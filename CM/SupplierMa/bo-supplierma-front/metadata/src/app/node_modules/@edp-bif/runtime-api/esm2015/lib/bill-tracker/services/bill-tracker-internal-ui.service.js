/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/services/bill-tracker-internal-ui.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, Inject, Injectable, Injector, LOCALE_ID } from "@angular/core";
import { JointQueryMode, JointQueryParameterType } from "@edp-bif/common-api";
import { MessagerService } from "@farris/ui-messager";
import { BsModalService } from "@farris/ui-modal";
import { AppType, FrameworkService, LoadingService } from "@gsp-sys/rtf-common";
import { BillTrackerConstant } from "../config/bill-tracker-constant";
import { BillTrackerLocalePipe } from "../pipe/bill-tracker-locale.pipe";
import { BillTrackerDataInfoService } from "./bill-tracker-data-info.service";
import { BillTrackerDataService } from "./bill-tracker-data.service";
export class BillTrackerInternalUiService {
    /**
     * @param {?} framework
     * @param {?} messager
     * @param {?} loading
     * @param {?} localeId
     * @param {?} dataService
     * @param {?} dataInfoService
     * @param {?} modalService
     * @param {?} cfr
     * @param {?} injector
     * @param {?} localePipe
     */
    constructor(framework, messager, loading, localeId, dataService, dataInfoService, modalService, cfr, injector, localePipe) {
        this.framework = framework;
        this.messager = messager;
        this.loading = loading;
        this.dataService = dataService;
        this.dataInfoService = dataInfoService;
        this.modalService = modalService;
        this.cfr = cfr;
        this.injector = injector;
        this.localePipe = localePipe;
    }
    /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @return {?}
     */
    openBillDetail(billInfo, billDataInfo) {
        /** @type {?} */
        const jointQueryMode = billInfo.jointQueryMode;
        /** @type {?} */
        const jointQueryParameters = JSON.parse(billInfo.jointQueryParameters);
        /** @type {?} */
        const id = billDataInfo.dataId;
        if (this.dataService.hasDynamicParams(jointQueryParameters)) {
            /** @type {?} */
            const args = this.dataService.buildGetJointQueryParametersArgs(jointQueryParameters, billInfo, billDataInfo);
            this.dataService.getJointQueryParameters(args).subscribe((/**
             * @param {?} results
             * @return {?}
             */
            (results) => {
                if (jointQueryMode == JointQueryMode.APP) {
                    this.openMenu(jointQueryParameters, id, results);
                }
                else if (jointQueryMode == JointQueryMode.URL) {
                    this.openUrl(jointQueryParameters, id, results);
                }
            }));
        }
        else {
            if (jointQueryMode == JointQueryMode.APP) {
                this.openMenu(jointQueryParameters, id);
            }
            else if (jointQueryMode == JointQueryMode.URL) {
                this.openUrl(jointQueryParameters, id);
            }
        }
    }
    /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @param {?} fieldsWithValue
     * @return {?}
     */
    openBillDetailWithFields(billInfo, billDataInfo, fieldsWithValue) {
        /** @type {?} */
        const id = billDataInfo.dataId;
        /** @type {?} */
        const jointQueryMode = billInfo.jointQueryMode;
        /** @type {?} */
        const jointQueryParameters = JSON.parse(billInfo.jointQueryParameters);
        if (this.dataService.hasDynamicParams(jointQueryParameters)) {
            /** @type {?} */
            const args = this.dataService.buildGetJointQueryParametersArgs(jointQueryParameters, billInfo, billDataInfo);
            this.dataService.getJointQueryParameters(args).subscribe((/**
             * @param {?} results
             * @return {?}
             */
            (results) => {
                if (jointQueryMode == JointQueryMode.APP) {
                    this.openMenu(jointQueryParameters, id, results);
                }
                else if (jointQueryMode == JointQueryMode.URL) {
                    this.openUrl(jointQueryParameters, id, results);
                }
            }));
        }
        else {
            if (jointQueryMode == JointQueryMode.APP) {
                this.openMenu(jointQueryParameters, id);
            }
            else if (jointQueryMode == JointQueryMode.URL) {
                this.openUrl(jointQueryParameters, id);
            }
        }
    }
    /**
     * 直接打开菜单
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    openMenu(jointQueryParameters, id, jqpr) {
        /** @type {?} */
        const entityParams = {};
        entityParams["id"] = id;
        entityParams["action"] = "LoadAndView1";
        /** @type {?} */
        const map = new Map();
        map.set("id", id);
        map.set("action", "LoadAndView1");
        this.buildOpenMenuParams(jointQueryParameters, map, entityParams, jqpr);
        /** @type {?} */
        const WEB_FORM_ROUTE_PARAMS = encodeURIComponent(JSON.stringify(entityParams));
        map.set("WEB_FORM_ROUTE_PARAMS", WEB_FORM_ROUTE_PARAMS);
        /** @type {?} */
        const opts = {
            appType: AppType.Menu,
            funcId: jointQueryParameters.funcId,
            appEntrance: null,
            appId: null,
            tabId: id,
            entityParams: entityParams,
            queryStringParams: map,
        };
        this.framework.openMenu(opts);
    }
    /**
     * 借助单据查看容器打开url
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    openUrl(jointQueryParameters, id, jqpr) {
        // console.log("open default container for url");
        // console.log("open default container for url");
        /** @type {?} */
        let url = this.appendQueryParam(jointQueryParameters.url, "id", id);
        // 添加自定义参数
        if (Array.isArray(jointQueryParameters.params)) {
            jointQueryParameters.params.forEach((/**
             * @param {?} p
             * @return {?}
             */
            p => {
                /** @type {?} */
                let value = p.value;
                if (p.type == JointQueryParameterType.Field || p.type == JointQueryParameterType.Expression) {
                    /** @type {?} */
                    const r = jqpr.find((/**
                     * @param {?} it
                     * @return {?}
                     */
                    it => it.code == p.code));
                    value = r && r.value;
                }
                url = this.appendQueryParam(url, p.code, value);
            }));
        }
        else {
            // 兼容key-value格式params
            Object.keys(jointQueryParameters.params).forEach((/**
             * @param {?} k
             * @return {?}
             */
            (k) => {
                url = this.appendQueryParam(url, k, jointQueryParameters.params[k]);
            }));
        }
        /** @type {?} */
        const entityParams = jointQueryParameters.params || {};
        entityParams["id"] = id;
        entityParams["url"] = url;
        entityParams["action"] = "LoadAndView1";
        /** @type {?} */
        const map = new Map();
        map.set("url", url);
        map.set("id", id);
        map.set("action", "LoadAndView1");
        this.buildOpenMenuParams(jointQueryParameters, map, undefined, jqpr);
        /** @type {?} */
        const opts = {
            appType: AppType.Menu,
            funcId: BillTrackerConstant.BILL_VIEWER_FUNC_ID,
            appEntrance: null,
            appId: null,
            tabId: id,
            entityParams: entityParams,
            queryStringParams: map,
        };
        this.framework.openMenu(opts);
    }
    /**
     * @param {?} jointQueryParameters
     * @param {?} map
     * @param {?=} entityParams
     * @param {?=} jqpr
     * @return {?}
     */
    buildOpenMenuParams(jointQueryParameters, map, entityParams = {}, jqpr) {
        // 添加自定义参数
        if (Array.isArray(jointQueryParameters.params)) {
            jointQueryParameters.params.forEach((/**
             * @param {?} p
             * @return {?}
             */
            p => {
                /** @type {?} */
                let value = p.value;
                if (p.type == JointQueryParameterType.Field || p.type == JointQueryParameterType.Expression) {
                    if (jqpr) {
                        /** @type {?} */
                        const r = jqpr.find((/**
                         * @param {?} it
                         * @return {?}
                         */
                        it => it.code == p.code));
                        value = r.value;
                    }
                }
                entityParams[p.code] = value;
                map.set(p.code, value);
            }));
        }
        else {
            // 兼容key-value格式params
            Object.keys(jointQueryParameters.params).forEach((/**
             * @param {?} k
             * @return {?}
             */
            (k) => {
                entityParams[k] = jointQueryParameters.params[k];
                map.set(k, jointQueryParameters.params[k]);
            }));
        }
    }
    /**
     * @param {?} url
     * @param {?} k
     * @param {?} v
     * @return {?}
     */
    appendQueryParam(url, k, v) {
        if (url.indexOf(k) > -1) {
            /** @type {?} */
            let re1 = eval('/(\\?)(' + k + '=)([^&]*)/gi');
            url = url.replace(re1, '?' + k + '=' + v);
            /** @type {?} */
            let re2 = eval('/(&)(' + k + '=)([^&]*)/gi');
            url = url.replace(re2, '&' + k + '=' + v);
        }
        else {
            /** @type {?} */
            let paraStr = k + '=' + v;
            /** @type {?} */
            let idx = url.indexOf('?');
            if (idx < 0)
                url += '?';
            else if (idx >= 0 && idx != url.length - 1)
                url += '&';
            url = url + paraStr;
        }
        return url;
    }
}
BillTrackerInternalUiService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BillTrackerInternalUiService.ctorParameters = () => [
    { type: FrameworkService },
    { type: MessagerService },
    { type: LoadingService },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
    { type: BillTrackerDataService },
    { type: BillTrackerDataInfoService },
    { type: BsModalService },
    { type: ComponentFactoryResolver },
    { type: Injector },
    { type: BillTrackerLocalePipe }
];
if (false) {
    /** @type {?} */
    BillTrackerInternalUiService.prototype.framework;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.messager;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.loading;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.dataService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.dataInfoService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.modalService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.cfr;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.injector;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.localePipe;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbC10cmFja2VyLWludGVybmFsLXVpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvc2VydmljZXMvYmlsbC10cmFja2VyLWludGVybmFsLXVpLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRWxHLE9BQU8sRUFBRSxjQUFjLEVBQXdCLHVCQUF1QixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQWMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBSTVGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBR3JFLE1BQU0sT0FBTyw0QkFBNEI7Ozs7Ozs7Ozs7Ozs7SUFFckMsWUFDVyxTQUEyQixFQUMzQixRQUF5QixFQUN6QixPQUF1QixFQUNYLFFBQWdCLEVBQzVCLFdBQW1DLEVBQ25DLGVBQTJDLEVBQzNDLFlBQTRCLEVBQzVCLEdBQTZCLEVBQzdCLFFBQWtCLEVBQ2xCLFVBQWlDO1FBVGpDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQzNCLGFBQVEsR0FBUixRQUFRLENBQWlCO1FBQ3pCLFlBQU8sR0FB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QUcsQ0FBQyxDQUFDLENBQUM7O2dCQUN0QyxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLEdBQUcsY0FBYyxDQUFDO1lBQzVDLEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUM3QzthQUFNOztnQkFDQyxPQUFPLEdBQUcsQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDOztnQkFFckIsR0FBRyxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQzFCLElBQUksR0FBRyxHQUFHLENBQUM7Z0JBQ1AsR0FBRyxJQUFJLEdBQUcsQ0FBQztpQkFDVixJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQztnQkFDdEMsR0FBRyxJQUFJLEdBQUcsQ0FBQztZQUNmLEdBQUcsR0FBRyxHQUFHLEdBQUcsT0FBTyxDQUFDO1NBQ3ZCO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDOzs7WUE1TEosVUFBVTs7OztZQVRtQixnQkFBZ0I7WUFGckMsZUFBZTtZQUV3QixjQUFjO3lDQWdCckQsTUFBTSxTQUFDLFNBQVM7WUFUaEIsc0JBQXNCO1lBRHRCLDBCQUEwQjtZQVAxQixjQUFjO1lBSmQsd0JBQXdCO1lBQXNCLFFBQVE7WUFVdEQscUJBQXFCOzs7O0lBUXRCLGlEQUFrQzs7SUFDbEMsZ0RBQWdDOztJQUNoQywrQ0FBOEI7O0lBRTlCLG1EQUEwQzs7SUFDMUMsdURBQWtEOztJQUNsRCxvREFBbUM7O0lBQ25DLDJDQUFvQzs7SUFDcEMsZ0RBQXlCOztJQUN6QixrREFBd0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIExPQ0FMRV9JRCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEJpbGxEYXRhRmllbGRCYXNlLCBCaWxsU2NoZW1hRmllbGRCYXNlIH0gZnJvbSBcIkBlZHAtYWlmL2NvbW1vbi1hcGlcIjtcclxuaW1wb3J0IHsgSm9pbnRRdWVyeU1vZGUsIEpvaW50UXVlcnlQYXJhbWV0ZXJzLCBKb2ludFF1ZXJ5UGFyYW1ldGVyVHlwZSB9IGZyb20gXCJAZWRwLWJpZi9jb21tb24tYXBpXCI7XHJcbmltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gXCJAZmFycmlzL3VpLW1lc3NhZ2VyXCI7XHJcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktbW9kYWxcIjtcclxuaW1wb3J0IHsgQXBwT3B0aW9ucywgQXBwVHlwZSwgRnJhbWV3b3JrU2VydmljZSwgTG9hZGluZ1NlcnZpY2UgfSBmcm9tIFwiQGdzcC1zeXMvcnRmLWNvbW1vblwiO1xyXG5pbXBvcnQgeyBCaWxsRGF0YUluZm8gfSBmcm9tIFwiLi4vLi4vZW50aXR5L3RyYWNraW5nL0JpbGxEYXRhSW5mb1wiO1xyXG5pbXBvcnQgeyBCaWxsSW5mbyB9IGZyb20gXCIuLi8uLi9lbnRpdHkvdHJhY2tpbmcvQmlsbEluZm9cIjtcclxuaW1wb3J0IHsgSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdCB9IGZyb20gXCIuLi8uLi9lbnRpdHkvdHJhY2tpbmcvSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdFwiO1xyXG5pbXBvcnQgeyBCaWxsVHJhY2tlckNvbnN0YW50IH0gZnJvbSBcIi4uL2NvbmZpZy9iaWxsLXRyYWNrZXItY29uc3RhbnRcIjtcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJMb2NhbGVQaXBlIH0gZnJvbSBcIi4uL3BpcGUvYmlsbC10cmFja2VyLWxvY2FsZS5waXBlXCI7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyRGF0YUluZm9TZXJ2aWNlIH0gZnJvbSBcIi4vYmlsbC10cmFja2VyLWRhdGEtaW5mby5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyRGF0YVNlcnZpY2UgfSBmcm9tIFwiLi9iaWxsLXRyYWNrZXItZGF0YS5zZXJ2aWNlXCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCaWxsVHJhY2tlckludGVybmFsVWlTZXJ2aWNlIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwdWJsaWMgZnJhbWV3b3JrOiBGcmFtZXdvcmtTZXJ2aWNlLFxyXG4gICAgICAgIHB1YmxpYyBtZXNzYWdlcjogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgICAgIHB1YmxpYyBsb2FkaW5nOiBMb2FkaW5nU2VydmljZSxcclxuICAgICAgICBASW5qZWN0KExPQ0FMRV9JRCkgbG9jYWxlSWQ6IHN0cmluZyxcclxuICAgICAgICBwdWJsaWMgZGF0YVNlcnZpY2U6IEJpbGxUcmFja2VyRGF0YVNlcnZpY2UsXHJcbiAgICAgICAgcHVibGljIGRhdGFJbmZvU2VydmljZTogQmlsbFRyYWNrZXJEYXRhSW5mb1NlcnZpY2UsXHJcbiAgICAgICAgcHVibGljIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICAgICAgcHVibGljIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgcHVibGljIGxvY2FsZVBpcGU6IEJpbGxUcmFja2VyTG9jYWxlUGlwZSxcclxuICAgICkge1xyXG4gICAgfVxyXG5cclxuICAgIG9wZW5CaWxsRGV0YWlsKGJpbGxJbmZvOiBCaWxsSW5mbywgYmlsbERhdGFJbmZvOiBCaWxsRGF0YUluZm8pIHtcclxuICAgICAgICBjb25zdCBqb2ludFF1ZXJ5TW9kZSA9IGJpbGxJbmZvLmpvaW50UXVlcnlNb2RlO1xyXG4gICAgICAgIGNvbnN0IGpvaW50UXVlcnlQYXJhbWV0ZXJzOiBKb2ludFF1ZXJ5UGFyYW1ldGVycyA9IEpTT04ucGFyc2UoYmlsbEluZm8uam9pbnRRdWVyeVBhcmFtZXRlcnMpO1xyXG4gICAgICAgIGNvbnN0IGlkID0gYmlsbERhdGFJbmZvLmRhdGFJZDtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZGF0YVNlcnZpY2UuaGFzRHluYW1pY1BhcmFtcyhqb2ludFF1ZXJ5UGFyYW1ldGVycykpIHtcclxuICAgICAgICAgICAgY29uc3QgYXJncyA9IHRoaXMuZGF0YVNlcnZpY2UuYnVpbGRHZXRKb2ludFF1ZXJ5UGFyYW1ldGVyc0FyZ3Moam9pbnRRdWVyeVBhcmFtZXRlcnMsIGJpbGxJbmZvLCBiaWxsRGF0YUluZm8pO1xyXG4gICAgICAgICAgICB0aGlzLmRhdGFTZXJ2aWNlLmdldEpvaW50UXVlcnlQYXJhbWV0ZXJzKGFyZ3MpLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgIChyZXN1bHRzKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLkFQUCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5NZW51KGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCwgcmVzdWx0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChqb2ludFF1ZXJ5TW9kZSA9PSBKb2ludFF1ZXJ5TW9kZS5VUkwpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuVXJsKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCwgcmVzdWx0cyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChqb2ludFF1ZXJ5TW9kZSA9PSBKb2ludFF1ZXJ5TW9kZS5BUFApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMub3Blbk1lbnUoam9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkKTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChqb2ludFF1ZXJ5TW9kZSA9PSBKb2ludFF1ZXJ5TW9kZS5VUkwpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMub3BlblVybChqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9wZW5CaWxsRGV0YWlsV2l0aEZpZWxkcyhiaWxsSW5mbzogQmlsbEluZm8sIGJpbGxEYXRhSW5mbzogQmlsbERhdGFJbmZvLCBmaWVsZHNXaXRoVmFsdWU6IEJpbGxTY2hlbWFGaWVsZEJhc2VbXSkge1xyXG4gICAgICAgIGNvbnN0IGlkID0gYmlsbERhdGFJbmZvLmRhdGFJZDtcclxuICAgICAgICBjb25zdCBqb2ludFF1ZXJ5TW9kZSA9IGJpbGxJbmZvLmpvaW50UXVlcnlNb2RlO1xyXG4gICAgICAgIGNvbnN0IGpvaW50UXVlcnlQYXJhbWV0ZXJzOiBKb2ludFF1ZXJ5UGFyYW1ldGVycyA9IEpTT04ucGFyc2UoYmlsbEluZm8uam9pbnRRdWVyeVBhcmFtZXRlcnMpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5kYXRhU2VydmljZS5oYXNEeW5hbWljUGFyYW1zKGpvaW50UXVlcnlQYXJhbWV0ZXJzKSkge1xyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gdGhpcy5kYXRhU2VydmljZS5idWlsZEdldEpvaW50UXVlcnlQYXJhbWV0ZXJzQXJncyhqb2ludFF1ZXJ5UGFyYW1ldGVycywgYmlsbEluZm8sIGJpbGxEYXRhSW5mbyk7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YVNlcnZpY2UuZ2V0Sm9pbnRRdWVyeVBhcmFtZXRlcnMoYXJncykuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgKHJlc3VsdHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuQVBQKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3Blbk1lbnUoam9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkLCByZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLlVSTCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5Vcmwoam9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkLCByZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLkFQUCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuTWVudShqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLlVSTCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuVXJsKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDnm7TmjqXmiZPlvIDoj5zljZVcclxuICAgICAqIEBwYXJhbSBqb2ludFF1ZXJ5UGFyYW1ldGVycyBcclxuICAgICAqIEBwYXJhbSBpZCBcclxuICAgICAqL1xyXG4gICAgb3Blbk1lbnUoam9pbnRRdWVyeVBhcmFtZXRlcnM6IEpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZDogc3RyaW5nLCBqcXByPzogSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdFtdKSB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5UGFyYW1zID0ge307XHJcbiAgICAgICAgZW50aXR5UGFyYW1zW1wiaWRcIl0gPSBpZDtcclxuICAgICAgICBlbnRpdHlQYXJhbXNbXCJhY3Rpb25cIl0gPSBcIkxvYWRBbmRWaWV3MVwiO1xyXG5cclxuICAgICAgICBjb25zdCBtYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xyXG4gICAgICAgIG1hcC5zZXQoXCJpZFwiLCBpZCk7XHJcbiAgICAgICAgbWFwLnNldChcImFjdGlvblwiLCBcIkxvYWRBbmRWaWV3MVwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5idWlsZE9wZW5NZW51UGFyYW1zKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBtYXAsIGVudGl0eVBhcmFtcywganFwcik7XHJcblxyXG4gICAgICAgIGNvbnN0IFdFQl9GT1JNX1JPVVRFX1BBUkFNUyA9IGVuY29kZVVSSUNvbXBvbmVudChKU09OLnN0cmluZ2lmeShlbnRpdHlQYXJhbXMpKTtcclxuICAgICAgICBtYXAuc2V0KFwiV0VCX0ZPUk1fUk9VVEVfUEFSQU1TXCIsIFdFQl9GT1JNX1JPVVRFX1BBUkFNUyk7XHJcblxyXG4gICAgICAgIGNvbnN0IG9wdHM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6IEFwcFR5cGUuTWVudSxcclxuICAgICAgICAgICAgZnVuY0lkOiBqb2ludFF1ZXJ5UGFyYW1ldGVycy5mdW5jSWQsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlOiBudWxsLFxyXG4gICAgICAgICAgICBhcHBJZDogbnVsbCxcclxuICAgICAgICAgICAgdGFiSWQ6IGlkLFxyXG4gICAgICAgICAgICBlbnRpdHlQYXJhbXM6IGVudGl0eVBhcmFtcyxcclxuICAgICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IG1hcCxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZnJhbWV3b3JrLm9wZW5NZW51KG9wdHMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5YCf5Yqp5Y2V5o2u5p+l55yL5a655Zmo5omT5byAdXJsXHJcbiAgICAgKiBAcGFyYW0gam9pbnRRdWVyeVBhcmFtZXRlcnMgXHJcbiAgICAgKiBAcGFyYW0gaWQgXHJcbiAgICAgKi9cclxuICAgIG9wZW5Vcmwoam9pbnRRdWVyeVBhcmFtZXRlcnM6IEpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZDogc3RyaW5nLCBqcXByPzogSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdFtdKSB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coXCJvcGVuIGRlZmF1bHQgY29udGFpbmVyIGZvciB1cmxcIik7XHJcblxyXG4gICAgICAgIGxldCB1cmwgPSB0aGlzLmFwcGVuZFF1ZXJ5UGFyYW0oam9pbnRRdWVyeVBhcmFtZXRlcnMudXJsLCBcImlkXCIsIGlkKTtcclxuICAgICAgICAvLyDmt7vliqDoh6rlrprkuYnlj4LmlbBcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXMpKSB7XHJcbiAgICAgICAgICAgIGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcy5mb3JFYWNoKHAgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gcC52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChwLnR5cGUgPT0gSm9pbnRRdWVyeVBhcmFtZXRlclR5cGUuRmllbGQgfHwgcC50eXBlID09IEpvaW50UXVlcnlQYXJhbWV0ZXJUeXBlLkV4cHJlc3Npb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByID0ganFwci5maW5kKGl0ID0+IGl0LmNvZGUgPT0gcC5jb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHIgJiYgci52YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuYXBwZW5kUXVlcnlQYXJhbSh1cmwsIHAuY29kZSwgdmFsdWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDlhbzlrrlrZXktdmFsdWXmoLzlvI9wYXJhbXNcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMoam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zKS5mb3JFYWNoKChrKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLmFwcGVuZFF1ZXJ5UGFyYW0odXJsLCBrLCBqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXNba10pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGVudGl0eVBhcmFtcyA9IGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcyB8fCB7fTtcclxuICAgICAgICBlbnRpdHlQYXJhbXNbXCJpZFwiXSA9IGlkO1xyXG4gICAgICAgIGVudGl0eVBhcmFtc1tcInVybFwiXSA9IHVybDtcclxuICAgICAgICBlbnRpdHlQYXJhbXNbXCJhY3Rpb25cIl0gPSBcIkxvYWRBbmRWaWV3MVwiO1xyXG5cclxuICAgICAgICBjb25zdCBtYXAgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xyXG4gICAgICAgIG1hcC5zZXQoXCJ1cmxcIiwgdXJsKTtcclxuICAgICAgICBtYXAuc2V0KFwiaWRcIiwgaWQpO1xyXG4gICAgICAgIG1hcC5zZXQoXCJhY3Rpb25cIiwgXCJMb2FkQW5kVmlldzFcIik7XHJcblxyXG4gICAgICAgIHRoaXMuYnVpbGRPcGVuTWVudVBhcmFtcyhqb2ludFF1ZXJ5UGFyYW1ldGVycywgbWFwLCB1bmRlZmluZWQsIGpxcHIpO1xyXG5cclxuICAgICAgICBjb25zdCBvcHRzOiBBcHBPcHRpb25zID0ge1xyXG4gICAgICAgICAgICBhcHBUeXBlOiBBcHBUeXBlLk1lbnUsXHJcbiAgICAgICAgICAgIGZ1bmNJZDogQmlsbFRyYWNrZXJDb25zdGFudC5CSUxMX1ZJRVdFUl9GVU5DX0lELFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogbnVsbCxcclxuICAgICAgICAgICAgYXBwSWQ6IG51bGwsXHJcbiAgICAgICAgICAgIHRhYklkOiBpZCxcclxuICAgICAgICAgICAgZW50aXR5UGFyYW1zOiBlbnRpdHlQYXJhbXMsXHJcbiAgICAgICAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBtYXAsXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmZyYW1ld29yay5vcGVuTWVudShvcHRzKTtcclxuICAgIH1cclxuXHJcbiAgICBidWlsZE9wZW5NZW51UGFyYW1zKGpvaW50UXVlcnlQYXJhbWV0ZXJzOiBKb2ludFF1ZXJ5UGFyYW1ldGVycywgbWFwOiBNYXA8c3RyaW5nLCBzdHJpbmc+LCBlbnRpdHlQYXJhbXM6IGFueSA9IHt9LCBqcXByPzogSm9pbnRRdWVyeVBhcmFtZXRlclJlc3VsdFtdKSB7XHJcbiAgICAgICAgLy8g5re75Yqg6Ieq5a6a5LmJ5Y+C5pWwXHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zKSkge1xyXG4gICAgICAgICAgICBqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXMuZm9yRWFjaChwID0+IHtcclxuICAgICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHAudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBpZiAocC50eXBlID09IEpvaW50UXVlcnlQYXJhbWV0ZXJUeXBlLkZpZWxkIHx8IHAudHlwZSA9PSBKb2ludFF1ZXJ5UGFyYW1ldGVyVHlwZS5FeHByZXNzaW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGpxcHIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGpxcHIuZmluZChpdCA9PiBpdC5jb2RlID09IHAuY29kZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gci52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlQYXJhbXNbcC5jb2RlXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgbWFwLnNldChwLmNvZGUsIHZhbHVlKVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDlhbzlrrlrZXktdmFsdWXmoLzlvI9wYXJhbXNcclxuICAgICAgICAgICAgT2JqZWN0LmtleXMoam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zKS5mb3JFYWNoKChrKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlbnRpdHlQYXJhbXNba10gPSBqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXNba107XHJcbiAgICAgICAgICAgICAgICBtYXAuc2V0KGssIGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtc1trXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhcHBlbmRRdWVyeVBhcmFtKHVybDogc3RyaW5nLCBrOiBzdHJpbmcsIHYpIHtcclxuICAgICAgICBpZiAodXJsLmluZGV4T2YoaykgPiAtMSkge1xyXG4gICAgICAgICAgICBsZXQgcmUxID0gZXZhbCgnLyhcXFxcPykoJyArIGsgKyAnPSkoW14mXSopL2dpJyk7XHJcbiAgICAgICAgICAgIHVybCA9IHVybC5yZXBsYWNlKHJlMSwgJz8nICsgayArICc9JyArIHYpO1xyXG4gICAgICAgICAgICBsZXQgcmUyID0gZXZhbCgnLygmKSgnICsgayArICc9KShbXiZdKikvZ2knKTtcclxuICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UocmUyLCAnJicgKyBrICsgJz0nICsgdik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbGV0IHBhcmFTdHIgPSBrICsgJz0nICsgdjtcclxuXHJcbiAgICAgICAgICAgIGxldCBpZHggPSB1cmwuaW5kZXhPZignPycpO1xyXG4gICAgICAgICAgICBpZiAoaWR4IDwgMClcclxuICAgICAgICAgICAgICAgIHVybCArPSAnPyc7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGlkeCA+PSAwICYmIGlkeCAhPSB1cmwubGVuZ3RoIC0gMSlcclxuICAgICAgICAgICAgICAgIHVybCArPSAnJic7XHJcbiAgICAgICAgICAgIHVybCA9IHVybCArIHBhcmFTdHI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1cmw7XHJcbiAgICB9XHJcbn0iXX0=