/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/components/child-info/child-info.component.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ChangeDetectorRef, Component, ComponentFactoryResolver, Inject, Injector, Input, LOCALE_ID, Optional, ViewChild, ViewContainerRef } from "@angular/core";
import { BillDataTable, BillSchemaTable, DataType } from "@edp-aif/common-api";
import { BillTrackingDataShownMode, BillTrackingSettings } from "@edp-bif/common-api";
import { DatagridComponent } from "@farris/ui-datagrid";
import { LoadingService } from "@farris/ui-loading";
import { MessagerService } from "@farris/ui-messager";
import { BsModalService } from "@farris/ui-modal";
import { NotifyService } from "@farris/ui-notify";
import { BillInfo } from "../../../entity/tracking/BillInfo";
import { BillTrackerLocalePipe } from "../../pipe/bill-tracker-locale.pipe";
import { BillTrackerDataInfoService } from "../../services/bill-tracker-data-info.service";
import { ChildInfoListComponent } from "../child-info-list/child-info-list.component";
var ChildInfoComponent = /** @class */ (function () {
    function ChildInfoComponent(notify, messager, loading, modal, dataInfoService, localePipe, vcr, inj, cfr, cdr, localeId) {
        this.notify = notify;
        this.messager = messager;
        this.loading = loading;
        this.modal = modal;
        this.dataInfoService = dataInfoService;
        this.localePipe = localePipe;
        this.vcr = vcr;
        this.inj = inj;
        this.cfr = cfr;
        this.cdr = cdr;
        this.localeId = localeId;
        this.secTitle = null;
        this.showDetail = false;
        this.dgCols = [];
        this.dgData = [];
        this.dgLineNumberTitle = this.localePipe.transform("lineNumber");
        this.dgIdField = "bifDgId0d63";
        this.localeId = localeId || this.inj.get(LOCALE_ID);
    }
    /**
     * @return {?}
     */
    ChildInfoComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        // 设置section标题
        this.secTitle = this.localePipe.transform("basicInfo");
        // 表名解析
        this.secTitle = this.dataInfoService.getTableLabel(this.billInfo, this.schemaTable, this.localeId);
        // 单据追踪配置
        /** @type {?} */
        var bts = new BillTrackingSettings();
        if (this.billInfo && this.billInfo.billTrackingSettings) {
            bts.LoadFromJson(this.billInfo.billTrackingSettings);
        }
        // 字段解析
        /** @type {?} */
        var fieldContent = bts.customFieldContent;
        /** @type {?} */
        var fieldConfig = fieldContent && (typeof fieldContent == "object" ? fieldContent : JSON.parse(fieldContent));
        /** @type {?} */
        var selectedFields = fieldConfig && fieldConfig.schema && fieldConfig.schema[this.schemaTable.tableName] && fieldConfig.schema[this.schemaTable.tableName].fields;
        selectedFields = selectedFields ? selectedFields : [];
        /** @type {?} */
        var showCustomFields = bts.billTrackingDataShownMode === BillTrackingDataShownMode.CUSTOMFIELD;
        /** @type {?} */
        var fs = this.schemaTable.getFieldList();
        // 提取字段
        /** @type {?} */
        var ffs = this.dataInfoService.extractFFields(fs, selectedFields, showCustomFields);
        // 筛选显示列
        ffs = ffs.filter((/**
         * @param {?} f
         * @return {?}
         */
        function (f) { return f.show; }));
        // 按order排序
        ffs = this.dataInfoService.sortFieldsByOrder(ffs);
        // 创建显示列
        this.dgCols = [];
        ffs.forEach((/**
         * @param {?} f
         * @return {?}
         */
        function (f) {
            /** @type {?} */
            var c = {
                field: f.fieldPath || f.fieldName,
                title: _this.dataInfoService.getFieldLabel(f, _this.localeId),
                width: 120
            };
            if (f.dataType == DataType.Boolean) {
                c.formatter = (/**
                 * @param {?} value
                 * @param {?} rowData
                 * @param {?} rowIndex
                 * @return {?}
                 */
                function (value, rowData, rowIndex) {
                    if (value == true) {
                        return _this.localePipe.transform("yes");
                    }
                    else if (value == false) {
                        return _this.localePipe.transform("no");
                    }
                    else {
                        return "-";
                    }
                });
            }
            _this.dgCols.push(c);
        }));
        // 构建行数据
        /** @type {?} */
        var rows = this.dataTable.GetRowList();
        this.dgData = tslib_1.__spread(this.dataInfoService.extractDataRows(rows, ffs, fs, this.dgIdField));
        if (this.dgData.length > 0) {
            setTimeout((/**
             * @return {?}
             */
            function () {
                _this.dg && _this.dg.selectRow(_this.dgData[0][_this.dgIdField]);
            }), 500);
        }
    };
    /**
     * @param {?} row
     * @return {?}
     */
    ChildInfoComponent.prototype.selectChanged = /**
     * @param {?} row
     * @return {?}
     */
    function (row) {
        /** @type {?} */
        var r = this.dataTable.GetRowMap()[row.id];
        this.showDetail = this.dataInfoService.hasChildData(r, this.billInfo);
        this.cdr.detectChanges();
    };
    /**
     * @return {?}
     */
    ChildInfoComponent.prototype.viewChildData = /**
     * @return {?}
     */
    function () {
        if (this.dg.selectedRow == null) {
            this.notify.warning(this.localePipe.transform("selectOneFirst"));
            return;
        }
        /** @type {?} */
        var row = this.dataTable.GetRowMap()[this.dg.selectedRow.id];
        if (!this.dataInfoService.hasChildData(row, this.billInfo)) {
            this.notify.info(this.localePipe.transform("noChildData"));
            return;
        }
        /** @type {?} */
        var cmpF = this.cfr.resolveComponentFactory(ChildInfoListComponent);
        /** @type {?} */
        var cmpR = cmpF.create(this.inj, []);
        // 获取子表列表
        /** @type {?} */
        var childSchemaTables = this.dataInfoService.getChildTables(this.billInfo, this.schemaTable);
        cmpR.instance.childSchemaTables = childSchemaTables;
        cmpR.instance.childDataTableMap = row.GetChildTableMap();
        cmpR.instance.billInfo = this.billInfo;
        /** @type {?} */
        var bsModalRef = this.modal.show(cmpR, {
            title: this.localePipe.transform("childData"),
            width: 900,
            height: 600,
            showButtons: false,
        });
        cmpR.instance.bsModalRef = bsModalRef;
    };
    ChildInfoComponent.decorators = [
        { type: Component, args: [{
                    selector: "lib-bill-tracker-child-info",
                    template: "<div class=\"f-struct-wrapper\" *ngIf=\"dgCols&&dgCols.length>0&&dgData&&dgData.length>0\">\r\n    <farris-section class=\"f-section-tabs f-section-in-mainsubcard\" [mainTitle]=\"secTitle\">\r\n        <ng-template farrisSectionToolbar [toolbarCls]=\"'section-test-toolbar'\">\r\n            <button class=\"btn btn-secondary f-btn-ml\" *ngIf=\"showDetail\" (click)=\"viewChildData()\">\r\n                {{ \"childData\" | billTrackerLocale}}\r\n            </button>\r\n        </ng-template>\r\n        <div class=\"\">\r\n            <div class=\"f-utils-fill\">\r\n                <farris-datagrid #dg [data]=\"dgData\" [idField]=\"dgIdField\" [fields]=\"dgCols\" [showLineNumber]=\"true\"\r\n                    [striped]=\"true\" [virtualized]=\"false\" [pagination]=\"false\" [virtualizedAsyncLoad]=\"false\"\r\n                    [multiSelect]=\"false\" [fit]=\"true\" [showCheckbox]=\"false\" [showAllCheckbox]=\"false\"\r\n                    [lineNumberTitle]=\"dgLineNumberTitle\" [mergeCell]=\"false\" [showBorder]=\"true\"\r\n                    [checkOnSelect]=\"false\" [selectOnCheck]=\"false\" [nowrap]=\"true\" [autoFitColumns]=\"true\"\r\n                    [fitColumns]=\"true\" [autoHeight]=\"false\" (selectChanged)=\"selectChanged($event)\">\r\n                </farris-datagrid>\r\n            </div>\r\n        </div>\r\n    </farris-section>\r\n</div>"
                }] }
    ];
    /** @nocollapse */
    ChildInfoComponent.ctorParameters = function () { return [
        { type: NotifyService },
        { type: MessagerService },
        { type: LoadingService },
        { type: BsModalService },
        { type: BillTrackerDataInfoService },
        { type: BillTrackerLocalePipe },
        { type: ViewContainerRef },
        { type: Injector },
        { type: ComponentFactoryResolver },
        { type: ChangeDetectorRef },
        { type: String, decorators: [{ type: Optional }, { type: Inject, args: [LOCALE_ID,] }] }
    ]; };
    ChildInfoComponent.propDecorators = {
        schemaTable: [{ type: Input, args: ["schemaTable",] }],
        dataTable: [{ type: Input, args: ["dataTable",] }],
        billInfo: [{ type: Input, args: ["billInfo",] }],
        dg: [{ type: ViewChild, args: ["dg",] }]
    };
    return ChildInfoComponent;
}());
export { ChildInfoComponent };
if (false) {
    /** @type {?} */
    ChildInfoComponent.prototype.schemaTable;
    /** @type {?} */
    ChildInfoComponent.prototype.dataTable;
    /** @type {?} */
    ChildInfoComponent.prototype.billInfo;
    /** @type {?} */
    ChildInfoComponent.prototype.secTitle;
    /** @type {?} */
    ChildInfoComponent.prototype.showDetail;
    /** @type {?} */
    ChildInfoComponent.prototype.dg;
    /** @type {?} */
    ChildInfoComponent.prototype.dgCols;
    /** @type {?} */
    ChildInfoComponent.prototype.dgData;
    /** @type {?} */
    ChildInfoComponent.prototype.dgLineNumberTitle;
    /** @type {?} */
    ChildInfoComponent.prototype.dgIdField;
    /** @type {?} */
    ChildInfoComponent.prototype.notify;
    /** @type {?} */
    ChildInfoComponent.prototype.messager;
    /** @type {?} */
    ChildInfoComponent.prototype.loading;
    /** @type {?} */
    ChildInfoComponent.prototype.modal;
    /** @type {?} */
    ChildInfoComponent.prototype.dataInfoService;
    /** @type {?} */
    ChildInfoComponent.prototype.localePipe;
    /** @type {?} */
    ChildInfoComponent.prototype.vcr;
    /** @type {?} */
    ChildInfoComponent.prototype.inj;
    /** @type {?} */
    ChildInfoComponent.prototype.cfr;
    /** @type {?} */
    ChildInfoComponent.prototype.cdr;
    /** @type {?} */
    ChildInfoComponent.prototype.localeId;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hpbGQtaW5mby5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvY29tcG9uZW50cy9jaGlsZC1pbmZvL2NoaWxkLWluZm8uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUssT0FBTyxFQUFFLGFBQWEsRUFBNEQsZUFBZSxFQUFFLFFBQVEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3pJLE9BQU8sRUFBaUMseUJBQXlCLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNySCxPQUFPLEVBQWMsaUJBQWlCLEVBQWUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQzdELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQzVFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLCtDQUErQyxDQUFDO0FBQzNGLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBRXRGO0lBMEJJLDRCQUNXLE1BQXFCLEVBQ3JCLFFBQXlCLEVBQ3pCLE9BQXVCLEVBQ3ZC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LEtBQUssU0FBQyxXQUFXOzJCQUdqQixLQUFLLFNBQUMsVUFBVTtxQkFPaEIsU0FBUyxTQUFDLElBQUk7O0lBb0huQix5QkFBQztDQUFBLEFBdklELElBdUlDO1NBbElZLGtCQUFrQjs7O0lBQzNCLHlDQUNvQzs7SUFFcEMsdUNBQ2dDOztJQUVoQyxzQ0FDMEI7O0lBRTFCLHNDQUFnQjs7SUFFaEIsd0NBQW1COztJQUVuQixnQ0FDc0I7O0lBQ3RCLG9DQUFZOztJQUNaLG9DQUFZOztJQUNaLCtDQUE0RDs7SUFDNUQsdUNBQTBCOztJQUd0QixvQ0FBNEI7O0lBQzVCLHNDQUFnQzs7SUFDaEMscUNBQThCOztJQUM5QixtQ0FBNEI7O0lBQzVCLDZDQUFrRDs7SUFDbEQsd0NBQXdDOztJQUN4QyxpQ0FBNEI7O0lBQzVCLGlDQUFvQjs7SUFDcEIsaUNBQW9DOztJQUNwQyxpQ0FBNkI7O0lBQzdCLHNDQUFzRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgSW5qZWN0LCBJbmplY3RvciwgSW5wdXQsIExPQ0FMRV9JRCwgT25Jbml0LCBPcHRpb25hbCwgVmlld0NoaWxkLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQmlsbERhdGFUYWJsZSwgQmlsbFNjaGVtYUZpZWxkLCBCaWxsU2NoZW1hRmllbGRCYXNlLCBCaWxsU2NoZW1hU3ViRmllbGQsIEJpbGxTY2hlbWFUYWJsZSwgRGF0YVR5cGUgfSBmcm9tIFwiQGVkcC1haWYvY29tbW9uLWFwaVwiO1xyXG5pbXBvcnQgeyBCaWxsVHJhY2tlclNjaGVtYUZpZWxkQ29udGVudCwgQmlsbFRyYWNraW5nRGF0YVNob3duTW9kZSwgQmlsbFRyYWNraW5nU2V0dGluZ3MgfSBmcm9tIFwiQGVkcC1iaWYvY29tbW9uLWFwaVwiO1xyXG5pbXBvcnQgeyBEYXRhQ29sdW1uLCBEYXRhZ3JpZENvbXBvbmVudCwgU2VsZWN0ZWRSb3cgfSBmcm9tIFwiQGZhcnJpcy91aS1kYXRhZ3JpZFwiO1xyXG5pbXBvcnQgeyBMb2FkaW5nU2VydmljZSB9IGZyb20gXCJAZmFycmlzL3VpLWxvYWRpbmdcIjtcclxuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktbWVzc2FnZXJcIjtcclxuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1tb2RhbFwiO1xyXG5pbXBvcnQgeyBOb3RpZnlTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktbm90aWZ5XCI7XHJcbmltcG9ydCB7IEJpbGxJbmZvIH0gZnJvbSBcIi4uLy4uLy4uL2VudGl0eS90cmFja2luZy9CaWxsSW5mb1wiO1xyXG5pbXBvcnQgeyBCaWxsVHJhY2tlckxvY2FsZVBpcGUgfSBmcm9tIFwiLi4vLi4vcGlwZS9iaWxsLXRyYWNrZXItbG9jYWxlLnBpcGVcIjtcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJEYXRhSW5mb1NlcnZpY2UgfSBmcm9tIFwiLi4vLi4vc2VydmljZXMvYmlsbC10cmFja2VyLWRhdGEtaW5mby5zZXJ2aWNlXCI7XHJcbmltcG9ydCB7IENoaWxkSW5mb0xpc3RDb21wb25lbnQgfSBmcm9tIFwiLi4vY2hpbGQtaW5mby1saXN0L2NoaWxkLWluZm8tbGlzdC5jb21wb25lbnRcIjtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6IFwibGliLWJpbGwtdHJhY2tlci1jaGlsZC1pbmZvXCIsXHJcbiAgICB0ZW1wbGF0ZVVybDogXCIuL2NoaWxkLWluZm8uY29tcG9uZW50Lmh0bWxcIixcclxuICAgIHN0eWxlVXJsczogW11cclxufSlcclxuZXhwb3J0IGNsYXNzIENoaWxkSW5mb0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgICBASW5wdXQoXCJzY2hlbWFUYWJsZVwiKVxyXG4gICAgcHVibGljIHNjaGVtYVRhYmxlOiBCaWxsU2NoZW1hVGFibGU7XHJcblxyXG4gICAgQElucHV0KFwiZGF0YVRhYmxlXCIpXHJcbiAgICBwdWJsaWMgZGF0YVRhYmxlOiBCaWxsRGF0YVRhYmxlO1xyXG5cclxuICAgIEBJbnB1dChcImJpbGxJbmZvXCIpXHJcbiAgICBwdWJsaWMgYmlsbEluZm86IEJpbGxJbmZvO1xyXG5cclxuICAgIHNlY1RpdGxlID0gbnVsbDtcclxuXHJcbiAgICBzaG93RGV0YWlsID0gZmFsc2U7XHJcblxyXG4gICAgQFZpZXdDaGlsZChcImRnXCIpXHJcbiAgICBkZzogRGF0YWdyaWRDb21wb25lbnQ7XHJcbiAgICBkZ0NvbHMgPSBbXTtcclxuICAgIGRnRGF0YSA9IFtdO1xyXG4gICAgZGdMaW5lTnVtYmVyVGl0bGUgPSB0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwibGluZU51bWJlclwiKTtcclxuICAgIGRnSWRGaWVsZCA9IFwiYmlmRGdJZDBkNjNcIjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwdWJsaWMgbm90aWZ5OiBOb3RpZnlTZXJ2aWNlLFxyXG4gICAgICAgIHB1YmxpYyBtZXNzYWdlcjogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgICAgIHB1YmxpYyBsb2FkaW5nOiBMb2FkaW5nU2VydmljZSxcclxuICAgICAgICBwdWJsaWMgbW9kYWw6IEJzTW9kYWxTZXJ2aWNlLFxyXG4gICAgICAgIHB1YmxpYyBkYXRhSW5mb1NlcnZpY2U6IEJpbGxUcmFja2VyRGF0YUluZm9TZXJ2aWNlLFxyXG4gICAgICAgIHB1YmxpYyBsb2NhbGVQaXBlOiBCaWxsVHJhY2tlckxvY2FsZVBpcGUsXHJcbiAgICAgICAgcHVibGljIHZjcjogVmlld0NvbnRhaW5lclJlZixcclxuICAgICAgICBwdWJsaWMgaW5qOiBJbmplY3RvcixcclxuICAgICAgICBwdWJsaWMgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHVibGljIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICAgICAgQE9wdGlvbmFsKCkgQEluamVjdChMT0NBTEVfSUQpIHB1YmxpYyBsb2NhbGVJZDogc3RyaW5nLFxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy5sb2NhbGVJZCA9IGxvY2FsZUlkIHx8IHRoaXMuaW5qLmdldChMT0NBTEVfSUQpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgICAgIC8vIOiuvue9rnNlY3Rpb27moIfpophcclxuICAgICAgICB0aGlzLnNlY1RpdGxlID0gdGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcImJhc2ljSW5mb1wiKTtcclxuICAgICAgICAvLyDooajlkI3op6PmnpBcclxuICAgICAgICB0aGlzLnNlY1RpdGxlID0gdGhpcy5kYXRhSW5mb1NlcnZpY2UuZ2V0VGFibGVMYWJlbCh0aGlzLmJpbGxJbmZvLCB0aGlzLnNjaGVtYVRhYmxlLCB0aGlzLmxvY2FsZUlkKTtcclxuXHJcbiAgICAgICAgLy8g5Y2V5o2u6L+96Liq6YWN572uXHJcbiAgICAgICAgbGV0IGJ0czogQmlsbFRyYWNraW5nU2V0dGluZ3MgPSBuZXcgQmlsbFRyYWNraW5nU2V0dGluZ3MoKTtcclxuICAgICAgICBpZiAodGhpcy5iaWxsSW5mbyAmJiB0aGlzLmJpbGxJbmZvLmJpbGxUcmFja2luZ1NldHRpbmdzKSB7XHJcbiAgICAgICAgICAgIGJ0cy5Mb2FkRnJvbUpzb24odGhpcy5iaWxsSW5mby5iaWxsVHJhY2tpbmdTZXR0aW5ncyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDlrZfmrrXop6PmnpBcclxuICAgICAgICBsZXQgZmllbGRDb250ZW50ID0gYnRzLmN1c3RvbUZpZWxkQ29udGVudDtcclxuICAgICAgICBsZXQgZmllbGRDb25maWc6IEJpbGxUcmFja2VyU2NoZW1hRmllbGRDb250ZW50ID0gZmllbGRDb250ZW50ICYmICh0eXBlb2YgZmllbGRDb250ZW50ID09IFwib2JqZWN0XCIgPyBmaWVsZENvbnRlbnQgOiBKU09OLnBhcnNlKGZpZWxkQ29udGVudCkpO1xyXG4gICAgICAgIGxldCBzZWxlY3RlZEZpZWxkcyA9IGZpZWxkQ29uZmlnICYmIGZpZWxkQ29uZmlnLnNjaGVtYSAmJiBmaWVsZENvbmZpZy5zY2hlbWFbdGhpcy5zY2hlbWFUYWJsZS50YWJsZU5hbWVdICYmIGZpZWxkQ29uZmlnLnNjaGVtYVt0aGlzLnNjaGVtYVRhYmxlLnRhYmxlTmFtZV0uZmllbGRzO1xyXG4gICAgICAgIHNlbGVjdGVkRmllbGRzID0gc2VsZWN0ZWRGaWVsZHMgPyBzZWxlY3RlZEZpZWxkcyA6IFtdO1xyXG4gICAgICAgIGxldCBzaG93Q3VzdG9tRmllbGRzID0gYnRzLmJpbGxUcmFja2luZ0RhdGFTaG93bk1vZGUgPT09IEJpbGxUcmFja2luZ0RhdGFTaG93bk1vZGUuQ1VTVE9NRklFTEQ7XHJcblxyXG4gICAgICAgIGNvbnN0IGZzID0gdGhpcy5zY2hlbWFUYWJsZS5nZXRGaWVsZExpc3QoKTtcclxuICAgICAgICAvLyDmj5Dlj5blrZfmrrVcclxuICAgICAgICBsZXQgZmZzID0gdGhpcy5kYXRhSW5mb1NlcnZpY2UuZXh0cmFjdEZGaWVsZHMoZnMsIHNlbGVjdGVkRmllbGRzLCBzaG93Q3VzdG9tRmllbGRzKTtcclxuICAgICAgICAvLyDnrZvpgInmmL7npLrliJdcclxuICAgICAgICBmZnMgPSBmZnMuZmlsdGVyKGYgPT4gZi5zaG93KTtcclxuICAgICAgICAvLyDmjIlvcmRlcuaOkuW6j1xyXG4gICAgICAgIGZmcyA9IHRoaXMuZGF0YUluZm9TZXJ2aWNlLnNvcnRGaWVsZHNCeU9yZGVyKGZmcyk7XHJcblxyXG4gICAgICAgIC8vIOWIm+W7uuaYvuekuuWIl1xyXG4gICAgICAgIHRoaXMuZGdDb2xzID0gW107XHJcbiAgICAgICAgZmZzLmZvckVhY2goKGY6IEJpbGxTY2hlbWFGaWVsZCB8IEJpbGxTY2hlbWFTdWJGaWVsZCkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgYzogRGF0YUNvbHVtbiA9IHtcclxuICAgICAgICAgICAgICAgIGZpZWxkOiBmLmZpZWxkUGF0aCB8fCBmLmZpZWxkTmFtZSxcclxuICAgICAgICAgICAgICAgIHRpdGxlOiB0aGlzLmRhdGFJbmZvU2VydmljZS5nZXRGaWVsZExhYmVsKGYsIHRoaXMubG9jYWxlSWQpLFxyXG4gICAgICAgICAgICAgICAgd2lkdGg6IDEyMFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBpZiAoZi5kYXRhVHlwZSA9PSBEYXRhVHlwZS5Cb29sZWFuKSB7XHJcbiAgICAgICAgICAgICAgICBjLmZvcm1hdHRlciA9ICh2YWx1ZTogYm9vbGVhbiwgcm93RGF0YSwgcm93SW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgPT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcInllc1wiKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwibm9cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiLVwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmRnQ29scy5wdXNoKGMpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDmnoTlu7rooYzmlbDmja5cclxuICAgICAgICBjb25zdCByb3dzID0gdGhpcy5kYXRhVGFibGUuR2V0Um93TGlzdCgpO1xyXG4gICAgICAgIHRoaXMuZGdEYXRhID0gWy4uLnRoaXMuZGF0YUluZm9TZXJ2aWNlLmV4dHJhY3REYXRhUm93cyhyb3dzLCBmZnMsIGZzLCB0aGlzLmRnSWRGaWVsZCldO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5kZ0RhdGEubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGcgJiYgdGhpcy5kZy5zZWxlY3RSb3codGhpcy5kZ0RhdGFbMF1bdGhpcy5kZ0lkRmllbGRdKTtcclxuICAgICAgICAgICAgfSwgNTAwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0Q2hhbmdlZChyb3c6IFNlbGVjdGVkUm93KSB7XHJcbiAgICAgICAgY29uc3QgciA9IHRoaXMuZGF0YVRhYmxlLkdldFJvd01hcCgpW3Jvdy5pZF07XHJcbiAgICAgICAgdGhpcy5zaG93RGV0YWlsID0gdGhpcy5kYXRhSW5mb1NlcnZpY2UuaGFzQ2hpbGREYXRhKHIsIHRoaXMuYmlsbEluZm8pO1xyXG4gICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuXHJcbiAgICB2aWV3Q2hpbGREYXRhKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnLnNlbGVjdGVkUm93ID09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy5ub3RpZnkud2FybmluZyh0aGlzLmxvY2FsZVBpcGUudHJhbnNmb3JtKFwic2VsZWN0T25lRmlyc3RcIikpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCByb3cgPSB0aGlzLmRhdGFUYWJsZS5HZXRSb3dNYXAoKVt0aGlzLmRnLnNlbGVjdGVkUm93LmlkXTtcclxuICAgICAgICBpZiAoIXRoaXMuZGF0YUluZm9TZXJ2aWNlLmhhc0NoaWxkRGF0YShyb3csIHRoaXMuYmlsbEluZm8pKSB7XHJcbiAgICAgICAgICAgIHRoaXMubm90aWZ5LmluZm8odGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcIm5vQ2hpbGREYXRhXCIpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY21wRiA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KENoaWxkSW5mb0xpc3RDb21wb25lbnQpO1xyXG4gICAgICAgIGNvbnN0IGNtcFIgPSBjbXBGLmNyZWF0ZSh0aGlzLmluaiwgW10pO1xyXG4gICAgICAgIC8vIOiOt+WPluWtkOihqOWIl+ihqFxyXG4gICAgICAgIGNvbnN0IGNoaWxkU2NoZW1hVGFibGVzID0gdGhpcy5kYXRhSW5mb1NlcnZpY2UuZ2V0Q2hpbGRUYWJsZXModGhpcy5iaWxsSW5mbywgdGhpcy5zY2hlbWFUYWJsZSk7XHJcbiAgICAgICAgY21wUi5pbnN0YW5jZS5jaGlsZFNjaGVtYVRhYmxlcyA9IGNoaWxkU2NoZW1hVGFibGVzO1xyXG4gICAgICAgIGNtcFIuaW5zdGFuY2UuY2hpbGREYXRhVGFibGVNYXAgPSByb3cuR2V0Q2hpbGRUYWJsZU1hcCgpO1xyXG4gICAgICAgIGNtcFIuaW5zdGFuY2UuYmlsbEluZm8gPSB0aGlzLmJpbGxJbmZvO1xyXG4gICAgICAgIGNvbnN0IGJzTW9kYWxSZWYgPSB0aGlzLm1vZGFsLnNob3coY21wUiwge1xyXG4gICAgICAgICAgICB0aXRsZTogdGhpcy5sb2NhbGVQaXBlLnRyYW5zZm9ybShcImNoaWxkRGF0YVwiKSxcclxuICAgICAgICAgICAgd2lkdGg6IDkwMCxcclxuICAgICAgICAgICAgaGVpZ2h0OiA2MDAsXHJcbiAgICAgICAgICAgIHNob3dCdXR0b25zOiBmYWxzZSxcclxuICAgICAgICB9KTtcclxuICAgICAgICBjbXBSLmluc3RhbmNlLmJzTW9kYWxSZWYgPSBic01vZGFsUmVmO1xyXG4gICAgfVxyXG59Il19