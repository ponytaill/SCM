import * as tslib_1 from "tslib";
import { BindingPropertyType } from './binding_property';
import { PropertyUtil } from './property_util';
import { BaseBindingObject } from './base_binding_object';
import { BindingListFactory } from './binding_list_factory';
import { TranslateService } from '../i18n/translate_service';
// import { BindingObjectFactory } from './binding_object_factory';
/**
 * BindingObjectTypeFactory
 */
var BindingObjectTypeFactory = /** @class */ (function () {
    function BindingObjectTypeFactory() {
    }
    /**
     * 创建BindingObject
     * @param properties
     * @param data
     * @returns
     */
    BindingObjectTypeFactory.create = function (properties /*, data?: any*/) {
        var bindingObjectType = this.getType(properties);
        return new bindingObjectType();
    };
    /**
     * 创建原型类型
     * @param properties
     * @returns
     */
    BindingObjectTypeFactory.createType = function (properties) {
        // 继承原绑定对象所有属性
        var bindingObjectType = /** @class */ (function (_super) {
            tslib_1.__extends(BindingObjectType, _super);
            function BindingObjectType() {
                return _super.call(this) || this;
                // this.innerValues = ImmutableMap(Object.assign({}, data));
            }
            return BindingObjectType;
        }(BaseBindingObject));
        // 获取主键
        var primaryKey = PropertyUtil.getPrimaryKey(properties);
        // 设置主键
        bindingObjectType.prototype.primaryKey = primaryKey;
        bindingObjectType.prototype.properties = properties;
        // 将属性扩展到原型对象上
        this.extendProperties(bindingObjectType.prototype, properties);
        return bindingObjectType;
    };
    /**
     * 扩展原型属性
     * @param typePrototype
     * @param properties
     */
    BindingObjectTypeFactory.extendProperties = function (typePrototype, properties) {
        var _this = this;
        // 扩展BindingObject属性
        properties.forEach(function (property) {
            if (property.type === BindingPropertyType.List) {
                _this.extendListProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Object) {
                _this.extendObjectProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                _this.extendDynamicObjectProperty(typePrototype, property);
            }
            else {
                _this.extendPlainProperty(typePrototype, property);
            }
        });
    };
    /**
     * 扩展原型列表属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendListProperty = function (typePrototype, property) {
        var propertyName = property.name;
        var childListProperties = PropertyUtil.getProperties(property.entityType);
        var key = "_" + propertyName + "_";
        // 将子的BindingList实例赋值给当前属性
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                var _this = this;
                var bindingList = this[key];
                if (!bindingList) {
                    bindingList = BindingListFactory.create(childListProperties);
                    this[key] = bindingList;
                    // 加载数据
                    var data = this.getValue(propertyName);
                    if (data) {
                        var bindingObjects = data.map(function (item) {
                            var bindingObject = BindingObjectTypeFactory.create(childListProperties);
                            return bindingObject;
                        });
                        bindingList.load(bindingObjects);
                    }
                    // 指定子List的parent、监听子List的changes事件
                    bindingList.parent = this;
                    bindingList.changes.subscribe(function (change) {
                        change.path.unshift(propertyName);
                        _this.changes.next(change);
                    });
                }
                return bindingList;
            },
            set: function (bindingList) {
                this[key] = bindingList;
            }
        });
    };
    /**
     * 扩展原型对象属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendObjectProperty = function (typePrototype, property) {
        var propertyName = property.name;
        var childObjectProperties = PropertyUtil.getProperties(property.entityType);
        var key = "_" + propertyName + "_";
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                var _this = this;
                var bindingObject = this[key];
                if (!bindingObject) {
                    var value = this.getValue(propertyName) || {};
                    bindingObject = BindingObjectTypeFactory.create(childObjectProperties);
                    this[key] = bindingObject;
                    // 指定子Object的parent、监听子Object的changes事件
                    bindingObject.parent = this;
                    bindingObject.changes.subscribe(function (change) {
                        change.path.unshift(propertyName);
                        _this.changes.next(change);
                    });
                }
                return bindingObject;
            },
            set: function (value) {
                this[key] = value;
            }
        });
    };
    /**
     * 扩展原型动态属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendDynamicObjectProperty = function (typePrototype, property) {
        var propertyName = property.name;
        // Object.defineProperty(typePrototype, propertyName, {
        //   value: null
        // });
        typePrototype[propertyName] = null;
    };
    /**
     * 扩展原型简单属性
     * @param typePrototype
     * @param property
     */
    BindingObjectTypeFactory.extendPlainProperty = function (typePrototype, property) {
        var propertyName = property.name;
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                var _a;
                if (property.enableMultiLangInput === true) {
                    var value = this.getValue(propertyName, false);
                    if (!value) {
                        value = this.getValue(propertyName, false);
                        var langCode = TranslateService.getCurrentLanguage();
                        return _a = {}, _a[langCode] = value, _a;
                    }
                    return value;
                }
                else {
                    var value = this.getValue(propertyName);
                    return value;
                }
            },
            set: function (value) {
                var oldValue = this.getValue(propertyName);
                if (value === oldValue) {
                    return;
                }
                this.setValue(propertyName, value, true, true);
            }
        });
    };
    /**
     * 获取缓存的bindingList模板类
     * @param properties bindingList属性
     * @returns
     */
    BindingObjectTypeFactory.getType = function (properties) {
        if (this.provider.has(properties)) {
            return this.provider.get(properties);
        }
        var bindingObjectType = this.createType(properties);
        this.provider.set(properties, bindingObjectType);
        return bindingObjectType;
    };
    BindingObjectTypeFactory.provider = new Map();
    return BindingObjectTypeFactory;
}());
export { BindingObjectTypeFactory };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19vYmplY3RfdHlwZV9mYWN0b3J5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1kYXRhL2JpbmRpbmdfb2JqZWN0X3R5cGVfZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBR0EsT0FBTyxFQUFtQixtQkFBbUIsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRTFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUc1RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM3RCxtRUFBbUU7QUFFbkU7O0dBRUc7QUFDSDtJQUFBO0lBa1BBLENBQUM7SUFoUEM7Ozs7O09BS0c7SUFDVywrQkFBTSxHQUFwQixVQUFxQixVQUE2QixDQUFBLGdCQUFnQjtRQUNoRSxJQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDbkQsT0FBTyxJQUFJLGlCQUFpQixFQUFFLENBQUM7SUFDakMsQ0FBQztJQUNEOzs7O09BSUc7SUFDWSxtQ0FBVSxHQUF6QixVQUEwQixVQUE2QjtRQUNyRCxjQUFjO1FBQ2QsSUFBTSxpQkFBaUI7WUFBbUMsNkNBQWlCO1lBQ3pFO3VCQUNFLGlCQUFPO2dCQUNQLDREQUE0RDtZQUU5RCxDQUFDO1lBZ0VILHdCQUFDO1FBQUQsQ0FBQyxBQXJFeUIsQ0FBZ0MsaUJBQWlCLEVBcUUxRSxDQUFDO1FBQ0YsT0FBTztRQUNQLElBQU0sVUFBVSxHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDMUQsT0FBTztRQUNQLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQ3BELGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQ3BELGNBQWM7UUFDZCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQy9ELE9BQU8saUJBQWlCLENBQUM7SUFDM0IsQ0FBQztJQUNEOzs7O09BSUc7SUFDWSx5Q0FBZ0IsR0FBL0IsVUFBZ0MsYUFBZ0MsRUFBRSxVQUE2QjtRQUEvRixpQkFhQztRQVpDLG9CQUFvQjtRQUNwQixVQUFVLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBeUI7WUFDM0MsSUFBSSxRQUFRLENBQUMsSUFBSSxLQUFLLG1CQUFtQixDQUFDLElBQUksRUFBRTtnQkFDOUMsS0FBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQzthQUNsRDtpQkFBTSxJQUFJLFFBQVEsQ0FBQyxJQUFJLEtBQUssbUJBQW1CLENBQUMsTUFBTSxFQUFFO2dCQUN2RCxLQUFJLENBQUMsb0JBQW9CLENBQUMsYUFBYSxFQUFFLFFBQVEsQ0FBQyxDQUFDO2FBQ3BEO2lCQUFNLElBQUksUUFBUSxDQUFDLElBQUksS0FBSyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUU7Z0JBQ3hELEtBQUksQ0FBQywyQkFBMkIsQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDM0Q7aUJBQU07Z0JBQ0wsS0FBSSxDQUFDLG1CQUFtQixDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQzthQUNuRDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOzs7O09BSUc7SUFDWSwyQ0FBa0IsR0FBakMsVUFBa0MsYUFBZ0MsRUFBRSxRQUF5QjtRQUMzRixJQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ25DLElBQU0sbUJBQW1CLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDNUUsSUFBTSxHQUFHLEdBQUcsTUFBSSxZQUFZLE1BQUcsQ0FBQztRQUNoQywwQkFBMEI7UUFDMUIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsWUFBWSxFQUFFO1lBQ2pELEdBQUcsRUFBRTtnQkFBQSxpQkFzQko7Z0JBckJDLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLFdBQVcsRUFBRTtvQkFDaEIsV0FBVyxHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO29CQUM3RCxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsV0FBVyxDQUFDO29CQUN4QixPQUFPO29CQUNQLElBQU0sSUFBSSxHQUFVLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQ2hELElBQUksSUFBSSxFQUFFO3dCQUNSLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQSxJQUFJOzRCQUNsQyxJQUFNLGFBQWEsR0FBRyx3QkFBd0IsQ0FBQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQzs0QkFDM0UsT0FBTyxhQUFhLENBQUM7d0JBQ3ZCLENBQUMsQ0FBQyxDQUFDO3dCQUNILFdBQVcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7cUJBQ2xDO29CQUNELG1DQUFtQztvQkFDbkMsV0FBVyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7b0JBQzFCLFdBQVcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFVBQUMsTUFBYzt3QkFDM0MsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBQ2xDLEtBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUM1QixDQUFDLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxPQUFPLFdBQVcsQ0FBQztZQUNyQixDQUFDO1lBQ0QsR0FBRyxFQUFFLFVBQVUsV0FBd0I7Z0JBQ3JDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxXQUFXLENBQUM7WUFDMUIsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRDs7OztPQUlHO0lBQ1ksNkNBQW9CLEdBQW5DLFVBQW9DLGFBQWdDLEVBQUUsUUFBeUI7UUFDN0YsSUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNuQyxJQUFNLHFCQUFxQixHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzlFLElBQU0sR0FBRyxHQUFHLE1BQUksWUFBWSxNQUFHLENBQUM7UUFDaEMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsWUFBWSxFQUFFO1lBQ2pELEdBQUcsRUFBRTtnQkFBQSxpQkFjSjtnQkFiQyxJQUFJLGFBQWEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxhQUFhLEVBQUU7b0JBQ2xCLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO29CQUNoRCxhQUFhLEdBQUcsd0JBQXdCLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLENBQUM7b0JBQ3ZFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxhQUFhLENBQUM7b0JBQzFCLHVDQUF1QztvQkFDdkMsYUFBYSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7b0JBQzVCLGFBQWEsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLFVBQUMsTUFBYzt3QkFDN0MsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7d0JBQ2xDLEtBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUM1QixDQUFDLENBQUMsQ0FBQztpQkFDSjtnQkFDRCxPQUFPLGFBQWEsQ0FBQztZQUN2QixDQUFDO1lBQ0QsR0FBRyxFQUFFLFVBQVUsS0FBd0I7Z0JBQ3JDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUM7WUFDcEIsQ0FBQztTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRDs7OztPQUlHO0lBQ1ksb0RBQTJCLEdBQTFDLFVBQTJDLGFBQWdDLEVBQUUsUUFBeUI7UUFDcEcsSUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNuQyx1REFBdUQ7UUFDdkQsZ0JBQWdCO1FBQ2hCLE1BQU07UUFDTixhQUFhLENBQUMsWUFBWSxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQ3JDLENBQUM7SUFDRDs7OztPQUlHO0lBQ1ksNENBQW1CLEdBQWxDLFVBQW1DLGFBQWdDLEVBQUUsUUFBeUI7UUFDNUYsSUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztRQUNuQyxNQUFNLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxZQUFZLEVBQUU7WUFDakQsR0FBRyxFQUFFOztnQkFDSCxJQUFJLFFBQVEsQ0FBQyxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7b0JBQzFDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUMvQyxJQUFJLENBQUMsS0FBSyxFQUFFO3dCQUNWLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsQ0FBQzt3QkFDM0MsSUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUMsa0JBQWtCLEVBQUUsQ0FBQzt3QkFDdkQsZ0JBQVMsR0FBQyxRQUFRLElBQUcsS0FBSyxLQUFHO3FCQUM5QjtvQkFDRCxPQUFPLEtBQUssQ0FBQztpQkFDZDtxQkFBTTtvQkFDTCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO29CQUMxQyxPQUFPLEtBQUssQ0FBQztpQkFDZDtZQUNILENBQUM7WUFDRCxHQUFHLEVBQUUsVUFBVSxLQUFVO2dCQUN2QixJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUM3QyxJQUFJLEtBQUssS0FBSyxRQUFRLEVBQUU7b0JBQ3RCLE9BQU87aUJBQ1I7Z0JBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNqRCxDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOzs7O09BSUc7SUFDWSxnQ0FBTyxHQUF0QixVQUF1QixVQUE2QjtRQUNsRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQ2pDLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDdEM7UUFDRCxJQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDakQsT0FBTyxpQkFBaUIsQ0FBQztJQUMzQixDQUFDO0lBaFBjLGlDQUFRLEdBQWdELElBQUksR0FBRyxFQUEwQyxDQUFDO0lBaVAzSCwrQkFBQztDQUFBLEFBbFBELElBa1BDO1NBbFBZLHdCQUF3QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuLy9pbXBvcnQgeyBNYXAgYXMgSW1tdXRhYmxlTWFwIH0gZnJvbSAnaW1tdXRhYmxlJztcclxuaW1wb3J0IHsgQ2hhbmdlIH0gZnJvbSAnLi9jaGFuZ2VzJztcclxuaW1wb3J0IHsgQmluZGluZ1Byb3BlcnR5LCBCaW5kaW5nUHJvcGVydHlUeXBlIH0gZnJvbSAnLi9iaW5kaW5nX3Byb3BlcnR5JztcclxuaW1wb3J0IHsgQmluZGluZ0xpc3QgfSBmcm9tICcuL2JpbmRpbmdfbGlzdCc7XHJcbmltcG9ydCB7IFByb3BlcnR5VXRpbCB9IGZyb20gJy4vcHJvcGVydHlfdXRpbCc7XHJcbmltcG9ydCB7IEJhc2VCaW5kaW5nT2JqZWN0IH0gZnJvbSAnLi9iYXNlX2JpbmRpbmdfb2JqZWN0JztcclxuaW1wb3J0IHsgQmluZGluZ0xpc3RGYWN0b3J5IH0gZnJvbSAnLi9iaW5kaW5nX2xpc3RfZmFjdG9yeSc7XHJcbmltcG9ydCB7IENsYXNzVHlwZSB9IGZyb20gJy4uL2VudGl0eSc7XHJcbmltcG9ydCB7IEJpbmRpbmdPYmplY3QgfSBmcm9tICcuL2JpbmRpbmdfb2JqZWN0JztcclxuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJy4uL2kxOG4vdHJhbnNsYXRlX3NlcnZpY2UnO1xyXG4vLyBpbXBvcnQgeyBCaW5kaW5nT2JqZWN0RmFjdG9yeSB9IGZyb20gJy4vYmluZGluZ19vYmplY3RfZmFjdG9yeSc7XHJcblxyXG4vKipcclxuICogQmluZGluZ09iamVjdFR5cGVGYWN0b3J5XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgQmluZGluZ09iamVjdFR5cGVGYWN0b3J5IHtcclxuICBwcml2YXRlIHN0YXRpYyBwcm92aWRlcjogTWFwPEJpbmRpbmdQcm9wZXJ0eVtdLCBUeXBlPEJpbmRpbmdPYmplY3Q+PiA9IG5ldyBNYXA8QmluZGluZ1Byb3BlcnR5W10sIFR5cGU8QmluZGluZ09iamVjdD4+KCk7XHJcbiAgLyoqXHJcbiAgICog5Yib5bu6QmluZGluZ09iamVjdFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzIFxyXG4gICAqIEBwYXJhbSBkYXRhIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgY3JlYXRlKHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdLyosIGRhdGE/OiBhbnkqLykge1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdFR5cGUgPSB0aGlzLmdldFR5cGUocHJvcGVydGllcyk7XHJcbiAgICByZXR1cm4gbmV3IGJpbmRpbmdPYmplY3RUeXBlKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuWOn+Wei+exu+Wei1xyXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGNyZWF0ZVR5cGUocHJvcGVydGllczogQmluZGluZ1Byb3BlcnR5W10pOiBDbGFzc1R5cGU8QmluZGluZ09iamVjdD4ge1xyXG4gICAgLy8g57un5om/5Y6f57uR5a6a5a+56LGh5omA5pyJ5bGe5oCnXHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0VHlwZSA9IGNsYXNzIEJpbmRpbmdPYmplY3RUeXBlIGV4dGVuZHMgQmFzZUJpbmRpbmdPYmplY3Qge1xyXG4gICAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIC8vIHRoaXMuaW5uZXJWYWx1ZXMgPSBJbW11dGFibGVNYXAoT2JqZWN0LmFzc2lnbih7fSwgZGF0YSkpO1xyXG5cclxuICAgICAgfVxyXG4gICAgICAvLyNlbmRyZWdpb24gbG9hZFxyXG5cclxuICAgICAgLypcclxuICAgICAgcHVibGljIGxvYWQoZGF0YTogYW55KSB7XHJcbiAgICAgICAgLy8gZGF0YeWMheWQq+WkmuivreWtl+autVxyXG4gICAgICAgIHRoaXMuaW5uZXJWYWx1ZXMgPSBJbW11dGFibGVNYXAoT2JqZWN0LmFzc2lnbih7fSwgZGF0YSkpO1xyXG4gICAgICAgIHRoaXMucHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSA9PiB7XHJcbiAgICAgICAgICBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5MaXN0KSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZExpc3RzKHByb3BlcnR5KTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5PYmplY3QpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2FkT2JqZWN0cyhwcm9wZXJ0eSk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuRHluYW1pYykge1xyXG4gICAgICAgICAgICB0aGlzLmxvYWREeW5hbWljT2JqZWN0cyhwcm9wZXJ0eSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmxvYWRGaWVsZHMocHJvcGVydHkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZEZpZWxkcyhwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgICAgICBjb25zdCBkYXRhRmllbGQgPSBwcm9wZXJ0eS5kYXRhRmllbGQgfHwgcHJvcGVydHlOYW1lO1xyXG4gICAgICAgIGxldCB2YWx1ZTtcclxuICAgICAgICBpZiAocHJvcGVydHkuZW5hYmxlTXVsdGlMYW5nSW5wdXQpIHtcclxuICAgICAgICAgIHZhbHVlID0gdGhpcy5nZXRWYWx1ZShkYXRhRmllbGQsIGZhbHNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZExpc3RzKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICAgIGNvbnN0IGtleSA9IGBfJHtwcm9wZXJ0eU5hbWV9X2A7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpc1trZXldO1xyXG4gICAgICAgIGlmIChiaW5kaW5nTGlzdCkge1xyXG4gICAgICAgICAgY29uc3QgY2hpbGRMaXN0UHJvcGVydGllcyA9IFByb3BlcnR5VXRpbC5nZXRQcm9wZXJ0aWVzKHByb3BlcnR5LmVudGl0eVR5cGUpO1xyXG4gICAgICAgICAgY29uc3QgZGF0YTogYW55W10gPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0cyA9IGRhdGEubWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnkuY3JlYXRlKGNoaWxkTGlzdFByb3BlcnRpZXMpO1xyXG4gICAgICAgICAgICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgYmluZGluZ0xpc3QubG9hZChiaW5kaW5nT2JqZWN0cyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZE9iamVjdHMocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkge1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gYF8ke3Byb3BlcnR5TmFtZX1fYDtcclxuICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKSB8fCB7fTtcclxuICAgICAgICBjb25zdCBjaGlsZE9iamVjdFByb3BlcnRpZXMgPSBQcm9wZXJ0eVV0aWwuZ2V0UHJvcGVydGllcyhwcm9wZXJ0eS5lbnRpdHlUeXBlKTtcclxuICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gQmluZGluZ09iamVjdFR5cGVGYWN0b3J5LmNyZWF0ZShjaGlsZE9iamVjdFByb3BlcnRpZXMpO1xyXG4gICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdPYmplY3Q7XHJcblxyXG4gICAgICB9XHJcbiAgICAgIHByaXZhdGUgbG9hZER5bmFtaWNPYmplY3RzKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpIHx8IHt9O1xyXG4gICAgICAgIGNvbnN0IGR5bmFtaWNPYmplY3QgPSBCaW5kaW5nT2JqZWN0RmFjdG9yeS5jcmVhdGVEeW5hbWljQmluZGluZ09iamVjdCh2YWx1ZSk7XHJcbiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgICAgdmFsdWU6IGR5bmFtaWNPYmplY3RcclxuICAgICAgICB9KTtcclxuICAgICAgfSovXHJcbiAgICAgIC8vI2VuZHJlZ2lvblxyXG4gICAgfTtcclxuICAgIC8vIOiOt+WPluS4u+mUrlxyXG4gICAgY29uc3QgcHJpbWFyeUtleSA9IFByb3BlcnR5VXRpbC5nZXRQcmltYXJ5S2V5KHByb3BlcnRpZXMpO1xyXG4gICAgLy8g6K6+572u5Li76ZSuXHJcbiAgICBiaW5kaW5nT2JqZWN0VHlwZS5wcm90b3R5cGUucHJpbWFyeUtleSA9IHByaW1hcnlLZXk7XHJcbiAgICBiaW5kaW5nT2JqZWN0VHlwZS5wcm90b3R5cGUucHJvcGVydGllcyA9IHByb3BlcnRpZXM7XHJcbiAgICAvLyDlsIblsZ7mgKfmianlsZXliLDljp/lnovlr7nosaHkuIpcclxuICAgIHRoaXMuZXh0ZW5kUHJvcGVydGllcyhiaW5kaW5nT2JqZWN0VHlwZS5wcm90b3R5cGUsIHByb3BlcnRpZXMpO1xyXG4gICAgcmV0dXJuIGJpbmRpbmdPYmplY3RUeXBlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmianlsZXljp/lnovlsZ7mgKdcclxuICAgKiBAcGFyYW0gdHlwZVByb3RvdHlwZSBcclxuICAgKiBAcGFyYW0gcHJvcGVydGllcyBcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRQcm9wZXJ0aWVzKHR5cGVQcm90b3R5cGU6IEJhc2VCaW5kaW5nT2JqZWN0LCBwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXSkge1xyXG4gICAgLy8g5omp5bGVQmluZGluZ09iamVjdOWxnuaAp1xyXG4gICAgcHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSA9PiB7XHJcbiAgICAgIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLkxpc3QpIHtcclxuICAgICAgICB0aGlzLmV4dGVuZExpc3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eSk7XHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5PYmplY3QpIHtcclxuICAgICAgICB0aGlzLmV4dGVuZE9iamVjdFByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5KTtcclxuICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLkR5bmFtaWMpIHtcclxuICAgICAgICB0aGlzLmV4dGVuZER5bmFtaWNPYmplY3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmRQbGFpblByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleWOn+Wei+WIl+ihqOWxnuaAp1xyXG4gICAqIEBwYXJhbSB0eXBlUHJvdG90eXBlIFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eSBcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRMaXN0UHJvcGVydHkodHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICBjb25zdCBjaGlsZExpc3RQcm9wZXJ0aWVzID0gUHJvcGVydHlVdGlsLmdldFByb3BlcnRpZXMocHJvcGVydHkuZW50aXR5VHlwZSk7XHJcbiAgICBjb25zdCBrZXkgPSBgXyR7cHJvcGVydHlOYW1lfV9gO1xyXG4gICAgLy8g5bCG5a2Q55qEQmluZGluZ0xpc3Tlrp7kvovotYvlgLznu5nlvZPliY3lsZ7mgKdcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbGV0IGJpbmRpbmdMaXN0ID0gdGhpc1trZXldO1xyXG4gICAgICAgIGlmICghYmluZGluZ0xpc3QpIHtcclxuICAgICAgICAgIGJpbmRpbmdMaXN0ID0gQmluZGluZ0xpc3RGYWN0b3J5LmNyZWF0ZShjaGlsZExpc3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdMaXN0O1xyXG4gICAgICAgICAgLy8g5Yqg6L295pWw5o2uXHJcbiAgICAgICAgICBjb25zdCBkYXRhOiBhbnlbXSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3RzID0gZGF0YS5tYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IEJpbmRpbmdPYmplY3RUeXBlRmFjdG9yeS5jcmVhdGUoY2hpbGRMaXN0UHJvcGVydGllcyk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdPYmplY3Q7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBiaW5kaW5nTGlzdC5sb2FkKGJpbmRpbmdPYmplY3RzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOaMh+WumuWtkExpc3TnmoRwYXJlbnTjgIHnm5HlkKzlrZBMaXN055qEY2hhbmdlc+S6i+S7tlxyXG4gICAgICAgICAgYmluZGluZ0xpc3QucGFyZW50ID0gdGhpcztcclxuICAgICAgICAgIGJpbmRpbmdMaXN0LmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICAgICAgICBjaGFuZ2UucGF0aC51bnNoaWZ0KHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KGNoYW5nZSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGJpbmRpbmdMaXN0O1xyXG4gICAgICB9LFxyXG4gICAgICBzZXQ6IGZ1bmN0aW9uIChiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QpIHtcclxuICAgICAgICB0aGlzW2tleV0gPSBiaW5kaW5nTGlzdDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleWOn+Wei+WvueixoeWxnuaAp1xyXG4gICAqIEBwYXJhbSB0eXBlUHJvdG90eXBlIFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eSBcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRPYmplY3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlOiBCYXNlQmluZGluZ09iamVjdCwgcHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSk6IHZvaWQge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgIGNvbnN0IGNoaWxkT2JqZWN0UHJvcGVydGllcyA9IFByb3BlcnR5VXRpbC5nZXRQcm9wZXJ0aWVzKHByb3BlcnR5LmVudGl0eVR5cGUpO1xyXG4gICAgY29uc3Qga2V5ID0gYF8ke3Byb3BlcnR5TmFtZX1fYDtcclxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgbGV0IGJpbmRpbmdPYmplY3QgPSB0aGlzW2tleV07XHJcbiAgICAgICAgaWYgKCFiaW5kaW5nT2JqZWN0KSB7XHJcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKSB8fCB7fTtcclxuICAgICAgICAgIGJpbmRpbmdPYmplY3QgPSBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnkuY3JlYXRlKGNoaWxkT2JqZWN0UHJvcGVydGllcyk7XHJcbiAgICAgICAgICB0aGlzW2tleV0gPSBiaW5kaW5nT2JqZWN0O1xyXG4gICAgICAgICAgLy8g5oyH5a6a5a2QT2JqZWN055qEcGFyZW5044CB55uR5ZCs5a2QT2JqZWN055qEY2hhbmdlc+S6i+S7tlxyXG4gICAgICAgICAgYmluZGluZ09iamVjdC5wYXJlbnQgPSB0aGlzO1xyXG4gICAgICAgICAgYmluZGluZ09iamVjdC5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgICAgICAgY2hhbmdlLnBhdGgudW5zaGlmdChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgICB0aGlzLmNoYW5nZXMubmV4dChjaGFuZ2UpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBiaW5kaW5nT2JqZWN0O1xyXG4gICAgICB9LFxyXG4gICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZTogQmFzZUJpbmRpbmdPYmplY3QpIHtcclxuICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleWOn+Wei+WKqOaAgeWxnuaAp1xyXG4gICAqIEBwYXJhbSB0eXBlUHJvdG90eXBlIFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eSBcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmREeW5hbWljT2JqZWN0UHJvcGVydHkodHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAvLyBPYmplY3QuZGVmaW5lUHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAvLyAgIHZhbHVlOiBudWxsXHJcbiAgICAvLyB9KTtcclxuICAgIHR5cGVQcm90b3R5cGVbcHJvcGVydHlOYW1lXSA9IG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleWOn+Wei+eugOWNleWxnuaAp1xyXG4gICAqIEBwYXJhbSB0eXBlUHJvdG90eXBlIFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eSBcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRQbGFpblByb3BlcnR5KHR5cGVQcm90b3R5cGU6IEJhc2VCaW5kaW5nT2JqZWN0LCBwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KTogdm9pZCB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAocHJvcGVydHkuZW5hYmxlTXVsdGlMYW5nSW5wdXQgPT09IHRydWUpIHtcclxuICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lLCBmYWxzZSk7XHJcbiAgICAgICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUsIGZhbHNlKTtcclxuICAgICAgICAgICAgY29uc3QgbGFuZ0NvZGUgPSBUcmFuc2xhdGVTZXJ2aWNlLmdldEN1cnJlbnRMYW5ndWFnZSgpO1xyXG4gICAgICAgICAgICByZXR1cm4geyBbbGFuZ0NvZGVdOiB2YWx1ZSB9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuICAgICAgICBpZiAodmFsdWUgPT09IG9sZFZhbHVlKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2V0VmFsdWUocHJvcGVydHlOYW1lLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5bnvJPlrZjnmoRiaW5kaW5nTGlzdOaooeadv+exu1xyXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzIGJpbmRpbmdMaXN05bGe5oCnXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZ2V0VHlwZShwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXSk6IFR5cGU8QmluZGluZ09iamVjdD4ge1xyXG4gICAgaWYgKHRoaXMucHJvdmlkZXIuaGFzKHByb3BlcnRpZXMpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnByb3ZpZGVyLmdldChwcm9wZXJ0aWVzKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3RUeXBlID0gdGhpcy5jcmVhdGVUeXBlKHByb3BlcnRpZXMpO1xyXG4gICAgdGhpcy5wcm92aWRlci5zZXQocHJvcGVydGllcywgYmluZGluZ09iamVjdFR5cGUpO1xyXG4gICAgcmV0dXJuIGJpbmRpbmdPYmplY3RUeXBlO1xyXG4gIH1cclxufSJdfQ==