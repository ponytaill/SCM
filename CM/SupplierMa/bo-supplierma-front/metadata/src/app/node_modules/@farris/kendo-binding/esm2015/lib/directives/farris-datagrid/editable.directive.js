import { Directive, Input, Injector, NgZone, } from '@angular/core';
import { of } from 'rxjs';
import { BindingData, ViewModel } from '@farris/devkit';
import { DatagridComponent } from '@farris/ui-datagrid';
import { isNumber } from 'lodash-es';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { RuntimeStateService } from '@farris/ui-common';
import { DialogService } from '@farris/ui-dialog';
export class EditableDirective {
    constructor(bindingData, viewModel, grid, dateService, injector, rts, dialogSer, ngZone) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.grid = grid;
        this.dateService = dateService;
        this.injector = injector;
        this.rts = rts;
        this.dialogSer = dialogSer;
        this.ngZone = ngZone;
        /**
         * 编辑时取消分组
         */
        this.disableGroupOnEditing = true;
        /**
         * 临时记录grid分组字段
         */
        this.groupFields = [];
    }
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.bindingData.getValue(filteredPaths);
    }
    ngOnInit() {
        this.apply();
    }
    ngOnChanges(changes) {
        this.apply();
    }
    ngOnDestroy() {
        this.detach();
    }
    /**
     * 应用属性
     */
    apply() {
        if (!this.grid) {
            return;
        }
        this.handleGroupStatus();
        if (this.gridEditable) {
            // if(!this.grid.remoteFilter){
            //   this.grid.clearCondition();
            // }
            this.grid.editable = true;
            this.grid.disableHeader(true);
            this.handleBeginEditEvent();
            this.handleAfterEditEvent();
            this.handleEndEditEvent();
        }
        else {
            this.grid.editable = false;
            this.grid.disableHeader(false);
            if (this.grid && typeof this.grid.sort === 'function' && this.grid.sortName) {
                this.grid.sort();
            }
            this.detach();
        }
    }
    /**
     * 编辑时取消分组
     */
    handleGroupStatus() {
        if (this.disableGroupOnEditing === false) {
            return;
        }
        const groupField = this.grid && this.grid.groupField || null;
        if (groupField) {
            if (this.gridEditable) {
                this.groupFields = [groupField];
                this.grid.setGroupFields('');
            }
        }
        else {
            if (this.groupFields && this.groupFields.length > 0) {
                const groupField = this.groupFields.pop();
                if (this.groupFields.length > 0) {
                    this.groupFields = [];
                }
                this.grid.setGroupFields(groupField);
            }
        }
    }
    /**
     * 处理开始编辑事件
     */
    handleBeginEditEvent() {
        this.beginEditSubscription = this.grid.beginEdit.subscribe((e) => {
            if (!e) {
                return;
            }
            const column = e.column;
            if (column && column.editor) {
                const editorInstance = e.editor.componentRef.instance;
                if (!editorInstance || !editorInstance.instance) {
                    return;
                }
                let mapFields = editorInstance.instance.mapFields;
                if (column.editor.type === 'lookup' || column.editor.type === 'PersonnelSelector'
                    || column.editor.type === 'OrganizationSelector' || column.editor.type === 'external-integration') {
                    const subject = editorInstance.instance.selectedData;
                    if (subject) {
                        subject.subscribe((data) => {
                            mapFields = editorInstance.instance.mapFields;
                            this.lookupMapping(data, mapFields);
                        });
                    }
                    const clearMappings = editorInstance.instance.clearMappings;
                    if (clearMappings) {
                        clearMappings.subscribe((result) => {
                            const mapFields = Object.assign({}, editorInstance.instance.mapFields);
                            const value = result && result.value || null;
                            const binding = editorInstance.column && editorInstance.column.field;
                            const lookupTextField = editorInstance.instance.textField;
                            const data = {};
                            if (binding) {
                                const textFieldMapping = mapFields[lookupTextField];
                                if (textFieldMapping) {
                                    mapFields[lookupTextField] = textFieldMapping.split(',').filter(item => item !== binding).join(',');
                                }
                                const parentPaths = this.getBindingPathArray();
                                this.bindingData.setValue(parentPaths.concat(binding.split('.')), value, true, true);
                            }
                            // this.setValue(data, lookupTextField.split('.'), value);
                            Object.keys(mapFields).forEach(field => {
                                this.setValue(data, field.split('.'), '');
                            });
                            this.lookupMapping(data, mapFields, true);
                        });
                    }
                }
                if (column.editor.type === 'combo-lookup') {
                    editorInstance.instance.valueChange.subscribe((e) => {
                        mapFields = editorInstance.instance.mapFields;
                        this.lookupMapping(e.selections || [], mapFields);
                    });
                }
                if (editorInstance.instance.clear) {
                    editorInstance.instance.clear.subscribe(() => {
                        this.lookupMapping(null, mapFields);
                    });
                }
                if (column.editor.type === 'combolist') {
                    if (mapFields) {
                        editorInstance.instance.valueChange.subscribe(e => {
                            const pathArr = this.getBindingPathArray();
                            this.viewModel.bindingData.setValue(pathArr.concat(mapFields.split('.')), editorInstance.instance.selectedValues, true, true);
                        });
                    }
                }
            }
        });
    }
    /**
     * 处理编辑事件
     */
    handleAfterEditEvent() {
        this.grid.afterEdit = (rowIndex, rowData, column, editor) => {
            if (this.dialogSer.hasDialogOpened()) {
                return of(false);
            }
            if (this.rts) {
                // 帮助组件文本变化后去查询
                if (this.rts.getFormState('lookup.pending')) {
                    return of(false);
                }
            }
            // 更新数据源
            if (!editor || !editor.formControl) {
                return of(false);
            }
            return of(true);
        };
    }
    /**
     * 处理结束编辑事件
     */
    handleEndEditEvent() {
        this.endEditSubscription = this.grid && this.grid.endEdit && this.grid.endEdit.subscribe((event) => {
            const { value = undefined, column = undefined, rowData = {} } = event || {};
            const primaryValue = rowData && rowData[this.grid.idField] || null;
            this.updateBindingData(value, column, primaryValue);
        });
    }
    /*
     * 给列表赋值 或给formcontrol赋值
     */
    updateBindingData(value, column, primaryValue) {
        if (!column) {
            return;
        }
        const currentColumnType = column.dataType;
        // 同时判断gridOption的列对象
        const fieldPaths = column.field.split('.');
        // 是否为大数
        const isBigNumber = column && column.editor && column.editor.options && column.editor.options.bigNumber;
        // 存在行编辑器
        if (currentColumnType === 'date') {
            let result;
            if (value) {
                result = this.dateService.formatTo(value, 'yyyy-MM-dd');
            }
            else {
                result = value;
            }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), result);
        }
        else if (currentColumnType === 'datetime') {
            // if (!value) {
            //   value = '0001-01-01T00:00:00';
            // }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
        else if (currentColumnType === 'number' && !isBigNumber) {
            if (value === null || value === undefined) {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), null);
            }
            else {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), Number(value));
            }
        }
        else {
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
    }
    updateBindingList(primaryValue, propertyName, value) {
        const viewModel = this.viewModel || null;
        if (!viewModel || !propertyName) {
            return;
        }
        // 更新主表部分行的字段
        const propertyNames = propertyName.split('.').filter(item => item);
        const bindingPath = this.getBindingPathArray();
        // 取出来的一定是bindingList
        const list = this.bindingData.getValue(bindingPath);
        // 修改的是当前行
        if (list && primaryValue === list.currentItem.primaryKeyValue) {
            const paths = bindingPath.concat(propertyNames);
            this.bindingData.setValue(paths, value, true, true);
            return;
        }
        const bindingObject = this.bindingList.findById(primaryValue);
        if (!bindingObject) {
            return;
        }
        if (propertyNames.length < 2) {
            bindingObject.setValue(propertyName, value, true, true);
        }
        else {
            let targetBindingObject = null;
            const fpaths = propertyNames.slice(0, propertyNames.length - 1);
            const targetPropertyName = propertyNames[propertyNames.length - 1];
            fpaths.forEach(prop => {
                targetBindingObject = targetBindingObject && targetBindingObject[prop] || bindingObject[prop];
            });
            // todo:需要添加值变化事件
            targetBindingObject.setValue(targetPropertyName, value, true, true);
        }
    }
    detach() {
        if (this.beginEditSubscription && typeof this.beginEditSubscription.unsubscribe === 'function') {
            this.beginEditSubscription.unsubscribe();
        }
        if (this.endEditSubscription && typeof this.endEditSubscription.unsubscribe === 'function') {
            this.endEditSubscription.unsubscribe();
        }
    }
    //#region 帮助字段映射
    lookupMapping(helpData, mapFields, asClear = false) {
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        const appContext = this.viewModel.frameContext.appContext;
        appContext.changeDetectionController.detach();
        const pathArr = this.getBindingPathArray();
        let helpFields = Object.keys(mapFields);
        const primaryInfo = this.getMapFieldsPrimaryKey(mapFields, pathArr);
        let primaryKeys = primaryInfo && primaryInfo.map(item => item.primaryKey) || [];
        const primaryFields = primaryInfo && primaryInfo.map(item => item.primaryField) || [];
        // 去重
        if (primaryKeys && primaryKeys.length > 0) {
            primaryKeys = [...new Set(primaryKeys)];
            helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        }
        if (!helpData || asClear) {
            helpFields.reverse();
        }
        helpFields.forEach((f) => {
            let val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map((h) => {
                        return this.getValue(f, h);
                    }).join(',');
                }
                else {
                    val = this.getValue(f, helpData);
                }
            }
            let mappings = mapFields[f].split(',');
            const headMappings = mappings.filter(p => primaryFields.includes(p));
            const leftMappings = mappings.filter(p => !primaryFields.includes(p));
            if (!helpData) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            mappings.forEach((ff) => {
                if (!helpData) {
                    this.viewModel.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    this.viewModel.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            });
        });
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    }
    getValue(f, data) {
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((a, b) => {
                return a[b];
            }, data);
        }
        return val;
    }
    getBindingPathArray() {
        const path = this.viewModel.bindingPath;
        if (path) {
            return path.split('/').filter(n => n !== '');
        }
        return [];
    }
    isNumberValue(field, data) {
        const currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    }
    //#endregion
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    getMapFieldsPrimaryKey(mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        const results = [];
        // let primaryField = null;
        try {
            const entityTypeInfo = this.viewModel.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach((key) => {
                const mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    const mappings = mapField.split(',').filter(p => p);
                    mappings.forEach((item) => {
                        let paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        const propInfo = entityTypeInfo.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    }
    setValue(target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce((prev, path) => {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    }
    sortMapFieldKeys(keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        // 过滤出非主键映射字段
        keys = keys.filter(p => !primaryKeys.includes(p));
        return [].concat(primaryKeys).concat(keys);
    }
}
EditableDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-datagrid-editable]'
            },] }
];
/** @nocollapse */
EditableDirective.ctorParameters = () => [
    { type: BindingData },
    { type: ViewModel },
    { type: DatagridComponent },
    { type: DateTimeHelperService },
    { type: Injector },
    { type: RuntimeStateService },
    { type: DialogService },
    { type: NgZone }
];
EditableDirective.propDecorators = {
    gridEditable: [{ type: Input, args: ['farris-datagrid-editable',] }],
    disableGroupOnEditing: [{ type: Input, args: ['disableGroupOnEditing',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdGFibGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZmFycmlzLWRhdGFncmlkL2VkaXRhYmxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxLQUFLLEVBQ0MsUUFBUSxFQUFFLE1BQU0sR0FDL0UsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLEVBQUUsRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDeEMsT0FBTyxFQUNMLFdBQVcsRUFDbUIsU0FBUyxFQUN4QyxNQUFNLGdCQUFnQixDQUFDO0FBQ3hCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXhELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckMsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBS2xELE1BQU0sT0FBTyxpQkFBaUI7SUErQjVCLFlBQ1MsV0FBd0IsRUFDeEIsU0FBb0IsRUFDcEIsSUFBdUIsRUFDdEIsV0FBa0MsRUFDbkMsUUFBa0IsRUFDakIsR0FBd0IsRUFDekIsU0FBd0IsRUFDeEIsTUFBYztRQVBkLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDcEIsU0FBSSxHQUFKLElBQUksQ0FBbUI7UUFDdEIsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBQ25DLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDakIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFDekIsY0FBUyxHQUFULFNBQVMsQ0FBZTtRQUN4QixXQUFNLEdBQU4sTUFBTSxDQUFR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O1FBQ0QsYUFBYTtRQUNiLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QyxDQUFDOzs7WUExYUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSw0QkFBNEI7YUFDdkM7Ozs7WUFaQyxXQUFXO1lBQ21CLFNBQVM7WUFFaEMsaUJBQWlCO1lBR2pCLHFCQUFxQjtZQVZrQyxRQUFRO1lBVy9ELG1CQUFtQjtZQUNuQixhQUFhO1lBWm9ELE1BQU07OzsyQkFxQjdFLEtBQUssU0FBQywwQkFBMEI7b0NBSWhDLEtBQUssU0FBQyx1QkFBdUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSwgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgU2ltcGxlQ2hhbmdlcywgSW5wdXQsIEhvc3RMaXN0ZW5lciwgT3B0aW9uYWwsXHJcbiAgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIEVsZW1lbnRSZWYsIENvbnRlbnRDaGlsZHJlbiwgUXVlcnlMaXN0LCBJbmplY3RvciwgTmdab25lLFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBvZiwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7XHJcbiAgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBDaGFuZ2UsIENoYW5nZVR5cGUsXHJcbiAgRnJhbWVFdmVudEJ1cywgVUlTdGF0ZSwgRm9ybSwgVmlld01vZGVsLCBEYXRhVHlwZUluZm8sIERhdGFQcm9wSW5mb1xyXG59IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuXHJcbmltcG9ydCB7IGlzTnVtYmVyIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgRGF0ZVRpbWVIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vZGF0ZSc7XHJcbmltcG9ydCB7IFJ1bnRpbWVTdGF0ZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IERpYWxvZ1NlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWRpYWxvZyc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXMtZGF0YWdyaWQtZWRpdGFibGVdJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRWRpdGFibGVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuICAvKipcclxuICAgKiBncmlk5piv5ZCm5Y+v5Lul57yW6L6RXHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXMtZGF0YWdyaWQtZWRpdGFibGUnKSBncmlkRWRpdGFibGU6IGJvb2xlYW47XHJcbiAgLyoqXHJcbiAgICog57yW6L6R5pe25Y+W5raI5YiG57uEXHJcbiAgICovXHJcbiAgQElucHV0KCdkaXNhYmxlR3JvdXBPbkVkaXRpbmcnKSBkaXNhYmxlR3JvdXBPbkVkaXRpbmc6IGJvb2xlYW4gPSB0cnVlO1xyXG5cclxuICBwcml2YXRlIGJlZ2luRWRpdFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgZW5kRWRpdFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIC8qKlxyXG4gICAqIOS4tOaXtuiusOW9lWdyaWTliIbnu4TlrZfmrrVcclxuICAgKi9cclxuICBwcml2YXRlIGdyb3VwRmllbGRzOiBhbnlbXSA9IFtdO1xyXG4gIHByb3RlY3RlZCBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgLy8g5qC55a6e5L2TXHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09ICcvJyB8fCAhdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEubGlzdDtcclxuICAgIH1cclxuICAgIC8vIOWtkOWunuS9k1xyXG4gICAgbGV0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGguc3Vic3RyKDEpO1xyXG4gICAgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aFswXS50b0xvd2VyQ2FzZSgpICsgYmluZGluZ1BhdGguc3Vic3RyaW5nKDEsIGJpbmRpbmdQYXRoLmxlbmd0aCk7XHJcbiAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcblxyXG4gICAgY29uc3QgZmlsdGVyZWRQYXRocyA9IHBhdGhzLmZpbHRlcigocGFydDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiBwYXJ0ICE9PSAnJztcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoZmlsdGVyZWRQYXRocyk7XHJcbiAgfVxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHVibGljIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSxcclxuICAgIHB1YmxpYyB2aWV3TW9kZWw6IFZpZXdNb2RlbCxcclxuICAgIHB1YmxpYyBncmlkOiBEYXRhZ3JpZENvbXBvbmVudCxcclxuICAgIHByaXZhdGUgZGF0ZVNlcnZpY2U6IERhdGVUaW1lSGVscGVyU2VydmljZSxcclxuICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICBwcml2YXRlIHJ0czogUnVudGltZVN0YXRlU2VydmljZSxcclxuICAgIHB1YmxpYyBkaWFsb2dTZXI6IERpYWxvZ1NlcnZpY2UsXHJcbiAgICBwdWJsaWMgbmdab25lOiBOZ1pvbmVcclxuICApIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuYXBwbHkoKTtcclxuICB9XHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgdGhpcy5hcHBseSgpO1xyXG4gIH1cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuZGV0YWNoKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOW6lOeUqOWxnuaAp1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwbHkoKSB7XHJcbiAgICBpZiAoIXRoaXMuZ3JpZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmhhbmRsZUdyb3VwU3RhdHVzKCk7XHJcbiAgICBpZiAodGhpcy5ncmlkRWRpdGFibGUpIHtcclxuICAgICAgLy8gaWYoIXRoaXMuZ3JpZC5yZW1vdGVGaWx0ZXIpe1xyXG4gICAgICAvLyAgIHRoaXMuZ3JpZC5jbGVhckNvbmRpdGlvbigpO1xyXG4gICAgICAvLyB9XHJcbiAgICAgIHRoaXMuZ3JpZC5lZGl0YWJsZSA9IHRydWU7XHJcbiAgICAgIHRoaXMuZ3JpZC5kaXNhYmxlSGVhZGVyKHRydWUpO1xyXG4gICAgICB0aGlzLmhhbmRsZUJlZ2luRWRpdEV2ZW50KCk7XHJcbiAgICAgIHRoaXMuaGFuZGxlQWZ0ZXJFZGl0RXZlbnQoKTtcclxuICAgICAgdGhpcy5oYW5kbGVFbmRFZGl0RXZlbnQoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZ3JpZC5lZGl0YWJsZSA9IGZhbHNlO1xyXG4gICAgICB0aGlzLmdyaWQuZGlzYWJsZUhlYWRlcihmYWxzZSk7XHJcbiAgICAgIGlmICh0aGlzLmdyaWQgJiYgdHlwZW9mIHRoaXMuZ3JpZC5zb3J0ID09PSAnZnVuY3Rpb24nICYmIHRoaXMuZ3JpZC5zb3J0TmFtZSkge1xyXG4gICAgICAgIHRoaXMuZ3JpZC5zb3J0KCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5kZXRhY2goKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog57yW6L6R5pe25Y+W5raI5YiG57uEXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVHcm91cFN0YXR1cygpIHtcclxuICAgIGlmICh0aGlzLmRpc2FibGVHcm91cE9uRWRpdGluZyA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZ3JvdXBGaWVsZCA9IHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQuZ3JvdXBGaWVsZCB8fCBudWxsO1xyXG4gICAgaWYgKGdyb3VwRmllbGQpIHtcclxuICAgICAgaWYgKHRoaXMuZ3JpZEVkaXRhYmxlKSB7XHJcbiAgICAgICAgdGhpcy5ncm91cEZpZWxkcyA9IFtncm91cEZpZWxkXTtcclxuICAgICAgICB0aGlzLmdyaWQuc2V0R3JvdXBGaWVsZHMoJycpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAodGhpcy5ncm91cEZpZWxkcyAmJiB0aGlzLmdyb3VwRmllbGRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBncm91cEZpZWxkID0gdGhpcy5ncm91cEZpZWxkcy5wb3AoKTtcclxuICAgICAgICBpZiAodGhpcy5ncm91cEZpZWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICB0aGlzLmdyb3VwRmllbGRzID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ3JpZC5zZXRHcm91cEZpZWxkcyhncm91cEZpZWxkKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlpITnkIblvIDlp4vnvJbovpHkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZUJlZ2luRWRpdEV2ZW50KCkge1xyXG4gICAgdGhpcy5iZWdpbkVkaXRTdWJzY3JpcHRpb24gPSB0aGlzLmdyaWQuYmVnaW5FZGl0LnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgIGlmICghZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjb2x1bW4gPSBlLmNvbHVtbjtcclxuICAgICAgaWYgKGNvbHVtbiAmJiBjb2x1bW4uZWRpdG9yKSB7XHJcbiAgICAgICAgY29uc3QgZWRpdG9ySW5zdGFuY2UgPSBlLmVkaXRvci5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgICAgICAgaWYgKCFlZGl0b3JJbnN0YW5jZSB8fCAhZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IG1hcEZpZWxkcyA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlLm1hcEZpZWxkcztcclxuICAgICAgICBpZiAoY29sdW1uLmVkaXRvci50eXBlID09PSAnbG9va3VwJyB8fCBjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdQZXJzb25uZWxTZWxlY3RvcidcclxuICAgICAgICAgIHx8IGNvbHVtbi5lZGl0b3IudHlwZSA9PT0gJ09yZ2FuaXphdGlvblNlbGVjdG9yJyB8fCBjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdleHRlcm5hbC1pbnRlZ3JhdGlvbicpIHtcclxuICAgICAgICAgIGNvbnN0IHN1YmplY3QgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5zZWxlY3RlZERhdGE7XHJcbiAgICAgICAgICBpZiAoc3ViamVjdCkge1xyXG4gICAgICAgICAgICBzdWJqZWN0LnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgbWFwRmllbGRzID0gZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UubWFwRmllbGRzO1xyXG4gICAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhkYXRhLCBtYXBGaWVsZHMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGNsZWFyTWFwcGluZ3MgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5jbGVhck1hcHBpbmdzO1xyXG4gICAgICAgICAgaWYgKGNsZWFyTWFwcGluZ3MpIHtcclxuICAgICAgICAgICAgY2xlYXJNYXBwaW5ncy5zdWJzY3JpYmUoKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgbWFwRmllbGRzID0gT2JqZWN0LmFzc2lnbih7fSwgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UubWFwRmllbGRzKTtcclxuICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHJlc3VsdCAmJiByZXN1bHQudmFsdWUgfHwgbnVsbDtcclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nID0gZWRpdG9ySW5zdGFuY2UuY29sdW1uICYmIGVkaXRvckluc3RhbmNlLmNvbHVtbi5maWVsZDtcclxuICAgICAgICAgICAgICBjb25zdCBsb29rdXBUZXh0RmllbGQgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS50ZXh0RmllbGQ7XHJcbiAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHt9O1xyXG4gICAgICAgICAgICAgIGlmIChiaW5kaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0RmllbGRNYXBwaW5nID0gbWFwRmllbGRzW2xvb2t1cFRleHRGaWVsZF07XHJcbiAgICAgICAgICAgICAgICBpZiAodGV4dEZpZWxkTWFwcGluZykge1xyXG4gICAgICAgICAgICAgICAgICBtYXBGaWVsZHNbbG9va3VwVGV4dEZpZWxkXSA9IHRleHRGaWVsZE1hcHBpbmcuc3BsaXQoJywnKS5maWx0ZXIoaXRlbSA9PiBpdGVtICE9PSBiaW5kaW5nKS5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRQYXRocyA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXJlbnRQYXRocy5jb25jYXQoYmluZGluZy5zcGxpdCgnLicpKSwgdmFsdWUsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAvLyB0aGlzLnNldFZhbHVlKGRhdGEsIGxvb2t1cFRleHRGaWVsZC5zcGxpdCgnLicpLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgT2JqZWN0LmtleXMobWFwRmllbGRzKS5mb3JFYWNoKGZpZWxkID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoZGF0YSwgZmllbGQuc3BsaXQoJy4nKSwgJycpO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhkYXRhLCBtYXBGaWVsZHMsIHRydWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdjb21iby1sb29rdXAnKSB7XHJcbiAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS52YWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBtYXBGaWVsZHMgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhlLnNlbGVjdGlvbnMgfHwgW10sIG1hcEZpZWxkcyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGVkaXRvckluc3RhbmNlLmluc3RhbmNlLmNsZWFyKSB7XHJcbiAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cE1hcHBpbmcobnVsbCwgbWFwRmllbGRzKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29sdW1uLmVkaXRvci50eXBlID09PSAnY29tYm9saXN0Jykge1xyXG4gICAgICAgICAgaWYgKG1hcEZpZWxkcykge1xyXG4gICAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS52YWx1ZUNoYW5nZS5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgcGF0aEFyciA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICAgIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhBcnIuY29uY2F0KG1hcEZpZWxkcy5zcGxpdCgnLicpKSwgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2Uuc2VsZWN0ZWRWYWx1ZXMsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhue8lui+keS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFuZGxlQWZ0ZXJFZGl0RXZlbnQoKSB7XHJcbiAgICB0aGlzLmdyaWQuYWZ0ZXJFZGl0ID0gKHJvd0luZGV4LCByb3dEYXRhLCBjb2x1bW4sIGVkaXRvcikgPT4ge1xyXG4gICAgICBpZiAodGhpcy5kaWFsb2dTZXIuaGFzRGlhbG9nT3BlbmVkKCkpIHtcclxuICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLnJ0cykge1xyXG4gICAgICAgIC8vIOW4ruWKqee7hOS7tuaWh+acrOWPmOWMluWQjuWOu+afpeivolxyXG4gICAgICAgIGlmICh0aGlzLnJ0cy5nZXRGb3JtU3RhdGUoJ2xvb2t1cC5wZW5kaW5nJykpIHtcclxuICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIOabtOaWsOaVsOaNrua6kFxyXG4gICAgICBpZiAoIWVkaXRvciB8fCAhZWRpdG9yLmZvcm1Db250cm9sKSB7XHJcbiAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlpITnkIbnu5PmnZ/nvJbovpHkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZUVuZEVkaXRFdmVudCgpIHtcclxuICAgIHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbiA9IHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQuZW5kRWRpdCAmJiB0aGlzLmdyaWQuZW5kRWRpdC5zdWJzY3JpYmUoKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgeyB2YWx1ZSA9IHVuZGVmaW5lZCwgY29sdW1uID0gdW5kZWZpbmVkLCByb3dEYXRhID0ge30gfSA9IGV2ZW50IHx8IHt9O1xyXG4gICAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSByb3dEYXRhICYmIHJvd0RhdGFbdGhpcy5ncmlkLmlkRmllbGRdIHx8IG51bGw7XHJcbiAgICAgIHRoaXMudXBkYXRlQmluZGluZ0RhdGEodmFsdWUsIGNvbHVtbiwgcHJpbWFyeVZhbHVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICAvKlxyXG4gICAqIOe7meWIl+ihqOi1i+WAvCDmiJbnu5lmb3JtY29udHJvbOi1i+WAvFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlQmluZGluZ0RhdGEodmFsdWU6IGFueSwgY29sdW1uOiBhbnksIHByaW1hcnlWYWx1ZT86IGFueSkge1xyXG4gICAgaWYgKCFjb2x1bW4pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY3VycmVudENvbHVtblR5cGUgPSBjb2x1bW4uZGF0YVR5cGU7XHJcbiAgICAvLyDlkIzml7bliKTmlq1ncmlkT3B0aW9u55qE5YiX5a+56LGhXHJcblxyXG4gICAgY29uc3QgZmllbGRQYXRocyA9IGNvbHVtbi5maWVsZC5zcGxpdCgnLicpO1xyXG4gICAgLy8g5piv5ZCm5Li65aSn5pWwXHJcbiAgICBjb25zdCBpc0JpZ051bWJlciA9IGNvbHVtbiAmJiBjb2x1bW4uZWRpdG9yICYmIGNvbHVtbi5lZGl0b3Iub3B0aW9ucyAmJiBjb2x1bW4uZWRpdG9yLm9wdGlvbnMuYmlnTnVtYmVyO1xyXG4gICAgLy8g5a2Y5Zyo6KGM57yW6L6R5ZmoXHJcbiAgICBpZiAoY3VycmVudENvbHVtblR5cGUgPT09ICdkYXRlJykge1xyXG4gICAgICBsZXQgcmVzdWx0O1xyXG4gICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICByZXN1bHQgPSB0aGlzLmRhdGVTZXJ2aWNlLmZvcm1hdFRvKHZhbHVlLCAneXl5eS1NTS1kZCcpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc3VsdCA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMudXBkYXRlQmluZGluZ0xpc3QocHJpbWFyeVZhbHVlLCBmaWVsZFBhdGhzLmpvaW4oJy4nKSwgcmVzdWx0KTtcclxuICAgIH0gZWxzZSBpZiAoY3VycmVudENvbHVtblR5cGUgPT09ICdkYXRldGltZScpIHtcclxuICAgICAgLy8gaWYgKCF2YWx1ZSkge1xyXG4gICAgICAvLyAgIHZhbHVlID0gJzAwMDEtMDEtMDFUMDA6MDA6MDAnO1xyXG4gICAgICAvLyB9XHJcbiAgICAgIHRoaXMudXBkYXRlQmluZGluZ0xpc3QocHJpbWFyeVZhbHVlLCBmaWVsZFBhdGhzLmpvaW4oJy4nKSwgdmFsdWUpO1xyXG4gICAgfSBlbHNlIGlmIChjdXJyZW50Q29sdW1uVHlwZSA9PT0gJ251bWJlcicgJiYgIWlzQmlnTnVtYmVyKSB7XHJcbiAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWUsIGZpZWxkUGF0aHMuam9pbignLicpLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZSwgZmllbGRQYXRocy5qb2luKCcuJyksIE51bWJlcih2YWx1ZSkpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZSwgZmllbGRQYXRocy5qb2luKCcuJyksIHZhbHVlKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWU6IGFueSwgcHJvcGVydHlOYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgIGNvbnN0IHZpZXdNb2RlbCA9IHRoaXMudmlld01vZGVsIHx8IG51bGw7XHJcbiAgICBpZiAoIXZpZXdNb2RlbCB8fCAhcHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOabtOaWsOS4u+ihqOmDqOWIhuihjOeahOWtl+autVxyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lcyA9IHByb3BlcnR5TmFtZS5zcGxpdCgnLicpLmZpbHRlcihpdGVtID0+IGl0ZW0pO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgIC8vIOWPluWHuuadpeeahOS4gOWumuaYr2JpbmRpbmdMaXN0XHJcbiAgICBjb25zdCBsaXN0ID0gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aCkgYXMgQmluZGluZ0xpc3Q7XHJcbiAgICAvLyDkv67mlLnnmoTmmK/lvZPliY3ooYxcclxuICAgIGlmIChsaXN0ICYmIHByaW1hcnlWYWx1ZSA9PT0gbGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUpIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aC5jb25jYXQocHJvcGVydHlOYW1lcyk7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0VmFsdWUocGF0aHMsIHZhbHVlLCB0cnVlLCB0cnVlKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IHRoaXMuYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcclxuICAgIGlmICghYmluZGluZ09iamVjdCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAocHJvcGVydHlOYW1lcy5sZW5ndGggPCAyKSB7XHJcbiAgICAgIGJpbmRpbmdPYmplY3Quc2V0VmFsdWUocHJvcGVydHlOYW1lLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsZXQgdGFyZ2V0QmluZGluZ09iamVjdCA9IG51bGw7XHJcbiAgICAgIGNvbnN0IGZwYXRocyA9IHByb3BlcnR5TmFtZXMuc2xpY2UoMCwgcHJvcGVydHlOYW1lcy5sZW5ndGggLSAxKTtcclxuICAgICAgY29uc3QgdGFyZ2V0UHJvcGVydHlOYW1lID0gcHJvcGVydHlOYW1lc1twcm9wZXJ0eU5hbWVzLmxlbmd0aCAtIDFdO1xyXG4gICAgICBmcGF0aHMuZm9yRWFjaChwcm9wID0+IHtcclxuICAgICAgICB0YXJnZXRCaW5kaW5nT2JqZWN0ID0gdGFyZ2V0QmluZGluZ09iamVjdCAmJiB0YXJnZXRCaW5kaW5nT2JqZWN0W3Byb3BdIHx8IGJpbmRpbmdPYmplY3RbcHJvcF07XHJcbiAgICAgIH0pO1xyXG4gICAgICAvLyB0b2RvOumcgOimgea3u+WKoOWAvOWPmOWMluS6i+S7tlxyXG4gICAgICB0YXJnZXRCaW5kaW5nT2JqZWN0LnNldFZhbHVlKHRhcmdldFByb3BlcnR5TmFtZSwgdmFsdWUsIHRydWUsIHRydWUpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGRldGFjaCgpIHtcclxuICAgIGlmICh0aGlzLmJlZ2luRWRpdFN1YnNjcmlwdGlvbiAmJiB0eXBlb2YgdGhpcy5iZWdpbkVkaXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5iZWdpbkVkaXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmVuZEVkaXRTdWJzY3JpcHRpb24gJiYgdHlwZW9mIHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmVuZEVkaXRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vI3JlZ2lvbiDluK7liqnlrZfmrrXmmKDlsIRcclxuXHJcbiAgcHJpdmF0ZSBsb29rdXBNYXBwaW5nKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55LCBhc0NsZWFyOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgIGlmICghbWFwRmllbGRzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xyXG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xyXG4gICAgYXBwQ29udGV4dC5jaGFuZ2VEZXRlY3Rpb25Db250cm9sbGVyLmRldGFjaCgpO1xyXG5cclxuICAgIGNvbnN0IHBhdGhBcnIgPSB0aGlzLmdldEJpbmRpbmdQYXRoQXJyYXkoKTtcclxuICAgIGxldCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcclxuICAgIGNvbnN0IHByaW1hcnlJbmZvID0gdGhpcy5nZXRNYXBGaWVsZHNQcmltYXJ5S2V5KG1hcEZpZWxkcywgcGF0aEFycik7XHJcblxyXG4gICAgbGV0IHByaW1hcnlLZXlzID0gcHJpbWFyeUluZm8gJiYgcHJpbWFyeUluZm8ubWFwKGl0ZW0gPT4gaXRlbS5wcmltYXJ5S2V5KSB8fCBbXTtcclxuICAgIGNvbnN0IHByaW1hcnlGaWVsZHMgPSBwcmltYXJ5SW5mbyAmJiBwcmltYXJ5SW5mby5tYXAoaXRlbSA9PiBpdGVtLnByaW1hcnlGaWVsZCkgfHwgW107XHJcbiAgICAvLyDljrvph41cclxuICAgIGlmIChwcmltYXJ5S2V5cyAmJiBwcmltYXJ5S2V5cy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIHByaW1hcnlLZXlzID0gWy4uLm5ldyBTZXQocHJpbWFyeUtleXMpXTtcclxuICAgICAgaGVscEZpZWxkcyA9IHRoaXMuc29ydE1hcEZpZWxkS2V5cyhoZWxwRmllbGRzLCBwcmltYXJ5S2V5cyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFoZWxwRGF0YSB8fCBhc0NsZWFyKSB7XHJcbiAgICAgIGhlbHBGaWVsZHMucmV2ZXJzZSgpO1xyXG4gICAgfVxyXG4gICAgaGVscEZpZWxkcy5mb3JFYWNoKChmOiBhbnkpID0+IHtcclxuICAgICAgbGV0IHZhbDogYW55ID0gJyc7XHJcbiAgICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICAgIGlmIChoZWxwRGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XHJcbiAgICAgICAgICB2YWwgPSBoZWxwRGF0YS5tYXAoKGg6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZShmLCBoKTtcclxuICAgICAgICAgIH0pLmpvaW4oJywnKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdmFsID0gdGhpcy5nZXRWYWx1ZShmLCBoZWxwRGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgbWFwcGluZ3M6IGFueVtdID0gbWFwRmllbGRzW2ZdLnNwbGl0KCcsJyk7XHJcbiAgICAgIGNvbnN0IGhlYWRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcihwID0+IHByaW1hcnlGaWVsZHMuaW5jbHVkZXMocCkpO1xyXG4gICAgICBjb25zdCBsZWZ0TWFwcGluZ3MgPSBtYXBwaW5ncy5maWx0ZXIocCA9PiAhcHJpbWFyeUZpZWxkcy5pbmNsdWRlcyhwKSk7XHJcbiAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICBtYXBwaW5ncyA9IFtdLmNvbmNhdChsZWZ0TWFwcGluZ3MpLmNvbmNhdChoZWFkTWFwcGluZ3MpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1hcHBpbmdzID0gW10uY29uY2F0KGhlYWRNYXBwaW5ncykuY29uY2F0KGxlZnRNYXBwaW5ncyk7XHJcbiAgICAgIH1cclxuICAgICAgbWFwcGluZ3MuZm9yRWFjaCgoZmY6IGFueSkgPT4ge1xyXG4gICAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICAgIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmNsZWFyVmFsdWUocGF0aEFyci5jb25jYXQoZmYuc3BsaXQoJy4nKSksIHRydWUsIHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRoQXJyLmNvbmNhdChmZi5zcGxpdCgnLicpKSwgdmFsLCB0cnVlLCB0cnVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g6YeN5paw5omT5byA5Y+Y5pu05qOA5rWLXHJcbiAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0VmFsdWUoZjogc3RyaW5nLCBkYXRhOiBhbnkpIHtcclxuICAgIGxldCB2YWwgPSAnJztcclxuICAgIGlmIChmLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcclxuICAgICAgdmFsID0gZGF0YVtmXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhbCA9IGYuc3BsaXQoJy4nKS5yZWR1Y2UoKGEsIGIpID0+IHtcclxuICAgICAgICByZXR1cm4gYVtiXTtcclxuICAgICAgfSwgZGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHZhbDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QmluZGluZ1BhdGhBcnJheSgpOiBhbnlbXSB7XHJcbiAgICBjb25zdCBwYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBpZiAocGF0aCkge1xyXG4gICAgICByZXR1cm4gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihuID0+IG4gIT09ICcnKTtcclxuICAgIH1cclxuICAgIHJldHVybiBbXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNOdW1iZXJWYWx1ZShmaWVsZCwgZGF0YSkge1xyXG4gICAgY29uc3QgY3VycmVudFZhbCA9IHRoaXMuZ2V0VmFsdWUoZmllbGQsIGRhdGEpO1xyXG4gICAgcmV0dXJuIGlzTnVtYmVyKGN1cnJlbnRWYWwpO1xyXG4gIH1cclxuXHJcbiAgLy8jZW5kcmVnaW9uXHJcbiAgLyoqXHJcbiAgICogXHJcbiAgICogQHBhcmFtIG1hcEZpZWxkcyAg5qC85byP5b2i5aaC77yae2lkOiBcImFzc29GaWVsZC5hc3NvRmllbGRcIiwgY29kZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX0NvZGVcIiwgbmFtZTogXCJhc3NvRmllbGQuYXNzb0ZpZWxkX05hbWVcIn0g5oiW6ICFIHtpZDondmlkJyxjb2RlOidjb2RlJyxuYW1lOiduYW1lJ31cclxuICAgKi9cclxuICBwcml2YXRlIGdldE1hcEZpZWxkc1ByaW1hcnlLZXkobWFwRmllbGRzOiBhbnksIGJpbmRpbmdQYXRoczogc3RyaW5nW10pOiBBcnJheTx7IHByaW1hcnlLZXk6IHN0cmluZywgcHJpbWFyeUZpZWxkOiBzdHJpbmcgfT4ge1xyXG4gICAgaWYgKCFtYXBGaWVsZHMgfHwgT2JqZWN0LmtleXMobWFwRmllbGRzKS5sZW5ndGggPCAxKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0cyA9IFtdO1xyXG4gICAgLy8gbGV0IHByaW1hcnlGaWVsZCA9IG51bGw7XHJcbiAgICB0cnkge1xyXG4gICAgICBjb25zdCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XHJcbiAgICAgIE9iamVjdC5rZXlzKG1hcEZpZWxkcykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCBtYXBGaWVsZCA9IG1hcEZpZWxkc1trZXldO1xyXG4gICAgICAgIGlmIChtYXBGaWVsZCAmJiB0eXBlb2YgbWFwRmllbGQgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICBjb25zdCBtYXBwaW5ncyA9IG1hcEZpZWxkLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBtYXBwaW5ncy5mb3JFYWNoKChpdGVtOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgbGV0IHBhdGhzID0gaXRlbS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBpZiAoYmluZGluZ1BhdGhzICYmIGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgcGF0aHMgPSBiaW5kaW5nUGF0aHMuY29uY2F0KHBhdGhzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBwcm9wSW5mbzogRGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICAgICAgICBpZiAocHJvcEluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mby5wcmltYXJ5ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHByaW1hcnlLZXk6IGtleSxcclxuICAgICAgICAgICAgICAgIHByaW1hcnlGaWVsZDogaXRlbVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgc2V0VmFsdWUodGFyZ2V0OiBvYmplY3QsIHBhdGhzOiBzdHJpbmdbXSwgdmFsdWU6IGFueSkge1xyXG4gICAgaWYgKHRhcmdldCkge1xyXG4gICAgICBpZiAocGF0aHMubGVuZ3RoIDw9IDEpIHtcclxuICAgICAgICB0YXJnZXRbcGF0aHNbMF1dID0gdmFsdWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcGF0aHMuc2xpY2UoMCwgLTEpLnJlZHVjZSgocHJldiwgcGF0aCkgPT4ge1xyXG4gICAgICAgICAgaWYgKCEocHJldi5oYXNPd25Qcm9wZXJ0eShwYXRoKSB8fCBwcmV2WydfX3Byb3RvX18nXS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkpIHtcclxuICAgICAgICAgICAgcHJldltwYXRoXSA9IHt9O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHByZXZbcGF0aF07XHJcbiAgICAgICAgfSwgdGFyZ2V0KVtwYXRoc1twYXRocy5sZW5ndGggLSAxXV0gPSB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHNvcnRNYXBGaWVsZEtleXMoa2V5czogc3RyaW5nW10sIHByaW1hcnlLZXlzOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgIGlmICghcHJpbWFyeUtleXMgfHwgcHJpbWFyeUtleXMubGVuZ3RoIDwgMSB8fCAha2V5cyB8fCBrZXlzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIGtleXM7XHJcbiAgICB9XHJcbiAgICAvLyDov4fmu6Tlh7rpnZ7kuLvplK7mmKDlsITlrZfmrrVcclxuICAgIGtleXMgPSBrZXlzLmZpbHRlcihwID0+ICFwcmltYXJ5S2V5cy5pbmNsdWRlcyhwKSk7XHJcbiAgICByZXR1cm4gW10uY29uY2F0KHByaW1hcnlLZXlzKS5jb25jYXQoa2V5cyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==