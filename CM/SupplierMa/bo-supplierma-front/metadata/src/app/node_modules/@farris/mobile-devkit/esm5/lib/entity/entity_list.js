import * as tslib_1 from "tslib";
import { Subject } from 'rxjs';
import { ChangeSet } from '../changeset/change_set';
import { ModifyType } from '../changeset/types';
import { Entity } from './entity';
import { EntityFactory } from './entity_creator';
import { PARENT_CLASS, PARENT_PATH } from './types';
/**
 * 实体集合列表
 */
var EntityList = /** @class */ (function () {
    // #endregion
    /**
     * @param data JSON数据集合
     * @param type 集合中的实体类型
     */
    function EntityList(data, type) {
        var _this = this;
        /**
         * 已废弃：请勿使用
         */
        this.listChanged = new Subject();
        /**
         * 已废弃：请勿使用
         */
        this.changeSet = new ChangeSet();
        // #endregion
        // #region 公有属性
        /**
         * 集合改变时触发(新增、行记录修改、删除)
         * @event
         */
        this.onListChanged = this.listChanged.asObservable();
        this.clear();
        if (data) {
            // this.loadEntities(data);
            data.forEach(function (item) {
                _this.initEntity(EntityFactory(type, item));
            });
        }
    }
    Object.defineProperty(EntityList.prototype, "items", {
        /**
         * 获取项集合
         */
        get: function () {
            return this.rawData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityList.prototype, "changes", {
        /**
         * 列表变更集
         */
        get: function () {
            return this.changeSet.changes;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 迭代器
     */
    EntityList.prototype[Symbol.iterator] = function () {
        return tslib_1.__generator(this, function (_a) {
            switch (_a.label) {
                case 0: return [5 /*yield**/, tslib_1.__values(this.items)];
                case 1:
                    _a.sent();
                    return [2 /*return*/];
            }
        });
    };
    // #region 公有方法
    /** 加载实体列表 */
    EntityList.prototype.loadEntities = function (entities) {
        var _this = this;
        this.clear();
        entities.forEach(function (entity) {
            _this.initEntity(entity);
        });
        // 发送Load变更
        var changeItem = {
            path: [],
            value: entities,
            preValue: undefined,
            type: ModifyType.Load
        };
        this.setChanges(changeItem);
    };
    /**
     * 清空
     */
    EntityList.prototype.clear = function () {
        this.rawData = [];
    };
    /**
     * 添加实体对象到集合中，并返回新加的对象
     * @param entity 实体对象
     */
    EntityList.prototype.appendNew = function (entity) {
        var newEntity = this.initEntity(entity);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
        return newEntity;
    };
    /**
     * 追加实体
     */
    EntityList.prototype.appendEntity = function (entity) {
        var newEntity = this.initEntity(entity);
        // 新增变更
        var changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 批量追加实体
     */
    EntityList.prototype.appendEntities = function (entities) {
        var _this = this;
        var newEntites = entities.map(function (entity) {
            return _this.initEntity(entity);
        });
        var changeItem = {
            path: [],
            value: newEntites,
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    };
    /**
     * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败
     * @param primaryId 主键ID
     */
    EntityList.prototype.remove = function (primaryId) {
        var _a;
        var total = this.count();
        var indexToRemove = this.rawData.findIndex(function (entity) {
            return entity.primaryValue === primaryId;
        });
        if (indexToRemove === -1) {
            return false;
        }
        var entityToRemove = this.rawData[indexToRemove];
        this.rawData.splice(indexToRemove, 1);
        // 删除变更
        var changeItem = {
            path: [],
            value: (_a = {}, _a[entityToRemove.primaryProperty.dataField] = primaryId, _a),
            preValue: undefined,
            type: ModifyType.Remove
        };
        this.updateIndex(total);
        this.setChanges(changeItem);
        return true;
    };
    /**
     * 从集合中获取指定ID值的实体对象
     * @param id 主键值
     */
    EntityList.prototype.get = function (id) {
        return this.items.find(function (item) {
            return item.primaryValue === id;
        });
    };
    /**
     * 将变更记录添加到集合变更集中
     * @param value 变更记录
     */
    EntityList.prototype.setChanges = function (modinfo) {
        // 向app层发送的变更
        this.listChanged.next(modinfo);
        // 构造向changeSet中添加的chagne
        var change = Object.assign({}, modinfo);
        if (modinfo.type === ModifyType.Add && modinfo.value[0] instanceof Entity) {
            change.value = [modinfo.value[0].data];
        }
        this.changeSet.append(change);
    };
    /** 集合总记录数 */
    EntityList.prototype.count = function () {
        return this.items.length;
    };
    /**
     * 获取实体对象的索引值
     */
    EntityList.prototype.indexOf = function (entity) {
        return this.items.indexOf(entity);
    };
    /**
     * 计算集合中某个属性的总和
     * @param propertyName 属性名称
     */
    EntityList.prototype.sum = function (propertyName) {
        if (this.count() === 0) {
            return 0;
        }
        return this.items.reduce(function (val, curr) {
            return val + curr[propertyName];
        }, 0);
    };
    /**
     * 已废弃：请使用toJSON方法代替
     * @deprecated
     */
    EntityList.prototype.toJson = function () {
        return this.rawData;
    };
    /**
     * 转换为JSON格式
     */
    EntityList.prototype.toJSON = function () {
        var result = [];
        this.items.forEach(function (entity) {
            result.push(entity.toJSON());
        });
        return result;
    };
    EntityList.prototype.toArray = function () {
        return this.items;
    };
    // #endregion
    // #region 私有方法
    /**
     * 实体初始化
     * @param entity 实体
     */
    EntityList.prototype.initEntity = function (entity) {
        var _this = this;
        entity[PARENT_CLASS] = this;
        entity[PARENT_PATH] = this[PARENT_PATH];
        entity.onValueChanged.subscribe(function (v) {
            var path = v.path;
            var value = v.value;
            var preValue = v.preValue;
            var operator = v.type;
            var subChanges = { path: path, value: value, preValue: preValue, type: operator };
            _this.setChanges(subChanges);
        });
        // TODO: 添加数据验证逻辑代码
        var newLength = this.rawData.push(entity);
        this[newLength - 1] = entity;
        return entity;
    };
    /**
     * 更新索引
     * @param total 总记录数
     */
    EntityList.prototype.updateIndex = function (total) {
        var _this = this;
        for (var i = 0; i < total; i++) {
            delete this[i];
        }
        this.rawData.forEach(function (entity, index) {
            _this[index] = entity;
        });
    };
    /**
     * 获取属性名称
     */
    EntityList.prototype.getPropertyName = function () {
        var path = this[PARENT_PATH];
        if (path && path.length) {
            var name_1 = path[path.length - 1];
            return name_1;
        }
        return undefined;
    };
    return EntityList;
}());
export { EntityList };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2xpc3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2VudGl0eV9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRCxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzlELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFhLE1BQU0sU0FBUyxDQUFDO0FBSy9EOztHQUVHO0FBQ0g7SUF1REUsYUFBYTtJQUdiOzs7T0FHRztJQUNILG9CQUFZLElBQVksRUFBRSxJQUFnQjtRQUExQyxpQkFRQztRQTdERDs7V0FFRztRQUNLLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQWdCLENBQUM7UUFFbEQ7O1dBRUc7UUFDSyxjQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUNwQyxhQUFhO1FBR2IsZUFBZTtRQUVmOzs7V0FHRztRQUNJLGtCQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQW9DckQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsSUFBSSxJQUFJLEVBQUU7WUFDUiwyQkFBMkI7WUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7Z0JBQ2YsS0FBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDN0MsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUF0Q0Qsc0JBQVcsNkJBQUs7UUFIaEI7O1dBRUc7YUFD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RUFBRSxFQUFFO1lBQzlCLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2hCO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUFNLEVBQUUsS0FBSztZQUNqQyxLQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssb0NBQWUsR0FBdkI7UUFDRSxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDL0IsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN2QixJQUFNLE1BQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNuQyxPQUFPLE1BQUksQ0FBQztTQUNiO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUlILGlCQUFDO0FBQUQsQ0FBQyxBQXJURCxJQXFUQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgQ2hhbmdlU2V0IH0gZnJvbSAnLi4vY2hhbmdlc2V0L2NoYW5nZV9zZXQnO1xyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuL2VudGl0eSc7XHJcbmltcG9ydCB7IEVudGl0eUZhY3RvcnkgfSBmcm9tICcuL2VudGl0eV9jcmVhdG9yJztcclxuaW1wb3J0IHsgUEFSRU5UX0NMQVNTLCBQQVJFTlRfUEFUSCwgQ2xhc3NUeXBlIH0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElMaXN0PFQ+IHtcclxuICBbaW5kZXg6IG51bWJlcl06IFQ7XHJcbn1cclxuLyoqXHJcbiAqIOWunuS9k+mbhuWQiOWIl+ihqFxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEVudGl0eUxpc3Q8VCBleHRlbmRzIEVudGl0eT4gaW1wbGVtZW50cyBJTGlzdDxUPiwgSXRlcmFibGU8VD4ge1xyXG5cclxuICAvLyAjcmVnaW9uIOengeacieWxnuaAp1xyXG5cclxuICAvKipcclxuICAgKiDlt7Llup/lvIPvvJror7fli7/kvb/nlKhcclxuICAgKi9cclxuICBwcml2YXRlIHJhd0RhdGE6IFRbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsaXN0Q2hhbmdlZCA9IG5ldyBTdWJqZWN0PE1vZGlmaWNhdGlvbj4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDlhazmnInlsZ7mgKdcclxuXHJcbiAgLyoqXHJcbiAgICog6ZuG5ZCI5pS55Y+Y5pe26Kem5Y+RKOaWsOWinuOAgeihjOiusOW9leS/ruaUueOAgeWIoOmZpClcclxuICAgKiBAZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgb25MaXN0Q2hhbmdlZCA9IHRoaXMubGlzdENoYW5nZWQuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlumhuembhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgaXRlbXMoKTogVFtdIHtcclxuICAgIHJldHVybiB0aGlzLnJhd0RhdGE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJfooajlj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGNoYW5nZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGFuZ2VTZXQuY2hhbmdlcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaMh+Wumue0ouW8leWkhOeahOWAvFxyXG4gICAqL1xyXG4gIFtpbmRleDogbnVtYmVyXTogVDtcclxuXHJcbiAgLyoqXHJcbiAgICog6L+t5Luj5ZmoXHJcbiAgICovXHJcbiAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhdG9yPFQ+IHtcclxuICAgIHlpZWxkKiB0aGlzLml0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGRhdGEgSlNPTuaVsOaNrumbhuWQiFxyXG4gICAqIEBwYXJhbSB0eXBlIOmbhuWQiOS4reeahOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGRhdGE/OiBhbnlbXSwgdHlwZT86IENsYXNzVHlwZSkge1xyXG4gICAgdGhpcy5jbGVhcigpO1xyXG4gICAgaWYgKGRhdGEpIHtcclxuICAgICAgLy8gdGhpcy5sb2FkRW50aXRpZXMoZGF0YSk7XHJcbiAgICAgIGRhdGEuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICB0aGlzLmluaXRFbnRpdHkoRW50aXR5RmFjdG9yeSh0eXBlLCBpdGVtKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5YWs5pyJ5pa55rOVXHJcblxyXG4gIC8qKiDliqDovb3lrp7kvZPliJfooaggKi9cclxuICBwdWJsaWMgbG9hZEVudGl0aWVzKGVudGl0aWVzOiBUW10pIHtcclxuICAgIHRoaXMuY2xlYXIoKTtcclxuXHJcbiAgICBlbnRpdGllcy5mb3JFYWNoKGVudGl0eSA9PiB7XHJcbiAgICAgIHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5Y+R6YCBTG9hZOWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiBlbnRpdGllcyxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5Mb2FkXHJcbiAgICB9O1xyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuIXnqbpcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXIoKSB7XHJcbiAgICB0aGlzLnJhd0RhdGEgPSBbXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWunuS9k+WvueixoeWIsOmbhuWQiOS4re+8jOW5tui/lOWbnuaWsOWKoOeahOWvueixoVxyXG4gICAqIEBwYXJhbSBlbnRpdHkg5a6e5L2T5a+56LGhXHJcbiAgICovXHJcbiAgcHVibGljIGFwcGVuZE5ldyhlbnRpdHk6IFQpOiBUIHtcclxuICAgIGNvbnN0IG5ld0VudGl0eSA9IHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xyXG5cclxuICAgIC8vIOaWsOWinuWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiBbbmV3RW50aXR5XSxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG4gICAgcmV0dXJuIG5ld0VudGl0eTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi/veWKoOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmRFbnRpdHkoZW50aXR5OiBUKTogdm9pZCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdHkgPSB0aGlzLmluaXRFbnRpdHkoZW50aXR5KTtcclxuXHJcbiAgICAvLyDmlrDlop7lj5jmm7RcclxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XHJcbiAgICAgIHBhdGg6IFtdLFxyXG4gICAgICB2YWx1ZTogW25ld0VudGl0eV0sXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+i/veWKoOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmRFbnRpdGllcyhlbnRpdGllczogVFtdKTogdm9pZCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdGVzID0gZW50aXRpZXMubWFwKChlbnRpdHk6IFQpID0+IHtcclxuICAgICAgcmV0dXJuIHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IG5ld0VudGl0ZXMsXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOaMh+WumuS4u+mUrklEIOeahOWunuS9k+Wvueixoe+8jOi/lOWbnuW4g+WwlO+8jHRydWUg5Yig6Zmk5oiQ5Yqf77yMZmFsc2Ug5Yig6Zmk5aSx6LSlXHJcbiAgICogQHBhcmFtIHByaW1hcnlJZCDkuLvplK5JRFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmUocHJpbWFyeUlkOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHRvdGFsID0gdGhpcy5jb3VudCgpO1xyXG4gICAgY29uc3QgaW5kZXhUb1JlbW92ZSA9IHRoaXMucmF3RGF0YS5maW5kSW5kZXgoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgIHJldHVybiBlbnRpdHkucHJpbWFyeVZhbHVlID09PSBwcmltYXJ5SWQ7XHJcbiAgICB9KTtcclxuICAgIGlmIChpbmRleFRvUmVtb3ZlID09PSAtMSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHlUb1JlbW92ZSA9IHRoaXMucmF3RGF0YVtpbmRleFRvUmVtb3ZlXTtcclxuICAgIHRoaXMucmF3RGF0YS5zcGxpY2UoaW5kZXhUb1JlbW92ZSwgMSk7XHJcblxyXG4gICAgLy8g5Yig6Zmk5Y+Y5pu0XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IHsgW2VudGl0eVRvUmVtb3ZlLnByaW1hcnlQcm9wZXJ0eS5kYXRhRmllbGRdOiBwcmltYXJ5SWQgfSxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5SZW1vdmVcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy51cGRhdGVJbmRleCh0b3RhbCk7XHJcbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XHJcblxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku47pm4blkIjkuK3ojrflj5bmjIflrppJROWAvOeahOWunuS9k+WvueixoVxyXG4gICAqIEBwYXJhbSBpZCDkuLvplK7lgLxcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0KGlkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zLmZpbmQoaXRlbSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtLnByaW1hcnlWYWx1ZSA9PT0gaWQ7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuWPmOabtOiusOW9lea3u+WKoOWIsOmbhuWQiOWPmOabtOmbhuS4rVxyXG4gICAqIEBwYXJhbSB2YWx1ZSDlj5jmm7TorrDlvZVcclxuICAgKi9cclxuICBwdWJsaWMgc2V0Q2hhbmdlcyhtb2RpbmZvOiBNb2RpZmljYXRpb24pIHtcclxuICAgIC8vIOWQkWFwcOWxguWPkemAgeeahOWPmOabtFxyXG4gICAgdGhpcy5saXN0Q2hhbmdlZC5uZXh0KG1vZGluZm8pO1xyXG5cclxuICAgIC8vIOaehOmAoOWQkWNoYW5nZVNldOS4rea3u+WKoOeahGNoYWduZVxyXG4gICAgY29uc3QgY2hhbmdlID0gT2JqZWN0LmFzc2lnbih7fSwgbW9kaW5mbyk7XHJcbiAgICBpZiAobW9kaW5mby50eXBlID09PSBNb2RpZnlUeXBlLkFkZCAmJiBtb2RpbmZvLnZhbHVlWzBdIGluc3RhbmNlb2YgRW50aXR5KSB7XHJcbiAgICAgIGNoYW5nZS52YWx1ZSA9IFttb2RpbmZvLnZhbHVlWzBdLmRhdGFdO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jaGFuZ2VTZXQuYXBwZW5kKGNoYW5nZSk7XHJcbiAgfVxyXG5cclxuICAvKiog6ZuG5ZCI5oC76K6w5b2V5pWwICovXHJcbiAgcHVibGljIGNvdW50KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaXRlbXMubGVuZ3RoO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a6e5L2T5a+56LGh55qE57Si5byV5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGluZGV4T2YoZW50aXR5OiBUKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zLmluZGV4T2YoZW50aXR5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuoeeul+mbhuWQiOS4reafkOS4quWxnuaAp+eahOaAu+WSjFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5bGe5oCn5ZCN56ewXHJcbiAgICovXHJcbiAgcHVibGljIHN1bShwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBpZiAodGhpcy5jb3VudCgpID09PSAwKSB7XHJcbiAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuaXRlbXMucmVkdWNlKCh2YWwsIGN1cnI6IFQpID0+IHtcclxuICAgICAgcmV0dXJuIHZhbCArIGN1cnJbcHJvcGVydHlOYW1lXTtcclxuICAgIH0sIDApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35L2/55SodG9KU09O5pa55rOV5Luj5pu/XHJcbiAgICogQGRlcHJlY2F0ZWRcclxuICAgKi9cclxuICBwdWJsaWMgdG9Kc29uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmF3RGF0YTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouS4ukpTT07moLzlvI9cclxuICAgKi9cclxuICBwdWJsaWMgdG9KU09OKCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgdGhpcy5pdGVtcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICByZXN1bHQucHVzaChlbnRpdHkudG9KU09OKCkpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHRvQXJyYXkoKTogVFtdIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDnp4HmnInmlrnms5VcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5Yid5aeL5YyWXHJcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZNcclxuICAgKi9cclxuICBwcml2YXRlIGluaXRFbnRpdHkoZW50aXR5OiBUKTogVCB7XHJcbiAgICBlbnRpdHlbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XHJcbiAgICBlbnRpdHlbUEFSRU5UX1BBVEhdID0gdGhpc1tQQVJFTlRfUEFUSF07XHJcbiAgICBlbnRpdHkub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKCh2OiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgY29uc3QgcGF0aCA9IHYucGF0aDtcclxuICAgICAgY29uc3QgdmFsdWUgPSB2LnZhbHVlO1xyXG4gICAgICBjb25zdCBwcmVWYWx1ZSA9IHYucHJlVmFsdWU7XHJcbiAgICAgIGNvbnN0IG9wZXJhdG9yID0gdi50eXBlO1xyXG4gICAgICBjb25zdCBzdWJDaGFuZ2VzID0geyBwYXRoLCB2YWx1ZSwgcHJlVmFsdWUsIHR5cGU6IG9wZXJhdG9yIH07XHJcbiAgICAgIHRoaXMuc2V0Q2hhbmdlcyhzdWJDaGFuZ2VzKTtcclxuICAgIH0pO1xyXG4gICAgLy8gVE9ETzog5re75Yqg5pWw5o2u6aqM6K+B6YC76L6R5Luj56CBXHJcbiAgICBjb25zdCBuZXdMZW5ndGggPSB0aGlzLnJhd0RhdGEucHVzaChlbnRpdHkpO1xyXG4gICAgdGhpc1tuZXdMZW5ndGggLSAxXSA9IGVudGl0eTtcclxuXHJcbiAgICByZXR1cm4gZW50aXR5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pu05paw57Si5byVXHJcbiAgICogQHBhcmFtIHRvdGFsIOaAu+iusOW9leaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlSW5kZXgodG90YWw6IG51bWJlcikge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKSB7XHJcbiAgICAgIGRlbGV0ZSB0aGlzW2ldO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yYXdEYXRhLmZvckVhY2goKGVudGl0eSwgaW5kZXgpID0+IHtcclxuICAgICAgdGhpc1tpbmRleF0gPSBlbnRpdHk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWxnuaAp+WQjeensFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UHJvcGVydHlOYW1lKCkge1xyXG4gICAgY29uc3QgcGF0aCA9IHRoaXNbUEFSRU5UX1BBVEhdO1xyXG4gICAgaWYgKHBhdGggJiYgcGF0aC5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgbmFtZSA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXTtcclxuICAgICAgcmV0dXJuIG5hbWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxufVxyXG4iXX0=