/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, EventEmitter } from '@angular/core';
import { Subject } from 'rxjs';
import { ColumnFilterType, DatagridUtils } from '@farris/ui-datagrid';
import { FilterOperator } from './operations/operators';
export class DatagridFilterRowService {
    constructor() {
        this.columnConditionSubject = new Subject();
        this.filterRowConditions$ = this.columnConditionSubject.asObservable();
        this.columnConditions = {};
        this.filterTextboxChanged = new EventEmitter();
        this.removeField = new EventEmitter();
    }
    /**
     * @param {?} frp
     * @return {?}
     */
    setFilterPanel(frp) {
        this.currentFilterPanel = frp;
    }
    /**
     * @return {?}
     */
    hasFilterPanel() {
        return !!this.currentFilterPanel;
    }
    /**
     * @return {?}
     */
    closeFilterPanel() {
        if (this.hasFilterPanel()) {
            if (this.currentFilterPanel.instance.documentClickHandle) {
                this.currentFilterPanel.instance.documentClickHandle();
            }
            document.body.removeChild(this.currentFilterPanel.location.nativeElement);
            this.currentFilterPanel.destroy();
            this.currentFilterPanel = null;
        }
    }
    /**
     * @param {?=} emitEvent
     * @return {?}
     */
    clear(emitEvent = true) {
        this.columnConditions = {};
        if (emitEvent) {
            this.columnConditionSubject.next({});
        }
    }
    /**
     * @param {?} field
     * @param {?=} opts
     * @return {?}
     */
    removeFilterField(field, opts) {
        if (this.columnConditions) {
            delete this.columnConditions[field];
            if (!opts || (opts && opts.emitEvent)) {
                this.emitColumnConditionChanged(this.columnConditions);
            }
            this.removeField.emit(field);
        }
    }
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    _updateColumnConditions(field, colCondition) {
        /** @type {?} */
        const currentCondition = this.columnConditions[field];
        if (!currentCondition) {
            this.columnConditions = Object.assign(this.columnConditions, { [field]: colCondition });
        }
        else {
            if (JSON.stringify(currentCondition) !== JSON.stringify(colCondition)) {
                this.columnConditions = Object.assign(this.columnConditions, { [field]: colCondition });
            }
        }
        // 值为 ‘’ ，则代表着不参与查询
        Object.keys(this.columnConditions).forEach((/**
         * @param {?} k
         * @return {?}
         */
        k => {
            if (!this.columnConditions[k]) {
                delete this.columnConditions[k];
            }
        }));
    }
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    updateColumnConditions(field, colCondition) {
        this._updateColumnConditions(field, colCondition);
        this.emitColumnConditionChanged(this.columnConditions);
    }
    /**
     * @private
     * @param {?} conditions
     * @return {?}
     */
    emitColumnConditionChanged(conditions) {
        // const farr = this.gridInstance.remoteFilter ? this.convert2FilterArray(this.columnConditions) : this.columnConditions;
        this.columnConditionSubject.next(conditions);
    }
    // 获取过滤行显示文本
    /**
     * @param {?} column
     * @param {?} condition
     * @return {?}
     */
    condition2string(column, condition) {
        if (!condition || typeof condition === 'string') {
            return '';
        }
        /** @type {?} */
        const andText = this.gridInstance.localeService.getValue('datagrid.filter.and');
        /** @type {?} */
        const orText = this.gridInstance.localeService.getValue('datagrid.filter.or');
        /** @type {?} */
        const getRelationLabel = (/**
         * @param {?} r
         * @return {?}
         */
        (r) => {
            if (r === 'and') {
                return andText;
            }
            else if (r === 'or') {
                return orText;
            }
            else {
                return '';
            }
        });
        /** @type {?} */
        let filterPreViewString = '';
        if (column.filter.type === ColumnFilterType.fromdata) {
            filterPreViewString = `(${condition.value1.length})`;
            if (condition.value1) {
                filterPreViewString += ` ${condition.value1.join(',')}`;
            }
        }
        else if (column.filter.type === ColumnFilterType.enum) {
            /** @type {?} */
            const enumOpts = (/** @type {?} */ (this.getEnumOptions(column)));
            const { valueField, textField, data } = enumOpts;
            filterPreViewString = `(${condition.value1.length})`;
            if (condition.value1) {
                filterPreViewString += ` ${condition.value1.map((/**
                 * @param {?} v
                 * @return {?}
                 */
                v => {
                    /** @type {?} */
                    const enumItem = data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d[valueField] == v));
                    return enumItem[textField];
                })).join(',')}`;
            }
        }
        else {
            if (condition) {
                /** @type {?} */
                const operator1Label = this.getOperatorLabel(condition.operator1);
                if (!this.isEmpty(condition.value1)) {
                    filterPreViewString = `${operator1Label} ${condition.value1}`;
                    /** @type {?} */
                    const operator2Label = this.getOperatorLabel(condition.operator2);
                    if (!this.isEmpty(condition.value2)) {
                        filterPreViewString += ` ${getRelationLabel(condition.relation)} ${operator2Label} ${condition.value2}`;
                    }
                    else {
                        if (condition.operator2 !== undefined) {
                            /** @type {?} */
                            const op2 = parseInt('' + condition.operator2, 10);
                            if (op2 === FilterOperator.Empty || op2 === FilterOperator.NotEmpty) {
                                filterPreViewString += ` ${getRelationLabel(condition.relation)} ${operator2Label}`;
                            }
                        }
                    }
                }
                else {
                    /** @type {?} */
                    const op1 = parseInt('' + condition.operator1, 10);
                    if (op1 === FilterOperator.Empty || op1 === FilterOperator.NotEmpty) {
                        filterPreViewString = `${operator1Label}`;
                    }
                }
            }
        }
        return filterPreViewString;
    }
    /**
     * @private
     * @param {?} v
     * @return {?}
     */
    isEmpty(v) {
        return v === '' || v === undefined || v === null;
    }
    /**
     * @param {?} column
     * @return {?}
     */
    getEnumOptions(column) {
        /** @type {?} */
        const colFilter = (/** @type {?} */ (column.filter));
        /** @type {?} */
        const datatype = colFilter.type;
        /** @type {?} */
        let enumSetting = null;
        if (datatype === ColumnFilterType.enum) {
            /** @type {?} */
            const fmt = (/** @type {?} */ (column.formatter));
            if (fmt) {
                enumSetting = fmt.options;
            }
            else {
                if (colFilter.options) {
                    enumSetting = colFilter.options;
                }
            }
        }
        else { // enum 数据源来自grid 数据列表
            // enum 数据源来自grid 数据列表
            /** @type {?} */
            const columnData = this.gridInstance.dfs.getData(true).map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return DatagridUtils.getValue(column.field, n);
            }));
            // 去除重复
            /** @type {?} */
            const enumData = Array.from(new Set(columnData)).map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return {
                    value: n, label: n
                };
            }));
            enumSetting = {
                valueField: 'value', textField: 'label', data: enumData, idField: 'value'
            };
        }
        return enumSetting;
    }
    // 获取操作符标签
    /**
     * @param {?} code
     * @return {?}
     */
    getOperatorLabel(code) {
        /** @type {?} */
        const strOper = FilterOperator[code];
        if (strOper) {
            /** @type {?} */
            const operName = strOper[0].toLowerCase() + strOper.substr(1);
            /** @type {?} */
            const key = `datagrid.filter.operators.${operName}`;
            return this.gridInstance.localeService.getValue(key);
        }
        return '';
    }
}
DatagridFilterRowService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
DatagridFilterRowService.ctorParameters = () => [];
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridFilterRowService.prototype.columnConditionSubject;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterRowConditions$;
    /** @type {?} */
    DatagridFilterRowService.prototype.columnConditions;
    /** @type {?} */
    DatagridFilterRowService.prototype.currentFilterPanel;
    /** @type {?} */
    DatagridFilterRowService.prototype.gridInstance;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterTextboxChanged;
    /** @type {?} */
    DatagridFilterRowService.prototype.removeField;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC1maWx0ZXIvIiwic291cmNlcyI6WyJsaWIvZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBQUMsZ0JBQWdCLEVBQWMsYUFBYSxFQUFtQyxNQUFNLHFCQUFxQixDQUFDO0FBRWxILE9BQU8sRUFDZ0IsY0FBYyxFQUFjLE1BQU0sd0JBQXdCLENBQUM7QUFJbEYsTUFBTSxPQUFPLHdCQUF3QjtJQVdqQztRQVZRLDJCQUFzQixHQUFHLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ25FLHlCQUFvQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxxQkFBZ0IsR0FBMEIsRUFBRSxDQUFDO1FBSzdDLHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO0lBRXpCLENBQUM7Ozs7O0lBRWpCLGNBQWMsQ0FBQyxHQUEwQztRQUNyRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0lBQ2xDLENBQUM7Ozs7SUFFRCxjQUFjO1FBQ1YsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDO0lBQ3JDLENBQUM7Ozs7SUFFRCxnQkFBZ0I7UUFDWixJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRTtZQUN2QixJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUU7Z0JBQ3RELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVB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SSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUc7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRTtnQkFDckQsT0FBTztvQkFDSCxLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDO2lCQUNyQixDQUFDO1lBQ04sQ0FBQyxFQUFDO1lBQ0YsV0FBVyxHQUFHO2dCQUNWLFVBQVUsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxPQUFPO2FBQzVFLENBQUM7U0FDTDtRQUVELE9BQU8sV0FBVyxDQUFDO0lBRXZCLENBQUM7Ozs7OztJQUdELGdCQUFnQixDQUFDLElBQVM7O2NBQ2hCLE9BQU8sR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO1FBQ3BDLElBQUksT0FBTyxFQUFFOztrQkFDSCxRQUFRLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDOztrQkFDdkQsR0FBRyxHQUFHLDZCQUE2QixRQUFRLEVBQUU7WUFDbkQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDeEQ7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7OztZQXpMSixVQUFVOzs7Ozs7Ozs7SUFFUCwwREFBbUU7O0lBQ25FLHdEQUFrRTs7SUFDbEUsb0RBQTZDOztJQUM3QyxzREFBMEQ7O0lBRTFELGdEQUFnQzs7SUFFaEMsd0RBQTBDOztJQUMxQywrQ0FBeUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBDb21wb25lbnRSZWYsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQge0NvbHVtbkZpbHRlclR5cGUsIERhdGFDb2x1bW4sIERhdGFncmlkVXRpbHMsIERhdGFncmlkQ29tcG9uZW50LCBDb2x1bW5GaWx0ZXIgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuXHJcbmltcG9ydCB7IENvbHVtbkZpbHRlckNvbmRpdGlvbiwgRmlsdGVyQ29uZGl0aW9uLCBGaWx0ZXJDb25kaXRpb25WYWx1ZSwgQWxsRmlsdGVyT3BlcmF0b3IsXHJcbiAgICBGaWx0ZXJFbnVtU2V0dGluZywgRmlsdGVyT3BlcmF0b3IsIEZpbHRlckRhdGEgfSBmcm9tICcuL29wZXJhdGlvbnMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRmlsdGVyUm93UGFuZWxDb21wb25lbnQgfSBmcm9tICcuL2ZpbHRlci1lZGl0b3JzL2ZpbHRlci1yb3ctcGFuZWwuY29tcG9uZW50JztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkRmlsdGVyUm93U2VydmljZSB7XHJcbiAgICBwcml2YXRlIGNvbHVtbkNvbmRpdGlvblN1YmplY3QgPSBuZXcgU3ViamVjdDxGaWx0ZXJEYXRhW10gfCBhbnk+KCk7XHJcbiAgICBmaWx0ZXJSb3dDb25kaXRpb25zJCA9IHRoaXMuY29sdW1uQ29uZGl0aW9uU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICAgIGNvbHVtbkNvbmRpdGlvbnM6IENvbHVtbkZpbHRlckNvbmRpdGlvbiA9IHt9O1xyXG4gICAgY3VycmVudEZpbHRlclBhbmVsOiBDb21wb25lbnRSZWY8RmlsdGVyUm93UGFuZWxDb21wb25lbnQ+O1xyXG5cclxuICAgIGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQ7XHJcblxyXG4gICAgZmlsdGVyVGV4dGJveENoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICByZW1vdmVGaWVsZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkgeyB9XHJcblxyXG4gICAgc2V0RmlsdGVyUGFuZWwoZnJwOiBDb21wb25lbnRSZWY8RmlsdGVyUm93UGFuZWxDb21wb25lbnQ+KSB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwgPSBmcnA7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzRmlsdGVyUGFuZWwoKSB7XHJcbiAgICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50RmlsdGVyUGFuZWw7XHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2VGaWx0ZXJQYW5lbCgpIHtcclxuICAgICAgICBpZiAodGhpcy5oYXNGaWx0ZXJQYW5lbCgpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5pbnN0YW5jZS5kb2N1bWVudENsaWNrSGFuZGxlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5pbnN0YW5jZS5kb2N1bWVudENsaWNrSGFuZGxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyKGVtaXRFdmVudCA9IHRydWUpIHtcclxuICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnMgPSB7fTtcclxuICAgICAgICBpZiAoZW1pdEV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sdW1uQ29uZGl0aW9uU3ViamVjdC5uZXh0KHt9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlRmlsdGVyRmllbGQoZmllbGQ6IHN0cmluZywgb3B0cz86IHtlbWl0RXZlbnQ6IGJvb2xlYW59KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29sdW1uQ29uZGl0aW9ucykge1xyXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5jb2x1bW5Db25kaXRpb25zW2ZpZWxkXTtcclxuICAgICAgICAgICAgaWYgKCFvcHRzIHx8IChvcHRzICYmIG9wdHMuZW1pdEV2ZW50KSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0Q29sdW1uQ29uZGl0aW9uQ2hhbmdlZCh0aGlzLmNvbHVtbkNvbmRpdGlvbnMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlRmllbGQuZW1pdChmaWVsZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIF91cGRhdGVDb2x1bW5Db25kaXRpb25zKGZpZWxkOiBzdHJpbmcsIGNvbENvbmRpdGlvbjogRmlsdGVyQ29uZGl0aW9uIHwgRmlsdGVyQ29uZGl0aW9uVmFsdWUgKSB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudENvbmRpdGlvbiA9IHRoaXMuY29sdW1uQ29uZGl0aW9uc1tmaWVsZF07XHJcbiAgICAgICAgaWYgKCFjdXJyZW50Q29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sdW1uQ29uZGl0aW9ucyA9IE9iamVjdC5hc3NpZ24odGhpcy5jb2x1bW5Db25kaXRpb25zLCB7W2ZpZWxkXTogY29sQ29uZGl0aW9ufSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KGN1cnJlbnRDb25kaXRpb24pICE9PSBKU09OLnN0cmluZ2lmeShjb2xDb25kaXRpb24pKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnMgPSBPYmplY3QuYXNzaWduKHRoaXMuY29sdW1uQ29uZGl0aW9ucywge1tmaWVsZF06IGNvbENvbmRpdGlvbn0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWAvOS4uiDigJjigJkg77yM5YiZ5Luj6KGo552A5LiN5Y+C5LiO5p+l6K+iXHJcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5jb2x1bW5Db25kaXRpb25zKS5mb3JFYWNoKGsgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29sdW1uQ29uZGl0aW9uc1trXSkge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29sdW1uQ29uZGl0aW9uc1trXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUNvbHVtbkNvbmRpdGlvbnMoZmllbGQ6IHN0cmluZywgY29sQ29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24gfCBGaWx0ZXJDb25kaXRpb25WYWx1ZSApIHtcclxuICAgICAgICB0aGlzLl91cGRhdGVDb2x1bW5Db25kaXRpb25zKGZpZWxkLCBjb2xDb25kaXRpb24pO1xyXG4gICAgICAgIHRoaXMuZW1pdENvbHVtbkNvbmRpdGlvbkNoYW5nZWQodGhpcy5jb2x1bW5Db25kaXRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGVtaXRDb2x1bW5Db25kaXRpb25DaGFuZ2VkKGNvbmRpdGlvbnMpIHtcclxuICAgICAgICAvLyBjb25zdCBmYXJyID0gdGhpcy5ncmlkSW5zdGFuY2UucmVtb3RlRmlsdGVyID8gdGhpcy5jb252ZXJ0MkZpbHRlckFycmF5KHRoaXMuY29sdW1uQ29uZGl0aW9ucykgOiB0aGlzLmNvbHVtbkNvbmRpdGlvbnM7XHJcbiAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25TdWJqZWN0Lm5leHQoY29uZGl0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W6L+H5ruk6KGM5pi+56S65paH5pysXHJcbiAgICBjb25kaXRpb24yc3RyaW5nKGNvbHVtbjogRGF0YUNvbHVtbiwgY29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24pIHtcclxuICAgICAgICBpZiAoIWNvbmRpdGlvbiB8fCB0eXBlb2YgY29uZGl0aW9uID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBhbmRUZXh0ID0gdGhpcy5ncmlkSW5zdGFuY2UubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZGF0YWdyaWQuZmlsdGVyLmFuZCcpO1xyXG4gICAgICAgIGNvbnN0IG9yVGV4dCA9IHRoaXMuZ3JpZEluc3RhbmNlLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2RhdGFncmlkLmZpbHRlci5vcicpO1xyXG5cclxuICAgICAgICBjb25zdCBnZXRSZWxhdGlvbkxhYmVsID0gKHIpID0+IHtcclxuICAgICAgICAgICAgaWYgKHIgPT09ICdhbmQnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYW5kVGV4dDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChyID09PSAnb3InKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JUZXh0O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGxldCBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gJyc7XHJcbiAgICAgICAgaWYgKGNvbHVtbi5maWx0ZXIudHlwZSA9PT0gQ29sdW1uRmlsdGVyVHlwZS5mcm9tZGF0YSkge1xyXG4gICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCgke2NvbmRpdGlvbi52YWx1ZTEubGVuZ3RofSlgO1xyXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uLnZhbHVlMSkge1xyXG4gICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Y29uZGl0aW9uLnZhbHVlMS5qb2luKCcsJyl9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoY29sdW1uLmZpbHRlci50eXBlID09PSBDb2x1bW5GaWx0ZXJUeXBlLmVudW0pIHtcclxuICAgICAgICAgICAgY29uc3QgZW51bU9wdHMgPSB0aGlzLmdldEVudW1PcHRpb25zKGNvbHVtbikgYXMgRmlsdGVyRW51bVNldHRpbmc7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgdmFsdWVGaWVsZCwgdGV4dEZpZWxkLCBkYXRhIH0gPSBlbnVtT3B0cztcclxuICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAoJHtjb25kaXRpb24udmFsdWUxLmxlbmd0aH0pYDtcclxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi52YWx1ZTEpIHtcclxuICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2NvbmRpdGlvbi52YWx1ZTEubWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVudW1JdGVtID0gZGF0YS5maW5kKGQgPT4gZFt2YWx1ZUZpZWxkXSA9PSB2KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW51bUl0ZW1bdGV4dEZpZWxkXTtcclxuICAgICAgICAgICAgICAgIH0pLmpvaW4oJywnKX1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BlcmF0b3IxTGFiZWwgPSB0aGlzLmdldE9wZXJhdG9yTGFiZWwoY29uZGl0aW9uLm9wZXJhdG9yMSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoICF0aGlzLmlzRW1wdHkoY29uZGl0aW9uLnZhbHVlMSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCR7b3BlcmF0b3IxTGFiZWx9ICR7Y29uZGl0aW9uLnZhbHVlMX1gO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wZXJhdG9yMkxhYmVsID0gdGhpcy5nZXRPcGVyYXRvckxhYmVsKGNvbmRpdGlvbi5vcGVyYXRvcjIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VtcHR5KGNvbmRpdGlvbi52YWx1ZTIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2dldFJlbGF0aW9uTGFiZWwoY29uZGl0aW9uLnJlbGF0aW9uKX0gJHtvcGVyYXRvcjJMYWJlbH0gJHtjb25kaXRpb24udmFsdWUyfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi5vcGVyYXRvcjIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3AyID0gcGFyc2VJbnQoJycgKyBjb25kaXRpb24ub3BlcmF0b3IyLCAxMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AyID09PSBGaWx0ZXJPcGVyYXRvci5FbXB0eSB8fCBvcDIgPT09IEZpbHRlck9wZXJhdG9yLk5vdEVtcHR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Z2V0UmVsYXRpb25MYWJlbChjb25kaXRpb24ucmVsYXRpb24pfSAke29wZXJhdG9yMkxhYmVsfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wMSA9IHBhcnNlSW50KCcnICsgY29uZGl0aW9uLm9wZXJhdG9yMSwgMTApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcDEgPT09IEZpbHRlck9wZXJhdG9yLkVtcHR5IHx8IG9wMSA9PT0gRmlsdGVyT3BlcmF0b3IuTm90RW1wdHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAke29wZXJhdG9yMUxhYmVsfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmaWx0ZXJQcmVWaWV3U3RyaW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNFbXB0eSh2KSB7XHJcbiAgICAgICAgcmV0dXJuIHYgPT09ICcnIHx8IHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXRFbnVtT3B0aW9ucyhjb2x1bW46IERhdGFDb2x1bW4pIHtcclxuICAgICAgICBjb25zdCBjb2xGaWx0ZXIgPSBjb2x1bW4uZmlsdGVyIGFzIENvbHVtbkZpbHRlcjtcclxuICAgICAgICBjb25zdCBkYXRhdHlwZSA9IGNvbEZpbHRlci50eXBlO1xyXG4gICAgICAgIGxldCBlbnVtU2V0dGluZyA9IG51bGw7XHJcbiAgICAgICAgaWYgKGRhdGF0eXBlID09PSBDb2x1bW5GaWx0ZXJUeXBlLmVudW0pIHtcclxuICAgICAgICAgICAgY29uc3QgZm10ID0gY29sdW1uLmZvcm1hdHRlciBhcyBhbnk7XHJcbiAgICAgICAgICAgIGlmIChmbXQpIHtcclxuICAgICAgICAgICAgICAgIGVudW1TZXR0aW5nID0gZm10Lm9wdGlvbnM7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sRmlsdGVyLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtU2V0dGluZyA9IGNvbEZpbHRlci5vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHsgLy8gZW51bSDmlbDmja7mupDmnaXoh6pncmlkIOaVsOaNruWIl+ihqFxyXG4gICAgICAgICAgICBjb25zdCBjb2x1bW5EYXRhOiBzdHJpbmdbXSA9IHRoaXMuZ3JpZEluc3RhbmNlLmRmcy5nZXREYXRhKHRydWUpLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBEYXRhZ3JpZFV0aWxzLmdldFZhbHVlKGNvbHVtbi5maWVsZCwgbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyDljrvpmaTph43lpI1cclxuICAgICAgICAgICAgY29uc3QgZW51bURhdGEgPSBBcnJheS5mcm9tKG5ldyBTZXQoY29sdW1uRGF0YSkpLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG4sIGxhYmVsOiBuXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgZW51bVNldHRpbmcgPSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZUZpZWxkOiAndmFsdWUnLCB0ZXh0RmllbGQ6ICdsYWJlbCcsIGRhdGE6IGVudW1EYXRhLCBpZEZpZWxkOiAndmFsdWUnXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZW51bVNldHRpbmc7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIOiOt+WPluaTjeS9nOespuagh+etvlxyXG4gICAgZ2V0T3BlcmF0b3JMYWJlbChjb2RlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBzdHJPcGVyID0gRmlsdGVyT3BlcmF0b3JbY29kZV07XHJcbiAgICAgICAgaWYgKHN0ck9wZXIpIHtcclxuICAgICAgICAgICAgY29uc3Qgb3Blck5hbWUgPSBzdHJPcGVyWzBdLnRvTG93ZXJDYXNlKCkgKyBzdHJPcGVyLnN1YnN0cigxKTtcclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gYGRhdGFncmlkLmZpbHRlci5vcGVyYXRvcnMuJHtvcGVyTmFtZX1gO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ncmlkSW5zdGFuY2UubG9jYWxlU2VydmljZS5nZXRWYWx1ZShrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==