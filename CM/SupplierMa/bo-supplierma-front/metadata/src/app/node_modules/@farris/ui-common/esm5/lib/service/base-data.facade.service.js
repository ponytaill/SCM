/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * @template T
 */
var /**
 * @template T
 */
BaseDataFacadeService = /** @class */ (function () {
    function BaseDataFacadeService(_initState) {
        this._initState = _initState;
        this._state = this._initState;
        this.store = new BehaviorSubject(this._state);
        this.state$ = this.store.asObservable();
        this.data$ = this.state$.pipe(map((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return state.data; })));
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    BaseDataFacadeService.prototype.initData = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        var _this = this;
        return data.map((/**
         * @param {?} d
         * @return {?}
         */
        function (d) {
            /** @type {?} */
            var _id = d[_this._state.idField];
            /** @type {?} */
            var disable = (/**
             * @return {?}
             */
            function () {
                return _this.disableExpress ? _this.disableExpress(d) : false;
            });
            return {
                id: _id,
                data: d,
                disabled: disable(),
            };
        }));
    };
    /**
     * @protected
     * @param {?} state
     * @return {?}
     */
    BaseDataFacadeService.prototype.updateState = /**
     * @protected
     * @param {?} state
     * @return {?}
     */
    function (state) {
        /** @type {?} */
        var newState = tslib_1.__assign({}, this._state, state);
        this.store.next(this._state = newState);
    };
    /**
     * @param {?} state
     * @return {?}
     */
    BaseDataFacadeService.prototype.initState = /**
     * @param {?} state
     * @return {?}
     */
    function (state) {
        this.updateState(state);
    };
    /**
     * @param {?} id
     * @return {?}
     */
    BaseDataFacadeService.prototype.isSelect = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        var _this = this;
        if (this._state.selections && this._state.selections.length) {
            return this._state.selections.find((/**
             * @param {?} item
             * @return {?}
             */
            function (item) { return !!item ? item[_this._state.idField] == id : false; })) !== undefined;
        }
        return false;
    };
    /**
     * @param {?} data
     * @param {?=} selectValues
     * @param {?=} separator
     * @return {?}
     */
    BaseDataFacadeService.prototype.loadData = /**
     * @param {?} data
     * @param {?=} selectValues
     * @param {?=} separator
     * @return {?}
     */
    function (data, selectValues, separator) {
        if (selectValues === void 0) { selectValues = ''; }
        if (separator === void 0) { separator = ','; }
        if (data) {
            /** @type {?} */
            var _data = this.initData(data);
            this.updateState(tslib_1.__assign({}, this._state, { data: _data }));
            if (selectValues) {
                this.setSelections(selectValues, separator);
            }
            else {
                this._state.selections = [];
            }
        }
        else {
            this.updateState({ data: [], selections: [] });
        }
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.getSelections = /**
     * @return {?}
     */
    function () {
        return this._state.selections;
    };
    /**
     * @param {?} selectValues
     * @param {?=} separator
     * @return {?}
     */
    BaseDataFacadeService.prototype.setSelections = /**
     * @param {?} selectValues
     * @param {?=} separator
     * @return {?}
     */
    function (selectValues, separator) {
        var _this = this;
        if (separator === void 0) { separator = ','; }
        if (selectValues) {
            /** @type {?} */
            var selectedItems = [];
            if (this._state.multiSelect) {
                selectedItems = selectValues.split(separator).map((/**
                 * @param {?} val
                 * @return {?}
                 */
                function (val) {
                    return _this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) { return d.data[_this._state.valueField] + '' == val; }));
                })).map((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) {
                    return n ? n.data : '';
                })).filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n; }));
            }
            else {
                selectedItems = [this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) { return d.data[_this._state.valueField] + '' == selectValues; }))];
            }
            this.updateState({ selections: selectedItems });
        }
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.selectAll = /**
     * @return {?}
     */
    function () {
        this.updateState({ selections: this._state.data.map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.data; })) });
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.unSelectAll = /**
     * @return {?}
     */
    function () {
        this.clearSelections();
    };
    /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    BaseDataFacadeService.prototype.selectItem = /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    function (data, index) {
        /** @type {?} */
        var idfield = this._state.idField;
        /** @type {?} */
        var selections = this.getSelections();
        /** @type {?} */
        var id = data[idfield];
        if (!this._state.multiSelect) {
            if (!this.isSelect(id)) {
                selections = [data];
            }
        }
        else {
            if (!this.isSelect(id)) {
                selections.push(data);
            }
        }
        /** @type {?} */
        var items = this.cloneArray(selections);
        this.updateState({ selections: items });
    };
    /**
     * @param {?} data
     * @return {?}
     */
    BaseDataFacadeService.prototype.unSelectItem = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var idfield = this._state.idField;
        /** @type {?} */
        var selections = this.getSelections();
        /** @type {?} */
        var id = data[idfield];
        if (!this._state.multiSelect) {
            selections = [];
        }
        else {
            selections = selections.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n[idfield] != id; }));
        }
        /** @type {?} */
        var items = this.cloneArray(selections);
        this.updateState({ selections: items });
    };
    /**
     * @return {?}
     */
    BaseDataFacadeService.prototype.clearSelections = /**
     * @return {?}
     */
    function () {
        this.updateState({ selections: [] });
    };
    /**
     * @private
     * @param {?} arr
     * @return {?}
     */
    BaseDataFacadeService.prototype.cloneArray = /**
     * @private
     * @param {?} arr
     * @return {?}
     */
    function (arr) {
        if (arr && arr.length) {
            return arr.map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n; }));
        }
        return arr;
    };
    return BaseDataFacadeService;
}());
/**
 * @template T
 */
export { BaseDataFacadeService };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    BaseDataFacadeService.prototype._state;
    /** @type {?} */
    BaseDataFacadeService.prototype.disableExpress;
    /** @type {?} */
    BaseDataFacadeService.prototype.store;
    /** @type {?} */
    BaseDataFacadeService.prototype.state$;
    /** @type {?} */
    BaseDataFacadeService.prototype.data$;
    /**
     * @type {?}
     * @private
     */
    BaseDataFacadeService.prototype._initState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1kYXRhLmZhY2FkZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9iYXNlLWRhdGEuZmFjYWRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFDQSxPQUFPLEVBQUUsZUFBZSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUVyQzs7OztJQVNJLCtCQUFvQixVQUFhO1FBQWIsZUFBVSxHQUFWLFVBQVUsQ0FBRztRQVJ2QixXQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUcxQixVQUFLLEdBQUksSUFBSSxlQUFlLENBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLFdBQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRTVDLFVBQUssR0FBb0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLFVBQUMsS0FBUSxJQUFLLE9BQUEsS0FBSyxDQUFDLElBQUksRUFBVixDQUFVLEVBQUMsQ0FBQyxDQUFDO0lBR3pFLENBQUM7Ozs7OztJQUVPLHdDQUFROzs7OztJQUFoQixVQUFpQixJQUFTO1FBQTFCLGlCQVlDO1FBWEcsT0FBTyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLFVBQUEsQ0FBQzs7Z0JBQ1AsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQzs7Z0JBQzVCLE9BQU87OztZQUFHO2dCQUNaLE9BQU8sS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsS0FBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQ2hFLENBQUMsQ0FBQTtZQUNELE9BQU87Z0JBQ0gsRUFBRSxFQUFFLEdBQUc7Z0JBQ1As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QUFBLENBQUMsRUFBRCxDQUFDLEVBQUMsQ0FBQztTQUMzQjtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQztJQUNMLDRCQUFDO0FBQUQsQ0FBQyxBQW5JRCxJQW1JQzs7Ozs7Ozs7OztJQWxJRyx1Q0FBbUM7O0lBQ25DLCtDQUFrQzs7SUFFbEMsc0NBQXNEOztJQUN0RCx1Q0FBNEM7O0lBRTVDLHNDQUF5RTs7Ozs7SUFFN0QsMkNBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmFycmlzRGF0YVN0YXRlIH0gZnJvbSAnLi9mYXJyaXMtZGF0YWl0ZW0nO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhc2VEYXRhRmFjYWRlU2VydmljZTxUIGV4dGVuZHMgRmFycmlzRGF0YVN0YXRlPiB7XHJcbiAgICBwcm90ZWN0ZWQgX3N0YXRlID0gdGhpcy5faW5pdFN0YXRlO1xyXG4gICAgZGlzYWJsZUV4cHJlc3M6IChpdGVtKSA9PiBib29sZWFuO1xyXG5cclxuICAgIHJlYWRvbmx5IHN0b3JlICA9IG5ldyBCZWhhdmlvclN1YmplY3Q8VD4odGhpcy5fc3RhdGUpO1xyXG4gICAgcmVhZG9ubHkgc3RhdGUkID0gdGhpcy5zdG9yZS5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICBkYXRhJDogT2JzZXJ2YWJsZTxhbnk+ID0gdGhpcy5zdGF0ZSQucGlwZShtYXAoKHN0YXRlOiBUKSA9PiBzdGF0ZS5kYXRhKSk7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfaW5pdFN0YXRlOiBUKSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0RGF0YShkYXRhOiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gZGF0YS5tYXAoZCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IF9pZCA9IGRbdGhpcy5fc3RhdGUuaWRGaWVsZF07XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc2FibGUgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kaXNhYmxlRXhwcmVzcyA/IHRoaXMuZGlzYWJsZUV4cHJlc3MoZCkgOiBmYWxzZTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGlkOiBfaWQsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiBkLFxyXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6IGRpc2FibGUoKSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgdXBkYXRlU3RhdGUoc3RhdGU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IG5ld1N0YXRlID0gey4uLnRoaXMuX3N0YXRlLCAuLi5zdGF0ZX07XHJcbiAgICAgICAgdGhpcy5zdG9yZS5uZXh0KHRoaXMuX3N0YXRlID0gbmV3U3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRTdGF0ZShzdGF0ZTogYW55KSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZShzdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaXNTZWxlY3QoaWQ6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zICYmIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zLmZpbmQoaXRlbSA9PiAhIWl0ZW0gPyBpdGVtW3RoaXMuX3N0YXRlLmlkRmllbGRdID09IGlkIDogZmFsc2UpICE9PSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgbG9hZERhdGEoZGF0YTogYW55LCBzZWxlY3RWYWx1ZXM6IHN0cmluZyA9ICcnLCBzZXBhcmF0b3IgPSAnLCcpIHtcclxuICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICBjb25zdCBfZGF0YSA9IHRoaXMuaW5pdERhdGEoZGF0YSk7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoey4uLnRoaXMuX3N0YXRlLCBkYXRhOiBfZGF0YX0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHNlbGVjdFZhbHVlcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTZWxlY3Rpb25zKHNlbGVjdFZhbHVlcywgc2VwYXJhdG9yKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnMgPSBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyBkYXRhOiBbXSwgc2VsZWN0aW9uczogW10gfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldFNlbGVjdGlvbnMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnM7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0U2VsZWN0aW9ucyhzZWxlY3RWYWx1ZXM6IHN0cmluZywgc2VwYXJhdG9yID0gJywnKSB7XHJcbiAgICAgICAgaWYgKHNlbGVjdFZhbHVlcykge1xyXG4gICAgICAgICAgICBsZXQgc2VsZWN0ZWRJdGVtcyA9IFtdO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fc3RhdGUubXVsdGlTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbXMgPSBzZWxlY3RWYWx1ZXMuc3BsaXQoc2VwYXJhdG9yKS5tYXAoIHZhbCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLmRhdGEuZmluZChkID0+IGQuZGF0YVt0aGlzLl9zdGF0ZS52YWx1ZUZpZWxkXSArICcnID09IHZhbCk7XHJcbiAgICAgICAgICAgICAgICB9KS5tYXAoIG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuID8gbi5kYXRhIDogJyc7XHJcbiAgICAgICAgICAgICAgICB9KS5maWx0ZXIobiA9PiBuKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbXMgPSBbdGhpcy5fc3RhdGUuZGF0YS5maW5kKGQgPT4gZC5kYXRhW3RoaXMuX3N0YXRlLnZhbHVlRmllbGRdICsgJycgPT0gc2VsZWN0VmFsdWVzKV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7c2VsZWN0aW9uczogc2VsZWN0ZWRJdGVtcyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0QWxsKCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IHRoaXMuX3N0YXRlLmRhdGEubWFwKG4gPT4gbi5kYXRhKSB9KTtcclxuICAgIH1cclxuXHJcbiAgICB1blNlbGVjdEFsbCgpIHtcclxuICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucygpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEl0ZW0oZGF0YTogYW55LCBpbmRleD86IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IGlkZmllbGQgPSB0aGlzLl9zdGF0ZS5pZEZpZWxkO1xyXG4gICAgICAgIGxldCBzZWxlY3Rpb25zID0gdGhpcy5nZXRTZWxlY3Rpb25zKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGlkID0gZGF0YVtpZGZpZWxkXTtcclxuICAgICAgICBpZiAoIXRoaXMuX3N0YXRlLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1NlbGVjdChpZCkpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbnMgPSBbIGRhdGEgXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1NlbGVjdChpZCkpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbnMucHVzaChkYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaXRlbXMgPSB0aGlzLmNsb25lQXJyYXkoc2VsZWN0aW9ucyk7XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IGl0ZW1zfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdW5TZWxlY3RJdGVtKGRhdGE6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IGlkZmllbGQgPSB0aGlzLl9zdGF0ZS5pZEZpZWxkO1xyXG4gICAgICAgIGxldCBzZWxlY3Rpb25zID0gdGhpcy5nZXRTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgY29uc3QgaWQgPSBkYXRhW2lkZmllbGRdO1xyXG4gICAgICAgIGlmICghdGhpcy5fc3RhdGUubXVsdGlTZWxlY3QpIHtcclxuICAgICAgICAgICAgc2VsZWN0aW9ucyA9IFtdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHNlbGVjdGlvbnMgPSBzZWxlY3Rpb25zLmZpbHRlcihuID0+IG5baWRmaWVsZF0gIT0gaWQpIDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5jbG9uZUFycmF5KHNlbGVjdGlvbnMpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IGl0ZW1zfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJTZWxlY3Rpb25zKCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IFtdfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbG9uZUFycmF5KGFycjogYW55W10pIHtcclxuICAgICAgICBpZiAoYXJyICYmIGFyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFyci5tYXAoIG4gPT4gbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==