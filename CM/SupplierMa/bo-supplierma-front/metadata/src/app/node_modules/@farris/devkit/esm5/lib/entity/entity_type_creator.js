import * as tslib_1 from "tslib";
import { ModifyType } from "../changeset";
import { Entity } from "./entity";
import { DynamicFactory, EntityFactory } from "./entity_factory";
import { EntityList } from "./entity_list";
import { FieldMetadataUtil } from "./metadata";
import { PARENT_CLASS, PARENT_PATH } from "./types";
var EntityTypeCreator = /** @class */ (function () {
    function EntityTypeCreator() {
    }
    EntityTypeCreator.create = function (constructor, data) {
        var entityType = this.getType(constructor);
        var entity = new entityType(data);
        entity.constructor = constructor;
        return entity;
    };
    // @Cache({ key: ((context: any, args: any[]) => { return args[0] }), provider: new MemoryCacheProvider() })
    EntityTypeCreator.createType = function (constructor) {
        var entityType = /** @class */ (function (_super) {
            tslib_1.__extends(EntityType, _super);
            function EntityType(data) {
                return _super.call(this, data) || this;
            }
            return EntityType;
        }(Entity));
        var entityPrototype = entityType.prototype;
        this.extendProperties(constructor, entityPrototype);
        return entityType;
    };
    EntityTypeCreator.extendProperties = function (constructor, entityPrototype) {
        var ngFields = FieldMetadataUtil.getNgFields(constructor);
        var ngObjects = FieldMetadataUtil.getNgObjects(constructor);
        var ngLists = FieldMetadataUtil.getNgList(constructor);
        var ngDynamic = FieldMetadataUtil.getNgDynamic(constructor);
        this.extendPlainProperty(entityPrototype, ngFields);
        this.extendListProperty(entityPrototype, ngLists);
        this.extendObjectProperty(entityPrototype, ngObjects);
        this.extendDynamicProperty(entityPrototype, ngDynamic);
    };
    EntityTypeCreator.extendPlainProperty = function (entityPrototype, ngFields) {
        Object.keys(ngFields).forEach(function (propName) {
            var ngField = ngFields[propName];
            // const dataField = ngField.dataField || propName;
            Object.defineProperty(entityPrototype, propName, {
                get: function () {
                    var value = this.getPropValue(propName, ngField);
                    return value;
                },
                set: function (newPropValue) {
                    // 值相同时不触发变更。
                    var oldPropValue = this.getPropValue(propName, ngField);
                    if (this.isPropValueChanged(propName, ngField, newPropValue, oldPropValue) === false) {
                        return;
                    }
                    this.setPropValue(propName, ngField, newPropValue);
                    var changeSetValue = this.preparePropValue(propName, ngField, newPropValue);
                    this.emitValueChange(propName, ngField, newPropValue, oldPropValue, changeSetValue);
                }
            });
        });
    };
    EntityTypeCreator.extendListProperty = function (entityPrototype, ngListMetadata) {
        Object.keys(ngListMetadata).forEach(function (propertyName) {
            var key = "__" + propertyName + "__";
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    var _this = this;
                    var entityList = this[key];
                    if (!entityList) {
                        var fieldMetadata_1 = ngListMetadata[propertyName];
                        var path = this.createPath(propertyName);
                        var dataField = fieldMetadata_1.dataField || propertyName;
                        var val = this.data[dataField];
                        entityList = new EntityList();
                        entityList[PARENT_CLASS] = this;
                        entityList[PARENT_PATH] = path;
                        if (val) {
                            var entities = val.map(function (v) { return EntityFactory(fieldMetadata_1.type, v); });
                            entityList.loadEntities(entities);
                        }
                        entityList.onListChanged.subscribe(function (value) {
                            if (value) {
                                if (entityList[PARENT_PATH][0] !== value.path[0]) {
                                    value.path = entityList[PARENT_PATH].concat(value.path);
                                }
                                _this.setChanges(value);
                            }
                        });
                        this[key] = entityList;
                    }
                    return entityList;
                },
                set: function (value) {
                    this[key] = value;
                }
            });
        });
    };
    EntityTypeCreator.extendObjectProperty = function (entityPrototype, ngObjectMetadata) {
        Object.keys(ngObjectMetadata).forEach(function (propertyName) {
            var fieldMetadata = ngObjectMetadata[propertyName];
            var key = "__" + propertyName + "__";
            // 如果没有值用一个空对象代替
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    var childEntity = this[key];
                    var path = this.createPath(propertyName);
                    if (!childEntity) {
                        var dataField = fieldMetadata.dataField || propertyName;
                        // val不存在时，用空对象代替
                        var val = this.data[dataField] || {};
                        childEntity = EntityTypeCreator.buildEntity(path, val, this, fieldMetadata);
                        this[key] = childEntity;
                    }
                    return childEntity;
                },
                set: function (value) {
                    var path = this.createPath(propertyName);
                    var modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    var childEntity = EntityTypeCreator.buildEntity(path, value, this, fieldMetadata);
                    this[key] = childEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    };
    EntityTypeCreator.extendDynamicProperty = function (entityPrototype, ngDynamicMetadata) {
        Object.keys(ngDynamicMetadata).forEach(function (propertyName) {
            var fieldMetadata = ngDynamicMetadata[propertyName];
            var key = "__" + propertyName + "__";
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    var dynamicEntity = this[key];
                    var path = this.createPath(propertyName);
                    if (!dynamicEntity) {
                        var dataField = fieldMetadata.dataField || propertyName;
                        var originalData = this.data[dataField] || {};
                        dynamicEntity = EntityTypeCreator.buildDynamic(path, originalData, this, fieldMetadata);
                        this[key] = dynamicEntity;
                    }
                    return dynamicEntity;
                },
                set: function (value) {
                    var path = this.createPath(propertyName);
                    var modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    var dynamicEntity = EntityTypeCreator.buildDynamic(path, value, this, fieldMetadata);
                    this[key] = dynamicEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    };
    EntityTypeCreator.getType = function (constructor) {
        if (this.buffer.has(constructor)) {
            return this.buffer.get(constructor);
        }
        var entityType = this.createType(constructor);
        this.buffer.set(constructor, entityType);
        return entityType;
    };
    EntityTypeCreator.buildEntity = function (parentPath, value, parent, fieldMetadata) {
        var instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = EntityFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(function (changes) {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                parent.setChanges(changes);
            }
        });
        return instance;
    };
    EntityTypeCreator.buildDynamic = function (parentPath, value, parent, fieldMetadata) {
        var instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = DynamicFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(function (changes) {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                parent.setChanges(changes);
            }
        });
        return instance;
    };
    EntityTypeCreator.buffer = new Map();
    return EntityTypeCreator;
}());
export { EntityTypeCreator };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3R5cGVfY3JlYXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHlfdHlwZV9jcmVhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxpQkFBaUIsRUFBd0UsTUFBTSxZQUFZLENBQUM7QUFDckgsT0FBTyxFQUFhLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFL0Q7SUFBQTtJQW1NQSxDQUFDO0lBak1lLHdCQUFNLEdBQXBCLFVBQXFCLFdBQXFCLEVBQUUsSUFBUztRQUNuRCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzdDLElBQU0sTUFBTSxHQUFHLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sQ0FBQyxXQUFXLEdBQUcsV0FBVyxDQUFDO1FBQ2pDLE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDRCw0R0FBNEc7SUFDOUYsNEJBQVUsR0FBeEIsVUFBeUIsV0FBcUI7UUFDNUMsSUFBTSxVQUFVO1lBQTRCLHNDQUFNO1lBQ2hELG9CQUFZLElBQVM7dUJBQ25CLGtCQUFNLElBQUksQ0FBQztZQUNiLENBQUM7WUFDSCxpQkFBQztRQUFELENBQUMsQUFKa0IsQ0FBeUIsTUFBTSxFQUlqRCxDQUFDO1FBQ0YsSUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztRQUM3QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FB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QUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDaEUsTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUM1QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztJQWpNYyx3QkFBTSxHQUFHLElBQUksR0FBRyxFQUFZLENBQUM7SUFrTTlDLHdCQUFDO0NBQUEsQUFuTUQsSUFtTUM7U0FuTVksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTW9kaWZ5VHlwZSB9IGZyb20gXCIuLi9jaGFuZ2VzZXRcIjtcclxuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSBcIi4vZW50aXR5XCI7XHJcbmltcG9ydCB7IER5bmFtaWNGYWN0b3J5LCBFbnRpdHlGYWN0b3J5IH0gZnJvbSBcIi4vZW50aXR5X2ZhY3RvcnlcIjtcclxuaW1wb3J0IHsgRW50aXR5TGlzdCB9IGZyb20gXCIuL2VudGl0eV9saXN0XCI7XHJcbmltcG9ydCB7IEZpZWxkTWV0YWRhdGFVdGlsLCBOZ0R5bmFtaWNQcm9wZXJ0eSwgTmdGaWVsZFByb3BlcnR5LCBOZ0xpc3RQcm9wZXJ0eSwgTmdPYmplY3RQcm9wZXJ0eSB9IGZyb20gXCIuL21ldGFkYXRhXCI7XHJcbmltcG9ydCB7IENsYXNzVHlwZSwgUEFSRU5UX0NMQVNTLCBQQVJFTlRfUEFUSCB9IGZyb20gXCIuL3R5cGVzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRW50aXR5VHlwZUNyZWF0b3Ige1xyXG4gIHByaXZhdGUgc3RhdGljIGJ1ZmZlciA9IG5ldyBNYXA8YW55LCBhbnk+KCk7XHJcbiAgcHVibGljIHN0YXRpYyBjcmVhdGUoY29uc3RydWN0b3I6IEZ1bmN0aW9uLCBkYXRhOiBhbnkpOiBFbnRpdHkge1xyXG4gICAgY29uc3QgZW50aXR5VHlwZSA9IHRoaXMuZ2V0VHlwZShjb25zdHJ1Y3Rvcik7XHJcbiAgICBjb25zdCBlbnRpdHkgPSBuZXcgZW50aXR5VHlwZShkYXRhKTtcclxuICAgIGVudGl0eS5jb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yO1xyXG4gICAgcmV0dXJuIGVudGl0eTtcclxuICB9XHJcbiAgLy8gQENhY2hlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IHsgcmV0dXJuIGFyZ3NbMF0gfSksIHByb3ZpZGVyOiBuZXcgTWVtb3J5Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgcHVibGljIHN0YXRpYyBjcmVhdGVUeXBlKGNvbnN0cnVjdG9yOiBGdW5jdGlvbik6IENsYXNzVHlwZTxFbnRpdHk+IHtcclxuICAgIGNvbnN0IGVudGl0eVR5cGUgPSBjbGFzcyBFbnRpdHlUeXBlIGV4dGVuZHMgRW50aXR5IHtcclxuICAgICAgY29uc3RydWN0b3IoZGF0YTogYW55KSB7XHJcbiAgICAgICAgc3VwZXIoZGF0YSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBlbnRpdHlQcm90b3R5cGUgPSBlbnRpdHlUeXBlLnByb3RvdHlwZTtcclxuICAgIHRoaXMuZXh0ZW5kUHJvcGVydGllcyhjb25zdHJ1Y3RvciwgZW50aXR5UHJvdG90eXBlKTtcclxuICAgIHJldHVybiBlbnRpdHlUeXBlO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmRQcm9wZXJ0aWVzKGNvbnN0cnVjdG9yOiBGdW5jdGlvbiwgZW50aXR5UHJvdG90eXBlOiBFbnRpdHkpIHtcclxuICAgIGNvbnN0IG5nRmllbGRzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdGaWVsZHMoY29uc3RydWN0b3IpO1xyXG4gICAgY29uc3QgbmdPYmplY3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKGNvbnN0cnVjdG9yKTtcclxuICAgIGNvbnN0IG5nTGlzdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0xpc3QoY29uc3RydWN0b3IpO1xyXG4gICAgY29uc3QgbmdEeW5hbWljID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdEeW5hbWljKGNvbnN0cnVjdG9yKTtcclxuICAgIHRoaXMuZXh0ZW5kUGxhaW5Qcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIG5nRmllbGRzKTtcclxuICAgIHRoaXMuZXh0ZW5kTGlzdFByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgbmdMaXN0cyk7XHJcbiAgICB0aGlzLmV4dGVuZE9iamVjdFByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgbmdPYmplY3RzKTtcclxuICAgIHRoaXMuZXh0ZW5kRHluYW1pY1Byb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgbmdEeW5hbWljKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZFBsYWluUHJvcGVydHkoZW50aXR5UHJvdG90eXBlOiBFbnRpdHksIG5nRmllbGRzOiB7IFtrZXk6IHN0cmluZ106IE5nRmllbGRQcm9wZXJ0eSB9KTogdm9pZCB7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0ZpZWxkcykuZm9yRWFjaChmdW5jdGlvbiAocHJvcE5hbWUpIHtcclxuICAgICAgY29uc3QgbmdGaWVsZCA9IG5nRmllbGRzW3Byb3BOYW1lXSBhcyBOZ0ZpZWxkUHJvcGVydHk7XHJcbiAgICAgIC8vIGNvbnN0IGRhdGFGaWVsZCA9IG5nRmllbGQuZGF0YUZpZWxkIHx8IHByb3BOYW1lO1xyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBwcm9wTmFtZSwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFByb3BWYWx1ZShwcm9wTmFtZSwgbmdGaWVsZCk7XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uIChuZXdQcm9wVmFsdWUpIHtcclxuICAgICAgICAgIC8vIOWAvOebuOWQjOaXtuS4jeinpuWPkeWPmOabtOOAglxyXG4gICAgICAgICAgY29uc3Qgb2xkUHJvcFZhbHVlID0gdGhpcy5nZXRQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQpO1xyXG4gICAgICAgICAgaWYgKHRoaXMuaXNQcm9wVmFsdWVDaGFuZ2VkKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUsIG9sZFByb3BWYWx1ZSkgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHRoaXMuc2V0UHJvcFZhbHVlKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUpO1xyXG4gICAgICAgICAgY29uc3QgY2hhbmdlU2V0VmFsdWUgPSB0aGlzLnByZXBhcmVQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQsIG5ld1Byb3BWYWx1ZSk7XHJcbiAgICAgICAgICB0aGlzLmVtaXRWYWx1ZUNoYW5nZShwcm9wTmFtZSwgbmdGaWVsZCwgbmV3UHJvcFZhbHVlLCBvbGRQcm9wVmFsdWUsIGNoYW5nZVNldFZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZExpc3RQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGU6IEVudGl0eSwgbmdMaXN0TWV0YWRhdGE6IHsgW2tleTogc3RyaW5nXTogTmdMaXN0UHJvcGVydHkgfSk6IHZvaWQge1xyXG4gICAgT2JqZWN0LmtleXMobmdMaXN0TWV0YWRhdGEpLmZvckVhY2goZnVuY3Rpb24gKHByb3BlcnR5TmFtZSkge1xyXG4gICAgICBjb25zdCBrZXkgPSBgX18ke3Byb3BlcnR5TmFtZX1fX2A7XHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgbGV0IGVudGl0eUxpc3QgPSB0aGlzW2tleV07XHJcbiAgICAgICAgICBpZiAoIWVudGl0eUxpc3QpIHtcclxuICAgICAgICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IG5nTGlzdE1ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTmdMaXN0UHJvcGVydHk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YUZpZWxkID0gZmllbGRNZXRhZGF0YS5kYXRhRmllbGQgfHwgcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgICBjb25zdCB2YWwgPSB0aGlzLmRhdGFbZGF0YUZpZWxkXTtcclxuICAgICAgICAgICAgZW50aXR5TGlzdCA9IG5ldyBFbnRpdHlMaXN0PHR5cGVvZiBmaWVsZE1ldGFkYXRhLnR5cGU+KCk7XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3RbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3RbUEFSRU5UX1BBVEhdID0gcGF0aDtcclxuICAgICAgICAgICAgaWYgKHZhbCkge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGVudGl0aWVzID0gdmFsLm1hcCh2ID0+IEVudGl0eUZhY3Rvcnk8dHlwZW9mIGZpZWxkTWV0YWRhdGEudHlwZT4oZmllbGRNZXRhZGF0YS50eXBlLCB2KSk7XHJcbiAgICAgICAgICAgICAgZW50aXR5TGlzdC5sb2FkRW50aXRpZXMoZW50aXRpZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGVudGl0eUxpc3Qub25MaXN0Q2hhbmdlZC5zdWJzY3JpYmUodmFsdWUgPT4ge1xyXG4gICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGVudGl0eUxpc3RbUEFSRU5UX1BBVEhdWzBdICE9PSB2YWx1ZS5wYXRoWzBdKSB7XHJcbiAgICAgICAgICAgICAgICAgIHZhbHVlLnBhdGggPSBlbnRpdHlMaXN0W1BBUkVOVF9QQVRIXS5jb25jYXQodmFsdWUucGF0aCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldENoYW5nZXModmFsdWUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHRoaXNba2V5XSA9IGVudGl0eUxpc3Q7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gZW50aXR5TGlzdDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZE9iamVjdFByb3BlcnR5KGVudGl0eVByb3RvdHlwZTogRW50aXR5LCBuZ09iamVjdE1ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IE5nT2JqZWN0UHJvcGVydHkgfSkge1xyXG4gICAgT2JqZWN0LmtleXMobmdPYmplY3RNZXRhZGF0YSkuZm9yRWFjaChmdW5jdGlvbiAocHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIGNvbnN0IGZpZWxkTWV0YWRhdGEgPSBuZ09iamVjdE1ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTmdPYmplY3RQcm9wZXJ0eTtcclxuICAgICAgY29uc3Qga2V5ID0gYF9fJHtwcm9wZXJ0eU5hbWV9X19gO1xyXG4gICAgICAvLyDlpoLmnpzmsqHmnInlgLznlKjkuIDkuKrnqbrlr7nosaHku6Pmm79cclxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICBsZXQgY2hpbGRFbnRpdHkgPSB0aGlzW2tleV07XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBpZiAoIWNoaWxkRW50aXR5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IGZpZWxkTWV0YWRhdGEuZGF0YUZpZWxkIHx8IHByb3BlcnR5TmFtZTtcclxuICAgICAgICAgICAgLy8gdmFs5LiN5a2Y5Zyo5pe277yM55So56m65a+56LGh5Luj5pu/XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZGF0YVtkYXRhRmllbGRdIHx8IHt9O1xyXG4gICAgICAgICAgICBjaGlsZEVudGl0eSA9IEVudGl0eVR5cGVDcmVhdG9yLmJ1aWxkRW50aXR5KHBhdGgsIHZhbCwgdGhpcywgZmllbGRNZXRhZGF0YSk7XHJcbiAgICAgICAgICAgIHRoaXNba2V5XSA9IGNoaWxkRW50aXR5O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGNoaWxkRW50aXR5O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWU6IGFueSkge1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcclxuICAgICAgICAgICAgcGF0aDogcGF0aCxcclxuICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXHJcbiAgICAgICAgICAgIHByZVZhbHVlOiB0aGlzW3Byb3BlcnR5TmFtZV0uZGF0YSxcclxuICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGNvbnN0IGNoaWxkRW50aXR5ID0gRW50aXR5VHlwZUNyZWF0b3IuYnVpbGRFbnRpdHkocGF0aCwgdmFsdWUsIHRoaXMsIGZpZWxkTWV0YWRhdGEpO1xyXG4gICAgICAgICAgdGhpc1trZXldID0gY2hpbGRFbnRpdHk7XHJcbiAgICAgICAgICB0aGlzLnNldENoYW5nZXMobW9kaWZ5SW5mbyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBleHRlbmREeW5hbWljUHJvcGVydHkoZW50aXR5UHJvdG90eXBlOiBFbnRpdHksIG5nRHluYW1pY01ldGFkYXRhOiB7IFtrZXk6IHN0cmluZ106IE5nRHluYW1pY1Byb3BlcnR5IH0pIHtcclxuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY01ldGFkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWUpIHtcclxuICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IG5nRHluYW1pY01ldGFkYXRhW3Byb3BlcnR5TmFtZV0gYXMgTmdEeW5hbWljUHJvcGVydHk7XHJcbiAgICAgIGNvbnN0IGtleSA9IGBfXyR7cHJvcGVydHlOYW1lfV9fYDtcclxuICAgICAgXHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgbGV0IGR5bmFtaWNFbnRpdHkgPSB0aGlzW2tleV07XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBpZiAoIWR5bmFtaWNFbnRpdHkpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YUZpZWxkID0gZmllbGRNZXRhZGF0YS5kYXRhRmllbGQgfHwgcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSB0aGlzLmRhdGFbZGF0YUZpZWxkXSB8fCB7fTtcclxuICAgICAgICAgICAgZHluYW1pY0VudGl0eSA9IEVudGl0eVR5cGVDcmVhdG9yLmJ1aWxkRHluYW1pYyhwYXRoLCBvcmlnaW5hbERhdGEsIHRoaXMsIGZpZWxkTWV0YWRhdGEpO1xyXG4gICAgICAgICAgICB0aGlzW2tleV0gPSBkeW5hbWljRW50aXR5O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIGR5bmFtaWNFbnRpdHk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkge1xyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcclxuICAgICAgICAgICAgcGF0aDogcGF0aCxcclxuICAgICAgICAgICAgdmFsdWU6IHZhbHVlLmRhdGEsXHJcbiAgICAgICAgICAgIHByZVZhbHVlOiB0aGlzW3Byb3BlcnR5TmFtZV0uZGF0YSxcclxuICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGxldCBkeW5hbWljRW50aXR5ID0gRW50aXR5VHlwZUNyZWF0b3IuYnVpbGREeW5hbWljKHBhdGgsIHZhbHVlLCB0aGlzLCBmaWVsZE1ldGFkYXRhKTtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IGR5bmFtaWNFbnRpdHk7XHJcbiAgICAgICAgICB0aGlzLnNldENoYW5nZXMobW9kaWZ5SW5mbyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBnZXRUeXBlKGNvbnN0cnVjdG9yOiBGdW5jdGlvbikge1xyXG4gICAgaWYgKHRoaXMuYnVmZmVyLmhhcyhjb25zdHJ1Y3RvcikpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyLmdldChjb25zdHJ1Y3Rvcik7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHlUeXBlID0gdGhpcy5jcmVhdGVUeXBlKGNvbnN0cnVjdG9yKTtcclxuICAgIHRoaXMuYnVmZmVyLnNldChjb25zdHJ1Y3RvciwgZW50aXR5VHlwZSk7XHJcbiAgICByZXR1cm4gZW50aXR5VHlwZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgYnVpbGRFbnRpdHkocGFyZW50UGF0aDogc3RyaW5nW10sIHZhbHVlOiBhbnksIHBhcmVudDogYW55LCBmaWVsZE1ldGFkYXRhOiBOZ09iamVjdFByb3BlcnR5IHwgTmdEeW5hbWljUHJvcGVydHkpIHtcclxuICAgIGxldCBpbnN0YW5jZTtcclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGZpZWxkTWV0YWRhdGEudHlwZSkge1xyXG4gICAgICBpbnN0YW5jZSA9IHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaW5zdGFuY2UgPSBFbnRpdHlGYWN0b3J5KGZpZWxkTWV0YWRhdGEudHlwZSwgdmFsdWUpO1xyXG4gICAgfVxyXG4gICAgaW5zdGFuY2VbUEFSRU5UX0NMQVNTXSA9IHBhcmVudDtcclxuICAgIGluc3RhbmNlW1BBUkVOVF9QQVRIXSA9IHBhcmVudFBhdGg7XHJcbiAgICBpbnN0YW5jZS5vblZhbHVlQ2hhbmdlZC5zdWJzY3JpYmUoY2hhbmdlcyA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2VzKSB7XHJcbiAgICAgICAgY2hhbmdlcy5wYXRoID0gKHBhcmVudFtQQVJFTlRfUEFUSF0gfHwgW10pLmNvbmNhdChjaGFuZ2VzLnBhdGgpO1xyXG4gICAgICAgIHBhcmVudC5zZXRDaGFuZ2VzKGNoYW5nZXMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBpbnN0YW5jZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgYnVpbGREeW5hbWljKHBhcmVudFBhdGg6IHN0cmluZ1tdLCB2YWx1ZTogYW55LCBwYXJlbnQ6IGFueSwgZmllbGRNZXRhZGF0YTogTmdPYmplY3RQcm9wZXJ0eSB8IE5nRHluYW1pY1Byb3BlcnR5KSB7XHJcbiAgICBsZXQgaW5zdGFuY2U7XHJcbiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBmaWVsZE1ldGFkYXRhLnR5cGUpIHtcclxuICAgICAgaW5zdGFuY2UgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGluc3RhbmNlID0gRHluYW1pY0ZhY3RvcnkoZmllbGRNZXRhZGF0YS50eXBlLCB2YWx1ZSk7XHJcbiAgICB9XHJcbiAgICBpbnN0YW5jZVtQQVJFTlRfQ0xBU1NdID0gcGFyZW50O1xyXG4gICAgaW5zdGFuY2VbUEFSRU5UX1BBVEhdID0gcGFyZW50UGF0aDtcclxuICAgIGluc3RhbmNlLm9uVmFsdWVDaGFuZ2VkLnN1YnNjcmliZShjaGFuZ2VzID0+IHtcclxuICAgICAgaWYgKGNoYW5nZXMpIHtcclxuICAgICAgICBjaGFuZ2VzLnBhdGggPSAocGFyZW50W1BBUkVOVF9QQVRIXSB8fCBbXSkuY29uY2F0KGNoYW5nZXMucGF0aCk7XHJcbiAgICAgICAgcGFyZW50LnNldENoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGluc3RhbmNlO1xyXG4gIH1cclxufSJdfQ==