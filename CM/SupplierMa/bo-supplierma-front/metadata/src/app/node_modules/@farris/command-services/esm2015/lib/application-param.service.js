import { take } from 'rxjs/operators';
import { Injectable, Optional } from '@angular/core';
import { ParamService } from './param.service';
import { RuntimeFrameworkService } from './rtf-service';
import { isObservable } from 'rxjs';
/**
 * 应用参数服务
 * @scope FormModule
 */
export class ApplicationParamService {
    constructor(paramService, runtimeFrameworkService) {
        this.paramService = paramService;
        this.runtimeFrameworkService = runtimeFrameworkService;
        if (!this.runtimeFrameworkService) {
            this.runtimeFrameworkService = new RuntimeFrameworkService();
        }
    }
    /**
     * 解析参数
     */
    parseParams(route, frameworkService, viewModel, callback) {
        const highOrderInvoke = this.highOrderInvoke(callback);
        if (!this.paramService) {
            route.queryParams.pipe(take(1)).subscribe((params) => {
                this.params = params;
                this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
        else {
            this.paramService.parse().pipe(take(1)).subscribe(params => {
                this.params = params;
                this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
    }
    /**
     * 设置参数
     */
    setupParams(params, frameworkService, viewModel, callback) {
        const queryParams = this.getParams(params);
        if (!queryParams) {
            callback();
            return;
        }
        // 先设置参数，保证普通路由也能正常执行。
        this.setQueryParams(queryParams, viewModel);
        const funcId = this.getFuncId(queryParams);
        const appId = this.getAppId(queryParams);
        if (!funcId && !appId) {
            callback();
            return;
        }
        if (funcId) {
            this.setStaticParams(funcId, queryParams, frameworkService, viewModel, callback);
        }
        else {
            callback();
        }
    }
    /**
     * 设置查询参数
     */
    setQueryParams(queryParams, viewModel) {
        const parsedQueryParams = {};
        // 设置表单参数
        // 首先判断是否为弹窗
        const isInDialog = this.isInDialog(viewModel);
        const uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        // 如果是弹窗，弹窗外的参数（无论表单参数或静态参数）不应该覆盖弹窗的参数。弹窗打开时传递的参数相当于局部变量，不应被覆盖
        Object.keys(queryParams).forEach((paramName) => {
            if (!isInDialog) {
                parsedQueryParams[paramName] = queryParams[paramName];
            }
            else {
                if (!uiState.hasOwnProperty(paramName)) {
                    parsedQueryParams[paramName] = queryParams[paramName];
                }
            }
        });
        this.updateUIState(viewModel, parsedQueryParams);
    }
    /**
     * 设置静态参数
     */
    setStaticParams(funcId, queryParams, frameworkService, viewModel, callback) {
        this.runtimeFrameworkService.getMenuParams(funcId, (staicParams) => {
            const staticParamsObj = this.mapStaticParamsToObject(staicParams, queryParams, viewModel);
            if (!staticParamsObj) {
                callback();
                return;
            }
            this.updateUIState(viewModel, staticParamsObj);
            callback();
        });
    }
    /**
     * 将staticParams转换为普通对象
     * @param staticParams，形如：[{'name': 'key1', 'value': 'val1'}, {'name': 'key2', 'value': 'val2'}]
     * @return 形如：{key1: val1, key2: value2 }
     */
    mapStaticParamsToObject(staticParams, queryParams, viewModel) {
        if (!staticParams) {
            return;
        }
        const inDialog = this.isInDialog(viewModel);
        const uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        const result = {};
        staticParams.forEach((value, key, map) => {
            if (!inDialog) {
                // 静态参数不能覆盖查询参数
                if (!queryParams.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
            else {
                if (!queryParams.hasOwnProperty(key) && !uiState.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
        });
        return result;
    }
    /**
     * 是否在弹窗内
     * @param viewModel viewmodel
     */
    isInDialog(viewModel) {
        let isInDialog = false;
        if (viewModel && viewModel.uiState) {
            // tslint:disable-next-line: max-line-length
            if (viewModel.uiState.innerData && viewModel.uiState.innerData.hasOwnProperty('DEVKIT_DIALOG') || viewModel.uiState['DEVKIT_DIALOG']) {
                isInDialog = true;
            }
        }
        return isInDialog;
    }
    /**
     * 更新UIState
     */
    updateUIState(viewModel, params) {
        if (!viewModel || !params) {
            return;
        }
        const uiState = viewModel.uiState;
        // 兼容使用string传递params对象的场景
        if (typeof params === 'string' && params !== '') {
            params = JSON.parse(params);
        }
        // 在UIState为参数创建属性
        Object.keys(params).forEach((propName) => {
            uiState.setPropertyValue(propName, params[propName]);
            if (propName && propName === 'union_session') {
                let sessionInfo = params[propName];
                this.setSessionInfo(viewModel, sessionInfo);
            }
        });
    }
    setSessionInfo(viewModel, sessionInfo) {
        if (!viewModel || !sessionInfo) {
            return;
        }
        if (sessionInfo && typeof sessionInfo === 'string' && sessionInfo.startsWith('{') && sessionInfo.endsWith('}')) {
            sessionInfo = JSON.parse(sessionInfo);
        }
        const token = sessionInfo && sessionInfo.token || null;
        const sessionId = sessionInfo && sessionInfo.sessionId || null;
        if (token) {
            viewModel.frameContext.appContext.Token = token;
        }
        if (sessionId) {
            const befRepository = viewModel.frameContext.repository;
            if (befRepository) {
                befRepository.restService.sessionService.setBeSessionId(sessionId);
            }
        }
    }
    /**
     * 获取功能菜单id
     */
    getFuncId(queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['funcId'];
    }
    /**
     * 获取应用id
     */
    getAppId(queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['appId'];
    }
    getTabId(queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['tabId'];
    }
    /**
     * 获取url参数对象
     * @param queryParams url参数
     */
    getParams(queryParams) {
        if (!queryParams) {
            return {};
        }
        let result = {};
        if (queryParams.hasOwnProperty('WEB_FORM_ROUTE_PARAMS')) {
            let webFormRouteParams = queryParams['WEB_FORM_ROUTE_PARAMS'];
            if (webFormRouteParams && webFormRouteParams.startsWith('{') && webFormRouteParams.endsWith('}')) {
                webFormRouteParams = decodeURI(encodeURI(webFormRouteParams).replace(/%0A/g, '\\n').replace(/%09/g, '\\t').replace(/%0D/g, '\\r'));
                result = JSON.parse(webFormRouteParams);
            }
            Object.keys(queryParams).forEach(prop => {
                if (prop !== 'WEB_FORM_ROUTE_PARAMS') {
                    result[prop] = queryParams[prop];
                }
            });
            return result;
        }
        return queryParams;
    }
    highOrderInvoke(callback) {
        return () => {
            try {
                const queryParams = this.getParams(this.params);
                const tabId = this.getTabId(queryParams);
                if (tabId) {
                    const controlEvent = this.runtimeFrameworkService.getMenuSwitchControlEvent();
                    if (controlEvent && isObservable(controlEvent)) {
                        controlEvent.subscribe((event) => {
                            if (event) {
                                event.next('ok');
                            }
                        });
                    }
                }
            }
            catch (e) {
                console.warn(e);
            }
            if (callback && typeof callback === 'function') {
                callback();
            }
        };
    }
}
ApplicationParamService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ApplicationParamService.ctorParameters = () => [
    { type: ParamService, decorators: [{ type: Optional }] },
    { type: RuntimeFrameworkService, decorators: [{ type: Optional }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tcGFyYW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9hcHBsaWNhdGlvbi1wYXJhbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXhELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFcEM7OztHQUdHO0FBR0gsTUFBTSxPQUFPLHVCQUF1QjtJQUVsQyxZQUNzQixZQUEwQixFQUMxQix1QkFBZ0Q7UUFEaEQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUVwRSxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFO1lBQ2pDLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLHVCQUF1QixFQUFFLENBQUM7U0FDOUQ7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDSSxXQUFXLENBQUMsS0FBcUIsRUFBRSxnQkFBa0MsRUFBRSxTQUFvQixFQUFFLFFBQW9CO1FBQ3RILE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDdEIsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUU7Z0JBQ3hELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFB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SSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ2hELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ3pDLElBQUksS0FBSyxFQUFFO29CQUNULE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyx5QkFBeUIsRUFBRSxDQUFDO29CQUM5RSxJQUFJLFlBQVksSUFBSSxZQUFZLENBQUMsWUFBWSxDQUFDLEVBQUU7d0JBQzlDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFVLEVBQUUsRUFBRTs0QkFDcEMsSUFBSSxLQUFLLEVBQUU7Z0NBQ1QsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs2QkFDbEI7d0JBQ0gsQ0FBQyxDQUFDLENBQUM7cUJBQ0o7aUJBQ0Y7YUFDRjtZQUFDLE9BQU8sQ0FBQyxFQUFFO2dCQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFBRTtZQUNoQyxJQUFJLFFBQVEsSUFBSSxPQUFPLFFBQVEsS0FBSyxVQUFVLEVBQUU7Z0JBQzlDLFFBQVEsRUFBRSxDQUFDO2FBQ1o7UUFDSCxDQUFDLENBQUE7SUFDSCxDQUFDOzs7WUFyUEYsVUFBVTs7OztZQVZGLFlBQVksdUJBY2hCLFFBQVE7WUFiSix1QkFBdUIsdUJBYzNCLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUGFyYW1NYXAgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICdAZ3NwLXN5cy9ydGYtY29tbW9uJztcbmltcG9ydCB7IFZpZXdNb2RlbCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQYXJhbVNlcnZpY2UgfSBmcm9tICcuL3BhcmFtLnNlcnZpY2UnO1xuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL3J0Zi1zZXJ2aWNlJztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XG5pbXBvcnQgeyBpc09ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuLyoqXG4gKiDlupTnlKjlj4LmlbDmnI3liqFcbiAqIEBzY29wZSBGb3JtTW9kdWxlXG4gKi9cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFwcGxpY2F0aW9uUGFyYW1TZXJ2aWNlIHtcbiAgcHJpdmF0ZSBwYXJhbXM6IGFueTtcbiAgY29uc3RydWN0b3IoXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBwYXJhbVNlcnZpY2U6IFBhcmFtU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlOiBSdW50aW1lRnJhbWV3b3JrU2VydmljZSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlKSB7XG4gICAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlID0gbmV3IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlKCk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDop6PmnpDlj4LmlbBcbiAgICovXG4gIHB1YmxpYyBwYXJzZVBhcmFtcyhyb3V0ZTogQWN0aXZhdGVkUm91dGUsIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbDogVmlld01vZGVsLCBjYWxsYmFjazogKCkgPT4gdm9pZCkge1xuICAgIGNvbnN0IGhpZ2hPcmRlckludm9rZSA9IHRoaXMuaGlnaE9yZGVySW52b2tlKGNhbGxiYWNrKTtcbiAgICBpZiAoIXRoaXMucGFyYW1TZXJ2aWNlKSB7XG4gICAgICByb3V0ZS5xdWVyeVBhcmFtcy5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgocGFyYW1zOiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1zLCBmcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWwsIGhpZ2hPcmRlckludm9rZSk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wYXJhbVNlcnZpY2UucGFyc2UoKS5waXBlKHRha2UoMSkpLnN1YnNjcmliZShwYXJhbXMgPT4ge1xuICAgICAgICB0aGlzLnBhcmFtcyA9IHBhcmFtcztcbiAgICAgICAgdGhpcy5zZXR1cFBhcmFtcyhwYXJhbXMsIGZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbCwgaGlnaE9yZGVySW52b2tlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDorr7nva7lj4LmlbBcbiAgICovXG4gIHByaXZhdGUgc2V0dXBQYXJhbXMocGFyYW1zLCBmcmFtZXdvcmtTZXJ2aWNlOiBGcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWw6IFZpZXdNb2RlbCwgY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKHBhcmFtcyk7XG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xuICAgICAgY2FsbGJhY2soKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyDlhYjorr7nva7lj4LmlbDvvIzkv53or4Hmma7pgJrot6/nlLHkuZ/og73mraPluLjmiafooYzjgIJcbiAgICB0aGlzLnNldFF1ZXJ5UGFyYW1zKHF1ZXJ5UGFyYW1zLCB2aWV3TW9kZWwpO1xuXG4gICAgY29uc3QgZnVuY0lkID0gdGhpcy5nZXRGdW5jSWQocXVlcnlQYXJhbXMpO1xuICAgIGNvbnN0IGFwcElkID0gdGhpcy5nZXRBcHBJZChxdWVyeVBhcmFtcyk7XG4gICAgaWYgKCFmdW5jSWQgJiYgIWFwcElkKSB7XG4gICAgICBjYWxsYmFjaygpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChmdW5jSWQpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGljUGFyYW1zKGZ1bmNJZCwgcXVlcnlQYXJhbXMsIGZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbCwgY2FsbGJhY2spO1xuICAgIH0gZWxzZSB7XG4gICAgICBjYWxsYmFjaygpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6K6+572u5p+l6K+i5Y+C5pWwXG4gICAqL1xuICBwcml2YXRlIHNldFF1ZXJ5UGFyYW1zKHF1ZXJ5UGFyYW1zOiBhbnksIHZpZXdNb2RlbDogVmlld01vZGVsKTogYW55IHtcbiAgICBjb25zdCBwYXJzZWRRdWVyeVBhcmFtcyA9IHt9O1xuICAgIC8vIOiuvue9ruihqOWNleWPguaVsFxuICAgIC8vIOmmluWFiOWIpOaWreaYr+WQpuS4uuW8ueeql1xuICAgIGNvbnN0IGlzSW5EaWFsb2cgPSB0aGlzLmlzSW5EaWFsb2codmlld01vZGVsKTtcbiAgICBjb25zdCB1aVN0YXRlID0gdmlld01vZGVsICYmIHZpZXdNb2RlbC51aVN0YXRlICYmIHZpZXdNb2RlbC51aVN0YXRlLmlubmVyRGF0YSB8fCB7fTtcbiAgICAvLyDlpoLmnpzmmK/lvLnnqpfvvIzlvLnnqpflpJbnmoTlj4LmlbDvvIjml6DorrrooajljZXlj4LmlbDmiJbpnZnmgIHlj4LmlbDvvInkuI3lupTor6Xopobnm5blvLnnqpfnmoTlj4LmlbDjgILlvLnnqpfmiZPlvIDml7bkvKDpgJLnmoTlj4LmlbDnm7jlvZPkuo7lsYDpg6jlj5jph4/vvIzkuI3lupTooqvopobnm5ZcbiAgICBPYmplY3Qua2V5cyhxdWVyeVBhcmFtcykuZm9yRWFjaCgocGFyYW1OYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmICghaXNJbkRpYWxvZykge1xuICAgICAgICBwYXJzZWRRdWVyeVBhcmFtc1twYXJhbU5hbWVdID0gcXVlcnlQYXJhbXNbcGFyYW1OYW1lXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghdWlTdGF0ZS5oYXNPd25Qcm9wZXJ0eShwYXJhbU5hbWUpKSB7XG4gICAgICAgICAgcGFyc2VkUXVlcnlQYXJhbXNbcGFyYW1OYW1lXSA9IHF1ZXJ5UGFyYW1zW3BhcmFtTmFtZV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICB0aGlzLnVwZGF0ZVVJU3RhdGUodmlld01vZGVsLCBwYXJzZWRRdWVyeVBhcmFtcyk7XG4gIH1cblxuICAvKipcbiAgICog6K6+572u6Z2Z5oCB5Y+C5pWwXG4gICAqL1xuICBwcml2YXRlIHNldFN0YXRpY1BhcmFtcyhcbiAgICBmdW5jSWQ6IHN0cmluZywgcXVlcnlQYXJhbXM6IGFueSwgZnJhbWV3b3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSwgdmlld01vZGVsOiBWaWV3TW9kZWwsIGNhbGxiYWNrOiAoKSA9PiB2b2lkXG4gICkge1xuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuZ2V0TWVudVBhcmFtcyhmdW5jSWQsIChzdGFpY1BhcmFtcykgPT4ge1xuICAgICAgY29uc3Qgc3RhdGljUGFyYW1zT2JqID0gdGhpcy5tYXBTdGF0aWNQYXJhbXNUb09iamVjdChzdGFpY1BhcmFtcywgcXVlcnlQYXJhbXMsIHZpZXdNb2RlbCk7XG4gICAgICBpZiAoIXN0YXRpY1BhcmFtc09iaikge1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0aGlzLnVwZGF0ZVVJU3RhdGUodmlld01vZGVsLCBzdGF0aWNQYXJhbXNPYmopO1xuICAgICAgY2FsbGJhY2soKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlsIZzdGF0aWNQYXJhbXPovazmjaLkuLrmma7pgJrlr7nosaFcbiAgICogQHBhcmFtIHN0YXRpY1BhcmFtc++8jOW9ouWmgu+8mlt7J25hbWUnOiAna2V5MScsICd2YWx1ZSc6ICd2YWwxJ30sIHsnbmFtZSc6ICdrZXkyJywgJ3ZhbHVlJzogJ3ZhbDInfV1cbiAgICogQHJldHVybiDlvaLlpoLvvJp7a2V5MTogdmFsMSwga2V5MjogdmFsdWUyIH1cbiAgICovXG4gIHByaXZhdGUgbWFwU3RhdGljUGFyYW1zVG9PYmplY3Qoc3RhdGljUGFyYW1zOiBNYXA8YW55LCBhbnk+LCBxdWVyeVBhcmFtczogYW55LCB2aWV3TW9kZWw/OiBWaWV3TW9kZWwpOiBhbnkge1xuICAgIGlmICghc3RhdGljUGFyYW1zKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGluRGlhbG9nID0gdGhpcy5pc0luRGlhbG9nKHZpZXdNb2RlbCk7XG4gICAgY29uc3QgdWlTdGF0ZSA9IHZpZXdNb2RlbCAmJiB2aWV3TW9kZWwudWlTdGF0ZSAmJiB2aWV3TW9kZWwudWlTdGF0ZS5pbm5lckRhdGEgfHwge307XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgc3RhdGljUGFyYW1zLmZvckVhY2goKHZhbHVlLCBrZXksIG1hcCkgPT4ge1xuICAgICAgaWYgKCFpbkRpYWxvZykge1xuICAgICAgICAvLyDpnZnmgIHlj4LmlbDkuI3og73opobnm5bmn6Xor6Llj4LmlbBcbiAgICAgICAgaWYgKCFxdWVyeVBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKCFxdWVyeVBhcmFtcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmICF1aVN0YXRlLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICAvKipcbiAgICog5piv5ZCm5Zyo5by556qX5YaFXG4gICAqIEBwYXJhbSB2aWV3TW9kZWwgdmlld21vZGVsXG4gICAqL1xuICBwcml2YXRlIGlzSW5EaWFsb2codmlld01vZGVsOiBWaWV3TW9kZWwpIHtcbiAgICBsZXQgaXNJbkRpYWxvZyA9IGZhbHNlO1xuICAgIGlmICh2aWV3TW9kZWwgJiYgdmlld01vZGVsLnVpU3RhdGUpIHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXG4gICAgICBpZiAodmlld01vZGVsLnVpU3RhdGUuaW5uZXJEYXRhICYmIHZpZXdNb2RlbC51aVN0YXRlLmlubmVyRGF0YS5oYXNPd25Qcm9wZXJ0eSgnREVWS0lUX0RJQUxPRycpIHx8IHZpZXdNb2RlbC51aVN0YXRlWydERVZLSVRfRElBTE9HJ10pIHtcbiAgICAgICAgaXNJbkRpYWxvZyA9IHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBpc0luRGlhbG9nO1xuICB9XG4gIC8qKlxuICAgKiDmm7TmlrBVSVN0YXRlXG4gICAqL1xuICBwcml2YXRlIHVwZGF0ZVVJU3RhdGUodmlld01vZGVsOiBWaWV3TW9kZWwsIHBhcmFtczogYW55KSB7XG4gICAgaWYgKCF2aWV3TW9kZWwgfHwgIXBhcmFtcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCB1aVN0YXRlID0gdmlld01vZGVsLnVpU3RhdGU7XG5cbiAgICAvLyDlhbzlrrnkvb/nlKhzdHJpbmfkvKDpgJJwYXJhbXPlr7nosaHnmoTlnLrmma9cbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3N0cmluZycgJiYgcGFyYW1zICE9PSAnJykge1xuICAgICAgcGFyYW1zID0gSlNPTi5wYXJzZShwYXJhbXMpO1xuICAgIH1cblxuICAgIC8vIOWcqFVJU3RhdGXkuLrlj4LmlbDliJvlu7rlsZ7mgKdcbiAgICBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcbiAgICAgIHVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZShwcm9wTmFtZSwgcGFyYW1zW3Byb3BOYW1lXSk7XG4gICAgICBpZiAocHJvcE5hbWUgJiYgcHJvcE5hbWUgPT09ICd1bmlvbl9zZXNzaW9uJykge1xuICAgICAgICBsZXQgc2Vzc2lvbkluZm8gPSBwYXJhbXNbcHJvcE5hbWVdO1xuICAgICAgICB0aGlzLnNldFNlc3Npb25JbmZvKHZpZXdNb2RlbCwgc2Vzc2lvbkluZm8pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIHByaXZhdGUgc2V0U2Vzc2lvbkluZm8odmlld01vZGVsOiBWaWV3TW9kZWwsIHNlc3Npb25JbmZvOiBhbnkpIHtcbiAgICBpZiAoIXZpZXdNb2RlbCB8fCAhc2Vzc2lvbkluZm8pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHNlc3Npb25JbmZvICYmIHR5cGVvZiBzZXNzaW9uSW5mbyA9PT0gJ3N0cmluZycgJiYgc2Vzc2lvbkluZm8uc3RhcnRzV2l0aCgneycpICYmIHNlc3Npb25JbmZvLmVuZHNXaXRoKCd9JykpIHtcbiAgICAgIHNlc3Npb25JbmZvID0gSlNPTi5wYXJzZShzZXNzaW9uSW5mbyk7XG4gICAgfVxuICAgIGNvbnN0IHRva2VuID0gc2Vzc2lvbkluZm8gJiYgc2Vzc2lvbkluZm8udG9rZW4gfHwgbnVsbDtcbiAgICBjb25zdCBzZXNzaW9uSWQgPSBzZXNzaW9uSW5mbyAmJiBzZXNzaW9uSW5mby5zZXNzaW9uSWQgfHwgbnVsbDtcbiAgICBpZiAodG9rZW4pIHtcbiAgICAgIHZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5Ub2tlbiA9IHRva2VuO1xuICAgIH1cbiAgICBpZiAoc2Vzc2lvbklkKSB7XG4gICAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdmlld01vZGVsLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICAgIGlmIChiZWZSZXBvc2l0b3J5KSB7XG4gICAgICAgIGJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2Uuc2Vzc2lvblNlcnZpY2Uuc2V0QmVTZXNzaW9uSWQoc2Vzc2lvbklkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluWKn+iDveiPnOWNlWlkXG4gICAqL1xuICBwcml2YXRlIGdldEZ1bmNJZChxdWVyeVBhcmFtczogYW55KTogYW55IHtcbiAgICBpZiAoIXF1ZXJ5UGFyYW1zKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHJldHVybiBxdWVyeVBhcmFtc1snZnVuY0lkJ107XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5bqU55SoaWRcbiAgICovXG4gIHByaXZhdGUgZ2V0QXBwSWQocXVlcnlQYXJhbXM6IGFueSk6IGFueSB7XG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gcXVlcnlQYXJhbXNbJ2FwcElkJ107XG4gIH1cbiAgcHJpdmF0ZSBnZXRUYWJJZChxdWVyeVBhcmFtczogYW55KSB7XG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gcXVlcnlQYXJhbXNbJ3RhYklkJ107XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPlnVybOWPguaVsOWvueixoVxuICAgKiBAcGFyYW0gcXVlcnlQYXJhbXMgdXJs5Y+C5pWwXG4gICAqL1xuICBwcml2YXRlIGdldFBhcmFtcyhxdWVyeVBhcmFtczogYW55KTogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9IHtcbiAgICBpZiAoIXF1ZXJ5UGFyYW1zKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICBpZiAocXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoJ1dFQl9GT1JNX1JPVVRFX1BBUkFNUycpKSB7XG4gICAgICBsZXQgd2ViRm9ybVJvdXRlUGFyYW1zOiBzdHJpbmcgPSBxdWVyeVBhcmFtc1snV0VCX0ZPUk1fUk9VVEVfUEFSQU1TJ107XG4gICAgICBpZiAod2ViRm9ybVJvdXRlUGFyYW1zICYmIHdlYkZvcm1Sb3V0ZVBhcmFtcy5zdGFydHNXaXRoKCd7JykgJiYgd2ViRm9ybVJvdXRlUGFyYW1zLmVuZHNXaXRoKCd9JykpIHtcbiAgICAgICAgd2ViRm9ybVJvdXRlUGFyYW1zID0gZGVjb2RlVVJJKGVuY29kZVVSSSh3ZWJGb3JtUm91dGVQYXJhbXMpLnJlcGxhY2UoLyUwQS9nLCAnXFxcXG4nKS5yZXBsYWNlKC8lMDkvZywgJ1xcXFx0JykucmVwbGFjZSgvJTBEL2csICdcXFxccicpKTtcbiAgICAgICAgcmVzdWx0ID0gSlNPTi5wYXJzZSh3ZWJGb3JtUm91dGVQYXJhbXMpO1xuICAgICAgfVxuICAgICAgT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLmZvckVhY2gocHJvcCA9PiB7XG4gICAgICAgIGlmIChwcm9wICE9PSAnV0VCX0ZPUk1fUk9VVEVfUEFSQU1TJykge1xuICAgICAgICAgIHJlc3VsdFtwcm9wXSA9IHF1ZXJ5UGFyYW1zW3Byb3BdO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIHJldHVybiBxdWVyeVBhcmFtcztcbiAgfVxuICBwcml2YXRlIGhpZ2hPcmRlckludm9rZShjYWxsYmFjaykge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBxdWVyeVBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKHRoaXMucGFyYW1zKTtcbiAgICAgICAgY29uc3QgdGFiSWQgPSB0aGlzLmdldFRhYklkKHF1ZXJ5UGFyYW1zKTtcbiAgICAgICAgaWYgKHRhYklkKSB7XG4gICAgICAgICAgY29uc3QgY29udHJvbEV2ZW50ID0gdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5nZXRNZW51U3dpdGNoQ29udHJvbEV2ZW50KCk7XG4gICAgICAgICAgaWYgKGNvbnRyb2xFdmVudCAmJiBpc09ic2VydmFibGUoY29udHJvbEV2ZW50KSkge1xuICAgICAgICAgICAgY29udHJvbEV2ZW50LnN1YnNjcmliZSgoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICBpZiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICBldmVudC5uZXh0KCdvaycpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKGUpOyB9XG4gICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=