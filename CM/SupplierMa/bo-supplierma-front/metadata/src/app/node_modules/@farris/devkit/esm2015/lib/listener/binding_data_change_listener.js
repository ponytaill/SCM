import { Inject, Injectable, Injector } from '@angular/core';
import { BindingData, BindingList, ChangeType } from '../binding-data/index';
import { ChangeListener } from './change_listener';
import { Expression } from '../expression/index';
import { NAMESPACE } from '../frame/index';
import { Repository } from '../repository/index';
const EventType = Expression.EventType;
/**
 * 监听bindingList变更
 * @description 主要用于监听行切换等事件
 */
class BindingDataChangeListener extends ChangeListener {
    constructor(injector, bindingData, namespace) {
        super();
        this.injector = injector;
        this.bindingData = bindingData;
        this.namespace = namespace;
        this.repository = null;
        this.repository = this.injector.get(Repository, null);
        this.registerEvent();
    }
    /**
     * 注册值变化事件
     */
    registerEvent() {
        if (this.bindingData && this.bindingData.changes && typeof this.bindingData.changes.subscribe === 'function') {
            this.bindingData.changes.subscribe((change) => {
                if ((change.type === ChangeType.Append && change.isCloned !== true) || change.type === ChangeType.ValueChanged || change.type === ChangeType.Remove || change.type === ChangeType.Load || change.type === ChangeType.SelectionChanged) {
                    let eventType = null;
                    if (change.type === ChangeType.Append) {
                        eventType = EventType.Append;
                    }
                    else if (change.type === ChangeType.ValueChanged) {
                        eventType = EventType.ValueChanged;
                    }
                    else if (change.type === ChangeType.Remove) {
                        eventType = EventType.Remove;
                    }
                    else if (change.type === ChangeType.Load) {
                        // 主表新增
                        if (change.create === true) {
                            eventType = EventType.Append;
                        }
                        else {
                            eventType = EventType.Load;
                        }
                    }
                    else if (change.type === ChangeType.SelectionChanged) {
                        eventType = EventType.SelectionChanged;
                    }
                    const path = this.buildEventPath(change);
                    const modification = {
                        ns: this.namespace,
                        path: path,
                        type: eventType,
                        source: Expression.EventSource.BindingData,
                        value: change.value,
                        id: change.id
                    };
                    // console.log("BindingDataChangeListener", modification);
                    this.subject.next(modification);
                }
            });
        }
    }
    buildEventPath(change) {
        const path = change.path;
        const paths = [];
        // if (!path || path.length < 1) {
        //   return paths;
        // }
        const primaryValue = this.bindingData.list.currentItem.primaryKeyValue;
        if (primaryValue) {
            if (!(change.type === ChangeType.Load && change.path.length === 0)) {
                paths.push(`${this.bindingData.list.primaryKey}:${primaryValue}`);
            }
        }
        const currentPath = [];
        for (let index = 0; index < path.length; index++) {
            const propertyName = path[index];
            currentPath.push(propertyName);
            const item = this.bindingData.getValue(currentPath);
            paths.push(propertyName);
            if (item instanceof BindingList) {
                if (currentPath.length < path.length) {
                    const bindingList = item;
                    let currentId = bindingList.currentItem.primaryKeyValue;
                    if (index === path.length - 2 && change.id) {
                        currentId = change.id;
                    }
                    paths.push(`${this.bindingData.list.primaryKey}:${currentId}`);
                }
            }
        }
        return paths;
    }
}
BindingDataChangeListener.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BindingDataChangeListener.ctorParameters = () => [
    { type: Injector },
    { type: BindingData },
    { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] }
];
export { BindingDataChangeListener };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX2NoYW5nZV9saXN0ZW5lci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2xpc3RlbmVyL2JpbmRpbmdfZGF0YV9jaGFuZ2VfbGlzdGVuZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFVLFVBQVUsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUdqRCxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDO0FBQ3ZDOzs7R0FHRztBQUNILE1BQ00seUJBQTBCLFNBQVEsY0FBYztJQUVwRCxZQUFvQixRQUFrQixFQUFVLFdBQXdCLEVBQTZCLFNBQVM7UUFDNUcsS0FBSyxFQUFFLENBQUM7UUFEVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFBNkIsY0FBUyxHQUFULFNBQVMsQ0FBQTtRQUR0RyxlQUFVLEdBQW9CLElBQUksQ0FBQztRQUd6QyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssYUFBYTtRQUNuQixJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdB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ZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBCaW5kaW5nTGlzdCwgQ2hhbmdlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnLi4vYmluZGluZy1kYXRhL2luZGV4JztcclxuaW1wb3J0IHsgQ2hhbmdlTGlzdGVuZXIgfSBmcm9tICcuL2NoYW5nZV9saXN0ZW5lcic7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcclxuaW1wb3J0IHsgTkFNRVNQQUNFIH0gZnJvbSAnLi4vZnJhbWUvaW5kZXgnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yeS9pbmRleCc7XHJcblxyXG50eXBlIEV2ZW50QXJncyA9IEV4cHJlc3Npb24uRXZlbnRBcmdzO1xyXG5jb25zdCBFdmVudFR5cGUgPSBFeHByZXNzaW9uLkV2ZW50VHlwZTtcclxuLyoqXHJcbiAqIOebkeWQrGJpbmRpbmdMaXN05Y+Y5pu0XHJcbiAqIEBkZXNjcmlwdGlvbiDkuLvopoHnlKjkuo7nm5HlkKzooYzliIfmjaLnrYnkuovku7ZcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgQmluZGluZ0RhdGFDaGFuZ2VMaXN0ZW5lciBleHRlbmRzIENoYW5nZUxpc3RlbmVyIHtcclxuICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PiA9IG51bGw7XHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLCBASW5qZWN0KE5BTUVTUEFDRSkgcHJpdmF0ZSBuYW1lc3BhY2UpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICB0aGlzLnJlcG9zaXRvcnkgPSB0aGlzLmluamVjdG9yLmdldChSZXBvc2l0b3J5LCBudWxsKTtcclxuICAgIHRoaXMucmVnaXN0ZXJFdmVudCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5rOo5YaM5YC85Y+Y5YyW5LqL5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZWdpc3RlckV2ZW50KCkge1xyXG4gICAgaWYgKHRoaXMuYmluZGluZ0RhdGEgJiYgdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzICYmIHR5cGVvZiB0aGlzLmJpbmRpbmdEYXRhLmNoYW5nZXMuc3Vic2NyaWJlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgICAgaWYgKChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5BcHBlbmQgJiYgY2hhbmdlLmlzQ2xvbmVkICE9PSB0cnVlKSB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUmVtb3ZlIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCkge1xyXG4gICAgICAgICAgbGV0IGV2ZW50VHlwZSA9IG51bGw7XHJcbiAgICAgICAgICBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuQXBwZW5kKSB7XHJcbiAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5BcHBlbmQ7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICBldmVudFR5cGUgPSBFdmVudFR5cGUuVmFsdWVDaGFuZ2VkO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5SZW1vdmUpIHtcclxuICAgICAgICAgICAgZXZlbnRUeXBlID0gRXZlbnRUeXBlLlJlbW92ZTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCkge1xyXG4gICAgICAgICAgICAvLyDkuLvooajmlrDlop5cclxuICAgICAgICAgICAgaWYgKGNoYW5nZS5jcmVhdGUgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICBldmVudFR5cGUgPSBFdmVudFR5cGUuQXBwZW5kO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5Mb2FkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlNlbGVjdGlvbkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgZXZlbnRUeXBlID0gRXZlbnRUeXBlLlNlbGVjdGlvbkNoYW5nZWRcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmJ1aWxkRXZlbnRQYXRoKGNoYW5nZSk7XHJcbiAgICAgICAgICBjb25zdCBtb2RpZmljYXRpb246IEV2ZW50QXJncyA9IHtcclxuICAgICAgICAgICAgbnM6IHRoaXMubmFtZXNwYWNlLFxyXG4gICAgICAgICAgICBwYXRoOiBwYXRoLFxyXG4gICAgICAgICAgICB0eXBlOiBldmVudFR5cGUsXHJcbiAgICAgICAgICAgIHNvdXJjZTogRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5CaW5kaW5nRGF0YSxcclxuICAgICAgICAgICAgdmFsdWU6IGNoYW5nZS52YWx1ZSxcclxuICAgICAgICAgICAgaWQ6IGNoYW5nZS5pZFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwiQmluZGluZ0RhdGFDaGFuZ2VMaXN0ZW5lclwiLCBtb2RpZmljYXRpb24pO1xyXG4gICAgICAgICAgdGhpcy5zdWJqZWN0Lm5leHQobW9kaWZpY2F0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGJ1aWxkRXZlbnRQYXRoKGNoYW5nZTogQ2hhbmdlKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcGF0aCA9IGNoYW5nZS5wYXRoO1xyXG4gICAgY29uc3QgcGF0aHMgPSBbXTtcclxuICAgIC8vIGlmICghcGF0aCB8fCBwYXRoLmxlbmd0aCA8IDEpIHtcclxuICAgIC8vICAgcmV0dXJuIHBhdGhzO1xyXG4gICAgLy8gfVxyXG4gICAgY29uc3QgcHJpbWFyeVZhbHVlID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZTtcclxuICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcclxuICAgICAgaWYgKCEoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCAmJiBjaGFuZ2UucGF0aC5sZW5ndGggPT09IDApKSB7XHJcbiAgICAgICAgcGF0aHMucHVzaChgJHt0aGlzLmJpbmRpbmdEYXRhLmxpc3QucHJpbWFyeUtleX06JHtwcmltYXJ5VmFsdWV9YCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IGN1cnJlbnRQYXRoID0gW107XHJcbiAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgcGF0aC5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aFtpbmRleF07XHJcbiAgICAgIGN1cnJlbnRQYXRoLnB1c2gocHJvcGVydHlOYW1lKTtcclxuICAgICAgY29uc3QgaXRlbSA9IHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoY3VycmVudFBhdGgpO1xyXG4gICAgICBwYXRocy5wdXNoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgIGlmIChpdGVtIGluc3RhbmNlb2YgQmluZGluZ0xpc3QpIHtcclxuICAgICAgICBpZiAoY3VycmVudFBhdGgubGVuZ3RoIDwgcGF0aC5sZW5ndGgpIHtcclxuICAgICAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gaXRlbSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgICAgIGxldCBjdXJyZW50SWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWU7XHJcbiAgICAgICAgICBpZiAoaW5kZXggPT09IHBhdGgubGVuZ3RoIC0gMiAmJiBjaGFuZ2UuaWQpIHtcclxuICAgICAgICAgICAgY3VycmVudElkID0gY2hhbmdlLmlkO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGF0aHMucHVzaChgJHt0aGlzLmJpbmRpbmdEYXRhLmxpc3QucHJpbWFyeUtleX06JHtjdXJyZW50SWR9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG59XHJcbmV4cG9ydCB7IEJpbmRpbmdEYXRhQ2hhbmdlTGlzdGVuZXIgfTtcclxuIl19