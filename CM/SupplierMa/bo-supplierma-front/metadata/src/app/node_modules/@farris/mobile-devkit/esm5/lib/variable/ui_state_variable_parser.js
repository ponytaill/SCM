/**
 * session变量解析
 * @author Witt <jiwt@inspur.com>
 */
import * as tslib_1 from "tslib";
import { ParseUtil } from './parse_util';
/**
 * 数据变量解析
 */
var UIStateVariableParser = /** @class */ (function () {
    function UIStateVariableParser() {
    }
    /**
     * 解析变量
     * @param expression 形如：/frameId/stateName
     * @param context 上下文
     */
    UIStateVariableParser.prototype.parse = function (expression, context) {
        var _this = this;
        var appContext = ParseUtil.getAppContext(context);
        var paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === "{UISTATE~" + paths[0] + "}") {
            return this.getUIState(paths[0], appContext);
        }
        // 2、其他情况：字符串替换
        paths.forEach(function (path) {
            var searchValue = "{UISTATE~" + path + "}";
            var replaceValue = _this.getUIState(path, appContext);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    };
    /**
     * 提取路径
     * 变量格式：{}
     */
    UIStateVariableParser.prototype.extractPaths = function (expression) {
        var paths = [];
        // 查找所有的uiState变量字符串
        var UI_STATE_PATTERN_G = /\{UISTATE~(\S+?)\}/g;
        var uiStateVariables = expression.match(UI_STATE_PATTERN_G);
        if (uiStateVariables === null) {
            return [];
        }
        // 提取后边的路径
        var UI_STATE_PATTERN = /\{UISTATE~(\S+?)\}/;
        uiStateVariables.forEach(function (uiStateVariable) {
            var pathMatches = uiStateVariable.match(UI_STATE_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    };
    /**
     * 获取UIState
     */
    UIStateVariableParser.prototype.getUIState = function (path, appContext) {
        var parts = path.split('/').filter(function (part) {
            return part !== '';
        });
        var _a = tslib_1.__read(parts, 2), frameId = _a[0], stateName = _a[1];
        var frameContext = appContext.viewModelContextManager.getContextById(frameId);
        var state = frameContext.uiState[stateName];
        if (state && state.constructor.toString().startsWith('function Date()')) {
            return this.formatDate(state);
        }
        for (var i = 2; i < parts.length; i++) {
            state = state[parts[i]];
            // 复杂对象一层层查找下去，如果某一层不存在，结果可以是undefined，但是要直接返回undefined避免报错。
            if (!state) {
                return state;
            }
        }
        return state;
    };
    /**
     * @todo：待删除
     */
    UIStateVariableParser.prototype.formatDate = function (value) {
        if (!value) {
            return '';
        }
        // 年
        var year = value.getFullYear();
        // 月
        var month = (value.getMonth() + 1).toString();
        month = month.length === 1 ? ('0' + month) : month;
        // 日
        var day = value.getDate().toString();
        day = day.length === 1 ? ('0' + day) : day;
        return year + "-" + month + "-" + day;
    };
    return UIStateVariableParser;
}());
export { UIStateVariableParser };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWlfc3RhdGVfdmFyaWFibGVfcGFyc2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3ZhcmlhYmxlL3VpX3N0YXRlX3ZhcmlhYmxlX3BhcnNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O0dBR0c7O0FBSUgsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUV6Qzs7R0FFRztBQUNIO0lBQUE7SUFpR0EsQ0FBQztJQS9GQzs7OztPQUlHO0lBQ0kscUNBQUssR0FBWixVQUFhLFVBQWtCLEVBQUUsT0FBWTtRQUE3QyxpQkFrQkM7UUFoQkMsSUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwRCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRTVDLGdCQUFnQjtRQUNoQixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxJQUFJLFVBQVUsS0FBSyxjQUFZLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBRyxFQUFFO1lBQ2hFLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsVUFBVSxDQUFDLENBQUM7U0FDOUM7UUFFRCxlQUFlO1FBQ2YsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFBLElBQUk7WUFDaEIsSUFBTSxXQUFXLEdBQUcsY0FBWSxJQUFJLE1BQUcsQ0FBQztZQUN4QyxJQUFNLFlBQVksR0FBRyxLQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztZQUN2RCxVQUFVLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDN0QsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssNENBQVksR0FB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LENBQUM7SUFDbkMsQ0FBQztJQUNILDRCQUFDO0FBQUQsQ0FBQyxBQWpHRCxJQWlHQztBQUVELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIHNlc3Npb27lj5jph4/op6PmnpBcclxuICogQGF1dGhvciBXaXR0IDxqaXd0QGluc3B1ci5jb20+XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgVmFyaWFibGVQYXJzZXIgfSBmcm9tICcuL3ZhcmlhYmxlX3BhcnNlcic7XHJcbmltcG9ydCB7IEFwcENvbnRleHQgfSBmcm9tICcuLi9hcHAvaW5kZXgnO1xyXG5pbXBvcnQgeyBQYXJzZVV0aWwgfSBmcm9tICcuL3BhcnNlX3V0aWwnO1xyXG5cclxuLyoqXHJcbiAqIOaVsOaNruWPmOmHj+ino+aekFxyXG4gKi9cclxuY2xhc3MgVUlTdGF0ZVZhcmlhYmxlUGFyc2VyIGltcGxlbWVudHMgVmFyaWFibGVQYXJzZXIge1xyXG5cclxuICAvKipcclxuICAgKiDop6PmnpDlj5jph49cclxuICAgKiBAcGFyYW0gZXhwcmVzc2lvbiDlvaLlpoLvvJovZnJhbWVJZC9zdGF0ZU5hbWVcclxuICAgKiBAcGFyYW0gY29udGV4dCDkuIrkuIvmlodcclxuICAgKi9cclxuICBwdWJsaWMgcGFyc2UoZXhwcmVzc2lvbjogc3RyaW5nLCBjb250ZXh0OiBhbnkpOiBhbnkge1xyXG5cclxuICAgIGNvbnN0IGFwcENvbnRleHQgPSBQYXJzZVV0aWwuZ2V0QXBwQ29udGV4dChjb250ZXh0KTtcclxuICAgIGNvbnN0IHBhdGhzID0gdGhpcy5leHRyYWN0UGF0aHMoZXhwcmVzc2lvbik7XHJcblxyXG4gICAgLy8gMeOAgeWNleS4queahOihqOi+vuW8j++8muebtOaOpeaxguWAvFxyXG4gICAgaWYgKHBhdGhzLmxlbmd0aCA9PT0gMSAmJiBleHByZXNzaW9uID09PSBge1VJU1RBVEV+JHtwYXRoc1swXX19YCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5nZXRVSVN0YXRlKHBhdGhzWzBdLCBhcHBDb250ZXh0KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAy44CB5YW25LuW5oOF5Ya177ya5a2X56ym5Liy5pu/5o2iXHJcbiAgICBwYXRocy5mb3JFYWNoKHBhdGggPT4ge1xyXG4gICAgICBjb25zdCBzZWFyY2hWYWx1ZSA9IGB7VUlTVEFURX4ke3BhdGh9fWA7XHJcbiAgICAgIGNvbnN0IHJlcGxhY2VWYWx1ZSA9IHRoaXMuZ2V0VUlTdGF0ZShwYXRoLCBhcHBDb250ZXh0KTtcclxuICAgICAgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShzZWFyY2hWYWx1ZSwgcmVwbGFjZVZhbHVlKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBleHByZXNzaW9uO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5o+Q5Y+W6Lev5b6EXHJcbiAgICog5Y+Y6YeP5qC85byP77yae31cclxuICAgKi9cclxuICBwcml2YXRlIGV4dHJhY3RQYXRocyhleHByZXNzaW9uOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwYXRoczogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgICAvLyDmn6Xmib7miYDmnInnmoR1aVN0YXRl5Y+Y6YeP5a2X56ym5LiyXHJcbiAgICBjb25zdCBVSV9TVEFURV9QQVRURVJOX0cgPSAvXFx7VUlTVEFURX4oXFxTKz8pXFx9L2c7XHJcbiAgICBjb25zdCB1aVN0YXRlVmFyaWFibGVzID0gZXhwcmVzc2lvbi5tYXRjaChVSV9TVEFURV9QQVRURVJOX0cpO1xyXG4gICAgaWYgKHVpU3RhdGVWYXJpYWJsZXMgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOaPkOWPluWQjui+ueeahOi3r+W+hFxyXG4gICAgY29uc3QgVUlfU1RBVEVfUEFUVEVSTiA9IC9cXHtVSVNUQVRFfihcXFMrPylcXH0vO1xyXG4gICAgdWlTdGF0ZVZhcmlhYmxlcy5mb3JFYWNoKCh1aVN0YXRlVmFyaWFibGU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBwYXRoTWF0Y2hlcyA9IHVpU3RhdGVWYXJpYWJsZS5tYXRjaChVSV9TVEFURV9QQVRURVJOKTtcclxuICAgICAgaWYgKHBhdGhNYXRjaGVzICE9IG51bGwgJiYgcGF0aE1hdGNoZXMubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgcGF0aHMucHVzaChwYXRoTWF0Y2hlc1sxXSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBwYXRocztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPllVJU3RhdGVcclxuICAgKi9cclxuICBwcml2YXRlIGdldFVJU3RhdGUocGF0aDogc3RyaW5nLCBhcHBDb250ZXh0OiBBcHBDb250ZXh0KSB7XHJcbiAgICBjb25zdCBwYXJ0cyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIoKHBhcnQ6IHN0cmluZykgPT4ge1xyXG4gICAgICByZXR1cm4gcGFydCAhPT0gJyc7XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IFtmcmFtZUlkLCBzdGF0ZU5hbWVdID0gcGFydHM7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBhcHBDb250ZXh0LnZpZXdNb2RlbENvbnRleHRNYW5hZ2VyLmdldENvbnRleHRCeUlkKGZyYW1lSWQpO1xyXG4gICAgbGV0IHN0YXRlID0gZnJhbWVDb250ZXh0LnVpU3RhdGVbc3RhdGVOYW1lXTtcclxuICAgIGlmIChzdGF0ZSAmJiBzdGF0ZS5jb25zdHJ1Y3Rvci50b1N0cmluZygpLnN0YXJ0c1dpdGgoJ2Z1bmN0aW9uIERhdGUoKScpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdERhdGUoc3RhdGUpO1xyXG4gICAgfVxyXG4gICAgZm9yIChsZXQgaSA9IDI7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICBzdGF0ZSA9IHN0YXRlW3BhcnRzW2ldXTtcclxuXHJcbiAgICAgIC8vIOWkjeadguWvueixoeS4gOWxguWxguafpeaJvuS4i+WOu++8jOWmguaenOafkOS4gOWxguS4jeWtmOWcqO+8jOe7k+aenOWPr+S7peaYr3VuZGVmaW5lZO+8jOS9huaYr+imgeebtOaOpei/lOWbnnVuZGVmaW5lZOmBv+WFjeaKpemUmeOAglxyXG4gICAgICBpZiAoIXN0YXRlKSB7XHJcbiAgICAgICAgcmV0dXJuIHN0YXRlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3RhdGU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBAdG9kb++8muW+heWIoOmZpFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZm9ybWF0RGF0ZSh2YWx1ZTogRGF0ZSk6IHN0cmluZyB7XHJcbiAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICAvLyDlubRcclxuICAgIGNvbnN0IHllYXIgPSB2YWx1ZS5nZXRGdWxsWWVhcigpO1xyXG5cclxuICAgIC8vIOaciFxyXG4gICAgbGV0IG1vbnRoID0gKHZhbHVlLmdldE1vbnRoKCkgKyAxKS50b1N0cmluZygpO1xyXG4gICAgbW9udGggPSBtb250aC5sZW5ndGggPT09IDEgPyAoJzAnICsgbW9udGgpIDogbW9udGg7XHJcblxyXG4gICAgLy8g5pelXHJcbiAgICBsZXQgZGF5ID0gdmFsdWUuZ2V0RGF0ZSgpLnRvU3RyaW5nKCk7XHJcbiAgICBkYXkgPSBkYXkubGVuZ3RoID09PSAxID8gKCcwJyArIGRheSkgOiBkYXk7XHJcbiAgICByZXR1cm4gYCR7eWVhcn0tJHttb250aH0tJHtkYXl9YDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IFVJU3RhdGVWYXJpYWJsZVBhcnNlciB9O1xyXG4iXX0=