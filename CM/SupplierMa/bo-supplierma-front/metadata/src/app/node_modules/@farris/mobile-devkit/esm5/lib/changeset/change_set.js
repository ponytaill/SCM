/*
 * @Author: Lucus, Witt
 * @Date: 2018-10-30 15:53:59
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-08 17:25:08
 */
import { ModifyType } from './types';
function isEqual(value, other) {
    return JSON.stringify(value) === JSON.stringify(other);
}
/**
 * 实体数据变更集
 */
var ChangeSet = /** @class */ (function () {
    function ChangeSet() {
        /**
         * 变更集合
         */
        this.modifications = [];
    }
    Object.defineProperty(ChangeSet.prototype, "changes", {
        /**
         *  获取所有的变更记录
         */
        get: function () {
            return this.modifications;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 将变更集添加到集合中
     * ### 使用示例
     * ```
     * const changeSet = new ChangeSet();
     * const modify = new Modification('newValue', ModifyType.ValueChange, [1, 'title'], 'oldValue');
     * changeSet.append(modify)
     * ```
     * @param changeItem 变更数据
     */
    ChangeSet.prototype.append = function (modification) {
        switch (modification.type) {
            case ModifyType.ValueChange:
                this.appendValueChangeModification(modification);
                break;
            case ModifyType.Add:
                this.appendAddModification(modification);
                break;
            case ModifyType.Remove:
                this.appendRemoveModification(modification);
                break;
            case ModifyType.Load:
                break;
            default:
                throw new Error('不支持此类型的变更');
        }
    };
    /**
     * 添加值变化变更
     */
    ChangeSet.prototype.appendValueChangeModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findModifyItemsPath(modification.path);
        if (existedModification) {
            // 如果存在相同路径的ValueChange类型的变更集，则更新值；
            existedModification.value = value;
        }
        else {
            var existedAddModification = this.findNewAddItemsPath(modification.path);
            if (existedAddModification) {
                // @todo：
                // 1、此处逻辑有问题，value是个字符串，不能直接assign；
                // 2、之所以没有出现问题，是因为都是服务器端新增，新增后，客户端清空了所有变更。
                // 如果存在涵盖该ValueChange变更的Add变更，则更新Add变更对应的数据；
                existedAddModification.value = Object.assign({}, existedAddModification.value, value);
            }
            else {
                // 其他情况，新增一条ValueChange变更。
                this.modifications.push(modification);
            }
        }
    };
    /**
     * 添加新增变更
     */
    ChangeSet.prototype.appendAddModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findNewAddItemsPath(modification.path);
        if (existedModification) {
            // 1、如果已经存在相同路径的Add变更，则合并Value。
            existedModification.value = existedModification.value.concat(value);
        }
        else {
            // 2、如果没有，则新增一条Add变更。
            this.modifications.push(modification);
        }
    };
    /**
     * 添加删除变更
     */
    ChangeSet.prototype.appendRemoveModification = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        // 1、存在相同path的新增变更，移除新增变更，不需要添加删除变更；
        // @todo：待重构（1、只考虑了主从情况，2、临时用多重循环实现）
        this.modifications.forEach(function (addModification) {
            // 只处理新增变更
            if (addModification.type !== ModifyType.Add) {
                return;
            }
            // @todo 只考虑主从结构，再深的层次暂不考虑
            if (isEqual(addModification.path, path) === false) {
                return;
            }
            // 遍历新增新增变更的value（value是个数组），移除相匹配的新增删除
            addModification.value = addModification.value.filter(function (addDataItem) {
                return addDataItem[primaryKey] !== primaryKeyValue;
            });
        });
        // 2、移除对应的修改变更
        var fullRemovePath = path.concat(primaryKey + ":" + primaryKeyValue);
        this.modifications = this.modifications.filter(function (valueModification) {
            if (valueModification.type !== ModifyType.ValueChange) {
                return true;
            }
            var valueChangePath = Array.from(valueModification.path);
            valueChangePath.pop();
            // 路径相同进行移除
            var isToRemove = isEqual(valueChangePath, fullRemovePath);
            return !isToRemove;
        });
        // 先删除下级删除变更，再插入
        // 主要针对从从表删除之后，又删除子表时，根实体上还存在从从表删除变更的场景
        this.removeDescendantRemoveModifications(modification);
        this.modifications.push(modification);
    };
    /**
     * 清空变更集合
     */
    ChangeSet.prototype.clear = function () {
        this.modifications = [];
    };
    /**
     * 根据path获取Add类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findNewAddItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && value.type === ModifyType.Add;
        });
    };
    /**
     * 根据path获取ValueChange类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findModifyItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && value.type === ModifyType.ValueChange;
        });
    };
    /**
     * 删除后代（包括自己）所有的删除变更
     * @todo：临时做一个最小化修改
     */
    ChangeSet.prototype.removeDescendantRemoveModifications = function (parentRemoveModification) {
        var _this = this;
        var parentPathWithId = this.createRemovePathWithId(parentRemoveModification);
        // 删除后代修改变更
        this.modifications = this.modifications.filter(function (modification) {
            if (modification.type !== ModifyType.Remove) {
                return true;
            }
            var descendantPathWithId = _this.createRemovePathWithId(modification);
            var isDescendant = _this.isDescendantPath(parentPathWithId, descendantPathWithId);
            return !isDescendant;
        });
    };
    /**
     * 获取删除路径的完整格式
     * @summary
     * 1、目前删除变更的路径标记到父集合；
     * 2、为了方便比较，将被删除的数据id加入到路径中
     */
    ChangeSet.prototype.createRemovePathWithId = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        var pathWithId = path.concat([primaryKey + ":" + primaryKeyValue]);
        return pathWithId;
    };
    /**
     * 判断是否是后代节点路径
     * @param parentPath 父节点路径
     * @param descendantPath 后代节点
     */
    ChangeSet.prototype.isDescendantPath = function (parentPath, descendantPath) {
        if (parentPath.length > descendantPath.length) {
            return false;
        }
        var isDescendantPath = true;
        parentPath.forEach(function (parentPathItem, parentPathItemIndex) {
            if (parentPathItem !== descendantPath[parentPathItemIndex]) {
                isDescendantPath = false;
                return;
            }
        });
        return isDescendantPath;
    };
    return ChangeSet;
}());
export { ChangeSet };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlX3NldC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jaGFuZ2VzZXQvY2hhbmdlX3NldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUVILE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRW5ELFNBQVMsT0FBTyxDQUFDLEtBQVUsRUFBRSxLQUFVO0lBQ3JDLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBTSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzFELENBQUM7QUFFRDs7R0FFRztBQUNIO0lBQUE7UUFFRTs7V0FFRztRQUNPLGtCQUFhLEdBQW1CLEVBQUUsQ0FBQztJQXNOL0MsQ0FBQztJQWpOQyxzQkFBVyw4QkFBTztRQUhsQjs7V0FFRzthQUNIO1lBQ0ksT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBQzlCLENBQUM7OztPQUFBO0lBRUQ7Ozs7Ozs7OztPQVNHO0lBQ0ksMEJBQU0sR0FBYixVQUFjLFlBQTBCO1FBQ3RDLFFBQVEsWUFBWSxDQUFDLElBQUksRUFBRTtZQUN6QixLQUFLLFVBQVUsQ0FBQyxXQUFXO2dCQUN6QixJQUFJLENBQUMsNkJBQTZCLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQy9DLE1BQU07WUFDVCxLQUFLLFVBQVUsQ0FBQyxHQUFHO2dCQUNsQixJQUFJLENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQ3ZDLE1BQU07WUFDVixLQUFLLFVBQVUsQ0FBQyxNQUFNO2dCQUNwQixJQUFJLENBQUMsd0JBQXdCLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQzVDLE1BQU07WUFDUixLQUFLLFVBQVUsQ0FBQyxJQUFJO2dCQUNsQixNQUFNO1lBQ1I7Z0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNoQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLGlEQUE2QixHQUFyQyxVQUFzQyxZQUEwQjtRQUM5RCxJQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBRWpDLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RSxJQUFJLG1CQUFtQixFQUFFO1lBRXZCLG1DQUFtQztZQUNuQyxtQkFBbUIsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1NBQ25DO2FBQU07WUFDSCxJQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0UsSUFBSSxzQkFBc0IsRUFBRTtnQkFFMUIsU0FBUztnQkFDVCxtQ0FBbUM7Z0JBQ25DLDBDQUEwQztnQkFDMUMsNENBQTRDO2dCQUM1QyxzQkFBc0IsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsc0JBQXNCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ3ZGO2lCQUFNO2dCQUVMLDBCQUEwQjtnQkFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDdkM7U0FDSjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLHlDQUFxQixHQUE3QixVQUE4QixZQUEwQjtRQUN0RCxJQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBRWpDLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RSxJQUFJLG1CQUFtQixFQUFFO1lBRXZCLCtCQUErQjtZQUMvQixtQkFBbUIsQ0FBQyxLQUFLLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyRTthQUFNO1lBRUwscUJBQXFCO1lBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssNENBQXdCLEdBQWhDLFVBQWlDLFlBQTBCO1FBRXpELElBQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDL0IsSUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEQsSUFBTSxlQUFlLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUV2RCxvQ0FBb0M7UUFDcEMsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsZUFBNkI7WUFFdkQsVUFBVTtZQUNWLElBQUksZUFBZSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUMzQyxPQUFPO2FBQ1I7WUFFRCwwQkFBMEI7WUFDMUIsSUFBSSxPQUFPLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxLQUFLLEVBQUU7Z0JBQ2pELE9BQU87YUFDUjtZQUVELHVDQUF1QztZQUN2QyxlQUFlLENBQUMsS0FBSyxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUMsV0FBZ0I7Z0JBQ3BFLE9BQU8sV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLGVBQWUsQ0FBQztZQUNyRCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsY0FBYztRQUNkLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUksVUFBVSxTQUFJLGVBQWlCLENBQUMsQ0FBQztRQUN2RSxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQUMsaUJBQStCO1lBQzdFLElBQUksaUJBQWlCLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxXQUFXLEVBQUU7Z0JBQ3JELE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxJQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzNELGVBQWUsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUV0QixXQUFXO1lBQ1gsSUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLGVBQWUsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUM1RCxPQUFPLENBQUMsVUFBVSxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxDQUFDO1FBRUgsZ0JBQWdCO1FBQ2hCLHVDQUF1QztRQUN2QyxJQUFJLENBQUMsbUNBQW1DLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVEOztPQUVHO0lBQ0kseUJBQUssR0FBWjtRQUNFLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFHRDs7O09BR0c7SUFDSyx1Q0FBbUIsR0FBM0IsVUFBNEIsSUFBVztRQUNuQyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQUMsS0FBSyxFQUFFLEtBQUs7WUFDeEMsT0FBTyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxHQUFHLENBQUM7UUFDdEUsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssdUNBQW1CLEdBQTNCLFVBQTRCLElBQVc7UUFDckMsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxVQUFDLEtBQUssRUFBRSxLQUFLO1lBQzFDLE9BQU8sT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsV0FBVyxDQUFDO1FBQzVFLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7T0FHRztJQUNLLHVEQUFtQyxHQUEzQyxVQUE0Qyx3QkFBc0M7UUFBbEYsaUJBYUM7UUFYQyxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBRS9FLFdBQVc7UUFDWCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLFVBQUMsWUFBMEI7WUFDeEUsSUFBSSxZQUFZLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxNQUFNLEVBQUU7Z0JBQzNDLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxJQUFNLG9CQUFvQixHQUFHLEtBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN2RSxJQUFNLFlBQVksR0FBSSxLQUFJLENBQUMsZ0JBQWdCLENBQUMsZ0JBQWdCLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztZQUNwRixPQUFPLENBQUMsWUFBWSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssMENBQXNCLEdBQTlCLFVBQStCLFlBQTBCO1FBQ3ZELElBQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDL0IsSUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEQsSUFBTSxlQUFlLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN2RCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUksVUFBVSxTQUFJLGVBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ssb0NBQWdCLEdBQXhCLFVBQXlCLFVBQW9CLEVBQUUsY0FBd0I7UUFDckUsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLGNBQWMsQ0FBQyxNQUFNLEVBQUU7WUFDN0MsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELElBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO1FBQzVCLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBQyxjQUFzQixFQUFFLG1CQUEyQjtZQUNyRSxJQUFJLGNBQWMsS0FBSyxjQUFjLENBQUMsbUJBQW1CLENBQUMsRUFBRTtnQkFDMUQsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDO2dCQUN6QixPQUFPO2FBQ1I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQUVILGdCQUFDO0FBQUQsQ0FBQyxBQTNORCxJQTJOQztBQUVELE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEBBdXRob3I6IEx1Y3VzLCBXaXR0XHJcbiAqIEBEYXRlOiAyMDE4LTEwLTMwIDE1OjUzOjU5XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTgtMTEtMDggMTc6MjU6MDhcclxuICovXHJcblxyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuL3R5cGVzJztcclxuXHJcbmZ1bmN0aW9uIGlzRXF1YWwodmFsdWU6IGFueSwgb3RoZXI6IGFueSkge1xyXG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgPT09ICBKU09OLnN0cmluZ2lmeShvdGhlcik7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlrp7kvZPmlbDmja7lj5jmm7Tpm4ZcclxuICovXHJcbmNsYXNzIENoYW5nZVNldCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPmOabtOmbhuWQiFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBtb2RpZmljYXRpb25zOiBNb2RpZmljYXRpb25bXSA9IFtdO1xyXG5cclxuICAvKipcclxuICAgKiAg6I635Y+W5omA5pyJ55qE5Y+Y5pu06K6w5b2VXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBjaGFuZ2VzKCk6IE1vZGlmaWNhdGlvbltdIHtcclxuICAgICAgcmV0dXJuIHRoaXMubW9kaWZpY2F0aW9ucztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuWPmOabtOmbhua3u+WKoOWIsOmbhuWQiOS4rVxyXG4gICAqICMjIyDkvb/nlKjnpLrkvotcclxuICAgKiBgYGBcclxuICAgKiBjb25zdCBjaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XHJcbiAgICogY29uc3QgbW9kaWZ5ID0gbmV3IE1vZGlmaWNhdGlvbignbmV3VmFsdWUnLCBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlLCBbMSwgJ3RpdGxlJ10sICdvbGRWYWx1ZScpO1xyXG4gICAqIGNoYW5nZVNldC5hcHBlbmQobW9kaWZ5KVxyXG4gICAqIGBgYFxyXG4gICAqIEBwYXJhbSBjaGFuZ2VJdGVtIOWPmOabtOaVsOaNrlxyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmQobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcclxuICAgIHN3aXRjaCAobW9kaWZpY2F0aW9uLnR5cGUpIHtcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlOlxyXG4gICAgICAgIHRoaXMuYXBwZW5kVmFsdWVDaGFuZ2VNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgY2FzZSBNb2RpZnlUeXBlLkFkZDpcclxuICAgICAgICB0aGlzLmFwcGVuZEFkZE1vZGlmaWNhdGlvbihtb2RpZmljYXRpb24pO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgTW9kaWZ5VHlwZS5SZW1vdmU6XHJcbiAgICAgICAgdGhpcy5hcHBlbmRSZW1vdmVNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLkxvYWQ6XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCfkuI3mlK/mjIHmraTnsbvlnovnmoTlj5jmm7QnKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWAvOWPmOWMluWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwZW5kVmFsdWVDaGFuZ2VNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcclxuICAgIGNvbnN0IHZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xyXG5cclxuICAgIGNvbnN0IGV4aXN0ZWRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmRNb2RpZnlJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xyXG4gICAgaWYgKGV4aXN0ZWRNb2RpZmljYXRpb24pIHtcclxuXHJcbiAgICAgIC8vIOWmguaenOWtmOWcqOebuOWQjOi3r+W+hOeahFZhbHVlQ2hhbmdl57G75Z6L55qE5Y+Y5pu06ZuG77yM5YiZ5pu05paw5YC877ybXHJcbiAgICAgIGV4aXN0ZWRNb2RpZmljYXRpb24udmFsdWUgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgZXhpc3RlZEFkZE1vZGlmaWNhdGlvbiA9IHRoaXMuZmluZE5ld0FkZEl0ZW1zUGF0aChtb2RpZmljYXRpb24ucGF0aCk7XHJcbiAgICAgICAgaWYgKGV4aXN0ZWRBZGRNb2RpZmljYXRpb24pIHtcclxuXHJcbiAgICAgICAgICAvLyBAdG9kb++8mlxyXG4gICAgICAgICAgLy8gMeOAgeatpOWkhOmAu+i+keaciemXrumimO+8jHZhbHVl5piv5Liq5a2X56ym5Liy77yM5LiN6IO955u05o6lYXNzaWdu77ybXHJcbiAgICAgICAgICAvLyAy44CB5LmL5omA5Lul5rKh5pyJ5Ye6546w6Zeu6aKY77yM5piv5Zug5Li66YO95piv5pyN5Yqh5Zmo56uv5paw5aKe77yM5paw5aKe5ZCO77yM5a6i5oi356uv5riF56m65LqG5omA5pyJ5Y+Y5pu044CCXHJcbiAgICAgICAgICAvLyDlpoLmnpzlrZjlnKjmtrXnm5bor6VWYWx1ZUNoYW5nZeWPmOabtOeahEFkZOWPmOabtO+8jOWImeabtOaWsEFkZOWPmOabtOWvueW6lOeahOaVsOaNru+8m1xyXG4gICAgICAgICAgZXhpc3RlZEFkZE1vZGlmaWNhdGlvbi52YWx1ZSA9IE9iamVjdC5hc3NpZ24oe30sIGV4aXN0ZWRBZGRNb2RpZmljYXRpb24udmFsdWUsIHZhbHVlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAgIC8vIOWFtuS7luaDheWGte+8jOaWsOWinuS4gOadoVZhbHVlQ2hhbmdl5Y+Y5pu044CCXHJcbiAgICAgICAgICB0aGlzLm1vZGlmaWNhdGlvbnMucHVzaChtb2RpZmljYXRpb24pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOaWsOWinuWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwZW5kQWRkTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XHJcbiAgICBjb25zdCB2YWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZTtcclxuXHJcbiAgICBjb25zdCBleGlzdGVkTW9kaWZpY2F0aW9uID0gdGhpcy5maW5kTmV3QWRkSXRlbXNQYXRoKG1vZGlmaWNhdGlvbi5wYXRoKTtcclxuICAgIGlmIChleGlzdGVkTW9kaWZpY2F0aW9uKSB7XHJcblxyXG4gICAgICAvLyAx44CB5aaC5p6c5bey57uP5a2Y5Zyo55u45ZCM6Lev5b6E55qEQWRk5Y+Y5pu077yM5YiZ5ZCI5bm2VmFsdWXjgIJcclxuICAgICAgZXhpc3RlZE1vZGlmaWNhdGlvbi52YWx1ZSA9IGV4aXN0ZWRNb2RpZmljYXRpb24udmFsdWUuY29uY2F0KHZhbHVlKTtcclxuICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAvLyAy44CB5aaC5p6c5rKh5pyJ77yM5YiZ5paw5aKe5LiA5p2hQWRk5Y+Y5pu044CCXHJcbiAgICAgIHRoaXMubW9kaWZpY2F0aW9ucy5wdXNoKG1vZGlmaWNhdGlvbik7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDliKDpmaTlj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIGFwcGVuZFJlbW92ZU1vZGlmaWNhdGlvbihtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xyXG5cclxuICAgIGNvbnN0IHBhdGggPSBtb2RpZmljYXRpb24ucGF0aDtcclxuICAgIGNvbnN0IHByaW1hcnlLZXkgPSBPYmplY3Qua2V5cyhtb2RpZmljYXRpb24udmFsdWUpWzBdO1xyXG4gICAgY29uc3QgcHJpbWFyeUtleVZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlW3ByaW1hcnlLZXldO1xyXG5cclxuICAgIC8vIDHjgIHlrZjlnKjnm7jlkIxwYXRo55qE5paw5aKe5Y+Y5pu077yM56e76Zmk5paw5aKe5Y+Y5pu077yM5LiN6ZyA6KaB5re75Yqg5Yig6Zmk5Y+Y5pu077ybXHJcbiAgICAvLyBAdG9kb++8muW+hemHjeaehO+8iDHjgIHlj6rogIPomZHkuobkuLvku47mg4XlhrXvvIwy44CB5Li05pe255So5aSa6YeN5b6q546v5a6e546w77yJXHJcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMuZm9yRWFjaCgoYWRkTW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcclxuXHJcbiAgICAgIC8vIOWPquWkhOeQhuaWsOWinuWPmOabtFxyXG4gICAgICBpZiAoYWRkTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuQWRkKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBAdG9kbyDlj6rogIPomZHkuLvku47nu5PmnoTvvIzlho3mt7HnmoTlsYLmrKHmmoLkuI3ogIPomZFcclxuICAgICAgaWYgKGlzRXF1YWwoYWRkTW9kaWZpY2F0aW9uLnBhdGgsIHBhdGgpID09PSBmYWxzZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g6YGN5Y6G5paw5aKe5paw5aKe5Y+Y5pu055qEdmFsdWXvvIh2YWx1ZeaYr+S4quaVsOe7hO+8ie+8jOenu+mZpOebuOWMuemFjeeahOaWsOWinuWIoOmZpFxyXG4gICAgICBhZGRNb2RpZmljYXRpb24udmFsdWUgPSBhZGRNb2RpZmljYXRpb24udmFsdWUuZmlsdGVyKChhZGREYXRhSXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGFkZERhdGFJdGVtW3ByaW1hcnlLZXldICE9PSBwcmltYXJ5S2V5VmFsdWU7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gMuOAgeenu+mZpOWvueW6lOeahOS/ruaUueWPmOabtFxyXG4gICAgY29uc3QgZnVsbFJlbW92ZVBhdGggPSBwYXRoLmNvbmNhdChgJHtwcmltYXJ5S2V5fToke3ByaW1hcnlLZXlWYWx1ZX1gKTtcclxuICAgIHRoaXMubW9kaWZpY2F0aW9ucyA9IHRoaXMubW9kaWZpY2F0aW9ucy5maWx0ZXIoKHZhbHVlTW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgaWYgKHZhbHVlTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5nZVBhdGggPSBBcnJheS5mcm9tKHZhbHVlTW9kaWZpY2F0aW9uLnBhdGgpO1xyXG4gICAgICB2YWx1ZUNoYW5nZVBhdGgucG9wKCk7XHJcblxyXG4gICAgICAvLyDot6/lvoTnm7jlkIzov5vooYznp7vpmaRcclxuICAgICAgY29uc3QgaXNUb1JlbW92ZSA9IGlzRXF1YWwodmFsdWVDaGFuZ2VQYXRoLCBmdWxsUmVtb3ZlUGF0aCk7XHJcbiAgICAgIHJldHVybiAhaXNUb1JlbW92ZTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOWFiOWIoOmZpOS4i+e6p+WIoOmZpOWPmOabtO+8jOWGjeaPkuWFpVxyXG4gICAgLy8g5Li76KaB6ZKI5a+55LuO5LuO6KGo5Yig6Zmk5LmL5ZCO77yM5Y+I5Yig6Zmk5a2Q6KGo5pe277yM5qC55a6e5L2T5LiK6L+Y5a2Y5Zyo5LuO5LuO6KGo5Yig6Zmk5Y+Y5pu055qE5Zy65pmvXHJcbiAgICB0aGlzLnJlbW92ZURlc2NlbmRhbnRSZW1vdmVNb2RpZmljYXRpb25zKG1vZGlmaWNhdGlvbik7XHJcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMucHVzaChtb2RpZmljYXRpb24pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF56m65Y+Y5pu06ZuG5ZCIXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyKCkge1xyXG4gICAgdGhpcy5tb2RpZmljYXRpb25zID0gW107XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPlkFkZOexu+Wei+eahOWPmOabtOiusOW9lVxyXG4gICAqIEBwYXJhbSBwYXRoIOWPmOabtOi3r+W+hFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZmluZE5ld0FkZEl0ZW1zUGF0aChwYXRoOiBhbnlbXSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5tb2RpZmljYXRpb25zLmZpbmQoKHZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIGlzRXF1YWwocGF0aCwgdmFsdWUucGF0aCkgJiYgdmFsdWUudHlwZSA9PT0gTW9kaWZ5VHlwZS5BZGQ7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPllZhbHVlQ2hhbmdl57G75Z6L55qE5Y+Y5pu06K6w5b2VXHJcbiAgICogQHBhcmFtIHBhdGgg5Y+Y5pu06Lev5b6EXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaW5kTW9kaWZ5SXRlbXNQYXRoKHBhdGg6IGFueVtdKSB7XHJcbiAgICByZXR1cm4gdGhpcy5tb2RpZmljYXRpb25zLmZpbmQoKHZhbHVlLCBpbmRleCkgPT4ge1xyXG4gICAgICByZXR1cm4gaXNFcXVhbChwYXRoLCB2YWx1ZS5wYXRoKSAmJiB2YWx1ZS50eXBlID09PSBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliKDpmaTlkI7ku6PvvIjljIXmi6zoh6rlt7HvvInmiYDmnInnmoTliKDpmaTlj5jmm7RcclxuICAgKiBAdG9kb++8muS4tOaXtuWBmuS4gOS4quacgOWwj+WMluS/ruaUuVxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVtb3ZlRGVzY2VuZGFudFJlbW92ZU1vZGlmaWNhdGlvbnMocGFyZW50UmVtb3ZlTW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCBwYXJlbnRQYXRoV2l0aElkID0gdGhpcy5jcmVhdGVSZW1vdmVQYXRoV2l0aElkKHBhcmVudFJlbW92ZU1vZGlmaWNhdGlvbik7XHJcblxyXG4gICAgLy8g5Yig6Zmk5ZCO5Luj5L+u5pS55Y+Y5pu0XHJcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMgPSB0aGlzLm1vZGlmaWNhdGlvbnMuZmlsdGVyKChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikgPT4ge1xyXG4gICAgICBpZiAobW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuUmVtb3ZlKSB7XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgZGVzY2VuZGFudFBhdGhXaXRoSWQgPSB0aGlzLmNyZWF0ZVJlbW92ZVBhdGhXaXRoSWQobW9kaWZpY2F0aW9uKTtcclxuICAgICAgY29uc3QgaXNEZXNjZW5kYW50ID0gIHRoaXMuaXNEZXNjZW5kYW50UGF0aChwYXJlbnRQYXRoV2l0aElkLCBkZXNjZW5kYW50UGF0aFdpdGhJZCk7XHJcbiAgICAgIHJldHVybiAhaXNEZXNjZW5kYW50O1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bliKDpmaTot6/lvoTnmoTlrozmlbTmoLzlvI9cclxuICAgKiBAc3VtbWFyeVxyXG4gICAqIDHjgIHnm67liY3liKDpmaTlj5jmm7TnmoTot6/lvoTmoIforrDliLDniLbpm4blkIjvvJtcclxuICAgKiAy44CB5Li65LqG5pa55L6/5q+U6L6D77yM5bCG6KKr5Yig6Zmk55qE5pWw5o2uaWTliqDlhaXliLDot6/lvoTkuK1cclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZVJlbW92ZVBhdGhXaXRoSWQobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcclxuICAgIGNvbnN0IHBhdGggPSBtb2RpZmljYXRpb24ucGF0aDtcclxuICAgIGNvbnN0IHByaW1hcnlLZXkgPSBPYmplY3Qua2V5cyhtb2RpZmljYXRpb24udmFsdWUpWzBdO1xyXG4gICAgY29uc3QgcHJpbWFyeUtleVZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlW3ByaW1hcnlLZXldO1xyXG4gICAgY29uc3QgcGF0aFdpdGhJZCA9IHBhdGguY29uY2F0KFtgJHtwcmltYXJ5S2V5fToke3ByaW1hcnlLZXlWYWx1ZX1gXSk7XHJcbiAgICByZXR1cm4gcGF0aFdpdGhJZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIpOaWreaYr+WQpuaYr+WQjuS7o+iKgueCuei3r+W+hFxyXG4gICAqIEBwYXJhbSBwYXJlbnRQYXRoIOeItuiKgueCuei3r+W+hFxyXG4gICAqIEBwYXJhbSBkZXNjZW5kYW50UGF0aCDlkI7ku6PoioLngrlcclxuICAgKi9cclxuICBwcml2YXRlIGlzRGVzY2VuZGFudFBhdGgocGFyZW50UGF0aDogc3RyaW5nW10sIGRlc2NlbmRhbnRQYXRoOiBzdHJpbmdbXSkge1xyXG4gICAgaWYgKHBhcmVudFBhdGgubGVuZ3RoID4gZGVzY2VuZGFudFBhdGgubGVuZ3RoKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgaXNEZXNjZW5kYW50UGF0aCA9IHRydWU7XHJcbiAgICBwYXJlbnRQYXRoLmZvckVhY2goKHBhcmVudFBhdGhJdGVtOiBzdHJpbmcsIHBhcmVudFBhdGhJdGVtSW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICBpZiAocGFyZW50UGF0aEl0ZW0gIT09IGRlc2NlbmRhbnRQYXRoW3BhcmVudFBhdGhJdGVtSW5kZXhdKSB7XHJcbiAgICAgICAgaXNEZXNjZW5kYW50UGF0aCA9IGZhbHNlO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGlzRGVzY2VuZGFudFBhdGg7XHJcbiAgfVxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgQ2hhbmdlU2V0IH07XHJcblxyXG4iXX0=