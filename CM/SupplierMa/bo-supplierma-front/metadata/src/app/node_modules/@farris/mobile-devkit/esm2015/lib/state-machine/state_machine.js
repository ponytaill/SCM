import { BehaviorSubject } from 'rxjs';
import { MetadataUtil } from '../core/index';
import { State, initialUIState } from './types';
import { STATE_PROP_META, RENDER_STATE_PROP_META, ACTION_METHOD_META } from './decorators';
import { StateMachineContext } from './state_machine_context';
import { StateMachineWatcher } from './state_machine_watcher';
/**
 * 状态机
 */
export class StateMachine {
    /**
     * 构造函数
     */
    constructor() {
        this.renderStates = {};
        this.handlePropMetadatas();
        this.stateChange = new BehaviorSubject(false);
        this.context = new StateMachineContext(this, this.initialState);
        this.stateMachineWatcher = new StateMachineWatcher(this);
    }
    /**
     * 初始化状态机
     * @param viewModelContext ViewModel上下文
     * @summary
     * 状态机变更，为了在绑定数据之后执行状态机的操作，把render方法延后执行。
     */
    init(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.context.init(this.viewModelContext);
        this.stateMachineWatcher.init(this.viewModelContext);
        this.render();
    }
    /**
     * 批量处理属性元数据
     */
    handlePropMetadatas() {
        const propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);
        // 遍历所有属性装饰器，并调用相应的build方法
        if (propsMetadatas) {
            Object.keys(propsMetadatas).forEach((propName) => {
                const propMetadatas = propsMetadatas[propName];
                propMetadatas.forEach(propMetadata => {
                    this.handlePropMetadata(propName, propMetadata);
                });
            });
        }
        if (!this.initialState) {
            throw new Error('请在StatePropMeta注解中指定状态机的初始状态。');
        }
    }
    /**
     * 处理属性元数据
     */
    handlePropMetadata(propName, propMetadata) {
        const ngMetadataName = propMetadata.ngMetadataName;
        switch (ngMetadataName) {
            case STATE_PROP_META:
                this.buildState(propName, propMetadata);
                break;
            case RENDER_STATE_PROP_META:
                this.buildRenderState(propName, propMetadata);
                break;
            case ACTION_METHOD_META:
                this.buildAction(propName, propMetadata);
                break;
            default:
                break;
        }
    }
    /**
     * 包装State
     * @param stateName 状态名称
     * @param ngState   状态对象
     */
    buildState(stateName, ngState) {
        this.states = this.states || {};
        this[stateName] = new State(stateName);
        this.states[stateName] = this[stateName];
        if (ngState.initialState) {
            this.initialState = this[stateName];
        }
    }
    /**
     * 包装RenderState
     * @param renderStateName 渲染状态名称
     * @param ngRenderState   渲染状态元数据
     */
    buildRenderState(renderStateName, ngRenderState) {
        this.renderStates = this.renderStates || {};
        this[renderStateName] = initialUIState;
        this.renderStates[renderStateName] = this[renderStateName];
        // 将renderState上指定的render加入到renders中
        this.renders = this.renders || {};
        this.renders[renderStateName] = ngRenderState.render;
    }
    /**
     * 包装Action
     * @param actionName 动作名称
     * @param ngAction 动作元数据
     */
    buildAction(actionName, ngAction) {
        this[actionName] = () => {
            const nextStateName = ngAction.transitTo;
            const nextState = this.states[nextStateName];
            this.context.transitTo(nextState.name);
            this.render();
        };
    }
    /**
     * 重新计算所有渲染状态的值
     * @sumamry
     * 当 state切换的时候，调用遍历所有的render方法，更改renderState
     */
    render() {
        for (const renderStateName in this.renderStates) {
            if (this.renderStates.hasOwnProperty(renderStateName) === false) {
                continue;
            }
            // 执行RenderState的render方法，更新renderState
            const stateRender = this.renders[renderStateName];
            if (!stateRender) {
                continue;
            }
            this.renderStates[renderStateName] = stateRender(this.context);
            this[renderStateName] = this.renderStates[renderStateName];
        }
        this.stateChange.next(this.context.state);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9zdGF0ZS1tYWNoaW5lL3N0YXRlX21hY2hpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzdDLE9BQU8sRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUE0RCxNQUFNLFNBQVMsQ0FBQztBQUMxRyxPQUFPLEVBRUwsZUFBZSxFQUFFLHNCQUFzQixFQUFFLGtCQUFrQixFQUM1RCxNQUFNLGNBQWMsQ0FBQztBQUN0QixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RDs7R0FFRztBQUNILE1BQU0sT0FBTyxZQUFZO0lBMEN2Qjs7T0FFRztJQUNIO1FBQ0UsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLGVBQWUsQ0FBTSxLQUFLLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksbUJBQW1CLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSSxJQUFJLENBQUMsZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMs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SUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUNwRCxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdkMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsTUFBTTtRQUNKLEtBQUssTUFBTSxlQUFlLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUUvQyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLGVBQWUsQ0FBQyxLQUFLLEtBQUssRUFBRTtnQkFDL0QsU0FBUzthQUNWO1lBRUQsdUNBQXVDO1lBQ3ZDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDbEQsSUFBSSxDQUFDLFdBQVcsRUFBRTtnQkFDaEIsU0FBUzthQUNWO1lBRUQsSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQy9ELElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQzVEO1FBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUM1QyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcbmltcG9ydCB7IFZpZXdNb2RlbENvbnRleHQgfSBmcm9tICcuLi92aWV3LW1vZGVsL2luZGV4JztcclxuXHJcbmltcG9ydCB7IFN0YXRlLCBpbml0aWFsVUlTdGF0ZSwgU3RhdGVEaWN0aW9uYXJ5LCBSZW5kZXJTdGF0ZURpY3Rpb25hcnksIFJlbmRlckRpY3Rpb25hcnkgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHtcclxuICBTdGF0ZVByb3BNZXRhZGF0YSwgQWN0aW9uTWV0aG9kTWV0YWRhdGEsIFJlbmRlclN0YXRlUHJvcE1ldGFkYXRhLFxyXG4gIFNUQVRFX1BST1BfTUVUQSwgUkVOREVSX1NUQVRFX1BST1BfTUVUQSwgQUNUSU9OX01FVEhPRF9NRVRBXHJcbn0gZnJvbSAnLi9kZWNvcmF0b3JzJztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lQ29udGV4dCB9IGZyb20gJy4vc3RhdGVfbWFjaGluZV9jb250ZXh0JztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lV2F0Y2hlciB9IGZyb20gJy4vc3RhdGVfbWFjaGluZV93YXRjaGVyJztcclxuXHJcbi8qKlxyXG4gKiDnirbmgIHmnLpcclxuICovXHJcbmV4cG9ydCBjbGFzcyBTdGF0ZU1hY2hpbmUge1xyXG5cclxuICAvKipcclxuICAgKiDliJ3lp4vnirbmgIFcclxuICAgKi9cclxuICBwcml2YXRlIGluaXRpYWxTdGF0ZTogU3RhdGU7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeWtl+WFuFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZXM6IFN0YXRlRGljdGlvbmFyeTtcclxuXHJcbiAgLyoqXHJcbiAgICog5riy5p+T54q25oCB5a2X5YW4XHJcbiAgICovXHJcbiAgcHVibGljIHJlbmRlclN0YXRlczogUmVuZGVyU3RhdGVEaWN0aW9uYXJ5O1xyXG5cclxuICAvKipcclxuICAgKiDmuLLmn5PlmajlrZflhbhcclxuICAgKi9cclxuICBwdWJsaWMgcmVuZGVyczogUmVuZGVyRGljdGlvbmFyeTtcclxuXHJcbiAgLyoqXHJcbiAgICog54q25oCB5py65LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRleHQ6IFN0YXRlTWFjaGluZUNvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeWPmOabtFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZUNoYW5nZTogQmVoYXZpb3JTdWJqZWN0PHN0cmluZz47XHJcblxyXG4gIC8qKlxyXG4gICAqIFZpZXdNb2RlbOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHB1YmxpYyB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0O1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHmnLrkuovku7bnm5HlkKxcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGVNYWNoaW5lV2F0Y2hlcjogU3RhdGVNYWNoaW5lV2F0Y2hlcjtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB0aGlzLnJlbmRlclN0YXRlcyA9IHt9O1xyXG4gICAgdGhpcy5oYW5kbGVQcm9wTWV0YWRhdGFzKCk7XHJcbiAgICB0aGlzLnN0YXRlQ2hhbmdlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxhbnk+KGZhbHNlKTtcclxuICAgIHRoaXMuY29udGV4dCA9IG5ldyBTdGF0ZU1hY2hpbmVDb250ZXh0KHRoaXMsIHRoaXMuaW5pdGlhbFN0YXRlKTtcclxuICAgIHRoaXMuc3RhdGVNYWNoaW5lV2F0Y2hlciA9IG5ldyBTdGF0ZU1hY2hpbmVXYXRjaGVyKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyW54q25oCB5py6XHJcbiAgICogQHBhcmFtIHZpZXdNb2RlbENvbnRleHQgVmlld01vZGVs5LiK5LiL5paHXHJcbiAgICogQHN1bW1hcnlcclxuICAgKiDnirbmgIHmnLrlj5jmm7TvvIzkuLrkuoblnKjnu5HlrprmlbDmja7kuYvlkI7miafooYznirbmgIHmnLrnmoTmk43kvZzvvIzmiopyZW5kZXLmlrnms5Xlu7blkI7miafooYzjgIJcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdCh2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0KSB7XHJcbiAgICB0aGlzLnZpZXdNb2RlbENvbnRleHQgPSB2aWV3TW9kZWxDb250ZXh0O1xyXG4gICAgdGhpcy5jb250ZXh0LmluaXQodGhpcy52aWV3TW9kZWxDb250ZXh0KTtcclxuICAgIHRoaXMuc3RhdGVNYWNoaW5lV2F0Y2hlci5pbml0KHRoaXMudmlld01vZGVsQ29udGV4dCk7XHJcbiAgICB0aGlzLnJlbmRlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP5aSE55CG5bGe5oCn5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVQcm9wTWV0YWRhdGFzKCkge1xyXG4gICAgY29uc3QgcHJvcHNNZXRhZGF0YXMgPSBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXModGhpcy5jb25zdHJ1Y3Rvcik7XHJcblxyXG4gICAgLy8g6YGN5Y6G5omA5pyJ5bGe5oCn6KOF6aWw5Zmo77yM5bm26LCD55So55u45bqU55qEYnVpbGTmlrnms5VcclxuICAgIGlmIChwcm9wc01ldGFkYXRhcykge1xyXG4gICAgICBPYmplY3Qua2V5cyhwcm9wc01ldGFkYXRhcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHByb3BNZXRhZGF0YXMgPSBwcm9wc01ldGFkYXRhc1twcm9wTmFtZV07XHJcbiAgICAgICAgcHJvcE1ldGFkYXRhcy5mb3JFYWNoKHByb3BNZXRhZGF0YSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmhhbmRsZVByb3BNZXRhZGF0YShwcm9wTmFtZSwgcHJvcE1ldGFkYXRhKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0aGlzLmluaXRpYWxTdGF0ZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+ivt+WcqFN0YXRlUHJvcE1ldGHms6jop6PkuK3mjIflrprnirbmgIHmnLrnmoTliJ3lp4vnirbmgIHjgIInKTtcclxuICAgIH1cclxuICB9XHJcbiAgXHJcbiAgLyoqXHJcbiAgICog5aSE55CG5bGe5oCn5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVQcm9wTWV0YWRhdGEocHJvcE5hbWU6IHN0cmluZywgcHJvcE1ldGFkYXRhOiBhbnkpIHtcclxuICAgIGNvbnN0IG5nTWV0YWRhdGFOYW1lID0gIHByb3BNZXRhZGF0YS5uZ01ldGFkYXRhTmFtZTtcclxuICAgIHN3aXRjaChuZ01ldGFkYXRhTmFtZSkge1xyXG4gICAgICBjYXNlIFNUQVRFX1BST1BfTUVUQTpcclxuICAgICAgICB0aGlzLmJ1aWxkU3RhdGUocHJvcE5hbWUsIHByb3BNZXRhZGF0YSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgUkVOREVSX1NUQVRFX1BST1BfTUVUQTpcclxuICAgICAgICB0aGlzLmJ1aWxkUmVuZGVyU3RhdGUocHJvcE5hbWUsIHByb3BNZXRhZGF0YSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgQUNUSU9OX01FVEhPRF9NRVRBOlxyXG4gICAgICAgIHRoaXMuYnVpbGRBY3Rpb24ocHJvcE5hbWUsIHByb3BNZXRhZGF0YSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDljIXoo4VTdGF0ZVxyXG4gICAqIEBwYXJhbSBzdGF0ZU5hbWUg54q25oCB5ZCN56ewXHJcbiAgICogQHBhcmFtIG5nU3RhdGUgICDnirbmgIHlr7nosaFcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkU3RhdGUoc3RhdGVOYW1lOiBzdHJpbmcsIG5nU3RhdGU6IFN0YXRlUHJvcE1ldGFkYXRhKSB7XHJcbiAgICB0aGlzLnN0YXRlcyA9IHRoaXMuc3RhdGVzIHx8IHt9O1xyXG4gICAgdGhpc1tzdGF0ZU5hbWVdID0gbmV3IFN0YXRlKHN0YXRlTmFtZSk7XHJcbiAgICB0aGlzLnN0YXRlc1tzdGF0ZU5hbWVdID0gdGhpc1tzdGF0ZU5hbWVdO1xyXG4gICAgaWYgKG5nU3RhdGUuaW5pdGlhbFN0YXRlKSB7XHJcbiAgICAgIHRoaXMuaW5pdGlhbFN0YXRlID0gdGhpc1tzdGF0ZU5hbWVdO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YyF6KOFUmVuZGVyU3RhdGVcclxuICAgKiBAcGFyYW0gcmVuZGVyU3RhdGVOYW1lIOa4suafk+eKtuaAgeWQjeensFxyXG4gICAqIEBwYXJhbSBuZ1JlbmRlclN0YXRlICAg5riy5p+T54q25oCB5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZFJlbmRlclN0YXRlKHJlbmRlclN0YXRlTmFtZTogc3RyaW5nLCBuZ1JlbmRlclN0YXRlOiBSZW5kZXJTdGF0ZVByb3BNZXRhZGF0YSkge1xyXG4gICAgdGhpcy5yZW5kZXJTdGF0ZXMgPSB0aGlzLnJlbmRlclN0YXRlcyB8fCB7fTtcclxuICAgIHRoaXNbcmVuZGVyU3RhdGVOYW1lXSA9IGluaXRpYWxVSVN0YXRlO1xyXG4gICAgdGhpcy5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHRoaXNbcmVuZGVyU3RhdGVOYW1lXTtcclxuXHJcbiAgICAvLyDlsIZyZW5kZXJTdGF0ZeS4iuaMh+WumueahHJlbmRlcuWKoOWFpeWIsHJlbmRlcnPkuK1cclxuICAgIHRoaXMucmVuZGVycyA9IHRoaXMucmVuZGVycyB8fCB7fTtcclxuICAgIHRoaXMucmVuZGVyc1tyZW5kZXJTdGF0ZU5hbWVdID0gbmdSZW5kZXJTdGF0ZS5yZW5kZXI7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDljIXoo4VBY3Rpb25cclxuICAgKiBAcGFyYW0gYWN0aW9uTmFtZSDliqjkvZzlkI3np7BcclxuICAgKiBAcGFyYW0gbmdBY3Rpb24g5Yqo5L2c5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZEFjdGlvbihhY3Rpb25OYW1lOiBzdHJpbmcsIG5nQWN0aW9uOiBBY3Rpb25NZXRob2RNZXRhZGF0YSkge1xyXG4gICAgdGhpc1thY3Rpb25OYW1lXSA9ICgpID0+IHtcclxuICAgICAgY29uc3QgbmV4dFN0YXRlTmFtZSA9IG5nQWN0aW9uLnRyYW5zaXRUbztcclxuICAgICAgY29uc3QgbmV4dFN0YXRlOiBTdGF0ZSA9IHRoaXMuc3RhdGVzW25leHRTdGF0ZU5hbWVdO1xyXG4gICAgICB0aGlzLmNvbnRleHQudHJhbnNpdFRvKG5leHRTdGF0ZS5uYW1lKTtcclxuICAgICAgdGhpcy5yZW5kZXIoKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDph43mlrDorqHnrpfmiYDmnInmuLLmn5PnirbmgIHnmoTlgLxcclxuICAgKiBAc3VtYW1yeVxyXG4gICAqIOW9kyBzdGF0ZeWIh+aNoueahOaXtuWAme+8jOiwg+eUqOmBjeWOhuaJgOacieeahHJlbmRlcuaWueazle+8jOabtOaUuXJlbmRlclN0YXRlXHJcbiAgICovXHJcbiAgcmVuZGVyKCkge1xyXG4gICAgZm9yIChjb25zdCByZW5kZXJTdGF0ZU5hbWUgaW4gdGhpcy5yZW5kZXJTdGF0ZXMpIHtcclxuXHJcbiAgICAgIGlmICh0aGlzLnJlbmRlclN0YXRlcy5oYXNPd25Qcm9wZXJ0eShyZW5kZXJTdGF0ZU5hbWUpID09PSBmYWxzZSkge1xyXG4gICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDmiafooYxSZW5kZXJTdGF0ZeeahHJlbmRlcuaWueazle+8jOabtOaWsHJlbmRlclN0YXRlXHJcbiAgICAgIGNvbnN0IHN0YXRlUmVuZGVyID0gdGhpcy5yZW5kZXJzW3JlbmRlclN0YXRlTmFtZV07XHJcbiAgICAgIGlmICghc3RhdGVSZW5kZXIpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5yZW5kZXJTdGF0ZXNbcmVuZGVyU3RhdGVOYW1lXSA9IHN0YXRlUmVuZGVyKHRoaXMuY29udGV4dCk7XHJcbiAgICAgIHRoaXNbcmVuZGVyU3RhdGVOYW1lXSA9IHRoaXMucmVuZGVyU3RhdGVzW3JlbmRlclN0YXRlTmFtZV07XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0YXRlQ2hhbmdlLm5leHQodGhpcy5jb250ZXh0LnN0YXRlKTtcclxuICB9XHJcbn1cclxuIl19