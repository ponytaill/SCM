/**
 * BindingObject相关定义
 * @author Witt<jiwt@inspur.com>
 */
import { Subject, of } from 'rxjs';
import { ChangeType, ViewChangeType } from './changes';
import { BindingPropertyType } from './binding_property';
import { PropertyUtil } from './property_util';
/**
 * BindingObject是Entity在绑定层的一个影射，它将Entity内的数据转换为不可变对象，并用于界面绑定。
 */
var BindingObject = /** @class */ (function () {
    /**
     * 构造函数
     * @param properties 属性集合
     */
    function BindingObject(properties) {
        /**
         * 标识是否提交过
         */
        this.isShowValidationMsg = false;
        /**
         * 以{ [propertyName]: FormControl }的形式存放每条数据的control
         */
        this.controlMap = {};
        this.properties = properties;
        this.primaryKey = PropertyUtil.getPrimaryKey(properties);
        this.innerValues = new Map();
        this.changes = new Subject();
        this.viewChanges = new Subject();
    }
    Object.defineProperty(BindingObject.prototype, "primaryKeyValue", {
        /**
         * 主键值
         */
        get: function () {
            return this.primaryKey ? this.getValue(this.primaryKey) : '';
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置是否提交过
     */
    BindingObject.prototype.setShowValidationMsg = function (flag) {
        this.isShowValidationMsg = flag;
    };
    /**
     * 根据属性名获取属性值
     * @param   propertyName 属性名
     * @returns 属性值
     */
    BindingObject.prototype.getValue = function (propertyName) {
        return this.innerValues.get(propertyName);
    };
    /**
     * 设置属性值
     * @param propertyName        属性名
     * @param propertyValue       属性值
     * @param emitEventToView     是否通知View层去更新界面，默认为false
     * @param emitEventToEntity   是否通知Entity层去更新值，默认为false
     * @param errors              错误消息
     * @param invokeOnValueChange 值变化事件执行句柄
     */
    BindingObject.prototype.setValue = function (propertyName, propertyValue, emitEventToView, emitEventToEntity, errors, invokeOnValueChange) {
        var _this = this;
        if (emitEventToView === void 0) { emitEventToView = false; }
        if (emitEventToEntity === void 0) { emitEventToEntity = false; }
        var oldPropertyValue = this.getValue(propertyName);
        // 由于特定原因（@邵珠强），无法屏蔽oldPropertyValue === propertyValue
        if (oldPropertyValue === propertyValue) {
            return;
        }
        if (!invokeOnValueChange || oldPropertyValue === propertyValue) {
            // 设定缺省
            invokeOnValueChange = function (preValue, value, entityChanged) {
                return of(true);
            };
        }
        if (emitEventToEntity === true) {
            // BUG 322301，删除@2019.08.10; 如果无对应实体，则中止值传递; 这种情况发生在带从表的单据新增，从表响应Load变化的情况；
            // if(!this.innerValues.has(propertyName)) {
            //   return;
            // }
            // 执行实体值变化前事件
            invokeOnValueChange(oldPropertyValue, propertyValue, false).subscribe(function (result) {
                if (result) {
                    // 如果成功，执行变化，并通知实体变化
                    _this.innerValues = _this.innerValues.set(propertyName, propertyValue);
                    var viewChange = {
                        type: ViewChangeType.ValueChanged,
                        path: [propertyName],
                        value: propertyValue,
                        errors: errors
                    };
                    _this.viewChanges.next(viewChange);
                    // 如果需要通知视图，通知视图相应修改
                    if (emitEventToView === true) {
                        _this.changes.next({
                            type: ChangeType.ValueChanged,
                            path: [propertyName],
                            value: propertyValue,
                            id: _this.primaryKeyValue,
                            errors: errors
                        });
                    }
                    // 执行实体值变化后事件
                    invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();
                }
                else {
                    // 如果失败，不再通知实体变化
                    // 并执行界面回滚操作
                    _this.changes.next({
                        type: ChangeType.ValueChanged,
                        path: [propertyName],
                        value: oldPropertyValue,
                        id: _this.primaryKeyValue,
                        errors: errors
                    });
                }
            });
        }
        else {
            // `emitEventToEntity === false`, 则认定实体值已经发生变化，通知视图变化，并触发实体值变化后事件
            this.innerValues = this.innerValues.set(propertyName, propertyValue);
            if (emitEventToView === true) {
                this.changes.next({
                    type: ChangeType.ValueChanged,
                    path: [propertyName],
                    value: propertyValue,
                    id: this.primaryKeyValue,
                    errors: errors
                });
            }
            // 执行实体值变化后事件
            invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();
        }
    };
    /**
     * 将BindingObject实例转换成JSON对象
     */
    BindingObject.prototype.toJSON = function (options) {
        var _this = this;
        var langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';
        var result = {};
        this.properties.forEach(function (property) {
            var propName = property.name;
            if (property.type === BindingPropertyType.List) {
                var list = _this[propName];
                result[propName] = list.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Object) {
                var object = _this[propName];
                result[propName] = object.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                var object = _this[propName];
                result[propName] = object.toJSON(options);
            }
            else {
                // 1、对于多语录入字段；
                // 2、传入ignoreMultiLangInput标志，则取当前语言的值给控件。
                if (options && options.ignoreMultiLangInput === true && property.enableMultiLangInput === true) {
                    var multiLangValueObj = _this.getValue(propName);
                    if (multiLangValueObj) {
                        result[propName] = multiLangValueObj[langCode];
                    }
                    else {
                        result[propName] = multiLangValueObj;
                    }
                }
                else {
                    result[propName] = _this.getValue(propName);
                }
            }
        });
        return result;
    };
    return BindingObject;
}());
export { BindingObject };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19vYmplY3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1kYXRhL2JpbmRpbmdfb2JqZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUVILE9BQU8sRUFBRSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9DLE9BQU8sRUFBVSxVQUFVLEVBQWMsY0FBYyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzNFLE9BQU8sRUFBbUIsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFNL0M7O0dBRUc7QUFDSDtJQXlERTs7O09BR0c7SUFDSCx1QkFBWSxVQUE2QjtRQXRCekM7O1dBRUc7UUFDSSx3QkFBbUIsR0FBRyxLQUFLLENBQUM7UUFFbkM7O1dBRUc7UUFDSSxlQUFVLEdBQVEsRUFBRSxDQUFDO1FBZTFCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxVQUFVLEdBQUcsWUFBWSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUV6RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxFQUFlLENBQUM7UUFDMUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxPQUFPLEVBQWMsQ0FBQztJQUMvQyxDQUFDO0lBakNELHNCQUFXLDBDQUFlO1FBSDFCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7UUFDL0QsQ0FBQzs7O09BQUE7SUFZRDs7T0FFRztJQUNJ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O2FBQzNDO2lCQUFNLElBQUksUUFBUSxDQUFDLElBQUksS0FBSyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUU7Z0JBQ3hELElBQU0sTUFBTSxHQUFrQixLQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzdDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzNDO2lCQUFNO2dCQUVMLGNBQWM7Z0JBQ2QsMENBQTBDO2dCQUMxQyxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsb0JBQW9CLEtBQUssSUFBSSxJQUFJLFFBQVEsQ0FBQyxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7b0JBQzlGLElBQU0saUJBQWlCLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDbEQsSUFBSSxpQkFBaUIsRUFBRTt3QkFDckIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO3FCQUNoRDt5QkFBTTt3QkFDTCxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsaUJBQWlCLENBQUM7cUJBQ3RDO2lCQUNGO3FCQUFNO29CQUNMLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxLQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUM1QzthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0lBQ0gsb0JBQUM7QUFBRCxDQUFDLEFBMU1ELElBME1DO0FBRUQsT0FBTyxFQUFFLGFBQWEsRUFBdUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBCaW5kaW5nT2JqZWN055u45YWz5a6a5LmJXHJcbiAqIEBhdXRob3IgV2l0dDxqaXd0QGluc3B1ci5jb20+XHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgU3ViamVjdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7IENoYW5nZSwgQ2hhbmdlVHlwZSwgVmlld0NoYW5nZSwgVmlld0NoYW5nZVR5cGUgfSBmcm9tICcuL2NoYW5nZXMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nUHJvcGVydHksIEJpbmRpbmdQcm9wZXJ0eVR5cGUgfSBmcm9tICcuL2JpbmRpbmdfcHJvcGVydHknO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4vYmluZGluZ19saXN0JztcclxuaW1wb3J0IHsgUHJvcGVydHlVdGlsIH0gZnJvbSAnLi9wcm9wZXJ0eV91dGlsJztcclxuXHJcbmludGVyZmFjZSBJbnZva2VPblZhbHVlQ2hhbmdlIHtcclxuICAocHJlVmFsdWUsIHZhbHVlLCBlbnRpdHlDaGFuZ2VkOiBib29sZWFuKTogT2JzZXJ2YWJsZTxib29sZWFuPjtcclxufVxyXG5cclxuLyoqXHJcbiAqIEJpbmRpbmdPYmplY3TmmK9FbnRpdHnlnKjnu5HlrprlsYLnmoTkuIDkuKrlvbHlsITvvIzlroPlsIZFbnRpdHnlhoXnmoTmlbDmja7ovazmjaLkuLrkuI3lj6/lj5jlr7nosaHvvIzlubbnlKjkuo7nlYzpnaLnu5HlrprjgIJcclxuICovXHJcbmNsYXNzIEJpbmRpbmdPYmplY3Qge1xyXG5cclxuICAvKipcclxuICAgKiBpbW11dGFibGXlgLzlr7nosaFcclxuICAgKi9cclxuICBwcml2YXRlIGlubmVyVmFsdWVzOiBNYXA8c3RyaW5nLCBhbnk+O1xyXG5cclxuICAvKipcclxuICAgKiDniLblr7nosaHmiJbniLbliJfooahcclxuICAgKi9cclxuICBwdWJsaWMgcGFyZW50OiBCaW5kaW5nTGlzdCB8IEJpbmRpbmdPYmplY3Q7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWunuS9k+W8lei1t+eahOWPmOabtFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGFuZ2VzOiBTdWJqZWN0PENoYW5nZT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOeVjOmdouWxguW8lei1t+eahOWPmOabtOa1gVxyXG4gICAqL1xyXG4gIHB1YmxpYyB2aWV3Q2hhbmdlczogU3ViamVjdDxWaWV3Q2hhbmdlPjtcclxuXHJcbiAgLyoqXHJcbiAgICogIOWxnuaAp+mbhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyBwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog5Li76ZSu5ZCNXHJcbiAgICovXHJcbiAgcHVibGljIHByaW1hcnlLZXk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5Li76ZSu5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGdldCBwcmltYXJ5S2V5VmFsdWUoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5wcmltYXJ5S2V5ID8gdGhpcy5nZXRWYWx1ZSh0aGlzLnByaW1hcnlLZXkpIDogJyc7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoIfor4bmmK/lkKbmj5DkuqTov4dcclxuICAgKi9cclxuICBwdWJsaWMgaXNTaG93VmFsaWRhdGlvbk1zZyA9IGZhbHNlO1xyXG5cclxuICAvKipcclxuICAgKiDku6V7IFtwcm9wZXJ0eU5hbWVdOiBGb3JtQ29udHJvbCB955qE5b2i5byP5a2Y5pS+5q+P5p2h5pWw5o2u55qEY29udHJvbFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb250cm9sTWFwOiBhbnkgPSB7fTtcclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5piv5ZCm5o+Q5Lqk6L+HXHJcbiAgICovXHJcbiAgcHVibGljIHNldFNob3dWYWxpZGF0aW9uTXNnKGZsYWc6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMuaXNTaG93VmFsaWRhdGlvbk1zZyA9IGZsYWc7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICogQHBhcmFtIHByb3BlcnRpZXMg5bGe5oCn6ZuG5ZCIXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IocHJvcGVydGllczogQmluZGluZ1Byb3BlcnR5W10pIHtcclxuICAgIHRoaXMucHJvcGVydGllcyA9IHByb3BlcnRpZXM7XHJcbiAgICB0aGlzLnByaW1hcnlLZXkgPSBQcm9wZXJ0eVV0aWwuZ2V0UHJpbWFyeUtleShwcm9wZXJ0aWVzKTtcclxuXHJcbiAgICB0aGlzLmlubmVyVmFsdWVzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgIHRoaXMuY2hhbmdlcyA9IG5ldyBTdWJqZWN0PENoYW5nZT4oKTtcclxuICAgIHRoaXMudmlld0NoYW5nZXMgPSBuZXcgU3ViamVjdDxWaWV3Q2hhbmdlPigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2u5bGe5oCn5ZCN6I635Y+W5bGe5oCn5YC8XHJcbiAgICogQHBhcmFtICAgcHJvcGVydHlOYW1lIOWxnuaAp+WQjVxyXG4gICAqIEByZXR1cm5zIOWxnuaAp+WAvFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRWYWx1ZShwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IGFueSB7XHJcbiAgICByZXR1cm4gdGhpcy5pbm5lclZhbHVlcy5nZXQocHJvcGVydHlOYW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruWxnuaAp+WAvFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUgICAgICAgIOWxnuaAp+WQjVxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVZhbHVlICAgICAgIOWxnuaAp+WAvFxyXG4gICAqIEBwYXJhbSBlbWl0RXZlbnRUb1ZpZXcgICAgIOaYr+WQpumAmuefpVZpZXflsYLljrvmm7TmlrDnlYzpnaLvvIzpu5jorqTkuLpmYWxzZVxyXG4gICAqIEBwYXJhbSBlbWl0RXZlbnRUb0VudGl0eSAgIOaYr+WQpumAmuefpUVudGl0eeWxguWOu+abtOaWsOWAvO+8jOm7mOiupOS4umZhbHNlXHJcbiAgICogQHBhcmFtIGVycm9ycyAgICAgICAgICAgICAg6ZSZ6K+v5raI5oGvXHJcbiAgICogQHBhcmFtIGludm9rZU9uVmFsdWVDaGFuZ2Ug5YC85Y+Y5YyW5LqL5Lu25omn6KGM5Y+l5p+EXHJcbiAgICovXHJcbiAgcHVibGljIHNldFZhbHVlKFxyXG4gICAgcHJvcGVydHlOYW1lOiBzdHJpbmcsIHByb3BlcnR5VmFsdWU6IGFueSxcclxuICAgIGVtaXRFdmVudFRvVmlldzogYm9vbGVhbiA9IGZhbHNlLCBlbWl0RXZlbnRUb0VudGl0eTogYm9vbGVhbiA9IGZhbHNlLFxyXG4gICAgZXJyb3JzPzogYW55LCBpbnZva2VPblZhbHVlQ2hhbmdlPzogSW52b2tlT25WYWx1ZUNoYW5nZVxyXG4gICk6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IG9sZFByb3BlcnR5VmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSk7XHJcblxyXG4gICAgLy8g55Sx5LqO54m55a6a5Y6f5Zug77yIQOmCteePoOW8uu+8ie+8jOaXoOazleWxj+iUvW9sZFByb3BlcnR5VmFsdWUgPT09IHByb3BlcnR5VmFsdWVcclxuICAgIGlmIChvbGRQcm9wZXJ0eVZhbHVlID09PSBwcm9wZXJ0eVZhbHVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWludm9rZU9uVmFsdWVDaGFuZ2UgfHwgb2xkUHJvcGVydHlWYWx1ZSA9PT0gcHJvcGVydHlWYWx1ZSkge1xyXG4gICAgICAvLyDorr7lrprnvLrnnIFcclxuICAgICAgaW52b2tlT25WYWx1ZUNoYW5nZSA9IGZ1bmN0aW9uIChwcmVWYWx1ZSwgdmFsdWUsIGVudGl0eUNoYW5nZWQ6IGJvb2xlYW4pIHtcclxuICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGVtaXRFdmVudFRvRW50aXR5ID09PSB0cnVlKSB7XHJcbiAgICAgIC8vIEJVRyAzMjIzMDHvvIzliKDpmaRAMjAxOS4wOC4xMDsg5aaC5p6c5peg5a+55bqU5a6e5L2T77yM5YiZ5Lit5q2i5YC85Lyg6YCSOyDov5nnp43mg4XlhrXlj5HnlJ/lnKjluKbku47ooajnmoTljZXmja7mlrDlop7vvIzku47ooajlk43lupRMb2Fk5Y+Y5YyW55qE5oOF5Ya177ybXHJcbiAgICAgIC8vIGlmKCF0aGlzLmlubmVyVmFsdWVzLmhhcyhwcm9wZXJ0eU5hbWUpKSB7XHJcbiAgICAgIC8vICAgcmV0dXJuO1xyXG4gICAgICAvLyB9XHJcbiAgICAgIC8vIOaJp+ihjOWunuS9k+WAvOWPmOWMluWJjeS6i+S7tlxyXG4gICAgICBpbnZva2VPblZhbHVlQ2hhbmdlKG9sZFByb3BlcnR5VmFsdWUsIHByb3BlcnR5VmFsdWUsIGZhbHNlKS5zdWJzY3JpYmUoKHJlc3VsdCkgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIC8vIOWmguaenOaIkOWKn++8jOaJp+ihjOWPmOWMlu+8jOW5tumAmuefpeWunuS9k+WPmOWMllxyXG4gICAgICAgICAgdGhpcy5pbm5lclZhbHVlcyA9IHRoaXMuaW5uZXJWYWx1ZXMuc2V0KHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSk7XHJcbiAgICAgICAgICBjb25zdCB2aWV3Q2hhbmdlID0ge1xyXG4gICAgICAgICAgICB0eXBlOiBWaWV3Q2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQsXHJcbiAgICAgICAgICAgIHBhdGg6IFtwcm9wZXJ0eU5hbWVdLFxyXG4gICAgICAgICAgICB2YWx1ZTogcHJvcGVydHlWYWx1ZSxcclxuICAgICAgICAgICAgZXJyb3JzOiBlcnJvcnNcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICB0aGlzLnZpZXdDaGFuZ2VzLm5leHQodmlld0NoYW5nZSk7XHJcbiAgICAgICAgICAvLyDlpoLmnpzpnIDopoHpgJrnn6Xop4blm77vvIzpgJrnn6Xop4blm77nm7jlupTkv67mlLlcclxuICAgICAgICAgIGlmIChlbWl0RXZlbnRUb1ZpZXcgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkLFxyXG4gICAgICAgICAgICAgIHBhdGg6IFtwcm9wZXJ0eU5hbWVdLFxyXG4gICAgICAgICAgICAgIHZhbHVlOiBwcm9wZXJ0eVZhbHVlLFxyXG4gICAgICAgICAgICAgIGlkOiB0aGlzLnByaW1hcnlLZXlWYWx1ZSxcclxuICAgICAgICAgICAgICBlcnJvcnM6IGVycm9yc1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOaJp+ihjOWunuS9k+WAvOWPmOWMluWQjuS6i+S7tlxyXG4gICAgICAgICAgaW52b2tlT25WYWx1ZUNoYW5nZShvbGRQcm9wZXJ0eVZhbHVlLCBwcm9wZXJ0eVZhbHVlLCB0cnVlKS5zdWJzY3JpYmUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8g5aaC5p6c5aSx6LSl77yM5LiN5YaN6YCa55+l5a6e5L2T5Y+Y5YyWXHJcbiAgICAgICAgICAvLyDlubbmiafooYznlYzpnaLlm57mu5rmk43kvZxcclxuICAgICAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQsXHJcbiAgICAgICAgICAgIHBhdGg6IFtwcm9wZXJ0eU5hbWVdLFxyXG4gICAgICAgICAgICB2YWx1ZTogb2xkUHJvcGVydHlWYWx1ZSxcclxuICAgICAgICAgICAgaWQ6IHRoaXMucHJpbWFyeUtleVZhbHVlLFxyXG4gICAgICAgICAgICBlcnJvcnM6IGVycm9yc1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIGBlbWl0RXZlbnRUb0VudGl0eSA9PT0gZmFsc2VgLCDliJnorqTlrprlrp7kvZPlgLzlt7Lnu4/lj5HnlJ/lj5jljJbvvIzpgJrnn6Xop4blm77lj5jljJbvvIzlubbop6blj5Hlrp7kvZPlgLzlj5jljJblkI7kuovku7ZcclxuICAgICAgdGhpcy5pbm5lclZhbHVlcyA9IHRoaXMuaW5uZXJWYWx1ZXMuc2V0KHByb3BlcnR5TmFtZSwgcHJvcGVydHlWYWx1ZSk7XHJcbiAgICAgIGlmIChlbWl0RXZlbnRUb1ZpZXcgPT09IHRydWUpIHtcclxuICAgICAgICB0aGlzLmNoYW5nZXMubmV4dCh7XHJcbiAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCxcclxuICAgICAgICAgIHBhdGg6IFtwcm9wZXJ0eU5hbWVdLFxyXG4gICAgICAgICAgdmFsdWU6IHByb3BlcnR5VmFsdWUsXHJcbiAgICAgICAgICBpZDogdGhpcy5wcmltYXJ5S2V5VmFsdWUsXHJcbiAgICAgICAgICBlcnJvcnM6IGVycm9yc1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIOaJp+ihjOWunuS9k+WAvOWPmOWMluWQjuS6i+S7tlxyXG4gICAgICBpbnZva2VPblZhbHVlQ2hhbmdlKG9sZFByb3BlcnR5VmFsdWUsIHByb3BlcnR5VmFsdWUsIHRydWUpLnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCGQmluZGluZ09iamVjdOWunuS+i+i9rOaNouaIkEpTT07lr7nosaFcclxuICAgKi9cclxuICBwdWJsaWMgdG9KU09OKG9wdGlvbnM/OiBhbnkpOiBhbnkge1xyXG4gICAgY29uc3QgbGFuZ0NvZGUgPSB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xhbmd1YWdlQ29kZScpIHx8ICd6aC1DSFMnO1xyXG4gICAgY29uc3QgcmVzdWx0ID0ge307XHJcbiAgICB0aGlzLnByb3BlcnRpZXMuZm9yRWFjaCgocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkgPT4ge1xyXG4gICAgICBjb25zdCBwcm9wTmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLkxpc3QpIHtcclxuICAgICAgICBjb25zdCBsaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXNbcHJvcE5hbWVdO1xyXG4gICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBsaXN0LnRvSlNPTihvcHRpb25zKTtcclxuICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLk9iamVjdCkge1xyXG4gICAgICAgIGNvbnN0IG9iamVjdDogQmluZGluZ09iamVjdCA9IHRoaXNbcHJvcE5hbWVdO1xyXG4gICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBvYmplY3QudG9KU09OKG9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuRHluYW1pYykge1xyXG4gICAgICAgIGNvbnN0IG9iamVjdDogQmluZGluZ09iamVjdCA9IHRoaXNbcHJvcE5hbWVdO1xyXG4gICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBvYmplY3QudG9KU09OKG9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2Uge1xyXG5cclxuICAgICAgICAvLyAx44CB5a+55LqO5aSa6K+t5b2V5YWl5a2X5q6177ybXHJcbiAgICAgICAgLy8gMuOAgeS8oOWFpWlnbm9yZU11bHRpTGFuZ0lucHV05qCH5b+X77yM5YiZ5Y+W5b2T5YmN6K+t6KiA55qE5YC857uZ5o6n5Lu244CCXHJcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5pZ25vcmVNdWx0aUxhbmdJbnB1dCA9PT0gdHJ1ZSAmJiBwcm9wZXJ0eS5lbmFibGVNdWx0aUxhbmdJbnB1dCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgY29uc3QgbXVsdGlMYW5nVmFsdWVPYmogPSB0aGlzLmdldFZhbHVlKHByb3BOYW1lKTtcclxuICAgICAgICAgIGlmIChtdWx0aUxhbmdWYWx1ZU9iaikge1xyXG4gICAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gbXVsdGlMYW5nVmFsdWVPYmpbbGFuZ0NvZGVdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IG11bHRpTGFuZ1ZhbHVlT2JqO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gdGhpcy5nZXRWYWx1ZShwcm9wTmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgQmluZGluZ09iamVjdCwgSW52b2tlT25WYWx1ZUNoYW5nZSB9O1xyXG4iXX0=