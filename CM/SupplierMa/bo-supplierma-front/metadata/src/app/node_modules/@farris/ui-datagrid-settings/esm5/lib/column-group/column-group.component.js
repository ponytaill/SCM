/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Component, Input, Injector, ChangeDetectorRef, ElementRef, ViewChild, EventEmitter, Output } from '@angular/core';
import { NgForm } from '@angular/forms';
import { DatagridSettingsComponent } from '../datagrid-settings.component';
var ColumnGroupSettingComponent = /** @class */ (function () {
    function ColumnGroupSettingComponent(injector, gridSettingComponentRef, cd) {
        this.injector = injector;
        this.gridSettingComponentRef = gridSettingComponentRef;
        this.cd = cd;
        this.fields = [];
        this.formatColumns = [];
        this.groupFields = [];
        this.groupFieldsChange = new EventEmitter();
        this.formatColumnsChange = new EventEmitter();
        this.groupColumns = [];
        this.allowGroupColumns = [];
        this.activeCalculationCol = null;
        this.showSelectColumnsPanel = false;
        this.summaryItems = [];
        this.summaryItems2 = [];
    }
    /**
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.summaryItems = this.gridSettingComponentRef.summaryItems;
        this.summaryItems2 = this.gridSettingComponentRef.summaryItems2;
        this.setGroupColumns();
        this.registerEventHandle();
        this.initCalculationColumns();
        if (this.colForm) {
            this.colForm.valueChanges.subscribe((/**
             * @param {?} v
             * @return {?}
             */
            function (v) {
                if (!_this.colForm.pristine) {
                    _this.formatColumnsChange.emit(_this.formatColumns);
                }
            }));
        }
        this.formatColumns.forEach((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            _this.checkColumnOptions(n);
        }));
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        var _this = this;
        if (changes.formatColumns && !changes.formatColumns.isFirstChange()) {
            this.formatColumns.forEach((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                _this.checkColumnOptions(n);
            }));
            this.setGroupColumns();
            this.initCalculationColumns();
        }
    };
    /**
     * @private
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.initCalculationColumns = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.formatColumns) {
            this.activeCalculationCol = this.formatColumns[0];
        }
    };
    /**
     * @private
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.registerEventHandle = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.groupingSettingEl.nativeElement.addEventListener('click', (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e.target !== _this.selectcolumnspanel.nativeElement) {
                _this.showSelectColumnsPanel = false;
            }
        }), false);
    };
    /**
     * @private
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.setGroupColumns = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.groupFields && this.groupFields.length) {
            this.groupColumns = this.groupFields.map((/**
             * @param {?} f
             * @return {?}
             */
            function (f) {
                return _this.columns[0].find((/**
                 * @param {?} col
                 * @return {?}
                 */
                function (col) { return col.field === f; }));
            })).filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n; }));
        }
        else {
            this.groupColumns = [];
        }
        this.onGroupFieldsChange();
    };
    /**
     * @private
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.getAllowGroupingColumns = /**
     * @private
     * @return {?}
     */
    function () {
        return this.columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.allowGrouping || n.allowGrouping === undefined; }));
    };
    /**
     * @private
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.onGroupFieldsChange = /**
     * @private
     * @return {?}
     */
    function () {
        this.groupFieldsChange.emit(this.groupFields);
    };
    /**
     * @private
     * @param {?} col
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.checkColumnOptions = /**
     * @private
     * @param {?} col
     * @return {?}
     */
    function (col) {
        if (col) {
            if (col.groupFooter === undefined) {
                col.groupFooter = { options: { calculationType: -1 } };
            }
            else {
                col.groupFooter.options = col.groupFooter.options || { calculationType: -1 };
                if (col.groupFooter.options.calculationType === undefined) {
                    col.groupFooter.options.calculationType = -1;
                }
            }
            // if (this.activeField.footer === undefined) {
            //     this.activeField.footer =  { options: {calculationType: -1} };
            // } else {
            //     this.activeField.footer.options = this.activeField.footer.options || {calculationType: -1};
            //     if (this.activeField.footer.options.calculationType === undefined) {
            //         this.activeField.footer.options.calculationType = -1;
            //     }
            // }
        }
    };
    /**
     * 显示或隐藏字段选取面板
     */
    /**
     * 显示或隐藏字段选取面板
     * @param {?} $event
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.toggleGroupingColumnPanel = /**
     * 显示或隐藏字段选取面板
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        $event.stopPropagation();
        this.showSelectColumnsPanel = !this.showSelectColumnsPanel;
        this.allowGroupColumns = this.getAllowGroupingColumns();
    };
    /** 添加分组字段 */
    /**
     * 添加分组字段
     * @param {?} $event
     * @param {?} col
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.addGroupColumn = /**
     * 添加分组字段
     * @param {?} $event
     * @param {?} col
     * @return {?}
     */
    function ($event, col) {
        $event.stopPropagation();
        if (this.groupFields.indexOf(col.field) === -1) {
            this.groupColumns = tslib_1.__spread(this.groupColumns, [col]);
            this.groupFields = this.groupColumns.map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.field; }));
            this.onGroupFieldsChange();
            this.showSelectColumnsPanel = false;
        }
    };
    /** 移除分组字段 */
    /**
     * 移除分组字段
     * @param {?} $event
     * @param {?} col
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.onRemoveGroupingField = /**
     * 移除分组字段
     * @param {?} $event
     * @param {?} col
     * @return {?}
     */
    function ($event, col) {
        $event.stopPropagation();
        this.groupFields = this.groupFields.filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n !== col.field; }));
        this.setGroupColumns();
    };
    /** 拖动分组字段进行排序 */
    /**
     * 拖动分组字段进行排序
     * @param {?} $event
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.onGroupingFieldDropped = /**
     * 拖动分组字段进行排序
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        var _a;
        console.log('grouping field droped.', $event);
        var removedIndex = $event.removedIndex, addedIndex = $event.addedIndex;
        /** @type {?} */
        var removedItem = this.groupFields.splice(removedIndex, 1);
        (_a = this.groupFields).splice.apply(_a, tslib_1.__spread([addedIndex, 0], removedItem));
        this.setGroupColumns();
    };
    /**
     * @param {?} $event
     * @param {?} col
     * @return {?}
     */
    ColumnGroupSettingComponent.prototype.onFieldClick = /**
     * @param {?} $event
     * @param {?} col
     * @return {?}
     */
    function ($event, col) {
        this.activeCalculationCol = col;
    };
    ColumnGroupSettingComponent.decorators = [
        { type: Component, args: [{
                    selector: 'column-group-setting',
                    template: "<div #groupingSetting class=\"d-flex flex-column flex-fill column-group-setting\">\r\n\r\n    <div region=\"north\" class=\"north d-flex flex-column group-fields\" style=\"height: 78px; \">\r\n        <div class=\"title\">\r\n            {{'datagrid.settings.grouppingField' | locale }}\r\n            <span class=\"text-warning\"> ({{'datagrid.settings.moreGrouppingFieldWarningMessage' | locale }})</span>\r\n        </div>\r\n        <div #groupfieldcontainer class=\"flex-fill p-2 all-fields\">\r\n            <ul class=\"list-group\" style=\"display: inline-block;\"  column-group-drag (drop)=\"onGroupingFieldDropped($event)\">\r\n                <li class=\"list-group-item list-group-item-action btn btn-light smooth-dnd-draggable-wrapper group-field\"\r\n                *ngFor=\"let item of groupColumns\">\r\n                    {{ item.title }}\r\n                    <span class=\"f-icon f-icon-close\" style=\"cursor: pointer;\" title=\"{{'datagrid.settings.removeGrouppingFieldTip' | locale }}\" (click)=\"onRemoveGroupingField($event, item)\"></span>\r\n                </li>\r\n\r\n                <li class=\"list-group-item list-group-item-action btn btn-light btn-add-groupfield\" title=\"{{'datagrid.settings.addGrouppingFieldTip' | locale }}\"\r\n                    *ngIf=\"!groupFields || groupFields.length < 3\" (click)=\"toggleGroupingColumnPanel($event)\">\r\n                   <span class=\"f-icon f-icon-add\" style=\"font-size: 24px;\"></span>\r\n                </li>\r\n            </ul>\r\n            <div #selectcolumnspanel class=\"group-field-panel\" [style.display]=\"showSelectColumnsPanel? '': 'none'\"\r\n            [style.width.px]=\"groupfieldcontainer.offsetWidth - 16\">\r\n                <ul class=\"list-group\">\r\n                    <li class=\"list-group-item list-group-item-action btn btn-light\" *ngFor=\"let item of allowGroupColumns\"\r\n                    (click)=\"addGroupColumn($event, item)\" [style.display]=\"groupFields?.indexOf(item.field) > -1 ? 'none': ''\">\r\n                        {{ item.title }}\r\n                    </li>\r\n                </ul>\r\n\r\n            </div>\r\n        </div>\r\n\r\n    </div>\r\n    <div region=\"center\" class=\"center  d-flex flex-column flex-fill\" style=\"overflow:hidden;\">\r\n        <div class=\"group-sum-fields\">\r\n            {{'datagrid.settings.grouppingSummary' | locale}}\r\n        </div>\r\n        <div class=\"flex-fill p-2\" style=\" background-color: #fff; overflow: auto;\">\r\n            <div class=\"d-flex flex-row flex-fill dg-column-format-setting\" style=\"height: 100%\">\r\n                <div region=\"west\" class=\"west d-flex flex-column\" style=\"width: 360px; min-width:260px;overflow: hidden;\">\r\n                    <div style=\"overflow: auto;padding-right: 5px;\" class=\"flex-fill\">\r\n                        <ul class=\"list-group  list-group-flush\">\r\n                            <li class=\"list-group-item list-group-item-action format-setting-column\"\r\n                            *ngFor=\"let item of formatColumns\"\r\n                            [class.active]=\"activeCalculationCol && activeCalculationCol.field === item.field\"\r\n                            (click)=\"onFieldClick($event, item)\"\r\n                             >\r\n                                {{ item.title }}\r\n                            </li>\r\n                        </ul>\r\n                    </div>\r\n                 \r\n                </div>\r\n                <div region=\"center\" class=\"center flex-fill\" style=\"overflow:auto;padding: 0 10px; padding-left: 20px\">\r\n                    <form #groupSumform=\"ngForm\">\r\n                        <div class=\"farris-group-wrap\">\r\n                            <div class=\"form-group farris-form-group\">\r\n                                <label for=\"hpinput01\" class=\"col-form-label\">\r\n                                    <span class=\"farris-label-text\">{{'datagrid.settings.grouppingSummaryType' | locale}}</span>\r\n                                </label>\r\n                                <div class=\"farris-input-wrap\">\r\n                                   \r\n                                    <farris-combo-list name=\"groupFooter.options.calculationType\" \r\n                                    [data]=\" activeCalculationCol?.dataType === 'number'?  summaryItems : summaryItems2 \" \r\n                                    [editable]=\"false\"\r\n                                    [(ngModel)]=\"activeCalculationCol?.groupFooter.options.calculationType\"\r\n                                    [idField]=\"'value'\"\r\n                                    [textField]=\"'title'\"\r\n                                    [enableClear]=\"false\"></farris-combo-list>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"farris-group-wrap\" *ngIf=\"activeCalculationCol?.groupFooter.options.calculationType == -1\">\r\n                            <div class=\"form-group farris-form-group\">\r\n                                <label for=\"hpinput01\" class=\"col-form-label\">\r\n                                    <span class=\"farris-label-text\">{{'datagrid.settings.grouppingSummaryText' | locale}}</span>\r\n                                </label>\r\n                                <div class=\"farris-input-wrap\">\r\n                                    <input type=\"input\" name=\"groupFooter.options.text\" class=\"form-control\" [(ngModel)]=\"activeCalculationCol?.groupFooter.options.text\">\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    </form>\r\n                </div>\r\n               \r\n            </div>\r\n\r\n\r\n\r\n        </div>\r\n    </div>\r\n\r\n</div>",
                    styles: ["\n        .column-group-setting{ height: 100%; background-color: #ffffff; padding: 0 10px 10px 10px}\n        .smooth-dnd-ghost.group-field {\n            z-index: 999999999 !important;\n        }\n        .active {\n            background-color: rgb(231 241 255);\n            color: rgb(0 0 0);\n        }\n        .column-group-setting .group-field {\n            float: left;max-width: 200px;margin-right: 10px;\n            width: auto; padding: 5px;padding-right: 30px;\n            border-radius: 20px;padding-left: 10px; cursor:move\n        }\n        .group-field .f-icon { position: absolute;right: 2px;top: 7px; }\n        .btn-add-groupfield{float: left;width: 32px;padding: 0px;padding-top: 3px; border-radius: 20px;}\n        .group-field-panel{\n            height: 260px; border-radius: 5px; z-index: 3;position: absolute;\n            background: rgb(255 255 255); box-shadow: 1px 1px 4px rgb(156 155 155 / 75%);\n            overflow: hidden;\n            overflow-y: auto;\n        }\n        .group-field-panel ul {\n            display: inline-block;margin: 20px;margin-top: 5px;\n        }\n        .group-field-panel li {\n            float: left; cursor: pointer;max-width: 200px;margin-right: 10px;width: auto;\n            padding: 10px; min-width: 80px; margin-top: 15px; text-align: center;\n        }\n        .format-setting-column {\n            background: rgba(247,248,251,0.6);\n            padding: 7px 10px;\n            margin-bottom: 5px;\n            border: 1px solid rgba(233,236,243,0.45);\n            border-radius: 5px;\n        }\n        .format-setting-column.active {\n            border: 1px solid rgb(42 135 255);\n            background: rgb(239 247 255);\n            border-top: 1px solid rgb(42 135 255)!important;\n            border-bottom: 1px solid rgb(42 135 255)!important;\n        }\n\n        "]
                }] }
    ];
    /** @nocollapse */
    ColumnGroupSettingComponent.ctorParameters = function () { return [
        { type: Injector },
        { type: DatagridSettingsComponent },
        { type: ChangeDetectorRef }
    ]; };
    ColumnGroupSettingComponent.propDecorators = {
        columns: [{ type: Input }],
        fields: [{ type: Input }],
        formatColumns: [{ type: Input }],
        groupFields: [{ type: Input }],
        groupFieldsChange: [{ type: Output }],
        formatColumnsChange: [{ type: Output }],
        groupingSettingEl: [{ type: ViewChild, args: ['groupingSetting',] }],
        selectcolumnspanel: [{ type: ViewChild, args: ['selectcolumnspanel',] }],
        colForm: [{ type: ViewChild, args: ['groupSumform',] }]
    };
    return ColumnGroupSettingComponent;
}());
export { ColumnGroupSettingComponent };
if (false) {
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.columns;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.fields;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.formatColumns;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.groupFields;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.groupFieldsChange;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.formatColumnsChange;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.groupingSettingEl;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.selectcolumnspanel;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.colForm;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.groupColumns;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.allowGroupColumns;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.activeCalculationCol;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.showSelectColumnsPanel;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.summaryItems;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.summaryItems2;
    /**
     * @type {?}
     * @private
     */
    ColumnGroupSettingComponent.prototype.injector;
    /** @type {?} */
    ColumnGroupSettingComponent.prototype.gridSettingComponentRef;
    /**
     * @type {?}
     * @private
     */
    ColumnGroupSettingComponent.prototype.cd;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1uLWdyb3VwLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQtc2V0dGluZ3MvIiwic291cmNlcyI6WyJsaWIvY29sdW1uLWdyb3VwL2NvbHVtbi1ncm91cC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLEtBQUssRUFBRSxRQUFRLEVBQUUsaUJBQWlCLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUE0QixNQUFNLGVBQWUsQ0FBQztBQUM3SixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEMsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFFM0U7SUF1RUkscUNBQW9CLFFBQWtCLEVBQVMsdUJBQWtELEVBQVUsRUFBcUI7UUFBNUcsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFTLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBMkI7UUFBVSxPQUFFLEdBQUYsRUFBRSxDQUFtQjtRQW5CdkgsV0FBTSxHQUFHLEVBQUUsQ0FBQztRQUNaLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBRW5CLGdCQUFXLEdBQUcsRUFBRSxDQUFDO1FBRWhCLHNCQUFpQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdkMsd0JBQW1CLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU1uRCxpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQixzQkFBaUIsR0FBRyxFQUFFLENBQUM7UUFDdkIseUJBQW9CLEdBQUcsSUFBSSxDQUFDO1FBRTVCLDJCQUFzQixHQUFHLEtBQUssQ0FBQztRQUMvQixpQkFBWSxHQUFHLEVBQUUsQ0FBQztRQUNsQixrQkFBYSxHQUFHLEVBQUUsQ0FBQztJQUNpSCxDQUFDOzs7O0lBRXJJLDhDQUFROzs7SUFBUjtRQUFBLGlCQW9CQztRQWxCRyxJQUFJLENBQUMsWUFB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WUFBWSxFQUFFLENBQUMsQ0FBQztRQUM1RCxDQUFBLEtBQUEsSUFBSSxDQUFDLFdBQVcsQ0FBQSxDQUFDLE1BQU0sNkJBQUMsVUFBVSxFQUFFLENBQUMsR0FBSyxXQUFXLEdBQUU7UUFDdkQsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzNCLENBQUM7Ozs7OztJQUVELGtEQUFZOzs7OztJQUFaLFVBQWEsTUFBTSxFQUFFLEdBQUc7UUFDcEIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEdBQUcsQ0FBQztJQUNwQyxDQUFDOztnQkF4TUosU0FBUyxTQUFDO29CQUNQLFFBQVEsRUFBRSxzQkFBc0I7b0JBQ2hDLG16TEFBNEM7NkJBRXhDLG8wREEyQ0M7aUJBRVI7Ozs7Z0JBckRrQyxRQUFRO2dCQUVsQyx5QkFBeUI7Z0JBRlcsaUJBQWlCOzs7MEJBdUR6RCxLQUFLO3lCQUNMLEtBQUs7Z0NBQ0wsS0FBSzs4QkFFTCxLQUFLO29DQUVMLE1BQU07c0NBQ04sTUFBTTtvQ0FFTixTQUFTLFNBQUMsaUJBQWlCO3FDQUMzQixTQUFTLFNBQUMsb0JBQW9COzBCQUM5QixTQUFTLFNBQUMsY0FBYzs7SUEySTdCLGtDQUFDO0NBQUEsQUF6TUQsSUF5TUM7U0F2SlksMkJBQTJCOzs7SUFDcEMsOENBQWlCOztJQUNqQiw2Q0FBcUI7O0lBQ3JCLG9EQUE0Qjs7SUFFNUIsa0RBQTBCOztJQUUxQix3REFBaUQ7O0lBQ2pELDBEQUFtRDs7SUFFbkQsd0RBQTREOztJQUM1RCx5REFBZ0U7O0lBQ2hFLDhDQUEyQzs7SUFFM0MsbURBQWtCOztJQUNsQix3REFBdUI7O0lBQ3ZCLDJEQUE0Qjs7SUFFNUIsNkRBQStCOztJQUMvQixtREFBa0I7O0lBQ2xCLG9EQUFtQjs7Ozs7SUFDUCwrQ0FBMEI7O0lBQUUsOERBQXlEOzs7OztJQUFFLHlDQUE2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBJbnB1dCwgSW5qZWN0b3IsIENoYW5nZURldGVjdG9yUmVmLCBFbGVtZW50UmVmLCBWaWV3Q2hpbGQsIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZFNldHRpbmdzQ29tcG9uZW50IH0gZnJvbSAnLi4vZGF0YWdyaWQtc2V0dGluZ3MuY29tcG9uZW50JztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICdjb2x1bW4tZ3JvdXAtc2V0dGluZycsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vY29sdW1uLWdyb3VwLmNvbXBvbmVudC5odG1sJyxcclxuICAgIHN0eWxlczogW1xyXG4gICAgICAgIGBcclxuICAgICAgICAuY29sdW1uLWdyb3VwLXNldHRpbmd7IGhlaWdodDogMTAwJTsgYmFja2dyb3VuZC1jb2xvcjogI2ZmZmZmZjsgcGFkZGluZzogMCAxMHB4IDEwcHggMTBweH1cclxuICAgICAgICAuc21vb3RoLWRuZC1naG9zdC5ncm91cC1maWVsZCB7XHJcbiAgICAgICAgICAgIHotaW5kZXg6IDk5OTk5OTk5OSAhaW1wb3J0YW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICAuYWN0aXZlIHtcclxuICAgICAgICAgICAgYmFja2dyb3VuZC1jb2xvcjogcmdiKDIzMSAyNDEgMjU1KTtcclxuICAgICAgICAgICAgY29sb3I6IHJnYigwIDAgMCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC5jb2x1bW4tZ3JvdXAtc2V0dGluZyAuZ3JvdXAtZmllbGQge1xyXG4gICAgICAgICAgICBmbG9hdDogbGVmdDttYXgtd2lkdGg6IDIwMHB4O21hcmdpbi1yaWdodDogMTBweDtcclxuICAgICAgICAgICAgd2lkdGg6IGF1dG87IHBhZGRpbmc6IDVweDtwYWRkaW5nLXJpZ2h0OiAzMHB4O1xyXG4gICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyMHB4O3BhZGRpbmctbGVmdDogMTBweDsgY3Vyc29yOm1vdmVcclxuICAgICAgICB9XHJcbiAgICAgICAgLmdyb3VwLWZpZWxkIC5mLWljb24geyBwb3NpdGlvbjogYWJzb2x1dGU7cmlnaHQ6IDJweDt0b3A6IDdweDsgfVxyXG4gICAgICAgIC5idG4tYWRkLWdyb3VwZmllbGR7ZmxvYXQ6IGxlZnQ7d2lkdGg6IDMycHg7cGFkZGluZzogMHB4O3BhZGRpbmctdG9wOiAzcHg7IGJvcmRlci1yYWRpdXM6IDIwcHg7fVxyXG4gICAgICAgIC5ncm91cC1maWVsZC1wYW5lbHtcclxuICAgICAgICAgICAgaGVpZ2h0OiAyNjBweDsgYm9yZGVyLXJhZGl1czogNXB4OyB6LWluZGV4OiAzO3Bvc2l0aW9uOiBhYnNvbHV0ZTtcclxuICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiKDI1NSAyNTUgMjU1KTsgYm94LXNoYWRvdzogMXB4IDFweCA0cHggcmdiKDE1NiAxNTUgMTU1IC8gNzUlKTtcclxuICAgICAgICAgICAgb3ZlcmZsb3c6IGhpZGRlbjtcclxuICAgICAgICAgICAgb3ZlcmZsb3cteTogYXV0bztcclxuICAgICAgICB9XHJcbiAgICAgICAgLmdyb3VwLWZpZWxkLXBhbmVsIHVsIHtcclxuICAgICAgICAgICAgZGlzcGxheTogaW5saW5lLWJsb2NrO21hcmdpbjogMjBweDttYXJnaW4tdG9wOiA1cHg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC5ncm91cC1maWVsZC1wYW5lbCBsaSB7XHJcbiAgICAgICAgICAgIGZsb2F0OiBsZWZ0OyBjdXJzb3I6IHBvaW50ZXI7bWF4LXdpZHRoOiAyMDBweDttYXJnaW4tcmlnaHQ6IDEwcHg7d2lkdGg6IGF1dG87XHJcbiAgICAgICAgICAgIHBhZGRpbmc6IDEwcHg7IG1pbi13aWR0aDogODBweDsgbWFyZ2luLXRvcDogMTVweDsgdGV4dC1hbGlnbjogY2VudGVyO1xyXG4gICAgICAgIH1cclxuICAgICAgICAuZm9ybWF0LXNldHRpbmctY29sdW1uIHtcclxuICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyNDcsMjQ4LDI1MSwwLjYpO1xyXG4gICAgICAgICAgICBwYWRkaW5nOiA3cHggMTBweDtcclxuICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogNXB4O1xyXG4gICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDIzMywyMzYsMjQzLDAuNDUpO1xyXG4gICAgICAgICAgICBib3JkZXItcmFkaXVzOiA1cHg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC5mb3JtYXQtc2V0dGluZy1jb2x1bW4uYWN0aXZlIHtcclxuICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmdiKDQyIDEzNSAyNTUpO1xyXG4gICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2IoMjM5IDI0NyAyNTUpO1xyXG4gICAgICAgICAgICBib3JkZXItdG9wOiAxcHggc29saWQgcmdiKDQyIDEzNSAyNTUpIWltcG9ydGFudDtcclxuICAgICAgICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHJnYig0MiAxMzUgMjU1KSFpbXBvcnRhbnQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBgXHJcbiAgICBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDb2x1bW5Hcm91cFNldHRpbmdDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XHJcbiAgICBASW5wdXQoKSBjb2x1bW5zO1xyXG4gICAgQElucHV0KCkgZmllbGRzID0gW107XHJcbiAgICBASW5wdXQoKSBmb3JtYXRDb2x1bW5zID0gW107XHJcblxyXG4gICAgQElucHV0KCkgZ3JvdXBGaWVsZHMgPSBbXTtcclxuXHJcbiAgICBAT3V0cHV0KCkgZ3JvdXBGaWVsZHNDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICBAT3V0cHV0KCkgZm9ybWF0Q29sdW1uc0NoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcclxuXHJcbiAgICBAVmlld0NoaWxkKCdncm91cGluZ1NldHRpbmcnKSBncm91cGluZ1NldHRpbmdFbDogRWxlbWVudFJlZjtcclxuICAgIEBWaWV3Q2hpbGQoJ3NlbGVjdGNvbHVtbnNwYW5lbCcpIHNlbGVjdGNvbHVtbnNwYW5lbDogRWxlbWVudFJlZjtcclxuICAgIEBWaWV3Q2hpbGQoJ2dyb3VwU3VtZm9ybScpIGNvbEZvcm06IE5nRm9ybTtcclxuXHJcbiAgICBncm91cENvbHVtbnMgPSBbXTtcclxuICAgIGFsbG93R3JvdXBDb2x1bW5zID0gW107XHJcbiAgICBhY3RpdmVDYWxjdWxhdGlvbkNvbCA9IG51bGw7XHJcblxyXG4gICAgc2hvd1NlbGVjdENvbHVtbnNQYW5lbCA9IGZhbHNlO1xyXG4gICAgc3VtbWFyeUl0ZW1zID0gW107XHJcbiAgICBzdW1tYXJ5SXRlbXMyID0gW107XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHVibGljIGdyaWRTZXR0aW5nQ29tcG9uZW50UmVmOiBEYXRhZ3JpZFNldHRpbmdzQ29tcG9uZW50LCBwcml2YXRlIGNkOiBDaGFuZ2VEZXRlY3RvclJlZikgeyB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcblxyXG4gICAgICAgIHRoaXMuc3VtbWFyeUl0ZW1zID0gdGhpcy5ncmlkU2V0dGluZ0NvbXBvbmVudFJlZi5zdW1tYXJ5SXRlbXM7XHJcbiAgICAgICAgdGhpcy5zdW1tYXJ5SXRlbXMyID0gdGhpcy5ncmlkU2V0dGluZ0NvbXBvbmVudFJlZi5zdW1tYXJ5SXRlbXMyO1xyXG5cclxuICAgICAgICB0aGlzLnNldEdyb3VwQ29sdW1ucygpO1xyXG4gICAgICAgIHRoaXMucmVnaXN0ZXJFdmVudEhhbmRsZSgpO1xyXG4gICAgICAgIHRoaXMuaW5pdENhbGN1bGF0aW9uQ29sdW1ucygpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5jb2xGb3JtKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sRm9ybS52YWx1ZUNoYW5nZXMuc3Vic2NyaWJlKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbEZvcm0ucHJpc3RpbmUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZvcm1hdENvbHVtbnNDaGFuZ2UuZW1pdCh0aGlzLmZvcm1hdENvbHVtbnMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5mb3JtYXRDb2x1bW5zLmZvckVhY2gobiA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuY2hlY2tDb2x1bW5PcHRpb25zKG4pO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy5mb3JtYXRDb2x1bW5zICYmICFjaGFuZ2VzLmZvcm1hdENvbHVtbnMuaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9ybWF0Q29sdW1ucy5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jaGVja0NvbHVtbk9wdGlvbnMobik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNldEdyb3VwQ29sdW1ucygpO1xyXG4gICAgICAgICAgICB0aGlzLmluaXRDYWxjdWxhdGlvbkNvbHVtbnMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0Q2FsY3VsYXRpb25Db2x1bW5zKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmZvcm1hdENvbHVtbnMpIHtcclxuICAgICAgICAgICAgdGhpcy5hY3RpdmVDYWxjdWxhdGlvbkNvbCA9IHRoaXMuZm9ybWF0Q29sdW1uc1swXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZWdpc3RlckV2ZW50SGFuZGxlKCkge1xyXG4gICAgICAgIHRoaXMuZ3JvdXBpbmdTZXR0aW5nRWwubmF0aXZlRWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlLnRhcmdldCAgIT09IHRoaXMuc2VsZWN0Y29sdW1uc3BhbmVsLm5hdGl2ZUVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd1NlbGVjdENvbHVtbnNQYW5lbCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2V0R3JvdXBDb2x1bW5zKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmdyb3VwRmllbGRzICYmIHRoaXMuZ3JvdXBGaWVsZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ3JvdXBDb2x1bW5zID0gdGhpcy5ncm91cEZpZWxkcy5tYXAoIGYgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29sdW1uc1swXS5maW5kKGNvbCA9PiBjb2wuZmllbGQgPT09IGYpO1xyXG4gICAgICAgICAgICB9KS5maWx0ZXIobiA9PiBuKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmdyb3VwQ29sdW1ucyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm9uR3JvdXBGaWVsZHNDaGFuZ2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEFsbG93R3JvdXBpbmdDb2x1bW5zKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmNvbHVtbnNbMF0uZmlsdGVyKG4gPT4gbi5hbGxvd0dyb3VwaW5nIHx8IG4uYWxsb3dHcm91cGluZyA9PT0gdW5kZWZpbmVkKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uR3JvdXBGaWVsZHNDaGFuZ2UoKSB7XHJcbiAgICAgICAgdGhpcy5ncm91cEZpZWxkc0NoYW5nZS5lbWl0KHRoaXMuZ3JvdXBGaWVsZHMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2hlY2tDb2x1bW5PcHRpb25zKGNvbCkge1xyXG4gICAgICAgIGlmIChjb2wpIHtcclxuXHJcbiAgICAgICAgICAgIGlmIChjb2wuZ3JvdXBGb290ZXIgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgY29sLmdyb3VwRm9vdGVyID0geyBvcHRpb25zOiB7Y2FsY3VsYXRpb25UeXBlOiAtMX0gfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbC5ncm91cEZvb3Rlci5vcHRpb25zID0gY29sLmdyb3VwRm9vdGVyLm9wdGlvbnMgfHwge2NhbGN1bGF0aW9uVHlwZTogLTF9O1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbC5ncm91cEZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29sLmdyb3VwRm9vdGVyLm9wdGlvbnMuY2FsY3VsYXRpb25UeXBlID0gLTE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIGlmICh0aGlzLmFjdGl2ZUZpZWxkLmZvb3RlciA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmFjdGl2ZUZpZWxkLmZvb3RlciA9ICB7IG9wdGlvbnM6IHtjYWxjdWxhdGlvblR5cGU6IC0xfSB9O1xyXG4gICAgICAgICAgICAvLyB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy5hY3RpdmVGaWVsZC5mb290ZXIub3B0aW9ucyA9IHRoaXMuYWN0aXZlRmllbGQuZm9vdGVyLm9wdGlvbnMgfHwge2NhbGN1bGF0aW9uVHlwZTogLTF9O1xyXG4gICAgICAgICAgICAvLyAgICAgaWYgKHRoaXMuYWN0aXZlRmllbGQuZm9vdGVyLm9wdGlvbnMuY2FsY3VsYXRpb25UeXBlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgLy8gICAgICAgICB0aGlzLmFjdGl2ZUZpZWxkLmZvb3Rlci5vcHRpb25zLmNhbGN1bGF0aW9uVHlwZSA9IC0xO1xyXG4gICAgICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5pi+56S65oiW6ZqQ6JeP5a2X5q616YCJ5Y+W6Z2i5p2/XHJcbiAgICAgKi9cclxuICAgIHRvZ2dsZUdyb3VwaW5nQ29sdW1uUGFuZWwoJGV2ZW50KSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIHRoaXMuc2hvd1NlbGVjdENvbHVtbnNQYW5lbCA9ICF0aGlzLnNob3dTZWxlY3RDb2x1bW5zUGFuZWw7XHJcbiAgICAgICAgdGhpcy5hbGxvd0dyb3VwQ29sdW1ucyA9IHRoaXMuZ2V0QWxsb3dHcm91cGluZ0NvbHVtbnMoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5re75Yqg5YiG57uE5a2X5q61ICovXHJcbiAgICBhZGRHcm91cENvbHVtbigkZXZlbnQsIGNvbCkge1xyXG4gICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICBpZiAodGhpcy5ncm91cEZpZWxkcy5pbmRleE9mKGNvbC5maWVsZCkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZ3JvdXBDb2x1bW5zID0gWy4uLnRoaXMuZ3JvdXBDb2x1bW5zLCBjb2xdO1xyXG4gICAgICAgICAgICB0aGlzLmdyb3VwRmllbGRzID0gdGhpcy5ncm91cENvbHVtbnMubWFwKG4gPT4gbi5maWVsZCk7XHJcbiAgICAgICAgICAgIHRoaXMub25Hcm91cEZpZWxkc0NoYW5nZSgpO1xyXG4gICAgICAgICAgICB0aGlzLnNob3dTZWxlY3RDb2x1bW5zUGFuZWwgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOenu+mZpOWIhue7hOWtl+autSAqL1xyXG4gICAgb25SZW1vdmVHcm91cGluZ0ZpZWxkKCRldmVudCwgY29sKSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIHRoaXMuZ3JvdXBGaWVsZHMgPSB0aGlzLmdyb3VwRmllbGRzLmZpbHRlcihuID0+IG4gIT09IGNvbC5maWVsZCk7XHJcbiAgICAgICAgdGhpcy5zZXRHcm91cENvbHVtbnMoKTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5ouW5Yqo5YiG57uE5a2X5q616L+b6KGM5o6S5bqPICovXHJcbiAgICBvbkdyb3VwaW5nRmllbGREcm9wcGVkKCRldmVudCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKCdncm91cGluZyBmaWVsZCBkcm9wZWQuJywgJGV2ZW50KTtcclxuICAgICAgICBjb25zdCB7IHJlbW92ZWRJbmRleCwgYWRkZWRJbmRleCB9ID0gJGV2ZW50O1xyXG5cclxuICAgICAgICBjb25zdCByZW1vdmVkSXRlbSA9IHRoaXMuZ3JvdXBGaWVsZHMuc3BsaWNlKHJlbW92ZWRJbmRleCwgMSk7XHJcbiAgICAgICAgdGhpcy5ncm91cEZpZWxkcy5zcGxpY2UoYWRkZWRJbmRleCwgMCwgLi4ucmVtb3ZlZEl0ZW0pO1xyXG4gICAgICAgIHRoaXMuc2V0R3JvdXBDb2x1bW5zKCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25GaWVsZENsaWNrKCRldmVudCwgY29sKSB7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVDYWxjdWxhdGlvbkNvbCA9IGNvbDtcclxuICAgIH1cclxufVxyXG4iXX0=