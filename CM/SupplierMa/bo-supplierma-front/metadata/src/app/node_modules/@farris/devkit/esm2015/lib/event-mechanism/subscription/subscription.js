import { Injectable } from '@angular/core';
import { MetadataUtil } from '../../metadata/index';
import { NG_SUBSCRIPTION } from './subscription_decorator';
class Subscription {
    /**
     * 初始化
     */
    init(frameComponent) {
        if (!frameComponent) {
            return;
        }
        return this.bindSubscription(frameComponent, null);
    }
    /**
     *  根据订阅列表进行初始化
     * @param frameComponent
     * @param ngEvents 订阅列表
     * @returns eventPipes
     */
    initWithSubscriptions(frameComponent, ngEvents) {
        if (!frameComponent) {
            return;
        }
        return this.bindSubscription(frameComponent, ngEvents);
    }
    bindSubscription(frameComponent, ngEvents) {
        const context = frameComponent.context;
        if (!context) {
            return;
        }
        const ngEventHandlerProps = ngEvents ? ngEvents : this.getNgEvents(frameComponent);
        if (!ngEventHandlerProps) {
            return;
        }
        const eventPipes = [];
        Object.keys(ngEventHandlerProps).forEach((propertyName) => {
            const ngImportEvent = ngEventHandlerProps[propertyName];
            // 获取待订阅方法详情，尝试执行订阅
            const targetContext = context;
            const receiver = frameComponent;
            const emitter = ngImportEvent.token;
            const tokenValue = ngImportEvent.token;
            const eventName = ngImportEvent.name;
            const paramMapCollection = ngImportEvent.paramMapCollection;
            const eventPipe = targetContext.eventBus.on(emitter, tokenValue, eventName, receiver, (eventArgs) => {
                this.subscriptionHandler(eventArgs, paramMapCollection, targetContext);
                const eventHandler = frameComponent[eventName];
                if (!eventHandler) {
                    return;
                }
                try {
                    eventHandler(receiver, eventArgs);
                }
                catch (_a) {
                    throw new Error('Error invoking method ' + eventName);
                }
            });
            eventPipes.push(eventPipe);
        });
        return eventPipes;
    }
    /**
     * 获取组件订阅列表
     * @param frameComponent 表单component
     * @returns 组件订阅列表信息
     */
    getNgEvents(frameComponent) {
        return MetadataUtil.getPropsMetadatasByName(frameComponent.constructor, NG_SUBSCRIPTION);
    }
    subscriptionHandler(param, paramMapCollection, currentFrameContext) {
        if (!param || !paramMapCollection || paramMapCollection.length <= 0 || !currentFrameContext) {
            return;
        }
        this.paramMap2UiState(param, paramMapCollection, currentFrameContext);
    }
    /**
     * 设置paramMap后，将param映射到UISTATE上
     */
    paramMap2UiState(param, paramMapCollection, currentFrameContext) {
        for (let i = 0; i < paramMapCollection.length; i++) {
            const from = paramMapCollection[i].from;
            const frameId = paramMapCollection[i].frameId;
            const to = paramMapCollection[i].to;
            if (!from || !frameId || !to) {
                continue;
            }
            const destContext = this.getFrameContext(frameId, currentFrameContext);
            if (destContext == null) {
                continue;
            }
            this.setUiStateProperty(to, param[from], destContext.uiState);
            // this.setUiStateProperty(to, param[from], currentFrameContext.uiState);
        }
    }
    getFrameContext(targetFrameContextId, currentContext) {
        let destContext = null;
        try {
            destContext = currentContext.appContext.getFrameContext(targetFrameContextId);
        }
        catch (_a) {
            throw new Error('Error in Getting FrameContext');
        }
        return destContext;
    }
    setUiStateProperty(propertyName, propertyValue, uiState) {
        try {
            uiState.setPropertyValue(propertyName, propertyValue);
        }
        catch (_a) {
            throw new Error("Error in Setting Property Value of the current UISTATE" + uiState);
        }
    }
}
Subscription.decorators = [
    { type: Injectable }
];
export { Subscription };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Vic2NyaXB0aW9uLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtbWVjaGFuaXNtL3N1YnNjcmlwdGlvbi9zdWJzY3JpcHRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHcEQsT0FBTyxFQUFFLGVBQWUsRUFBNEIsTUFBTSwwQkFBMEIsQ0FBQztBQUdyRixNQUNNLFlBQVk7SUFFaEI7O09BRUc7SUFDSSxJQUFJLENBQUMsY0FBOEI7UUFDeEMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFFRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUdEOzs7OztPQUtHO0lBQ0kscUJBQXFCLENBQUMsY0FBOEIsRUFBRSxRQUU1RDtRQUNDLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDbkIsT0FBTztTQUNSO1FBRUQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxjQUE4QixFQUFFLFFBRXhEO1FBQ0MsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQztRQUN2QyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osT0FBTztTQUNSO1FBRUQsTUFBTSxtQkFBbUIsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNuRixJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDeEIsT0FBTztTQUNSO1FBRUQsTUFBTSxVQUFVLEdBQWtCLEVBQUUsQ0FBQztRQUNyQyxNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsWUFBb0IsRUFBRSxFQUFFO1lBQ2hFLE1BQU0sYUFBYSxHQUFtQixtQkFBbUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUV4RSxtQkFBbUI7WUFDbkIsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDO1lBRTlCLE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQztZQUNoQyxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDO1lBQ3BDLE1BQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUM7WUFDdkMsTUFBTSxTQUFTLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQztZQUVyQyxNQUFNLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQztZQUM1RCxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQ2xGLENBQUMsU0FBUyxFQUFFLEVBQUU7Z0JBQ1osSUFBSSxDQUFDLG1CQUFtQixDQUFDLFNBQVMsRUFBRSxrQkFBa0IsRUFBRSxhQUFhLENBQUMsQ0FBQztnQkFFdkUsTUFBTSxZQUFZLEdBQWEsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN6RCxJQUFJLENBQUMsWUFBWSxFQUFFO29CQUNqQixPQUFPO2lCQUNSO2dCQUVELElBQUk7b0JBQ0YsWUFBWSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztpQkFDbkM7Z0JBQUMsV0FBTTtvQkFDTixNQUFNLElBQUksS0FBSyxDQUFDLHdCQUF3QixHQUFHLFNBQVMsQ0FBQyxDQUFDO2lCQUN2RDtZQUNILENBQUMsQ0FDRixDQUFDO1lBRUYsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7OztPQUlHO0lBQ0ksV0FBVyxDQUFDLGNBQThCO1FBQy9DLE9BQU8sWUFBWSxDQUFDLHVCQUF1QixDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDM0YsQ0FBQztJQUVPLG1CQUFtQixDQUFDLEtBQVUsRUFBRSxrQkFBOEIsRUFBRSxtQkFBaUM7UUFFdkcsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLGtCQUFrQixJQUFJLGtCQUFrQixDQUFDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsRUFBRTtZQUMzRixPQUFPO1NBQ1I7UUFFRCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLGtCQUFrQixFQUFFLG1CQUFtQixDQUFDLENBQUM7SUFDeEUsQ0FBQztJQUVEOztPQUVHO0lBQ0ssZ0JBQWdCLENBQUMsS0FBVSxFQUFFLGtCQUE4QixFQUFFLG1CQUFpQztRQUNwRyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ2xELE1BQU0sSUFBSSxHQUFHLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUN4QyxNQUFNLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDOUMsTUFBTSxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBRXBDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQzVCLFNBQVM7YUFDVjtZQUNELE1BQU0sV0FBVyxHQUFpQixJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3JGLElBQUksV0FBVyxJQUFJLElBQUksRUFBRTtnQkFDdkIsU0FBUzthQUNWO1lBQ0QsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzlELHlFQUF5RTtTQUMxRTtJQUNILENBQUM7SUFFTyxlQUFlLENBQUMsb0JBQTRCLEVBQUUsY0FBNEI7UUFDaEYsSUFBSSxXQUFXLEdBQWlCLElBQUksQ0FBQztRQUNyQyxJQUFJO1lBQ0YsV0FBVyxHQUFHLGNBQWMsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLG9CQUFvQixDQUFDLENBQUM7U0FDL0U7UUFBQyxXQUFNO1lBQ04sTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVPLGtCQUFrQixDQUFDLFlBQW9CLEVBQUUsYUFBcUIsRUFBRSxPQUFnQjtRQUN0RixJQUFJO1lBQ0YsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztTQUN2RDtRQUFDLFdBQU07WUFDTixNQUFNLElBQUksS0FBSyxDQUFDLHdEQUF3RCxHQUFHLE9BQU8sQ0FBQyxDQUFDO1NBQ3JGO0lBQ0gsQ0FBQzs7O1lBdklGLFVBQVU7O0FBMklYLE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uLy4uL21ldGFkYXRhL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBGcmFtZUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2ZyYW1lL2luZGV4JztcclxuaW1wb3J0IHsgVUlTdGF0ZSB9IGZyb20gJy4uLy4uL3VpLXN0YXRlL2luZGV4JztcclxuaW1wb3J0IHsgTkdfU1VCU0NSSVBUSU9OLCBOZ1N1YnNjcmlwdGlvbiwgUGFyYW1NYXAgfSBmcm9tICcuL3N1YnNjcmlwdGlvbl9kZWNvcmF0b3InO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSB9IGZyb20gJy4uLy4uL2NvcmUvaW5kZXgnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBTdWJzY3JpcHRpb24ge1xyXG5cclxuICAvKipcclxuICAgKiDliJ3lp4vljJZcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdChmcmFtZUNvbXBvbmVudDogRnJhbWVDb21wb25lbnQpOiBJRGlzcG9zYWJsZVtdIHtcclxuICAgIGlmICghZnJhbWVDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmJpbmRTdWJzY3JpcHRpb24oZnJhbWVDb21wb25lbnQsIG51bGwpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqICDmoLnmja7orqLpmIXliJfooajov5vooYzliJ3lp4vljJZcclxuICAgKiBAcGFyYW0gZnJhbWVDb21wb25lbnQgXHJcbiAgICogQHBhcmFtIG5nRXZlbnRzIOiuoumYheWIl+ihqFxyXG4gICAqIEByZXR1cm5zIGV2ZW50UGlwZXNcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdFdpdGhTdWJzY3JpcHRpb25zKGZyYW1lQ29tcG9uZW50OiBGcmFtZUNvbXBvbmVudCwgbmdFdmVudHM6IHtcclxuICAgIFtwcm9wTmFtZTogc3RyaW5nXTogYW55O1xyXG4gIH0pOiBJRGlzcG9zYWJsZVtdIHtcclxuICAgIGlmICghZnJhbWVDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmJpbmRTdWJzY3JpcHRpb24oZnJhbWVDb21wb25lbnQsIG5nRXZlbnRzKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYmluZFN1YnNjcmlwdGlvbihmcmFtZUNvbXBvbmVudDogRnJhbWVDb21wb25lbnQsIG5nRXZlbnRzOiB7XHJcbiAgICBbcHJvcE5hbWU6IHN0cmluZ106IGFueTtcclxuICB9KSB7XHJcbiAgICBjb25zdCBjb250ZXh0ID0gZnJhbWVDb21wb25lbnQuY29udGV4dDtcclxuICAgIGlmICghY29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbmdFdmVudEhhbmRsZXJQcm9wcyA9IG5nRXZlbnRzID8gbmdFdmVudHMgOiB0aGlzLmdldE5nRXZlbnRzKGZyYW1lQ29tcG9uZW50KTtcclxuICAgIGlmICghbmdFdmVudEhhbmRsZXJQcm9wcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZXZlbnRQaXBlczogSURpc3Bvc2FibGVbXSA9IFtdO1xyXG4gICAgT2JqZWN0LmtleXMobmdFdmVudEhhbmRsZXJQcm9wcykuZm9yRWFjaCgocHJvcGVydHlOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdJbXBvcnRFdmVudDogTmdTdWJzY3JpcHRpb24gPSBuZ0V2ZW50SGFuZGxlclByb3BzW3Byb3BlcnR5TmFtZV07XHJcblxyXG4gICAgICAvLyDojrflj5blvoXorqLpmIXmlrnms5Xor6bmg4XvvIzlsJ3or5XmiafooYzorqLpmIVcclxuICAgICAgY29uc3QgdGFyZ2V0Q29udGV4dCA9IGNvbnRleHQ7XHJcblxyXG4gICAgICBjb25zdCByZWNlaXZlciA9IGZyYW1lQ29tcG9uZW50O1xyXG4gICAgICBjb25zdCBlbWl0dGVyID0gbmdJbXBvcnRFdmVudC50b2tlbjtcclxuICAgICAgY29uc3QgdG9rZW5WYWx1ZSA9IG5nSW1wb3J0RXZlbnQudG9rZW47XHJcbiAgICAgIGNvbnN0IGV2ZW50TmFtZSA9IG5nSW1wb3J0RXZlbnQubmFtZTtcclxuXHJcbiAgICAgIGNvbnN0IHBhcmFtTWFwQ29sbGVjdGlvbiA9IG5nSW1wb3J0RXZlbnQucGFyYW1NYXBDb2xsZWN0aW9uO1xyXG4gICAgICBjb25zdCBldmVudFBpcGUgPSB0YXJnZXRDb250ZXh0LmV2ZW50QnVzLm9uKGVtaXR0ZXIsIHRva2VuVmFsdWUsIGV2ZW50TmFtZSwgcmVjZWl2ZXIsXHJcbiAgICAgICAgKGV2ZW50QXJncykgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25IYW5kbGVyKGV2ZW50QXJncywgcGFyYW1NYXBDb2xsZWN0aW9uLCB0YXJnZXRDb250ZXh0KTtcclxuXHJcbiAgICAgICAgICBjb25zdCBldmVudEhhbmRsZXI6IEZ1bmN0aW9uID0gZnJhbWVDb21wb25lbnRbZXZlbnROYW1lXTtcclxuICAgICAgICAgIGlmICghZXZlbnRIYW5kbGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBldmVudEhhbmRsZXIocmVjZWl2ZXIsIGV2ZW50QXJncyk7XHJcbiAgICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBpbnZva2luZyBtZXRob2QgJyArIGV2ZW50TmFtZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG5cclxuICAgICAgZXZlbnRQaXBlcy5wdXNoKGV2ZW50UGlwZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZXZlbnRQaXBlcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlue7hOS7tuiuoumYheWIl+ihqFxyXG4gICAqIEBwYXJhbSBmcmFtZUNvbXBvbmVudCDooajljZVjb21wb25lbnRcclxuICAgKiBAcmV0dXJucyDnu4Tku7borqLpmIXliJfooajkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0TmdFdmVudHMoZnJhbWVDb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50KSB7XHJcbiAgICByZXR1cm4gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKGZyYW1lQ29tcG9uZW50LmNvbnN0cnVjdG9yLCBOR19TVUJTQ1JJUFRJT04pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25IYW5kbGVyKHBhcmFtOiBhbnksIHBhcmFtTWFwQ29sbGVjdGlvbjogUGFyYW1NYXBbXSwgY3VycmVudEZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcblxyXG4gICAgaWYgKCFwYXJhbSB8fCAhcGFyYW1NYXBDb2xsZWN0aW9uIHx8IHBhcmFtTWFwQ29sbGVjdGlvbi5sZW5ndGggPD0gMCB8fCAhY3VycmVudEZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5wYXJhbU1hcDJVaVN0YXRlKHBhcmFtLCBwYXJhbU1hcENvbGxlY3Rpb24sIGN1cnJlbnRGcmFtZUNvbnRleHQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572ucGFyYW1NYXDlkI7vvIzlsIZwYXJhbeaYoOWwhOWIsFVJU1RBVEXkuIpcclxuICAgKi9cclxuICBwcml2YXRlIHBhcmFtTWFwMlVpU3RhdGUocGFyYW06IGFueSwgcGFyYW1NYXBDb2xsZWN0aW9uOiBQYXJhbU1hcFtdLCBjdXJyZW50RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1NYXBDb2xsZWN0aW9uLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IGZyb20gPSBwYXJhbU1hcENvbGxlY3Rpb25baV0uZnJvbTtcclxuICAgICAgY29uc3QgZnJhbWVJZCA9IHBhcmFtTWFwQ29sbGVjdGlvbltpXS5mcmFtZUlkO1xyXG4gICAgICBjb25zdCB0byA9IHBhcmFtTWFwQ29sbGVjdGlvbltpXS50bztcclxuXHJcbiAgICAgIGlmICghZnJvbSB8fCAhZnJhbWVJZCB8fCAhdG8pIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBkZXN0Q29udGV4dDogRnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoZnJhbWVJZCwgY3VycmVudEZyYW1lQ29udGV4dCk7XHJcbiAgICAgIGlmIChkZXN0Q29udGV4dCA9PSBudWxsKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zZXRVaVN0YXRlUHJvcGVydHkodG8sIHBhcmFtW2Zyb21dLCBkZXN0Q29udGV4dC51aVN0YXRlKTtcclxuICAgICAgLy8gdGhpcy5zZXRVaVN0YXRlUHJvcGVydHkodG8sIHBhcmFtW2Zyb21dLCBjdXJyZW50RnJhbWVDb250ZXh0LnVpU3RhdGUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHQodGFyZ2V0RnJhbWVDb250ZXh0SWQ6IHN0cmluZywgY3VycmVudENvbnRleHQ6IEZyYW1lQ29udGV4dCk6IEZyYW1lQ29udGV4dCB7XHJcbiAgICBsZXQgZGVzdENvbnRleHQ6IEZyYW1lQ29udGV4dCA9IG51bGw7XHJcbiAgICB0cnkge1xyXG4gICAgICBkZXN0Q29udGV4dCA9IGN1cnJlbnRDb250ZXh0LmFwcENvbnRleHQuZ2V0RnJhbWVDb250ZXh0KHRhcmdldEZyYW1lQ29udGV4dElkKTtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIGluIEdldHRpbmcgRnJhbWVDb250ZXh0Jyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGVzdENvbnRleHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFVpU3RhdGVQcm9wZXJ0eShwcm9wZXJ0eU5hbWU6IHN0cmluZywgcHJvcGVydHlWYWx1ZTogc3RyaW5nLCB1aVN0YXRlOiBVSVN0YXRlKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICB1aVN0YXRlLnNldFByb3BlcnR5VmFsdWUocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlKTtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciBpbiBTZXR0aW5nIFByb3BlcnR5IFZhbHVlIG9mIHRoZSBjdXJyZW50IFVJU1RBVEVcIiArIHVpU3RhdGUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IFN1YnNjcmlwdGlvbiB9O1xyXG4iXX0=