/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, Directive, HostListener, Injector, Input, NgZone, Renderer2 } from '@angular/core';
import { reqAnimFrame } from '@farris/ui-common';
import { InputGroupComponent } from '@farris/ui-input-group';
import { debounceTime, filter, map } from 'rxjs/operators';
import { LookupGridDisplayType } from '../lookup-displaytype';
import { LookupGridComponent } from '../lookup-grid.component';
import { LookupQuickSelectPanelComponent } from './quick-select-panel.component';
var LookupQuickSelectDirective = /** @class */ (function () {
    function LookupQuickSelectDirective(injector, ngzone, render, inputRef, lookupRef, cfr) {
        this.injector = injector;
        this.ngzone = ngzone;
        this.render = render;
        this.inputRef = inputRef;
        this.lookupRef = lookupRef;
        this.cfr = cfr;
    }
    /**
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.options && this.options.enable) {
            this.inputRef.inputClick.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e.stopPropagation();
                if (!_this.panelElement) {
                    // 执行帮助前
                    _this.lookupRef.dictPicking({
                        instance: _this,
                    }).subscribe((/**
                     * @param {?} pr
                     * @return {?}
                     */
                    function (pr) {
                        if (_this.lookupRef.displayType === LookupGridDisplayType.TreeList || !_this.lookupRef.singleSelect) {
                            return;
                        }
                        var _a = _this.lookupRef.dialogMgr.checkDictPickingResult(pr), show = _a.show, customData = _a.customData, message = _a.message;
                        _this.lookupRef.customData = customData;
                        if (show) {
                            _this.createDataPanel();
                        }
                        else {
                            if (message) {
                                _this.lookupRef.notifyService.warning(message);
                            }
                        }
                    }));
                }
            }));
            this.inputRef.valueChange.pipe(debounceTime(200)).subscribe((/**
             * @param {?} val
             * @return {?}
             */
            function (val) {
                _this.lookupRef.dictPicking({ instance: _this }).subscribe((/**
                 * @param {?} pr
                 * @return {?}
                 */
                function (pr) {
                    if (_this.lookupRef.displayType === LookupGridDisplayType.TreeList || !_this.lookupRef.singleSelect) {
                        return;
                    }
                    var _a = _this.lookupRef.dialogMgr.checkDictPickingResult(pr), show = _a.show, customData = _a.customData, message = _a.message;
                    _this.lookupRef.customData = customData;
                    if (!_this.panelElement) {
                        _this.createDataPanel();
                    }
                    else {
                        _this.loadData();
                    }
                }));
            }));
            this.inputRef.keydownHandle.pipe(filter((/**
             * @param {?} event
             * @return {?}
             */
            function (event) {
                return event.key === 'Escape' || event.key === 'Tab' || event.key === 'ArrowRight' || event.key === 'F2';
            }))).subscribe((/**
             * @return {?}
             */
            function () {
                _this.hide();
            }));
        }
    };
    /**
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.lookupRef.overLayService.destory(this.lookupRef.el.nativeElement);
    };
    /**
     * @private
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.removePanelElement = /**
     * @private
     * @return {?}
     */
    function () {
        document.body.removeChild(this.panelElement);
        this.panelElement = null;
    };
    /**
     * @param {?=} e
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.hide = /**
     * @param {?=} e
     * @return {?}
     */
    function (e) {
        var _this = this;
        reqAnimFrame((/**
         * @return {?}
         */
        function () {
            if (_this.panelElement) {
                if (e && (e.type === 'mousewheel' || e.type === 'wheel')) {
                    _this.removePanelElement();
                }
                else {
                    _this.panelElement.classList.remove('f-area-show');
                    setTimeout((/**
                     * @return {?}
                     */
                    function () {
                        _this.removePanelElement();
                    }), 120);
                }
                _this.lookupRef.overLayService.destory(_this.lookupRef.el.nativeElement);
            }
        }));
    };
    /**
     * @private
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.createDataPanel = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        this.panelElement = document.createElement('div');
        this.panelElement.classList.add('overlay-pane', 'f-lookup_quick-panel', 'f-area-hide');
        document.body.appendChild(this.panelElement);
        var _a = this.getPanelSize(), width = _a.width, left = _a.left, top = _a.top, height = _a.height;
        this.panelElement.style.width = width + "px";
        this.panelElement.style.height = height + "px";
        this.panelElement.style.top = top + "px";
        this.panelElement.style.left = left + "px";
        this.panelElement.style.zIndex = '10001';
        // 创建数据展示组件
        /** @type {?} */
        var cmpFact = this.cfr.resolveComponentFactory(LookupQuickSelectPanelComponent);
        this.cmpRef = cmpFact.create(this.injector);
        this.cmpRef.instance.showMore = this.options.showMore;
        this.cmpRef.instance.textField = this.lookupRef.textField;
        this.cmpRef.instance.formatter = this.options.formatter;
        // cmpRef.location.nativeElement.classList.add('farris-main-area');
        this.panelElement.appendChild(this.cmpRef.location.nativeElement);
        this.cmpRef.changeDetectorRef.detectChanges();
        // more clicked 打开帮助窗口
        this.cmpRef.instance.moreClcik.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.hide(e);
            _this.lookupRef.showDialog();
        }));
        this.cmpRef.instance.itemClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            var data = e.data;
            _this.lookupRef.selectItem(data);
            _this.hide();
        }));
        // 注册鼠标滚轮，点击事件，用于隐藏Panel
        this.lookupRef.overLayService.registerMouseEvent(this.lookupRef.el.nativeElement, (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (!_this.panelElement || e.target['closest']('.f-lookup_quick-panel')) {
                return;
            }
            if (_this.cmpRef) {
                _this.cmpRef.destroy();
                _this.cmpRef = null;
            }
            _this.hide(e);
            if (_this.lookupRef.inputGroup.textbox.nativeElement === e.target) {
                return false;
            }
        }));
        this.panelElement.classList.add('f-area-show');
        this.loadData();
    };
    /**
     * @private
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.calculationPanelHeight = /**
     * @private
     * @return {?}
     */
    function () {
        return this.options.showItemsCount * 30 + (this.options.showMore ? 50 : 0) + this.options.footerHeight + 5;
    };
    /**
     * @private
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.getInputSizeInfo = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var el = this.lookupRef.viewType === 'text' ? this.inputRef.inputGroup : this.lookupRef.tagbox;
        return el.nativeElement.getBoundingClientRect();
    };
    /**
     * @private
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.getPanelSize = /**
     * @private
     * @return {?}
     */
    function () {
        var _a = this.getInputSizeInfo(), width = _a.width, height = _a.height, top = _a.top, left = _a.left;
        /** @type {?} */
        var bottom = window.innerHeight - height - top;
        /** @type {?} */
        var panelHeight = this.calculationPanelHeight();
        /** @type {?} */
        var h = top > bottom ? top : bottom;
        if (bottom > panelHeight) {
            top = top + height;
            // 面板由上向下展开
            this.panelElement.style.transformOrigin = '100% top';
        }
        else {
            if (top > bottom) {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                    top = 10;
                }
                else {
                    top = top - parseInt('' + panelHeight, 10) - 5;
                }
                // 面板由下向上展开
                this.panelElement.style.transformOrigin = '100% bottom';
            }
            else {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                }
                top = top + height;
            }
        }
        return { width: width, top: top, height: panelHeight, left: left };
    };
    /**
     * @private
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.getData = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var p = {
            pageInfo: {
                pageSize: this.options.showItemsCount,
                pageIndex: 1,
            },
        };
        /** @type {?} */
        var t = "all";
        if (this.lookupRef.isTextChange) {
            this.lookupRef._searchState = {
                field: this.lookupRef.textField,
                //"*",
                value: this.lookupRef.displayText
            };
            p = {
                search: this.lookupRef._searchState
            };
            t = 'search';
        }
        return this.lookupRef.httpMgr.lookupRequest(p, t).pipe(map((/**
         * @param {?} restData
         * @return {?}
         */
        function (restData) {
            if (restData) {
                return restData.items || [];
            }
            if (_this.lookupRef.displayText && _this.lookupRef.isTextChange) {
                return _this.lookupRef.items.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) {
                    return n[_this.lookupRef.textField].indexOf(_this.lookupRef.displayText) > -1;
                })).slice(0, _this.options.showItemsCount);
            }
            return _this.lookupRef.items.slice(0, _this.options.showItemsCount);
        })));
    };
    /**
     * @private
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.loadData = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var loadingRef = this.lookupRef.loadingService.show({ container: this.panelElement });
        this.getData().subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            _this.cmpRef.instance.loadData(data);
            loadingRef.close();
        }));
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    LookupQuickSelectDirective.prototype.registerKeyboardEvent = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        var _this = this;
        if (!this.lookupRef.singleSelect) {
            return;
        }
        /** @type {?} */
        var rows = [];
        if (this.cmpRef) {
            rows = this.cmpRef.instance.data;
        }
        if (!rows || !rows.length) {
            return;
        }
        if ($event.code === 'ArrowUp' || $event.code === 'ArrowDown') {
            $event.preventDefault();
            $event.stopPropagation();
        }
        /** @type {?} */
        var idx = this.cmpRef.instance.activeIndex;
        /** @type {?} */
        var activeIndex = idx;
        /** @type {?} */
        var selectItem = (/**
         * @param {?} index
         * @return {?}
         */
        function (index) {
            activeIndex = index;
            _this.cmpRef.instance.setActiveItem(index);
        });
        if ($event.code === 'ArrowUp') { // up
            if (idx > -1) {
                /** @type {?} */
                var prevIdx = idx - 1;
                if (prevIdx < 0) {
                    prevIdx = rows.length - 1;
                }
                selectItem(prevIdx);
            }
            else {
                selectItem(rows.length - 1);
            }
        }
        if ($event.code === 'ArrowDown') { // down
            // down
            /** @type {?} */
            var nextIdx = idx + 1;
            if (nextIdx >= rows.length) {
                nextIdx = 0;
            }
            selectItem(nextIdx);
        }
        if ($event.key === 'Enter') {
            if (rows && rows.length) {
                /** @type {?} */
                var data = rows[idx];
                this.lookupRef.selectItem(data);
                this.hide();
            }
        }
    };
    LookupQuickSelectDirective.decorators = [
        { type: Directive, args: [{ selector: '[quick-select]' },] }
    ];
    /** @nocollapse */
    LookupQuickSelectDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: NgZone },
        { type: Renderer2 },
        { type: InputGroupComponent },
        { type: LookupGridComponent },
        { type: ComponentFactoryResolver }
    ]; };
    LookupQuickSelectDirective.propDecorators = {
        options: [{ type: Input, args: ['quick-select',] }],
        registerKeyboardEvent: [{ type: HostListener, args: ['keydown', ['$event'],] }]
    };
    return LookupQuickSelectDirective;
}());
export { LookupQuickSelectDirective };
if (false) {
    /** @type {?} */
    LookupQuickSelectDirective.prototype.options;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.panelElement;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.cmpRef;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.inputRef;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.lookupRef;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.cfr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLXF1aWNrLXNlbGVjdC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9xdWljay1zZWxlY3QvbG9va3VwLXF1aWNrLXNlbGVjdC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBaUIsd0JBQXdCLEVBQWdCLFNBQVMsRUFBYyxZQUFZLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQXFCLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsTCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDakQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFN0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0QsT0FBTyxFQUFFLHFCQUFxQixFQUFxQixNQUFNLHVCQUF1QixDQUFDO0FBRWpGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBRWpGO0lBTUksb0NBQW9CLFFBQWtCLEVBQVUsTUFBYyxFQUFVLE1BQWlCLEVBQVcsUUFBNkIsRUFBVSxTQUE4QixFQUM3SixHQUE2QjtRQURyQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFBVyxhQUFRLEdBQVIsUUFBUSxDQUFxQjtRQUFVLGNBQVMsR0FBVCxTQUFTLENBQXFCO1FBQzdKLFFBQUcsR0FBSCxHQUFHLENBQTBCO0lBQ3pDLENBQUM7Ozs7SUFFRCw2Q0FBUTs7O0lBQVI7SUFFQSxDQUFDOzs7O0lBRUQsb0RBQWU7OztJQUFmO1FBQUEsaUJBa0RDO1FBakRHLElBQUksSUFB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UUFDRCxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFLEVBQUUsT0FBTzs7O2dCQUNsQyxPQUFPLEdBQUcsR0FBRyxHQUFHLENBQUM7WUFDckIsSUFBSSxPQUFPLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDeEIsT0FBTyxHQUFHLENBQUMsQ0FBQzthQUNmO1lBRUQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ3ZCO1FBRUQsSUFBRyxNQUFNLENBQUMsR0FBRyxLQUFLLE9BQU8sRUFBRTtZQUN2QixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFOztvQkFDZixJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ2hDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQzthQUNmO1NBQ0o7SUFDTCxDQUFDOztnQkE1U0osU0FBUyxTQUFDLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFDOzs7O2dCQVg2RCxRQUFRO2dCQUFTLE1BQU07Z0JBQXFCLFNBQVM7Z0JBRWpKLG1CQUFtQjtnQkFNbkIsbUJBQW1CO2dCQVJKLHdCQUF3Qjs7OzBCQWEzQyxLQUFLLFNBQUMsY0FBYzt3Q0FrUHBCLFlBQVksU0FBQyxTQUFTLEVBQUUsQ0FBQyxRQUFRLENBQUM7O0lBeUR2QyxpQ0FBQztDQUFBLEFBN1NELElBNlNDO1NBNVNZLDBCQUEwQjs7O0lBQ25DLDZDQUFrRDs7Ozs7SUFFbEQsa0RBQWtDOzs7OztJQUNsQyw0Q0FBOEQ7Ozs7O0lBQ2xELDhDQUEwQjs7Ozs7SUFBRSw0Q0FBc0I7Ozs7O0lBQUUsNENBQXlCOzs7OztJQUFHLDhDQUFxQzs7Ozs7SUFBRSwrQ0FBc0M7Ozs7O0lBQ3JLLHlDQUFxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyVmlld0luaXQsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEhvc3RMaXN0ZW5lciwgSW5qZWN0b3IsIElucHV0LCBOZ1pvbmUsIE9uRGVzdHJveSwgT25Jbml0LCBSZW5kZXJlcjIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgcmVxQW5pbUZyYW1lIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBJbnB1dEdyb3VwQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1pbnB1dC1ncm91cCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IExvb2t1cEdyaWREaXNwbGF5VHlwZSwgUXVpY2tTZWxlY3RPcHRpb24gfSBmcm9tICcuLi9sb29rdXAtZGlzcGxheXR5cGUnO1xyXG5pbXBvcnQgeyBEaXNwbGF5SW5mbywgTE9BRF9EQVRBX1RZUEUsIExvb2t1cEdyaWRSZXN1bHQsIFBpY2tpbmdSZXN1bHQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvb2t1cFF1aWNrU2VsZWN0UGFuZWxDb21wb25lbnQgfSBmcm9tICcuL3F1aWNrLXNlbGVjdC1wYW5lbC5jb21wb25lbnQnO1xyXG5cclxuQERpcmVjdGl2ZSh7IHNlbGVjdG9yOiAnW3F1aWNrLXNlbGVjdF0nfSlcclxuZXhwb3J0IGNsYXNzIExvb2t1cFF1aWNrU2VsZWN0RGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG4gICAgQElucHV0KCdxdWljay1zZWxlY3QnKSBvcHRpb25zOiBRdWlja1NlbGVjdE9wdGlvbjtcclxuXHJcbiAgICBwcml2YXRlIHBhbmVsRWxlbWVudDogSFRNTEVsZW1lbnQ7XHJcbiAgICBwcml2YXRlIGNtcFJlZjogQ29tcG9uZW50UmVmPExvb2t1cFF1aWNrU2VsZWN0UGFuZWxDb21wb25lbnQ+O1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgbmd6b25lOiBOZ1pvbmUsIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsICBwcml2YXRlIGlucHV0UmVmOiBJbnB1dEdyb3VwQ29tcG9uZW50LCBwcml2YXRlIGxvb2t1cFJlZjogTG9va3VwR3JpZENvbXBvbmVudCxcclxuICAgICAgICBwcml2YXRlIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSB7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgXHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMgJiYgdGhpcy5vcHRpb25zLmVuYWJsZSkge1xyXG4gICAgICAgICAgICB0aGlzLmlucHV0UmVmLmlucHV0Q2xpY2suc3Vic2NyaWJlKChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOaJp+ihjOW4ruWKqeWJjVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwUmVmLmRpY3RQaWNraW5nKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2U6IHRoaXMsXHJcbiAgICAgICAgICAgICAgICAgICAgfSkuc3Vic2NyaWJlKChwcjogUGlja2luZ1Jlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29rdXBSZWYuZGlzcGxheVR5cGUgPT09IExvb2t1cEdyaWREaXNwbGF5VHlwZS5UcmVlTGlzdCB8fCAhdGhpcy5sb29rdXBSZWYuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBzaG93LCBjdXN0b21EYXRhLCBtZXNzYWdlIH0gPSB0aGlzLmxvb2t1cFJlZi5kaWFsb2dNZ3IuY2hlY2tEaWN0UGlja2luZ1Jlc3VsdChwcik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9va3VwUmVmLmN1c3RvbURhdGEgPSBjdXN0b21EYXRhO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2hvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVEYXRhUGFuZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYubm90aWZ5U2VydmljZS53YXJuaW5nKG1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmlucHV0UmVmLnZhbHVlQ2hhbmdlLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBkZWJvdW5jZVRpbWUoMjAwKVxyXG4gICAgICAgICAgICApLnN1YnNjcmliZSgodmFsOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9va3VwUmVmLmRpY3RQaWNraW5nKHtpbnN0YW5jZTogdGhpc30pLnN1YnNjcmliZSgocHI6IFBpY2tpbmdSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29rdXBSZWYuZGlzcGxheVR5cGUgPT09IExvb2t1cEdyaWREaXNwbGF5VHlwZS5UcmVlTGlzdCB8fCAhdGhpcy5sb29rdXBSZWYuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBzaG93LCBjdXN0b21EYXRhLCBtZXNzYWdlIH0gPSB0aGlzLmxvb2t1cFJlZi5kaWFsb2dNZ3IuY2hlY2tEaWN0UGlja2luZ1Jlc3VsdChwcik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYuY3VzdG9tRGF0YSA9IGN1c3RvbURhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnBhbmVsRWxlbWVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZURhdGFQYW5lbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZERhdGEoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRSZWYua2V5ZG93bkhhbmRsZS5waXBlKFxyXG4gICAgICAgICAgICAgICAgZmlsdGVyKChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldmVudC5rZXkgPT09ICdFc2NhcGUnIHx8IGV2ZW50LmtleSA9PT0gJ1RhYicgfHwgZXZlbnQua2V5ID09PSAnQXJyb3dSaWdodCcgfHwgZXZlbnQua2V5ID09PSAnRjInO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmxvb2t1cFJlZi5vdmVyTGF5U2VydmljZS5kZXN0b3J5KHRoaXMubG9va3VwUmVmLmVsLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVtb3ZlUGFuZWxFbGVtZW50KCkge1xyXG4gICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5wYW5lbEVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50ID0gbnVsbDtcclxuICAgIH1cclxuXHJcblxyXG4gICAgaGlkZShlPzogYW55KSB7XHJcbiAgICAgICAgcmVxQW5pbUZyYW1lKCgpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMucGFuZWxFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSAmJiAoIGUudHlwZSA9PT0gJ21vdXNld2hlZWwnIHx8IGUudHlwZSA9PT0gJ3doZWVsJykpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVBhbmVsRWxlbWVudCgpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKCdmLWFyZWEtc2hvdycpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVBhbmVsRWxlbWVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sMTIwKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYub3ZlckxheVNlcnZpY2UuZGVzdG9yeSh0aGlzLmxvb2t1cFJlZi5lbC5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZURhdGFQYW5lbCgpIHtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ292ZXJsYXktcGFuZScsICdmLWxvb2t1cF9xdWljay1wYW5lbCcsICdmLWFyZWEtaGlkZScpO1xyXG5cclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMucGFuZWxFbGVtZW50KTtcclxuICAgICAgICBjb25zdCB7IHdpZHRoLCBsZWZ0LCB0b3AsIGhlaWdodCB9ID0gdGhpcy5nZXRQYW5lbFNpemUoKTtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS53aWR0aCA9IGAke3dpZHRofXB4YDtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS5oZWlnaHQgPSBgJHtoZWlnaHR9cHhgO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRvcCA9IGAke3RvcH1weGA7XHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUubGVmdCA9IGAke2xlZnR9cHhgO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnpJbmRleCA9ICcxMDAwMSc7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8g5Yib5bu65pWw5o2u5bGV56S657uE5Lu2XHJcbiAgICAgICAgY29uc3QgY21wRmFjdCA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KExvb2t1cFF1aWNrU2VsZWN0UGFuZWxDb21wb25lbnQpO1xyXG4gICAgICAgIHRoaXMuY21wUmVmID0gY21wRmFjdC5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5jbXBSZWYuaW5zdGFuY2Uuc2hvd01vcmUgPSB0aGlzLm9wdGlvbnMuc2hvd01vcmU7XHJcbiAgICAgICAgdGhpcy5jbXBSZWYuaW5zdGFuY2UudGV4dEZpZWxkID0gdGhpcy5sb29rdXBSZWYudGV4dEZpZWxkO1xyXG4gICAgICAgIHRoaXMuY21wUmVmLmluc3RhbmNlLmZvcm1hdHRlciA9IHRoaXMub3B0aW9ucy5mb3JtYXR0ZXI7XHJcblxyXG4gICAgICAgIC8vIGNtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2ZhcnJpcy1tYWluLWFyZWEnKTtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5hcHBlbmRDaGlsZCh0aGlzLmNtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuXHJcbiAgICAgICAgdGhpcy5jbXBSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG5cclxuICAgICAgICAvLyBtb3JlIGNsaWNrZWQg5omT5byA5biu5Yqp56qX5Y+jXHJcbiAgICAgICAgdGhpcy5jbXBSZWYuaW5zdGFuY2UubW9yZUNsY2lrLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmhpZGUoZSk7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwUmVmLnNob3dEaWFsb2coKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5jbXBSZWYuaW5zdGFuY2UuaXRlbUNsaWNrLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgZGF0YSB9ID0gZTtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYuc2VsZWN0SXRlbShkYXRhKTtcclxuICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICAvLyDms6jlhozpvKDmoIfmu5rova7vvIzngrnlh7vkuovku7bvvIznlKjkuo7pmpDol49QYW5lbFxyXG4gICAgICAgIHRoaXMubG9va3VwUmVmLm92ZXJMYXlTZXJ2aWNlLnJlZ2lzdGVyTW91c2VFdmVudCh0aGlzLmxvb2t1cFJlZi5lbC5uYXRpdmVFbGVtZW50LCAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMucGFuZWxFbGVtZW50IHx8IGUudGFyZ2V0WydjbG9zZXN0J10oJy5mLWxvb2t1cF9xdWljay1wYW5lbCcpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNtcFJlZikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbXBSZWYuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbXBSZWYgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmhpZGUoZSk7XHJcblxyXG4gICAgICAgICAgICBpZih0aGlzLmxvb2t1cFJlZi5pbnB1dEdyb3VwLnRleHRib3gubmF0aXZlRWxlbWVudCA9PT0gZS50YXJnZXQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdmLWFyZWEtc2hvdycpO1xyXG5cclxuICAgICAgICB0aGlzLmxvYWREYXRhKCk7XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICBwcml2YXRlIGNhbGN1bGF0aW9uUGFuZWxIZWlnaHQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5zaG93SXRlbXNDb3VudCAqIDMwICsgKHRoaXMub3B0aW9ucy5zaG93TW9yZSA/IDUwOiAwKSArIHRoaXMub3B0aW9ucy5mb290ZXJIZWlnaHQgKyA1O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0SW5wdXRTaXplSW5mbygpIHtcclxuICAgICAgICBjb25zdCBlbDogYW55ID0gdGhpcy5sb29rdXBSZWYudmlld1R5cGUgPT09ICd0ZXh0JyA/IHRoaXMuaW5wdXRSZWYuaW5wdXRHcm91cCA6IHRoaXMubG9va3VwUmVmLnRhZ2JveDtcclxuICAgICAgICByZXR1cm4gZWwubmF0aXZlRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFBhbmVsU2l6ZSgpIHtcclxuICAgICAgICBsZXQgeyB3aWR0aCwgaGVpZ2h0LCB0b3AsIGxlZnQgfSA9IHRoaXMuZ2V0SW5wdXRTaXplSW5mbygpO1xyXG4gICAgICAgIGNvbnN0IGJvdHRvbSA9IHdpbmRvdy5pbm5lckhlaWdodCAtIGhlaWdodCAtIHRvcDtcclxuICAgICAgICBsZXQgcGFuZWxIZWlnaHQgPSB0aGlzLmNhbGN1bGF0aW9uUGFuZWxIZWlnaHQoKTtcclxuXHJcbiAgICAgICAgY29uc3QgaCA9IHRvcCA+IGJvdHRvbSA/IHRvcCA6IGJvdHRvbTtcclxuICAgICAgICBpZiAoYm90dG9tID4gcGFuZWxIZWlnaHQpIHtcclxuICAgICAgICAgICAgdG9wID0gdG9wICsgaGVpZ2h0O1xyXG4gICAgICAgICAgICAvLyDpnaLmnb/nlLHkuIrlkJHkuIvlsZXlvIBcclxuICAgICAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUudHJhbnNmb3JtT3JpZ2luID0gJzEwMCUgdG9wJztcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodG9wID4gYm90dG9tKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaCA8IHBhbmVsSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFuZWxIZWlnaHQgPSBoIC0gMTA7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9wID0gMTA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRvcCA9IHRvcCAtIHBhcnNlSW50KCcnICsgcGFuZWxIZWlnaHQsIDEwKSAtIDU7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgLy8g6Z2i5p2/55Sx5LiL5ZCR5LiK5bGV5byAXHJcbiAgICAgICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS50cmFuc2Zvcm1PcmlnaW4gPSAnMTAwJSBib3R0b20nO1xyXG5cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChoIDwgcGFuZWxIZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYW5lbEhlaWdodCA9IGggLSAxMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRvcCA9IHRvcCArIGhlaWdodDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHsgd2lkdGgsIHRvcCwgaGVpZ2h0OiBwYW5lbEhlaWdodCwgbGVmdCB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGF0YSgpOiBPYnNlcnZhYmxlPEFycmF5PGFueT4+IHtcclxuICAgICAgICBsZXQgcDogYW55ID0ge1xyXG4gICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgcGFnZVNpemU6IHRoaXMub3B0aW9ucy5zaG93SXRlbXNDb3VudCxcclxuICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogMSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIGxldCB0OiBMT0FEX0RBVEFfVFlQRSA9IFwiYWxsXCI7XHJcbiAgICAgICAgaWYgKHRoaXMubG9va3VwUmVmLmlzVGV4dENoYW5nZSkge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFJlZi5fc2VhcmNoU3RhdGUgPSB7IFxyXG4gICAgICAgICAgICAgICAgZmllbGQ6IHRoaXMubG9va3VwUmVmLnRleHRGaWVsZCwgLy9cIipcIixcclxuICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLmxvb2t1cFJlZi5kaXNwbGF5VGV4dFxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHAgPSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2g6IHRoaXMubG9va3VwUmVmLl9zZWFyY2hTdGF0ZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgdCA9ICdzZWFyY2gnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5sb29rdXBSZWYuaHR0cE1nci5sb29rdXBSZXF1ZXN0KHAsIHQpLnBpcGUoXHJcbiAgICAgICAgICAgIG1hcCgocmVzdERhdGE6IExvb2t1cEdyaWRSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChyZXN0RGF0YSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN0RGF0YS5pdGVtcyB8fCBbXTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29rdXBSZWYuZGlzcGxheVRleHQgJiYgdGhpcy5sb29rdXBSZWYuaXNUZXh0Q2hhbmdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubG9va3VwUmVmLml0ZW1zLmZpbHRlcihuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5bdGhpcy5sb29rdXBSZWYudGV4dEZpZWxkXS5pbmRleE9mKHRoaXMubG9va3VwUmVmLmRpc3BsYXlUZXh0KSA+IC0xO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLnNsaWNlKDAsIHRoaXMub3B0aW9ucy5zaG93SXRlbXNDb3VudClcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb29rdXBSZWYuaXRlbXMuc2xpY2UoMCwgdGhpcy5vcHRpb25zLnNob3dJdGVtc0NvdW50KTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbG9hZERhdGEoKSB7XHJcbiAgICAgICAgY29uc3QgbG9hZGluZ1JlZiA9IHRoaXMubG9va3VwUmVmLmxvYWRpbmdTZXJ2aWNlLnNob3coe2NvbnRhaW5lcjogdGhpcy5wYW5lbEVsZW1lbnR9KTtcclxuICAgICAgICB0aGlzLmdldERhdGEoKS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNtcFJlZi5pbnN0YW5jZS5sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgbG9hZGluZ1JlZi5jbG9zZSgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdrZXlkb3duJywgWyckZXZlbnQnXSlcclxuICAgIHJlZ2lzdGVyS2V5Ym9hcmRFdmVudCgkZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmxvb2t1cFJlZi5zaW5nbGVTZWxlY3QpICB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCByb3dzPSBbXTtcclxuICAgICAgICBpZiAodGhpcy5jbXBSZWYpIHtcclxuICAgICAgICAgICAgcm93cyA9IHRoaXMuY21wUmVmLmluc3RhbmNlLmRhdGE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXJvd3MgfHwgIXJvd3MubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICgkZXZlbnQuY29kZSA9PT0gJ0Fycm93VXAnIHx8ICRldmVudC5jb2RlID09PSAnQXJyb3dEb3duJykge1xyXG4gICAgICAgICAgICAkZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaWR4ID0gdGhpcy5jbXBSZWYuaW5zdGFuY2UuYWN0aXZlSW5kZXg7XHJcbiAgICAgICAgbGV0IGFjdGl2ZUluZGV4ID0gaWR4O1xyXG5cclxuICAgICAgICBjb25zdCBzZWxlY3RJdGVtID0gKGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgIGFjdGl2ZUluZGV4ID0gaW5kZXg7XHJcbiAgICAgICAgICAgIHRoaXMuY21wUmVmLmluc3RhbmNlLnNldEFjdGl2ZUl0ZW0oaW5kZXgpO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGlmICgkZXZlbnQuY29kZSA9PT0gJ0Fycm93VXAnKSB7ICAvLyB1cFxyXG4gICAgICAgICAgICBpZiAoaWR4ID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIGxldCBwcmV2SWR4ID0gaWR4IC0gMTtcclxuICAgICAgICAgICAgICAgIGlmIChwcmV2SWR4IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHByZXZJZHggPSByb3dzLmxlbmd0aCAtIDE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RJdGVtKHByZXZJZHgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZWN0SXRlbShyb3dzLmxlbmd0aCAtIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICgkZXZlbnQuY29kZSA9PT0gJ0Fycm93RG93bicpIHsgLy8gZG93blxyXG4gICAgICAgICAgICBsZXQgbmV4dElkeCA9IGlkeCArIDE7XHJcbiAgICAgICAgICAgIGlmIChuZXh0SWR4ID49IHJvd3MubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBuZXh0SWR4ID0gMDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgc2VsZWN0SXRlbShuZXh0SWR4KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmKCRldmVudC5rZXkgPT09ICdFbnRlcicpIHtcclxuICAgICAgICAgICAgaWYgKHJvd3MgJiYgcm93cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByb3dzW2lkeF07XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFJlZi5zZWxlY3RJdGVtKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oaWRlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn0iXX0=