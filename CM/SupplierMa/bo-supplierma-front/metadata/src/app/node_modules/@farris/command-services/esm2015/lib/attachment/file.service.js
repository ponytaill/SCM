import { Injectable, Optional } from '@angular/core';
import { forkJoin, Subject } from 'rxjs';
import { FrameContext, BindingPathConverter } from '@farris/devkit';
import { FormNotifyService } from '../form-notify.service';
import { ATTACHMENT_ORDER_FIELD } from './types';
import { AttachmentDataService } from './attachment-data.service';
import { LanguageService } from '../languag.service';
import { EntityService } from '../entity-services/index';
import { ListDataService, SubListDataService } from '../data-services/index';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { debounceTime, tap } from 'rxjs/operators';
/**
 * 附件上传
 * @summary
 * fileExtend：命名文件上传或预览组件传递过来的数据；
 * fileExtendFieldPath：命名附件UDT的字段路径；
 * attachmentInfo：命名附件UDT所需的信息；
 */
class FileService {
    /**
     * 构造函数
     */
    constructor(frameContext, attachDataService, entityService, subListDataService, notifyService, languageService, listDataService, formLoadingService) {
        this.frameContext = frameContext;
        this.attachDataService = attachDataService;
        this.entityService = entityService;
        this.subListDataService = subListDataService;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.listDataService = listDataService;
        this.formLoadingService = formLoadingService;
        this.subject = new Subject();
        this.subject.pipe(debounceTime(500)).subscribe((data) => {
            this.process(data.fileInfoFieldPath, data.configs);
        });
        this.attachmentInfos = [];
    }
    // #region 上传文件
    /**
     * 批量添加附件行
     */
    addFileRows(fileInfoFieldPath) {
        const attachmentInfos = this.getAttachmentInfosToAddFromContext();
        if (attachmentInfos.length === 0) {
            this.notifyService.info('请先上传附件');
        }
        return this.attachDataService.updateRows(fileInfoFieldPath, attachmentInfos);
    }
    /**
     * 批量添加带附件类型的附件行
     * @param fileInfoFieldPath 附件udt字段
     * @param configs 附件扩展信息配置
     * @description configs配置如{"billId":"{UISTATE~/root/billId}","rowId":"{UISTATE~/root/rowId}","attachmentType":"xueli"}
     */
    addFileRowsWithConfigs(fileInfoFieldPath, configs) {
        const attachmentInfos = this.getAttachmentInfosToAddFromContext();
        if (attachmentInfos.length === 0) {
            this.notifyService.info('请先上传附件');
        }
        // let mapFields = null;
        // if (typeof configs === 'string') {
        //   // 去掉首尾空格
        //   configs = configs.trim();
        // }
        // if (configs.startsWith('{') && configs.endsWith('}')) {
        //   try {
        //     mapFields = JSON.parse(configs);
        //   } catch {
        //     throw new Error('附件扩展信息配置不是合法的json字符串。');
        //   }
        // } else {
        //   throw new Error('附件扩展信息配置不是合法的json字符串。');
        // }
        this.attachmentInfos = this.attachmentInfos.concat(attachmentInfos);
        this.subject.next({ fileInfoFieldPath, configs });
        //return this.attachDataService.updateRowsWithConfigs(fileInfoFieldPath, attachmentInfos, mapFields);
    }
    process(fileInfoFieldPath, configs) {
        if (this.attachmentInfos && this.attachmentInfos.length > 0) {
            const attachmentInfos = this.attachmentInfos.concat([]);
            let mapFields = null;
            if (typeof configs === 'string') {
                // 去掉首尾空格
                configs = configs.trim();
            }
            if (configs.startsWith('{') && configs.endsWith('}')) {
                try {
                    mapFields = JSON.parse(configs);
                }
                catch (_a) {
                    throw new Error('附件扩展信息配置不是合法的json字符串。');
                }
            }
            else {
                throw new Error('附件扩展信息配置不是合法的json字符串。');
            }
            this.attachDataService.updateRowsWithConfigs(fileInfoFieldPath, attachmentInfos, mapFields).pipe(tap(() => {
                this.attachmentInfos = this.attachmentInfos.filter(item => !attachmentInfos.find(attachmentInfo => attachmentInfo.attachmentId === item.attachmentId));
                if (this.attachmentInfos.length > 0) {
                    this.process(fileInfoFieldPath, configs);
                }
            })).subscribe();
        }
    }
    /**
     * 获取要添加的附件信息数组
     */
    getAttachmentInfosToAddFromContext() {
        const fileExtends = this.getFileExtendsFromContext();
        const attachmentInfos = this.convertToAttachmentInfos(fileExtends);
        return attachmentInfos;
    }
    /**
     * 将附件上传组件返回的附件信息转换为服务器端需要的格式
     */
    convertToAttachmentInfos(fileExtends) {
        if (!fileExtends) {
            return [];
        }
        const attachmentInfos = [];
        fileExtends.forEach((fUploadOutPut) => {
            const attachmentInfo = {
                attachmentId: fUploadOutPut.extend.metadataId,
                fileName: fUploadOutPut.extend.fileName,
            };
            attachmentInfos.push(attachmentInfo);
        });
        return attachmentInfos;
    }
    // #endregion
    // #region 删除文件
    /**
     * 删除附件行
     */
    removeFileRows(fileInfoFieldPath) {
        const dataIds = this.getDataIdsToRemoveFromContext(fileInfoFieldPath);
        if (dataIds.length === 0) {
            this.notifyService.info('请选择要删除的附件');
        }
        const isSublist = fileInfoFieldPath.split('/').filter(p => p).length >= 2;
        const removeObservables = [];
        if (isSublist) {
            dataIds.forEach((dataId) => {
                let removeObservable;
                removeObservable = this.subListDataService.removeWithoutConfirm(dataId);
                removeObservables.push(removeObservable);
            });
            return forkJoin(removeObservables);
        }
        else {
            return this.listDataService.removeRows(dataIds, false, null, false);
        }
    }
    /**
     * 获取要删除的数据
     */
    getDataIdsToRemoveFromContext(fileExtendFieldPath) {
        // 从上下文中获取要处理的附件信息数组
        const fileExtends = this.getFileExtendsFromContext();
        // 将附件数组转换为对应的数据id
        const dataIds = [];
        fileExtends.forEach((fileExtend) => {
            // 上传删除和预览删除传递过来的fileId的key可能不一致，要做兼容
            const fileId = fileExtend.extend.metadataId;
            const dataId = this.convertFileIdToDataId(fileId, fileExtendFieldPath);
            dataIds.push(dataId);
        });
        return dataIds;
    }
    /**
     * 根据路径获取附件字段值数组
     * @param fieldPath 字段路径
     */
    convertFileIdToDataId(fileId, fileExtendFieldPath) {
        // 解析路径
        const fileBindingPath = BindingPathConverter.toBindingPathArray(fileExtendFieldPath);
        const fileFieldName = fileBindingPath.pop();
        const fileListBindingPath = fileBindingPath;
        // 获取附件id数组
        const entityListData = this.entityService.getEntityListData(fileListBindingPath);
        const targetEntityData = entityListData.find((entityData) => {
            if (entityData[fileFieldName]) {
                const attachmentId = entityData[fileFieldName]['attachmentId'];
                if (attachmentId === fileId) {
                    return true;
                }
            }
        });
        return targetEntityData.id;
    }
    // #endregion
    //#region 文件排序
    /**
     * 更新附件排序
     * @param attachmentInfoFieldPath 附件udt字段路径
     * @param ids 附件排序后的附件id数组
     */
    updateOrder(attachmentInfoFieldPath, ids) {
        if (!attachmentInfoFieldPath) {
            throw new Error('附件udt字段路径参数不能为空');
        }
        // 支持从代码中直接调用，如果参数中传递了ids则使用，否则使用命令上下文中的事件参数
        if (!ids) {
            // 获取事件参数
            const commandContext = this['context'];
            // 与组件约定事件参数为数据主键数组
            ids = commandContext && commandContext.eventParam && commandContext.eventParam.data;
        }
        // 对收集的主键数组进行判断
        if (!ids || !Array.isArray(ids)) {
            return;
        }
        // 当前命令所在组件的绑定数据
        const bindingList = this.frameContext.bindingData.getList();
        // 无绑定数据时不处理
        if (!bindingList || bindingList.length < 1) {
            return;
        }
        // 统一获取附件udt信息
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        const attachmentField = parentBindingPathArray.pop();
        // 出现udt字段不存在的情况，说明命令中附件udt字段配置错误或vo中没有附件udt。控制器不兼容错误，此处判断只为阻止后续的遍历
        if (!attachmentField) {
            throw new Error('无法获取附件udt字段，请确认命令中附件udt字段路径配置正确，且视图模型中存在附件udt字段');
        }
        const data = bindingList.toJSON();
        // 更新绑定数据中附件udt字段中排序字段的值,仅更新有附件的行
        ids.forEach((id, index) => {
            const item = data.find(item => item && item[attachmentField] && item[attachmentField]['attachmentId'] === id);
            const primaryKeyValue = item && item.id;
            if (!primaryKeyValue) {
                return;
            }
            const bindingObject = bindingList.findById(primaryKeyValue);
            if (bindingObject) {
                // 附件udt对象
                const attachment = bindingObject[attachmentField];
                if (attachment) {
                    // 获取旧值
                    const order = attachment.getValue(ATTACHMENT_ORDER_FIELD);
                    if (order !== index) {
                        // 更新排序
                        attachment.setValue(ATTACHMENT_ORDER_FIELD, index, true, true);
                    }
                }
            }
        });
    }
    //#endregion
    // #region 其他工具方法
    /**
     * 从上下文中获取要处理的附件信息数组
     * @summary
     * 为了统一单个和多个附件的处理方式，统一包装为数组
     */
    getFileExtendsFromContext() {
        const commandContext = this['context'];
        const eventParam = commandContext.eventParam;
        if (!eventParam) {
            return [];
        }
        let fileExtends;
        if (Array.isArray(eventParam) === false) {
            fileExtends = [eventParam];
        }
        else {
            fileExtends = eventParam.concat([]);
        }
        return fileExtends;
    }
}
FileService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FileService.ctorParameters = () => [
    { type: FrameContext },
    { type: AttachmentDataService },
    { type: EntityService },
    { type: SubListDataService },
    { type: FormNotifyService },
    { type: LanguageService },
    { type: ListDataService },
    { type: FormLoadingService, decorators: [{ type: Optional }] }
];
export { FileService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQvZmlsZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXJELE9BQU8sRUFBRSxZQUFZLEVBQWtCLG9CQUFvQixFQUE4QixNQUFNLGdCQUFnQixDQUFDO0FBQ2hILE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBa0Isc0JBQXNCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFDakUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDbEUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZUFBZSxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDMUUsT0FBTyxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRDs7Ozs7O0dBTUc7QUFDSCxNQUNNLFdBQVc7SUFHZjs7T0FFRztJQUNILFlBQ1UsWUFBMEIsRUFDMUIsaUJBQXdDLEVBQ3hDLGFBQTRCLEVBQzVCLGtCQUFzQyxFQUN0QyxhQUFnQyxFQUNoQyxlQUFnQyxFQUNoQyxlQUFnQyxFQUNwQixrQkFBc0M7UUFQbEQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUF1QjtRQUN4QyxrQkFBYSxH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S0FBSyxFQUFFO1lBQ3ZDLFdBQVcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1NBQzVCO2FBQU07WUFDTCxXQUFXLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNyQztRQUVELE9BQU8sV0FBa0MsQ0FBQztJQUM1QyxDQUFDOzs7WUFyUkYsVUFBVTs7OztZQWpCRixZQUFZO1lBR1oscUJBQXFCO1lBRXJCLGFBQWE7WUFDSSxrQkFBa0I7WUFMbkMsaUJBQWlCO1lBR2pCLGVBQWU7WUFFZixlQUFlO1lBQ2Ysa0JBQWtCLHVCQXlCdEIsUUFBUTs7QUEwUWIsT0FBTyxFQUFFLFdBQVcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZvcmtKb2luLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBGVXBsb2FkRmlsZUV4dGVuZCB9IGZyb20gJ0BmYXJyaXMvZXh0ZW5kLWZpbGUtdXBsb2FkJztcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgQ29tbWFuZENvbnRleHQsIEJpbmRpbmdQYXRoQ29udmVydGVyLCBCaW5kaW5nTGlzdCwgQmluZGluZ09iamVjdCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1ub3RpZnkuc2VydmljZSc7XG5pbXBvcnQgeyBBdHRhY2htZW50SW5mbywgQVRUQUNITUVOVF9PUkRFUl9GSUVMRCB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgQXR0YWNobWVudERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9hdHRhY2htZW50LWRhdGEuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi9sYW5ndWFnLnNlcnZpY2UnO1xuaW1wb3J0IHsgRW50aXR5U2VydmljZSB9IGZyb20gJy4uL2VudGl0eS1zZXJ2aWNlcy9pbmRleCc7XG5pbXBvcnQgeyBMaXN0RGF0YVNlcnZpY2UsIFN1Ykxpc3REYXRhU2VydmljZSB9IGZyb20gJy4uL2RhdGEtc2VydmljZXMvaW5kZXgnO1xuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vKipcbiAqIOmZhOS7tuS4iuS8oFxuICogQHN1bW1hcnlcbiAqIGZpbGVFeHRlbmTvvJrlkb3lkI3mlofku7bkuIrkvKDmiJbpooTop4jnu4Tku7bkvKDpgJLov4fmnaXnmoTmlbDmja7vvJtcbiAqIGZpbGVFeHRlbmRGaWVsZFBhdGjvvJrlkb3lkI3pmYTku7ZVRFTnmoTlrZfmrrXot6/lvoTvvJtcbiAqIGF0dGFjaG1lbnRJbmZv77ya5ZG95ZCN6ZmE5Lu2VURU5omA6ZyA55qE5L+h5oGv77ybXG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIEZpbGVTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzdWJqZWN0OiBTdWJqZWN0PHsgZmlsZUluZm9GaWVsZFBhdGg6IHN0cmluZywgY29uZmlnczogc3RyaW5nIH0+O1xuICBwcml2YXRlIGF0dGFjaG1lbnRJbmZvczogQXR0YWNobWVudEluZm9bXTtcbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcbiAgICBwcml2YXRlIGF0dGFjaERhdGFTZXJ2aWNlOiBBdHRhY2htZW50RGF0YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBlbnRpdHlTZXJ2aWNlOiBFbnRpdHlTZXJ2aWNlLFxuICAgIHByaXZhdGUgc3ViTGlzdERhdGFTZXJ2aWNlOiBTdWJMaXN0RGF0YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBub3RpZnlTZXJ2aWNlOiBGb3JtTm90aWZ5U2VydmljZSxcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgbGlzdERhdGFTZXJ2aWNlOiBMaXN0RGF0YVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBmb3JtTG9hZGluZ1NlcnZpY2U6IEZvcm1Mb2FkaW5nU2VydmljZVxuICApIHtcbiAgICB0aGlzLnN1YmplY3QgPSBuZXcgU3ViamVjdDx7IGZpbGVJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGNvbmZpZ3M6IHN0cmluZyB9PigpO1xuICAgIHRoaXMuc3ViamVjdC5waXBlKGRlYm91bmNlVGltZSg1MDApKS5zdWJzY3JpYmUoKGRhdGE6IHsgZmlsZUluZm9GaWVsZFBhdGg6IHN0cmluZywgY29uZmlnczogc3RyaW5nIH0pID0+IHtcbiAgICAgIHRoaXMucHJvY2VzcyhkYXRhLmZpbGVJbmZvRmllbGRQYXRoLCBkYXRhLmNvbmZpZ3MpO1xuICAgIH0pO1xuICAgIHRoaXMuYXR0YWNobWVudEluZm9zID0gW107XG4gIH1cblxuICAvLyAjcmVnaW9uIOS4iuS8oOaWh+S7tlxuXG4gIC8qKlxuICAgKiDmibnph4/mt7vliqDpmYTku7booYxcbiAgICovXG4gIHB1YmxpYyBhZGRGaWxlUm93cyhmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gdGhpcy5nZXRBdHRhY2htZW50SW5mb3NUb0FkZEZyb21Db250ZXh0KCk7XG4gICAgaWYgKGF0dGFjaG1lbnRJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKCfor7flhYjkuIrkvKDpmYTku7YnKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93cyhmaWxlSW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcbiAgfVxuICAvKipcbiAgICog5om56YeP5re75Yqg5bim6ZmE5Lu257G75Z6L55qE6ZmE5Lu26KGMXG4gICAqIEBwYXJhbSBmaWxlSW5mb0ZpZWxkUGF0aCDpmYTku7Z1ZHTlrZfmrrVcbiAgICogQHBhcmFtIGNvbmZpZ3Mg6ZmE5Lu25omp5bGV5L+h5oGv6YWN572uIFxuICAgKiBAZGVzY3JpcHRpb24gY29uZmlnc+mFjee9ruWmgntcImJpbGxJZFwiOlwie1VJU1RBVEV+L3Jvb3QvYmlsbElkfVwiLFwicm93SWRcIjpcIntVSVNUQVRFfi9yb290L3Jvd0lkfVwiLFwiYXR0YWNobWVudFR5cGVcIjpcInh1ZWxpXCJ9XG4gICAqL1xuICBwdWJsaWMgYWRkRmlsZVJvd3NXaXRoQ29uZmlncyhmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBjb25maWdzOiBzdHJpbmcpIHtcbiAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSB0aGlzLmdldEF0dGFjaG1lbnRJbmZvc1RvQWRkRnJvbUNvbnRleHQoKTtcbiAgICBpZiAoYXR0YWNobWVudEluZm9zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8oJ+ivt+WFiOS4iuS8oOmZhOS7ticpO1xuICAgIH1cbiAgICAvLyBsZXQgbWFwRmllbGRzID0gbnVsbDtcbiAgICAvLyBpZiAodHlwZW9mIGNvbmZpZ3MgPT09ICdzdHJpbmcnKSB7XG4gICAgLy8gICAvLyDljrvmjonpppblsL7nqbrmoLxcbiAgICAvLyAgIGNvbmZpZ3MgPSBjb25maWdzLnRyaW0oKTtcbiAgICAvLyB9XG4gICAgLy8gaWYgKGNvbmZpZ3Muc3RhcnRzV2l0aCgneycpICYmIGNvbmZpZ3MuZW5kc1dpdGgoJ30nKSkge1xuICAgIC8vICAgdHJ5IHtcbiAgICAvLyAgICAgbWFwRmllbGRzID0gSlNPTi5wYXJzZShjb25maWdzKTtcbiAgICAvLyAgIH0gY2F0Y2gge1xuICAgIC8vICAgICB0aHJvdyBuZXcgRXJyb3IoJ+mZhOS7tuaJqeWxleS/oeaBr+mFjee9ruS4jeaYr+WQiOazleeahGpzb27lrZfnrKbkuLLjgIInKTtcbiAgICAvLyAgIH1cbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCfpmYTku7bmianlsZXkv6Hmga/phY3nva7kuI3mmK/lkIjms5XnmoRqc29u5a2X56ym5Liy44CCJyk7XG4gICAgLy8gfVxuICAgIHRoaXMuYXR0YWNobWVudEluZm9zID0gdGhpcy5hdHRhY2htZW50SW5mb3MuY29uY2F0KGF0dGFjaG1lbnRJbmZvcyk7XG4gICAgdGhpcy5zdWJqZWN0Lm5leHQoeyBmaWxlSW5mb0ZpZWxkUGF0aCwgY29uZmlncyB9KTtcbiAgICAvL3JldHVybiB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvd3NXaXRoQ29uZmlncyhmaWxlSW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zLCBtYXBGaWVsZHMpO1xuICB9XG4gIHByaXZhdGUgcHJvY2VzcyhmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBjb25maWdzOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5hdHRhY2htZW50SW5mb3MgJiYgdGhpcy5hdHRhY2htZW50SW5mb3MubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gdGhpcy5hdHRhY2htZW50SW5mb3MuY29uY2F0KFtdKTtcbiAgICAgIGxldCBtYXBGaWVsZHMgPSBudWxsO1xuICAgICAgaWYgKHR5cGVvZiBjb25maWdzID09PSAnc3RyaW5nJykge1xuICAgICAgICAvLyDljrvmjonpppblsL7nqbrmoLxcbiAgICAgICAgY29uZmlncyA9IGNvbmZpZ3MudHJpbSgpO1xuICAgICAgfVxuICAgICAgaWYgKGNvbmZpZ3Muc3RhcnRzV2l0aCgneycpICYmIGNvbmZpZ3MuZW5kc1dpdGgoJ30nKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIG1hcEZpZWxkcyA9IEpTT04ucGFyc2UoY29uZmlncyk7XG4gICAgICAgIH0gY2F0Y2gge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcign6ZmE5Lu25omp5bGV5L+h5oGv6YWN572u5LiN5piv5ZCI5rOV55qEanNvbuWtl+espuS4suOAgicpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ+mZhOS7tuaJqeWxleS/oeaBr+mFjee9ruS4jeaYr+WQiOazleeahGpzb27lrZfnrKbkuLLjgIInKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93c1dpdGhDb25maWdzKGZpbGVJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MsIG1hcEZpZWxkcykucGlwZShcbiAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmF0dGFjaG1lbnRJbmZvcyA9IHRoaXMuYXR0YWNobWVudEluZm9zLmZpbHRlcihpdGVtID0+ICFhdHRhY2htZW50SW5mb3MuZmluZChhdHRhY2htZW50SW5mbyA9PiBhdHRhY2htZW50SW5mby5hdHRhY2htZW50SWQgPT09IGl0ZW0uYXR0YWNobWVudElkKSk7XG4gICAgICAgICAgaWYgKHRoaXMuYXR0YWNobWVudEluZm9zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMucHJvY2VzcyhmaWxlSW5mb0ZpZWxkUGF0aCwgY29uZmlncyk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKS5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bopoHmt7vliqDnmoTpmYTku7bkv6Hmga/mlbDnu4RcbiAgICovXG4gIHByaXZhdGUgZ2V0QXR0YWNobWVudEluZm9zVG9BZGRGcm9tQ29udGV4dCgpOiBBdHRhY2htZW50SW5mb1tdIHtcbiAgICBjb25zdCBmaWxlRXh0ZW5kcyA9IHRoaXMuZ2V0RmlsZUV4dGVuZHNGcm9tQ29udGV4dCgpO1xuICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IHRoaXMuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVFeHRlbmRzKTtcbiAgICByZXR1cm4gYXR0YWNobWVudEluZm9zO1xuICB9XG5cbiAgLyoqXG4gICAqIOWwhumZhOS7tuS4iuS8oOe7hOS7tui/lOWbnueahOmZhOS7tuS/oeaBr+i9rOaNouS4uuacjeWKoeWZqOerr+mcgOimgeeahOagvOW8j1xuICAgKi9cbiAgcHJpdmF0ZSBjb252ZXJ0VG9BdHRhY2htZW50SW5mb3MoZmlsZUV4dGVuZHM6IEZVcGxvYWRGaWxlRXh0ZW5kW10pOiBBdHRhY2htZW50SW5mb1tdIHtcbiAgICBpZiAoIWZpbGVFeHRlbmRzKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3QgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdID0gW107XG4gICAgZmlsZUV4dGVuZHMuZm9yRWFjaCgoZlVwbG9hZE91dFB1dDogRlVwbG9hZEZpbGVFeHRlbmQpID0+IHtcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvOiBBdHRhY2htZW50SW5mbyA9IHtcbiAgICAgICAgYXR0YWNobWVudElkOiBmVXBsb2FkT3V0UHV0LmV4dGVuZC5tZXRhZGF0YUlkLFxuICAgICAgICBmaWxlTmFtZTogZlVwbG9hZE91dFB1dC5leHRlbmQuZmlsZU5hbWUsXG4gICAgICB9O1xuICAgICAgYXR0YWNobWVudEluZm9zLnB1c2goYXR0YWNobWVudEluZm8pO1xuICAgIH0pO1xuICAgIHJldHVybiBhdHRhY2htZW50SW5mb3M7XG4gIH1cblxuICAvLyAjZW5kcmVnaW9uXG5cblxuICAvLyAjcmVnaW9uIOWIoOmZpOaWh+S7tlxuXG4gIC8qKlxuICAgKiDliKDpmaTpmYTku7booYxcbiAgICovXG4gIHB1YmxpYyByZW1vdmVGaWxlUm93cyhmaWxlSW5mb0ZpZWxkUGF0aDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBkYXRhSWRzID0gdGhpcy5nZXREYXRhSWRzVG9SZW1vdmVGcm9tQ29udGV4dChmaWxlSW5mb0ZpZWxkUGF0aCk7XG4gICAgaWYgKGRhdGFJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuaW5mbygn6K+36YCJ5oup6KaB5Yig6Zmk55qE6ZmE5Lu2Jyk7XG4gICAgfVxuICAgIGNvbnN0IGlzU3VibGlzdCA9IGZpbGVJbmZvRmllbGRQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkubGVuZ3RoID49IDI7XG4gICAgY29uc3QgcmVtb3ZlT2JzZXJ2YWJsZXM6IE9ic2VydmFibGU8YW55PltdID0gW107XG4gICAgaWYgKGlzU3VibGlzdCkge1xuICAgICAgZGF0YUlkcy5mb3JFYWNoKChkYXRhSWQ6IHN0cmluZykgPT4ge1xuICAgICAgICBsZXQgcmVtb3ZlT2JzZXJ2YWJsZTtcbiAgICAgICAgcmVtb3ZlT2JzZXJ2YWJsZSA9IHRoaXMuc3ViTGlzdERhdGFTZXJ2aWNlLnJlbW92ZVdpdGhvdXRDb25maXJtKGRhdGFJZCk7XG4gICAgICAgIHJlbW92ZU9ic2VydmFibGVzLnB1c2gocmVtb3ZlT2JzZXJ2YWJsZSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBmb3JrSm9pbihyZW1vdmVPYnNlcnZhYmxlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmxpc3REYXRhU2VydmljZS5yZW1vdmVSb3dzKGRhdGFJZHMsIGZhbHNlLCBudWxsLCBmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluimgeWIoOmZpOeahOaVsOaNrlxuICAgKi9cbiAgcHJpdmF0ZSBnZXREYXRhSWRzVG9SZW1vdmVGcm9tQ29udGV4dChmaWxlRXh0ZW5kRmllbGRQYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG5cbiAgICAvLyDku47kuIrkuIvmlofkuK3ojrflj5bopoHlpITnkIbnmoTpmYTku7bkv6Hmga/mlbDnu4RcbiAgICBjb25zdCBmaWxlRXh0ZW5kcyA9IHRoaXMuZ2V0RmlsZUV4dGVuZHNGcm9tQ29udGV4dCgpO1xuXG4gICAgLy8g5bCG6ZmE5Lu25pWw57uE6L2s5o2i5Li65a+55bqU55qE5pWw5o2uaWRcbiAgICBjb25zdCBkYXRhSWRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGZpbGVFeHRlbmRzLmZvckVhY2goKGZpbGVFeHRlbmQ6IEZVcGxvYWRGaWxlRXh0ZW5kKSA9PiB7XG5cbiAgICAgIC8vIOS4iuS8oOWIoOmZpOWSjOmihOiniOWIoOmZpOS8oOmAkui/h+adpeeahGZpbGVJZOeahGtleeWPr+iDveS4jeS4gOiHtO+8jOimgeWBmuWFvOWuuVxuICAgICAgY29uc3QgZmlsZUlkID0gZmlsZUV4dGVuZC5leHRlbmQubWV0YWRhdGFJZDtcbiAgICAgIGNvbnN0IGRhdGFJZCA9IHRoaXMuY29udmVydEZpbGVJZFRvRGF0YUlkKGZpbGVJZCwgZmlsZUV4dGVuZEZpZWxkUGF0aCk7XG4gICAgICBkYXRhSWRzLnB1c2goZGF0YUlkKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZGF0YUlkcztcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja7ot6/lvoTojrflj5bpmYTku7blrZfmrrXlgLzmlbDnu4RcbiAgICogQHBhcmFtIGZpZWxkUGF0aCDlrZfmrrXot6/lvoRcbiAgICovXG4gIHByaXZhdGUgY29udmVydEZpbGVJZFRvRGF0YUlkKGZpbGVJZDogc3RyaW5nLCBmaWxlRXh0ZW5kRmllbGRQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuXG4gICAgLy8g6Kej5p6Q6Lev5b6EXG4gICAgY29uc3QgZmlsZUJpbmRpbmdQYXRoID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGZpbGVFeHRlbmRGaWVsZFBhdGgpO1xuICAgIGNvbnN0IGZpbGVGaWVsZE5hbWUgPSBmaWxlQmluZGluZ1BhdGgucG9wKCk7XG4gICAgY29uc3QgZmlsZUxpc3RCaW5kaW5nUGF0aCA9IGZpbGVCaW5kaW5nUGF0aDtcblxuICAgIC8vIOiOt+WPlumZhOS7tmlk5pWw57uEXG4gICAgY29uc3QgZW50aXR5TGlzdERhdGEgPSB0aGlzLmVudGl0eVNlcnZpY2UuZ2V0RW50aXR5TGlzdERhdGEoZmlsZUxpc3RCaW5kaW5nUGF0aCk7XG4gICAgY29uc3QgdGFyZ2V0RW50aXR5RGF0YSA9IGVudGl0eUxpc3REYXRhLmZpbmQoKGVudGl0eURhdGE6IGFueSkgPT4ge1xuICAgICAgaWYgKGVudGl0eURhdGFbZmlsZUZpZWxkTmFtZV0pIHtcbiAgICAgICAgY29uc3QgYXR0YWNobWVudElkID0gZW50aXR5RGF0YVtmaWxlRmllbGROYW1lXVsnYXR0YWNobWVudElkJ107XG4gICAgICAgIGlmIChhdHRhY2htZW50SWQgPT09IGZpbGVJZCkge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGFyZ2V0RW50aXR5RGF0YS5pZDtcbiAgfVxuXG4gIC8vICNlbmRyZWdpb25cbiAgLy8jcmVnaW9uIOaWh+S7tuaOkuW6j1xuICAvKipcbiAgICog5pu05paw6ZmE5Lu25o6S5bqPXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCDpmYTku7Z1ZHTlrZfmrrXot6/lvoRcbiAgICogQHBhcmFtIGlkcyDpmYTku7bmjpLluo/lkI7nmoTpmYTku7ZpZOaVsOe7hFxuICAgKi9cbiAgcHVibGljIHVwZGF0ZU9yZGVyKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGlkczogc3RyaW5nW10pIHtcbiAgICBpZiAoIWF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+mZhOS7tnVkdOWtl+autei3r+W+hOWPguaVsOS4jeiDveS4uuepuicpO1xuICAgIH1cbiAgICAvLyDmlK/mjIHku47ku6PnoIHkuK3nm7TmjqXosIPnlKjvvIzlpoLmnpzlj4LmlbDkuK3kvKDpgJLkuoZpZHPliJnkvb/nlKjvvIzlkKbliJnkvb/nlKjlkb3ku6TkuIrkuIvmlofkuK3nmoTkuovku7blj4LmlbBcbiAgICBpZiAoIWlkcykge1xuICAgICAgLy8g6I635Y+W5LqL5Lu25Y+C5pWwXG4gICAgICBjb25zdCBjb21tYW5kQ29udGV4dCA9IHRoaXNbJ2NvbnRleHQnXSBhcyBDb21tYW5kQ29udGV4dDtcbiAgICAgIC8vIOS4jue7hOS7tue6puWumuS6i+S7tuWPguaVsOS4uuaVsOaNruS4u+mUruaVsOe7hFxuICAgICAgaWRzID0gY29tbWFuZENvbnRleHQgJiYgY29tbWFuZENvbnRleHQuZXZlbnRQYXJhbSAmJiBjb21tYW5kQ29udGV4dC5ldmVudFBhcmFtLmRhdGE7XG4gICAgfVxuICAgIC8vIOWvueaUtumbhueahOS4u+mUruaVsOe7hOi/m+ihjOWIpOaWrVxuICAgIGlmICghaWRzIHx8ICFBcnJheS5pc0FycmF5KGlkcykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgLy8g5b2T5YmN5ZG95Luk5omA5Zyo57uE5Lu255qE57uR5a6a5pWw5o2uXG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xuICAgIC8vIOaXoOe7keWumuaVsOaNruaXtuS4jeWkhOeQhlxuICAgIGlmICghYmluZGluZ0xpc3QgfHwgYmluZGluZ0xpc3QubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyDnu5/kuIDojrflj5bpmYTku7Z1ZHTkv6Hmga9cbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGQgPSBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xuICAgIC8vIOWHuueOsHVkdOWtl+auteS4jeWtmOWcqOeahOaDheWGte+8jOivtOaYjuWRveS7pOS4remZhOS7tnVkdOWtl+autemFjee9rumUmeivr+aIlnZv5Lit5rKh5pyJ6ZmE5Lu2dWR044CC5o6n5Yi25Zmo5LiN5YW85a656ZSZ6K+v77yM5q2k5aSE5Yik5pat5Y+q5Li66Zi75q2i5ZCO57ut55qE6YGN5Y6GXG4gICAgaWYgKCFhdHRhY2htZW50RmllbGQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign5peg5rOV6I635Y+W6ZmE5Lu2dWR05a2X5q6177yM6K+356Gu6K6k5ZG95Luk5Lit6ZmE5Lu2dWR05a2X5q616Lev5b6E6YWN572u5q2j56Gu77yM5LiU6KeG5Zu+5qih5Z6L5Lit5a2Y5Zyo6ZmE5Lu2dWR05a2X5q61Jyk7XG4gICAgfVxuICAgIGNvbnN0IGRhdGEgPSBiaW5kaW5nTGlzdC50b0pTT04oKTtcbiAgICAvLyDmm7TmlrDnu5HlrprmlbDmja7kuK3pmYTku7Z1ZHTlrZfmrrXkuK3mjpLluo/lrZfmrrXnmoTlgLws5LuF5pu05paw5pyJ6ZmE5Lu255qE6KGMXG4gICAgaWRzLmZvckVhY2goKGlkOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgIGNvbnN0IGl0ZW0gPSBkYXRhLmZpbmQoaXRlbSA9PiBpdGVtICYmIGl0ZW1bYXR0YWNobWVudEZpZWxkXSAmJiBpdGVtW2F0dGFjaG1lbnRGaWVsZF1bJ2F0dGFjaG1lbnRJZCddID09PSBpZCk7XG4gICAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSBpdGVtICYmIGl0ZW0uaWQ7XG4gICAgICBpZiAoIXByaW1hcnlLZXlWYWx1ZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeUtleVZhbHVlKTtcbiAgICAgIGlmIChiaW5kaW5nT2JqZWN0KSB7XG4gICAgICAgIC8vIOmZhOS7tnVkdOWvueixoVxuICAgICAgICBjb25zdCBhdHRhY2htZW50ID0gYmluZGluZ09iamVjdFthdHRhY2htZW50RmllbGRdIGFzIEJpbmRpbmdPYmplY3Q7XG4gICAgICAgIGlmIChhdHRhY2htZW50KSB7XG4gICAgICAgICAgLy8g6I635Y+W5pen5YC8XG4gICAgICAgICAgY29uc3Qgb3JkZXIgPSBhdHRhY2htZW50LmdldFZhbHVlKEFUVEFDSE1FTlRfT1JERVJfRklFTEQpO1xuICAgICAgICAgIGlmIChvcmRlciAhPT0gaW5kZXgpIHtcbiAgICAgICAgICAgIC8vIOabtOaWsOaOkuW6j1xuICAgICAgICAgICAgYXR0YWNobWVudC5zZXRWYWx1ZShBVFRBQ0hNRU5UX09SREVSX0ZJRUxELCBpbmRleCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgLy8jZW5kcmVnaW9uXG5cbiAgLy8gI3JlZ2lvbiDlhbbku5blt6Xlhbfmlrnms5VcblxuICAvKipcbiAgICog5LuO5LiK5LiL5paH5Lit6I635Y+W6KaB5aSE55CG55qE6ZmE5Lu25L+h5oGv5pWw57uEXG4gICAqIEBzdW1tYXJ5XG4gICAqIOS4uuS6hue7n+S4gOWNleS4quWSjOWkmuS4qumZhOS7tueahOWkhOeQhuaWueW8j++8jOe7n+S4gOWMheijheS4uuaVsOe7hFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRGaWxlRXh0ZW5kc0Zyb21Db250ZXh0KCk6IEZVcGxvYWRGaWxlRXh0ZW5kW10ge1xuXG4gICAgY29uc3QgY29tbWFuZENvbnRleHQgPSB0aGlzWydjb250ZXh0J10gYXMgQ29tbWFuZENvbnRleHQ7XG4gICAgY29uc3QgZXZlbnRQYXJhbSA9IGNvbW1hbmRDb250ZXh0LmV2ZW50UGFyYW07XG4gICAgaWYgKCFldmVudFBhcmFtKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgbGV0IGZpbGVFeHRlbmRzOiBhbnlbXTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShldmVudFBhcmFtKSA9PT0gZmFsc2UpIHtcbiAgICAgIGZpbGVFeHRlbmRzID0gW2V2ZW50UGFyYW1dO1xuICAgIH0gZWxzZSB7XG4gICAgICBmaWxlRXh0ZW5kcyA9IGV2ZW50UGFyYW0uY29uY2F0KFtdKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmlsZUV4dGVuZHMgYXMgRlVwbG9hZEZpbGVFeHRlbmRbXTtcbiAgfVxuICAvLyAjZW5kcmVnaW9uXG59XG5cbmV4cG9ydCB7IEZpbGVTZXJ2aWNlIH07XG4iXX0=