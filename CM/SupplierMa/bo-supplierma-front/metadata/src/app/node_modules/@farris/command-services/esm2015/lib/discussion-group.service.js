import { Injectable, Injector } from '@angular/core';
import { FrameContext } from '@farris/devkit';
import { FormLoadingService } from './form-loading/form-loading.service';
import { RuntimeFrameworkService } from './rtf-service';
import { tap } from 'rxjs/operators';
import { EMPTY } from 'rxjs';
// tslint:disable: max-line-length
export class DiscussionGroupService {
    constructor(injector, frameContext, loadingService, runtimeFrameworkService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.loadingService = loadingService;
        this.runtimeFrameworkService = runtimeFrameworkService;
    }
    /**
     * 实体仓库
     */
    get repository() {
        return this.frameContext.repository;
    }
    /**
     * 命令参数
     */
    get params() {
        return this['context'] && this['context']['eventParam'] || {};
    }
    addComment(id, summary, configId, text, visibility, parentId) {
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        const params = this.buildAddCommentParam(id, text, parentId, summary, visibility, configId);
        const restService = this.repository.restService;
        const url = '/api/runtime/comment/v1.0/bill-comment/comment';
        const requestInfo = restService.buildRequestInfo();
        const options = {
            body: Object.assign({ requestInfo }, params)
        };
        this.loadingService.show();
        return restService.invoke(url, 'POST', null, options).pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 查询评论
     * @param id id
     */
    queryComments(id, configId, pageIndex, pageSize) {
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        const restService = this.repository.restService;
        const url = this.buildQueryCommentsUrl(id, pageIndex, pageSize, configId);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 查询所有部门信息
     */
    queryAllOrgs() {
        const restService = this.repository.restService;
        const url = '/api/runtime/sys/v1.0/sysOrgs?param={"layer":"1"}';
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 查询常用@用户
     * @param pageIndex
     * @param pageSize
     */
    queryFrequentAtUsers(pageIndex, pageSize) {
        const restService = this.repository.restService;
        const url = this.buildQueryFrequentAtUsersUrl(pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 获取at用户列表
     * @param user 用户编号或者用户名称（过滤使用）
     * @param pageIndex pageIndex
     * @param pageSize pageSize
     */
    queryAtUsers(user, pageIndex, pageSize) {
        const restService = this.repository.restService;
        const url = this.buildQueryAtUsersUrl(user, pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 构造获取评论列表的url
     * @param id id
     */
    buildQueryCommentsUrl(id, pageIndex, pageSize, configId) {
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 10;
        }
        const serverUri = this.repository.serverUri;
        // const funcId = this.runtimeFrameworkService && this.runtimeFrameworkService.funcId || '';
        return `/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId=${configId}&billId=${id}&pageSize=${pageSize}&pageIndex=${pageIndex}`;
    }
    /**
     * 构造获取@用户url
     */
    buildQueryAtUsersUrl(user, pageIndex, pageSize) {
        const params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 1000;
        }
        if (user) {
            params.push(`param=${user}`);
        }
        params.push(`pageSize=${pageSize}`);
        params.push(`pageIndex=${pageIndex}`);
        return `/api/runtime/comment/v1.0/bill-comment/atUser?${params.join('&')}`;
    }
    buildQueryFrequentAtUsersUrl(pageIndex, pageSize) {
        const params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 6;
        }
        params.push(`pageSize=${pageSize}`);
        params.push(`pageIndex=${pageIndex}`);
        return `/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?${params.join('&')}`;
    }
    buildAddCommentParam(id, text, parentId, summary, visibility, configId) {
        if (typeof text === 'undefined') {
            text = this.params.text;
        }
        if (typeof parentId === 'undefined') {
            parentId = this.params.parentId;
        }
        if (typeof visibility === 'undefined') {
            visibility = this.params.visibility;
        }
        return {
            'bill': {
                'billId': id,
                'configId': configId,
                'summary': summary
            },
            'comment': {
                'billId': id,
                'configId': configId,
                'parentId': parentId || null,
                'text': text,
                'visibility': visibility
            }
        };
    }
}
DiscussionGroupService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
DiscussionGroupService.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: FormLoadingService },
    { type: RuntimeFrameworkService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzY3Vzc2lvbi1ncm91cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2Rpc2N1c3Npb24tZ3JvdXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFVLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDekUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQWtCLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QyxrQ0FBa0M7QUFFbEMsTUFBTSxPQUFPLHNCQUFzQjtJQWFqQyxZQUFvQixRQUFrQixFQUFVLFlBQTBCLEVBQVUsY0FBa0MsRUFBVSx1QkFBZ0Q7UUFBNUosYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQW9CO1FBQVUsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtJQUNoTCxDQUFDO0lBYkQ7O09BRUc7SUFDSCxJQUFZLFVBQVU7UUFDcEIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQW1DLENBQUM7SUFDL0QsQ0FBQztJQUNEOztPQUVHO0lBQ0gsSUFBWSxNQUFNO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEUsQ0FBQztJQUlNLFVBQVUsQ0FBQyxFQUFXLEVBQUUsT0FBZ0IsRUFBRSxRQUFpQixFQUFFLElBQWEsRUFBRSxV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ZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgRW50aXR5IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnLi9ydGYtc2VydmljZSc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgRU1QVFkgfSBmcm9tICdyeGpzJztcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEaXNjdXNzaW9uR3JvdXBTZXJ2aWNlIHtcbiAgLyoqXG4gICAqIOWunuS9k+S7k+W6k1xuICAgKi9cbiAgcHJpdmF0ZSBnZXQgcmVwb3NpdG9yeSgpOiBCZWZSZXBvc2l0b3J5PEVudGl0eT4ge1xuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8RW50aXR5PjtcbiAgfVxuICAvKipcbiAgICog5ZG95Luk5Y+C5pWwXG4gICAqL1xuICBwcml2YXRlIGdldCBwYXJhbXMoKSB7XG4gICAgcmV0dXJuIHRoaXNbJ2NvbnRleHQnXSAmJiB0aGlzWydjb250ZXh0J11bJ2V2ZW50UGFyYW0nXSB8fCB7fTtcbiAgfVxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLCBwcml2YXRlIHJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlOiBSdW50aW1lRnJhbWV3b3JrU2VydmljZSkge1xuICB9XG5cbiAgcHVibGljIGFkZENvbW1lbnQoaWQ/OiBzdHJpbmcsIHN1bW1hcnk/OiBzdHJpbmcsIGNvbmZpZ0lkPzogc3RyaW5nLCB0ZXh0Pzogc3RyaW5nLCB2aXNpYmlsaXR5Pzogc3RyaW5nLCBwYXJlbnRJZD86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWQgPSBpZCB8fCB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCB8fCBudWxsO1xuICAgIGlmICghaWQpIHtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5idWlsZEFkZENvbW1lbnRQYXJhbShpZCwgdGV4dCwgcGFyZW50SWQsIHN1bW1hcnksIHZpc2liaWxpdHksIGNvbmZpZ0lkKTtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCB1cmwgPSAnL2FwaS9ydW50aW1lL2NvbW1lbnQvdjEuMC9iaWxsLWNvbW1lbnQvY29tbWVudCc7XG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKCk7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGJvZHk6IHtcbiAgICAgICAgcmVxdWVzdEluZm8sXG4gICAgICAgIC4uLnBhcmFtc1xuICAgICAgfVxuICAgIH07XG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdQT1NUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmn6Xor6Lor4TorrpcbiAgICogQHBhcmFtIGlkIGlkXG4gICAqL1xuICBwdWJsaWMgcXVlcnlDb21tZW50cyhpZDogc3RyaW5nLCBjb25maWdJZDogc3RyaW5nLCBwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlkID0gaWQgfHwgdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgfHwgbnVsbDtcbiAgICBpZiAoIWlkKSB7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG5cbiAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkUXVlcnlDb21tZW50c1VybChpZCwgcGFnZUluZGV4LCBwYWdlU2l6ZSwgY29uZmlnSWQpO1xuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJykucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmn6Xor6LmiYDmnInpg6jpl6jkv6Hmga9cbiAgICovXG4gIHB1YmxpYyBxdWVyeUFsbE9yZ3MoKSB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9zeXMvdjEuMC9zeXNPcmdzP3BhcmFtPXtcImxheWVyXCI6XCIxXCJ9JztcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5p+l6K+i5bi455SoQOeUqOaItyBcbiAgICogQHBhcmFtIHBhZ2VJbmRleCBcbiAgICogQHBhcmFtIHBhZ2VTaXplIFxuICAgKi9cbiAgcHVibGljIHF1ZXJ5RnJlcXVlbnRBdFVzZXJzKHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRRdWVyeUZyZXF1ZW50QXRVc2Vyc1VybChwYWdlSW5kZXgsIHBhZ2VTaXplKTtcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog6I635Y+WYXTnlKjmiLfliJfooahcbiAgICogQHBhcmFtIHVzZXIg55So5oi357yW5Y+35oiW6ICF55So5oi35ZCN56ew77yI6L+H5ruk5L2/55So77yJXG4gICAqIEBwYXJhbSBwYWdlSW5kZXggcGFnZUluZGV4XG4gICAqIEBwYXJhbSBwYWdlU2l6ZSBwYWdlU2l6ZVxuICAgKi9cbiAgcHVibGljIHF1ZXJ5QXRVc2Vycyh1c2VyPzogc3RyaW5nLCBwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpIHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkUXVlcnlBdFVzZXJzVXJsKHVzZXIsIHBhZ2VJbmRleCwgcGFnZVNpemUpO1xuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJykucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmnoTpgKDojrflj5bor4TorrrliJfooajnmoR1cmxcbiAgICogQHBhcmFtIGlkIGlkXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkUXVlcnlDb21tZW50c1VybChpZDogc3RyaW5nLCBwYWdlSW5kZXg6IG51bWJlciB8IG51bGwsIHBhZ2VTaXplOiBudW1iZXIgfCBudWxsLCBjb25maWdJZDogc3RyaW5nKSB7XG4gICAgaWYgKHR5cGVvZiBwYWdlSW5kZXggPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VJbmRleCA9PT0gbnVsbCkge1xuICAgICAgcGFnZUluZGV4ID0gdGhpcy5wYXJhbXMucGFnZUluZGV4IHx8IDA7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgcGFnZVNpemUgPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VTaXplID09PSBudWxsKSB7XG4gICAgICBwYWdlU2l6ZSA9IHRoaXMucGFyYW1zLnBhZ2VTaXplIHx8IDEwO1xuICAgIH1cbiAgICBjb25zdCBzZXJ2ZXJVcmkgPSB0aGlzLnJlcG9zaXRvcnkuc2VydmVyVXJpO1xuICAgIC8vIGNvbnN0IGZ1bmNJZCA9IHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UgJiYgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5mdW5jSWQgfHwgJyc7XG4gICAgcmV0dXJuIGAvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9jb21tZW50L2J5QmlsbD9jb25maWdJZD0ke2NvbmZpZ0lkfSZiaWxsSWQ9JHtpZH0mcGFnZVNpemU9JHtwYWdlU2l6ZX0mcGFnZUluZGV4PSR7cGFnZUluZGV4fWA7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOiOt+WPlkDnlKjmiLd1cmxcbiAgICovXG4gIHByaXZhdGUgYnVpbGRRdWVyeUF0VXNlcnNVcmwodXNlcj86IHN0cmluZywgcGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XG4gICAgY29uc3QgcGFyYW1zOiBzdHJpbmdbXSA9IFtdO1xuICAgIGlmICh0eXBlb2YgcGFnZUluZGV4ID09PSAndW5kZWZpbmVkJyB8fCBwYWdlSW5kZXggPT09IG51bGwpIHtcbiAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHBhZ2VTaXplID09PSAndW5kZWZpbmVkJyB8fCBwYWdlU2l6ZSA9PT0gbnVsbCkge1xuICAgICAgcGFnZVNpemUgPSB0aGlzLnBhcmFtcy5wYWdlU2l6ZSB8fCAxMDAwO1xuICAgIH1cbiAgICBpZiAodXNlcikge1xuICAgICAgcGFyYW1zLnB1c2goYHBhcmFtPSR7dXNlcn1gKTtcbiAgICB9XG4gICAgcGFyYW1zLnB1c2goYHBhZ2VTaXplPSR7cGFnZVNpemV9YCk7XG4gICAgcGFyYW1zLnB1c2goYHBhZ2VJbmRleD0ke3BhZ2VJbmRleH1gKTtcbiAgICByZXR1cm4gYC9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2F0VXNlcj8ke3BhcmFtcy5qb2luKCcmJyl9YDtcbiAgfVxuICBwcml2YXRlIGJ1aWxkUXVlcnlGcmVxdWVudEF0VXNlcnNVcmwocGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XG4gICAgY29uc3QgcGFyYW1zOiBzdHJpbmdbXSA9IFtdO1xuICAgIGlmICh0eXBlb2YgcGFnZUluZGV4ID09PSAndW5kZWZpbmVkJyB8fCBwYWdlSW5kZXggPT09IG51bGwpIHtcbiAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHBhZ2VTaXplID09PSAndW5kZWZpbmVkJyB8fCBwYWdlU2l6ZSA9PT0gbnVsbCkge1xuICAgICAgcGFnZVNpemUgPSB0aGlzLnBhcmFtcy5wYWdlU2l6ZSB8fCA2O1xuICAgIH1cbiAgICBwYXJhbXMucHVzaChgcGFnZVNpemU9JHtwYWdlU2l6ZX1gKTtcbiAgICBwYXJhbXMucHVzaChgcGFnZUluZGV4PSR7cGFnZUluZGV4fWApO1xuICAgIHJldHVybiBgL2FwaS9ydW50aW1lL2NvbW1lbnQvdjEuMC9iaWxsLWNvbW1lbnQvZnJlcXVlbnRBdFVzZXJzPyR7cGFyYW1zLmpvaW4oJyYnKX1gO1xuICB9XG4gIHByaXZhdGUgYnVpbGRBZGRDb21tZW50UGFyYW0oaWQ6IHN0cmluZywgdGV4dDogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBzdW1tYXJ5OiBzdHJpbmcsIHZpc2liaWxpdHk6IHN0cmluZywgY29uZmlnSWQ6IHN0cmluZykge1xuICAgIGlmICh0eXBlb2YgdGV4dCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRleHQgPSB0aGlzLnBhcmFtcy50ZXh0O1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHBhcmVudElkID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcGFyZW50SWQgPSB0aGlzLnBhcmFtcy5wYXJlbnRJZDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB2aXNpYmlsaXR5ID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdmlzaWJpbGl0eSA9IHRoaXMucGFyYW1zLnZpc2liaWxpdHk7XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICAnYmlsbCc6IHtcbiAgICAgICAgJ2JpbGxJZCc6IGlkLFxuICAgICAgICAnY29uZmlnSWQnOiBjb25maWdJZCxcbiAgICAgICAgJ3N1bW1hcnknOiBzdW1tYXJ5XG4gICAgICB9LFxuICAgICAgJ2NvbW1lbnQnOiB7XG4gICAgICAgICdiaWxsSWQnOiBpZCxcbiAgICAgICAgJ2NvbmZpZ0lkJzogY29uZmlnSWQsXG4gICAgICAgICdwYXJlbnRJZCc6IHBhcmVudElkIHx8IG51bGwsXG4gICAgICAgICd0ZXh0JzogdGV4dCxcbiAgICAgICAgJ3Zpc2liaWxpdHknOiB2aXNpYmlsaXR5XG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=