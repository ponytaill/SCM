import { Injectable, InjectFlags, Optional } from '@angular/core';
import { from, of, empty, EMPTY } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { UploadDialogService, UploadLimit, DownloadService, FileState } from '@gsp-svc/formdoc-upload';
import { FileViewerService } from '@gsp-svc/file-viewer';
import { FrameContext, BindingPathConverter, DataPathCreator } from '@farris/devkit';
import { FormNotifyService } from '../form-notify.service';
import { AttachmentUtil } from './attachment.util';
import { AttachmentDataService } from './attachment-data.service';
import { LanguageService } from '../languag.service';
import { EntityService } from '../entity-services/index';
// tslint:disable: max-line-length
/**
 * 附件服务
 */
var AttachmentService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function AttachmentService(frameContext, attachDataService, notifyService, uploadDialogService, downloadService) {
        this.frameContext = frameContext;
        this.attachDataService = attachDataService;
        this.notifyService = notifyService;
        this.uploadDialogService = uploadDialogService;
        this.downloadService = downloadService;
        /**
         * 默认根目录
         */
        this.defaultRootDirId = '';
        this.setLanguageService();
        this.fileViewerService = this.frameContext.injector.get(FileViewerService, null, InjectFlags.Optional);
        this.entityService = this.frameContext.injector.get(EntityService, null, InjectFlags.Optional);
        if (!this.downloadService && typeof DownloadService !== 'undefined') {
            this.downloadService = this.frameContext.injector.get(DownloadService, null);
        }
    }
    Object.defineProperty(AttachmentService.prototype, "defaultParentDirName", {
        /**
         * 默认父路径
         */
        get: function () {
            return this.frameContext.bindingData.list.currentId;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AttachmentService.prototype, "bindingData", {
        /**
         * 绑定数据
         */
        get: function () {
            return this.frameContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置语言服务
     */
    AttachmentService.prototype.setLanguageService = function () {
        var injector = this.frameContext.injector;
        this.languageService = injector.get(LanguageService, null, InjectFlags.Optional);
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
    };
    /**
     * 上传单个文件
     * @param attachmentIdPath 附件内码字段的路径，形如/attachInfo/attachmentId；
     * @param attachmentNamePath 附件名称字段的路径
     */
    AttachmentService.prototype.uploadAndUpdateRow = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType, id) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        uploadLimit.fileCount = 1;
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        // 获取老的附件id数组
        var attachmentIdList = [];
        var currentItem = null;
        if (id) {
            // 修正当前行
            var bindingList = this.frameContext.bindingData.getList();
            if (bindingList.currentId !== id) {
                bindingList.setCurrentId(id, true, true);
            }
            // 如果指定了id则获取指定id的行
            currentItem = this.getSpecialRow(attachmentInfoFieldPath, id);
        }
        else {
            // 没有指定则使用当前行，可能存在当前行和事件行不一致的情况，此时应该在命令中传递id参数
            currentItem = this.getCurrentRow(attachmentInfoFieldPath);
        }
        if (currentItem && currentItem.primaryKeyValue) {
            var attachmentIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, [currentItem.primaryKeyValue]);
            if (attachmentIds && attachmentIds.length > 0) {
                attachmentIdList.push.apply(attachmentIdList, attachmentIds);
            }
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit, attachmentIdList));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return empty();
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            // 是否上传判断
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            var firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
            return _this.attachDataService.updateRow(attachmentInfoFieldPath, firstAttachmentInfo);
        }));
        return result$;
    };
    /**
     * 上传单个文件（支持多列）
     * @param attachmentInfoFieldPath 附件内码字段的路径，形如/attachInfo/attachmentId；
     * @param rootDirId 附件存储根目录
     * @param parentDirName 附件存储目录
     * @param fileType 文件类型，like .txt,.docx
     */
    AttachmentService.prototype.uploadAndUpdateRowWithPropertyName = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType, id) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        uploadLimit.fileCount = 1;
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        // 获取老的附件id数组
        var attachmentIdList = [];
        var currentItem = null;
        if (id) {
            // 修正当前行
            var bindingList = this.frameContext.bindingData.getList();
            if (bindingList.currentId !== id) {
                bindingList.setCurrentId(id, true, true);
            }
            // 如果指定了id则获取指定id的行
            currentItem = this.getSpecialRow(attachmentInfoFieldPath, id);
        }
        else {
            // 没有指定则使用当前行，可能存在当前行和事件行不一致的情况，此时应该在命令中传递id参数
            currentItem = this.getCurrentRow(attachmentInfoFieldPath);
        }
        if (currentItem && currentItem.primaryKeyValue) {
            var attachmentIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, [currentItem.primaryKeyValue]);
            if (attachmentIds && attachmentIds.length > 0) {
                attachmentIdList.push.apply(attachmentIdList, attachmentIds);
            }
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit, attachmentIdList));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            // 是否上传判断
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            var firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
            return _this.attachDataService.updateRowWithPropertyName(attachmentInfoFieldPath, firstAttachmentInfo);
        }));
        return result$;
    };
    /**
     * 上传多个文件
     */
    AttachmentService.prototype.uploadAndBatchAddRows = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            return _this.attachDataService.updateRows(attachmentInfoFieldPath, attachmentInfos);
        }));
        return result$;
    };
    /**
     * 上传多个文件
     */
    AttachmentService.prototype.uploadAndBatchAddRowsWithPropertyName = function (attachmentInfoFieldPath, rootDirId, parentDirName, fileType) {
        var _this = this;
        var rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        var formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        var uploadLimit = new UploadLimit();
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        var dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit));
        var result$ = dialog$.pipe(switchMap(function (fileInfos) {
            if (!fileInfos || fileInfos.length === 0) {
                _this.notifyService.warning(_this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter(function (fileInfo) {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            var attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            return _this.attachDataService.updateRowsWithPropertyName(attachmentInfoFieldPath, attachmentInfos);
        }));
        return result$;
    };
    /**
     * 下载附件（根据附件id）
     */
    AttachmentService.prototype.download = function (attachId, rootId) {
        if (!attachId) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        rootId = rootId || 'default-root';
        var url = this.getDownloadUrl([attachId], rootId);
        // let url = '';
        // if (rootId) {
        //   url = `/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=${attachId}&rootid=${rootId}`;
        // } else {
        //   url = `/api/runtime/dfs/v1.0/formdoc/download/${attachId}`;
        // }
        window.open(url);
        return of(true);
    };
    /**
     * 批量下载附件（根据附件id数组）
     */
    AttachmentService.prototype.batchDownload = function (attachIds, rootId) {
        if (!attachIds || attachIds.length === 0) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        // 只选择一个附件时按单个附件下载处理
        if (attachIds.length === 1) {
            return this.download(attachIds[0], rootId);
        }
        // const attachIdsString = JSON.stringify(attachIds);
        // const url = `/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist=${attachIdsString}&rootid=${rootId}`;
        var url = this.getDownloadUrl(attachIds, rootId);
        window.open(url);
        return of(true);
    };
    /**
     * 获取下载路径
     * @param metadataidlist 附件id数组
     * @param rootId rootId
     */
    AttachmentService.prototype.getDownloadUrl = function (metadataidlist, rootId) {
        rootId = rootId || 'default-root';
        if (this.downloadService) {
            if (metadataidlist.length === 1) {
                return this.downloadService.getDownloadUrl(metadataidlist[0], rootId);
            }
            else {
                var attachIdsString = JSON.stringify(metadataidlist);
                return this.downloadService.getMultipleDownloadUrl(attachIdsString, rootId);
            }
        }
        else {
            console.warn('因安全问题，附件下载提供安全校验机制，附件下载功能需重新编译。');
            if (metadataidlist.length === 1) {
                return "/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=" + metadataidlist[0] + "&rootid=" + rootId;
            }
            else {
                var attachIdsString = JSON.stringify(metadataidlist);
                return "/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist=" + attachIdsString + "&rootid=" + rootId;
            }
        }
    };
    /**
     * 下载（根据数据id）
     */
    AttachmentService.prototype.downloadByDataId = function (dataId, attachmentInfoFieldPath, rootId) {
        if (!dataId) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        var dataIds = [dataId];
        var attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds);
        if (attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        var attachId = attachIds[0];
        return this.download(attachId);
    };
    /**
     * 批量下载附件
     */
    AttachmentService.prototype.batchDownloadByDataIds = function (dataIds, attachmentInfoFieldPath, rootId) {
        if (typeof dataIds === 'string' && dataIds && dataIds.length > 0) {
            dataIds = dataIds.split(',').filter(function (p) { return p; });
        }
        if (!dataIds || Array.isArray(dataIds) === false || dataIds.length === 0) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        var ids = [].concat(dataIds);
        var attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, ids);
        if (attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        return this.batchDownload(attachIds, rootId);
    };
    /**
     * 根据附件UDT字段的路径预览附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param rootDirId 跟目录id
     * @param ids 附件id
     */
    AttachmentService.prototype.previewByAttachmentInfoFieldPath = function (attachmentInfoFieldPath, rootDirId, ids) {
        if (!attachmentInfoFieldPath || !rootDirId) {
            throw new Error('attachmentInfoFieldPath和rootDirId不能为空，请填写');
        }
        var attachIds = [];
        var dataIds = [];
        if (ids && ids.length > 0) {
            if (typeof (ids) === 'string') {
                dataIds.push(ids);
            }
            else {
                dataIds = ids;
            }
            attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds);
        }
        else {
            attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        }
        if (attachIds && attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        return this.previewByAttachmentIds(attachIds, rootDirId);
    };
    /**
     * 根据附件UDT字段的路径预览当前行的附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewByAttachmentInfoFieldPathWithIndex = function (attachmentInfoFieldPath, rootDirId) {
        if (!attachmentInfoFieldPath || !rootDirId) {
            throw new Error('attachmentInfoFieldPath和rootDirId不能为空，请填写');
        }
        var currentRow = this.getCurrentRow(attachmentInfoFieldPath);
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        var attachmentFieldName = parentBindingPathArray.pop();
        if (!currentRow[attachmentFieldName] || !currentRow[attachmentFieldName]['attachmentId']) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        var attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        if (attachIds && attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        var attachmentId = this.getCurrentAttachmentId(attachmentInfoFieldPath);
        if (!attachmentId) {
            throw new Error('要预览的附件id不存在，请确认');
        }
        else {
            return this.previewFileListWithIndex(attachIds, rootDirId, attachmentId);
        }
    };
    /**
     * 根据目录预览附件
     * @param subDirName 父目录名称
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewBySubDirName = function (subDirName, rootDirId) {
        if (!subDirName || !rootDirId) {
            throw new Error('subDirName和rootDirId不能为空，请填写');
        }
        var viewer$ = from(this.fileViewerService.viewerFormFile(subDirName, rootDirId));
        return viewer$;
    };
    /**
     * 根据目录预览指定索引的附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param subDirName 子目录名称
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewBySubDirNameWithIndex = function (attachmentInfoFieldPath, subDirName, rootDirId) {
        if (!subDirName || !rootDirId) {
            throw new Error('subDirName和rootDirId不能为空，请填写');
        }
        // const attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        var attachmentId = this.getCurrentAttachmentId(attachmentInfoFieldPath);
        if (!attachmentId) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        var viewer$ = from(this.fileViewerService.viewerFormFileWithIndex(subDirName, rootDirId, attachmentId));
        return viewer$;
    };
    /**
     * 根据附件id数组预览附件
     * @param attachmentIds 附件id数组
     * @param rootDirId 根目录id
     */
    AttachmentService.prototype.previewByAttachmentIds = function (attachmentIds, rootDirId) {
        var viewer$ = from(this.fileViewerService.viewerFileList(attachmentIds, rootDirId));
        return viewer$;
    };
    /**
     * 根据附件id数组预览指定索引的附件
     * @param attachmentIds 附件id数组
     * @param rootDirId 根目录id
     * @param attachmentId 附件Id
     */
    AttachmentService.prototype.previewFileListWithIndex = function (attachmentIds, rootDirId, attachmentId) {
        var viewer$ = from(this.fileViewerService.viewerFileListWithIndex(attachmentIds, rootDirId, attachmentId));
        return viewer$;
    };
    /**
     * 生成版本号
     * @param versions 历史版本号
     * @description 默认编码规则v1.0 v2.0 ...
     */
    AttachmentService.prototype.genVersion = function (versions) {
        if (!versions) {
            versions = [];
        }
        var mainCode = versions.length + 1;
        return "V" + mainCode + ".0";
    };
    /**
     * 更新附件版本信息
     * @param versionField 附件版本字段
     * @param historyField 是否历史版本字段
     * @param attachmentFieldPath 附件udt字段路径
     */
    AttachmentService.prototype.updateAttachmentVersion = function (versionField, historyField, attachmentFieldPath) {
        var _this = this;
        /**
         * 遍历所有附件行
         * 找到所有没有附件版本的行
         * 遍历这些行
         * 通过文件名去查找同名的且有附件版本号的行
         * 这些行历史版本字段置为true
         * 无版本号的行，版本= 上行数 + 1
         *
         */
        var bindingPaths = attachmentFieldPath.split('/').filter(function (p) { return p; });
        // 弹出附件udt字段
        var attachmentField = bindingPaths.pop();
        // 获取到所有的附件
        var attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        var befRepository = this.frameContext.repository;
        var entityManager = befRepository.entityManager;
        var dataPath = DataPathCreator.createByShortPathFromRoot(bindingPaths, entityManager, this.frameContext.bindingData);
        var paths = dataPath.toArray().map(function (path) {
            if (path.startsWith('PropName:')) {
                return path.split(':')[1];
            }
            else {
                return path;
            }
        });
        if (attachmentBindingList) {
            var attachments_1 = attachmentBindingList.toJSON();
            // 只处理有附件的情况
            if (attachments_1) {
                var versionLessRows = attachments_1.filter(function (item) { return !item[versionField]; });
                versionLessRows.forEach(function (item) {
                    var fileName = item[attachmentField]['fileName'];
                    var versionedRows = attachments_1.filter(function (row) { return row[attachmentField]['fileName'] === fileName && row[versionField]; });
                    paths.pop();
                    paths.push("DataId:" + item[attachmentBindingList.primaryKey]);
                    var entity = _this.frameContext.repository.entityCollection.getEntityByPath(paths);
                    var version = _this.genVersion(versionedRows);
                    entity[versionField] = version;
                    entity[historyField] = false;
                    // 处理历史记录
                    versionedRows.forEach(function (row) {
                        paths.pop();
                        paths.push("DataId:" + row[attachmentBindingList.primaryKey]);
                        entity = _this.frameContext.repository.entityCollection.getEntityByPath(paths);
                        entity[historyField] = true;
                    });
                });
            }
        }
    };
    AttachmentService.prototype.isAttachmentCanDelete = function (historyField, attachmentFieldPath) {
        var bindingPaths = attachmentFieldPath.split('/').filter(function (p) { return p; });
        // 弹出附件udt字段
        bindingPaths.pop();
        var attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        var bindingObject = attachmentBindingList.currentItem;
        if (bindingObject[historyField] === true) {
            this.notifyService.warning(this.languageService.historyAttachment, { hideTitle: true });
            return EMPTY;
        }
    };
    AttachmentService.prototype.updateAttachmentHistory = function (versionField, historyField, attachmentFieldPath) {
        var _this = this;
        var bindingPaths = attachmentFieldPath.split('/').filter(function (p) { return p; });
        // 弹出附件udt字段
        var attachmentField = bindingPaths.pop();
        // 获取到所有的附件
        var attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        // const befRepository = this.frameContext.repository as BefRepository<any>;
        // const entityManager = befRepository.entityManager;
        if (attachmentBindingList) {
            var attachments = attachmentBindingList.toJSON();
            var versionedRows = attachments.filter(function (item) { return item[versionField]; });
            var fileNameMap_1 = new Map();
            var befRepository = this.frameContext.repository;
            var entityManager = befRepository.entityManager;
            var dataPath = DataPathCreator.createByShortPathFromRoot(bindingPaths, entityManager, this.frameContext.bindingData);
            var paths_1 = dataPath.toArray().map(function (path) {
                if (path.startsWith('PropName:')) {
                    return path.split(':')[1];
                }
                else {
                    return path;
                }
            });
            versionedRows.forEach(function (item) {
                var fileName = item[attachmentField]['fileName'];
                if (fileNameMap_1.has(fileName)) {
                    fileNameMap_1.get(fileName).push(item);
                }
                else {
                    fileNameMap_1.set(fileName, [item]);
                }
            });
            Array.from(fileNameMap_1.values()).forEach(function (array) {
                array.sort(function (x, y) {
                    var xVersion = parseInt(x[versionField].replace(/[a-zA-Z\.]/g, ''));
                    var yVersion = parseInt(y[versionField].replace(/[a-zA-Z\.]/g, ''));
                    return yVersion - xVersion;
                });
                var row = array[0];
                paths_1.pop();
                paths_1.push("DataId:" + row[attachmentBindingList.primaryKey]);
                var entity = _this.frameContext.repository.entityCollection.getEntityByPath(paths_1);
                entity[historyField] = false;
            });
        }
    };
    /**
     * 获取当前视图模型当前行的附件id
     * @param attachmentInfoFieldPath 附件udt字段
     */
    AttachmentService.prototype.getCurrentAttachmentId = function (attachmentInfoFieldPath) {
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        var attachmentFieldName = parentBindingPathArray.pop();
        var bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        var currentItem = bindingList.currentItem;
        if (currentItem && currentItem.primaryKeyValue) {
            return currentItem[attachmentFieldName] && currentItem[attachmentFieldName]['attachmentId'] || null;
        }
        else {
            return null;
        }
    };
    /**
     * 获取当前行
     * @param attachmentInfoFieldPath udt字段
     */
    AttachmentService.prototype.getCurrentRow = function (attachmentInfoFieldPath) {
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        var bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        var currentItem = bindingList && bindingList.currentItem;
        return currentItem;
    };
    /**
     * 获取指定附件信息表的指定行
     * @param attachmentInfoFieldPath
     * @param primaryValue
     * @returns
     */
    AttachmentService.prototype.getSpecialRow = function (attachmentInfoFieldPath, primaryValue) {
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        var bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        var currentItem = bindingList && bindingList.findById(primaryValue);
        return currentItem;
    };
    /**
     * 获取dataIds对应Entity上的附件id数组
     */
    AttachmentService.prototype.getAttachmentIdsByPathAndDataIds = function (attachmentInfoFieldPath, dataIds) {
        // 解析路径
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        var attachmentFieldName = parentBindingPathArray.pop();
        // 获取附件所在实体的数据列表，不传递dataIds参数，则返回全部
        var entityListData = this.entityService.getEntityListData(parentBindingPathArray);
        var filteredEntityListData = [];
        if (dataIds && Array.isArray(dataIds) === true) {
            filteredEntityListData = entityListData.filter(function (entityData) {
                return dataIds.indexOf(entityData.id) > -1;
            });
        }
        else {
            filteredEntityListData = entityListData;
        }
        // 转换为附件Id数组
        var attachmentIds = [];
        filteredEntityListData.forEach(function (entityData) {
            if (entityData[attachmentFieldName]) {
                var attachmentId = entityData[attachmentFieldName]['attachmentId'];
                if (attachmentId) {
                    attachmentIds.push(attachmentId);
                }
            }
        });
        return attachmentIds;
    };
    AttachmentService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    AttachmentService.ctorParameters = function () { return [
        { type: FrameContext },
        { type: AttachmentDataService },
        { type: FormNotifyService },
        { type: UploadDialogService },
        { type: DownloadService, decorators: [{ type: Optional }] }
    ]; };
    return AttachmentService;
}());
export { AttachmentService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQvYXR0YWNobWVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRSxPQUFPLEVBQWMsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsbUJBQW1CLEVBQWtCLFdBQVcsRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDdkgsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQsT0FBTyxFQUFFLFlBQVksRUFBZSxvQkFBb0IsRUFBNkIsZUFBZSxFQUFzQixNQUFNLGdCQUFnQixDQUFDO0FBQ2pKLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBR3pELGtDQUFrQztBQUNsQzs7R0FFRztBQUNIO0lBcUNFOztPQUVHO0lBQ0gsMkJBQ1UsWUFBMEIsRUFDMUIsaUJBQXdDLEVBQ3hDLGFBQWdDLEVBQ2hDLG1CQUF3QyxFQUM1QixlQUFnQztRQUo1QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixzQkFBaUIsR0FBakIs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QUMsaUJBQWlCLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUNwRixJQUFJLHNCQUFzQixHQUFHLEVBQUUsQ0FBQztRQUNoQyxJQUFJLE9BQU8sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksRUFBRTtZQUM5QyxzQkFBc0IsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLFVBQUMsVUFBZTtnQkFDN0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUM3QyxDQUFDLENBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCxzQkFBc0IsR0FBRyxjQUFjLENBQUM7U0FDekM7UUFFRCxZQUFZO1FBQ1osSUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxVQUFDLFVBQWU7WUFDN0MsSUFBSSxVQUFVLENBQUMsbUJBQW1CLENBQUMsRUFBRTtnQkFDbkMsSUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLG1CQUFtQixDQUFDLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ3JFLElBQUksWUFBWSxFQUFFO29CQUNoQixhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO2lCQUNsQzthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDOztnQkFscUJGLFVBQVU7Ozs7Z0JBWkYsWUFBWTtnQkFHWixxQkFBcUI7Z0JBRnJCLGlCQUFpQjtnQkFIakIsbUJBQW1CO2dCQUErQixlQUFlLHVCQTJEckUsUUFBUTs7SUFzbkJiLHdCQUFDO0NBQUEsQUFucUJELElBbXFCQztBQUVELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0RmxhZ3MsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tLCBvZiwgZW1wdHksIEVNUFRZIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBVcGxvYWREaWFsb2dTZXJ2aWNlLCBVcGxvYWRGaWxlSW5mbywgVXBsb2FkTGltaXQsIERvd25sb2FkU2VydmljZSwgRmlsZVN0YXRlIH0gZnJvbSAnQGdzcC1zdmMvZm9ybWRvYy11cGxvYWQnO1xuaW1wb3J0IHsgRmlsZVZpZXdlclNlcnZpY2UgfSBmcm9tICdAZ3NwLXN2Yy9maWxlLXZpZXdlcic7XG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIEJpbmRpbmdEYXRhLCBCaW5kaW5nUGF0aENvbnZlcnRlciwgQmluZGluZ0xpc3QsIERhdGFQYXRoVXRpbCwgRGF0YVBhdGhDcmVhdG9yLCBFbnRpdHlMaXN0LCBFbnRpdHkgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgQXR0YWNobWVudFV0aWwgfSBmcm9tICcuL2F0dGFjaG1lbnQudXRpbCc7XG5pbXBvcnQgeyBBdHRhY2htZW50RGF0YVNlcnZpY2UgfSBmcm9tICcuL2F0dGFjaG1lbnQtZGF0YS5zZXJ2aWNlJztcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4uL2xhbmd1YWcuc2VydmljZSc7XG5pbXBvcnQgeyBFbnRpdHlTZXJ2aWNlIH0gZnJvbSAnLi4vZW50aXR5LXNlcnZpY2VzL2luZGV4JztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XG5cbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcbi8qKlxuICog6ZmE5Lu25pyN5YqhXG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIEF0dGFjaG1lbnRTZXJ2aWNlIHtcblxuICAvKipcbiAgICog6buY6K6k5qC555uu5b2VXG4gICAqL1xuICBwcml2YXRlIGRlZmF1bHRSb290RGlySWQgPSAnJztcblxuICAvKipcbiAgICog6buY6K6k54i26Lev5b6EXG4gICAqL1xuICBwcml2YXRlIGdldCBkZWZhdWx0UGFyZW50RGlyTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcbiAgfVxuXG4gIC8qKlxuICAgKiDnu5HlrprmlbDmja5cbiAgICovXG4gIHByaXZhdGUgZ2V0IGJpbmRpbmdEYXRhKCk6IEJpbmRpbmdEYXRhIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XG4gIH1cblxuICAvKipcbiAgICog5aSa6K+t5pyN5YqhXG4gICAqL1xuICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlO1xuXG4gIC8qKlxuICAgKiDpmYTku7bpooTop4jmnI3liqFcbiAgICovXG4gIHByaXZhdGUgZmlsZVZpZXdlclNlcnZpY2U6IEZpbGVWaWV3ZXJTZXJ2aWNlO1xuXG4gIC8qKlxuICAgKiDlrp7kvZPmnI3liqFcbiAgICovXG4gIHByaXZhdGUgZW50aXR5U2VydmljZTogRW50aXR5U2VydmljZTtcblxuICAvKipcbiAgICog5p6E6YCg5Ye95pWwXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxuICAgIHByaXZhdGUgYXR0YWNoRGF0YVNlcnZpY2U6IEF0dGFjaG1lbnREYXRhU2VydmljZSxcbiAgICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgdXBsb2FkRGlhbG9nU2VydmljZTogVXBsb2FkRGlhbG9nU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGRvd25sb2FkU2VydmljZTogRG93bmxvYWRTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuc2V0TGFuZ3VhZ2VTZXJ2aWNlKCk7XG4gICAgdGhpcy5maWxlVmlld2VyU2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxGaWxlVmlld2VyU2VydmljZT4oRmlsZVZpZXdlclNlcnZpY2UsIG51bGwsIEluamVjdEZsYWdzLk9wdGlvbmFsKTtcbiAgICB0aGlzLmVudGl0eVNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8RW50aXR5U2VydmljZT4oRW50aXR5U2VydmljZSwgbnVsbCwgSW5qZWN0RmxhZ3MuT3B0aW9uYWwpO1xuICAgIGlmICghdGhpcy5kb3dubG9hZFNlcnZpY2UgJiYgdHlwZW9mIERvd25sb2FkU2VydmljZSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRoaXMuZG93bmxvYWRTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PERvd25sb2FkU2VydmljZT4oRG93bmxvYWRTZXJ2aWNlLCBudWxsKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6K6+572u6K+t6KiA5pyN5YqhXG4gICAqL1xuICBwcml2YXRlIHNldExhbmd1YWdlU2VydmljZSgpIHtcbiAgICBjb25zdCBpbmplY3RvciA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yO1xuICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0PExhbmd1YWdlU2VydmljZT4oTGFuZ3VhZ2VTZXJ2aWNlLCBudWxsLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5LiK5Lyg5Y2V5Liq5paH5Lu2XG4gICAqIEBwYXJhbSBhdHRhY2htZW50SWRQYXRoIOmZhOS7tuWGheeggeWtl+auteeahOi3r+W+hO+8jOW9ouWmgi9hdHRhY2hJbmZvL2F0dGFjaG1lbnRJZO+8m1xuICAgKiBAcGFyYW0gYXR0YWNobWVudE5hbWVQYXRoIOmZhOS7tuWQjeensOWtl+auteeahOi3r+W+hFxuICAgKi9cbiAgcHVibGljIHVwbG9hZEFuZFVwZGF0ZVJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCByb290RGlySWQ/OiBzdHJpbmcsIHBhcmVudERpck5hbWU/OiBzdHJpbmcsIGZpbGVUeXBlPzogc3RyaW5nLCBpZD86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgcm9vdElkID0gcm9vdERpcklkID8gcm9vdERpcklkIDogdGhpcy5kZWZhdWx0Um9vdERpcklkO1xuICAgIGNvbnN0IGZvcm1JZCA9IHBhcmVudERpck5hbWUgPyBwYXJlbnREaXJOYW1lIDogdGhpcy5kZWZhdWx0UGFyZW50RGlyTmFtZTtcbiAgICBpZiAoIXJvb3RJZCB8fCAhZm9ybUlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jvb3REaXJJZOWSjHBhcmVudERpck5hbWXkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGxvYWRMaW1pdDogVXBsb2FkTGltaXQgPSBuZXcgVXBsb2FkTGltaXQoKTtcbiAgICB1cGxvYWRMaW1pdC5maWxlQ291bnQgPSAxO1xuICAgIGlmIChmaWxlVHlwZSkge1xuICAgICAgdXBsb2FkTGltaXQuZmlsZVR5cGUgPSBmaWxlVHlwZTtcbiAgICB9XG4gICAgLy8g6I635Y+W6ICB55qE6ZmE5Lu2aWTmlbDnu4RcbiAgICBjb25zdCBhdHRhY2htZW50SWRMaXN0ID0gW107XG4gICAgbGV0IGN1cnJlbnRJdGVtID0gbnVsbDtcbiAgICBpZiAoaWQpIHtcbiAgICAgIC8vIOS/ruato+W9k+WJjeihjFxuICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xuICAgICAgaWYgKGJpbmRpbmdMaXN0LmN1cnJlbnRJZCAhPT0gaWQpIHtcbiAgICAgICAgYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkLCB0cnVlLCB0cnVlKTtcbiAgICAgIH1cbiAgICAgIC8vIOWmguaenOaMh+WumuS6hmlk5YiZ6I635Y+W5oyH5a6aaWTnmoTooYxcbiAgICAgIGN1cnJlbnRJdGVtID0gdGhpcy5nZXRTcGVjaWFsUm93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBpZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOayoeacieaMh+WumuWImeS9v+eUqOW9k+WJjeihjO+8jOWPr+iDveWtmOWcqOW9k+WJjeihjOWSjOS6i+S7tuihjOS4jeS4gOiHtOeahOaDheWGte+8jOatpOaXtuW6lOivpeWcqOWRveS7pOS4reS8oOmAkmlk5Y+C5pWwXG4gICAgICBjdXJyZW50SXRlbSA9IHRoaXMuZ2V0Q3VycmVudFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgfVxuICAgIGlmIChjdXJyZW50SXRlbSAmJiBjdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUpIHtcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnRJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBbY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlXSk7XG4gICAgICBpZiAoYXR0YWNobWVudElkcyAmJiBhdHRhY2htZW50SWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgYXR0YWNobWVudElkTGlzdC5wdXNoLmFwcGx5KGF0dGFjaG1lbnRJZExpc3QsIGF0dGFjaG1lbnRJZHMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRpYWxvZyQgPSBmcm9tKHRoaXMudXBsb2FkRGlhbG9nU2VydmljZS51cGxvYWRGaWxlV2l0aExpbWl0KGZvcm1JZCwgcm9vdElkLCB1cGxvYWRMaW1pdCwgYXR0YWNobWVudElkTGlzdCkpO1xuICAgIGNvbnN0IHJlc3VsdCQgPSBkaWFsb2ckLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKGZpbGVJbmZvczogVXBsb2FkRmlsZUluZm9bXSkgPT4ge1xuICAgICAgICBpZiAoIWZpbGVJbmZvcyB8fCBmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzVXBsb2FkRmlyc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICB9XG4gICAgICAgIC8vIOi/h+a7pOWHunN0YXRl5Li65paw5aKe55qE6ZmE5Lu2XG4gICAgICAgIGZpbGVJbmZvcyA9IGZpbGVJbmZvcy5maWx0ZXIoKGZpbGVJbmZvOiBVcGxvYWRGaWxlSW5mbykgPT4ge1xuICAgICAgICAgIGlmIChmaWxlSW5mby5oYXNPd25Qcm9wZXJ0eSgnc3RhdGUnKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZpbGVJbmZvLnN0YXRlID09PSBGaWxlU3RhdGUuTmV3O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIC8vIOaYr+WQpuS4iuS8oOWIpOaWrVxuICAgICAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSBBdHRhY2htZW50VXRpbC5jb252ZXJ0VG9BdHRhY2htZW50SW5mb3MoZmlsZUluZm9zKTtcbiAgICAgICAgY29uc3QgZmlyc3RBdHRhY2htZW50SW5mbyA9IEF0dGFjaG1lbnRVdGlsLmdldEZpcnN0QXR0YWNobWVudEluZm8oYXR0YWNobWVudEluZm9zKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBmaXJzdEF0dGFjaG1lbnRJbmZvKTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJldHVybiByZXN1bHQkO1xuICB9XG4gIC8qKlxuICAgKiDkuIrkvKDljZXkuKrmlofku7bvvIjmlK/mjIHlpJrliJfvvIlcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tuWGheeggeWtl+auteeahOi3r+W+hO+8jOW9ouWmgi9hdHRhY2hJbmZvL2F0dGFjaG1lbnRJZO+8m1xuICAgKiBAcGFyYW0gcm9vdERpcklkIOmZhOS7tuWtmOWCqOagueebruW9lVxuICAgKiBAcGFyYW0gcGFyZW50RGlyTmFtZSDpmYTku7blrZjlgqjnm67lvZVcbiAgICogQHBhcmFtIGZpbGVUeXBlIOaWh+S7tuexu+Wei++8jGxpa2UgLnR4dCwuZG9jeFxuICAgKi9cbiAgcHVibGljIHVwbG9hZEFuZFVwZGF0ZVJvd1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nLCBmaWxlVHlwZT86IHN0cmluZywgaWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJvb3RJZCA9IHJvb3REaXJJZCA/IHJvb3REaXJJZCA6IHRoaXMuZGVmYXVsdFJvb3REaXJJZDtcbiAgICBjb25zdCBmb3JtSWQgPSBwYXJlbnREaXJOYW1lID8gcGFyZW50RGlyTmFtZSA6IHRoaXMuZGVmYXVsdFBhcmVudERpck5hbWU7XG4gICAgaWYgKCFyb290SWQgfHwgIWZvcm1JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyb290RGlySWTlkoxwYXJlbnREaXJOYW1l5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBsb2FkTGltaXQ6IFVwbG9hZExpbWl0ID0gbmV3IFVwbG9hZExpbWl0KCk7XG4gICAgdXBsb2FkTGltaXQuZmlsZUNvdW50ID0gMTtcbiAgICBpZiAoZmlsZVR5cGUpIHtcbiAgICAgIHVwbG9hZExpbWl0LmZpbGVUeXBlID0gZmlsZVR5cGU7XG4gICAgfVxuXG4gICAgLy8g6I635Y+W6ICB55qE6ZmE5Lu2aWTmlbDnu4RcbiAgICBjb25zdCBhdHRhY2htZW50SWRMaXN0ID0gW107XG4gICAgbGV0IGN1cnJlbnRJdGVtID0gbnVsbDtcbiAgICBpZiAoaWQpIHtcbiAgICAgIC8vIOS/ruato+W9k+WJjeihjFxuICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xuICAgICAgaWYgKGJpbmRpbmdMaXN0LmN1cnJlbnRJZCAhPT0gaWQpIHtcbiAgICAgICAgYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkLCB0cnVlLCB0cnVlKTtcbiAgICAgIH1cbiAgICAgIC8vIOWmguaenOaMh+WumuS6hmlk5YiZ6I635Y+W5oyH5a6aaWTnmoTooYxcbiAgICAgIGN1cnJlbnRJdGVtID0gdGhpcy5nZXRTcGVjaWFsUm93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBpZCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOayoeacieaMh+WumuWImeS9v+eUqOW9k+WJjeihjO+8jOWPr+iDveWtmOWcqOW9k+WJjeihjOWSjOS6i+S7tuihjOS4jeS4gOiHtOeahOaDheWGte+8jOatpOaXtuW6lOivpeWcqOWRveS7pOS4reS8oOmAkmlk5Y+C5pWwXG4gICAgICBjdXJyZW50SXRlbSA9IHRoaXMuZ2V0Q3VycmVudFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgfVxuICAgIGlmIChjdXJyZW50SXRlbSAmJiBjdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUpIHtcbiAgICAgIGNvbnN0IGF0dGFjaG1lbnRJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBbY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlXSk7XG4gICAgICBpZiAoYXR0YWNobWVudElkcyAmJiBhdHRhY2htZW50SWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgYXR0YWNobWVudElkTGlzdC5wdXNoLmFwcGx5KGF0dGFjaG1lbnRJZExpc3QsIGF0dGFjaG1lbnRJZHMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRpYWxvZyQgPSBmcm9tKHRoaXMudXBsb2FkRGlhbG9nU2VydmljZS51cGxvYWRGaWxlV2l0aExpbWl0KGZvcm1JZCwgcm9vdElkLCB1cGxvYWRMaW1pdCwgYXR0YWNobWVudElkTGlzdCkpO1xuICAgIGNvbnN0IHJlc3VsdCQgPSBkaWFsb2ckLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKGZpbGVJbmZvczogVXBsb2FkRmlsZUluZm9bXSkgPT4ge1xuICAgICAgICBpZiAoIWZpbGVJbmZvcyB8fCBmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzVXBsb2FkRmlyc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgfVxuICAgICAgICAvLyDov4fmu6Tlh7pzdGF0ZeS4uuaWsOWinueahOmZhOS7tlxuICAgICAgICBmaWxlSW5mb3MgPSBmaWxlSW5mb3MuZmlsdGVyKChmaWxlSW5mbzogVXBsb2FkRmlsZUluZm8pID0+IHtcbiAgICAgICAgICBpZiAoZmlsZUluZm8uaGFzT3duUHJvcGVydHkoJ3N0YXRlJykpIHtcbiAgICAgICAgICAgIHJldHVybiBmaWxlSW5mby5zdGF0ZSA9PT0gRmlsZVN0YXRlLk5ldztcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoZmlsZUluZm9zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICAvLyDmmK/lkKbkuIrkvKDliKTmlq1cbiAgICAgICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XG4gICAgICAgIGNvbnN0IGZpcnN0QXR0YWNobWVudEluZm8gPSBBdHRhY2htZW50VXRpbC5nZXRGaXJzdEF0dGFjaG1lbnRJbmZvKGF0dGFjaG1lbnRJbmZvcyk7XG4gICAgICAgIHJldHVybiB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvd1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGZpcnN0QXR0YWNobWVudEluZm8pO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHJlc3VsdCQ7XG4gIH1cbiAgLyoqXG4gICAqIOS4iuS8oOWkmuS4quaWh+S7tlxuICAgKi9cbiAgcHVibGljIHVwbG9hZEFuZEJhdGNoQWRkUm93cyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCByb290RGlySWQ/OiBzdHJpbmcsIHBhcmVudERpck5hbWU/OiBzdHJpbmcsIGZpbGVUeXBlPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByb290SWQgPSByb290RGlySWQgPyByb290RGlySWQgOiB0aGlzLmRlZmF1bHRSb290RGlySWQ7XG4gICAgY29uc3QgZm9ybUlkID0gcGFyZW50RGlyTmFtZSA/IHBhcmVudERpck5hbWUgOiB0aGlzLmRlZmF1bHRQYXJlbnREaXJOYW1lO1xuICAgIGlmICghcm9vdElkIHx8ICFmb3JtSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigncm9vdERpcklk5ZKMcGFyZW50RGlyTmFtZeS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xuICAgIH1cblxuICAgIGNvbnN0IHVwbG9hZExpbWl0OiBVcGxvYWRMaW1pdCA9IG5ldyBVcGxvYWRMaW1pdCgpO1xuICAgIGlmIChmaWxlVHlwZSkge1xuICAgICAgdXBsb2FkTGltaXQuZmlsZVR5cGUgPSBmaWxlVHlwZTtcbiAgICB9XG4gICAgY29uc3QgZGlhbG9nJCA9IGZyb20odGhpcy51cGxvYWREaWFsb2dTZXJ2aWNlLnVwbG9hZEZpbGVXaXRoTGltaXQoZm9ybUlkLCByb290SWQsIHVwbG9hZExpbWl0KSk7XG4gICAgY29uc3QgcmVzdWx0JCA9IGRpYWxvZyQucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoZmlsZUluZm9zOiBVcGxvYWRGaWxlSW5mb1tdKSA9PiB7XG4gICAgICAgIGlmICghZmlsZUluZm9zIHx8IGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNVcGxvYWRGaXJzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICB9XG4gICAgICAgIC8vIOi/h+a7pOWHunN0YXRl5Li65paw5aKe55qE6ZmE5Lu2XG4gICAgICAgIGZpbGVJbmZvcyA9IGZpbGVJbmZvcy5maWx0ZXIoKGZpbGVJbmZvOiBVcGxvYWRGaWxlSW5mbykgPT4ge1xuICAgICAgICAgIGlmIChmaWxlSW5mby5oYXNPd25Qcm9wZXJ0eSgnc3RhdGUnKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZpbGVJbmZvLnN0YXRlID09PSBGaWxlU3RhdGUuTmV3O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IEF0dGFjaG1lbnRVdGlsLmNvbnZlcnRUb0F0dGFjaG1lbnRJbmZvcyhmaWxlSW5mb3MpO1xuICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3dzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xuICAgICAgfSlcbiAgICApO1xuICAgIHJldHVybiByZXN1bHQkO1xuICB9XG4gIC8qKlxuICAgKiDkuIrkvKDlpJrkuKrmlofku7ZcbiAgICovXG4gIHB1YmxpYyB1cGxvYWRBbmRCYXRjaEFkZFJvd3NXaXRoUHJvcGVydHlOYW1lKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZD86IHN0cmluZywgcGFyZW50RGlyTmFtZT86IHN0cmluZywgZmlsZVR5cGU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJvb3RJZCA9IHJvb3REaXJJZCA/IHJvb3REaXJJZCA6IHRoaXMuZGVmYXVsdFJvb3REaXJJZDtcbiAgICBjb25zdCBmb3JtSWQgPSBwYXJlbnREaXJOYW1lID8gcGFyZW50RGlyTmFtZSA6IHRoaXMuZGVmYXVsdFBhcmVudERpck5hbWU7XG4gICAgaWYgKCFyb290SWQgfHwgIWZvcm1JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyb290RGlySWTlkoxwYXJlbnREaXJOYW1l5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XG4gICAgfVxuICAgIGNvbnN0IHVwbG9hZExpbWl0OiBVcGxvYWRMaW1pdCA9IG5ldyBVcGxvYWRMaW1pdCgpO1xuICAgIGlmIChmaWxlVHlwZSkge1xuICAgICAgdXBsb2FkTGltaXQuZmlsZVR5cGUgPSBmaWxlVHlwZTtcbiAgICB9XG4gICAgY29uc3QgZGlhbG9nJCA9IGZyb20odGhpcy51cGxvYWREaWFsb2dTZXJ2aWNlLnVwbG9hZEZpbGVXaXRoTGltaXQoZm9ybUlkLCByb290SWQsIHVwbG9hZExpbWl0KSk7XG4gICAgY29uc3QgcmVzdWx0JCA9IGRpYWxvZyQucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoZmlsZUluZm9zOiBVcGxvYWRGaWxlSW5mb1tdKSA9PiB7XG4gICAgICAgIGlmICghZmlsZUluZm9zIHx8IGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNVcGxvYWRGaXJzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICB9XG4gICAgICAgIC8vIOi/h+a7pOWHunN0YXRl5Li65paw5aKe55qE6ZmE5Lu2XG4gICAgICAgIGZpbGVJbmZvcyA9IGZpbGVJbmZvcy5maWx0ZXIoKGZpbGVJbmZvOiBVcGxvYWRGaWxlSW5mbykgPT4ge1xuICAgICAgICAgIGlmIChmaWxlSW5mby5oYXNPd25Qcm9wZXJ0eSgnc3RhdGUnKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZpbGVJbmZvLnN0YXRlID09PSBGaWxlU3RhdGUuTmV3O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IEF0dGFjaG1lbnRVdGlsLmNvbnZlcnRUb0F0dGFjaG1lbnRJbmZvcyhmaWxlSW5mb3MpO1xuICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3dzV2l0aFByb3BlcnR5TmFtZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gcmVzdWx0JDtcbiAgfVxuICAvKipcbiAgICog5LiL6L296ZmE5Lu277yI5qC55o2u6ZmE5Lu2aWTvvIlcbiAgICovXG4gIHB1YmxpYyBkb3dubG9hZChhdHRhY2hJZDogc3RyaW5nLCByb290SWQ/OiBzdHJpbmcpOiBhbnkge1xuICAgIGlmICghYXR0YWNoSWQpIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdERvd25sb2FkQXR0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgcm9vdElkID0gcm9vdElkIHx8ICdkZWZhdWx0LXJvb3QnO1xuICAgIGNvbnN0IHVybCA9IHRoaXMuZ2V0RG93bmxvYWRVcmwoW2F0dGFjaElkXSwgcm9vdElkKTtcbiAgICAvLyBsZXQgdXJsID0gJyc7XG4gICAgLy8gaWYgKHJvb3RJZCkge1xuICAgIC8vICAgdXJsID0gYC9hcGkvcnVudGltZS9kZnMvdjEuMC9mb3JtZG9jL2ZpbGVjb250ZW50P21ldGFkYXRhaWQ9JHthdHRhY2hJZH0mcm9vdGlkPSR7cm9vdElkfWA7XG4gICAgLy8gfSBlbHNlIHtcbiAgICAvLyAgIHVybCA9IGAvYXBpL3J1bnRpbWUvZGZzL3YxLjAvZm9ybWRvYy9kb3dubG9hZC8ke2F0dGFjaElkfWA7XG4gICAgLy8gfVxuICAgIHdpbmRvdy5vcGVuKHVybCk7XG4gICAgcmV0dXJuIG9mKHRydWUpO1xuICB9XG4gIC8qKlxuICAgKiDmibnph4/kuIvovb3pmYTku7bvvIjmoLnmja7pmYTku7ZpZOaVsOe7hO+8iVxuICAgKi9cbiAgcHVibGljIGJhdGNoRG93bmxvYWQoYXR0YWNoSWRzOiBzdHJpbmdbXSwgcm9vdElkOiBzdHJpbmcpOiBhbnkge1xuICAgIGlmICghYXR0YWNoSWRzIHx8IGF0dGFjaElkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdERvd25sb2FkQXR0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgLy8g5Y+q6YCJ5oup5LiA5Liq6ZmE5Lu25pe25oyJ5Y2V5Liq6ZmE5Lu25LiL6L295aSE55CGXG4gICAgaWYgKGF0dGFjaElkcy5sZW5ndGggPT09IDEpIHtcbiAgICAgIHJldHVybiB0aGlzLmRvd25sb2FkKGF0dGFjaElkc1swXSwgcm9vdElkKTtcbiAgICB9XG4gICAgLy8gY29uc3QgYXR0YWNoSWRzU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoYXR0YWNoSWRzKTtcbiAgICAvLyBjb25zdCB1cmwgPSBgL2FwaS9ydW50aW1lL2Rmcy92MS4wL2Zvcm1kb2MvbXVsdGlwbGUvZG93bmxvYWQ/bWV0YWRhdGFpZGxpc3Q9JHthdHRhY2hJZHNTdHJpbmd9JnJvb3RpZD0ke3Jvb3RJZH1gO1xuICAgIGNvbnN0IHVybCA9IHRoaXMuZ2V0RG93bmxvYWRVcmwoYXR0YWNoSWRzLCByb290SWQpO1xuICAgIHdpbmRvdy5vcGVuKHVybCk7XG4gICAgcmV0dXJuIG9mKHRydWUpO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuIvovb3ot6/lvoRcbiAgICogQHBhcmFtIG1ldGFkYXRhaWRsaXN0IOmZhOS7tmlk5pWw57uEXG4gICAqIEBwYXJhbSByb290SWQgcm9vdElkXG4gICAqL1xuICBwcml2YXRlIGdldERvd25sb2FkVXJsKG1ldGFkYXRhaWRsaXN0OiBBcnJheTxzdHJpbmc+LCByb290SWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcm9vdElkID0gcm9vdElkIHx8ICdkZWZhdWx0LXJvb3QnO1xuICAgIGlmICh0aGlzLmRvd25sb2FkU2VydmljZSkge1xuICAgICAgaWYgKG1ldGFkYXRhaWRsaXN0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gdGhpcy5kb3dubG9hZFNlcnZpY2UuZ2V0RG93bmxvYWRVcmwobWV0YWRhdGFpZGxpc3RbMF0sIHJvb3RJZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBhdHRhY2hJZHNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShtZXRhZGF0YWlkbGlzdCk7XG4gICAgICAgIHJldHVybiB0aGlzLmRvd25sb2FkU2VydmljZS5nZXRNdWx0aXBsZURvd25sb2FkVXJsKGF0dGFjaElkc1N0cmluZywgcm9vdElkKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS53YXJuKCflm6Dlronlhajpl67popjvvIzpmYTku7bkuIvovb3mj5DkvpvlronlhajmoKHpqozmnLrliLbvvIzpmYTku7bkuIvovb3lip/og73pnIDph43mlrDnvJbor5HjgIInKTtcbiAgICAgIGlmIChtZXRhZGF0YWlkbGlzdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgcmV0dXJuIGAvYXBpL3J1bnRpbWUvZGZzL3YxLjAvZm9ybWRvYy9maWxlY29udGVudD9tZXRhZGF0YWlkPSR7bWV0YWRhdGFpZGxpc3RbMF19JnJvb3RpZD0ke3Jvb3RJZH1gO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgYXR0YWNoSWRzU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkobWV0YWRhdGFpZGxpc3QpO1xuICAgICAgICByZXR1cm4gYC9hcGkvcnVudGltZS9kZnMvdjEuMC9mb3JtZG9jL211bHRpcGxlL2Rvd25sb2FkP21ldGFkYXRhaWRsaXN0PSR7YXR0YWNoSWRzU3RyaW5nfSZyb290aWQ9JHtyb290SWR9YDtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOS4i+i9ve+8iOagueaNruaVsOaNrmlk77yJXG4gICAqL1xuICBwdWJsaWMgZG93bmxvYWRCeURhdGFJZChkYXRhSWQ6IHN0cmluZywgYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICghZGF0YUlkKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNTZWxlY3REb3dubG9hZEF0dCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuXG4gICAgY29uc3QgZGF0YUlkcyA9IFtkYXRhSWRdO1xuICAgIGNvbnN0IGF0dGFjaElkcyA9IHRoaXMuZ2V0QXR0YWNobWVudElkc0J5UGF0aEFuZERhdGFJZHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGRhdGFJZHMpO1xuICAgIGlmIChhdHRhY2hJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub0Rvd25sb2FkQXR0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG5cbiAgICBjb25zdCBhdHRhY2hJZCA9IGF0dGFjaElkc1swXTtcbiAgICByZXR1cm4gdGhpcy5kb3dubG9hZChhdHRhY2hJZCk7XG4gIH1cblxuICAvKipcbiAgICog5om56YeP5LiL6L296ZmE5Lu2XG4gICAqL1xuICBwdWJsaWMgYmF0Y2hEb3dubG9hZEJ5RGF0YUlkcyhkYXRhSWRzOiBzdHJpbmdbXSB8IHN0cmluZywgYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICh0eXBlb2YgZGF0YUlkcyA9PT0gJ3N0cmluZycgJiYgZGF0YUlkcyAmJiBkYXRhSWRzLmxlbmd0aCA+IDApIHtcbiAgICAgIGRhdGFJZHMgPSBkYXRhSWRzLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgfVxuICAgIGlmICghZGF0YUlkcyB8fCBBcnJheS5pc0FycmF5KGRhdGFJZHMpID09PSBmYWxzZSB8fCBkYXRhSWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzU2VsZWN0RG93bmxvYWRBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBpZHMgPSBbXS5jb25jYXQoZGF0YUlkcyk7XG4gICAgY29uc3QgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgaWRzKTtcbiAgICBpZiAoYXR0YWNoSWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2Uubm9Eb3dubG9hZEF0dCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYmF0Y2hEb3dubG9hZChhdHRhY2hJZHMsIHJvb3RJZCk7XG4gIH1cblxuICAvKipcbiAgICog5qC55o2u6ZmE5Lu2VURU5a2X5q6155qE6Lev5b6E6aKE6KeI6ZmE5Lu2XG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCDpmYTku7ZVRFTlrZfmrrVwYXRoXG4gICAqIEBwYXJhbSByb290RGlySWQg6Lef55uu5b2VaWRcbiAgICogQHBhcmFtIGlkcyDpmYTku7ZpZFxuICAgKi9cbiAgcHVibGljIHByZXZpZXdCeUF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZDogc3RyaW5nLCBpZHM/OiBhbnkpIHtcbiAgICBpZiAoIWF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIHx8ICFyb290RGlySWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignYXR0YWNobWVudEluZm9GaWVsZFBhdGjlkoxyb290RGlySWTkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcbiAgICB9XG4gICAgbGV0IGF0dGFjaElkcyA9IFtdO1xuICAgIGxldCBkYXRhSWRzID0gW107XG4gICAgaWYgKGlkcyAmJiBpZHMubGVuZ3RoID4gMCkge1xuICAgICAgaWYgKHR5cGVvZiAoaWRzKSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZGF0YUlkcy5wdXNoKGlkcyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkYXRhSWRzID0gaWRzO1xuICAgICAgfVxuICAgICAgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgZGF0YUlkcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF0dGFjaElkcyA9IHRoaXMuZ2V0QXR0YWNobWVudElkc0J5UGF0aEFuZERhdGFJZHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIG51bGwpO1xuICAgIH1cbiAgICBpZiAoYXR0YWNoSWRzICYmIGF0dGFjaElkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vQXR0YWNobWVudCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByZXZpZXdCeUF0dGFjaG1lbnRJZHMoYXR0YWNoSWRzLCByb290RGlySWQpO1xuICB9XG4gIC8qKlxuICAgKiDmoLnmja7pmYTku7ZVRFTlrZfmrrXnmoTot6/lvoTpooTop4jlvZPliY3ooYznmoTpmYTku7ZcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tlVEVOWtl+autXBhdGhcbiAgICogQHBhcmFtIHJvb3REaXJJZCDmoLnnm67lvZVpZFxuICAgKi9cbiAgcHVibGljIHByZXZpZXdCeUF0dGFjaG1lbnRJbmZvRmllbGRQYXRoV2l0aEluZGV4KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAoIWF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIHx8ICFyb290RGlySWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignYXR0YWNobWVudEluZm9GaWVsZFBhdGjlkoxyb290RGlySWTkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcbiAgICB9XG4gICAgY29uc3QgY3VycmVudFJvdyA9IHRoaXMuZ2V0Q3VycmVudFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgY29uc3QgYXR0YWNobWVudEZpZWxkTmFtZSA9IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XG4gICAgaWYgKCFjdXJyZW50Um93W2F0dGFjaG1lbnRGaWVsZE5hbWVdIHx8ICFjdXJyZW50Um93W2F0dGFjaG1lbnRGaWVsZE5hbWVdWydhdHRhY2htZW50SWQnXSkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2Uubm9BdHRhY2htZW50LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgY29uc3QgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgbnVsbCk7XG4gICAgaWYgKGF0dGFjaElkcyAmJiBhdHRhY2hJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub0F0dGFjaG1lbnQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBhdHRhY2htZW50SWQgPSB0aGlzLmdldEN1cnJlbnRBdHRhY2htZW50SWQoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xuICAgIGlmICghYXR0YWNobWVudElkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+imgemihOiniOeahOmZhOS7tmlk5LiN5a2Y5Zyo77yM6K+356Gu6K6kJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLnByZXZpZXdGaWxlTGlzdFdpdGhJbmRleChhdHRhY2hJZHMsIHJvb3REaXJJZCwgYXR0YWNobWVudElkKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOagueaNruebruW9lemihOiniOmZhOS7tlxuICAgKiBAcGFyYW0gc3ViRGlyTmFtZSDniLbnm67lvZXlkI3np7BcbiAgICogQHBhcmFtIHJvb3REaXJJZCDmoLnnm67lvZVpZFxuICAgKi9cbiAgcHVibGljIHByZXZpZXdCeVN1YkRpck5hbWUoc3ViRGlyTmFtZTogc3RyaW5nLCByb290RGlySWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKCFzdWJEaXJOYW1lIHx8ICFyb290RGlySWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc3ViRGlyTmFtZeWSjHJvb3REaXJJZOS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xuICAgIH1cbiAgICBjb25zdCB2aWV3ZXIkID0gZnJvbSh0aGlzLmZpbGVWaWV3ZXJTZXJ2aWNlLnZpZXdlckZvcm1GaWxlKHN1YkRpck5hbWUsIHJvb3REaXJJZCkpO1xuICAgIHJldHVybiB2aWV3ZXIkO1xuICB9XG4gIC8qKlxuICAgKiDmoLnmja7nm67lvZXpooTop4jmjIflrprntKLlvJXnmoTpmYTku7ZcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tlVEVOWtl+autXBhdGhcbiAgICogQHBhcmFtIHN1YkRpck5hbWUg5a2Q55uu5b2V5ZCN56ewXG4gICAqIEBwYXJhbSByb290RGlySWQg5qC555uu5b2VaWRcbiAgICovXG4gIHB1YmxpYyBwcmV2aWV3QnlTdWJEaXJOYW1lV2l0aEluZGV4KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHN1YkRpck5hbWU6IHN0cmluZywgcm9vdERpcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICghc3ViRGlyTmFtZSB8fCAhcm9vdERpcklkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3N1YkRpck5hbWXlkoxyb290RGlySWTkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcbiAgICB9XG4gICAgLy8gY29uc3QgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgbnVsbCk7XG4gICAgY29uc3QgYXR0YWNobWVudElkID0gdGhpcy5nZXRDdXJyZW50QXR0YWNobWVudElkKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBpZiAoIWF0dGFjaG1lbnRJZCkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2Uubm9BdHRhY2htZW50LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgY29uc3Qgdmlld2VyJCA9IGZyb20odGhpcy5maWxlVmlld2VyU2VydmljZS52aWV3ZXJGb3JtRmlsZVdpdGhJbmRleChzdWJEaXJOYW1lLCByb290RGlySWQsIGF0dGFjaG1lbnRJZCkpO1xuICAgIHJldHVybiB2aWV3ZXIkO1xuICB9XG4gIC8qKlxuICAgKiDmoLnmja7pmYTku7ZpZOaVsOe7hOmihOiniOmZhOS7tlxuICAgKiBAcGFyYW0gYXR0YWNobWVudElkcyDpmYTku7ZpZOaVsOe7hFxuICAgKiBAcGFyYW0gcm9vdERpcklkIOagueebruW9lWlkXG4gICAqL1xuICBwdWJsaWMgcHJldmlld0J5QXR0YWNobWVudElkcyhhdHRhY2htZW50SWRzOiBzdHJpbmdbXSwgcm9vdERpcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHZpZXdlciQgPSBmcm9tKHRoaXMuZmlsZVZpZXdlclNlcnZpY2Uudmlld2VyRmlsZUxpc3QoYXR0YWNobWVudElkcywgcm9vdERpcklkKSk7XG4gICAgcmV0dXJuIHZpZXdlciQ7XG4gIH1cbiAgLyoqXG4gICAqIOagueaNrumZhOS7tmlk5pWw57uE6aKE6KeI5oyH5a6a57Si5byV55qE6ZmE5Lu2XG4gICAqIEBwYXJhbSBhdHRhY2htZW50SWRzIOmZhOS7tmlk5pWw57uEXG4gICAqIEBwYXJhbSByb290RGlySWQg5qC555uu5b2VaWRcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJZCDpmYTku7ZJZFxuICAgKi9cbiAgcHVibGljIHByZXZpZXdGaWxlTGlzdFdpdGhJbmRleChhdHRhY2htZW50SWRzOiBzdHJpbmdbXSwgcm9vdERpcklkOiBzdHJpbmcsIGF0dGFjaG1lbnRJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgdmlld2VyJCA9IGZyb20odGhpcy5maWxlVmlld2VyU2VydmljZS52aWV3ZXJGaWxlTGlzdFdpdGhJbmRleChhdHRhY2htZW50SWRzLCByb290RGlySWQsIGF0dGFjaG1lbnRJZCkpO1xuICAgIHJldHVybiB2aWV3ZXIkO1xuICB9XG4gIC8qKlxuICAgKiDnlJ/miJDniYjmnKzlj7dcbiAgICogQHBhcmFtIHZlcnNpb25zIOWOhuWPsueJiOacrOWPt1xuICAgKiBAZGVzY3JpcHRpb24g6buY6K6k57yW56CB6KeE5YiZdjEuMCB2Mi4wIC4uLlxuICAgKi9cbiAgcHVibGljIGdlblZlcnNpb24odmVyc2lvbnM6IHN0cmluZ1tdKSB7XG4gICAgaWYgKCF2ZXJzaW9ucykge1xuICAgICAgdmVyc2lvbnMgPSBbXTtcbiAgICB9XG4gICAgY29uc3QgbWFpbkNvZGUgPSB2ZXJzaW9ucy5sZW5ndGggKyAxO1xuICAgIHJldHVybiBgViR7bWFpbkNvZGV9LjBgO1xuICB9XG4gIC8qKlxuICAgKiDmm7TmlrDpmYTku7bniYjmnKzkv6Hmga9cbiAgICogQHBhcmFtIHZlcnNpb25GaWVsZCDpmYTku7bniYjmnKzlrZfmrrVcbiAgICogQHBhcmFtIGhpc3RvcnlGaWVsZCDmmK/lkKbljoblj7LniYjmnKzlrZfmrrVcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRGaWVsZFBhdGgg6ZmE5Lu2dWR05a2X5q616Lev5b6EXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlQXR0YWNobWVudFZlcnNpb24odmVyc2lvbkZpZWxkOiBzdHJpbmcsIGhpc3RvcnlGaWVsZDogc3RyaW5nLCBhdHRhY2htZW50RmllbGRQYXRoOiBzdHJpbmcpIHtcbiAgICAvKipcbiAgICAgKiDpgY3ljobmiYDmnInpmYTku7booYxcbiAgICAgKiDmib7liLDmiYDmnInmsqHmnInpmYTku7bniYjmnKznmoTooYxcbiAgICAgKiDpgY3ljobov5nkupvooYxcbiAgICAgKiDpgJrov4fmlofku7blkI3ljrvmn6Xmib7lkIzlkI3nmoTkuJTmnInpmYTku7bniYjmnKzlj7fnmoTooYwgXG4gICAgICog6L+Z5Lqb6KGM5Y6G5Y+y54mI5pys5a2X5q61572u5Li6dHJ1ZVxuICAgICAqIOaXoOeJiOacrOWPt+eahOihjO+8jOeJiOacrD0g5LiK6KGM5pWwICsgMVxuICAgICAqIFxuICAgICAqL1xuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGF0dGFjaG1lbnRGaWVsZFBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAvLyDlvLnlh7rpmYTku7Z1ZHTlrZfmrrVcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGQgPSBiaW5kaW5nUGF0aHMucG9wKCk7XG4gICAgLy8g6I635Y+W5Yiw5omA5pyJ55qE6ZmE5Lu2XG4gICAgY29uc3QgYXR0YWNobWVudEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XG4gICAgY29uc3QgZW50aXR5TWFuYWdlciA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlcjtcbiAgICBjb25zdCBkYXRhUGF0aCA9IERhdGFQYXRoQ3JlYXRvci5jcmVhdGVCeVNob3J0UGF0aEZyb21Sb290KGJpbmRpbmdQYXRocywgZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpO1xuICAgIGNvbnN0IHBhdGhzID0gZGF0YVBhdGgudG9BcnJheSgpLm1hcCgocGF0aDogc3RyaW5nKSA9PiB7XG4gICAgICBpZiAocGF0aC5zdGFydHNXaXRoKCdQcm9wTmFtZTonKSkge1xuICAgICAgICByZXR1cm4gcGF0aC5zcGxpdCgnOicpWzFdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHBhdGg7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKGF0dGFjaG1lbnRCaW5kaW5nTGlzdCkge1xuICAgICAgY29uc3QgYXR0YWNobWVudHMgPSBhdHRhY2htZW50QmluZGluZ0xpc3QudG9KU09OKCk7XG4gICAgICAvLyDlj6rlpITnkIbmnInpmYTku7bnmoTmg4XlhrVcbiAgICAgIGlmIChhdHRhY2htZW50cykge1xuICAgICAgICBjb25zdCB2ZXJzaW9uTGVzc1Jvd3MgPSBhdHRhY2htZW50cy5maWx0ZXIoaXRlbSA9PiAhaXRlbVt2ZXJzaW9uRmllbGRdKTtcbiAgICAgICAgdmVyc2lvbkxlc3NSb3dzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBpdGVtW2F0dGFjaG1lbnRGaWVsZF1bJ2ZpbGVOYW1lJ107XG4gICAgICAgICAgY29uc3QgdmVyc2lvbmVkUm93cyA9IGF0dGFjaG1lbnRzLmZpbHRlcihyb3cgPT4gcm93W2F0dGFjaG1lbnRGaWVsZF1bJ2ZpbGVOYW1lJ10gPT09IGZpbGVOYW1lICYmIHJvd1t2ZXJzaW9uRmllbGRdKTtcbiAgICAgICAgICBwYXRocy5wb3AoKTtcbiAgICAgICAgICBwYXRocy5wdXNoKGBEYXRhSWQ6JHtpdGVtW2F0dGFjaG1lbnRCaW5kaW5nTGlzdC5wcmltYXJ5S2V5XX1gKTtcbiAgICAgICAgICBsZXQgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5UGF0aChwYXRocyk7XG4gICAgICAgICAgY29uc3QgdmVyc2lvbiA9IHRoaXMuZ2VuVmVyc2lvbih2ZXJzaW9uZWRSb3dzKTtcbiAgICAgICAgICBlbnRpdHlbdmVyc2lvbkZpZWxkXSA9IHZlcnNpb247XG4gICAgICAgICAgZW50aXR5W2hpc3RvcnlGaWVsZF0gPSBmYWxzZTtcbiAgICAgICAgICAvLyDlpITnkIbljoblj7LorrDlvZVcbiAgICAgICAgICB2ZXJzaW9uZWRSb3dzLmZvckVhY2gocm93ID0+IHtcbiAgICAgICAgICAgIHBhdGhzLnBvcCgpO1xuICAgICAgICAgICAgcGF0aHMucHVzaChgRGF0YUlkOiR7cm93W2F0dGFjaG1lbnRCaW5kaW5nTGlzdC5wcmltYXJ5S2V5XX1gKTtcbiAgICAgICAgICAgIGVudGl0eSA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeVBhdGgocGF0aHMpO1xuICAgICAgICAgICAgZW50aXR5W2hpc3RvcnlGaWVsZF0gPSB0cnVlO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcHVibGljIGlzQXR0YWNobWVudENhbkRlbGV0ZShoaXN0b3J5RmllbGQ6IHN0cmluZywgYXR0YWNobWVudEZpZWxkUGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYXR0YWNobWVudEZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIC8vIOW8ueWHuumZhOS7tnVkdOWtl+autVxuICAgIGJpbmRpbmdQYXRocy5wb3AoKTtcbiAgICBjb25zdCBhdHRhY2htZW50QmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBhdHRhY2htZW50QmluZGluZ0xpc3QuY3VycmVudEl0ZW07XG4gICAgaWYgKGJpbmRpbmdPYmplY3RbaGlzdG9yeUZpZWxkXSA9PT0gdHJ1ZSkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UuaGlzdG9yeUF0dGFjaG1lbnQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgdXBkYXRlQXR0YWNobWVudEhpc3RvcnkodmVyc2lvbkZpZWxkOiBzdHJpbmcsIGhpc3RvcnlGaWVsZDogc3RyaW5nLCBhdHRhY2htZW50RmllbGRQYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBhdHRhY2htZW50RmllbGRQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgLy8g5by55Ye66ZmE5Lu2dWR05a2X5q61XG4gICAgY29uc3QgYXR0YWNobWVudEZpZWxkID0gYmluZGluZ1BhdGhzLnBvcCgpO1xuICAgIC8vIOiOt+WPluWIsOaJgOacieeahOmZhOS7tlxuICAgIGNvbnN0IGF0dGFjaG1lbnRCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgLy8gY29uc3QgYmVmUmVwb3NpdG9yeSA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xuICAgIC8vIGNvbnN0IGVudGl0eU1hbmFnZXIgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXI7XG4gICAgaWYgKGF0dGFjaG1lbnRCaW5kaW5nTGlzdCkge1xuICAgICAgY29uc3QgYXR0YWNobWVudHMgPSBhdHRhY2htZW50QmluZGluZ0xpc3QudG9KU09OKCk7XG4gICAgICBjb25zdCB2ZXJzaW9uZWRSb3dzID0gYXR0YWNobWVudHMuZmlsdGVyKGl0ZW0gPT4gaXRlbVt2ZXJzaW9uRmllbGRdKTtcbiAgICAgIGNvbnN0IGZpbGVOYW1lTWFwID0gbmV3IE1hcDxzdHJpbmcsIEFycmF5PGFueT4+KCk7XG4gICAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XG4gICAgICBjb25zdCBlbnRpdHlNYW5hZ2VyID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyO1xuICAgICAgY29uc3QgZGF0YVBhdGggPSBEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGVudGl0eU1hbmFnZXIsIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhKTtcbiAgICAgIGNvbnN0IHBhdGhzID0gZGF0YVBhdGgudG9BcnJheSgpLm1hcCgocGF0aDogc3RyaW5nKSA9PiB7XG4gICAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJ1Byb3BOYW1lOicpKSB7XG4gICAgICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJzonKVsxXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gcGF0aDtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICB2ZXJzaW9uZWRSb3dzLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVOYW1lID0gaXRlbVthdHRhY2htZW50RmllbGRdWydmaWxlTmFtZSddO1xuICAgICAgICBpZiAoZmlsZU5hbWVNYXAuaGFzKGZpbGVOYW1lKSkge1xuICAgICAgICAgIGZpbGVOYW1lTWFwLmdldChmaWxlTmFtZSkucHVzaChpdGVtKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmaWxlTmFtZU1hcC5zZXQoZmlsZU5hbWUsIFtpdGVtXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgQXJyYXkuZnJvbShmaWxlTmFtZU1hcC52YWx1ZXMoKSkuZm9yRWFjaCgoYXJyYXk6IEFycmF5PGFueT4pID0+IHtcbiAgICAgICAgYXJyYXkuc29ydCgoeCwgeSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHhWZXJzaW9uID0gcGFyc2VJbnQoeFt2ZXJzaW9uRmllbGRdLnJlcGxhY2UoL1thLXpBLVpcXC5dL2csICcnKSk7XG4gICAgICAgICAgY29uc3QgeVZlcnNpb24gPSBwYXJzZUludCh5W3ZlcnNpb25GaWVsZF0ucmVwbGFjZSgvW2EtekEtWlxcLl0vZywgJycpKTtcbiAgICAgICAgICByZXR1cm4geVZlcnNpb24gLSB4VmVyc2lvbjtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHJvdyA9IGFycmF5WzBdO1xuICAgICAgICBwYXRocy5wb3AoKTtcbiAgICAgICAgcGF0aHMucHVzaChgRGF0YUlkOiR7cm93W2F0dGFjaG1lbnRCaW5kaW5nTGlzdC5wcmltYXJ5S2V5XX1gKTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5UGF0aChwYXRocyk7XG4gICAgICAgIGVudGl0eVtoaXN0b3J5RmllbGRdID0gZmFsc2U7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluW9k+WJjeinhuWbvuaooeWei+W9k+WJjeihjOeahOmZhOS7tmlkXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCDpmYTku7Z1ZHTlrZfmrrVcbiAgICovXG4gIHByaXZhdGUgZ2V0Q3VycmVudEF0dGFjaG1lbnRJZChhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgY29uc3QgYXR0YWNobWVudEZpZWxkTmFtZSA9IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGFyZW50QmluZGluZ1BhdGhBcnJheSkgYXMgQmluZGluZ0xpc3Q7XG4gICAgY29uc3QgY3VycmVudEl0ZW0gPSBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbTtcbiAgICBpZiAoY3VycmVudEl0ZW0gJiYgY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlKSB7XG4gICAgICByZXR1cm4gY3VycmVudEl0ZW1bYXR0YWNobWVudEZpZWxkTmFtZV0gJiYgY3VycmVudEl0ZW1bYXR0YWNobWVudEZpZWxkTmFtZV1bJ2F0dGFjaG1lbnRJZCddIHx8IG51bGw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6I635Y+W5b2T5YmN6KGMXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCB1ZHTlrZfmrrVcbiAgICovXG4gIHByaXZhdGUgZ2V0Q3VycmVudFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXJlbnRCaW5kaW5nUGF0aEFycmF5KSBhcyBCaW5kaW5nTGlzdDtcbiAgICBjb25zdCBjdXJyZW50SXRlbSA9IGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xuICAgIHJldHVybiBjdXJyZW50SXRlbTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5oyH5a6a6ZmE5Lu25L+h5oGv6KGo55qE5oyH5a6a6KGMXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCBcbiAgICogQHBhcmFtIHByaW1hcnlWYWx1ZSBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcml2YXRlIGdldFNwZWNpYWxSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcHJpbWFyeVZhbHVlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhcmVudEJpbmRpbmdQYXRoQXJyYXkpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGNvbnN0IGN1cnJlbnRJdGVtID0gYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcbiAgICByZXR1cm4gY3VycmVudEl0ZW07XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPlmRhdGFJZHPlr7nlupRFbnRpdHnkuIrnmoTpmYTku7ZpZOaVsOe7hFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBkYXRhSWRzPzogc3RyaW5nW10pOiBzdHJpbmdbXSB7XG5cbiAgICAvLyDop6PmnpDot6/lvoRcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGROYW1lID0gcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcblxuICAgIC8vIOiOt+WPlumZhOS7tuaJgOWcqOWunuS9k+eahOaVsOaNruWIl+ihqO+8jOS4jeS8oOmAkmRhdGFJZHPlj4LmlbDvvIzliJnov5Tlm57lhajpg6hcbiAgICBjb25zdCBlbnRpdHlMaXN0RGF0YSA9IHRoaXMuZW50aXR5U2VydmljZS5nZXRFbnRpdHlMaXN0RGF0YShwYXJlbnRCaW5kaW5nUGF0aEFycmF5KTtcbiAgICBsZXQgZmlsdGVyZWRFbnRpdHlMaXN0RGF0YSA9IFtdO1xuICAgIGlmIChkYXRhSWRzICYmIEFycmF5LmlzQXJyYXkoZGF0YUlkcykgPT09IHRydWUpIHtcbiAgICAgIGZpbHRlcmVkRW50aXR5TGlzdERhdGEgPSBlbnRpdHlMaXN0RGF0YS5maWx0ZXIoKGVudGl0eURhdGE6IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gZGF0YUlkcy5pbmRleE9mKGVudGl0eURhdGEuaWQpID4gLTE7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZmlsdGVyZWRFbnRpdHlMaXN0RGF0YSA9IGVudGl0eUxpc3REYXRhO1xuICAgIH1cblxuICAgIC8vIOi9rOaNouS4uumZhOS7tklk5pWw57uEXG4gICAgY29uc3QgYXR0YWNobWVudElkcyA9IFtdO1xuICAgIGZpbHRlcmVkRW50aXR5TGlzdERhdGEuZm9yRWFjaCgoZW50aXR5RGF0YTogYW55KSA9PiB7XG4gICAgICBpZiAoZW50aXR5RGF0YVthdHRhY2htZW50RmllbGROYW1lXSkge1xuICAgICAgICBjb25zdCBhdHRhY2htZW50SWQgPSBlbnRpdHlEYXRhW2F0dGFjaG1lbnRGaWVsZE5hbWVdWydhdHRhY2htZW50SWQnXTtcbiAgICAgICAgaWYgKGF0dGFjaG1lbnRJZCkge1xuICAgICAgICAgIGF0dGFjaG1lbnRJZHMucHVzaChhdHRhY2htZW50SWQpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gYXR0YWNobWVudElkcztcbiAgfVxufVxuXG5leHBvcnQgeyBBdHRhY2htZW50U2VydmljZSB9O1xuIl19