import { Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import { AppContext, FrameContext, Repository, ENTITY_TEMPLATE, ResolveService, ExpressionUtil, ExpressionExecutor } from "@farris/devkit";
import { of } from "rxjs";
export class ExpressionService {
    constructor(injector, resolveService, frameContext, expressionExecutor) {
        this.injector = injector;
        this.resolveService = resolveService;
        this.frameContext = frameContext;
        this.expressionExecutor = expressionExecutor;
    }
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    execute(expression, customContext) {
        const deps = this.resolveService.resolve(expression);
        const groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        const entityContext = this.buildEntityContext(deps, groupDependencies);
        const stateContext = this.buildStateContext();
        const context = Object.assign({ [this.entityOriginalNodeCode]: entityContext }, stateContext, { BigNumber, frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository }, customContext);
        return this.expressionExecutor.eval(expression, context);
    }
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    executeAsync(expression, customContext) {
        const result = this.execute(expression, customContext);
        return of(result);
    }
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    buildEntityContext(deps, groupDependencies, context) {
        let isGroupdMainEntity = false;
        deps.forEach((dep) => {
            const isEntityDependency = this.isEntityDependency(dep);
            const isGroupDependency = groupDependencies.findIndex(item => item === dep) !== -1;
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                // 是聚合依赖
                if (isGroupDependency) {
                    const dependencyLength = dep.split('/').filter(p => p).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        isGroupdMainEntity = true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                }
            }
        });
        const data = this.getEntity();
        if (isGroupdMainEntity) {
            const collection = this.frameContext.repository.entityCollection.toJSON();
            data['__type__'] = 'List';
            data['__items__'] = collection;
        }
        return data;
    }
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    isEntityDependency(dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    }
    /**
     * 获取实体
     * @param event
     * @returns
     */
    getEntity() {
        const entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        const bindingData = this.frameContext.bindingData;
        const childrenEntityPaths = [];
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        const entity = this.frameContext.bindingData.list.currentItem.toJSON();
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach((paths) => {
            const row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
            if (row) {
                const propertyName = paths.pop();
                let parent = paths.reduce((object, path) => {
                    return object && object[path] || null;
                }, entity);
                const node = Object.assign({ __items__: [...parent[propertyName]] }, row, { __type__: 'List' });
                parent[propertyName] = node;
            }
        });
        return entity;
    }
    /**
     * 获取主实体原始字段名
     */
    get entityOriginalNodeCode() {
        const repository = this.injector.get(Repository);
        return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
    }
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    buildStateContext() {
        const ns = this.frameContext.namespace;
        const appContext = this.injector.get(AppContext, null);
        const frameContexts = appContext.frameContextManager.getFrameContextsByNamespace(ns);
        const result = {};
        if (frameContexts && frameContexts.length > 0) {
            const anonymousFrameContext = frameContexts[0];
            const rootFrameContext = anonymousFrameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                const uiState = rootFrameContext.viewModel.uiState;
                const propertyNames = Object.getOwnPropertyNames(uiState) || [];
                propertyNames.forEach((prop) => {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState[prop];
                    }
                });
            }
        }
        return result;
    }
}
ExpressionService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ExpressionService.ctorParameters = () => [
    { type: Injector },
    { type: ResolveService },
    { type: FrameContext },
    { type: ExpressionExecutor }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb25fc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNJLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFHdEMsTUFBTSxPQUFPLGlCQUFpQjtJQUM1QixZQUFvQixRQUFrQixFQUFVLGNBQThCLEVBQVUsWUFBMEIsRUFBVSxrQkFBc0M7UUFBOUksYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUFJLENBQUM7SUFDdks7Ozs7O09BS0c7SUFDSSxPQUFPLENBQUMsVUFBa0IsRUFBRSxhQUF1QztRQUN4RSxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNyRCxNQUFNLGlCQUFpQixHQUFHLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDN0gsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxp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ZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQmlnTnVtYmVyIH0gZnJvbSAnYmlnbnVtYmVyLmpzJztcbmltcG9ydCB7IEFwcENvbnRleHQsIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSwgRU5USVRZX1RFTVBMQVRFLCBSZXNvbHZlU2VydmljZSwgRXhwcmVzc2lvblV0aWwsIEV4cHJlc3Npb25FeGVjdXRvciB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvblNlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZXNvbHZlU2VydmljZTogUmVzb2x2ZVNlcnZpY2UsIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIHByaXZhdGUgZXhwcmVzc2lvbkV4ZWN1dG9yOiBFeHByZXNzaW9uRXhlY3V0b3IpIHsgfVxuICAvKipcbiAgICog5omn6KGM6KGo6L6+5byP6K6h566XXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xuICAgKiBAcGFyYW0gY3VzdG9tQ29udGV4dCDoh6rlrprkuYnkuIrkuIvmlodcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZXhlY3V0ZShleHByZXNzaW9uOiBzdHJpbmcsIGN1c3RvbUNvbnRleHQ/OiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IGFueSB7XG4gICAgY29uc3QgZGVwcyA9IHRoaXMucmVzb2x2ZVNlcnZpY2UucmVzb2x2ZShleHByZXNzaW9uKTtcbiAgICBjb25zdCBncm91cERlcGVuZGVuY2llcyA9IEV4cHJlc3Npb25VdGlsLmdldEdyb3VwRnVuY3Rpb25EZXBlbmRlbmN5KGV4cHJlc3Npb24sIHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xuICAgIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChkZXBzLCBncm91cERlcGVuZGVuY2llcyk7XG4gICAgY29uc3Qgc3RhdGVDb250ZXh0ID0gdGhpcy5idWlsZFN0YXRlQ29udGV4dCgpO1xuICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICBbdGhpcy5lbnRpdHlPcmlnaW5hbE5vZGVDb2RlXTogZW50aXR5Q29udGV4dCxcbiAgICAgIC4uLnN0YXRlQ29udGV4dCxcbiAgICAgIEJpZ051bWJlcixcbiAgICAgIGZyYW1lQ29udGV4dDogdGhpcy5mcmFtZUNvbnRleHQsXG4gICAgICBiaW5kaW5nRGF0YTogdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEsXG4gICAgICByZXBvc2l0b3J5OiB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LFxuICAgICAgLi4uY3VzdG9tQ29udGV4dFxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uRXhlY3V0b3IuZXZhbChleHByZXNzaW9uLCBjb250ZXh0KTtcbiAgfVxuICAvKipcbiAgICog5omn6KGM6KGo6L6+5byP77yI6L+U5Zue5Y+v6KeC5a+f5a+56LGh77yJXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xuICAgKiBAcGFyYW0gY3VzdG9tQ29udGV4dCDoh6rlrprkuYnkuIrkuIvmlodcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZXhlY3V0ZUFzeW5jKGV4cHJlc3Npb246IHN0cmluZywgY3VzdG9tQ29udGV4dD86IHsgW3Byb3A6IHN0cmluZ106IGFueSB9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmV4ZWN1dGUoZXhwcmVzc2lvbiwgY3VzdG9tQ29udGV4dCk7XG4gICAgcmV0dXJuIG9mKHJlc3VsdCk7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOWunuS9k+S4iuS4i+aWh1xuICAgKiBAcGFyYW0gZGVwcyBcbiAgICogQHBhcmFtIGdyb3VwRGVwZW5kZW5jaWVzIFxuICAgKiBAcGFyYW0gY29udGV4dCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkRW50aXR5Q29udGV4dChkZXBzOiBzdHJpbmdbXSwgZ3JvdXBEZXBlbmRlbmNpZXM6IHN0cmluZ1tdLCBjb250ZXh0PzogeyBbcHJvcDogc3RyaW5nXTogYW55IH0pIHtcbiAgICBsZXQgaXNHcm91cGRNYWluRW50aXR5ID0gZmFsc2U7XG4gICAgZGVwcy5mb3JFYWNoKChkZXA6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgaXNFbnRpdHlEZXBlbmRlbmN5ID0gdGhpcy5pc0VudGl0eURlcGVuZGVuY3koZGVwKTtcbiAgICAgIGNvbnN0IGlzR3JvdXBEZXBlbmRlbmN5ID0gZ3JvdXBEZXBlbmRlbmNpZXMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gZGVwKSAhPT0gLTE7XG4gICAgICAvLyDlpoLmnpzkvp3otZbnmoTmmK9zdGF0Ze+8jOaXoOmcgOWkhOeQhu+8jOeOsOWcqOmcgOimgeehruWumueahOaYr+i/lOWbnuWkmuWwkeWunuS9k+eahOmXrumimO+8jOWSjHN0YXRl5rKh5pyJ5YWz57O7XG4gICAgICAvLyDooajovr7lvI/kvp3otZbkuoblrp7kvZNcbiAgICAgIGlmIChpc0VudGl0eURlcGVuZGVuY3kpIHtcbiAgICAgICAgLy8g5piv6IGa5ZCI5L6d6LWWXG4gICAgICAgIGlmIChpc0dyb3VwRGVwZW5kZW5jeSkge1xuICAgICAgICAgIGNvbnN0IGRlcGVuZGVuY3lMZW5ndGggPSBkZXAuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5sZW5ndGggLSAxO1xuICAgICAgICAgIGlmIChkZXBlbmRlbmN5TGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAvLyDogZrlkIjkuobkuLvooajlrZfmrrXvvIzmiYDmnInkuLvooajmlbDmja7pg73pnIDopoHlj4LkuI7ov5DnrpfvvIzmraTml7blt7Lnu4/noa7lrprorqHnrpfnmoTlrp7kvZPkuIrkuIvmlofkuobjgIJcbiAgICAgICAgICAgIGlzR3JvdXBkTWFpbkVudGl0eSA9IHRydWU7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIOiBmuWQiOS6huWtkOihqOWtl+aute+8jOWPqumcgOimgeS8oOmAkuW9k+WJjeWunuS9k1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyDlvZPliY3kvp3otZbkuI3mmK/ogZrlkIjvvIzlj6rpnIDopoHkvKDpgJLlvZPliY3lrp7kvZNcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdldEVudGl0eSgpO1xuICAgIGlmIChpc0dyb3VwZE1haW5FbnRpdHkpIHtcbiAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24udG9KU09OKCk7XG4gICAgICBkYXRhWydfX3R5cGVfXyddID0gJ0xpc3QnO1xuICAgICAgZGF0YVsnX19pdGVtc19fJ10gPSBjb2xsZWN0aW9uO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuICAvKipcbiAgICog5piv5ZCm5Li65a6e5L2T5L6d6LWWXG4gICAqIEBwYXJhbSBkZXAgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBpc0VudGl0eURlcGVuZGVuY3koZGVwOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZGVwLnN0YXJ0c1dpdGgoRU5USVRZX1RFTVBMQVRFKTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5a6e5L2TXG4gICAqIEBwYXJhbSBldmVudCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0RW50aXR5KCkge1xuICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xuICAgIGNvbnN0IGNoaWxkcmVuRW50aXR5UGF0aHMgPSBbXTtcbiAgICBFeHByZXNzaW9uVXRpbC5nZXRDaGlsZHJlbkVudGl0eVBhdGhzKGVudGl0eVR5cGVJbmZvLCBjaGlsZHJlbkVudGl0eVBhdGhzKTtcbiAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJdGVtLnRvSlNPTigpO1xuICAgIGVudGl0eVsnX190eXBlX18nXSA9ICdFbnRpdHknO1xuICAgIGlmICghY2hpbGRyZW5FbnRpdHlQYXRocyB8fCBjaGlsZHJlbkVudGl0eVBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuICAgIC8vIOaJvuWIsOaJgOacieWtkOihqFxuICAgIGNoaWxkcmVuRW50aXR5UGF0aHMuZm9yRWFjaCgocGF0aHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICBjb25zdCByb3cgPSBFeHByZXNzaW9uVXRpbC5nZXRDdXJyZW50Um93QnlQYXRocyhwYXRocywgYmluZGluZ0RhdGEpO1xuICAgICAgaWYgKHJvdykge1xuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5wb3AoKTtcbiAgICAgICAgbGV0IHBhcmVudCA9IHBhdGhzLnJlZHVjZSgob2JqZWN0OiBhbnksIHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0W3BhdGhdIHx8IG51bGw7XG4gICAgICAgIH0sIGVudGl0eSk7XG4gICAgICAgIGNvbnN0IG5vZGUgPSB7IF9faXRlbXNfXzogWy4uLnBhcmVudFtwcm9wZXJ0eU5hbWVdXSwgLi4ucm93LCBfX3R5cGVfXzogJ0xpc3QnIH07XG4gICAgICAgIHBhcmVudFtwcm9wZXJ0eU5hbWVdID0gbm9kZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gZW50aXR5O1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuLvlrp7kvZPljp/lp4vlrZfmrrXlkI1cbiAgICovXG4gIHByb3RlY3RlZCBnZXQgZW50aXR5T3JpZ2luYWxOb2RlQ29kZSgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSB0aGlzLmluamVjdG9yLmdldChSZXBvc2l0b3J5KTtcbiAgICByZXR1cm4gcmVwb3NpdG9yeSAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvICYmIHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mbyAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlIHx8IG51bGw7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOWPmOmHj+S4iuS4i+aWh1xuICAgKiBAcGFyYW0gZXZlbnQgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGJ1aWxkU3RhdGVDb250ZXh0KCkge1xuICAgIGNvbnN0IG5zID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlO1xuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShucyk7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgaWYgKGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0cy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBhbm9ueW1vdXNGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHRzWzBdO1xuICAgICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dCA9IGFub255bW91c0ZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xuICAgICAgaWYgKHJvb3RGcmFtZUNvbnRleHQpIHtcbiAgICAgICAgY29uc3QgdWlTdGF0ZSA9IHJvb3RGcmFtZUNvbnRleHQudmlld01vZGVsLnVpU3RhdGU7XG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh1aVN0YXRlKSB8fCBbXTtcbiAgICAgICAgcHJvcGVydHlOYW1lcy5mb3JFYWNoKChwcm9wOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICBpZiAocHJvcC5tYXRjaCgvXlthLXpBLVowLTlfXFwkXSskL2cpICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHRbcHJvcF0gPSB1aVN0YXRlW3Byb3BdO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn0iXX0=