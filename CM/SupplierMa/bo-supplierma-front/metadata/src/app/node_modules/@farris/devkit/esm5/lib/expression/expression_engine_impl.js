import { Injectable, Injector } from "@angular/core";
import { ExpressionRegistry } from "./expression_registry";
import { ExpressionEventEmitter } from "./expression_event_emitter";
import { Expression } from './types';
import { ResolverRegistry, ResolveService } from "../resolver/index";
import { EventHandlerRegistry } from "../event-handler/index";
import { Core } from "../core/index";
var ExpressionEngineImpl = /** @class */ (function () {
    function ExpressionEngineImpl(injector, expressionRegistry, expressionEventEmitter, resolverRegistry, eventHandlerRegistry, resolveService) {
        var _this = this;
        this.injector = injector;
        this.expressionRegistry = expressionRegistry;
        this.expressionEventEmitter = expressionEventEmitter;
        this.resolverRegistry = resolverRegistry;
        this.eventHandlerRegistry = eventHandlerRegistry;
        this.resolveService = resolveService;
        this.expressionObjects = new Array();
        this.expressionRegistry.expressions.subscribe(function (exprs) {
            if (exprs && exprs.length > 0) {
                _this.expressionObjects = exprs;
                // 解析表达式依赖
                _this.resolveDependency();
            }
            _this.attachEvent();
        });
    }
    ExpressionEngineImpl.prototype.attachEvent = function () {
        var _this = this;
        this.expressionEventEmitter.attach().subscribe(function (events) {
            if (!events || events.length < 1 || !_this.expressionObjects || _this.expressionObjects.length < 1) {
                return;
            }
            events.forEach(function (event) {
                var handler = _this.getEventHandler(event);
                if (handler) {
                    handler.handleEvent(event, _this.expressionObjects);
                }
                else {
                    Core.warn("\u6CA1\u6709\u5BF9\u5E94\u7684\u4E8B\u4EF6\u5904\u7406\u5668,event=" + event.type);
                }
            });
        });
    };
    /**
     * 解析表达式依赖
     * @returns
     */
    ExpressionEngineImpl.prototype.resolveDependency = function () {
        var _this = this;
        if (!this.resolverRegistry || !this.resolverRegistry.resolvers || this.resolverRegistry.resolvers.length < 1 || !this.expressionObjects || this.expressionObjects.length < 1 || !Array.isArray(this.expressionObjects)) {
            return;
        }
        this.expressionObjects.forEach(function (expressionObject) {
            var expression = expressionObject.expression;
            var dependencies = _this.resolveService.resolve(expression);
            expressionObject.deps = dependencies;
        });
    };
    /**
     * 获取表达式事件处理器
     * @param event event
     * @returns
     */
    ExpressionEngineImpl.prototype.getEventHandler = function (event) {
        if (event.type === Expression.EventType.ValueChanged) {
            // 实体值变化
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;
            }
            else if (event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.entityValueChangedEventHandler;
            }
            else if (event.source === Expression.EventSource.State) {
                return this.eventHandlerRegistry.stateValueChangedEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Append) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryAddEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Remove) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Update) {
            if (event.source === Expression.EventSource.Repository) {
                return this.eventHandlerRegistry.entityUpdateEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Load) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryLoadEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataLoadEventHandler;
            }
        }
        else if (event.type === Expression.EventType.SelectionChanged) {
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;
            }
        }
        return null;
    };
    ExpressionEngineImpl.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ExpressionEngineImpl.ctorParameters = function () { return [
        { type: Injector },
        { type: ExpressionRegistry },
        { type: ExpressionEventEmitter },
        { type: ResolverRegistry },
        { type: EventHandlerRegistry },
        { type: ResolveService }
    ]; };
    return ExpressionEngineImpl;
}());
export { ExpressionEngineImpl };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9lbmdpbmVfaW1wbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXhwcmVzc2lvbl9lbmdpbmVfaW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXJDO0lBR0UsOEJBQ1UsUUFBa0IsRUFDbEIsa0JBQXNDLEVBQ3RDLHNCQUE4QyxFQUM5QyxnQkFBa0MsRUFDbEMsb0JBQTBDLEVBQzFDLGNBQThCO1FBTnhDLGlCQWdCQztRQWZTLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXdCO1FBQzlDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFQaEMsc0JBQWlCLEdBQXVDLElBQUksS0FBSyxFQUErQixDQUFDO1FBU3ZHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQUMsS0FBb0M7WUFDakYsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0s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QUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3ZHLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLDBCQUEwQixDQUFDO2FBQzdEO2lCQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxVQUFVLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRTtnQkFDOUQsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsMkJBQTJCLENBQUM7YUFDOUQ7U0FDRjthQUFNLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsU0FBUyxDQUFDLGdCQUFnQixFQUFFO1lBQy9ELElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxVQUFVLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRTtnQkFDdkQsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsa0NBQWtDLENBQUM7YUFDckU7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7Z0JBN0ZGLFVBQVU7Ozs7Z0JBUlUsUUFBUTtnQkFDcEIsa0JBQWtCO2dCQUNsQixzQkFBc0I7Z0JBRXRCLGdCQUFnQjtnQkFDaEIsb0JBQW9CO2dCQURGLGNBQWM7O0lBbUd6QywyQkFBQztDQUFBLEFBL0ZELElBK0ZDO1NBOUZZLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvblJlZ2lzdHJ5IH0gZnJvbSBcIi4vZXhwcmVzc2lvbl9yZWdpc3RyeVwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uRXZlbnRFbWl0dGVyIH0gZnJvbSBcIi4vZXhwcmVzc2lvbl9ldmVudF9lbWl0dGVyXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsgUmVzb2x2ZXJSZWdpc3RyeSwgUmVzb2x2ZVNlcnZpY2UgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcclxuaW1wb3J0IHsgRXZlbnRIYW5kbGVyUmVnaXN0cnkgfSBmcm9tIFwiLi4vZXZlbnQtaGFuZGxlci9pbmRleFwiO1xyXG5pbXBvcnQgeyBDb3JlIH0gZnJvbSBcIi4uL2NvcmUvaW5kZXhcIjtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEV4cHJlc3Npb25FbmdpbmVJbXBsIHtcclxuICBwcml2YXRlIGV4cHJlc3Npb25PYmplY3RzOiBBcnJheTxFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3Q+ID0gbmV3IEFycmF5PEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdD4oKTtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgcHJpdmF0ZSBleHByZXNzaW9uUmVnaXN0cnk6IEV4cHJlc3Npb25SZWdpc3RyeSxcclxuICAgIHByaXZhdGUgZXhwcmVzc2lvbkV2ZW50RW1pdHRlcjogRXhwcmVzc2lvbkV2ZW50RW1pdHRlcixcclxuICAgIHByaXZhdGUgcmVzb2x2ZXJSZWdpc3RyeTogUmVzb2x2ZXJSZWdpc3RyeSxcclxuICAgIHByaXZhdGUgZXZlbnRIYW5kbGVyUmVnaXN0cnk6IEV2ZW50SGFuZGxlclJlZ2lzdHJ5LFxyXG4gICAgcHJpdmF0ZSByZXNvbHZlU2VydmljZTogUmVzb2x2ZVNlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMuZXhwcmVzc2lvblJlZ2lzdHJ5LmV4cHJlc3Npb25zLnN1YnNjcmliZSgoZXhwcnM6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdFtdKSA9PiB7XHJcbiAgICAgIGlmIChleHBycyAmJiBleHBycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5leHByZXNzaW9uT2JqZWN0cyA9IGV4cHJzO1xyXG4gICAgICAgIC8vIOino+aekOihqOi+vuW8j+S+nei1llxyXG4gICAgICAgIHRoaXMucmVzb2x2ZURlcGVuZGVuY3koKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmF0dGFjaEV2ZW50KCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXR0YWNoRXZlbnQoKSB7XHJcbiAgICB0aGlzLmV4cHJlc3Npb25FdmVudEVtaXR0ZXIuYXR0YWNoKCkuc3Vic2NyaWJlKChldmVudHM6IEV4cHJlc3Npb24uRXZlbnRBcmdzW10pID0+IHtcclxuICAgICAgaWYgKCFldmVudHMgfHwgZXZlbnRzLmxlbmd0aCA8IDEgfHwgIXRoaXMuZXhwcmVzc2lvbk9iamVjdHMgfHwgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5sZW5ndGggPCAxKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIGV2ZW50cy5mb3JFYWNoKChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MpID0+IHtcclxuICAgICAgICBjb25zdCBoYW5kbGVyID0gdGhpcy5nZXRFdmVudEhhbmRsZXIoZXZlbnQpO1xyXG4gICAgICAgIGlmIChoYW5kbGVyKSB7XHJcbiAgICAgICAgICBoYW5kbGVyLmhhbmRsZUV2ZW50KGV2ZW50LCB0aGlzLmV4cHJlc3Npb25PYmplY3RzKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgQ29yZS53YXJuKGDmsqHmnInlr7nlupTnmoTkuovku7blpITnkIblmagsZXZlbnQ9JHtldmVudC50eXBlfWApO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6Kej5p6Q6KGo6L6+5byP5L6d6LWWXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZXNvbHZlRGVwZW5kZW5jeSgpIHtcclxuICAgIGlmICghdGhpcy5yZXNvbHZlclJlZ2lzdHJ5IHx8ICF0aGlzLnJlc29sdmVyUmVnaXN0cnkucmVzb2x2ZXJzIHx8IHRoaXMucmVzb2x2ZXJSZWdpc3RyeS5yZXNvbHZlcnMubGVuZ3RoIDwgMSB8fCAhdGhpcy5leHByZXNzaW9uT2JqZWN0cyB8fCB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmxlbmd0aCA8IDEgfHwgIUFycmF5LmlzQXJyYXkodGhpcy5leHByZXNzaW9uT2JqZWN0cykpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5mb3JFYWNoKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcclxuICAgICAgY29uc3QgZXhwcmVzc2lvbiA9IGV4cHJlc3Npb25PYmplY3QuZXhwcmVzc2lvbjtcclxuICAgICAgY29uc3QgZGVwZW5kZW5jaWVzID0gdGhpcy5yZXNvbHZlU2VydmljZS5yZXNvbHZlKGV4cHJlc3Npb24pO1xyXG4gICAgICBleHByZXNzaW9uT2JqZWN0LmRlcHMgPSBkZXBlbmRlbmNpZXM7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W6KGo6L6+5byP5LqL5Lu25aSE55CG5ZmoXHJcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRFdmVudEhhbmRsZXIoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKTogRXhwcmVzc2lvbi5JRXZlbnRIYW5kbGVyIHtcclxuICAgIGlmIChldmVudC50eXBlID09PSBFeHByZXNzaW9uLkV2ZW50VHlwZS5WYWx1ZUNoYW5nZWQpIHtcclxuICAgICAgLy8g5a6e5L2T5YC85Y+Y5YyWXHJcbiAgICAgIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuQmluZGluZ0RhdGEpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5iaW5kaW5nRGF0YVZhbHVlQ2hhbmdlRXZlbnRIYW5kbGVyO1xyXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5GaWVsZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmVudGl0eVZhbHVlQ2hhbmdlZEV2ZW50SGFuZGxlcjtcclxuICAgICAgfSBlbHNlIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuU3RhdGUpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5zdGF0ZVZhbHVlQ2hhbmdlZEV2ZW50SGFuZGxlcjtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChldmVudC50eXBlID09PSBFeHByZXNzaW9uLkV2ZW50VHlwZS5BcHBlbmQpIHtcclxuICAgICAgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5SZXBvc2l0b3J5IHx8IGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5GaWVsZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LnJlcG9zaXRvcnlBZGRFbnRpdHlFdmVudEhhbmRsZXI7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuYmluZGluZ0RhdGFBcHBlbmRFbnRpdHlFdmVudEhhbmRsZXI7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoZXZlbnQudHlwZSA9PT0gRXhwcmVzc2lvbi5FdmVudFR5cGUuUmVtb3ZlKSB7XHJcbiAgICAgIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuUmVwb3NpdG9yeSB8fCBldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuRmllbGQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5yZXBvc2l0b3J5UmVtb3ZlRW50aXR5RXZlbnRIYW5kbGVyO1xyXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5CaW5kaW5nRGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmJpbmRpbmdEYXRhUmVtb3ZlT2JqZWN0RXZlbnRIYW5kbGVyO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09IEV4cHJlc3Npb24uRXZlbnRUeXBlLlVwZGF0ZSkge1xyXG4gICAgICBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLlJlcG9zaXRvcnkpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5lbnRpdHlVcGRhdGVFdmVudEhhbmRsZXI7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoZXZlbnQudHlwZSA9PT0gRXhwcmVzc2lvbi5FdmVudFR5cGUuTG9hZCkge1xyXG4gICAgICBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLlJlcG9zaXRvcnkgfHwgZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkZpZWxkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkucmVwb3NpdG9yeUxvYWRFdmVudEhhbmRsZXI7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuYmluZGluZ0RhdGFMb2FkRXZlbnRIYW5kbGVyO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09IEV4cHJlc3Npb24uRXZlbnRUeXBlLlNlbGVjdGlvbkNoYW5nZWQpIHtcclxuICAgICAgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5CaW5kaW5nRGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmJpbmRpbmdEYXRhU2VsZWN0aW9uQ2hhbmdlZEhhbmRsZXI7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICBcclxufSJdfQ==