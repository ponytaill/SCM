import { Injectable, Optional } from '@angular/core';
import { LoadingService } from '@farris/ui-loading';
import { HideEventService } from './hide-event.service';
import { AppContext } from '@farris/devkit';
// tslint:disable: no-string-literal
/**
 * 加载提示Helper
 * 1、包装@farris/ui的LoadingService；
 * 2、提供针对表单的快捷方法；
 */
var FormLoadingService = /** @class */ (function () {
    /**
     * 强制显示，不能隐藏
     */
    /**
     * 构造函数
     * 注入@farris/ui的LoadingService
     */
    function FormLoadingService(loadingService, hideEventService, applicationContext) {
        var _this = this;
        this.loadingService = loadingService;
        this.hideEventService = hideEventService;
        this.applicationContext = applicationContext;
        /**
         * 延迟loading定时器
         */
        this.loadingTimerIds = [];
        if (hideEventService) {
            this.hideEventService.hideEvent.subscribe(function (result) {
                _this.hide();
            });
        }
    }
    FormLoadingService.prototype.setSuspend = function (flag) {
        FormLoadingService.isSuspend = flag;
    };
    /**
     * 显示加载中
     */
    FormLoadingService.prototype.show = function (configOrMessage) {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        if (this.loadingCmp) {
            this.loadingCmp.close();
            this.loadingCmp = null;
        }
        this.registerService();
        var loadingConfig = this.buildLoadingConfig(configOrMessage);
        this.loadingCmp = this.loadingService.show(loadingConfig);
        return this.loadingCmp;
    };
    /**
     * 延迟显示Loading
     */
    FormLoadingService.prototype.showLoadingWithDelay = function (delayTime, configOrMessage) {
        var _this = this;
        // this.show(configOrMessage);
        var timerId = setTimeout(function () {
            _this.show(configOrMessage);
        }, delayTime);
        this.loadingTimerIds.push(timerId);
        this.registerService();
        return timerId;
    };
    /**
     * 隐藏延迟的Loading
     */
    FormLoadingService.prototype.hideDelayLoading = function (timerIdToClear) {
        this.clearLoadingTimer(timerIdToClear);
        this.hide();
    };
    /**
     * 构造LoadingConfig
     * @param configOrMessage 配置对象或消息字符串
     */
    FormLoadingService.prototype.buildLoadingConfig = function (configOrMessage) {
        var loadingConfig;
        if (!!configOrMessage) {
            if (typeof configOrMessage === 'object') {
                loadingConfig = configOrMessage;
            }
            else {
                loadingConfig = { 'message': configOrMessage };
            }
        }
        else {
            loadingConfig = {};
        }
        if (!loadingConfig.hasOwnProperty('delay')) {
            loadingConfig.delay = 0;
        }
        return loadingConfig;
    };
    /**
     * 关闭所有loading
     */
    FormLoadingService.prototype.clearAll = function () {
        var _this = this;
        FormLoadingService.isSuspend = false;
        window.setTimeout(function () {
            _this.loadingService.clearAll();
        }, 350);
        this.loadingCmp = null;
        this.clearAllLoadingTimers();
        this.destroy();
    };
    /**
     * 清空Loading定时器
     */
    FormLoadingService.prototype.clearLoadingTimer = function (timerIdToClear) {
        clearTimeout(timerIdToClear);
        this.loadingTimerIds = this.loadingTimerIds.filter(function (timerId) {
            return timerId !== timerIdToClear;
        });
    };
    /**
     * 清空所有Loading定时器
     */
    FormLoadingService.prototype.clearAllLoadingTimers = function () {
        var _this = this;
        this.loadingTimerIds.forEach(function (timerId) {
            _this.clearLoadingTimer(timerId);
        });
    };
    /**
     * 隐藏加载中
     */
    FormLoadingService.prototype.hide = function () {
        if (!this.loadingCmp) {
            this.destroy();
            return;
        }
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        this.loadingCmp.close();
        this.loadingCmp = null;
        this.destroy();
    };
    /**
     * 销毁loadingService
     */
    FormLoadingService.prototype.destroy = function () {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        var services = window['DEVKIT_LOADING_SERVICE'] || [];
        if (services && Array.isArray(services) && services.length > 0) {
            services.forEach(function (service) {
                if (service) {
                    service.clearAllLoadingTimers();
                    if (service.loadingCmp) {
                        service.loadingCmp.close();
                        service.loadingCmp = null;
                    }
                }
            });
        }
        window['DEVKIT_LOADING_SERVICE'] = [];
    };
    /**
     * 注册所有的LoadingService实例
     */
    FormLoadingService.prototype.registerService = function () {
        var services = window['DEVKIT_LOADING_SERVICE'] || [];
        services.push(this);
        window['DEVKIT_LOADING_SERVICE'] = services;
    };
    FormLoadingService.isSuspend = false;
    FormLoadingService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FormLoadingService.ctorParameters = function () { return [
        { type: LoadingService },
        { type: HideEventService, decorators: [{ type: Optional }] },
        { type: AppContext, decorators: [{ type: Optional }] }
    ]; };
    return FormLoadingService;
}());
export { FormLoadingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1sb2FkaW5nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVksUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQW1DLE1BQU0sb0JBQW9CLENBQUM7QUFDckYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxvQ0FBb0M7QUFDcEM7Ozs7R0FJRztBQUNIO0lBYUU7O09BRUc7SUFFSDs7O09BR0c7SUFDSCw0QkFDVSxjQUE4QixFQUNsQixnQkFBa0MsRUFDbEMsa0JBQThCO1FBSHBELGlCQVlDO1FBWFMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQ2xCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFZO1FBaEJwRDs7V0FFRztRQUNLLG9CQUFlLEdBQVUsRUFBRSxDQUFDO1FBZWxDLElBQUksZ0JBQWdCLEVBQUU7WUFDcEIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQ3ZDLFVBQUEsTUFBTTtnQkFDSixLQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDZCxDQUFDLENBQ0YsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUNNLHVDQUFVLEdBQWpCLFVBQWtCLElBQWE7UUFDN0Isa0JBQWtCLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztJQUN0QyxDQUFDO0lBQ0Q7O09BRUc7SUFDSSxpQ0FBSSxHQUFYLFVBQVksZUFBcUI7UUFDL0IsSUFBSSxrQkFBa0IsQ0FBQyxTQUFTLEtBQUssSUFBSSxFQUFFO1lBQ3pDLE9BQU87U0FDUjtRQUNELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1NBQ3hCO1FBQ0QsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMvRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzFELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUN6QixDQUFDO0lBRUQ7O09BRUc7SUFDSSxpREFBb0IsR0FBM0IsVUFBNEIsU0FBaUIsRUFBRSxlQUFxQjtRQUFwRSxpQkFRQztRQVBDLDhCQUE4QjtRQUM5QixJQUFNLE9BQU8sR0FBRyxVQUFVLENBQUM7WUFDekIsS0FBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUM3QixDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDZCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksNkNBQWdCLEdBQXZCLFVBQXdCLGNBQW1CO1FBQ3pDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssK0NBQWtCLEdBQTFCLFVBQTJCLGVBQW9CO1FBQzdDLElBQUksYUFBNEIsQ0FBQztRQUNqQyxJQUFJLENBQUMsQ0FBQyxlQUFlLEVBQUU7WUFDckIsSUFBSSxPQUFPLGVBQWUsS0FBSyxRQUFRLEVBQUU7Z0JBQ3ZDLGFBQWEsR0FBRyxlQUFlLENBQUM7YUFDakM7aUJBQU07Z0JBQ0wsYUFBYSxHQUFHLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxDQUFDO2FBQ2hEO1NBQ0Y7YUFBTTtZQUNMLGFBQWEsR0FBRyxFQUFFLENBQUM7U0FDcEI7UUFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUMxQyxhQUFhLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztTQUN6QjtRQUNELE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNJLHFDQUFRLEdBQWY7UUFBQSxpQkFRQztRQVBDLGtCQUFrQixDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFDckMsTUFBTSxDQUFDLFVBQVUsQ0FBQztZQUNoQixLQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2pDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNSLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSyw4Q0FBaUIsR0FBekIsVUFBMEIsY0FBbUI7UUFDM0MsWUFBWSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzdCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsVUFBQyxPQUFZO1lBQzlELE9BQU8sT0FBTyxLQUFLLGNBQWMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNLLGtEQUFxQixHQUE3QjtRQUFBLGlCQUlDO1FBSEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsVUFBQyxPQUFZO1lBQ3hDLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNsQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNJLGlDQUFJLEdBQVg7UUFDRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNwQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDZixPQUFPO1NBQ1I7UUFDRCxJQUFJLGtCQUFrQixDQUFDLFNBQVMsS0FBSyxJQUFJLEVBQUU7WUFDekMsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDakIsQ0FBQztJQUNEOztPQUVHO0lBQ0ksb0NBQU8sR0FBZDtRQUNFLElBQUksa0JBQWtCLENBQUMsU0FBUyxLQUFLLElBQUksRUFBRTtZQUN6QyxPQUFPO1NBQ1I7UUFDRCxJQUFNLFFBQVEsR0FBVSxNQUFNLENBQUMsd0JBQXdCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDL0QsSUFBSSxRQUFRLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUM5RCxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQUMsT0FBMkI7Z0JBQzNDLElBQUksT0FBTyxFQUFFO29CQUNYLE9BQU8sQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO29CQUNoQyxJQUFJLE9BQU8sQ0FBQyxVQUFVLEVBQUU7d0JBQ3RCLE9BQU8sQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUM7d0JBQzNCLE9BQU8sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO3FCQUM3QjtpQkFDQTtZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxNQUFNLENBQUMsd0JBQXdCLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDeEMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssNENBQWUsR0FBdkI7UUFDRSxJQUFNLFFBQVEsR0FBVSxNQUFNLENBQUMsd0JBQXdCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDL0QsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNwQixNQUFNLENBQUMsd0JBQXdCLENBQUMsR0FBRyxRQUFRLENBQUM7SUFDOUMsQ0FBQztJQTFLYyw0QkFBUyxHQUFHLEtBQUssQ0FBQzs7Z0JBRmxDLFVBQVU7Ozs7Z0JBVEYsY0FBYztnQkFDZCxnQkFBZ0IsdUJBK0JwQixRQUFRO2dCQTlCSixVQUFVLHVCQStCZCxRQUFROztJQXFKYix5QkFBQztDQUFBLEFBN0tELElBNktDO0FBR0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBTa2lwU2VsZiwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IExvYWRpbmdTZXJ2aWNlLCBMb2FkaW5nQ29uZmlnLCBMb2FkaW5nQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1sb2FkaW5nJztcbmltcG9ydCB7IEhpZGVFdmVudFNlcnZpY2UgfSBmcm9tICcuL2hpZGUtZXZlbnQuc2VydmljZSc7XG5pbXBvcnQgeyBBcHBDb250ZXh0LCBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG4vLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWxcbi8qKlxuICog5Yqg6L295o+Q56S6SGVscGVyXG4gKiAx44CB5YyF6KOFQGZhcnJpcy91aeeahExvYWRpbmdTZXJ2aWNl77ybXG4gKiAy44CB5o+Q5L6b6ZKI5a+56KGo5Y2V55qE5b+r5o235pa55rOV77ybXG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIEZvcm1Mb2FkaW5nU2VydmljZSB7XG4gIHByaXZhdGUgc3RhdGljIGlzU3VzcGVuZCA9IGZhbHNlO1xuICAvKipcbiAgICog5Yqg6L295Lit57uE5Lu25a6e5L6LXG4gICAqL1xuICBwcml2YXRlIGxvYWRpbmdDbXA6IExvYWRpbmdDb21wb25lbnQ7XG5cbiAgLyoqXG4gICAqIOW7tui/n2xvYWRpbmflrprml7blmahcbiAgICovXG4gIHByaXZhdGUgbG9hZGluZ1RpbWVySWRzOiBhbnlbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiDlvLrliLbmmL7npLrvvIzkuI3og73pmpDol49cbiAgICovXG5cbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKiDms6jlhaVAZmFycmlzL3Vp55qETG9hZGluZ1NlcnZpY2VcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IExvYWRpbmdTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgaGlkZUV2ZW50U2VydmljZTogSGlkZUV2ZW50U2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGFwcGxpY2F0aW9uQ29udGV4dDogQXBwQ29udGV4dCxcbiAgKSB7XG4gICAgaWYgKGhpZGVFdmVudFNlcnZpY2UpIHtcbiAgICAgIHRoaXMuaGlkZUV2ZW50U2VydmljZS5oaWRlRXZlbnQuc3Vic2NyaWJlKFxuICAgICAgICByZXN1bHQgPT4ge1xuICAgICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgc2V0U3VzcGVuZChmbGFnOiBib29sZWFuKSB7XG4gICAgRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9IGZsYWc7XG4gIH1cbiAgLyoqXG4gICAqIOaYvuekuuWKoOi9veS4rVxuICAgKi9cbiAgcHVibGljIHNob3coY29uZmlnT3JNZXNzYWdlPzogYW55KTogTG9hZGluZ0NvbXBvbmVudCB7XG4gICAgaWYgKEZvcm1Mb2FkaW5nU2VydmljZS5pc1N1c3BlbmQgPT09IHRydWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHRoaXMubG9hZGluZ0NtcCkge1xuICAgICAgdGhpcy5sb2FkaW5nQ21wLmNsb3NlKCk7XG4gICAgICB0aGlzLmxvYWRpbmdDbXAgPSBudWxsO1xuICAgIH1cbiAgICB0aGlzLnJlZ2lzdGVyU2VydmljZSgpO1xuICAgIGNvbnN0IGxvYWRpbmdDb25maWcgPSB0aGlzLmJ1aWxkTG9hZGluZ0NvbmZpZyhjb25maWdPck1lc3NhZ2UpO1xuICAgIHRoaXMubG9hZGluZ0NtcCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdyhsb2FkaW5nQ29uZmlnKTtcbiAgICByZXR1cm4gdGhpcy5sb2FkaW5nQ21wO1xuICB9XG5cbiAgLyoqXG4gICAqIOW7tui/n+aYvuekukxvYWRpbmdcbiAgICovXG4gIHB1YmxpYyBzaG93TG9hZGluZ1dpdGhEZWxheShkZWxheVRpbWU6IG51bWJlciwgY29uZmlnT3JNZXNzYWdlPzogYW55KTogYW55IHtcbiAgICAvLyB0aGlzLnNob3coY29uZmlnT3JNZXNzYWdlKTtcbiAgICBjb25zdCB0aW1lcklkID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLnNob3coY29uZmlnT3JNZXNzYWdlKTtcbiAgICB9LCBkZWxheVRpbWUpO1xuICAgIHRoaXMubG9hZGluZ1RpbWVySWRzLnB1c2godGltZXJJZCk7XG4gICAgdGhpcy5yZWdpc3RlclNlcnZpY2UoKTtcbiAgICByZXR1cm4gdGltZXJJZDtcbiAgfVxuXG4gIC8qKlxuICAgKiDpmpDol4/lu7bov5/nmoRMb2FkaW5nXG4gICAqL1xuICBwdWJsaWMgaGlkZURlbGF5TG9hZGluZyh0aW1lcklkVG9DbGVhcjogYW55KSB7XG4gICAgdGhpcy5jbGVhckxvYWRpbmdUaW1lcih0aW1lcklkVG9DbGVhcik7XG4gICAgdGhpcy5oaWRlKCk7XG4gIH1cblxuICAvKipcbiAgICog5p6E6YCgTG9hZGluZ0NvbmZpZ1xuICAgKiBAcGFyYW0gY29uZmlnT3JNZXNzYWdlIOmFjee9ruWvueixoeaIlua2iOaBr+Wtl+espuS4slxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZExvYWRpbmdDb25maWcoY29uZmlnT3JNZXNzYWdlOiBhbnkpOiBMb2FkaW5nQ29uZmlnIHtcbiAgICBsZXQgbG9hZGluZ0NvbmZpZzogTG9hZGluZ0NvbmZpZztcbiAgICBpZiAoISFjb25maWdPck1lc3NhZ2UpIHtcbiAgICAgIGlmICh0eXBlb2YgY29uZmlnT3JNZXNzYWdlID09PSAnb2JqZWN0Jykge1xuICAgICAgICBsb2FkaW5nQ29uZmlnID0gY29uZmlnT3JNZXNzYWdlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9hZGluZ0NvbmZpZyA9IHsgJ21lc3NhZ2UnOiBjb25maWdPck1lc3NhZ2UgfTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbG9hZGluZ0NvbmZpZyA9IHt9O1xuICAgIH1cbiAgICBpZiAoIWxvYWRpbmdDb25maWcuaGFzT3duUHJvcGVydHkoJ2RlbGF5JykpIHtcbiAgICAgIGxvYWRpbmdDb25maWcuZGVsYXkgPSAwO1xuICAgIH1cbiAgICByZXR1cm4gbG9hZGluZ0NvbmZpZztcbiAgfVxuXG4gIC8qKlxuICAgKiDlhbPpl63miYDmnIlsb2FkaW5nXG4gICAqL1xuICBwdWJsaWMgY2xlYXJBbGwoKSB7XG4gICAgRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9IGZhbHNlO1xuICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuY2xlYXJBbGwoKTtcbiAgICB9LCAzNTApO1xuICAgIHRoaXMubG9hZGluZ0NtcCA9IG51bGw7XG4gICAgdGhpcy5jbGVhckFsbExvYWRpbmdUaW1lcnMoKTtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnqbpMb2FkaW5n5a6a5pe25ZmoXG4gICAqL1xuICBwcml2YXRlIGNsZWFyTG9hZGluZ1RpbWVyKHRpbWVySWRUb0NsZWFyOiBhbnkpIHtcbiAgICBjbGVhclRpbWVvdXQodGltZXJJZFRvQ2xlYXIpO1xuICAgIHRoaXMubG9hZGluZ1RpbWVySWRzID0gdGhpcy5sb2FkaW5nVGltZXJJZHMuZmlsdGVyKCh0aW1lcklkOiBhbnkpID0+IHtcbiAgICAgIHJldHVybiB0aW1lcklkICE9PSB0aW1lcklkVG9DbGVhcjtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmuIXnqbrmiYDmnIlMb2FkaW5n5a6a5pe25ZmoXG4gICAqL1xuICBwcml2YXRlIGNsZWFyQWxsTG9hZGluZ1RpbWVycygpIHtcbiAgICB0aGlzLmxvYWRpbmdUaW1lcklkcy5mb3JFYWNoKCh0aW1lcklkOiBhbnkpID0+IHtcbiAgICAgIHRoaXMuY2xlYXJMb2FkaW5nVGltZXIodGltZXJJZCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog6ZqQ6JeP5Yqg6L295LitXG4gICAqL1xuICBwdWJsaWMgaGlkZSgpIHtcbiAgICBpZiAoIXRoaXMubG9hZGluZ0NtcCkge1xuICAgICAgdGhpcy5kZXN0cm95KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChGb3JtTG9hZGluZ1NlcnZpY2UuaXNTdXNwZW5kID09PSB0cnVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMubG9hZGluZ0NtcC5jbG9zZSgpO1xuICAgIHRoaXMubG9hZGluZ0NtcCA9IG51bGw7XG4gICAgdGhpcy5kZXN0cm95KCk7XG4gIH1cbiAgLyoqXG4gICAqIOmUgOavgWxvYWRpbmdTZXJ2aWNlXG4gICAqL1xuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICBpZiAoRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzZXJ2aWNlczogYW55W10gPSB3aW5kb3dbJ0RFVktJVF9MT0FESU5HX1NFUlZJQ0UnXSB8fCBbXTtcbiAgICBpZiAoc2VydmljZXMgJiYgQXJyYXkuaXNBcnJheShzZXJ2aWNlcykgJiYgc2VydmljZXMubGVuZ3RoID4gMCkge1xuICAgICAgc2VydmljZXMuZm9yRWFjaCgoc2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlKSA9PiB7XG4gICAgICAgIGlmIChzZXJ2aWNlKSB7XG4gICAgICAgICAgc2VydmljZS5jbGVhckFsbExvYWRpbmdUaW1lcnMoKTtcbiAgICAgICAgICBpZiAoc2VydmljZS5sb2FkaW5nQ21wKSB7XG4gICAgICAgICAgICBzZXJ2aWNlLmxvYWRpbmdDbXAuY2xvc2UoKTtcbiAgICAgICAgICAgIHNlcnZpY2UubG9hZGluZ0NtcCA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHdpbmRvd1snREVWS0lUX0xPQURJTkdfU0VSVklDRSddID0gW107XG4gIH1cblxuICAvKipcbiAgICog5rOo5YaM5omA5pyJ55qETG9hZGluZ1NlcnZpY2Xlrp7kvotcbiAgICovXG4gIHByaXZhdGUgcmVnaXN0ZXJTZXJ2aWNlKCkge1xuICAgIGNvbnN0IHNlcnZpY2VzOiBhbnlbXSA9IHdpbmRvd1snREVWS0lUX0xPQURJTkdfU0VSVklDRSddIHx8IFtdO1xuICAgIHNlcnZpY2VzLnB1c2godGhpcyk7XG4gICAgd2luZG93WydERVZLSVRfTE9BRElOR19TRVJWSUNFJ10gPSBzZXJ2aWNlcztcbiAgfVxufVxuXG5cbmV4cG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9O1xuIl19