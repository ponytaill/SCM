/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { Injectable } from '@angular/core';
import { delay } from 'rxjs/operators';
export class SelectionModeService {
    /**
     * @param {?} grid
     */
    constructor(grid) {
        this.dgRef = null;
        this.oldSettings = null;
        this.selectStartEvent = null;
        this.events = null;
        this.dgRef = grid;
        if (this.dgRef.selectionMode === 'default') {
            grid.zone.runOutsideAngular((/**
             * @return {?}
             */
            () => {
                this.removeEvents();
                this.events = this.registerStopSelectionEvent();
            }));
        }
    }
    /**
     * @return {?}
     */
    destroy() {
        this.dgRef = null;
        this.removeEvents();
    }
    /**
     * @return {?}
     */
    removeEvents() {
        if (this.events && this.events.length) {
            this.events.forEach((/**
             * @param {?} e
             * @return {?}
             */
            e => {
                e();
            }));
            this.events = null;
        }
    }
    /**
     * @return {?}
     */
    toggleMode() {
        if (this.dgRef) {
            if (this.dgRef.selectionMode === 'default') {
                this.enableWindowsSelectionMode();
            }
            else {
                this.restoreSettings();
            }
        }
    }
    /**
     * @return {?}
     */
    enableWindowsSelectionMode() {
        if (this.dgRef) {
            this.oldSettings = {
                showCheckbox: this.dgRef.showCheckbox,
                keepSelect: this.dgRef.keepSelect,
                onlySelectSelf: this.dgRef.onlySelectSelf,
                selectOnCheck: this.dgRef.selectOnCheck,
                checkOnSelect: this.dgRef.checkOnSelect
            };
            this.dgRef.showCheckbox = true;
            this.dgRef.keepSelect = true;
            this.dgRef.onlySelectSelf = false;
            this.dgRef.selectOnCheck = true;
            this.dgRef.checkOnSelect = true;
            this.dgRef.dfs.updateProperty('keepSelect', true);
            this.dgRef.dfs.updateProperty('onlySelectSelf', false);
            this.dgRef.dfs.updateProperty('selectOnCheck', true);
            this.dgRef.dfs.updateProperty('checkOnSelect', true);
        }
    }
    /**
     * @return {?}
     */
    restoreSettings() {
        if (this.dgRef && this.oldSettings) {
            this.dgRef.showCheckbox = this.oldSettings.showCheckbox;
            this.dgRef.keepSelect = this.oldSettings.keepSelect;
            this.dgRef.onlySelectSelf = this.oldSettings.onlySelectSelf;
            this.dgRef.selectOnCheck = this.oldSettings.selectOnCheck;
            this.dgRef.checkOnSelect = this.oldSettings.checkOnSelect;
            this.dgRef.dfs.updateProperty('keepSelect', this.oldSettings.keepSelect);
            this.dgRef.dfs.updateProperty('onlySelectSelf', this.oldSettings.onlySelectSelf);
            this.dgRef.dfs.updateProperty('selectOnCheck', this.oldSettings.selectOnCheck);
            this.dgRef.dfs.updateProperty('checkOnSelect', this.oldSettings.checkOnSelect);
        }
    }
    /**
     * @private
     * @return {?}
     */
    registerStopSelectionEvent() {
        /** @type {?} */
        const kd = this.dgRef.render2.listen(document, 'keydown', (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            if (event.ctrlKey || event.shiftKey) {
                this.unselectable();
            }
        }));
        /** @type {?} */
        const ku = this.dgRef.render2.listen(document, 'keyup', (/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            if (event.ctrlKey || event.shiftKey || event.keyCode === 17 || event.keyCode === 16) {
                this.enableSelectable();
            }
        }));
        return [kd, ku];
    }
    /**
     * @private
     * @return {?}
     */
    unselectable() {
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable', 'on');
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart', 'return false');
        this.dgRef.render2.setStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select', 'none');
    }
    /**
     * @private
     * @return {?}
     */
    enableSelectable() {
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable');
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart');
        this.dgRef.render2.removeStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select');
    }
    /**
     * @param {?} param
     * @return {?}
     */
    beforRowClick(param) {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            /** @type {?} */
            const isSelected = this.dgRef.dfs.isRowSelected(param.id);
            /** @type {?} */
            const isCtrlKey = param.e.ctrlKey;
            /** @type {?} */
            const isShiftKey = param.e.shiftKey;
            this.dgRef.endEditing();
            if (!isCtrlKey && !isShiftKey) {
                if (!isSelected) {
                    this.dgRef.clearCheckeds();
                }
                else {
                    // 如果有多条选，移除其他选中行
                    /** @type {?} */
                    const currentPagerIds = this.dgRef.getRows().map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n.id));
                    /** @type {?} */
                    const unCheckIDs = this.dgRef.checkValues.filter((/**
                     * @param {?} i
                     * @return {?}
                     */
                    i => currentPagerIds.includes(i) && i != param.id));
                    /** @type {?} */
                    const unSelectIds = this.dgRef.checkValues.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => !currentPagerIds.includes(n)));
                    // const unCheckIDs = this.dgRef.checkValues.filter(n => n != param.id);
                    if (unCheckIDs && unCheckIDs.length) {
                        this.dgRef.unCheckRows(unCheckIDs, true);
                        this.dgRef.clearSelections([param.id, ...unSelectIds]);
                    }
                }
            }
            else {
                if (isShiftKey) {
                    /** @type {?} */
                    let focusIndex = this.dgRef.focusRowIndex;
                    if (focusIndex === -1) {
                        focusIndex = 0;
                    }
                    /** @type {?} */
                    const endIndex = param.rowIndex;
                    /** @type {?} */
                    let start = focusIndex;
                    /** @type {?} */
                    let end = endIndex;
                    if (focusIndex > endIndex) {
                        start = endIndex;
                        end = focusIndex;
                    }
                    /** @type {?} */
                    const data = this.dgRef.getRows();
                    /** @type {?} */
                    const checkedItems = [...data].splice(start, end - start + 1);
                    /** @type {?} */
                    const willCheckIds = checkedItems.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => {
                        return this.dgRef.dfs.primaryId(n);
                    }));
                    if (!isCtrlKey) {
                        this.dgRef.clearCheckeds(false, false);
                    }
                    // this.dgRef.selectValues = willCheckIds;
                    this.dgRef.checkRows(willCheckIds, true);
                    return true;
                }
            }
            if (isSelected && isCtrlKey) {
                param.e.stopPropagation();
                // 执行取消选择
                this.dgRef.unCheckRow(param.id);
                return true;
            }
            this.dgRef.beforeSelect(param).pipe(delay(100)).subscribe((/**
             * @param {?} canSelect
             * @return {?}
             */
            (canSelect) => {
                if (canSelect) {
                    this.dgRef.dfs.selectRow(param.rowIndex, param.rowData);
                    if (this.dgRef.selectedRow) {
                        this.dgRef.selectedRow.dr = param.dr;
                    }
                }
                this.dgRef.rowClick.emit({ data: param.rowData, grid: this.dgRef, dblclick: false });
                this.dgRef.dgs.setSelecedRow.emit({ selected: true, id: this.dgRef.dfs.primaryId(param.rowData) });
            }));
            return true;
        }
        return false;
    }
    /**
     * @return {?}
     */
    endRowClick() {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            this.dgRef.checkOnSelect = false;
        }
    }
}
SelectionModeService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SelectionModeService.ctorParameters = () => [
    { type: DatagridComponent }
];
if (false) {
    /** @type {?} */
    SelectionModeService.prototype.dgRef;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.oldSettings;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.selectStartEvent;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.events;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1vZGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvc2VsZWN0aW9uLW1vZGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDNUQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHdkMsTUFBTSxPQUFPLG9CQUFvQjs7OztJQUs3QixZQUFZLElBQXVCO1FBSm5DLFVBQUssR0FBc0IsSUFBSSxDQUFDO1FBQ3hCLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLHFCQUFnQixHQUFRLElBQUksQ0FBQztRQUM3QixXQUFNLEdBQUcsSUFBSSxDQUFDO1FBRWxCLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEtBQUssU0FBUyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCOzs7WUFBQyxHQUFHLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDcEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztZQUNwRCxDQUFDLEVBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQzs7OztJQUVELE9BQU87UUFDSCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDeEIsQ0FBQzs7OztJQUVELFlBQVk7UUFDUixJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7WUFDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFP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O3dCQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQztxQkFDeEM7aUJBQ0o7Z0JBQ0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7Z0JBQ3JGLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2RyxDQUFDLEVBQUMsQ0FBQztZQUVILE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDOzs7O0lBRUQsV0FBVztRQUNQLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsS0FBSyxTQUFTLEVBQUU7WUFDdEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1NBQ3BDO0lBQ0wsQ0FBQzs7O1lBN0xKLFVBQVU7Ozs7WUFKRixpQkFBaUI7Ozs7SUFNdEIscUNBQWdDOzs7OztJQUNoQywyQ0FBZ0M7Ozs7O0lBQ2hDLGdEQUFxQzs7Ozs7SUFDckMsc0NBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICcuLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZGVsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25Nb2RlU2VydmljZSB7XHJcbiAgICBkZ1JlZjogRGF0YWdyaWRDb21wb25lbnQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBvbGRTZXR0aW5nczogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgc2VsZWN0U3RhcnRFdmVudDogYW55ID0gbnVsbDtcclxuICAgIHByaXZhdGUgZXZlbnRzID0gbnVsbDtcclxuICAgIGNvbnN0cnVjdG9yKGdyaWQ6IERhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZiA9IGdyaWQ7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgIGdyaWQuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUV2ZW50cygpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudHMgPSB0aGlzLnJlZ2lzdGVyU3RvcFNlbGVjdGlvbkV2ZW50KCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBkZXN0cm95KCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYgPSBudWxsO1xyXG4gICAgICAgIHRoaXMucmVtb3ZlRXZlbnRzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlRXZlbnRzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmV2ZW50cyAmJiB0aGlzLmV2ZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5ldmVudHMuZm9yRWFjaChlID0+IHtcclxuICAgICAgICAgICAgICAgIGUoKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmV2ZW50cyA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB0b2dnbGVNb2RlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbmFibGVXaW5kb3dzU2VsZWN0aW9uTW9kZSgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXN0b3JlU2V0dGluZ3MoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZW5hYmxlV2luZG93c1NlbGVjdGlvbk1vZGUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5vbGRTZXR0aW5ncyA9IHtcclxuICAgICAgICAgICAgICAgIHNob3dDaGVja2JveDogdGhpcy5kZ1JlZi5zaG93Q2hlY2tib3gsXHJcbiAgICAgICAgICAgICAgICBrZWVwU2VsZWN0OiB0aGlzLmRnUmVmLmtlZXBTZWxlY3QsXHJcbiAgICAgICAgICAgICAgICBvbmx5U2VsZWN0U2VsZjogdGhpcy5kZ1JlZi5vbmx5U2VsZWN0U2VsZixcclxuICAgICAgICAgICAgICAgIHNlbGVjdE9uQ2hlY2s6IHRoaXMuZGdSZWYuc2VsZWN0T25DaGVjayxcclxuICAgICAgICAgICAgICAgIGNoZWNrT25TZWxlY3Q6IHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdFxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zaG93Q2hlY2tib3ggPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmtlZXBTZWxlY3QgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLm9ubHlTZWxlY3RTZWxmID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2VsZWN0T25DaGVjayA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdCA9IHRydWU7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgna2VlcFNlbGVjdCcsIHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnb25seVNlbGVjdFNlbGYnLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdzZWxlY3RPbkNoZWNrJywgdHJ1ZSk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdjaGVja09uU2VsZWN0JywgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZXN0b3JlU2V0dGluZ3MoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYgJiYgdGhpcy5vbGRTZXR0aW5ncykge1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNob3dDaGVja2JveCA9IHRoaXMub2xkU2V0dGluZ3Muc2hvd0NoZWNrYm94O1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmtlZXBTZWxlY3QgPSB0aGlzLm9sZFNldHRpbmdzLmtlZXBTZWxlY3Q7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYub25seVNlbGVjdFNlbGYgPSB0aGlzLm9sZFNldHRpbmdzLm9ubHlTZWxlY3RTZWxmO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNlbGVjdE9uQ2hlY2sgPSB0aGlzLm9sZFNldHRpbmdzLnNlbGVjdE9uQ2hlY2s7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdCA9IHRoaXMub2xkU2V0dGluZ3MuY2hlY2tPblNlbGVjdDtcclxuXHJcblxyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgna2VlcFNlbGVjdCcsIHRoaXMub2xkU2V0dGluZ3Mua2VlcFNlbGVjdCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdvbmx5U2VsZWN0U2VsZicsIHRoaXMub2xkU2V0dGluZ3Mub25seVNlbGVjdFNlbGYpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnc2VsZWN0T25DaGVjaycsIHRoaXMub2xkU2V0dGluZ3Muc2VsZWN0T25DaGVjayk7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZGZzLnVwZGF0ZVByb3BlcnR5KCdjaGVja09uU2VsZWN0JywgdGhpcy5vbGRTZXR0aW5ncy5jaGVja09uU2VsZWN0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJTdG9wU2VsZWN0aW9uRXZlbnQoKSB7XHJcbiAgICAgICAgY29uc3Qga2QgPSB0aGlzLmRnUmVmLnJlbmRlcjIubGlzdGVuKGRvY3VtZW50LCAna2V5ZG93bicsIChldmVudDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50LnNoaWZ0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVuc2VsZWN0YWJsZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGt1ID0gdGhpcy5kZ1JlZi5yZW5kZXIyLmxpc3Rlbihkb2N1bWVudCwgJ2tleXVwJywgKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQuc2hpZnRLZXkgfHwgZXZlbnQua2V5Q29kZSA9PT0gMTcgfHwgZXZlbnQua2V5Q29kZSA9PT0gMTYpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlU2VsZWN0YWJsZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBbIGtkLCBrdV07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1bnNlbGVjdGFibGUoKSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnNldEF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICd1bnNlbGVjdGFibGUnLCAnb24nKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIuc2V0QXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ29uc2VsZWN0c3RhcnQnLCAncmV0dXJuIGZhbHNlJyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnNldFN0eWxlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJy1tb3otdXNlci1zZWxlY3QnLCAnbm9uZScpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZW5hYmxlU2VsZWN0YWJsZSgpIHtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ3Vuc2VsZWN0YWJsZScpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5yZW1vdmVBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnb25zZWxlY3RzdGFydCcpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5yZW1vdmVTdHlsZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICctbW96LXVzZXItc2VsZWN0Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgYmVmb3JSb3dDbGljayhwYXJhbTogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZGdSZWYgJiYgdGhpcy5kZ1JlZi5zZWxlY3Rpb25Nb2RlID09PSAnZGVmYXVsdCcpIHtcclxuICAgICAgICAgICAgY29uc3QgaXNTZWxlY3RlZCA9IHRoaXMuZGdSZWYuZGZzLmlzUm93U2VsZWN0ZWQocGFyYW0uaWQpO1xyXG4gICAgICAgICAgICBjb25zdCBpc0N0cmxLZXkgPSBwYXJhbS5lLmN0cmxLZXk7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzU2hpZnRLZXkgPSBwYXJhbS5lLnNoaWZ0S2V5O1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5lbmRFZGl0aW5nKCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIWlzQ3RybEtleSAmJiAhaXNTaGlmdEtleSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKCFpc1NlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jbGVhckNoZWNrZWRzKCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWmguaenOacieWkmuadoemAie+8jOenu+mZpOWFtuS7lumAieS4reihjFxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRQYWdlcklkcyA9IHRoaXMuZGdSZWYuZ2V0Um93cygpLm1hcChuID0+IG4uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHVuQ2hlY2tJRHMgPSB0aGlzLmRnUmVmLmNoZWNrVmFsdWVzLmZpbHRlcihpID0+IGN1cnJlbnRQYWdlcklkcy5pbmNsdWRlcyhpKSAmJiBpICE9IHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB1blNlbGVjdElkcyA9IHRoaXMuZGdSZWYuY2hlY2tWYWx1ZXMuZmlsdGVyKG4gPT4gIWN1cnJlbnRQYWdlcklkcy5pbmNsdWRlcyhuKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgdW5DaGVja0lEcyA9IHRoaXMuZGdSZWYuY2hlY2tWYWx1ZXMuZmlsdGVyKG4gPT4gbiAhPSBwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVuQ2hlY2tJRHMgJiYgdW5DaGVja0lEcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi51bkNoZWNrUm93cyh1bkNoZWNrSURzLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jbGVhclNlbGVjdGlvbnMoW3BhcmFtLmlkLCAuLi51blNlbGVjdElkc10pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChpc1NoaWZ0S2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGZvY3VzSW5kZXggPSB0aGlzLmRnUmVmLmZvY3VzUm93SW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzSW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvY3VzSW5kZXggPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kSW5kZXggPSBwYXJhbS5yb3dJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBmb2N1c0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBlbmQgPSBlbmRJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZm9jdXNJbmRleCA+IGVuZEluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gZW5kSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVuZCA9IGZvY3VzSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gdGhpcy5kZ1JlZi5nZXRSb3dzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2tlZEl0ZW1zID0gWy4uLmRhdGFdLnNwbGljZShzdGFydCwgZW5kIC0gc3RhcnQgKyAxKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB3aWxsQ2hlY2tJZHMgPSBjaGVja2VkSXRlbXMubWFwKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZ1JlZi5kZnMucHJpbWFyeUlkKG4pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWlzQ3RybEtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmNsZWFyQ2hlY2tlZHMoZmFsc2UsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5kZ1JlZi5zZWxlY3RWYWx1ZXMgPSB3aWxsQ2hlY2tJZHM7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jaGVja1Jvd3Mod2lsbENoZWNrSWRzLCB0cnVlKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGlzU2VsZWN0ZWQgJiYgaXNDdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICBwYXJhbS5lLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgLy8g5omn6KGM5Y+W5raI6YCJ5oupXHJcbiAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnVuQ2hlY2tSb3cocGFyYW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5iZWZvcmVTZWxlY3QocGFyYW0pLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBkZWxheSgxMDApXHJcbiAgICAgICAgICAgICkuc3Vic2NyaWJlKChjYW5TZWxlY3Q6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChjYW5TZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy5zZWxlY3RSb3cocGFyYW0ucm93SW5kZXgsIHBhcmFtLnJvd0RhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRnUmVmLnNlbGVjdGVkUm93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuc2VsZWN0ZWRSb3cuZHIgPSBwYXJhbS5kcjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnJvd0NsaWNrLmVtaXQoeyBkYXRhOiBwYXJhbS5yb3dEYXRhLCBncmlkOiB0aGlzLmRnUmVmLCBkYmxjbGljazogZmFsc2UgfSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLmRncy5zZXRTZWxlY2VkUm93LmVtaXQoeyBzZWxlY3RlZDogdHJ1ZSwgaWQ6IHRoaXMuZGdSZWYuZGZzLnByaW1hcnlJZChwYXJhbS5yb3dEYXRhKSB9KTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIGVuZFJvd0NsaWNrKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmICYmIHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tPblNlbGVjdCA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG5cclxuIl19