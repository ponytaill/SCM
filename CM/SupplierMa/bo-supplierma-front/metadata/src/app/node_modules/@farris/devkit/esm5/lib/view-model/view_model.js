import { Injectable } from '@angular/core';
import { MetadataUtil } from '../metadata/index';
import { NG_COMMAND } from './decorators';
import { of, Subject, from, EMPTY } from 'rxjs';
import { concatMap, tap, every } from 'rxjs/operators';
/**
 * ViewModel是界面层访问应用层的入口。
 *
 * ### 定义ViewModel
 *
 * 定义ViewModel需要以下几个步骤：
 *
 * 1、定义的ViewModel需要继承ViewModel基类
 * 2、使用NgViewModel关联相关对象，比如：绑定数据（SinmpleDemoBindingData）、表单（SimpleDemoForm）、
 *    状态机（SimpleDemoStateMachine）等，但所有这些关联都是可选的，用不到或者自己单独实现时，不指定即可。
 * 3、同时我们需要传递一个injector给基类的构造函数，在ViewModel实例化时，会从injector获取NgViewModel声明的各个类型的实例。
 *
 * 下面我们来定义一个简单的ViewModel，代码如下：
 * ```ts
 * import { Injector, Injectable } from '@angular/core';
 * import { NgViewModel, ViewModel } from '@farris/devkit';
 *
 * @Injectable()
 * @NgViewModel({
 *   children: [],
 *   binding: SimpleDemoBindingData,
 *   form: SimpleDemoForm,
 *   stateMachine: SimpleDemoStateMachine,
 * })
 * class SimpleDemoViewModel extends ViewModel {
 *    constructor(injector: Injector) {
 *      super(injector);
 *    }
 *    @NgCommand({
 *      name: 'formLoad',
 *      params: {
 *        dataId: '1'
 *      }
 *    })
 *    public formLoad() {}
 * }
 * export { SimpleDemoViewModel };
 * ```
 *
 * 通过组件的构造函数，我们将ViewModel注入进组件
 * ```ts
 * @Component({
 *   selector: 'app-simple-demo',
 *   templateUrl: './simple-demo.component.html'
 * })
 * class SimpleDemoComponent implements OnInit {
 *
 *   public viewModel: SimpleDemoViewModel;
 *
 *   constructor(viewModel: SimpleDemoViewModel) {
 *     this.viewModel = viewModel;
 *   }
 * }
 * ```
 *
 * ### 组件模板中使用ViewModel
 *
 * 我们可以在模板中绑定NgViewModel中指定的 BindingData、Form、StateMachine的实例。
 * ```html
 * * <!--绑定数据-->
 * <p>{{viewModel.bindingData.name}}</p>
 *
 * <!--绑定表单-->
 * <form [formGroup]="viewModel.form">
 *   <input type="text" formControlName="name">
 * </form>
 *
 * <!--绑定状态机-->
 * <button type="button" [disabled]="!viewModel.stateMachine.canAdd">新增 </button>
 * * ```
 *
 * 我们在模板中绑定绑定viewModel的一个方法作为事件处理，这个方法可以是普通的方法，也可以是用NgCommand注解修饰过的。
 * ```html
 * <button type="button" (click)="viewModel.add()">新增 </button>
 * ```
 *
 * ### 组合的ViewModle
 *
 * 当界面比较复杂时，我们对界面按一定的粒度进行拆分，拆分出来的各个组成部分分别对应一个ViewModel，这样就形成了一个ViewModel树。
 * 我们在父的ViewModel的NgViewModel注解中通过在children属性中声明它的子ViewModel，将它们关联起来。
 * 假设我们有一个左列表右卡片的界面，我们可以为左列表、右卡片分别定义一个ViewModel，然后在页面的ViewModel中，将它们组合起来，
 * 代码如下：
 * ```ts
 * @Injectable()
 *  @NgViewModel({
 *  children: [LeftListViewModel, RightCardViewModel],
 *    binding: NestedDemoBindingData,
 * })
 * class NestedDemoViewModel extends ViewModel {
 *   constructor(injector: Injector) {
 *     super(injector);
 *   }
 * }
 * export { NestedDemoViewModel };
 * ```
 */
var ViewModel = /** @class */ (function () {
    /**
     * kendogrid option
     */
    // constructor(metadata?: IContextMetadata) {
    //   if (!this.bindingPath && metadata && metadata.bindingTo) {
    //     this.bindingPath = metadata.bindingTo;
    //   }
    // }
    function ViewModel() {
        /**
         * 界面验证信息
         */
        this.verifyInformations = [];
        this.verifycationChanged = new Subject();
    }
    Object.defineProperty(ViewModel.prototype, "expression", {
        /**
         * 表达式服务
         */
        get: function () {
            return this.frameContext.expressionManager;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ViewModel.prototype, "expressionResult", {
        /**
         * 表达式结果
         */
        get: function () {
            return this.frameContext.expressionResult;
        },
        enumerable: true,
        configurable: true
    });
    ViewModel.prototype.ngOnDestroy = function () {
        this.dispose();
    };
    ViewModel.prototype.dispose = function (options) {
        // this.frameContext = null;
        // this.bindingData = null;
        // this.stateMachine = null;
        this.form = null;
        // this.uiState = null;
        if (this.entityValueChangingListeners) {
            this.entityValueChangingListeners.clear();
        }
        if (this.entityValueChangedListeners) {
            this.entityValueChangedListeners.clear();
        }
        if (this.verifycationChanged) {
            this.verifycationChanged.complete();
            this.verifycationChanged = null;
        }
    };
    ViewModel.prototype.setMetadata = function (metadata) {
        if (!this.bindingPath && metadata && metadata.bindingTo) {
            this.bindingPath = metadata.bindingTo;
        }
    };
    /**
     * 初始化
     */
    ViewModel.prototype.init = function (context) {
        var _this = this;
        if (!this.name) {
            this.name = context.metadata.viewModelCode || this.constructor.name;
        }
        this.frameContext = context;
        this.bindingData = context.bindingData;
        this.uiState = context.uiState;
        this.form = context.form;
        this.stateMachine = context.stateMachine;
        this.buildCommands(context);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        // 为bindingData赋值值变化监听器
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory(function (paths) {
                return function (preValue, value, entityChanged, primaryValue) {
                    var plainPath = '/' + paths.join('/');
                    var command;
                    if (entityChanged === false) {
                        command = _this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = _this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        var change_1 = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            id: primaryValue,
                            changed: entityChanged
                        };
                        var commands = command.split(';').filter(function (p) { return p; });
                        var valueChangeSuccess_1 = true;
                        return from(commands).pipe(concatMap(function (item) {
                            if (!valueChangeSuccess_1) {
                                return EMPTY;
                            }
                            return _this[item](change_1).pipe(tap(function (result) {
                                valueChangeSuccess_1 = result;
                            }));
                        }), every(function (result) { return result; }));
                        // return this[command](change).pipe(map(result => {
                        //   return result === false ? false : true;
                        // }));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        this.initListeners();
    };
    /**
     * 绑定命令
     */
    ViewModel.prototype.buildCommands = function (context) {
        var _this = this;
        var ngCommands = context.metadata.commands || MetadataUtil.getPropsMetadatasByName(this.constructor, NG_COMMAND);
        this.metadatas = ngCommands;
        this.keybindingMap = new Map();
        Object.keys(ngCommands).forEach(function (propertyName) {
            var ngCommand = ngCommands[propertyName];
            // 注册快捷键
            if (ngCommand.keyBinding) {
                _this.keybindingMap.set(propertyName, ngCommand.keyBinding);
            }
            Object.defineProperty(_this, propertyName, {
                value: function (data) {
                    if (context.isDisposed) {
                        return EMPTY;
                    }
                    // 获取命令处理上下文
                    var targetContext = context;
                    if (ngCommand.frameId) {
                        targetContext = context.appContext.getFrameContext(ngCommand.frameId);
                    }
                    var command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: data || null
                    };
                    return targetContext.commandBus.dispatch(command);
                }
            });
        });
    };
    /**
     * 从Form获取监听器
     */
    ViewModel.prototype.initListeners = function () {
        var _this = this;
        var extractPath = function (bindingBasePath, bindingPath) {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter(function (item) { return item.length > 0; }).join('/');
        };
        if (this.form) {
            var valueChangingListeners_1 = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangingListeners[plainPath] = valueChangingListeners_1[bindingPath];
            });
            var valueChangedListeners_1 = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangedListeners[plainPath] = valueChangedListeners_1[bindingPath];
            });
        }
    };
    ViewModel.prototype.bindToParent = function (parent) {
        var _this = this;
        if (parent) {
            if (parent.verifycationChanged) {
                parent.verifycationChanged.subscribe(function (verifyInformations) {
                    if (_this.verifycationChanged) {
                        _this.verifycationChanged.next(verifyInformations);
                    }
                });
            }
        }
    };
    /**
     * 合并审批及表单表达式并计算结果
     * @param expression 表达式
     * @returns
     */
    ViewModel.prototype.transform = function (expression) {
        if (Array.isArray(expression)) {
            var wfConf = expression.find(function (item) { return item && item.source === 'wf'; });
            if (wfConf && wfConf.value) {
                return this.transform(wfConf.value);
            }
            else {
                return this.transform(expression[0]);
            }
        }
        else {
            if (typeof expression === 'boolean') {
                return expression;
            }
            else if (typeof expression === 'string') {
                return new Function('ctx', "return " + expression).apply(this.frameContext, [this]);
            }
            else {
                // 表达式result
                return expression;
            }
        }
    };
    ViewModel.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ViewModel.ctorParameters = function () { return []; };
    return ViewModel;
}());
export { ViewModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld19tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL3ZpZXctbW9kZWwvdmlld19tb2RlbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUF1QixNQUFNLGVBQWUsQ0FBQztBQUNoRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFakQsT0FBTyxFQUFFLFVBQVUsRUFBeUIsTUFBTSxjQUFjLENBQUM7QUFNakUsT0FBTyxFQUFjLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQU8sU0FBUyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQXFDLE1BQU0sZ0JBQWdCLENBQUM7QUFNL0Y7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBK0ZHO0FBQ0g7SUFzRUU7O09BRUc7SUFFSCw2Q0FBNkM7SUFDN0MsK0RBQStEO0lBQy9ELDZDQUE2QztJQUM3QyxNQUFNO0lBQ04sSUFBSTtJQUNKO1FBOUNBOztXQUVHO1FBQ0ksdUJBQWtCLEdBQVUsRUFBRSxDQUFDO1FBRS9CLHdCQUFtQixHQUFHLElBQUksT0FBTyxFQUFTLENBQUM7SUF5Q2xDLENBQUM7SUFyQ2pCLHNCQUFXLGlDQUFVO1FBSHJCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUM7UUFDN0MsQ0FBQzs7O09BQUE7SUFJRCxzQkFBVyx1Q0FBZ0I7UUFIM0I7O1dBRUc7YUFDSDtZQUNFLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztRQUM1QyxDQUFDOzs7T0FBQTtJQThCRCwrQkFBVyxHQUFYO1FBQ0UsSUFBSSxDQUFDLE9B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LENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7cUJBQ25EO2dCQUNILENBQUMsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtJQUNILENBQUM7SUFDRDs7OztPQUlHO0lBQ0ksNkJBQVMsR0FBaEIsVUFBaUIsVUFBeUM7UUFDeEQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFO1lBQzdCLElBQU0sTUFBTSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsVUFBQSxJQUFJLElBQUksT0FBQSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxJQUFJLEVBQTVCLENBQTRCLENBQUMsQ0FBQztZQUNyRSxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFO2dCQUMxQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3JDO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUN0QztTQUNGO2FBQU07WUFDTCxJQUFJLE9BQU8sVUFBVSxLQUFLLFNBQVMsRUFBRTtnQkFDbkMsT0FBTyxVQUFVLENBQUM7YUFDbkI7aUJBQU0sSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUU7Z0JBQ3pDLE9BQU8sSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFLFlBQVUsVUFBWSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2FBQ3JGO2lCQUFNO2dCQUNMLFlBQVk7Z0JBQ1osT0FBTyxVQUFVLENBQUM7YUFDbkI7U0FDRjtJQUNILENBQUM7O2dCQTFRRixVQUFVOzs7O0lBMlFYLGdCQUFDO0NBQUEsQUEzUUQsSUEyUUM7QUFFRCxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uL21ldGFkYXRhL2luZGV4JztcclxuaW1wb3J0IHsgQ29tbWFuZCB9IGZyb20gJy4uL2NvbW1hbmQvaW5kZXgnO1xyXG5pbXBvcnQgeyBOR19DT01NQU5ELCBOZ0NvbW1hbmQsIEtleWJpbmRpbmcgfSBmcm9tICcuL2RlY29yYXRvcnMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgRW50aXR5VmFsdWVDaGFuZ2UgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBVSVN0YXRlIH0gZnJvbSAnLi4vdWktc3RhdGUvaW5kZXgnO1xyXG5pbXBvcnQgeyBGb3JtIH0gZnJvbSAnLi4vZm9ybS9pbmRleCc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZSB9IGZyb20gJy4uL3N0YXRlLW1hY2hpbmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBTdWJqZWN0LCBmcm9tLCBFTVBUWSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAsIGNvbmNhdE1hcCwgdGFwLCBldmVyeSwgZGVib3VuY2VUaW1lLCBzd2l0Y2hNYXAsIHRha2VMYXN0IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uTWFuYWdlciwgRXhwcmVzc2lvblJlc3VsdCB9IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xyXG5pbXBvcnQgeyBJQ29udGV4dE1ldGFkYXRhIH0gZnJvbSAnLi4vYXBwL2FwcF9tZXRhZGF0YSc7XHJcbmltcG9ydCB7IEludm9rZU9uVmFsdWVDaGFuZ2UgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvdHlwZXMnO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5cclxuLyoqXHJcbiAqIFZpZXdNb2RlbOaYr+eVjOmdouWxguiuv+mXruW6lOeUqOWxgueahOWFpeWPo+OAglxyXG4gKlxyXG4gKiAjIyMg5a6a5LmJVmlld01vZGVsXHJcbiAqXHJcbiAqIOWumuS5iVZpZXdNb2RlbOmcgOimgeS7peS4i+WHoOS4quatpemqpO+8mlxyXG4gKlxyXG4gKiAx44CB5a6a5LmJ55qEVmlld01vZGVs6ZyA6KaB57un5om/Vmlld01vZGVs5Z+657G7XHJcbiAqIDLjgIHkvb/nlKhOZ1ZpZXdNb2RlbOWFs+iBlOebuOWFs+Wvueixoe+8jOavlOWmgu+8mue7keWumuaVsOaNru+8iFNpbm1wbGVEZW1vQmluZGluZ0RhdGHvvInjgIHooajljZXvvIhTaW1wbGVEZW1vRm9ybe+8ieOAgVxyXG4gKiAgICDnirbmgIHmnLrvvIhTaW1wbGVEZW1vU3RhdGVNYWNoaW5l77yJ562J77yM5L2G5omA5pyJ6L+Z5Lqb5YWz6IGU6YO95piv5Y+v6YCJ55qE77yM55So5LiN5Yiw5oiW6ICF6Ieq5bex5Y2V54us5a6e546w5pe277yM5LiN5oyH5a6a5Y2z5Y+v44CCXHJcbiAqIDPjgIHlkIzml7bmiJHku6zpnIDopoHkvKDpgJLkuIDkuKppbmplY3Rvcue7meWfuuexu+eahOaehOmAoOWHveaVsO+8jOWcqFZpZXdNb2RlbOWunuS+i+WMluaXtu+8jOS8muS7jmluamVjdG9y6I635Y+WTmdWaWV3TW9kZWzlo7DmmI7nmoTlkITkuKrnsbvlnovnmoTlrp7kvovjgIJcclxuICpcclxuICog5LiL6Z2i5oiR5Lus5p2l5a6a5LmJ5LiA5Liq566A5Y2V55qEVmlld01vZGVs77yM5Luj56CB5aaC5LiL77yaXHJcbiAqIGBgYHRzXHJcbiAqIGltcG9ydCB7IEluamVjdG9yLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbiAqIGltcG9ydCB7IE5nVmlld01vZGVsLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbiAqXHJcbiAqIEBJbmplY3RhYmxlKClcclxuICogQE5nVmlld01vZGVsKHtcclxuICogICBjaGlsZHJlbjogW10sXHJcbiAqICAgYmluZGluZzogU2ltcGxlRGVtb0JpbmRpbmdEYXRhLFxyXG4gKiAgIGZvcm06IFNpbXBsZURlbW9Gb3JtLFxyXG4gKiAgIHN0YXRlTWFjaGluZTogU2ltcGxlRGVtb1N0YXRlTWFjaGluZSxcclxuICogfSlcclxuICogY2xhc3MgU2ltcGxlRGVtb1ZpZXdNb2RlbCBleHRlbmRzIFZpZXdNb2RlbCB7XHJcbiAqICAgIGNvbnN0cnVjdG9yKGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gKiAgICAgIHN1cGVyKGluamVjdG9yKTtcclxuICogICAgfVxyXG4gKiAgICBATmdDb21tYW5kKHtcclxuICogICAgICBuYW1lOiAnZm9ybUxvYWQnLFxyXG4gKiAgICAgIHBhcmFtczoge1xyXG4gKiAgICAgICAgZGF0YUlkOiAnMSdcclxuICogICAgICB9XHJcbiAqICAgIH0pXHJcbiAqICAgIHB1YmxpYyBmb3JtTG9hZCgpIHt9XHJcbiAqIH1cclxuICogZXhwb3J0IHsgU2ltcGxlRGVtb1ZpZXdNb2RlbCB9O1xyXG4gKiBgYGBcclxuICpcclxuICog6YCa6L+H57uE5Lu255qE5p6E6YCg5Ye95pWw77yM5oiR5Lus5bCGVmlld01vZGVs5rOo5YWl6L+b57uE5Lu2XHJcbiAqIGBgYHRzXHJcbiAqIEBDb21wb25lbnQoe1xyXG4gKiAgIHNlbGVjdG9yOiAnYXBwLXNpbXBsZS1kZW1vJyxcclxuICogICB0ZW1wbGF0ZVVybDogJy4vc2ltcGxlLWRlbW8uY29tcG9uZW50Lmh0bWwnXHJcbiAqIH0pXHJcbiAqIGNsYXNzIFNpbXBsZURlbW9Db21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xyXG4gKlxyXG4gKiAgIHB1YmxpYyB2aWV3TW9kZWw6IFNpbXBsZURlbW9WaWV3TW9kZWw7XHJcbiAqXHJcbiAqICAgY29uc3RydWN0b3Iodmlld01vZGVsOiBTaW1wbGVEZW1vVmlld01vZGVsKSB7XHJcbiAqICAgICB0aGlzLnZpZXdNb2RlbCA9IHZpZXdNb2RlbDtcclxuICogICB9XHJcbiAqIH1cclxuICogYGBgXHJcbiAqXHJcbiAqICMjIyDnu4Tku7bmqKHmnb/kuK3kvb/nlKhWaWV3TW9kZWxcclxuICpcclxuICog5oiR5Lus5Y+v5Lul5Zyo5qih5p2/5Lit57uR5a6aTmdWaWV3TW9kZWzkuK3mjIflrprnmoQgQmluZGluZ0RhdGHjgIFGb3Jt44CBU3RhdGVNYWNoaW5l55qE5a6e5L6L44CCXHJcbiAqIGBgYGh0bWxcclxuICogKiA8IS0t57uR5a6a5pWw5o2uLS0+XHJcbiAqIDxwPnt7dmlld01vZGVsLmJpbmRpbmdEYXRhLm5hbWV9fTwvcD5cclxuICpcclxuICogPCEtLee7keWumuihqOWNlS0tPlxyXG4gKiA8Zm9ybSBbZm9ybUdyb3VwXT1cInZpZXdNb2RlbC5mb3JtXCI+XHJcbiAqICAgPGlucHV0IHR5cGU9XCJ0ZXh0XCIgZm9ybUNvbnRyb2xOYW1lPVwibmFtZVwiPlxyXG4gKiA8L2Zvcm0+XHJcbiAqXHJcbiAqIDwhLS3nu5HlrprnirbmgIHmnLotLT5cclxuICogPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgW2Rpc2FibGVkXT1cIiF2aWV3TW9kZWwuc3RhdGVNYWNoaW5lLmNhbkFkZFwiPuaWsOWiniA8L2J1dHRvbj5cclxuICogKiBgYGBcclxuICpcclxuICog5oiR5Lus5Zyo5qih5p2/5Lit57uR5a6a57uR5a6admlld01vZGVs55qE5LiA5Liq5pa55rOV5L2c5Li65LqL5Lu25aSE55CG77yM6L+Z5Liq5pa55rOV5Y+v5Lul5piv5pmu6YCa55qE5pa55rOV77yM5Lmf5Y+v5Lul5piv55SoTmdDb21tYW5k5rOo6Kej5L+u6aWw6L+H55qE44CCXHJcbiAqIGBgYGh0bWxcclxuICogPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgKGNsaWNrKT1cInZpZXdNb2RlbC5hZGQoKVwiPuaWsOWiniA8L2J1dHRvbj5cclxuICogYGBgXHJcbiAqXHJcbiAqICMjIyDnu4TlkIjnmoRWaWV3TW9kbGVcclxuICpcclxuICog5b2T55WM6Z2i5q+U6L6D5aSN5p2C5pe277yM5oiR5Lus5a+555WM6Z2i5oyJ5LiA5a6a55qE57KS5bqm6L+b6KGM5ouG5YiG77yM5ouG5YiG5Ye65p2l55qE5ZCE5Liq57uE5oiQ6YOo5YiG5YiG5Yir5a+55bqU5LiA5LiqVmlld01vZGVs77yM6L+Z5qC35bCx5b2i5oiQ5LqG5LiA5LiqVmlld01vZGVs5qCR44CCXHJcbiAqIOaIkeS7rOWcqOeItueahFZpZXdNb2RlbOeahE5nVmlld01vZGVs5rOo6Kej5Lit6YCa6L+H5ZyoY2hpbGRyZW7lsZ7mgKfkuK3lo7DmmI7lroPnmoTlrZBWaWV3TW9kZWzvvIzlsIblroPku6zlhbPogZTotbfmnaXjgIJcclxuICog5YGH6K6+5oiR5Lus5pyJ5LiA5Liq5bem5YiX6KGo5Y+z5Y2h54mH55qE55WM6Z2i77yM5oiR5Lus5Y+v5Lul5Li65bem5YiX6KGo44CB5Y+z5Y2h54mH5YiG5Yir5a6a5LmJ5LiA5LiqVmlld01vZGVs77yM54S25ZCO5Zyo6aG16Z2i55qEVmlld01vZGVs5Lit77yM5bCG5a6D5Lus57uE5ZCI6LW35p2l77yMXHJcbiAqIOS7o+eggeWmguS4i++8mlxyXG4gKiBgYGB0c1xyXG4gKiBASW5qZWN0YWJsZSgpXHJcbiAqICBATmdWaWV3TW9kZWwoe1xyXG4gKiAgY2hpbGRyZW46IFtMZWZ0TGlzdFZpZXdNb2RlbCwgUmlnaHRDYXJkVmlld01vZGVsXSxcclxuICogICAgYmluZGluZzogTmVzdGVkRGVtb0JpbmRpbmdEYXRhLFxyXG4gKiB9KVxyXG4gKiBjbGFzcyBOZXN0ZWREZW1vVmlld01vZGVsIGV4dGVuZHMgVmlld01vZGVsIHtcclxuICogICBjb25zdHJ1Y3RvcihpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICogICAgIHN1cGVyKGluamVjdG9yKTtcclxuICogICB9XHJcbiAqIH1cclxuICogZXhwb3J0IHsgTmVzdGVkRGVtb1ZpZXdNb2RlbCB9O1xyXG4gKiBgYGBcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgVmlld01vZGVsIGltcGxlbWVudHMgSURpc3Bvc2FibGUsIE9uRGVzdHJveSB7XHJcblxyXG4gIHB1YmxpYyBuYW1lOiBzdHJpbmc7XHJcblxyXG4gIHB1YmxpYyBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YTtcclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a6Lev5b6EXHJcbiAgICog5b2i5aaC77yaLyjmoLnlrp7kvZMp77yML2VkdXPvvIjku47ooajvvInvvIwvZWR1cy9ncmFkZXPvvIjku47ku47ooajvvIlcclxuICAgKi9cclxuICBwdWJsaWMgYmluZGluZ1BhdGg6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog55WM6Z2i54q25oCBXHJcbiAgICovXHJcbiAgcHVibGljIHVpU3RhdGU6IFVJU3RhdGU7XHJcblxyXG4gIC8qKlxyXG4gICAqIOihqOWNleWumuS5iVxyXG4gICAqL1xyXG4gIHB1YmxpYyBmb3JtOiBGb3JtO1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHmnLpcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGVNYWNoaW5lOiBTdGF0ZU1hY2hpbmU7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeVjOmdoumqjOivgeS/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyB2ZXJpZnlJbmZvcm1hdGlvbnM6IGFueVtdID0gW107XHJcblxyXG4gIHB1YmxpYyB2ZXJpZnljYXRpb25DaGFuZ2VkID0gbmV3IFN1YmplY3Q8YW55W10+KCk7XHJcbiAgLyoqXHJcbiAgICog6KGo6L6+5byP5pyN5YqhXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBleHByZXNzaW9uKCk6IEV4cHJlc3Npb25NYW5hZ2VyIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5leHByZXNzaW9uTWFuYWdlcjtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6KGo6L6+5byP57uT5p6cXHJcbiAgICovXHJcbiAgcHVibGljIGdldCBleHByZXNzaW9uUmVzdWx0KCk6IEV4cHJlc3Npb25SZXN1bHQge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmV4cHJlc3Npb25SZXN1bHQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOW/q+aNt+mUruaYoOWwhFxyXG4gICAqL1xyXG4gIHB1YmxpYyBrZXliaW5kaW5nTWFwOiBNYXA8c3RyaW5nLCBLZXliaW5kaW5nPjtcclxuXHJcbiAgLyoqXHJcbiAgICog5YC85Y+Y5YyW5YmN55uR5ZCs5ZmoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBlbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xyXG5cclxuICAvKipcclxuICAgKiDlgLzlj5jljJblkI7nm5HlkKzlmahcclxuICAgKi9cclxuICBwcml2YXRlIGVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVyczogTWFwPHN0cmluZywgc3RyaW5nPjtcclxuICAvKipcclxuICAgKiDlhYPmlbDmja5cclxuICAgKi9cclxuICBwdWJsaWMgbWV0YWRhdGFzOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogTmdDb21tYW5kIH07XHJcblxyXG4gIC8qKlxyXG4gICAqIGtlbmRvZ3JpZCBvcHRpb25cclxuICAgKi9cclxuXHJcbiAgLy8gY29uc3RydWN0b3IobWV0YWRhdGE/OiBJQ29udGV4dE1ldGFkYXRhKSB7XHJcbiAgLy8gICBpZiAoIXRoaXMuYmluZGluZ1BhdGggJiYgbWV0YWRhdGEgJiYgbWV0YWRhdGEuYmluZGluZ1RvKSB7XHJcbiAgLy8gICAgIHRoaXMuYmluZGluZ1BhdGggPSBtZXRhZGF0YS5iaW5kaW5nVG87XHJcbiAgLy8gICB9XHJcbiAgLy8gfVxyXG4gIGNvbnN0cnVjdG9yKCkgeyB9XHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICB9XHJcblxyXG4gIGRpc3Bvc2Uob3B0aW9ucz86IGFueSkge1xyXG4gICAgLy8gdGhpcy5mcmFtZUNvbnRleHQgPSBudWxsO1xyXG4gICAgLy8gdGhpcy5iaW5kaW5nRGF0YSA9IG51bGw7XHJcbiAgICAvLyB0aGlzLnN0YXRlTWFjaGluZSA9IG51bGw7XHJcbiAgICB0aGlzLmZvcm0gPSBudWxsO1xyXG4gICAgLy8gdGhpcy51aVN0YXRlID0gbnVsbDtcclxuXHJcbiAgICBpZiAodGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzKSB7XHJcbiAgICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVycy5jbGVhcigpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzKSB7XHJcbiAgICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzLmNsZWFyKCk7XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy52ZXJpZnljYXRpb25DaGFuZ2VkKSB7XHJcbiAgICAgIHRoaXMudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5jb21wbGV0ZSgpO1xyXG4gICAgICB0aGlzLnZlcmlmeWNhdGlvbkNoYW5nZWQgPSBudWxsO1xyXG4gICAgfVxyXG4gICAgfVxyXG5cclxuICBwdWJsaWMgc2V0TWV0YWRhdGEobWV0YWRhdGE6IElDb250ZXh0TWV0YWRhdGEpIHtcclxuICAgIGlmICghdGhpcy5iaW5kaW5nUGF0aCAmJiBtZXRhZGF0YSAmJiBtZXRhZGF0YS5iaW5kaW5nVG8pIHtcclxuICAgICAgdGhpcy5iaW5kaW5nUGF0aCA9IG1ldGFkYXRhLmJpbmRpbmdUbztcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgcHVibGljIGluaXQoY29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcbiAgICBpZiAoIXRoaXMubmFtZSkge1xyXG4gICAgICB0aGlzLm5hbWUgPSBjb250ZXh0Lm1ldGFkYXRhLnZpZXdNb2RlbENvZGUgfHwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSBjb250ZXh0O1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YSA9IGNvbnRleHQuYmluZGluZ0RhdGE7XHJcbiAgICB0aGlzLnVpU3RhdGUgPSBjb250ZXh0LnVpU3RhdGU7XHJcbiAgICB0aGlzLmZvcm0gPSBjb250ZXh0LmZvcm07XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZSA9IGNvbnRleHQuc3RhdGVNYWNoaW5lO1xyXG4gICAgdGhpcy5idWlsZENvbW1hbmRzKGNvbnRleHQpO1xyXG4gICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcclxuICAgIC8vIOS4umJpbmRpbmdEYXRh6LWL5YC85YC85Y+Y5YyW55uR5ZCs5ZmoXHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YSkge1xyXG4gICAgICB0aGlzLmJpbmRpbmdEYXRhLnNldFZhbHVlQ2hhbmdlSW52b2tlckZhY3RvcnkoKHBhdGhzOiBzdHJpbmdbXSk6IEludm9rZU9uVmFsdWVDaGFuZ2UgPT4ge1xyXG4gICAgICAgIHJldHVybiAocHJlVmFsdWUsIHZhbHVlLCBlbnRpdHlDaGFuZ2VkOiBib29sZWFuLCBwcmltYXJ5VmFsdWU/OiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0+IHtcclxuICAgICAgICAgIGNvbnN0IHBsYWluUGF0aCA9ICcvJyArIHBhdGhzLmpvaW4oJy8nKTtcclxuICAgICAgICAgIGxldCBjb21tYW5kOiBzdHJpbmc7XHJcbiAgICAgICAgICBpZiAoZW50aXR5Q2hhbmdlZCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1twbGFpblBhdGhdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzW3BsYWluUGF0aF07XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKCEhY29tbWFuZCkge1xyXG4gICAgICAgICAgICBjb25zdCBjaGFuZ2U6IEVudGl0eVZhbHVlQ2hhbmdlID0ge1xyXG4gICAgICAgICAgICAgIHBhdGhzOiBwYXRocyxcclxuICAgICAgICAgICAgICBwcmVWYWx1ZTogcHJlVmFsdWUsXHJcbiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLFxyXG4gICAgICAgICAgICAgIGlkOiBwcmltYXJ5VmFsdWUsXHJcbiAgICAgICAgICAgICAgY2hhbmdlZDogZW50aXR5Q2hhbmdlZFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCBjb21tYW5kcyA9IGNvbW1hbmQuc3BsaXQoJzsnKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgICAgbGV0IHZhbHVlQ2hhbmdlU3VjY2VzcyA9IHRydWU7XHJcbiAgICAgICAgICAgIHJldHVybiBmcm9tKGNvbW1hbmRzKS5waXBlKFxyXG4gICAgICAgICAgICAgIGNvbmNhdE1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghdmFsdWVDaGFuZ2VTdWNjZXNzKSB7XHJcbiAgICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2l0ZW1dKGNoYW5nZSkucGlwZShcclxuICAgICAgICAgICAgICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlQ2hhbmdlU3VjY2VzcyA9IHJlc3VsdDtcclxuICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgZXZlcnkoKHJlc3VsdDogYW55KSA9PiByZXN1bHQpXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIC8vIHJldHVybiB0aGlzW2NvbW1hbmRdKGNoYW5nZSkucGlwZShtYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgLy8gICByZXR1cm4gcmVzdWx0ID09PSBmYWxzZSA/IGZhbHNlIDogdHJ1ZTtcclxuICAgICAgICAgICAgLy8gfSkpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmluaXRMaXN0ZW5lcnMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuWRveS7pFxyXG4gICAqL1xyXG4gIHB1YmxpYyBidWlsZENvbW1hbmRzKGNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgY29uc3QgbmdDb21tYW5kczoge1xyXG4gICAgICBbY29tbWFuZE5hbWU6IHN0cmluZ106IE5nQ29tbWFuZFxyXG4gICAgfSA9IGNvbnRleHQubWV0YWRhdGEuY29tbWFuZHMgfHwgTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKHRoaXMuY29uc3RydWN0b3IsIE5HX0NPTU1BTkQpO1xyXG4gICAgdGhpcy5tZXRhZGF0YXMgPSBuZ0NvbW1hbmRzO1xyXG4gICAgdGhpcy5rZXliaW5kaW5nTWFwID0gbmV3IE1hcDxzdHJpbmcsIEtleWJpbmRpbmc+KCk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0NvbW1hbmRzKS5mb3JFYWNoKChwcm9wZXJ0eU5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBuZ0NvbW1hbmQ6IE5nQ29tbWFuZCA9IG5nQ29tbWFuZHNbcHJvcGVydHlOYW1lXTtcclxuICAgICAgLy8g5rOo5YaM5b+r5o236ZSuXHJcbiAgICAgIGlmIChuZ0NvbW1hbmQua2V5QmluZGluZykge1xyXG4gICAgICAgIHRoaXMua2V5YmluZGluZ01hcC5zZXQocHJvcGVydHlOYW1lLCBuZ0NvbW1hbmQua2V5QmluZGluZyk7XHJcbiAgICAgIH1cclxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICAgIHZhbHVlOiAoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICBpZiAoY29udGV4dC5pc0Rpc3Bvc2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOiOt+WPluWRveS7pOWkhOeQhuS4iuS4i+aWh1xyXG4gICAgICAgICAgbGV0IHRhcmdldENvbnRleHQgPSBjb250ZXh0O1xyXG4gICAgICAgICAgaWYgKG5nQ29tbWFuZC5mcmFtZUlkKSB7XHJcbiAgICAgICAgICAgIHRhcmdldENvbnRleHQgPSBjb250ZXh0LmFwcENvbnRleHQuZ2V0RnJhbWVDb250ZXh0KG5nQ29tbWFuZC5mcmFtZUlkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGNvbW1hbmQ6IENvbW1hbmQgPSB7XHJcbiAgICAgICAgICAgIG5hbWU6IG5nQ29tbWFuZC5uYW1lLFxyXG4gICAgICAgICAgICBwYXJhbXM6IG5nQ29tbWFuZC5wYXJhbXMsXHJcbiAgICAgICAgICAgIHBhcmFtRGVzY3JpcHRpb25zOiBuZ0NvbW1hbmQucGFyYW1EZXNjcmlwdGlvbnMsXHJcbiAgICAgICAgICAgIGV2ZW50UGFyYW06IGRhdGEgfHwgbnVsbFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHJldHVybiB0YXJnZXRDb250ZXh0LmNvbW1hbmRCdXMuZGlzcGF0Y2goY29tbWFuZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5LuORm9ybeiOt+WPluebkeWQrOWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5pdExpc3RlbmVycygpIHtcclxuICAgIGNvbnN0IGV4dHJhY3RQYXRoID0gKGJpbmRpbmdCYXNlUGF0aDogc3RyaW5nLCBiaW5kaW5nUGF0aDogc3RyaW5nKTogc3RyaW5nID0+IHtcclxuICAgICAgcmV0dXJuICcvJyArIGJpbmRpbmdCYXNlUGF0aC5zcGxpdCgnLycpLmNvbmNhdChiaW5kaW5nUGF0aC5zcGxpdCgnLicpKS5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0ubGVuZ3RoID4gMCkuam9pbignLycpO1xyXG4gICAgfTtcclxuXHJcbiAgICBpZiAodGhpcy5mb3JtKSB7XHJcbiAgICAgIGNvbnN0IHZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMgPSB0aGlzLmZvcm0uZ2V0RW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVycygpO1xyXG4gICAgICBPYmplY3Qua2V5cyh2YWx1ZUNoYW5naW5nTGlzdGVuZXJzKS5mb3JFYWNoKChiaW5kaW5nUGF0aCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBsYWluUGF0aCA9IGV4dHJhY3RQYXRoKHRoaXMuYmluZGluZ1BhdGgsIGJpbmRpbmdQYXRoKTtcclxuICAgICAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnNbcGxhaW5QYXRoXSA9IHZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnNbYmluZGluZ1BhdGhdO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGNvbnN0IHZhbHVlQ2hhbmdlZExpc3RlbmVycyA9IHRoaXMuZm9ybS5nZXRFbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnMoKTtcclxuICAgICAgT2JqZWN0LmtleXModmFsdWVDaGFuZ2VkTGlzdGVuZXJzKS5mb3JFYWNoKChiaW5kaW5nUGF0aCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHBsYWluUGF0aCA9IGV4dHJhY3RQYXRoKHRoaXMuYmluZGluZ1BhdGgsIGJpbmRpbmdQYXRoKTtcclxuICAgICAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVyc1twbGFpblBhdGhdID0gdmFsdWVDaGFuZ2VkTGlzdGVuZXJzW2JpbmRpbmdQYXRoXTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYmluZFRvUGFyZW50KHBhcmVudDogVmlld01vZGVsKSB7XHJcbiAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgIGlmIChwYXJlbnQudmVyaWZ5Y2F0aW9uQ2hhbmdlZCkge1xyXG4gICAgICAgIHBhcmVudC52ZXJpZnljYXRpb25DaGFuZ2VkLnN1YnNjcmliZSh2ZXJpZnlJbmZvcm1hdGlvbnMgPT4ge1xyXG4gICAgICAgICAgaWYgKHRoaXMudmVyaWZ5Y2F0aW9uQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICB0aGlzLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWQiOW5tuWuoeaJueWPiuihqOWNleihqOi+vuW8j+W5tuiuoeeul+e7k+aenFxyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyB0cmFuc2Zvcm0oZXhwcmVzc2lvbjogc3RyaW5nIHwgYm9vbGVhbiB8IEFycmF5PGFueT4pOiBhbnkge1xyXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZXhwcmVzc2lvbikpIHtcclxuICAgICAgY29uc3Qgd2ZDb25mID0gZXhwcmVzc2lvbi5maW5kKGl0ZW0gPT4gaXRlbSAmJiBpdGVtLnNvdXJjZSA9PT0gJ3dmJyk7XHJcbiAgICAgIGlmICh3ZkNvbmYgJiYgd2ZDb25mLnZhbHVlKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtKHdmQ29uZi52YWx1ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtKGV4cHJlc3Npb25bMF0pO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAodHlwZW9mIGV4cHJlc3Npb24gPT09ICdib29sZWFuJykge1xyXG4gICAgICAgIHJldHVybiBleHByZXNzaW9uO1xyXG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiBleHByZXNzaW9uID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIHJldHVybiBuZXcgRnVuY3Rpb24oJ2N0eCcsIGByZXR1cm4gJHtleHByZXNzaW9ufWApLmFwcGx5KHRoaXMuZnJhbWVDb250ZXh0LCBbdGhpc10pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOihqOi+vuW8j3Jlc3VsdFxyXG4gICAgICAgIHJldHVybiBleHByZXNzaW9uO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBWaWV3TW9kZWwgfTtcclxuIl19