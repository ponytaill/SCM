/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { FilterRelation, Compare } from '@farris/ui-common/types';
import { cloneDeep } from 'lodash-es';
var LookupUtils = /** @class */ (function () {
    function LookupUtils(utils, rts, ngZone) {
        this.utils = utils;
        this.rts = rts;
        this.ngZone = ngZone;
    }
    /**
     * @param {?} lookupIns
     * @return {?}
     */
    LookupUtils.prototype.setActiveLookupInstance = /**
     * @param {?} lookupIns
     * @return {?}
     */
    function (lookupIns) {
        if (this.rts) {
            this.rts.setLookupInstance(lookupIns);
        }
    };
    /**
     * @return {?}
     */
    LookupUtils.prototype.destroy = /**
     * @return {?}
     */
    function () {
        this.rts.destroy();
    };
    /**
     * @return {?}
     */
    LookupUtils.prototype.pendingStart = /**
     * @return {?}
     */
    function () {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: true
                }
            });
            // 禁用页面的所有鼠标事件
            document.body.style['pointer-events'] = 'none';
        }
    };
    /**
     * @return {?}
     */
    LookupUtils.prototype.pendingEnd = /**
     * @return {?}
     */
    function () {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: false
                }
            });
            // 激活鼠标事件
            document.body.style['pointer-events'] = '';
        }
    };
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    LookupUtils.prototype.createFilterCondition = /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    function (field, value) {
        return {
            filterField: field,
            value: value,
            lbracket: '',
            rbracket: '',
            relation: FilterRelation.Or,
            compare: Compare.Like
        };
    };
    /**
     * @param {?} condition
     * @param {?} fields
     * @param {?} searchData
     * @return {?}
     */
    LookupUtils.prototype.mergeCondition = /**
     * @param {?} condition
     * @param {?} fields
     * @param {?} searchData
     * @return {?}
     */
    function (condition, fields, searchData) {
        var _this = this;
        if (!condition) {
            condition = {
                pagination: {
                    pageIndex: 1,
                    pageSize: 20
                },
                filterConditions: [],
                sortConditions: []
            };
        }
        else {
            condition = cloneDeep(condition);
        }
        var _a = tslib_1.__assign({}, searchData), _b = _a.field, field = _b === void 0 ? '*' : _b, _c = _a.value, value = _c === void 0 ? '' : _c;
        if (value) {
            if (field === '*') {
                if (fields && fields.length) {
                    /** @type {?} */
                    var searchConditions = fields.map((/**
                     * @param {?} f
                     * @return {?}
                     */
                    function (f) {
                        return _this.createFilterCondition(f, value);
                    }));
                    if (searchConditions.length) {
                        searchConditions[0].lbracket = '(';
                        /** @type {?} */
                        var lastSearchConditions = searchConditions[searchConditions.length - 1];
                        lastSearchConditions.rbracket = ')';
                        lastSearchConditions.relation = FilterRelation.Empty;
                    }
                    if (condition.filterConditions && condition.filterConditions.length) {
                        condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                        condition.filterConditions = condition.filterConditions.concat(searchConditions);
                    }
                    else {
                        condition.filterConditions = searchConditions;
                    }
                }
            }
            else {
                /** @type {?} */
                var searchCondition = this.createFilterCondition(field, value);
                searchCondition.relation = FilterRelation.Empty;
                if (condition.filterConditions && condition.filterConditions.length) {
                    condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                    condition.filterConditions.push(searchCondition);
                }
                else {
                    condition.filterConditions = [searchCondition];
                }
            }
        }
        return condition;
    };
    /**
     * @private
     * @param {?} n
     * @return {?}
     */
    LookupUtils.prototype.canSelectable = /**
     * @private
     * @param {?} n
     * @return {?}
     */
    function (n) {
        if (n.hasOwnProperty('farris_selectable')) {
            return !!n['farris_selectable'];
        }
        return true;
    };
    /** 将数据转树形结构 */
    /**
     * 将数据转树形结构
     * @param {?} data
     * @param {?} parentId
     * @param {?=} parentIdField
     * @param {?=} idField
     * @return {?}
     */
    LookupUtils.prototype.makeTreeWithParentID = /**
     * 将数据转树形结构
     * @param {?} data
     * @param {?} parentId
     * @param {?=} parentIdField
     * @param {?=} idField
     * @return {?}
     */
    function (data, parentId, parentIdField, idField) {
        var _this = this;
        if (parentIdField === void 0) { parentIdField = 'parentId'; }
        if (idField === void 0) { idField = 'id'; }
        /** @type {?} */
        var nodes = new Map();
        /** @type {?} */
        var result = [];
        /** @type {?} */
        var unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        function (t) {
            /** @type {?} */
            var node = {
                data: t,
                children: [],
                selectable: _this.canSelectable(t),
                parent: null,
                parents: []
            };
            /** @type {?} */
            var id = t[idField];
            nodes.set(id, node);
            /** @type {?} */
            var PID = _this.utils.getValue(parentIdField, t);
            if (PID === parentId) {
                result.push(node);
            }
            else {
                /** @type {?} */
                var parent_1 = nodes.get(PID);
                if (parent_1) {
                    node.parent = PID;
                    node.parents = tslib_1.__spread(parent_1.parents, [PID]);
                    parent_1.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            /** @type {?} */
            var pid = _this.utils.getValue(parentIdField, n.data);
            /** @type {?} */
            var parent = nodes.get(pid);
            if (parent) {
                n.parent = pid;
                n.parents = tslib_1.__spread(parent.parents, [pid]);
                parent.children.push(n);
            }
        }));
        return result;
    };
    /**
     * @param {?} data
     * @param {?} treeInfo
     * @return {?}
     */
    LookupUtils.prototype.makeTree = /**
     * @param {?} data
     * @param {?} treeInfo
     * @return {?}
     */
    function (data, treeInfo) {
        var _this = this;
        /** @type {?} */
        var treeInfoField = treeInfo.dataField;
        /** @type {?} */
        var layerField = treeInfo.layerField;
        /** @type {?} */
        var pathField = treeInfo.pathField;
        /** @type {?} */
        var nodes = new Map();
        /** @type {?} */
        var result = [];
        /** @type {?} */
        var unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        function (t) {
            /** @type {?} */
            var node = {
                data: t,
                children: [],
                selectable: _this.canSelectable(t)
            };
            /** @type {?} */
            var pathCode = t[treeInfoField][pathField];
            nodes.set(pathCode, node);
            if (t[treeInfoField][layerField] === 1) {
                result.push(node);
            }
            else {
                /** @type {?} */
                var parentPathCode = pathCode.substr(0, pathCode.length - 4);
                /** @type {?} */
                var parent_2 = nodes.get(parentPathCode);
                if (parent_2) {
                    parent_2.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        function (n) {
            /** @type {?} */
            var pathCode = n.data[treeInfoField][pathField];
            /** @type {?} */
            var parent = nodes.get(pathCode.substr(0, pathCode.length - 4));
            if (parent) {
                parent.children.push(n);
            }
        }));
        return result;
    };
    LookupUtils.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    LookupUtils.ctorParameters = function () { return [
        { type: CommonUtils },
        { type: RuntimeStateService },
        { type: NgZone }
    ]; };
    return LookupUtils;
}());
export { LookupUtils };
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.utils;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.rts;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxXQUFXLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsY0FBYyxFQUFtQixPQUFPLEVBQWdCLE1BQU0seUJBQXlCLENBQUM7QUFDakcsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUd0QztJQUdJLHFCQUFvQixLQUFrQixFQUFVLEdBQXdCLEVBQVUsTUFBYztRQUE1RSxVQUFLLEdBQUwsS0FBSyxDQUFhO1FBQVUsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFRO0lBQUksQ0FBQzs7Ozs7SUFFckcsNkNBQXVCOzs7O0lBQXZCLFVBQXdCLFNBQWM7UUFDbEMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6QztJQUNMLENBQUM7Ozs7SUFHRCw2QkFBTzs7O0lBQVA7UUFDSSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3ZCLENBQUM7Ozs7SUFFRCxrQ0FBWTs7O0lBQVo7UUFDSSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztnQkFDckIsTUFBTSxFQUFFO29CQUNKLE9BQU8sRUFBRSxJQUFJO2lCQUNoQjthQUNKLENBQUMsQ0FBQztZQUVILGNBQWM7WUFDZCxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLE1BQU0sQ0FBQztTQUNsRDtJQUNMLENBQUM7Ozs7SUFFRCxnQ0FBVTs7O0lBQVY7UUFDSSxJQUFJLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQztnQkFDckIsTUFBTSxFQUFFO29CQUNKLE9BQU8sRUFBRSxLQUFLO2lCQUNqQjthQUNKLENBQUMsQ0FBQztZQUVILFNBQVM7WUFDVCxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUM5QztJQUNMLENBQUM7Ozs7Ozs7SUFHTywyQ0FBcUI7Ozs7OztJQUE3QixVQUE4QixLQUFhLEVBQUUsS0FBYTtRQUN0RCxPQUFPO1lBQ0gsV0FBVyxFQUFFLEtBQUs7WUFDbEIsS0FBSyxPQUFBO1lBQ0wsUUFBUSxFQUFFLEVBQUU7WUFDWixRQUFRLEVBQUUsRUFBRTtZQUNaLFFBQVEsRUFBRSxjQUFjLENBQUMsRUFBRTtZQUMzQixPQUFPLEVBQUUsT0FBTyxDQUFDLElBQUk7U0FDeEIsQ0FBQztJQUNOLENBQUM7Ozs7Ozs7SUFFRCxvQ0FBYzs7Ozs7O0lBQWQsVUFBZSxTQUF1QixFQUFFLE1BQWdCLEVBQUUsVUFBNEM7UUFBdEcsaUJBa0RDO1FBakRHLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDWixTQUFTLEdBQUc7Z0JBQ1IsVUFBVSxFQUFFO29CQUNSLFNBQVMsRUFBRSxDQUFDO29CQUNaLFFBQVEsRUFBRSxFQUFFO2lCQUNmO2dCQUNELGdCQUFnQixFQUFFLEVBQUU7Z0JBQ3BCLGNBQWMsRUFBRSxFQUFFO2FBQ3JCLENBQUM7U0FDTDthQUFNO1lBQ0gsU0FBUyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNwQztRQUVLLElBQUEscUNBQStDLEVBQTdDLGFBQVcsRUFBWCxnQ0FBVyxFQUFFLGFBQVUsRUFBViwrQkFBZ0M7UUFFckQsSUFBSSxLQUFLLEVBQUU7WUFDUCxJQUFJLEtBQUssS0FBSyxHQUFHLEVBQUU7Z0JBQ2YsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLE1BQU0sRUFBRTs7d0JBQ25CLGdCQUFnQixHQUFzQixNQUFNLENBQUMsR0FBRzs7OztvQkFBQyxVQUFDLENBQVM7d0JBQzdELE9BQU8sS0FBSSxDQUFDLHFCQUFxQixDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFDaEQsQ0FBQyxFQUFDO29CQUVGLElBQUksZ0JBQWdCLENBQUMsTUFBTSxFQUFFO3dCQUN6QixnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDOzs0QkFDN0Isb0JBQW9CLEdBQUcsZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQzt3QkFDMUUsb0JBQW9CLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQzt3QkFDcEMsb0JBQW9CLENBQUMsUUFBUSxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUM7cUJBQ3hEO29CQUVELElBQUksU0FBUyxDQUFDLGdCQUFnQixJQUFJLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUU7d0JBQ2pFLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDO3dCQUNoRyxTQUFTLENBQUMsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO3FCQUNwRjt5QkFBTTt3QkFDSCxTQUFTLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7cUJBQ2pEO2lCQUNKO2FBQ0o7aUJBQU07O29CQUNHLGVBQWUsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQztnQkFDaEUsZUFBZSxDQUFDLFFBQVEsR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDO2dCQUNoRCxJQUFJLFNBQVMsQ0FBQyxnQkFBZ0IsSUFBSSxTQUFTLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFO29CQUNqRSxTQUFTLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsY0FBYyxDQUFDLEdBQUcsQ0FBQztvQkFDaEcsU0FBUyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztpQkFDcEQ7cUJBQU07b0JBQ0gsU0FBUyxDQUFDLGdCQUFnQixHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7aUJBQ2xEO2FBQ0o7U0FDSjtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7Ozs7OztJQUVPLG1DQUFhOzs7OztJQUFyQixVQUFzQixDQUFNO1FBQ3hCLElBQUksQ0FBQyxDQUFDLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1lBQ3ZDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1NBQ25DO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELGVBQWU7Ozs7Ozs7OztJQUNmLDBDQUFvQjs7Ozs7Ozs7SUFBcEIsVUFBcUIsSUFBVyxFQUFFLFFBQVEsRUFBRSxhQUEwQixFQUFFLE9BQWM7UUFBdEYsaUJBd0NDO1FBeEMyQyw4QkFBQSxFQUFBLDBCQUEwQjtRQUFFLHdCQUFBLEVBQUEsY0FBYzs7WUFDNUUsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFlOztZQUM5QixNQUFNLEdBQUcsRUFBRTs7WUFDWCxVQUFVLEdBQUcsRUFBRTtRQUNyQixJQUFJLENBQUMsT0FBTzs7OztRQUFDLFVBQUEsQ0FBQzs7Z0JBQ0osSUFBSSxHQUFHO2dCQUNULElBQUksRUFBRSxDQUFDO2dCQUNQLFFBQVEsRUFBRSxFQUFFO2dCQUNaLFVBQVUsRUFBRSxLQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztnQkFDakMsTUFBTSxFQUFFLElBQUk7Z0JBQ1osT0FBTyxFQUFFLEVBQUU7YUFDZDs7Z0JBQ0ssRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUM7WUFDckIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7O2dCQUNkLEdBQUcsR0FBRyxLQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO1lBQ2pELElBQUksR0FBRyxLQUFLLFFBQVEsRUFBRTtnQkFDbEIsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNyQjtpQkFBTTs7b0JBQ0csUUFBTSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUM3QixJQUFJLFFBQU0sRUFBRTtvQkFDUixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztvQkFDbEIsSUFBSSxDQUFDLE9BQU8sb0JBQU8sUUFBTSxDQUFDLE9BQU8sR0FBRSxHQUFHLEVBQUMsQ0FBQztvQkFDeEMsUUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQzlCO3FCQUFNO29CQUNILFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ3pCO2FBQ0o7UUFDTCxDQUFDLEVBQUMsQ0FBQztRQUVILFVBQVUsQ0FBQyxPQUFPOzs7O1FBQUMsVUFBQSxDQUFDOztnQkFDVixHQUFHLEdBQUcsS0FBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUM7O2dCQUNoRCxNQUFNLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFDN0IsSUFBSSxNQUFNLEVBQUU7Z0JBQ1IsQ0FBQyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUM7Z0JBQ2YsQ0FBQyxDQUFDLE9BQU8sb0JBQU8sTUFBTSxDQUFDLE9BQU8sR0FBRSxHQUFHLEVBQUMsQ0FBQztnQkFDckMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDM0I7UUFDTCxDQUFDLEVBQUMsQ0FBQztRQUVILE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Ozs7OztJQUVELDhCQUFROzs7OztJQUFSLFVBQVMsSUFBSSxFQUFFLFFBQWtCO1FBQWpDLGlCQXdDQzs7WUF2Q1MsYUFBYSxHQUFHLFFBQVEsQ0FBQyxTQUFTOztZQUNsQyxVQUFVLEdBQUcsUUFBUSxDQUFDLFVBQVU7O1lBQ2hDLFNBQVMsR0FBRyxRQUFRLENBQUMsU0FBUzs7WUFFOUIsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFlOztZQUM5QixNQUFNLEdBQUcsRUFBRTs7WUFDWCxVQUFVLEdBQUcsRUFBRTtRQUNyQixJQUFJLENBQUMsT0FBTzs7OztRQUFDLFVBQUEsQ0FBQzs7Z0JBQ0osSUFBSSxHQUFHO2dCQUNULElBQUksRUFBRSxDQUFDO2dCQUNQLFFBQVEsRUFBRSxFQUFFO2dCQUNaLFVBQVUsRUFBRSxLQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzthQUNwQzs7Z0JBQ0ssUUFBUSxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFDNUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFFMUIsSUFBSSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNwQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3JCO2lCQUFNOztvQkFDRyxjQUFjLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7O29CQUN4RCxRQUFNLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUM7Z0JBQ3hDLElBQUksUUFBTSxFQUFFO29CQUNSLFFBQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUM5QjtxQkFBTTtvQkFDSCxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUN6QjthQUNKO1FBQ0wsQ0FBQyxFQUFDLENBQUM7UUFHSCxVQUFVLENBQUMsT0FBTzs7OztRQUFDLFVBQUEsQ0FBQzs7Z0JBQ1YsUUFBUSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsU0FBUyxDQUFDOztnQkFDM0MsTUFBTSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNqRSxJQUFJLE1BQU0sRUFBRTtnQkFDUixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMzQjtRQUNMLENBQUMsRUFBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQzs7Z0JBcE1KLFVBQVU7Ozs7Z0JBTEYsV0FBVztnQkFBRSxtQkFBbUI7Z0JBRHBCLE1BQU07O0lBMk0zQixrQkFBQztDQUFBLEFBck1ELElBcU1DO1NBcE1ZLFdBQVc7Ozs7OztJQUVSLDRCQUEwQjs7Ozs7SUFBRSwwQkFBZ0M7Ozs7O0lBQUUsNkJBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IENvbW1vblV0aWxzLCBSdW50aW1lU3RhdGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBGaWx0ZXJSZWxhdGlvbiwgRmlsdGVyQ29uZGl0aW9uLCBDb21wYXJlLCBFbnRpdHlGaWx0ZXIgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi90eXBlcyc7XHJcbmltcG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IFRyZWVJbmZvIH0gZnJvbSAnLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIExvb2t1cFV0aWxzIHtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHV0aWxzOiBDb21tb25VdGlscywgcHJpdmF0ZSBydHM6IFJ1bnRpbWVTdGF0ZVNlcnZpY2UsIHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHsgfVxyXG5cclxuICAgIHNldEFjdGl2ZUxvb2t1cEluc3RhbmNlKGxvb2t1cEluczogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMucnRzKSB7XHJcbiAgICAgICAgICAgIHRoaXMucnRzLnNldExvb2t1cEluc3RhbmNlKGxvb2t1cElucyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBkZXN0cm95KCkge1xyXG4gICAgICAgIHRoaXMucnRzLmRlc3Ryb3koKTtcclxuICAgIH1cclxuXHJcbiAgICBwZW5kaW5nU3RhcnQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucnRzKSB7XHJcbiAgICAgICAgICAgIHRoaXMucnRzLnVwZGF0ZUZvcm1TdGF0ZSh7XHJcbiAgICAgICAgICAgICAgICBsb29rdXA6IHtcclxuICAgICAgICAgICAgICAgICAgICBwZW5kaW5nOiB0cnVlXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgLy8g56aB55So6aG16Z2i55qE5omA5pyJ6byg5qCH5LqL5Lu2XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuc3R5bGVbJ3BvaW50ZXItZXZlbnRzJ10gPSAnbm9uZSc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHBlbmRpbmdFbmQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucnRzKSB7XHJcbiAgICAgICAgICAgIHRoaXMucnRzLnVwZGF0ZUZvcm1TdGF0ZSh7XHJcbiAgICAgICAgICAgICAgICBsb29rdXA6IHtcclxuICAgICAgICAgICAgICAgICAgICBwZW5kaW5nOiBmYWxzZVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIOa/gOa0u+m8oOagh+S6i+S7tlxyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlWydwb2ludGVyLWV2ZW50cyddID0gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZUZpbHRlckNvbmRpdGlvbihmaWVsZDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgZmlsdGVyRmllbGQ6IGZpZWxkLFxyXG4gICAgICAgICAgICB2YWx1ZSxcclxuICAgICAgICAgICAgbGJyYWNrZXQ6ICcnLFxyXG4gICAgICAgICAgICByYnJhY2tldDogJycsXHJcbiAgICAgICAgICAgIHJlbGF0aW9uOiBGaWx0ZXJSZWxhdGlvbi5PcixcclxuICAgICAgICAgICAgY29tcGFyZTogQ29tcGFyZS5MaWtlXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBtZXJnZUNvbmRpdGlvbihjb25kaXRpb246IEVudGl0eUZpbHRlciwgZmllbGRzOiBzdHJpbmdbXSwgc2VhcmNoRGF0YTogeyBmaWVsZDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nIH0pIHtcclxuICAgICAgICBpZiAoIWNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICBjb25kaXRpb24gPSB7XHJcbiAgICAgICAgICAgICAgICBwYWdpbmF0aW9uOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFnZUluZGV4OiAxLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiAyMFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGZpbHRlckNvbmRpdGlvbnM6IFtdLFxyXG4gICAgICAgICAgICAgICAgc29ydENvbmRpdGlvbnM6IFtdXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uZGl0aW9uID0gY2xvbmVEZWVwKGNvbmRpdGlvbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB7IGZpZWxkID0gJyonLCB2YWx1ZSA9ICcnIH0gPSB7IC4uLnNlYXJjaERhdGEgfTtcclxuXHJcbiAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZCA9PT0gJyonKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZmllbGRzICYmIGZpZWxkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzZWFyY2hDb25kaXRpb25zOiBGaWx0ZXJDb25kaXRpb25bXSA9IGZpZWxkcy5tYXAoKGY6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jcmVhdGVGaWx0ZXJDb25kaXRpb24oZiwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoc2VhcmNoQ29uZGl0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VhcmNoQ29uZGl0aW9uc1swXS5sYnJhY2tldCA9ICcoJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdFNlYXJjaENvbmRpdGlvbnMgPSBzZWFyY2hDb25kaXRpb25zW3NlYXJjaENvbmRpdGlvbnMubGVuZ3RoIC0gMV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RTZWFyY2hDb25kaXRpb25zLnJicmFja2V0ID0gJyknO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VhcmNoQ29uZGl0aW9ucy5yZWxhdGlvbiA9IEZpbHRlclJlbGF0aW9uLkVtcHR5O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zICYmIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9uc1tjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucy5sZW5ndGggLSAxXS5yZWxhdGlvbiA9IEZpbHRlclJlbGF0aW9uLkFuZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMgPSBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucy5jb25jYXQoc2VhcmNoQ29uZGl0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMgPSBzZWFyY2hDb25kaXRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaENvbmRpdGlvbiA9IHRoaXMuY3JlYXRlRmlsdGVyQ29uZGl0aW9uKGZpZWxkLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hDb25kaXRpb24ucmVsYXRpb24gPSBGaWx0ZXJSZWxhdGlvbi5FbXB0eTtcclxuICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucyAmJiBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9uc1tjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucy5sZW5ndGggLSAxXS5yZWxhdGlvbiA9IEZpbHRlclJlbGF0aW9uLkFuZDtcclxuICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucy5wdXNoKHNlYXJjaENvbmRpdGlvbik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zID0gW3NlYXJjaENvbmRpdGlvbl07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjb25kaXRpb247XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjYW5TZWxlY3RhYmxlKG46IGFueSkge1xyXG4gICAgICAgIGlmIChuLmhhc093blByb3BlcnR5KCdmYXJyaXNfc2VsZWN0YWJsZScpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhIW5bJ2ZhcnJpc19zZWxlY3RhYmxlJ107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDlsIbmlbDmja7ovazmoJHlvaLnu5PmnoQgKi9cclxuICAgIG1ha2VUcmVlV2l0aFBhcmVudElEKGRhdGE6IGFueVtdLCBwYXJlbnRJZCwgcGFyZW50SWRGaWVsZCA9ICdwYXJlbnRJZCcsIGlkRmllbGQgPSAnaWQnKSB7XHJcbiAgICAgICAgY29uc3Qgbm9kZXMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHVuYXR0YWNoZWQgPSBbXTtcclxuICAgICAgICBkYXRhLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiB0LFxyXG4gICAgICAgICAgICAgICAgY2hpbGRyZW46IFtdLFxyXG4gICAgICAgICAgICAgICAgc2VsZWN0YWJsZTogdGhpcy5jYW5TZWxlY3RhYmxlKHQpLFxyXG4gICAgICAgICAgICAgICAgcGFyZW50OiBudWxsLFxyXG4gICAgICAgICAgICAgICAgcGFyZW50czogW11cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY29uc3QgaWQgPSB0W2lkRmllbGRdO1xyXG4gICAgICAgICAgICBub2Rlcy5zZXQoaWQsIG5vZGUpO1xyXG4gICAgICAgICAgICBjb25zdCBQSUQgPSB0aGlzLnV0aWxzLmdldFZhbHVlKHBhcmVudElkRmllbGQsIHQpO1xyXG4gICAgICAgICAgICBpZiAoUElEID09PSBwYXJlbnRJZCkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2Rlcy5nZXQoUElEKTtcclxuICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudCA9IFBJRDtcclxuICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudHMgPSBbLi4ucGFyZW50LnBhcmVudHMsIFBJRF07XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHVuYXR0YWNoZWQucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB1bmF0dGFjaGVkLmZvckVhY2gobiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBpZCA9IHRoaXMudXRpbHMuZ2V0VmFsdWUocGFyZW50SWRGaWVsZCwgbi5kYXRhKTtcclxuICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZXMuZ2V0KHBpZCk7XHJcbiAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgIG4ucGFyZW50ID0gcGlkO1xyXG4gICAgICAgICAgICAgICAgbi5wYXJlbnRzID0gWy4uLnBhcmVudC5wYXJlbnRzLCBwaWRdO1xyXG4gICAgICAgICAgICAgICAgcGFyZW50LmNoaWxkcmVuLnB1c2gobik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBtYWtlVHJlZShkYXRhLCB0cmVlSW5mbzogVHJlZUluZm8pIHtcclxuICAgICAgICBjb25zdCB0cmVlSW5mb0ZpZWxkID0gdHJlZUluZm8uZGF0YUZpZWxkO1xyXG4gICAgICAgIGNvbnN0IGxheWVyRmllbGQgPSB0cmVlSW5mby5sYXllckZpZWxkO1xyXG4gICAgICAgIGNvbnN0IHBhdGhGaWVsZCA9IHRyZWVJbmZvLnBhdGhGaWVsZDtcclxuXHJcbiAgICAgICAgY29uc3Qgbm9kZXMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHVuYXR0YWNoZWQgPSBbXTtcclxuICAgICAgICBkYXRhLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vZGUgPSB7XHJcbiAgICAgICAgICAgICAgICBkYXRhOiB0LFxyXG4gICAgICAgICAgICAgICAgY2hpbGRyZW46IFtdLFxyXG4gICAgICAgICAgICAgICAgc2VsZWN0YWJsZTogdGhpcy5jYW5TZWxlY3RhYmxlKHQpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhDb2RlID0gdFt0cmVlSW5mb0ZpZWxkXVtwYXRoRmllbGRdO1xyXG4gICAgICAgICAgICBub2Rlcy5zZXQocGF0aENvZGUsIG5vZGUpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRbdHJlZUluZm9GaWVsZF1bbGF5ZXJGaWVsZF0gPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyZW50UGF0aENvZGUgPSBwYXRoQ29kZS5zdWJzdHIoMCwgcGF0aENvZGUubGVuZ3RoIC0gNCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2Rlcy5nZXQocGFyZW50UGF0aENvZGUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB1bmF0dGFjaGVkLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIHVuYXR0YWNoZWQuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgY29uc3QgcGF0aENvZGUgPSBuLmRhdGFbdHJlZUluZm9GaWVsZF1bcGF0aEZpZWxkXTtcclxuICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZXMuZ2V0KHBhdGhDb2RlLnN1YnN0cigwLCBwYXRoQ29kZS5sZW5ndGggLSA0KSk7XHJcbiAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKG4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbn1cclxuIl19