/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { FavoriteAction, FAVORITE_FIELD_NAME } from '../lookup-displaytype';
export class DataTableEventManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        this.lookupSelectionSer = this.ins.lookupSelectionSer;
    }
    /**
     * @param {?=} $event
     * @return {?}
     */
    onSearch($event = { field: '*', value: '' }) {
        if ($event && $event.field !== '*' && !$event.value) {
            this.ins.messagerService.warning(this.ins.mustWriteSomething);
            return;
        }
        /** @type {?} */
        const p = {
            pageInfo: { pageIndex: 1, pageSize: this.ins.gridOptions.pageSize },
            search: $event
        };
        if (this.ins.uri) {
            if (!this.ins.searching) {
                this.ins.searching = true;
                this.ins.httpMgr.getData(p, 'list').pipe(catchError((/**
                 * @param {?} err
                 * @return {?}
                 */
                err => {
                    this.ins.searching = false;
                    return of({ "_ERROR_": err });
                })), tap((/**
                 * @return {?}
                 */
                () => {
                    this.ins.searching = false;
                }))).subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                data => {
                    this.ins.searching = false;
                    this.ins.closeLoading();
                    if (!data['_ERROR_']) {
                        this._loadData(data);
                    }
                    else {
                        throw new Error(data['_ERROR_']);
                    }
                }));
            }
        }
        else {
            this.ins.search.emit(p);
        }
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    _loadData(data) {
        /** @type {?} */
        const self = this.ins;
        self.closeLoading();
        self.favHelper.updateFavoritesStatus(data.items);
        self.loadDataTableData(data);
        // 选中数据
        this.ins.selectionMgr.selectCurrentValue();
    }
    /**
     * @return {?}
     */
    bindDataTableEvent() {
        /** @type {?} */
        const self = this.ins;
        /** @type {?} */
        const dt = (/** @type {?} */ (self.componentRef.instance));
        dt.selectedRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.ins.singleSelect) {
                this.lookupSelectionSer.clearSelections();
            }
            this.ins.checkedChange.emit({ data: [e.data], isCheck: true });
            this.lookupSelectionSer.updateSelections([e.data]);
            dt.cd.detectChanges();
        }));
        dt.unSelectRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            this.lookupSelectionSer.unSelect(e.data[self.idField]);
            this.ins.checkedChange.emit({ data: [e.data], isCheck: false });
        }));
        dt.checkAll.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.lookupSelectionSer.updateSelections(dt.data, e);
            this.ins.checkedChange.emit({ data: dt.data, isCheck: e });
        }));
        dt.pageChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                (data) => {
                    this._loadData(data);
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.pageSizeChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                data => {
                    this._loadData(data);
                }), (/**
                 * @param {?} err
                 * @return {?}
                 */
                err => {
                    self.closeLoading();
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.search.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            self._searchState = e;
            this.onSearch(e);
        }));
        // 双击事件
        dt.rowDblClick.subscribe((/**
         * @param {?} rowData
         * @return {?}
         */
        (rowData) => {
            if (self.gridOptions.singleSelect) {
                // this.lookupSelectionSer.updateSelections([rowData]);
                self.selectItem(rowData);
            }
        }));
        // 收藏事件
        dt.cellClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (e.col.field === FAVORITE_FIELD_NAME) {
                e.event.stopPropagation();
                /** @type {?} */
                const classList = e.event.target['classList'];
                if (classList.contains('f-lookup-favorite')) {
                    self.items.forEach((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => {
                        /** @type {?} */
                        const id = self.utils.getValue(self.idField, item);
                        if (id === self.utils.getValue(self.idField, e.row)) {
                            item[FAVORITE_FIELD_NAME] = !item[FAVORITE_FIELD_NAME];
                        }
                    }));
                    dt.loadData({
                        pageSize: self.gridOptions.pageSize,
                        pageIndex: self.gridOptions.pageIndex,
                        total: self.gridOptions.total,
                        data: self.gridOptions.items
                    });
                    // 更新收藏数据
                    /** @type {?} */
                    const faction = e.row[FAVORITE_FIELD_NAME] ? FavoriteAction.add : FavoriteAction.delete;
                    if (faction === FavoriteAction.add) {
                        this.ins.favoriteItems = [...this.ins.favoriteItems, e.row];
                    }
                    else {
                        this.ins.favoriteItems = this.ins.favoriteItems.filter((/**
                         * @param {?} n
                         * @return {?}
                         */
                        n => {
                            return self.utils.getValue(self.idField, n) !== self.utils.getValue(self.idField, e.row);
                        }));
                    }
                    this.lookupSelectionSer.updateFavoriteData(e.row, faction);
                }
            }
        }));
        dt.columnSorted.subscribe((/**
         * @param {?} sort
         * @return {?}
         */
        (sort) => {
            if (!this.ins.remoteSort) {
                return;
            }
            const { sortName, sortOrder } = Object.assign({}, sort);
            /** @type {?} */
            const col = this.ins.columns.find((/**
             * @param {?} n
             * @return {?}
             */
            n => n.field === sortName));
            /** @type {?} */
            const _sortName = col ? col.fieldPath ? col.fieldPath : col.field : sortName;
            /** @type {?} */
            const param = {
                sortName: _sortName,
                sortOrder,
                search: self._searchState,
                pageInfo: {
                    pageSize: self.pageSize,
                    pageIndex: 1
                }
            };
            self.httpMgr.getData(param, 'search').subscribe((/**
             * @param {?} d
             * @return {?}
             */
            d => {
                self.loadDataTableData(d);
                self.closeLoading();
            }));
        }));
        dt.clearSearchValue.subscribe((/**
         * @return {?}
         */
        () => {
            self._searchState = null;
            this.onSearch();
        }));
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.lookupSelectionSer;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZC1kYXRhdGFibGUtZXZlbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9iaW5kLWRhdGF0YWJsZS1ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUUsVUFBVSxFQUFRLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxjQUFjLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUs1RSxNQUFNLE9BQU8scUJBQXFCOzs7O0lBSTlCLFlBQW9CLEdBQXdCO1FBQXhCLFFBQUcsR0FBSCxHQUFHLENBQXFCO1FBQ3hDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO0lBQzFELENBQUM7Ozs7O0lBRUQsUUFBUSxDQUFDLFNBQTJDLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFO1FBQ3pFLElBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRTtZQUNqRCxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQzlELE9BQU87U0FDVjs7Y0FFSyxDQUFDLEdBQUc7WUFDTixRQUFRLEVBQUUsRUFBRSxTQUFTLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUU7WUFDbkUsTUFBTSxFQUFFLE1BQU07U0FDakI7UUFDRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFH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Q2hELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3hCLENBQUMsRUFBQyxDQUFDO1FBQ1AsQ0FBQyxFQUFDLENBQUM7UUFFSCxFQUFFLENBQUMsZ0JBQWdCLENBQUMsU0FBUzs7O1FBQUMsR0FBRyxFQUFFO1lBQy9CLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNwQixDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjs7Ozs7O0lBckxHLG1EQUFtRDs7Ozs7SUFFdkMsb0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhdGFibGUnO1xyXG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBjYXRjaEVycm9yLCB0YWtlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZhdm9yaXRlQWN0aW9uLCBGQVZPUklURV9GSUVMRF9OQU1FIH0gZnJvbSAnLi4vbG9va3VwLWRpc3BsYXl0eXBlJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZFJlc3VsdCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgTG9va3VwU2VsZWN0aW9uU2VydmljZSB9IGZyb20gJy4vbG9va3VwLXNlbGVjdGlvbi5zZXJ2aWNlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBEYXRhVGFibGVFdmVudE1hbmFnZXIge1xyXG5cclxuICAgIHByaXZhdGUgbG9va3VwU2VsZWN0aW9uU2VyOiBMb29rdXBTZWxlY3Rpb25TZXJ2aWNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIgPSB0aGlzLmlucy5sb29rdXBTZWxlY3Rpb25TZXI7XHJcbiAgICB9XHJcblxyXG4gICAgb25TZWFyY2goJGV2ZW50OiB7IGZpZWxkOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfSA9IHsgZmllbGQ6ICcqJywgdmFsdWU6ICcnIH0pIHtcclxuICAgICAgICBpZiAoJGV2ZW50ICYmICRldmVudC5maWVsZCAhPT0gJyonICYmICEkZXZlbnQudmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubWVzc2FnZXJTZXJ2aWNlLndhcm5pbmcodGhpcy5pbnMubXVzdFdyaXRlU29tZXRoaW5nKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcCA9IHtcclxuICAgICAgICAgICAgcGFnZUluZm86IHsgcGFnZUluZGV4OiAxLCBwYWdlU2l6ZTogdGhpcy5pbnMuZ3JpZE9wdGlvbnMucGFnZVNpemUgfSxcclxuICAgICAgICAgICAgc2VhcmNoOiAkZXZlbnRcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmICh0aGlzLmlucy51cmkpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmlucy5zZWFyY2hpbmcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5odHRwTWdyLmdldERhdGEocCwgJ2xpc3QnKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZih7IFwiX0VSUk9SX1wiOiBlcnIgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICkuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5zZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGF0YVsnX0VSUk9SXyddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihkYXRhWydfRVJST1JfJ10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaC5lbWl0KHApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9sb2FkRGF0YShkYXRhOiBMb29rdXBHcmlkUmVzdWx0KSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXMuaW5zO1xyXG4gICAgICAgIHNlbGYuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgc2VsZi5mYXZIZWxwZXIudXBkYXRlRmF2b3JpdGVzU3RhdHVzKGRhdGEuaXRlbXMpO1xyXG4gICAgICAgIHNlbGYubG9hZERhdGFUYWJsZURhdGEoZGF0YSk7XHJcbiAgICAgICAgLy8g6YCJ5Lit5pWw5o2uXHJcbiAgICAgICAgdGhpcy5pbnMuc2VsZWN0aW9uTWdyLnNlbGVjdEN1cnJlbnRWYWx1ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGJpbmREYXRhVGFibGVFdmVudCgpIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcy5pbnM7XHJcbiAgICAgICAgY29uc3QgZHQgPSBzZWxmLmNvbXBvbmVudFJlZi5pbnN0YW5jZSBhcyBEYXRhVGFibGVDb21wb25lbnQ7XHJcblxyXG4gICAgICAgIGR0LnNlbGVjdGVkUm93LnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLmNsZWFyU2VsZWN0aW9ucygpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNoZWNrZWRDaGFuZ2UuZW1pdCh7IGRhdGE6IFtlLmRhdGFdLCBpc0NoZWNrOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51cGRhdGVTZWxlY3Rpb25zKFtlLmRhdGFdKTtcclxuICAgICAgICAgICAgZHQuY2QuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC51blNlbGVjdFJvdy5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVuU2VsZWN0KGUuZGF0YVtzZWxmLmlkRmllbGRdKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY2hlY2tlZENoYW5nZS5lbWl0KHsgZGF0YTogW2UuZGF0YV0sIGlzQ2hlY2s6IGZhbHNlIH0pO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5jaGVja0FsbC5zdWJzY3JpYmUoKGU6IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhkdC5kYXRhLCBlKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY2hlY2tlZENoYW5nZS5lbWl0KHsgZGF0YTogZHQuZGF0YSwgaXNDaGVjazogZSB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQucGFnZUNoYW5nZWQuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHNlbGYudXJpKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmh0dHBNZ3IuZ2V0RGF0YShlLCAnbGlzdCcpLnN1YnNjcmliZSgoZGF0YTogTG9va3VwR3JpZFJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvYWREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLnBhZ2VyQ2hhbmdlZC5lbWl0KHNlbGYuaHR0cE1nci5idWlsZFF1ZXJ5UGFyYW1zKGUsICdsaXN0JykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LnBhZ2VTaXplQ2hhbmdlZC5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLnVyaSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEoZSwgJ2xpc3QnKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2xvYWREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5wYWdlckNoYW5nZWQuZW1pdChzZWxmLmh0dHBNZ3IuYnVpbGRRdWVyeVBhcmFtcyhlLCAnbGlzdCcpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5zZWFyY2guc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgc2VsZi5fc2VhcmNoU3RhdGUgPSBlO1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKGUpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIC8vIOWPjOWHu+S6i+S7tlxyXG4gICAgICAgIGR0LnJvd0RibENsaWNrLnN1YnNjcmliZSgocm93RGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLmdyaWRPcHRpb25zLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgLy8gdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhbcm93RGF0YV0pO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5zZWxlY3RJdGVtKHJvd0RhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOaUtuiXj+S6i+S7tlxyXG4gICAgICAgIGR0LmNlbGxDbGljay5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZS5jb2wuZmllbGQgPT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpIHtcclxuICAgICAgICAgICAgICAgIGUuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjbGFzc0xpc3QgPSBlLmV2ZW50LnRhcmdldFsnY2xhc3NMaXN0J107XHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdmLWxvb2t1cC1mYXZvcml0ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5pdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpZCA9IHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBpdGVtKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGlkID09PSBzZWxmLnV0aWxzLmdldFZhbHVlKHNlbGYuaWRGaWVsZCwgZS5yb3cpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtW0ZBVk9SSVRFX0ZJRUxEX05BTUVdID0gIWl0ZW1bRkFWT1JJVEVfRklFTERfTkFNRV07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICBkdC5sb2FkRGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiBzZWxmLmdyaWRPcHRpb25zLnBhZ2VTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwYWdlSW5kZXg6IHNlbGYuZ3JpZE9wdGlvbnMucGFnZUluZGV4LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0b3RhbDogc2VsZi5ncmlkT3B0aW9ucy50b3RhbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogc2VsZi5ncmlkT3B0aW9ucy5pdGVtc1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyDmm7TmlrDmlLbol4/mlbDmja5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmYWN0aW9uID0gZS5yb3dbRkFWT1JJVEVfRklFTERfTkFNRV0gPyBGYXZvcml0ZUFjdGlvbi5hZGQgOiBGYXZvcml0ZUFjdGlvbi5kZWxldGU7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmYWN0aW9uID09PSAgRmF2b3JpdGVBY3Rpb24uYWRkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlSXRlbXMgPSBbLi4udGhpcy5pbnMuZmF2b3JpdGVJdGVtcywgZS5yb3ddO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlSXRlbXMgPSB0aGlzLmlucy5mYXZvcml0ZUl0ZW1zLmZpbHRlcihuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnV0aWxzLmdldFZhbHVlKHNlbGYuaWRGaWVsZCwgbikgIT09IHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBlLnJvdyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlRmF2b3JpdGVEYXRhKGUucm93LCBmYWN0aW9uKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5jb2x1bW5Tb3J0ZWQuc3Vic2NyaWJlKChzb3J0OiB7IHNvcnROYW1lOiBzdHJpbmc7IHNvcnRPcmRlcjogYW55IH0pID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pbnMucmVtb3RlU29ydCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB7IHNvcnROYW1lLCBzb3J0T3JkZXIgfSA9IHsgLi4uc29ydCB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29sID0gdGhpcy5pbnMuY29sdW1ucy5maW5kKG4gPT4gbi5maWVsZCA9PT0gc29ydE5hbWUpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgX3NvcnROYW1lID0gY29sID8gY29sLmZpZWxkUGF0aCA/IGNvbC5maWVsZFBhdGggOiBjb2wuZmllbGQgOiBzb3J0TmFtZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmFtID0ge1xyXG4gICAgICAgICAgICAgICAgc29ydE5hbWU6IF9zb3J0TmFtZSxcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcixcclxuICAgICAgICAgICAgICAgIHNlYXJjaDogc2VsZi5fc2VhcmNoU3RhdGUsXHJcbiAgICAgICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiBzZWxmLnBhZ2VTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogMVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEocGFyYW0sICdzZWFyY2gnKS5zdWJzY3JpYmUoZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmxvYWREYXRhVGFibGVEYXRhKGQpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LmNsZWFyU2VhcmNoVmFsdWUuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgc2VsZi5fc2VhcmNoU3RhdGUgPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==