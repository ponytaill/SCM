import { Injectable } from '@angular/core';
import { of, from, EMPTY } from 'rxjs';
import { every, concatMap, switchMap, take, tap } from 'rxjs/operators';
import { RuntimeFrameworkService } from './rtf-service';
import { MenuStateService } from './menu-state.service';
import { TAB_EVENT } from './types';
import { QuerystringService } from './querystring';
import { UID } from '@farris/devkit';
/**
 * 导航事件服务
 * @scope FormModule
 */
export class NavigationEventService {
    constructor(runtimeFrameworkService, menuStateService, querystringService) {
        this.runtimeFrameworkService = runtimeFrameworkService;
        this.menuStateService = menuStateService;
        this.querystringService = querystringService;
        this.onClosedListeners = new Map();
        this.onClosingListeners = new Map();
        this.onTabSwitchListeners = new Map();
    }
    get querystrings() {
        const params = this.querystringService.parse(window.location.hash);
        // 修正formToken
        if (params) {
            params.formToken = this.runtimeFrameworkService.formToken;
        }
        return params;
    }
    /**
     * 注册事件
     */
    registerEvent() {
        const options = this.querystrings;
        this.params = options;
        // 注册标签页切换事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabSwitched, (e) => this.handleTabSwitchEvent(e), options);
        // 注册标签页关闭后事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosed, (e) => this.handleTabClosedEvent(e), options);
        // 注册标签页关闭前事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosing, (e) => this.handleTabClosingEvent(e), options);
    }
    /**
     * 处理标签页切换事件
     */
    handleTabSwitchEvent(e) {
        if (!e) {
            return;
        }
        // 选中的表单为系统表单，只能返回id，没有tabId
        const eventTabId = e.tabId || e.id || null;
        if (!eventTabId) {
            return;
        }
        const options = this.params; // this.querystrings;
        const tabId = options.tabId || options.funcId || options.appId;
        const menuState = this.menuStateService.getMenuState(eventTabId);
        if (!!tabId && tabId === eventTabId && !!menuState && menuState.length > 0) {
            this.formReload();
        }
        this.fireTabSwitchEvent(e);
    }
    /**
     * 触发tab切换事件
     * @param e e
     */
    fireTabSwitchEvent(e) {
        if (!this.onTabSwitchListeners || this.onTabSwitchListeners.size < 1) {
            return;
        }
        this.onTabSwitchListeners.forEach((handle, key, map) => {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    }
    /**
     * 标签页关闭前事件
     */
    handleTabClosingEvent(e) {
        if (!e) {
            return;
        }
        // 要关闭的表单为系统表单，只能返回id，没有tabId
        const eventTabId = e.tabId || e.id || null;
        const options = this.params; // this.querystrings;
        const tabId = options.tabId || options.funcId || options.appId;
        if (!!eventTabId && !!tabId && tabId === eventTabId) {
            this.fireTabClosingEvent(e).subscribe(result => {
                if (result) {
                    setTimeout(() => this.removeMenuState(eventTabId), 500);
                    const formEventServices = window['formEventServices'];
                    if (formEventServices.has(eventTabId)) {
                        formEventServices.delete(eventTabId);
                        window['formEventServices'] = formEventServices;
                    }
                    if (!(e && e.hasOwnProperty('token'))) {
                        e = Object.assign({}, e, { token: options.formToken });
                    }
                    if (this.frameContext && this.frameContext.appContext) {
                        this.frameContext.appContext.dispose();
                    }
                    this.runtimeFrameworkService.closeMenu(e);
                }
            });
        }
    }
    /**
     * 触发关闭前事件
     */
    fireTabClosingEvent(e) {
        if (!this.onClosingListeners || this.onClosingListeners.size < 1) {
            return of(true);
        }
        const listeners = this.onClosingListeners.values();
        const result$ = from(listeners);
        // 用户拒绝
        let userRejected = false;
        return result$.pipe(concatMap(handle => {
            if (userRejected) {
                return EMPTY;
            }
            return handle(e).pipe(take(1), tap(result => userRejected = !result), switchMap(result => of(result)));
        }), every(result => result));
    }
    /**
     * 标签页关闭后事件
     */
    handleTabClosedEvent(e) {
        if (!e) {
            return;
        }
        const options = this.params; // this.querystrings;
        const tabId = options.tabId || options.funcId || options.appId;
        const eventTabId = e.tabId || e.id || null;
        if (tabId === eventTabId) {
            return;
        }
        const menuState = this.menuStateService.getMenuState(tabId, eventTabId);
        if (!!eventTabId && !!menuState && menuState.length > 0) {
            this.removeMenuState(eventTabId);
            this.formReload();
        }
        this.fireTabClosedEvent(e);
    }
    removeMenuState(tabId) {
        if (this['context']) {
            this.menuStateService.removeMenu(tabId);
        }
    }
    /**
     * 触发关闭后事件
     * @param e event
     */
    fireTabClosedEvent(e) {
        if (!this.onClosedListeners || this.onClosedListeners.size < 1) {
            return;
        }
        this.onClosedListeners.forEach((handle, key, map) => {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    }
    // #endregion
    /**
     * 注册事件监听器
     * @param eventType 事件类型 onTabClosed
     * @param handler 处理器
     */
    addEventListener(eventType, handler) {
        const key = UID.create();
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabSwitched) {
            this.onTabSwitchListeners.set(key, handler);
            return key;
        }
        return null;
    }
    /**
     * 移除事件监听器
     * @param eventType 事件类型
     * @param key 事件标识
     */
    removeEventListener(eventType, key) {
        if (eventType === TAB_EVENT.onTabClosed) {
            return this.onClosedListeners.delete(key);
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            return this.onClosingListeners.delete(key);
        }
        return false;
    }
    /**
     * 清空事件监听器
     * @param eventType 事件类型
     */
    clearEventListener(eventType) {
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.clear();
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.clear();
        }
    }
    /**
     * 刷新组件数据
     */
    formReload() {
        try {
            // tslint:disable-next-line: no-string-literal
            this['context']['frameContext']['appContext']['refresh']();
        }
        catch (_a) { }
    }
}
NavigationEventService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NavigationEventService.ctorParameters = () => [
    { type: RuntimeFrameworkService },
    { type: MenuStateService },
    { type: QuerystringService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1ldmVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL25hdmlnYXRpb24tZXZlbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXhFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQWdCLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5EOzs7R0FHRztBQUVILE1BQU0sT0FBTyxzQkFBc0I7SUFhakMsWUFDVSx1QkFBZ0QsRUFDaEQsZ0JBQWtDLEVBQ2xDLGtCQUFzQztRQUZ0Qyw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBQ2hELHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUU5QyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQTBDLENBQUM7UUFDM0UsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksR0FBRyxFQUF5RCxDQUFDO1FBQzNGLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLEdBQUcsRUFBMEMsQ0FBQztJQUNoRixDQUFDO0lB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LENBQUMsV0FBVyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNoQzthQUFNLElBQUksU0FBUyxLQUFLLFNBQVMsQ0FBQyxZQUFZLEVBQUU7WUFDL0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUNEOztPQUVHO0lBQ0ssVUFBVTtRQUNoQixJQUFJO1lBQ0YsOENBQThDO1lBQzlDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1NBQzVEO1FBQUMsV0FBTSxHQUFHO0lBQ2IsQ0FBQzs7O1lBak9GLFVBQVU7Ozs7WUFWRix1QkFBdUI7WUFDdkIsZ0JBQWdCO1lBRWhCLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgZnJvbSwgRU1QVFkgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGV2ZXJ5LCBjb25jYXRNYXAsIHN3aXRjaE1hcCwgdGFrZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQXBwT3B0aW9ucyB9IGZyb20gJ0Bnc3Atc3lzL3J0Zi1jb21tb24nO1xuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL3J0Zi1zZXJ2aWNlJztcbmltcG9ydCB7IE1lbnVTdGF0ZVNlcnZpY2UgfSBmcm9tICcuL21lbnUtc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBUQUJfRVZFTlQgfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IFF1ZXJ5c3RyaW5nU2VydmljZSB9IGZyb20gJy4vcXVlcnlzdHJpbmcnO1xuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBVSUQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5cbi8qKlxuICog5a+86Iiq5LqL5Lu25pyN5YqhXG4gKiBAc2NvcGUgRm9ybU1vZHVsZVxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvbkV2ZW50U2VydmljZSB7XG4gIHB1YmxpYyBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcbiAgLyoqXG4gICAqIOWFs+mXreWQjuS6i+S7tuWkhOeQhuWZqFxuICAgKi9cbiAgcHJpdmF0ZSBvbkNsb3NlZExpc3RlbmVyczogTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiB2b2lkPjtcbiAgLyoqXG4gICAqIOWFs+mXreWJjeWkhOeQhuWZqFxuICAgKi9cbiAgcHJpdmF0ZSBvbkNsb3NpbmdMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gT2JzZXJ2YWJsZTxib29sZWFuPj47XG4gIHByaXZhdGUgb25UYWJTd2l0Y2hMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gdm9pZD47XG4gIHByaXZhdGUgcGFyYW1zOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBtZW51U3RhdGVTZXJ2aWNlOiBNZW51U3RhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgcXVlcnlzdHJpbmdTZXJ2aWNlOiBRdWVyeXN0cmluZ1NlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5vbkNsb3NlZExpc3RlbmVycyA9IG5ldyBNYXA8c3RyaW5nLCAob3B0aW9ucz86IEFwcE9wdGlvbnMpID0+IHZvaWQ+KCk7XG4gICAgdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiBPYnNlcnZhYmxlPGJvb2xlYW4+PigpO1xuICAgIHRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiB2b2lkPigpO1xuICB9XG4gIHByaXZhdGUgZ2V0IHF1ZXJ5c3RyaW5ncygpIHtcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLnF1ZXJ5c3RyaW5nU2VydmljZS5wYXJzZSh3aW5kb3cubG9jYXRpb24uaGFzaCk7XG4gICAgLy8g5L+u5q2jZm9ybVRva2VuXG4gICAgaWYgKHBhcmFtcykge1xuICAgICAgcGFyYW1zLmZvcm1Ub2tlbiA9IHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuZm9ybVRva2VuO1xuICAgIH1cbiAgICByZXR1cm4gcGFyYW1zO1xuICB9XG4gIC8qKlxuICAgKiDms6jlhozkuovku7ZcbiAgICovXG4gIHB1YmxpYyByZWdpc3RlckV2ZW50KCkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnF1ZXJ5c3RyaW5ncztcbiAgICB0aGlzLnBhcmFtcyA9IG9wdGlvbnM7XG4gICAgLy8g5rOo5YaM5qCH562+6aG15YiH5o2i5LqL5Lu2XG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5hZGRFdmVudExpc3RlbmVyKFRBQl9FVkVOVC5vblRhYlN3aXRjaGVkLCAoZSkgPT4gdGhpcy5oYW5kbGVUYWJTd2l0Y2hFdmVudChlKSwgb3B0aW9ucyk7XG4gICAgLy8g5rOo5YaM5qCH562+6aG15YWz6Zet5ZCO5LqL5Lu2XG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5hZGRFdmVudExpc3RlbmVyKFRBQl9FVkVOVC5vblRhYkNsb3NlZCwgKGUpID0+IHRoaXMuaGFuZGxlVGFiQ2xvc2VkRXZlbnQoZSksIG9wdGlvbnMpO1xuICAgIC8vIOazqOWGjOagh+etvumhteWFs+mXreWJjeS6i+S7tlxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihUQUJfRVZFTlQub25UYWJDbG9zaW5nLCAoZSkgPT4gdGhpcy5oYW5kbGVUYWJDbG9zaW5nRXZlbnQoZSksIG9wdGlvbnMpO1xuICB9XG4gIC8qKlxuICAgKiDlpITnkIbmoIfnrb7pobXliIfmjaLkuovku7ZcbiAgICovXG4gIHByaXZhdGUgaGFuZGxlVGFiU3dpdGNoRXZlbnQoZTogYW55KSB7XG4gICAgaWYgKCFlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIOmAieS4reeahOihqOWNleS4uuezu+e7n+ihqOWNle+8jOWPquiDvei/lOWbnmlk77yM5rKh5pyJdGFiSWRcbiAgICBjb25zdCBldmVudFRhYklkID0gZS50YWJJZCB8fCBlLmlkIHx8IG51bGw7XG4gICAgaWYgKCFldmVudFRhYklkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnBhcmFtczsgLy8gdGhpcy5xdWVyeXN0cmluZ3M7XG4gICAgY29uc3QgdGFiSWQgPSBvcHRpb25zLnRhYklkIHx8IG9wdGlvbnMuZnVuY0lkIHx8IG9wdGlvbnMuYXBwSWQ7XG4gICAgY29uc3QgbWVudVN0YXRlID0gdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmdldE1lbnVTdGF0ZShldmVudFRhYklkKTtcbiAgICBpZiAoISF0YWJJZCAmJiB0YWJJZCA9PT0gZXZlbnRUYWJJZCAmJiAhIW1lbnVTdGF0ZSAmJiBtZW51U3RhdGUubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5mb3JtUmVsb2FkKCk7XG4gICAgfVxuICAgIHRoaXMuZmlyZVRhYlN3aXRjaEV2ZW50KGUpO1xuICB9XG4gIC8qKlxuICAgKiDop6blj5F0YWLliIfmjaLkuovku7ZcbiAgICogQHBhcmFtIGUgZVxuICAgKi9cbiAgcHJpdmF0ZSBmaXJlVGFiU3dpdGNoRXZlbnQoZTogYW55KSB7XG4gICAgaWYgKCF0aGlzLm9uVGFiU3dpdGNoTGlzdGVuZXJzIHx8IHRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMuc2l6ZSA8IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5vblRhYlN3aXRjaExpc3RlbmVycy5mb3JFYWNoKChoYW5kbGUsIGtleSwgbWFwKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIGhhbmRsZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBoYW5kbGUoZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgLyoqXG4gICAqIOagh+etvumhteWFs+mXreWJjeS6i+S7tlxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVUYWJDbG9zaW5nRXZlbnQoZTogYW55KSB7XG4gICAgaWYgKCFlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIOimgeWFs+mXreeahOihqOWNleS4uuezu+e7n+ihqOWNle+8jOWPquiDvei/lOWbnmlk77yM5rKh5pyJdGFiSWRcbiAgICBjb25zdCBldmVudFRhYklkID0gZS50YWJJZCB8fCBlLmlkIHx8IG51bGw7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMucGFyYW1zOyAvLyB0aGlzLnF1ZXJ5c3RyaW5ncztcbiAgICBjb25zdCB0YWJJZCA9IG9wdGlvbnMudGFiSWQgfHwgb3B0aW9ucy5mdW5jSWQgfHwgb3B0aW9ucy5hcHBJZDtcbiAgICBpZiAoISFldmVudFRhYklkICYmICEhdGFiSWQgJiYgdGFiSWQgPT09IGV2ZW50VGFiSWQpIHtcbiAgICAgIHRoaXMuZmlyZVRhYkNsb3NpbmdFdmVudChlKS5zdWJzY3JpYmUocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZW1vdmVNZW51U3RhdGUoZXZlbnRUYWJJZCksIDUwMCk7XG4gICAgICAgICAgY29uc3QgZm9ybUV2ZW50U2VydmljZXM6IE1hcDxzdHJpbmcsIGFueT4gPSB3aW5kb3dbJ2Zvcm1FdmVudFNlcnZpY2VzJ107XG4gICAgICAgICAgaWYgKGZvcm1FdmVudFNlcnZpY2VzLmhhcyhldmVudFRhYklkKSkge1xuICAgICAgICAgICAgZm9ybUV2ZW50U2VydmljZXMuZGVsZXRlKGV2ZW50VGFiSWQpO1xuICAgICAgICAgICAgd2luZG93Wydmb3JtRXZlbnRTZXJ2aWNlcyddID0gZm9ybUV2ZW50U2VydmljZXM7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICghKGUgJiYgZS5oYXNPd25Qcm9wZXJ0eSgndG9rZW4nKSkpIHtcbiAgICAgICAgICAgIGUgPSBPYmplY3QuYXNzaWduKHt9LCBlLCB7IHRva2VuOiBvcHRpb25zLmZvcm1Ub2tlbiB9KTtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQpIHtcbiAgICAgICAgICAgIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZGlzcG9zZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmNsb3NlTWVudShlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDop6blj5HlhbPpl63liY3kuovku7ZcbiAgICovXG4gIHByaXZhdGUgZmlyZVRhYkNsb3NpbmdFdmVudChlOiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBpZiAoIXRoaXMub25DbG9zaW5nTGlzdGVuZXJzIHx8IHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLnNpemUgPCAxKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLnZhbHVlcygpO1xuICAgIGNvbnN0IHJlc3VsdCQgPSBmcm9tKGxpc3RlbmVycyk7XG4gICAgLy8g55So5oi35ouS57udXG4gICAgbGV0IHVzZXJSZWplY3RlZCA9IGZhbHNlO1xuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXG4gICAgICBjb25jYXRNYXAoaGFuZGxlID0+IHtcbiAgICAgICAgaWYgKHVzZXJSZWplY3RlZCkge1xuICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaGFuZGxlKGUpLnBpcGUoXG4gICAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgICB0YXAocmVzdWx0ID0+IHVzZXJSZWplY3RlZCA9ICFyZXN1bHQpLFxuICAgICAgICAgIHN3aXRjaE1hcChyZXN1bHQgPT4gb2YocmVzdWx0KSlcbiAgICAgICAgKTtcbiAgICAgIH0pLFxuICAgICAgZXZlcnkocmVzdWx0ID0+IHJlc3VsdClcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmoIfnrb7pobXlhbPpl63lkI7kuovku7ZcbiAgICovXG4gIHByaXZhdGUgaGFuZGxlVGFiQ2xvc2VkRXZlbnQoZTogYW55KSB7XG4gICAgaWYgKCFlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnBhcmFtczsgLy8gdGhpcy5xdWVyeXN0cmluZ3M7XG4gICAgY29uc3QgdGFiSWQgPSBvcHRpb25zLnRhYklkIHx8IG9wdGlvbnMuZnVuY0lkIHx8IG9wdGlvbnMuYXBwSWQ7XG4gICAgY29uc3QgZXZlbnRUYWJJZCA9IGUudGFiSWQgfHwgZS5pZCB8fCBudWxsO1xuICAgIGlmICh0YWJJZCA9PT0gZXZlbnRUYWJJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBtZW51U3RhdGUgPSB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UuZ2V0TWVudVN0YXRlKHRhYklkLCBldmVudFRhYklkKTtcbiAgICBpZiAoISFldmVudFRhYklkICYmICEhbWVudVN0YXRlICYmIG1lbnVTdGF0ZS5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnJlbW92ZU1lbnVTdGF0ZShldmVudFRhYklkKTtcbiAgICAgIHRoaXMuZm9ybVJlbG9hZCgpO1xuICAgIH1cbiAgICB0aGlzLmZpcmVUYWJDbG9zZWRFdmVudChlKTtcbiAgfVxuICBwcml2YXRlIHJlbW92ZU1lbnVTdGF0ZSh0YWJJZDogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXNbJ2NvbnRleHQnXSkge1xuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLnJlbW92ZU1lbnUodGFiSWQpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6Kem5Y+R5YWz6Zet5ZCO5LqL5Lu2XG4gICAqIEBwYXJhbSBlIGV2ZW50XG4gICAqL1xuICBwcml2YXRlIGZpcmVUYWJDbG9zZWRFdmVudChlOiBhbnkpIHtcbiAgICBpZiAoIXRoaXMub25DbG9zZWRMaXN0ZW5lcnMgfHwgdGhpcy5vbkNsb3NlZExpc3RlbmVycy5zaXplIDwgMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLmZvckVhY2goKGhhbmRsZSwga2V5LCBtYXApID0+IHtcbiAgICAgIGlmICh0eXBlb2YgaGFuZGxlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGhhbmRsZShlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICAvLyAjZW5kcmVnaW9uXG4gIC8qKlxuICAgKiDms6jlhozkuovku7bnm5HlkKzlmahcbiAgICogQHBhcmFtIGV2ZW50VHlwZSDkuovku7bnsbvlnosgb25UYWJDbG9zZWRcbiAgICogQHBhcmFtIGhhbmRsZXIg5aSE55CG5ZmoXG4gICAqL1xuICBwdWJsaWMgYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZywgaGFuZGxlcjogKG9wdGlvbnM6IEFwcE9wdGlvbnMpID0+IGFueSk6IHN0cmluZyB7XG4gICAgY29uc3Qga2V5ID0gVUlELmNyZWF0ZSgpO1xuICAgIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NlZCkge1xuICAgICAgdGhpcy5vbkNsb3NlZExpc3RlbmVycy5zZXQoa2V5LCBoYW5kbGVyKTtcbiAgICAgIHJldHVybiBrZXk7XG4gICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NpbmcpIHtcbiAgICAgIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLnNldChrZXksIGhhbmRsZXIpO1xuICAgICAgcmV0dXJuIGtleTtcbiAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiU3dpdGNoZWQpIHtcbiAgICAgIHRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMuc2V0KGtleSwgaGFuZGxlcik7XG4gICAgICByZXR1cm4ga2V5O1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICAvKipcbiAgICog56e76Zmk5LqL5Lu255uR5ZCs5ZmoXG4gICAqIEBwYXJhbSBldmVudFR5cGUg5LqL5Lu257G75Z6LXG4gICAqIEBwYXJhbSBrZXkg5LqL5Lu25qCH6K+GXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZywga2V5OiBzdHJpbmcpIHtcbiAgICBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zZWQpIHtcbiAgICAgIHJldHVybiB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLmRlbGV0ZShrZXkpO1xuICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zaW5nKSB7XG4gICAgICByZXR1cm4gdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMuZGVsZXRlKGtleSk7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICAvKipcbiAgICog5riF56m65LqL5Lu255uR5ZCs5ZmoXG4gICAqIEBwYXJhbSBldmVudFR5cGUg5LqL5Lu257G75Z6LXG4gICAqL1xuICBwdWJsaWMgY2xlYXJFdmVudExpc3RlbmVyKGV2ZW50VHlwZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiQ2xvc2VkKSB7XG4gICAgICB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLmNsZWFyKCk7XG4gICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NpbmcpIHtcbiAgICAgIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLmNsZWFyKCk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDliLfmlrDnu4Tku7bmlbDmja5cbiAgICovXG4gIHByaXZhdGUgZm9ybVJlbG9hZCgpIHtcbiAgICB0cnkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1zdHJpbmctbGl0ZXJhbFxuICAgICAgdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXVsnYXBwQ29udGV4dCddWydyZWZyZXNoJ10oKTtcbiAgICB9IGNhdGNoIHsgfVxuICB9XG59XG4iXX0=