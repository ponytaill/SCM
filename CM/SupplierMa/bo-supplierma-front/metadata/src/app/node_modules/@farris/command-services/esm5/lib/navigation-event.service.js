import { Injectable } from '@angular/core';
import { of, from, EMPTY } from 'rxjs';
import { every, concatMap, switchMap, take, tap } from 'rxjs/operators';
import { RuntimeFrameworkService } from './rtf-service';
import { MenuStateService } from './menu-state.service';
import { TAB_EVENT } from './types';
import { QuerystringService } from './querystring';
import { UID } from '@farris/devkit';
/**
 * 导航事件服务
 * @scope FormModule
 */
var NavigationEventService = /** @class */ (function () {
    function NavigationEventService(runtimeFrameworkService, menuStateService, querystringService) {
        this.runtimeFrameworkService = runtimeFrameworkService;
        this.menuStateService = menuStateService;
        this.querystringService = querystringService;
        this.onClosedListeners = new Map();
        this.onClosingListeners = new Map();
        this.onTabSwitchListeners = new Map();
    }
    Object.defineProperty(NavigationEventService.prototype, "querystrings", {
        get: function () {
            var params = this.querystringService.parse(window.location.hash);
            // 修正formToken
            if (params) {
                params.formToken = this.runtimeFrameworkService.formToken;
            }
            return params;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 注册事件
     */
    NavigationEventService.prototype.registerEvent = function () {
        var _this = this;
        var options = this.querystrings;
        this.params = options;
        // 注册标签页切换事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabSwitched, function (e) { return _this.handleTabSwitchEvent(e); }, options);
        // 注册标签页关闭后事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosed, function (e) { return _this.handleTabClosedEvent(e); }, options);
        // 注册标签页关闭前事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosing, function (e) { return _this.handleTabClosingEvent(e); }, options);
    };
    /**
     * 处理标签页切换事件
     */
    NavigationEventService.prototype.handleTabSwitchEvent = function (e) {
        if (!e) {
            return;
        }
        // 选中的表单为系统表单，只能返回id，没有tabId
        var eventTabId = e.tabId || e.id || null;
        if (!eventTabId) {
            return;
        }
        var options = this.params; // this.querystrings;
        var tabId = options.tabId || options.funcId || options.appId;
        var menuState = this.menuStateService.getMenuState(eventTabId);
        if (!!tabId && tabId === eventTabId && !!menuState && menuState.length > 0) {
            this.formReload();
        }
        this.fireTabSwitchEvent(e);
    };
    /**
     * 触发tab切换事件
     * @param e e
     */
    NavigationEventService.prototype.fireTabSwitchEvent = function (e) {
        if (!this.onTabSwitchListeners || this.onTabSwitchListeners.size < 1) {
            return;
        }
        this.onTabSwitchListeners.forEach(function (handle, key, map) {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    };
    /**
     * 标签页关闭前事件
     */
    NavigationEventService.prototype.handleTabClosingEvent = function (e) {
        var _this = this;
        if (!e) {
            return;
        }
        // 要关闭的表单为系统表单，只能返回id，没有tabId
        var eventTabId = e.tabId || e.id || null;
        var options = this.params; // this.querystrings;
        var tabId = options.tabId || options.funcId || options.appId;
        if (!!eventTabId && !!tabId && tabId === eventTabId) {
            this.fireTabClosingEvent(e).subscribe(function (result) {
                if (result) {
                    setTimeout(function () { return _this.removeMenuState(eventTabId); }, 500);
                    var formEventServices = window['formEventServices'];
                    if (formEventServices.has(eventTabId)) {
                        formEventServices.delete(eventTabId);
                        window['formEventServices'] = formEventServices;
                    }
                    if (!(e && e.hasOwnProperty('token'))) {
                        e = Object.assign({}, e, { token: options.formToken });
                    }
                    if (_this.frameContext && _this.frameContext.appContext) {
                        _this.frameContext.appContext.dispose();
                    }
                    _this.runtimeFrameworkService.closeMenu(e);
                }
            });
        }
    };
    /**
     * 触发关闭前事件
     */
    NavigationEventService.prototype.fireTabClosingEvent = function (e) {
        if (!this.onClosingListeners || this.onClosingListeners.size < 1) {
            return of(true);
        }
        var listeners = this.onClosingListeners.values();
        var result$ = from(listeners);
        // 用户拒绝
        var userRejected = false;
        return result$.pipe(concatMap(function (handle) {
            if (userRejected) {
                return EMPTY;
            }
            return handle(e).pipe(take(1), tap(function (result) { return userRejected = !result; }), switchMap(function (result) { return of(result); }));
        }), every(function (result) { return result; }));
    };
    /**
     * 标签页关闭后事件
     */
    NavigationEventService.prototype.handleTabClosedEvent = function (e) {
        if (!e) {
            return;
        }
        var options = this.params; // this.querystrings;
        var tabId = options.tabId || options.funcId || options.appId;
        var eventTabId = e.tabId || e.id || null;
        if (tabId === eventTabId) {
            return;
        }
        var menuState = this.menuStateService.getMenuState(tabId, eventTabId);
        if (!!eventTabId && !!menuState && menuState.length > 0) {
            this.removeMenuState(eventTabId);
            this.formReload();
        }
        this.fireTabClosedEvent(e);
    };
    NavigationEventService.prototype.removeMenuState = function (tabId) {
        if (this['context']) {
            this.menuStateService.removeMenu(tabId);
        }
    };
    /**
     * 触发关闭后事件
     * @param e event
     */
    NavigationEventService.prototype.fireTabClosedEvent = function (e) {
        if (!this.onClosedListeners || this.onClosedListeners.size < 1) {
            return;
        }
        this.onClosedListeners.forEach(function (handle, key, map) {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    };
    // #endregion
    /**
     * 注册事件监听器
     * @param eventType 事件类型 onTabClosed
     * @param handler 处理器
     */
    NavigationEventService.prototype.addEventListener = function (eventType, handler) {
        var key = UID.create();
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabSwitched) {
            this.onTabSwitchListeners.set(key, handler);
            return key;
        }
        return null;
    };
    /**
     * 移除事件监听器
     * @param eventType 事件类型
     * @param key 事件标识
     */
    NavigationEventService.prototype.removeEventListener = function (eventType, key) {
        if (eventType === TAB_EVENT.onTabClosed) {
            return this.onClosedListeners.delete(key);
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            return this.onClosingListeners.delete(key);
        }
        return false;
    };
    /**
     * 清空事件监听器
     * @param eventType 事件类型
     */
    NavigationEventService.prototype.clearEventListener = function (eventType) {
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.clear();
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.clear();
        }
    };
    /**
     * 刷新组件数据
     */
    NavigationEventService.prototype.formReload = function () {
        try {
            // tslint:disable-next-line: no-string-literal
            this['context']['frameContext']['appContext']['refresh']();
        }
        catch (_a) { }
    };
    NavigationEventService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NavigationEventService.ctorParameters = function () { return [
        { type: RuntimeFrameworkService },
        { type: MenuStateService },
        { type: QuerystringService }
    ]; };
    return NavigationEventService;
}());
export { NavigationEventService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1ldmVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL25hdmlnYXRpb24tZXZlbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXhFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQWdCLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5EOzs7R0FHRztBQUNIO0lBY0UsZ0NBQ1UsdUJBQWdELEVBQ2hELGdCQUFrQyxFQUNsQyxrQkFBc0M7UUFGdEMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFFOUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksR0FBRyxFQUEwQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsRUFBeUQsQ0FBQztRQUMzRixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxHQUFHLEVBQTBDLENBQUM7SUFDaEYsQ0FBQztJQUNELHNCQUFZLGdEQUFZO2FB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TUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzVDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ksbURBQWtCLEdBQXpCLFVBQTBCLFNBQWlCO1FBQ3pDLElBQUksU0FBUyxLQUFLLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDdkMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2hDO2FBQU0sSUFBSSxTQUFTLEtBQUssU0FBUyxDQUFDLFlBQVksRUFBRTtZQUMvQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDakM7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDSywyQ0FBVSxHQUFsQjtRQUNFLElBQUk7WUFDRiw4Q0FBOEM7WUFDOUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7U0FDNUQ7UUFBQyxXQUFNLEdBQUc7SUFDYixDQUFDOztnQkFqT0YsVUFBVTs7OztnQkFWRix1QkFBdUI7Z0JBQ3ZCLGdCQUFnQjtnQkFFaEIsa0JBQWtCOztJQXlPM0IsNkJBQUM7Q0FBQSxBQWxPRCxJQWtPQztTQWpPWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGZyb20sIEVNUFRZIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBldmVyeSwgY29uY2F0TWFwLCBzd2l0Y2hNYXAsIHRha2UsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEFwcE9wdGlvbnMgfSBmcm9tICdAZ3NwLXN5cy9ydGYtY29tbW9uJztcbmltcG9ydCB7IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnLi9ydGYtc2VydmljZSc7XG5pbXBvcnQgeyBNZW51U3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi9tZW51LXN0YXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgVEFCX0VWRU5UIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBRdWVyeXN0cmluZ1NlcnZpY2UgfSBmcm9tICcuL3F1ZXJ5c3RyaW5nJztcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgVUlEIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuXG4vKipcbiAqIOWvvOiIquS6i+S7tuacjeWKoVxuICogQHNjb3BlIEZvcm1Nb2R1bGVcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE5hdmlnYXRpb25FdmVudFNlcnZpY2Uge1xuICBwdWJsaWMgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XG4gIC8qKlxuICAgKiDlhbPpl63lkI7kuovku7blpITnkIblmahcbiAgICovXG4gIHByaXZhdGUgb25DbG9zZWRMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gdm9pZD47XG4gIC8qKlxuICAgKiDlhbPpl63liY3lpITnkIblmahcbiAgICovXG4gIHByaXZhdGUgb25DbG9zaW5nTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCAob3B0aW9ucz86IEFwcE9wdGlvbnMpID0+IE9ic2VydmFibGU8Ym9vbGVhbj4+O1xuICBwcml2YXRlIG9uVGFiU3dpdGNoTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCAob3B0aW9ucz86IEFwcE9wdGlvbnMpID0+IHZvaWQ+O1xuICBwcml2YXRlIHBhcmFtczogeyBbcHJvcE5hbWU6IHN0cmluZ106IGFueSB9O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcnVudGltZUZyYW1ld29ya1NlcnZpY2U6IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLFxuICAgIHByaXZhdGUgbWVudVN0YXRlU2VydmljZTogTWVudVN0YXRlU2VydmljZSxcbiAgICBwcml2YXRlIHF1ZXJ5c3RyaW5nU2VydmljZTogUXVlcnlzdHJpbmdTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMub25DbG9zZWRMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiB2b2lkPigpO1xuICAgIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gT2JzZXJ2YWJsZTxib29sZWFuPj4oKTtcbiAgICB0aGlzLm9uVGFiU3dpdGNoTGlzdGVuZXJzID0gbmV3IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gdm9pZD4oKTtcbiAgfVxuICBwcml2YXRlIGdldCBxdWVyeXN0cmluZ3MoKSB7XG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5xdWVyeXN0cmluZ1NlcnZpY2UucGFyc2Uod2luZG93LmxvY2F0aW9uLmhhc2gpO1xuICAgIC8vIOS/ruato2Zvcm1Ub2tlblxuICAgIGlmIChwYXJhbXMpIHtcbiAgICAgIHBhcmFtcy5mb3JtVG9rZW4gPSB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmZvcm1Ub2tlbjtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmFtcztcbiAgfVxuICAvKipcbiAgICog5rOo5YaM5LqL5Lu2XG4gICAqL1xuICBwdWJsaWMgcmVnaXN0ZXJFdmVudCgpIHtcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5xdWVyeXN0cmluZ3M7XG4gICAgdGhpcy5wYXJhbXMgPSBvcHRpb25zO1xuICAgIC8vIOazqOWGjOagh+etvumhteWIh+aNouS6i+S7tlxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihUQUJfRVZFTlQub25UYWJTd2l0Y2hlZCwgKGUpID0+IHRoaXMuaGFuZGxlVGFiU3dpdGNoRXZlbnQoZSksIG9wdGlvbnMpO1xuICAgIC8vIOazqOWGjOagh+etvumhteWFs+mXreWQjuS6i+S7tlxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihUQUJfRVZFTlQub25UYWJDbG9zZWQsIChlKSA9PiB0aGlzLmhhbmRsZVRhYkNsb3NlZEV2ZW50KGUpLCBvcHRpb25zKTtcbiAgICAvLyDms6jlhozmoIfnrb7pobXlhbPpl63liY3kuovku7ZcbiAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmFkZEV2ZW50TGlzdGVuZXIoVEFCX0VWRU5ULm9uVGFiQ2xvc2luZywgKGUpID0+IHRoaXMuaGFuZGxlVGFiQ2xvc2luZ0V2ZW50KGUpLCBvcHRpb25zKTtcbiAgfVxuICAvKipcbiAgICog5aSE55CG5qCH562+6aG15YiH5o2i5LqL5Lu2XG4gICAqL1xuICBwcml2YXRlIGhhbmRsZVRhYlN3aXRjaEV2ZW50KGU6IGFueSkge1xuICAgIGlmICghZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyDpgInkuK3nmoTooajljZXkuLrns7vnu5/ooajljZXvvIzlj6rog73ov5Tlm55pZO+8jOayoeaciXRhYklkXG4gICAgY29uc3QgZXZlbnRUYWJJZCA9IGUudGFiSWQgfHwgZS5pZCB8fCBudWxsO1xuICAgIGlmICghZXZlbnRUYWJJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5wYXJhbXM7IC8vIHRoaXMucXVlcnlzdHJpbmdzO1xuICAgIGNvbnN0IHRhYklkID0gb3B0aW9ucy50YWJJZCB8fCBvcHRpb25zLmZ1bmNJZCB8fCBvcHRpb25zLmFwcElkO1xuICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUoZXZlbnRUYWJJZCk7XG4gICAgaWYgKCEhdGFiSWQgJiYgdGFiSWQgPT09IGV2ZW50VGFiSWQgJiYgISFtZW51U3RhdGUgJiYgbWVudVN0YXRlLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuZm9ybVJlbG9hZCgpO1xuICAgIH1cbiAgICB0aGlzLmZpcmVUYWJTd2l0Y2hFdmVudChlKTtcbiAgfVxuICAvKipcbiAgICog6Kem5Y+RdGFi5YiH5o2i5LqL5Lu2XG4gICAqIEBwYXJhbSBlIGVcbiAgICovXG4gIHByaXZhdGUgZmlyZVRhYlN3aXRjaEV2ZW50KGU6IGFueSkge1xuICAgIGlmICghdGhpcy5vblRhYlN3aXRjaExpc3RlbmVycyB8fCB0aGlzLm9uVGFiU3dpdGNoTGlzdGVuZXJzLnNpemUgPCAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMuZm9yRWFjaCgoaGFuZGxlLCBrZXksIG1hcCkgPT4ge1xuICAgICAgaWYgKHR5cGVvZiBoYW5kbGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgaGFuZGxlKGUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDmoIfnrb7pobXlhbPpl63liY3kuovku7ZcbiAgICovXG4gIHByaXZhdGUgaGFuZGxlVGFiQ2xvc2luZ0V2ZW50KGU6IGFueSkge1xuICAgIGlmICghZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyDopoHlhbPpl63nmoTooajljZXkuLrns7vnu5/ooajljZXvvIzlj6rog73ov5Tlm55pZO+8jOayoeaciXRhYklkXG4gICAgY29uc3QgZXZlbnRUYWJJZCA9IGUudGFiSWQgfHwgZS5pZCB8fCBudWxsO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnBhcmFtczsgLy8gdGhpcy5xdWVyeXN0cmluZ3M7XG4gICAgY29uc3QgdGFiSWQgPSBvcHRpb25zLnRhYklkIHx8IG9wdGlvbnMuZnVuY0lkIHx8IG9wdGlvbnMuYXBwSWQ7XG4gICAgaWYgKCEhZXZlbnRUYWJJZCAmJiAhIXRhYklkICYmIHRhYklkID09PSBldmVudFRhYklkKSB7XG4gICAgICB0aGlzLmZpcmVUYWJDbG9zaW5nRXZlbnQoZSkuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMucmVtb3ZlTWVudVN0YXRlKGV2ZW50VGFiSWQpLCA1MDApO1xuICAgICAgICAgIGNvbnN0IGZvcm1FdmVudFNlcnZpY2VzOiBNYXA8c3RyaW5nLCBhbnk+ID0gd2luZG93Wydmb3JtRXZlbnRTZXJ2aWNlcyddO1xuICAgICAgICAgIGlmIChmb3JtRXZlbnRTZXJ2aWNlcy5oYXMoZXZlbnRUYWJJZCkpIHtcbiAgICAgICAgICAgIGZvcm1FdmVudFNlcnZpY2VzLmRlbGV0ZShldmVudFRhYklkKTtcbiAgICAgICAgICAgIHdpbmRvd1snZm9ybUV2ZW50U2VydmljZXMnXSA9IGZvcm1FdmVudFNlcnZpY2VzO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoIShlICYmIGUuaGFzT3duUHJvcGVydHkoJ3Rva2VuJykpKSB7XG4gICAgICAgICAgICBlID0gT2JqZWN0LmFzc2lnbih7fSwgZSwgeyB0b2tlbjogb3B0aW9ucy5mb3JtVG9rZW4gfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0KSB7XG4gICAgICAgICAgICB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmRpc3Bvc2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5jbG9zZU1lbnUoZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6Kem5Y+R5YWz6Zet5YmN5LqL5Lu2XG4gICAqL1xuICBwcml2YXRlIGZpcmVUYWJDbG9zaW5nRXZlbnQoZTogYW55KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgaWYgKCF0aGlzLm9uQ2xvc2luZ0xpc3RlbmVycyB8fCB0aGlzLm9uQ2xvc2luZ0xpc3RlbmVycy5zaXplIDwgMSkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cbiAgICBjb25zdCBsaXN0ZW5lcnMgPSB0aGlzLm9uQ2xvc2luZ0xpc3RlbmVycy52YWx1ZXMoKTtcbiAgICBjb25zdCByZXN1bHQkID0gZnJvbShsaXN0ZW5lcnMpO1xuICAgIC8vIOeUqOaIt+aLkue7nVxuICAgIGxldCB1c2VyUmVqZWN0ZWQgPSBmYWxzZTtcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxuICAgICAgY29uY2F0TWFwKGhhbmRsZSA9PiB7XG4gICAgICAgIGlmICh1c2VyUmVqZWN0ZWQpIHtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGhhbmRsZShlKS5waXBlKFxuICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgdGFwKHJlc3VsdCA9PiB1c2VyUmVqZWN0ZWQgPSAhcmVzdWx0KSxcbiAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IG9mKHJlc3VsdCkpXG4gICAgICAgICk7XG4gICAgICB9KSxcbiAgICAgIGV2ZXJ5KHJlc3VsdCA9PiByZXN1bHQpXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5qCH562+6aG15YWz6Zet5ZCO5LqL5Lu2XG4gICAqL1xuICBwcml2YXRlIGhhbmRsZVRhYkNsb3NlZEV2ZW50KGU6IGFueSkge1xuICAgIGlmICghZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5wYXJhbXM7IC8vIHRoaXMucXVlcnlzdHJpbmdzO1xuICAgIGNvbnN0IHRhYklkID0gb3B0aW9ucy50YWJJZCB8fCBvcHRpb25zLmZ1bmNJZCB8fCBvcHRpb25zLmFwcElkO1xuICAgIGNvbnN0IGV2ZW50VGFiSWQgPSBlLnRhYklkIHx8IGUuaWQgfHwgbnVsbDtcbiAgICBpZiAodGFiSWQgPT09IGV2ZW50VGFiSWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgbWVudVN0YXRlID0gdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmdldE1lbnVTdGF0ZSh0YWJJZCwgZXZlbnRUYWJJZCk7XG4gICAgaWYgKCEhZXZlbnRUYWJJZCAmJiAhIW1lbnVTdGF0ZSAmJiBtZW51U3RhdGUubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5yZW1vdmVNZW51U3RhdGUoZXZlbnRUYWJJZCk7XG4gICAgICB0aGlzLmZvcm1SZWxvYWQoKTtcbiAgICB9XG4gICAgdGhpcy5maXJlVGFiQ2xvc2VkRXZlbnQoZSk7XG4gIH1cbiAgcHJpdmF0ZSByZW1vdmVNZW51U3RhdGUodGFiSWQ6IHN0cmluZykge1xuICAgIGlmICh0aGlzWydjb250ZXh0J10pIHtcbiAgICAgIHRoaXMubWVudVN0YXRlU2VydmljZS5yZW1vdmVNZW51KHRhYklkKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOinpuWPkeWFs+mXreWQjuS6i+S7tlxuICAgKiBAcGFyYW0gZSBldmVudFxuICAgKi9cbiAgcHJpdmF0ZSBmaXJlVGFiQ2xvc2VkRXZlbnQoZTogYW55KSB7XG4gICAgaWYgKCF0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzIHx8IHRoaXMub25DbG9zZWRMaXN0ZW5lcnMuc2l6ZSA8IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5vbkNsb3NlZExpc3RlbmVycy5mb3JFYWNoKChoYW5kbGUsIGtleSwgbWFwKSA9PiB7XG4gICAgICBpZiAodHlwZW9mIGhhbmRsZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBoYW5kbGUoZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgLy8gI2VuZHJlZ2lvblxuICAvKipcbiAgICog5rOo5YaM5LqL5Lu255uR5ZCs5ZmoXG4gICAqIEBwYXJhbSBldmVudFR5cGUg5LqL5Lu257G75Z6LIG9uVGFiQ2xvc2VkXG4gICAqIEBwYXJhbSBoYW5kbGVyIOWkhOeQhuWZqFxuICAgKi9cbiAgcHVibGljIGFkZEV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlOiBzdHJpbmcsIGhhbmRsZXI6IChvcHRpb25zOiBBcHBPcHRpb25zKSA9PiBhbnkpOiBzdHJpbmcge1xuICAgIGNvbnN0IGtleSA9IFVJRC5jcmVhdGUoKTtcbiAgICBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zZWQpIHtcbiAgICAgIHRoaXMub25DbG9zZWRMaXN0ZW5lcnMuc2V0KGtleSwgaGFuZGxlcik7XG4gICAgICByZXR1cm4ga2V5O1xuICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zaW5nKSB7XG4gICAgICB0aGlzLm9uQ2xvc2luZ0xpc3RlbmVycy5zZXQoa2V5LCBoYW5kbGVyKTtcbiAgICAgIHJldHVybiBrZXk7XG4gICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYlN3aXRjaGVkKSB7XG4gICAgICB0aGlzLm9uVGFiU3dpdGNoTGlzdGVuZXJzLnNldChrZXksIGhhbmRsZXIpO1xuICAgICAgcmV0dXJuIGtleTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgLyoqXG4gICAqIOenu+mZpOS6i+S7tuebkeWQrOWZqFxuICAgKiBAcGFyYW0gZXZlbnRUeXBlIOS6i+S7tuexu+Wei1xuICAgKiBAcGFyYW0ga2V5IOS6i+S7tuagh+ivhlxuICAgKi9cbiAgcHVibGljIHJlbW92ZUV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlOiBzdHJpbmcsIGtleTogc3RyaW5nKSB7XG4gICAgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiQ2xvc2VkKSB7XG4gICAgICByZXR1cm4gdGhpcy5vbkNsb3NlZExpc3RlbmVycy5kZWxldGUoa2V5KTtcbiAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiQ2xvc2luZykge1xuICAgICAgcmV0dXJuIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLmRlbGV0ZShrZXkpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgLyoqXG4gICAqIOa4heepuuS6i+S7tuebkeWQrOWZqFxuICAgKiBAcGFyYW0gZXZlbnRUeXBlIOS6i+S7tuexu+Wei1xuICAgKi9cbiAgcHVibGljIGNsZWFyRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NlZCkge1xuICAgICAgdGhpcy5vbkNsb3NlZExpc3RlbmVycy5jbGVhcigpO1xuICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zaW5nKSB7XG4gICAgICB0aGlzLm9uQ2xvc2luZ0xpc3RlbmVycy5jbGVhcigpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog5Yi35paw57uE5Lu25pWw5o2uXG4gICAqL1xuICBwcml2YXRlIGZvcm1SZWxvYWQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc3RyaW5nLWxpdGVyYWxcbiAgICAgIHRoaXNbJ2NvbnRleHQnXVsnZnJhbWVDb250ZXh0J11bJ2FwcENvbnRleHQnXVsncmVmcmVzaCddKCk7XG4gICAgfSBjYXRjaCB7IH1cbiAgfVxufVxuIl19