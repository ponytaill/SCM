/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
export class LookupDialogManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        this.lookupInit = null;
        this._loadDataWhenOpen = true;
        this._navSelectedId = '';
        this._selectFirstInNav = false;
        this.keyDownHandler = null;
    }
    // 帮助窗口关闭后做一些清理工作
    /**
     * @return {?}
     */
    dialogClosed() {
        if (this.ins.displayText !== this.ins.originalText && !this.ins.nosearch) {
            this.ins.displayText = this.ins.originalText;
            this.ins.setModelValue(this.ins.displayText);
        }
        if (this.ins.componentRef) {
            this.ins.componentRef.destroy();
            this.ins.componentRef = null;
        }
        if (this.ins.favoritesComponentRef) {
            this.ins.favoritesComponentRef.destroy();
            this.ins.favoritesComponentRef = null;
        }
        if (this.ins.contentContainer) {
            this.ins.contentContainer.clear();
        }
        if (this.ins.centerContainer) {
            this.ins.centerContainer.clear();
        }
        if (this.ins.leftComponentRef) {
            this.ins.leftComponentRef.destroy();
            this.ins.leftComponentRef = null;
        }
        if (this.ins.leftContainer) {
            this.ins.leftContainer.clear();
        }
        this.ins.isShow = false;
        this.ins.isTextChange = false;
        if (this.ins.dialog) {
            this.ins.content = null;
        }
        this.ins.navigationFilter = null;
        this.ins.lookupUtils.pendingEnd();
        if (this.ins.helpId) {
            this.ins.displayType = '';
        }
        if (this.lookupInit) {
            this.lookupInit.unsubscribe();
            this.lookupInit = null;
        }
        // this.ins.items = [];
        this.ins.favoriteItems = [];
        this.ins.isTabChanged = false;
        if (this.ins.uri) {
            this.ins.items = [];
        }
        this.ins._searchState = null;
        this.ins.pageIndex = 1;
        this.ins.loadDataWhenOpen = this._loadDataWhenOpen;
        this.ins.navSelectedIds = this._navSelectedId;
        this.ins.selectFirstInNav = this._selectFirstInNav;
        this.ins.isGetAllChidlNodes = false;
        this.ins.enableGetAllChildNodes = true;
        // 保存个性化数据
        if (this.ins.usePersionalConf && this.ins.favoriteDataFrom !== 'locale') {
            this.ins.httpMgr.submitFavoriteData('dialog closed event.');
        }
        if (this.keyDownHandler) {
            this.keyDownHandler();
            this.keyDownHandler = null;
        }
        if (this.ins.inputGroup) {
            this.ins.inputGroup.focus();
        }
        this.ins.userInitialConfig.reset();
        this.ins.treeInfo = this.ins._treeInfo_;
        this.ins.lookupUtils.destroy();
        this.ins.dialogClosed.emit();
    }
    /**
     * @return {?}
     */
    onDialogCreated() {
        this._loadDataWhenOpen = this.ins.loadDataWhenOpen;
        this._navSelectedId = this.ins.navSelectedIds;
        this._selectFirstInNav = this.ins.selectFirstInNav;
        this.ins.dialogCreatedSubscription = this.ins.dialogCreated.subscribe((/**
         * @param {?} dlg
         * @return {?}
         */
        dlg => {
            if (dlg) {
                if (this.ins.dialogOpenedSubscription) {
                    this.ins.dialogOpenedSubscription.unsubscribe();
                }
                if (this.ins.dialogClosedSubscription) {
                    this.ins.dialogClosedSubscription.unsubscribe();
                }
                this.registerDialogEvent();
                if (this.ins.isRecordSize) {
                    /** @type {?} */
                    const dlgSize = this.ins.personalConfigService.getDialogSize();
                    if (dlgSize) {
                        const { width, height } = dlgSize;
                        this.ins.dialogWidth = width ? width : this.ins.dialogWidth;
                        this.ins.dialogHeight = height ? height : this.ins.dialogHeight;
                        // 20200908 更新现窗口的尺寸 by Lucas
                        dlg.width = this.ins.dialogWidth;
                        dlg.height = this.ins.dialogHeight;
                    }
                }
                dlg.show();
            }
        }));
    }
    /**
     * @param {?} pr
     * @return {?}
     */
    checkDictPickingResult(pr) {
        /** @type {?} */
        let o = true;
        if (pr === undefined || pr === null || pr === '') {
            o = true;
        }
        if (typeof pr === 'boolean') {
            o = pr;
        }
        /** @type {?} */
        let customData;
        /** @type {?} */
        let selectedIds;
        /** @type {?} */
        let message;
        if (typeof pr === 'object') {
            if (pr.showDialog === undefined) {
                o = true;
            }
            else {
                o = pr.showDialog;
            }
            if (pr.hasOwnProperty('data')) {
                /** 保存帮助前传递的数据 */
                customData = pr.data;
            }
            selectedIds = pr.selectedIds || null;
            if (pr.message) {
                message = pr.message;
            }
        }
        return { show: o, customData, selectedIds, message };
    }
    /**
     * @param {?} pr
     * @return {?}
     */
    canOpenDialog(pr) {
        const { show, customData, selectedIds, message } = this.checkDictPickingResult(pr);
        this.ins.customData = customData;
        this.ins.selectedIds = selectedIds || null;
        if (message) {
            this.ins.notifyService.warning(message);
        }
        this.ins.isReady = false;
        this.ins.isShow = show;
    }
    /**
     * @return {?}
     */
    getHeight() {
        return this.ins.dialog.size.contentHeight -
            this.ins.containerMargin.bottom -
            this.ins.containerMargin.top -
            (this.ins.useFavorite ? 40 : 0);
    }
    /**
     * @private
     * @return {?}
     */
    getMainGridSize() {
        if (this.ins.isDoublleList()) {
            return {
                width: this.ins.dialog.size.width - this.ins.leftPanel.width - 27,
                height: this.getHeight()
            };
        }
        return {
            width: this.ins.dialog.size.width - this.ins.containerMargin.left - this.ins.containerMargin.right,
            height: this.getHeight()
        };
    }
    /**
     * @return {?}
     */
    resetDialogContentHeight() {
        const { header: hHeight, footer: fHeight } = this.ins.dialog.size;
        return this.ins.dialogHeight - hHeight - fHeight - this.ins.containerMargin.bottom - this.ins.containerMargin.top;
    }
    /**
     * 注册弹出窗口的事件
     * @private
     * @return {?}
     */
    registerDialogEvent() {
        this.ins.dialogOpenedSubscription = this.ins.dialog.opened.subscribe((/**
         * @return {?}
         */
        () => {
            this.ins.dialogContentHeight = this.resetDialogContentHeight();
            this.ins.gridOptions = Object.assign(this.ins.gridOptions, this.getMainGridSize());
            this.ins.dialog.el.nativeElement.querySelector('.ps-content').style.height = '100%';
            if (this.ins.displayType && this.ins.customDisplayType) {
                this.ins.componentRef = this.ins.lookupCmpMgr.createContent(this.ins.gridOptions);
                this.ins.lookupCmpMgr.createFavoriteComponent();
            }
            this.ins.initData();
            // 修改帮助窗口的状态
            this.ins.lookupUtils.pendingEnd();
            this.ins.dialogOpened.emit();
        }));
        this.ins.subscriptions.push(this.ins.dialogOpenedSubscription);
        this.lookupInit = this.ins.lookupinitializationSubject.subscribe((/**
         * @return {?}
         */
        () => {
            this.ins.loadDataWhenOpen = true;
            // 注册快捷键
            this.registerShortcutKey();
            // 监听左侧尺寸变化事件
            if (this.ins.leftPanel) {
                /** @type {?} */
                const leftPanelResize$ = this.ins.leftPanel.resizing.subscribe((/**
                 * @param {?} s
                 * @return {?}
                 */
                (s) => {
                    this.ins.componentRef.instance.resize({
                        width: this.ins.dialog.size.width - s.size.width - 27,
                        height: this.getHeight()
                    });
                    this.ins.leftComponentRef.instance.resize(s.size);
                }));
                this.ins.subscriptions.push(leftPanelResize$);
            }
        }));
        this.ins.dialogClosedSubscription = this.ins.dialog.closed.subscribe((/**
         * @return {?}
         */
        () => {
            // 输入框变化后，弹出窗口未选择数据关闭窗口时，还原原始值
            this.ins.dialogMgr.dialogClosed();
        }));
        this.ins.subscriptions.push(this.ins.dialogClosedSubscription);
    }
    /**
     * @private
     * @return {?}
     */
    registerShortcutKey() {
        // 回车，与确定按钮处理逻辑一至。
        /** @type {?} */
        const dlgContainerDom = this.ins.dialog.el.nativeElement.querySelector('.farris-modal');
        if (dlgContainerDom && this.ins.shortcutKey && !this.keyDownHandler) {
            this.keyDownHandler = this.ins.eventManager.addEventListener(dlgContainerDom, 'keydown', (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                const { moveUp, moveDown, searchFocus, confirm, nextPager, prevPager, expand, collapse } = this.ins.shortcutKey;
                /** @type {?} */
                const arrowKey = [moveUp, moveDown, expand, collapse];
                if (arrowKey.includes(e.code)) {
                    this.ins.componentRef.instance.onKeydownEvent(e);
                }
                else if (e.key === confirm) {
                    if (e.target['nodeName'] === 'INPUT' && !e.ctrlKey) {
                        return;
                    }
                    this.ins.okButton.nativeElement.click();
                }
                else if (e.code === searchFocus) { // 帮助窗口查询输入框焦点
                    e.preventDefault();
                    this.ins.componentRef.instance.inputGroup.focus();
                }
                else if (!this.ins.isTree() && (e.code === nextPager || e.code === prevPager)) { // 分页
                    // 分页
                    /** @type {?} */
                    const isNextPager = e.code === nextPager;
                    this.paginationKeyDownHandler(isNextPager);
                }
            }));
        }
    }
    /**
     * @private
     * @param {?=} next
     * @return {?}
     */
    paginationKeyDownHandler(next = true) {
        /** @type {?} */
        const datatableRef = this.ins.componentRef.instance;
        const { pageIndex, pageSize, total } = datatableRef;
        /** @type {?} */
        const pagerCount = Math.ceil(total / pageSize);
        /** @type {?} */
        let newPageNum = pageIndex;
        if (next) {
            newPageNum = newPageNum + 1;
        }
        else {
            newPageNum = newPageNum - 1;
        }
        if (newPageNum > pagerCount || newPageNum < 1) {
            newPageNum = pageIndex;
        }
        this.ins.componentRef.instance.onPageChange({ pageSize, pageIndex: newPageNum });
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.lookupInit;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._loadDataWhenOpen;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._navSelectedId;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype._selectFirstInNav;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.keyDownHandler;
    /**
     * @type {?}
     * @private
     */
    LookupDialogManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLW1hbmdhZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvZGlhbG9nLW1hbmdhZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFJQSxNQUFNLE9BQU8sbUJBQW1COzs7O0lBUzVCLFlBQW9CLEdBQXdCO1FBQXhCLFFBQUcsR0FBSCxHQUFHLENBQXFCO1FBUHBDLGVBQVUsR0FBaUIsSUFBSSxDQUFDO1FBQ2hDLHNCQUFpQixHQUFHLElBQUksQ0FBQztRQUN6QixtQkFBYyxHQUFHLEVBQUUsQ0FBQztRQUNwQixzQkFBaUIsR0FBRyxLQUFLLENBQUM7UUFFMUIsbUJBQWMsR0FBRyxJQUFJLENBQUM7SUFFa0IsQ0FBQzs7Ozs7SUFFakQsWUFBWTtRQUNSLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRTtZQUN0RSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztZQUM3QyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1NBQ2hEO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNoQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUU7WUFDaEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLHFC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RixDQUFDO0NBRUo7Ozs7OztJQTdTRyx5Q0FBd0M7Ozs7O0lBQ3hDLGdEQUFpQzs7Ozs7SUFDakMsNkNBQTRCOzs7OztJQUM1QixnREFBa0M7Ozs7O0lBRWxDLDZDQUE4Qjs7Ozs7SUFFbEIsa0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFBpY2tpbmdSZXN1bHQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcblxyXG5leHBvcnQgY2xhc3MgTG9va3VwRGlhbG9nTWFuYWdlciB7XHJcblxyXG4gICAgcHJpdmF0ZSBsb29rdXBJbml0OiBTdWJzY3JpcHRpb24gPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBfbG9hZERhdGFXaGVuT3BlbiA9IHRydWU7XHJcbiAgICBwcml2YXRlIF9uYXZTZWxlY3RlZElkID0gJyc7XHJcbiAgICBwcml2YXRlIF9zZWxlY3RGaXJzdEluTmF2ID0gZmFsc2U7XHJcblxyXG4gICAgcHJpdmF0ZSBrZXlEb3duSGFuZGxlciA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbnM6IExvb2t1cEdyaWRDb21wb25lbnQpIHsgfVxyXG4gICAgLy8g5biu5Yqp56qX5Y+j5YWz6Zet5ZCO5YGa5LiA5Lqb5riF55CG5bel5L2cXHJcbiAgICBkaWFsb2dDbG9zZWQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmRpc3BsYXlUZXh0ICE9PSB0aGlzLmlucy5vcmlnaW5hbFRleHQgJiYgIXRoaXMuaW5zLm5vc2VhcmNoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpc3BsYXlUZXh0ID0gdGhpcy5pbnMub3JpZ2luYWxUZXh0O1xyXG4gICAgICAgICAgICB0aGlzLmlucy5zZXRNb2RlbFZhbHVlKHRoaXMuaW5zLmRpc3BsYXlUZXh0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5jb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5mYXZvcml0ZXNDb21wb25lbnRSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVzQ29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVzQ29tcG9uZW50UmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5jb250ZW50Q29udGFpbmVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNvbnRlbnRDb250YWluZXIuY2xlYXIoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5jZW50ZXJDb250YWluZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuY2VudGVyQ29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMubGVmdENvbXBvbmVudFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5sZWZ0Q29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5pbnMubGVmdENvbXBvbmVudFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMubGVmdENvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5sZWZ0Q29udGFpbmVyLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgdGhpcy5pbnMuaXNTaG93ID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5pbnMuaXNUZXh0Q2hhbmdlID0gZmFsc2U7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmRpYWxvZykge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5jb250ZW50ID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIgPSBudWxsO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5oZWxwSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlzcGxheVR5cGUgPSAnJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmxvb2t1cEluaXQpIHtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBJbml0LnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwSW5pdCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB0aGlzLmlucy5pdGVtcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuaW5zLmZhdm9yaXRlSXRlbXMgPSBbXTtcclxuICAgICAgICB0aGlzLmlucy5pc1RhYkNoYW5nZWQgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnVyaSkge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5pdGVtcyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmlucy5fc2VhcmNoU3RhdGUgPSBudWxsO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5pbnMucGFnZUluZGV4ID0gMTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMubG9hZERhdGFXaGVuT3BlbiA9IHRoaXMuX2xvYWREYXRhV2hlbk9wZW47XHJcbiAgICAgICAgdGhpcy5pbnMubmF2U2VsZWN0ZWRJZHMgPSB0aGlzLl9uYXZTZWxlY3RlZElkO1xyXG4gICAgICAgIHRoaXMuaW5zLnNlbGVjdEZpcnN0SW5OYXYgPSB0aGlzLl9zZWxlY3RGaXJzdEluTmF2O1xyXG5cclxuICAgICAgICB0aGlzLmlucy5pc0dldEFsbENoaWRsTm9kZXMgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuZW5hYmxlR2V0QWxsQ2hpbGROb2RlcyA9IHRydWU7XHJcblxyXG4gICAgICAgIC8vIOS/neWtmOS4quaAp+WMluaVsOaNrlxyXG4gICAgICAgIGlmICh0aGlzLmlucy51c2VQZXJzaW9uYWxDb25mICYmIHRoaXMuaW5zLmZhdm9yaXRlRGF0YUZyb20gIT09ICdsb2NhbGUnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmh0dHBNZ3Iuc3VibWl0RmF2b3JpdGVEYXRhKCdkaWFsb2cgY2xvc2VkIGV2ZW50LicpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMua2V5RG93bkhhbmRsZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5rZXlEb3duSGFuZGxlcigpO1xyXG4gICAgICAgICAgICB0aGlzLmtleURvd25IYW5kbGVyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlucHV0R3JvdXApIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMuaW5wdXRHcm91cC5mb2N1cygpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5pbnMudXNlckluaXRpYWxDb25maWcucmVzZXQoKTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMudHJlZUluZm8gPSB0aGlzLmlucy5fdHJlZUluZm9fO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5sb29rdXBVdGlscy5kZXN0cm95KCk7XHJcbiAgICAgICAgdGhpcy5pbnMuZGlhbG9nQ2xvc2VkLmVtaXQoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRpYWxvZ0NyZWF0ZWQoKSB7XHJcbiAgICAgICAgdGhpcy5fbG9hZERhdGFXaGVuT3BlbiA9IHRoaXMuaW5zLmxvYWREYXRhV2hlbk9wZW47XHJcbiAgICAgICAgdGhpcy5fbmF2U2VsZWN0ZWRJZCA9IHRoaXMuaW5zLm5hdlNlbGVjdGVkSWRzO1xyXG4gICAgICAgIHRoaXMuX3NlbGVjdEZpcnN0SW5OYXYgPSB0aGlzLmlucy5zZWxlY3RGaXJzdEluTmF2O1xyXG5cclxuICAgICAgICB0aGlzLmlucy5kaWFsb2dDcmVhdGVkU3Vic2NyaXB0aW9uID0gdGhpcy5pbnMuZGlhbG9nQ3JlYXRlZC5zdWJzY3JpYmUoZGxnID0+IHtcclxuICAgICAgICAgICAgaWYgKGRsZykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmRpYWxvZ09wZW5lZFN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ09wZW5lZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmRpYWxvZ0Nsb3NlZFN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ0Nsb3NlZFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZWdpc3RlckRpYWxvZ0V2ZW50KCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMuaXNSZWNvcmRTaXplKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGxnU2l6ZSA9IHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5nZXREaWFsb2dTaXplKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRsZ1NpemUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSBkbGdTaXplO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dXaWR0aCA9IHdpZHRoID8gd2lkdGggOiB0aGlzLmlucy5kaWFsb2dXaWR0aDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nSGVpZ2h0ID0gaGVpZ2h0ID8gaGVpZ2h0IDogdGhpcy5pbnMuZGlhbG9nSGVpZ2h0O1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gMjAyMDA5MDgg5pu05paw546w56qX5Y+j55qE5bC65a+4IGJ5IEx1Y2FzXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRsZy53aWR0aCA9IHRoaXMuaW5zLmRpYWxvZ1dpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkbGcuaGVpZ2h0ID0gdGhpcy5pbnMuZGlhbG9nSGVpZ2h0O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGRsZy5zaG93KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjaGVja0RpY3RQaWNraW5nUmVzdWx0KHByOiBQaWNraW5nUmVzdWx0IHwgYW55KSB7XHJcbiAgICAgICAgbGV0IG8gPSB0cnVlO1xyXG4gICAgICAgIGlmIChwciA9PT0gdW5kZWZpbmVkIHx8IHByID09PSBudWxsIHx8IHByID09PSAnJykge1xyXG4gICAgICAgICAgICBvID0gdHJ1ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgcHIgPT09ICdib29sZWFuJykge1xyXG4gICAgICAgICAgICBvID0gcHI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgY3VzdG9tRGF0YSwgc2VsZWN0ZWRJZHMsIG1lc3NhZ2U7XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2YgcHIgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgIGlmIChwci5zaG93RGlhbG9nID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIG8gPSB0cnVlO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbyA9IHByLnNob3dEaWFsb2c7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChwci5oYXNPd25Qcm9wZXJ0eSgnZGF0YScpKSB7XHJcbiAgICAgICAgICAgICAgICAvKiog5L+d5a2Y5biu5Yqp5YmN5Lyg6YCS55qE5pWw5o2uICovXHJcbiAgICAgICAgICAgICAgICBjdXN0b21EYXRhID0gcHIuZGF0YTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzZWxlY3RlZElkcyA9IHByLnNlbGVjdGVkSWRzIHx8IG51bGw7XHJcblxyXG4gICAgICAgICAgICBpZiAocHIubWVzc2FnZSkge1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZSA9IHByLm1lc3NhZ2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7IHNob3c6IG8sIGN1c3RvbURhdGEsIHNlbGVjdGVkSWRzLCBtZXNzYWdlIH07XHJcbiAgICB9XHJcblxyXG4gICAgY2FuT3BlbkRpYWxvZyhwcjogUGlja2luZ1Jlc3VsdCB8IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHtzaG93LCBjdXN0b21EYXRhLCBzZWxlY3RlZElkcywgbWVzc2FnZX0gPSB0aGlzLmNoZWNrRGljdFBpY2tpbmdSZXN1bHQocHIpO1xyXG4gICAgICAgIHRoaXMuaW5zLmN1c3RvbURhdGEgPSBjdXN0b21EYXRhO1xyXG4gICAgICAgIHRoaXMuaW5zLnNlbGVjdGVkSWRzID0gc2VsZWN0ZWRJZHMgfHwgbnVsbDtcclxuICAgICAgICBpZiAobWVzc2FnZSkge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcobWVzc2FnZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmlucy5pc1JlYWR5ID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5pbnMuaXNTaG93ID0gc2hvdztcclxuICAgIH1cclxuXHJcbiAgICBnZXRIZWlnaHQoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmRpYWxvZy5zaXplLmNvbnRlbnRIZWlnaHQgLVxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuY29udGFpbmVyTWFyZ2luLmJvdHRvbSAtXHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5jb250YWluZXJNYXJnaW4udG9wIC1cclxuICAgICAgICAgICAgICAgICh0aGlzLmlucy51c2VGYXZvcml0ZSA/IDQwIDogMCk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0TWFpbkdyaWRTaXplKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc0RvdWJsbGVMaXN0KCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIHdpZHRoOiB0aGlzLmlucy5kaWFsb2cuc2l6ZS53aWR0aCAtIHRoaXMuaW5zLmxlZnRQYW5lbC53aWR0aCAtIDI3LFxyXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmdldEhlaWdodCgpXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB3aWR0aDogdGhpcy5pbnMuZGlhbG9nLnNpemUud2lkdGggLSB0aGlzLmlucy5jb250YWluZXJNYXJnaW4ubGVmdCAtIHRoaXMuaW5zLmNvbnRhaW5lck1hcmdpbi5yaWdodCxcclxuICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLmdldEhlaWdodCgpXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICByZXNldERpYWxvZ0NvbnRlbnRIZWlnaHQoKSB7XHJcbiAgICAgICAgY29uc3QgeyBoZWFkZXI6IGhIZWlnaHQsIGZvb3RlcjogZkhlaWdodCB9ID0gdGhpcy5pbnMuZGlhbG9nLnNpemU7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmRpYWxvZ0hlaWdodCAtIGhIZWlnaHQgLSBmSGVpZ2h0IC0gIHRoaXMuaW5zLmNvbnRhaW5lck1hcmdpbi5ib3R0b20gLSB0aGlzLmlucy5jb250YWluZXJNYXJnaW4udG9wO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDms6jlhozlvLnlh7rnqpflj6PnmoTkuovku7YgKi9cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJEaWFsb2dFdmVudCgpIHtcclxuICAgICAgICB0aGlzLmlucy5kaWFsb2dPcGVuZWRTdWJzY3JpcHRpb24gPSB0aGlzLmlucy5kaWFsb2cub3BlbmVkLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dDb250ZW50SGVpZ2h0ID0gdGhpcy5yZXNldERpYWxvZ0NvbnRlbnRIZWlnaHQoKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmdyaWRPcHRpb25zID0gT2JqZWN0LmFzc2lnbih0aGlzLmlucy5ncmlkT3B0aW9ucywgdGhpcy5nZXRNYWluR3JpZFNpemUoKSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZy5lbC5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5wcy1jb250ZW50Jykuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmRpc3BsYXlUeXBlICYmIHRoaXMuaW5zLmN1c3RvbURpc3BsYXlUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYgPSB0aGlzLmlucy5sb29rdXBDbXBNZ3IuY3JlYXRlQ29udGVudCh0aGlzLmlucy5ncmlkT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5sb29rdXBDbXBNZ3IuY3JlYXRlRmF2b3JpdGVDb21wb25lbnQoKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5pbnMuaW5pdERhdGEoKTtcclxuXHJcbiAgICAgICAgICAgIC8vIOS/ruaUueW4ruWKqeeql+WPo+eahOeKtuaAgVxyXG4gICAgICAgICAgICB0aGlzLmlucy5sb29rdXBVdGlscy5wZW5kaW5nRW5kKCk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ09wZW5lZC5lbWl0KCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zLnN1YnNjcmlwdGlvbnMucHVzaCh0aGlzLmlucy5kaWFsb2dPcGVuZWRTdWJzY3JpcHRpb24pO1xyXG5cclxuICAgICAgICB0aGlzLmxvb2t1cEluaXQgPSB0aGlzLmlucy5sb29rdXBpbml0aWFsaXphdGlvblN1YmplY3Quc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubG9hZERhdGFXaGVuT3BlbiA9IHRydWU7XHJcbiAgICAgICAgICAgIC8vIOazqOWGjOW/q+aNt+mUrlxyXG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVyU2hvcnRjdXRLZXkoKTtcclxuICAgICAgICAgICAgLy8g55uR5ZCs5bem5L6n5bC65a+45Y+Y5YyW5LqL5Lu2XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5sZWZ0UGFuZWwpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxlZnRQYW5lbFJlc2l6ZSQgPSB0aGlzLmlucy5sZWZ0UGFuZWwucmVzaXppbmcuc3Vic2NyaWJlKChzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2UucmVzaXplKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg6IHRoaXMuaW5zLmRpYWxvZy5zaXplLndpZHRoIC0gcy5zaXplLndpZHRoIC0gMjcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5nZXRIZWlnaHQoKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmxlZnRDb21wb25lbnRSZWYuaW5zdGFuY2UucmVzaXplKHMuc2l6ZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5zdWJzY3JpcHRpb25zLnB1c2gobGVmdFBhbmVsUmVzaXplJCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5pbnMuZGlhbG9nQ2xvc2VkU3Vic2NyaXB0aW9uID0gdGhpcy5pbnMuZGlhbG9nLmNsb3NlZC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyDovpPlhaXmoYblj5jljJblkI7vvIzlvLnlh7rnqpflj6PmnKrpgInmi6nmlbDmja7lhbPpl63nqpflj6Pml7bvvIzov5jljp/ljp/lp4vlgLxcclxuICAgICAgICAgICAgdGhpcy5pbnMuZGlhbG9nTWdyLmRpYWxvZ0Nsb3NlZCgpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmlucy5zdWJzY3JpcHRpb25zLnB1c2godGhpcy5pbnMuZGlhbG9nQ2xvc2VkU3Vic2NyaXB0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlZ2lzdGVyU2hvcnRjdXRLZXkoKSB7XHJcbiAgICAgICAgLy8g5Zue6L2m77yM5LiO56Gu5a6a5oyJ6ZKu5aSE55CG6YC76L6R5LiA6Iez44CCXHJcbiAgICAgICAgY29uc3QgZGxnQ29udGFpbmVyRG9tID0gdGhpcy5pbnMuZGlhbG9nLmVsLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmZhcnJpcy1tb2RhbCcpO1xyXG5cclxuICAgICAgICBpZiAoZGxnQ29udGFpbmVyRG9tICYmIHRoaXMuaW5zLnNob3J0Y3V0S2V5ICYmICF0aGlzLmtleURvd25IYW5kbGVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMua2V5RG93bkhhbmRsZXIgPSB0aGlzLmlucy5ldmVudE1hbmFnZXIuYWRkRXZlbnRMaXN0ZW5lcihkbGdDb250YWluZXJEb20sICdrZXlkb3duJywgKGU6IEtleWJvYXJkRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB7IG1vdmVVcCwgbW92ZURvd24sIHNlYXJjaEZvY3VzLCBjb25maXJtLCBuZXh0UGFnZXIsIHByZXZQYWdlciwgZXhwYW5kLCBjb2xsYXBzZSB9ID0gdGhpcy5pbnMuc2hvcnRjdXRLZXk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhcnJvd0tleSA9IFttb3ZlVXAsIG1vdmVEb3duLCBleHBhbmQsIGNvbGxhcHNlXTtcclxuICAgICAgICAgICAgICAgIGlmIChhcnJvd0tleS5pbmNsdWRlcyhlLmNvZGUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuY29tcG9uZW50UmVmLmluc3RhbmNlLm9uS2V5ZG93bkV2ZW50KGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLmtleSA9PT0gY29uZmlybSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlLnRhcmdldFsnbm9kZU5hbWUnXSA9PT0gJ0lOUFVUJyAmJiAhZS5jdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMub2tCdXR0b24ubmF0aXZlRWxlbWVudC5jbGljaygpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChlLmNvZGUgPT09IHNlYXJjaEZvY3VzKSB7IC8vIOW4ruWKqeeql+WPo+afpeivoui+k+WFpeahhueEpueCuVxyXG4gICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2UuaW5wdXRHcm91cC5mb2N1cygpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pbnMuaXNUcmVlKCkgJiYgKGUuY29kZSA9PT0gbmV4dFBhZ2VyIHx8IGUuY29kZSA9PT0gcHJldlBhZ2VyICkpIHsgIC8vIOWIhumhtVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzTmV4dFBhZ2VyID0gZS5jb2RlID09PSBuZXh0UGFnZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wYWdpbmF0aW9uS2V5RG93bkhhbmRsZXIoaXNOZXh0UGFnZXIpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwYWdpbmF0aW9uS2V5RG93bkhhbmRsZXIobmV4dCA9IHRydWUpIHtcclxuICAgICAgICBjb25zdCBkYXRhdGFibGVSZWYgPSB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgICAgICAgY29uc3Qge3BhZ2VJbmRleCwgcGFnZVNpemUsIHRvdGFsfSA9IGRhdGF0YWJsZVJlZjtcclxuICAgICAgICBjb25zdCBwYWdlckNvdW50ID0gTWF0aC5jZWlsKHRvdGFsIC8gcGFnZVNpemUpO1xyXG5cclxuICAgICAgICBsZXQgbmV3UGFnZU51bSA9IHBhZ2VJbmRleDtcclxuICAgICAgICBpZiAobmV4dCkge1xyXG4gICAgICAgICAgICBuZXdQYWdlTnVtID0gbmV3UGFnZU51bSArIDE7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbmV3UGFnZU51bSA9IG5ld1BhZ2VOdW0gLSAxO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG5ld1BhZ2VOdW0gPiBwYWdlckNvdW50IHx8IG5ld1BhZ2VOdW0gPCAxKSB7XHJcbiAgICAgICAgICAgIG5ld1BhZ2VOdW0gPSBwYWdlSW5kZXg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmlucy5jb21wb25lbnRSZWYuaW5zdGFuY2Uub25QYWdlQ2hhbmdlKHsgcGFnZVNpemUsIHBhZ2VJbmRleDogbmV3UGFnZU51bSB9KTtcclxuICAgIH1cclxuXHJcbn1cclxuXHJcbiJdfQ==