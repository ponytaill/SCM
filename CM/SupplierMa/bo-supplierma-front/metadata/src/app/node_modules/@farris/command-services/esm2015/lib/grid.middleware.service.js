/*
 * @Author: aalizzwell
 * @Date: 2019-08-05 11:48:27
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-08-06 15:01:53
 */
import { Injectable, Optional } from '@angular/core';
import { EMPTY, of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { FrameContext, ViewModel } from '@farris/devkit';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { BefRepositoryUtil } from '@farris/bef';
import { CommandService } from './command-service';
// tslint:disable: no-string-literal
/**
 * Grid中间件服务
 * @scope FrameComponent
 */
export class GridMiddlewareService {
    constructor(frameContext, msgService, languageService, viewModel, commandService) {
        this.frameContext = frameContext;
        this.msgService = msgService;
        this.languageService = languageService;
        this.viewModel = viewModel;
        this.commandService = commandService;
        this.repository = this.frameContext.repository;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
    }
    /**
     * 页码切换前
     */
    onPageChanging() {
        if (this.isChanged) {
            return this.msgService.question(this.languageService['gridDataNotSave']).pipe(switchMap((result) => {
                if (!result) {
                    return EMPTY;
                }
                else {
                    return of(true);
                }
            }));
        }
        else {
            return of(true);
        }
    }
    /**
     * 表格过滤
     * @param commandName 命令名称
     * @param frameId frameId
     * @returns
     */
    filter(commandName, frameId) {
        const self = this;
        let filters = self.context && self.context.eventParam || [];
        if (typeof (filters) === 'string') {
            filters = JSON.parse(filters);
        }
        // 查询时重置页码为第一页
        this.viewModel.frameContext.repository.entityCollection.pageIndex = 1;
        this.viewModel.frameContext.repository.filterConditionManager.setConditions(this.viewModel.bindingPath, filters);
        return this.commandService.execute(commandName, frameId);
    }
    /**
     * 是否有未保存的变更
     */
    get isChanged() {
        const befRepository = this.repository;
        return BefRepositoryUtil.isExistUnsaveData(befRepository);
    }
}
GridMiddlewareService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
GridMiddlewareService.ctorParameters = () => [
    { type: FrameContext },
    { type: FormMessageService },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: ViewModel },
    { type: CommandService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JpZC5taWRkbGV3YXJlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZ3JpZC5taWRkbGV3YXJlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFlBQVksRUFBYyxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM1RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGlCQUFpQixFQUFpQixNQUFNLGFBQWEsQ0FBQztBQUMvRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFbkQsb0NBQW9DO0FBQ3BDOzs7R0FHRztBQUVILE1BQU0sT0FBTyxxQkFBcUI7SUFHaEMsWUFDVSxZQUEwQixFQUMxQixVQUE4QixFQUNsQixlQUFnQyxFQUM1QyxTQUFvQixFQUNwQixjQUE4QjtRQUo5QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUNsQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDNUMsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFFdEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQztRQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN6QixJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUN0RDtJQUNILENBQUM7SUFDRDs7T0FFRztJQUNJLGNBQWM7UUFDbkIsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2xCLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUMzRSxTQUFTLENBQUMsQ0FBQyxNQUFlLEVBQUUsRUFBRTtnQkFDNUIsSUFBSSxDQUFDLE1BQU0sRUFBRTtvQkFDWCxPQUFPLEtBQUssQ0FBQztpQkFDZDtxQkFBTTtvQkFDTCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDakI7WUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFDO1NBQ0g7YUFBTTtZQUNMLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO0lBQ0gsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ksTUFBTSxDQUFDLFdBQW1CLEVBQUUsT0FBZTtRQUNoRCxNQUFNLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdkIsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDNUQsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEtBQUssUUFBUSxFQUFFO1lBQ2pDLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQy9CO1FBQ0QsY0FBYztRQUNkLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxzQkFBc0IsQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDakgsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUNEOztPQUVHO0lBQ0gsSUFBWSxTQUFTO1FBQ25CLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxVQUFnQyxDQUFDO1FBQzVELE9BQU8saUJBQWlCLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDNUQsQ0FBQzs7O1lBekRGLFVBQVU7Ozs7WUFYRixZQUFZO1lBQ1osa0JBQWtCO1lBQ2xCLGVBQWUsdUJBZ0JuQixRQUFRO1lBbEJzQixTQUFTO1lBSW5DLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQEF1dGhvcjogYWFsaXp6d2VsbFxuICogQERhdGU6IDIwMTktMDgtMDUgMTE6NDg6MjdcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBhYWxpenp3ZWxsXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE5LTA4LTA2IDE1OjAxOjUzXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEVNUFRZLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBSZXBvc2l0b3J5LCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnlVdGlsLCBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xuaW1wb3J0IHsgQ29tbWFuZFNlcnZpY2UgfSBmcm9tICcuL2NvbW1hbmQtc2VydmljZSc7XG5cbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxuLyoqXG4gKiBHcmlk5Lit6Ze05Lu25pyN5YqhXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEdyaWRNaWRkbGV3YXJlU2VydmljZSB7XG4gIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXG4gICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcbiAgICBwcml2YXRlIHZpZXdNb2RlbDogVmlld01vZGVsLFxuICAgIHByaXZhdGUgY29tbWFuZFNlcnZpY2U6IENvbW1hbmRTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMucmVwb3NpdG9yeSA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnk7XG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOmhteeggeWIh+aNouWJjVxuICAgKi9cbiAgcHVibGljIG9uUGFnZUNoYW5naW5nKCkge1xuICAgIGlmICh0aGlzLmlzQ2hhbmdlZCkge1xuICAgICAgcmV0dXJuIHRoaXMubXNnU2VydmljZS5xdWVzdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZVsnZ3JpZERhdGFOb3RTYXZlJ10pLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgocmVzdWx0OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOihqOagvOi/h+a7pFxuICAgKiBAcGFyYW0gY29tbWFuZE5hbWUg5ZG95Luk5ZCN56ewXG4gICAqIEBwYXJhbSBmcmFtZUlkIGZyYW1lSWRcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZmlsdGVyKGNvbW1hbmROYW1lOiBzdHJpbmcsIGZyYW1lSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IHNlbGY6IGFueSA9IHRoaXM7XG4gICAgbGV0IGZpbHRlcnMgPSBzZWxmLmNvbnRleHQgJiYgc2VsZi5jb250ZXh0LmV2ZW50UGFyYW0gfHwgW107XG4gICAgaWYgKHR5cGVvZiAoZmlsdGVycykgPT09ICdzdHJpbmcnKSB7XG4gICAgICBmaWx0ZXJzID0gSlNPTi5wYXJzZShmaWx0ZXJzKTtcbiAgICB9XG4gICAgLy8g5p+l6K+i5pe26YeN572u6aG156CB5Li656ys5LiA6aG1XG4gICAgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5wYWdlSW5kZXggPSAxO1xuICAgIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmZpbHRlckNvbmRpdGlvbk1hbmFnZXIuc2V0Q29uZGl0aW9ucyh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCwgZmlsdGVycyk7XG4gICAgcmV0dXJuIHRoaXMuY29tbWFuZFNlcnZpY2UuZXhlY3V0ZShjb21tYW5kTmFtZSwgZnJhbWVJZCk7XG4gIH1cbiAgLyoqXG4gICAqIOaYr+WQpuacieacquS/neWtmOeahOWPmOabtFxuICAgKi9cbiAgcHJpdmF0ZSBnZXQgaXNDaGFuZ2VkKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xuICAgIHJldHVybiBCZWZSZXBvc2l0b3J5VXRpbC5pc0V4aXN0VW5zYXZlRGF0YShiZWZSZXBvc2l0b3J5KTtcbiAgfVxufSJdfQ==