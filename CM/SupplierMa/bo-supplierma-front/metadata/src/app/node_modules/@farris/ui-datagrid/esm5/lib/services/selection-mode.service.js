/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { DatagridComponent } from './../datagrid.component';
import { Injectable } from '@angular/core';
import { delay } from 'rxjs/operators';
var SelectionModeService = /** @class */ (function () {
    function SelectionModeService(grid) {
        var _this = this;
        this.dgRef = null;
        this.oldSettings = null;
        this.selectStartEvent = null;
        this.events = null;
        this.dgRef = grid;
        if (this.dgRef.selectionMode === 'default') {
            grid.zone.runOutsideAngular((/**
             * @return {?}
             */
            function () {
                _this.removeEvents();
                _this.events = _this.registerStopSelectionEvent();
            }));
        }
    }
    /**
     * @return {?}
     */
    SelectionModeService.prototype.destroy = /**
     * @return {?}
     */
    function () {
        this.dgRef = null;
        this.removeEvents();
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.removeEvents = /**
     * @return {?}
     */
    function () {
        if (this.events && this.events.length) {
            this.events.forEach((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                e();
            }));
            this.events = null;
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.toggleMode = /**
     * @return {?}
     */
    function () {
        if (this.dgRef) {
            if (this.dgRef.selectionMode === 'default') {
                this.enableWindowsSelectionMode();
            }
            else {
                this.restoreSettings();
            }
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.enableWindowsSelectionMode = /**
     * @return {?}
     */
    function () {
        if (this.dgRef) {
            this.oldSettings = {
                showCheckbox: this.dgRef.showCheckbox,
                keepSelect: this.dgRef.keepSelect,
                onlySelectSelf: this.dgRef.onlySelectSelf,
                selectOnCheck: this.dgRef.selectOnCheck,
                checkOnSelect: this.dgRef.checkOnSelect
            };
            this.dgRef.showCheckbox = true;
            this.dgRef.keepSelect = true;
            this.dgRef.onlySelectSelf = false;
            this.dgRef.selectOnCheck = true;
            this.dgRef.checkOnSelect = true;
            this.dgRef.dfs.updateProperty('keepSelect', true);
            this.dgRef.dfs.updateProperty('onlySelectSelf', false);
            this.dgRef.dfs.updateProperty('selectOnCheck', true);
            this.dgRef.dfs.updateProperty('checkOnSelect', true);
        }
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.restoreSettings = /**
     * @return {?}
     */
    function () {
        if (this.dgRef && this.oldSettings) {
            this.dgRef.showCheckbox = this.oldSettings.showCheckbox;
            this.dgRef.keepSelect = this.oldSettings.keepSelect;
            this.dgRef.onlySelectSelf = this.oldSettings.onlySelectSelf;
            this.dgRef.selectOnCheck = this.oldSettings.selectOnCheck;
            this.dgRef.checkOnSelect = this.oldSettings.checkOnSelect;
            this.dgRef.dfs.updateProperty('keepSelect', this.oldSettings.keepSelect);
            this.dgRef.dfs.updateProperty('onlySelectSelf', this.oldSettings.onlySelectSelf);
            this.dgRef.dfs.updateProperty('selectOnCheck', this.oldSettings.selectOnCheck);
            this.dgRef.dfs.updateProperty('checkOnSelect', this.oldSettings.checkOnSelect);
        }
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.registerStopSelectionEvent = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var kd = this.dgRef.render2.listen(document, 'keydown', (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event.ctrlKey || event.shiftKey) {
                _this.unselectable();
            }
        }));
        /** @type {?} */
        var ku = this.dgRef.render2.listen(document, 'keyup', (/**
         * @param {?} event
         * @return {?}
         */
        function (event) {
            if (event.ctrlKey || event.shiftKey || event.keyCode === 17 || event.keyCode === 16) {
                _this.enableSelectable();
            }
        }));
        return [kd, ku];
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.unselectable = /**
     * @private
     * @return {?}
     */
    function () {
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable', 'on');
        this.dgRef.render2.setAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart', 'return false');
        this.dgRef.render2.setStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select', 'none');
    };
    /**
     * @private
     * @return {?}
     */
    SelectionModeService.prototype.enableSelectable = /**
     * @private
     * @return {?}
     */
    function () {
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'unselectable');
        this.dgRef.render2.removeAttribute(this.dgRef.dgContainer.nativeElement, 'onselectstart');
        this.dgRef.render2.removeStyle(this.dgRef.dgContainer.nativeElement, '-moz-user-select');
    };
    /**
     * @param {?} param
     * @return {?}
     */
    SelectionModeService.prototype.beforRowClick = /**
     * @param {?} param
     * @return {?}
     */
    function (param) {
        var _this = this;
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            /** @type {?} */
            var isSelected = this.dgRef.dfs.isRowSelected(param.id);
            /** @type {?} */
            var isCtrlKey = param.e.ctrlKey;
            /** @type {?} */
            var isShiftKey = param.e.shiftKey;
            this.dgRef.endEditing();
            if (!isCtrlKey && !isShiftKey) {
                if (!isSelected) {
                    this.dgRef.clearCheckeds();
                }
                else {
                    // 如果有多条选，移除其他选中行
                    /** @type {?} */
                    var currentPagerIds_1 = this.dgRef.getRows().map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n.id; }));
                    /** @type {?} */
                    var unCheckIDs = this.dgRef.checkValues.filter((/**
                     * @param {?} i
                     * @return {?}
                     */
                    function (i) { return currentPagerIds_1.includes(i) && i != param.id; }));
                    /** @type {?} */
                    var unSelectIds = this.dgRef.checkValues.filter((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return !currentPagerIds_1.includes(n); }));
                    // const unCheckIDs = this.dgRef.checkValues.filter(n => n != param.id);
                    if (unCheckIDs && unCheckIDs.length) {
                        this.dgRef.unCheckRows(unCheckIDs, true);
                        this.dgRef.clearSelections(tslib_1.__spread([param.id], unSelectIds));
                    }
                }
            }
            else {
                if (isShiftKey) {
                    /** @type {?} */
                    var focusIndex = this.dgRef.focusRowIndex;
                    if (focusIndex === -1) {
                        focusIndex = 0;
                    }
                    /** @type {?} */
                    var endIndex = param.rowIndex;
                    /** @type {?} */
                    var start = focusIndex;
                    /** @type {?} */
                    var end = endIndex;
                    if (focusIndex > endIndex) {
                        start = endIndex;
                        end = focusIndex;
                    }
                    /** @type {?} */
                    var data = this.dgRef.getRows();
                    /** @type {?} */
                    var checkedItems = tslib_1.__spread(data).splice(start, end - start + 1);
                    /** @type {?} */
                    var willCheckIds = checkedItems.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) {
                        return _this.dgRef.dfs.primaryId(n);
                    }));
                    if (!isCtrlKey) {
                        this.dgRef.clearCheckeds(false, false);
                    }
                    // this.dgRef.selectValues = willCheckIds;
                    this.dgRef.checkRows(willCheckIds, true);
                    return true;
                }
            }
            if (isSelected && isCtrlKey) {
                param.e.stopPropagation();
                // 执行取消选择
                this.dgRef.unCheckRow(param.id);
                return true;
            }
            this.dgRef.beforeSelect(param).pipe(delay(100)).subscribe((/**
             * @param {?} canSelect
             * @return {?}
             */
            function (canSelect) {
                if (canSelect) {
                    _this.dgRef.dfs.selectRow(param.rowIndex, param.rowData);
                    if (_this.dgRef.selectedRow) {
                        _this.dgRef.selectedRow.dr = param.dr;
                    }
                }
                _this.dgRef.rowClick.emit({ data: param.rowData, grid: _this.dgRef, dblclick: false });
                _this.dgRef.dgs.setSelecedRow.emit({ selected: true, id: _this.dgRef.dfs.primaryId(param.rowData) });
            }));
            return true;
        }
        return false;
    };
    /**
     * @return {?}
     */
    SelectionModeService.prototype.endRowClick = /**
     * @return {?}
     */
    function () {
        if (this.dgRef && this.dgRef.selectionMode === 'default') {
            this.dgRef.checkOnSelect = false;
        }
    };
    SelectionModeService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    SelectionModeService.ctorParameters = function () { return [
        { type: DatagridComponent }
    ]; };
    return SelectionModeService;
}());
export { SelectionModeService };
if (false) {
    /** @type {?} */
    SelectionModeService.prototype.dgRef;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.oldSettings;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.selectStartEvent;
    /**
     * @type {?}
     * @private
     */
    SelectionModeService.prototype.events;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1vZGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvc2VsZWN0aW9uLW1vZGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZDO0lBTUksOEJBQVksSUFBdUI7UUFBbkMsaUJBUUM7UUFaRCxVQUFLLEdBQXNCLElBQUksQ0FBQztRQUN4QixnQkFBVyxHQUFRLElBQUksQ0FBQztRQUN4QixxQkFBZ0IsR0FBUSxJQUFJLENBQUM7UUFDN0IsV0FBTSxHQUFHLElBQUksQ0FBQztRQUVsQixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQztRQUNsQixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxLQUFLLFNBQVMsRUFBRTtZQUN4QyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQjs7O1lBQUM7Z0JBQ3hCLEtBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDcEIsS0FBSSxDQUFDLE1BQU0sR0FBRyxLQUFJLENBQUMsMEJBQTBCLEVBQUUsQ0FBQztZQUNwRCxDQUFDLEVBQUMsQ0FBQztTQUNOO0lBQ0wsQ0FBQzs7OztJQUVELHNDQUFPOzs7SUFBUDtRQUNJLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN4QixDQUFDOzs7O0lBRUQsMkNBQVk7OztJQUFaO1FBQ0ksSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFO1lBQ25DLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTzs7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QU8sQ0FBQyxDQUFDO29CQUN4RCxJQUFJLEtBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFO3dCQUN4QixLQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLEdBQUcsS0FBSyxDQUFDLEVBQUUsQ0FBQztxQkFDeEM7aUJBQ0o7Z0JBQ0QsS0FBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUksQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7Z0JBQ3JGLEtBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2RyxDQUFDLEVBQUMsQ0FBQztZQUVILE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDOzs7O0lBRUQsMENBQVc7OztJQUFYO1FBQ0ksSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxLQUFLLFNBQVMsRUFBRTtZQUN0RCxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsR0FBRyxLQUFLLENBQUM7U0FDcEM7SUFDTCxDQUFDOztnQkE3TEosVUFBVTs7OztnQkFKRixpQkFBaUI7O0lBa00xQiwyQkFBQztDQUFBLEFBOUxELElBOExDO1NBN0xZLG9CQUFvQjs7O0lBQzdCLHFDQUFnQzs7Ozs7SUFDaEMsMkNBQWdDOzs7OztJQUNoQyxnREFBcUM7Ozs7O0lBQ3JDLHNDQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGRlbGF5IH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgU2VsZWN0aW9uTW9kZVNlcnZpY2Uge1xyXG4gICAgZGdSZWY6IERhdGFncmlkQ29tcG9uZW50ID0gbnVsbDtcclxuICAgIHByaXZhdGUgb2xkU2V0dGluZ3M6IGFueSA9IG51bGw7XHJcbiAgICBwcml2YXRlIHNlbGVjdFN0YXJ0RXZlbnQ6IGFueSA9IG51bGw7XHJcbiAgICBwcml2YXRlIGV2ZW50cyA9IG51bGw7XHJcbiAgICBjb25zdHJ1Y3RvcihncmlkOiBEYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYgPSBncmlkO1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICBncmlkLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudHMoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZXZlbnRzID0gdGhpcy5yZWdpc3RlclN0b3BTZWxlY3Rpb25FdmVudCgpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLmRnUmVmID0gbnVsbDtcclxuICAgICAgICB0aGlzLnJlbW92ZUV2ZW50cygpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUV2ZW50cygpIHtcclxuICAgICAgICBpZiAodGhpcy5ldmVudHMgJiYgdGhpcy5ldmVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnRzLmZvckVhY2goZSA9PiB7XHJcbiAgICAgICAgICAgICAgICBlKCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ldmVudHMgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdG9nZ2xlTW9kZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZikge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZ1JlZi5zZWxlY3Rpb25Nb2RlID09PSAnZGVmYXVsdCcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW5hYmxlV2luZG93c1NlbGVjdGlvbk1vZGUoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVzdG9yZVNldHRpbmdzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGVuYWJsZVdpbmRvd3NTZWxlY3Rpb25Nb2RlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMub2xkU2V0dGluZ3MgPSB7XHJcbiAgICAgICAgICAgICAgICBzaG93Q2hlY2tib3g6IHRoaXMuZGdSZWYuc2hvd0NoZWNrYm94LFxyXG4gICAgICAgICAgICAgICAga2VlcFNlbGVjdDogdGhpcy5kZ1JlZi5rZWVwU2VsZWN0LFxyXG4gICAgICAgICAgICAgICAgb25seVNlbGVjdFNlbGY6IHRoaXMuZGdSZWYub25seVNlbGVjdFNlbGYsXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RPbkNoZWNrOiB0aGlzLmRnUmVmLnNlbGVjdE9uQ2hlY2ssXHJcbiAgICAgICAgICAgICAgICBjaGVja09uU2VsZWN0OiB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3RcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuc2hvd0NoZWNrYm94ID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5rZWVwU2VsZWN0ID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5vbmx5U2VsZWN0U2VsZiA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLnNlbGVjdE9uQ2hlY2sgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3QgPSB0cnVlO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2tlZXBTZWxlY3QnLCB0cnVlKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ29ubHlTZWxlY3RTZWxmJywgZmFsc2UpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnc2VsZWN0T25DaGVjaycsIHRydWUpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnY2hlY2tPblNlbGVjdCcsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgcmVzdG9yZVNldHRpbmdzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmICYmIHRoaXMub2xkU2V0dGluZ3MpIHtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zaG93Q2hlY2tib3ggPSB0aGlzLm9sZFNldHRpbmdzLnNob3dDaGVja2JveDtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5rZWVwU2VsZWN0ID0gdGhpcy5vbGRTZXR0aW5ncy5rZWVwU2VsZWN0O1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLm9ubHlTZWxlY3RTZWxmID0gdGhpcy5vbGRTZXR0aW5ncy5vbmx5U2VsZWN0U2VsZjtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5zZWxlY3RPbkNoZWNrID0gdGhpcy5vbGRTZXR0aW5ncy5zZWxlY3RPbkNoZWNrO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3QgPSB0aGlzLm9sZFNldHRpbmdzLmNoZWNrT25TZWxlY3Q7XHJcblxyXG5cclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ2tlZXBTZWxlY3QnLCB0aGlzLm9sZFNldHRpbmdzLmtlZXBTZWxlY3QpO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnb25seVNlbGVjdFNlbGYnLCB0aGlzLm9sZFNldHRpbmdzLm9ubHlTZWxlY3RTZWxmKTtcclxuICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMudXBkYXRlUHJvcGVydHkoJ3NlbGVjdE9uQ2hlY2snLCB0aGlzLm9sZFNldHRpbmdzLnNlbGVjdE9uQ2hlY2spO1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmRmcy51cGRhdGVQcm9wZXJ0eSgnY2hlY2tPblNlbGVjdCcsIHRoaXMub2xkU2V0dGluZ3MuY2hlY2tPblNlbGVjdCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIHJlZ2lzdGVyU3RvcFNlbGVjdGlvbkV2ZW50KCkge1xyXG4gICAgICAgIGNvbnN0IGtkID0gdGhpcy5kZ1JlZi5yZW5kZXIyLmxpc3Rlbihkb2N1bWVudCwgJ2tleWRvd24nLCAoZXZlbnQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5zaGlmdEtleSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51bnNlbGVjdGFibGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBjb25zdCBrdSA9IHRoaXMuZGdSZWYucmVuZGVyMi5saXN0ZW4oZG9jdW1lbnQsICdrZXl1cCcsIChldmVudDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChldmVudC5jdHJsS2V5IHx8IGV2ZW50LnNoaWZ0S2V5IHx8IGV2ZW50LmtleUNvZGUgPT09IDE3IHx8IGV2ZW50LmtleUNvZGUgPT09IDE2KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZVNlbGVjdGFibGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gWyBrZCwga3VdO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdW5zZWxlY3RhYmxlKCkge1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5zZXRBdHRyaWJ1dGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAndW5zZWxlY3RhYmxlJywgJ29uJyk7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnNldEF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICdvbnNlbGVjdHN0YXJ0JywgJ3JldHVybiBmYWxzZScpO1xyXG4gICAgICAgIHRoaXMuZGdSZWYucmVuZGVyMi5zZXRTdHlsZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICctbW96LXVzZXItc2VsZWN0JywgJ25vbmUnKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGVuYWJsZVNlbGVjdGFibGUoKSB7XHJcbiAgICAgICAgdGhpcy5kZ1JlZi5yZW5kZXIyLnJlbW92ZUF0dHJpYnV0ZSh0aGlzLmRnUmVmLmRnQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICd1bnNlbGVjdGFibGUnKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIucmVtb3ZlQXR0cmlidXRlKHRoaXMuZGdSZWYuZGdDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ29uc2VsZWN0c3RhcnQnKTtcclxuICAgICAgICB0aGlzLmRnUmVmLnJlbmRlcjIucmVtb3ZlU3R5bGUodGhpcy5kZ1JlZi5kZ0NvbnRhaW5lci5uYXRpdmVFbGVtZW50LCAnLW1vei11c2VyLXNlbGVjdCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGJlZm9yUm93Q2xpY2socGFyYW06IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnUmVmICYmIHRoaXMuZGdSZWYuc2VsZWN0aW9uTW9kZSA9PT0gJ2RlZmF1bHQnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGlzU2VsZWN0ZWQgPSB0aGlzLmRnUmVmLmRmcy5pc1Jvd1NlbGVjdGVkKHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgY29uc3QgaXNDdHJsS2V5ID0gcGFyYW0uZS5jdHJsS2V5O1xyXG4gICAgICAgICAgICBjb25zdCBpc1NoaWZ0S2V5ID0gcGFyYW0uZS5zaGlmdEtleTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuZW5kRWRpdGluZygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKCFpc0N0cmxLZXkgJiYgIWlzU2hpZnRLZXkpIHtcclxuICAgICAgICAgICAgICAgIGlmICghaXNTZWxlY3RlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2xlYXJDaGVja2VkcygpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDlpoLmnpzmnInlpJrmnaHpgInvvIznp7vpmaTlhbbku5bpgInkuK3ooYxcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50UGFnZXJJZHMgPSB0aGlzLmRnUmVmLmdldFJvd3MoKS5tYXAobiA9PiBuLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB1bkNoZWNrSURzID0gdGhpcy5kZ1JlZi5jaGVja1ZhbHVlcy5maWx0ZXIoaSA9PiBjdXJyZW50UGFnZXJJZHMuaW5jbHVkZXMoaSkgJiYgaSAhPSBwYXJhbS5pZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5TZWxlY3RJZHMgPSB0aGlzLmRnUmVmLmNoZWNrVmFsdWVzLmZpbHRlcihuID0+ICFjdXJyZW50UGFnZXJJZHMuaW5jbHVkZXMobikpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IHVuQ2hlY2tJRHMgPSB0aGlzLmRnUmVmLmNoZWNrVmFsdWVzLmZpbHRlcihuID0+IG4gIT0gcGFyYW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1bkNoZWNrSURzICYmIHVuQ2hlY2tJRHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYudW5DaGVja1Jvd3ModW5DaGVja0lEcywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2xlYXJTZWxlY3Rpb25zKFtwYXJhbS5pZCwgLi4udW5TZWxlY3RJZHNdKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoaXNTaGlmdEtleSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBmb2N1c0luZGV4ID0gdGhpcy5kZ1JlZi5mb2N1c1Jvd0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb2N1c0luZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb2N1c0luZGV4ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZEluZGV4ID0gcGFyYW0ucm93SW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0ID0gZm9jdXNJbmRleDtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgZW5kID0gZW5kSW5kZXg7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvY3VzSW5kZXggPiBlbmRJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IGVuZEluZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBmb2N1c0luZGV4O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZGdSZWYuZ2V0Um93cygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoZWNrZWRJdGVtcyA9IFsuLi5kYXRhXS5zcGxpY2Uoc3RhcnQsIGVuZCAtIHN0YXJ0ICsgMSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2lsbENoZWNrSWRzID0gY2hlY2tlZEl0ZW1zLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGdSZWYuZGZzLnByaW1hcnlJZChuKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpc0N0cmxLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5jbGVhckNoZWNrZWRzKGZhbHNlLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuZGdSZWYuc2VsZWN0VmFsdWVzID0gd2lsbENoZWNrSWRzO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGdSZWYuY2hlY2tSb3dzKHdpbGxDaGVja0lkcywgdHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChpc1NlbGVjdGVkICYmIGlzQ3RybEtleSkge1xyXG4gICAgICAgICAgICAgICAgcGFyYW0uZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIC8vIOaJp+ihjOWPlua2iOmAieaLqVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi51bkNoZWNrUm93KHBhcmFtLmlkKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuZGdSZWYuYmVmb3JlU2VsZWN0KHBhcmFtKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgZGVsYXkoMTAwKVxyXG4gICAgICAgICAgICApLnN1YnNjcmliZSgoY2FuU2VsZWN0OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY2FuU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZnMuc2VsZWN0Um93KHBhcmFtLnJvd0luZGV4LCBwYXJhbS5yb3dEYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kZ1JlZi5zZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRnUmVmLnNlbGVjdGVkUm93LmRyID0gcGFyYW0uZHI7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5yb3dDbGljay5lbWl0KHsgZGF0YTogcGFyYW0ucm93RGF0YSwgZ3JpZDogdGhpcy5kZ1JlZiwgZGJsY2xpY2s6IGZhbHNlIH0pO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZ1JlZi5kZ3Muc2V0U2VsZWNlZFJvdy5lbWl0KHsgc2VsZWN0ZWQ6IHRydWUsIGlkOiB0aGlzLmRnUmVmLmRmcy5wcmltYXJ5SWQocGFyYW0ucm93RGF0YSkgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBlbmRSb3dDbGljaygpIHtcclxuICAgICAgICBpZiAodGhpcy5kZ1JlZiAmJiB0aGlzLmRnUmVmLnNlbGVjdGlvbk1vZGUgPT09ICdkZWZhdWx0Jykge1xyXG4gICAgICAgICAgICB0aGlzLmRnUmVmLmNoZWNrT25TZWxlY3QgPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==