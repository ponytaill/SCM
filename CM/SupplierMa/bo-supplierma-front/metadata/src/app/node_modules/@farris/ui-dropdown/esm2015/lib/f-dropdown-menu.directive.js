/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, HostBinding, ElementRef, Input, } from "@angular/core";
import { OverLayHiddenService } from "@farris/ui-common";
import { FDropdownDirective } from "./f-dropdown.directive";
export class FDropdownMenuDirective {
    /**
     * @param {?} elementRef
     * @param {?} dropdown
     */
    constructor(elementRef, dropdown) {
        this.elementRef = elementRef;
        this.dropdown = dropdown;
        this._docRect = { width: 0, height: 0 };
        this.showDropdownMenu = true;
        // 内部使用，在不变更依赖的情况下，触发改变
        this.dpIsOpen = false;
        this.overLayService = null;
        this.overLayService = new OverLayHiddenService();
        this.dropdown.getOpenState().subscribe((/**
         * @param {?} state
         * @return {?}
         */
        (state) => {
            /** @type {?} */
            const ddmel = this.dropdown.getNativeElement();
            this.dpIsOpen = this.dropdown.isOpen;
            if (this.dpIsOpen) {
                // 注册鼠标滚轮，点击事件，用于隐藏Panel
                this.overLayService.registerMouseEvent(ddmel, (/**
                 * @param {?} e
                 * @return {?}
                 */
                (e) => {
                    /** @type {?} */
                    const tar = (/** @type {?} */ (e.target));
                    /** @type {?} */
                    var classList = Array.from(tar.classList || []);
                    if (tar.className.indexOf('dropdown-toggle') > -1 || tar.closest('.dropdown-item') || classList.includes("dropdown-item")) {
                        return;
                    }
                    this.dpIsOpen = false;
                    this.openStateChange();
                }));
            }
            else {
                this.overLayService.destory(ddmel);
            }
            this.openStateChange();
        }));
    }
    /**
     * @return {?}
     */
    ngAfterViewChecked() { }
    /**
     * @private
     * @param {?} pment
     * @return {?}
     */
    getRealPlacement(pment) {
        /** @type {?} */
        var result = "bottom-right";
        switch (pment) {
            case "top":
                result = "top-right";
                break;
            case "left":
                result = "left-bottom";
                break;
            case "right":
                result = "right-bottom";
                break;
            case "bottom":
                result = "bottom-right";
                break;
            default:
                result = pment;
        }
        return result;
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
    }
    /**
     * @private
     * @return {?}
     */
    openStateChange() {
        if (this.dpIsOpen) {
            if (this.elementRef.nativeElement.className.indexOf("show") < 0) {
                document.body.style.overflow = 'hidden';
                this.elementRef.nativeElement.style.visibility = 'hidden';
                this.elementRef.nativeElement.className += " show";
                if (this.dropdown.needToCalculate()) {
                    this._docRect = this.dropdown.getRectifyReferenceEl();
                }
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    this.changeDirection();
                    document.body.style.overflow = '';
                    this.elementRef.nativeElement.style.visibility = 'visible';
                }), 0);
            }
        }
        else {
            if (this.elementRef.nativeElement.className.indexOf("show") > -1) {
                this.elementRef.nativeElement.className = this.elementRef.nativeElement.className.replace(' show', ' ');
                this.elementRef.nativeElement.style.cssText = '';
            }
            this.dropdown['_internalOpen'] = false;
        }
    }
    /**
     * @private
     * @return {?}
     */
    changeDirection() {
        // if (this.dropdown.needToCalculate()) {
        //     const rect = this.elementRef.nativeElement.getBoundingClientRect();
        //     let placement = this.dropdown.placement;
        //     let newplacement = this.getRealPlacement(placement);
        //     placement = newplacement;
        //     //
        //     if (
        //         newplacement.indexOf("right") > -1 &&
        //         rect.right > this._docRect.width
        //     ) {
        //         placement = placement.replace("right", "left");
        //     }
        //     if (
        //         newplacement.indexOf("left") > -1 &&
        //         rect.left - rect.width < 0
        //     ) {
        //         placement = placement.replace("left", "right");
        //     }
        //     if (
        //         newplacement.indexOf("bottom") > -1 &&
        //         rect.bottom > this._docRect.height
        //     ) {
        //         placement = placement.replace("down", "up");
        //     }
        //     if (
        //         newplacement.indexOf("up") > -1 &&
        //         rect.bottom - rect.height < 0
        //     ) {
        //         placement = placement.replace("up", "bottom");
        //     }
        //     if (newplacement !== this.dropdown.placement) {
        //         this.dropdown.placement = newplacement;
        //     }
        //     if (placement !== newplacement) {
        //         this.dropdown.placement = placement;
        //     }
        //     this.dropdown.resetCalculate(false);
        // }
        this.setMenuPanelPosition();
    }
    /**
     * @private
     * @return {?}
     */
    issubMenu() {
        /** @type {?} */
        const dd = this.dropdown.getNativeElement();
        return dd.className.indexOf('dropdown-submenu') > -1 || dd.closest('.dropdown-submenu');
    }
    /**
     * @private
     * @return {?}
     */
    setMenuPanelPosition() {
        /** @type {?} */
        const parentMenuPanel = this.dropdown.getNativeElement();
        const { height, left, top, width } = parentMenuPanel.getBoundingClientRect();
        const { width: pw, height: ph } = this.elementRef.nativeElement.getBoundingClientRect();
        /** @type {?} */
        let _top = top + height;
        /** @type {?} */
        let _left = left;
        if (window.innerHeight - top - height < ph) {
            _top = top - ph;
        }
        if (window.innerWidth - left - width < pw) {
            _left = left - pw + width;
        }
        if (!this.issubMenu()) {
            document.body.append(this.elementRef.nativeElement);
            this.dropdown.appendMenuEl(this.elementRef.nativeElement);
            this.elementRef.nativeElement.style.cssText = `position:fixed;bottom:unset;left:${_left}px !important;top:${_top}px !important;right: unset;z-index: 100000;`;
            // if (this.elementRef.nativeElement.classList.contains('solution-header-title-menu')) {
            //     this.elementRef.nativeElement.classList.add('query-solution');
            // }
            // const solutionBtns = this.elementRef.nativeElement.querySelector('.solution-header-dropdown-item-btns');
            // if (solutionBtns && !solutionBtns.classList.contains('dropdown-item')) {
            //     solutionBtns.classList.add('dropdown-item');
            // }
        }
        else {
            /** @type {?} */
            const childContainerWidth = window.innerWidth - left - parentMenuPanel.offsetWidth;
            /** @type {?} */
            const childMenuPanel = this.elementRef.nativeElement;
            if (childMenuPanel.offsetWidth > childContainerWidth) {
                /** @type {?} */
                const l = -parentMenuPanel.offsetWidth + 16;
                childMenuPanel.style.left = l + 'px';
            }
            /** @type {?} */
            const childContainerHeight = window.innerHeight - childMenuPanel.getBoundingClientRect().top;
            if (childContainerHeight < childMenuPanel.offsetHeight) {
                /** @type {?} */
                const t = window.innerHeight - top - childMenuPanel.offsetHeight - 10;
                childMenuPanel.style.top = t + 'px';
            }
        }
    }
}
FDropdownMenuDirective.decorators = [
    { type: Directive, args: [{
                selector: "[fDropdownMenu]",
            },] }
];
/** @nocollapse */
FDropdownMenuDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: FDropdownDirective }
];
FDropdownMenuDirective.propDecorators = {
    showDropdownMenu: [{ type: HostBinding, args: ["class.dropdown-menu",] }],
    dpIsOpen: [{ type: Input }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype._docRect;
    /** @type {?} */
    FDropdownMenuDirective.prototype.showDropdownMenu;
    /** @type {?} */
    FDropdownMenuDirective.prototype.dpIsOpen;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.overLayService;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.elementRef;
    /**
     * @type {?}
     * @private
     */
    FDropdownMenuDirective.prototype.dropdown;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZi1kcm9wZG93bi1tZW51LmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZHJvcGRvd24vIiwic291cmNlcyI6WyJsaWIvZi1kcm9wZG93bi1tZW51LmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxXQUFXLEVBRVgsVUFBVSxFQUVWLEtBQUssR0FFUixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUs1RCxNQUFNLE9BQU8sc0JBQXNCOzs7OztJQU0vQixZQUFvQixVQUFzQixFQUFVLFFBQTRCO1FBQTVELGVBQVUsR0FBVixVQUFVLENBQVk7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFvQjtRQUx4RSxhQUFRLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUNQLHFCQUFnQixHQUFHLElBQUksQ0FBQzs7UUFFbkQsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNsQixtQkFBYyxHQUF5QixJQUFJLENBQUM7UUFFaEQsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLG9CQUFvQixFQUFFLENBQUM7UUFFakQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxTQUFTOzs7O1FBQUMsQ0FBQyxLQUFjLEVBQUUsRUFBRTs7a0JBQ2hELEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixFQUFFO1lBQzlDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7WUFDckMsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNmLHdCQUF3QjtnQkFDeEIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLOzs7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YUFBYTtZQUNwRCxJQUFJLGNBQWMsQ0FBQyxXQUFXLEdBQUcsbUJBQW1CLEVBQUU7O3NCQUM1QyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsV0FBVyxHQUFHLEVBQUU7Z0JBQzNDLGNBQWMsQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDeEM7O2tCQUVLLG9CQUFvQixHQUFHLE1BQU0sQ0FBQyxXQUFXLEdBQUcsY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUMsR0FBRztZQUM1RixJQUFJLG9CQUFvQixHQUFHLGNBQWMsQ0FBQyxZQUFZLEVBQUU7O3NCQUM5QyxDQUFDLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLEdBQUcsY0FBYyxDQUFDLFlBQVksR0FBRyxFQUFFO2dCQUNyRSxjQUFjLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDO2FBQ3ZDO1NBQ0o7SUFDTCxDQUFDOzs7WUFuTEosU0FBUyxTQUFDO2dCQUNQLFFBQVEsRUFBRSxpQkFBaUI7YUFDOUI7Ozs7WUFWRyxVQUFVO1lBTUwsa0JBQWtCOzs7K0JBT3RCLFdBQVcsU0FBQyxxQkFBcUI7dUJBRWpDLEtBQUs7Ozs7Ozs7SUFITiwwQ0FBMkM7O0lBQzNDLGtEQUE0RDs7SUFFNUQsMENBQTBCOzs7OztJQUMxQixnREFBb0Q7Ozs7O0lBQ3hDLDRDQUE4Qjs7Ozs7SUFBRSwwQ0FBb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgRGlyZWN0aXZlLFxyXG4gICAgSG9zdEJpbmRpbmcsXHJcbiAgICBBZnRlclZpZXdDaGVja2VkLFxyXG4gICAgRWxlbWVudFJlZixcclxuICAgIE9wdGlvbmFsLFxyXG4gICAgSW5wdXQsXHJcbiAgICBPbkRlc3Ryb3ksXHJcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgT3ZlckxheUhpZGRlblNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1jb21tb25cIjtcclxuaW1wb3J0IHsgRkRyb3Bkb3duRGlyZWN0aXZlIH0gZnJvbSBcIi4vZi1kcm9wZG93bi5kaXJlY3RpdmVcIjtcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6IFwiW2ZEcm9wZG93bk1lbnVdXCIsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGRHJvcGRvd25NZW51RGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3Q2hlY2tlZCwgT25EZXN0cm95IHtcclxuICAgIHByaXZhdGUgX2RvY1JlY3QgPSB7IHdpZHRoOiAwLCBoZWlnaHQ6IDAgfTtcclxuICAgIEBIb3N0QmluZGluZyhcImNsYXNzLmRyb3Bkb3duLW1lbnVcIikgc2hvd0Ryb3Bkb3duTWVudSA9IHRydWU7XHJcbiAgICAvLyDlhoXpg6jkvb/nlKjvvIzlnKjkuI3lj5jmm7Tkvp3otZbnmoTmg4XlhrXkuIvvvIzop6blj5HmlLnlj5hcclxuICAgIEBJbnB1dCgpIGRwSXNPcGVuID0gZmFsc2U7XHJcbiAgICBwcml2YXRlIG92ZXJMYXlTZXJ2aWNlOiBPdmVyTGF5SGlkZGVuU2VydmljZSA9IG51bGw7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIHByaXZhdGUgZHJvcGRvd246IEZEcm9wZG93bkRpcmVjdGl2ZSApIHtcclxuICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlID0gbmV3IE92ZXJMYXlIaWRkZW5TZXJ2aWNlKCk7XHJcblxyXG4gICAgICAgIHRoaXMuZHJvcGRvd24uZ2V0T3BlblN0YXRlKCkuc3Vic2NyaWJlKChzdGF0ZTogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkZG1lbCA9IHRoaXMuZHJvcGRvd24uZ2V0TmF0aXZlRWxlbWVudCgpOyAgICBcclxuICAgICAgICAgICAgdGhpcy5kcElzT3BlbiA9IHRoaXMuZHJvcGRvd24uaXNPcGVuO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kcElzT3Blbikge1xyXG4gICAgICAgICAgICAgICAgLy8g5rOo5YaM6byg5qCH5rua6L2u77yM54K55Ye75LqL5Lu277yM55So5LqO6ZqQ6JePUGFuZWxcclxuICAgICAgICAgICAgICAgIHRoaXMub3ZlckxheVNlcnZpY2UucmVnaXN0ZXJNb3VzZUV2ZW50KGRkbWVsLCAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhciA9IGUudGFyZ2V0IGFzIGFueTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY2xhc3NMaXN0ID0gQXJyYXkuZnJvbSh0YXIuY2xhc3NMaXN0IHx8IFtdKTtcclxuICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0YXIuY2xhc3NOYW1lLmluZGV4T2YoJ2Ryb3Bkb3duLXRvZ2dsZScpID4gLTEgfHwgdGFyLmNsb3Nlc3QoJy5kcm9wZG93bi1pdGVtJykgfHwgY2xhc3NMaXN0LmluY2x1ZGVzKFwiZHJvcGRvd24taXRlbVwiKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZHBJc09wZW4gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5TdGF0ZUNoYW5nZSgpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlLmRlc3RvcnkoZGRtZWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMub3BlblN0YXRlQ2hhbmdlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBuZ0FmdGVyVmlld0NoZWNrZWQoKSB7fVxyXG4gICAgcHJpdmF0ZSBnZXRSZWFsUGxhY2VtZW50KHBtZW50KSB7XHJcbiAgICAgICAgdmFyIHJlc3VsdCA9IFwiYm90dG9tLXJpZ2h0XCI7XHJcbiAgICAgICAgc3dpdGNoIChwbWVudCkge1xyXG4gICAgICAgICAgICBjYXNlIFwidG9wXCI6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBcInRvcC1yaWdodFwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJsZWZ0XCI6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBcImxlZnQtYm90dG9tXCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgY2FzZSBcInJpZ2h0XCI6XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBcInJpZ2h0LWJvdHRvbVwiO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIGNhc2UgXCJib3R0b21cIjpcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IFwiYm90dG9tLXJpZ2h0XCI7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IHBtZW50O1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb3BlblN0YXRlQ2hhbmdlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRwSXNPcGVuKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5kZXhPZihcInNob3dcIikgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93ID0gJ2hpZGRlbic7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgKz0gXCIgc2hvd1wiO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZHJvcGRvd24ubmVlZFRvQ2FsY3VsYXRlKCkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9kb2NSZWN0ID0gdGhpcy5kcm9wZG93bi5nZXRSZWN0aWZ5UmVmZXJlbmNlRWwoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2hhbmdlRGlyZWN0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdyA9ICcnO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7XHJcbiAgICAgICAgICAgICAgICB9LCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5kZXhPZihcInNob3dcIikgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLnJlcGxhY2UoJyBzaG93JywnICcpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuc3R5bGUuY3NzVGV4dCA9ICcnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRyb3Bkb3duWydfaW50ZXJuYWxPcGVuJ10gPSBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGNoYW5nZURpcmVjdGlvbigpIHtcclxuICAgICAgICAvLyBpZiAodGhpcy5kcm9wZG93bi5uZWVkVG9DYWxjdWxhdGUoKSkge1xyXG4gICAgICAgIC8vICAgICBjb25zdCByZWN0ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgLy8gICAgIGxldCBwbGFjZW1lbnQgPSB0aGlzLmRyb3Bkb3duLnBsYWNlbWVudDtcclxuICAgICAgICAvLyAgICAgbGV0IG5ld3BsYWNlbWVudCA9IHRoaXMuZ2V0UmVhbFBsYWNlbWVudChwbGFjZW1lbnQpO1xyXG4gICAgICAgIC8vICAgICBwbGFjZW1lbnQgPSBuZXdwbGFjZW1lbnQ7XHJcbiAgICAgICAgLy8gICAgIC8vXHJcbiAgICAgICAgLy8gICAgIGlmIChcclxuICAgICAgICAvLyAgICAgICAgIG5ld3BsYWNlbWVudC5pbmRleE9mKFwicmlnaHRcIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5yaWdodCA+IHRoaXMuX2RvY1JlY3Qud2lkdGhcclxuICAgICAgICAvLyAgICAgKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBwbGFjZW1lbnQgPSBwbGFjZW1lbnQucmVwbGFjZShcInJpZ2h0XCIsIFwibGVmdFwiKTtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAoXHJcbiAgICAgICAgLy8gICAgICAgICBuZXdwbGFjZW1lbnQuaW5kZXhPZihcImxlZnRcIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5sZWZ0IC0gcmVjdC53aWR0aCA8IDBcclxuICAgICAgICAvLyAgICAgKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBwbGFjZW1lbnQgPSBwbGFjZW1lbnQucmVwbGFjZShcImxlZnRcIiwgXCJyaWdodFwiKTtcclxuICAgICAgICAvLyAgICAgfVxyXG5cclxuICAgICAgICAvLyAgICAgaWYgKFxyXG4gICAgICAgIC8vICAgICAgICAgbmV3cGxhY2VtZW50LmluZGV4T2YoXCJib3R0b21cIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5ib3R0b20gPiB0aGlzLl9kb2NSZWN0LmhlaWdodFxyXG4gICAgICAgIC8vICAgICApIHtcclxuICAgICAgICAvLyAgICAgICAgIHBsYWNlbWVudCA9IHBsYWNlbWVudC5yZXBsYWNlKFwiZG93blwiLCBcInVwXCIpO1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gICAgIGlmIChcclxuICAgICAgICAvLyAgICAgICAgIG5ld3BsYWNlbWVudC5pbmRleE9mKFwidXBcIikgPiAtMSAmJlxyXG4gICAgICAgIC8vICAgICAgICAgcmVjdC5ib3R0b20gLSByZWN0LmhlaWdodCA8IDBcclxuICAgICAgICAvLyAgICAgKSB7XHJcbiAgICAgICAgLy8gICAgICAgICBwbGFjZW1lbnQgPSBwbGFjZW1lbnQucmVwbGFjZShcInVwXCIsIFwiYm90dG9tXCIpO1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gICAgIGlmIChuZXdwbGFjZW1lbnQgIT09IHRoaXMuZHJvcGRvd24ucGxhY2VtZW50KSB7XHJcbiAgICAgICAgLy8gICAgICAgICB0aGlzLmRyb3Bkb3duLnBsYWNlbWVudCA9IG5ld3BsYWNlbWVudDtcclxuICAgICAgICAvLyAgICAgfVxyXG4gICAgICAgIC8vICAgICBpZiAocGxhY2VtZW50ICE9PSBuZXdwbGFjZW1lbnQpIHtcclxuICAgICAgICAvLyAgICAgICAgIHRoaXMuZHJvcGRvd24ucGxhY2VtZW50ID0gcGxhY2VtZW50O1xyXG4gICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgLy8gICAgIHRoaXMuZHJvcGRvd24ucmVzZXRDYWxjdWxhdGUoZmFsc2UpO1xyXG4gICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgdGhpcy5zZXRNZW51UGFuZWxQb3NpdGlvbigpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGlzc3ViTWVudSgpIHtcclxuICAgICAgICBjb25zdCBkZCA9IHRoaXMuZHJvcGRvd24uZ2V0TmF0aXZlRWxlbWVudCgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIHJldHVybiBkZC5jbGFzc05hbWUuaW5kZXhPZignZHJvcGRvd24tc3VibWVudScpID4gLTEgfHwgZGQuY2xvc2VzdCgnLmRyb3Bkb3duLXN1Ym1lbnUnKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBzZXRNZW51UGFuZWxQb3NpdGlvbigpIHtcclxuICAgICAgICBjb25zdCBwYXJlbnRNZW51UGFuZWwgPSAgdGhpcy5kcm9wZG93bi5nZXROYXRpdmVFbGVtZW50KCk7XHJcbiAgICAgICAgY29uc3QgeyBoZWlnaHQsIGxlZnQsIHRvcCwgd2lkdGggfSA9IHBhcmVudE1lbnVQYW5lbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBjb25zdCB7IHdpZHRoOiBwdywgaGVpZ2h0OiBwaCB9ID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcblxyXG4gICAgICAgIGxldCBfdG9wID0gdG9wICsgaGVpZ2h0O1xyXG4gICAgICAgIGxldCBfbGVmdCA9IGxlZnQ7XHJcbiAgICAgICAgaWYgKHdpbmRvdy5pbm5lckhlaWdodCAtIHRvcCAtIGhlaWdodCA8IHBoKSB7XHJcbiAgICAgICAgICAgIF90b3AgPSB0b3AgLSBwaDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCAtIGxlZnQgLSB3aWR0aCA8IHB3KSB7XHJcbiAgICAgICAgICAgIF9sZWZ0ID0gbGVmdCAtIHB3ICsgd2lkdGg7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBcclxuICAgICAgICBpZiAoIXRoaXMuaXNzdWJNZW51KCkpIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmQodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB0aGlzLmRyb3Bkb3duLmFwcGVuZE1lbnVFbCh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnN0eWxlLmNzc1RleHQgPSBgcG9zaXRpb246Zml4ZWQ7Ym90dG9tOnVuc2V0O2xlZnQ6JHtfbGVmdH1weCAhaW1wb3J0YW50O3RvcDoke190b3B9cHggIWltcG9ydGFudDtyaWdodDogdW5zZXQ7ei1pbmRleDogMTAwMDAwO2A7XHJcblxyXG4gICAgICAgICAgICAvLyBpZiAodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzb2x1dGlvbi1oZWFkZXItdGl0bGUtbWVudScpKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc0xpc3QuYWRkKCdxdWVyeS1zb2x1dGlvbicpO1xyXG4gICAgICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgICAgICAvLyBjb25zdCBzb2x1dGlvbkJ0bnMgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuc29sdXRpb24taGVhZGVyLWRyb3Bkb3duLWl0ZW0tYnRucycpO1xyXG4gICAgICAgICAgICAvLyBpZiAoc29sdXRpb25CdG5zICYmICFzb2x1dGlvbkJ0bnMuY2xhc3NMaXN0LmNvbnRhaW5zKCdkcm9wZG93bi1pdGVtJykpIHtcclxuICAgICAgICAgICAgLy8gICAgIHNvbHV0aW9uQnRucy5jbGFzc0xpc3QuYWRkKCdkcm9wZG93bi1pdGVtJyk7XHJcbiAgICAgICAgICAgIC8vIH1cclxuXHJcblxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkQ29udGFpbmVyV2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aCAtIGxlZnQgLSBwYXJlbnRNZW51UGFuZWwub2Zmc2V0V2lkdGg7XHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkTWVudVBhbmVsID0gdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgICAgIGlmIChjaGlsZE1lbnVQYW5lbC5vZmZzZXRXaWR0aCA+IGNoaWxkQ29udGFpbmVyV2lkdGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGwgPSAtcGFyZW50TWVudVBhbmVsLm9mZnNldFdpZHRoICsgMTY7XHJcbiAgICAgICAgICAgICAgICBjaGlsZE1lbnVQYW5lbC5zdHlsZS5sZWZ0ID0gbCArICdweCc7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkQ29udGFpbmVySGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0IC0gY2hpbGRNZW51UGFuZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wO1xyXG4gICAgICAgICAgICBpZiAoY2hpbGRDb250YWluZXJIZWlnaHQgPCBjaGlsZE1lbnVQYW5lbC5vZmZzZXRIZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgLSB0b3AgLSBjaGlsZE1lbnVQYW5lbC5vZmZzZXRIZWlnaHQgLSAxMDtcclxuICAgICAgICAgICAgICAgIGNoaWxkTWVudVBhbmVsLnN0eWxlLnRvcCA9IHQgKyAncHgnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==