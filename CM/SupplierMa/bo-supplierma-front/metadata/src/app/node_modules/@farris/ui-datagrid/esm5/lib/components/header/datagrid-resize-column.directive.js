/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Input, NgZone, ElementRef, Renderer2, Optional, HostListener } from '@angular/core';
import { DatagridHeaderComponent } from './datagrid-header.component';
import { fromEvent } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-08-10 09:04:53
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-11-20 17:09:09
 * @QQ: 1055818239
 * @Version: v0.0.12
 */
var DatagridResizeColumnDirective = /** @class */ (function () {
    function DatagridResizeColumnDirective(dh, ngzone, el, render) {
        this.dh = dh;
        this.ngzone = ngzone;
        this.el = el;
        this.render = render;
        this.dg = this.dh.dg;
    }
    /**
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.isEnable()) {
            this.render.addClass(this.el.nativeElement, 'f-datagrid-header-cell-resize');
            this.resizer = document.createElement('span');
            this.resizer.className = 'column-resize-bar';
            this.el.nativeElement.appendChild(this.resizer);
            this.ngzone.runOutsideAngular((/**
             * @return {?}
             */
            function () {
                // this.resizerMouseDownListener = this.onMouseDown.bind(this);
                // this.resizer.addEventListener('mousedown', this.resizerMouseDownListener);
                /** @type {?} */
                var mouseUp$ = fromEvent(_this.resizer, 'mouseup');
                _this.resizerMouseDownListener = fromEvent(_this.resizer, 'mousedown').pipe(
                // debounceTime(260),
                takeUntil(mouseUp$)).subscribe((/**
                 * @param {?} e
                 * @return {?}
                 */
                function (e) {
                    return _this.onMouseDown(e);
                }));
            }));
            // const mouse$ = fromEvent(this.resizer, 'click');
            // const buff$ = mouse$.pipe(
            //     debounceTime(250)
            // );
            // const click$ = mouse$.pipe(
            //     buffer(buff$),
            //     map(list => {
            //         return {event: list[0], count: list.length};
            //     }),
            //     filter(x => x.count === 2),
            //     map(x => x.event),
            //     takeUntil(mouseUp$)
            // );
            // click$.subscribe((e) => {
            //     this.onDblClickHandler(e);
            //     // this.onMouseUp(e);
            // });
        }
    };
    /**
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.onDblClickHandler = /**
     * @return {?}
     */
    function () {
        if (this.col.field && this.col.field !== this.dg.ControlPanelFeild) {
            /** @type {?} */
            var thRef = this.el;
            this.dg.sizeToContent(this.col, thRef);
        }
        return false;
    };
    /**
     * @private
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.isEnable = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.dg.resizeColumn) {
            if (this.col.field === this.dg.ControlPanelFeild) {
                this.col.resizable = false;
            }
            if (this.col.resizable === undefined) {
                this.col.resizable = true;
            }
            return this.col.resizable;
        }
        return false;
    };
    /**
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.bindDocumentEvents = /**
     * @return {?}
     */
    function () {
        var _this = this;
        this.ngzone.runOutsideAngular((/**
         * @return {?}
         */
        function () {
            _this.documentMouseMoveListener = _this.onMouseMove.bind(_this);
            document.addEventListener('mousemove', _this.documentMouseMoveListener);
            _this.documentMouseUpListener = _this.onMouseUp.bind(_this);
            document.addEventListener('mouseup', _this.documentMouseUpListener);
        }));
    };
    /**
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.unbindDocumentEvents = /**
     * @return {?}
     */
    function () {
        if (this.documentMouseMoveListener) {
            document.removeEventListener('mousemove', this.documentMouseMoveListener);
            this.documentMouseMoveListener = null;
        }
        if (this.documentMouseUpListener) {
            document.removeEventListener('mouseup', this.documentMouseUpListener);
            this.documentMouseUpListener = null;
        }
    };
    /**
     * @param {?} event
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.onMouseDown = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        event.stopPropagation();
        this.dg.onColumnResizeBegin(event);
        this.render.addClass(this.el.nativeElement, 'column-resizeing');
        this.bindDocumentEvents();
    };
    /**
     * @param {?} event
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.onMouseMove = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        this.dg.onColumnResize(event);
    };
    /**
     * @param {?} event
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.onMouseUp = /**
     * @param {?} event
     * @return {?}
     */
    function (event) {
        this.dg.onColumnResizeEnd(event, this.col);
        this.render.removeClass(this.el.nativeElement, 'column-resizeing');
        this.unbindDocumentEvents();
    };
    /**
     * @return {?}
     */
    DatagridResizeColumnDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.resizerMouseDownListener) {
            // this.resizer.removeEventListener('mousedown', this.resizerMouseDownListener);
            this.resizerMouseDownListener.unsubscribe();
        }
        this.unbindDocumentEvents();
        if (this.dblclickListener) {
            this.dblclickListener();
        }
        this.resizer = null;
    };
    DatagridResizeColumnDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[resize-column]',
                },] }
    ];
    /** @nocollapse */
    DatagridResizeColumnDirective.ctorParameters = function () { return [
        { type: DatagridHeaderComponent, decorators: [{ type: Optional }] },
        { type: NgZone },
        { type: ElementRef },
        { type: Renderer2 }
    ]; };
    DatagridResizeColumnDirective.propDecorators = {
        col: [{ type: Input, args: ['resize-column',] }],
        onDblClickHandler: [{ type: HostListener, args: ['dblclick',] }]
    };
    return DatagridResizeColumnDirective;
}());
export { DatagridResizeColumnDirective };
if (false) {
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.col;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.resizer;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.resizerMouseDownListener;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.documentMouseMoveListener;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.documentMouseUpListener;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.dblclickListener;
    /**
     * @type {?}
     * @private
     */
    DatagridResizeColumnDirective.prototype.dg;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.dh;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.ngzone;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.el;
    /** @type {?} */
    DatagridResizeColumnDirective.prototype.render;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtcmVzaXplLWNvbHVtbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvaGVhZGVyL2RhdGFncmlkLXJlc2l6ZS1jb2x1bW4uZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBNEIsUUFBUSxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUdsSSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2pDLE9BQU8sRUFBcUMsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7OztBQVM5RTtJQVdJLHVDQUN1QixFQUEyQixFQUN2QyxNQUFjLEVBQVMsRUFBYyxFQUFTLE1BQWlCO1FBRG5ELE9BQUUsR0FBRixFQUFFLENBQXlCO1FBQ3ZDLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBUyxPQUFFLEdBQUYsRUFBRSxDQUFZO1FBQVMsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUV0RSxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQ3pCLENBQUM7Ozs7SUFFRCx1REFBZTs7O0lBQWY7UUFBQSxpQkF3Q0M7UUF2Q0csSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxhQUFhLEVBQUUsK0JBQStCLENBQUMsQ0FBQztZQUU3RSxJQUFJLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDOUMsSUFBSSxDQUFDLE9BQU8sQ0FB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QixFQUFFLENBQUM7UUFFNUIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDdkIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7U0FDM0I7UUFFRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztJQUN4QixDQUFDOztnQkExSUosU0FBUyxTQUFDO29CQUNQLFFBQVEsRUFBRSxpQkFBaUI7aUJBQzlCOzs7O2dCQWJRLHVCQUF1Qix1QkF1QnZCLFFBQVE7Z0JBMUJVLE1BQU07Z0JBQUUsVUFBVTtnQkFBRSxTQUFTOzs7c0JBa0JuRCxLQUFLLFNBQUMsZUFBZTtvQ0F3RHJCLFlBQVksU0FBQyxVQUFVOztJQStFNUIsb0NBQUM7Q0FBQSxBQTNJRCxJQTJJQztTQXhJWSw2QkFBNkI7OztJQUN0Qyw0Q0FBd0M7O0lBQ3hDLGdEQUF5Qjs7SUFDekIsaUVBQThCOztJQUM5QixrRUFBK0I7O0lBQy9CLGdFQUE2Qjs7SUFDN0IseURBQXNCOzs7OztJQUN0QiwyQ0FBOEI7O0lBRTFCLDJDQUE4Qzs7SUFDOUMsK0NBQXFCOztJQUFFLDJDQUFxQjs7SUFBRSwrQ0FBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIElucHV0LCBOZ1pvbmUsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95LCBPcHRpb25hbCwgSG9zdExpc3RlbmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGFDb2x1bW4gfSBmcm9tICcuLi8uLi90eXBlcy9kYXRhLWNvbHVtbic7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi8uLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZEhlYWRlckNvbXBvbmVudCB9IGZyb20gJy4vZGF0YWdyaWQtaGVhZGVyLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IGZyb21FdmVudCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBidWZmZXIsIGRlYm91bmNlVGltZSwgbWFwLCBmaWx0ZXIsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuLypcclxuICogQEF1dGhvcjog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBARGF0ZTogMjAxOS0wOC0xMCAwOTowNDo1M1xyXG4gKiBATGFzdEVkaXRvcnM6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQExhc3RFZGl0VGltZTogMjAxOS0xMS0yMCAxNzowOTowOVxyXG4gKiBAUVE6IDEwNTU4MTgyMzlcclxuICogQFZlcnNpb246IHYwLjAuMTJcclxuICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6ICdbcmVzaXplLWNvbHVtbl0nLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRSZXNpemVDb2x1bW5EaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3kge1xyXG4gICAgQElucHV0KCdyZXNpemUtY29sdW1uJykgY29sOiBEYXRhQ29sdW1uO1xyXG4gICAgcmVzaXplcjogSFRNTFNwYW5FbGVtZW50O1xyXG4gICAgcmVzaXplck1vdXNlRG93bkxpc3RlbmVyOiBhbnk7XHJcbiAgICBkb2N1bWVudE1vdXNlTW92ZUxpc3RlbmVyOiBhbnk7XHJcbiAgICBkb2N1bWVudE1vdXNlVXBMaXN0ZW5lcjogYW55O1xyXG4gICAgZGJsY2xpY2tMaXN0ZW5lcjogYW55O1xyXG4gICAgcHJpdmF0ZSBkZzogRGF0YWdyaWRDb21wb25lbnQ7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBAT3B0aW9uYWwoKSBwdWJsaWMgZGg6IERhdGFncmlkSGVhZGVyQ29tcG9uZW50LFxyXG4gICAgICAgIHB1YmxpYyBuZ3pvbmU6IE5nWm9uZSwgcHVibGljIGVsOiBFbGVtZW50UmVmLCBwdWJsaWMgcmVuZGVyOiBSZW5kZXJlcjJcclxuICAgICkge1xyXG4gICAgICAgIHRoaXMuZGcgPSB0aGlzLmRoLmRnO1xyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgICAgICBpZiAodGhpcy5pc0VuYWJsZSgpKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLmFkZENsYXNzKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ2YtZGF0YWdyaWQtaGVhZGVyLWNlbGwtcmVzaXplJyk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJlc2l6ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgICAgIHRoaXMucmVzaXplci5jbGFzc05hbWUgPSAnY29sdW1uLXJlc2l6ZS1iYXInO1xyXG4gICAgICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuYXBwZW5kQ2hpbGQodGhpcy5yZXNpemVyKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMucmVzaXplck1vdXNlRG93bkxpc3RlbmVyID0gdGhpcy5vbk1vdXNlRG93bi5iaW5kKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgLy8gdGhpcy5yZXNpemVyLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMucmVzaXplck1vdXNlRG93bkxpc3RlbmVyKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG1vdXNlVXAkID0gZnJvbUV2ZW50KHRoaXMucmVzaXplciwgJ21vdXNldXAnKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVzaXplck1vdXNlRG93bkxpc3RlbmVyID0gZnJvbUV2ZW50KHRoaXMucmVzaXplciwgJ21vdXNlZG93bicpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gZGVib3VuY2VUaW1lKDI2MCksXHJcbiAgICAgICAgICAgICAgICAgICAgdGFrZVVudGlsKG1vdXNlVXAkKVxyXG4gICAgICAgICAgICAgICAgKS5zdWJzY3JpYmUoKGU6IGFueSkgPT5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTW91c2VEb3duKGUpXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIGNvbnN0IG1vdXNlJCA9IGZyb21FdmVudCh0aGlzLnJlc2l6ZXIsICdjbGljaycpO1xyXG4gICAgICAgICAgICAvLyBjb25zdCBidWZmJCA9IG1vdXNlJC5waXBlKFxyXG4gICAgICAgICAgICAvLyAgICAgZGVib3VuY2VUaW1lKDI1MClcclxuICAgICAgICAgICAgLy8gKTtcclxuXHJcbiAgICAgICAgICAgIC8vIGNvbnN0IGNsaWNrJCA9IG1vdXNlJC5waXBlKFxyXG4gICAgICAgICAgICAvLyAgICAgYnVmZmVyKGJ1ZmYkKSxcclxuICAgICAgICAgICAgLy8gICAgIG1hcChsaXN0ID0+IHtcclxuICAgICAgICAgICAgLy8gICAgICAgICByZXR1cm4ge2V2ZW50OiBsaXN0WzBdLCBjb3VudDogbGlzdC5sZW5ndGh9O1xyXG4gICAgICAgICAgICAvLyAgICAgfSksXHJcbiAgICAgICAgICAgIC8vICAgICBmaWx0ZXIoeCA9PiB4LmNvdW50ID09PSAyKSxcclxuICAgICAgICAgICAgLy8gICAgIG1hcCh4ID0+IHguZXZlbnQpLFxyXG4gICAgICAgICAgICAvLyAgICAgdGFrZVVudGlsKG1vdXNlVXAkKVxyXG4gICAgICAgICAgICAvLyApO1xyXG5cclxuICAgICAgICAgICAgLy8gY2xpY2skLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy5vbkRibENsaWNrSGFuZGxlcihlKTtcclxuICAgICAgICAgICAgLy8gICAgIC8vIHRoaXMub25Nb3VzZVVwKGUpO1xyXG4gICAgICAgICAgICAvLyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgQEhvc3RMaXN0ZW5lcignZGJsY2xpY2snKVxyXG4gICAgb25EYmxDbGlja0hhbmRsZXIoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29sLmZpZWxkICYmIHRoaXMuY29sLmZpZWxkICE9PSB0aGlzLmRnLkNvbnRyb2xQYW5lbEZlaWxkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRoUmVmID0gdGhpcy5lbDtcclxuICAgICAgICAgICAgdGhpcy5kZy5zaXplVG9Db250ZW50KHRoaXMuY29sLCB0aFJlZik7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGlzRW5hYmxlKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnLnJlc2l6ZUNvbHVtbikge1xyXG5cclxuICAgICAgICAgICAgaWYgKCB0aGlzLmNvbC5maWVsZCA9PT0gdGhpcy5kZy5Db250cm9sUGFuZWxGZWlsZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2wucmVzaXphYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbC5yZXNpemFibGUgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2wucmVzaXphYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY29sLnJlc2l6YWJsZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBiaW5kRG9jdW1lbnRFdmVudHMoKSB7XHJcbiAgICAgICAgdGhpcy5uZ3pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmRvY3VtZW50TW91c2VNb3ZlTGlzdGVuZXIgPSB0aGlzLm9uTW91c2VNb3ZlLmJpbmQodGhpcyk7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuZG9jdW1lbnRNb3VzZU1vdmVMaXN0ZW5lcik7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRvY3VtZW50TW91c2VVcExpc3RlbmVyID0gdGhpcy5vbk1vdXNlVXAuYmluZCh0aGlzKTtcclxuICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuZG9jdW1lbnRNb3VzZVVwTGlzdGVuZXIpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVuYmluZERvY3VtZW50RXZlbnRzKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRvY3VtZW50TW91c2VNb3ZlTGlzdGVuZXIpIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5kb2N1bWVudE1vdXNlTW92ZUxpc3RlbmVyKTtcclxuICAgICAgICAgICAgdGhpcy5kb2N1bWVudE1vdXNlTW92ZUxpc3RlbmVyID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRvY3VtZW50TW91c2VVcExpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLmRvY3VtZW50TW91c2VVcExpc3RlbmVyKTtcclxuICAgICAgICAgICAgdGhpcy5kb2N1bWVudE1vdXNlVXBMaXN0ZW5lciA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9uTW91c2VEb3duKGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgdGhpcy5kZy5vbkNvbHVtblJlc2l6ZUJlZ2luKGV2ZW50KTtcclxuICAgICAgICB0aGlzLnJlbmRlci5hZGRDbGFzcyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdjb2x1bW4tcmVzaXplaW5nJyk7XHJcbiAgICAgICAgdGhpcy5iaW5kRG9jdW1lbnRFdmVudHMoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbk1vdXNlTW92ZShldmVudDogTW91c2VFdmVudCkge1xyXG4gICAgICAgIHRoaXMuZGcub25Db2x1bW5SZXNpemUoZXZlbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uTW91c2VVcChldmVudDogTW91c2VFdmVudCkge1xyXG4gICAgICAgIHRoaXMuZGcub25Db2x1bW5SZXNpemVFbmQoZXZlbnQsIHRoaXMuY29sKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVDbGFzcyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdjb2x1bW4tcmVzaXplaW5nJyk7XHJcbiAgICAgICAgdGhpcy51bmJpbmREb2N1bWVudEV2ZW50cygpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLnJlc2l6ZXJNb3VzZURvd25MaXN0ZW5lcikge1xyXG4gICAgICAgICAgICAvLyB0aGlzLnJlc2l6ZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5yZXNpemVyTW91c2VEb3duTGlzdGVuZXIpO1xyXG4gICAgICAgICAgICB0aGlzLnJlc2l6ZXJNb3VzZURvd25MaXN0ZW5lci51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy51bmJpbmREb2N1bWVudEV2ZW50cygpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5kYmxjbGlja0xpc3RlbmVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGJsY2xpY2tMaXN0ZW5lcigpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5yZXNpemVyID0gbnVsbDtcclxuICAgIH1cclxufVxyXG4iXX0=