import { Injectable, Optional } from '@angular/core';
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { BefRepositoryUtil } from '@farris/bef';
import { TAB_EVENT } from './types';
import { NavigationService } from './navigation.service';
import { FrameContext, UID } from '@farris/devkit';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { CardDataService } from './data-services/card-data.service';
/**
 * 导航中间件服务
 * @scope FrameComponent
 */
// tslint:disable: no-string-literal
export class NavigationMiddlewareService {
    constructor(navigationService, frameContext, msgService, languageService, cardDataService) {
        this.navigationService = navigationService;
        this.frameContext = frameContext;
        this.msgService = msgService;
        this.languageService = languageService;
        this.cardDataService = cardDataService;
        this.repository = frameContext.repository;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        if (this.frameContext) {
            this.appContext = this.frameContext.getFormAppContext() || null;
        }
    }
    /**
     * 关闭前处理
     */
    onClosing() {
        if (this.isInDialog()) {
            return;
        }
        this.navigationService.addEventListener(TAB_EVENT.onTabClosing, (options) => {
            if (this.isChanged && !this.appContext.opened) {
                // 如果需要用户确认就切换到当前tab
                if (options && options.beforeCloseHandle && typeof options.beforeCloseHandle === 'function') {
                    options.beforeCloseHandle({ selectedChange: true });
                }
                const conform = this.msgService.question(this.languageService['exitWithoutSave']);
                /*记录弹窗已打开*/
                this.appContext.opened = true;
                return conform.pipe(switchMap((result) => {
                    this.appContext.opened = false;
                    if (result) {
                        /*记录用户关闭弹窗*/
                        if (!!this.cardDataService) {
                            const revert$ = this.cardDataService.revert(options);
                            return revert$.pipe(switchMap(() => of(result)));
                        }
                    }
                    return of(result);
                }));
            }
            else if (this.isChanged && this.appContext.opened) {
                return of(false);
            }
            else {
                return of(true);
            }
        });
    }
    /**
     * 是否在是弹窗窗口内
     */
    isInDialog() {
        let frameContext = this.frameContext;
        let isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'] || false;
        while (frameContext.parent !== null && !isDialogRootComponent) {
            frameContext = frameContext.parent;
            isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'];
        }
        return isDialogRootComponent;
    }
    /**
     * 获取tabid,如果targetId存在则直接使用targetId
     * @description 将用户要查看的数据id转换为运行框架需要的tabId
     * @param params router参数
     * @param targetId 要编辑/查看的数据id
     */
    getTabId(params, targetId) {
        if (!!targetId) {
            return targetId;
        }
        let paramsObj = null;
        if (!!params && params.startsWith('{') && params.endsWith('}')) {
            paramsObj = JSON.parse(params);
        }
        let paramId = null;
        if (paramsObj && paramsObj.hasOwnProperty('id') && !!paramsObj.id) {
            paramId = paramsObj.id;
        }
        else {
            paramId = UID.create();
        }
        return paramId;
    }
    /**
     * 是否有未保存的变更
     */
    get isChanged() {
        const befRepository = this.repository;
        return BefRepositoryUtil.isExistUnsaveData(befRepository);
    }
}
NavigationMiddlewareService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
NavigationMiddlewareService.ctorParameters = () => [
    { type: NavigationService },
    { type: FrameContext },
    { type: FormMessageService },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: CardDataService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFpQixpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQWMsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRTs7O0dBR0c7QUFDSCxvQ0FBb0M7QUFFcEMsTUFBTSxPQUFPLDJCQUEyQjtJQUl0QyxZQUNVLGlCQUFvQyxFQUNwQyxZQUEwQixFQUMxQixVQUE4QixFQUNsQixlQUFnQyxFQUM1QyxlQUFnQztRQUpoQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQ2xCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUM1QyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFFeEMsSUFBSSxDQUFDLFVBQVUs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UUFDRCxJQUFJLFNBQVMsR0FBUSxJQUFJLENBQUM7UUFDMUIsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUM5RCxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNoQztRQUNELElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztRQUNuQixJQUFJLFNBQVMsSUFBSSxTQUFTLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFO1lBQ2pFLE9BQU8sR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDO1NBQ3hCO2FBQU07WUFDTCxPQUFPLEdBQUcsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ3hCO1FBQ0QsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUNEOztPQUVHO0lBQ0gsSUFBWSxTQUFTO1FBQ25CLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxVQUFnQyxDQUFDO1FBQzVELE9BQU8saUJBQWlCLENBQUMsaUJBQWlCLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDNUQsQ0FBQzs7O1lBbEdGLFVBQVU7Ozs7WUFWRixpQkFBaUI7WUFDakIsWUFBWTtZQUNaLGtCQUFrQjtZQUNsQixlQUFlLHVCQWdCbkIsUUFBUTtZQWZKLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIEJlZlJlcG9zaXRvcnlVdGlsIH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xuaW1wb3J0IHsgVEFCX0VWRU5UIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBOYXZpZ2F0aW9uU2VydmljZSB9IGZyb20gJy4vbmF2aWdhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSwgVUlEIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XG5pbXBvcnQgeyBDYXJkRGF0YVNlcnZpY2UgfSBmcm9tICcuL2RhdGEtc2VydmljZXMvY2FyZC1kYXRhLnNlcnZpY2UnO1xuLyoqXG4gKiDlr7zoiKrkuK3pl7Tku7bmnI3liqFcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxuICovXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWxcbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBOYXZpZ2F0aW9uTWlkZGxld2FyZVNlcnZpY2Uge1xuICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PjtcblxuICBwcml2YXRlIGFwcENvbnRleHQ6IGFueTtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuYXZpZ2F0aW9uU2VydmljZTogTmF2aWdhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcbiAgICBwcml2YXRlIG1zZ1NlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2FyZERhdGFTZXJ2aWNlOiBDYXJkRGF0YVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5ID0gZnJhbWVDb250ZXh0LnJlcG9zaXRvcnk7XG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XG4gICAgICB0aGlzLmFwcENvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpIHx8IG51bGw7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDlhbPpl63liY3lpITnkIZcbiAgICovXG4gIHB1YmxpYyBvbkNsb3NpbmcoKSB7XG4gICAgaWYgKHRoaXMuaXNJbkRpYWxvZygpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMubmF2aWdhdGlvblNlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihUQUJfRVZFTlQub25UYWJDbG9zaW5nLCAob3B0aW9ucykgPT4ge1xuICAgICAgaWYgKHRoaXMuaXNDaGFuZ2VkICYmICF0aGlzLmFwcENvbnRleHQub3BlbmVkKSB7XG4gICAgICAgIC8vIOWmguaenOmcgOimgeeUqOaIt+ehruiupOWwseWIh+aNouWIsOW9k+WJjXRhYlxuICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmJlZm9yZUNsb3NlSGFuZGxlICYmIHR5cGVvZiBvcHRpb25zLmJlZm9yZUNsb3NlSGFuZGxlID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgb3B0aW9ucy5iZWZvcmVDbG9zZUhhbmRsZSh7IHNlbGVjdGVkQ2hhbmdlOiB0cnVlIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNvbmZvcm0gPSB0aGlzLm1zZ1NlcnZpY2UucXVlc3Rpb24odGhpcy5sYW5ndWFnZVNlcnZpY2VbJ2V4aXRXaXRob3V0U2F2ZSddKTtcbiAgICAgICAgLyrorrDlvZXlvLnnqpflt7LmiZPlvIAqL1xuICAgICAgICB0aGlzLmFwcENvbnRleHQub3BlbmVkID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIGNvbmZvcm0ucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgdGhpcy5hcHBDb250ZXh0Lm9wZW5lZCA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAvKuiusOW9leeUqOaIt+WFs+mXreW8ueeqlyovXG4gICAgICAgICAgICAgIGlmICghIXRoaXMuY2FyZERhdGFTZXJ2aWNlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmV2ZXJ0JCA9IHRoaXMuY2FyZERhdGFTZXJ2aWNlLnJldmVydChvcHRpb25zKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV2ZXJ0JC5waXBlKFxuICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IG9mKHJlc3VsdCkpXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3VsdCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0NoYW5nZWQgJiYgdGhpcy5hcHBDb250ZXh0Lm9wZW5lZCkge1xuICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDmmK/lkKblnKjmmK/lvLnnqpfnqpflj6PlhoVcbiAgICovXG4gIHByaXZhdGUgaXNJbkRpYWxvZygpIHtcbiAgICBsZXQgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQ7XG4gICAgbGV0IGlzRGlhbG9nUm9vdENvbXBvbmVudCA9IGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J10gfHwgZmFsc2U7XG4gICAgd2hpbGUgKGZyYW1lQ29udGV4dC5wYXJlbnQgIT09IG51bGwgJiYgIWlzRGlhbG9nUm9vdENvbXBvbmVudCkge1xuICAgICAgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0LnBhcmVudDtcbiAgICAgIGlzRGlhbG9nUm9vdENvbXBvbmVudCA9IGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J107XG4gICAgfVxuICAgIHJldHVybiBpc0RpYWxvZ1Jvb3RDb21wb25lbnQ7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPlnRhYmlkLOWmguaenHRhcmdldElk5a2Y5Zyo5YiZ55u05o6l5L2/55SodGFyZ2V0SWRcbiAgICogQGRlc2NyaXB0aW9uIOWwhueUqOaIt+imgeafpeeci+eahOaVsOaNrmlk6L2s5o2i5Li66L+Q6KGM5qGG5p626ZyA6KaB55qEdGFiSWRcbiAgICogQHBhcmFtIHBhcmFtcyByb3V0ZXLlj4LmlbBcbiAgICogQHBhcmFtIHRhcmdldElkIOimgee8lui+kS/mn6XnnIvnmoTmlbDmja5pZFxuICAgKi9cbiAgcHVibGljIGdldFRhYklkKHBhcmFtczogc3RyaW5nLCB0YXJnZXRJZDogc3RyaW5nKTogYW55IHtcbiAgICBpZiAoISF0YXJnZXRJZCkge1xuICAgICAgcmV0dXJuIHRhcmdldElkO1xuICAgIH1cbiAgICBsZXQgcGFyYW1zT2JqOiBhbnkgPSBudWxsO1xuICAgIGlmICghIXBhcmFtcyAmJiBwYXJhbXMuc3RhcnRzV2l0aCgneycpICYmIHBhcmFtcy5lbmRzV2l0aCgnfScpKSB7XG4gICAgICBwYXJhbXNPYmogPSBKU09OLnBhcnNlKHBhcmFtcyk7XG4gICAgfVxuICAgIGxldCBwYXJhbUlkID0gbnVsbDtcbiAgICBpZiAocGFyYW1zT2JqICYmIHBhcmFtc09iai5oYXNPd25Qcm9wZXJ0eSgnaWQnKSAmJiAhIXBhcmFtc09iai5pZCkge1xuICAgICAgcGFyYW1JZCA9IHBhcmFtc09iai5pZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1JZCA9IFVJRC5jcmVhdGUoKTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmFtSWQ7XG4gIH1cbiAgLyoqXG4gICAqIOaYr+WQpuacieacquS/neWtmOeahOWPmOabtFxuICAgKi9cbiAgcHJpdmF0ZSBnZXQgaXNDaGFuZ2VkKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xuICAgIHJldHVybiBCZWZSZXBvc2l0b3J5VXRpbC5pc0V4aXN0VW5zYXZlRGF0YShiZWZSZXBvc2l0b3J5KTtcbiAgfVxufVxuIl19