import { Injectable, Injector } from '@angular/core';
import { FrameContext } from '@farris/devkit';
import { FormLoadingService } from './form-loading/form-loading.service';
import { RuntimeFrameworkService } from './rtf-service';
import { tap } from 'rxjs/operators';
import { EMPTY } from 'rxjs';
// tslint:disable: max-line-length
export class DiscussionGroupService {
    constructor(injector, frameContext, loadingService, runtimeFrameworkService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.loadingService = loadingService;
        this.runtimeFrameworkService = runtimeFrameworkService;
    }
    /**
     * 实体仓库
     */
    get repository() {
        return this.frameContext.repository;
    }
    /**
     * 命令参数
     */
    get params() {
        return this['context'] && this['context']['eventParam'] || {};
    }
    addComment(id, summary, configId, text, visibility, parentId) {
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        const params = this.buildAddCommentParam(id, text, parentId, summary, visibility, configId);
        const restService = this.repository.restService;
        const url = '/api/runtime/comment/v1.0/bill-comment/comment';
        const requestInfo = restService.buildRequestInfo();
        const options = {
            body: Object.assign({ requestInfo }, params)
        };
        this.loadingService.show();
        return restService.invoke(url, 'POST', null, options).pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 查询评论
     * @param id id
     */
    queryComments(id, configId, pageIndex, pageSize) {
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        const restService = this.repository.restService;
        const url = this.buildQueryCommentsUrl(id, pageIndex, pageSize, configId);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 查询所有部门信息
     */
    queryAllOrgs() {
        const restService = this.repository.restService;
        const url = '/api/runtime/sys/v1.0/sysOrgs?param={"layer":"1"}';
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 查询常用@用户
     * @param pageIndex
     * @param pageSize
     */
    queryFrequentAtUsers(pageIndex, pageSize) {
        const restService = this.repository.restService;
        const url = this.buildQueryFrequentAtUsersUrl(pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 获取at用户列表
     * @param user 用户编号或者用户名称（过滤使用）
     * @param pageIndex pageIndex
     * @param pageSize pageSize
     */
    queryAtUsers(user, pageIndex, pageSize) {
        const restService = this.repository.restService;
        const url = this.buildQueryAtUsersUrl(user, pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 构造获取评论列表的url
     * @param id id
     */
    buildQueryCommentsUrl(id, pageIndex, pageSize, configId) {
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 10;
        }
        const serverUri = this.repository.serverUri;
        // const funcId = this.runtimeFrameworkService && this.runtimeFrameworkService.funcId || '';
        return `/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId=${configId}&billId=${id}&pageSize=${pageSize}&pageIndex=${pageIndex}`;
    }
    /**
     * 构造获取@用户url
     */
    buildQueryAtUsersUrl(user, pageIndex, pageSize) {
        const params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 1000;
        }
        if (user) {
            params.push(`param=${user}`);
        }
        params.push(`pageSize=${pageSize}`);
        params.push(`pageIndex=${pageIndex}`);
        return `/api/runtime/comment/v1.0/bill-comment/atUser?${params.join('&')}`;
    }
    buildQueryFrequentAtUsersUrl(pageIndex, pageSize) {
        const params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 6;
        }
        params.push(`pageSize=${pageSize}`);
        params.push(`pageIndex=${pageIndex}`);
        return `/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?${params.join('&')}`;
    }
    buildAddCommentParam(id, text, parentId, summary, visibility, configId) {
        if (typeof text === 'undefined') {
            text = this.params.text;
        }
        if (typeof parentId === 'undefined') {
            parentId = this.params.parentId;
        }
        if (typeof visibility === 'undefined') {
            visibility = this.params.visibility;
        }
        return {
            'bill': {
                'billId': id,
                'configId': configId,
                'summary': summary
            },
            'comment': {
                'billId': id,
                'configId': configId,
                'parentId': parentId || null,
                'text': text,
                'visibility': visibility
            }
        };
    }
}
DiscussionGroupService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
DiscussionGroupService.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: FormLoadingService },
    { type: RuntimeFrameworkService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzY3Vzc2lvbi1ncm91cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2Rpc2N1c3Npb24tZ3JvdXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFVLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDekUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyQyxPQUFPLEVBQWtCLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3QyxrQ0FBa0M7QUFFbEMsTUFBTSxPQUFPLHNCQUFzQjtJQWFqQyxZQUFvQixRQUFrQixFQUFVLFlBQTBCLEVBQVUsY0FBa0MsRUFBVSx1QkFBZ0Q7UUFBNUosYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQW9CO1FBQVUsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtJQUNoTCxDQUFDO0lBYkQ7O09BRUc7SUFDSCxJQUFZLFVBQVU7UUFDcEIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQW1DLENBQUM7SUFDL0QsQ0FBQztJQUNEOztPQUVHO0lBQ0gsSUFBWSxNQUFNO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDaEUsQ0FBQztJQUlNLFVBQVUsQ0FBQyxFQUFXLEVBQUUsT0FBZ0IsRUFBRSxRQUFpQixFQUFFLElBQWEsRUFBRSxV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ZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBFbnRpdHkgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XHJcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL3J0Zi1zZXJ2aWNlJztcclxuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgRU1QVFkgfSBmcm9tICdyeGpzJztcclxuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBEaXNjdXNzaW9uR3JvdXBTZXJ2aWNlIHtcclxuICAvKipcclxuICAgKiDlrp7kvZPku5PlupNcclxuICAgKi9cclxuICBwcml2YXRlIGdldCByZXBvc2l0b3J5KCk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PEVudGl0eT47XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWRveS7pOWPguaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IHBhcmFtcygpIHtcclxuICAgIHJldHVybiB0aGlzWydjb250ZXh0J10gJiYgdGhpc1snY29udGV4dCddWydldmVudFBhcmFtJ10gfHwge307XHJcbiAgfVxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwcml2YXRlIGxvYWRpbmdTZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2UsIHByaXZhdGUgcnVudGltZUZyYW1ld29ya1NlcnZpY2U6IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlKSB7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYWRkQ29tbWVudChpZD86IHN0cmluZywgc3VtbWFyeT86IHN0cmluZywgY29uZmlnSWQ/OiBzdHJpbmcsIHRleHQ/OiBzdHJpbmcsIHZpc2liaWxpdHk/OiBzdHJpbmcsIHBhcmVudElkPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlkID0gaWQgfHwgdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgfHwgbnVsbDtcclxuICAgIGlmICghaWQpIHtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5idWlsZEFkZENvbW1lbnRQYXJhbShpZCwgdGV4dCwgcGFyZW50SWQsIHN1bW1hcnksIHZpc2liaWxpdHksIGNvbmZpZ0lkKTtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2NvbW1lbnQnO1xyXG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKCk7XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiB7XHJcbiAgICAgICAgcmVxdWVzdEluZm8sXHJcbiAgICAgICAgLi4ucGFyYW1zXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnUE9TVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmn6Xor6Lor4TorrpcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKi9cclxuICBwdWJsaWMgcXVlcnlDb21tZW50cyhpZDogc3RyaW5nLCBjb25maWdJZDogc3RyaW5nLCBwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWQgPSBpZCB8fCB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCB8fCBudWxsO1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcblxyXG4gICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFF1ZXJ5Q29tbWVudHNVcmwoaWQsIHBhZ2VJbmRleCwgcGFnZVNpemUsIGNvbmZpZ0lkKTtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l6K+i5omA5pyJ6YOo6Zeo5L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIHF1ZXJ5QWxsT3JncygpIHtcclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9zeXMvdjEuMC9zeXNPcmdzP3BhcmFtPXtcImxheWVyXCI6XCIxXCJ9JztcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l6K+i5bi455SoQOeUqOaItyBcclxuICAgKiBAcGFyYW0gcGFnZUluZGV4IFxyXG4gICAqIEBwYXJhbSBwYWdlU2l6ZSBcclxuICAgKi9cclxuICBwdWJsaWMgcXVlcnlGcmVxdWVudEF0VXNlcnMocGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRRdWVyeUZyZXF1ZW50QXRVc2Vyc1VybChwYWdlSW5kZXgsIHBhZ2VTaXplKTtcclxuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xyXG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+WYXTnlKjmiLfliJfooahcclxuICAgKiBAcGFyYW0gdXNlciDnlKjmiLfnvJblj7fmiJbogIXnlKjmiLflkI3np7DvvIjov4fmu6Tkvb/nlKjvvIlcclxuICAgKiBAcGFyYW0gcGFnZUluZGV4IHBhZ2VJbmRleFxyXG4gICAqIEBwYXJhbSBwYWdlU2l6ZSBwYWdlU2l6ZVxyXG4gICAqL1xyXG4gIHB1YmxpYyBxdWVyeUF0VXNlcnModXNlcj86IHN0cmluZywgcGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRRdWVyeUF0VXNlcnNVcmwodXNlciwgcGFnZUluZGV4LCBwYWdlU2l6ZSk7XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJykucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOiOt+WPluivhOiuuuWIl+ihqOeahHVybFxyXG4gICAqIEBwYXJhbSBpZCBpZFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRRdWVyeUNvbW1lbnRzVXJsKGlkOiBzdHJpbmcsIHBhZ2VJbmRleDogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU6IG51bWJlciB8IG51bGwsIGNvbmZpZ0lkOiBzdHJpbmcpIHtcclxuICAgIGlmICh0eXBlb2YgcGFnZUluZGV4ID09PSAndW5kZWZpbmVkJyB8fCBwYWdlSW5kZXggPT09IG51bGwpIHtcclxuICAgICAgcGFnZUluZGV4ID0gdGhpcy5wYXJhbXMucGFnZUluZGV4IHx8IDA7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIHBhZ2VTaXplID09PSAndW5kZWZpbmVkJyB8fCBwYWdlU2l6ZSA9PT0gbnVsbCkge1xyXG4gICAgICBwYWdlU2l6ZSA9IHRoaXMucGFyYW1zLnBhZ2VTaXplIHx8IDEwO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgc2VydmVyVXJpID0gdGhpcy5yZXBvc2l0b3J5LnNlcnZlclVyaTtcclxuICAgIC8vIGNvbnN0IGZ1bmNJZCA9IHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UgJiYgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5mdW5jSWQgfHwgJyc7XHJcbiAgICByZXR1cm4gYC9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2NvbW1lbnQvYnlCaWxsP2NvbmZpZ0lkPSR7Y29uZmlnSWR9JmJpbGxJZD0ke2lkfSZwYWdlU2l6ZT0ke3BhZ2VTaXplfSZwYWdlSW5kZXg9JHtwYWdlSW5kZXh9YDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg6I635Y+WQOeUqOaIt3VybFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRRdWVyeUF0VXNlcnNVcmwodXNlcj86IHN0cmluZywgcGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XHJcbiAgICBjb25zdCBwYXJhbXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBpZiAodHlwZW9mIHBhZ2VJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZUluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBwYWdlU2l6ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZVNpemUgPT09IG51bGwpIHtcclxuICAgICAgcGFnZVNpemUgPSB0aGlzLnBhcmFtcy5wYWdlU2l6ZSB8fCAxMDAwO1xyXG4gICAgfVxyXG4gICAgaWYgKHVzZXIpIHtcclxuICAgICAgcGFyYW1zLnB1c2goYHBhcmFtPSR7dXNlcn1gKTtcclxuICAgIH1cclxuICAgIHBhcmFtcy5wdXNoKGBwYWdlU2l6ZT0ke3BhZ2VTaXplfWApO1xyXG4gICAgcGFyYW1zLnB1c2goYHBhZ2VJbmRleD0ke3BhZ2VJbmRleH1gKTtcclxuICAgIHJldHVybiBgL2FwaS9ydW50aW1lL2NvbW1lbnQvdjEuMC9iaWxsLWNvbW1lbnQvYXRVc2VyPyR7cGFyYW1zLmpvaW4oJyYnKX1gO1xyXG4gIH1cclxuICBwcml2YXRlIGJ1aWxkUXVlcnlGcmVxdWVudEF0VXNlcnNVcmwocGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XHJcbiAgICBjb25zdCBwYXJhbXM6IHN0cmluZ1tdID0gW107XHJcbiAgICBpZiAodHlwZW9mIHBhZ2VJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZUluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBwYWdlU2l6ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZVNpemUgPT09IG51bGwpIHtcclxuICAgICAgcGFnZVNpemUgPSB0aGlzLnBhcmFtcy5wYWdlU2l6ZSB8fCA2O1xyXG4gICAgfVxyXG4gICAgcGFyYW1zLnB1c2goYHBhZ2VTaXplPSR7cGFnZVNpemV9YCk7XHJcbiAgICBwYXJhbXMucHVzaChgcGFnZUluZGV4PSR7cGFnZUluZGV4fWApO1xyXG4gICAgcmV0dXJuIGAvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9mcmVxdWVudEF0VXNlcnM/JHtwYXJhbXMuam9pbignJicpfWA7XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGRBZGRDb21tZW50UGFyYW0oaWQ6IHN0cmluZywgdGV4dDogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBzdW1tYXJ5OiBzdHJpbmcsIHZpc2liaWxpdHk6IHN0cmluZywgY29uZmlnSWQ6IHN0cmluZykge1xyXG4gICAgaWYgKHR5cGVvZiB0ZXh0ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICB0ZXh0ID0gdGhpcy5wYXJhbXMudGV4dDtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGFyZW50SWQgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHBhcmVudElkID0gdGhpcy5wYXJhbXMucGFyZW50SWQ7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIHZpc2liaWxpdHkgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIHZpc2liaWxpdHkgPSB0aGlzLnBhcmFtcy52aXNpYmlsaXR5O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgJ2JpbGwnOiB7XHJcbiAgICAgICAgJ2JpbGxJZCc6IGlkLFxyXG4gICAgICAgICdjb25maWdJZCc6IGNvbmZpZ0lkLFxyXG4gICAgICAgICdzdW1tYXJ5Jzogc3VtbWFyeVxyXG4gICAgICB9LFxyXG4gICAgICAnY29tbWVudCc6IHtcclxuICAgICAgICAnYmlsbElkJzogaWQsXHJcbiAgICAgICAgJ2NvbmZpZ0lkJzogY29uZmlnSWQsXHJcbiAgICAgICAgJ3BhcmVudElkJzogcGFyZW50SWQgfHwgbnVsbCxcclxuICAgICAgICAndGV4dCc6IHRleHQsXHJcbiAgICAgICAgJ3Zpc2liaWxpdHknOiB2aXNpYmlsaXR5XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19