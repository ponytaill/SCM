import { BindingPropertyType } from './binding_property';
import { PropertyUtil } from './property_util';
import { BaseBindingObject } from './base_binding_object';
import { BindingListFactory } from './binding_list_factory';
import { TranslateService } from '../i18n/translate_service';
// import { BindingObjectFactory } from './binding_object_factory';
/**
 * BindingObjectTypeFactory
 */
export class BindingObjectTypeFactory {
    /**
     * 创建BindingObject
     * @param properties
     * @param data
     * @returns
     */
    static create(properties /*, data?: any*/) {
        const bindingObjectType = this.getType(properties);
        return new bindingObjectType();
    }
    /**
     * 创建原型类型
     * @param properties
     * @returns
     */
    static createType(properties) {
        // 继承原绑定对象所有属性
        const bindingObjectType = class BindingObjectType extends BaseBindingObject {
            constructor() {
                super();
                // this.innerValues = ImmutableMap(Object.assign({}, data));
            }
        };
        // 获取主键
        const primaryKey = PropertyUtil.getPrimaryKey(properties);
        // 设置主键
        bindingObjectType.prototype.primaryKey = primaryKey;
        bindingObjectType.prototype.properties = properties;
        // 将属性扩展到原型对象上
        this.extendProperties(bindingObjectType.prototype, properties);
        return bindingObjectType;
    }
    /**
     * 扩展原型属性
     * @param typePrototype
     * @param properties
     */
    static extendProperties(typePrototype, properties) {
        // 扩展BindingObject属性
        properties.forEach((property) => {
            if (property.type === BindingPropertyType.List) {
                this.extendListProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Object) {
                this.extendObjectProperty(typePrototype, property);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                this.extendDynamicObjectProperty(typePrototype, property);
            }
            else {
                this.extendPlainProperty(typePrototype, property);
            }
        });
    }
    /**
     * 扩展原型列表属性
     * @param typePrototype
     * @param property
     */
    static extendListProperty(typePrototype, property) {
        const propertyName = property.name;
        const childListProperties = PropertyUtil.getProperties(property.entityType);
        const key = `_${propertyName}_`;
        // 将子的BindingList实例赋值给当前属性
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                let bindingList = this[key];
                if (!bindingList) {
                    bindingList = BindingListFactory.create(childListProperties);
                    this[key] = bindingList;
                    // 加载数据
                    const data = this.getValue(propertyName);
                    if (data) {
                        const bindingObjects = data.map(item => {
                            const bindingObject = BindingObjectTypeFactory.create(childListProperties);
                            return bindingObject;
                        });
                        bindingList.load(bindingObjects);
                    }
                    // 指定子List的parent、监听子List的changes事件
                    bindingList.parent = this;
                    bindingList.changes.subscribe((change) => {
                        change.path.unshift(propertyName);
                        this.changes.next(change);
                    });
                }
                return bindingList;
            },
            set: function (bindingList) {
                this[key] = bindingList;
            }
        });
    }
    /**
     * 扩展原型对象属性
     * @param typePrototype
     * @param property
     */
    static extendObjectProperty(typePrototype, property) {
        const propertyName = property.name;
        const childObjectProperties = PropertyUtil.getProperties(property.entityType);
        const key = `_${propertyName}_`;
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                let bindingObject = this[key];
                if (!bindingObject) {
                    const value = this.getValue(propertyName) || {};
                    bindingObject = BindingObjectTypeFactory.create(childObjectProperties);
                    this[key] = bindingObject;
                    // 指定子Object的parent、监听子Object的changes事件
                    bindingObject.parent = this;
                    bindingObject.changes.subscribe((change) => {
                        change.path.unshift(propertyName);
                        this.changes.next(change);
                    });
                }
                return bindingObject;
            },
            set: function (value) {
                this[key] = value;
            }
        });
    }
    /**
     * 扩展原型动态属性
     * @param typePrototype
     * @param property
     */
    static extendDynamicObjectProperty(typePrototype, property) {
        const propertyName = property.name;
        // Object.defineProperty(typePrototype, propertyName, {
        //   value: null
        // });
        typePrototype[propertyName] = null;
    }
    /**
     * 扩展原型简单属性
     * @param typePrototype
     * @param property
     */
    static extendPlainProperty(typePrototype, property) {
        const propertyName = property.name;
        Object.defineProperty(typePrototype, propertyName, {
            get: function () {
                if (property.enableMultiLangInput === true) {
                    let value = this.getValue(propertyName, false);
                    if (!value) {
                        value = this.getValue(propertyName, false);
                        const langCode = TranslateService.getCurrentLanguage();
                        return { [langCode]: value };
                    }
                    return value;
                }
                else {
                    const value = this.getValue(propertyName);
                    return value;
                }
            },
            set: function (value) {
                const oldValue = this.getValue(propertyName);
                if (value === oldValue) {
                    return;
                }
                this.setValue(propertyName, value, true, true);
            }
        });
    }
    /**
     * 获取缓存的bindingList模板类
     * @param properties bindingList属性
     * @returns
     */
    static getType(properties) {
        if (this.provider.has(properties)) {
            return this.provider.get(properties);
        }
        const bindingObjectType = this.createType(properties);
        this.provider.set(properties, bindingObjectType);
        return bindingObjectType;
    }
}
BindingObjectTypeFactory.provider = new Map();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19vYmplY3RfdHlwZV9mYWN0b3J5LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1kYXRhL2JpbmRpbmdfb2JqZWN0X3R5cGVfZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQW1CLG1CQUFtQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFMUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRzVELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzdELG1FQUFtRTtBQUVuRTs7R0FFRztBQUNILE1BQU0sT0FBTyx3QkFBd0I7SUFFbkM7Ozs7O09BS0c7SUFDSSxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQTZCLENBQUEsZ0JBQWdCO1FBQ2hFLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuRCxPQUFPLElBQUksaUJBQWlCLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNLLE1BQU0sQ0FBQyxVQUFVLENBQUMsVUFBNkI7UUFDckQsY0FBYztRQUNkLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxpQkFBa0IsU0FBUSxpQkFBaUI7WUFDekU7Z0JBQ0UsS0FBSyxFQUFFLENBQUM7Z0JBQ1IsNERBQTREO1lBRTlELENBQUM7U0FnRUYsQ0FBQztRQUNGLE9BQU87UUFDUCxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzFELE9BQU87UUFDUCxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUNwRCxpQkFB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QUU7b0JBQ3RCLE9BQU87aUJBQ1I7Z0JBQ0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNqRCxDQUFDO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQTZCO1FBQ2xELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDakMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUN0QztRQUNELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUNqRCxPQUFPLGlCQUFpQixDQUFDO0lBQzNCLENBQUM7O0FBaFBjLGlDQUFRLEdBQWdELElBQUksR0FBRyxFQUEwQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG4vL2ltcG9ydCB7IE1hcCBhcyBJbW11dGFibGVNYXAgfSBmcm9tICdpbW11dGFibGUnO1xyXG5pbXBvcnQgeyBDaGFuZ2UgfSBmcm9tICcuL2NoYW5nZXMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nUHJvcGVydHksIEJpbmRpbmdQcm9wZXJ0eVR5cGUgfSBmcm9tICcuL2JpbmRpbmdfcHJvcGVydHknO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdCB9IGZyb20gJy4vYmluZGluZ19saXN0JztcclxuaW1wb3J0IHsgUHJvcGVydHlVdGlsIH0gZnJvbSAnLi9wcm9wZXJ0eV91dGlsJztcclxuaW1wb3J0IHsgQmFzZUJpbmRpbmdPYmplY3QgfSBmcm9tICcuL2Jhc2VfYmluZGluZ19vYmplY3QnO1xyXG5pbXBvcnQgeyBCaW5kaW5nTGlzdEZhY3RvcnkgfSBmcm9tICcuL2JpbmRpbmdfbGlzdF9mYWN0b3J5JztcclxuaW1wb3J0IHsgQ2xhc3NUeXBlIH0gZnJvbSAnLi4vZW50aXR5JztcclxuaW1wb3J0IHsgQmluZGluZ09iamVjdCB9IGZyb20gJy4vYmluZGluZ19vYmplY3QnO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnLi4vaTE4bi90cmFuc2xhdGVfc2VydmljZSc7XHJcbi8vIGltcG9ydCB7IEJpbmRpbmdPYmplY3RGYWN0b3J5IH0gZnJvbSAnLi9iaW5kaW5nX29iamVjdF9mYWN0b3J5JztcclxuXHJcbi8qKlxyXG4gKiBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnlcclxuICovXHJcbmV4cG9ydCBjbGFzcyBCaW5kaW5nT2JqZWN0VHlwZUZhY3Rvcnkge1xyXG4gIHByaXZhdGUgc3RhdGljIHByb3ZpZGVyOiBNYXA8QmluZGluZ1Byb3BlcnR5W10sIFR5cGU8QmluZGluZ09iamVjdD4+ID0gbmV3IE1hcDxCaW5kaW5nUHJvcGVydHlbXSwgVHlwZTxCaW5kaW5nT2JqZWN0Pj4oKTtcclxuICAvKipcclxuICAgKiDliJvlu7pCaW5kaW5nT2JqZWN0XHJcbiAgICogQHBhcmFtIHByb3BlcnRpZXMgXHJcbiAgICogQHBhcmFtIGRhdGEgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBjcmVhdGUocHJvcGVydGllczogQmluZGluZ1Byb3BlcnR5W10vKiwgZGF0YT86IGFueSovKSB7XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0VHlwZSA9IHRoaXMuZ2V0VHlwZShwcm9wZXJ0aWVzKTtcclxuICAgIHJldHVybiBuZXcgYmluZGluZ09iamVjdFR5cGUoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yib5bu65Y6f5Z6L57G75Z6LXHJcbiAgICogQHBhcmFtIHByb3BlcnRpZXMgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzdGF0aWMgY3JlYXRlVHlwZShwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXSk6IENsYXNzVHlwZTxCaW5kaW5nT2JqZWN0PiB7XHJcbiAgICAvLyDnu6fmib/ljp/nu5Hlrprlr7nosaHmiYDmnInlsZ7mgKdcclxuICAgIGNvbnN0IGJpbmRpbmdPYmplY3RUeXBlID0gY2xhc3MgQmluZGluZ09iamVjdFR5cGUgZXh0ZW5kcyBCYXNlQmluZGluZ09iamVjdCB7XHJcbiAgICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgLy8gdGhpcy5pbm5lclZhbHVlcyA9IEltbXV0YWJsZU1hcChPYmplY3QuYXNzaWduKHt9LCBkYXRhKSk7XHJcblxyXG4gICAgICB9XHJcbiAgICAgIC8vI2VuZHJlZ2lvbiBsb2FkXHJcblxyXG4gICAgICAvKlxyXG4gICAgICBwdWJsaWMgbG9hZChkYXRhOiBhbnkpIHtcclxuICAgICAgICAvLyBkYXRh5YyF5ZCr5aSa6K+t5a2X5q61XHJcbiAgICAgICAgdGhpcy5pbm5lclZhbHVlcyA9IEltbXV0YWJsZU1hcChPYmplY3QuYXNzaWduKHt9LCBkYXRhKSk7XHJcbiAgICAgICAgdGhpcy5wcm9wZXJ0aWVzLmZvckVhY2goKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpID0+IHtcclxuICAgICAgICAgIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLkxpc3QpIHtcclxuICAgICAgICAgICAgdGhpcy5sb2FkTGlzdHMocHJvcGVydHkpO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLk9iamVjdCkge1xyXG4gICAgICAgICAgICB0aGlzLmxvYWRPYmplY3RzKHByb3BlcnR5KTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5EeW5hbWljKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZER5bmFtaWNPYmplY3RzKHByb3BlcnR5KTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9hZEZpZWxkcyhwcm9wZXJ0eSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgcHJpdmF0ZSBsb2FkRmllbGRzKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICAgIGNvbnN0IGRhdGFGaWVsZCA9IHByb3BlcnR5LmRhdGFGaWVsZCB8fCBwcm9wZXJ0eU5hbWU7XHJcbiAgICAgICAgbGV0IHZhbHVlO1xyXG4gICAgICAgIGlmIChwcm9wZXJ0eS5lbmFibGVNdWx0aUxhbmdJbnB1dCkge1xyXG4gICAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKGRhdGFGaWVsZCwgZmFsc2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpc1twcm9wZXJ0eU5hbWVdID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgICAgcHJpdmF0ZSBsb2FkTGlzdHMocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkge1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gYF8ke3Byb3BlcnR5TmFtZX1fYDtcclxuICAgICAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzW2tleV07XHJcbiAgICAgICAgaWYgKGJpbmRpbmdMaXN0KSB7XHJcbiAgICAgICAgICBjb25zdCBjaGlsZExpc3RQcm9wZXJ0aWVzID0gUHJvcGVydHlVdGlsLmdldFByb3BlcnRpZXMocHJvcGVydHkuZW50aXR5VHlwZSk7XHJcbiAgICAgICAgICBjb25zdCBkYXRhOiBhbnlbXSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGlmIChkYXRhKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3RzID0gZGF0YS5tYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IEJpbmRpbmdPYmplY3RUeXBlRmFjdG9yeS5jcmVhdGUoY2hpbGRMaXN0UHJvcGVydGllcyk7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGJpbmRpbmdPYmplY3Q7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBiaW5kaW5nTGlzdC5sb2FkKGJpbmRpbmdPYmplY3RzKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcHJpdmF0ZSBsb2FkT2JqZWN0cyhwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSB7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgICAgICBjb25zdCBrZXkgPSBgXyR7cHJvcGVydHlOYW1lfV9gO1xyXG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpIHx8IHt9O1xyXG4gICAgICAgIGNvbnN0IGNoaWxkT2JqZWN0UHJvcGVydGllcyA9IFByb3BlcnR5VXRpbC5nZXRQcm9wZXJ0aWVzKHByb3BlcnR5LmVudGl0eVR5cGUpO1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBCaW5kaW5nT2JqZWN0VHlwZUZhY3RvcnkuY3JlYXRlKGNoaWxkT2JqZWN0UHJvcGVydGllcyk7XHJcbiAgICAgICAgdGhpc1trZXldID0gYmluZGluZ09iamVjdDtcclxuXHJcbiAgICAgIH1cclxuICAgICAgcHJpdmF0ZSBsb2FkRHluYW1pY09iamVjdHMocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkge1xyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSkgfHwge307XHJcbiAgICAgICAgY29uc3QgZHluYW1pY09iamVjdCA9IEJpbmRpbmdPYmplY3RGYWN0b3J5LmNyZWF0ZUR5bmFtaWNCaW5kaW5nT2JqZWN0KHZhbHVlKTtcclxuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgICB2YWx1ZTogZHluYW1pY09iamVjdFxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9Ki9cclxuICAgICAgLy8jZW5kcmVnaW9uXHJcbiAgICB9O1xyXG4gICAgLy8g6I635Y+W5Li76ZSuXHJcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gUHJvcGVydHlVdGlsLmdldFByaW1hcnlLZXkocHJvcGVydGllcyk7XHJcbiAgICAvLyDorr7nva7kuLvplK5cclxuICAgIGJpbmRpbmdPYmplY3RUeXBlLnByb3RvdHlwZS5wcmltYXJ5S2V5ID0gcHJpbWFyeUtleTtcclxuICAgIGJpbmRpbmdPYmplY3RUeXBlLnByb3RvdHlwZS5wcm9wZXJ0aWVzID0gcHJvcGVydGllcztcclxuICAgIC8vIOWwhuWxnuaAp+aJqeWxleWIsOWOn+Wei+WvueixoeS4ilxyXG4gICAgdGhpcy5leHRlbmRQcm9wZXJ0aWVzKGJpbmRpbmdPYmplY3RUeXBlLnByb3RvdHlwZSwgcHJvcGVydGllcyk7XHJcbiAgICByZXR1cm4gYmluZGluZ09iamVjdFR5cGU7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleWOn+Wei+WxnuaAp1xyXG4gICAqIEBwYXJhbSB0eXBlUHJvdG90eXBlIFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZFByb3BlcnRpZXModHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdKSB7XHJcbiAgICAvLyDmianlsZVCaW5kaW5nT2JqZWN05bGe5oCnXHJcbiAgICBwcm9wZXJ0aWVzLmZvckVhY2goKHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpID0+IHtcclxuICAgICAgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuTGlzdCkge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kTGlzdFByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5KTtcclxuICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLk9iamVjdCkge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kT2JqZWN0UHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHkpO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuRHluYW1pYykge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kRHluYW1pY09iamVjdFByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmV4dGVuZFBsYWluUHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHkpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L5YiX6KGo5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGUgXHJcbiAgICogQHBhcmFtIHByb3BlcnR5IFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZExpc3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlOiBCYXNlQmluZGluZ09iamVjdCwgcHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgIGNvbnN0IGNoaWxkTGlzdFByb3BlcnRpZXMgPSBQcm9wZXJ0eVV0aWwuZ2V0UHJvcGVydGllcyhwcm9wZXJ0eS5lbnRpdHlUeXBlKTtcclxuICAgIGNvbnN0IGtleSA9IGBfJHtwcm9wZXJ0eU5hbWV9X2A7XHJcbiAgICAvLyDlsIblrZDnmoRCaW5kaW5nTGlzdOWunuS+i+i1i+WAvOe7meW9k+WJjeWxnuaAp1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsZXQgYmluZGluZ0xpc3QgPSB0aGlzW2tleV07XHJcbiAgICAgICAgaWYgKCFiaW5kaW5nTGlzdCkge1xyXG4gICAgICAgICAgYmluZGluZ0xpc3QgPSBCaW5kaW5nTGlzdEZhY3RvcnkuY3JlYXRlKGNoaWxkTGlzdFByb3BlcnRpZXMpO1xyXG4gICAgICAgICAgdGhpc1trZXldID0gYmluZGluZ0xpc3Q7XHJcbiAgICAgICAgICAvLyDliqDovb3mlbDmja5cclxuICAgICAgICAgIGNvbnN0IGRhdGE6IGFueVtdID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdHMgPSBkYXRhLm1hcChpdGVtID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gQmluZGluZ09iamVjdFR5cGVGYWN0b3J5LmNyZWF0ZShjaGlsZExpc3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgICAgICByZXR1cm4gYmluZGluZ09iamVjdDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIGJpbmRpbmdMaXN0LmxvYWQoYmluZGluZ09iamVjdHMpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5oyH5a6a5a2QTGlzdOeahHBhcmVudOOAgeebkeWQrOWtkExpc3TnmoRjaGFuZ2Vz5LqL5Lu2XHJcbiAgICAgICAgICBiaW5kaW5nTGlzdC5wYXJlbnQgPSB0aGlzO1xyXG4gICAgICAgICAgYmluZGluZ0xpc3QuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgICAgICAgIGNoYW5nZS5wYXRoLnVuc2hpZnQocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoY2hhbmdlKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gYmluZGluZ0xpc3Q7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCkge1xyXG4gICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdMaXN0O1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L5a+56LGh5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGUgXHJcbiAgICogQHBhcmFtIHByb3BlcnR5IFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZE9iamVjdFByb3BlcnR5KHR5cGVQcm90b3R5cGU6IEJhc2VCaW5kaW5nT2JqZWN0LCBwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KTogdm9pZCB7XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgY29uc3QgY2hpbGRPYmplY3RQcm9wZXJ0aWVzID0gUHJvcGVydHlVdGlsLmdldFByb3BlcnRpZXMocHJvcGVydHkuZW50aXR5VHlwZSk7XHJcbiAgICBjb25zdCBrZXkgPSBgXyR7cHJvcGVydHlOYW1lfV9gO1xyXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHR5cGVQcm90b3R5cGUsIHByb3BlcnR5TmFtZSwge1xyXG4gICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBsZXQgYmluZGluZ09iamVjdCA9IHRoaXNba2V5XTtcclxuICAgICAgICBpZiAoIWJpbmRpbmdPYmplY3QpIHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpIHx8IHt9O1xyXG4gICAgICAgICAgYmluZGluZ09iamVjdCA9IEJpbmRpbmdPYmplY3RUeXBlRmFjdG9yeS5jcmVhdGUoY2hpbGRPYmplY3RQcm9wZXJ0aWVzKTtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IGJpbmRpbmdPYmplY3Q7XHJcbiAgICAgICAgICAvLyDmjIflrprlrZBPYmplY3TnmoRwYXJlbnTjgIHnm5HlkKzlrZBPYmplY3TnmoRjaGFuZ2Vz5LqL5Lu2XHJcbiAgICAgICAgICBiaW5kaW5nT2JqZWN0LnBhcmVudCA9IHRoaXM7XHJcbiAgICAgICAgICBiaW5kaW5nT2JqZWN0LmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICAgICAgICBjaGFuZ2UucGF0aC51bnNoaWZ0KHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KGNoYW5nZSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGJpbmRpbmdPYmplY3Q7XHJcbiAgICAgIH0sXHJcbiAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlOiBCYXNlQmluZGluZ09iamVjdCkge1xyXG4gICAgICAgIHRoaXNba2V5XSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L5Yqo5oCB5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGUgXHJcbiAgICogQHBhcmFtIHByb3BlcnR5IFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZER5bmFtaWNPYmplY3RQcm9wZXJ0eSh0eXBlUHJvdG90eXBlOiBCYXNlQmluZGluZ09iamVjdCwgcHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSk6IHZvaWQge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgIC8vIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0eXBlUHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgIC8vICAgdmFsdWU6IG51bGxcclxuICAgIC8vIH0pO1xyXG4gICAgdHlwZVByb3RvdHlwZVtwcm9wZXJ0eU5hbWVdID0gbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5omp5bGV5Y6f5Z6L566A5Y2V5bGe5oCnXHJcbiAgICogQHBhcmFtIHR5cGVQcm90b3R5cGUgXHJcbiAgICogQHBhcmFtIHByb3BlcnR5IFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZFBsYWluUHJvcGVydHkodHlwZVByb3RvdHlwZTogQmFzZUJpbmRpbmdPYmplY3QsIHByb3BlcnR5OiBCaW5kaW5nUHJvcGVydHkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5Lm5hbWU7XHJcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodHlwZVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgIGdldDogZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIGlmIChwcm9wZXJ0eS5lbmFibGVNdWx0aUxhbmdJbnB1dCA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUsIGZhbHNlKTtcclxuICAgICAgICAgIGlmICghdmFsdWUpIHtcclxuICAgICAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKHByb3BlcnR5TmFtZSwgZmFsc2UpO1xyXG4gICAgICAgICAgICBjb25zdCBsYW5nQ29kZSA9IFRyYW5zbGF0ZVNlcnZpY2UuZ2V0Q3VycmVudExhbmd1YWdlKCk7XHJcbiAgICAgICAgICAgIHJldHVybiB7IFtsYW5nQ29kZV06IHZhbHVlIH07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgIGlmICh2YWx1ZSA9PT0gb2xkVmFsdWUpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zZXRWYWx1ZShwcm9wZXJ0eU5hbWUsIHZhbHVlLCB0cnVlLCB0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlue8k+WtmOeahGJpbmRpbmdMaXN05qih5p2/57G7XHJcbiAgICogQHBhcmFtIHByb3BlcnRpZXMgYmluZGluZ0xpc3TlsZ7mgKdcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcml2YXRlIHN0YXRpYyBnZXRUeXBlKHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdKTogVHlwZTxCaW5kaW5nT2JqZWN0PiB7XHJcbiAgICBpZiAodGhpcy5wcm92aWRlci5oYXMocHJvcGVydGllcykpIHtcclxuICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZXIuZ2V0KHByb3BlcnRpZXMpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYmluZGluZ09iamVjdFR5cGUgPSB0aGlzLmNyZWF0ZVR5cGUocHJvcGVydGllcyk7XHJcbiAgICB0aGlzLnByb3ZpZGVyLnNldChwcm9wZXJ0aWVzLCBiaW5kaW5nT2JqZWN0VHlwZSk7XHJcbiAgICByZXR1cm4gYmluZGluZ09iamVjdFR5cGU7XHJcbiAgfVxyXG59Il19