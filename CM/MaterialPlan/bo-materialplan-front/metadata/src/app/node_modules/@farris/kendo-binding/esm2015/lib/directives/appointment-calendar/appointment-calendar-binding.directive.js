import { Directive, HostListener, Injector, Input } from '@angular/core';
import { ChangeType, FrameContext } from '@farris/devkit';
import { AppointmentCalendarComponent } from '@farris/appointment-calendar';
import { ViewType } from './types';
export class AppointmentCalendarBindingDirective {
    constructor(injector, frameContext, calendarComponent) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.calendarComponent = calendarComponent;
        /**
         * 房间列表api url
         */
        this.url = null;
        /**
         * http method, default PUT
         */
        this.method = 'PUT';
        this.startDateVariable = 'startDate';
        this.endDateVariable = 'endDate';
        this.viewTypeVariable = 'viewType';
    }
    get bindingData() {
        return this.frameContext.bindingData;
    }
    get viewModel() {
        return this.frameContext.viewModel;
    }
    restService() {
        return this.frameContext.repository.restService;
    }
    /**
     * 获取绑定数据
     */
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.bindingData.getValue(filteredPaths);
    }
    ngOnInit() {
        this.loadPlacements();
        this.registerBindingDataChangeEvent();
    }
    ngOnChanges(changes) {
    }
    ngOnDestroy() {
        this.unRegisterBindingDataChangeEvent();
    }
    bindData(change) {
        // 再toJSON
        let data = this.bindingList.toJSON();
        this.calendarComponent.loadReserveData(data);
    }
    onBindingDataChange(change) {
        this.bindData(change);
        this.updateSelectedRow(change);
    }
    registerBindingDataChangeEvent() {
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe((change) => {
            this.onBindingDataChange(change);
        });
    }
    /**
     * 取消bindingdata变化订阅
     */
    unRegisterBindingDataChangeEvent() {
        if (this.bindingDataChangeEvent && typeof (this.bindingDataChangeEvent.unsubscribe) === 'function') {
            this.bindingDataChangeEvent.unsubscribe();
        }
    }
    loadPlacements() {
        if (!this.url) {
            console.log('无法加载房间信息，请配置房间列表api地址');
            return;
        }
        const requestInfo = this.restService().buildRequestInfo();
        const options = {
            body: {
                requestInfo
            }
        };
        this.restService().request(this.url, this.method, null, options).subscribe((returnValue) => {
            this.bindPlacements(returnValue);
        });
    }
    bindPlacements(placments) {
        this.calendarComponent.loadPlaceData(placments);
    }
    updateState(startDate, endDate, viewType) {
        this.viewModel.uiState.setPropertyValue(this.startDateVariable, startDate);
        this.viewModel.uiState.setPropertyValue(this.endDateVariable, endDate);
        this.viewModel.uiState.setPropertyValue(this.viewTypeVariable, viewType);
    }
    updateSelectedRow(change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        // 页码切换时不执行当前行切换
        if (change && change.type === ChangeType.PaginationInfoChange) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        const id = this.calendarComponent.selectedId;
        const currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (id === currentId) {
            return;
        }
        this.selectCalendarRow(this.bindingList.currentId);
    }
    selectCalendarRow(id) {
        this.calendarComponent.selectItem(id);
    }
    filterChanged(event) {
        const { dateValue = null, place = null, viewType = null } = event || {};
        let startDate = null;
        let endDate = null;
        if (!dateValue) {
            return;
        }
        if (viewType === ViewType.day) {
            startDate = `${dateValue} 00:00:00`;
            endDate = `${dateValue} 23:59:59`;
        }
        else if (viewType === ViewType.week && dateValue.indexOf('~') !== -1) {
            const sections = dateValue.split('~');
            startDate = `${sections[0]} 00:00:00`;
            endDate = `${sections[1]} 23:59:59`;
        }
        this.updateState(startDate, endDate, viewType);
    }
    setSelectionIdToBindingData(id) {
        // 如果当前行不存在，则强制设置
        if (this.bindingList.currentId !== id) {
            this.bindingList.setCurrentId(id, true);
        }
    }
    selectChange(event) {
        const { item: { id = null } } = event;
        this.setSelectionIdToBindingData(id);
    }
}
AppointmentCalendarBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farris-appointment-calendar-binding]'
            },] }
];
/** @nocollapse */
AppointmentCalendarBindingDirective.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: AppointmentCalendarComponent }
];
AppointmentCalendarBindingDirective.propDecorators = {
    url: [{ type: Input }],
    method: [{ type: Input }],
    startDateVariable: [{ type: Input }],
    endDateVariable: [{ type: Input }],
    viewTypeVariable: [{ type: Input }],
    filterChanged: [{ type: HostListener, args: ['filterChange', ['$event'],] }],
    selectChange: [{ type: HostListener, args: ['selectChange', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwb2ludG1lbnQtY2FsZW5kYXItYmluZGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9hcHBvaW50bWVudC1jYWxlbmRhci9hcHBvaW50bWVudC1jYWxlbmRhci1iaW5kaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxZQUFZLEVBQzlDLFFBQVEsRUFBRSxLQUFLLEVBQ3RDLE1BQU0sZUFBZSxDQUFDO0FBR3ZCLE9BQU8sRUFBb0MsVUFBVSxFQUF5QixZQUFZLEVBQWdGLE1BQU0sZ0JBQWdCLENBQUM7QUFDak0sT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDNUUsT0FBTyxFQUFpQyxRQUFRLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFLbEUsTUFBTSxPQUFPLG1DQUFtQztJQXlDOUMsWUFBb0IsUUFBa0IsRUFBVSxZQUEwQixFQUFVLGlCQUErQztRQUEvRyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxzQkFBaUIsR0FBakIsaUJBQWlCLENBQThCO1FBWm5JOztXQUVHO1FBQ00sUUFBRyxHQUFXLElBQUksQ0FBQztRQUM1Qjs7V0FFRztRQUNNLFdBQU0sR0FBVyxLQUFLLENBQUM7UUFDdkIsc0JBQWlCLEdBQVcsV0FBVyxDQUFDO1FBQ3hDLG9CQUFlLEdBQVcsU0FBUyxDQUFDO1FBQ3BDLHFCQUFnQixHQUFXLFVBQVUsQ0FBQztJQUV3RixDQUFDO0lBdkN4SSxJQUFZLFdBQVc7UUFDckIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztJQUN2QyxDQUFDO0lBQ0QsSUFBWSxTQUFTO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUM7SUFDckMsQ0FBQztJQUNPLFdBQVc7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aUI7UUFDakIsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsS0FBSyxFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3pDO0lBQ0gsQ0FBQztJQUVNLFlBQVksQ0FBQyxLQUFLO1FBQ3ZCLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEdBQUcsSUFBSSxFQUFFLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFDdEMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7OztZQXZKRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHVDQUF1QzthQUNsRDs7OztZQVZ1QixRQUFRO1lBSThDLFlBQVk7WUFDakYsNEJBQTRCOzs7a0JBc0NsQyxLQUFLO3FCQUlMLEtBQUs7Z0NBQ0wsS0FBSzs4QkFDTCxLQUFLOytCQUNMLEtBQUs7NEJBaUZMLFlBQVksU0FBQyxjQUFjLEVBQUUsQ0FBQyxRQUFRLENBQUM7MkJBd0J2QyxZQUFZLFNBQUMsY0FBYyxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICBEaXJlY3RpdmUsIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIFNpbXBsZUNoYW5nZXMsIEhvc3RMaXN0ZW5lcixcclxuICBFdmVudEVtaXR0ZXIsIE91dHB1dCwgSW5qZWN0b3IsIElucHV0XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIGZpbmFsaXplIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIENoYW5nZSwgQ2hhbmdlVHlwZSwgVmlld01vZGVsLCBBcHBDb250ZXh0LCBGcmFtZUNvbnRleHQsIEZpZWxkTWV0YWRhdGFVdGlsLCBEYXRhVHlwZUluZm8sIEJpbmRpbmdPYmplY3QsIEVudGl0eVBhdGhDb252ZXJ0ZXIsIFJ1bk1vZGUgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEFwcG9pbnRtZW50Q2FsZW5kYXJDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL2FwcG9pbnRtZW50LWNhbGVuZGFyJztcclxuaW1wb3J0IHsgQmVmUmVzdFNlcnZpY2UsIEJlZlJlcG9zaXRvcnksIFZpZXdUeXBlIH0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXMtYXBwb2ludG1lbnQtY2FsZW5kYXItYmluZGluZ10nXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBBcHBvaW50bWVudENhbGVuZGFyQmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgYmluZGluZ0RhdGFDaGFuZ2VFdmVudDogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgZ2V0IGJpbmRpbmdEYXRhKCk6IEJpbmRpbmdEYXRhIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgdmlld01vZGVsKCk6IFZpZXdNb2RlbCB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsO1xyXG4gIH1cclxuICBwcml2YXRlIHJlc3RTZXJ2aWNlKCk6IEJlZlJlc3RTZXJ2aWNlIHtcclxuICAgIHJldHVybiAodGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5KS5yZXN0U2VydmljZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBiaW5kaW5nTGlzdCgpOiBCaW5kaW5nTGlzdCB7XHJcbiAgICAvLyDmoLnlrp7kvZNcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gJy8nIHx8ICF0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5saXN0O1xyXG4gICAgfVxyXG4gICAgLy8g5a2Q5a6e5L2TXHJcbiAgICBsZXQgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zdWJzdHIoMSk7XHJcbiAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoWzBdLnRvTG93ZXJDYXNlKCkgKyBiaW5kaW5nUGF0aC5zdWJzdHJpbmcoMSwgYmluZGluZ1BhdGgubGVuZ3RoKTtcclxuICAgIGNvbnN0IHBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcclxuXHJcbiAgICBjb25zdCBmaWx0ZXJlZFBhdGhzID0gcGF0aHMuZmlsdGVyKChwYXJ0OiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuIHBhcnQgIT09ICcnO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShmaWx0ZXJlZFBhdGhzKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5oi/6Ze05YiX6KGoYXBpIHVybFxyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHVybDogc3RyaW5nID0gbnVsbDtcclxuICAvKipcclxuICAgKiBodHRwIG1ldGhvZCwgZGVmYXVsdCBQVVRcclxuICAgKi9cclxuICBASW5wdXQoKSBtZXRob2Q6IHN0cmluZyA9ICdQVVQnO1xyXG4gIEBJbnB1dCgpIHN0YXJ0RGF0ZVZhcmlhYmxlOiBzdHJpbmcgPSAnc3RhcnREYXRlJztcclxuICBASW5wdXQoKSBlbmREYXRlVmFyaWFibGU6IHN0cmluZyA9ICdlbmREYXRlJztcclxuICBASW5wdXQoKSB2aWV3VHlwZVZhcmlhYmxlOiBzdHJpbmcgPSAndmlld1R5cGUnO1xyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSBjYWxlbmRhckNvbXBvbmVudDogQXBwb2ludG1lbnRDYWxlbmRhckNvbXBvbmVudCkgeyB9XHJcblxyXG4gIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5sb2FkUGxhY2VtZW50cygpO1xyXG4gICAgdGhpcy5yZWdpc3RlckJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQoKTtcclxuICB9XHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xyXG5cclxuICB9XHJcbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XHJcbiAgICB0aGlzLnVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgYmluZERhdGEoY2hhbmdlOiBDaGFuZ2UpIHtcclxuICAgIC8vIOWGjXRvSlNPTlxyXG4gICAgbGV0IGRhdGE6IGFueSA9IHRoaXMuYmluZGluZ0xpc3QudG9KU09OKCk7XHJcbiAgICB0aGlzLmNhbGVuZGFyQ29tcG9uZW50LmxvYWRSZXNlcnZlRGF0YShkYXRhKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBvbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZTogQ2hhbmdlKSB7XHJcbiAgICB0aGlzLmJpbmREYXRhKGNoYW5nZSk7XHJcbiAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkUm93KGNoYW5nZSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50ID0gdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgdGhpcy5vbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Y+W5raIYmluZGluZ2RhdGHlj5jljJborqLpmIVcclxuICAgKi9cclxuICBwcml2YXRlIHVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgaWYgKHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudCAmJiB0eXBlb2YgKHRoaXMuYmluZGluZ0RhdGFDaGFuZ2VFdmVudC51bnN1YnNjcmliZSkgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50LnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgbG9hZFBsYWNlbWVudHMoKSB7XHJcbiAgICBpZiAoIXRoaXMudXJsKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCfml6Dms5XliqDovb3miL/pl7Tkv6Hmga/vvIzor7fphY3nva7miL/pl7TliJfooahhcGnlnLDlnYAnKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSB0aGlzLnJlc3RTZXJ2aWNlKCkuYnVpbGRSZXF1ZXN0SW5mbygpO1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keToge1xyXG4gICAgICAgIHJlcXVlc3RJbmZvXHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICB0aGlzLnJlc3RTZXJ2aWNlKCkucmVxdWVzdCh0aGlzLnVybCwgdGhpcy5tZXRob2QsIG51bGwsIG9wdGlvbnMpLnN1YnNjcmliZSgocmV0dXJuVmFsdWU6IGFueSkgPT4ge1xyXG4gICAgICB0aGlzLmJpbmRQbGFjZW1lbnRzKHJldHVyblZhbHVlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIGJpbmRQbGFjZW1lbnRzKHBsYWNtZW50czogYW55KSB7XHJcbiAgICB0aGlzLmNhbGVuZGFyQ29tcG9uZW50LmxvYWRQbGFjZURhdGEocGxhY21lbnRzKTtcclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVTdGF0ZShzdGFydERhdGU6IHN0cmluZywgZW5kRGF0ZTogc3RyaW5nLCB2aWV3VHlwZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUodGhpcy5zdGFydERhdGVWYXJpYWJsZSwgc3RhcnREYXRlKTtcclxuICAgIHRoaXMudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSh0aGlzLmVuZERhdGVWYXJpYWJsZSwgZW5kRGF0ZSk7XHJcbiAgICB0aGlzLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUodGhpcy52aWV3VHlwZVZhcmlhYmxlLCB2aWV3VHlwZSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlU2VsZWN0ZWRSb3coY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBpZiAoIXRoaXMuYmluZGluZ0xpc3QgfHwgIXRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOmhteeggeWIh+aNouaXtuS4jeaJp+ihjOW9k+WJjeihjOWIh+aNolxyXG4gICAgaWYgKGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5QYWdpbmF0aW9uSW5mb0NoYW5nZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLnJvd1NlbGVjdGVkRXZlbnRTdXNwZW5kID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGlkID0gdGhpcy5jYWxlbmRhckNvbXBvbmVudC5zZWxlY3RlZElkO1xyXG4gICAgY29uc3QgY3VycmVudElkID0gdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICAvLyBncmlk5b2T5YmN6KGM5LiOYmluZ2luZ0xpc3TlvZPliY3ooYzkuIDoh7TvvIzml6DpobvliIfmjaJcclxuICAgIGlmIChpZCA9PT0gY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuc2VsZWN0Q2FsZW5kYXJSb3codGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQpO1xyXG4gIH1cclxuICBwcml2YXRlIHNlbGVjdENhbGVuZGFyUm93KGlkOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuY2FsZW5kYXJDb21wb25lbnQuc2VsZWN0SXRlbShpZCk7XHJcbiAgfVxyXG4gIEBIb3N0TGlzdGVuZXIoJ2ZpbHRlckNoYW5nZScsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIGZpbHRlckNoYW5nZWQoZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyBkYXRlVmFsdWUgPSBudWxsLCBwbGFjZSA9IG51bGwsIHZpZXdUeXBlID0gbnVsbCB9ID0gZXZlbnQgfHwge307XHJcbiAgICBsZXQgc3RhcnREYXRlID0gbnVsbDtcclxuICAgIGxldCBlbmREYXRlID0gbnVsbDtcclxuICAgIGlmICghZGF0ZVZhbHVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICh2aWV3VHlwZSA9PT0gVmlld1R5cGUuZGF5KSB7XHJcbiAgICAgIHN0YXJ0RGF0ZSA9IGAke2RhdGVWYWx1ZX0gMDA6MDA6MDBgO1xyXG4gICAgICBlbmREYXRlID0gYCR7ZGF0ZVZhbHVlfSAyMzo1OTo1OWA7XHJcbiAgICB9IGVsc2UgaWYgKHZpZXdUeXBlID09PSBWaWV3VHlwZS53ZWVrICYmIGRhdGVWYWx1ZS5pbmRleE9mKCd+JykgIT09IC0xKSB7XHJcbiAgICAgIGNvbnN0IHNlY3Rpb25zID0gZGF0ZVZhbHVlLnNwbGl0KCd+Jyk7XHJcbiAgICAgIHN0YXJ0RGF0ZSA9IGAke3NlY3Rpb25zWzBdfSAwMDowMDowMGA7XHJcbiAgICAgIGVuZERhdGUgPSBgJHtzZWN0aW9uc1sxXX0gMjM6NTk6NTlgO1xyXG4gICAgfVxyXG4gICAgdGhpcy51cGRhdGVTdGF0ZShzdGFydERhdGUsIGVuZERhdGUsIHZpZXdUeXBlKTtcclxuICB9XHJcbiAgcHJvdGVjdGVkIHNldFNlbGVjdGlvbklkVG9CaW5kaW5nRGF0YShpZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAvLyDlpoLmnpzlvZPliY3ooYzkuI3lrZjlnKjvvIzliJnlvLrliLborr7nva5cclxuICAgIGlmICh0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCAhPT0gaWQpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQsIHRydWUpO1xyXG4gICAgfVxyXG4gIH1cclxuICBASG9zdExpc3RlbmVyKCdzZWxlY3RDaGFuZ2UnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBzZWxlY3RDaGFuZ2UoZXZlbnQpIHtcclxuICAgIGNvbnN0IHsgaXRlbTogeyBpZCA9IG51bGwgfSB9ID0gZXZlbnQ7XHJcbiAgICB0aGlzLnNldFNlbGVjdGlvbklkVG9CaW5kaW5nRGF0YShpZCk7XHJcbiAgfVxyXG59Il19