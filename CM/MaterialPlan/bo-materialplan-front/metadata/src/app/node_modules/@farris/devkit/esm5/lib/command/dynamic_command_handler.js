import * as tslib_1 from "tslib";
import { ReflectiveInjector } from '@angular/core';
import { isObservable, of, Subject } from 'rxjs';
import { CommandHandler } from './command_handler';
var DynamicCommandHandler = /** @class */ (function (_super) {
    tslib_1.__extends(DynamicCommandHandler, _super);
    function DynamicCommandHandler(commandName, method) {
        var _this = _super.call(this) || this;
        _this.commandName = commandName;
        _this.method = method;
        return _this;
    }
    DynamicCommandHandler.prototype.dynamicInvoke = function (serviceTocken, method, args, context) {
        var serviceInstance = context.frameContext.injector.get(serviceTocken, null);
        if (serviceInstance) {
            this.setContextToServiceInstance(serviceInstance, context);
            var parsedStageParams = this.parseService.parse(args, context);
            var parsedArgs = parsedStageParams.map(function (param) { return param.expression; });
            // tslint:disable-next-line: ban-types
            var serviceMethod = serviceInstance[method];
            return serviceMethod.apply(serviceInstance, parsedArgs);
        }
    };
    DynamicCommandHandler.prototype.dynamicInvoke2 = function (methodObject, context) {
        var _this = this;
        var serviceUri = methodObject.source, serviceName = methodObject.service, method = methodObject.method;
        var args = methodObject.params.map(function (stageParam) {
            return Object.assign({}, stageParam);
        });
        var result$ = new Subject();
        // const serviceSpecifer = controllerMap.imports[serviceUri] || serviceUri;
        var serviceSpecifer = serviceUri && serviceUri.toLowerCase();
        if (serviceSpecifer) {
            System.import(serviceSpecifer)
                .then(function (serviceModule) {
                var serviceConstructor = serviceModule[serviceName];
                if (serviceConstructor) {
                    var originalContextInjector_1 = context.frameContext.injector;
                    var serviceInstance = void 0;
                    // const resolvedReflectiveProviders = ReflectiveInjector.resolve([{ provide: serviceName, useClass: serviceConstructor }]);
                    if (context.frameContext.injector.get(serviceName, null)) {
                        serviceInstance = context.frameContext.injector.get(serviceName);
                    }
                    else {
                        var resolvedReflectiveProviders = _this.loadProvidersFromModule(serviceModule);
                        var reflectiveInjector = ReflectiveInjector.fromResolvedProviders(resolvedReflectiveProviders, context.frameContext.injector);
                        context.frameContext.injector = reflectiveInjector;
                        serviceInstance = reflectiveInjector.get(serviceName, null);
                    }
                    if (serviceInstance) {
                        _this.setContextToServiceInstance(serviceInstance, context);
                        var parsedStageParams = _this.parseService.parse(args, context);
                        var parsedArgs = parsedStageParams.map(function (param) { return param.expression; });
                        // tslint:disable-next-line: ban-types
                        var serviceMethod = serviceInstance[method];
                        var serviceMethodResult = serviceMethod.apply(serviceInstance, parsedArgs);
                        var result$$ = isObservable(serviceMethodResult) ? serviceMethodResult : of(serviceMethodResult);
                        result$$.subscribe({
                            next: function (result) {
                                result$.next(result);
                            },
                            error: function (error) {
                                result$.error(error);
                            },
                            complete: function () {
                                result$.complete();
                                context.frameContext.injector = originalContextInjector_1;
                            },
                        });
                        // return serviceMethod.apply(serviceInstance, parsedArgs);
                    }
                }
            });
        }
        return result$;
    };
    DynamicCommandHandler.prototype.schedule = function () {
        this.scheduleStages(this.method.stages, null);
        // this.method.stages.reduce((preStage: MethodStage, currentStage: MethodStage) => {
        //   if (currentStage.type === '0') {
        //     this.addTask(currentStage.name, (context: CommandContext) => {
        //       return this.dynamicInvoke2(currentStage as ExecutingStage, context);
        //     });
        //     if (preStage) {
        //       this.addLink(preStage.name, currentStage.name, `1===1`);
        //     }
        //   } else if (currentStage.type === '2') {
        //   } else {
        //     throw new Error(`unknow method stage type, the ${currentStage.name}'s type is ${currentStage.type}`);
        //   }
        //   return currentStage;
        // }, null);
    };
    DynamicCommandHandler.prototype.scheduleStages = function (stages, initialStage) {
        var _this = this;
        stages.reduce(function (preStage, currentStage) {
            if (currentStage.type === 'executing') {
                _this.addTask(currentStage.name, function (context) {
                    return _this.dynamicInvoke2(currentStage, context);
                });
            }
            else if (currentStage.type === 'fork') {
                var forkStages = currentStage.stages;
                forkStages.forEach(function (forkStage) {
                    _this.scheduleStages(forkStage.stages, forkStage);
                });
                _this.scheduleStages(currentStage.stages, currentStage);
            }
            else if (currentStage.type === 'determing') {
                _this.addTask(currentStage.name, function (context) {
                    return of(true);
                });
            }
            else {
                throw new Error("unknow method stage type, the " + currentStage.name + "'s type is " + currentStage.type);
            }
            if (preStage) {
                var condition = preStage.type === 'determing' ? preStage.condition : "1===1";
                _this.addLink(preStage.name, currentStage.name, condition);
            }
            return currentStage;
        }, initialStage);
    };
    DynamicCommandHandler.prototype.loadProvidersFromModule = function (serviceModule) {
        var providerArray = [];
        for (var propertyName in serviceModule) {
            if (Object.prototype.hasOwnProperty.call(serviceModule, propertyName)) {
                var propertyValue = serviceModule[propertyName];
                if (this.isInjectableService(propertyValue)) {
                    // const providerName = propertyValue.name === 'e' ? propertyName : propertyValue.name;
                    var providerName = propertyName;
                    providerArray.push({ provide: providerName, useClass: propertyValue });
                    providerArray.push(propertyValue);
                }
            }
        }
        var resolvedReflectiveProviders = ReflectiveInjector.resolve(providerArray);
        return resolvedReflectiveProviders;
    };
    DynamicCommandHandler.prototype.isInjectableService = function (propertyValue) {
        var hasInjectableDecorator = false;
        var isFunction = propertyValue instanceof Function;
        if (isFunction && propertyValue.hasOwnProperty('decorators')) {
            var decorators = propertyValue.decorators;
            var injectableDecorators = decorators.filter(function (decorator) {
                if (decorator.type && decorator.type.prototype && decorator.type.prototype.ngMetadataName === 'Injectable') {
                    return decorator;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        else if (isFunction && propertyValue.hasOwnProperty('__annotations__')) {
            var decorators = propertyValue.__annotations__;
            var injectableDecorators = decorators.filter(function (decoratorFactory) {
                if (decoratorFactory && decoratorFactory.ngMetadataName && decoratorFactory.ngMetadataName === 'Injectable') {
                    return decoratorFactory;
                }
            });
            hasInjectableDecorator = injectableDecorators && injectableDecorators.length > 0;
        }
        return hasInjectableDecorator;
    };
    return DynamicCommandHandler;
}(CommandHandler));
export { DynamicCommandHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19jb21tYW5kX2hhbmRsZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kL2R5bmFtaWNfY29tbWFuZF9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRWpELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQXdGbkQ7SUFBMkMsaURBQWM7SUFFdkQsK0JBQW1CLFdBQW1CLEVBQVUsTUFBd0I7UUFBeEUsWUFDRSxpQkFBTyxTQUNSO1FBRmtCLGlCQUFXLEdBQVgsV0FBVyxDQUFRO1FBQVUsWUFBTSxHQUFOLE1BQU0sQ0FBa0I7O0lBRXhFLENBQUM7SUFFTSw2Q0FBYSxHQUFwQixVQUFxQixhQUFxQixFQUFFLE1BQWMsRUFBRSxJQUFrQixFQUFFLE9BQXVCO1FBQ3JHLElBQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0UsSUFBSSxlQUFlLEVBQUU7WUFDbkIsSUFBSSxDQUFDLDJCQUEyQixDQUFDLGVBQWUsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUMzRCxJQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxPQUFPLENBQWlCLENBQUM7WUFDakYsSUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsS0FBSyxDQUFDLFVBQVUsRUFBaEIsQ0FBZ0IsQ0FBQyxDQUFDO1lBQ3BFLHNDQUFzQztZQUN0QyxJQUFNLGFBQWEsR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFhLENB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VUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFBLGdCQUFnQjtnQkFDN0QsSUFBSSxnQkFBZ0IsSUFBSSxnQkFBZ0IsQ0FBQyxjQUFjLElBQUksZ0JBQWdCLENBQUMsY0FBYyxLQUFLLFlBQVksRUFBRTtvQkFDM0csT0FBTyxnQkFBZ0IsQ0FBQztpQkFDekI7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUNILHNCQUFzQixHQUFHLG9CQUFvQixJQUFJLG9CQUFvQixDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7U0FDbEY7UUFDRCxPQUFPLHNCQUFzQixDQUFDO0lBQ2hDLENBQUM7SUFDSCw0QkFBQztBQUFELENBQUMsQUE1SkQsQ0FBMkMsY0FBYyxHQTRKeEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZWZsZWN0aXZlSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgaXNPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBDb21tYW5kQ29udGV4dCB9IGZyb20gJy4vY29tbWFuZF9jb250ZXh0JztcclxuaW1wb3J0IHsgQ29tbWFuZEhhbmRsZXIgfSBmcm9tICcuL2NvbW1hbmRfaGFuZGxlcic7XHJcbmltcG9ydCB7XHJcbiAgQ29udHJvbGxlck1ldGhvZCwgRGV0ZXJtaW5pbmdTdGFnZSwgRXhlY3V0aW5nU3RhZ2UsXHJcbiAgRm9ya1N0YWdlLCBNZXRob2RTdGFnZSwgU3RhZ2VQYXJhbVxyXG59IGZyb20gJy4vZHluYW1pY19jb21tYW5kX2hhbmRsZXJfbWV0YWRhdGEnO1xyXG5cclxuLyoqXHJcbiAqIEBJbmplY3RhYmxlKClcclxuICogQE5nQ29tbWFuZEhhbmRsZXIoe1xyXG4gKiAgICAgY29tbWFuZE5hbWU6ICdhZGQxJ1xyXG4gKiB9KVxyXG4gKiBleHBvcnQgY2xhc3MgYWRkMUhhbmRsZXIgZXh0ZW5kcyBDb21tYW5kSGFuZGxlciB7XHJcbiAqICAgICBjb25zdHJ1Y3RvcihcclxuICogICAgICAgICBwdWJsaWMgX0xpc3REYXRhU2VydmljZTE6IExpc3REYXRhU2VydmljZTEsXHJcbiAqICAgICAgICAgcHVibGljIF9TdGF0ZU1hY2hpbmVTZXJ2aWNlMTogU3RhdGVNYWNoaW5lU2VydmljZTFcclxuICogICAgICkge1xyXG4gKiAgICAgICAgIHN1cGVyKCk7XHJcbiAqICAgICB9XHJcbiAqXHJcbiAqICAgICBzY2hlZHVsZSgpIHtcclxuICogICAgICAgICB0aGlzLmFkZFRhc2soJ2FwcGVuZCcsIChjb250ZXh0OiBDb21tYW5kQ29udGV4dCkgPT4ge1xyXG4gKiAgICAgICAgICAgICBjb25zdCBhcmdzID0gW107XHJcbiAqICAgICAgICAgICAgIHJldHVybiB0aGlzLmludm9rZSh0aGlzLl9MaXN0RGF0YVNlcnZpY2UxLCAnYXBwZW5kJywgYXJncywgY29udGV4dCk7XHJcbiAqICAgICAgICAgfSk7XHJcbiAqXHJcbiAqICAgICAgICAgdGhpcy5hZGRUYXNrKCd0cmFuc2l0JywgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAqICAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSBbXHJcbiAqICAgICAgICAgICAgICAgICAnQ3JlYXRlJ1xyXG4gKiAgICAgICAgICAgICAgICAgICAgIF07XHJcbiAqICAgICAgICAgICAgIHJldHVybiB0aGlzLmludm9rZSh0aGlzLl9TdGF0ZU1hY2hpbmVTZXJ2aWNlMSwgJ3RyYW5zaXQnLCBhcmdzLCBjb250ZXh0KTtcclxuICogICAgICAgICB9KTtcclxuICpcclxuICogICAgICAgICB0aGlzLmFkZExpbmsoJ2FwcGVuZCcsICd0cmFuc2l0JywgYDE9PTFgKTtcclxuICogICAgIH1cclxuICogfVxyXG4gKi9cclxuXHJcbi8vIGNvbnN0IGNvbnRyb2xsZXJNYXAgPSB7XHJcbi8vICAgaW1wb3J0czoge1xyXG4vLyAgICAgVmFsaWRhdGlvblNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRm9jdXNJbnZhbGlkU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBDaGFuZ2VJdGVtU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBVSVN0YXRlU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBTdGF0ZU1hY2hpbmVTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEJpbmRpbmdEYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBDb21tYW5kU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBFbnRpdHlUcmF2ZXJzaW5nU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBFbnRpdHlNYW5pcHVsYXRpb25TZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEVudGl0eUFnZ3JlZ2F0aW9uU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBFbnRpdHlMaXN0U2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBFbnRpdHlTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIExpc3REYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBUcmVlRGF0YVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgU3ViVHJlZURhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIENhcmREYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBTdWJMaXN0RGF0YVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgUmVtb3ZlRGF0YVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgU2F2ZURhdGFTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEVkaXREYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBGaWx0ZXJDb25kaXRpb25EYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBSZW1vdGVTdW1tYXJ5U2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBCZUFjdGlvblNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgQXBwcm92ZVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgUHJpbnRTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEF0dGFjaG1lbnREYXRhU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBBdHRhY2htZW50U2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBGaWxlU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBOYXZpZ2F0aW9uTWlkZGxld2FyZVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgR3JpZE1pZGRsZXdhcmVTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIFNpZGViYXJTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEZhcnJpc0Zvcm1TZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIERpYWxvZ1NlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgTmF2aWdhdGlvbkV2ZW50U2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBOYXZpZ2F0aW9uU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBSb3V0ZXJTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIEF1dGhvcml0eVNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRW5kRWRpdFNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgQmF0Y2hFZGl0RGlhbG9nU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBCYXRjaEVkaXRTZXJ2aWNlOiAnL3BsYXRmb3JtL2NvbW1vbi93ZWIvQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLmpzJyxcclxuLy8gICAgIERpc2N1c3Npb25Hcm91cFNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgTG9jYWxpemF0aW9uU2VydmljZTogJy9wbGF0Zm9ybS9jb21tb24vd2ViL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy5qcycsXHJcbi8vICAgICBEYXRhR3JpZFNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgICAgRm9ybUF0dGVudGlvblNlcnZpY2U6ICcvcGxhdGZvcm0vY29tbW9uL3dlYi9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMuanMnLFxyXG4vLyAgIH1cclxuLy8gfTtcclxuXHJcbmRlY2xhcmUgY29uc3QgU3lzdGVtOiBhbnk7XHJcblxyXG5leHBvcnQgY2xhc3MgRHluYW1pY0NvbW1hbmRIYW5kbGVyIGV4dGVuZHMgQ29tbWFuZEhhbmRsZXIge1xyXG5cclxuICBjb25zdHJ1Y3RvcihwdWJsaWMgY29tbWFuZE5hbWU6IHN0cmluZywgcHJpdmF0ZSBtZXRob2Q6IENvbnRyb2xsZXJNZXRob2QpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZHluYW1pY0ludm9rZShzZXJ2aWNlVG9ja2VuOiBzdHJpbmcsIG1ldGhvZDogc3RyaW5nLCBhcmdzOiBTdGFnZVBhcmFtW10sIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSB7XHJcbiAgICBjb25zdCBzZXJ2aWNlSW5zdGFuY2UgPSBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQoc2VydmljZVRvY2tlbiwgbnVsbCk7XHJcbiAgICBpZiAoc2VydmljZUluc3RhbmNlKSB7XHJcbiAgICAgIHRoaXMuc2V0Q29udGV4dFRvU2VydmljZUluc3RhbmNlKHNlcnZpY2VJbnN0YW5jZSwgY29udGV4dCk7XHJcbiAgICAgIGNvbnN0IHBhcnNlZFN0YWdlUGFyYW1zID0gdGhpcy5wYXJzZVNlcnZpY2UucGFyc2UoYXJncywgY29udGV4dCkgYXMgU3RhZ2VQYXJhbVtdO1xyXG4gICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VkU3RhZ2VQYXJhbXMubWFwKHBhcmFtID0+IHBhcmFtLmV4cHJlc3Npb24pO1xyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IGJhbi10eXBlc1xyXG4gICAgICBjb25zdCBzZXJ2aWNlTWV0aG9kID0gc2VydmljZUluc3RhbmNlW21ldGhvZF0gYXMgRnVuY3Rpb247XHJcbiAgICAgIHJldHVybiBzZXJ2aWNlTWV0aG9kLmFwcGx5KHNlcnZpY2VJbnN0YW5jZSwgcGFyc2VkQXJncyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZHluYW1pY0ludm9rZTIobWV0aG9kT2JqZWN0OiBFeGVjdXRpbmdTdGFnZSwgY29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuICAgIGNvbnN0IHsgc291cmNlOiBzZXJ2aWNlVXJpLCBzZXJ2aWNlOiBzZXJ2aWNlTmFtZSwgbWV0aG9kIH0gPSBtZXRob2RPYmplY3Q7XHJcbiAgICBjb25zdCBhcmdzID0gbWV0aG9kT2JqZWN0LnBhcmFtcy5tYXAoc3RhZ2VQYXJhbSA9PiB7XHJcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCBzdGFnZVBhcmFtKTtcclxuICAgIH0pO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICAvLyBjb25zdCBzZXJ2aWNlU3BlY2lmZXIgPSBjb250cm9sbGVyTWFwLmltcG9ydHNbc2VydmljZVVyaV0gfHwgc2VydmljZVVyaTtcclxuICAgIGNvbnN0IHNlcnZpY2VTcGVjaWZlciA9IHNlcnZpY2VVcmkgJiYgc2VydmljZVVyaS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgaWYgKHNlcnZpY2VTcGVjaWZlcikge1xyXG4gICAgICBTeXN0ZW0uaW1wb3J0KHNlcnZpY2VTcGVjaWZlcilcclxuICAgICAgICAudGhlbigoc2VydmljZU1vZHVsZTogYW55KSA9PiB7XHJcbiAgICAgICAgICBjb25zdCBzZXJ2aWNlQ29uc3RydWN0b3IgPSBzZXJ2aWNlTW9kdWxlW3NlcnZpY2VOYW1lXTtcclxuICAgICAgICAgIGlmIChzZXJ2aWNlQ29uc3RydWN0b3IpIHtcclxuICAgICAgICAgICAgY29uc3Qgb3JpZ2luYWxDb250ZXh0SW5qZWN0b3IgPSBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3RvcjtcclxuICAgICAgICAgICAgbGV0IHNlcnZpY2VJbnN0YW5jZTtcclxuICAgICAgICAgICAgLy8gY29uc3QgcmVzb2x2ZWRSZWZsZWN0aXZlUHJvdmlkZXJzID0gUmVmbGVjdGl2ZUluamVjdG9yLnJlc29sdmUoW3sgcHJvdmlkZTogc2VydmljZU5hbWUsIHVzZUNsYXNzOiBzZXJ2aWNlQ29uc3RydWN0b3IgfV0pO1xyXG4gICAgICAgICAgICBpZiAoY29udGV4dC5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0KHNlcnZpY2VOYW1lLCBudWxsKSkge1xyXG4gICAgICAgICAgICAgIHNlcnZpY2VJbnN0YW5jZSA9IGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldChzZXJ2aWNlTmFtZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgcmVzb2x2ZWRSZWZsZWN0aXZlUHJvdmlkZXJzID0gdGhpcy5sb2FkUHJvdmlkZXJzRnJvbU1vZHVsZShzZXJ2aWNlTW9kdWxlKTtcclxuICAgICAgICAgICAgICBjb25zdCByZWZsZWN0aXZlSW5qZWN0b3IgPSBSZWZsZWN0aXZlSW5qZWN0b3IuZnJvbVJlc29sdmVkUHJvdmlkZXJzKHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycywgY29udGV4dC5mcmFtZUNvbnRleHQuaW5qZWN0b3IpO1xyXG4gICAgICAgICAgICAgIGNvbnRleHQuZnJhbWVDb250ZXh0LmluamVjdG9yID0gcmVmbGVjdGl2ZUluamVjdG9yO1xyXG4gICAgICAgICAgICAgIHNlcnZpY2VJbnN0YW5jZSA9IHJlZmxlY3RpdmVJbmplY3Rvci5nZXQoc2VydmljZU5hbWUsIG51bGwpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoc2VydmljZUluc3RhbmNlKSB7XHJcbiAgICAgICAgICAgICAgdGhpcy5zZXRDb250ZXh0VG9TZXJ2aWNlSW5zdGFuY2Uoc2VydmljZUluc3RhbmNlLCBjb250ZXh0KTtcclxuICAgICAgICAgICAgICBjb25zdCBwYXJzZWRTdGFnZVBhcmFtcyA9IHRoaXMucGFyc2VTZXJ2aWNlLnBhcnNlKGFyZ3MsIGNvbnRleHQpIGFzIFN0YWdlUGFyYW1bXTtcclxuICAgICAgICAgICAgICBjb25zdCBwYXJzZWRBcmdzID0gcGFyc2VkU3RhZ2VQYXJhbXMubWFwKHBhcmFtID0+IHBhcmFtLmV4cHJlc3Npb24pO1xyXG4gICAgICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogYmFuLXR5cGVzXHJcbiAgICAgICAgICAgICAgY29uc3Qgc2VydmljZU1ldGhvZCA9IHNlcnZpY2VJbnN0YW5jZVttZXRob2RdIGFzIEZ1bmN0aW9uO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHNlcnZpY2VNZXRob2RSZXN1bHQgPSBzZXJ2aWNlTWV0aG9kLmFwcGx5KHNlcnZpY2VJbnN0YW5jZSwgcGFyc2VkQXJncyk7XHJcbiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0JCQgPSBpc09ic2VydmFibGUoc2VydmljZU1ldGhvZFJlc3VsdCkgPyBzZXJ2aWNlTWV0aG9kUmVzdWx0IDogb2Yoc2VydmljZU1ldGhvZFJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgcmVzdWx0JCQuc3Vic2NyaWJlKHtcclxuICAgICAgICAgICAgICAgIG5leHQ6IChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICByZXN1bHQkLm5leHQocmVzdWx0KTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBlcnJvcjogKGVycm9yOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmVzdWx0JC5lcnJvcihlcnJvcik7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgY29tcGxldGU6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgcmVzdWx0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICBjb250ZXh0LmZyYW1lQ29udGV4dC5pbmplY3RvciA9IG9yaWdpbmFsQ29udGV4dEluamVjdG9yO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAvLyByZXR1cm4gc2VydmljZU1ldGhvZC5hcHBseShzZXJ2aWNlSW5zdGFuY2UsIHBhcnNlZEFyZ3MpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIHNjaGVkdWxlKCkge1xyXG4gICAgdGhpcy5zY2hlZHVsZVN0YWdlcyh0aGlzLm1ldGhvZC5zdGFnZXMsIG51bGwpO1xyXG4gICAgLy8gdGhpcy5tZXRob2Quc3RhZ2VzLnJlZHVjZSgocHJlU3RhZ2U6IE1ldGhvZFN0YWdlLCBjdXJyZW50U3RhZ2U6IE1ldGhvZFN0YWdlKSA9PiB7XHJcbiAgICAvLyAgIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJzAnKSB7XHJcbiAgICAvLyAgICAgdGhpcy5hZGRUYXNrKGN1cnJlbnRTdGFnZS5uYW1lLCAoY29udGV4dDogQ29tbWFuZENvbnRleHQpID0+IHtcclxuICAgIC8vICAgICAgIHJldHVybiB0aGlzLmR5bmFtaWNJbnZva2UyKGN1cnJlbnRTdGFnZSBhcyBFeGVjdXRpbmdTdGFnZSwgY29udGV4dCk7XHJcbiAgICAvLyAgICAgfSk7XHJcbiAgICAvLyAgICAgaWYgKHByZVN0YWdlKSB7XHJcbiAgICAvLyAgICAgICB0aGlzLmFkZExpbmsocHJlU3RhZ2UubmFtZSwgY3VycmVudFN0YWdlLm5hbWUsIGAxPT09MWApO1xyXG4gICAgLy8gICAgIH1cclxuICAgIC8vICAgfSBlbHNlIGlmIChjdXJyZW50U3RhZ2UudHlwZSA9PT0gJzInKSB7XHJcblxyXG4gICAgLy8gICB9IGVsc2Uge1xyXG4gICAgLy8gICAgIHRocm93IG5ldyBFcnJvcihgdW5rbm93IG1ldGhvZCBzdGFnZSB0eXBlLCB0aGUgJHtjdXJyZW50U3RhZ2UubmFtZX0ncyB0eXBlIGlzICR7Y3VycmVudFN0YWdlLnR5cGV9YCk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vICAgcmV0dXJuIGN1cnJlbnRTdGFnZTtcclxuICAgIC8vIH0sIG51bGwpO1xyXG4gIH1cclxuXHJcbiAgc2NoZWR1bGVTdGFnZXMoc3RhZ2VzOiBNZXRob2RTdGFnZVtdLCBpbml0aWFsU3RhZ2U6IE1ldGhvZFN0YWdlKSB7XHJcbiAgICBzdGFnZXMucmVkdWNlKChwcmVTdGFnZTogTWV0aG9kU3RhZ2UsIGN1cnJlbnRTdGFnZTogTWV0aG9kU3RhZ2UpID0+IHtcclxuICAgICAgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZXhlY3V0aW5nJykge1xyXG4gICAgICAgIHRoaXMuYWRkVGFzayhjdXJyZW50U3RhZ2UubmFtZSwgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5keW5hbWljSW52b2tlMihjdXJyZW50U3RhZ2UgYXMgRXhlY3V0aW5nU3RhZ2UsIGNvbnRleHQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZm9yaycpIHtcclxuICAgICAgICBjb25zdCBmb3JrU3RhZ2VzID0gKGN1cnJlbnRTdGFnZSBhcyBGb3JrU3RhZ2UpLnN0YWdlcztcclxuICAgICAgICBmb3JrU3RhZ2VzLmZvckVhY2goZm9ya1N0YWdlID0+IHtcclxuICAgICAgICAgIHRoaXMuc2NoZWR1bGVTdGFnZXMoZm9ya1N0YWdlLnN0YWdlcywgZm9ya1N0YWdlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNjaGVkdWxlU3RhZ2VzKChjdXJyZW50U3RhZ2UgYXMgRGV0ZXJtaW5pbmdTdGFnZSkuc3RhZ2VzLCBjdXJyZW50U3RhZ2UpO1xyXG4gICAgICB9IGVsc2UgaWYgKGN1cnJlbnRTdGFnZS50eXBlID09PSAnZGV0ZXJtaW5nJykge1xyXG4gICAgICAgIHRoaXMuYWRkVGFzayhjdXJyZW50U3RhZ2UubmFtZSwgKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmtub3cgbWV0aG9kIHN0YWdlIHR5cGUsIHRoZSAke2N1cnJlbnRTdGFnZS5uYW1lfSdzIHR5cGUgaXMgJHtjdXJyZW50U3RhZ2UudHlwZX1gKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAocHJlU3RhZ2UpIHtcclxuICAgICAgICBjb25zdCBjb25kaXRpb24gPSBwcmVTdGFnZS50eXBlID09PSAnZGV0ZXJtaW5nJyA/IChwcmVTdGFnZSBhcyBEZXRlcm1pbmluZ1N0YWdlKS5jb25kaXRpb24gOiBgMT09PTFgO1xyXG4gICAgICAgIHRoaXMuYWRkTGluayhwcmVTdGFnZS5uYW1lLCBjdXJyZW50U3RhZ2UubmFtZSwgY29uZGl0aW9uKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm4gY3VycmVudFN0YWdlO1xyXG4gICAgfSwgaW5pdGlhbFN0YWdlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbG9hZFByb3ZpZGVyc0Zyb21Nb2R1bGUoc2VydmljZU1vZHVsZTogeyBbcHJvcGVydHlOYW1lOiBzdHJpbmddOiBhbnkgfSkge1xyXG4gICAgY29uc3QgcHJvdmlkZXJBcnJheSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eU5hbWUgaW4gc2VydmljZU1vZHVsZSkge1xyXG4gICAgICBpZiAoT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHNlcnZpY2VNb2R1bGUsIHByb3BlcnR5TmFtZSkpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlID0gc2VydmljZU1vZHVsZVtwcm9wZXJ0eU5hbWVdO1xyXG4gICAgICAgIGlmICh0aGlzLmlzSW5qZWN0YWJsZVNlcnZpY2UocHJvcGVydHlWYWx1ZSkpIHtcclxuICAgICAgICAgIC8vIGNvbnN0IHByb3ZpZGVyTmFtZSA9IHByb3BlcnR5VmFsdWUubmFtZSA9PT0gJ2UnID8gcHJvcGVydHlOYW1lIDogcHJvcGVydHlWYWx1ZS5uYW1lO1xyXG4gICAgICAgICAgY29uc3QgcHJvdmlkZXJOYW1lID0gcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgcHJvdmlkZXJBcnJheS5wdXNoKHsgcHJvdmlkZTogcHJvdmlkZXJOYW1lLCB1c2VDbGFzczogcHJvcGVydHlWYWx1ZSB9KTtcclxuICAgICAgICAgIHByb3ZpZGVyQXJyYXkucHVzaChwcm9wZXJ0eVZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycyA9IFJlZmxlY3RpdmVJbmplY3Rvci5yZXNvbHZlKHByb3ZpZGVyQXJyYXkpO1xyXG4gICAgcmV0dXJuIHJlc29sdmVkUmVmbGVjdGl2ZVByb3ZpZGVycztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaXNJbmplY3RhYmxlU2VydmljZShwcm9wZXJ0eVZhbHVlOiBhbnkpIHtcclxuICAgIGxldCBoYXNJbmplY3RhYmxlRGVjb3JhdG9yID0gZmFsc2U7XHJcbiAgICBjb25zdCBpc0Z1bmN0aW9uID0gcHJvcGVydHlWYWx1ZSBpbnN0YW5jZW9mIEZ1bmN0aW9uO1xyXG4gICAgaWYgKGlzRnVuY3Rpb24gJiYgcHJvcGVydHlWYWx1ZS5oYXNPd25Qcm9wZXJ0eSgnZGVjb3JhdG9ycycpKSB7XHJcbiAgICAgIGNvbnN0IGRlY29yYXRvcnMgPSBwcm9wZXJ0eVZhbHVlLmRlY29yYXRvcnMgYXMgYW55W107XHJcbiAgICAgIGNvbnN0IGluamVjdGFibGVEZWNvcmF0b3JzID0gZGVjb3JhdG9ycy5maWx0ZXIoZGVjb3JhdG9yID0+IHtcclxuICAgICAgICBpZiAoZGVjb3JhdG9yLnR5cGUgJiYgZGVjb3JhdG9yLnR5cGUucHJvdG90eXBlICYmIGRlY29yYXRvci50eXBlLnByb3RvdHlwZS5uZ01ldGFkYXRhTmFtZSA9PT0gJ0luamVjdGFibGUnKSB7XHJcbiAgICAgICAgICByZXR1cm4gZGVjb3JhdG9yO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGhhc0luamVjdGFibGVEZWNvcmF0b3IgPSBpbmplY3RhYmxlRGVjb3JhdG9ycyAmJiBpbmplY3RhYmxlRGVjb3JhdG9ycy5sZW5ndGggPiAwO1xyXG4gICAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uICYmIHByb3BlcnR5VmFsdWUuaGFzT3duUHJvcGVydHkoJ19fYW5ub3RhdGlvbnNfXycpKSB7XHJcbiAgICAgIGNvbnN0IGRlY29yYXRvcnMgPSBwcm9wZXJ0eVZhbHVlLl9fYW5ub3RhdGlvbnNfXyBhcyBhbnlbXTtcclxuICAgICAgY29uc3QgaW5qZWN0YWJsZURlY29yYXRvcnMgPSBkZWNvcmF0b3JzLmZpbHRlcihkZWNvcmF0b3JGYWN0b3J5ID0+IHtcclxuICAgICAgICBpZiAoZGVjb3JhdG9yRmFjdG9yeSAmJiBkZWNvcmF0b3JGYWN0b3J5Lm5nTWV0YWRhdGFOYW1lICYmIGRlY29yYXRvckZhY3RvcnkubmdNZXRhZGF0YU5hbWUgPT09ICdJbmplY3RhYmxlJykge1xyXG4gICAgICAgICAgcmV0dXJuIGRlY29yYXRvckZhY3Rvcnk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgICAgaGFzSW5qZWN0YWJsZURlY29yYXRvciA9IGluamVjdGFibGVEZWNvcmF0b3JzICYmIGluamVjdGFibGVEZWNvcmF0b3JzLmxlbmd0aCA+IDA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gaGFzSW5qZWN0YWJsZURlY29yYXRvcjtcclxuICB9XHJcbn1cclxuIl19