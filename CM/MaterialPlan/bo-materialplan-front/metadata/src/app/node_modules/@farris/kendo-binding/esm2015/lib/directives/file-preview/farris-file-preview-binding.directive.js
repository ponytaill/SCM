import { Directive, Input, Injector, Optional } from '@angular/core';
import { FrameContext, ChangeType } from '@farris/devkit';
import { FFilePreviewComponent, UploadAndPreviewComponent } from '@farris/extend-file-upload';
/**
 * 树表格绑定指令
 */
class FarrisFilePreviewBindingDirective {
    /**
     * 构造函数
     */
    constructor(previewComponent, frameContext, uploadAndPreviewComponent, injector) {
        this.previewComponent = previewComponent;
        this.frameContext = frameContext;
        this.uploadAndPreviewComponent = uploadAndPreviewComponent;
        this.injector = injector;
    }
    /**
     * 绑定数据
     */
    get bindingData() {
        return this.frameContext.bindingData;
    }
    /**
     * 绑定数据列表
     */
    get bindingList() {
        return this.bindingData.getList();
    }
    /**
     * 指令初始化
     */
    ngOnInit() {
        this.bindData();
        if (this.uploadAndPreviewComponent) {
            this.uploadAndPreviewComponent.orderField = 'fileSortOrder';
        }
        this.bindingData.changes.subscribe((change) => {
            if (change.type === ChangeType.Load
                || change.type === ChangeType.Append
                || change.type === ChangeType.Remove) {
                this.bindData();
            }
        });
    }
    /**
     * 指令输入变更
     */
    ngOnChanges(changes) {
    }
    /**
     * 绑定数据
     */
    bindData() {
        const fileInfos = this.getFileInfos();
        if (this.componentRef) {
            this.componentRef.fileInfos = fileInfos;
        }
    }
    /**
     * 获取附件信息列表
     */
    getFileInfos() {
        const listData = this.bindingList.toJSON();
        const idKey = this.bindingList.primaryKey;
        const fileInfos = [];
        listData.forEach((itemData) => {
            const id = this.getValueByPath(itemData, idKey);
            const fileId = this.getValueByPath(itemData, this.fileIdKey);
            const fileName = this.getValueByPath(itemData, this.fileNameKey);
            const fileSize = this.getValueByPath(itemData, this.fileSizeKey);
            const fileCreateTime = this.getValueByPath(itemData, this.fileCreateTimeKey);
            const fileInfo = {
                id: fileId,
                name: fileName,
                size: fileSize,
                createTime: fileCreateTime,
                originalData: itemData,
                extend: {
                    metadataId: fileId
                }
            };
            if (this.extendFileInfo && Array.isArray(this.extendFileInfo) && this.extendFileInfo.length > 0) {
                this.extendFileInfo.forEach(item => {
                    fileInfo[item.key] = this.getValueByPath(itemData, item.path);
                });
            }
            if (this.fileSortOrderKey) {
                const fileSortOrder = this.getValueByPath(itemData, this.fileSortOrderKey);
                fileInfo.fileSortOrder = fileSortOrder;
            }
            fileInfos.push(fileInfo);
        });
        return fileInfos;
    }
    /**
     * 根据字段路径获取值
     */
    getValueByPath(data, path) {
        const keys = path.split('.');
        let currentValue = data;
        keys.forEach((key) => {
            currentValue = currentValue && currentValue[key];
        });
        return currentValue;
    }
    getUdtPaths() {
        const paths = this.fileIdKey.split('.');
        paths.pop();
        return paths;
    }
    get fileSizeKey() {
        const basePaths = this.getUdtPaths();
        return basePaths.concat(['fileSize']).join('.');
    }
    get fileCreateTimeKey() {
        const basePaths = this.getUdtPaths();
        return basePaths.concat(['fileCreateTime']).join('.');
    }
    get componentRef() {
        return this.previewComponent || this.uploadAndPreviewComponent || null;
    }
}
FarrisFilePreviewBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farrisFilePreviewBinding]'
            },] }
];
/** @nocollapse */
FarrisFilePreviewBindingDirective.ctorParameters = () => [
    { type: FFilePreviewComponent, decorators: [{ type: Optional }] },
    { type: FrameContext },
    { type: UploadAndPreviewComponent, decorators: [{ type: Optional }] },
    { type: Injector, decorators: [{ type: Optional }] }
];
FarrisFilePreviewBindingDirective.propDecorators = {
    extendFileInfo: [{ type: Input, args: ['extendFileInfo',] }],
    fileIdKey: [{ type: Input, args: ['farrisFileIdKey',] }],
    fileSortOrderKey: [{ type: Input, args: ['farrisFileSortOrderKey',] }],
    fileNameKey: [{ type: Input, args: ['farrisFileNameKey',] }]
};
export { FarrisFilePreviewBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWZpbGUtcHJldmlldy1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2ZpbGUtcHJldmlldy9mYXJyaXMtZmlsZS1wcmV2aWV3LWJpbmRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQW9DLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZHLE9BQU8sRUFBNEIsWUFBWSxFQUFVLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVGLE9BQU8sRUFBYyxxQkFBcUIsRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFHOztHQUVHO0FBQ0gsTUFHTSxpQ0FBaUM7SUFrQ3JDOztPQUVHO0lBQ0gsWUFDc0IsZ0JBQXVDLEVBQ25ELFlBQTBCLEVBQ2QseUJBQW9ELEVBQ3BELFFBQWtCO1FBSGxCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBdUI7UUFDbkQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDZCw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELGFBQVEsR0FBUixRQUFRLENBQVU7SUFFeEMsQ0FBQztJQXZCRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQWFEOztPQUVHO0lBQ0gsUUFBUTtRQUNOLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLElBQUksQ0FBQyx5QkFBeUIsRUFBRTtZQUNsQyxJQUFJLENBQUMseUJBQXlCLENBQUMsVUFBVSxHQUFH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dUJBZ0RoRSxRQUFRO1lBbERnRCxRQUFRLHVCQW1EaEUsUUFBUTs7OzZCQXZDVixLQUFLLFNBQUMsZ0JBQWdCO3dCQUt0QixLQUFLLFNBQUMsaUJBQWlCOytCQUt2QixLQUFLLFNBQUMsd0JBQXdCOzBCQUs5QixLQUFLLFNBQUMsbUJBQW1COztBQW9JNUIsT0FBTyxFQUFFLGlDQUFpQyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIE9uSW5pdCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBJbnB1dCwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJpbmRpbmdEYXRhLCBCaW5kaW5nTGlzdCwgRnJhbWVDb250ZXh0LCBDaGFuZ2UsIENoYW5nZVR5cGUgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IFVwbG9hZEZpbGUsIEZGaWxlUHJldmlld0NvbXBvbmVudCwgVXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvZXh0ZW5kLWZpbGUtdXBsb2FkJztcclxuXHJcbi8qKlxyXG4gKiDmoJHooajmoLznu5HlrprmjIfku6RcclxuICovXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnW2ZhcnJpc0ZpbGVQcmV2aWV3QmluZGluZ10nXHJcbn0pXHJcbmNsYXNzIEZhcnJpc0ZpbGVQcmV2aWV3QmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcclxuXHJcbiAgQElucHV0KCdleHRlbmRGaWxlSW5mbycpXHJcbiAgcHVibGljIGV4dGVuZEZpbGVJbmZvOiB7IGtleTogc3RyaW5nLCBwYXRoOiBhbnkgfVtdO1xyXG4gIC8qKlxyXG4gICAqIOaWh+S7tmlk5a2X5q616Lev5b6EXHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXNGaWxlSWRLZXknKVxyXG4gIHB1YmxpYyBmaWxlSWRLZXk6IHN0cmluZztcclxuICAvKipcclxuICAgKiDmjpLluo/lrZfmrrVcclxuICAgKi9cclxuICBASW5wdXQoJ2ZhcnJpc0ZpbGVTb3J0T3JkZXJLZXknKVxyXG4gIHB1YmxpYyBmaWxlU29ydE9yZGVyS2V5OiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICog5paH5Lu2bmFtZeWtl+autei3r+W+hFxyXG4gICAqL1xyXG4gIEBJbnB1dCgnZmFycmlzRmlsZU5hbWVLZXknKVxyXG4gIHB1YmxpYyBmaWxlTmFtZUtleTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDnu5HlrprmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGdldCBiaW5kaW5nRGF0YSgpOiBCaW5kaW5nRGF0YSB7XHJcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDnu5HlrprmlbDmja7liJfooahcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBiaW5kaW5nTGlzdCgpOiBCaW5kaW5nTGlzdCB7XHJcbiAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5nZXRMaXN0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgcHJldmlld0NvbXBvbmVudDogRkZpbGVQcmV2aWV3Q29tcG9uZW50LFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgdXBsb2FkQW5kUHJldmlld0NvbXBvbmVudDogVXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCxcclxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yXHJcbiAgKSB7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmjIfku6TliJ3lp4vljJZcclxuICAgKi9cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuYmluZERhdGEoKTtcclxuICAgIGlmICh0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQpIHtcclxuICAgICAgdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50Lm9yZGVyRmllbGQgPSAnZmlsZVNvcnRPcmRlcic7XHJcbiAgICB9XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZFxyXG4gICAgICAgIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkFwcGVuZFxyXG4gICAgICAgIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZVxyXG4gICAgICApIHtcclxuICAgICAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5oyH5Luk6L6T5YWl5Y+Y5pu0XHJcbiAgICovXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmluZERhdGEoKSB7XHJcbiAgICBjb25zdCBmaWxlSW5mb3MgPSB0aGlzLmdldEZpbGVJbmZvcygpO1xyXG4gICAgaWYgKHRoaXMuY29tcG9uZW50UmVmKSB7XHJcbiAgICAgIHRoaXMuY29tcG9uZW50UmVmLmZpbGVJbmZvcyA9IGZpbGVJbmZvcztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlumZhOS7tuS/oeaBr+WIl+ihqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RmlsZUluZm9zKCk6IFVwbG9hZEZpbGVbXSB7XHJcbiAgICBjb25zdCBsaXN0RGF0YSA9IHRoaXMuYmluZGluZ0xpc3QudG9KU09OKCk7XHJcbiAgICBjb25zdCBpZEtleSA9IHRoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICAgIGNvbnN0IGZpbGVJbmZvczogVXBsb2FkRmlsZVtdID0gW107XHJcblxyXG4gICAgbGlzdERhdGEuZm9yRWFjaCgoaXRlbURhdGE6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBpZCA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIGlkS2V5KTtcclxuICAgICAgY29uc3QgZmlsZUlkID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgdGhpcy5maWxlSWRLZXkpO1xyXG4gICAgICBjb25zdCBmaWxlTmFtZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZU5hbWVLZXkpO1xyXG4gICAgICBjb25zdCBmaWxlU2l6ZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZVNpemVLZXkpO1xyXG4gICAgICBjb25zdCBmaWxlQ3JlYXRlVGltZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZUNyZWF0ZVRpbWVLZXkpO1xyXG5cclxuICAgICAgY29uc3QgZmlsZUluZm86IGFueSA9IHtcclxuICAgICAgICBpZDogZmlsZUlkLFxyXG4gICAgICAgIG5hbWU6IGZpbGVOYW1lLFxyXG4gICAgICAgIHNpemU6IGZpbGVTaXplLFxyXG4gICAgICAgIGNyZWF0ZVRpbWU6IGZpbGVDcmVhdGVUaW1lLFxyXG4gICAgICAgIG9yaWdpbmFsRGF0YTogaXRlbURhdGEsXHJcbiAgICAgICAgZXh0ZW5kOiB7XHJcbiAgICAgICAgICBtZXRhZGF0YUlkOiBmaWxlSWRcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGlmICh0aGlzLmV4dGVuZEZpbGVJbmZvICYmIEFycmF5LmlzQXJyYXkodGhpcy5leHRlbmRGaWxlSW5mbykgJiYgdGhpcy5leHRlbmRGaWxlSW5mby5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmRGaWxlSW5mby5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgZmlsZUluZm9baXRlbS5rZXldID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgaXRlbS5wYXRoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5maWxlU29ydE9yZGVyS2V5KSB7XHJcbiAgICAgICAgY29uc3QgZmlsZVNvcnRPcmRlciA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZVNvcnRPcmRlcktleSk7XHJcbiAgICAgICAgZmlsZUluZm8uZmlsZVNvcnRPcmRlciA9IGZpbGVTb3J0T3JkZXI7XHJcbiAgICAgIH1cclxuICAgICAgZmlsZUluZm9zLnB1c2goZmlsZUluZm8pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGZpbGVJbmZvcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNruWtl+autei3r+W+hOiOt+WPluWAvFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VmFsdWVCeVBhdGgoZGF0YTogYW55LCBwYXRoOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgY29uc3Qga2V5cyA9IHBhdGguc3BsaXQoJy4nKTtcclxuICAgIGxldCBjdXJyZW50VmFsdWUgPSBkYXRhO1xyXG4gICAga2V5cy5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICBjdXJyZW50VmFsdWUgPSBjdXJyZW50VmFsdWUgJiYgY3VycmVudFZhbHVlW2tleV07XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjdXJyZW50VmFsdWU7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0VWR0UGF0aHMoKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcGF0aHMgPSB0aGlzLmZpbGVJZEtleS5zcGxpdCgnLicpO1xyXG4gICAgcGF0aHMucG9wKCk7XHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGZpbGVTaXplS2V5KCkge1xyXG4gICAgY29uc3QgYmFzZVBhdGhzID0gdGhpcy5nZXRVZHRQYXRocygpO1xyXG4gICAgcmV0dXJuIGJhc2VQYXRocy5jb25jYXQoWydmaWxlU2l6ZSddKS5qb2luKCcuJyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGZpbGVDcmVhdGVUaW1lS2V5KCkge1xyXG4gICAgY29uc3QgYmFzZVBhdGhzID0gdGhpcy5nZXRVZHRQYXRocygpO1xyXG4gICAgcmV0dXJuIGJhc2VQYXRocy5jb25jYXQoWydmaWxlQ3JlYXRlVGltZSddKS5qb2luKCcuJyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGNvbXBvbmVudFJlZigpIHtcclxuICAgIHJldHVybiB0aGlzLnByZXZpZXdDb21wb25lbnQgfHwgdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50IHx8IG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBGYXJyaXNGaWxlUHJldmlld0JpbmRpbmdEaXJlY3RpdmUgfTtcclxuIl19