/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, Directive, ElementRef, Injector, Input, Renderer2 } from "@angular/core";
import { NgControl } from "@angular/forms";
import { OverLayHiddenService } from "@farris/ui-common";
import { LocaleService } from "@farris/ui-locale";
import { CommentsHttpToken } from "./comments/get-data.interface";
import { SingleListComponent } from "./comments/single-list.component";
export class TextareaCommentsDirective {
    /**
     * @param {?} injector
     * @param {?} el
     * @param {?} render
     * @param {?} localeSer
     * @param {?} cfr
     */
    constructor(injector, el, render, localeSer, cfr) {
        this.injector = injector;
        this.el = el;
        this.render = render;
        this.localeSer = localeSer;
        this.cfr = cfr;
        this.useComments = true;
        this.maxHeight = 300;
        this.title = '';
        this.mgrText = '';
        this.commentsBtnElement = null;
        this.singListRef = null;
        this.listPanelElRef = null;
        this.commentSer = this.injector.get(CommentsHttpToken, null);
        this.overlaySer = this.injector.get(OverLayHiddenService, null);
        if (!this.overlaySer) {
            this.overlaySer = new OverLayHiddenService();
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.ngControl = this.injector.get(NgControl, null);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.init();
        this.listenAttributesChanged();
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.useComments && !changes.useComments.isFirstChange()) {
            this.init();
        }
    }
    /**
     * @private
     * @return {?}
     */
    init() {
        /** @type {?} */
        const readonly = this.el.nativeElement.readOnly;
        /** @type {?} */
        const disabled = this.el.nativeElement.disabled;
        if (this.useComments && (!readonly && !disabled)) {
            this.createCommentsButton();
        }
        else {
            this.destroy();
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.destroy();
        this.hideListPanel();
        // 停止观察属性变化
        this.observer.disconnect();
        this.observer = null;
    }
    /**
     * @return {?}
     */
    listenAttributesChanged() {
        // 选择需要观察变动的节点
        /** @type {?} */
        const targetNode = this.el.nativeElement;
        // 观察器的配置（需要观察什么变动）
        /** @type {?} */
        const config = { attributes: true };
        // 当观察到变动时执行的回调函数
        /** @type {?} */
        const callback = (/**
         * @param {?} mutationsList
         * @param {?} observer
         * @return {?}
         */
        (mutationsList, observer) => {
            // Use traditional 'for loops' for IE 11
            for (let mutation of mutationsList) {
                if (mutation.type === 'attributes' && (mutation.attributeName === 'readonly' || mutation.attributeName === 'disabled')) {
                    this.init();
                }
            }
        });
        // 创建一个观察器实例并传入回调函数
        this.observer = new MutationObserver(callback);
        // 以上述配置开始观察目标节点
        this.observer.observe(targetNode, config);
    }
    /**
     * @return {?}
     */
    destroy() {
        if (this.commentsBtnElement) {
            this.commentsBtnElement.remove();
        }
    }
    /**
     * @private
     * @return {?}
     */
    createID() {
        /** @type {?} */
        const tagName = this.el.nativeElement.tagName;
        if (this.ngControl) {
            /** @type {?} */
            const ctrlName = this.ngControl.name;
            return `${tagName}_COMMENTS_${ctrlName}`;
        }
        else {
            if (this.el.nativeElement.id) {
                return `${tagName}_COMMENTS_${this.el.nativeElement.id}`;
            }
        }
        return '';
    }
    /**
     * @private
     * @return {?}
     */
    createCommentsButton() {
        /** @type {?} */
        const commentsBtn = this.render.createElement('span');
        commentsBtn.className = 'dropdown-toggle';
        commentsBtn.title = this.title ? this.title : (this.localeSer.getValue('text.comments.title') || '常用意见');
        /** @type {?} */
        const id = this.createID();
        if (id) {
            commentsBtn.id = id;
        }
        this.render.setStyle(commentsBtn, 'position', 'absolute');
        this.render.setStyle(commentsBtn, 'left', '3px');
        this.render.setStyle(commentsBtn, 'bottom', '0px');
        this.render.setStyle(commentsBtn, 'cursor', 'pointer');
        /** @type {?} */
        const icon = this.render.createElement('span');
        this.render.appendChild(commentsBtn, icon);
        icon.className = 'f-icon f-icon-message';
        this.render.setStyle(icon, 'position', 'relative');
        // this.render.setStyle(icon, 'margin-right', '3px');
        this.render.setStyle(icon, 'top', '1px');
        this.render.setStyle(icon, 'font-size', '13px');
        this.el.nativeElement.after(commentsBtn);
        this.commentsBtnElement = commentsBtn;
        this.render.listen(commentsBtn, 'click', (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            e.stopPropagation();
            if (!this.listPanelElRef) {
                this.showListPanel();
            }
            else {
                this.hideListPanel();
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    showListPanel() {
        /** @type {?} */
        const listPanelEl = this.render.createElement('div');
        const { left, bottom } = this.commentsBtnElement.getBoundingClientRect();
        this.render.setStyle(listPanelEl, 'width', '200px');
        this.render.setStyle(listPanelEl, 'max-height', `${this.maxHeight}px`);
        this.render.setStyle(listPanelEl, 'position', 'absolute');
        this.render.setStyle(listPanelEl, 'left', `${left}px`);
        this.render.setStyle(listPanelEl, 'top', '0px');
        this.render.setStyle(listPanelEl, 'z-index', '9999999');
        this.render.setStyle(listPanelEl, 'box-shadow', '0 2px 8px 0 #dedede');
        this.render.setStyle(listPanelEl, 'border-radius', '6px');
        this.render.setStyle(listPanelEl, 'background', 'white');
        this.render.setStyle(listPanelEl, 'visibility', 'hidden');
        document.body.append(listPanelEl);
        this.listPanelElRef = listPanelEl;
        /** @type {?} */
        const singListCmf = this.cfr.resolveComponentFactory(SingleListComponent);
        this.singListRef = singListCmf.create(this.injector);
        this.singListRef.instance.showButtons = true;
        this.singListRef.instance.emptyDataMsg = this.localeSer.getValue('text.comments.empty');
        this.singListRef.instance.buttons = [
            {
                text: this.mgrText ? this.mgrText : this.localeSer.getValue('text.comments.manager'),
                iconCls: 'f-icon f-icon-home-setup', handler: (/**
                 * @return {?}
                 */
                () => {
                    if (this.commentSer) {
                        this.hideListPanel();
                        this.commentSer.showCommentManageDialog({ type: 'forms' }).subscribe((/**
                         * @param {?} e
                         * @return {?}
                         */
                        (e) => {
                            console.log(e);
                        }));
                    }
                })
            }
        ];
        this.singListRef.instance.textField = 'message';
        this.singListRef.instance.maxItems = 999999;
        this.singListRef.instance.itemClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            /** @type {?} */
            const val = e.data['message'];
            /** @type {?} */
            let _text = this.el.nativeElement.value || '';
            _text += val;
            if (this.ngControl) {
                this.ngControl.control.patchValue(_text);
            }
            else {
                this.el.nativeElement.value = _text;
            }
            this.hideListPanel();
        }));
        listPanelEl.appendChild(this.singListRef.location.nativeElement);
        this.singListRef.changeDetectorRef.detectChanges();
        this.loadData(this.singListRef);
        this.overlaySer.registerMouseEvent(listPanelEl, (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.listPanelElRef.contains(e.target) || this.commentsBtnElement === e.target || this.commentsBtnElement.contains(e.target)) {
                return;
            }
            this.hideListPanel();
        }));
    }
    /**
     * @return {?}
     */
    hideListPanel() {
        if (this.singListRef) {
            this.singListRef.destroy();
            this.singListRef = null;
        }
        if (this.listPanelElRef) {
            this.listPanelElRef.remove();
            this.overlaySer.destory(this.listPanelElRef);
            this.listPanelElRef = null;
        }
    }
    /**
     * @private
     * @param {?} singListRef
     * @return {?}
     */
    loadData(singListRef) {
        if (this.commentSer) {
            this.commentSer.getCommonComments({ type: 'forms' }).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            (data) => {
                singListRef.instance.loadData(data);
                setTimeout((/**
                 * @return {?}
                 */
                () => {
                    this.resetPosition();
                }));
            }));
        }
    }
    /**
     * @private
     * @return {?}
     */
    resetPosition() {
        const { top, bottom, left } = this.commentsBtnElement.getBoundingClientRect();
        /** @type {?} */
        const panelHeight = this.listPanelElRef.offsetHeight;
        if (window.innerHeight - bottom > this.maxHeight || window.innerHeight - bottom > panelHeight) {
            this.render.setStyle(this.listPanelElRef, 'top', `${bottom}px`);
            this.render.removeStyle(this.listPanelElRef, 'visibility');
            return;
        }
        else {
            if (top > this.maxHeight || top > panelHeight) {
                this.render.setStyle(this.listPanelElRef, 'top', `${top - panelHeight}px`);
            }
            else {
                this.render.setStyle(this.listPanelElRef, 'top', '0px');
                if (left > 200) {
                    this.render.setStyle(this.listPanelElRef, 'left', `${left - 200}px`);
                }
            }
            this.render.removeStyle(this.listPanelElRef, 'visibility');
        }
    }
}
TextareaCommentsDirective.decorators = [
    { type: Directive, args: [{
                selector: '[common-comments]',
            },] }
];
/** @nocollapse */
TextareaCommentsDirective.ctorParameters = () => [
    { type: Injector },
    { type: ElementRef },
    { type: Renderer2 },
    { type: LocaleService },
    { type: ComponentFactoryResolver }
];
TextareaCommentsDirective.propDecorators = {
    useComments: [{ type: Input, args: ['common-comments',] }],
    maxHeight: [{ type: Input }],
    title: [{ type: Input }],
    mgrText: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    TextareaCommentsDirective.prototype.useComments;
    /** @type {?} */
    TextareaCommentsDirective.prototype.maxHeight;
    /** @type {?} */
    TextareaCommentsDirective.prototype.title;
    /** @type {?} */
    TextareaCommentsDirective.prototype.mgrText;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.commentSer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.eventManager;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.ngControl;
    /** @type {?} */
    TextareaCommentsDirective.prototype.commentsBtnElement;
    /** @type {?} */
    TextareaCommentsDirective.prototype.singListRef;
    /** @type {?} */
    TextareaCommentsDirective.prototype.listPanelElRef;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.overlaySer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.observer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.cfr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGFyZWEtY29tbWVudHMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1mb3Jtcy8iLCJzb3VyY2VzIjpbImxpYi90ZXh0YXJlYS1jb21tZW50cy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBaUIsd0JBQXdCLEVBQWdCLFNBQVMsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBZ0MsU0FBUyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUN0TCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0MsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDekQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxpQkFBaUIsRUFBd0IsTUFBTSwrQkFBK0IsQ0FBQztBQUN4RixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQU12RSxNQUFNLE9BQU8seUJBQXlCOzs7Ozs7OztJQWlCbEMsWUFBb0IsUUFBa0IsRUFBVSxFQUFjLEVBQVUsTUFBaUIsRUFDN0UsU0FBd0IsRUFBVSxHQUE2QjtRQUR2RCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDN0UsY0FBUyxHQUFULFNBQVMsQ0FBZTtRQUFVLFFBQUcsR0FBSCxHQUFHLENBQTBCO1FBaEJqRCxnQkFBVyxHQUFHLElBQUksQ0FBQztRQUNwQyxjQUFTLEdBQUcsR0FBRyxDQUFDO1FBQ2hCLFVBQUssR0FBRyxFQUFFLENBQUM7UUFDWCxZQUFPLEdBQUcsRUFBRSxDQUFDO1FBS3RCLHVCQUFrQixHQUFHLElBQUksQ0FBQztRQUMxQixnQkFBVyxHQUFzQyxJQUFJLENBQUM7UUFDdEQsbUJBQWMsR0FBRyxJQUFJLENBQUM7UUFPbEIs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Ozs7O0lBQUUsdUNBQXNCOzs7OztJQUFFLDJDQUF5Qjs7Ozs7SUFDckYsOENBQWdDOzs7OztJQUFFLHdDQUFxQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyVmlld0luaXQsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBEaXJlY3RpdmUsIEVsZW1lbnRSZWYsIEluamVjdG9yLCBJbnB1dCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIE9uSW5pdCwgUmVuZGVyZXIyLCBTaW1wbGVDaGFuZ2VzIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgTmdDb250cm9sIH0gZnJvbSBcIkBhbmd1bGFyL2Zvcm1zXCI7XHJcbmltcG9ydCB7IEV2ZW50TWFuYWdlciB9IGZyb20gXCJAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyXCI7XHJcbmltcG9ydCB7IE92ZXJMYXlIaWRkZW5TZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktY29tbW9uXCI7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1sb2NhbGVcIjtcclxuaW1wb3J0IHsgQ29tbWVudHNIdHRwVG9rZW4sIElDb21tZW50c0h0dHBTZXJ2aWNlIH0gZnJvbSBcIi4vY29tbWVudHMvZ2V0LWRhdGEuaW50ZXJmYWNlXCI7XHJcbmltcG9ydCB7IFNpbmdsZUxpc3RDb21wb25lbnQgfSBmcm9tIFwiLi9jb21tZW50cy9zaW5nbGUtbGlzdC5jb21wb25lbnRcIjtcclxuXHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW2NvbW1vbi1jb21tZW50c10nLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgVGV4dGFyZWFDb21tZW50c0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG5cclxuICAgIEBJbnB1dCgnY29tbW9uLWNvbW1lbnRzJykgdXNlQ29tbWVudHMgPSB0cnVlO1xyXG4gICAgQElucHV0KCkgbWF4SGVpZ2h0ID0gMzAwO1xyXG4gICAgQElucHV0KCkgdGl0bGUgPSAnJztcclxuICAgIEBJbnB1dCgpIG1nclRleHQgPSAnJztcclxuXHJcbiAgICBwcml2YXRlIGNvbW1lbnRTZXI6IElDb21tZW50c0h0dHBTZXJ2aWNlO1xyXG4gICAgcHJpdmF0ZSBldmVudE1hbmFnZXI6IEV2ZW50TWFuYWdlcjtcclxuICAgIHByaXZhdGUgbmdDb250cm9sOiBOZ0NvbnRyb2w7XHJcbiAgICBjb21tZW50c0J0bkVsZW1lbnQgPSBudWxsO1xyXG4gICAgc2luZ0xpc3RSZWY6IENvbXBvbmVudFJlZjxTaW5nbGVMaXN0Q29tcG9uZW50PiA9IG51bGw7XHJcbiAgICBsaXN0UGFuZWxFbFJlZiA9IG51bGw7XHJcbiAgICBwcml2YXRlIG92ZXJsYXlTZXI6IE92ZXJMYXlIaWRkZW5TZXJ2aWNlO1xyXG5cclxuICAgIHByaXZhdGUgb2JzZXJ2ZXI6IE11dGF0aW9uT2JzZXJ2ZXI7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsIFxyXG4gICAgICAgIHByaXZhdGUgbG9jYWxlU2VyOiBMb2NhbGVTZXJ2aWNlLCBwcml2YXRlIGNmcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyKSB7XHJcbiAgICAgICAgdGhpcy5jb21tZW50U2VyID0gdGhpcy5pbmplY3Rvci5nZXQoQ29tbWVudHNIdHRwVG9rZW4sIG51bGwpO1xyXG4gICAgICAgIHRoaXMub3ZlcmxheVNlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KE92ZXJMYXlIaWRkZW5TZXJ2aWNlLCBudWxsKTtcclxuICAgICAgICBpZiAoIXRoaXMub3ZlcmxheVNlcikge1xyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlTZXIgPSBuZXcgT3ZlckxheUhpZGRlblNlcnZpY2UoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5uZ0NvbnRyb2wgPSB0aGlzLmluamVjdG9yLmdldChOZ0NvbnRyb2wsIG51bGwpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcclxuICAgICAgICB0aGlzLmluaXQoKTtcclxuICAgICAgICB0aGlzLmxpc3RlbkF0dHJpYnV0ZXNDaGFuZ2VkKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgICAgIGlmIChjaGFuZ2VzLnVzZUNvbW1lbnRzICYmICFjaGFuZ2VzLnVzZUNvbW1lbnRzLmlzRmlyc3RDaGFuZ2UoKSkge1xyXG4gICAgICAgICAgICB0aGlzLmluaXQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0KCkge1xyXG4gICAgICAgIGNvbnN0IHJlYWRvbmx5ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnJlYWRPbmx5O1xyXG4gICAgICAgIGNvbnN0IGRpc2FibGVkID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LmRpc2FibGVkO1xyXG4gICAgICAgIGlmICh0aGlzLnVzZUNvbW1lbnRzICYmICghcmVhZG9ubHkgJiYgIWRpc2FibGVkKSkge1xyXG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUNvbW1lbnRzQnV0dG9uKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgIHRoaXMuaGlkZUxpc3RQYW5lbCgpO1xyXG4gICAgICAgIC8vIOWBnOatouinguWvn+WxnuaAp+WPmOWMllxyXG4gICAgICAgIHRoaXMub2JzZXJ2ZXIuZGlzY29ubmVjdCgpO1xyXG4gICAgICAgIHRoaXMub2JzZXJ2ZXIgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGxpc3RlbkF0dHJpYnV0ZXNDaGFuZ2VkKCkge1xyXG4gICAgICAgIC8vIOmAieaLqemcgOimgeinguWvn+WPmOWKqOeahOiKgueCuVxyXG4gICAgICAgIGNvbnN0IHRhcmdldE5vZGUgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgICAgIC8vIOinguWvn+WZqOeahOmFjee9ru+8iOmcgOimgeinguWvn+S7gOS5iOWPmOWKqO+8iVxyXG4gICAgICAgIGNvbnN0IGNvbmZpZyA9IHsgYXR0cmlidXRlczogdHJ1ZSB9O1xyXG5cclxuICAgICAgICAvLyDlvZPop4Llr5/liLDlj5jliqjml7bmiafooYznmoTlm57osIPlh73mlbBcclxuICAgICAgICBjb25zdCBjYWxsYmFjayA9IChtdXRhdGlvbnNMaXN0LCBvYnNlcnZlcikgPT4ge1xyXG4gICAgICAgICAgICAvLyBVc2UgdHJhZGl0aW9uYWwgJ2ZvciBsb29wcycgZm9yIElFIDExXHJcbiAgICAgICAgICAgIGZvcihsZXQgbXV0YXRpb24gb2YgbXV0YXRpb25zTGlzdCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKG11dGF0aW9uLnR5cGUgPT09ICdhdHRyaWJ1dGVzJyAmJiAobXV0YXRpb24uYXR0cmlidXRlTmFtZSA9PT0gJ3JlYWRvbmx5JyB8fCBtdXRhdGlvbi5hdHRyaWJ1dGVOYW1lID09PSAnZGlzYWJsZWQnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5pdCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgLy8g5Yib5bu65LiA5Liq6KeC5a+f5Zmo5a6e5L6L5bm25Lyg5YWl5Zue6LCD5Ye95pWwXHJcbiAgICAgICAgdGhpcy5vYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGNhbGxiYWNrKTtcclxuXHJcbiAgICAgICAgLy8g5Lul5LiK6L+w6YWN572u5byA5aeL6KeC5a+f55uu5qCH6IqC54K5XHJcbiAgICAgICAgdGhpcy5vYnNlcnZlci5vYnNlcnZlKHRhcmdldE5vZGUsIGNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGRlc3Ryb3koKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29tbWVudHNCdG5FbGVtZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29tbWVudHNCdG5FbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZUlEKCkge1xyXG4gICAgICAgIGNvbnN0IHRhZ05hbWUgPSB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQudGFnTmFtZTtcclxuICAgICAgICBpZiAodGhpcy5uZ0NvbnRyb2wpIHtcclxuICAgICAgICAgICAgY29uc3QgY3RybE5hbWUgPSB0aGlzLm5nQ29udHJvbC5uYW1lO1xyXG4gICAgICAgICAgICByZXR1cm4gYCR7dGFnTmFtZX1fQ09NTUVOVFNfJHtjdHJsTmFtZX1gO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuaWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgJHt0YWdOYW1lfV9DT01NRU5UU18ke3RoaXMuZWwubmF0aXZlRWxlbWVudC5pZH1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZUNvbW1lbnRzQnV0dG9uKCkge1xyXG4gICAgICAgIGNvbnN0IGNvbW1lbnRzQnRuID0gdGhpcy5yZW5kZXIuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xyXG4gICAgICAgIGNvbW1lbnRzQnRuLmNsYXNzTmFtZSA9ICdkcm9wZG93bi10b2dnbGUnO1xyXG4gICAgICAgIGNvbW1lbnRzQnRuLnRpdGxlID0gdGhpcy50aXRsZSA/IHRoaXMudGl0bGUgOiAodGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ3RleHQuY29tbWVudHMudGl0bGUnKSB8fCAn5bi455So5oSP6KeBJyk7XHJcbiAgICAgICAgY29uc3QgaWQgPSB0aGlzLmNyZWF0ZUlEKCk7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgIGNvbW1lbnRzQnRuLmlkID0gaWQ7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShjb21tZW50c0J0biwgJ3Bvc2l0aW9uJywgJ2Fic29sdXRlJyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoY29tbWVudHNCdG4sICdsZWZ0JywgJzNweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGNvbW1lbnRzQnRuLCAnYm90dG9tJywgJzBweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGNvbW1lbnRzQnRuLCAnY3Vyc29yJywgJ3BvaW50ZXInKTtcclxuXHJcbiAgICAgICAgY29uc3QgaWNvbiA9IHRoaXMucmVuZGVyLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5hcHBlbmRDaGlsZChjb21tZW50c0J0biwgaWNvbik7XHJcblxyXG4gICAgICAgIGljb24uY2xhc3NOYW1lID0gJ2YtaWNvbiBmLWljb24tbWVzc2FnZSc7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoaWNvbiwgJ3Bvc2l0aW9uJywgJ3JlbGF0aXZlJyk7XHJcbiAgICAgICAgLy8gdGhpcy5yZW5kZXIuc2V0U3R5bGUoaWNvbiwgJ21hcmdpbi1yaWdodCcsICczcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShpY29uLCAndG9wJywgJzFweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGljb24sICdmb250LXNpemUnLCAnMTNweCcpO1xyXG5cclxuICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuYWZ0ZXIoY29tbWVudHNCdG4pO1xyXG4gICAgICAgIHRoaXMuY29tbWVudHNCdG5FbGVtZW50ID0gY29tbWVudHNCdG47XHJcblxyXG4gICAgICAgIHRoaXMucmVuZGVyLmxpc3Rlbihjb21tZW50c0J0biwgJ2NsaWNrJywgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmxpc3RQYW5lbEVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dMaXN0UGFuZWwoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaGlkZUxpc3RQYW5lbCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNob3dMaXN0UGFuZWwoKSB7XHJcbiAgICAgICAgY29uc3QgbGlzdFBhbmVsRWwgPSB0aGlzLnJlbmRlci5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICBjb25zdCB7IGxlZnQsIGJvdHRvbSB9ID0gdGhpcy5jb21tZW50c0J0bkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUobGlzdFBhbmVsRWwsICd3aWR0aCcsICcyMDBweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnbWF4LWhlaWdodCcsIGAke3RoaXMubWF4SGVpZ2h0fXB4YCk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUobGlzdFBhbmVsRWwsICdwb3NpdGlvbicsICdhYnNvbHV0ZScpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnbGVmdCcsIGAke2xlZnR9cHhgKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ3RvcCcsICcwcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ3otaW5kZXgnLCAnOTk5OTk5OScpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnYm94LXNoYWRvdycsICcwIDJweCA4cHggMCAjZGVkZWRlJyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUobGlzdFBhbmVsRWwsICdib3JkZXItcmFkaXVzJywgJzZweCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnYmFja2dyb3VuZCcsICd3aGl0ZScpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAndmlzaWJpbGl0eScsICdoaWRkZW4nKTtcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZChsaXN0UGFuZWxFbCk7XHJcblxyXG4gICAgICAgIHRoaXMubGlzdFBhbmVsRWxSZWYgPSBsaXN0UGFuZWxFbDtcclxuXHJcbiAgICAgICAgY29uc3Qgc2luZ0xpc3RDbWYgPSB0aGlzLmNmci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShTaW5nbGVMaXN0Q29tcG9uZW50KTtcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmID0gc2luZ0xpc3RDbWYuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xyXG5cclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLnNob3dCdXR0b25zID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLmVtcHR5RGF0YU1zZyA9IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCd0ZXh0LmNvbW1lbnRzLmVtcHR5Jyk7XHJcbiAgICAgICAgdGhpcy5zaW5nTGlzdFJlZi5pbnN0YW5jZS5idXR0b25zID0gW1xyXG4gICAgICAgICAgICB7IFxyXG4gICAgICAgICAgICAgICAgdGV4dDogdGhpcy5tZ3JUZXh0ID8gdGhpcy5tZ3JUZXh0IDogdGhpcy5sb2NhbGVTZXIuZ2V0VmFsdWUoJ3RleHQuY29tbWVudHMubWFuYWdlcicpLCBcclxuICAgICAgICAgICAgICAgIGljb25DbHM6ICdmLWljb24gZi1pY29uLWhvbWUtc2V0dXAnLCBoYW5kbGVyOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY29tbWVudFNlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhpZGVMaXN0UGFuZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jb21tZW50U2VyLnNob3dDb21tZW50TWFuYWdlRGlhbG9nKHt0eXBlOiAnZm9ybXMnfSkuc3Vic2NyaWJlKChlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICBdO1xyXG4gICAgICAgIHRoaXMuc2luZ0xpc3RSZWYuaW5zdGFuY2UudGV4dEZpZWxkID0gJ21lc3NhZ2UnO1xyXG4gICAgICAgIHRoaXMuc2luZ0xpc3RSZWYuaW5zdGFuY2UubWF4SXRlbXMgPSA5OTk5OTk7XHJcblxyXG4gICAgICAgIHRoaXMuc2luZ0xpc3RSZWYuaW5zdGFuY2UuaXRlbUNsaWNrLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB2YWwgPSBlLmRhdGFbJ21lc3NhZ2UnXTtcclxuICAgICAgICAgICAgbGV0IF90ZXh0ID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnZhbHVlIHx8ICcnO1xyXG4gICAgICAgICAgICBfdGV4dCArPSB2YWw7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLm5nQ29udHJvbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5uZ0NvbnRyb2wuY29udHJvbC5wYXRjaFZhbHVlKF90ZXh0KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZSA9IF90ZXh0O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmhpZGVMaXN0UGFuZWwoKTtcclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICBsaXN0UGFuZWxFbC5hcHBlbmRDaGlsZCh0aGlzLnNpbmdMaXN0UmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMuc2luZ0xpc3RSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG5cclxuICAgICAgICB0aGlzLmxvYWREYXRhKHRoaXMuc2luZ0xpc3RSZWYpO1xyXG5cclxuXHJcbiAgICAgICAgdGhpcy5vdmVybGF5U2VyLnJlZ2lzdGVyTW91c2VFdmVudChsaXN0UGFuZWxFbCwgKGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMubGlzdFBhbmVsRWxSZWYuY29udGFpbnMoZS50YXJnZXQpIHx8IHRoaXMuY29tbWVudHNCdG5FbGVtZW50ID09PSBlLnRhcmdldCB8fCB0aGlzLmNvbW1lbnRzQnRuRWxlbWVudC5jb250YWlucyhlLnRhcmdldCkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmhpZGVMaXN0UGFuZWwoKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBoaWRlTGlzdFBhbmVsKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnNpbmdMaXN0UmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2luZ0xpc3RSZWYuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICB0aGlzLnNpbmdMaXN0UmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmxpc3RQYW5lbEVsUmVmKSB7XHJcbiAgICAgICAgICAgIHRoaXMubGlzdFBhbmVsRWxSZWYucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgIHRoaXMub3ZlcmxheVNlci5kZXN0b3J5KHRoaXMubGlzdFBhbmVsRWxSZWYpO1xyXG4gICAgICAgICAgICB0aGlzLmxpc3RQYW5lbEVsUmVmID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBsb2FkRGF0YShzaW5nTGlzdFJlZjogQ29tcG9uZW50UmVmPFNpbmdsZUxpc3RDb21wb25lbnQ+KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29tbWVudFNlcikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbW1lbnRTZXIuZ2V0Q29tbW9uQ29tbWVudHMoe3R5cGU6ICdmb3Jtcyd9KS5zdWJzY3JpYmUoKGRhdGEpID0+IHtcclxuICAgICAgICAgICAgICAgIHNpbmdMaXN0UmVmLmluc3RhbmNlLmxvYWREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXNldFBvc2l0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVzZXRQb3NpdGlvbigpIHtcclxuICAgICAgICBjb25zdCB7IHRvcCwgYm90dG9tLCBsZWZ0IH0gPSB0aGlzLmNvbW1lbnRzQnRuRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBjb25zdCBwYW5lbEhlaWdodCA9IHRoaXMubGlzdFBhbmVsRWxSZWYub2Zmc2V0SGVpZ2h0O1xyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJIZWlnaHQgLSBib3R0b20gID4gdGhpcy5tYXhIZWlnaHQgfHwgd2luZG93LmlubmVySGVpZ2h0IC0gYm90dG9tID4gcGFuZWxIZWlnaHQpIHtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5saXN0UGFuZWxFbFJlZiwgJ3RvcCcsIGAke2JvdHRvbX1weGApO1xyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAndmlzaWJpbGl0eScpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHRvcCA+IHRoaXMubWF4SGVpZ2h0IHx8IHRvcCA+IHBhbmVsSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAndG9wJywgYCR7dG9wIC0gcGFuZWxIZWlnaHR9cHhgKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKHRoaXMubGlzdFBhbmVsRWxSZWYsICd0b3AnLCAnMHB4Jyk7XHJcbiAgICAgICAgICAgICAgICBpZiAobGVmdCA+IDIwMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKHRoaXMubGlzdFBhbmVsRWxSZWYsICdsZWZ0JywgYCR7IGxlZnQgLSAyMDAgfXB4YCApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZVN0eWxlKHRoaXMubGlzdFBhbmVsRWxSZWYsICd2aXNpYmlsaXR5Jyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19