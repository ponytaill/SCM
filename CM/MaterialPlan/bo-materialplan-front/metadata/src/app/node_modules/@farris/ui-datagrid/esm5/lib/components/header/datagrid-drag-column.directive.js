/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, NgZone, Injector, Renderer2, ElementRef, Input } from '@angular/core';
import { dropHandlers, smoothDnD as SmoothDnDForHeader, constants } from '@farris/smooth-dnd';
import { DatagridComponent } from '../../datagrid.component';
import { DatagridHeaderComponent } from './datagrid-header.component';
import { DragDropColumnService } from './drag-drop-column.service';
var wrapperClass = constants.wrapperClass, animationClass = constants.animationClass;
SmoothDnDForHeader.dropHandler = dropHandlers.reactDropHandler().handler;
SmoothDnDForHeader.wrapChild = false;
/**
 * @record
 */
export function DragStartEndInfo() { }
if (false) {
    /** @type {?} */
    DragStartEndInfo.prototype.isSource;
    /** @type {?} */
    DragStartEndInfo.prototype.payload;
    /** @type {?} */
    DragStartEndInfo.prototype.willAcceptDrop;
}
var DragColumnDirective = /** @class */ (function () {
    function DragColumnDirective(ngzone, injector, render, el, header, dg, dndSer) {
        var _this = this;
        this.ngzone = ngzone;
        this.injector = injector;
        this.render = render;
        this.el = el;
        this.header = header;
        this.dg = dg;
        this.dndSer = dndSer;
        this.enableDrag = true;
        this.groupName = '';
        this.options = {
            groupName: this.groupName,
            orientation: 'horizontal',
            behaviour: 'move',
            dragHandleSelector: '.drag-column-bar',
            dragClass: 'drag-column-moving',
            dropPlaceholder: {
                className: 'drop-group-field',
            },
            getGhostParent: (/**
             * @return {?}
             */
            function () {
                return document.body;
            }),
            getChildPayload: this.getChildPayload.bind(this),
            shouldAcceptDrop: (/**
             * @param {?} sourceContainerOptions
             * @param {?} payload
             * @return {?}
             */
            function (sourceContainerOptions, payload) {
                if (typeof payload === 'number') {
                    return false;
                }
                if (sourceContainerOptions.groupName !== _this.groupName) {
                    return false;
                }
                return !_this.dg.isMultiHeader();
            }),
            onDropReady: (/**
             * @param {?} dropResult
             * @return {?}
             */
            function (dropResult) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDropReady(dropResult);
                }));
            }),
            onDrop: (/**
             * @param {?} dropResult
             * @return {?}
             */
            function (dropResult) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDrop(dropResult);
                }));
            }),
            onDragEnter: (/**
             * @return {?}
             */
            function () {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDragEnter();
                }));
            }),
            onDragStart: (/**
             * @param {?} info
             * @return {?}
             */
            function (info) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDragStart(info);
                }));
            }),
            onDragEnd: (/**
             * @param {?} info
             * @return {?}
             */
            function (info) {
                _this.ngzone.run((/**
                 * @return {?}
                 */
                function () {
                    _this.onDragEnd(info);
                }));
            })
        };
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    DragColumnDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (changes.enableDrag && !changes.enableDrag.isFirstChange()) {
            if (this.enableDrag) {
                this.initDnD();
            }
            else {
                this.disposeDnd();
            }
        }
    };
    /**
     * @return {?}
     */
    DragColumnDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.initDnD();
    };
    /**
     * @return {?}
     */
    DragColumnDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.disposeDnd();
    };
    /**
     * @private
     * @return {?}
     */
    DragColumnDirective.prototype.disposeDnd = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.container) {
            this.container.dispose();
            this.container = null;
        }
    };
    /**
     * @private
     * @return {?}
     */
    DragColumnDirective.prototype.initDnD = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.dg.editable) {
            return;
        }
        if (this.groupName === 'left' || this.groupName === 'right') {
            var _a = this.columnsGroup(), left = _a.left, right = _a.right;
            if (this.groupName === 'left' && !left.length) {
                return;
            }
            if (this.groupName === 'right' && (!right.length || (right.length === 1 && right[0].field === '_datagrid-setting-control_'))) {
                return;
            }
        }
        this.options.groupName = this.groupName;
        this.disposeDnd();
        if (this.enableDrag) {
            this.container = SmoothDnDForHeader(this.el.nativeElement, this.options);
            this.dndSer.backupColumns(this.header.columns);
        }
    };
    /**
     * @private
     * @param {?} index
     * @return {?}
     */
    DragColumnDirective.prototype.getChildPayload = /**
     * @private
     * @param {?} index
     * @return {?}
     */
    function (index) {
        var _this = this;
        if (this.groupName === 'left') {
            if (this.dg.showCheckbox) {
                index--;
            }
            if (this.dg.showLineNumber) {
                index--;
            }
        }
        /** @type {?} */
        var groupColumns = this.columnsGroup();
        if (this.groupName === 'left') {
            return groupColumns.left.filter((/**
             * @param {?} n
             * @param {?} i
             * @return {?}
             */
            function (n, i) { return _this.dg.columnIsVisible(n); }))[index];
        }
        return groupColumns.middle.filter((/**
         * @param {?} n
         * @param {?} i
         * @return {?}
         */
        function (n, i) { return _this.dg.columnIsVisible(n); }))[index];
    };
    /**
     * @param {?} dropResult
     * @return {?}
     */
    DragColumnDirective.prototype.onDropReady = /**
     * @param {?} dropResult
     * @return {?}
     */
    function (dropResult) {
    };
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    DragColumnDirective.prototype.onDrop = /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    function (dropResult) {
        var _this = this;
        var addedIndex = dropResult.addedIndex, payload = dropResult.payload, removedIndex = dropResult.removedIndex;
        if (addedIndex === null) {
            return;
        }
        /** @type {?} */
        var groupColumns = this.columnsGroup();
        /** @type {?} */
        var cols = this.dg.columns[0];
        /** @type {?} */
        var currIndex = cols.findIndex((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.field === payload.field; }));
        /** @type {?} */
        var newIndex = addedIndex;
        /** @type {?} */
        var moveColumn = (/**
         * @param {?} columns
         * @return {?}
         */
        function (columns) {
            if (columns) {
                /** @type {?} */
                var targetColumn_1 = columns.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n.visible || n.visible === undefined; }))[newIndex];
                if (targetColumn_1) {
                    /** @type {?} */
                    var realTagetIndex = cols.findIndex((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n.field === targetColumn_1.field; }));
                    _this.dg.columns[0] = _this.dndSer.moveItem(_this.dg.columns[0], realTagetIndex, currIndex);
                    return true;
                }
            }
            return false;
        });
        /** @type {?} */
        var columns = [];
        if (this.groupName === 'left') {
            if (this.dg.showCheckbox) {
                newIndex--;
            }
            if (this.dg.showLineNumber) {
                newIndex--;
            }
            columns = groupColumns.left;
        }
        else if (this.groupName === 'center') {
            columns = groupColumns.middle;
        }
        else if (this.groupName === 'right') {
            columns = groupColumns.right;
        }
        if (moveColumn(columns)) {
            this.dg.columnsChanged(false);
            if (this.dg.useControlPanel && this.dg.settingService) {
                this.dg.settingService.saveUserConfig(this.dg.id);
            }
            this.dg.columnMoved.emit({ newColumns: this.dg.columns, grid: this.dg });
        }
    };
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    DragColumnDirective.prototype.onDragStart = /**
     * @private
     * @param {?} info
     * @return {?}
     */
    function (info) {
    };
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    DragColumnDirective.prototype.onDragEnd = /**
     * @private
     * @param {?} info
     * @return {?}
     */
    function (info) {
    };
    /**
     * @private
     * @return {?}
     */
    DragColumnDirective.prototype.onDragEnter = /**
     * @private
     * @return {?}
     */
    function () {
    };
    /**
     * @private
     * @return {?}
     */
    DragColumnDirective.prototype.columnsGroup = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var leftColumns = this.dg.columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.fixed === 'left'; }));
        /** @type {?} */
        var rightColumns = this.dg.columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.fixed === 'right'; }));
        /** @type {?} */
        var middleColumns = this.dg.columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n.fixed !== 'right' && n.fixed !== 'left'; }));
        return {
            left: leftColumns,
            right: rightColumns,
            middle: middleColumns
        };
    };
    DragColumnDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[drag-column]',
                    providers: [
                        DragDropColumnService
                    ]
                },] }
    ];
    /** @nocollapse */
    DragColumnDirective.ctorParameters = function () { return [
        { type: NgZone },
        { type: Injector },
        { type: Renderer2 },
        { type: ElementRef },
        { type: DatagridHeaderComponent },
        { type: DatagridComponent },
        { type: DragDropColumnService }
    ]; };
    DragColumnDirective.propDecorators = {
        enableDrag: [{ type: Input, args: ['drag-column',] }],
        groupName: [{ type: Input }],
        options: [{ type: Input }]
    };
    return DragColumnDirective;
}());
export { DragColumnDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.container;
    /** @type {?} */
    DragColumnDirective.prototype.enableDrag;
    /** @type {?} */
    DragColumnDirective.prototype.groupName;
    /** @type {?} */
    DragColumnDirective.prototype.options;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.header;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.dg;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.dndSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZHJhZy1jb2x1bW4uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hlYWRlci9kYXRhZ3JpZC1kcmFnLWNvbHVtbi5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFpQixLQUFLLEVBQXVDLE1BQU0sZUFBZSxDQUFDO0FBQzlJLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxJQUFJLGtCQUFrQixFQUFnQyxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1SCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUczRCxJQUFBLHFDQUFZLEVBQUUseUNBQWM7QUFDcEMsa0JBQWtCLENBQUMsV0FBVyxHQUFHLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLE9BQU8sQ0FBQztBQUN6RSxrQkFBa0IsQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDOzs7O0FBRXJDLHNDQUlDOzs7SUFIRyxvQ0FBa0I7O0lBQ2xCLG1DQUFhOztJQUNiLDBDQUF3Qjs7QUFHNUI7SUE4REksNkJBQW9CLE1BQWMsRUFBVSxRQUFrQixFQUFVLE1BQWlCLEVBQ3JFLEVBQWMsRUFBVSxNQUErQixFQUFVLEVBQXFCLEVBQ3RGLE1BQTZCO1FBRmpELGlCQUVzRDtRQUZsQyxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDckUsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUFVLFdBQU0s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QU07Ozs7UUFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxLQUFLLEtBQUssT0FBTyxFQUFuQixDQUFtQixFQUFDOztZQUNsRSxhQUFhLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTTs7OztRQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLEtBQUssS0FBSyxPQUFPLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxNQUFNLEVBQXpDLENBQXlDLEVBQUM7UUFFL0YsT0FBTztZQUNILElBQUksRUFBRSxXQUFXO1lBQ2pCLEtBQUssRUFBRSxZQUFZO1lBQ25CLE1BQU0sRUFBRSxhQUFhO1NBQ3hCLENBQUM7SUFDTixDQUFDOztnQkEzTkosU0FBUyxTQUFDO29CQUNQLFFBQVEsRUFBRSxlQUFlO29CQUN6QixTQUFTLEVBQUU7d0JBQ1AscUJBQXFCO3FCQUN4QjtpQkFDSjs7OztnQkF0Qm1CLE1BQU07Z0JBQUUsUUFBUTtnQkFBRSxTQUFTO2dCQUFFLFVBQVU7Z0JBR2xELHVCQUF1QjtnQkFEdkIsaUJBQWlCO2dCQUVqQixxQkFBcUI7Ozs2QkFxQnpCLEtBQUssU0FBQyxhQUFhOzRCQUNuQixLQUFLOzBCQUVMLEtBQUs7O0lBaU5WLDBCQUFDO0NBQUEsQUE1TkQsSUE0TkM7U0F0TlksbUJBQW1COzs7Ozs7SUFDNUIsd0NBQXVCOztJQUN2Qix5Q0FBd0M7O0lBQ3hDLHdDQUF3Qjs7SUFFeEIsc0NBaURFOzs7OztJQUVVLHFDQUFzQjs7Ozs7SUFBRSx1Q0FBMEI7Ozs7O0lBQUUscUNBQXlCOzs7OztJQUM3RSxpQ0FBc0I7Ozs7O0lBQUUscUNBQXVDOzs7OztJQUFFLGlDQUE2Qjs7Ozs7SUFDOUYscUNBQXFDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IERpcmVjdGl2ZSwgTmdab25lLCBJbmplY3RvciwgUmVuZGVyZXIyLCBFbGVtZW50UmVmLCBBZnRlclZpZXdJbml0LCBJbnB1dCwgT25DaGFuZ2VzLCBTaW1wbGVDaGFuZ2VzLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgZHJvcEhhbmRsZXJzLCBzbW9vdGhEbkQgYXMgU21vb3RoRG5ERm9ySGVhZGVyLCBEcm9wUmVzdWx0LCBDb250YWluZXJPcHRpb25zLCBjb25zdGFudHMgfSBmcm9tICdAZmFycmlzL3Ntb290aC1kbmQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJy4uLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IERhdGFncmlkSGVhZGVyQ29tcG9uZW50IH0gZnJvbSAnLi9kYXRhZ3JpZC1oZWFkZXIuY29tcG9uZW50JztcclxuaW1wb3J0IHsgRHJhZ0Ryb3BDb2x1bW5TZXJ2aWNlIH0gZnJvbSAnLi9kcmFnLWRyb3AtY29sdW1uLnNlcnZpY2UnO1xyXG5cclxuXHJcbmNvbnN0IHsgd3JhcHBlckNsYXNzLCBhbmltYXRpb25DbGFzcyB9ID0gY29uc3RhbnRzO1xyXG5TbW9vdGhEbkRGb3JIZWFkZXIuZHJvcEhhbmRsZXIgPSBkcm9wSGFuZGxlcnMucmVhY3REcm9wSGFuZGxlcigpLmhhbmRsZXI7XHJcblNtb290aERuREZvckhlYWRlci53cmFwQ2hpbGQgPSBmYWxzZTtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRHJhZ1N0YXJ0RW5kSW5mbyB7XHJcbiAgICBpc1NvdXJjZTogYm9vbGVhbjtcclxuICAgIHBheWxvYWQ6IGFueTtcclxuICAgIHdpbGxBY2NlcHREcm9wOiBib29sZWFuO1xyXG59XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICAgIHNlbGVjdG9yOiAnW2RyYWctY29sdW1uXScsXHJcbiAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBEcmFnRHJvcENvbHVtblNlcnZpY2VcclxuICAgIF1cclxufSlcclxuZXhwb3J0IGNsYXNzIERyYWdDb2x1bW5EaXJlY3RpdmUgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XHJcbiAgICBwcml2YXRlIGNvbnRhaW5lcjogYW55O1xyXG4gICAgQElucHV0KCdkcmFnLWNvbHVtbicpIGVuYWJsZURyYWcgPSB0cnVlO1xyXG4gICAgQElucHV0KCkgZ3JvdXBOYW1lID0gJyc7XHJcblxyXG4gICAgQElucHV0KCkgb3B0aW9uczogQ29udGFpbmVyT3B0aW9ucyA9IHtcclxuICAgICAgICBncm91cE5hbWU6IHRoaXMuZ3JvdXBOYW1lLFxyXG4gICAgICAgIG9yaWVudGF0aW9uOiAnaG9yaXpvbnRhbCcsXHJcbiAgICAgICAgYmVoYXZpb3VyOiAnbW92ZScsXHJcbiAgICAgICAgZHJhZ0hhbmRsZVNlbGVjdG9yOiAnLmRyYWctY29sdW1uLWJhcicsXHJcbiAgICAgICAgZHJhZ0NsYXNzOiAnZHJhZy1jb2x1bW4tbW92aW5nJyxcclxuICAgICAgICBkcm9wUGxhY2Vob2xkZXI6IHtcclxuICAgICAgICAgICAgY2xhc3NOYW1lOiAnZHJvcC1ncm91cC1maWVsZCcsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRHaG9zdFBhcmVudDogKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQuYm9keTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGdldENoaWxkUGF5bG9hZDogdGhpcy5nZXRDaGlsZFBheWxvYWQuYmluZCh0aGlzKSxcclxuICAgICAgICBzaG91bGRBY2NlcHREcm9wOiAoc291cmNlQ29udGFpbmVyT3B0aW9ucywgcGF5bG9hZCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHBheWxvYWQgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChzb3VyY2VDb250YWluZXJPcHRpb25zLmdyb3VwTmFtZSAhPT0gdGhpcy5ncm91cE5hbWUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuICF0aGlzLmRnLmlzTXVsdGlIZWFkZXIoKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJvcFJlYWR5OiAoZHJvcFJlc3VsdDogRHJvcFJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm5nem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyb3BSZWFkeShkcm9wUmVzdWx0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbkRyb3A6IChkcm9wUmVzdWx0OiBEcm9wUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJvcChkcm9wUmVzdWx0KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbkRyYWdFbnRlcjogKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm5nem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyYWdFbnRlcigpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uRHJhZ1N0YXJ0OiAoaW5mbzogRHJhZ1N0YXJ0RW5kSW5mbykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm5nem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyYWdTdGFydChpbmZvKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbkRyYWdFbmQ6IChpbmZvOiBEcmFnU3RhcnRFbmRJbmZvKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubmd6b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uRHJhZ0VuZChpbmZvKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nem9uZTogTmdab25lLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMixcclxuICAgICAgICAgICAgICAgIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsIHByaXZhdGUgaGVhZGVyOiBEYXRhZ3JpZEhlYWRlckNvbXBvbmVudCwgcHJpdmF0ZSBkZzogRGF0YWdyaWRDb21wb25lbnQsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGRuZFNlcjogRHJhZ0Ryb3BDb2x1bW5TZXJ2aWNlKSB7IH1cclxuXHJcblxyXG4gICAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgICAgIGlmIChjaGFuZ2VzLmVuYWJsZURyYWcgJiYgIWNoYW5nZXMuZW5hYmxlRHJhZy5pc0ZpcnN0Q2hhbmdlKCkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZW5hYmxlRHJhZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbml0RG5EKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRpc3Bvc2VEbmQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgdGhpcy5pbml0RG5EKCk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlRG5kKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBkaXNwb3NlRG5kKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lci5kaXNwb3NlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0RG5EKCkge1xyXG4gICAgICAgIGlmICh0aGlzLmRnLmVkaXRhYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuZ3JvdXBOYW1lID09PSAnbGVmdCcgfHwgdGhpcy5ncm91cE5hbWUgPT09ICdyaWdodCcpIHtcclxuICAgICAgICAgICAgY29uc3QgeyBsZWZ0LCByaWdodCB9ID0gdGhpcy5jb2x1bW5zR3JvdXAoKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmdyb3VwTmFtZSA9PT0gJ2xlZnQnICYmICFsZWZ0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5ncm91cE5hbWUgPT09ICdyaWdodCcgJiYgKCFyaWdodC5sZW5ndGggfHwgKHJpZ2h0Lmxlbmd0aCA9PT0gMSAmJiByaWdodFswXS5maWVsZCA9PT0gJ19kYXRhZ3JpZC1zZXR0aW5nLWNvbnRyb2xfJykpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICB0aGlzLm9wdGlvbnMuZ3JvdXBOYW1lID0gdGhpcy5ncm91cE5hbWU7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlRG5kKCk7XHJcblxyXG5cclxuICAgICAgICBpZiAodGhpcy5lbmFibGVEcmFnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyID0gU21vb3RoRG5ERm9ySGVhZGVyKFxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zXHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRuZFNlci5iYWNrdXBDb2x1bW5zKHRoaXMuaGVhZGVyLmNvbHVtbnMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldENoaWxkUGF5bG9hZChpbmRleCkge1xyXG4gICAgICAgIGlmICh0aGlzLmdyb3VwTmFtZSA9PT0gJ2xlZnQnKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRnLnNob3dDaGVja2JveCkge1xyXG4gICAgICAgICAgICAgICAgaW5kZXgtLTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5kZy5zaG93TGluZU51bWJlcikge1xyXG4gICAgICAgICAgICAgICAgaW5kZXgtLTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZ3JvdXBDb2x1bW5zID0gdGhpcy5jb2x1bW5zR3JvdXAoKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZ3JvdXBOYW1lID09PSAnbGVmdCcpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGdyb3VwQ29sdW1ucy5sZWZ0LmZpbHRlcigobiwgaSkgPT4gdGhpcy5kZy5jb2x1bW5Jc1Zpc2libGUobikpW2luZGV4XTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBncm91cENvbHVtbnMubWlkZGxlLmZpbHRlcigobiwgaSkgPT4gdGhpcy5kZy5jb2x1bW5Jc1Zpc2libGUobikpW2luZGV4XTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRyb3BSZWFkeShkcm9wUmVzdWx0KSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbkRyb3AoZHJvcFJlc3VsdDogRHJvcFJlc3VsdCkge1xyXG4gICAgICAgIGNvbnN0IHsgYWRkZWRJbmRleCwgcGF5bG9hZCwgcmVtb3ZlZEluZGV4IH0gPSBkcm9wUmVzdWx0O1xyXG4gICAgICAgIGlmIChhZGRlZEluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGdyb3VwQ29sdW1ucyA9IHRoaXMuY29sdW1uc0dyb3VwKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbHMgPSB0aGlzLmRnLmNvbHVtbnNbMF07XHJcbiAgICAgICAgY29uc3QgY3VyckluZGV4ID0gY29scy5maW5kSW5kZXgobiA9PiBuLmZpZWxkID09PSBwYXlsb2FkLmZpZWxkKTtcclxuXHJcbiAgICAgICAgbGV0IG5ld0luZGV4ID0gYWRkZWRJbmRleDtcclxuXHJcbiAgICAgICAgY29uc3QgbW92ZUNvbHVtbiA9IChjb2x1bW5zOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGNvbHVtbnMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldENvbHVtbiA9IGNvbHVtbnMuZmlsdGVyKG4gPT4gbi52aXNpYmxlIHx8IG4udmlzaWJsZSA9PT0gdW5kZWZpbmVkKVtuZXdJbmRleF07XHJcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0Q29sdW1uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhbFRhZ2V0SW5kZXggPSBjb2xzLmZpbmRJbmRleChuID0+IG4uZmllbGQgPT09IHRhcmdldENvbHVtbi5maWVsZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kZy5jb2x1bW5zWzBdID0gdGhpcy5kbmRTZXIubW92ZUl0ZW0odGhpcy5kZy5jb2x1bW5zWzBdLCByZWFsVGFnZXRJbmRleCwgY3VyckluZGV4KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBsZXQgY29sdW1ucyA9IFtdO1xyXG4gICAgICAgIGlmICh0aGlzLmdyb3VwTmFtZSA9PT0gJ2xlZnQnKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRnLnNob3dDaGVja2JveCkge1xyXG4gICAgICAgICAgICAgICAgbmV3SW5kZXgtLTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5kZy5zaG93TGluZU51bWJlcikge1xyXG4gICAgICAgICAgICAgICAgbmV3SW5kZXgtLTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb2x1bW5zID0gZ3JvdXBDb2x1bW5zLmxlZnQ7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmdyb3VwTmFtZSA9PT0gJ2NlbnRlcicpIHtcclxuICAgICAgICAgICAgY29sdW1ucyA9IGdyb3VwQ29sdW1ucy5taWRkbGU7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmdyb3VwTmFtZSA9PT0gJ3JpZ2h0Jykge1xyXG4gICAgICAgICAgICBjb2x1bW5zID0gZ3JvdXBDb2x1bW5zLnJpZ2h0O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKG1vdmVDb2x1bW4oY29sdW1ucykpIHtcclxuICAgICAgICAgICAgdGhpcy5kZy5jb2x1bW5zQ2hhbmdlZChmYWxzZSk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5kZy51c2VDb250cm9sUGFuZWwgJiYgdGhpcy5kZy5zZXR0aW5nU2VydmljZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kZy5zZXR0aW5nU2VydmljZS5zYXZlVXNlckNvbmZpZyh0aGlzLmRnLmlkKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5kZy5jb2x1bW5Nb3ZlZC5lbWl0KHsgbmV3Q29sdW1uczogdGhpcy5kZy5jb2x1bW5zLCBncmlkOiB0aGlzLmRnIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uRHJhZ1N0YXJ0KGluZm8pIHtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG9uRHJhZ0VuZChpbmZvKSB7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgb25EcmFnRW50ZXIoKSB7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgY29sdW1uc0dyb3VwKCkge1xyXG4gICAgICAgIGNvbnN0IGxlZnRDb2x1bW5zID0gdGhpcy5kZy5jb2x1bW5zWzBdLmZpbHRlcihuID0+IG4uZml4ZWQgPT09ICdsZWZ0Jyk7XHJcbiAgICAgICAgY29uc3QgcmlnaHRDb2x1bW5zID0gdGhpcy5kZy5jb2x1bW5zWzBdLmZpbHRlcihuID0+IG4uZml4ZWQgPT09ICdyaWdodCcpO1xyXG4gICAgICAgIGNvbnN0IG1pZGRsZUNvbHVtbnMgPSB0aGlzLmRnLmNvbHVtbnNbMF0uZmlsdGVyKG4gPT4gbi5maXhlZCAhPT0gJ3JpZ2h0JyAmJiBuLmZpeGVkICE9PSAnbGVmdCcpO1xyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBsZWZ0OiBsZWZ0Q29sdW1ucyxcclxuICAgICAgICAgICAgcmlnaHQ6IHJpZ2h0Q29sdW1ucyxcclxuICAgICAgICAgICAgbWlkZGxlOiBtaWRkbGVDb2x1bW5zXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufVxyXG5cclxuIl19