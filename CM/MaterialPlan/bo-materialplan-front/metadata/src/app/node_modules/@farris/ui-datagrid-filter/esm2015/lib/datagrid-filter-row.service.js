/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, EventEmitter } from '@angular/core';
import { Subject } from 'rxjs';
import { ColumnFilterType, DatagridUtils } from '@farris/ui-datagrid';
import { FilterOperator } from './operations/operators';
export class DatagridFilterRowService {
    constructor() {
        this.columnConditionSubject = new Subject();
        this.filterRowConditions$ = this.columnConditionSubject.asObservable();
        this.columnConditions = {};
        this.filterTextboxChanged = new EventEmitter();
        this.removeField = new EventEmitter();
    }
    /**
     * @param {?} frp
     * @return {?}
     */
    setFilterPanel(frp) {
        this.currentFilterPanel = frp;
    }
    /**
     * @return {?}
     */
    hasFilterPanel() {
        return !!this.currentFilterPanel;
    }
    /**
     * @return {?}
     */
    closeFilterPanel() {
        if (this.hasFilterPanel()) {
            if (this.currentFilterPanel.instance.documentClickHandle) {
                this.currentFilterPanel.instance.documentClickHandle();
            }
            document.body.removeChild(this.currentFilterPanel.location.nativeElement);
            this.currentFilterPanel.destroy();
            this.currentFilterPanel = null;
            document.body.style.overflow = 'auto';
        }
    }
    /**
     * @param {?=} emitEvent
     * @return {?}
     */
    clear(emitEvent = true) {
        this.columnConditions = {};
        if (emitEvent) {
            this.columnConditionSubject.next({});
        }
    }
    /**
     * @param {?} field
     * @param {?=} opts
     * @return {?}
     */
    removeFilterField(field, opts) {
        if (this.columnConditions) {
            delete this.columnConditions[field];
            if (!opts || (opts && opts.emitEvent)) {
                this.emitColumnConditionChanged(this.columnConditions);
            }
            this.removeField.emit(field);
        }
    }
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    _updateColumnConditions(field, colCondition) {
        /** @type {?} */
        const currentCondition = this.columnConditions[field];
        if (!currentCondition) {
            this.columnConditions = Object.assign(this.columnConditions, { [field]: colCondition });
        }
        else {
            if (JSON.stringify(currentCondition) !== JSON.stringify(colCondition)) {
                this.columnConditions = Object.assign(this.columnConditions, { [field]: colCondition });
            }
        }
        // 值为 ‘’ ，则代表着不参与查询
        Object.keys(this.columnConditions).forEach((/**
         * @param {?} k
         * @return {?}
         */
        k => {
            if (!this.columnConditions[k]) {
                // delete this.columnConditions[k];
                this.columnConditions[k] = null;
            }
        }));
    }
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    updateColumnConditions(field, colCondition) {
        this._updateColumnConditions(field, colCondition);
        this.emitColumnConditionChanged(this.columnConditions);
    }
    /**
     * @private
     * @param {?} conditions
     * @return {?}
     */
    emitColumnConditionChanged(conditions) {
        // const farr = this.gridInstance.remoteFilter ? this.convert2FilterArray(this.columnConditions) : this.columnConditions;
        this.columnConditionSubject.next(conditions);
    }
    // 获取过滤行显示文本
    /**
     * @param {?} column
     * @param {?} condition
     * @return {?}
     */
    condition2string(column, condition) {
        if (!condition || typeof condition === 'string') {
            return '';
        }
        /** @type {?} */
        const andText = this.gridInstance.localeService.getValue('datagrid.filter.and');
        /** @type {?} */
        const orText = this.gridInstance.localeService.getValue('datagrid.filter.or');
        /** @type {?} */
        const getRelationLabel = (/**
         * @param {?} r
         * @return {?}
         */
        (r) => {
            if (r === 'and') {
                return andText;
            }
            else if (r === 'or') {
                return orText;
            }
            else {
                return '';
            }
        });
        /** @type {?} */
        let filterPreViewString = '';
        if (column.filter.type === ColumnFilterType.fromdata) {
            filterPreViewString = `(${condition.value1.length})`;
            if (condition.value1) {
                filterPreViewString += ` ${condition.value1.join(',')}`;
            }
        }
        else if (column.filter.type === ColumnFilterType.enum) {
            /** @type {?} */
            const enumOpts = (/** @type {?} */ (this.getEnumOptions(column)));
            const { valueField, textField, data } = enumOpts;
            filterPreViewString = `(${condition.value1.length})`;
            if (condition.value1) {
                filterPreViewString += ` ${condition.value1.map((/**
                 * @param {?} v
                 * @return {?}
                 */
                v => {
                    /** @type {?} */
                    const enumItem = data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d[valueField] == v));
                    return enumItem[textField];
                })).join(',')}`;
            }
        }
        else {
            if (condition) {
                /** @type {?} */
                const operator1Label = this.getOperatorLabel(condition.operator1);
                if (!this.isEmpty(condition.value1)) {
                    filterPreViewString = `${operator1Label} ${condition.value1}`;
                    /** @type {?} */
                    const operator2Label = this.getOperatorLabel(condition.operator2);
                    if (!this.isEmpty(condition.value2)) {
                        filterPreViewString += ` ${getRelationLabel(condition.relation)} ${operator2Label} ${condition.value2}`;
                    }
                    else {
                        if (condition.operator2 !== undefined) {
                            /** @type {?} */
                            const op2 = parseInt('' + condition.operator2, 10);
                            if (op2 === FilterOperator.Empty || op2 === FilterOperator.NotEmpty) {
                                filterPreViewString += ` ${getRelationLabel(condition.relation)} ${operator2Label}`;
                            }
                        }
                    }
                }
                else {
                    /** @type {?} */
                    const op1 = parseInt('' + condition.operator1, 10);
                    if (op1 === FilterOperator.Empty || op1 === FilterOperator.NotEmpty) {
                        filterPreViewString = `${operator1Label}`;
                    }
                }
            }
        }
        return filterPreViewString;
    }
    /**
     * @private
     * @param {?} v
     * @return {?}
     */
    isEmpty(v) {
        return v === '' || v === undefined || v === null;
    }
    /**
     * @param {?} column
     * @return {?}
     */
    getEnumOptions(column) {
        /** @type {?} */
        const colFilter = (/** @type {?} */ (column.filter));
        /** @type {?} */
        const datatype = colFilter.type;
        /** @type {?} */
        let enumSetting = null;
        if (datatype === ColumnFilterType.enum) {
            /** @type {?} */
            const fmt = (/** @type {?} */ (column.formatter));
            if (fmt) {
                enumSetting = fmt.options;
            }
            else {
                if (colFilter.options) {
                    enumSetting = colFilter.options;
                }
            }
        }
        else { // enum 数据源来自grid 数据列表
            // enum 数据源来自grid 数据列表
            /** @type {?} */
            const columnData = this.gridInstance.dfs.getData(true).map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return DatagridUtils.getValue(column.field, n);
            }));
            // 去除重复
            /** @type {?} */
            const enumData = Array.from(new Set(columnData)).map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return {
                    value: n, label: n
                };
            }));
            enumSetting = {
                valueField: 'value', textField: 'label', data: enumData, idField: 'value'
            };
        }
        return enumSetting;
    }
    // 获取操作符标签
    /**
     * @param {?} code
     * @return {?}
     */
    getOperatorLabel(code) {
        /** @type {?} */
        const strOper = FilterOperator[code];
        if (strOper) {
            /** @type {?} */
            const operName = strOper[0].toLowerCase() + strOper.substr(1);
            /** @type {?} */
            const key = `datagrid.filter.operators.${operName}`;
            return this.gridInstance.localeService.getValue(key);
        }
        return '';
    }
}
DatagridFilterRowService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
DatagridFilterRowService.ctorParameters = () => [];
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridFilterRowService.prototype.columnConditionSubject;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterRowConditions$;
    /** @type {?} */
    DatagridFilterRowService.prototype.columnConditions;
    /** @type {?} */
    DatagridFilterRowService.prototype.currentFilterPanel;
    /** @type {?} */
    DatagridFilterRowService.prototype.gridInstance;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterTextboxChanged;
    /** @type {?} */
    DatagridFilterRowService.prototype.removeField;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC1maWx0ZXIvIiwic291cmNlcyI6WyJsaWIvZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBQUMsZ0JBQWdCLEVBQWMsYUFBYSxFQUFtQyxNQUFNLHFCQUFxQixDQUFDO0FBRWxILE9BQU8sRUFDZ0IsY0FBYyxFQUFjLE1BQU0sd0JBQXdCLENBQUM7QUFJbEYsTUFBTSxPQUFPLHdCQUF3QjtJQVdqQztRQVZRLDJCQUFzQixHQUFHLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ25FLHlCQUFvQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxxQkFBZ0IsR0FBMEIsRUFBRSxDQUFDO1FBSzdDLHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO0lBRXpCLENBQUM7Ozs7O0lBRWpCLGNBQWMsQ0FBQyxHQUEwQztRQUNyRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0lBQ2xDLENBQUM7Ozs7SUFFRCxjQUFjO1FBQ1YsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDO0lBQ3JDLENBQUM7Ozs7SUFFRCxnQkFBZ0I7UUFDWixJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRTtZQUN2QixJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUU7Z0JBQ3RELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEVBQUUsQ0FBQzthQUMxRDtZQUNELFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDMUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7WUFFL0IsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQztTQUN6QztJQUNMLENBQUM7Ozs7O0lBRUQsS0FBSyxDQUFDLFNBQVMsR0FBRyxJQUFJO1FBQ2xCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDM0IsSUFBSSxTQUFTLEVBQUU7WUFDWCxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQ3hDO0lBQ0wsQ0FBQzs7Ozs7O0lBRUQsaUJBQWlCLENBQUMsS0FBYSxFQUFFLElBQTJCO1FBQ3hELElBQUksSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQ3ZCLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3BDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUNuQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7YUFDMUQ7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNoQztJQUNMLENBQUM7Ozs7OztJQUVELHVCQUF1QixDQUFDLEtBQWEsRUFBRSxZQUFvRDs7Y0FDakYsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQztRQUNyRCxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDbkIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLEVBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxZQUFZLEVBQUMsQ0FBQyxDQUFDO1NBQ3pGO2FBQU07WUFDSCxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUFFO2dCQUNuRSxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLFlBQVksRUFBQyxDQUFDLENBQUM7YUFDekY7U0FDSjtRQUNELG1CQUFtQjtRQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU87Ozs7UUFBQyxDQUFDLENBQUMsRUFBRTtZQUMzQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUMzQixtQ0FBbUM7Z0JBQ25DLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUM7YUFDbkM7UUFDTCxDQUFDLEVBQUMsQ0FBQztJQUNQLENBQUM7Ozs7OztJQUVELHNCQUFzQixDQUFDLEtBQWEsRUFBRSxZQUFvRDtRQUN0RixJQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztJQUMzRCxDQUFDOzs7Ozs7SUFFTywwQkFBMEIsQ0FBQyxVQUFVO1FBQ3pDLHlIQUF5SDtRQUN6SCxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2pELENBQUM7Ozs7Ozs7SUFHRCxnQkFBZ0IsQ0FBQyxNQUFrQixFQUFFLFNBQTBCO1FBQzNELElBQUksQ0FBQyxTQUFTLElBQUksT0FBTyxTQUFTLEtBQUssUUFBUSxFQUFFO1lBQzdDLE9BQU8sRUFBRSxDQUFDO1NBQ2I7O2NBRUssT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBQzs7Y0FDekUsTUFBTSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxvQkFBb0IsQ0FBQzs7Y0FFdkUsZ0JBQWdCOzs7O1FBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUMzQixJQUFJLENBQUMsS0FBSyxLQUFLLEVBQUU7Z0JBQ2IsT0FBTyxPQUFPLENBQUM7YUFDbEI7aUJBQU0sSUFBSSxDQUFDLEtBQUssSUFBSSxFQUFFO2dCQUNuQixPQUFPLE1BQU0sQ0FBQzthQUNqQjtpQkFBTTtnQkFDSCxPQUFRLEVBQUUsQ0FBQzthQUNkO1FBQ0wsQ0FBQyxDQUFBOztZQUVHLG1CQUFtQixHQUFHLEVBQUU7UUFDNUIsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksS0FBSyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUU7WUFDbEQsbUJBQW1CLEdBQUcsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQ3JELElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRTtnQkFDbEIsbUJBQW1CLElBQUksSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO2FBQzNEO1NBQ0o7YUFBTSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLGdCQUFnQixDQUFDLElBQUksRUFBRTs7a0JBQy9DLFFBQVEsR0FBRyxtQkFBQSxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxFQUFxQjtrQkFDM0QsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxHQUFHLFFBQVE7WUFDaEQsbUJBQW1CLEdBQUcsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDO1lBQ3JELElBQUksU0FBUyxDQUFDLE1BQU0sRUFBRTtnQkFDbEIsbUJBQW1CLElBQUksSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUc7Ozs7Z0JBQUMsQ0FBQyxDQUFDLEVBQUU7OzBCQUMxQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUk7Ozs7b0JBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFDO29CQUNuRCxPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDL0IsQ0FBQyxFQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7YUFDbEI7U0FDSjthQUFNO1lBQ0gsSUFBSSxTQUFTLEVBQUU7O3NCQUNMLGNBQWMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQztnQkFDakUsSUFBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUNsQyxtQkFBbUIsR0FBRyxHQUFHLGNBQWMsSUFBSSxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUM7OzBCQUN4RCxjQUFjLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7b0JBQ2pFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTt3QkFDakMsbUJBQW1CLElBQUksSUFBSSxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksY0FBYyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztxQkFDM0c7eUJBQU07d0JBQ0gsSUFBSSxTQUFTLENBQUMsU0FBUyxLQUFLLFNBQVMsRUFBRTs7a0NBQzdCLEdBQUcsR0FBRyxRQUFRLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDOzRCQUNsRCxJQUFJLEdBQUcsS0FBSyxjQUFjLENBQUMsS0FBSyxJQUFJLEdBQUcsS0FBSyxjQUFjLENBQUMsUUFBUSxFQUFFO2dDQUNqRSxtQkFBbUIsSUFBSSxJQUFJLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxjQUFjLEVBQUUsQ0FBQzs2QkFDdkY7eUJBQ0o7cUJBQ0o7aUJBQ0o7cUJBQU07OzBCQUNHLEdBQUcsR0FBRyxRQUFRLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDO29CQUNsRCxJQUFJLEdBQUcsS0FBSyxjQUFjLENBQUMsS0FBSyxJQUFJLEdBQUcsS0FBSyxjQUFjLENBQUMsUUFBUSxFQUFFO3dCQUNqRSxtQkFBbUIsR0FBRyxHQUFHLGNBQWMsRUFBRSxDQUFDO3FCQUM3QztpQkFDSjthQUNKO1NBQ0o7UUFDRCxPQUFPLG1CQUFtQixDQUFDO0lBQy9CLENBQUM7Ozs7OztJQUVPLE9BQU8sQ0FBQyxDQUFDO1FBQ2IsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxTQUFTLElBQUksQ0FBQyxLQUFLLElBQUksQ0FBQztJQUNyRCxDQUFDOzs7OztJQUdELGNBQWMsQ0FBQyxNQUFrQjs7Y0FDdkIsU0FBUyxHQUFHLG1CQUFBLE1BQU0sQ0FBQyxNQUFNLEVBQWdCOztjQUN6QyxRQUFRLEdBQUcsU0FBUyxDQUFDLElBQUk7O1lBQzNCLFdBQVcsR0FBRyxJQUFJO1FBQ3RCLElBQUksUUFBUSxLQUFLLGdCQUFnQixDQUFDLElBQUksRUFBRTs7a0JBQzlCLEdBQUcsR0FBRyxtQkFBQSxNQUFNLENBQUMsU0FBUyxFQUFPO1lBQ25DLElBQUksR0FBRyxFQUFFO2dCQUNMLFdBQVcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDO2FBQzdCO2lCQUFNO2dCQUNILElBQUksU0FBUyxDQUFDLE9BQU8sRUFBRTtvQkFDbkIsV0FBVyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7aUJBQ25DO2FBQ0o7U0FDSjthQUFNLEVBQUUsc0JBQXNCOzs7a0JBQ3JCLFVBQVUsR0FBYSxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRzs7OztZQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNyRSxPQUFPLGFBQWEsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNuRCxDQUFDLEVBQUM7OztrQkFFSSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUc7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRTtnQkFDckQsT0FBTztvQkFDSCxLQUFLLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDO2lCQUNyQixDQUFDO1lBQ04sQ0FBQyxFQUFDO1lBQ0YsV0FBVyxHQUFHO2dCQUNWLFVBQVUsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxPQUFPO2FBQzVFLENBQUM7U0FDTDtRQUVELE9BQU8sV0FBVyxDQUFDO0lBRXZCLENBQUM7Ozs7OztJQUdELGdCQUFnQixDQUFDLElBQVM7O2NBQ2hCLE9BQU8sR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDO1FBQ3BDLElBQUksT0FBTyxFQUFFOztrQkFDSCxRQUFRLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDOztrQkFDdkQsR0FBRyxHQUFHLDZCQUE2QixRQUFRLEVBQUU7WUFDbkQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDeEQ7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7OztZQTVMSixVQUFVOzs7Ozs7Ozs7SUFFUCwwREFBbUU7O0lBQ25FLHdEQUFrRTs7SUFDbEUsb0RBQTZDOztJQUM3QyxzREFBMEQ7O0lBRTFELGdEQUFnQzs7SUFFaEMsd0RBQTBDOztJQUMxQywrQ0FBeUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBDb21wb25lbnRSZWYsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQge0NvbHVtbkZpbHRlclR5cGUsIERhdGFDb2x1bW4sIERhdGFncmlkVXRpbHMsIERhdGFncmlkQ29tcG9uZW50LCBDb2x1bW5GaWx0ZXIgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuXHJcbmltcG9ydCB7IENvbHVtbkZpbHRlckNvbmRpdGlvbiwgRmlsdGVyQ29uZGl0aW9uLCBGaWx0ZXJDb25kaXRpb25WYWx1ZSwgQWxsRmlsdGVyT3BlcmF0b3IsXHJcbiAgICBGaWx0ZXJFbnVtU2V0dGluZywgRmlsdGVyT3BlcmF0b3IsIEZpbHRlckRhdGEgfSBmcm9tICcuL29wZXJhdGlvbnMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRmlsdGVyUm93UGFuZWxDb21wb25lbnQgfSBmcm9tICcuL2ZpbHRlci1lZGl0b3JzL2ZpbHRlci1yb3ctcGFuZWwuY29tcG9uZW50JztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkRmlsdGVyUm93U2VydmljZSB7XHJcbiAgICBwcml2YXRlIGNvbHVtbkNvbmRpdGlvblN1YmplY3QgPSBuZXcgU3ViamVjdDxGaWx0ZXJEYXRhW10gfCBhbnk+KCk7XHJcbiAgICBmaWx0ZXJSb3dDb25kaXRpb25zJCA9IHRoaXMuY29sdW1uQ29uZGl0aW9uU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICAgIGNvbHVtbkNvbmRpdGlvbnM6IENvbHVtbkZpbHRlckNvbmRpdGlvbiA9IHt9O1xyXG4gICAgY3VycmVudEZpbHRlclBhbmVsOiBDb21wb25lbnRSZWY8RmlsdGVyUm93UGFuZWxDb21wb25lbnQ+O1xyXG5cclxuICAgIGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQ7XHJcblxyXG4gICAgZmlsdGVyVGV4dGJveENoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICByZW1vdmVGaWVsZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkgeyB9XHJcblxyXG4gICAgc2V0RmlsdGVyUGFuZWwoZnJwOiBDb21wb25lbnRSZWY8RmlsdGVyUm93UGFuZWxDb21wb25lbnQ+KSB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwgPSBmcnA7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzRmlsdGVyUGFuZWwoKSB7XHJcbiAgICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50RmlsdGVyUGFuZWw7XHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2VGaWx0ZXJQYW5lbCgpIHtcclxuICAgICAgICBpZiAodGhpcy5oYXNGaWx0ZXJQYW5lbCgpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5pbnN0YW5jZS5kb2N1bWVudENsaWNrSGFuZGxlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5pbnN0YW5jZS5kb2N1bWVudENsaWNrSGFuZGxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbCA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93ID0gJ2F1dG8nO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjbGVhcihlbWl0RXZlbnQgPSB0cnVlKSB7XHJcbiAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25zID0ge307XHJcbiAgICAgICAgaWYgKGVtaXRFdmVudCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvblN1YmplY3QubmV4dCh7fSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUZpbHRlckZpZWxkKGZpZWxkOiBzdHJpbmcsIG9wdHM/OiB7ZW1pdEV2ZW50OiBib29sZWFufSkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbHVtbkNvbmRpdGlvbnMpIHtcclxuICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29sdW1uQ29uZGl0aW9uc1tmaWVsZF07XHJcbiAgICAgICAgICAgIGlmICghb3B0cyB8fCAob3B0cyAmJiBvcHRzLmVtaXRFdmVudCkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdENvbHVtbkNvbmRpdGlvbkNoYW5nZWQodGhpcy5jb2x1bW5Db25kaXRpb25zKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZpZWxkLmVtaXQoZmllbGQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBfdXBkYXRlQ29sdW1uQ29uZGl0aW9ucyhmaWVsZDogc3RyaW5nLCBjb2xDb25kaXRpb246IEZpbHRlckNvbmRpdGlvbiB8IEZpbHRlckNvbmRpdGlvblZhbHVlICkge1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnRDb25kaXRpb24gPSB0aGlzLmNvbHVtbkNvbmRpdGlvbnNbZmllbGRdO1xyXG4gICAgICAgIGlmICghY3VycmVudENvbmRpdGlvbikge1xyXG4gICAgICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnMgPSBPYmplY3QuYXNzaWduKHRoaXMuY29sdW1uQ29uZGl0aW9ucywge1tmaWVsZF06IGNvbENvbmRpdGlvbn0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChKU09OLnN0cmluZ2lmeShjdXJyZW50Q29uZGl0aW9uKSAhPT0gSlNPTi5zdHJpbmdpZnkoY29sQ29uZGl0aW9uKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25zID0gT2JqZWN0LmFzc2lnbih0aGlzLmNvbHVtbkNvbmRpdGlvbnMsIHtbZmllbGRdOiBjb2xDb25kaXRpb259KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDlgLzkuLog4oCY4oCZIO+8jOWImeS7o+ihqOedgOS4jeWPguS4juafpeivolxyXG4gICAgICAgIE9iamVjdC5rZXlzKHRoaXMuY29sdW1uQ29uZGl0aW9ucykuZm9yRWFjaChrID0+IHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmNvbHVtbkNvbmRpdGlvbnNba10pIHtcclxuICAgICAgICAgICAgICAgIC8vIGRlbGV0ZSB0aGlzLmNvbHVtbkNvbmRpdGlvbnNba107XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnNba10gPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlQ29sdW1uQ29uZGl0aW9ucyhmaWVsZDogc3RyaW5nLCBjb2xDb25kaXRpb246IEZpbHRlckNvbmRpdGlvbiB8IEZpbHRlckNvbmRpdGlvblZhbHVlICkge1xyXG4gICAgICAgIHRoaXMuX3VwZGF0ZUNvbHVtbkNvbmRpdGlvbnMoZmllbGQsIGNvbENvbmRpdGlvbik7XHJcbiAgICAgICAgdGhpcy5lbWl0Q29sdW1uQ29uZGl0aW9uQ2hhbmdlZCh0aGlzLmNvbHVtbkNvbmRpdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZW1pdENvbHVtbkNvbmRpdGlvbkNoYW5nZWQoY29uZGl0aW9ucykge1xyXG4gICAgICAgIC8vIGNvbnN0IGZhcnIgPSB0aGlzLmdyaWRJbnN0YW5jZS5yZW1vdGVGaWx0ZXIgPyB0aGlzLmNvbnZlcnQyRmlsdGVyQXJyYXkodGhpcy5jb2x1bW5Db25kaXRpb25zKSA6IHRoaXMuY29sdW1uQ29uZGl0aW9ucztcclxuICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvblN1YmplY3QubmV4dChjb25kaXRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5bov4fmu6TooYzmmL7npLrmlofmnKxcclxuICAgIGNvbmRpdGlvbjJzdHJpbmcoY29sdW1uOiBEYXRhQ29sdW1uLCBjb25kaXRpb246IEZpbHRlckNvbmRpdGlvbikge1xyXG4gICAgICAgIGlmICghY29uZGl0aW9uIHx8IHR5cGVvZiBjb25kaXRpb24gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGFuZFRleHQgPSB0aGlzLmdyaWRJbnN0YW5jZS5sb2NhbGVTZXJ2aWNlLmdldFZhbHVlKCdkYXRhZ3JpZC5maWx0ZXIuYW5kJyk7XHJcbiAgICAgICAgY29uc3Qgb3JUZXh0ID0gdGhpcy5ncmlkSW5zdGFuY2UubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZGF0YWdyaWQuZmlsdGVyLm9yJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGdldFJlbGF0aW9uTGFiZWwgPSAocikgPT4ge1xyXG4gICAgICAgICAgICBpZiAociA9PT0gJ2FuZCcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBhbmRUZXh0O1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHIgPT09ICdvcicpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvclRleHQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gICcnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgbGV0IGZpbHRlclByZVZpZXdTdHJpbmcgPSAnJztcclxuICAgICAgICBpZiAoY29sdW1uLmZpbHRlci50eXBlID09PSBDb2x1bW5GaWx0ZXJUeXBlLmZyb21kYXRhKSB7XHJcbiAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgPSBgKCR7Y29uZGl0aW9uLnZhbHVlMS5sZW5ndGh9KWA7XHJcbiAgICAgICAgICAgIGlmIChjb25kaXRpb24udmFsdWUxKSB7XHJcbiAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nICs9IGAgJHtjb25kaXRpb24udmFsdWUxLmpvaW4oJywnKX1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIGlmIChjb2x1bW4uZmlsdGVyLnR5cGUgPT09IENvbHVtbkZpbHRlclR5cGUuZW51bSkge1xyXG4gICAgICAgICAgICBjb25zdCBlbnVtT3B0cyA9IHRoaXMuZ2V0RW51bU9wdGlvbnMoY29sdW1uKSBhcyBGaWx0ZXJFbnVtU2V0dGluZztcclxuICAgICAgICAgICAgY29uc3QgeyB2YWx1ZUZpZWxkLCB0ZXh0RmllbGQsIGRhdGEgfSA9IGVudW1PcHRzO1xyXG4gICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCgke2NvbmRpdGlvbi52YWx1ZTEubGVuZ3RofSlgO1xyXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uLnZhbHVlMSkge1xyXG4gICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Y29uZGl0aW9uLnZhbHVlMS5tYXAodiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW51bUl0ZW0gPSBkYXRhLmZpbmQoZCA9PiBkW3ZhbHVlRmllbGRdID09IHYpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlbnVtSXRlbVt0ZXh0RmllbGRdO1xyXG4gICAgICAgICAgICAgICAgfSkuam9pbignLCcpfWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcGVyYXRvcjFMYWJlbCA9IHRoaXMuZ2V0T3BlcmF0b3JMYWJlbChjb25kaXRpb24ub3BlcmF0b3IxKTtcclxuICAgICAgICAgICAgICAgIGlmICggIXRoaXMuaXNFbXB0eShjb25kaXRpb24udmFsdWUxKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgPSBgJHtvcGVyYXRvcjFMYWJlbH0gJHtjb25kaXRpb24udmFsdWUxfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3BlcmF0b3IyTGFiZWwgPSB0aGlzLmdldE9wZXJhdG9yTGFiZWwoY29uZGl0aW9uLm9wZXJhdG9yMik7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRW1wdHkoY29uZGl0aW9uLnZhbHVlMikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Z2V0UmVsYXRpb25MYWJlbChjb25kaXRpb24ucmVsYXRpb24pfSAke29wZXJhdG9yMkxhYmVsfSAke2NvbmRpdGlvbi52YWx1ZTJ9YDtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLm9wZXJhdG9yMiAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcDIgPSBwYXJzZUludCgnJyArIGNvbmRpdGlvbi5vcGVyYXRvcjIsIDEwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcDIgPT09IEZpbHRlck9wZXJhdG9yLkVtcHR5IHx8IG9wMiA9PT0gRmlsdGVyT3BlcmF0b3IuTm90RW1wdHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nICs9IGAgJHtnZXRSZWxhdGlvbkxhYmVsKGNvbmRpdGlvbi5yZWxhdGlvbil9ICR7b3BlcmF0b3IyTGFiZWx9YDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3AxID0gcGFyc2VJbnQoJycgKyBjb25kaXRpb24ub3BlcmF0b3IxLCAxMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9wMSA9PT0gRmlsdGVyT3BlcmF0b3IuRW1wdHkgfHwgb3AxID09PSBGaWx0ZXJPcGVyYXRvci5Ob3RFbXB0eSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCR7b3BlcmF0b3IxTGFiZWx9YDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZpbHRlclByZVZpZXdTdHJpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpc0VtcHR5KHYpIHtcclxuICAgICAgICByZXR1cm4gdiA9PT0gJycgfHwgdiA9PT0gdW5kZWZpbmVkIHx8IHYgPT09IG51bGw7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGdldEVudW1PcHRpb25zKGNvbHVtbjogRGF0YUNvbHVtbikge1xyXG4gICAgICAgIGNvbnN0IGNvbEZpbHRlciA9IGNvbHVtbi5maWx0ZXIgYXMgQ29sdW1uRmlsdGVyO1xyXG4gICAgICAgIGNvbnN0IGRhdGF0eXBlID0gY29sRmlsdGVyLnR5cGU7XHJcbiAgICAgICAgbGV0IGVudW1TZXR0aW5nID0gbnVsbDtcclxuICAgICAgICBpZiAoZGF0YXR5cGUgPT09IENvbHVtbkZpbHRlclR5cGUuZW51bSkge1xyXG4gICAgICAgICAgICBjb25zdCBmbXQgPSBjb2x1bW4uZm9ybWF0dGVyIGFzIGFueTtcclxuICAgICAgICAgICAgaWYgKGZtdCkge1xyXG4gICAgICAgICAgICAgICAgZW51bVNldHRpbmcgPSBmbXQub3B0aW9ucztcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChjb2xGaWx0ZXIub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgIGVudW1TZXR0aW5nID0gY29sRmlsdGVyLm9wdGlvbnM7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgeyAvLyBlbnVtIOaVsOaNrua6kOadpeiHqmdyaWQg5pWw5o2u5YiX6KGoXHJcbiAgICAgICAgICAgIGNvbnN0IGNvbHVtbkRhdGE6IHN0cmluZ1tdID0gdGhpcy5ncmlkSW5zdGFuY2UuZGZzLmdldERhdGEodHJ1ZSkubWFwKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIERhdGFncmlkVXRpbHMuZ2V0VmFsdWUoY29sdW1uLmZpZWxkLCBuKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8vIOWOu+mZpOmHjeWkjVxyXG4gICAgICAgICAgICBjb25zdCBlbnVtRGF0YSA9IEFycmF5LmZyb20obmV3IFNldChjb2x1bW5EYXRhKSkubWFwKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbiwgbGFiZWw6IG5cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBlbnVtU2V0dGluZyA9IHtcclxuICAgICAgICAgICAgICAgIHZhbHVlRmllbGQ6ICd2YWx1ZScsIHRleHRGaWVsZDogJ2xhYmVsJywgZGF0YTogZW51bURhdGEsIGlkRmllbGQ6ICd2YWx1ZSdcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBlbnVtU2V0dGluZztcclxuXHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W5pON5L2c56ym5qCH562+XHJcbiAgICBnZXRPcGVyYXRvckxhYmVsKGNvZGU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHN0ck9wZXIgPSBGaWx0ZXJPcGVyYXRvcltjb2RlXTtcclxuICAgICAgICBpZiAoc3RyT3Blcikge1xyXG4gICAgICAgICAgICBjb25zdCBvcGVyTmFtZSA9IHN0ck9wZXJbMF0udG9Mb3dlckNhc2UoKSArIHN0ck9wZXIuc3Vic3RyKDEpO1xyXG4gICAgICAgICAgICBjb25zdCBrZXkgPSBgZGF0YWdyaWQuZmlsdGVyLm9wZXJhdG9ycy4ke29wZXJOYW1lfWA7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdyaWRJbnN0YW5jZS5sb2NhbGVTZXJ2aWNlLmdldFZhbHVlKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbn1cclxuIl19