/**
 * 树数据的帮助类
 */
var ParentTreeNodeUtil = /** @class */ (function () {
    function ParentTreeNodeUtil() {
    }
    /**
     * 选中第一个根节点
     */
    ParentTreeNodeUtil.prototype.selectFirstRootNode = function (bindingData, hierarchyInfoKey) {
        var treeNodesData = bindingData.list.toJSON();
        var firstRootNodeId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        this.selectedNode(bindingData, hierarchyInfoKey, firstRootNodeId);
    };
    ParentTreeNodeUtil.prototype.selectNodeByBindingList = function (bindingList, hierarchyInfoKey, selectedNodeId) {
        var treeNodesData = bindingList.toJSON();
        // 如果要设置的节点不存在，则设置第1个根节点
        var selectedNodeData = this.getNodeDataById(treeNodesData, selectedNodeId);
        var currentId = selectedNodeId;
        if (!selectedNodeData) {
            currentId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        }
        setTimeout(function () {
            bindingList.setCurrentId(currentId, true, true);
        }, 0);
    };
    /**
     * 选中节点
     */
    ParentTreeNodeUtil.prototype.selectedNode = function (bindingData, hierarchyInfoKey, selectedNodeId) {
        var treeNodesData = bindingData.list.toJSON();
        // 如果要设置的节点不存在，则设置第1个根节点
        var selectedNodeData = this.getNodeDataById(treeNodesData, selectedNodeId);
        var currentId = selectedNodeId;
        if (!selectedNodeData) {
            currentId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        }
        if (bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        setTimeout(function () {
            bindingData.list.currentId = null;
            bindingData.list.setCurrentId(currentId, true, true);
        }, 0);
    };
    /**
     * 检查是否有子节点
     */
    ParentTreeNodeUtil.prototype.hasChildNodes = function (treeNodesData, hierarchyInfoKey, fid) {
        var fNodeData = this.getNodeDataById(treeNodesData, fid);
        // const fLayer = fNodeData[hierarchyInfoKey]['layer'];
        var fIsDetail = fNodeData[hierarchyInfoKey]['isDetail'];
        // 非明细节点，返回true
        if (fIsDetail === false) {
            return true;
        }
        return false;
        // const childNodesData = this.getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fid);
        // return childNodesData.length > 0;
    };
    /**
     * 获取根节点（多个根节点时获取第一个）
     * @return 找不到时返回null
     */
    ParentTreeNodeUtil.prototype.getFirstNodeId = function (treeNodesData, hierarchyInfoKey) {
        var rootData = treeNodesData.find(function (itemData) {
            var layer = itemData[hierarchyInfoKey]['layer'];
            return layer === 1;
        });
        if (!rootData) {
            var rootLayer_1 = this.getRootLayer(treeNodesData, hierarchyInfoKey);
            rootData = treeNodesData.find(function (itemData) {
                var layer = itemData[hierarchyInfoKey]['layer'];
                return layer === rootLayer_1;
            });
        }
        return rootData ? rootData['id'] : '';
    };
    ParentTreeNodeUtil.prototype.getRootLayer = function (treeNodesData, hierarchyInfoKey) {
        var layer = null;
        if (treeNodesData && Array.isArray(treeNodesData)) {
            var layers = treeNodesData.map(function (item) {
                var layer = item[hierarchyInfoKey]['layer'];
                return layer;
            });
            var minLayer = Math.min.apply(Math, layers);
            if (!isNaN(minLayer)) {
                layer = minLayer;
            }
        }
        return layer;
    };
    /**
     * 获取下一个节点（删除后）
     */
    ParentTreeNodeUtil.prototype.getNextNodeId = function (treeNodesData, hierarchyInfoKey, currentId) {
        // 当前节点信息
        var currentNodeData = treeNodesData.find(function (itemData) {
            return itemData['id'] === currentId;
        });
        var currentLayer = currentNodeData[hierarchyInfoKey]['layer'];
        // 父节点信息
        var fLayer = currentLayer - 1;
        var fParentElement = currentNodeData[hierarchyInfoKey]['parentElement'];
        // 查找兄弟节点
        var siblingtreeNodesData = this.getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fParentElement);
        // 如果没有兄弟节点，向上查找
        if (siblingtreeNodesData.length === 1) {
            var parentData = treeNodesData.find(function (itemData) {
                return itemData['id'] === fParentElement;
            });
            // 存在父节点，则设置父节点；
            // 不存在父节点，则设置第一个根节点。
            if (!parentData) {
                return this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
            }
            return parentData['id'];
        }
        else {
            return this.getNextSiblingNodeId(siblingtreeNodesData, currentId);
        }
    };
    /**
     * 获取下个兄弟节点的id
     */
    ParentTreeNodeUtil.prototype.getNextSiblingNodeId = function (siblingtreeNodesData, currentId) {
        if (siblingtreeNodesData.length <= 1) {
            return '';
        }
        var currentIndex = siblingtreeNodesData.findIndex(function (itemData) {
            return itemData['id'] === currentId;
        });
        // 最后一行上移一行，其他下移一行
        var nextIndex = -1;
        if (currentIndex === siblingtreeNodesData.length - 1) {
            nextIndex = currentIndex - 1;
        }
        else {
            nextIndex = currentIndex + 1;
        }
        return siblingtreeNodesData[nextIndex]['id'];
    };
    /**
     * 获取下级节点的BindingObjects集合
     */
    ParentTreeNodeUtil.prototype.getChildNodesData = function (treeNodesData, hierarchyInfoKey, fLayer, fParentElement) {
        var childtreeNodesData = treeNodesData.filter(function (itemData) {
            var layer = itemData[hierarchyInfoKey]['layer'];
            var parentElement = itemData[hierarchyInfoKey]['parentElement'];
            return (layer === fLayer + 1) && fParentElement == parentElement;
        });
        return childtreeNodesData;
    };
    /**
     * 获取id获取节点数据
     */
    ParentTreeNodeUtil.prototype.getNodeDataById = function (treeNodesData, id) {
        var nodeData = treeNodesData.find(function (itemData) {
            return itemData['id'] === id;
        });
        return nodeData ? nodeData : null;
    };
    return ParentTreeNodeUtil;
}());
export { ParentTreeNodeUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyZW50LXRyZWUudXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3RyZWUtdGFibGUvdXRpbC9wYXJlbnQtdHJlZS51dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBOztHQUVHO0FBQ0g7SUFBQTtJQTRLQSxDQUFDO0lBMUtDOztPQUVHO0lBQ0ksZ0RBQW1CLEdBQTFCLFVBQTJCLFdBQXdCLEVBQUUsZ0JBQXdCO1FBRTNFLElBQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEQsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztRQUM3RSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBQ00sb0RBQXVCLEdBQTlCLFVBQStCLFdBQXdCLEVBQUUsZ0JBQXdCLEVBQUUsY0FBc0I7UUFDdkcsSUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzNDLHdCQUF3QjtRQUN4QixJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzdFLElBQUksU0FBUyxHQUFHLGNBQWMsQ0FBQztRQUMvQixJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDckIsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUM7U0FDbEU7UUFDRCxVQUFVLENBQUM7WUFDVCxXQUFXLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEQsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ1IsQ0FBQztJQUNEOztPQUVHO0lBQ0kseUNBQVksR0FBbkIsVUFBb0IsV0FBd0IsRUFBRSxnQkFBd0IsRUFBRSxjQUFzQjtRQUM1RixJQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hELHdCQUF3QjtRQUN4QixJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzdFLElBQUksU0FBUyxHQUFHLGNBQWMsQ0FBQztRQUMvQixJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDckIsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUM7U0FDbEU7UUFDRCxJQUFJLFdBQVcsQ0FBQyx1QkFBdUIsS0FBSyxJQUFJLEVBQUU7WUFDaEQsT0FBTztTQUNSO1FBQ0QsVUFBVSxDQUFDO1lBQ1QsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ2xDLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdkQsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ1IsQ0FBQztJQUVEOztPQUVHO0lBQ0ksMENBQWEsR0FBcEIsVUFBcUIsYUFBb0IsRUFBRSxnQkFBd0IsRUFBRSxHQUFXO1FBQzlFLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzNELHVEQUF1RDtRQUN2RCxJQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUxRCxlQUFlO1FBQ2YsSUFBSSxTQUFTLEtBQUssS0FBSyxFQUFFO1lBQ3ZCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxPQUFPLEtBQUssQ0FBQztRQUViLCtGQUErRjtRQUMvRixvQ0FBb0M7SUFDdEMsQ0FBQztJQUVEOzs7T0FHRztJQUNLLDJDQUFjLEdBQXRCLFVBQXVCLGFBQW9CLEVBQUUsZ0JBQXdCO1FBQ25FLElBQUksUUFBUSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBQyxRQUFhO1lBQzlDLElBQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELE9BQU8sS0FBSyxLQUFLLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixJQUFNLFdBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3JFLFFBQVEsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQUMsUUFBYTtnQkFDMUMsSUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ2xELE9BQU8sS0FBSyxLQUFLLFdBQVMsQ0FBQztZQUM3QixDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFDTyx5Q0FBWSxHQUFwQixVQUFxQixhQUFvQixFQUFFLGdCQUF3QjtRQUNqRSxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxhQUFhLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsRUFBRTtZQUNqRCxJQUFNLE1BQU0sR0FBRyxhQUFhLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSTtnQkFDbkMsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzlDLE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDOUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDcEIsS0FBSyxHQUFHLFFBQVEsQ0FBQzthQUNsQjtTQUNGO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQ0Q7O09BRUc7SUFDSSwwQ0FBYSxHQUFwQixVQUFxQixhQUFvQixFQUFFLGdCQUF3QixFQUFFLFNBQWlCO1FBRXBGLFNBQVM7UUFDVCxJQUFNLGVBQWUsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQUMsUUFBYTtZQUN2RCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUVoRSxRQUFRO1FBQ1IsSUFBTSxNQUFNLEdBQUcsWUFBWSxHQUFHLENBQUMsQ0FBQztRQUNoQyxJQUFNLGNBQWMsR0FBRyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUUxRSxTQUFTO1FBQ1QsSUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsYUFBYSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxjQUFjLENBQUMsQ0FBQztRQUU3RyxnQkFBZ0I7UUFDaEIsSUFBSSxvQkFBb0IsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3JDLElBQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBQyxRQUFhO2dCQUNsRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxjQUFjLENBQUM7WUFDM0MsQ0FBQyxDQUFDLENBQUM7WUFFSCxnQkFBZ0I7WUFDaEIsb0JBQW9CO1lBQ3BCLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ2YsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO2FBQzdEO1lBQ0QsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekI7YUFBTTtZQUNMLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLG9CQUFvQixFQUFFLFNBQVMsQ0FBQyxDQUFDO1NBQ25FO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ksaURBQW9CLEdBQTNCLFVBQTRCLG9CQUEyQixFQUFFLFNBQWlCO1FBQ3hFLElBQUksb0JBQW9CLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUNwQyxPQUFPLEVBQUUsQ0FBQztTQUNYO1FBRUQsSUFBTSxZQUFZLEdBQUcsb0JBQW9CLENBQUMsU0FBUyxDQUFDLFVBQUMsUUFBYTtZQUNoRSxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxTQUFTLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxrQkFBa0I7UUFDbEIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkIsSUFBSSxZQUFZLEtBQUssb0JBQW9CLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNwRCxTQUFTLEdBQUcsWUFBWSxHQUFHLENBQUMsQ0FBQztTQUM5QjthQUFNO1lBQ0wsU0FBUyxHQUFHLFlBQVksR0FBRyxDQUFDLENBQUM7U0FDOUI7UUFFRCxPQUFPLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRDs7T0FFRztJQUNJLDhDQUFpQixHQUF4QixVQUF5QixhQUFvQixFQUFFLGdCQUF3QixFQUFFLE1BQWMsRUFBRSxjQUFzQjtRQUM3RyxJQUFNLGtCQUFrQixHQUFHLGFBQWEsQ0FBQyxNQUFNLENBQUMsVUFBQyxRQUFRO1lBQ3ZELElBQU0sS0FBSyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELElBQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2xFLE9BQU8sQ0FBQyxLQUFLLEtBQUssTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLGNBQWMsSUFBSSxhQUFhLENBQUM7UUFDbkUsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLGtCQUFrQixDQUFDO0lBQzVCLENBQUM7SUFFRDs7T0FFRztJQUNJLDRDQUFlLEdBQXRCLFVBQXVCLGFBQW9CLEVBQUUsRUFBVTtRQUNyRCxJQUFNLFFBQVEsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQUMsUUFBYTtZQUNoRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDcEMsQ0FBQztJQUNILHlCQUFDO0FBQUQsQ0FBQyxBQTVLRCxJQTRLQztBQUVELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuXG4vKipcbiAqIOagkeaVsOaNrueahOW4ruWKqeexu1xuICovXG5jbGFzcyBQYXJlbnRUcmVlTm9kZVV0aWwge1xuXG4gIC8qKlxuICAgKiDpgInkuK3nrKzkuIDkuKrmoLnoioLngrlcbiAgICovXG4gIHB1YmxpYyBzZWxlY3RGaXJzdFJvb3ROb2RlKGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nKSB7XG5cbiAgICBjb25zdCB0cmVlTm9kZXNEYXRhID0gYmluZGluZ0RhdGEubGlzdC50b0pTT04oKTtcbiAgICBjb25zdCBmaXJzdFJvb3ROb2RlSWQgPSB0aGlzLmdldEZpcnN0Tm9kZUlkKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgIHRoaXMuc2VsZWN0ZWROb2RlKGJpbmRpbmdEYXRhLCBoaWVyYXJjaHlJbmZvS2V5LCBmaXJzdFJvb3ROb2RlSWQpO1xuICB9XG4gIHB1YmxpYyBzZWxlY3ROb2RlQnlCaW5kaW5nTGlzdChiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QsIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgc2VsZWN0ZWROb2RlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHRyZWVOb2Rlc0RhdGEgPSBiaW5kaW5nTGlzdC50b0pTT04oKTtcbiAgICAvLyDlpoLmnpzopoHorr7nva7nmoToioLngrnkuI3lrZjlnKjvvIzliJnorr7nva7nrKwx5Liq5qC56IqC54K5XG4gICAgY29uc3Qgc2VsZWN0ZWROb2RlRGF0YSA9IHRoaXMuZ2V0Tm9kZURhdGFCeUlkKHRyZWVOb2Rlc0RhdGEsIHNlbGVjdGVkTm9kZUlkKTtcbiAgICBsZXQgY3VycmVudElkID0gc2VsZWN0ZWROb2RlSWQ7XG4gICAgaWYgKCFzZWxlY3RlZE5vZGVEYXRhKSB7XG4gICAgICBjdXJyZW50SWQgPSB0aGlzLmdldEZpcnN0Tm9kZUlkKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgIH1cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChjdXJyZW50SWQsIHRydWUsIHRydWUpO1xuICAgIH0sIDApO1xuICB9XG4gIC8qKlxuICAgKiDpgInkuK3oioLngrlcbiAgICovXG4gIHB1YmxpYyBzZWxlY3RlZE5vZGUoYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIHNlbGVjdGVkTm9kZUlkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBjb25zdCB0cmVlTm9kZXNEYXRhID0gYmluZGluZ0RhdGEubGlzdC50b0pTT04oKTtcbiAgICAvLyDlpoLmnpzopoHorr7nva7nmoToioLngrnkuI3lrZjlnKjvvIzliJnorr7nva7nrKwx5Liq5qC56IqC54K5XG4gICAgY29uc3Qgc2VsZWN0ZWROb2RlRGF0YSA9IHRoaXMuZ2V0Tm9kZURhdGFCeUlkKHRyZWVOb2Rlc0RhdGEsIHNlbGVjdGVkTm9kZUlkKTtcbiAgICBsZXQgY3VycmVudElkID0gc2VsZWN0ZWROb2RlSWQ7XG4gICAgaWYgKCFzZWxlY3RlZE5vZGVEYXRhKSB7XG4gICAgICBjdXJyZW50SWQgPSB0aGlzLmdldEZpcnN0Tm9kZUlkKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgIH1cbiAgICBpZiAoYmluZGluZ0RhdGEucm93U2VsZWN0ZWRFdmVudFN1c3BlbmQgPT09IHRydWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBiaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCA9IG51bGw7XG4gICAgICBiaW5kaW5nRGF0YS5saXN0LnNldEN1cnJlbnRJZChjdXJyZW50SWQsIHRydWUsIHRydWUpO1xuICAgIH0sIDApO1xuICB9XG5cbiAgLyoqXG4gICAqIOajgOafpeaYr+WQpuacieWtkOiKgueCuVxuICAgKi9cbiAgcHVibGljIGhhc0NoaWxkTm9kZXModHJlZU5vZGVzRGF0YTogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgZmlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBmTm9kZURhdGEgPSB0aGlzLmdldE5vZGVEYXRhQnlJZCh0cmVlTm9kZXNEYXRhLCBmaWQpO1xuICAgIC8vIGNvbnN0IGZMYXllciA9IGZOb2RlRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcbiAgICBjb25zdCBmSXNEZXRhaWwgPSBmTm9kZURhdGFbaGllcmFyY2h5SW5mb0tleV1bJ2lzRGV0YWlsJ107XG5cbiAgICAvLyDpnZ7mmI7nu4boioLngrnvvIzov5Tlm550cnVlXG4gICAgaWYgKGZJc0RldGFpbCA9PT0gZmFsc2UpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG5cbiAgICAvLyBjb25zdCBjaGlsZE5vZGVzRGF0YSA9IHRoaXMuZ2V0Q2hpbGROb2Rlc0RhdGEodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSwgZkxheWVyLCBmaWQpO1xuICAgIC8vIHJldHVybiBjaGlsZE5vZGVzRGF0YS5sZW5ndGggPiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluagueiKgueCue+8iOWkmuS4quagueiKgueCueaXtuiOt+WPluesrOS4gOS4qu+8iVxuICAgKiBAcmV0dXJuIOaJvuS4jeWIsOaXtui/lOWbnm51bGxcbiAgICovXG4gIHByaXZhdGUgZ2V0Rmlyc3ROb2RlSWQodHJlZU5vZGVzRGF0YTogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IHJvb3REYXRhID0gdHJlZU5vZGVzRGF0YS5maW5kKChpdGVtRGF0YTogYW55KSA9PiB7XG4gICAgICBjb25zdCBsYXllciA9IGl0ZW1EYXRhW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xuICAgICAgcmV0dXJuIGxheWVyID09PSAxO1xuICAgIH0pO1xuICAgIGlmICghcm9vdERhdGEpIHtcbiAgICAgIGNvbnN0IHJvb3RMYXllciA9IHRoaXMuZ2V0Um9vdExheWVyKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgICAgcm9vdERhdGEgPSB0cmVlTm9kZXNEYXRhLmZpbmQoKGl0ZW1EYXRhOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBpdGVtRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcbiAgICAgICAgcmV0dXJuIGxheWVyID09PSByb290TGF5ZXI7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJvb3REYXRhID8gcm9vdERhdGFbJ2lkJ10gOiAnJztcbiAgfVxuICBwcml2YXRlIGdldFJvb3RMYXllcih0cmVlTm9kZXNEYXRhOiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nKSB7XG4gICAgbGV0IGxheWVyID0gbnVsbDtcbiAgICBpZiAodHJlZU5vZGVzRGF0YSAmJiBBcnJheS5pc0FycmF5KHRyZWVOb2Rlc0RhdGEpKSB7XG4gICAgICBjb25zdCBsYXllcnMgPSB0cmVlTm9kZXNEYXRhLm1hcChpdGVtID0+IHtcbiAgICAgICAgY29uc3QgbGF5ZXIgPSBpdGVtW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xuICAgICAgICByZXR1cm4gbGF5ZXI7XG4gICAgICB9KTtcbiAgICAgIGNvbnN0IG1pbkxheWVyID0gTWF0aC5taW4uYXBwbHkoTWF0aCwgbGF5ZXJzKTtcbiAgICAgIGlmICghaXNOYU4obWluTGF5ZXIpKSB7XG4gICAgICAgIGxheWVyID0gbWluTGF5ZXI7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBsYXllcjtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5LiL5LiA5Liq6IqC54K577yI5Yig6Zmk5ZCO77yJXG4gICAqL1xuICBwdWJsaWMgZ2V0TmV4dE5vZGVJZCh0cmVlTm9kZXNEYXRhOiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBjdXJyZW50SWQ6IHN0cmluZyk6IHN0cmluZyB7XG5cbiAgICAvLyDlvZPliY3oioLngrnkv6Hmga9cbiAgICBjb25zdCBjdXJyZW50Tm9kZURhdGEgPSB0cmVlTm9kZXNEYXRhLmZpbmQoKGl0ZW1EYXRhOiBhbnkpID0+IHtcbiAgICAgIHJldHVybiBpdGVtRGF0YVsnaWQnXSA9PT0gY3VycmVudElkO1xuICAgIH0pO1xuICAgIGNvbnN0IGN1cnJlbnRMYXllciA9IGN1cnJlbnROb2RlRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcblxuICAgIC8vIOeItuiKgueCueS/oeaBr1xuICAgIGNvbnN0IGZMYXllciA9IGN1cnJlbnRMYXllciAtIDE7XG4gICAgY29uc3QgZlBhcmVudEVsZW1lbnQgPSBjdXJyZW50Tm9kZURhdGFbaGllcmFyY2h5SW5mb0tleV1bJ3BhcmVudEVsZW1lbnQnXTtcblxuICAgIC8vIOafpeaJvuWFhOW8n+iKgueCuVxuICAgIGNvbnN0IHNpYmxpbmd0cmVlTm9kZXNEYXRhID0gdGhpcy5nZXRDaGlsZE5vZGVzRGF0YSh0cmVlTm9kZXNEYXRhLCBoaWVyYXJjaHlJbmZvS2V5LCBmTGF5ZXIsIGZQYXJlbnRFbGVtZW50KTtcblxuICAgIC8vIOWmguaenOayoeacieWFhOW8n+iKgueCue+8jOWQkeS4iuafpeaJvlxuICAgIGlmIChzaWJsaW5ndHJlZU5vZGVzRGF0YS5sZW5ndGggPT09IDEpIHtcbiAgICAgIGNvbnN0IHBhcmVudERhdGEgPSB0cmVlTm9kZXNEYXRhLmZpbmQoKGl0ZW1EYXRhOiBhbnkpID0+IHtcbiAgICAgICAgcmV0dXJuIGl0ZW1EYXRhWydpZCddID09PSBmUGFyZW50RWxlbWVudDtcbiAgICAgIH0pO1xuXG4gICAgICAvLyDlrZjlnKjniLboioLngrnvvIzliJnorr7nva7niLboioLngrnvvJtcbiAgICAgIC8vIOS4jeWtmOWcqOeItuiKgueCue+8jOWImeiuvue9ruesrOS4gOS4quagueiKgueCueOAglxuICAgICAgaWYgKCFwYXJlbnREYXRhKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEZpcnN0Tm9kZUlkKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHBhcmVudERhdGFbJ2lkJ107XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB0aGlzLmdldE5leHRTaWJsaW5nTm9kZUlkKHNpYmxpbmd0cmVlTm9kZXNEYXRhLCBjdXJyZW50SWQpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bkuIvkuKrlhYTlvJ/oioLngrnnmoRpZFxuICAgKi9cbiAgcHVibGljIGdldE5leHRTaWJsaW5nTm9kZUlkKHNpYmxpbmd0cmVlTm9kZXNEYXRhOiBhbnlbXSwgY3VycmVudElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChzaWJsaW5ndHJlZU5vZGVzRGF0YS5sZW5ndGggPD0gMSkge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHNpYmxpbmd0cmVlTm9kZXNEYXRhLmZpbmRJbmRleCgoaXRlbURhdGE6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIGl0ZW1EYXRhWydpZCddID09PSBjdXJyZW50SWQ7XG4gICAgfSk7XG5cbiAgICAvLyDmnIDlkI7kuIDooYzkuIrnp7vkuIDooYzvvIzlhbbku5bkuIvnp7vkuIDooYxcbiAgICBsZXQgbmV4dEluZGV4ID0gLTE7XG4gICAgaWYgKGN1cnJlbnRJbmRleCA9PT0gc2libGluZ3RyZWVOb2Rlc0RhdGEubGVuZ3RoIC0gMSkge1xuICAgICAgbmV4dEluZGV4ID0gY3VycmVudEluZGV4IC0gMTtcbiAgICB9IGVsc2Uge1xuICAgICAgbmV4dEluZGV4ID0gY3VycmVudEluZGV4ICsgMTtcbiAgICB9XG5cbiAgICByZXR1cm4gc2libGluZ3RyZWVOb2Rlc0RhdGFbbmV4dEluZGV4XVsnaWQnXTtcbiAgfVxuXG4gIC8qKlxuICAgKiDojrflj5bkuIvnuqfoioLngrnnmoRCaW5kaW5nT2JqZWN0c+mbhuWQiFxuICAgKi9cbiAgcHVibGljIGdldENoaWxkTm9kZXNEYXRhKHRyZWVOb2Rlc0RhdGE6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIGZMYXllcjogbnVtYmVyLCBmUGFyZW50RWxlbWVudDogc3RyaW5nKTogYW55W10ge1xuICAgIGNvbnN0IGNoaWxkdHJlZU5vZGVzRGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmlsdGVyKChpdGVtRGF0YSkgPT4ge1xuICAgICAgY29uc3QgbGF5ZXIgPSBpdGVtRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnbGF5ZXInXTtcbiAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSBpdGVtRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsncGFyZW50RWxlbWVudCddO1xuICAgICAgcmV0dXJuIChsYXllciA9PT0gZkxheWVyICsgMSkgJiYgZlBhcmVudEVsZW1lbnQgPT0gcGFyZW50RWxlbWVudDtcbiAgICB9KTtcbiAgICByZXR1cm4gY2hpbGR0cmVlTm9kZXNEYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPlmlk6I635Y+W6IqC54K55pWw5o2uXG4gICAqL1xuICBwdWJsaWMgZ2V0Tm9kZURhdGFCeUlkKHRyZWVOb2Rlc0RhdGE6IGFueVtdLCBpZDogc3RyaW5nKTogYW55IHtcbiAgICBjb25zdCBub2RlRGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmluZCgoaXRlbURhdGE6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIGl0ZW1EYXRhWydpZCddID09PSBpZDtcbiAgICB9KTtcbiAgICByZXR1cm4gbm9kZURhdGEgPyBub2RlRGF0YSA6IG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IHsgUGFyZW50VHJlZU5vZGVVdGlsIH07XG4iXX0=