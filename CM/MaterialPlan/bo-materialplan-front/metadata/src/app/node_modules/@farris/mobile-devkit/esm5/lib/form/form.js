import { MetadataUtil } from '../core/index';
import { FormControl } from './form_control';
import { FORM_CONTROL_PROP_META } from './decorators';
import { Subject } from 'rxjs';
import { ValidatorFactory } from '../validator';
/**
 * Form抽象类
 */
var Form = /** @class */ (function () {
    /**
     * 构造函数
     */
    function Form(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.formControlConfigs = [];
        this.validateformControls = [];
        this.validateformControlPathMap = new Map;
        this.changes = new Subject();
    }
    /**
     * 初始化
     */
    Form.prototype.init = function () {
        this.collectMetadatas();
        this.createFormControls();
    };
    /**
     * 全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    Form.prototype.validateFields = function () {
        var _this = this;
        var validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach(function (formControl) {
            _this[formControl]['validationResult'] = ValidatorFactory.executeValidator(_this[formControl]['validatorFn'], _this[formControl]['value']);
            !_this[formControl]['validationResult'].passing && validationResult.push(_this[formControl]);
        });
        this.changes.next({ type: 'validateFieldsFinished' });
        return validationResult;
    };
    /**
     * 获取某一个得校验错误信息
     * @param name 属性名称
     */
    Form.prototype.getFieldError = function (name) {
        if (this.validateformControls.length === 0) {
            return {};
        }
        var index = this.validateformControls.findIndex(function (item) {
            return item === name;
        });
        if (index === -1) {
            return {};
        }
        else {
            var result = ValidatorFactory.executeValidator(this[name]['validatorFn'], this[name]['value']);
            this[name]['validationResult'] = result;
            this.changes.next({ type: 'validateFieldsFinished', value: name });
            return result;
        }
    };
    /**
   * 根据form元数据中的path获取某一个得校验错误信息
   * @param path 属性名称数组
   */
    Form.prototype.getFieldErrorByPath = function (path) {
        if (this.validateformControls.length === 0) {
            return {};
        }
        var pathName = path[0];
        if (path && path.length >= 2) {
            pathName = path.join('.');
        }
        var index = this.validateformControlPathMap.has(pathName);
        if (!index) {
            return {};
        }
        else {
            var result = ValidatorFactory.executeValidator(this[this.validateformControlPathMap.get(pathName)]['validatorFn'], this[this.validateformControlPathMap.get(pathName)]['value']);
            this[this.validateformControlPathMap.get(pathName)]['validationResult'] = result;
            this.changes.next({ type: 'validateFieldsFinished', value: this.validateformControlPathMap.get(pathName) });
            return result;
        }
    };
    /**
     * 清除一组字段验证状态
     * @param fields 字段的数组
     */
    Form.prototype.resetFieldsValidate = function (fields) {
        var _this = this;
        if (this.validateformControls.length === 0) {
            return true;
        }
        else {
            if (fields && fields.length > 0) {
                var sa = new Set(this.validateformControls);
                var sb_1 = new Set(fields);
                // 交集
                var intersect = this.validateformControls.filter(function (x) { return sb_1.has(x); });
                // 遍历清空所有校验结果数据
                intersect.forEach(function (item) {
                    _this[item]['validationResult'] = {};
                });
            }
            else {
                // 没传数据全部清除
                this.validateformControls.forEach(function (item) {
                    _this[item]['validationResult'] = {};
                });
            }
            this.changes.next({ type: 'validateFieldsFinished' });
        }
    };
    /**
     * 创建FormControls
     */
    Form.prototype.createFormControls = function () {
        var _this = this;
        this.formControlConfigs.forEach(function (formControlConfig) {
            var name = formControlConfig.name;
            var formControl = new FormControl(formControlConfig, _this.viewModelContext);
            _this[name] = formControl;
        });
    };
    /**
     * 收集元数据
     */
    Form.prototype.collectMetadatas = function () {
        var _this = this;
        var formControlMetadatas = MetadataUtil.getPropsMetadatasByName(this.constructor, FORM_CONTROL_PROP_META);
        Object.keys(formControlMetadatas).forEach(function (name) {
            var formControlMetadata = formControlMetadatas[name];
            if (formControlMetadata.validRules) {
                _this.validateformControls.push(name);
                _this.validateformControlPathMap.set(formControlMetadata.bindingPath, name);
            }
            var formControlConfig = {
                name: name,
                bindingType: formControlMetadata.bindingType,
                bindingPath: formControlMetadata.bindingPath,
                valueConverter: formControlMetadata.valueConverter,
                valueChanging: formControlMetadata.valueChanging,
                valueChanged: formControlMetadata.valueChanged,
                validRules: formControlMetadata.validRules
            };
            _this.formControlConfigs.push(formControlConfig);
        });
    };
    Form.prototype.getEntityValueChangingListeners = function () {
        var listeners = {};
        this.formControlConfigs.forEach(function (formControl) {
            if (formControl.valueChanging) {
                listeners[formControl.bindingPath] = formControl.valueChanging;
            }
        });
        return listeners;
    };
    Form.prototype.getEntityValueChangedListeners = function () {
        var listeners = {};
        this.formControlConfigs.forEach(function (formControl) {
            if (formControl.valueChanged) {
                listeners[formControl.bindingPath] = formControl.valueChanged;
            }
        });
        return listeners;
    };
    return Form;
}());
export { Form };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9mb3JtL2Zvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU3QyxPQUFPLEVBQXFCLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFBdUIsc0JBQXNCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDM0UsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFFL0M7O0dBRUc7QUFDSDtJQWtCRTs7T0FFRztJQUNILGNBQVksZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxFQUFFLENBQUM7UUFDL0IsSUFBSSxDQUFDLDBCQUEwQixHQUFHLElBQUksR0FBRyxDQUFDO1FBQzFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxtQkFBSSxHQUFYO1FBQ0UsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVEOzs7T0FHRztJQUNILDZCQUFjLEdBQWQ7UUFBQSxpQkFTQztRQVJDLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFBRSxPQUFPLGdCQUFnQixDQUFDO1NBQUU7UUFDeEUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxVQUFDLFdB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QUFFLG1CQUFtQixDQUFDLFVBQVU7YUFDM0MsQ0FBQztZQUNGLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSw4Q0FBK0IsR0FBdEM7UUFDRSxJQUFNLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxVQUFDLFdBQThCO1lBQzdELElBQUksV0FBVyxDQUFDLGFBQWEsRUFBRTtnQkFDN0IsU0FBUyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFDO2FBQ2hFO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRU0sNkNBQThCLEdBQXJDO1FBQ0UsSUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsVUFBQyxXQUE4QjtZQUM3RCxJQUFJLFdBQVcsQ0FBQyxZQUFZLEVBQUU7Z0JBQzVCLFNBQVMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLEdBQUcsV0FBVyxDQUFDLFlBQVksQ0FBQzthQUMvRDtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUNILFdBQUM7QUFBRCxDQUFDLEFBbExELElBa0xDO0FBRUQsT0FBTyxFQUFFLElBQUksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcbmltcG9ydCB7IFZpZXdNb2RlbENvbnRleHQgfSBmcm9tICcuLi92aWV3LW1vZGVsL2luZGV4JztcclxuaW1wb3J0IHsgRm9ybUNvbnRyb2xDb25maWcsIEZvcm1Db250cm9sIH0gZnJvbSAnLi9mb3JtX2NvbnRyb2wnO1xyXG5pbXBvcnQgeyBGb3JtQ29udHJvbE1ldGFkYXRhLCBGT1JNX0NPTlRST0xfUFJPUF9NRVRBIH0gZnJvbSAnLi9kZWNvcmF0b3JzJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBWYWxpZGF0b3JGYWN0b3J5IH0gZnJvbSAnLi4vdmFsaWRhdG9yJ1xyXG5cclxuLyoqXHJcbiAqIEZvcm3mir3osaHnsbtcclxuICovXHJcbmFic3RyYWN0IGNsYXNzIEZvcm0ge1xyXG5cclxuICAvKipcclxuICAgKiDooajljZXmjqfku7bphY3nva5cclxuICAgKi9cclxuICBwcml2YXRlIGZvcm1Db250cm9sQ29uZmlnczogRm9ybUNvbnRyb2xDb25maWdbXTtcclxuXHJcbiAgLyoqXHJcbiAgICogVmlld01vZGVs5LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB2aWV3TW9kZWxDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0O1xyXG5cclxuICBwcml2YXRlIHZhbGlkYXRlZm9ybUNvbnRyb2xzOiBzdHJpbmdbXTtcclxuXHJcbiAgcHJpdmF0ZSB2YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcDogTWFwPHN0cmluZywgc3RyaW5nPjtcclxuXHJcbiAgcHVibGljIGNoYW5nZXM6IFN1YmplY3Q8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3Iodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICAgIHRoaXMuZm9ybUNvbnRyb2xDb25maWdzID0gW107XHJcbiAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzID0gW107XHJcbiAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwID0gbmV3IE1hcDtcclxuICAgIHRoaXMuY2hhbmdlcyA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJ3lp4vljJZcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdCgpIHtcclxuICAgIHRoaXMuY29sbGVjdE1ldGFkYXRhcygpO1xyXG4gICAgdGhpcy5jcmVhdGVGb3JtQ29udHJvbHMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWFqOmDqOagoemqjCBcclxuICAgKiAgZm9ybUNvbnRyb2xDb25maWdzIOS4iuaJgOacieeahGZvcm1Db250cm9s55qE5a2Y5Zyo5pa55rOV6LCD55So5LiA6YGNIOWwhumUmeivr+S/oeaBr+mbhuS4rei/lOWbnlxyXG4gICAqL1xyXG4gIHZhbGlkYXRlRmllbGRzKCkge1xyXG4gICAgbGV0IHZhbGlkYXRpb25SZXN1bHQgPSBbXTtcclxuICAgIGlmICh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmxlbmd0aCA9PT0gMCkgeyByZXR1cm4gdmFsaWRhdGlvblJlc3VsdDsgfVxyXG4gICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5mb3JFYWNoKChmb3JtQ29udHJvbCkgPT4ge1xyXG4gICAgICB0aGlzW2Zvcm1Db250cm9sXVsndmFsaWRhdGlvblJlc3VsdCddID0gVmFsaWRhdG9yRmFjdG9yeS5leGVjdXRlVmFsaWRhdG9yKHRoaXNbZm9ybUNvbnRyb2xdWyd2YWxpZGF0b3JGbiddLCB0aGlzW2Zvcm1Db250cm9sXVsndmFsdWUnXSk7XHJcbiAgICAgICF0aGlzW2Zvcm1Db250cm9sXVsndmFsaWRhdGlvblJlc3VsdCddLnBhc3NpbmcgJiYgdmFsaWRhdGlvblJlc3VsdC5wdXNoKHRoaXNbZm9ybUNvbnRyb2xdKVxyXG4gICAgfSk7XHJcbiAgICB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJyB9KVxyXG4gICAgcmV0dXJuIHZhbGlkYXRpb25SZXN1bHQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmn5DkuIDkuKrlvpfmoKHpqozplJnor6/kv6Hmga9cclxuICAgKiBAcGFyYW0gbmFtZSDlsZ7mgKflkI3np7BcclxuICAgKi9cclxuICBnZXRGaWVsZEVycm9yKG5hbWU6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiB7fVxyXG4gICAgfVxyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmZpbmRJbmRleCgoaXRlbSkgPT4ge1xyXG4gICAgICByZXR1cm4gaXRlbSA9PT0gbmFtZVxyXG4gICAgfSk7XHJcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XHJcbiAgICAgIHJldHVybiB7fVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gVmFsaWRhdG9yRmFjdG9yeS5leGVjdXRlVmFsaWRhdG9yKHRoaXNbbmFtZV1bJ3ZhbGlkYXRvckZuJ10sIHRoaXNbbmFtZV1bJ3ZhbHVlJ10pO1xyXG4gICAgICB0aGlzW25hbWVdWyd2YWxpZGF0aW9uUmVzdWx0J10gPSByZXN1bHQ7XHJcbiAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KHsgdHlwZTogJ3ZhbGlkYXRlRmllbGRzRmluaXNoZWQnLCB2YWx1ZTogbmFtZSB9KTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gKiDmoLnmja5mb3Jt5YWD5pWw5o2u5Lit55qEcGF0aOiOt+WPluafkOS4gOS4quW+l+agoemqjOmUmeivr+S/oeaBr1xyXG4gKiBAcGFyYW0gcGF0aCDlsZ7mgKflkI3np7DmlbDnu4RcclxuICovXHJcbiAgZ2V0RmllbGRFcnJvckJ5UGF0aChwYXRoOiBzdHJpbmdbXSkge1xyXG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiB7fVxyXG4gICAgfVxyXG4gICAgbGV0IHBhdGhOYW1lID0gcGF0aFswXVxyXG4gICAgaWYgKHBhdGggJiYgcGF0aC5sZW5ndGggPj0gMikge1xyXG4gICAgICBwYXRoTmFtZSA9IHBhdGguam9pbignLicpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLmhhcyhwYXRoTmFtZSk7XHJcbiAgICBpZiAoIWluZGV4KSB7XHJcbiAgICAgIHJldHVybiB7fVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgcmVzdWx0ID0gVmFsaWRhdG9yRmFjdG9yeS5leGVjdXRlVmFsaWRhdG9yKHRoaXNbdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5nZXQocGF0aE5hbWUpXVsndmFsaWRhdG9yRm4nXSwgdGhpc1t0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLmdldChwYXRoTmFtZSldWyd2YWx1ZSddKTtcclxuICAgICAgdGhpc1t0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xQYXRoTWFwLmdldChwYXRoTmFtZSldWyd2YWxpZGF0aW9uUmVzdWx0J10gPSByZXN1bHQ7XHJcbiAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KHsgdHlwZTogJ3ZhbGlkYXRlRmllbGRzRmluaXNoZWQnLCB2YWx1ZTogdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5nZXQocGF0aE5hbWUpIH0pO1xyXG4gICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF6Zmk5LiA57uE5a2X5q616aqM6K+B54q25oCBXHJcbiAgICogQHBhcmFtIGZpZWxkcyDlrZfmrrXnmoTmlbDnu4RcclxuICAgKi9cclxuICByZXNldEZpZWxkc1ZhbGlkYXRlKGZpZWxkcz86IHN0cmluZ1tdKSB7XHJcbiAgICBpZiAodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoZmllbGRzICYmIGZpZWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgY29uc3Qgc2EgPSBuZXcgU2V0KHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMpO1xyXG4gICAgICAgIGNvbnN0IHNiID0gbmV3IFNldChmaWVsZHMpO1xyXG4gICAgICAgIC8vIOS6pOmbhlxyXG4gICAgICAgIGNvbnN0IGludGVyc2VjdCA9IHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMuZmlsdGVyKHggPT4gc2IuaGFzKHgpKTtcclxuICAgICAgICAvLyDpgY3ljobmuIXnqbrmiYDmnInmoKHpqoznu5PmnpzmlbDmja5cclxuICAgICAgICBpbnRlcnNlY3QuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgIHRoaXNbaXRlbV1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IHt9O1xyXG4gICAgICAgIH0pXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g5rKh5Lyg5pWw5o2u5YWo6YOo5riF6ZmkXHJcbiAgICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgdGhpc1tpdGVtXVsndmFsaWRhdGlvblJlc3VsdCddID0ge307XHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJyB9KVxyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7ukZvcm1Db250cm9sc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlRm9ybUNvbnRyb2xzKCkge1xyXG4gICAgdGhpcy5mb3JtQ29udHJvbENvbmZpZ3MuZm9yRWFjaCgoZm9ybUNvbnRyb2xDb25maWc6IEZvcm1Db250cm9sQ29uZmlnKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5hbWUgPSBmb3JtQ29udHJvbENvbmZpZy5uYW1lO1xyXG4gICAgICBjb25zdCBmb3JtQ29udHJvbCA9IG5ldyBGb3JtQ29udHJvbChmb3JtQ29udHJvbENvbmZpZywgdGhpcy52aWV3TW9kZWxDb250ZXh0KTtcclxuICAgICAgdGhpc1tuYW1lXSA9IGZvcm1Db250cm9sO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmlLbpm4blhYPmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGNvbGxlY3RNZXRhZGF0YXMoKSB7XHJcbiAgICBjb25zdCBmb3JtQ29udHJvbE1ldGFkYXRhcyA9IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0aGlzLmNvbnN0cnVjdG9yLCBGT1JNX0NPTlRST0xfUFJPUF9NRVRBKTtcclxuICAgIE9iamVjdC5rZXlzKGZvcm1Db250cm9sTWV0YWRhdGFzKS5mb3JFYWNoKChuYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgZm9ybUNvbnRyb2xNZXRhZGF0YSA9IGZvcm1Db250cm9sTWV0YWRhdGFzW25hbWVdIGFzIEZvcm1Db250cm9sTWV0YWRhdGE7XHJcbiAgICAgIGlmIChmb3JtQ29udHJvbE1ldGFkYXRhLnZhbGlkUnVsZXMpIHtcclxuICAgICAgICB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLnB1c2gobmFtZSk7XHJcbiAgICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5zZXQoZm9ybUNvbnRyb2xNZXRhZGF0YS5iaW5kaW5nUGF0aCwgbmFtZSk7XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgZm9ybUNvbnRyb2xDb25maWc6IEZvcm1Db250cm9sQ29uZmlnID0ge1xyXG4gICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgYmluZGluZ1R5cGU6IGZvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1R5cGUsXHJcbiAgICAgICAgYmluZGluZ1BhdGg6IGZvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1BhdGgsXHJcbiAgICAgICAgdmFsdWVDb252ZXJ0ZXI6IGZvcm1Db250cm9sTWV0YWRhdGEudmFsdWVDb252ZXJ0ZXIsXHJcbiAgICAgICAgdmFsdWVDaGFuZ2luZzogZm9ybUNvbnRyb2xNZXRhZGF0YS52YWx1ZUNoYW5naW5nLFxyXG4gICAgICAgIHZhbHVlQ2hhbmdlZDogZm9ybUNvbnRyb2xNZXRhZGF0YS52YWx1ZUNoYW5nZWQsXHJcbiAgICAgICAgdmFsaWRSdWxlczogZm9ybUNvbnRyb2xNZXRhZGF0YS52YWxpZFJ1bGVzXHJcbiAgICAgIH07XHJcbiAgICAgIHRoaXMuZm9ybUNvbnRyb2xDb25maWdzLnB1c2goZm9ybUNvbnRyb2xDb25maWcpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0RW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVycygpOiB7IFtwcm9wZXJ0eTogc3RyaW5nXTogc3RyaW5nIH0ge1xyXG4gICAgY29uc3QgbGlzdGVuZXJzID0ge307XHJcbiAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncy5mb3JFYWNoKChmb3JtQ29udHJvbDogRm9ybUNvbnRyb2xDb25maWcpID0+IHtcclxuICAgICAgaWYgKGZvcm1Db250cm9sLnZhbHVlQ2hhbmdpbmcpIHtcclxuICAgICAgICBsaXN0ZW5lcnNbZm9ybUNvbnRyb2wuYmluZGluZ1BhdGhdID0gZm9ybUNvbnRyb2wudmFsdWVDaGFuZ2luZztcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gbGlzdGVuZXJzO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldEVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVycygpOiB7IFtwcm9wZXJ0eTogc3RyaW5nXTogc3RyaW5nIH0ge1xyXG4gICAgY29uc3QgbGlzdGVuZXJzID0ge307XHJcbiAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncy5mb3JFYWNoKChmb3JtQ29udHJvbDogRm9ybUNvbnRyb2xDb25maWcpID0+IHtcclxuICAgICAgaWYgKGZvcm1Db250cm9sLnZhbHVlQ2hhbmdlZCkge1xyXG4gICAgICAgIGxpc3RlbmVyc1tmb3JtQ29udHJvbC5iaW5kaW5nUGF0aF0gPSBmb3JtQ29udHJvbC52YWx1ZUNoYW5nZWQ7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGxpc3RlbmVycztcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEZvcm0gfTtcclxuIl19