import { Directive, Injector, Input } from "@angular/core";
import { ChangeType, FrameContext, VariableParseService } from "@farris/devkit";
import { PortletComponent } from '@gspwidget/portlet';
import { Subject } from "rxjs";
import { filter } from "rxjs/operators";
import { ExpressionType } from "./types";
var DATA_PATTERN = /\{:?DATA~(\S+?)\}/;
var DATA_PATTERN_GLOBAL = new RegExp(DATA_PATTERN, 'g');
var UI_STATE_PATTERN = /\{:?UISTATE~(\S+?)\}/;
var UI_STATE_PATTERN_GLOBAL = new RegExp(UI_STATE_PATTERN, 'g');
var PortletFilterBindingDirective = /** @class */ (function () {
    function PortletFilterBindingDirective(injector, portletComponent, frameContext, variableParseService) {
        this.injector = injector;
        this.portletComponent = portletComponent;
        this.frameContext = frameContext;
        this.variableParseService = variableParseService;
        this.subject = new Subject();
        this.FilterFieldKey = 'dpId';
        this.FilterValueKey = 'value';
    }
    Object.defineProperty(PortletFilterBindingDirective.prototype, "changes", {
        get: function () {
            return this.subject;
        },
        enumerable: true,
        configurable: true
    });
    PortletFilterBindingDirective.prototype.ngOnInit = function () {
        var _this = this;
        // 监听数据变化，执行第一次的绑定
        this.frameContext.bindingData.changes.pipe(filter(function (change) {
            return (change.type === ChangeType.Load || change.type === ChangeType.Remove || change.type === ChangeType.Update || change.type === ChangeType.SelectionChanged) && (!change.path || change.path.length < 1);
        })).subscribe(function (change) {
            _this.filter();
        });
        this.changes.subscribe(function () {
            _this.filter();
        });
        this.observeChanges();
    };
    PortletFilterBindingDirective.prototype.filter = function () {
        var filters = this.buildFilters();
        this.portletComponent.widget.handleFilterChange(filters);
    };
    PortletFilterBindingDirective.prototype.deserializeFilter = function () {
        if (!this.filters) {
            return [];
        }
        var filters = [];
        if (typeof this.filters === 'string') {
            filters = JSON.parse(this.filters);
        }
        else if (Array.isArray(this.filters)) {
            filters = this.filters;
        }
        else {
            console.error('invalid filters');
        }
        return filters;
    };
    /**
     * 将表单配置的过滤条件转换为小部件支持的过滤条件
     * @returns
     */
    PortletFilterBindingDirective.prototype.buildFilters = function () {
        var _this = this;
        var filters = this.deserializeFilter();
        var result = [];
        if (!filters || filters.length < 1) {
            return result;
        }
        filters.forEach(function (filter) {
            result.push({
                dpId: filter[_this.FilterFieldKey],
                value: _this.variableParseService.parse(filter[_this.FilterValueKey], _this.frameContext)
            });
        });
        return result;
    };
    PortletFilterBindingDirective.prototype.collectDependencies = function (expression) {
        var bindingDataDependencies = this.getBindingDataDependencies(expression);
        var uistateDependencies = this.getUIstateDependencies(expression);
        return bindingDataDependencies.concat(uistateDependencies);
    };
    PortletFilterBindingDirective.prototype.getBindingDataDependencies = function (expression) {
        var matchs = expression.match(DATA_PATTERN_GLOBAL);
        return this.buildDependencies(matchs, DATA_PATTERN, ExpressionType.BindingData);
    };
    PortletFilterBindingDirective.prototype.getUIstateDependencies = function (expression) {
        var matchs = expression.match(UI_STATE_PATTERN_GLOBAL);
        return this.buildDependencies(matchs, UI_STATE_PATTERN, ExpressionType.UIState);
    };
    PortletFilterBindingDirective.prototype.buildDependencies = function (expressions, expr, expressionType) {
        var _this = this;
        var dependencies = [];
        expressions && expressions.forEach(function (expression) {
            var pathMatches = expression.match(expr);
            var dependency = _this.buildDependency(pathMatches, expressionType);
            dependencies.push(dependency);
        });
        return dependencies;
    };
    PortletFilterBindingDirective.prototype.buildDependency = function (matchs, expressionType) {
        if (matchs && matchs.length === 2) {
            var exps = matchs[1].split('/').filter(function (p) { return p; });
            var frameId = exps.shift();
            var paths = exps;
            var dependency = {
                type: expressionType,
                frameId: frameId,
                paths: paths
            };
            return dependency;
        }
    };
    PortletFilterBindingDirective.prototype.getFrameContext = function (frameId) {
        frameId = this.frameContext.getFrameId(frameId);
        return this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
    };
    PortletFilterBindingDirective.prototype.observeChanges = function () {
        var _this = this;
        var filters = this.deserializeFilter();
        filters && filters.forEach(function (filter) {
            var dependencies = _this.collectDependencies(filter[_this.FilterValueKey]);
            if (dependencies && dependencies.length > 0) {
                dependencies.forEach(function (dep) {
                    var frameContext = _this.getFrameContext(dep.frameId);
                    if (dep.type === ExpressionType.BindingData) {
                        _this.observeBindingDataChange(frameContext, dep.paths);
                    }
                    else if (dep.type === ExpressionType.UIState) {
                        _this.observeUIStateChange(frameContext, dep.paths.pop());
                    }
                });
            }
        });
    };
    PortletFilterBindingDirective.prototype.observeUIStateChange = function (frameContext, path) {
        var _this = this;
        frameContext.uiState.changes.subscribe(function (change) {
            if (change.field === path) {
                _this.subject.next();
            }
        });
    };
    PortletFilterBindingDirective.prototype.observeBindingDataChange = function (frameContext, paths) {
        var _this = this;
        frameContext.bindingData.changes.pipe(
        // 只监听主表变化
        filter(function (change) { return change.type === ChangeType.ValueChanged; })).subscribe(function (change) {
            if (change.path.join('/') === paths.join('/')) {
                _this.subject.next();
            }
        });
    };
    PortletFilterBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: "[portlet-filter-binding]"
                },] }
    ];
    /** @nocollapse */
    PortletFilterBindingDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: PortletComponent },
        { type: FrameContext },
        { type: VariableParseService }
    ]; };
    PortletFilterBindingDirective.propDecorators = {
        filters: [{ type: Input, args: ["portlet-filter-binding",] }]
    };
    return PortletFilterBindingDirective;
}());
export { PortletFilterBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydGxldC1maWx0ZXItYmluZGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9wb3J0bGV0L3BvcnRsZXQtZmlsdGVyLWJpbmRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNuRSxPQUFPLEVBQVUsVUFBVSxFQUFFLFlBQVksRUFBeUMsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvSCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN0RCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsY0FBYyxFQUFxQixNQUFNLFNBQVMsQ0FBQztBQUU1RCxJQUFNLFlBQVksR0FBRyxtQkFBbUIsQ0FBQztBQUN6QyxJQUFNLG1CQUFtQixHQUFHLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztBQUMxRCxJQUFNLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDO0FBQ2hELElBQU0sdUJBQXVCLEdBQUcsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFFbEU7SUFhRSx1Q0FBb0IsUUFBa0IsRUFBVSxnQkFBa0MsRUFBVSxZQUEwQixFQUFVLG9CQUEwQztRQUF0SixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQVRsSyxZQUFPLEdBQWlCLElBQUksT0FBTyxFQUFPLENBQUM7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LENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ3JCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOztnQkFySUYsU0FBUyxTQUFDO29CQUNULFFBQVEsRUFBRSwwQkFBMEI7aUJBQ3JDOzs7O2dCQWRtQixRQUFRO2dCQUVuQixnQkFBZ0I7Z0JBREksWUFBWTtnQkFBeUMsb0JBQW9COzs7MEJBc0JuRyxLQUFLLFNBQUMsd0JBQXdCOztJQTJIakMsb0NBQUM7Q0FBQSxBQXRJRCxJQXNJQztTQW5JWSw2QkFBNkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEluamVjdG9yLCBJbnB1dCwgT25Jbml0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQ2hhbmdlLCBDaGFuZ2VUeXBlLCBGcmFtZUNvbnRleHQsIFVJU3RhdGVDaGFuZ2UsIFVJU3RhdGVPYnNlcnZhYmxlUGFyYW0sIFZhcmlhYmxlUGFyc2VTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcbmltcG9ydCB7IFBvcnRsZXRDb21wb25lbnQgfSBmcm9tICdAZ3Nwd2lkZ2V0L3BvcnRsZXQnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25UeXBlLCBJRmlsdGVyRGVwZW5kZW5jeSB9IGZyb20gXCIuL3R5cGVzXCI7XHJcblxyXG5jb25zdCBEQVRBX1BBVFRFUk4gPSAvXFx7Oj9EQVRBfihcXFMrPylcXH0vO1xyXG5jb25zdCBEQVRBX1BBVFRFUk5fR0xPQkFMID0gbmV3IFJlZ0V4cChEQVRBX1BBVFRFUk4sICdnJyk7XHJcbmNvbnN0IFVJX1NUQVRFX1BBVFRFUk4gPSAvXFx7Oj9VSVNUQVRFfihcXFMrPylcXH0vO1xyXG5jb25zdCBVSV9TVEFURV9QQVRURVJOX0dMT0JBTCA9IG5ldyBSZWdFeHAoVUlfU1RBVEVfUEFUVEVSTiwgJ2cnKTtcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiBcIltwb3J0bGV0LWZpbHRlci1iaW5kaW5nXVwiXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb3J0bGV0RmlsdGVyQmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgcHJpdmF0ZSBzdWJqZWN0OiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBGaWx0ZXJGaWVsZEtleSA9ICdkcElkJztcclxuICBwcml2YXRlIHJlYWRvbmx5IEZpbHRlclZhbHVlS2V5ID0gJ3ZhbHVlJztcclxuXHJcbiAgcHJpdmF0ZSBnZXQgY2hhbmdlcygpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc3ViamVjdDtcclxuICB9XHJcbiAgQElucHV0KFwicG9ydGxldC1maWx0ZXItYmluZGluZ1wiKSBmaWx0ZXJzOiBzdHJpbmcgfCBhbnlbXTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgcG9ydGxldENvbXBvbmVudDogUG9ydGxldENvbXBvbmVudCwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSB2YXJpYWJsZVBhcnNlU2VydmljZTogVmFyaWFibGVQYXJzZVNlcnZpY2UpIHsgfVxyXG4gIHB1YmxpYyBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIC8vIOebkeWQrOaVsOaNruWPmOWMlu+8jOaJp+ihjOesrOS4gOasoeeahOe7keWumlxyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5waXBlKGZpbHRlcigoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgcmV0dXJuIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5VcGRhdGUgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCkgJiYgKCFjaGFuZ2UucGF0aCB8fCBjaGFuZ2UucGF0aC5sZW5ndGggPCAxKTtcclxuICAgIH0pKS5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIHRoaXMuZmlsdGVyKCk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMuY2hhbmdlcy5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLmZpbHRlcigpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLm9ic2VydmVDaGFuZ2VzKCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZmlsdGVyKCkge1xyXG4gICAgY29uc3QgZmlsdGVycyA9IHRoaXMuYnVpbGRGaWx0ZXJzKCk7XHJcbiAgICB0aGlzLnBvcnRsZXRDb21wb25lbnQud2lkZ2V0LmhhbmRsZUZpbHRlckNoYW5nZShmaWx0ZXJzKTtcclxuICB9XHJcbiAgcHVibGljIGRlc2VyaWFsaXplRmlsdGVyKCkge1xyXG4gICAgaWYgKCF0aGlzLmZpbHRlcnMpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgbGV0IGZpbHRlcnMgPSBbXTtcclxuICAgIGlmICh0eXBlb2YgdGhpcy5maWx0ZXJzID09PSAnc3RyaW5nJykge1xyXG4gICAgICBmaWx0ZXJzID0gSlNPTi5wYXJzZSh0aGlzLmZpbHRlcnMpO1xyXG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHRoaXMuZmlsdGVycykpIHtcclxuICAgICAgZmlsdGVycyA9IHRoaXMuZmlsdGVycztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2ludmFsaWQgZmlsdGVycycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZpbHRlcnM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWwhuihqOWNlemFjee9rueahOi/h+a7pOadoeS7tui9rOaNouS4uuWwj+mDqOS7tuaUr+aMgeeahOi/h+a7pOadoeS7tlxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRGaWx0ZXJzKCk6IGFueVtdIHtcclxuICAgIGNvbnN0IGZpbHRlcnMgPSB0aGlzLmRlc2VyaWFsaXplRmlsdGVyKCk7XHJcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgIGlmICghZmlsdGVycyB8fCBmaWx0ZXJzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIGZpbHRlcnMuZm9yRWFjaChmaWx0ZXIgPT4ge1xyXG4gICAgICByZXN1bHQucHVzaCh7XHJcbiAgICAgICAgZHBJZDogZmlsdGVyW3RoaXMuRmlsdGVyRmllbGRLZXldLFxyXG4gICAgICAgIHZhbHVlOiB0aGlzLnZhcmlhYmxlUGFyc2VTZXJ2aWNlLnBhcnNlKGZpbHRlclt0aGlzLkZpbHRlclZhbHVlS2V5XSwgdGhpcy5mcmFtZUNvbnRleHQpXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICBwcml2YXRlIGNvbGxlY3REZXBlbmRlbmNpZXMoZXhwcmVzc2lvbjogc3RyaW5nKTogSUZpbHRlckRlcGVuZGVuY3lbXSB7XHJcbiAgICBjb25zdCBiaW5kaW5nRGF0YURlcGVuZGVuY2llcyA9IHRoaXMuZ2V0QmluZGluZ0RhdGFEZXBlbmRlbmNpZXMoZXhwcmVzc2lvbik7XHJcbiAgICBjb25zdCB1aXN0YXRlRGVwZW5kZW5jaWVzID0gdGhpcy5nZXRVSXN0YXRlRGVwZW5kZW5jaWVzKGV4cHJlc3Npb24pO1xyXG4gICAgcmV0dXJuIGJpbmRpbmdEYXRhRGVwZW5kZW5jaWVzLmNvbmNhdCh1aXN0YXRlRGVwZW5kZW5jaWVzKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nRGF0YURlcGVuZGVuY2llcyhleHByZXNzaW9uOiBzdHJpbmcpOiBJRmlsdGVyRGVwZW5kZW5jeVtdIHtcclxuICAgIGNvbnN0IG1hdGNocyA9IGV4cHJlc3Npb24ubWF0Y2goREFUQV9QQVRURVJOX0dMT0JBTCk7XHJcbiAgICByZXR1cm4gdGhpcy5idWlsZERlcGVuZGVuY2llcyhtYXRjaHMsIERBVEFfUEFUVEVSTiwgRXhwcmVzc2lvblR5cGUuQmluZGluZ0RhdGEpO1xyXG4gIH1cclxuICBwcml2YXRlIGdldFVJc3RhdGVEZXBlbmRlbmNpZXMoZXhwcmVzc2lvbjogc3RyaW5nKTogSUZpbHRlckRlcGVuZGVuY3lbXSB7XHJcbiAgICBjb25zdCBtYXRjaHMgPSBleHByZXNzaW9uLm1hdGNoKFVJX1NUQVRFX1BBVFRFUk5fR0xPQkFMKTtcclxuICAgIHJldHVybiB0aGlzLmJ1aWxkRGVwZW5kZW5jaWVzKG1hdGNocywgVUlfU1RBVEVfUEFUVEVSTiwgRXhwcmVzc2lvblR5cGUuVUlTdGF0ZSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGREZXBlbmRlbmNpZXMoZXhwcmVzc2lvbnM6IFJlZ0V4cE1hdGNoQXJyYXksIGV4cHI6IFJlZ0V4cCwgZXhwcmVzc2lvblR5cGU6IEV4cHJlc3Npb25UeXBlKSB7XHJcbiAgICBjb25zdCBkZXBlbmRlbmNpZXM6IElGaWx0ZXJEZXBlbmRlbmN5W10gPSBbXTtcclxuICAgIGV4cHJlc3Npb25zICYmIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb246IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBwYXRoTWF0Y2hlcyA9IGV4cHJlc3Npb24ubWF0Y2goZXhwcik7XHJcbiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSB0aGlzLmJ1aWxkRGVwZW5kZW5jeShwYXRoTWF0Y2hlcywgZXhwcmVzc2lvblR5cGUpO1xyXG4gICAgICBkZXBlbmRlbmNpZXMucHVzaChkZXBlbmRlbmN5KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGRlcGVuZGVuY2llcztcclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZERlcGVuZGVuY3kobWF0Y2hzOiBSZWdFeHBNYXRjaEFycmF5LCBleHByZXNzaW9uVHlwZTogRXhwcmVzc2lvblR5cGUpIHtcclxuICAgIGlmIChtYXRjaHMgJiYgbWF0Y2hzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICBjb25zdCBleHBzID0gbWF0Y2hzWzFdLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIGNvbnN0IGZyYW1lSWQgPSBleHBzLnNoaWZ0KCk7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gZXhwcztcclxuICAgICAgY29uc3QgZGVwZW5kZW5jeTogSUZpbHRlckRlcGVuZGVuY3kgPSB7XHJcbiAgICAgICAgdHlwZTogZXhwcmVzc2lvblR5cGUsXHJcbiAgICAgICAgZnJhbWVJZCxcclxuICAgICAgICBwYXRoc1xyXG4gICAgICB9O1xyXG4gICAgICByZXR1cm4gZGVwZW5kZW5jeTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHQoZnJhbWVJZDogc3RyaW5nKSB7XHJcbiAgICBmcmFtZUlkID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0RnJhbWVJZChmcmFtZUlkKTtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBvYnNlcnZlQ2hhbmdlcygpIHtcclxuICAgIGNvbnN0IGZpbHRlcnMgPSB0aGlzLmRlc2VyaWFsaXplRmlsdGVyKCk7XHJcbiAgICBmaWx0ZXJzICYmIGZpbHRlcnMuZm9yRWFjaCgoZmlsdGVyOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgZGVwZW5kZW5jaWVzID0gdGhpcy5jb2xsZWN0RGVwZW5kZW5jaWVzKGZpbHRlclt0aGlzLkZpbHRlclZhbHVlS2V5XSk7XHJcbiAgICAgIGlmIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBkZXBlbmRlbmNpZXMuZm9yRWFjaCgoZGVwOiBJRmlsdGVyRGVwZW5kZW5jeSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoZGVwLmZyYW1lSWQpO1xyXG4gICAgICAgICAgaWYgKGRlcC50eXBlID09PSBFeHByZXNzaW9uVHlwZS5CaW5kaW5nRGF0YSkge1xyXG4gICAgICAgICAgICB0aGlzLm9ic2VydmVCaW5kaW5nRGF0YUNoYW5nZShmcmFtZUNvbnRleHQsIGRlcC5wYXRocyk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGRlcC50eXBlID09PSBFeHByZXNzaW9uVHlwZS5VSVN0YXRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMub2JzZXJ2ZVVJU3RhdGVDaGFuZ2UoZnJhbWVDb250ZXh0LCBkZXAucGF0aHMucG9wKCkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIG9ic2VydmVVSVN0YXRlQ2hhbmdlKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwYXRoOiBzdHJpbmcpIHtcclxuICAgIGZyYW1lQ29udGV4dC51aVN0YXRlLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IFVJU3RhdGVPYnNlcnZhYmxlUGFyYW0pID0+IHtcclxuICAgICAgaWYgKGNoYW5nZS5maWVsZCA9PT0gcGF0aCkge1xyXG4gICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIG9ic2VydmVCaW5kaW5nRGF0YUNoYW5nZShmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcGF0aHM6IHN0cmluZ1tdKSB7XHJcbiAgICBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5waXBlKFxyXG4gICAgICAvLyDlj6rnm5HlkKzkuLvooajlj5jljJZcclxuICAgICAgZmlsdGVyKChjaGFuZ2U6IENoYW5nZSkgPT4gY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkKVxyXG4gICAgKS5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2UucGF0aC5qb2luKCcvJykgPT09IHBhdGhzLmpvaW4oJy8nKSkge1xyXG4gICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufSJdfQ==