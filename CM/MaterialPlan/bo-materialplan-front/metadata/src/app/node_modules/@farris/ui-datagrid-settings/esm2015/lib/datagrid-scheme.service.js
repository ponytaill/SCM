/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, Subject } from "rxjs";
/**
 * 保存方案API
 * @type {?}
 */
const SCHEME_WEBAPI = '/api/runtime/sys/v1.0/querysolution';
/**
 * 获取方案列表API
 * @type {?}
 */
const SCHEME_WEBAPI_QUERY = `${SCHEME_WEBAPI}/belongId/`;
/**
 * 方案列表管理- 设默认、删除 API
 * @type {?}
 */
const SCHEME_WEBAPI_UPDATE = `${SCHEME_WEBAPI}/batch`;
/**
 * 权限验证
 * @type {?}
 */
const SCHEME_WEBAPI_Auth = '/api/runtime/sys/v1.0/querysolution/componentType/Datagrid';
/** @type {?} */
const LANGUAGE_WEBAPI = '/api/runtime/sys/v1.0/loginInfo?infoType=supportedLanguage';
export class DatagridSchemeService {
    constructor() {
        this.restService = null;
        this.state = {};
        this.schemeList$ = new Subject();
    }
    /**
     * @param {?} d
     * @param {?} gridId
     * @return {?}
     */
    update(d, gridId) {
        if (!this.state[gridId]) {
            this.state[gridId] = {};
        }
        this.state[gridId] = Object.assign(this.state[gridId], d);
    }
    /**
     * @param {?} httpSer
     * @return {?}
     */
    setRestService(httpSer) {
        if (httpSer && httpSer['befRepository']) {
            this.restService = httpSer['befRepository']['restService'];
        }
    }
    /**
     * @private
     * @return {?}
     */
    getWebFormKey() {
        /** @type {?} */
        const webformHash = window.location.hash.split('?')[0];
        return webformHash.substring(webformHash.lastIndexOf('/') + 1);
    }
    /**
     * @param {?} gridId
     * @return {?}
     */
    getSchemeKey(gridId) {
        /** @type {?} */
        const formKey = this.getWebFormKey();
        return `${formKey}_DatagridScheme_${gridId}`;
    }
    /**
     * @param {?} gridID
     * @return {?}
     */
    getSchemeList(gridID) {
        /** @type {?} */
        const uri = SCHEME_WEBAPI_QUERY + this.getSchemeKey(gridID);
        if (this.restService) {
            return this.restService.invoke(uri, 'GET', null, null, false);
        }
    }
    /**
     * @param {?} scheme
     * @param {?} gridID
     * @param {?=} isUpdate
     * @return {?}
     */
    saveScheme(scheme, gridID, isUpdate = false) {
        if (this.restService) {
            /** @type {?} */
            const httpMethod = isUpdate ? 'PUT' : 'POST';
            scheme.belongId = this.getSchemeKey(gridID);
            return this.restService.invoke(SCHEME_WEBAPI, httpMethod, null, { body: scheme }, false);
        }
    }
    /**
     * @param {?} param
     * @param {?} gridID
     * @return {?}
     */
    updateScheme(param, gridID) {
        if (!param) {
            return of(false);
        }
        /** @type {?} */
        const belongId = this.getSchemeKey(gridID);
        param.belongId = belongId;
        if (param.belongId) {
            return this.restService.invoke(SCHEME_WEBAPI_UPDATE, 'PUT', null, { body: param }, false);
        }
    }
    /**
     * @param {?} gridId
     * @param {...?} statePro
     * @return {?}
     */
    getStateValue(gridId, ...statePro) {
        /** @type {?} */
        const dgState = this.state[gridId];
        if (dgState) {
            if (statePro && statePro.length) {
                return statePro.reduce((/**
                 * @param {?} r
                 * @param {?} c
                 * @return {?}
                 */
                (r, c) => {
                    return r[c];
                }), dgState);
            }
            return dgState;
        }
        return null;
    }
    /**
     * @private
     * @param {?} gridId
     * @param {?} propertyName
     * @param {?} value
     * @return {?}
     */
    updateStateValue(gridId, propertyName, value) {
        this.update({ [propertyName]: value }, gridId);
    }
    /**
     * @param {?} gridId
     * @param {?} newSchemeList
     * @return {?}
     */
    setSchemeList(gridId, newSchemeList) {
        this.updateStateValue(gridId, 'list', newSchemeList);
        this.schemeList$.next(newSchemeList);
    }
    /**
     * @param {?} gridId
     * @param {?} schemeName
     * @return {?}
     */
    hasSchemeName(gridId, schemeName) {
        /** @type {?} */
        const schemeList = this.getStateValue(gridId, 'list');
        if (!schemeList || !schemeList.length) {
            return false;
        }
        if (typeof schemeName === 'string') {
            return !!schemeList.find((/**
             * @param {?} n
             * @return {?}
             */
            n => n.name === schemeName.trim()));
        }
        else {
            if (typeof schemeName === 'object') {
                /** @type {?} */
                const replayNames = [];
                schemeList.forEach((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    if (n.name) {
                        /** @type {?} */
                        const nameObj = JSON.parse(n.name);
                        // const currentNames = Object.values(nameObj);
                        for (let k in schemeName) {
                            if (nameObj[k] === schemeName[k]) {
                                replayNames.push(k);
                            }
                        }
                    }
                }));
                return replayNames;
            }
        }
    }
    /**
     * @return {?}
     */
    checkAuthority() {
        return this.restService.invoke(SCHEME_WEBAPI_Auth, 'GET', null, null, false);
    }
    /**
     * @return {?}
     */
    getLanguages() {
        if (this.restService) {
            return this.restService.invoke(LANGUAGE_WEBAPI, 'GET', null, null, false);
        }
        else {
            return of([]);
        }
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.state;
    /** @type {?} */
    DatagridSchemeService.prototype.schemeList$;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc2NoZW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLXNldHRpbmdzLyIsInNvdXJjZXMiOlsibGliL2RhdGFncmlkLXNjaGVtZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7Ozs7TUFLekMsYUFBYSxHQUFHLHFDQUFxQzs7Ozs7TUFFckQsbUJBQW1CLEdBQUcsR0FBRyxhQUFhLFlBQVk7Ozs7O01BRWxELG9CQUFvQixHQUFHLEdBQUcsYUFBYSxRQUFROzs7OztNQUUvQyxrQkFBa0IsR0FBRyw0REFBNEQ7O01BRWpGLGVBQWUsR0FBRyw0REFBNEQ7QUFHcEYsTUFBTSxPQUFPLHFCQUFxQjtJQU05QjtRQUxRLGdCQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ25CLFVBQUssR0FBa0IsRUFBRSxDQUFDO1FBRWxDLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUc1QixDQUFDOzs7Ozs7SUFFRCxNQUFNLENBQUMsQ0FBYyxFQUFFLE1BQWM7UUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDM0I7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDOzs7OztJQUVELGNBQWMsQ0FBQyxPQUFZO1FBQ3ZCLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUM5RDtJQUNMLENBQUM7Ozs7O0lBRU8sYUFBYTs7Y0FDWCxXQUFXLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN0RCxPQUFPLFdBQVcsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDOzs7OztJQUVELFlBQVksQ0FBQyxNQUFjOztjQUNqQixPQUFPLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRTtRQUNwQyxPQUFPLEdBQUcsT0FBTyxtQkFBbUIsTUFBTSxFQUFFLENBQUM7SUFDakQsQ0FBQzs7Ozs7SUFFRCxhQUFhLENBQUMsTUFBYzs7Y0FDbEIsR0FBRyxHQUFHLG1CQUFtQixHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO1FBQzNELElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNqRTtJQUNMLENBQUM7Ozs7Ozs7SUFFRCxVQUFVLENBQUMsTUFBMkIsRUFBRSxNQUFjLEVBQUUsUUFBUSxHQUFHLEtBQUs7UUFDcEUsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFOztrQkFDWixVQUFVLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUEsQ0FBQyxDQUFDLE1BQU07WUFDM0MsTUFBTSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzVDLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDM0Y7SUFDTCxDQUFDOzs7Ozs7SUFFRCxZQUFZLENBQUMsS0FBa0IsRUFBRSxNQUFjO1FBQzNDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDUixPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNwQjs7Y0FDSyxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7UUFDMUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUE7UUFFekIsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzRjtJQUNMLENBQUM7Ozs7OztJQUVELGFBQWEsQ0FBQyxNQUFNLEVBQUUsR0FBRyxRQUFROztjQUN2QixPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDbEMsSUFBSSxPQUFPLEVBQUU7WUFDVCxJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFO2dCQUM3QixPQUFPLFFBQVEsQ0FBQyxNQUFNOzs7OztnQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDNUIsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsR0FBRSxPQUFPLENBQUMsQ0FBQTthQUNkO1lBRUQsT0FBTyxPQUFPLENBQUM7U0FDbEI7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzs7Ozs7OztJQUVPLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxZQUFZLEVBQUUsS0FBSztRQUNoRCxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUMsQ0FBQyxZQUFZLENBQUMsRUFBRSxLQUFLLEVBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7Ozs7SUFFRCxhQUFhLENBQUMsTUFBTSxFQUFFLGFBQWE7UUFDL0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDekMsQ0FBQzs7Ozs7O0lBRUQsYUFBYSxDQUFDLE1BQU0sRUFBRSxVQUFlOztjQUMzQixVQUFVLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1FBQ3JELElBQUksQ0FBQyxVQUFVLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFO1lBQ25DLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQsSUFBSSxPQUFPLFVBQVUsS0FBSyxRQUFRLEVBQUU7WUFDaEMsT0FBTyxDQUFDLENBQUMsVUFBVSxDQUFDLElBQUk7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksRUFBRSxFQUFDLENBQUM7U0FDL0Q7YUFBTTtZQUNILElBQUksT0FBTyxVQUFVLEtBQUssUUFBUSxFQUFFOztzQkFDMUIsV0FBVyxHQUFHLEVBQUU7Z0JBQ3RCLFVBQVUsQ0FBQyxPQUFPOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNuQixJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUU7OzhCQUNGLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7d0JBQ2xDLCtDQUErQzt3QkFDL0MsS0FBSSxJQUFJLENBQUMsSUFBSSxVQUFVLEVBQUU7NEJBQ3JCLElBQUksT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQ0FDOUIsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzs2QkFDdkI7eUJBQ0o7cUJBQ0o7Z0JBQ0wsQ0FBQyxFQUFDLENBQUM7Z0JBRUgsT0FBTyxXQUFXLENBQUM7YUFDdEI7U0FDSjtJQUNMLENBQUM7Ozs7SUFFRCxjQUFjO1FBQ1YsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNqRixDQUFDOzs7O0lBRUQsWUFBWTtRQUNSLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM3RTthQUFNO1lBQ0gsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDakI7SUFDTCxDQUFDO0NBQ0o7Ozs7OztJQXhIRyw0Q0FBMkI7Ozs7O0lBQzNCLHNDQUFrQzs7SUFFbEMsNENBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcclxuaW1wb3J0IHsgQmF0Y2hTY2hlbWUsIERhdGFncmlkU2NoZW1lTW9kZWwsIERnU2NoZW1lU3RhdGUsIFNjaGVtZUF1dGhNb2RlbCwgU2NoZW1lU3RhdGUgfSBmcm9tIFwiLi9zZXR0aW5nLm1vZGVsXCI7XHJcblxyXG4vKiog5L+d5a2Y5pa55qGIQVBJICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUEkgPSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL3F1ZXJ5c29sdXRpb24nO1xyXG4vKiog6I635Y+W5pa55qGI5YiX6KGoQVBJICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUElfUVVFUlkgPSBgJHtTQ0hFTUVfV0VCQVBJfS9iZWxvbmdJZC9gO1xyXG4vKiog5pa55qGI5YiX6KGo566h55CGLSDorr7pu5jorqTjgIHliKDpmaQgQVBJICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUElfVVBEQVRFID0gYCR7U0NIRU1FX1dFQkFQSX0vYmF0Y2hgO1xyXG4vKiog5p2D6ZmQ6aqM6K+BICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUElfQXV0aCA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvcXVlcnlzb2x1dGlvbi9jb21wb25lbnRUeXBlL0RhdGFncmlkJztcclxuXHJcbmNvbnN0IExBTkdVQUdFX1dFQkFQSSA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvbG9naW5JbmZvP2luZm9UeXBlPXN1cHBvcnRlZExhbmd1YWdlJztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRTY2hlbWVTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgcmVzdFNlcnZpY2UgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBzdGF0ZTogRGdTY2hlbWVTdGF0ZSA9IHt9O1xyXG5cclxuICAgIHNjaGVtZUxpc3QkID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUoZDogU2NoZW1lU3RhdGUsIGdyaWRJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlW2dyaWRJZF0pIHtcclxuICAgICAgICAgICAgdGhpcy5zdGF0ZVtncmlkSWRdID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3RhdGVbZ3JpZElkXSA9IE9iamVjdC5hc3NpZ24odGhpcy5zdGF0ZVtncmlkSWRdLCBkKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRSZXN0U2VydmljZShodHRwU2VyOiBhbnkpIHtcclxuICAgICAgICBpZiAoaHR0cFNlciAmJiBodHRwU2VyWydiZWZSZXBvc2l0b3J5J10pIHtcclxuICAgICAgICAgICAgdGhpcy5yZXN0U2VydmljZSA9IGh0dHBTZXJbJ2JlZlJlcG9zaXRvcnknXVsncmVzdFNlcnZpY2UnXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRXZWJGb3JtS2V5KCkge1xyXG4gICAgICAgIGNvbnN0IHdlYmZvcm1IYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoJz8nKVswXTtcclxuICAgICAgICByZXR1cm4gd2ViZm9ybUhhc2guc3Vic3RyaW5nKHdlYmZvcm1IYXNoLmxhc3RJbmRleE9mKCcvJykgKyAxKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTY2hlbWVLZXkoZ3JpZElkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBmb3JtS2V5ID0gdGhpcy5nZXRXZWJGb3JtS2V5KCk7XHJcbiAgICAgICAgcmV0dXJuIGAke2Zvcm1LZXl9X0RhdGFncmlkU2NoZW1lXyR7Z3JpZElkfWA7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2NoZW1lTGlzdChncmlkSUQ6IHN0cmluZyk6IE9ic2VydmFibGU8RGF0YWdyaWRTY2hlbWVNb2RlbFtdPiB7XHJcbiAgICAgICAgY29uc3QgdXJpID0gU0NIRU1FX1dFQkFQSV9RVUVSWSArIHRoaXMuZ2V0U2NoZW1lS2V5KGdyaWRJRCk7XHJcbiAgICAgICAgaWYgKHRoaXMucmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKHVyaSwgJ0dFVCcsIG51bGwsIG51bGwsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVNjaGVtZShzY2hlbWU6IERhdGFncmlkU2NoZW1lTW9kZWwsIGdyaWRJRDogc3RyaW5nLCBpc1VwZGF0ZSA9IGZhbHNlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgY29uc3QgaHR0cE1ldGhvZCA9IGlzVXBkYXRlID8gJ1BVVCc6ICdQT1NUJztcclxuICAgICAgICAgICAgc2NoZW1lLmJlbG9uZ0lkID0gdGhpcy5nZXRTY2hlbWVLZXkoZ3JpZElEKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKFNDSEVNRV9XRUJBUEksIGh0dHBNZXRob2QsIG51bGwsIHsgYm9keTogc2NoZW1lfSwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVTY2hlbWUocGFyYW06IEJhdGNoU2NoZW1lLCBncmlkSUQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgaWYgKCFwYXJhbSkge1xyXG4gICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBiZWxvbmdJZCA9IHRoaXMuZ2V0U2NoZW1lS2V5KGdyaWRJRCk7XHJcbiAgICAgICAgcGFyYW0uYmVsb25nSWQgPSBiZWxvbmdJZFxyXG5cclxuICAgICAgICBpZiAocGFyYW0uYmVsb25nSWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKFNDSEVNRV9XRUJBUElfVVBEQVRFLCAnUFVUJywgbnVsbCwge2JvZHk6IHBhcmFtfSwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTdGF0ZVZhbHVlKGdyaWRJZCwgLi4uc3RhdGVQcm8pIHtcclxuICAgICAgICBjb25zdCBkZ1N0YXRlID0gdGhpcy5zdGF0ZVtncmlkSWRdO1xyXG4gICAgICAgIGlmIChkZ1N0YXRlKSB7XHJcbiAgICAgICAgICAgIGlmIChzdGF0ZVBybyAmJiBzdGF0ZVByby5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZVByby5yZWR1Y2UoKHIsIGMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcltjXTtcclxuICAgICAgICAgICAgICAgIH0sIGRnU3RhdGUpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBkZ1N0YXRlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHVwZGF0ZVN0YXRlVmFsdWUoZ3JpZElkLCBwcm9wZXJ0eU5hbWUsIHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGUoe1twcm9wZXJ0eU5hbWVdOiB2YWx1ZX0sIGdyaWRJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0U2NoZW1lTGlzdChncmlkSWQsIG5ld1NjaGVtZUxpc3QpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlVmFsdWUoZ3JpZElkLCAnbGlzdCcsIG5ld1NjaGVtZUxpc3QpO1xyXG4gICAgICAgIHRoaXMuc2NoZW1lTGlzdCQubmV4dChuZXdTY2hlbWVMaXN0KTtcclxuICAgIH1cclxuXHJcbiAgICBoYXNTY2hlbWVOYW1lKGdyaWRJZCwgc2NoZW1lTmFtZTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgc2NoZW1lTGlzdCA9IHRoaXMuZ2V0U3RhdGVWYWx1ZShncmlkSWQsICdsaXN0Jyk7XHJcbiAgICAgICAgaWYgKCFzY2hlbWVMaXN0IHx8ICFzY2hlbWVMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZW9mIHNjaGVtZU5hbWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhIXNjaGVtZUxpc3QuZmluZChuID0+IG4ubmFtZSA9PT0gc2NoZW1lTmFtZS50cmltKCkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1lTmFtZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlcGxheU5hbWVzID0gW107XHJcbiAgICAgICAgICAgICAgICBzY2hlbWVMaXN0LmZvckVhY2gobiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG4ubmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lT2JqID0gSlNPTi5wYXJzZShuLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCBjdXJyZW50TmFtZXMgPSBPYmplY3QudmFsdWVzKG5hbWVPYmopO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gc2NoZW1lTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5hbWVPYmpba10gPT09IHNjaGVtZU5hbWVba10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYXlOYW1lcy5wdXNoKGspO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcGxheU5hbWVzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrQXV0aG9yaXR5KCk6IE9ic2VydmFibGU8U2NoZW1lQXV0aE1vZGVsPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKFNDSEVNRV9XRUJBUElfQXV0aCwgJ0dFVCcsIG51bGwsIG51bGwsIGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRMYW5ndWFnZXMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKExBTkdVQUdFX1dFQkFQSSwgJ0dFVCcsIG51bGwsIG51bGwsIGZhbHNlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gb2YoW10pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=