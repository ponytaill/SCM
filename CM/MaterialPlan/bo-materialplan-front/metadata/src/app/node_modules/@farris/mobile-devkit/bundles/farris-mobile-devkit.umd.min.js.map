{"version":3,"sources":["../../../node_modules/tslib/tslib.es6.js","ng://@farris/mobile-devkit/lib/core/types.ts","ng://@farris/mobile-devkit/lib/core/di/types.ts","ng://@farris/mobile-devkit/lib/core/di/consts.ts","ng://@farris/mobile-devkit/lib/core/di/utils.ts","ng://@farris/mobile-devkit/lib/core/di/injectable_def.ts","ng://@farris/mobile-devkit/lib/core/di/injection_token.ts","ng://@farris/mobile-devkit/lib/core/di/injector.ts","ng://@farris/mobile-devkit/lib/core/di/null_injector.ts","ng://@farris/mobile-devkit/lib/core/di/forward_ref.ts","ng://@farris/mobile-devkit/lib/core/di/static_injector.ts","ng://@farris/mobile-devkit/lib/core/di/injector_creator.ts","ng://@farris/mobile-devkit/lib/core/metadata/decorator.ts","ng://@farris/mobile-devkit/lib/core/metadata/metadata_util.ts","ng://@farris/mobile-devkit/lib/changeset/types.ts","ng://@farris/mobile-devkit/lib/http/types.ts","ng://@farris/mobile-devkit/lib/http/http-util.ts","ng://@farris/mobile-devkit/lib/http/http-client.ts","ng://@farris/mobile-devkit/lib/http/index.ts","ng://@farris/mobile-devkit/lib/changeset/change_set.ts","ng://@farris/mobile-devkit/lib/entity/entity-path/data_path_node.ts","ng://@farris/mobile-devkit/lib/entity/entity-type-info/data_prop_info.ts","ng://@farris/mobile-devkit/lib/entity/entity-path/data_path.ts","ng://@farris/mobile-devkit/lib/entity/metadata/prop_metadata_primitive.ts","ng://@farris/mobile-devkit/lib/utils/string_uitl.ts","ng://@farris/mobile-devkit/lib/utils/number_uitl.ts","ng://@farris/mobile-devkit/lib/utils/bool_util.ts","ng://@farris/mobile-devkit/lib/utils/enum_util.ts","ng://@farris/mobile-devkit/lib/utils/date_util.ts","ng://@farris/mobile-devkit/lib/binding-data/changes.ts","ng://@farris/mobile-devkit/lib/binding-data/binding_property.ts","ng://@farris/mobile-devkit/lib/utils/array_util.ts","ng://@farris/mobile-devkit/lib/utils/object_util.ts","ng://@farris/mobile-devkit/lib/utils/data-path/binding_path_converter.ts","ng://@farris/mobile-devkit/lib/utils/data-path/binding_path_comparer.ts","ng://@farris/mobile-devkit/lib/utils/data-path/binding_path_traverser.ts","ng://@farris/mobile-devkit/lib/binding-data/property_util.ts","ng://@farris/mobile-devkit/lib/binding-data/binding_object.ts","ng://@farris/mobile-devkit/lib/binding-data/binding_list_factory.ts","ng://@farris/mobile-devkit/lib/binding-data/binding_object_factory.ts","ng://@farris/mobile-devkit/lib/binding-data/binding_list.ts","ng://@farris/mobile-devkit/lib/binding-data/entity_util.ts","ng://@farris/mobile-devkit/lib/binding-data/binding_data.ts","ng://@farris/mobile-devkit/lib/binding-data/binding_data_factory.ts","ng://@farris/mobile-devkit/lib/utils/data-path/entity_path_converter.ts","ng://@farris/mobile-devkit/lib/utils/data-path/entity_path_comparer.ts","ng://@farris/mobile-devkit/lib/utils/data-path/form_path_converter.ts","ng://@farris/mobile-devkit/lib/utils/data-path-util.ts","ng://@farris/mobile-devkit/lib/utils/guid.ts","ng://@farris/mobile-devkit/lib/utils/is-observable.ts","ng://@farris/mobile-devkit/lib/entity/metadata/prop_meatadata_object.ts","ng://@farris/mobile-devkit/lib/entity/metadata/prop_metadata_dynamic.ts","ng://@farris/mobile-devkit/lib/entity/metadata/prop_metadata_list.ts","ng://@farris/mobile-devkit/lib/entity/metadata/field_metadata_util.ts","ng://@farris/mobile-devkit/lib/entity/metadata/entity_metadata_util.ts","ng://@farris/mobile-devkit/lib/entity/entity-type-info/data_type_info.ts","ng://@farris/mobile-devkit/lib/entity/entity-path/data_path_creator.ts","ng://@farris/mobile-devkit/lib/entity/types.ts","ng://@farris/mobile-devkit/lib/entity/entity_creator.ts","ng://@farris/mobile-devkit/lib/entity/entity_list.ts","ng://@farris/mobile-devkit/lib/entity/entity_factory.ts","ng://@farris/mobile-devkit/lib/entity/entity.ts","ng://@farris/mobile-devkit/lib/entity/dynamic_entity.ts","ng://@farris/mobile-devkit/lib/repository/entity_collection.ts","ng://@farris/mobile-devkit/lib/repository/entity_manager.ts","ng://@farris/mobile-devkit/lib/repository/pagination_manager.ts","ng://@farris/mobile-devkit/lib/repository/data_change_history.ts","ng://@farris/mobile-devkit/lib/repository/repository.ts","ng://@farris/mobile-devkit/lib/repository/default_repository.ts","ng://@farris/mobile-devkit/lib/command/flow/task_node.ts","ng://@farris/mobile-devkit/lib/form/types.ts","ng://@farris/mobile-devkit/lib/variable/variable_parser.ts","ng://@farris/mobile-devkit/lib/app/types.ts","ng://@farris/mobile-devkit/lib/app/binding_data_manager.ts","ng://@farris/mobile-devkit/lib/app/repository_mananger.ts","ng://@farris/mobile-devkit/lib/app/view_model_contex_manager.ts","ng://@farris/mobile-devkit/lib/context/context.ts","ng://@farris/mobile-devkit/lib/app/app_context.ts","ng://@farris/mobile-devkit/lib/view-model/view_model_context.ts","ng://@farris/mobile-devkit/lib/ui-state/decorators.ts","ng://@farris/mobile-devkit/lib/ui-state/uistate_metadata_util.ts","ng://@farris/mobile-devkit/lib/ui-state/ui_state.ts","ng://@farris/mobile-devkit/lib/state-machine/types.ts","ng://@farris/mobile-devkit/lib/state-machine/metadata/state_metadata.ts","ng://@farris/mobile-devkit/lib/state-machine/metadata/render_state_metadata.ts","ng://@farris/mobile-devkit/lib/state-machine/metadata/action_metadata.ts","ng://@farris/mobile-devkit/lib/state-machine/state_machine_context.ts","ng://@farris/mobile-devkit/lib/state-machine/state_machine_watcher.ts","ng://@farris/mobile-devkit/lib/state-machine/state_machine.ts","ng://@farris/mobile-devkit/lib/form/binding_value_converter.ts","ng://@farris/mobile-devkit/lib/form/binding_value_accessor.ts","ng://@farris/mobile-devkit/lib/form/decorators.ts","ng://@farris/mobile-devkit/lib/validator/validator.ts","ng://@farris/mobile-devkit/lib/form/form_control.ts","ng://@farris/mobile-devkit/lib/form/form.ts","ng://@farris/mobile-devkit/lib/view-model/decorators.ts","ng://@farris/mobile-devkit/lib/view-model/view_model.ts","ng://@farris/mobile-devkit/lib/view-model/types.ts","ng://@farris/mobile-devkit/lib/app/app_eventBus.ts","ng://@farris/mobile-devkit/lib/app/providers.ts","ng://@farris/mobile-devkit/lib/app/app.ts","ng://@farris/mobile-devkit/lib/variable/parse_util.ts","ng://@farris/mobile-devkit/lib/variable/data_variable_parser.ts","ng://@farris/mobile-devkit/lib/variable/ui_state_variable_parser.ts","ng://@farris/mobile-devkit/lib/variable/state_machine_variable_parser.ts","ng://@farris/mobile-devkit/lib/variable/command_variable_parser.ts","ng://@farris/mobile-devkit/lib/variable/variable_parse_service.ts","ng://@farris/mobile-devkit/lib/variable/providers.ts","ng://@farris/mobile-devkit/lib/command/flow/task_link.ts","ng://@farris/mobile-devkit/lib/command/flow/task_flow.ts","ng://@farris/mobile-devkit/lib/command/command_context.ts","ng://@farris/mobile-devkit/lib/command/command_handler.ts","ng://@farris/mobile-devkit/lib/command/command_handler_registry.ts","ng://@farris/mobile-devkit/lib/command/decorators.ts","ng://@farris/mobile-devkit/lib/command/command_handler_extender.ts","ng://@farris/mobile-devkit/lib/command/command_handler_extender_registry.ts","ng://@farris/mobile-devkit/lib/command/command_handler_factory.ts","ng://@farris/mobile-devkit/lib/command/command_bus.ts","ng://@farris/mobile-devkit/lib/command/providers.ts","ng://@farris/mobile-devkit/lib/exception/tokens.ts","ng://@farris/mobile-devkit/lib/repository/decorators.ts"],"names":["extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__extends","__","this","constructor","prototype","create","__assign","assign","t","s","i","n","arguments","length","call","apply","__generator","thisArg","body","f","y","g","_","label","sent","trys","ops","next","verb","throw","return","Symbol","iterator","v","op","TypeError","done","value","pop","push","e","step","__values","o","m","__read","r","ar","error","__spread","concat","DataChangeType","InjectFlags","Type","Function","EMPTY","IDENT","CIRCULAR","MULTI_PROVIDER_FN","slice","NEW_LINE","THROW_IF_NOT_FOUND","stringify","token","isArray","map","join","overriddenName","name","res","toString","newLineIndex","indexOf","substring","getClosureSafeProperty","objWithPropertyToExtract","key","Error","staticError","text","obj","injectorErrorName","source","charAt","substr","context","parts","JSON","replace","formatError","NG_PROV_DEF","ɵprov","NG_INJECTABLE_DEF","ɵinj","ngInjectableDef","getOwnDefinition","type","def","InjectionToken","_desc","options","opts","ngMetadataName","undefined","__NG_ELEMENT_ID__","providedIn","factory","createInjectionToken","Injector","NULL_INJECTOR","NullInjector","get","notFoundValue","__forward_ref__","resolveForwardRef","fn","forwardRef","forwardRefFn","INJECTOR","USE_VALUE","provide","String","useValue","ɵ0","_currentInjector","setCurrentInjector","injector","former","StaticInjector","providers","parent","records","_records","Map","set","deps","useNew","scope","recursivelyProcessProviders","provider","resolvedProvider","resolveProvider","multi","multiProvider","multiProviderMixError","record","INJECTOR_SCOPE","flags","Default","injectableDef","useFactory","lastInjector","tryResolveToken","tokens","forEach","providerDeps","useExisting","computeDeps","useClass","SkipSelf","Self","Optional","NO_NEW_LINE","depRecords","depRecord","childRecord","_a","bind","resolveToken","unshift","INJECTOR_IMPL__PRE_R3__","INJECTOR_IMPL","createInjector","ANNOTATIONS","PARAMETERS","PROP_METADATA","makeDecorator","props","parentClass","chainFn","typeFn","metaCtor","makeMetadataCtor","DecoratorFactory","args","_i","annotationInstance","typeDecorator","cls","defineProperty","annotationCls","values","propName","makePropDecorator","PropDecoratorFactory","decoratorInstance","target","meta","ModifyType","MetadataUtil","getClassMetadatas","getClassMetadataByName","metadataName","getClassMetadataByNameWithTranslate","translateService","keysToTranslate","allClassMetadatas","metadata","find","classMetadata","metadataPropKey","propertyVariable","startsWith","endsWith","translateKey","trim","transform","getPropsMetadatas","getPropsMetadatasByName","getPropsMetadatasByNameWithTranslate","metadatas","allPropMetadatas","keys","propMetadata","getPropMetadatasByName","getPropMetadataByName","HttpMethods","GET","DELETE","HEAD","OPTIONS","POST","PUT","PATCH","LINK","UNLINK","HttpUtil","appendHeader","headers","appendBodyToRequestConfig","requestConfig","buildAxiosRequestConfig","method","url","params","responseType","data","buildHttpResponse","axiosResponse","status","statusText","HttpClient","axiosInstance","axios","request","post","put","patch","delete","_this","of","pipe","switchMap","axiosRequestConfig","from","httpResponse","observe","HTTP_PROVIDERS","Modification","modifyType","path","preValue","isEqual","other","DataPathNodeType","ChangeSet","modifications","append","modification","ValueChange","appendValueChangeModification","Add","appendAddModification","Remove","appendRemoveModification","Load","existedModification","findModifyItemsPath","existedAddModification","findNewAddItemsPath","primaryKey","primaryKeyValue","addModification","filter","addDataItem","fullRemovePath","valueModification","valueChangePath","removeDescendantRemoveModifications","clear","index","parentRemoveModification","parentPathWithId","createRemovePathWithId","descendantPathWithId","isDescendantPath","parentPath","descendantPath","parentPathItem","parentPathItemIndex","DataPropGroup","DataPathNode","prev","DataPath","head","newNode","tailNode","getTail","lastNode","toArray","pathArray","currentNode","clone","newDataPath","curDataNode","DataPropInfo","PrimitivePropMeta","primary","foreign","Boolean","dataField","StringUtil","format","NumberUtil","decimals","precision","decimalPoint","decimal","thousandsSep","thousand","prefix","suffix","prefixType","prefixFunc","sourceData","prec","k","Math","pow","parseFloat","round","toFixed","split","pattern","test","formatedValue","BoolUtil","EnumUtil","targetEnumOption","enumData","enumOption","console","dayjs","locale","ChangeType","ViewChangeType","BindingPropertyType","DateUtil","formatISO","dateOrDateString","isEmptyDateOrDateString","emptyISODateTimeString","dateObj","parse","defaultISOFormat","dateFormat","defaultDisplayFormat","dateShow","dateOperation","option","relativeTime","extend","fromNow","isToday","todayDate","Date","isSame","calendar","Calendar","sameDay","nextDay","lastDay","sameElse","isDate","parseISO","date","isEmptyDate","isEmptyDateString","dateString","dateOrDateString1","dateOrDateString2","dateObj1","dateObj2","compare","compareAsc","currentDate","targetDate","isBefore","isAfter","isBetween","targetDate1","targetDate2","contains","IsBetween","emptyDateTimeString","defaultDateFormat","defaultTimeFormat","ArrayUtil","remove","arr","itemToRemove","indexToRemove","findIndex","item","removeByIndex","splice","ObjectUtil","isPlainObject","getPrototypeOf","proto","BindingPathConverter","toBindingPathArray","bindingPath","part","toBindingPathString","bindingPathArray","BindingPathComparer","srcPath","dstPath","srcPathArray","dstPathArray","every","srcPathItem","srcPathIndex","isParent","childPath","childPathArray","parentPathArray","isAncestor","ancestorPath","descendantPathArray","ancestorPathArray","ancestorPathItem","ancestorPathIndex","BindingPathTraverser","getLeafPathString","getParentPathString","PropertyUtil","getProperties","entityType","properties","ngFieldProperties","FieldMetadataUtil","getNgFields","propertyName","ngFieldProperty","Plain","isPrimaryKey","isForeignKey","enableMultiLangInput","ngObjectProperties","getNgObjects","ngObjectProperty","ngListProperties","getNgList","ngListProperty","List","ngDynamicProperties","getNgDynamic","ngDynamicProperty","Dynamic","getDynamicProperties","dynamicData","getPropertyByName","property","getPrimaryKey","primaryProperty","BindingObject","isShowValidationMsg","controlMap","innerValues","changes","Subject","viewChanges","getValue","setShowValidationMsg","flag","setValue","propertyValue","emitEventToView","emitEventToEntity","errors","invokeOnValueChange","oldPropertyValue","entityChanged","subscribe","result","viewChange","ValueChanged","id","toJSON","langCode","window","localStorage","getItem","list","object","ignoreMultiLangInput","multiLangValueObj","BindingListFactory","bindingProperties","bindingList","BindingList","extendProperties","bindingProperty","currentItem","BindingObjectFactory","createDynamicBindingObject","extendListProperty","extendObjectProperty","extendDynamicObjectProperty","extendPlainProperty","childListProperties","childList","change","childObjectProperties","childObject","attachDynamicObjectProperty","dynamicObject","_paginationInfo","innerList","currentId","sPaginationInfo","PaginationInfoChange","paginationInfo","pageIndex","pageSize","total","totalCount","setPaginationInfo","skip","take","findById","emptyCurrentItem","self","size","load","objects","add","firstId","setCurrentId","lastId","Append","removeByIds","ids","nextCurrentId","getCurrentIdBeforeDeleting","getIndexById","nextIndex","currentIndex","getIdByIndex","emitEvent","emitGlobalEvent","SelectionChanged","GlobalSelectionChanged","getPaginationConfigByPath","defaultValue","paths","config","sortBy","fields","directions","arrFields","arrDirections","orders","sort","item1","item2","props_1","tslib_1.__values","props_1_1","prop","order","includes","EntityUtil","loadEntity","entity","bindingObject","loadEntityList","PARENT_CLASS","setUpEntityPipeline","onValueChanged","primaryKeyPath","parentId","findId","pathData","getPaths","isUdt","isGrid","shift","entityList","loadEntities","items","setUpEntityListPipeline","onListChanged","appendEntities","entities","loadRepository","repository","entityCollection","entityCollectionChange","removeEntities","bindingObjects","createBindingObjects","watchReposiroty","bindingData","pagingInfo","getPropInfo","targetPropName","propType","propEntityType","primaryNgFiledProp","getPrimaryFieldMetadata","isObjectProp","isDynamicProp","appendInitialData","initialData","parentID","BindingData","viewModelContext","viewModel","firePagingChangeEvent","setPagingInfo","pagingInfo_1","setValueChangeInvokerFactory","valueChangeInvokerFactory","init","initByRepository","dataTypeInfo","entityTypeInfo","initByBindingList","parentPaths","clearValue","initValue","propInfo","getPropInfoByPath","metadataInfo","getList","getObject","BindingDataFactory","createFromRepository","BindingPropertyUtil","EntityLoadUtil","createFromEntityManager","entityManager","getEntitiesByPath","createFromExistingBindingData","existingBindingData","EntityPathConverter","toEntityPathArray","bindingPathString","entityPathArray","currentBindingObject","createPrimaryKeyPath","currentBindingList","EntityPathComparer","FormPathConverter","formPahtString","DataPathUtil","convertToBindingPathArray","convertToEntityPathArray","convertToRestUrl","restPathArray","getLeafPath","getParentPath","Guid","guid","isGuid","validator","gen","createEmpty","raw","count","out","random","equals","isEmpty","RegExp","isObservable","observable","Observable","ObjectPropMeta","DynamicPropMeta","ListPropMeta","getNgField","getDataField","ngFieldObj","propMeta","primaryNgField","EntityMetadataUtil","getAllNgProperties","ngPlainProperties","getNgFieldProperties","ngEntityProperties","getNgObjectProperties","getNgDynamicProperties","ngEntityListProperties","getNgListProperties","getPrimaryKeyProperty","primaryKeyProperty","ngProperty","DataTypeInfo","foreignKey","propInfoMap","collectPropInfos","getPropInfos","getPropNames","propNames","getPropInfosByGroup","group","getPropNamesByGroup","getPropInfoByName","has","arrPath","typeInfo","getTypeInfoByPath","getPrimaryKeyPropInfo","getPropMappingByName","mapping","getPropMappingByPath","checkPropGroup","propGroup","addPropInfo","Primitive","DataPathCreator","createByLongPathFromRoot","fullPathArrayOrString","dataPath","fullPathArray","currentNodeInfo","nodeValue","nodeType","DataId","nextNodeValue","getNextPathNodeInfo","parentNodeInfo","parentNodeValue","parentNodeType","parentEntityTypeInfo","nextPathNodeInfo","PropName","nextPropInfo","createByShortPathFromRoot","shortPathArrayOrString","shortPathArray","currentEntityTypeInfo","PARENT_PATH","createEntity","entityData","createEntities","entityListData","EntityFactory","T","EntityList","listChanged","changeSet","asObservable","initEntity","rawData","changeItem","setChanges","appendNew","newEntity","appendEntity","primaryId","primaryValue","entityToRemove","updateIndex","modinfo","Entity","sum","reduce","val","curr","toJson","subChanges","getPropertyName","validErrors","isValidating","newData","valueChanged","initialize","pathObj","handleParent","reverse","loadFields","loadLists","loadObjects","loadDynamicObjects","ngFields","ngObjects","ngDynamics","ngLists","ngDynamic","initializeNormalField","initializeList","initializeObject","initializeDynamic","createPath","primaryFieldMetadata","ngField","getPropValue","newPropValue","oldPropValue","isPropValueChanged","setPropValue","emitValueChange","configurable","ngListMetadata","fieldMetadata","ngObjectMetadata","createEntityFromJsonData","instance","childEntity","modifyInfo","ngDynamicMetadata","originalData","dynamicEntity","ngList","listData","objectData","ngDynamicObjects","loadDynamicData","originDataField","propValue","isEmptyMultiLangPropValue","DynamicEntity","_super","tslib_1.__extends","initializeDynamicField","path_1","dynamicEntity_1","createDynamicEntityFromJsonData","oldValue","parentModification","EntityCollection","innerEntitySet","Set","innerEntityMap","collectionChanged","notifyCollectionChanged","addEntity","verifyEntityToAdd","addEntities","entitiesToAdd","getEntityById","identity","getEntityByPath","rootEntityId","parentNode","currentPath","getEntities","predicate","getAllEntities","removeEntityById","verifyEntityToRemove","removeEntitiesByIds","entitiesToRemove","resetEntities","_b","entityPrimaryKey","entityId","_c","_d","element","original","updatePaginationInfoByPath","pageInfo","setPaginationConfigByPath","match","current","abs","EntityManager","getEntityNodeByPath","entityCollectionOrList","entityNode","pathNode","getPropValueByPath","setPropValueByPath","insertEntityBeforeByPath","fpath","insertEntitiesBeforeByPath","insertEntityAfterByPath","insertEntitiesAfterByPath","appendEntityByPath","childEntityList","subPaths","fid","parentEntity","appendEntitiesByPath","removeEntityByPath","removeEntitiesByPath","clearAllEntityChanges","clearEntityChangesById","clearEntityChangesByIds","checkAllEntityChanges","some","checkEntityChangesById","clearEntityChangesByArray","idArray","PaginationManager","paginationConfig","expandMainEntityConfig","deleteMainEntityConfig","entityName","entityConfig","defaultPageSize","getChilds","objectType","listProperties","itemTypeName","child","childs","DataChangeHistory","history","addChange","dataChange","changeType","addChanges","clearByIds","dataId","ids_1","ids_1_1","isChanged","onAddData","onDeleteData","Repository","dataChangeHistory","reset","buildEntity","buildEntities","setPaginationConfig","paginationManager","pagination","DefaultRepository","BindingType","TaskNode","func","execute","VARIABLE_PARSERS","BindingDataManager","bindingDataMap","getBindingDataMap","getBindingDataByName","regBindingData","ifBindingDataExits","RepositoryManager","repositoryMap","regRepository","getRepositoryMap","getRepositories","getRepositoryByName","ifRepositoryExits","ViewModelContextManager","contextMap","contextSet","regContext","unregContext","getContextMap","getContexts","getContextById","getRootContext","getRootContextAndPosterityById","viewModelId","targetContext","contexts","contextsGroup","RootId","getContextsGroupRoot","Context","getParam","setParam","AppContext","eventBus","repositoryManager","bindingDataManager","viewModelContextManager","regViewModelContext","repositoryName","ViewModelContext","innerViewModel","appContext","regToTree","regToAppContext","parentInjector","root","uiState","stateMachine","form","commandBus","UIStatePropMeta","UIStateMetadataUtil","getUIFields","UIState","innerData","_init","construct","uiFields","initializeUIField","uiFieldMetadata","uiField","stateName","isExistProperty","field","setPropertyValue","State","StatePropMeta","RenderStatePropMeta","ActionMethodMeta","action","StateMachineContext","initialState","state","frameContext","parser","VariableParseService","stateMachineWatcher","transitTo","nextState","states","render","getUIState","expression","getViewModelContext","subscribeUIStateChange","getData","subscribeEntityChange","StateMachineWatcher","uiStatePathList","dataStatePathList","viewModelContextAndUIStatePathsMap","viewModelContextAndDataStatePathsMap","extractPaths","uiStatePath","getStatePath","uiStateChange","dataPathList","isAccordingPath","dataStatePaths","dataStatePath","uiStateVariables","dataVariables","UI_STATE_PATTERN_1","uiStateVariable","pathMatches","DATA_PATTERN_1","dataVariable","StateMachine","renderStates","handlePropMetadatas","stateChange","BehaviorSubject","propsMetadatas","handlePropMetadata","buildState","buildRenderState","buildAction","ngState","renderStateName","ngRenderState","renders","actionName","ngAction","nextStateName","stateRender","DateStringValueConverter","convertFrom","convertTo","ArrayStringValueConverter","arrString","EntityBindingValueAccessor","valueConverter","bindingPathSegments","getBindingPathSegments","stateValue","controlValue","oldStateValue","isDateConverter","parentPathSegments","converter","UIStateBindingValueAccessor","getUiStateBindingPath","search","BindingValueAccessorFactory","bindingType","bindingBindingPath","bindingValueConverter","EntityState","FormControlPropMeta","ValidatorFactory","validRules","validatorFn","validRule","initValidRuleFn","constraints","message","passing","constraintsTemp","message_1","executeValidator","validationResult","FormControl","valueAccessor","Form","formControlConfigs","validateformControls","validateformControlPathMap","collectMetadatas","createFormControls","validateFields","formControl","getFieldError","getFieldErrorByPath","pathName","resetFieldsValidate","sb_1","x","formControlConfig","formControlMetadatas","formControlMetadata","valueChanging","getEntityValueChangingListeners","listeners","getEntityValueChangedListeners","CommandMethodMeta","ViewModel","initRepository","initContext","initBindingData","initUIState","intiStateMachine","initForm","initCommandBus","registerWithParent","initListeners","closeOldBeSession","entityValueChangingListeners","entityValueChangedListeners","command","plainPath","change_1","changed","commands","valueChangeSuccess_1","concatMap","tap","repositoryBindingData","CommandBus","extendCommandMethods","ngCommands","keybindingMap","ngCommand","eventParams","paramDescriptions","eventParam","dispatch","keyBinding","parentContext","parentViewModel","className","allViewModelContexts","extractPath","bindingBasePath","valueChangingListeners_1","valueChangedListeners_1","AppEventBus","subscriptionsMap","triggerEvent","event","componentId","funcError","subscription","unsubscribe","APP_BASE_PROVIDERS","App","appInjector","APP_VARIABLE_PROVIDERS","createViewModel","VIEW_MODEL_COMMAND_PROVIDERS","ParseUtil","getAppContext","CommandContext","getFrameContext","getRootFrameContext","getFrameContextById","frameId","DataVariableParser","searchValue","replaceValue","DATA_PATTERN","UIStateVariableParser","UI_STATE_PATTERN","formatDate","year","getFullYear","month","getMonth","day","getDate","StateMachineVariableParser","stateMachineVariables","STATE_MACHINE_PATTERN","sessionVariable","getPathObj","getTargetStateMachine","targetFrameContext","splitPath","CommandVariableParser","results","parsers","parseExpression","itemIndex","evaluate","parsedExpression","TaskLink","to","condition","canLink","TaskFlow","nodes","links","addNode","node","addNodes","insertNode","findNodeIndex","createNode","appendNode","addLink","link","createLink","addLinks","getNext","nextLink","taskFlow","CommandHandler","parseService","schedule","lastTaskResult$","setTimeout","commandToExecute","context$","currentTask","latestResult","complete","throwIfEmpty","takeLast","displayError","addTask","insertTask","afterTask","replaceTask","invoke","serviceInstance","setContextToServiceInstance","parsedArgs","serviceContext","COMMAND_HANDLERS_TOKEN","CommandHandlerRegistry","handlers","handlerMap","handler","regist","commandName","commandHandler","handlerMetadata","CommandHandlerExtender","COMMAND_HANDLER_EXTENDERS_TOKEN","CommandHandlerExtenderRegistry","extenders","extendersMap","extender","extenderMetadata","CommandHandlerFactory","handlerRegistry","extenderRegistry","rawHandler","handlerFactory","executingCommands","executingCommandCount$","commandResult$","executeCommand","lastTaskResult","removeCommandFromExecutingQueue","addCommandToExecutingQueue","executingCommand","decoratorFactory","ParamDecoratorFactory","ParamDecorator","annotation","unusedKey","parameters"],"mappings":"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","sourcesContent":["/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport function __createBinding(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n}\r\n\r\nexport function __exportStar(m, exports) {\r\n    for (var p in m) if (p !== \"default\" && !exports.hasOwnProperty(p)) exports[p] = m[p];\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n};\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];\r\n    result.default = mod;\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, privateMap) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to get private field on non-instance\");\r\n    }\r\n    return privateMap.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, privateMap, value) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to set private field on non-instance\");\r\n    }\r\n    privateMap.set(receiver, value);\r\n    return value;\r\n}\r\n","\r\nexport interface Type<T> extends Function {\r\n  new (...args: any[]): T;\r\n}\r\n\r\nexport const Type = Function;\r\n\r\n\r\n\r\n// export type ClassType = new (...args: any[]) => any;\r\n\r\nexport interface Pagination {\r\n    pageSize: number;\r\n    pageIndex: number;\r\n    total: number;\r\n}\r\n\r\nexport interface Pagination {\r\n    pageSize: number;\r\n    pageIndex: number;\r\n    total: number;\r\n}\r\n\r\n\r\nexport interface ResultData {\r\n    data?: any[];\r\n    pagination?: Pagination;\r\n}\r\n\r\nexport enum DataChangeType { Add, Delete }\r\n\r\nexport interface DataChange {\r\n    /**\r\n     * 变更路径，主要针对带从表的情况\r\n     */\r\n    fpath?: string;\r\n    dataId: string;\r\n    changeType: DataChangeType;\r\n    [prop: string]: any;\r\n}\r\n","import { Type } from '../types';\r\n\r\nexport function isType(v: any): v is Type<any> {\r\n  return typeof v === 'function';\r\n}\r\n\r\n\r\n\r\nexport interface AbstractType<T> extends Function {\r\n  prototype: T;\r\n}\r\n\r\n\r\nexport enum InjectFlags {\r\n\r\n  Default = 0b0000,\r\n\r\n  Self = 0b0001,\r\n\r\n  SkipSelf = 0b0010,\r\n\r\n  Optional = 0b0100,\r\n}\r\n\r\n\r\nexport const enum OptionFlags {\r\n  Optional = 1 << 0,\r\n  CheckSelf = 1 << 1,\r\n  CheckParent = 1 << 2,\r\n  Default = CheckSelf | CheckParent\r\n}\r\n\r\n\r\nexport interface Record {\r\n\r\n  fn: Function;\r\n\r\n  useNew: boolean;\r\n\r\n  deps: DependencyRecord[];\r\n\r\n  value: any;\r\n\r\n}\r\n\r\n\r\nexport interface DependencyRecord {\r\n\r\n  token: any;\r\n\r\n  options: number;\r\n}\r\n\r\n\r\n","export const EMPTY = [] as any[];\r\n\r\nexport const IDENT = function<T>(value: T): T {\r\n  return value;\r\n};\r\n\r\nexport const CIRCULAR = IDENT;\r\n\r\nexport const MULTI_PROVIDER_FN = function(): any[] {\r\n  return Array.prototype.slice.call(arguments);\r\n};\r\n\r\nexport const NEW_LINE = /\\n/gm;\r\n\r\nexport const NO_NEW_LINE = 'ɵ';\r\n\r\nconst _THROW_IF_NOT_FOUND = {};\r\n\r\nexport const THROW_IF_NOT_FOUND = _THROW_IF_NOT_FOUND;\r\n\r\nexport const NG_TEMP_TOKEN_PATH = 'ngTempTokenPath';\r\n","import { NO_NEW_LINE, NEW_LINE } from './consts';\r\n\r\nexport function stringify(token: any): string {\r\n  if (typeof token === 'string') {\r\n    return token;\r\n  }\r\n\r\n  if (Array.isArray(token)) {\r\n    return '[' + token.map(stringify).join(', ') + ']';\r\n  }\r\n\r\n  if (token == null) {\r\n    return '' + token;\r\n  }\r\n\r\n  if (token.overriddenName) {\r\n    return `${token.overriddenName}`;\r\n  }\r\n\r\n  if (token.name) {\r\n    return `${token.name}`;\r\n  }\r\n\r\n  const res = token.toString();\r\n\r\n  if (res == null) {\r\n    return '' + res;\r\n  }\r\n\r\n  const newLineIndex = res.indexOf('\\n');\r\n  return newLineIndex === -1 ? res : res.substring(0, newLineIndex);\r\n}\r\n\r\n\r\nexport function getClosureSafeProperty<T>(objWithPropertyToExtract: T): string {\r\n  for (const key in objWithPropertyToExtract) {\r\n    if (objWithPropertyToExtract[key] === getClosureSafeProperty as any) {\r\n      return key;\r\n    }\r\n  }\r\n  throw Error('Could not find renamed property on target object.');\r\n}\r\n\r\n\r\nexport function formatError(\r\n  text: string,\r\n  obj: any,\r\n  injectorErrorName: string,\r\n  source: string|null = null\r\n): string {\r\n  text = text && text.charAt(0) === '\\n' && text.charAt(1) == NO_NEW_LINE ? text.substr(2) : text;\r\n  let context = stringify(obj);\r\n  if (Array.isArray(obj)) {\r\n    context = obj.map(stringify).join(' -> ');\r\n  } else if (typeof obj === 'object') {\r\n    const parts = [] as string[];\r\n    for (const key in obj) {\r\n      if (obj.hasOwnProperty(key)) {\r\n        const value = obj[key];\r\n        parts.push(\r\n            key + ':' + (typeof value === 'string' ? JSON.stringify(value) : stringify(value)));\r\n      }\r\n    }\r\n    context = `{${parts.join(', ')}}`;\r\n  }\r\n  return `${injectorErrorName}${source ? '(' + source + ')' : ''}[${context}]: ${\r\n      text.replace(NEW_LINE, '\\n  ')}`;\r\n}\r\n\r\n\r\nexport function staticError(text: string, obj: any): Error {\r\n  return new Error(formatError(text, obj, 'StaticInjectorError'));\r\n}\r\n","import { Type } from '../types';\r\nimport { getClosureSafeProperty } from './utils';\r\n\r\n\r\nexport interface InjectorType<T> extends Type<T> {\r\n  ɵinj: never;\r\n}\r\n\r\nexport interface ɵɵInjectableDef<T> {\r\n  providedIn: InjectorType<any>|'root'|'platform'|'any'|null;\r\n  token: unknown;\r\n  factory: (t?: Type<any>) => T;\r\n  value: T|undefined;\r\n}\r\n\r\n\r\nexport function ɵɵdefineInjectable<T>(opts: {\r\n  token: unknown,\r\n  providedIn?: Type<any>|'root'|'platform'|'any'|null, factory: () => T,\r\n}): never {\r\n  return ({\r\n    token: opts.token,\r\n    providedIn: opts.providedIn as any || null,\r\n    factory: opts.factory,\r\n    value: undefined,\r\n  } as ɵɵInjectableDef<T>) as never;\r\n}\r\n\r\n\r\nexport const NG_PROV_DEF       = getClosureSafeProperty({ɵprov: getClosureSafeProperty});\r\nexport const NG_INJ_DEF        = getClosureSafeProperty({ɵinj: getClosureSafeProperty});\r\nexport const NG_INJECTABLE_DEF = getClosureSafeProperty({ngInjectableDef: getClosureSafeProperty});\r\n\r\nexport function getOwnDefinition<T>(type: any, def: ɵɵInjectableDef<T>): ɵɵInjectableDef<T>|null {\r\n  return def && def.token === type ? def : null;\r\n}\r\n\r\nexport function getInjectableDef<T>(type: any): ɵɵInjectableDef<T>|null {\r\n  return getOwnDefinition(type, type[NG_PROV_DEF]) ||\r\n      getOwnDefinition(type, type[NG_INJECTABLE_DEF]);\r\n}\r\n","import { Type } from '../types';\r\nimport { ɵɵdefineInjectable } from './injectable_def';\r\n\r\n\r\nexport class InjectionToken<T> {\r\n\r\n  readonly ngMetadataName = 'InjectionToken';\r\n\r\n  readonly ɵprov: never|undefined;\r\n\r\n  constructor(\r\n    protected _desc: string,\r\n    options?: { providedIn?: Type<any>|'root'|'platform'|'any'|null, factory: () => T }\r\n  ) {\r\n\r\n    this.ɵprov = undefined;\r\n    if (typeof options === 'number') {\r\n      (this as any).__NG_ELEMENT_ID__ = options;\r\n    } else if (options !== undefined) {\r\n      this.ɵprov = ɵɵdefineInjectable({\r\n        token: this,\r\n        providedIn: options.providedIn || 'root',\r\n        factory: options.factory,\r\n      });\r\n    }\r\n  }\r\n\r\n  toString(): string {\r\n    return `InjectionToken ${this._desc}`;\r\n  }\r\n}\r\n\r\nexport function createInjectionToken(token: any): InjectionToken<any> {\r\n  return new InjectionToken<any>(token);\r\n}\r\n","import { Type } from '../types';\r\nimport { AbstractType, InjectFlags } from './types';\r\nimport { InjectionToken } from './injection_token';\r\n\r\n/**\r\n * 注入器抽象类\r\n */\r\nexport abstract class Injector {\r\n\r\n  abstract get<T>(\r\n      token: Type<T>|InjectionToken<T>|AbstractType<T>,\r\n      notFoundValue?: T,\r\n      flags?: InjectFlags\r\n  ): T;\r\n\r\n  abstract get(token: any, notFoundValue?: any): any;\r\n\r\n}\r\n","import { stringify } from './utils';\r\nimport { THROW_IF_NOT_FOUND } from './consts';\r\nimport { Injector } from './injector';\r\n\r\n\r\nexport class NullInjector implements Injector {\r\n\r\n  get(token: any, notFoundValue: any = THROW_IF_NOT_FOUND): any {\r\n    if (notFoundValue === THROW_IF_NOT_FOUND) {\r\n      const error = new Error(`NullInjectorError: No provider for ${stringify(token)}!`);\r\n      error.name = 'NullInjectorError';\r\n      throw error;\r\n    }\r\n    return notFoundValue;\r\n  }\r\n\r\n}\r\n\r\n\r\nexport const NULL_INJECTOR: Injector = new NullInjector();\r\n","import { Type } from '../types';\r\nimport { stringify, getClosureSafeProperty } from './utils';\r\n\r\nconst __forward_ref__ = getClosureSafeProperty({__forward_ref__: getClosureSafeProperty});\r\n\r\nexport function resolveForwardRef<T>(type: T): T {\r\n  return isForwardRef(type) ? type() : type;\r\n}\r\n\r\nexport interface ForwardRefFn {\r\n  (): any;\r\n}\r\n\r\nexport function forwardRef(forwardRefFn: ForwardRefFn): Type<any> {\r\n  (forwardRefFn as any).__forward_ref__ = forwardRef;\r\n  (forwardRefFn as any).toString = function() {\r\n    return stringify(this());\r\n  };\r\n  return (forwardRefFn as any as Type<any>);\r\n}\r\n\r\nexport function isForwardRef(fn: any): fn is() => any {\r\n  return typeof fn === 'function' && fn.hasOwnProperty(__forward_ref__) &&\r\n      fn.__forward_ref__ === forwardRef;\r\n}\r\n","import { Type } from '../types';\r\nimport { InjectFlags, OptionFlags, Record, DependencyRecord } from './types';\r\nimport { IDENT, EMPTY, CIRCULAR, MULTI_PROVIDER_FN, NO_NEW_LINE, NEW_LINE, NG_TEMP_TOKEN_PATH } from './consts';\r\nimport { stringify, getClosureSafeProperty, formatError, staticError } from './utils';\r\nimport { Injector } from './injector';\r\nimport { NULL_INJECTOR, NullInjector} from './null_injector';\r\nimport {\r\n  ValueProvider, StaticClassProvider, ConstructorProvider,  ExistingProvider, FactoryProvider,\r\n  StaticProvider, SupportedProvider,\r\n} from './providers';\r\nimport { InjectionToken } from './injection_token';\r\nimport { getInjectableDef } from './injectable_def';\r\nimport { resolveForwardRef } from './forward_ref';\r\nimport { THROW_IF_NOT_FOUND, } from './consts';\r\n\r\n\r\nexport const INJECTOR = new InjectionToken<Injector>('INJECTOR', -1 as any);\r\n\r\nexport const USE_VALUE =  getClosureSafeProperty<ValueProvider>({provide: String, useValue: getClosureSafeProperty});\r\n\r\nlet _currentInjector: Injector|undefined|null = undefined;\r\n\r\nexport function setCurrentInjector(injector: Injector|null|undefined): Injector|undefined|null {\r\n  const former = _currentInjector;\r\n  _currentInjector = injector;\r\n  return former;\r\n}\r\n\r\n\r\nexport class StaticInjector implements Injector {\r\n\r\n  readonly parent: Injector;\r\n\r\n  readonly source: string|null;\r\n\r\n  readonly scope: string|null;\r\n\r\n  private _records: Map<any, Record|null>;\r\n\r\n  constructor(\r\n    providers: StaticProvider[],\r\n    parent: Injector = NULL_INJECTOR,\r\n    source: string|null = null\r\n  ) {\r\n    parent = parent ? parent : NULL_INJECTOR;\r\n    this.parent = parent;\r\n    this.source = source;\r\n    const records = this._records = new Map<any, Record>();\r\n\r\n    records.set(Injector, {token: Injector, fn: IDENT, deps: EMPTY, value: this, useNew: false} as Record);\r\n    records.set(INJECTOR, {token: INJECTOR, fn: IDENT, deps: EMPTY, value: this, useNew: false} as Record);\r\n    this.scope = recursivelyProcessProviders(records, providers);\r\n  }\r\n\r\n  get<T>(token: Type<T>|InjectionToken<T>, notFoundValue?: T, flags?: InjectFlags): T;\r\n  get(token: any, notFoundValue?: any): any;\r\n  get(token: any, notFoundValue?: any, flags: InjectFlags = InjectFlags.Default): any {\r\n    const records = this._records;\r\n    let record = records.get(token);\r\n    if (record === undefined) {\r\n      const injectableDef = getInjectableDef(token);\r\n      if (injectableDef) {\r\n        const providedIn = injectableDef && injectableDef.providedIn;\r\n        if (providedIn === 'any' || providedIn != null && providedIn === this.scope) {\r\n          records.set(\r\n            token,\r\n            record = resolveProvider({provide: token, useFactory: injectableDef.factory, deps: EMPTY})\r\n          );\r\n        }\r\n      }\r\n      if (record === undefined) {\r\n        records.set(token, null);\r\n      }\r\n    }\r\n    const lastInjector = setCurrentInjector(this);\r\n    try {\r\n      return tryResolveToken(token, record, records, this.parent, notFoundValue, flags);\r\n    } catch (e) {\r\n      throw e;\r\n    } finally {\r\n      setCurrentInjector(lastInjector);\r\n    }\r\n  }\r\n\r\n  toString() {\r\n    const tokens = [] as string[];\r\n    const  records = this._records;\r\n    records.forEach((v, token) => tokens.push(stringify(token)));\r\n    return `StaticInjector[${tokens.join(', ')}]`;\r\n  }\r\n}\r\n\r\n\r\nfunction multiProviderMixError(token: any) {\r\n  return staticError('Cannot mix multi providers and regular providers', token);\r\n}\r\n\r\nexport const INJECTOR_SCOPE = new InjectionToken<'root'|'platform'|null>('Set Injector scope.');\r\n\r\n\r\n/**\r\n * 递归处理Provider\r\n */\r\nfunction recursivelyProcessProviders(records: Map<any, Record>, provider: StaticProvider): string | null {\r\n  let scope: string|null = null;\r\n  if (provider) {\r\n    provider = resolveForwardRef(provider);\r\n    if (Array.isArray(provider)) {\r\n\r\n      for (let i = 0; i < provider.length; i++) {\r\n        scope = recursivelyProcessProviders(records, provider[i]) || scope;\r\n      }\r\n    } else if (typeof provider === 'function') {\r\n\r\n      throw staticError('Function/Class not supported', provider);\r\n    } else if (provider && typeof provider === 'object' && provider.provide) {\r\n\r\n      let token = resolveForwardRef(provider.provide);\r\n      const resolvedProvider = resolveProvider(provider);\r\n\r\n      // multi\r\n      if (provider.multi === true) {\r\n        let multiProvider: Record|undefined = records.get(token);\r\n        if (multiProvider) {\r\n          if (multiProvider.fn !== MULTI_PROVIDER_FN) {\r\n            throw multiProviderMixError(token);\r\n          }\r\n        } else {\r\n          records.set(token, multiProvider = {\r\n            token: provider.provide,\r\n            deps: [],\r\n            useNew: false,\r\n            fn: MULTI_PROVIDER_FN,\r\n            value: EMPTY\r\n          } as Record);\r\n        }\r\n        token = provider;\r\n        multiProvider.deps.push({token, options: OptionFlags.Default});\r\n      }\r\n\r\n      const record = records.get(token);\r\n      if (record && record.fn === MULTI_PROVIDER_FN) {\r\n        throw multiProviderMixError(token);\r\n      }\r\n      if (token === INJECTOR_SCOPE) {\r\n        scope = resolvedProvider.value;\r\n      }\r\n      records.set(token, resolvedProvider);\r\n    } else {\r\n      throw staticError('Unexpected provider', provider);\r\n    }\r\n  }\r\n  return scope;\r\n}\r\n\r\nfunction resolveProvider(provider: SupportedProvider): Record {\r\n  const deps = computeDeps(provider);\r\n  let fn: Function = IDENT;\r\n  let value: any = EMPTY;\r\n  let useNew: boolean = false;\r\n  const provide = resolveForwardRef(provider.provide);\r\n\r\n  if (USE_VALUE in provider) {\r\n\r\n    value = (provider as ValueProvider).useValue;\r\n  } else if ((provider as FactoryProvider).useFactory) {\r\n\r\n    fn = (provider as FactoryProvider).useFactory;\r\n  } else if ((provider as ExistingProvider).useExisting) {\r\n\r\n    // Just use IDENT\r\n  } else if ((provider as StaticClassProvider).useClass) {\r\n\r\n    // 静态类型\r\n    useNew = true;\r\n    fn = resolveForwardRef((provider as StaticClassProvider).useClass);\r\n  } else if (typeof provide === 'function') {\r\n\r\n    // 构造函数\r\n    useNew = true;\r\n    fn = provide;\r\n  } else {\r\n    throw staticError(\r\n        'StaticProvider does not have [useValue|useFactory|useExisting|useClass] or [provide] is not newable',\r\n        provider);\r\n  }\r\n  return {deps, fn, useNew, value};\r\n}\r\n\r\n/**\r\n * 计算依赖\r\n */\r\nfunction computeDeps(provider: StaticProvider): DependencyRecord[] {\r\n  let deps: DependencyRecord[] = EMPTY;\r\n  const providerDeps: any[] = (provider as ExistingProvider & StaticClassProvider & ConstructorProvider).deps;\r\n\r\n  if (providerDeps && providerDeps.length) {\r\n    deps = [];\r\n    for (let i = 0; i < providerDeps.length; i++) {\r\n      const options = OptionFlags.Default;\r\n      const token = resolveForwardRef(providerDeps[i]);\r\n      deps.push({token, options});\r\n    }\r\n  } else if ((provider as ExistingProvider).useExisting) {\r\n    const token = resolveForwardRef((provider as ExistingProvider).useExisting);\r\n    deps = [{token, options: OptionFlags.Default}];\r\n  } else if (!providerDeps && !(USE_VALUE in provider)) {\r\n    // useValue & useExisting are the only ones which are exempt from deps all others need it.\r\n    throw staticError('\\'deps\\' required', provider);\r\n  }\r\n  return deps;\r\n}\r\n\r\n\r\nfunction tryResolveToken(\r\n  token: any,\r\n  record: Record|undefined|null,\r\n  records: Map<any, Record|null>,\r\n  parent: Injector,\r\n  notFoundValue: any,\r\n  flags: InjectFlags\r\n): any {\r\n  try {\r\n    return resolveToken(token, record, records, parent, notFoundValue, flags);\r\n  } catch (e) {\r\n    if (!(e instanceof Error)) {\r\n      e = new Error(e);\r\n    }\r\n    const path: any[] = e[NG_TEMP_TOKEN_PATH] = e[NG_TEMP_TOKEN_PATH] || [];\r\n    path.unshift(token);\r\n\r\n    // 清空循环引用的值\r\n    if (record && record.value === CIRCULAR) {\r\n      record.value = EMPTY;\r\n    }\r\n    throw e;\r\n  }\r\n}\r\n\r\n\r\nfunction resolveToken(\r\n  token: any,\r\n  record: Record|undefined|null,\r\n  records: Map<any, Record|null>,\r\n  parent: Injector,\r\n  notFoundValue: any,\r\n  flags: InjectFlags\r\n): any {\r\n\r\n  let value;\r\n  if (record && !(flags & InjectFlags.SkipSelf)) {\r\n    value = record.value;\r\n    if (value === CIRCULAR) {\r\n      throw Error(NO_NEW_LINE + 'Circular dependency');\r\n    } else if (value === EMPTY) {\r\n      record.value = CIRCULAR;\r\n      const useNew = record.useNew;\r\n      const fn = record.fn;\r\n      const depRecords = record.deps;\r\n      let deps = EMPTY;\r\n      if (depRecords.length) {\r\n        deps = [];\r\n        for (let i = 0; i < depRecords.length; i++) {\r\n          const depRecord: DependencyRecord = depRecords[i];\r\n          const options = depRecord.options;\r\n          const childRecord = options & OptionFlags.CheckSelf ? records.get(depRecord.token) : undefined;\r\n          deps.push(\r\n            tryResolveToken(\r\n              depRecord.token,\r\n              childRecord,\r\n              records,\r\n              !childRecord && !(options & OptionFlags.CheckParent) ? NULL_INJECTOR : parent,\r\n              options & OptionFlags.Optional ? null : THROW_IF_NOT_FOUND,\r\n              InjectFlags.Default\r\n            )\r\n          );\r\n        }\r\n      }\r\n      record.value = value = useNew ? new (fn as any)(...deps) : fn.apply(undefined, deps);\r\n    }\r\n  } else if (!(flags & InjectFlags.Self)) {\r\n\r\n    value = parent.get(token, notFoundValue, InjectFlags.Default);\r\n  } else if (!(flags & InjectFlags.Optional)) {\r\n\r\n    value = NULL_INJECTOR.get(token, notFoundValue);\r\n  } else {\r\n\r\n    value = NULL_INJECTOR.get(token, typeof notFoundValue !== 'undefined' ? notFoundValue : null);\r\n  }\r\n  return value;\r\n}\r\n","import { Injector } from './injector';\r\nimport { StaticInjector } from './static_injector';\r\nimport { StaticProvider } from './providers';\r\n\r\nexport function INJECTOR_IMPL__PRE_R3__(providers: StaticProvider[], parent: Injector|undefined, name: string) {\r\n  return new StaticInjector(providers, parent, name);\r\n}\r\n\r\nexport const INJECTOR_IMPL = INJECTOR_IMPL__PRE_R3__;\r\n\r\nexport function createInjector(\r\n  options: StaticProvider[] | {providers: StaticProvider[], parent?: Injector, name?: string},\r\n  parent?: Injector\r\n): Injector {\r\n  if (Array.isArray(options)) {\r\n    return INJECTOR_IMPL(options, parent, '');\r\n  } else {\r\n    return INJECTOR_IMPL(options.providers, options.parent, options.name || '');\r\n  }\r\n}\r\n","/**\r\n * @license\r\n * Copyright Google Inc. All Rights Reserved.\r\n *\r\n * Use of this source code is governed by an MIT-style license that can be\r\n * found in the LICENSE file at https://angular.io/license\r\n */\r\n// import { Type } from '@angular/core';\r\nimport { Type } from '../types';\r\n\r\n/**\r\n * An interface implemented by all Angular formType decorators, which allows them to be used as ES7\r\n * decorators as well as\r\n * Angular DSL syntax.\r\n *\r\n * ES7 syntax:\r\n *\r\n * ```\r\n * @ng.Component({...})\r\n * class MyClass {...}\r\n * ```\r\n *\r\n */\r\nexport interface TypeDecorator {\r\n    /**\r\n     * Invoke as ES7 decorator.\r\n     */\r\n    <T extends Type<any>>(type: T): T;\r\n\r\n    // Make TypeDecorator assignable to built-in ParameterDecorator formType.\r\n    // ParameterDecorator is declared in lib.d.ts as a `declare formType`\r\n    // so we cannot declare this interface as a subtype.\r\n    // see https://github.com/angular/angular/issues/3379#issuecomment-126169417\r\n    (target: Object, propertyKey?: string | symbol, parameterIndex?: number): void;\r\n}\r\n\r\nexport const ANNOTATIONS = '__annotations__';\r\nexport const PARAMETERS = '__parameters__';\r\nexport const PROP_METADATA = '__prop__metadata__';\r\n\r\n\r\n\r\n\r\n/**\r\n * @suppress {globalThis}\r\n */\r\nexport function makeDecorator(\r\n    name: string, props?: (...args: any[]) => any, parentClass?: any,\r\n    chainFn?: (fn: Function) => void,\r\n    typeFn?: (type: Type<any>, ...args: any[]) => void): {\r\n        new(...args: any[]): any;\r\n        (...args: any[]): any;\r\n        (...args: any[]): (cls: any) => any;\r\n    } {\r\n    const metaCtor = makeMetadataCtor(props);\r\n\r\n    function DecoratorFactory(...args: any[]): (cls: any) => any {\r\n        if (this instanceof DecoratorFactory) {\r\n            metaCtor.call(this, ...args);\r\n            return this;\r\n        }\r\n\r\n        const annotationInstance = new (<any>DecoratorFactory)(...args);\r\n        const typeDecorator: TypeDecorator = <TypeDecorator>function createTypeDecorator(cls: Type<any>) {\r\n            typeFn && typeFn(cls, ...args);\r\n            // Use of Object.defineProperty is important since it creates non-enumerable property which\r\n            // prevents the property is copied during subclassing.\r\n            const annotations = cls.hasOwnProperty(ANNOTATIONS) ?\r\n                (cls as any)[ANNOTATIONS] :\r\n                Object.defineProperty(cls, ANNOTATIONS, { value: [] })[ANNOTATIONS];\r\n            annotations.push(annotationInstance);\r\n            return cls;\r\n        };\r\n        if (chainFn) { chainFn(typeDecorator); }\r\n        return typeDecorator;\r\n    }\r\n\r\n    if (parentClass) {\r\n        DecoratorFactory.prototype = Object.create(parentClass.prototype);\r\n    }\r\n\r\n    DecoratorFactory.prototype.ngMetadataName = name;\r\n    (<any>DecoratorFactory).annotationCls = DecoratorFactory;\r\n    return DecoratorFactory as any;\r\n}\r\n\r\nfunction makeMetadataCtor(props?: (...args: any[]) => any): any {\r\n    return function ctor(...args: any[]) {\r\n        if (props) {\r\n            const values = props(...args);\r\n            // tslint:disable-next-line:forin\r\n            for (const propName in values) {\r\n                this[propName] = values[propName];\r\n            }\r\n        }\r\n    };\r\n}\r\n\r\n\r\n\r\n\r\n\r\nexport function makeParamDecorator(\r\n    name: string, props?: (...args: any[]) => any, parentClass?: any): any {\r\n    const metaCtor = makeMetadataCtor(props);\r\n    function ParamDecoratorFactory(...args: any[]): any {\r\n        if (this instanceof ParamDecoratorFactory) {\r\n            metaCtor.apply(this, args);\r\n            return this;\r\n        }\r\n        const annotationInstance = new (<any>ParamDecoratorFactory)(...args);\r\n\r\n        (<any>ParamDecorator).annotation = annotationInstance;\r\n        return ParamDecorator;\r\n\r\n        function ParamDecorator(cls: any, unusedKey: any, index: number): any {\r\n            // Use of Object.defineProperty is important since it creates non-enumerable property which\r\n            // prevents the property is copied during subclassing.\r\n            const parameters = cls.hasOwnProperty(PARAMETERS) ?\r\n                (cls as any)[PARAMETERS] :\r\n                Object.defineProperty(cls, PARAMETERS, { value: [] })[PARAMETERS];\r\n\r\n            // there might be gaps if some in between parameters do not have annotations.\r\n            // we pad with nulls.\r\n            while (parameters.length <= index) {\r\n                parameters.push(null);\r\n            }\r\n\r\n            (parameters[index] = parameters[index] || []).push(annotationInstance);\r\n            return cls;\r\n        }\r\n    }\r\n    if (parentClass) {\r\n        ParamDecoratorFactory.prototype = Object.create(parentClass.prototype);\r\n    }\r\n    ParamDecoratorFactory.prototype.ngMetadataName = name;\r\n    (<any>ParamDecoratorFactory).annotationCls = ParamDecoratorFactory;\r\n    return ParamDecoratorFactory;\r\n}\r\n\r\n\r\n\r\n\r\nexport function makePropDecorator(\r\n    name: string, props?: (...args: any[]) => any, parentClass?: any): any {\r\n    const metaCtor = makeMetadataCtor(props);\r\n\r\n    function PropDecoratorFactory(...args: any[]): any {\r\n        if (this instanceof PropDecoratorFactory) {\r\n            metaCtor.apply(this, args);\r\n            return this;\r\n        }\r\n\r\n        const decoratorInstance = new (<any>PropDecoratorFactory)(...args);\r\n\r\n        // tslint:disable-next-line:no-shadowed-variable\r\n        return function PropDecorator(target: any, name: string) {\r\n            const constructor = target.constructor;\r\n            // Use of Object.defineProperty is important since it creates non-enumerable property which\r\n            // prevents the property is copied during subclassing.\r\n            const meta = constructor.hasOwnProperty(PROP_METADATA) ?\r\n                (constructor as any)[PROP_METADATA] :\r\n                Object.defineProperty(constructor, PROP_METADATA, { value: {} })[PROP_METADATA];\r\n            meta[name] = meta.hasOwnProperty(name) && meta[name] || [];\r\n            meta[name].unshift(decoratorInstance);\r\n        };\r\n    }\r\n\r\n    if (parentClass) {\r\n        PropDecoratorFactory.prototype = Object.create(parentClass.prototype);\r\n    }\r\n\r\n    PropDecoratorFactory.prototype.ngMetadataName = name;\r\n    (<any>PropDecoratorFactory).annotationCls = PropDecoratorFactory;\r\n    return PropDecoratorFactory;\r\n}\r\n","import { ANNOTATIONS, PROP_METADATA } from './decorator';\r\nimport { Translate } from '../../i18n/index';\r\n\r\n/**\r\n * 元数据解析\r\n * 约束：\r\n * 1、类型装饰器：在某个类型上，某种类型的装饰器，只使用一次，不重复添加；\r\n * 2、属性装饰器：在某个属性上，某种类型的装饰器，只使用一次，不重复添加\r\n */\r\nclass MetadataUtil {\r\n\r\n  // ----------------------------------------\r\n  // 类型元数据\r\n  // ----------------------------------------\r\n\r\n  /**\r\n   * 获取类元数据\r\n   * 返回结果形如：\r\n   * [\r\n   *   Injectable\r\n   *   NgViewModel\r\n   *   NgViewModel\r\n   * ]\r\n   */\r\n  static getClassMetadatas(constructor: any): any[] {\r\n    const metadatas = constructor[ANNOTATIONS];\r\n    return metadatas;\r\n  }\r\n\r\n  /**\r\n   * 获取某个class上的某种装饰器\r\n   * 返回结果：NgViewModel\r\n   */\r\n  static getClassMetadataByName(constructor: any, metadataName: string): any {\r\n    const metadata = this.getClassMetadataByNameWithTranslate(constructor, metadataName, null, null);\r\n    return metadata;\r\n  }\r\n\r\n  static getClassMetadataByNameWithTranslate(\r\n    constructor: any, metadataName: string,\r\n    translateService?: Translate, keysToTranslate?: string[]): any {\r\n    const allClassMetadatas = this.getClassMetadatas(constructor);\r\n    if (!allClassMetadatas) {\r\n      return null;\r\n    }\r\n    const metadata = allClassMetadatas.find((classMetadata: any) => {\r\n      return classMetadata.ngMetadataName === metadataName;\r\n    });\r\n    if (metadata && translateService && keysToTranslate) {\r\n      keysToTranslate.forEach((metadataPropKey) => {\r\n        const propertyVariable: string = metadata[metadataPropKey];\r\n        if (propertyVariable && propertyVariable.startsWith('{{') && propertyVariable.endsWith('}}')) {\r\n          const translateKey = propertyVariable.replace('{{', '').replace('}}', '').trim();\r\n          metadata[metadataPropKey] = translateService.transform(translateKey, null);\r\n        }\r\n      });\r\n    }\r\n    return metadata;\r\n  }\r\n\r\n  // ----------------------------------------\r\n  // 属性元数据\r\n  // ----------------------------------------\r\n\r\n  /**\r\n   * 获取所有属性的所有元数据\r\n   * 返回格式：\r\n   * {\r\n   *   propName1: [ NgDefaultValue, NgMaxLength, NgMinLength],\r\n   *   propName2: [ NgDefaultValue, NgMaxLength, NgMinLength]\r\n   * }\r\n   */\r\n  static getPropsMetadatas(constructor: any): any {\r\n    const allPropMetadatas = constructor[PROP_METADATA];\r\n    return allPropMetadatas;\r\n  }\r\n\r\n  /**\r\n   * 获取所有属性的某一类型的元数据\r\n   * 如果同一属性\r\n   * 返回结果：\r\n   * {\r\n   *    propName1: NgDefaultValue,\r\n   *    propName2: NgDefaultValue\r\n   * }\r\n   */\r\n  static getPropsMetadatasByName(constructor: any, metadataName: string): { [propName: string]: any } {\r\n    const metadatas = this.getPropsMetadatasByNameWithTranslate(constructor, metadataName);\r\n    return metadatas;\r\n  }\r\n\r\n  static getPropsMetadatasByNameWithTranslate(\r\n    constructor: any, metadataName: string,\r\n    translateService?: Translate, keysToTranslate?: string[]): { [propName: string]: any } {\r\n    const metadatas = {};\r\n    // 读取构造函数中存储的类属性注解。\r\n    const allPropMetadatas = this.getPropsMetadatas(constructor);\r\n    if (!allPropMetadatas) {\r\n      return metadatas;\r\n    }\r\n    // 遍历所有属性提取注解信息。\r\n    Object.keys(allPropMetadatas).forEach((propName: string) => {\r\n      // 提取当前属性注解对象\r\n      const propMetadatas: any[] = allPropMetadatas[propName];\r\n      // 提取指定类型的注解项\r\n      const metadata = propMetadatas.find((propMetadata: any) => {\r\n        return propMetadata.ngMetadataName === metadataName;\r\n      });\r\n      if (translateService && keysToTranslate) {\r\n        keysToTranslate.forEach((metadataPropKey) => {\r\n          const propertyVariable: string = metadata[metadataPropKey];\r\n          if (propertyVariable && propertyVariable.startsWith('{{') && propertyVariable.endsWith('}}')) {\r\n            const translateKey = propertyVariable.replace('{{', '').replace('}}', '').trim();\r\n            metadata[metadataPropKey] = translateService.transform(translateKey, null);\r\n          }\r\n        });\r\n      }\r\n      if (metadata) {\r\n        metadatas[propName] = metadata;\r\n      }\r\n    });\r\n\r\n    return metadatas;\r\n  }\r\n\r\n  /**\r\n   * 获取某个属性的所有元数据\r\n   * 返回格式：[ NgDefaultValue, NgMaxLength, NgMinLength]\r\n   */\r\n  static getPropMetadatasByName(constructor: any, propName: string): any[] {\r\n    // 暂不实现\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * 获取某个属性的某种元数据\r\n   * 返回格式：NgDefaultValue\r\n   */\r\n  static getPropMetadataByName(constructor: any, propName: string, metadataName: string): any {\r\n    // 暂不实现\r\n    return null;\r\n  }\r\n\r\n\r\n  // ----------------------------------------\r\n  // 参数元数据\r\n  // ----------------------------------------\r\n\r\n}\r\n\r\nexport { MetadataUtil };\r\n","/**\r\n * 变更记录\r\n */\r\nexport class Modification {\r\n\r\n  /**\r\n   * 实体变更路径。如：[1, 'name']\r\n   * 说明： 1 为实体主键ID， name 为属性名称\r\n   */\r\n  path?: string[];\r\n\r\n  /**\r\n   * 原值\r\n   */\r\n  preValue?: any;\r\n\r\n  /**\r\n   * 变更后的新值\r\n   *\r\n   * value 值类型会根据 type(变更类型)的不同而不同，当type 为以下类型时：\r\n   * - Add: value的值为json 对象\r\n   * - ValueChange: value的值为string\\number\\boolean等简单数据\r\n   * - Remove: value的值为键值对{[key:string]: value} key为主键字段\r\n   *\r\n   */\r\n  value: any;\r\n\r\n  /**\r\n   * 变更类型\r\n   */\r\n  type: ModifyType;\r\n\r\n  /**\r\n   * 数据是否通过验证\r\n   */\r\n  isValid?: boolean;\r\n\r\n  /**\r\n   * 数据验证结果\r\n   */\r\n  errors?: { [type: string]: string };\r\n\r\n  /**\r\n   * 构造函数\r\n   * @param value 新值\r\n   * @param modifyType 变更类型\r\n   * @param path 变更路径\r\n   * @param preValue 旧值\r\n   */\r\n  constructor(value: any, modifyType: ModifyType, path?: string[], preValue?: any) {\r\n    this.type = modifyType;\r\n    this.value = value;\r\n    this.preValue = preValue;\r\n    this.path = path;\r\n  }\r\n}\r\n\r\n/**\r\n * 变更类型\r\n */\r\nexport enum ModifyType {\r\n\r\n  /**\r\n   * 添加\r\n   */\r\n  Add = 'ADD',\r\n\r\n  /**\r\n   * 删除\r\n   */\r\n  Remove = 'REMOVE',\r\n\r\n  /**\r\n   * 修改\r\n   */\r\n  ValueChange = 'VALUE_CHANGE',\r\n\r\n  /**\r\n   * 加载\r\n   */\r\n  Load = 'LOAD',\r\n\r\n  /**\r\n   * 未改变\r\n   */\r\n  UnChanged = 'UNCHANGED',\r\n\r\n  /**\r\n   * 分页信息变更\r\n   */\r\n  PaginationInfoChange = \"PAGINATION_INFO_CHANGE\"\r\n}\r\n","/**\r\n * 请求头信息\r\n */\r\ninterface HttpHeaders {\r\n  [key: string]: string;\r\n}\r\n\r\n/**\r\n * Http参数\r\n */\r\ninterface HttpParams {\r\n  [key: string]: string;\r\n}\r\n\r\n/**\r\n * 请求方法\r\n */\r\ntype HttpMethod = | 'GET' | 'DELETE' | 'HEAD' | 'OPTIONS' | 'POST' | 'PUT' | 'PATCH' | 'LINK' | 'UNLINK';\r\n\r\n/**\r\n * HttpMethods\r\n */\r\nclass HttpMethods {\r\n  public static GET: HttpMethod     = 'GET';\r\n  public static DELETE: HttpMethod  = 'DELETE';\r\n  public static HEAD: HttpMethod    = 'HEAD';\r\n  public static OPTIONS: HttpMethod = 'OPTIONS';\r\n  public static POST: HttpMethod    = 'POST';\r\n  public static PUT: HttpMethod     = 'PUT';\r\n  public static PATCH: HttpMethod   = 'PATCH';\r\n  public static LINK: HttpMethod    = 'LINK';\r\n  public static UNLINK: HttpMethod  = 'UNLINK';\r\n}\r\n\r\n\r\n/**\r\n * 返回值类型\r\n */\r\ntype HttpResponseType = | 'arraybuffer' | 'blob' | 'document' | 'json' | 'text' | 'stream';\r\n\r\n/**\r\n * 返回值处理类型\r\n */\r\ntype ObserveType = 'body' | 'response';\r\n\r\n/**\r\n * Http响应信息\r\n */\r\ninterface HttpResponse {\r\n  headers: {[key: string]: string};\r\n  body: any;\r\n  status: number;\r\n  statusText: string;\r\n}\r\n\r\n/**\r\n * Http请求配置\r\n */\r\ninterface HttpRequestConfig {\r\n  params?: HttpParams;\r\n  body?: any;\r\n  headers?: HttpHeaders;\r\n  responseType?: HttpResponseType;\r\n  observe?: 'body' | 'response';\r\n}\r\n\r\n\r\nexport { HttpHeaders, HttpParams, HttpMethod, HttpMethods, ObserveType, HttpResponseType, HttpRequestConfig, HttpResponse };\r\n","import { AxiosInstance, AxiosRequestConfig, AxiosResponse} from 'axios';\r\nimport { HttpMethod, HttpHeaders, HttpResponse, HttpRequestConfig } from './types';\r\n\r\nclass HttpUtil {\r\n\r\n  /**\r\n   * 追加Header\r\n   */\r\n  public static appendHeader(headers: HttpHeaders, key: string, value: string): HttpHeaders {\r\n    headers = Object.assign({}, headers, {[key]: value});\r\n    return headers;\r\n  }\r\n\r\n  /**\r\n   * 向RequestConfig中追加body\r\n   */\r\n  public static appendBodyToRequestConfig(body: any, requestConfig: HttpRequestConfig) {\r\n    if (!requestConfig) {\r\n      requestConfig = {};\r\n    }\r\n    requestConfig = Object.assign({}, requestConfig, { body: body});\r\n\r\n    return requestConfig;\r\n  }\r\n\r\n  /**\r\n   * 构造AxiosReqeustConfig\r\n   */\r\n  public static buildAxiosRequestConfig(method: HttpMethod, url: string, requestConfig: HttpRequestConfig): AxiosRequestConfig {\r\n    requestConfig = requestConfig || {};\r\n\r\n    const axiosRequestConfig: AxiosRequestConfig = {\r\n      url: url,\r\n      method: method,\r\n      params:  requestConfig.params || null,\r\n      headers: requestConfig.headers || null,\r\n      responseType: requestConfig.responseType || 'json',\r\n      data: requestConfig.body || null\r\n    };\r\n    return axiosRequestConfig;\r\n  }\r\n\r\n  /**\r\n   * 构造Http响应信息\r\n   */\r\n  public static buildHttpResponse(axiosResponse: AxiosResponse ) {\r\n    const httpResponse: HttpResponse = {\r\n      body: axiosResponse.data,\r\n      headers: axiosResponse.headers,\r\n      status: axiosResponse.status,\r\n      statusText: axiosResponse.statusText\r\n    };\r\n    return httpResponse;\r\n  }\r\n\r\n}\r\n\r\nexport { HttpUtil };\r\n","import { Observable, from, of } from 'rxjs';\r\nimport { map, switchMap } from 'rxjs/operators';\r\nimport axios from 'axios';\r\nimport { AxiosInstance, AxiosResponse} from 'axios';\r\nimport { HttpMethod, HttpRequestConfig } from './types';\r\nimport { HttpUtil } from './http-util';\r\n\r\n/**\r\n * HttpClient\r\n */\r\nclass HttpClient {\r\n\r\n  /**\r\n   * axios实例\r\n   */\r\n  private axiosInstance: AxiosInstance;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n    this.axiosInstance = axios.create();\r\n  }\r\n\r\n  /**\r\n   * 发送GET请求\r\n   */\r\n  public get(url: string, requestConfig: HttpRequestConfig): Observable<any> {\r\n    return this.request('GET', url, requestConfig);\r\n  }\r\n\r\n  /**\r\n   * 发送POST请求\r\n   */\r\n  public post(url: string, body: any, requestConfig: HttpRequestConfig) {\r\n    requestConfig = HttpUtil.appendBodyToRequestConfig(body, requestConfig);\r\n    return this.request('POST', url, requestConfig);\r\n  }\r\n\r\n  /**\r\n   * 发送PUT请求\r\n   */\r\n  public put(url: string, body: any, requestConfig: HttpRequestConfig) {\r\n    requestConfig = HttpUtil.appendBodyToRequestConfig(body, requestConfig);\r\n    return this.request('PUT', url, requestConfig);\r\n  }\r\n\r\n  /**\r\n   * 发送PATCH请求\r\n   */\r\n  public patch(url: string, body: any, requestConfig: HttpRequestConfig) {\r\n    requestConfig = HttpUtil.appendBodyToRequestConfig(body, requestConfig);\r\n    return this.request('PATCH', url, requestConfig);\r\n  }\r\n\r\n  /**\r\n   * 发送DELETE请求\r\n   */\r\n  public delete(url: string, requestConfig: HttpRequestConfig) {\r\n    return this.request('DELETE', url, requestConfig);\r\n  }\r\n\r\n  /**\r\n   * 发送请求\r\n   */\r\n  request( method: HttpMethod, url: string, requestConfig: HttpRequestConfig): Observable<any> {\r\n    const request$ = of(true).pipe(\r\n      switchMap(() => {\r\n        const axiosRequestConfig = HttpUtil.buildAxiosRequestConfig(method, url, requestConfig);\r\n        return from(this.axiosInstance.request(axiosRequestConfig));\r\n      })\r\n    );\r\n    return request$.pipe(\r\n      map((axiosResponse: AxiosResponse) => {\r\n        const httpResponse = HttpUtil.buildHttpResponse(axiosResponse);\r\n        return requestConfig.observe === 'response' ? httpResponse : axiosResponse.data;\r\n      })\r\n    );\r\n  }\r\n\r\n}\r\n\r\nexport { HttpClient };\r\n","export * from './types';\r\nexport * from './http-util';\r\nexport * from './http-client';\r\n\r\nimport { StaticProvider } from '../core/index';\r\nimport { HttpClient } from './http-client';\r\n\r\nconst HTTP_PROVIDERS: StaticProvider[] = [\r\n  { provide: HttpClient, useClass: HttpClient, deps: [] }\r\n];\r\n\r\nexport { HTTP_PROVIDERS };\r\n\r\n\r\n","/*\r\n * @Author: Lucus, Witt\r\n * @Date: 2018-10-30 15:53:59\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2018-11-08 17:25:08\r\n */\r\n\r\nimport { Modification, ModifyType } from './types';\r\n\r\nfunction isEqual(value: any, other: any) {\r\n  return JSON.stringify(value) ===  JSON.stringify(other);\r\n}\r\n\r\n/**\r\n * 实体数据变更集\r\n */\r\nclass ChangeSet {\r\n\r\n  /**\r\n   * 变更集合\r\n   */\r\n  protected modifications: Modification[] = [];\r\n\r\n  /**\r\n   *  获取所有的变更记录\r\n   */\r\n  public get changes(): Modification[] {\r\n      return this.modifications;\r\n  }\r\n\r\n  /**\r\n   * 将变更集添加到集合中\r\n   * ### 使用示例\r\n   * ```\r\n   * const changeSet = new ChangeSet();\r\n   * const modify = new Modification('newValue', ModifyType.ValueChange, [1, 'title'], 'oldValue');\r\n   * changeSet.append(modify)\r\n   * ```\r\n   * @param changeItem 变更数据\r\n   */\r\n  public append(modification: Modification) {\r\n    switch (modification.type) {\r\n      case ModifyType.ValueChange:\r\n        this.appendValueChangeModification(modification);\r\n          break;\r\n       case ModifyType.Add:\r\n        this.appendAddModification(modification);\r\n          break;\r\n      case ModifyType.Remove:\r\n        this.appendRemoveModification(modification);\r\n        break;\r\n      case ModifyType.Load:\r\n        break;\r\n      default:\r\n        throw new Error('不支持此类型的变更');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 添加值变化变更\r\n   */\r\n  private appendValueChangeModification(modification: Modification) {\r\n    const value = modification.value;\r\n\r\n    const existedModification = this.findModifyItemsPath(modification.path);\r\n    if (existedModification) {\r\n\r\n      // 如果存在相同路径的ValueChange类型的变更集，则更新值；\r\n      existedModification.value = value;\r\n    } else {\r\n        const existedAddModification = this.findNewAddItemsPath(modification.path);\r\n        if (existedAddModification) {\r\n\r\n          // @todo：\r\n          // 1、此处逻辑有问题，value是个字符串，不能直接assign；\r\n          // 2、之所以没有出现问题，是因为都是服务器端新增，新增后，客户端清空了所有变更。\r\n          // 如果存在涵盖该ValueChange变更的Add变更，则更新Add变更对应的数据；\r\n          existedAddModification.value = Object.assign({}, existedAddModification.value, value);\r\n        } else {\r\n\r\n          // 其他情况，新增一条ValueChange变更。\r\n          this.modifications.push(modification);\r\n        }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 添加新增变更\r\n   */\r\n  private appendAddModification(modification: Modification) {\r\n    const value = modification.value;\r\n\r\n    const existedModification = this.findNewAddItemsPath(modification.path);\r\n    if (existedModification) {\r\n\r\n      // 1、如果已经存在相同路径的Add变更，则合并Value。\r\n      existedModification.value = existedModification.value.concat(value);\r\n    } else {\r\n\r\n      // 2、如果没有，则新增一条Add变更。\r\n      this.modifications.push(modification);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 添加删除变更\r\n   */\r\n  private appendRemoveModification(modification: Modification) {\r\n\r\n    const path = modification.path;\r\n    const primaryKey = Object.keys(modification.value)[0];\r\n    const primaryKeyValue = modification.value[primaryKey];\r\n\r\n    // 1、存在相同path的新增变更，移除新增变更，不需要添加删除变更；\r\n    // @todo：待重构（1、只考虑了主从情况，2、临时用多重循环实现）\r\n    this.modifications.forEach((addModification: Modification) => {\r\n\r\n      // 只处理新增变更\r\n      if (addModification.type !== ModifyType.Add) {\r\n        return;\r\n      }\r\n\r\n      // @todo 只考虑主从结构，再深的层次暂不考虑\r\n      if (isEqual(addModification.path, path) === false) {\r\n        return;\r\n      }\r\n\r\n      // 遍历新增新增变更的value（value是个数组），移除相匹配的新增删除\r\n      addModification.value = addModification.value.filter((addDataItem: any) => {\r\n        return addDataItem[primaryKey] !== primaryKeyValue;\r\n      });\r\n    });\r\n\r\n    // 2、移除对应的修改变更\r\n    const fullRemovePath = path.concat(`${primaryKey}:${primaryKeyValue}`);\r\n    this.modifications = this.modifications.filter((valueModification: Modification) => {\r\n      if (valueModification.type !== ModifyType.ValueChange) {\r\n        return true;\r\n      }\r\n      const valueChangePath = Array.from(valueModification.path);\r\n      valueChangePath.pop();\r\n\r\n      // 路径相同进行移除\r\n      const isToRemove = isEqual(valueChangePath, fullRemovePath);\r\n      return !isToRemove;\r\n    });\r\n\r\n    // 先删除下级删除变更，再插入\r\n    // 主要针对从从表删除之后，又删除子表时，根实体上还存在从从表删除变更的场景\r\n    this.removeDescendantRemoveModifications(modification);\r\n    this.modifications.push(modification);\r\n  }\r\n\r\n  /**\r\n   * 清空变更集合\r\n   */\r\n  public clear() {\r\n    this.modifications = [];\r\n  }\r\n\r\n\r\n  /**\r\n   * 根据path获取Add类型的变更记录\r\n   * @param path 变更路径\r\n   */\r\n  private findNewAddItemsPath(path: any[]) {\r\n      return this.modifications.find((value, index) => {\r\n          return isEqual(path, value.path) && value.type === ModifyType.Add;\r\n      });\r\n  }\r\n\r\n  /**\r\n   * 根据path获取ValueChange类型的变更记录\r\n   * @param path 变更路径\r\n   */\r\n  private findModifyItemsPath(path: any[]) {\r\n    return this.modifications.find((value, index) => {\r\n      return isEqual(path, value.path) && value.type === ModifyType.ValueChange;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 删除后代（包括自己）所有的删除变更\r\n   * @todo：临时做一个最小化修改\r\n   */\r\n  private removeDescendantRemoveModifications(parentRemoveModification: Modification): void {\r\n\r\n    const parentPathWithId = this.createRemovePathWithId(parentRemoveModification);\r\n\r\n    // 删除后代修改变更\r\n    this.modifications = this.modifications.filter((modification: Modification) => {\r\n      if (modification.type !== ModifyType.Remove) {\r\n        return true;\r\n      }\r\n      const descendantPathWithId = this.createRemovePathWithId(modification);\r\n      const isDescendant =  this.isDescendantPath(parentPathWithId, descendantPathWithId);\r\n      return !isDescendant;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 获取删除路径的完整格式\r\n   * @summary\r\n   * 1、目前删除变更的路径标记到父集合；\r\n   * 2、为了方便比较，将被删除的数据id加入到路径中\r\n   */\r\n  private createRemovePathWithId(modification: Modification) {\r\n    const path = modification.path;\r\n    const primaryKey = Object.keys(modification.value)[0];\r\n    const primaryKeyValue = modification.value[primaryKey];\r\n    const pathWithId = path.concat([`${primaryKey}:${primaryKeyValue}`]);\r\n    return pathWithId;\r\n  }\r\n\r\n  /**\r\n   * 判断是否是后代节点路径\r\n   * @param parentPath 父节点路径\r\n   * @param descendantPath 后代节点\r\n   */\r\n  private isDescendantPath(parentPath: string[], descendantPath: string[]) {\r\n    if (parentPath.length > descendantPath.length) {\r\n      return false;\r\n    }\r\n\r\n    let isDescendantPath = true;\r\n    parentPath.forEach((parentPathItem: string, parentPathItemIndex: number) => {\r\n      if (parentPathItem !== descendantPath[parentPathItemIndex]) {\r\n        isDescendantPath = false;\r\n        return;\r\n      }\r\n    });\r\n\r\n    return isDescendantPath;\r\n  }\r\n\r\n}\r\n\r\nexport { ChangeSet };\r\n\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-12-27 09:25:38\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2018-12-27 09:39:10\r\n */\r\n\r\n\r\n/**\r\n * 路径类型\r\n */\r\nenum DataPathNodeType {\r\n\r\n  /**\r\n   * 标记该节点是一个实体主键值，用来在列表上定位一个实体\r\n   */\r\n  DataId   = 'DataId',\r\n\r\n  /**\r\n   * 标记该节点是一个属性名，用来在对象上定位一个属性\r\n   */\r\n  PropName = 'PropName',\r\n}\r\n\r\n\r\n/**\r\n * 路径节点\r\n */\r\nclass DataPathNode {\r\n\r\n  /**\r\n   * 上一节点\r\n   */\r\n  prev: DataPathNode;\r\n\r\n  /**\r\n   * 下一节点\r\n   */\r\n  next: DataPathNode;\r\n\r\n  /**\r\n   * 节点类型\r\n   */\r\n  type: DataPathNodeType;\r\n\r\n  /**\r\n   * 路径数据\r\n   * 对于List类型：  value是主键值，用于指明具体是哪一行；\r\n   * 对于Object类型：value是属性名，用于指明具体哪一属性。\r\n   */\r\n  value: any;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(type: DataPathNodeType, data: any) {\r\n    this.type = type;\r\n    this.value = data;\r\n\r\n    this.prev = null;\r\n    this.next = null;\r\n  }\r\n}\r\n\r\n\r\nexport { DataPathNodeType, DataPathNode };\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2019-08-14 14:11:51\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2019-08-14 16:11:51\r\n */\r\n\r\nimport { DataTypeInfo } from './data_type_info';\r\n\r\n\r\n/**\r\n * 实体属性分组\r\n */\r\nenum DataPropGroup {\r\n\r\n  /**\r\n   * 简单类型\r\n   */\r\n  Primitive = 'Primitive',\r\n\r\n  /**\r\n   * 实体类型\r\n   */\r\n  Object = 'Object',\r\n\r\n  /**\r\n   * 动态实体类型\r\n   */\r\n  Dynamic = 'Dynamic',\r\n\r\n  /**\r\n   * 列表类型\r\n   */\r\n  List = 'List'\r\n\r\n}\r\n\r\n\r\n/**\r\n * 实体属性信息\r\n */\r\nclass DataPropInfo {\r\n\r\n  /**\r\n   * 属性类型\r\n   */\r\n  public group: DataPropGroup;\r\n\r\n  /**\r\n   * 属性名称\r\n   */\r\n  public name: string;\r\n\r\n  /**\r\n   * 影射名称\r\n   */\r\n  public mapping: string;\r\n\r\n  /**\r\n   * 属性类型描述\r\n   */\r\n  public typeInfo: DataTypeInfo;\r\n\r\n  /**\r\n   * 元数据信息\r\n   * @todo\r\n   * 1、EntityPropInfo不应该认识元数据描述，不能强识别元数据上的属性；\r\n   * 2、将来元数据可能有多套，每一套有自己的解析 元数据解析框架还没有做，所以临时处理，不对暴露\r\n   */\r\n  public metadataInfo?: any;\r\n}\r\n\r\nexport {DataPropGroup, DataPropInfo };\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-12-27 09:26:41\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2019-01-15 22:00:45\r\n */\r\n\r\nimport { DataPathNode, DataPathNodeType } from './data_path_node';\r\n/**\r\n * 变更路径（简单双向列表）\r\n */\r\nclass DataPath {\r\n\r\n  /**\r\n   * 头节点\r\n   */\r\n  public head: DataPathNode;\r\n\r\n  /**\r\n   * 长度\r\n   */\r\n  public length: number;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n    this.head = new DataPathNode(null, null);\r\n    this.length = 0;\r\n  }\r\n\r\n  /**\r\n   * 添加一个节点到头部\r\n   */\r\n  public unshift(type: DataPathNodeType, data: any) {\r\n    const newNode = new DataPathNode(type, data);\r\n    newNode.next = this.head.next;\r\n    newNode.prev = this.head;\r\n\r\n    this.head.next = newNode;\r\n    if (newNode.next) {\r\n      newNode.next.prev = newNode;\r\n    }\r\n\r\n    this.length++;\r\n  }\r\n\r\n  /**\r\n   * 在链表最后追加一个节点\r\n   */\r\n  public push(type: DataPathNodeType, data: any) {\r\n    const tailNode = this.getTail();\r\n    const newNode = new DataPathNode(type, data);\r\n    tailNode.next = newNode;\r\n    this.length++;\r\n  }\r\n\r\n  /**\r\n   * 获取链表尾部节点\r\n   */\r\n  public getTail(): DataPathNode {\r\n    let lastNode = this.head;\r\n    while (lastNode.next) {\r\n      lastNode = lastNode.next;\r\n    }\r\n    return lastNode;\r\n  }\r\n\r\n  /**\r\n   * 转换为数组格式\r\n   */\r\n  public toArray() {\r\n    const pathArray = [];\r\n    let currentNode = this.head.next;\r\n    while (currentNode) {\r\n      pathArray.push(`${currentNode.type}:${currentNode.value}`) ;\r\n      currentNode = currentNode.next;\r\n    }\r\n    return pathArray;\r\n  }\r\n\r\n  /**\r\n   * 转换为字符串格式\r\n   */\r\n  public toString() {\r\n    const pathArray = this.toArray();\r\n    const pathString = pathArray.join(', ');\r\n    return `[${pathString}]`;\r\n  }\r\n\r\n  /**\r\n   * 拷贝\r\n   */\r\n  public clone(): DataPath {\r\n    const newDataPath = new DataPath();\r\n    let curDataNode = this.head.next;\r\n    while (curDataNode) {\r\n      newDataPath.push(curDataNode.type, curDataNode.value);\r\n      curDataNode = curDataNode.next;\r\n    }\r\n    return newDataPath;\r\n  }\r\n}\r\n\r\nexport { DataPath };\r\n","import 'reflect-metadata';\r\nimport { makePropDecorator } from '../../core/index';\r\nimport { ClassType } from '../types';\r\nimport { PropMetadata } from './prop_meatadata';\r\n\r\n/**\r\n * 简单属性元数据\r\n */\r\nexport interface PrimitivePropMetadata extends PropMetadata {\r\n\r\n  /**\r\n   * 属性名称\r\n   */\r\n  property?: string;\r\n\r\n  /**\r\n   * 字段名称\r\n   */\r\n  dataField?: string;\r\n\r\n  /**\r\n   * 原始字段名称\r\n   */\r\n  originalDataField?: string;\r\n\r\n  /**\r\n   * 原始字段类型\r\n   */\r\n  originalDataFieldType?: string;\r\n\r\n  /**\r\n   * 是否为主键\r\n   */\r\n  primary?: boolean;\r\n\r\n  /**\r\n   * 是否为外键\r\n   */\r\n  foreign?: boolean;\r\n\r\n  /**\r\n   * 默认值\r\n   */\r\n  defaultValue?: any;\r\n\r\n  /**\r\n   * 验证规则\r\n   */\r\n  validRules?: any[];\r\n\r\n  /**\r\n   * 初始值，用于字段清空后\r\n   */\r\n  initValue?: any;\r\n\r\n  /**\r\n   * 启用多语录入\r\n   */\r\n  enableMultiLangInput?: boolean;\r\n}\r\n\r\n\r\n/**\r\n * 元数据名称\r\n */\r\nexport const PRIMITIVE_PROP_META = 'PrimitivePropMeta';\r\n\r\n\r\n/**\r\n * 【简单属性装饰器工厂】接口\r\n * @summary\r\n * 类型可以为：NgFieldProperty、string、ClassType\r\n * 当为string 时，则设其映射字段；\r\n * 当为ClassType时，则设置集合中的记录类型\r\n */\r\nexport interface PrimitivePropMetaDecorator {\r\n\r\n  (obj: PrimitivePropMetadata | string | ClassType): any;\r\n\r\n  (obj?: PrimitivePropMetadata | string | boolean): any;\r\n\r\n  new(obj?: PrimitivePropMetadata | string | boolean): any;\r\n}\r\n\r\n\r\n/**\r\n * 【简单属性装饰器工厂】的工厂\r\n */\r\nfunction makePrimitivePropMetaDecorator(options?: PrimitivePropMetadata | string | boolean): any {\r\n\r\n  let metadata: PrimitivePropMetadata = {\r\n    primary: false,\r\n    foreign: false\r\n  };\r\n\r\n  if (options) {\r\n    const paramType = typeof options;\r\n    switch (paramType) {\r\n      case 'boolean':\r\n        metadata.primary = Boolean(options);\r\n        break;\r\n      case 'string':\r\n        metadata.dataField = String(options);\r\n        break;\r\n      case 'object':\r\n        metadata = Object.assign(metadata, options);\r\n        break;\r\n    }\r\n  }\r\n  return metadata;\r\n}\r\n\r\n\r\n/**\r\n * 简单属性装饰器工厂\r\n */\r\nexport const PrimitivePropMeta: PrimitivePropMetaDecorator = makePropDecorator(PRIMITIVE_PROP_META, makePrimitivePropMetaDecorator);\r\n","class StringUtil {\r\n\r\n  /**\r\n     * 字符串格式化\r\n     */\r\n  public static format(value, options) {\r\n    return value.toString();\r\n  }\r\n\r\n\r\n}\r\n\r\nexport { StringUtil };\r\n","class NumberUtil {\r\n\r\n  /**\r\n     * 数字格式化\r\n     * {\r\n     *   precision: 2,\r\n     *   decimal: true,\r\n     *   thousand: ','\r\n     *   prefix: '',\r\n     *   suffix: ''\r\n     * }\r\n     */\r\n  public static format(value, options) {\r\n\r\n    // 参数处理\r\n    let decimals = (options.precision || options.precision === 0) ? options.precision : 2;\r\n    let decimalPoint = options.decimal || '.';\r\n    let thousandsSep = options.thousand || '';\r\n    let prefix = options.prefix || '';\r\n    let suffix = options.suffix || '';\r\n\r\n    let prefixType = options.prefixType;\r\n    if (prefixType == \"dynamic\" && options.prefix) {\r\n      // 表示前缀为一个函数  那么执行函数定义\r\n      let prefixFunc = new Function(\"return \" + options.prefix);\r\n      prefix = prefixFunc()(options.sourceData);\r\n    }\r\n\r\n    value = (value + '').replace(/[^0-9+-Ee.]/g, '');\r\n    let s;\r\n\r\n    // 处理精度\r\n    let toFixedFix = function (n, prec) {\r\n      var k = Math.pow(10, prec);\r\n      return '' + parseFloat(Math.round(parseFloat((n * k).toFixed(prec * 2))).toFixed(prec * 2)) / k;\r\n    };\r\n    s = ((decimals || decimals === 0) ? toFixedFix(value, decimals) : '' + Math.round(value)).split('.');\r\n\r\n    // 处理千分位\r\n    if (thousandsSep) {\r\n      let pattern = /(-?\\d+)(\\d{3})/;\r\n      while (pattern.test(s[0])) {\r\n        s[0] = s[0].replace(pattern, \"$1\" + thousandsSep + \"$2\");\r\n      }\r\n      if ((s[1] || '').length < decimals) {\r\n        s[1] = s[1] || '';\r\n        s[1] += new Array(decimals - s[1].length + 1).join('0');\r\n      }\r\n    }\r\n\r\n    let formatedValue = s.join(decimalPoint);\r\n    formatedValue = `${prefix}${formatedValue}${suffix}`;\r\n    return formatedValue;\r\n  }\r\n\r\n}\r\n\r\nexport { NumberUtil };","/**\r\n * 布尔工具类\r\n */\r\nclass BoolUtil {\r\n  \r\n  /**\r\n   * 布尔值格式化\r\n  */\r\n  public static  format(value, options) {\r\n    if (value === true) {\r\n      return '是';\r\n    } else {\r\n      return '否';\r\n    }\r\n  }\r\n}\r\n\r\nexport { BoolUtil };\r\n\r\n\r\n","class EnumUtil {\r\n\r\n  /**\r\n   * 枚举格式化\r\n   * {\r\n   *  enumData: [\r\n   *    {value: 'value1', name: 'name1'},\r\n   *    {value: 'value2', name: 'name2'}\r\n   *  ]\r\n   * }\r\n   */\r\n  static format(value, options) {\r\n    const enumOptions = options.enumData;\r\n    const targetEnumOption = enumOptions.find((enumOption) => {\r\n      return enumOption.value === value;\r\n    });\r\n\r\n    if (!targetEnumOption) {\r\n      console.error(`找不到${value}对应的枚举选项`);\r\n      return value;\r\n    }\r\n\r\n    return targetEnumOption.name;\r\n  }\r\n}\r\n\r\nexport { EnumUtil };\r\n\r\n","import { format, isDate, parseISO, isEqual, compareAsc } from 'date-fns';\r\nimport dayjs from 'dayjs';\r\nimport IsBetween from 'dayjs/plugin/IsBetween';\r\nimport relativeTime from 'dayjs/plugin/relativeTime';\r\nimport Calendar from 'dayjs/plugin/calendar';\r\nimport 'dayjs/locale/zh-cn';\r\ndayjs.locale('zh-cn');\r\n/**\r\n * 日期处理类\r\n */\r\nclass DateUtil {\r\n\r\n  /**\r\n   * 空日期字符串（N版）\r\n   * @todo：兼容服务器端，不应该在devkit体现这种兼容，待移除\r\n   */\r\n  // static emptyDateTimeString = '0001-01-01T00:00:00';\r\n  static emptyDateTimeString = null;\r\n\r\n  /**\r\n   * 默认空日期字符串（ISO标准格式）\r\n   */\r\n  // static emptyISODateTimeString = '0001-01-01T00:00:00+00:00';\r\n  static emptyISODateTimeString = null;\r\n\r\n  /**\r\n   * 默认日期听格式\r\n   */\r\n  static defaultISOFormat = `yyyy-MM-dd'T'HH:mm:ssxxx`;\r\n\r\n  static defaultDisplayFormat = 'yyyy-MM-dd HH:mm:ss';\r\n\r\n  static defaultDateFormat = 'yyyy-MM-dd';\r\n\r\n  static defaultTimeFormat = 'HH:mm:ss';\r\n\r\n  /**\r\n   * 将日期（或日期字符串）转换为完整的的ISO格式的字符串\r\n   */\r\n  static formatISO(dateOrDateString: string | Date): string {\r\n    if (this.isEmptyDateOrDateString(dateOrDateString) === true) {\r\n      return this.emptyISODateTimeString;\r\n    }\r\n    const dateObj = this.parse(dateOrDateString);\r\n    return format(dateObj, this.defaultISOFormat);\r\n  }\r\n\r\n  /**\r\n   * 将日期（或日期字符串）转换为指定格式的字符串\r\n   * @param dateOrDateString 日期对象或符合ISO8601规范的日期字符串\r\n   * @param dateFormat 日期格式字符串\r\n   */\r\n  static format(dateOrDateString: string | Date, dateFormat?: string): string {\r\n    if (this.isEmptyDateOrDateString(dateOrDateString) === true) {\r\n      return this.emptyISODateTimeString;\r\n    }\r\n    const dateObj = this.parse(dateOrDateString);\r\n    dateFormat = dateFormat ? dateFormat : this.defaultDisplayFormat;\r\n    return format(dateObj, dateFormat);\r\n  }\r\n\r\n  static dateShow(dateOrDateString: string | Date, type: string) {\r\n    if (this.isEmptyDateOrDateString(dateOrDateString) === true) {\r\n      return this.emptyISODateTimeString;\r\n    }\r\n    if (!type || \"\" === type) {\r\n      return;\r\n    }\r\n    return this[type] && this[type](dateOrDateString)\r\n  }\r\n\r\n  static dateOperation(dateOrDateString: string | Date, options) {\r\n    if (this.isEmptyDateOrDateString(dateOrDateString) === true) {\r\n      return this.emptyISODateTimeString;\r\n    }\r\n    const { type = \"\", option } = options;\r\n    if (!type || \"\" === type) {\r\n      return;\r\n    }\r\n    if ('isSame' === type) {\r\n      return this[type] && this[type](dateOrDateString, options['targetDate'], options['granularity'])\r\n    }\r\n    if ('isBefore' === type) {\r\n      return this[type] && this[type](dateOrDateString, options['targetDate'], options['granularity'])\r\n    }\r\n    if ('isAfter' === type) {\r\n      return this[type] && this[type](dateOrDateString, options['targetDate'], options['granularity'])\r\n    }\r\n    if ('isBetween' === type ) {\r\n      return this[type] && this[type](dateOrDateString, options['targetDate'], options['targetDate2'], options['granularity'], options['contains'])\r\n    }\r\n    if (!option) {\r\n      return this[type] && this[type](dateOrDateString)\r\n    }\r\n    return this[type] && this[type](dateOrDateString, option)\r\n  }\r\n\r\n\r\n\r\n  static relativeTime(dateOrDateString: string | Date, option) {\r\n    dayjs.extend(relativeTime)\r\n    const dateObj = dayjs(dateOrDateString);\r\n    if (!option) {\r\n      return dayjs(dateObj).fromNow()\r\n    }\r\n    return dayjs(dateObj).fromNow(option)\r\n  }\r\n\r\n  static isToday(dateOrDateString: string | Date) {\r\n    const todayDate = new Date();\r\n    const dateObj = dayjs(dateOrDateString);\r\n    return this.isSame(dateObj, todayDate, 'date');\r\n  }\r\n\r\n  static calendar(dateOrDateString: string | Date, option) {\r\n    const dateObj = dayjs(dateOrDateString);\r\n    dayjs.extend(Calendar)\r\n    if (option) {\r\n      return dayjs().calendar(dateObj, { ...option })\r\n    }\r\n    return dayjs().calendar(dateObj, {\r\n      sameDay: '[今天] HH:mm',\r\n      nextDay: '[明天] HH:mm',\r\n      lastDay: '[昨天] HH:mm',\r\n      sameElse: 'YYYY-MM-DD'\r\n    })\r\n  }\r\n\r\n\r\n  /**\r\n   * 创建日期\r\n   * @param dateOrDateString 日期对象或符合ISO8601规范的日期字符串\r\n   */\r\n  static parse(dateOrDateString: string | Date): Date {\r\n    if (this.isEmptyDateOrDateString(dateOrDateString) === true) {\r\n      return null;\r\n    }\r\n\r\n    if (this.isDate(dateOrDateString) === true) {\r\n      return dateOrDateString as Date;\r\n    }\r\n\r\n    return parseISO(dateOrDateString as string);\r\n  }\r\n\r\n  /**\r\n   * 是否是日期对象\r\n   */\r\n  static isDate(date: any): boolean {\r\n    return isDate(date);\r\n  }\r\n\r\n  /**\r\n   * 是否是空日期或者空日期字符串\r\n   * @param dateOrDateString 日期或日期字符串\r\n   */\r\n  static isEmptyDateOrDateString(dateOrDateString: string | Date) {\r\n    if (this.isDate(dateOrDateString) === true) {\r\n      return this.isEmptyDate(dateOrDateString as Date);\r\n    }\r\n    return this.isEmptyDateString(dateOrDateString as string);\r\n  }\r\n\r\n  /**\r\n   * 是否为空日期字符串\r\n   * @param date 日期对象\r\n   */\r\n  static isEmptyDate(date: Date) {\r\n    if (!date) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * 是否是空日期字符串\r\n   * @param dateString 日期字符串\r\n   */\r\n  static isEmptyDateString(dateString: string) {\r\n    if (!dateString || dateString.startsWith('0001-01-01') === true) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * 两个日期是否相等\r\n   * @param dateOrDateString1 日期对象或字符串\r\n   * @param dateOrDateString1 日期对象或字符串\r\n   * @return 相等返回true，否则返回false\r\n   */\r\n  static isEqual(dateOrDateString1: string | Date, dateOrDateString2: string | Date): boolean {\r\n    const dateObj1 = this.parse(dateOrDateString1);\r\n    const dateObj2 = this.parse(dateOrDateString2);\r\n    if (dateObj1 === dateObj2) {\r\n      return true;\r\n    }\r\n    return isEqual(dateObj1, dateObj2);\r\n  }\r\n\r\n  /**\r\n   * 两个日期是否相等\r\n   * @param dateOrDateString1 日期对象或字符串\r\n   * @param dateOrDateString1 日期对象或字符串\r\n   * @return 返回-1、0、1\r\n   */\r\n  static compare(dateOrDateString1: string | Date, dateOrDateString2: string | Date) {\r\n    const dateObj1 = this.parse(dateOrDateString1);\r\n    const dateObj2 = this.parse(dateOrDateString2);\r\n    if (this.isEqual(dateObj1, dateObj2) === true) {\r\n      return 0;\r\n    }\r\n\r\n    // 处理解析后为null的场景，null比所有有效日期小\r\n    if (!dateObj1 && this.isDate(dateObj2) === true) {\r\n      return -1;\r\n    }\r\n    if (!dateObj2 && this.isDate(dateObj1) === true) {\r\n      return 1;\r\n    }\r\n\r\n    return compareAsc(dateObj1, dateObj2);\r\n  }\r\n\r\n\r\n  /**\r\n   * \r\n   * @param currentDate 当前日期\r\n   * @param targetDate 目标日期\r\n   * @param type 比较类型 date\tD\t天00:00 day\td\t星期00:00 month\tM\t月第一天00:00 year\ty\t1月1日00点 week\tw\t周第一天00:00hour\th\t00:00:00minute\tm\t00:00second\ts\t00millisecond\tms\t0\r\n   * @returns \r\n   */\r\n  static isSame(currentDate, targetDate, type?) {\r\n    if (type) {\r\n      return dayjs(currentDate).isSame(dayjs(targetDate), type)\r\n    }\r\n    return dayjs(currentDate).isSame(dayjs(targetDate));\r\n  }\r\n\r\n  /**\r\n   * \r\n   * @param currentDate 当前日期\r\n   * @param targetDate 目标日期\r\n   * @returns boolean\r\n   */\r\n  static isBefore(currentDate, targetDate, type?) {\r\n    if (type) {\r\n      return dayjs(currentDate).isBefore(dayjs(targetDate), type)\r\n    }\r\n    return dayjs(currentDate).isBefore(dayjs(targetDate));\r\n  }\r\n\r\n  /**\r\n * \r\n * @param currentDate 当前日期\r\n * @param targetDate 目标日期\r\n * @returns boolean\r\n */\r\n  static isAfter(currentDate, targetDate, type?) {\r\n    if (type) {\r\n      return dayjs(currentDate).isAfter(dayjs(targetDate), type)\r\n    }\r\n    return dayjs(currentDate).isAfter(dayjs(targetDate));\r\n  }\r\n\r\n\r\n  /**\r\n   * \r\n   * @param currentDate \r\n   * @param targetDate1 \r\n   * @param targetDate2 \r\n   * @returns \r\n   */\r\n  static isBetween(currentDate, targetDate1, targetDate2, type, contains) {\r\n    dayjs.extend(IsBetween)\r\n    if (type) {\r\n      return dayjs(currentDate).isBetween(dayjs(targetDate1), dayjs(targetDate2), type, contains);\r\n    }\r\n    return dayjs(currentDate).isBetween(dayjs(targetDate1), dayjs(targetDate2), null, contains);\r\n  }\r\n}\r\n\r\nexport { DateUtil };\r\n\r\n","/**\r\n * 变更相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\n/**\r\n * 绑定数据变更\r\n */\r\nexport interface Change {\r\n\r\n  /**\r\n   * 变更类型\r\n   */\r\n  type: ChangeType;\r\n\r\n  /**\r\n   * 变更路径\r\n   */\r\n  path: string[];\r\n\r\n  /**\r\n   * 变更后的值\r\n   */\r\n  value?: any;\r\n\r\n  /**\r\n   * 变更前的值\r\n   */\r\n  preValue?: any;\r\n\r\n  /**\r\n   * 错误信息\r\n   */\r\n  errors?: any;\r\n\r\n  /**\r\n   * 验证后回调，会将验证结果传入\r\n   */\r\n  cb?: Function;\r\n\r\n  /**\r\n   * 是否提交过，为true时开启输入时验证\r\n   */\r\n  isSubmitted?: boolean;\r\n\r\n  /**\r\n   * 在grid中使用，如果存在id，则将errors在form中以\r\n   * {\r\n   *  [id]: errors\r\n   * }\r\n   * 的形式保存一份\r\n   */\r\n  id?: string;\r\n\r\n  isUdt?: boolean;\r\n\r\n  isGrid?: boolean;\r\n}\r\n\r\n/**\r\n * 绑定数据变更类型\r\n */\r\nexport enum ChangeType {\r\n  Load = 'Load',\r\n  Append = 'Append',\r\n  Remove = 'Remove',\r\n  SelectionChanged = 'SelectionChanged',\r\n  ValueChanged = 'ValueChanged',\r\n  UpdateErrors = 'UpdateErrors',\r\n  GlobalSelectionChanged = 'GlobalSelectionChanged',\r\n  /**\r\n   * 分页信息变化\r\n   */\r\n  PaginationInfoChange = 'PaginationInfoChange',\r\n}\r\n\r\n/**\r\n * 视图变更\r\n */\r\nexport interface ViewChange {\r\n  type: ViewChangeType;\r\n  path: string[];\r\n  value: any;\r\n  preValue?: any;\r\n}\r\n\r\n/**\r\n * 视图变更类型\r\n */\r\nexport enum ViewChangeType {\r\n  ValueChanged\r\n}\r\n\r\n/**\r\n * Form值变化事件\r\n */\r\nexport interface FormValueChange {\r\n  path: string[]; // 字段路径\r\n  value: any; // 新值\r\n  preValue?: any; // 旧值\r\n  command: string; // 监听命令\r\n  entityChanged: boolean; // 实体是否已改变\r\n}\r\n\r\n/**\r\n * 实体值变化事件\r\n */\r\nexport interface EntityValueChange {\r\n  paths: string[]; // 字段路径\r\n  value: any; // 新值\r\n  preValue?: any; // 旧值\r\n  changed: boolean; // 实体是否已改变\r\n}","/**\r\n * 绑定属性相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\n/**\r\n * 属性类型\r\n */\r\nexport enum BindingPropertyType {\r\n\r\n  /**\r\n   * 简单类型\r\n   */\r\n  Plain  = 'Plain',\r\n\r\n  /**\r\n   * 对象类型\r\n   */\r\n  Object = 'Object',\r\n\r\n  /**\r\n   * 列表类型\r\n   */\r\n  List   = 'List',\r\n\r\n  /**\r\n   * 动态类型\r\n   */\r\n  Dynamic = 'Dynamic'\r\n}\r\n\r\n\r\n/**\r\n * 绑定属性\r\n */\r\nexport interface BindingProperty {\r\n\r\n  /**\r\n   * 属性名称\r\n   */\r\n  name: string;\r\n\r\n  /**\r\n   * 属性类型\r\n   */\r\n  type: BindingPropertyType;\r\n\r\n  /**\r\n   * 对应实体类型，当属性类型为Object、List类型时，设置该属性。\r\n   */\r\n  entityType?: any;\r\n\r\n  /**\r\n   * 是否为主键\r\n   */\r\n  isPrimaryKey?: boolean;\r\n\r\n  /**\r\n   * 启用多语录入\r\n   */\r\n  enableMultiLangInput?: boolean;\r\n\r\n}\r\n","class ArrayUtil {\r\n\r\n  /**\r\n   * 从数组中删除一项\r\n   */\r\n  public static remove(arr: any[], itemToRemove: any): void {\r\n    const indexToRemove = arr.findIndex((item: any) => {\r\n      return item === itemToRemove;\r\n    });\r\n    this.removeByIndex(arr, indexToRemove);\r\n  }\r\n  \r\n  /**\r\n   * 从数组中删除indexToRemove对应的项\r\n   * @param index \r\n   */\r\n  public static removeByIndex(arr: any[], indexToRemove: number) {\r\n    if (!arr || arr[indexToRemove] !== undefined) {\r\n      \r\n    }\r\n    arr.splice(indexToRemove, 1);\r\n  }\r\n\r\n\r\n}\r\n\r\nexport { ArrayUtil };","class ObjectUtil {\r\n\r\n  /**\r\n   * 检查是否是简单对象\r\n   */\r\n  public static isPlainObject(value): boolean {\r\n    if (!(typeof value === 'object' && value !== null) || Object.prototype.toString.call({}) !== '[object Object]') {\r\n      return false;\r\n    }\r\n    if (Object.getPrototypeOf(value) === null) {\r\n      return true;\r\n    }\r\n    let proto = value;\r\n    while (Object.getPrototypeOf(proto) !== null) {\r\n      proto = Object.getPrototypeOf(proto);\r\n    }\r\n    return Object.getPrototypeOf(value) === proto;\r\n  }\r\n}\r\n\r\nexport { ObjectUtil };\r\n","/**\r\n * 数据路径处理\r\n */\r\nclass BindingPathConverter {\r\n\r\n  /**\r\n   * (BindingPathString | BindingPathArray) => BindingPathArray\r\n   * @param bindingPath BindingPath的字符串或者数组格式\r\n   * @return BindingPath数组\r\n   */\r\n  public static toBindingPathArray(bindingPath: string | string[]): string[] {\r\n    let bindingPathArray: string[];\r\n    if (typeof bindingPath === 'string') {\r\n      bindingPathArray = bindingPath.split('/').filter((part: string) => {\r\n        return part !== '';\r\n      });\r\n      return bindingPathArray;\r\n    } else {\r\n      bindingPathArray = bindingPath.concat([]);\r\n    }\r\n\r\n    return bindingPathArray;\r\n  }\r\n\r\n  /**\r\n   * BindingPathArray => BindingPathString\r\n   */\r\n  public static toBindingPathString(bindingPathArray: string[]): string {\r\n    return '/' + bindingPathArray.join('/');\r\n  }\r\n}\r\n\r\nexport { BindingPathConverter };\r\n","import { BindingPathConverter } from './binding_path_converter';\r\n\r\n/**\r\n * BindingPath比较器\r\n */\r\nclass BindingPathComparer {\r\n\r\n  /**\r\n   * 是否相等\r\n   */\r\n  public static isEqual(srcPath: string | string[], dstPath: string | string[]) {\r\n    const srcPathArray = BindingPathConverter.toBindingPathArray(srcPath);\r\n    const dstPathArray = BindingPathConverter.toBindingPathArray(dstPath);\r\n\r\n    const isEqual = srcPathArray.every((srcPathItem: string, srcPathIndex: number) => {\r\n      return srcPathItem === dstPathArray[srcPathIndex];\r\n    });\r\n\r\n    return isEqual;\r\n  }\r\n\r\n  /**\r\n   * 是否是父路径\r\n   */\r\n  public static isParent(childPath: string | string[], parentPath: string | string[]): boolean {\r\n\r\n    const childPathArray  = BindingPathConverter.toBindingPathArray(childPath);\r\n    const parentPathArray = BindingPathConverter.toBindingPathArray(parentPath);\r\n\r\n    // 长度差1个\r\n    if (childPathArray.length !== parentPathArray.length + 1) {\r\n      return;\r\n    }\r\n\r\n    return this.isAncestor(childPath, parentPath);\r\n  }\r\n\r\n  /**\r\n   * 是否是祖先路径\r\n   */\r\n  public static isAncestor(descendantPath: string | string[], ancestorPath: string | string[]): boolean {\r\n    const descendantPathArray = BindingPathConverter.toBindingPathArray(descendantPath);\r\n    const ancestorPathArray   = BindingPathConverter.toBindingPathArray(ancestorPath);\r\n\r\n    if (descendantPath.length <= ancestorPathArray.length) {\r\n      return false;\r\n    }\r\n\r\n    const isAncestor = ancestorPathArray.every((ancestorPathItem: string, ancestorPathIndex: number) => {\r\n      return ancestorPathItem === descendantPathArray[ancestorPathIndex];\r\n    });\r\n\r\n    return isAncestor;\r\n  }\r\n\r\n}\r\n\r\nexport { BindingPathComparer };\r\n","import { BindingPathConverter } from './binding_path_converter';\r\n\r\n/**\r\n * BindingPath遍历器\r\n */\r\nclass BindingPathTraverser {\r\n\r\n  /**\r\n   * 获取叶子节点的Path\r\n   */\r\n  public static getLeafPathString(bindingPath: string | string[]): string {\r\n    const bindingPathArray = BindingPathConverter.toBindingPathArray(bindingPath);\r\n    return bindingPathArray.pop();\r\n  }\r\n\r\n  /**\r\n   * 获取父路径\r\n   */\r\n  public static getParentPathString(bindingPath: string | string[]): string {\r\n    const bindingPathArray = BindingPathConverter.toBindingPathArray(bindingPath);\r\n    bindingPathArray.pop();\r\n    return '/' + bindingPathArray.join('/');\r\n  }\r\n}\r\n\r\nexport { BindingPathTraverser };\r\n","import {Type} from '../core/index';\r\nimport { Entity, FieldMetadataUtil } from '../entity/index';\r\nimport { BindingProperty, BindingPropertyType } from './binding_property';\r\n\r\n/**\r\n * 属性工具类\r\n */\r\nclass PropertyUtil {\r\n\r\n  /**\r\n   * 获取实体上的属性集合，并将他们转换成BindingProperty集合\r\n   * @param  entityType 实体类型\r\n   * @returns 绑定属性集合\r\n   */\r\n  static getProperties(entityType: Type<Entity>): BindingProperty[] {\r\n    const properties = [];\r\n\r\n    // Plain\r\n    const ngFieldProperties = FieldMetadataUtil.getNgFields(entityType);\r\n    Object.keys(ngFieldProperties).forEach((propertyName: string) => {\r\n      const ngFieldProperty = ngFieldProperties[propertyName];\r\n      properties.push({\r\n        name: propertyName,\r\n        type: BindingPropertyType.Plain,\r\n        isPrimaryKey: ngFieldProperty.primary,\r\n        isForeignKey: ngFieldProperty.foreign,\r\n        enableMultiLangInput: ngFieldProperty.enableMultiLangInput\r\n      });\r\n    });\r\n\r\n    // Object\r\n    const ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);\r\n    Object.keys(ngObjectProperties).forEach((propertyName: string) => {\r\n      const ngObjectProperty = ngObjectProperties[propertyName];\r\n      properties.push({\r\n        name: propertyName,\r\n        type: BindingPropertyType.Object,\r\n        entityType: ngObjectProperty.type\r\n      });\r\n    });\r\n\r\n    // List\r\n    const ngListProperties = FieldMetadataUtil.getNgList(entityType);\r\n    Object.keys(ngListProperties).forEach((propertyName: string) => {\r\n      const ngListProperty = ngListProperties[propertyName];\r\n      properties.push({\r\n        name: propertyName,\r\n        type: BindingPropertyType.List,\r\n        entityType: ngListProperty.type\r\n      });\r\n    });\r\n\r\n    // Dynamics\r\n    const ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);\r\n    Object.keys(ngDynamicProperties).forEach((propertyName: string) => {\r\n      const ngDynamicProperty = ngDynamicProperties[propertyName];\r\n      properties.push({\r\n        name: propertyName,\r\n        type: BindingPropertyType.Dynamic,\r\n        entityType: ngDynamicProperty.type\r\n      });\r\n    });\r\n\r\n    return properties;\r\n  }\r\n\r\n  static getDynamicProperties(dynamicData: any): BindingProperty[] {\r\n    const properties = [];\r\n    Object.keys(dynamicData).forEach((propertyName: string) => {\r\n      if (dynamicData.hasOwnProperty(propertyName)) {\r\n        if (dynamicData[propertyName] instanceof Object) {\r\n          properties.push({\r\n            name: propertyName,\r\n            type: BindingPropertyType.Dynamic,\r\n            entityType: null\r\n          });\r\n        } else {\r\n          properties.push({\r\n            name: propertyName,\r\n            type: BindingPropertyType.Plain,\r\n            isPrimaryKey: false,\r\n            isForeignKey: false\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return properties;\r\n  }\r\n  /**\r\n   * 根据属性名获取属性\r\n   */\r\n  static getPropertyByName(properties: BindingProperty[], propertyName: string): BindingProperty {\r\n    const targetProperty =  properties.find((property: BindingProperty) => {\r\n      return property.name === propertyName;\r\n    });\r\n    return targetProperty;\r\n  }\r\n\r\n  /**\r\n   * 获取实体主键名\r\n   * @param properties 属性集合\r\n   * @returns 主键名\r\n   */\r\n  static getPrimaryKey(properties: BindingProperty[]): string {\r\n\r\n    // 实体必须有主键，如果没有主键在构造实体的时候就已经报错，这里不需要再进行检查\r\n    const primaryProperty = properties.find((property: BindingProperty) => {\r\n      return property.isPrimaryKey === true;\r\n    });\r\n    return primaryProperty ? primaryProperty.name : '';\r\n  }\r\n\r\n}\r\n\r\nexport { PropertyUtil };\r\n","/**\r\n * BindingObject相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\nimport { Subject, Observable, of } from 'rxjs';\r\n\r\nimport { Change, ChangeType, ViewChange, ViewChangeType } from './changes';\r\nimport { BindingProperty, BindingPropertyType } from './binding_property';\r\nimport { BindingList } from './binding_list';\r\nimport { PropertyUtil } from './property_util';\r\n\r\ninterface InvokeOnValueChange {\r\n  (preValue, value, entityChanged: boolean): Observable<boolean>;\r\n}\r\n\r\n/**\r\n * BindingObject是Entity在绑定层的一个影射，它将Entity内的数据转换为不可变对象，并用于界面绑定。\r\n */\r\nclass BindingObject {\r\n\r\n  /**\r\n   * immutable值对象\r\n   */\r\n  private innerValues: Map<string, any>;\r\n\r\n  /**\r\n   * 父对象或父列表\r\n   */\r\n  public parent: BindingList | BindingObject;\r\n\r\n  /**\r\n   * 实体引起的变更\r\n   */\r\n  public changes: Subject<Change>;\r\n\r\n  /**\r\n   * 界面层引起的变更流\r\n   */\r\n  public viewChanges: Subject<ViewChange>;\r\n\r\n  /**\r\n   *  属性集合\r\n   */\r\n  public properties: BindingProperty[];\r\n\r\n  /**\r\n   * 主键名\r\n   */\r\n  public primaryKey: string;\r\n\r\n  /**\r\n   * 主键值\r\n   */\r\n  public get primaryKeyValue() {\r\n    return this.primaryKey ? this.getValue(this.primaryKey) : '';\r\n  }\r\n\r\n  /**\r\n   * 标识是否提交过\r\n   */\r\n  public isShowValidationMsg = false;\r\n\r\n  /**\r\n   * 以{ [propertyName]: FormControl }的形式存放每条数据的control\r\n   */\r\n  public controlMap: any = {};\r\n\r\n  /**\r\n   * 设置是否提交过\r\n   */\r\n  public setShowValidationMsg(flag: boolean) {\r\n    this.isShowValidationMsg = flag;\r\n  }\r\n\r\n\r\n  /**\r\n   * 构造函数\r\n   * @param properties 属性集合\r\n   */\r\n  constructor(properties: BindingProperty[]) {\r\n    this.properties = properties;\r\n    this.primaryKey = PropertyUtil.getPrimaryKey(properties);\r\n\r\n    this.innerValues = new Map<string, any>();\r\n    this.changes = new Subject<Change>();\r\n    this.viewChanges = new Subject<ViewChange>();\r\n  }\r\n\r\n  /**\r\n   * 根据属性名获取属性值\r\n   * @param   propertyName 属性名\r\n   * @returns 属性值\r\n   */\r\n  public getValue(propertyName: string): any {\r\n    return this.innerValues.get(propertyName);\r\n  }\r\n\r\n  /**\r\n   * 设置属性值\r\n   * @param propertyName        属性名\r\n   * @param propertyValue       属性值\r\n   * @param emitEventToView     是否通知View层去更新界面，默认为false\r\n   * @param emitEventToEntity   是否通知Entity层去更新值，默认为false\r\n   * @param errors              错误消息\r\n   * @param invokeOnValueChange 值变化事件执行句柄\r\n   */\r\n  public setValue(\r\n    propertyName: string, propertyValue: any,\r\n    emitEventToView: boolean = false, emitEventToEntity: boolean = false,\r\n    errors?: any, invokeOnValueChange?: InvokeOnValueChange\r\n  ): void {\r\n\r\n    const oldPropertyValue = this.getValue(propertyName);\r\n\r\n    // 由于特定原因（@邵珠强），无法屏蔽oldPropertyValue === propertyValue\r\n    if (oldPropertyValue === propertyValue) {\r\n      return;\r\n    }\r\n\r\n    if (!invokeOnValueChange || oldPropertyValue === propertyValue) {\r\n      // 设定缺省\r\n      invokeOnValueChange = function (preValue, value, entityChanged: boolean) {\r\n        return of(true);\r\n      };\r\n    }\r\n\r\n    if (emitEventToEntity === true) {\r\n      // BUG 322301，删除@2019.08.10; 如果无对应实体，则中止值传递; 这种情况发生在带从表的单据新增，从表响应Load变化的情况；\r\n      // if(!this.innerValues.has(propertyName)) {\r\n      //   return;\r\n      // }\r\n      // 执行实体值变化前事件\r\n      invokeOnValueChange(oldPropertyValue, propertyValue, false).subscribe((result) => {\r\n        if (result) {\r\n          // 如果成功，执行变化，并通知实体变化\r\n          this.innerValues = this.innerValues.set(propertyName, propertyValue);\r\n          const viewChange = {\r\n            type: ViewChangeType.ValueChanged,\r\n            path: [propertyName],\r\n            value: propertyValue,\r\n            errors: errors\r\n          };\r\n          this.viewChanges.next(viewChange);\r\n          // 如果需要通知视图，通知视图相应修改\r\n          if (emitEventToView === true) {\r\n            this.changes.next({\r\n              type: ChangeType.ValueChanged,\r\n              path: [propertyName],\r\n              value: propertyValue,\r\n              id: this.primaryKeyValue,\r\n              errors: errors\r\n            });\r\n          }\r\n          // 执行实体值变化后事件\r\n          invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();\r\n        } else {\r\n          // 如果失败，不再通知实体变化\r\n          // 并执行界面回滚操作\r\n          this.changes.next({\r\n            type: ChangeType.ValueChanged,\r\n            path: [propertyName],\r\n            value: oldPropertyValue,\r\n            id: this.primaryKeyValue,\r\n            errors: errors\r\n          });\r\n        }\r\n      });\r\n    } else {\r\n      // `emitEventToEntity === false`, 则认定实体值已经发生变化，通知视图变化，并触发实体值变化后事件\r\n      this.innerValues = this.innerValues.set(propertyName, propertyValue);\r\n      if (emitEventToView === true) {\r\n        this.changes.next({\r\n          type: ChangeType.ValueChanged,\r\n          path: [propertyName],\r\n          value: propertyValue,\r\n          id: this.primaryKeyValue,\r\n          errors: errors\r\n        });\r\n      }\r\n      // 执行实体值变化后事件\r\n      invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 将BindingObject实例转换成JSON对象\r\n   */\r\n  public toJSON(options?: any): any {\r\n    const langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';\r\n    const result = {};\r\n    this.properties.forEach((property: BindingProperty) => {\r\n      const propName = property.name;\r\n      if (property.type === BindingPropertyType.List) {\r\n        const list: BindingList = this[propName];\r\n        result[propName] = list.toJSON(options);\r\n      } else if (property.type === BindingPropertyType.Object) {\r\n        const object: BindingObject = this[propName];\r\n        result[propName] = object.toJSON(options);\r\n      } else if (property.type === BindingPropertyType.Dynamic) {\r\n        const object: BindingObject = this[propName];\r\n        result[propName] = object.toJSON(options);\r\n      } else {\r\n\r\n        // 1、对于多语录入字段；\r\n        // 2、传入ignoreMultiLangInput标志，则取当前语言的值给控件。\r\n        if (options && options.ignoreMultiLangInput === true && property.enableMultiLangInput === true) {\r\n          const multiLangValueObj = this.getValue(propName);\r\n          if (multiLangValueObj) {\r\n            result[propName] = multiLangValueObj[langCode];\r\n          } else {\r\n            result[propName] = multiLangValueObj;\r\n          }\r\n        } else {\r\n          result[propName] = this.getValue(propName);\r\n        }\r\n      }\r\n    });\r\n\r\n    return result;\r\n  }\r\n}\r\n\r\nexport { BindingObject, InvokeOnValueChange };\r\n","/**\r\n * 绑定列表工厂相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\nimport { BindingList } from './binding_list';\r\nimport { BindingProperty } from './binding_property';\r\n\r\n/**\r\n * BindingList工厂用于创建一个空的BindingList对象，并将当前行的属性影射到BindingList对象上。\r\n *\r\n * **示例代码**\r\n * ```ts\r\n * const deptProperties: BindingProperty[] = PropertyUtil.getProperties(DeptEntity);\r\n * const deptList = BindingListFactory.create(deptProperties);\r\n * ```\r\n */\r\nclass BindingListFactory {\r\n\r\n  /**\r\n   * 创建BindingList实例，并扩展其属性\r\n   * @param bindingProperties 绑定属性集合\r\n   */\r\n  static create(bindingProperties: BindingProperty[]): BindingList {\r\n    const bindingList = new BindingList(bindingProperties);\r\n    this.extendProperties(bindingList, bindingProperties);\r\n    return bindingList;\r\n  }\r\n\r\n  /**\r\n   * 扩展BindingList属性，将当前行上的属性映射到列表上\r\n   * @param bindingList       要扩展的绑定列表\r\n   * @param bindingProperties 绑定属性集合\r\n   */\r\n  static extendProperties(bindingList: BindingList, bindingProperties: BindingProperty[]) {\r\n\r\n    bindingProperties.forEach((bindingProperty: BindingProperty) => {\r\n      const propertyName = bindingProperty.name;\r\n      Object.defineProperty(bindingList, propertyName, {\r\n        get: () => {\r\n          return bindingList.currentItem[propertyName];\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport { BindingListFactory };\r\n\r\n","/**\r\n * 绑定对象工厂相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\nimport { Change } from './changes';\r\nimport { PropertyUtil } from './property_util';\r\nimport { BindingProperty, BindingPropertyType } from './binding_property';\r\nimport { BindingObject } from './binding_object';\r\nimport { BindingListFactory } from './binding_list_factory';\r\n\r\n/**\r\n * BindingObject工厂用于创建一个空的BindingObject对象，并对其属性进行扩展。\r\n *\r\n * **扩展属性处理**\r\n *\r\n * 对于要扩展的属性（BindingProperty）有三种处理：\r\n * - 普通属性：初始化为一个undefined，并包装get、set方法，通过set方法监听变更；\r\n * - 对象属性：初始化为一个空的BindingObject对象，并监听子对象的变更；\r\n * - 列表属性：初始化为一个空的BindingList对象，并监听子列表的变更；\r\n *\r\n * **示例代码**\r\n *\r\n * ```ts\r\n *  const empProperties = PropertyUtil.getProperties(EmpEntity);\r\n * const empBindingObject = BindingObjectFactory.create(properties);\r\n * ```\r\n */\r\nclass BindingObjectFactory {\r\n\r\n  /**\r\n   * 创建BindingObject实例\r\n   * @param properties 要扩展的属性集合\r\n   * @returns 带扩展属性的空BindingObject对象\r\n   * @\r\n   */\r\n  static create(properties: BindingProperty[]): BindingObject {\r\n    const object = new BindingObject(properties);\r\n    this.extendProperties(object, properties);\r\n    return object;\r\n  }\r\n\r\n  static createDynamicBindingObject(data: any): BindingObject {\r\n    const properties = PropertyUtil.getDynamicProperties(data);\r\n    const object = new BindingObject(properties);\r\n    this.extendProperties(object, properties);\r\n    return object;\r\n  }\r\n\r\n  /**\r\n   * 扩展属性绑定对象的属性\r\n   * @param object     要扩展的绑定对象\r\n   * @param properties 绑定属性集合\r\n   */\r\n  static extendProperties(object: BindingObject, properties: BindingProperty[]): void {\r\n\r\n    // 扩展BindingObject属性\r\n    properties.forEach((property: BindingProperty) => {\r\n      if (property.type === BindingPropertyType.List) {\r\n        this.extendListProperty(object, property);\r\n      } else if (property.type === BindingPropertyType.Object) {\r\n        this.extendObjectProperty(object, property);\r\n      } else if (property.type === BindingPropertyType.Dynamic) {\r\n        this.extendDynamicObjectProperty(object, property);\r\n      } else {\r\n        this.extendPlainProperty(object, property);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 扩展列表类型的绑定属性\r\n   * @param object     要扩展的绑定对象\r\n   * @param properties 列表类型的绑定属性集合\r\n   */\r\n  static extendListProperty(object: BindingObject, property: BindingProperty): void {\r\n    const propertyName = property.name;\r\n    const childListProperties = PropertyUtil.getProperties(property.entityType);\r\n    const childList = BindingListFactory.create(childListProperties);\r\n\r\n    // 指定子List的parent、监听子List的changes事件\r\n    childList.parent = object;\r\n    childList.changes.subscribe((change: Change) => {\r\n      change.path.unshift(propertyName);\r\n      object.changes.next(change);\r\n    });\r\n\r\n    // 将子的BindingList实例赋值给当前属性\r\n    Object.defineProperty(object, propertyName, {\r\n      value: childList\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 扩展对象类型的绑定属性\r\n   * @param object     要扩展的绑定对象\r\n   * @param properties 对象类型的绑定属性集合\r\n   */\r\n  static extendObjectProperty(object: BindingObject, property: BindingProperty): void {\r\n    const propertyName = property.name;\r\n    const childObjectProperties = PropertyUtil.getProperties(property.entityType);\r\n    const childObject = this.create(childObjectProperties);\r\n\r\n    // 指定子Object的parent、监听子Object的changes事件\r\n    childObject.parent = object;\r\n    childObject.changes.subscribe((change: Change) => {\r\n      change.path.unshift(propertyName);\r\n      object.changes.next(change);\r\n    });\r\n\r\n    Object.defineProperty(object, propertyName, {\r\n      value: childObject\r\n    });\r\n  }\r\n\r\n  static extendDynamicObjectProperty(object: BindingObject, property: BindingProperty): void {\r\n    const propertyName = property.name;\r\n    object[propertyName] = null;\r\n  }\r\n\r\n  static attachDynamicObjectProperty(object: BindingObject, propertyName: string, dynamicObject: BindingObject) {\r\n    dynamicObject.parent = object;\r\n    dynamicObject.changes.subscribe((change: Change) => {\r\n      change.path.unshift(propertyName);\r\n      object.changes.next(change);\r\n    });\r\n    Object.defineProperty(object, propertyName, {\r\n      value: dynamicObject\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 扩展简单类型的绑定属性\r\n   * @param object     要扩展的绑定对象\r\n   * @param properties 简单类型的绑定属性集合\r\n   */\r\n  static extendPlainProperty(object: BindingObject, property: BindingProperty): void {\r\n    const propertyName = property.name;\r\n    Object.defineProperty(object, propertyName, {\r\n      get: () => {\r\n        return object.getValue(propertyName);\r\n      },\r\n      set: (value: any) => {\r\n        const oldValue = object.getValue(propertyName);\r\n        if (value === oldValue) {\r\n          return;\r\n        }\r\n        object.setValue(propertyName, value, true, true);\r\n      }\r\n    });\r\n  }\r\n\r\n}\r\n\r\nexport { BindingObjectFactory };\r\n","import { Subject } from 'rxjs';\r\n\r\nimport { ArrayUtil } from '../utils/index';\r\nimport { Change, ChangeType } from './changes';\r\nimport { BindingObject } from './binding_object';\r\nimport { BindingProperty } from './binding_property';\r\nimport { BindingObjectFactory } from './binding_object_factory';\r\nimport { PropertyUtil } from './property_util';\r\n\r\n/**\r\n * BindingList是一个BindingObject集合\r\n */\r\nclass BindingList {\r\n\r\n  /**\r\n   * immutable的BindingObject列表\r\n   */\r\n  private innerList: BindingObject[];\r\n\r\n  private emptyCurrentItem: BindingObject;\r\n\r\n  /**\r\n   * 关联实体的属性集合\r\n   */\r\n  public properties: BindingProperty[];\r\n\r\n  /**\r\n   * 主键名\r\n   */\r\n  public primaryKey: string;\r\n\r\n  /**\r\n   * 父对象\r\n   */\r\n  public parent: BindingObject;\r\n\r\n  /**\r\n   * 变更流\r\n   */\r\n  public changes: Subject<Change>;\r\n\r\n  /**\r\n   * 当前行对应的绑定对象的内码\r\n   */\r\n  public currentId: string;\r\n\r\n  //#region 分页相关\r\n\r\n  /**\r\n   * 分页信息\r\n   */\r\n  public _paginationInfo: any = null;\r\n\r\n  set paginationInfo(sPaginationInfo: any) {\r\n    this._paginationInfo = sPaginationInfo;\r\n    if (this._paginationInfo === sPaginationInfo) {\r\n      return;\r\n    }\r\n    this.changes.next({\r\n      type: ChangeType.PaginationInfoChange,\r\n      path: [],\r\n      value: this._paginationInfo\r\n    });\r\n  }\r\n\r\n  get paginationInfo(): any {\r\n    return this._paginationInfo;\r\n  }\r\n  /**\r\n   * 获取页码\r\n   */\r\n  get pageIndex() {\r\n    if (!!this.paginationInfo && this.paginationInfo.hasOwnProperty(\"pageIndex\")) {\r\n      return this.paginationInfo.pageIndex;\r\n    }\r\n    return 1;\r\n  }\r\n  /**\r\n   * 获取分页大小\r\n   */\r\n  get pageSize() {\r\n    if (!!this.paginationInfo && this.paginationInfo.hasOwnProperty(\"pageSize\")) {\r\n      return this.paginationInfo.pageSize;\r\n    }\r\n    return 0;\r\n  }\r\n\r\n  /**\r\n   * 获取数据总项数\r\n   */\r\n  get total() {\r\n    if (!!this.paginationInfo) {\r\n      return this.paginationInfo.total || this.paginationInfo.totalCount;\r\n    }\r\n    return 0;\r\n  }\r\n  /**\r\n   * 获取跳过的数据条数\r\n   */\r\n  get skip() {\r\n    const pageIndex = this.pageIndex;\r\n    const pageSize = this.pageSize;\r\n    return (pageIndex - 1) * pageSize;\r\n  }\r\n\r\n  /**\r\n   * 前台设置分页信息\r\n   * @param skip skip\r\n   * @param take take\r\n   */\r\n  public setPaginationInfo(skip: number, take: number) {\r\n    this.paginationInfo = Object.assign({}, this.paginationInfo, {\r\n      pageSize: take,\r\n      pageIndex: skip / take + 1\r\n    });\r\n    /*this.changes.next({\r\n      type: ChangeType.PaginationInfoChange,\r\n      path: [],\r\n      value: this.paginationInfo\r\n    });*/\r\n  }\r\n  //#endregion\r\n\r\n\r\n\r\n  /**\r\n   * 当前行对应的绑定对象\r\n   * 如果currentId为null，则创建一个空结构，防止绑定报错；\r\n   */\r\n  public get currentItem(): BindingObject {\r\n    const currentItem = this.findById(this.currentId);\r\n    if (!currentItem) {\r\n      if (!this.emptyCurrentItem) {\r\n        this.emptyCurrentItem = BindingObjectFactory.create(this.properties);\r\n      }\r\n      return this.emptyCurrentItem;\r\n    }\r\n    return currentItem;\r\n  }\r\n\r\n  /**\r\n   * 绑定对象的数量\r\n   */\r\n  public get length(): number {\r\n    return this.innerList.length;\r\n  }\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(properties: BindingProperty[]) {\r\n    this.properties = properties;\r\n    this.primaryKey = PropertyUtil.getPrimaryKey(properties);\r\n\r\n    this.changes = new Subject<Change>();\r\n    this.innerList = [];\r\n    this.currentId = null;\r\n  }\r\n\r\n  /**\r\n   * 添加[Symbol.iterator]，使之能通过for of遍历\r\n   */\r\n  [Symbol.iterator]() {\r\n    const self = this;\r\n    let index = -1;\r\n    const size = this.innerList.length;\r\n\r\n    return {\r\n      next: function () {\r\n        index++;\r\n        if (index < size) {\r\n          return {\r\n            done: false,\r\n            value: self.innerList[index]\r\n          };\r\n        }\r\n        return { done: true, value: undefined };\r\n      }\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 批量加载绑定对象，加载之前先清空绑定列表，并重置当前行，加载之后将第一行设置为默认当前行。\r\n   * @param objects 要加载绑定对象数组\r\n   */\r\n  public load(objects: BindingObject[]): void {\r\n\r\n    // 重置列表\r\n    this.innerList = [];\r\n\r\n    if (objects.length !== 0) {\r\n      // 加载数据\r\n      objects.forEach((object: BindingObject) => {\r\n        this.add(object);\r\n      });\r\n\r\n      // 设置默认当前行\r\n      const currentItem = this.findById(this.currentId);\r\n      if (!currentItem) {\r\n        const firstId = objects[0][this.primaryKey];\r\n        this.setCurrentId(firstId, false, false);\r\n      }\r\n    } else {\r\n      this.currentId = null;\r\n    }\r\n\r\n    // 触发事件\r\n    this.changes.next({\r\n      type: ChangeType.Load,\r\n      path: [],\r\n      value: objects\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 批量追加绑定对象，追加之后将最后一个追加的绑定对象设置为当前行。\r\n   * @param objects 要加载绑定对象数组\r\n   */\r\n  public append(objects: BindingObject[]): void {\r\n\r\n    if (objects.length === 0) {\r\n      return;\r\n    }\r\n\r\n    // 加载BindingObject\r\n    objects.forEach((object: BindingObject) => {\r\n      this.add(object);\r\n    });\r\n\r\n    // 当前行为新追加的最后1行\r\n    const lastId = objects[objects.length - 1][this.primaryKey];\r\n    this.setCurrentId(lastId, true, true);\r\n\r\n    // 触发事件\r\n    this.changes.next({\r\n      type: ChangeType.Append,\r\n      path: [],\r\n      value: objects\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 添加绑定对象，并建立绑定对象和绑定列表之间的关联。\r\n   * @param object 绑定对象\r\n   */\r\n  public add(object: BindingObject) {\r\n    this.innerList.push(object);\r\n    object.parent = this;\r\n\r\n    // 监听object变更，并继续向上抛，由于list有当前行的概念，不需要在path中追加路径\r\n    object.changes.subscribe((change: Change) => {\r\n      this.changes.next(change);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 删除主键值数组对应的绑定对象。\r\n   * @param ids 主键值数组\r\n   */\r\n  public removeByIds(ids: Array<string>): void {\r\n    if (!ids || ids.length === 0) {\r\n      return;\r\n    }\r\n\r\n    let nextCurrentId = this.currentId;\r\n    ids.forEach((id: string) => {\r\n\r\n      // 如果当前行被删除，计算下一当前行\r\n      if (id === nextCurrentId) {\r\n        nextCurrentId = this.getCurrentIdBeforeDeleting();\r\n      }\r\n\r\n      // 删除对象，找不到时跳过\r\n      const index = this.getIndexById(id);\r\n      if (index === -1) {\r\n        return;\r\n      }\r\n      ArrayUtil.removeByIndex(this.innerList, index);\r\n    });\r\n\r\n    // 重新设置当前行\r\n    if (this.innerList.length === 0) {\r\n      this.currentId = null;\r\n    } else {\r\n      this.setCurrentId(nextCurrentId, false, false);\r\n    }\r\n\r\n    // 出发行删除事件\r\n    this.changes.next({\r\n      type: ChangeType.Remove,\r\n      path: [],\r\n      value: ids\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 清空\r\n   */\r\n  public clear() {\r\n    this.innerList = [];\r\n    this.currentId = null;\r\n    this.changes.next({\r\n      type: ChangeType.Remove,\r\n      path: [],\r\n      value: []\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 如果当前行被删除，删除之前重新计算当前行的位置，并返回下一当前行的主键值。\r\n   * - 如果被删除的行是最后1行，则上移1行；\r\n   * - 其他情况，下移1行。\r\n   */\r\n  public getCurrentIdBeforeDeleting(): string {\r\n    let nextIndex = -1;\r\n    const currentIndex = this.getIndexById(this.currentId);\r\n    if (currentIndex === this.length - 1) {\r\n      nextIndex = currentIndex - 1;\r\n    } else {\r\n      nextIndex = currentIndex + 1;\r\n    }\r\n    return this.getIdByIndex(nextIndex);\r\n  }\r\n\r\n  /**\r\n   * 根据主键值获取对应绑定对象\r\n   * @param   id 要查找的主键值\r\n   * @returns 找到时返回对应BindingObject， 找不到时返回null\r\n   */\r\n  public findById(id: string): BindingObject | null {\r\n    let target: BindingObject;\r\n    target = this.innerList.find((item) => {\r\n      return item.getValue(this.primaryKey) === id;\r\n    });\r\n    return target === undefined ? null : target;\r\n  }\r\n\r\n  /**\r\n   * 将主键值为id的绑定对象设置为当前行\r\n   * @param  id        要设置的主键值\r\n   * @param  emitEvent 是否发送当前行变更事件\r\n   */\r\n  public setCurrentId(id: string, emitEvent: boolean = true, emitGlobalEvent: boolean = true): void {\r\n    if (this.currentId === id) {\r\n      return;\r\n    }\r\n\r\n    // 不存在时设置为null\r\n    // const currentObj = this.findById(id);\r\n    // if (!currentObj) {\r\n    //   this.currentId = null;\r\n    // } else {\r\n    //   this.currentId = id;\r\n    // }\r\n\r\n    // @todo：找不到时按理应该设置为null，目前是直接返回，框架部分功能依赖该特性。\r\n    const currentObj = this.findById(id);\r\n    if (!currentObj) {\r\n      return;\r\n    }\r\n    this.currentId = id;\r\n\r\n    // 发出行切换事件\r\n    if (emitEvent === true) {\r\n      this.changes.next({\r\n        type: ChangeType.SelectionChanged,\r\n        path: [],\r\n        value: this.currentItem\r\n      });\r\n    }\r\n\r\n    // 是否发送全局的行切换事件\r\n    if (emitGlobalEvent === true) {\r\n      this.changes.next({\r\n        type: ChangeType.GlobalSelectionChanged,\r\n        path: [],\r\n        value: this.currentItem\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 根据主键值为id的绑定对象的索引\r\n   * @param id 主键值\r\n   * @returns 找到时返回对应的index，找不到时返回-1\r\n   */\r\n  public getIndexById(id: string): number {\r\n    return this.innerList.findIndex((obj: BindingObject) => {\r\n      return obj[this.primaryKey] === id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 根据索引位置获取对应绑定对象的主键值\r\n   * @reutrn 找到时返回对应主键值，找不到返回null\r\n   */\r\n  public getIdByIndex(index: number): string {\r\n\r\n    if (index < 0 || index > this.length) {\r\n      return null;\r\n    }\r\n\r\n    const obj = this.innerList[index];\r\n    if (!obj) {\r\n      return null;\r\n    }\r\n\r\n    return obj[this.primaryKey];\r\n  }\r\n\r\n  /**\r\n   * 转换为BindingObject数组\r\n   */\r\n  public toArray(): BindingObject[] {\r\n    return this.innerList.concat([]);\r\n  }\r\n\r\n  /**\r\n   * 转换为JSON对象\r\n   * @returns 普通对象数组\r\n   */\r\n  public toJSON(options?: any): any[] {\r\n    const result = [];\r\n    this.innerList.forEach((obj: BindingObject) => {\r\n      result.push(obj.toJSON(options));\r\n    });\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * 获取分页信息\r\n   * @param path 路径\r\n   * @param defaultValue 默认值\r\n   */\r\n  public getPaginationConfigByPath(path: string, defaultValue?: any) {\r\n    if (!path || path === '/') {\r\n      return this.paginationInfo;\r\n    }\r\n    if (typeof path !== 'string') {\r\n      throw new Error('路径必须为字符串！');\r\n    }\r\n    path = path.substring(1);\r\n    const paths = path.split('/').filter(item => !!item && item.trim().length > 0).map(item => item.trim());\r\n    let config = this.paginationInfo;\r\n    paths.forEach(item => {\r\n      if (config && config.hasOwnProperty(item)) {\r\n        config = config[item];\r\n      } else {\r\n        config = null;\r\n      }\r\n    });\r\n    return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;\r\n  }\r\n  /**\r\n   * 对bindingList就行排序\r\n   * @param string 排序字段\r\n   * @param directions 排序规则字段\r\n   * @param options 参数\r\n   */\r\n  public sortBy(fields: string | Array<string>, directions: string | Array<string>, options?: { [prop: string]: any }) {\r\n    if (!fields || fields.length < 1 || !directions || directions.length < 1) {\r\n      throw new Error('sortBy:argument error');\r\n    }\r\n    // 默认升序\r\n    const arrFields: Array<string> = typeof fields === 'string' ? fields.split(',') : fields || [];\r\n    const arrDirections: Array<string> = typeof directions === 'string' ? directions.split(',') : directions || [];\r\n    // 排序字段和排序方式应一致\r\n    if (arrFields.length !== arrDirections.length || arrFields.length < 1) {\r\n      throw new Error('sortBy:fields and directions not match');\r\n    }\r\n    // nage,age,total\r\n    const comparator = (props: Array<string>, orders: Array<string>) => (item1: BindingObject, item2: BindingObject) => {\r\n      for (const prop of props) {\r\n        const order = ['asc'].includes(orders[props.indexOf(prop)]) ? 1 : -1;\r\n        if (item1.getValue(prop) > item2.getValue(prop)) { return order * 1; }\r\n        if (item1.getValue(prop) < item2.getValue(prop)) { return order * -1; }\r\n      }\r\n      return 0;\r\n    };\r\n    this.innerList = this.innerList.sort(comparator(arrFields, arrDirections));\r\n  }\r\n}\r\n\r\nexport { BindingList };\r\n","import { Repository } from '../repository/index';\r\nimport { Entity, EntityList, PARENT_CLASS, FieldMetadataUtil } from '../entity/index';\r\nimport { Modification, ModifyType } from '../changeset/index';\r\nimport { ViewChange, Change, ChangeType } from './changes';\r\nimport { BindingList } from './binding_list';\r\nimport { BindingObject } from './binding_object';\r\nimport { BindingProperty, BindingPropertyType } from './binding_property';\r\nimport { BindingObjectFactory } from './binding_object_factory';\r\nimport { Pagination } from '../core/index';\r\nimport { BindingData } from './binding_data';\r\n\r\n/**\r\n * 实体操作工具类\r\n */\r\nclass EntityUtil {\r\n\r\n  /**\r\n   * 将entity的数据加载到bindingObject中，并保持两者同步。\r\n   * @param entity        实体对象\r\n   * @param bindingObject 绑定对象\r\n   */\r\n  static loadEntity(entity: Entity, bindingObject: BindingObject) {\r\n\r\n    // 遍历bindingObject的properties进行赋值\r\n    bindingObject.properties.forEach((property: BindingProperty) => {\r\n      const propertyName = property.name;\r\n      if (property.type === BindingPropertyType.List) {\r\n        this.loadEntityList(entity[propertyName] || entity[PARENT_CLASS], bindingObject[propertyName]);\r\n      } else if (property.type === BindingPropertyType.Object) {\r\n        if (entity && entity[propertyName]) {\r\n          this.loadEntity(entity[propertyName], bindingObject[propertyName]);\r\n        }\r\n      } else if (property.type === BindingPropertyType.Dynamic) {\r\n        if (entity && entity[propertyName]) {\r\n          const dynamicObject = BindingObjectFactory.createDynamicBindingObject(entity[propertyName].data);\r\n          BindingObjectFactory.attachDynamicObjectProperty(bindingObject, propertyName, dynamicObject);\r\n          this.loadEntity(entity[propertyName], bindingObject[propertyName]);\r\n        }\r\n      } else {\r\n        bindingObject.setValue(propertyName, entity[propertyName], false, false);\r\n      }\r\n    });\r\n\r\n    this.setUpEntityPipeline(entity, bindingObject);\r\n  }\r\n\r\n  /**\r\n   * 建立entity和bindingObject之间的关联\r\n   * @param entity        实体对象\r\n   * @param bindingObject 绑定对象\r\n   */\r\n  static setUpEntityPipeline(entity: Entity, bindingObject: BindingObject) {\r\n\r\n    // 监听entity变更\r\n    entity.onValueChanged.subscribe((modification: Modification) => {\r\n      if (modification.type !== ModifyType.ValueChange || modification.path.length === 0) {\r\n        return;\r\n      }\r\n      const propertyName = modification.path[modification.path.length - 1];\r\n      const primaryKeyPath = modification.path[modification.path.length - 2];\r\n\r\n      // 验证主键是否匹配\r\n      // 存在主键并且主键不是id时才检查（值对象、关联对象不检查）\r\n      if (bindingObject.primaryKey && bindingObject.primaryKey === 'id') {\r\n        const primaryKey = bindingObject.primaryKey;\r\n        const primaryKeyValue = bindingObject.getValue(primaryKey);\r\n        if (primaryKeyPath !== `${primaryKey}:${primaryKeyValue}`) {\r\n          return;\r\n        }\r\n      }\r\n\r\n      // 值没有发生变化，不再设置\r\n      // TODO: 通过bindingObject修改entity属性值时，entity总会触发一个变更回来，如果不截获这个重复的变更，会导致重复或死循环\r\n      if (bindingObject.getValue(propertyName) === modification.value) {\r\n        return;\r\n      }\r\n      bindingObject.setValue(propertyName, modification.value, true, false, modification.errors);\r\n    });\r\n\r\n    // 监听bindingObject变更\r\n    bindingObject.viewChanges.subscribe((viewChange: ViewChange) => {\r\n      const value = viewChange.value;\r\n      const propertyName = viewChange.path[0];\r\n\r\n      let pathPrefix = '';\r\n      const pathData = entity.getPaths();\r\n      const paths = pathData.path;\r\n      let id = bindingObject['id'];\r\n      if (pathData.isUdt) {\r\n        // grid中udt没有id，从父级中取出id，以便存放验证信息\r\n        const getParentId = (target: any) => {\r\n          let parentId = '';\r\n          const findId = (item: any) => {\r\n            if (item && item && item['id']) {\r\n              parentId = item['id'];\r\n              return;\r\n            } else if (item['parent']) {\r\n              findId(item['parent']);\r\n            }\r\n          };\r\n          findId(target);\r\n          return parentId;\r\n        };\r\n        id = getParentId(bindingObject);\r\n        if (pathData.isGrid) {\r\n          // grid 将从表主字段去除\r\n          paths.shift();\r\n        }\r\n        if (paths.length) {\r\n          pathPrefix = paths.join('.') + '.';\r\n        }\r\n      }\r\n\r\n      // 不是主键值字段时，要先检查主键是否存在，并且主键是否相等（防止后代变更冒泡上来）\r\n      // 非主键属性变更时，要先检查主键是否匹配（如果主键也修改了，要求先修改主键再修改其他值）\r\n      if (bindingObject.primaryKey) {\r\n        const primaryKey = bindingObject.primaryKey;\r\n        if (propertyName !== primaryKey) {\r\n          if (!entity[primaryKey] || entity[primaryKey] !== bindingObject[primaryKey]) {\r\n            return;\r\n          }\r\n        }\r\n      }\r\n\r\n      // 如果BindingObject上的属性值和Entity上对应属性值一样，则不再设置\r\n      if (entity[propertyName] === value) {\r\n        return;\r\n      }\r\n\r\n      // 调用表单验证,通过后调用实体验证\r\n      // bingdingObject变化后，先调用实体上的验证，通过后再设置实体的变动\r\n      entity[propertyName] = value;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 将entityList中的Entity对象转换为BindingObject对象，加载到bindingList中，并保持entityList和bindingList同步。\r\n   * @param entityList  实体列表\r\n   * @param bindingList 绑定列表\r\n   */\r\n  static loadEntityList(entityList: EntityList<any>, bindingList: BindingList) {\r\n    this.loadEntities(entityList.items, bindingList);\r\n\r\n    this.setUpEntityListPipeline(entityList, bindingList);\r\n  }\r\n\r\n  /**\r\n   * 建立entityList和bindingList之间的关联\r\n   * @param entityList  实体列表\r\n   * @param bindingList 绑定列表\r\n   */\r\n  static setUpEntityListPipeline(entityList: EntityList<any>, bindingList: BindingList) {\r\n\r\n    entityList.onListChanged.subscribe((modification: Modification) => {\r\n      switch (modification.type) {\r\n\r\n        // 添加实体\r\n        case ModifyType.Add:\r\n          const entitiesToAdd = <Entity[]>modification.value;\r\n          if (entitiesToAdd.length === 0) {\r\n            return;\r\n          }\r\n\r\n          // 检查父id是否一致，冒泡导致的变更不处理\r\n          const paths = modification.path;\r\n          const parentPath = paths[paths.length - 2];\r\n          const parentId = bindingList.parent.primaryKeyValue;\r\n          if (parentPath.indexOf(parentId) === -1) {\r\n            return;\r\n          }\r\n\r\n          this.appendEntities(<Entity[]>modification.value, bindingList);\r\n          break;\r\n\r\n        // 删除实体\r\n        case ModifyType.Remove:\r\n\r\n          // 删除实体（value格式待商榷，目前value的格式为 { primaryKey: primaryValue}）\r\n          const id = modification.value[bindingList.primaryKey];\r\n          bindingList.removeByIds([id]);\r\n          // this.removeEntities(<Entity[]>modification.value, bindingList);\r\n          break;\r\n\r\n        // 加载实体\r\n        case ModifyType.Load:\r\n          const entities = modification.value;\r\n          this.loadEntities(entities, bindingList);\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 监听repository变化，保持repository和bindingList同步。\r\n   * @param repository  实体仓库\r\n   * @param bindingList 绑定列表\r\n   */\r\n  static loadRepository(repository: Repository<any>, bindingList: BindingList) {\r\n\r\n    // 初次加载\r\n    const entities = Array.from(repository.entityCollection.toArray());\r\n    this.loadEntities(entities, bindingList);\r\n\r\n    // 监听变化\r\n    repository.entityCollectionChange.subscribe((modification: Modification) => {\r\n      switch (modification.type) {\r\n        case ModifyType.Load:\r\n          this.loadEntities(<Entity[]>modification.value, bindingList);\r\n          break;\r\n        case ModifyType.Add:\r\n          this.appendEntities(<Entity[]>modification.value, bindingList);\r\n          break;\r\n        case ModifyType.Remove:\r\n          this.removeEntities(<Entity[]>modification.value, bindingList);\r\n          break;\r\n        case ModifyType.PaginationInfoChange:\r\n          bindingList.paginationInfo = <Pagination>modification.value;\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    });\r\n\r\n    // 监听BindingList数据变化\r\n    bindingList.changes.subscribe((change: Change) => {\r\n      if (change.type === ChangeType.PaginationInfoChange) {\r\n        const entityCollection = repository.entityCollection;\r\n        // const entityTypeName = entityCollection.entityTypeName;\r\n        // const original = entityCollection.paginationInfo[entityTypeName];\r\n        // const entityPaginationInfo = Object.assign({}, original, change.value);\r\n        entityCollection.paginationInfo = Object.assign({}, entityCollection.paginationInfo, change.value);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 将entities中的Entity对象转换为BindingObject对象，并加载到bindingList中\r\n   * @param entities    实体数组\r\n   * @param bindingList 绑定列表\r\n   */\r\n  static loadEntities(entities: Entity[], bindingList: BindingList) {\r\n    const bindingObjects = this.createBindingObjects(entities, bindingList);\r\n    bindingList.load(bindingObjects);\r\n  }\r\n\r\n  /**\r\n   * 将entities中的Entity对象转换为BIndingObject对象，并追加到bindingList中\r\n   * @param entities    实体数组\r\n   * @param bindingList 绑定列表\r\n   */\r\n  static appendEntities(entities: Entity[], bindingList: BindingList) {\r\n    const bindingObjects = this.createBindingObjects(entities, bindingList);\r\n    bindingList.append(bindingObjects);\r\n  }\r\n\r\n  /**\r\n   * 从bindingList移除entities对应的BindingObject对象\r\n   * @param entities    实体数组\r\n   * @param bindingList 绑定列表\r\n   */\r\n  static removeEntities(entities: Entity[], bindingList: BindingList) {\r\n    if (entities === null || entities.length === 0) {\r\n      return;\r\n    }\r\n\r\n    // 归集要删除的id数组\r\n    const primaryKey = bindingList.primaryKey;\r\n    const ids = [];\r\n    entities.forEach((entity: Entity) => {\r\n      ids.push(entity[primaryKey]);\r\n    });\r\n    bindingList.removeByIds(ids);\r\n  }\r\n\r\n  /**\r\n   * 将entities中的Entity对象转换为BindingObject对象\r\n   * @param entities    实体数组\r\n   * @param bindingList 绑定列表\r\n   */\r\n  static createBindingObjects(entities: Entity[], bindingList: BindingList) {\r\n\r\n    if (entities === null || entities.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    const bindingObjects = [];\r\n    entities.forEach((entity: Entity) => {\r\n      const bindingObject = BindingObjectFactory.create(bindingList.properties);\r\n      this.loadEntity(entity, bindingObject);\r\n\r\n      // // 为bindingObject设置默认值initialData属性\r\n      // if (entity['initialData']) {\r\n      //   bindingObject['initialData'] = entity['initialData'];\r\n      // }\r\n\r\n      bindingObjects.push(bindingObject);\r\n    });\r\n    return bindingObjects;\r\n  }\r\n  public static watchReposiroty(repository: Repository<any>, bindingData: BindingData) {\r\n    // reposiroty => bindingData\r\n    repository.entityCollectionChange.subscribe((modification: Modification) => {\r\n      switch (modification.type) {\r\n        case ModifyType.PaginationInfoChange:\r\n          bindingData.pagingInfo = modification.value;\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    });\r\n  }\r\n  /**\r\n   * 查找属性的类型\r\n   * @param entityType 实体类型\r\n   * @param targetPropName 属性名称\r\n   * @return 属性信息，包含属性类型（NgField、NgObject、NgList）和属性对应的实体类型（当NgField类型时为null）\r\n   */\r\n  static getPropInfo(entityType: any, targetPropName: string): { propType: string, propEntityType: any } {\r\n\r\n    let propType: string;\r\n    let propEntityType: any;\r\n\r\n    // NgField\r\n    const ngFieldProperties = FieldMetadataUtil.getNgFields(entityType);\r\n    Object.keys(ngFieldProperties).forEach((propName: string) => {\r\n      if (propName === targetPropName) {\r\n        propType = 'NgField';\r\n        propEntityType = null;\r\n      }\r\n    });\r\n\r\n    // NgObject\r\n    const ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);\r\n    Object.keys(ngObjectProperties).forEach((propName: string) => {\r\n      if (propName === targetPropName) {\r\n        propType = 'NgObject';\r\n        propEntityType = ngObjectProperties[propName].type;\r\n      }\r\n    });\r\n\r\n    // NgList\r\n    const ngListProperties = FieldMetadataUtil.getNgList(entityType);\r\n    Object.keys(ngListProperties).forEach((propName: string) => {\r\n      if (propName === targetPropName) {\r\n        propType = 'NgList';\r\n        propEntityType = ngListProperties[propName].type;\r\n      }\r\n    });\r\n\r\n    const ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);\r\n    Object.keys(ngDynamicProperties).forEach((propName: string) => {\r\n      if (propName === targetPropName) {\r\n        propType = 'NgDynamic';\r\n        propEntityType = ngDynamicProperties[propName].type;\r\n      }\r\n    });\r\n\r\n    return { propType, propEntityType };\r\n  }\r\n\r\n  /**\r\n   * 获取实体的主键名\r\n   * @param entityType 实体类型\r\n   */\r\n  static getPrimaryKey(entityType: any) {\r\n    const primaryNgFiledProp = FieldMetadataUtil.getPrimaryFieldMetadata(entityType);\r\n    if (primaryNgFiledProp) {\r\n      return primaryNgFiledProp.dataField;\r\n    } else {\r\n      return '';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 是否为对象属性\r\n   */\r\n  static isObjectProp(entityType: any, targetPropName: string, ) {\r\n    let isObjectProp = false;\r\n    const ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);\r\n    Object.keys(ngObjectProperties).forEach((propName: string) => {\r\n      if (propName === targetPropName) {\r\n        isObjectProp = true;\r\n      }\r\n    });\r\n    return isObjectProp;\r\n  }\r\n\r\n  /**\r\n   * 检查是否是动态列属性\r\n   */\r\n  static isDynamicProp(entityType: any, targetPropName: string) {\r\n    let isDynamicProp = false;\r\n    const ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);\r\n    Object.keys(ngDynamicProperties).forEach((propName: string) => {\r\n      if (propName === targetPropName) {\r\n        isDynamicProp = true;\r\n      }\r\n    });\r\n    return isDynamicProp;\r\n  }\r\n\r\n  /**\r\n   * 为实体增加initialData属性\r\n   * @param entity 实体实例\r\n   * @param initialData 默认值对象\r\n   */\r\n  static appendInitialData(entity, initialData) {\r\n    const data = Object.assign({}, initialData);\r\n    delete data.id;\r\n    delete data.parentID;\r\n    entity['initialData'] = data;\r\n  }\r\n}\r\n\r\nexport { EntityUtil };\r\n","// tslint:disable: max-line-length member-ordering\r\n/**\r\n * 绑定数据相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n * @todo\r\n * 1、全局的BindingData和局部的BindingData应该拆成两个类，两个类之间是装饰关系；；\r\n * 2、为了保持兼容，减少改动量，暂时放在一起，待进一步重构。\r\n */\r\n\r\nimport { Subject } from 'rxjs';\r\n\r\nimport { DataTypeInfo } from '../entity/entity-type-info/index';\r\nimport { Repository } from '../repository/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { Change, ChangeType } from './changes';\r\nimport { BindingProperty } from './binding_property';\r\nimport { BindingList } from './binding_list';\r\nimport { BindingListFactory } from './binding_list_factory';\r\nimport { PropertyUtil } from './property_util';\r\nimport { EntityUtil } from './entity_util';\r\nimport { InvokeOnValueChange } from './binding_object';\r\nimport { nullSafeIsEquivalent } from '@angular/compiler/src/output/output_ast';\r\n\r\n/**\r\n * BindingData\r\n */\r\n\r\nclass BindingData {\r\n\r\n  private viewModelContext: ViewModelContext;\r\n\r\n  /**\r\n   * 数据类型描述\r\n   */\r\n  private dataTypeInfo: DataTypeInfo;\r\n\r\n  /**\r\n   * 绑定该路径\r\n   */\r\n  public get bindingPath(): string {\r\n    if (this.viewModelContext && this.viewModelContext.viewModel.bindingPath) {\r\n      return this.viewModelContext.viewModel.bindingPath;\r\n    }\r\n    return '/';\r\n  }\r\n\r\n  /**\r\n   * 可绑定的属性描述\r\n   */\r\n  public properties: BindingProperty[];\r\n\r\n  /**\r\n   * 数据列表\r\n   */\r\n  public list: BindingList;\r\n  private paginationInfo = null;\r\n\r\n  public set pagingInfo(pagingInfo: any) {\r\n    this.paginationInfo = pagingInfo;\r\n    this.firePagingChangeEvent();\r\n  }\r\n\r\n  public get pagingInfo() {\r\n    return this.paginationInfo;\r\n  }\r\n  /**\r\n   * 设置分页信息\r\n   * @param skip 跳过\r\n   * @param take 获取\r\n   * @param bindingPath 路径\r\n   */\r\n  public setPagingInfo(skip: number, take: number, bindingPath: string) {\r\n    if (bindingPath.length < 1 || bindingPath === '/') {\r\n      this.paginationInfo = Object.assign(this.paginationInfo, { pageSize: take, pageIndex: skip / take + 1 });\r\n    } else {\r\n      let pagingInfo = this.paginationInfo || {};\r\n      const bindingPaths = bindingPath.substr(1).split('/').filter(item => !!item && item.length > 0).map(item => item.substring(0, item.length - 1));\r\n      bindingPaths.forEach(path => {\r\n        if (!pagingInfo.hasOwnProperty(path)) {\r\n          pagingInfo[path] = {};\r\n        }\r\n        pagingInfo = pagingInfo[path];\r\n      });\r\n      pagingInfo.pageIndex = ((skip / take) || 0) + 1;\r\n      pagingInfo.pageSize = take || 0;\r\n    }\r\n    this.firePagingChangeEvent();\r\n  }\r\n  private firePagingChangeEvent() {\r\n    this.list.changes.next({\r\n      type: ChangeType.PaginationInfoChange,\r\n      path: [],\r\n      value: this.paginationInfo\r\n    });\r\n  }\r\n  /**\r\n   * 变更集\r\n   */\r\n  public get changes(): Subject<Change> {\r\n    return this.list.changes;\r\n  }\r\n\r\n  /**\r\n   * 值变化执行器工厂，根据路径产生执行器\r\n   */\r\n  private valueChangeInvokerFactory: (paths: string[]) => InvokeOnValueChange;\r\n\r\n  /**\r\n   * 设置值变化执行器工厂\r\n   * @param value 值变化执行器工厂\r\n   */\r\n  public setValueChangeInvokerFactory(value: (paths: string[]) => InvokeOnValueChange) {\r\n    this.valueChangeInvokerFactory = value;\r\n  }\r\n\r\n  /**\r\n   * 初始化（已废弃）\r\n   */\r\n  public init(repository: Repository<any>, bindingPath: string) {\r\n    this.initByRepository(repository, null);\r\n  }\r\n\r\n  /**\r\n   * 根据Repository对BindingData进行初始化\r\n   */\r\n  public initByRepository(repository: Repository<any>, viewModelContext: ViewModelContext) {\r\n    this.viewModelContext = viewModelContext;\r\n\r\n    this.properties = PropertyUtil.getProperties(repository.entityType);\r\n    this.list = BindingListFactory.create(this.properties);\r\n    // 从repository初始化bindingData\r\n    this.pagingInfo = repository.entityCollection.paginationInfo;\r\n\r\n    // @todo\r\n    // BindingData不应该知道Repository，加载数据、建立关联关系的过程应该转移到外边\r\n    EntityUtil.loadRepository(repository, this.list);\r\n    this.dataTypeInfo = repository.entityTypeInfo;\r\n\r\n    this.extendProperties(this.properties);\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  public initByBindingList(bindingList: BindingList,  viewModelContext: ViewModelContext) {\r\n    this.list = bindingList;\r\n    this.viewModelContext = viewModelContext;\r\n    this.extendProperties(this.list.properties);\r\n  }\r\n\r\n  /**\r\n   * 获取paths对应的属性值\r\n   * @param  paths 属性路径数组\r\n   * @returns 属性值\r\n   */\r\n  public getValue(paths: string[]) {\r\n    let target: any = this.list;\r\n    paths.forEach((path: string) => {\r\n      if (target) {\r\n        target = target[path];\r\n      }\r\n    });\r\n    return target;\r\n  }\r\n\r\n  /**\r\n   * 根据paths设置属性值\r\n   * @param paths 属性路径数组\r\n   * @param value 属性值\r\n   * @param emitEventToView 如果设置为true，则发送事件通知订阅它的组件、指令去更新界面，默认为false。\r\n   * @param emitEventToEntity 如果设置为true，则同步去更新Entity上对应的字段，默认为true。\r\n   */\r\n  public setValue(paths: string[], value: any, emitEventToView: boolean = false, emitEventToEntity: boolean = true) {\r\n\r\n    if (!paths || paths.length === 0) {\r\n      throw Error('路径不能为空');\r\n    }\r\n    const parentPaths = paths.slice(0, paths.length - 1);\r\n    const propName = paths[paths.length - 1];\r\n\r\n    let parent = this.getValue(parentPaths);\r\n    if (!parent) {\r\n      throw Error('找不到要设置的对象');\r\n    }\r\n    if (parent instanceof BindingData) {\r\n      parent = parent.list.currentItem;\r\n    } else if (parent instanceof BindingList) {\r\n      parent = parent.currentItem;\r\n    }\r\n    if (!!this.valueChangeInvokerFactory) {\r\n      parent.setValue(propName, value, emitEventToView, emitEventToEntity, null, this.valueChangeInvokerFactory(paths));\r\n    } else {\r\n      parent.setValue(propName, value, emitEventToView, emitEventToEntity);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 根据paths清空属性值\r\n   */\r\n  public clearValue(paths: string[], emitEventToView: boolean = false, emitEventToEntity: boolean = true) {\r\n    let initValue: any;\r\n    const propInfo = this.dataTypeInfo.getPropInfoByPath(paths);\r\n    if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.initValue !== undefined) {\r\n      initValue = propInfo.metadataInfo.initValue;\r\n    } else {\r\n\r\n      // 原来的帮助映射中，强行纠正了数值的情况，保持一致\r\n      const oldValue = this.getValue(paths);\r\n      if (typeof oldValue === 'number') {\r\n        initValue = 0;\r\n      } else {\r\n        initValue = '';\r\n      }\r\n    }\r\n    this.setValue(paths, initValue, emitEventToView, emitEventToEntity);\r\n  }\r\n\r\n  /**\r\n   * 获取当前列表\r\n   */\r\n  public getList() {\r\n\r\n    if (!this.bindingPath || this.bindingPath === '/') {\r\n      return this.list;\r\n    }\r\n\r\n    const bindingPath = this.bindingPath.substr(1);\r\n    const bindingPathArray = bindingPath.split('/').filter((part: string) => {\r\n      return part !== '';\r\n    });\r\n    return this.getValue(bindingPathArray);\r\n  }\r\n\r\n  /**\r\n   * 获取当前对象\r\n   */\r\n  public getObject() {\r\n    const bindingList = this.getList();\r\n    return bindingList.currentItem;\r\n  }\r\n\r\n  /**\r\n   * 扩展BindingData属性，映射BindingData所持有的绑定列表当前行的属性，减少绑定层级。\r\n   * @param properties 关联实体的属性集合\r\n   */\r\n  private extendProperties(properties: BindingProperty[]) {\r\n    properties.forEach((property: BindingProperty) => {\r\n      const propName = property.name;\r\n      Object.defineProperty(this, propName, {\r\n        get: () => {\r\n          return this.list.currentItem[propName];\r\n        },\r\n        set: (value: any) => {\r\n          this.list.currentItem[propName] = value;\r\n        }\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nexport { BindingData };\r\n","import { Entity } from '../entity/index';\r\nimport { Repository, EntityManager } from '../repository/index';\r\nimport { PropertyUtil as BindingPropertyUtil } from './property_util';\r\nimport { EntityUtil as EntityLoadUtil } from './entity_util';\r\nimport { BindingListFactory } from './binding_list_factory';\r\nimport { BindingData } from './binding_data';\r\n\r\n\r\nclass BindingDataFactory {\r\n\r\n  /**\r\n   * 根据Repository创建一个BindingData\r\n   */\r\n  public static createFromRepository(repository: Repository<Entity>, bindingPath: string): BindingData {\r\n    const bindingData = new BindingData();\r\n    const bindingProperties = BindingPropertyUtil.getProperties(repository.entityType);\r\n    const bindingList = BindingListFactory.create(bindingProperties);\r\n    bindingData.initByBindingList(bindingList, null);\r\n    EntityLoadUtil.loadRepository(repository, bindingList);\r\n\r\n    // 从repository初始化bindingData\r\n    bindingData.pagingInfo = repository.entityCollection.paginationInfo;\r\n    return bindingData;\r\n  }\r\n\r\n  /**\r\n   * 根据EntityManager创建BindingData，并建立双向关联（请勿使用）\r\n   * @internal\r\n   * @summary\r\n   * 1、该方法暂时仅供内部单元测试使用；\r\n   * 2、该方法暂时只创建BindingData，不建立双向关联\r\n   */\r\n  public static createFromEntityManager(entityManager: EntityManager<Entity>, bindingPath: string): BindingData {\r\n    const bindingData = new BindingData();\r\n    const bindingProperties = BindingPropertyUtil.getProperties(entityManager.entityType);\r\n    const bindingList = BindingListFactory.create(bindingProperties);\r\n    bindingData.initByBindingList(bindingList, null);\r\n\r\n    // 初始化数据\r\n    const entities: Entity[] = entityManager.getEntitiesByPath([]);\r\n    EntityLoadUtil.loadEntities(entities, bindingList);\r\n\r\n    return bindingData;\r\n  }\r\n\r\n  /**\r\n   * 根据已经存在的BindingData创建一个新的BindingData\r\n   */\r\n  public static createFromExistingBindingData(existingBindingData: BindingData, bindingPath: string) {\r\n    const bindingData = new BindingData();\r\n    bindingData.initByBindingList(existingBindingData.list, null);\r\n    return bindingData;\r\n  }\r\n}\r\n\r\nexport { BindingDataFactory };\r\n","import {\r\n  BindingData, BindingPropertyType, PropertyUtil\r\n} from '../../binding-data/index';\r\nimport { BindingPathConverter } from './binding_path_converter';\r\n\r\n/**\r\n * EntityPath转换器\r\n */\r\nclass EntityPathConverter {\r\n\r\n  /**\r\n   * 转换为Entity可识别的路径\r\n   * 根：[]\r\n   * 主表：['id:xxx', 'name'],\r\n   * 关联：['id:xxx', 'deptInfo', 'id:xxx', 'name']\r\n   * UDT: ['id:xxx', 'updateInfo', ':', 'createdOn']\r\n   * 从表：['id:xxx', 'edus', 'id:xxx', 'name'],\r\n   * 从从表：['id:xxx', 'edus', 'id:xxx', 'grades', 'id:xxx', 'name']\r\n   */\r\n  public static toEntityPathArray(bindingPathString: string, bindingData: BindingData): string[] {\r\n    const bindingPathArray: string[] = BindingPathConverter.toBindingPathArray(bindingPathString);\r\n    const entityPathArray: string[] = [];\r\n\r\n    if (bindingPathArray.length === 0) {\r\n      return entityPathArray;\r\n    }\r\n\r\n    // 根节点\r\n    let currentBindingObject = bindingData.list.currentItem;\r\n    entityPathArray.push(\r\n      this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue)\r\n    );\r\n\r\n    bindingPathArray.forEach((propName: string) => {\r\n      const propInfo = PropertyUtil.getPropertyByName(currentBindingObject.properties, propName);\r\n      switch (propInfo.type) {\r\n        case BindingPropertyType.Plain:\r\n          entityPathArray.push(propName);\r\n          break;\r\n        case BindingPropertyType.Object:\r\n          currentBindingObject = currentBindingObject[propName];\r\n          entityPathArray.push(propName);\r\n          entityPathArray.push(\r\n            this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue)\r\n          );\r\n          break;\r\n        case BindingPropertyType.List:\r\n          const currentBindingList = currentBindingObject[propName];\r\n          currentBindingObject = currentBindingList.currentItem;\r\n          entityPathArray.push(propName);\r\n          entityPathArray.push(\r\n            this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue)\r\n          );\r\n          break;\r\n        default:\r\n            break;\r\n      }\r\n    });\r\n\r\n    return entityPathArray;\r\n  }\r\n\r\n  /**\r\n   * 创建路径中的主键部分\r\n   */\r\n  public static createPrimaryKeyPath(primaryKey: string, primaryKeyValue: string) {\r\n    return `${primaryKey}:${primaryKeyValue}`;\r\n  }\r\n\r\n}\r\n\r\nexport { EntityPathConverter };\r\n","\r\n/**\r\n * 实体路径比较器\r\n */\r\nclass EntityPathComparer {\r\n}\r\n\r\nexport { EntityPathComparer };\r\n","\r\n/**\r\n * 表单路径转换类\r\n */\r\nclass FormPathConverter {\r\n\r\n  /**\r\n   * ControlPathString => BingingPathArray\r\n   * @params controlPath FormControl对应的数据绑定路径（BindingData的bindingPaht + FormControl的binding）\r\n   * @return BindingPath数组\r\n   */\r\n  public static toBindingPathArray(formPahtString: string): string[] {\r\n    const bindingPathArray = formPahtString.split('.').filter((part: string) => {\r\n      return part !== '';\r\n    });\r\n    return bindingPathArray;\r\n  }\r\n}\r\n\r\nexport { FormPathConverter };\r\n","import { BindingData, BindingPropertyType, PropertyUtil } from '../binding-data/index';\r\n/**\r\n * 路径处理工具类（处理/PathNode1/PathNode2/...格式的路径）\r\n */\r\nclass DataPathUtil {\r\n\r\n  /**\r\n   * 转换成BindingData可识别的路径\r\n   */\r\n  public static convertToBindingPathArray(path: string): string[] {\r\n    const bindingPathArray = path.split('/').filter((part: string) => {\r\n      return part !== '';\r\n    });\r\n    return bindingPathArray;\r\n  }\r\n\r\n  /**\r\n   * 转换为Entity可识别的路径\r\n   * 根：[]\r\n   * 主表：['id:xxx', 'name'],\r\n   * 关联：['id:xxx', 'deptInfo', 'id:xxx', 'name']\r\n   * UDT: ['id:xxx', 'updateInfo', ':', 'createdOn']\r\n   * 从表：['id:xxx', 'edus', 'id:xxx', 'name'],\r\n   * 从从表：['id:xxx', 'edus', 'id:xxx', 'grades', 'id:xxx', 'name']\r\n   */\r\n  public static convertToEntityPathArray(path: string, bindingData: BindingData): string[] {\r\n    const bindingPathArray: string[] = this.convertToBindingPathArray(path);\r\n    const entityPathArray: string[] = [];\r\n\r\n    if (bindingPathArray.length === 0) {\r\n      return entityPathArray;\r\n    }\r\n\r\n    // 根节点\r\n    let currentBindingObject = bindingData.list.currentItem;\r\n    entityPathArray.push(\r\n      this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue)\r\n    );\r\n\r\n    bindingPathArray.forEach((propName: string) => {\r\n      const propInfo = PropertyUtil.getPropertyByName(currentBindingObject.properties, propName);\r\n      switch (propInfo.type) {\r\n        case BindingPropertyType.Plain:\r\n          entityPathArray.push(propName);\r\n          break;\r\n        case BindingPropertyType.Object:\r\n          currentBindingObject = currentBindingObject[propName];\r\n          entityPathArray.push(propName);\r\n          entityPathArray.push(\r\n            this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue)\r\n          );\r\n          break;\r\n        case BindingPropertyType.List:\r\n          const currentBindingList = currentBindingObject[propName];\r\n          currentBindingObject = currentBindingList.currentItem;\r\n          entityPathArray.push(propName);\r\n          entityPathArray.push(\r\n            this.createPrimaryKeyPath(currentBindingObject.primaryKey, currentBindingObject.primaryKeyValue)\r\n          );\r\n          break;\r\n        default:\r\n            break;\r\n      }\r\n    });\r\n\r\n    return entityPathArray;\r\n  }\r\n\r\n  /**\r\n   * 转换为RestUrl里的路径\r\n   *\r\n   * 返回结果：\r\n   * 主表（/）：/\r\n   * 从表（/jiwtEdus）：/xxx/jiwtEdus\r\n   * 从从表（/jiwtEdus/jiwtGrades）： /xxx/jiwtEdus/xxx/jiwtGrades\r\n   */\r\n  public static convertToRestUrl(path: string, bindingData: BindingData): string {\r\n    const bindingPathArray: string[] = this.convertToBindingPathArray(path);\r\n    const restPathArray: string[] = [];\r\n\r\n    let currentBindingObject = bindingData.list.currentItem;\r\n    restPathArray.push(currentBindingObject.primaryKeyValue);\r\n\r\n    bindingPathArray.forEach((propName: string) => {\r\n      const propInfo = PropertyUtil.getPropertyByName(currentBindingObject.properties, propName);\r\n      if (propInfo.type !== BindingPropertyType.List) {\r\n        throw new Error(`${propInfo.name}不是子表对应的属性`);\r\n      }\r\n      const currentBindingList = currentBindingObject[propName];\r\n      currentBindingObject = currentBindingList.currentItem;\r\n      restPathArray.push(propName);\r\n      restPathArray.push(currentBindingObject.primaryKeyValue);\r\n    });\r\n\r\n    // 移除最后一个主键\r\n    restPathArray.pop();\r\n    return '/' + restPathArray.join('/');\r\n  }\r\n\r\n  /**\r\n   * 获取叶子节点的Path\r\n   */\r\n  public static getLeafPath(path: string): string {\r\n    const pathArray = DataPathUtil.convertToBindingPathArray(path);\r\n    return pathArray.pop();\r\n  }\r\n\r\n  /**\r\n   * 获取父路径\r\n   */\r\n  public static getParentPath(path: string): string {\r\n    const pathArray = DataPathUtil.convertToBindingPathArray(path);\r\n    pathArray.pop();\r\n    return '/' + pathArray.join('/');\r\n  }\r\n\r\n  /**\r\n   * 创建路径中的主键部分\r\n   */\r\n  private static createPrimaryKeyPath(primaryKey: string, primaryKeyValue: string) {\r\n    return `${primaryKey}:${primaryKeyValue}`;\r\n  }\r\n}\r\n\r\nexport { DataPathUtil };\r\n","// tslint:disable: max-line-length\r\n/**\r\n * GUID创建服务\r\n * @scope 静态类没有提供Provider\r\n */\r\nexport class Guid {\r\n\r\n    private constructor(guid: string) {\r\n        if (!guid) { throw new TypeError('Invalid argument; `value` has no value.'); }\r\n\r\n        this.value = Guid.EMPTY;\r\n\r\n        if (guid && Guid.isGuid(guid)) {\r\n            this.value = guid;\r\n        }\r\n    }\r\n\r\n\r\n    public static validator = new RegExp('^[a-z0-9]{8}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{12}$', 'i');\r\n\r\n    public static EMPTY = '00000000-0000-0000-0000-000000000000';\r\n\r\n    private value: string;\r\n\r\n    public static isGuid(guid: any) {\r\n        const value: string = guid.toString();\r\n        return guid && (guid instanceof Guid || Guid.validator.test(value));\r\n    }\r\n\r\n    public static create(): Guid {\r\n        return new Guid([Guid.gen(2), Guid.gen(1), Guid.gen(1), Guid.gen(1), Guid.gen(3)].join('-'));\r\n    }\r\n\r\n    public static createEmpty(): Guid {\r\n        return new Guid('emptyguid');\r\n    }\r\n\r\n    public static parse(guid: string): Guid {\r\n        return new Guid(guid);\r\n    }\r\n\r\n    public static raw(): string {\r\n        return [Guid.gen(2), Guid.gen(1), Guid.gen(1), Guid.gen(1), Guid.gen(3)].join('-');\r\n    }\r\n\r\n    private static gen(count: number) {\r\n        let out = '';\r\n        for (let i = 0; i < count; i++) {\r\n            // tslint:disable-next-line:no-bitwise\r\n            out += (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);\r\n        }\r\n        return out;\r\n    }\r\n\r\n    public equals(other: Guid): boolean {\r\n        // Comparing string `value` against provided `guid` will auto-call\r\n        // toString on `guid` for comparison\r\n        return Guid.isGuid(other) && this.value === other.toString();\r\n    }\r\n\r\n    public isEmpty(): boolean {\r\n        return this.value === Guid.EMPTY;\r\n    }\r\n\r\n    public toString(): string {\r\n        return this.value;\r\n    }\r\n\r\n    public toJSON(): any {\r\n        return {\r\n            value: this.value,\r\n        };\r\n    }\r\n}\r\n","/*\r\n * @Author: aalizzwell \r\n * @Date: 2019-10-25 13:30:52 \r\n * @Last Modified by:   aalizzwell \r\n * @Last Modified time: 2019-10-25 13:30:52 \r\n */\r\nimport { Observable } from 'rxjs';\r\n\r\nconst isObservable = (value) => {\r\n    if (!value) {\r\n        return false;\r\n    }\r\n    if (value[Symbol.observable] && value === value[Symbol.observable]()) {\r\n        return true;\r\n    }\r\n    if (value['@@observable'] && value === value['@@observable']()) {\r\n        return true;\r\n    }\r\n    if (value instanceof Observable) {\r\n        return true;\r\n    }\r\n    return false;\r\n}\r\nexport { isObservable }\r\n","import { makePropDecorator } from '../../core/index';\r\nimport { ObjectUtil } from '../../utils/index';\r\nimport { ClassType } from '../types';\r\nimport { PropMetadata } from './prop_meatadata';\r\n\r\n/**\r\n * 【对象属性元数据】接口\r\n */\r\nexport interface ObjectPropMetadata extends PropMetadata {\r\n\r\n  /**\r\n   * 映射字段\r\n   */\r\n  dataField?: string;\r\n\r\n  /**\r\n   * 原始字段名称\r\n   */\r\n  originalDataField?: string;\r\n\r\n  /**\r\n   * 表名\r\n   */\r\n  tableName?: string;\r\n\r\n  /**\r\n   * 引用实体类型\r\n   */\r\n  type?: ClassType;\r\n\r\n  /**\r\n   * 树分级类型(分级码=path 父路径=parent) \r\n   */\r\n  hierarchyType?: string;\r\n}\r\n\r\n\r\n/**\r\n * 【对象属性元数据】名称\r\n */\r\nexport const OBJECT_PROP_META = 'ObjectPropMeta';\r\n\r\n\r\n/**\r\n * 【对象属性元数据装饰器工厂】接口\r\n * @summaryh\r\n * obj 参数obj的值类型可以为 NgObjectProperty、string、ClassType\r\n * 当为string 时，则设其映射字段；\r\n * 当为ClassType时，则设置集合中的记录类型\r\n */\r\nexport interface ObjectPropMetaDecorator {\r\n\r\n  (obj: ObjectPropMetadata | string | ClassType): any;\r\n\r\n  new(obj: ObjectPropMetadata | string | ClassType): any;\r\n}\r\n\r\n\r\n/**\r\n * 【对象属性元数据装饰器工厂】的工厂\r\n */\r\nfunction makeObjectPropMetaDecorator(options: ObjectPropMetadata | string | ClassType): any {\r\n  if (ObjectUtil.isPlainObject(options)) {\r\n    return options;\r\n  }\r\n\r\n  const type = typeof options;\r\n  if (type === 'string') {\r\n    return {\r\n      dataField: options\r\n    };\r\n  }\r\n\r\n  if (type === 'function') {\r\n    return {\r\n      type: options\r\n    };\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * 对象属性元数据装饰器工厂\r\n */\r\nexport const ObjectPropMeta: ObjectPropMetaDecorator = makePropDecorator(OBJECT_PROP_META, makeObjectPropMetaDecorator);\r\n","import { makePropDecorator } from '../../core/index';\r\nimport { ObjectUtil } from '../../utils/index';\r\nimport { ClassType } from '../types';\r\nimport { PropMetadata } from './prop_meatadata';\r\n\r\n\r\n/**\r\n * 【动态对象元数据】接口\r\n */\r\nexport interface DynamicPropMetadata extends PropMetadata {\r\n\r\n  /**\r\n   * 映射字段\r\n   */\r\n  dataField?: string;\r\n\r\n  /**\r\n   * 原始字段名称\r\n   */\r\n  originalDataField?: string;\r\n\r\n  /**\r\n   * 表名\r\n   */\r\n  tableName?: string;\r\n\r\n  /**\r\n   * 引用实体类型\r\n   */\r\n  type?: ClassType;\r\n}\r\n\r\n\r\n/**\r\n * 【动态对象元数据装饰器】名称\r\n */\r\nexport const DYNAMIC_PROP_META = 'DynamicPropMeta';\r\n\r\n\r\n/**\r\n * 【动态对象元数据装饰器工厂】接口\r\n */\r\nexport interface DynamicPropMetaDecorator {\r\n\r\n  (obj: DynamicPropMetadata | string | ClassType): any;\r\n\r\n  new(obj: DynamicPropMetadata | string | ClassType): any;\r\n}\r\n\r\n\r\n/**\r\n * 【动态对象元数据装饰器工厂】的工厂\r\n */\r\nfunction makeDynamicPropMetaDecorator(options: DynamicPropMetadata | string | ClassType): any {\r\n  if (ObjectUtil.isPlainObject(options)) {\r\n    return options;\r\n  }\r\n\r\n  const type = typeof options;\r\n  if (type === 'string') {\r\n    return {\r\n      dataField: options\r\n    };\r\n  }\r\n\r\n  if (type === 'function') {\r\n    return {\r\n      type: options\r\n    };\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * 实体属性注解\r\n */\r\nexport const DynamicPropMeta: DynamicPropMetaDecorator = makePropDecorator(DYNAMIC_PROP_META, makeDynamicPropMetaDecorator);","import { makePropDecorator } from '../../core/index';\r\nimport { ObjectUtil } from '../../utils/index';\r\nimport { ClassType } from '../types';\r\nimport { PropMetadata } from './prop_meatadata';\r\n\r\n\r\n/**\r\n * 列表属性元数据\r\n */\r\nexport interface ListPropMetadata extends PropMetadata {\r\n\r\n  /**\r\n   * 表名\r\n   */\r\n  tableName?: string;\r\n\r\n  /**\r\n   * 字段名称\r\n   */\r\n  dataField?: string;\r\n\r\n  /**\r\n   * 原始字段名称\r\n   */\r\n  originalDataField?: string;\r\n\r\n  /**\r\n   * 实体类型\r\n   */\r\n  type?: any;\r\n}\r\n\r\n\r\n/**\r\n * 【列表属性元数据】名称\r\n */\r\nexport const LIST_PROP_META = 'ListPropMeta';\r\n\r\n\r\n/**\r\n * 【列表属性元数据装饰器工厂】接口\r\n */\r\nexport interface ListPropMetaDecorator {\r\n\r\n  (obj: ListPropMetadata | string | ClassType): any;\r\n\r\n  new(obj: ListPropMetadata | string | ClassType): any;\r\n\r\n}\r\n\r\n/**\r\n * 【列表属性元数据装饰器工厂】的工厂\r\n */\r\nfunction makeListPropMetaDecorator(options: ListPropMetadata | string | ClassType): any {\r\n  if (ObjectUtil.isPlainObject(options)) {\r\n    return options;\r\n  }\r\n\r\n  const type = typeof options;\r\n  if (type === 'string') {\r\n    return {\r\n      dataField: options\r\n    };\r\n  }\r\n\r\n  if (type === 'function') {\r\n    return {\r\n      type: options\r\n    };\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * 列表属性装饰器工厂\r\n */\r\nexport const ListPropMeta: ListPropMetaDecorator = makePropDecorator(LIST_PROP_META, makeListPropMetaDecorator);\r\n","import { MetadataUtil } from '../../core/index';\r\nimport {\r\n  PRIMITIVE_PROP_META, OBJECT_PROP_META, DYNAMIC_PROP_META, LIST_PROP_META,\r\n  PrimitivePropMetadata, ObjectPropMetadata, DynamicPropMetadata, ListPropMetadata\r\n} from './field_decorator';\r\n\r\n/**\r\n * 属性注解器通用方法\r\n */\r\nexport class FieldMetadataUtil {\r\n  /**\r\n   * 获取实体所有的简单属性元数据\r\n   * @param target 实体类型\r\n   * @returns 形如：{[propName: string]: NgObjectProperty}\r\n   */\r\n  static getNgFields(target: any): { [propName: string]: PrimitivePropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(target, PRIMITIVE_PROP_META);\r\n  }\r\n\r\n  /**\r\n   * 获取某个简单属性的元数据\r\n   */\r\n  static getNgField(target: any, propName: string): PrimitivePropMetadata {\r\n    const ngFields = this.getNgFields(target);\r\n    const ngField = ngFields[propName] as PrimitivePropMetadata;\r\n    return ngField;\r\n  }\r\n\r\n  /**\r\n   * 获取实体属性在原始数据中的属性名\r\n   */\r\n  static getDataField(target: any, propName: string) {\r\n    const ngField = this.getNgField(target, propName);\r\n    return ngField.dataField || propName;\r\n  }\r\n\r\n  /**\r\n   * 获取标注为NgObject的属性的元数据\r\n   * @param target 实体类型\r\n   * @returns 形如：{[propName: string]: NgObjectProperty}\r\n   */\r\n  static getNgObjects(target: any): { [propName: string]: ObjectPropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(target, OBJECT_PROP_META);\r\n  }\r\n\r\n  static getNgDynamic(target: any): { [propName: string]: ObjectPropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(target, DYNAMIC_PROP_META);\r\n  }\r\n\r\n  /**\r\n   * 获取标注为NgList的属性的元数据\r\n   * @param target 实体类型\r\n   * @returns 形如：{[propName: string]: NgListProperty}\r\n   */\r\n  static getNgList(target: any): { [propName: string]: ListPropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(target, LIST_PROP_META);\r\n  }\r\n\r\n  /**\r\n   * 获取实体标注为主键的属性元数据\r\n   * @param target 实体类型\r\n   */\r\n  static getPrimaryFieldMetadata(target: any): PrimitivePropMetadata | undefined {\r\n    const ngFieldObj = FieldMetadataUtil.getNgFields(target);\r\n    const primaryKey = Object.keys(ngFieldObj).find((prop: string) => {\r\n      return ngFieldObj[prop].primary;\r\n    });\r\n\r\n    if (primaryKey) {\r\n      const propMeta = ngFieldObj[primaryKey];\r\n      propMeta.property = primaryKey;\r\n      if (!propMeta.dataField) {\r\n        propMeta.dataField = primaryKey;\r\n      }\r\n\r\n      return propMeta;\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * 获取主键名称，没有主键时返回空字符串\r\n   */\r\n  static getPrimaryKey(entityType: any) {\r\n    const primaryNgField = this.getPrimaryFieldMetadata(entityType);\r\n    if (!primaryNgField) {\r\n      return '';\r\n    }\r\n    return primaryNgField.property;\r\n  }\r\n\r\n}\r\n","import { Type } from '../../core/index';\r\nimport { MetadataUtil } from '../../core/index';\r\nimport { Entity } from '../entity';\r\n\r\nimport {\r\n  PropMetadata, PRIMITIVE_PROP_META, PrimitivePropMetadata, OBJECT_PROP_META, ObjectPropMetadata,\r\n  DYNAMIC_PROP_META, DynamicPropMetadata, LIST_PROP_META,    ListPropMetadata\r\n} from './field_decorator';\r\n\r\n/**\r\n * 实体元数据工具类\r\n */\r\nexport class EntityMetadataUtil {\r\n\r\n  /**\r\n   * 获取所有属性\r\n   * @todo：封装根据基类获取所有元数据的方法，解决重复代码\r\n   */\r\n  static getAllNgProperties(entityType: Type<Entity>): { [propName: string]: PropMetadata } {\r\n    const ngPlainProperties = this.getNgFieldProperties(entityType);\r\n    const ngEntityProperties = this.getNgObjectProperties(entityType);\r\n    const ngDynamicProperties = this.getNgDynamicProperties(entityType);\r\n    const ngEntityListProperties = this.getNgObjectProperties(entityType);\r\n\r\n    return Object.assign({},\r\n      ngPlainProperties,   ngEntityProperties,\r\n      ngDynamicProperties, ngEntityListProperties\r\n    );\r\n  }\r\n\r\n  /**\r\n   * 获取NgField的属性元数据\r\n   */\r\n  static getNgFieldProperties(entityType: any): { [propName: string]: PrimitivePropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(entityType, PRIMITIVE_PROP_META);\r\n  }\r\n\r\n  /**\r\n   * 获取NgObject属性元数据\r\n   */\r\n  static getNgObjectProperties(entityType: any): { [propName: string]: ObjectPropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(entityType, OBJECT_PROP_META);\r\n  }\r\n\r\n  /**\r\n   * 获取NgDynamic属性元数据\r\n   */\r\n  static getNgDynamicProperties(entityType: any): { [propName: string]: DynamicPropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(entityType, DYNAMIC_PROP_META);\r\n  }\r\n\r\n  /**\r\n   * 获取NgList属性元数据\r\n   */\r\n  static getNgListProperties(entityType: any): { [propName: string]: ListPropMetadata } {\r\n    return MetadataUtil.getPropsMetadatasByName(entityType, LIST_PROP_META);\r\n  }\r\n\r\n  /**\r\n   * 获取主键属性元数据\r\n   */\r\n  static getPrimaryKeyProperty(entityType: Type<Entity>): PrimitivePropMetadata {\r\n    let primaryKeyProperty;\r\n    const ngPlainProperties = EntityMetadataUtil.getNgFieldProperties(entityType);\r\n    Object.keys(ngPlainProperties).forEach((propName: string) => {\r\n      const ngProperty = ngPlainProperties[propName] as PrimitivePropMetadata;\r\n      if (ngProperty.primary === true) {\r\n        primaryKeyProperty = ngProperty;\r\n      }\r\n    });\r\n\r\n    return primaryKeyProperty;\r\n  }\r\n}\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-12-07 09:05:09\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2018-12-27 20:35:02\r\n */\r\n\r\nimport { Type } from '../../core/types';\r\nimport {\r\n  PropMetadata, PrimitivePropMetadata, ObjectPropMetadata, DynamicPropMetadata, ListPropMetadata,\r\n  EntityMetadataUtil\r\n} from '../metadata/index';\r\nimport { DataPropGroup, DataPropInfo } from './data_prop_info';\r\n\r\n/**\r\n * 实体类型信息\r\n * @todo：\r\n * 1、构造时不应该识别Entity模块的东西，应该是更抽象的；\r\n * 2、构造函数应该接收一个Builder接口，由Entity或者其他实现层来实现这个接口。\r\n */\r\nclass DataTypeInfo {\r\n\r\n  /**\r\n   * 数据类型\r\n   */\r\n  public type: Type<any>;\r\n\r\n  /**\r\n   * 属性集合\r\n   */\r\n  public propInfoMap: Map<string, DataPropInfo>;\r\n\r\n  /**\r\n   * 主键\r\n   */\r\n  public primaryKey: string;\r\n\r\n  /**\r\n   * 外键\r\n   */\r\n  public foreignKey: string;\r\n\r\n  /**\r\n   * 是否为值对象\r\n   */\r\n  public get isValueObject() {\r\n    return !this.primaryKey;\r\n  }\r\n\r\n  /**\r\n   * 构造函数\r\n   * @todo：不应该识别\r\n   */\r\n  constructor(type: any) {\r\n    this.type = type;\r\n    this.primaryKey = '';\r\n    this.foreignKey = '';\r\n    this.propInfoMap = new Map<string, DataPropInfo>();\r\n    this.collectPropInfos();\r\n  }\r\n\r\n  /**\r\n   * 获取全部属性信息\r\n   */\r\n  public getPropInfos(): DataPropInfo[] {\r\n    return Array.from(this.propInfoMap.values());\r\n  }\r\n\r\n  /**\r\n   * 获取全部属性的名称\r\n   */\r\n  public getPropNames(): string[] {\r\n    const propNames = [];\r\n    const propInfos = this.getPropInfos();\r\n    propInfos.forEach((propInfo) => {\r\n      propNames.push(propInfo.name);\r\n    });\r\n    return propNames;\r\n  }\r\n\r\n  /**\r\n   * 根据group获取属性信息数组\r\n   */\r\n  public getPropInfosByGroup(group: DataPropGroup): DataPropInfo[] {\r\n    const allPropInfos = Array.from(this.propInfoMap.values());\r\n    const propInfos = allPropInfos.filter((propInfo: DataPropInfo) => {\r\n      return propInfo.group === group;\r\n    });\r\n    return propInfos;\r\n  }\r\n\r\n  /**\r\n   * 根据group获取属性名称数组\r\n   * @param group 属性分组\r\n   */\r\n  public getPropNamesByGroup(group: DataPropGroup): string[] {\r\n    const propNames = [];\r\n    const propInfos = this.getPropInfosByGroup(group);\r\n    propInfos.forEach((propInfo) => {\r\n      propNames.push(propInfo.name);\r\n    });\r\n    return propNames;\r\n  }\r\n\r\n  /**\r\n   * 根据propName获取属性信息\r\n   */\r\n  public getPropInfoByName(propName: string): DataPropInfo {\r\n    if (this.propInfoMap.has(propName)) {\r\n      return this.propInfoMap.get(propName);\r\n    }\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * 根据path获取属性信息\r\n   */\r\n  public getPropInfoByPath(path: string[]): DataPropInfo {\r\n\r\n    // 先复制，防止shift方法产生污染\r\n    const arrPath = path.concat([]);\r\n    if (arrPath.length === 0) {\r\n      throw Error(`属性路径不能为空`);\r\n    }\r\n\r\n    // 循环查找\r\n    let typeInfo = this;\r\n    let propInfo = null;\r\n    while (typeInfo && arrPath.length > 0) {\r\n\r\n      const propName = arrPath.shift();\r\n      propInfo = typeInfo.getPropInfoByName(propName);\r\n      if (!propInfo) {\r\n        throw Error(`路径${path}中存在不正确的节点${propName}，请检查`);\r\n      }\r\n      typeInfo = propInfo.typeInfo;\r\n\r\n      // 如果是动态列，并且路径数组里还有属性，统一设置为null(动态列不再描述属性信息)\r\n      if (propInfo.group === DataPropGroup.Dynamic && arrPath.length > 0) {\r\n        propInfo = null;\r\n        typeInfo = null;\r\n      }\r\n    }\r\n\r\n    return propInfo;\r\n  }\r\n\r\n  /**\r\n   * 根据path获取对应属性的TypeInfo\r\n   */\r\n  public getTypeInfoByPath(path: string[]): DataTypeInfo {\r\n\r\n    // 空数组时返回\r\n    if (path.length === 0) {\r\n      return this;\r\n    }\r\n\r\n    // 获取对应属性信息\r\n    const propInfo = this.getPropInfoByPath(path);\r\n    if (!propInfo.typeInfo) {\r\n      throw Error(`路径${path}无法定位到一个EntityTypeInfo，请检查`);\r\n    }\r\n\r\n    return propInfo.typeInfo;\r\n  }\r\n\r\n  /**\r\n   * 获取主键的属性信息\r\n   */\r\n  public getPrimaryKeyPropInfo(): DataPropInfo {\r\n    return this.getPropInfoByName(this.primaryKey);\r\n  }\r\n\r\n  /**\r\n   * 根据name获取影射名\r\n   */\r\n  public getPropMappingByName(name: string): string {\r\n    const propInfo = this.getPropInfoByName(name);\r\n    if (!propInfo) {\r\n      return '';\r\n    }\r\n    return propInfo.mapping;\r\n  }\r\n\r\n  /**\r\n   * 根据path获取映射名\r\n   */\r\n  public getPropMappingByPath(path: string[]): string {\r\n    const propInfo = this.getPropInfoByPath(path);\r\n    if (!propInfo) {\r\n      return '';\r\n    }\r\n    return propInfo.mapping;\r\n  }\r\n\r\n  /**\r\n   * 检查属性是否属于特定的分组\r\n   */\r\n  public checkPropGroup(propName: string, propGroup: DataPropGroup): boolean {\r\n    const propInfo = this.getPropInfoByName(propName);\r\n    if (propInfo && propInfo.group === propGroup) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n\r\n  /**\r\n   * --------------------------------------------------------------------------------\r\n   * 属性元数据 => 属性描述信息\r\n   * --------------------------------------------------------------------------------\r\n   */\r\n\r\n  /**\r\n   * 搜集所有属性信息\r\n   * @todo：消除重复代码，ts不支持interface类型检测，暂时通过遍历实现。\r\n   */\r\n  private collectPropInfos() {\r\n\r\n    // 简单属性\r\n    const ngPlainProperties = EntityMetadataUtil.getNgFieldProperties(this.type);\r\n    Object.keys(ngPlainProperties).forEach((propName: string) => {\r\n      const ngProperty = ngPlainProperties[propName] as PrimitivePropMetadata;\r\n      if (ngProperty.primary === true) {\r\n        this.primaryKey = propName;\r\n      }\r\n      if (ngProperty.foreign === true) {\r\n        this.foreignKey = propName;\r\n      }\r\n      this.addPropInfo(DataPropGroup.Primitive, propName, ngProperty.dataField, null, ngProperty);\r\n    });\r\n\r\n    // 实体属性\r\n    const ngEntityProperties = EntityMetadataUtil.getNgObjectProperties(this.type);\r\n    Object.keys(ngEntityProperties).forEach((propName: string) => {\r\n      const ngProperty = ngEntityProperties[propName] as ObjectPropMetadata;\r\n      this.addPropInfo(DataPropGroup.Object, propName, ngProperty.dataField, ngProperty.type, ngProperty);\r\n    });\r\n\r\n    // 动态实体属性\r\n    const ngDynamicProperties = EntityMetadataUtil.getNgDynamicProperties(this.type);\r\n    Object.keys(ngDynamicProperties).forEach((propName: string) => {\r\n      const ngProperty = ngDynamicProperties[propName] as DynamicPropMetadata;\r\n      this.addPropInfo(DataPropGroup.Dynamic, propName, ngProperty.dataField, null, ngProperty);\r\n    });\r\n\r\n    // 实体列表属性\r\n    const ngEntityListProperties = EntityMetadataUtil.getNgListProperties(this.type);\r\n    Object.keys(ngEntityListProperties).forEach((propName: string) => {\r\n      const ngProperty = ngEntityListProperties[propName] as ListPropMetadata;\r\n      this.addPropInfo(DataPropGroup.List, propName, ngProperty.dataField, ngProperty.type, ngProperty);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 添加属性信息\r\n   */\r\n  private addPropInfo(group: DataPropGroup, name: string, mapping: string, type: Type<any>, metadataInfo: PropMetadata) {\r\n\r\n    // 没有设置影射时，用属性名充当影射\r\n    mapping = mapping ? mapping : name;\r\n    let typeInfo = null;\r\n    if (type) {\r\n      typeInfo = new DataTypeInfo(type);\r\n    }\r\n    const propInfo = { group, name, mapping, typeInfo, metadataInfo };\r\n    this.propInfoMap.set(name, propInfo);\r\n  }\r\n\r\n}\r\n\r\nexport { DataTypeInfo };\r\n","\r\nimport { DataTypeInfo, DataPropGroup  } from '../entity-type-info/index';\r\nimport { Entity  } from '../index';\r\nimport { Repository, EntityManager } from '../../repository/index';\r\nimport { BindingData } from '../../binding-data/index';\r\nimport { DataPathNode, DataPathNodeType } from './data_path_node';\r\nimport { DataPath } from './data_path';\r\n\r\n/**\r\n * 数据Path工厂类\r\n */\r\nclass DataPathCreator {\r\n\r\n  /**\r\n   * 将长路径数组或字符串转换为\r\n   * @param fullPathArrayOrString 路径数组或字符串\r\n   * @param repository 实体仓库\r\n   * @summary\r\n   * 1、长路径格式说明参考：data-path.md\r\n   */\r\n  public static createByLongPathFromRoot(fullPathArrayOrString: string[] | string, entityManager: EntityManager<Entity>): DataPath {\r\n    const dataPath = new DataPath();\r\n    const fullPathArray = fullPathArrayOrString as string[];\r\n    if (!fullPathArray || fullPathArray.length === 0) {\r\n      return dataPath;\r\n    }\r\n\r\n    let currentNodeInfo = {\r\n      nodeValue: fullPathArray.shift(),\r\n      nodeType: DataPathNodeType.DataId,\r\n      entityTypeInfo: new DataTypeInfo(entityManager.entityType)\r\n    };\r\n    while (currentNodeInfo) {\r\n      dataPath.push(currentNodeInfo.nodeType, currentNodeInfo.nodeValue);\r\n\r\n      // 处理下一个节点\r\n      const nextNodeValue = fullPathArray.shift();\r\n      if (!nextNodeValue || !currentNodeInfo.entityTypeInfo) {\r\n        break;\r\n      }\r\n      currentNodeInfo = this.getNextPathNodeInfo(currentNodeInfo, nextNodeValue);\r\n    }\r\n\r\n    return dataPath;\r\n  }\r\n\r\n  /**\r\n   * 获取下一个路径节点的信息\r\n   * @param parentNodeInfo 当前路径节点信息\r\n   * @param nextNodeValue 下一个路径节点的值\r\n   * @summary\r\n   * 1、这个递归写的很绕，说明数据结构设计不合理；\r\n   * 2、多个因素混用了一个结构；\r\n   */\r\n  private static getNextPathNodeInfo(parentNodeInfo: any, nextNodeValue: string): any {\r\n\r\n    const parentNodeValue = parentNodeInfo.nodeValue;\r\n    const parentNodeType = parentNodeInfo.nodeType;\r\n    const parentEntityTypeInfo = parentNodeInfo.entityTypeInfo;\r\n\r\n    if (!nextNodeValue || !parentEntityTypeInfo) {\r\n      return null;\r\n    }\r\n\r\n    const nextPathNodeInfo = {\r\n      nodeValue: nextNodeValue,\r\n      nodeType: null,\r\n      entityTypeInfo: null\r\n    };\r\n\r\n\r\n    // DataNodeType=List：下一节点肯定是Object，并且EntityTypeInfo不变\r\n    if (parentNodeType === DataPathNodeType.DataId) {\r\n      nextPathNodeInfo.nodeType = DataPathNodeType.PropName;\r\n      nextPathNodeInfo.entityTypeInfo = parentEntityTypeInfo;\r\n    } else {\r\n\r\n      // DataNodeType=Object：必然对应一个属性信息\r\n      const nextPropInfo = parentEntityTypeInfo.getPropInfoByName(parentNodeValue);\r\n      if (nextPropInfo.group === DataPropGroup.List) {\r\n\r\n        // EntityPropGroup=EntityList：下一个节点是List类型。\r\n        nextPathNodeInfo.nodeType = DataPathNodeType.DataId;\r\n        nextPathNodeInfo.entityTypeInfo = nextPropInfo.typeInfo;\r\n      } else {\r\n\r\n        // EntityPropGroup=Entity：       下级entityTypeInfo为\r\n        // EntityPropGroup=Dynamic|Plain：null\r\n        nextPathNodeInfo.nodeType = DataPathNodeType.PropName;\r\n        nextPathNodeInfo.entityTypeInfo = nextPropInfo.group === DataPropGroup.Object ? nextPropInfo.typeInfo : null;\r\n      }\r\n    }\r\n\r\n    return nextPathNodeInfo;\r\n  }\r\n\r\n  /**\r\n   * @param fullPathArrayOrString 路径数组或字符串\r\n   * @param repository 实体仓库\r\n   * @summary\r\n   * 1、长路径格式说明参考：data-path.md\r\n   * 2、shortPathArrayOrString暂时只支持字符串数组\r\n   */\r\n  public static createByShortPathFromRoot(\r\n    shortPathArrayOrString: string[] | string, entityManager: EntityManager<Entity>, bindingData: BindingData\r\n  ): DataPath {\r\n\r\n    const dataPath = new DataPath();\r\n    const shortPathArray: string[] = shortPathArrayOrString as string[];\r\n\r\n    // 根节点\r\n    let currentBindingObject = bindingData.list.currentItem;\r\n    let currentEntityTypeInfo = new DataTypeInfo(entityManager.entityType);\r\n    dataPath.push(DataPathNodeType.DataId, currentBindingObject.primaryKeyValue);\r\n\r\n    // 遍历下级节点\r\n    shortPathArray.forEach((propName: string) => {\r\n      const propInfo = currentEntityTypeInfo.getPropInfoByName(propName);\r\n      switch (propInfo.group) {\r\n        case DataPropGroup.Primitive:\r\n          dataPath.push(DataPathNodeType.PropName, propName);\r\n          break;\r\n        case DataPropGroup.Object:\r\n          currentBindingObject = currentBindingObject[propName];\r\n          currentEntityTypeInfo = propInfo.typeInfo;\r\n          dataPath.push(DataPathNodeType.PropName, propName);\r\n\r\n          break;\r\n        case DataPropGroup.List:\r\n          const currentBindingList = currentBindingObject[propName];\r\n          currentBindingObject = currentBindingList.currentItem;\r\n          currentEntityTypeInfo = propInfo.typeInfo;\r\n\r\n          dataPath.push(DataPathNodeType.PropName, propName);\r\n          dataPath.push(DataPathNodeType.DataId, currentBindingObject.primaryKeyValue);\r\n          break;\r\n        default:\r\n            break;\r\n      }\r\n    });\r\n\r\n    return dataPath;\r\n  }\r\n\r\n}\r\n\r\nexport { DataPathCreator };\r\n","export const PARENT_PATH = '__PARENT_PATH__';\r\nexport const PARENT_CLASS = '__PARENT__';\r\n\r\nexport type ClassType = new (...args: any[]) => any;\r\n\r\nexport interface Dynamic {\r\n  loadDynamicData(dynamicData: any): void;\r\n}\r\n","import { Type } from '../core/index';\r\nimport { Entity } from './entity';\r\n\r\n/**\r\n * 创建实体\r\n * @param entityType 实体类型\r\n * @param entityData 实体数据\r\n */\r\nexport function createEntity<T extends Entity>(entityType: Type<any>, entityData: any): T {\r\n  const entity = new entityType(entityData);\r\n  return entity;\r\n}\r\n\r\n/**\r\n * 批量创建实体\r\n * @param entityType     实体类型\r\n * @param entityListData 实体数据数组\r\n */\r\nexport function createEntities<T extends Entity>(entityType: Type<any>, entityListData: any): T[] {\r\n  const entities: T[] = [];\r\n  entityListData.forEach((entityData: any) => {\r\n    const entity = createEntity<T>(entityType, entityData);\r\n    entities.push(entity);\r\n  });\r\n  return entities;\r\n}\r\n\r\n/**\r\n * 已弃用：请使用createEntity方法代替。\r\n */\r\nexport function EntityFactory<T extends Entity>(T: new (...args: any[]) => any, data: any): T {\r\n  const entity = new T(data);\r\n  return entity;\r\n}\r\n\r\n\r\n\r\n","import { Subject } from 'rxjs';\r\nimport { ChangeSet } from '../changeset/change_set';\r\nimport { Modification, ModifyType } from '../changeset/types';\r\nimport { Entity } from './entity';\r\nimport { EntityFactory } from './entity_creator';\r\nimport { PARENT_CLASS, PARENT_PATH, ClassType } from './types';\r\n\r\nexport interface IList<T> {\r\n  [index: number]: T;\r\n}\r\n/**\r\n * 实体集合列表\r\n */\r\nexport class EntityList<T extends Entity> implements IList<T>, Iterable<T> {\r\n\r\n  // #region 私有属性\r\n\r\n  /**\r\n   * 已废弃：请勿使用\r\n   */\r\n  private rawData: T[];\r\n\r\n  /**\r\n   * 已废弃：请勿使用\r\n   */\r\n  private listChanged = new Subject<Modification>();\r\n\r\n  /**\r\n   * 已废弃：请勿使用\r\n   */\r\n  private changeSet = new ChangeSet();\r\n  // #endregion\r\n\r\n\r\n  // #region 公有属性\r\n\r\n  /**\r\n   * 集合改变时触发(新增、行记录修改、删除)\r\n   * @event\r\n   */\r\n  public onListChanged = this.listChanged.asObservable();\r\n\r\n  /**\r\n   * 获取项集合\r\n   */\r\n  public get items(): T[] {\r\n    return this.rawData;\r\n  }\r\n\r\n  /**\r\n   * 列表变更集\r\n   */\r\n  public get changes() {\r\n    return this.changeSet.changes;\r\n  }\r\n\r\n  /**\r\n   * 获取指定索引处的值\r\n   */\r\n  [index: number]: T;\r\n\r\n  /**\r\n   * 迭代器\r\n   */\r\n  *[Symbol.iterator](): Iterator<T> {\r\n    yield* this.items;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  /**\r\n   * @param data JSON数据集合\r\n   * @param type 集合中的实体类型\r\n   */\r\n  constructor(data?: any[], type?: ClassType) {\r\n    this.clear();\r\n    if (data) {\r\n      // this.loadEntities(data);\r\n      data.forEach(item => {\r\n        this.initEntity(EntityFactory(type, item));\r\n      });\r\n    }\r\n  }\r\n\r\n\r\n  // #region 公有方法\r\n\r\n  /** 加载实体列表 */\r\n  public loadEntities(entities: T[]) {\r\n    this.clear();\r\n\r\n    entities.forEach(entity => {\r\n      this.initEntity(entity);\r\n    });\r\n\r\n    // 发送Load变更\r\n    const changeItem = {\r\n      path: [],\r\n      value: entities,\r\n      preValue: undefined,\r\n      type: ModifyType.Load\r\n    };\r\n    this.setChanges(changeItem);\r\n  }\r\n  /**\r\n   * 清空\r\n   */\r\n  public clear() {\r\n    this.rawData = [];\r\n  }\r\n\r\n  /**\r\n   * 添加实体对象到集合中，并返回新加的对象\r\n   * @param entity 实体对象\r\n   */\r\n  public appendNew(entity: T): T {\r\n    const newEntity = this.initEntity(entity);\r\n\r\n    // 新增变更\r\n    const changeItem = {\r\n      path: [],\r\n      value: [newEntity],\r\n      preValue: undefined,\r\n      type: ModifyType.Add\r\n    };\r\n\r\n    this.setChanges(changeItem);\r\n    return newEntity;\r\n  }\r\n\r\n  /**\r\n   * 追加实体\r\n   */\r\n  public appendEntity(entity: T): void {\r\n    const newEntity = this.initEntity(entity);\r\n\r\n    // 新增变更\r\n    const changeItem = {\r\n      path: [],\r\n      value: [newEntity],\r\n      preValue: undefined,\r\n      type: ModifyType.Add\r\n    };\r\n\r\n    this.setChanges(changeItem);\r\n  }\r\n\r\n  /**\r\n   * 批量追加实体\r\n   */\r\n  public appendEntities(entities: T[]): void {\r\n    const newEntites = entities.map((entity: T) => {\r\n      return this.initEntity(entity);\r\n    });\r\n    const changeItem = {\r\n      path: [],\r\n      value: newEntites,\r\n      preValue: undefined,\r\n      type: ModifyType.Add\r\n    };\r\n\r\n    this.setChanges(changeItem);\r\n  }\r\n\r\n  /**\r\n   * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败\r\n   * @param primaryId 主键ID\r\n   */\r\n  public remove(primaryId: string): boolean {\r\n    const total = this.count();\r\n    const indexToRemove = this.rawData.findIndex((entity: Entity) => {\r\n      return entity.primaryValue === primaryId;\r\n    });\r\n    if (indexToRemove === -1) {\r\n      return false;\r\n    }\r\n    const entityToRemove = this.rawData[indexToRemove];\r\n    this.rawData.splice(indexToRemove, 1);\r\n\r\n    // 删除变更\r\n    const changeItem = {\r\n      path: [],\r\n      value: { [entityToRemove.primaryProperty.dataField]: primaryId },\r\n      preValue: undefined,\r\n      type: ModifyType.Remove\r\n    };\r\n\r\n    this.updateIndex(total);\r\n    this.setChanges(changeItem);\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * 从集合中获取指定ID值的实体对象\r\n   * @param id 主键值\r\n   */\r\n  public get(id: string) {\r\n    return this.items.find(item => {\r\n      return item.primaryValue === id;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 将变更记录添加到集合变更集中\r\n   * @param value 变更记录\r\n   */\r\n  public setChanges(modinfo: Modification) {\r\n    // 向app层发送的变更\r\n    this.listChanged.next(modinfo);\r\n\r\n    // 构造向changeSet中添加的chagne\r\n    const change = Object.assign({}, modinfo);\r\n    if (modinfo.type === ModifyType.Add && modinfo.value[0] instanceof Entity) {\r\n      change.value = [modinfo.value[0].data];\r\n    }\r\n    this.changeSet.append(change);\r\n  }\r\n\r\n  /** 集合总记录数 */\r\n  public count() {\r\n    return this.items.length;\r\n  }\r\n\r\n  /**\r\n   * 获取实体对象的索引值\r\n   */\r\n  public indexOf(entity: T): number {\r\n    return this.items.indexOf(entity);\r\n  }\r\n\r\n  /**\r\n   * 计算集合中某个属性的总和\r\n   * @param propertyName 属性名称\r\n   */\r\n  public sum(propertyName: string): number {\r\n    if (this.count() === 0) {\r\n      return 0;\r\n    }\r\n    return this.items.reduce((val, curr: T) => {\r\n      return val + curr[propertyName];\r\n    }, 0);\r\n  }\r\n\r\n  /**\r\n   * 已废弃：请使用toJSON方法代替\r\n   * @deprecated\r\n   */\r\n  public toJson() {\r\n    return this.rawData;\r\n  }\r\n\r\n  /**\r\n   * 转换为JSON格式\r\n   */\r\n  public toJSON(): any[] {\r\n    const result = [];\r\n    this.items.forEach((entity: Entity) => {\r\n      result.push(entity.toJSON());\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public toArray(): T[] {\r\n    return this.items;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 私有方法\r\n\r\n  /**\r\n   * 实体初始化\r\n   * @param entity 实体\r\n   */\r\n  private initEntity(entity: T): T {\r\n    entity[PARENT_CLASS] = this;\r\n    entity[PARENT_PATH] = this[PARENT_PATH];\r\n    entity.onValueChanged.subscribe((v: Modification) => {\r\n      const path = v.path;\r\n      const value = v.value;\r\n      const preValue = v.preValue;\r\n      const operator = v.type;\r\n      const subChanges = { path, value, preValue, type: operator };\r\n      this.setChanges(subChanges);\r\n    });\r\n    // TODO: 添加数据验证逻辑代码\r\n    const newLength = this.rawData.push(entity);\r\n    this[newLength - 1] = entity;\r\n\r\n    return entity;\r\n  }\r\n\r\n  /**\r\n   * 更新索引\r\n   * @param total 总记录数\r\n   */\r\n  private updateIndex(total: number) {\r\n    for (let i = 0; i < total; i++) {\r\n      delete this[i];\r\n    }\r\n    this.rawData.forEach((entity, index) => {\r\n      this[index] = entity;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 获取属性名称\r\n   */\r\n  private getPropertyName() {\r\n    const path = this[PARENT_PATH];\r\n    if (path && path.length) {\r\n      const name = path[path.length - 1];\r\n      return name;\r\n    }\r\n    return undefined;\r\n  }\r\n\r\n  // #endregion\r\n\r\n}\r\n","import { Entity } from './entity';\r\n\r\nexport function EntityFactory<T extends Entity>(T: new (...args: any[]) => any, data: any): T {\r\n    const entity = new T(data);\r\n    return entity;\r\n}\r\n","import { Observable, Subject, from, of } from 'rxjs';\r\nimport { scan, map, tap } from 'rxjs/operators';\r\nimport { PrimitivePropMetadata, ListPropMetadata, ObjectPropMetadata, DynamicPropMetadata, FieldMetadataUtil } from './metadata/index';;\r\nimport { Modification, ModifyType, ChangeSet } from '../changeset/index';\r\nimport { PARENT_PATH, PARENT_CLASS, Dynamic } from './types';\r\nimport { EntityList } from './entity_list';\r\nimport { EntityFactory } from './entity_factory';\r\n\r\n/**\r\n * @author Lucas Huang\r\n * 实体抽象基类，所有实体必须扩展自Entity\r\n *\r\n * ### 使用示例\r\n * ```\r\n * export class UserEntity extends Entity {\r\n *    userId: string;\r\n *    userName: string;\r\n *\r\n *    constructor(data: any){\r\n *        super(data);\r\n *    }\r\n * }\r\n * ```\r\n */\r\nexport abstract class Entity {\r\n\r\n\r\n  // #region 私有、保护属性\r\n\r\n  /**\r\n   * 验证错误集合\r\n   */\r\n  private validErrors = {};\r\n\r\n  /**\r\n   * 增量变更集合\r\n   */\r\n  protected changeSet = new ChangeSet();\r\n\r\n  /**\r\n   * 是否正在验证\r\n   */\r\n  protected isValidating = false;\r\n\r\n  /**\r\n   * 新数据\r\n   */\r\n  protected newData = undefined;\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 公有属性\r\n\r\n  /**\r\n   * 变更流\r\n   */\r\n  public valueChanged = new Subject<Modification>();\r\n\r\n  /**\r\n   * 属性值改变时触发\r\n   *\r\n   * ### 使用示例\r\n   * ```\r\n   *  const entity = new UserEntity(data);\r\n   *  entity.onValueChanged.subscribe((data: Modification) => {\r\n   *      console.log(data);\r\n   *  })\r\n   *\r\n   * ```\r\n   *\r\n   * @event\r\n   */\r\n  public onValueChanged = this.valueChanged.asObservable();\r\n\r\n  /**\r\n   * 返回JSON格式的数据\r\n   */\r\n  public get data(): any {\r\n    return this.newData;\r\n  }\r\n\r\n  /**\r\n   * 验证错误集合\r\n   */\r\n  public get errors() {\r\n    return this.validErrors;\r\n  }\r\n\r\n  /**\r\n   * 实体变更集\r\n   */\r\n  public get changes(): Modification[] {\r\n    return this.changeSet.changes;\r\n  }\r\n\r\n  /**\r\n   * 实体主键元数据\r\n   */\r\n  public get primaryProperty(): PrimitivePropMetadata {\r\n    return FieldMetadataUtil.getPrimaryFieldMetadata(this.constructor);\r\n  }\r\n\r\n  /**\r\n   * 主键\r\n   * @todo\r\n   * 1、没有主键时返回''不合理，应该返回undefined\r\n   */\r\n  public get primaryKey(): string {\r\n    if (this.primaryProperty) {\r\n      return this.primaryProperty.property;\r\n    } else {\r\n      return '';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 实体主键值\r\n   * 1、没有主键时返回''不合理，应该返回undefined\r\n   */\r\n  public get primaryValue(): string {\r\n    if (this.primaryKey) {\r\n      // return this[this.primaryProperty.property].toString();\r\n      const primaryValue = this[this.primaryProperty.property];\r\n      return primaryValue ? primaryValue : '';\r\n    } else {\r\n      return '';\r\n    }\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  /**\r\n   * @param data JSON数据\r\n   */\r\n  constructor(data: any) {\r\n    this.newData = Object.assign({}, data);\r\n    this.onValueChanged = this.valueChanged;\r\n    this.initialize();\r\n  }\r\n\r\n\r\n  // #region 公有方法\r\n\r\n  /**\r\n   * 将变更记录保存至变更集中\r\n   * @param value 变更记录\r\n   */\r\n  public setChanges(value: Modification): void {\r\n    const propertyName = value.path[value.path.length - 1];\r\n\r\n    // @todo：事件会从下级向上冒泡，change可能是下级的，不能和当前Entity的newData合并。\r\n    // this.newData = Object.assign(this.newData, { [propertyName]: value.value });\r\n\r\n    this.valueChanged.next(value);\r\n    this.changeSet.append(value);\r\n  }\r\n\r\n  public getPaths() {\r\n    const pathObj = {\r\n      path: [],\r\n      isUdt: false,\r\n      isGrid: false\r\n    };\r\n    const handleParent = item => {\r\n      const parentPaths = item[PARENT_PATH];\r\n      if (parentPaths) {\r\n        const prop = parentPaths[parentPaths.length - 1];\r\n        // 父级所在实体包含的ngObject，存在当前实体字段，则判断为UDt字段\r\n        if (Object.keys(FieldMetadataUtil.getNgObjects(item[PARENT_CLASS].constructor)).indexOf(prop) > -1) {\r\n          pathObj.isUdt = true;\r\n        }\r\n        // 存在类型为ngList，则判断为grid\r\n        if (item[PARENT_CLASS] && item instanceof EntityList === true) {\r\n          pathObj.isGrid = true;\r\n        }\r\n        pathObj.path.push(prop);\r\n      }\r\n      if (item[PARENT_CLASS] && item instanceof EntityList === true) {\r\n        handleParent(item[PARENT_CLASS]);\r\n      }\r\n    };\r\n    handleParent(this);\r\n    pathObj.path = pathObj.path.reverse();\r\n    return pathObj;\r\n  }\r\n\r\n  /**\r\n   * 加载数据\r\n   * @param data 新数据\r\n   */\r\n  public load(data: any) {\r\n    if (!data) {\r\n      data = {};\r\n    }\r\n\r\n    this.loadFields(data);\r\n    this.loadLists(data);\r\n    this.loadObjects(data);\r\n\r\n    this.loadDynamicObjects(data);\r\n    this.newData = Object.assign({}, data);\r\n  }\r\n\r\n  /**\r\n   * 转换为JSON\r\n   */\r\n  public toJSON() {\r\n    const result = {};\r\n\r\n    // 简单属性\r\n    const ngFields = FieldMetadataUtil.getNgFields(this.constructor);\r\n    Object.keys(ngFields).forEach((propName: string) => {\r\n      const ngField = ngFields[propName];\r\n      const dataField = ngField.dataField || propName;\r\n      result[dataField] = this[propName];\r\n    });\r\n\r\n    // 对象属性\r\n    const ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);\r\n    Object.keys(ngObjects).forEach((propName: string) => {\r\n      const ngObject = ngObjects[propName];\r\n      const dataField = ngObject.dataField || propName;\r\n      result[dataField] = this[propName] ? this[propName].toJSON() : {};\r\n    });\r\n\r\n    // 动态属性\r\n    const ngDynamics = FieldMetadataUtil.getNgDynamic(this.constructor);\r\n    Object.keys(ngDynamics).forEach((propName: string) => {\r\n      const ngDynamic = ngDynamics[propName];\r\n      const dataField = ngDynamic.dataField || propName;\r\n      result[dataField] = this[propName] ? this[propName].toJSON() : {};\r\n    });\r\n\r\n    // 列表属性\r\n    const ngLists = FieldMetadataUtil.getNgList(this.constructor);\r\n    Object.keys(ngLists).forEach((propName: string) => {\r\n      const ngList = ngLists[propName];\r\n      const dataField = ngList.dataField || propName;\r\n      result[dataField] = this[propName] ? this[propName].toJSON() : {};\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  //#region 实体初始化相关private方法\r\n\r\n  /**\r\n   * 初始化实体\r\n   */\r\n  private initialize() {\r\n    const constructor = this.constructor;\r\n\r\n    const ngFields = FieldMetadataUtil.getNgFields(constructor);\r\n    const ngObjects = FieldMetadataUtil.getNgObjects(constructor);\r\n    const ngLists = FieldMetadataUtil.getNgList(constructor);\r\n    const ngDynamic = FieldMetadataUtil.getNgDynamic(constructor);\r\n\r\n    this.initializeNormalField(ngFields);\r\n    this.initializeList(ngLists);\r\n    this.initializeObject(ngObjects);\r\n    this.initializeDynamic(ngDynamic);\r\n  }\r\n\r\n  /**\r\n   * 创建path\r\n   * @param propertyName 属性名称\r\n   */\r\n  protected createPath(propertyName: string): string[] {\r\n    const primaryFieldMetadata = this.primaryProperty;\r\n    if (primaryFieldMetadata) {\r\n      const primaryDataField = primaryFieldMetadata.dataField;\r\n      return [primaryDataField + ':' + this.primaryValue, propertyName];\r\n    } else {\r\n      return [':', propertyName];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 属性字段初始化\r\n   * @param ngFields 属性字段元数据\r\n   */\r\n  private initializeNormalField(ngFields: { [key: string]: PrimitivePropMetadata }): void {\r\n    Object.keys(ngFields).forEach(propName => {\r\n      const ngField = ngFields[propName] as PrimitivePropMetadata;\r\n      const dataField = ngField.dataField || propName;\r\n\r\n      if (delete this[propName]) {\r\n        Object.defineProperty(this, propName, {\r\n          get: function() {\r\n            return this.getPropValue(propName, ngField);\r\n          },\r\n          set: function(newPropValue) {\r\n\r\n            // 有主键的实体，必须先给主键赋值，否则其他字段不允许赋值\r\n            if (this.primaryKey && this.primaryKey === propName && !newPropValue) {\r\n              return;\r\n            }\r\n\r\n            if (this.primaryKey && this.primaryKey !== propName && !this.primaryValue ) {\r\n              return;\r\n            }\r\n\r\n            // 值相同时不触发变更。\r\n            const oldPropValue = this.getPropValue(propName, ngField);\r\n            if (this.isPropValueChanged(propName, ngField, newPropValue, oldPropValue) === false) {\r\n              return;\r\n            }\r\n            this.setPropValue(propName, ngField, newPropValue);\r\n            this.emitValueChange(propName, ngField, newPropValue, oldPropValue);\r\n          },\r\n          configurable: true\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 初始化列表类型的元数据\r\n   * @param ngListMetadata 列表类型元数据\r\n   */\r\n  private initializeList(ngListMetadata: { [key: string]: ListPropMetadata }): void {\r\n    Object.keys(ngListMetadata).forEach(propertyName => {\r\n      const fieldMetadata = ngListMetadata[propertyName] as ListPropMetadata;\r\n      const path = this.createPath(propertyName);\r\n      const dataField = fieldMetadata.dataField || propertyName;\r\n      const val = this.data[dataField];\r\n\r\n      const entityList = new EntityList<typeof fieldMetadata.type>();\r\n      entityList[PARENT_CLASS] = this;\r\n      entityList[PARENT_PATH] = path;\r\n\r\n      if (val) {\r\n        const entities = val.map(v => EntityFactory<typeof fieldMetadata.type>(fieldMetadata.type, v));\r\n        entityList.loadEntities(entities);\r\n      }\r\n\r\n      entityList.onListChanged.subscribe(value => {\r\n        if (value) {\r\n          if (entityList[PARENT_PATH][0] !== value.path[0]) {\r\n            value.path = entityList[PARENT_PATH].concat(value.path);\r\n          }\r\n          this.setChanges(value);\r\n        }\r\n      });\r\n      this[propertyName] = entityList;\r\n    });\r\n  }\r\n  /**\r\n   * 初始化子对象\r\n   * @param ngObjectMetadata 子对象元数据\r\n   */\r\n  private initializeObject(ngObjectMetadata: { [key: string]: ObjectPropMetadata }) {\r\n    Object.keys(ngObjectMetadata).forEach(propertyName => {\r\n      const fieldMetadata = ngObjectMetadata[propertyName] as ObjectPropMetadata;\r\n      const path = this.createPath(propertyName);\r\n      const dataField = fieldMetadata.dataField || propertyName;\r\n\r\n      // val不存在时，用空对象代替\r\n      const val = this.data[dataField] || {};\r\n\r\n      const createEntityFromJsonData = (value: any) => {\r\n        let instance;\r\n        if (value instanceof fieldMetadata.type) {\r\n          instance = value;\r\n        } else {\r\n          instance = EntityFactory(fieldMetadata.type, value);\r\n        }\r\n        instance[PARENT_CLASS] = this;\r\n        instance[PARENT_PATH] = path;\r\n\r\n        instance.onValueChanged.subscribe(changes => {\r\n          if (changes) {\r\n            changes.path = (this[PARENT_PATH] || []).concat(changes.path);\r\n            this.setChanges(changes);\r\n          }\r\n        });\r\n\r\n        return instance;\r\n      };\r\n\r\n      // 如果没有值用一个空对象代替\r\n      let childEntity = createEntityFromJsonData(val);\r\n      if (delete this[propertyName]) {\r\n        Object.defineProperty(this, propertyName, {\r\n          get: () => {\r\n            return childEntity;\r\n          },\r\n          set: function (value: any) {\r\n            const modifyInfo = {\r\n              path: childEntity[PARENT_PATH],\r\n              value: value.data,\r\n              preValue: this[propertyName].data,\r\n              type: ModifyType.ValueChange\r\n            };\r\n            childEntity = createEntityFromJsonData(value);\r\n            this.setChanges(modifyInfo);\r\n          },\r\n          configurable: true\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  private initializeDynamic(ngDynamicMetadata: { [key: string]: DynamicPropMetadata }) {\r\n    Object.keys(ngDynamicMetadata).forEach(propertyName => {\r\n      const fieldMetadata = ngDynamicMetadata[propertyName] as DynamicPropMetadata;\r\n      const path = this.createPath(propertyName);\r\n      const dataField = fieldMetadata.dataField || propertyName;\r\n\r\n      const originalData = this.data[dataField] || {};\r\n\r\n      const createEntityFromJsonData = (value: any) => {\r\n        let instance;\r\n        if (value instanceof fieldMetadata.type) {\r\n          instance = value;\r\n        } else {\r\n          instance = EntityFactory(fieldMetadata.type, value);\r\n        }\r\n        instance[PARENT_CLASS] = this;\r\n        instance[PARENT_PATH] = path;\r\n\r\n        instance.onValueChanged.subscribe(changes => {\r\n          if (changes) {\r\n            changes.path = (this[PARENT_PATH] || []).concat(changes.path);\r\n            this.setChanges(changes);\r\n          }\r\n        });\r\n\r\n        return instance;\r\n      };\r\n\r\n      let dynamicEntity = createEntityFromJsonData(originalData);\r\n      if (delete this[propertyName]) {\r\n        Object.defineProperty(this, propertyName, {\r\n          get: function () {\r\n            return dynamicEntity;\r\n          },\r\n          set: function (value) {\r\n            const modifyInfo = {\r\n              path: dynamicEntity[PARENT_PATH],\r\n              value: value.data,\r\n              preValue: this[propertyName].data,\r\n              type: ModifyType.ValueChange\r\n            };\r\n            dynamicEntity = createEntityFromJsonData(value);\r\n            this.setChanges(modifyInfo);\r\n          },\r\n          configurable: true\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  //#endregion\r\n\r\n\r\n  // #region 加载实体数据相关private、projected方法\r\n\r\n  /**\r\n   * 加载简单字段值\r\n   * @todo 临时用修改的方式模拟\r\n   */\r\n  protected loadFields(data: any) {\r\n    const ngFields = FieldMetadataUtil.getNgFields(this.constructor);\r\n    Object.keys(ngFields).forEach((propName: string) => {\r\n      const ngField = ngFields[propName];\r\n      const dataField = ngField.dataField || propName;\r\n      // if (ngField.primary === false) {\r\n      //   this[propName] = data[dataField];\r\n      // }\r\n      this[propName] = data[dataField];\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 加载子列表数据\r\n   * @param data 数据\r\n   */\r\n  protected loadLists(data: any) {\r\n    const ngLists = FieldMetadataUtil.getNgList(this.constructor);\r\n    Object.keys(ngLists).forEach((propName: string) => {\r\n      const ngList = ngLists[propName];\r\n      const dataField = ngList.dataField || propName;\r\n      const entityType = ngList.type;\r\n\r\n      // 创建实体\r\n      const listData = data[dataField];\r\n      if (listData) {\r\n        const entities = listData.map((entityData: any) => {\r\n          return EntityFactory<typeof entityType>(entityType, entityData);\r\n        });\r\n        this[propName].loadEntities(entities);\r\n      } else {\r\n        this[propName].loadEntities([]);\r\n      }\r\n    });\r\n  }\r\n\r\n  private loadObjects(data: any) {\r\n    const ngObjects = FieldMetadataUtil.getNgObjects(this.constructor);\r\n    Object.keys(ngObjects).forEach((propName: string) => {\r\n      const ngObject = ngObjects[propName];\r\n      const dataField = ngObject.dataField || propName;\r\n      const objectData = data[dataField];\r\n      const entity = this[propName] as Entity;\r\n      if (!entity || !objectData) {\r\n        return;\r\n      }\r\n      entity.load(objectData);\r\n    });\r\n  }\r\n\r\n  protected loadDynamicObjects(data: any) {\r\n    const ngDynamicObjects = FieldMetadataUtil.getNgDynamic(this.constructor);\r\n    Object.keys(ngDynamicObjects).forEach((propName: string) => {\r\n      const ngDynamicObject = ngDynamicObjects[propName];\r\n      const dataField = ngDynamicObject.dataField || propName;\r\n\r\n      const dynamicData = data[dataField] || {};\r\n      const dynamicEntity = this[propName] as Dynamic;\r\n      if (!dynamicEntity) {\r\n        return;\r\n      }\r\n      dynamicEntity.loadDynamicData(dynamicData);\r\n    });\r\n  }\r\n\r\n  // #endregion\r\n\r\n  // #region 私有工具方法\r\n\r\n\r\n  /**\r\n   * 发送值变更\r\n   */\r\n  private emitValueChange(propName: string, propMetadata: PrimitivePropMetadata, newPropValue: any, oldPropValue: any): void {\r\n    const change = {\r\n      path: this.createPath(propName),\r\n      value: newPropValue,\r\n      preValue: oldPropValue,\r\n      type: ModifyType.ValueChange\r\n    };\r\n\r\n    if (this[PARENT_PATH]) {\r\n      change.path = this[PARENT_PATH].concat(change.path);\r\n    }\r\n    this.setChanges(change);\r\n  }\r\n\r\n  /**\r\n   * 获取属性值\r\n   */\r\n  private getPropValue(propName: string, propMetadata: PrimitivePropMetadata) {\r\n    const dataField = propMetadata.dataField || propName;\r\n    const value = this.data[dataField];\r\n\r\n    // 对多语录入字段，query不返回问题进行兼容\r\n    if (propMetadata.enableMultiLangInput === true && !value) {\r\n      const langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';\r\n      const originDataField = dataField.replace('_MULTILANGUAGE', '');\r\n      return {\r\n        [langCode]: this.data[originDataField]\r\n      };\r\n    }\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * 设置属性值\r\n   */\r\n  private setPropValue(propName: string, propMetadata: PrimitivePropMetadata, propValue: any) {\r\n    const dataField = propMetadata.dataField || propName;\r\n    this.data[dataField] = propValue;\r\n  }\r\n\r\n  /**\r\n   * 检查属性值是否发生变化\r\n   */\r\n  private isPropValueChanged(propName: string, propMetadata: PrimitivePropMetadata, newPropValue: any, oldPropValue: any) {\r\n    if (propMetadata.enableMultiLangInput === true) {\r\n      if (this.isEmptyMultiLangPropValue(newPropValue) === true && this.isEmptyMultiLangPropValue(oldPropValue) === true) {\r\n        return false;\r\n      }\r\n      return JSON.stringify(newPropValue) !== JSON.stringify(oldPropValue);\r\n    } else {\r\n      return newPropValue !== oldPropValue;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 多语录入字段的值是否为空\r\n   */\r\n  private isEmptyMultiLangPropValue(value: any) {\r\n    return !value || Object.keys(value).length === 0;\r\n  }\r\n\r\n  // #endregion\r\n}\r\n","import { ModifyType, Modification } from '../changeset/types';\r\nimport { PARENT_PATH, Dynamic, PARENT_CLASS } from './types';\r\nimport { Entity } from './entity';\r\n\r\n/**\r\n * 支持动态字段集合的动态实体\r\n */\r\nexport class DynamicEntity extends Entity implements Dynamic {\r\n\r\n  /**\r\n   * 是否是嵌套的动态实体\r\n   */\r\n  public get IsNested(): boolean {\r\n    return this[PARENT_CLASS] instanceof DynamicEntity;\r\n  }\r\n\r\n  /**\r\n   * @param data JSON数据\r\n   */\r\n  constructor(data: any) {\r\n    super(data);\r\n    this.loadDynamicData(data);\r\n  }\r\n\r\n  public loadDynamicData(dynamicData: any) {\r\n    this.initializeDynamicField(dynamicData);\r\n    // super.loadFields(dynamicData);\r\n  }\r\n\r\n  /**\r\n   * 初始化动态数据\r\n   * @param dynamicData 动态数据\r\n   */\r\n  private initializeDynamicField(dynamicData: any): void {\r\n    // 遍历动态数据的key，创建动态实体属性。\r\n    Object.keys(dynamicData).forEach(propertyName => {\r\n\r\n      // 如果属性已经存在，先删除\r\n      if (this[propertyName]) {\r\n        delete this[propertyName];\r\n      }\r\n\r\n      const dataField = propertyName;\r\n      if (dynamicData[propertyName] instanceof Object) {\r\n        const path = this.createPath(propertyName);\r\n        let dynamicEntity = this.createDynamicEntityFromJsonData(dynamicData[propertyName], path);\r\n        Object.defineProperty(this, propertyName, {\r\n          get: function() {\r\n            return dynamicEntity;\r\n          },\r\n          set: function(value) {\r\n            const modifyInfo = {\r\n              path: dynamicEntity[PARENT_PATH],\r\n              value: value.data,\r\n              preValue: this[propertyName].data,\r\n              type: ModifyType.ValueChange\r\n            };\r\n            dynamicEntity = this.createDynamicEntityFromJsonData(value, path);\r\n            this.setChanges(modifyInfo);\r\n          },\r\n          configurable: true\r\n        });\r\n      } else {\r\n        Object.defineProperty(this, propertyName, {\r\n          // 定义返回数据方法。\r\n          get: function() {\r\n            // 从初始数据返回字段值。\r\n            return this.data[dataField];\r\n          },\r\n          set: function(value) {\r\n            // 值相同时不触发变更。\r\n            const oldValue = this.data[dataField];\r\n            if (oldValue === value) {\r\n              return;\r\n            }\r\n            // 更新元数据数据。\r\n            this.data[dataField] = value;\r\n            // 变更集\r\n            const changes = {\r\n              type: ModifyType.ValueChange,\r\n              path: this.createPath(propertyName),\r\n              value: value,\r\n              preValue: oldValue\r\n            };\r\n\r\n            if (this[PARENT_PATH]) {\r\n              changes.path = this[PARENT_PATH].concat(changes.path);\r\n            }\r\n            this.setChanges(changes);\r\n          },\r\n          configurable: true\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  private createDynamicEntityFromJsonData(value: any, parentPath: string[]) {\r\n    let instance: DynamicEntity;\r\n    if (value instanceof DynamicEntity) {\r\n      instance = value;\r\n    } else {\r\n      instance = new DynamicEntity(value);\r\n    }\r\n    instance[PARENT_CLASS] = this;\r\n    instance[PARENT_PATH] = parentPath;\r\n    instance.onValueChanged.subscribe(changes => {\r\n      if (changes) {\r\n        changes.path = (this[PARENT_PATH] || []).concat(changes.path);\r\n        this.setChanges(changes);\r\n      }\r\n    });\r\n\r\n    return instance;\r\n  }\r\n\r\n  /**\r\n   * 将变更记录保存至变更集中\r\n   * @param value 变更记录\r\n   * @todo\r\n   * 1、preValue的处理有问题，下级传递上来的变更这样可以，根DyanmicaEntity上的，data已经发生变化，prevalue和value是一样了；\r\n   * 2、当value是下级冒泡上来的，需要根据value去更新当前层级的data，该逻辑不应该放在setChagnes，待修改。\r\n   */\r\n  setChanges(value: Modification): void {\r\n    const propertyName = value.path[value.path.length - 1];\r\n    const preValue = Object.assign({}, this.data);\r\n    this.newData = Object.assign(this.newData, { [propertyName]: value.value });\r\n    let parentPath = value.path;\r\n    if (value.path.length > 2) {\r\n      parentPath = value.path.slice(0, value.path.length - 2);\r\n    }\r\n\r\n    // 统一不使用构造函数（保持和其他位置对Modification的构造一致）\r\n    // const parentModification = new Modification(this.data, value.type, parentPath, preValue);\r\n    const parentModification: Modification = {\r\n      path: parentPath,\r\n      value: this.data,\r\n      preValue: preValue,\r\n      type: value.type\r\n    };\r\n\r\n    this.valueChanged.next(parentModification);\r\n    this.changeSet.append(value);\r\n  }\r\n\r\n  /**\r\n   * toJSON\r\n   */\r\n  public toJSON() {\r\n    return this.data;\r\n  }\r\n}\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-10-01 19:36:51\r\n * @Last Modified by: aalizzwell\r\n * @Last Modified time: 2019-09-03 19:46:42\r\n */\r\nimport { Type } from '../core/index';\r\nimport { Modification, ModifyType } from '../changeset/index';\r\nimport { Subject } from 'rxjs';\r\nimport { Entity, FieldMetadataUtil, EntityList } from '../entity/index';\r\n// tslint:disable: no-bitwise\r\n/**\r\n * 实体集合\r\n * @todo：应该用EntityList代替。\r\n */\r\nclass EntityCollection<T extends Entity> {\r\n\r\n  /**\r\n   * 内部实体Set\r\n   */\r\n  private innerEntitySet: Set<T>;\r\n\r\n  /**\r\n   * 内部实体Map\r\n   */\r\n  private innerEntityMap: Map<string, T>;\r\n\r\n\r\n  /**\r\n   * Entity集合变更流\r\n   */\r\n  public collectionChanged: Subject<Modification>;\r\n\r\n  /**\r\n   * 实体类型\r\n   */\r\n  public readonly entityType: Type<T>;\r\n\r\n  /**\r\n   * 实体主键\r\n   */\r\n  public readonly primaryKey: string;\r\n\r\n  /**\r\n   * 实体当前分页信息\r\n   */\r\n  public paginationInfo: any;\r\n\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(entityType: Type<T>) {\r\n    this.innerEntitySet = new Set<T>();\r\n    this.innerEntityMap = new Map<string, T>();\r\n    this.collectionChanged = new Subject<Modification>();\r\n\r\n    this.entityType = entityType;\r\n    this.primaryKey = FieldMetadataUtil.getPrimaryKey(this.entityType);\r\n  }\r\n\r\n  /**\r\n   * 实体数量\r\n   */\r\n  public count(): number {\r\n    return this.innerEntitySet.size;\r\n  }\r\n\r\n  public get entityTypeName() {\r\n    return this.entityType.name;\r\n  }\r\n  /**\r\n   * 是否包含指定主键值的实体\r\n   * @param id 主键值\r\n   */\r\n  public has(id: string): boolean {\r\n    return this.innerEntityMap.has(id);\r\n  }\r\n\r\n  /**\r\n   * 清空全部实体\r\n   */\r\n  public clear() {\r\n    this.innerEntityMap.clear();\r\n    this.innerEntitySet.clear();\r\n    this.notifyCollectionChanged(new Modification([], ModifyType.Load));\r\n  }\r\n\r\n  /**\r\n   * 转换为实体数组\r\n   */\r\n  public toArray(): Entity[] {\r\n    return Array.from(this.innerEntitySet);\r\n  }\r\n\r\n  /**\r\n   * 转换为JSON数组\r\n   */\r\n  public toJSON(): any[] {\r\n    const result = [];\r\n    const entities = this.toArray();\r\n    entities.forEach((entity: Entity) => {\r\n      result.push(entity.toJSON());\r\n    });\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * 批量加载实体\r\n   */\r\n  public loadEntities(entities: any[]) {\r\n\r\n    this.innerEntityMap.clear();\r\n    this.innerEntitySet.clear();\r\n\r\n    entities.forEach(entity => {\r\n      this.innerEntitySet.add(entity);\r\n      this.innerEntityMap.set(entity[this.primaryKey], entity);\r\n    });\r\n    this.notifyCollectionChanged(new Modification(entities, ModifyType.Load));\r\n\r\n  }\r\n\r\n  /**\r\n   * 追加实体\r\n   * @param entity 要追加的实体\r\n   */\r\n  public addEntity(entity: T) {\r\n    this.verifyEntityToAdd(entity);\r\n    this.innerEntitySet.add(entity);\r\n    this.innerEntityMap.set(entity[this.primaryKey], entity);\r\n    this.notifyCollectionChanged(new Modification([entity], ModifyType.Add));\r\n  }\r\n\r\n  /**\r\n   * 批量追加实体\r\n   * @param entities 要加载的实体数组\r\n   */\r\n  public addEntities(entities: T[]) {\r\n    if (!entities) {\r\n      return;\r\n    }\r\n    const entitiesToAdd: T[] = [];\r\n    entities.forEach(entity => {\r\n      this.verifyEntityToAdd(entity);\r\n      entitiesToAdd.push(entity);\r\n    });\r\n    entitiesToAdd.forEach(entity => {\r\n      this.innerEntitySet.add(entity);\r\n      this.innerEntityMap.set(entity[this.primaryKey], entity);\r\n    });\r\n    this.notifyCollectionChanged(new Modification(entitiesToAdd, ModifyType.Add));\r\n  }\r\n\r\n\r\n\r\n  /**\r\n   * 根据主键值获取实体\r\n   */\r\n  getEntityById(identity: string): T {\r\n    if (this.innerEntityMap.has(identity) === false) {\r\n      return null;\r\n    }\r\n    const entity = this.innerEntityMap.get(identity);\r\n    return entity;\r\n  }\r\n\r\n  /**\r\n   * 根据路径获取实体\r\n   */\r\n  getEntityByPath(pathArray: string[]): any {\r\n    const rootEntityId = pathArray[0].split(':')[1];\r\n\r\n    let parentNode: any = this.getEntityById(rootEntityId);\r\n    for (let i = 1; i < pathArray.length && parentNode; i = i + 1) {\r\n      const currentPath = pathArray[i];\r\n      if (parentNode instanceof Entity) {\r\n\r\n        // @todo：强识了别冒号\r\n        if (currentPath.indexOf(':') === -1) {\r\n          parentNode = parentNode[pathArray[i]];\r\n        }\r\n      } else {\r\n        parentNode = parentNode.get(pathArray[i].split(':')[1]);\r\n      }\r\n    }\r\n\r\n    return parentNode;\r\n  }\r\n\r\n  /**\r\n   * 返回符合指定条件的实体集合\r\n   * @param predicate 条件谓词\r\n   */\r\n  getEntities(predicate: (value: T, index: number, array: T[]) => T): T[] {\r\n    const entities: T[] = Array.from(this.innerEntitySet);\r\n    const matchedEntities = entities.filter(predicate);\r\n    return matchedEntities;\r\n  }\r\n\r\n  /**\r\n   * 获取全部实体\r\n   */\r\n  getAllEntities(): T[] {\r\n    return Array.from(this.innerEntitySet);\r\n  }\r\n\r\n  /**\r\n   * 根据主键值删除对应实体\r\n   * @param identity 主键值\r\n   */\r\n  removeEntityById(identity: string): T {\r\n    this.verifyEntityToRemove(identity);\r\n    const entityToRemove = this.innerEntityMap.get(identity);\r\n    this.innerEntityMap.delete(identity);\r\n    this.innerEntitySet.delete(entityToRemove);\r\n    this.notifyCollectionChanged(new Modification([entityToRemove], ModifyType.Remove));\r\n    return entityToRemove;\r\n  }\r\n\r\n  removeEntitiesByIds(id: string) {\r\n  }\r\n\r\n  /**\r\n   * 删除符合条件的实体集合\r\n   */\r\n  public removeEntities(predicate: (value: T, index: number, array: T[]) => any): T[] {\r\n    const entitiesToRemove = Array.from(this.innerEntitySet).filter(predicate);\r\n    entitiesToRemove.forEach(entityToRemove => {\r\n      this.innerEntityMap.delete(entityToRemove[this.primaryKey]);\r\n      this.innerEntitySet.delete(entityToRemove);\r\n    });\r\n    this.notifyCollectionChanged(new Modification(entitiesToRemove, ModifyType.Remove));\r\n    return entitiesToRemove;\r\n  }\r\n  /**\r\n   * 重置子表数据\r\n   * @param paths 路径  \r\n   * 路径格式 ['实体主键:主键值','从表Codes','从从表Codes']\r\n   * @param entities 实体数组\r\n   */\r\n  public resetEntities(paths: string[], entities: T[]) {\r\n    if (paths[0].indexOf(':') === -1) {\r\n      throw new Error('路径格式错误');\r\n    }\r\n    // paths里面第一个一定是id\r\n    const entityInfo: string[] = paths[0].split(':');\r\n    const [entityPrimaryKey, entityId] = entityInfo;\r\n    let entity: T = null;\r\n    for (const element of this.innerEntitySet) {\r\n      if (element[entityPrimaryKey] === entityId) {\r\n        entity = element;\r\n        break;\r\n      }\r\n    }\r\n    // for (let index = 0; index < this.innerEntitySet; index++) {\r\n    //   const element: T = this.innerEntitySet[index];\r\n    //   if (element[entityPrimaryKey] === entityId) {\r\n    //     entity = element;\r\n    //     break;\r\n    //   }\r\n    // }\r\n    if (!entity) {\r\n      throw new Error(`找不到${entityPrimaryKey}为${entityId}的实体`);\r\n    }\r\n    let data: any = entity;\r\n    paths.slice(1).forEach(path => {\r\n      data = data[path];\r\n    });\r\n    const entityList = data as EntityList<T>;\r\n    entityList.clear();\r\n    entityList.loadEntities(entities);\r\n  }\r\n\r\n  /**\r\n   * 验证实体是否能够添加\r\n   */\r\n  private verifyEntityToAdd(entity: T): boolean {\r\n    if (this.has(entity[this.primaryKey])) {\r\n      this.innerEntitySet.delete(this.innerEntityMap.get(entity[this.primaryKey]));\r\n      this.innerEntityMap.delete(entity[this.primaryKey]);\r\n      // throw new Error(`The repository already had an item with the save identity of '${entity[this.primaryKey]}'`);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * 验证实体是否能移除\r\n   */\r\n  private verifyEntityToRemove(identity: string): boolean {\r\n    if (!this.has(identity)) {\r\n      throw new Error(`The entity with identity of '${identity} dose not exsit.'`);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * 实体集合变更流\r\n   */\r\n  private notifyCollectionChanged(modification: Modification) {\r\n    this.collectionChanged.next(modification);\r\n  }\r\n\r\n  //#region 分页\r\n\r\n  /**\r\n   * 设置分页大小\r\n   */\r\n  set pageSize(pageSize: number) {\r\n    if (typeof (pageSize) !== 'number' || pageSize < 0) {\r\n      throw new Error('Invalid parameter:pageSize');\r\n    }\r\n\r\n    const original = this.paginationInfo;\r\n    // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { pageSize });\r\n    // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });\r\n    // this.notifyCollectionChanged(new Modification(this.paginationInfo[this.entityTypeName], ModifyType.PaginationInfoChange));\r\n    this.paginationInfo = Object.assign({}, original, { pageSize });\r\n    this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));\r\n  }\r\n  /**\r\n   * 获取分页大小\r\n   * @description 如果用户未指定分页大小则默认为0，即获取所有数据\r\n   */\r\n  get pageSize(): number {\r\n    if (!!this.paginationInfo) {\r\n      return this.paginationInfo.pageSize || 0;\r\n    }\r\n    return 0;\r\n  }\r\n  /**\r\n   * 设置数据总条数\r\n   */\r\n  set totalCount(total: number) {\r\n    if (typeof (total) !== 'number' || total < 0) {\r\n      throw new Error('Invalid parameter:total');\r\n    }\r\n\r\n    const original = this.paginationInfo;\r\n    // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { total });\r\n    // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });\r\n    this.paginationInfo = Object.assign({}, original, { total });\r\n    this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));\r\n  }\r\n  /**\r\n   * 获取数据总条数\r\n   */\r\n  get totalCount(): number {\r\n    if (!!this.paginationInfo) {\r\n      return this.paginationInfo.total || 0;\r\n    }\r\n    return 0;\r\n  }\r\n  /**\r\n   * 设置当前页码\r\n   */\r\n  set pageIndex(pageIndex: number) {\r\n    if (typeof (pageIndex) !== 'number' || pageIndex < 0) {\r\n      throw new Error('Invalid parameter:pageIndex');\r\n    }\r\n\r\n    const original = this.paginationInfo;\r\n    // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { pageIndex });\r\n    // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });\r\n    this.paginationInfo = Object.assign({}, original, { pageIndex });\r\n    this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));\r\n  }\r\n  /**\r\n   * 获取当前页码\r\n   */\r\n  get pageIndex(): number {\r\n    if (!!this.paginationInfo) {\r\n      return this.paginationInfo.pageIndex || 1;\r\n    }\r\n    return 1;\r\n  }\r\n  /**\r\n   * 更新分页信息\r\n   * @param path 绑定路径\r\n   * @param pageInfo 分页信息\r\n   */\r\n  public updatePaginationInfoByPath(path: string, pageInfo: { pageIndex: any, pageSize: any, totalCount: any, [prop: string]: any }) {\r\n    const original = this.paginationInfo;\r\n    const { pageIndex, pageSize, totalCount: total } = pageInfo;\r\n    const paginationInfo = Object.assign({}, original, { pageIndex, pageSize, total });\r\n    this.setPaginationConfigByPath(path, paginationInfo);\r\n  }\r\n  /**\r\n   * 根据路径获取分页大小\r\n   * @param path 路径\r\n   */\r\n  public getPaginationConfigByPath(path: string, defaultValue?: any) {\r\n    if (!path || path === '/') {\r\n      return this.paginationInfo;\r\n    }\r\n    if (typeof path !== 'string') {\r\n      throw new Error('路径必须为字符串！');\r\n    }\r\n    path = path.substring(1);\r\n    const paths = path.split('/').filter(item => !!item && item.trim().length > 0).map(item => item.trim());\r\n    let config = this.paginationInfo;\r\n    paths.forEach(item => {\r\n      if (config && config.hasOwnProperty(item)) {\r\n        config = config[item];\r\n      } else {\r\n        config = null;\r\n      }\r\n    });\r\n    return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;\r\n  }\r\n  /**\r\n   * 设置分页信息\r\n   * @param path 路径\r\n   * @param value 值\r\n   */\r\n  public setPaginationConfigByPath(path: string | Array<any>, value: any) {\r\n    const original = JSON.stringify(this.paginationInfo);\r\n    if (!path || path === '/') {\r\n      this.paginationInfo = value;\r\n    } else {\r\n      if (!Array.isArray(path)) {\r\n        path = path.toString().match(/[^/[\\]]+/g) || [];\r\n      }\r\n      path.slice(0, -1).reduce((prev, current, index) =>\r\n        Object(prev[current]) === prev[current]\r\n          ? prev[current]\r\n          : prev[current] = Math.abs(path[index + 1]) >> 0 === +path[index + 1]\r\n            ? []\r\n            : {},\r\n        this.paginationInfo)[path[path.length - 1]] = value;\r\n    }\r\n\r\n    if (JSON.stringify(this.paginationInfo) !== original) {\r\n      this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));\r\n    }\r\n    return this.paginationInfo;\r\n  }\r\n  //#endregion\r\n}\r\n\r\nexport { EntityCollection };\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2019-03-07 17:24:38\r\n * @Last Modified by:   Witt\r\n * @Last Modified time: 2019-03-11 19:50:38\r\n */\r\n\r\nimport { Type } from '../core/index';\r\nimport { Entity, EntityList, createEntity, createEntities } from '../entity/index';\r\nimport { EntityCollection } from './entity_collection';\r\nimport { DataPath, DataPathCreator, DataPathNodeType, DataTypeInfo } from '../entity/index';\r\nimport { EntityUtil } from '../binding-data/entity_util';\r\n\r\n\r\n/**\r\n * 实体管理类\r\n */\r\nclass EntityManager<T extends Entity> {\r\n\r\n  /**\r\n   * 实体类型\r\n   */\r\n  public entityType: Type<Entity>;\r\n\r\n  /**\r\n   * 实体集合\r\n   */\r\n  public entityCollection: EntityCollection<Entity>;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(entityCollection: EntityCollection<T>) {\r\n    this.entityCollection = entityCollection;\r\n    this.entityType = entityCollection.entityType;\r\n  }\r\n\r\n\r\n  // #region 创建实体相关方法\r\n\r\n  /**\r\n   * 创建实体\r\n   */\r\n  public createEntity(entityData: any): T {\r\n    const entity = createEntity<T>(this.entityType, entityData);\r\n    return entity;\r\n  }\r\n\r\n  /**\r\n   * 批量创建实体\r\n   */\r\n  public createEntities(entityListData: any[], entityType: any): T[] {\r\n    const entities: T[] = createEntities<T>(this.entityType, entityListData);\r\n    return entities;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 获取实体、实体数组相关方法\r\n\r\n  /**\r\n   * 获取path对应的实体\r\n   */\r\n  public getEntityByPath(path: string[]): Entity {\r\n    const entity = this.getEntityNodeByPath(path) as Entity;\r\n    return entity;\r\n  }\r\n\r\n  /**\r\n   * 获取path对应的实体\r\n   */\r\n  public getEntitiesByPath(path: string[]): Entity[] {\r\n    const entityCollectionOrList = this.getEntityNodeByPath(path) as EntityCollection<Entity> | EntityList<Entity>;\r\n    let entities: Entity[];\r\n    if (entityCollectionOrList instanceof EntityCollection === true) {\r\n      entities = (entityCollectionOrList as EntityCollection<Entity>).toArray();\r\n    } else {\r\n      entities = (entityCollectionOrList as EntityList<Entity>).toArray();\r\n    }\r\n    return entities;\r\n  }\r\n\r\n  /**\r\n   * 获取实体节点\r\n   * @param path 节点路径\r\n   */\r\n  private getEntityNodeByPath(path: string[]): EntityCollection<Entity> | EntityList<Entity> | Entity {\r\n    const dataPath = DataPathCreator.createByLongPathFromRoot(path, this);\r\n    let entityNode: any = this.entityCollection;\r\n    let pathNode = dataPath.head.next;\r\n    while (pathNode) {\r\n      if (pathNode.type === DataPathNodeType.DataId) {\r\n        if (entityNode instanceof EntityCollection === true) {\r\n          entityNode = (entityNode as EntityCollection<Entity>).getEntityById(pathNode.value);\r\n        } else {\r\n          entityNode = (entityNode as EntityList<Entity>).get(pathNode.value);\r\n        }\r\n      } else {\r\n        entityNode = entityNode[pathNode.value];\r\n      }\r\n      if (!entityNode) {\r\n        throw new Error(`找不到${pathNode.value}对应的数据节点`);\r\n      }\r\n      pathNode = pathNode.next;\r\n    }\r\n    return entityNode;\r\n  }\r\n  // #endregion\r\n\r\n\r\n  // #region 获取、设置属性值\r\n\r\n  /**\r\n   * 获取path对应的实体属性值\r\n   */\r\n  public getPropValueByPath(path: string[]): any {\r\n    const propName = path.pop();\r\n    const entity = this.getEntityByPath(path);\r\n    return entity[propName];\r\n  }\r\n\r\n  /**\r\n   * 设置path对应实体的属性值\r\n   */\r\n  public setPropValueByPath(path: string[], propValue: any): void {\r\n    const propName = path.pop();\r\n    const entity = this.getEntityByPath(path);\r\n    entity[propName] = propValue;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 插入实体\r\n\r\n  /**\r\n   * 在path对应实体前插入实体\r\n   */\r\n  public insertEntityBeforeByPath(fpath: string[]) {\r\n    throw new Error('Not Implemented');\r\n  }\r\n\r\n  /**\r\n   * 在path对应实体前批量插入实体\r\n   */\r\n  public insertEntitiesBeforeByPath() {\r\n    throw new Error('Not Implemented');\r\n  }\r\n\r\n  /**\r\n   * 在path对应实体前插入实体\r\n   */\r\n  public insertEntityAfterByPath() {\r\n    throw new Error('Not Implemented');\r\n  }\r\n\r\n  /**\r\n   * 在path对应实体前批量插入实体\r\n   */\r\n  public insertEntitiesAfterByPath() {\r\n    throw new Error('Not Implemented');\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 追加实体\r\n\r\n  /**\r\n   * 在path对应的实体集合中追加1个实体\r\n   */\r\n  // public appendEntityByPath(fpath: string[], entity: Entity): void {\r\n  //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);\r\n  //   if (entityCollectionOrList instanceof EntityCollection === true) {\r\n  //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;\r\n  //     entityCollection.addEntity(entity);\r\n  //   } else {\r\n  //     const entityList = (entityCollectionOrList as EntityList<Entity>);\r\n  //     entityList.appendEntity(entity);\r\n  //   }\r\n  // }\r\n\r\n  /**\r\n   * 根据path获取实体集合\r\n   * @param fpath 路径\r\n   * @param entityData 实体数据\r\n   * @param initialData[可选] 默认值\r\n   */\r\n  public appendEntityByPath(fpath: string, entityData: any, initialData?: any): Entity {\r\n    const subPaths = fpath.split('/');\r\n    if (subPaths.length < 3) {\r\n      throw Error(`根据path删除实体数据出错了。传入的path[${fpath}]格式不对`);\r\n    }\r\n\r\n    let childEntityList: EntityList<any>;\r\n    let propInfo: { propType: string, propEntityType: any };\r\n    let propName: string;\r\n    for (let i = 2; i < subPaths.length; i = i + 2) {\r\n      const fid = subPaths[i - 1];\r\n      propName = subPaths[i];\r\n\r\n      // todo: EntityCollection重构之后这里无需差异处理\r\n      const parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);\r\n      childEntityList = parentEntity[propName];\r\n      const entityType = propInfo ? propInfo.propEntityType : this.entityType;\r\n      propInfo = EntityUtil.getPropInfo(entityType, propName);\r\n      if (!childEntityList) {\r\n        throw Error(`fpath参数错误，无法找到${propName}对应的子表。fpath为：${fpath}`);\r\n      }\r\n    }\r\n\r\n    // const propInfo = EntityUtil.getPropInfo(this.entityType, propName);\r\n    const childEntity = createEntity<Entity>(propInfo.propEntityType, entityData);\r\n    // 在实体的实例上增加默认值属性，以便在createBindingObject时存放默认值\r\n    if (initialData) {\r\n      EntityUtil.appendInitialData(childEntity, initialData);\r\n    }\r\n    childEntityList.appendNew(childEntity);\r\n    return childEntity;\r\n  }\r\n\r\n\r\n  /**\r\n   * 在path对应的实体集合中追加多个实体\r\n   */\r\n  public appendEntitiesByPath(fpath: string[], entities: Entity[]) {\r\n    const entityCollectionOrList = this.getEntityNodeByPath(fpath);\r\n    if (entityCollectionOrList instanceof EntityCollection === true) {\r\n      const entityCollection = entityCollectionOrList as EntityCollection<Entity>;\r\n      entityCollection.addEntities(entities);\r\n    } else {\r\n      const entityList = (entityCollectionOrList as EntityList<Entity>);\r\n      entityList.appendEntities(entities);\r\n    }\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 删除实体\r\n\r\n  /**\r\n   * 从fapth对应的实体集合中删除id对应的实体\r\n   */\r\n  // public removeEntityByPath(fpath: string[], id: string): void {\r\n  //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);\r\n  //   if (entityCollectionOrList instanceof EntityCollection === true) {\r\n  //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;\r\n  //     entityCollection.removeEntityById(id);\r\n  //   } else {\r\n  //     const entityList = (entityCollectionOrList as EntityList<Entity>);\r\n  //     entityList.remove(id);\r\n  //   }\r\n  // }\r\n\r\n  /**\r\n   * 根据path获取实体集合\r\n   * @param fpath path\r\n   */\r\n  public removeEntityByPath(fpath: string, id: string) {\r\n    const subPaths = fpath.split('/');\r\n    if (subPaths.length < 3) {\r\n      throw Error(`根据path删除实体数据出错了。传入的path[${fpath}]格式不对`);\r\n    }\r\n    let childEntityList: EntityList<any>;\r\n    for (let i = 2; i < subPaths.length; i = i + 2) {\r\n      const fid = subPaths[i - 1];\r\n      const propName = subPaths[i];\r\n      const parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);\r\n      childEntityList = parentEntity[propName];\r\n      if (!childEntityList) {\r\n        throw Error(`fpath参数错误，无法找到${propName}对应的子表。fpath为：${fpath}`);\r\n      }\r\n    }\r\n\r\n    childEntityList.remove(id);\r\n  }\r\n\r\n  /**\r\n   * 从fapth对应的实体集合中删除ids对应的实体\r\n   */\r\n  public removeEntitiesByPath(fpath: string[], ids: string[]): void {\r\n    // const entityCollectionOrList = this.getEntityNodeByPath(fpath);\r\n    // if (entityCollectionOrList instanceof EntityCollection === true) {\r\n    //   const entityCollection = entityCollectionOrList as EntityCollection<Entity>;\r\n    //   entityCollection.removeEntitiesByIds(ids);\r\n    // } else {\r\n    //   const entityList = (entityCollectionOrList as EntityList<Entity>);\r\n    //   entityList.remove(ids);\r\n    // }\r\n    throw new Error('Not Implemented');\r\n  }\r\n  // #endregion\r\n\r\n\r\n  // #region 清空变更集相关方法\r\n\r\n  /**\r\n   * 清空所有实体的变更集\r\n   */\r\n  public clearAllEntityChanges() {\r\n    const entities = this.entityCollection.toArray();\r\n    entities.forEach((entity: Entity) => {\r\n      entity.changes.splice(0, entity.changes.length);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 清空id指定的实体变更集\r\n   */\r\n  public clearEntityChangesById(id: string): void {\r\n    const entity = this.entityCollection.getEntityById(id);\r\n    if (!entity) {\r\n      return;\r\n    }\r\n    entity.changes.splice(0, entity.changes.length);\r\n  }\r\n\r\n  /**\r\n   * 清空ids数组中指定的实体的变更集\r\n   */\r\n  public clearEntityChangesByIds(ids: string[]): void {\r\n    if (!ids || ids.length < 0) {\r\n      return;\r\n    }\r\n\r\n    ids.forEach((id: string) => {\r\n      this.clearEntityChangesById(id);\r\n    });\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 变更集检查相关方法\r\n\r\n  /**\r\n   * 检查所有的实体，是否有未提交的变更\r\n   */\r\n  public checkAllEntityChanges(): boolean {\r\n\r\n    const entities = this.entityCollection.toArray();\r\n    const hasChanges = entities.some((entity: Entity) => {\r\n      if (entity.changes.length > 0) {\r\n        return true;\r\n      } else {\r\n        return false;\r\n      }\r\n    });\r\n    return hasChanges;\r\n  }\r\n\r\n  /**\r\n   * 检查id对应的实体，是否有未提交的变更\r\n   */\r\n  public checkEntityChangesById(id: string): boolean {\r\n    const entity = this.entityCollection.getEntityById(id);\r\n    if (!entity) {\r\n      return false;\r\n    }\r\n    return entity.changes.length > 0;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 不规范方法，待废弃\r\n\r\n  /**\r\n   * 待废弃\r\n   * @deprecated\r\n   */\r\n  public clearEntityChangesByArray(idArray: string[]): void {\r\n    this.clearEntityChangesByIds(idArray);\r\n  }\r\n\r\n  // #endregion\r\n\r\n}\r\n\r\nexport { EntityManager };\r\n","import { Type  } from '../core/index';\r\nimport { Entity, FieldMetadataUtil } from '../entity/index';\r\n// tslint:disable: no-bitwise\r\n\r\nexport class PaginationManager<T extends Entity> {\r\n\r\n    constructor(private entityType: Type<T>, private paginationConfig: any) {\r\n        if (this.paginationConfig === null || this.paginationConfig === undefined) {\r\n            this.paginationConfig = this.getNgListProperties();\r\n        }\r\n        // 兼容老表单，将之前的主表分页信息展开到分页配置根中\r\n        this.expandMainEntityConfig();\r\n        this.deleteMainEntityConfig();\r\n    }\r\n    /**\r\n     * 主表分页信息展开到分页配置根中\r\n     */\r\n    private expandMainEntityConfig() {\r\n        const entityName = this.entityType.name;\r\n        if (this.paginationConfig.hasOwnProperty(entityName)) {\r\n            const entityConfig = this.paginationConfig[entityName];\r\n            this.paginationConfig = Object.assign(this.paginationConfig, entityConfig);\r\n        }\r\n    }\r\n    /**\r\n     * 删除主表实体配置信息\r\n     */\r\n    private deleteMainEntityConfig() {\r\n        delete this.paginationConfig[this.entityType.name];\r\n    }\r\n    /**\r\n     * 获取分页信息\r\n     */\r\n    public get pagination() {\r\n        return this.paginationConfig;\r\n    }\r\n    /**\r\n     * 获取分页信息\r\n     * @param path 路径\r\n     * @param defaultValue 默认值\r\n     */\r\n    public getPaginationConfigByPath(path: string, defaultValue?: any) {\r\n        if (!path || path === '/') {\r\n            return this.paginationConfig;\r\n        }\r\n        if (typeof path !== 'string') {\r\n            throw new Error('路径必须为字符串！');\r\n        }\r\n        path = path.substring(1);\r\n        const paths = path.split('/').filter(item => !!item && item.trim().length > 0);\r\n        let config = this.paginationConfig;\r\n        paths.forEach(item => {\r\n            if (config && config.hasOwnProperty(item)) {\r\n                config = config[item];\r\n            } else {\r\n                config = null;\r\n            }\r\n        });\r\n        return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;\r\n    }\r\n    /**\r\n     * 设置分页信息\r\n     * @param path 路径\r\n     * @param value 值\r\n     */\r\n    public setPaginationConfigByPath(path: string | Array<any>, value: any) {\r\n        if (!Array.isArray(path)) {\r\n            path = path.toString().match(/[^/[\\]]+/g) || [];\r\n        }\r\n        path.slice(0, -1).reduce((prev, current, index) =>\r\n            Object(prev[current]) === prev[current]\r\n                ? prev[current]\r\n                : prev[current] = Math.abs(path[index + 1]) >> 0 === +path[index + 1]\r\n                    ? []\r\n                    : {},\r\n            this.paginationConfig)[path[path.length - 1]] = value;\r\n        return this.paginationConfig;\r\n    }\r\n\r\n    /**\r\n     * 递归获取当前实体的所有NgList属性\r\n     * @param defaultPageSize defaultPageSize\r\n     */\r\n    private getNgListProperties(defaultPageSize: number = 0) {\r\n\r\n        const getChilds = (objectType: Type<Entity>) => {\r\n            const listProperties = FieldMetadataUtil.getNgList(objectType);\r\n            let result = {};\r\n            if (Object.keys(listProperties).length < 1) {\r\n                return result;\r\n            }\r\n\r\n            Object.keys(listProperties).forEach(prop => {\r\n                let itemTypeName = listProperties[prop].dataField;\r\n                // 去掉尾部的s\r\n                if (itemTypeName.endsWith('s')) {\r\n                    itemTypeName = itemTypeName.substring(0, itemTypeName.length - 1);\r\n                }\r\n                result[itemTypeName] = {\r\n                    pageSize: defaultPageSize\r\n                };\r\n                const child = getChilds(listProperties[prop].type);\r\n                if (child !== null && Object.keys(child).length > 0) {\r\n                    result = Object.assign({}, result, child);\r\n                }\r\n            });\r\n            return result;\r\n        };\r\n        const childs = getChilds(this.entityType);\r\n        const root = Object.assign({}, { pageSize: defaultPageSize }, childs);\r\n        return root;\r\n    }\r\n\r\n}\r\n","import { DataChange, DataChangeType } from '../core';\r\n\r\nclass DataChangeHistory {\r\n    private history: Array<DataChange>;\r\n    constructor() {\r\n        this.history = [];\r\n    }\r\n    public addChange(dataChange: DataChange) {\r\n        const changeType = DataChangeType[dataChange.changeType];\r\n        this[`on${changeType}Data`](dataChange);\r\n    }\r\n    public addChanges(dataChange: DataChange[]) {\r\n        dataChange.forEach(change => this.addChange(change));\r\n    }\r\n    public clear() {\r\n        this.history.splice(0, this.history.length);\r\n    }\r\n    public clearByIds(ids: string[]) {\r\n        this.history = this.history.filter(item => {\r\n            if (item.fpath && item.fpath !== '/' && item.fpath.includes('/')) {\r\n                for (const id of ids) {\r\n                    const include = item.fpath.split('/').includes(id);\r\n                    return !include;\r\n                }\r\n            } else {\r\n                return !ids.includes(item.dataId);\r\n            }\r\n        });\r\n    }\r\n    public isChanged() {\r\n        return this.history.length > 0;\r\n    }\r\n    private onAddData(dataChange: DataChange) {\r\n        this.history.push(dataChange);\r\n    }\r\n    private onDeleteData(dataChange: DataChange) {\r\n        const index = this.history.findIndex(item => item.dataId === dataChange.dataId && item.changeType === DataChangeType.Add);\r\n        if (index >= 0) {\r\n            this.history.splice(index, 1);\r\n        } else {\r\n            this.history.push(dataChange);\r\n        }\r\n    }\r\n}\r\nexport { DataChangeHistory };\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-10-12 15:37:11\r\n * @Last Modified by: aalizzwell\r\n * @Last Modified time: 2019-09-03 19:10:44\r\n * @todo 待优化问题\r\n * 1、apiUrl是否应该在基类中，子类中的api如何传递给基类；\r\n */\r\n\r\nimport { Type } from '../core/index';\r\nimport { Observable, Subject } from 'rxjs';\r\n\r\nimport { DataTypeInfo } from '../entity/index';\r\nimport { Guid } from '../utils/index';\r\nimport { Modification } from '../changeset/index';\r\nimport { MetadataUtil } from '../core/index';\r\nimport { Entity, createEntity, createEntities, FieldMetadataUtil } from '../entity/index';\r\nimport { RepositoryMeta } from './decorators';\r\nimport { EntityCollection } from './entity_collection';\r\nimport { PaginationManager } from './pagination_manager';\r\nimport { DataChangeHistory } from './data_change_history';\r\n\r\nexport abstract class Repository<T extends Entity> {\r\n\r\n  /**\r\n   * 名称\r\n   */\r\n  abstract name: string;\r\n\r\n  /**\r\n   * 实体类型\r\n   */\r\n  public entityType: Type<T>;\r\n\r\n  /**\r\n   * 实体类型信息\r\n   */\r\n  public entityTypeInfo: DataTypeInfo;\r\n\r\n  /**\r\n   * 实体集合\r\n   */\r\n  public entityCollection: EntityCollection<T>;\r\n\r\n  /**\r\n   * 用户分页配置信息\r\n   */\r\n  public paginationInfo: any = null;\r\n\r\n  /**\r\n   * 数据变更历史\r\n   * @summary\r\n   * 仅针对主表增加、从表删除\r\n   */\r\n  public dataChangeHistory: DataChangeHistory;\r\n\r\n\r\n  /**\r\n   * 分页管理器\r\n   */\r\n  public paginationManager: PaginationManager<T>;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n  }\r\n\r\n  protected init() {\r\n    this.entityTypeInfo = new DataTypeInfo(this.entityType);\r\n    this.entityCollection = new EntityCollection<T>(this.entityType);\r\n    this.dataChangeHistory = new DataChangeHistory();\r\n  }\r\n\r\n  /**\r\n   * 实体主键\r\n   */\r\n  public get primaryKey(): string {\r\n    return this.entityCollection.primaryKey;\r\n  }\r\n\r\n  /**\r\n   * 实体变更集合\r\n   */\r\n  public get entityCollectionChange(): Subject<Modification> {\r\n    return this.entityCollection.collectionChanged;\r\n  }\r\n\r\n  /**\r\n   * 重置状态\r\n   */\r\n  public reset(): void {\r\n    this.entityCollection.clear();\r\n  }\r\n\r\n  /**\r\n   * 创建实体\r\n   */\r\n  public buildEntity(data: any): T {\r\n    const entity = createEntity<T>(this.entityType, data);\r\n    return entity;\r\n  }\r\n\r\n  /**\r\n   * 批量创建实体\r\n   */\r\n  public buildEntities(listData: any[]): T[] {\r\n    const entities: T[] = createEntities<T>(this.entityType, listData);\r\n    return entities;\r\n  }\r\n\r\n  /**\r\n   * 初始化分页配置\r\n   * @param config 用户分页配置\r\n   */\r\n  setPaginationConfig(config: any) {\r\n    this.paginationManager = new PaginationManager(this.entityType, config);\r\n    const { pageSize = 0 } = this.paginationManager.getPaginationConfigByPath('/') || {};\r\n    // tslint:disable-next-line: max-line-length\r\n    this.entityCollection.paginationInfo = Object.assign({ pageSize }, this.entityCollection.paginationInfo, this.paginationManager.pagination);\r\n\r\n    // 无需再单独设置一次pageSize，减少一次变更\r\n    // this.entityCollection.pageSize = pageSize;\r\n  }\r\n\r\n  /**\r\n   * 设置分页\r\n   */\r\n  public setPaginationInfo(paginationInfo: any) {\r\n    this.paginationInfo = { ...this.paginationInfo, ...paginationInfo };\r\n  }\r\n  \r\n}\r\n","import { Entity } from '../entity/index';\r\nimport { Repository } from './repository';\r\nimport { EntityManager } from './entity_manager';\r\n\r\n/**\r\n * 空Repository实现\r\n */\r\nabstract class DefaultRepository<T extends Entity> extends Repository<T> {\r\n\r\n  /**\r\n   * 名称\r\n   */\r\n  abstract name: string;\r\n\r\n  /**\r\n   * 实体管理器\r\n   */\r\n  public entityManager: EntityManager<T>;\r\n\r\n  constructor() {\r\n    super();\r\n    this.entityManager = new EntityManager(this.entityCollection);\r\n  }\r\n}\r\n\r\nexport { DefaultRepository };\r\n","import { Observable, of } from 'rxjs';\r\nimport { CommandContext } from '../command_context';\r\nimport { isObservable } from '../../utils/index';\r\n\r\n/**\r\n * 任务函数\r\n */\r\ntype TaskFunc = (context: CommandContext) => any;\r\n\r\n\r\n/**\r\n * 任务节点\r\n */\r\nclass TaskNode {\r\n\r\n  /**\r\n   * 任务名称\r\n   */\r\n  name: string;\r\n\r\n  /**\r\n   * 任务函数\r\n   */\r\n  func: TaskFunc;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(name: string, func: TaskFunc) {\r\n    this.name = name;\r\n    this.func = func;\r\n  }\r\n\r\n  /**\r\n   * 执行任务函数\r\n   */\r\n  execute(context: CommandContext): Observable<any> {\r\n    const result = this.func(context);\r\n    const result$ = isObservable(result) ? result : of(result);\r\n    return result$;\r\n  }\r\n}\r\n\r\nexport { TaskFunc, TaskNode };\r\n","enum BindingType {\r\n\r\n  /**\r\n   * 实体状态\r\n   */\r\n  EntityState = 'EntityState',\r\n\r\n  /**\r\n   * UI状态\r\n   */\r\n  UIState     = 'UIState'\r\n}\r\n\r\nexport { BindingType };\r\n","/**\r\n * session变量解析\r\n * @author Witt <jiwt@inspur.com>\r\n */\r\nimport { createInjectionToken } from '../core/index';\r\n\r\n/**\r\n * 变量解析接口\r\n */\r\ninterface VariableParser {\r\n  parse(expression: string, context: any): any;\r\n}\r\n\r\nconst VARIABLE_PARSERS = createInjectionToken('@farris/devkit VARIABLE_PARSERS');\r\n\r\nexport { VariableParser, VARIABLE_PARSERS };\r\n","import { StaticProvider } from '../core/index';\r\n\r\nclass AppOptions {\r\n\r\n  /**\r\n   * 应用id\r\n   */\r\n  id: string;\r\n\r\n  /**\r\n   * 应用providers\r\n   */\r\n  providers: StaticProvider[];\r\n\r\n}\r\n\r\nexport { AppOptions };\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-12-29 10:46:01\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2018-12-30 17:56:02\r\n */\r\n\r\nimport { BindingData } from '../binding-data';\r\n\r\n/**\r\n * BindingData管理类\r\n */\r\nclass BindingDataManager {\r\n\r\n  /**\r\n   * BindingDataMap\r\n   */\r\n  private bindingDataMap: Map<string, BindingData>;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n    this.bindingDataMap = new Map<string, BindingData>();\r\n  }\r\n\r\n  /**\r\n   * 获取BindingDataMap\r\n   */\r\n  public getBindingDataMap(): Map<string, BindingData> {\r\n    return this.bindingDataMap;\r\n  }\r\n\r\n  /**\r\n   * 根据name获取BindingData\r\n   * @return 找不到时返回undefined\r\n   */\r\n  public getBindingDataByName(name: string): BindingData {\r\n    return this.bindingDataMap.get(name);\r\n  }\r\n\r\n  /**\r\n   * 初始化全局的BindingData\r\n   */\r\n  public regBindingData(name: string, bindingData: BindingData): void {\r\n    this.bindingDataMap.set(name, bindingData);\r\n  }\r\n\r\n  /**\r\n   * 是否Repository已经存在\r\n   */\r\n  public ifBindingDataExits(name: string) {\r\n    const bindingData = this.getBindingDataByName(name);\r\n    return bindingData ? true : false;\r\n  }\r\n\r\n}\r\n\r\nexport { BindingDataManager };\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-12-29 10:46:01\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2018-12-30 18:06:11\r\n */\r\n\r\nimport { Repository } from '../repository/index';\r\nimport { Entity } from '../entity/index';\r\n\r\n/**\r\n * Repository管理类\r\n */\r\nclass RepositoryManager {\r\n\r\n  /**\r\n   * repositoryMap\r\n   */\r\n  private repositoryMap: Map<string, Repository<Entity>>;\r\n\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n    this.repositoryMap = new Map<string, Repository<Entity>>();\r\n  }\r\n\r\n  /**\r\n   * 注册Repository\r\n   */\r\n  public regRepository(name: string, repository: Repository<Entity>): void {\r\n    this.repositoryMap.set(name, repository);\r\n  }\r\n\r\n  /**\r\n   * 获取RepositoryMap\r\n   * @internal\r\n   */\r\n  public getRepositoryMap(): Map<string, Repository<Entity>> {\r\n    return this.repositoryMap;\r\n  }\r\n\r\n  /**\r\n   * 获取Repository数组\r\n   */\r\n  public getRepositories(): Repository<Entity>[] {\r\n    return Array.from(this.repositoryMap.values());\r\n  }\r\n\r\n  /**\r\n   * 根据name获取Repository\r\n   */\r\n  public getRepositoryByName(name: string): Repository<Entity> {\r\n    return this.repositoryMap.get(name);\r\n  }\r\n\r\n  /**\r\n   * 是否Repository已经存在\r\n   */\r\n  public ifRepositoryExits(name: string) {\r\n    const repository = this.getRepositoryByName(name);\r\n    return repository ? true : false;\r\n  }\r\n\r\n}\r\n\r\nexport { RepositoryManager };\r\n","import { ViewModelContext } from '../view-model/index';\r\n\r\n/**\r\n * ViewModelContext管理类\r\n */\r\nclass ViewModelContextManager {\r\n\r\n  /**\r\n   * Context字典\r\n   */\r\n  private contextMap: Map<string, ViewModelContext>;\r\n\r\n  /**\r\n   * Context集合\r\n   */\r\n  private contextSet: Set<ViewModelContext>;\r\n\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n    this.contextMap = new Map<string, ViewModelContext>();\r\n    this.contextSet = new Set<ViewModelContext>();\r\n  }\r\n\r\n  /**\r\n   * 注册Context\r\n   */\r\n  public regContext(viewModelContext: ViewModelContext): void {\r\n    const id = viewModelContext.id;\r\n    if (this.contextMap.has(id) === true) {\r\n      // throw Error(`id为${id}的ViewModelContext已经存在`);\r\n      // 临时处理，方式报错。\r\n      this.unregContext(viewModelContext);\r\n    }\r\n\r\n    this.contextMap.set(id, viewModelContext);\r\n    this.contextSet.add(viewModelContext);\r\n  }\r\n\r\n  /**\r\n   * 取消注册\r\n   */\r\n  public unregContext(context: ViewModelContext): void {\r\n    const id = context.id;\r\n    this.contextMap.delete(id);\r\n    this.contextSet.delete(context);\r\n  }\r\n\r\n  /**\r\n   * 获取ContextMap\r\n   */\r\n  public getContextMap() {\r\n    return this.contextMap;\r\n  }\r\n\r\n  /**\r\n   * 获取全部Context\r\n   */\r\n  public getContexts(): ViewModelContext[] {\r\n    return Array.from(this.contextSet);\r\n  }\r\n\r\n  /**\r\n   * 根据id获取Context\r\n   */\r\n  public getContextById(id: string): ViewModelContext {\r\n    const targetContext = this.contextMap.get(id);\r\n    return targetContext;\r\n  }\r\n\r\n  /**\r\n   * 获取根Context\r\n   */\r\n  public getRootContext(): ViewModelContext {\r\n    const contexts = this.getContexts();\r\n    const rootContext = contexts.find((context: ViewModelContext) => {\r\n      return context.parent === null;\r\n    });\r\n    return rootContext;\r\n  }\r\n\r\n  /**\r\n   * 获取传入视图模型id的root及root的下一代集合数组\r\n   */\r\n  public getRootContextAndPosterityById(viewModelId): ViewModelContext[] {\r\n    const targetContext = this.getContextById(viewModelId);\r\n    const contexts = this.getContexts();\r\n    let contextsGroup = [];\r\n    // 1.找到ROOT\r\n    const RootId = this.getContextsGroupRoot(targetContext);\r\n    // 2.可直接遍历拿到所有直系后代 (目前只有两层结构直接获取下一代)\r\n    contexts.map((context: ViewModelContext) => {\r\n      if (context.parent && context.parent.id === RootId) {\r\n        contextsGroup.push(context);\r\n      }\r\n    });\r\n    contextsGroup.push(this.getContextById(RootId));\r\n    return contextsGroup;\r\n  }\r\n\r\n  private getContextsGroupRoot(context: ViewModelContext) {\r\n    if (context.parent) {\r\n      return this.getContextsGroupRoot(context.parent);\r\n    } else {\r\n      return context.id\r\n    }\r\n  }\r\n}\r\n\r\nexport { ViewModelContextManager };\r\n","class Context {\r\n\r\n  /**\r\n   * 上下文变量\r\n   */\r\n  params: Map<string, any> = new Map<string, any>();\r\n\r\n  /**\r\n   * 获取变量\r\n   */\r\n  getParam(key: string): any {\r\n    return this.params.get(key);\r\n  }\r\n\r\n  /**\r\n   * 设置变量\r\n   */\r\n  setParam(key: string, value: any) {\r\n    this.params.set(key, value);\r\n  }\r\n}\r\n\r\nexport { Context };\r\n","/**\r\n * 应用上下文\r\n * @author Witt<jiwt@inspur.com>\r\n * @todo\r\n * 1、parnet和AppContextManager是否必要？按理说就是应该隔离上下文，表单之间通过事件通讯进行交互；\r\n */\r\nimport { Injector } from '../core/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { Context } from '../context/index';\r\nimport { BindingDataFactory } from '../binding-data';\r\nimport { ViewModelContextManager } from './view_model_contex_manager';\r\nimport { RepositoryManager } from './repository_mananger';\r\nimport { BindingDataManager } from './binding_data_manager';\r\nimport { AppEventBus } from './app_eventBus';\r\n\r\n\r\nclass AppContext extends Context {\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(\r\n    public injector: Injector,\r\n    public eventBus: AppEventBus,\r\n    public repositoryManager: RepositoryManager,\r\n    public bindingDataManager: BindingDataManager,\r\n    public viewModelContextManager: ViewModelContextManager,\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  /**\r\n   * 注册FrameContext\r\n   */\r\n  public regViewModelContext(viewModelContext: ViewModelContext): void {\r\n\r\n    const repository = viewModelContext.repository;\r\n    const repositoryName = repository.name;\r\n\r\n    // Repository\r\n    if (this.repositoryManager.ifRepositoryExits(repositoryName) === false) {\r\n      this.repositoryManager.regRepository(repositoryName, repository);\r\n    }\r\n\r\n    // BindingData\r\n    if (this.bindingDataManager.ifBindingDataExits(repositoryName) === false) {\r\n      const bindingData = BindingDataFactory.createFromRepository(repository, '/');\r\n      this.bindingDataManager.regBindingData(repositoryName, bindingData);\r\n    }\r\n\r\n    // 考虑路由再次进入的时候，AppContext没有被注销，但Component被再次构造的场景\r\n    this.viewModelContextManager.regContext(viewModelContext);\r\n  }\r\n\r\n}\r\n\r\nexport { AppContext };\r\n","import { Injector, InjectFlags } from '../core/index';\r\nimport { Context } from '../context/index';\r\nimport { AppContext } from '../app/index';\r\nimport { Entity } from '../entity/index';\r\nimport { Repository } from '../repository/index';\r\nimport { BindingData } from '../binding-data/index';\r\nimport { UIState } from '../ui-state/index';\r\nimport { StateMachine } from '../state-machine/index';\r\nimport { Form } from '../form/index';\r\nimport { ViewModel } from '../view-model/index';\r\nimport { CommandBus } from '../command/index';\r\n\r\n/**\r\n * 视图模型上下文\r\n */\r\nclass ViewModelContext {\r\n\r\n  private innerViewModel: ViewModel;\r\n\r\n  public appContext: AppContext;\r\n\r\n  public root: ViewModelContext;\r\n\r\n  public parent: ViewModelContext;\r\n\r\n  public id: string;\r\n\r\n  constructor() {\r\n  }\r\n\r\n  public init(viewModel): void {\r\n    this.innerViewModel = viewModel;\r\n    this.id = this.innerViewModel.id;\r\n    this.appContext = viewModel.injector.get(AppContext);\r\n    this.regToTree();\r\n    this.regToAppContext();\r\n  }\r\n\r\n  public regToTree() {\r\n    const parentInjector = this.innerViewModel.injector.get<Injector>(Injector, null, InjectFlags.SkipSelf);\r\n    if (parentInjector)  {\r\n      this.parent = parentInjector.get(ViewModelContext, null);\r\n      this.root = this.parent ? this.parent.root : this;\r\n    } else {\r\n      this.parent = null;\r\n      this.root = this;\r\n    }\r\n  }\r\n\r\n  public regToAppContext() {\r\n    this.appContext.regViewModelContext(this);\r\n  }\r\n\r\n  public get viewModel(): ViewModel {\r\n    return this.innerViewModel;\r\n  }\r\n\r\n  public get injector(): Injector {\r\n    return this.innerViewModel.injector;\r\n  }\r\n\r\n  public get repository(): Repository<Entity> {\r\n    return this.innerViewModel.repository;\r\n  }\r\n\r\n  public get bindingData(): BindingData {\r\n    return this.innerViewModel.bindingData;\r\n  }\r\n\r\n  public get uiState(): UIState {\r\n    return this.innerViewModel.uiState;\r\n  }\r\n\r\n  public get stateMachine(): StateMachine {\r\n    return this.innerViewModel.stateMachine;\r\n  }\r\n\r\n  public get form(): Form {\r\n    return this.innerViewModel.form;\r\n  }\r\n\r\n  public get commandBus(): CommandBus {\r\n    return this.innerViewModel.commandBus;\r\n  }\r\n\r\n}\r\n\r\nexport { ViewModelContext };\r\n","import { makePropDecorator } from '../core/index';\r\n\r\n/**\r\n * UIState属性元数据接口\r\n */\r\nexport interface UIStatePropMetadata {\r\n\r\n  /**\r\n   * 组件的ID\r\n   */\r\n  componentId?: string;\r\n\r\n  /**\r\n   * 状态名称\r\n   */\r\n  stateName?: string;\r\n  \r\n}\r\n\r\n/**\r\n * UIState属性元数据名称\r\n */\r\nexport const UISTATE_PROP_META = 'UIStatePropMeta';\r\n\r\n/**\r\n * UIState属性元数据装饰器工厂接口\r\n */\r\nexport interface UIStatePropMetaDecorator {\r\n  (obj?: UIStatePropMetadata): any;\r\n  new(obj?: UIStatePropMetadata): any;\r\n}\r\n\r\n/**\r\n * UIState属性元数据装饰器工厂\r\n */\r\nexport const UIStatePropMeta: UIStatePropMetaDecorator =\r\n  makePropDecorator(UISTATE_PROP_META, (obj?: UIStatePropMetadata) => obj);\r\n\r\n\r\n","import { MetadataUtil } from '../core/index';\r\nimport { UISTATE_PROP_META, UIStatePropMetadata } from './decorators';\r\n\r\nexport class UIStateMetadataUtil {\r\n\r\n  /**\r\n   * 获取NgUIState的属性元数据\r\n   * @param \r\n   * @returns 属性元数据对象\r\n   * @example\r\n   * 返回格式：\r\n   * {\r\n   *    '属性名称': <NgUIStateProperty>{ ...}\r\n   * }\r\n   */\r\n  static getUIFields(target: Function): {[propName: string]: UIStatePropMetadata} {\r\n      return MetadataUtil.getPropsMetadatasByName(target, UISTATE_PROP_META);\r\n  }\r\n}","/*\r\n * @Author: Witt\r\n * @Date: 2018-11-17 13:38:23\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2018-11-17 13:38:50\r\n * @todo：临时删除原有功能，待重构\r\n */\r\n\r\nimport { Subject } from 'rxjs';\r\nimport { UIStateMetadataUtil } from './uistate_metadata_util';\r\nimport { UIStatePropMetadata } from './decorators';\r\n\r\nexport interface UIStateObservableParam {\r\n  field: string;\r\n  value: any;\r\n}\r\n\r\n\r\n/**\r\n * UI状态\r\n */\r\nexport class UIState {\r\n\r\n  innerData: {};\r\n\r\n  // 监听变化\r\n  changes: Subject<UIStateObservableParam>;\r\n\r\n  constructor() {\r\n    this.changes = new Subject<UIStateObservableParam>();\r\n    this.innerData = Object.assign({});\r\n    this._init();\r\n  }\r\n\r\n  _init() {\r\n    const construct = this.constructor;\r\n    const uiFields = UIStateMetadataUtil.getUIFields(construct);\r\n    this.initializeUIField(uiFields);\r\n  }\r\n\r\n  private initializeUIField(uiFieldMetadata: { [key: string]: UIStatePropMetadata }): void {\r\n    Object.keys(uiFieldMetadata).forEach(propertyName => {\r\n      const fieldMetadata = uiFieldMetadata[propertyName] as UIStatePropMetadata;\r\n      const uiField = fieldMetadata.stateName || propertyName;\r\n\r\n      if (delete this[propertyName]) {\r\n        this.defineProperty(propertyName, uiField);\r\n      }\r\n    });\r\n  }\r\n\r\n  public isExistProperty(propertyName: any) {\r\n    if (this.innerData.hasOwnProperty(propertyName) || this.hasOwnProperty(propertyName)) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private defineProperty(propertyName: any, field: any = null) {\r\n    Object.defineProperty(this, propertyName, {\r\n      get: function () {\r\n        return field !== null ? this.innerData[field] : this.innerData[propertyName];\r\n      },\r\n      set: function (value) {\r\n        // 值相同时不触发变更\r\n        const oldValue = field !== null ? this.innerData[field] : this.innerData[propertyName];\r\n        if (oldValue === value) {\r\n          return;\r\n        }\r\n        if (field !== null) {\r\n          this.innerData[field] = value;\r\n        } else {\r\n          this.innerData[propertyName] = value;\r\n        }\r\n        this.changes.next({\r\n          field: propertyName,\r\n          value: value\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  public setPropertyValue(propertyName: any, value: any) {\r\n    if (propertyName === '' || propertyName === undefined) {\r\n      return;\r\n    }\r\n    if (!this.isExistProperty(propertyName)) {\r\n      this.defineProperty(propertyName);\r\n    }\r\n    this[propertyName] = value;\r\n  }\r\n}\r\n","import { StateMachineContext } from './state_machine_context';\r\n\r\n/**\r\n * --------------------------------------------------------------------------------\r\n * State相关\r\n * --------------------------------------------------------------------------------\r\n */\r\n\r\n/**\r\n * 基本状态：表单的基本状态，通过State的运算确定RenderState的值，进而控制页面控件的状态。\r\n */\r\nexport class State {\r\n\r\n  /**\r\n   * 构造函数\r\n   * @param name 状态名称\r\n   */\r\n  constructor(public name: string) {\r\n  }\r\n}\r\n\r\n/**\r\n * 基本状态字典, 形如\r\n * {\r\n *  stateName1: stateInstance1,\r\n *  stateName2: stateInstance2,\r\n *  ...\r\n * }\r\n */\r\nexport interface StateDictionary {\r\n    [index: string]: State;\r\n}\r\n\r\n\r\n/**\r\n * --------------------------------------------------------------------------------\r\n * RenderState相关\r\n * --------------------------------------------------------------------------------\r\n */\r\n\r\n/**\r\n * 渲染状态，该状态用于和界面UI绑定\r\n */\r\nexport type RenderState = boolean;\r\n\r\n/**\r\n * 初始渲染状态\r\n */\r\nexport const initialUIState: RenderState = false;\r\n\r\n/**\r\n * 渲染状态字典，形如：\r\n * {\r\n *  renderStateName1: true,\r\n *  renderStateName1: false,\r\n *  ...\r\n * }\r\n */\r\nexport interface RenderStateDictionary {\r\n  [index: string]: RenderState;\r\n}\r\n\r\n\r\n/**\r\n * 渲染方法\r\n * 该方法接收一个StateMachineContext类型的上下文，\r\n * 通过对上下文中指定的当前状态的计算，确定对应渲染状态的值，该方法返回一个RenderState类型的值（即布尔类型）\r\n */\r\nexport type Render = (context: StateMachineContext) => RenderState;\r\n\r\n/**\r\n * 渲染方法字典\r\n * {\r\n *  renderStateName1: render1,\r\n *  renderStateName1: render2,\r\n *  ...\r\n * }\r\n */\r\nexport interface RenderDictionary {\r\n  [index: string]: Render;\r\n}\r\n\r\n\r\n/**\r\n * --------------------------------------------------------------------------------\r\n * Action相关\r\n * --------------------------------------------------------------------------------\r\n */\r\n\r\n/**\r\n * 状态机动作\r\n */\r\nexport type Action = () => any;\r\n\r\n/**\r\n * 状态机行为约束条件\r\n */\r\n// export interface Precondition {\r\n// }\r\n\r\n\r\n/**\r\n * --------------------------------------------------------------------------------\r\n * Effect相关\r\n * --------------------------------------------------------------------------------\r\n */\r\n\r\n/**\r\n * 行为效果，表示状态机发起某行为后引起的界面变化效果\r\n */\r\nexport interface EffectHandlerOption {\r\n\r\n  /**\r\n   * 效果类型\r\n   */\r\n  type: string;\r\n\r\n  /**\r\n   * 效果实现\r\n   */\r\n  effect: any;\r\n}\r\n\r\n/**\r\n * 状态机界面效果\r\n */\r\nexport interface Effect {\r\n\r\n  /**\r\n   * 行为约束条件集合\r\n   */\r\n  preconditions?: any[];\r\n\r\n  /**\r\n   * 发生某行为后引起的界面变化效果\r\n   */\r\n  handlers?: EffectHandlerOption[];\r\n}\r\n\r\n/**\r\n * 状态机效果字典\r\n */\r\nexport interface EffectDictianry {\r\n    [index: string]: Effect;\r\n}\r\n\r\n\r\n","import { makePropDecorator } from '../../core/index';\r\n\r\n/**\r\n * 页面状态元数据\r\n */\r\nexport interface StatePropMetadata {\r\n\r\n  /**\r\n   * 初始状态\r\n   */\r\n  initialState?: boolean;\r\n}\r\n\r\n\r\n/**\r\n * 状态元数据名称\r\n */\r\nexport const STATE_PROP_META = 'StatePropMeta';\r\n\r\n\r\n/**\r\n * 页面状态元数据装饰器工厂接口\r\n */\r\nexport interface StatePropMetaDecorator {\r\n  (obj?: StatePropMetadata): any;\r\n  new(obj?: StatePropMetadata): any;\r\n}\r\n\r\n/**\r\n * 页面状态元数据装饰器工厂\r\n */\r\nexport const StatePropMeta: StatePropMetaDecorator =\r\n  makePropDecorator(STATE_PROP_META, (obj?: StatePropMetadata) => obj);\r\n","import { makePropDecorator } from '../../core/index';\r\nimport { Render } from '../types';\r\n\r\n/**\r\n * 组件状态元数据\r\n */\r\nexport interface RenderStatePropMetadata {\r\n  render: Render;\r\n}\r\n\r\n\r\n/**\r\n * 组件状态元数据名称\r\n */\r\nexport const RENDER_STATE_PROP_META = 'RenderStatePropMeta';\r\n\r\n\r\n/**\r\n * 组件状态元数据工厂接口\r\n */\r\nexport interface RenderStatePropMetaDecorator {\r\n  (obj?: RenderStatePropMetadata): any;\r\n  new(obj?: RenderStatePropMetadata): any;\r\n}\r\n\r\n/**\r\n * 组件状态元数据工厂\r\n */\r\nexport const RenderStatePropMeta: RenderStatePropMetaDecorator =\r\n  makePropDecorator(RENDER_STATE_PROP_META, (obj: RenderStatePropMetadata) => obj);","import { makePropDecorator } from '../../core/index';\r\n\r\n/**\r\n * 迁移动作\r\n */\r\nexport interface ActionMethodMetadata {\r\n  precondition?: any[];\r\n  transitTo: string;\r\n}\r\n\r\n\r\n/**\r\n * 动作方法元数据名称\r\n */\r\nexport const ACTION_METHOD_META = 'ActionMethodMeta';\r\n\r\n\r\n/**\r\n * 迁移动作元数据装饰工厂接口\r\n */\r\nexport interface ActionMethodMetaDecorator {\r\n  (obj?: ActionMethodMetadata): any;\r\n  new(obj?: ActionMethodMetadata): any;\r\n}\r\n\r\n/**\r\n * 迁移动作元数据装饰工厂\r\n */\r\nexport const ActionMethodMeta: ActionMethodMetaDecorator =\r\n  makePropDecorator(ACTION_METHOD_META, (action: ActionMethodMetadata) => action);","import { StateMachine } from './state_machine';\r\nimport { State } from './types';\r\nimport { Context } from '../context/context';\r\nimport { VariableParseService } from '../variable/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { StateMachineWatcher } from './state_machine_watcher';\r\n\r\n/**\r\n * 状态机上下文\r\n */\r\nexport class StateMachineContext {\r\n\r\n  /**\r\n   * 当前状态名称\r\n   */\r\n  public state: string;\r\n\r\n  /**\r\n   * 父Context\r\n   */\r\n  public parent: Context;\r\n\r\n  /**\r\n   * 变量解析器\r\n   */\r\n  public parser: any;\r\n\r\n  /**\r\n   * ViewModel上下文\r\n   */\r\n  public viewModelContext: ViewModelContext;\r\n\r\n  /**\r\n   * 状态机事件监听\r\n   */\r\n  public stateMachineWatcher: StateMachineWatcher;\r\n\r\n  /**\r\n   * 构造函数\r\n   * @param stateMachine 状态机实例\r\n   * @param initialState 初始状态\r\n   */\r\n  constructor(public stateMachine: StateMachine, initialState: State) {\r\n    this.state = initialState.name;\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  public init(frameContext: ViewModelContext) {\r\n    this.viewModelContext = frameContext;\r\n    this.parser = this.viewModelContext.injector.get(VariableParseService);\r\n    this.stateMachineWatcher = this.stateMachine.stateMachineWatcher;\r\n  }\r\n\r\n  /**\r\n   * 状态迁移\r\n   * @param stateName 下一状态的名称\r\n   */\r\n  public transitTo(stateName: string) {\r\n    const nextState = this.stateMachine.states[stateName];\r\n    if (nextState) {\r\n      this.state = nextState.name;\r\n      this.stateMachine.render();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取expression对应的UIState值\r\n   * @param expression UIState表达式\r\n   */\r\n  public getUIState(expression: string): any {\r\n    if (!expression) {\r\n      return;\r\n    }\r\n    const viewModelContext = this.stateMachineWatcher.getViewModelContext(expression);\r\n    if (!viewModelContext) {\r\n      return;\r\n    }\r\n\r\n    this.stateMachineWatcher.subscribeUIStateChange(viewModelContext, expression);\r\n\r\n    if (this.parser) {\r\n      const value = this.parser.parse(expression, viewModelContext);\r\n      if (value === null) {\r\n        return null;\r\n      }\r\n      if (typeof value === 'object' && Object.keys(value).length === 0) {\r\n        return null;\r\n      }\r\n      return value;\r\n    } else {\r\n      throw new Error('未初始化变量解析器。');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取数据的值\r\n   */\r\n  public getData(expression: string): any {\r\n    if (!expression) {\r\n      return;\r\n    }\r\n    const viewModelContext = this.stateMachineWatcher.getViewModelContext(expression);\r\n    if (!viewModelContext) {\r\n      return;\r\n    }\r\n\r\n    this.stateMachineWatcher.subscribeEntityChange(viewModelContext, expression);\r\n\r\n    if (this.parser) {\r\n      const value = this.parser.parse(expression, viewModelContext);\r\n      if (value === null) {\r\n        return null;\r\n      }\r\n      if (typeof value === 'object' && Object.keys(value).length === 0) {\r\n        return null;\r\n      }\r\n      return value;\r\n    } else {\r\n      throw new Error('未初始化变量解析器。');\r\n    }\r\n  }\r\n}\r\n","import { StateMachine } from './state_machine';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { Change } from '../binding-data/changes';\r\n\r\n\r\n/**\r\n * 状态机事件，监听uistate的变化和entity的变化\r\n */\r\nexport class StateMachineWatcher {\r\n\r\n  /**\r\n   * 当前ViewModel上下文\r\n   */\r\n  private viewModelContext: ViewModelContext;\r\n\r\n  /**\r\n   * viewModel=>UIStatePahts字典\r\n   */\r\n  private viewModelContextAndUIStatePathsMap: Map<ViewModelContext, Array<string>>;\r\n\r\n  /**\r\n   * viewModel=>DataStatePahts字典\r\n   */\r\n  private viewModelContextAndDataStatePathsMap: Map<ViewModelContext, Array<string>>;\r\n\r\n  /**\r\n   * 所有UIStatePath数组\r\n   */\r\n  private uiStatePathList: Array<string> = [];\r\n\r\n  /**\r\n   * 所有DataStatePath数组\r\n   */\r\n  private dataStatePathList: Array<string> = [];\r\n\r\n  constructor(public stateMachine: StateMachine) {\r\n    this.viewModelContextAndUIStatePathsMap = new Map<ViewModelContext, any>();\r\n    this.viewModelContextAndDataStatePathsMap = new Map<ViewModelContext, any>();\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   * @param viewModelContext 当前视图上下文\r\n   */\r\n  public init(viewModelContext: ViewModelContext) {\r\n    this.viewModelContext = viewModelContext;\r\n  }\r\n\r\n  /**\r\n   * 返回表达式中ViewModelId对应的ViewModelContext\r\n   */\r\n  public getViewModelContext(expression: any): ViewModelContext {\r\n    const viewModelId = this.extractPaths(expression).split('/')[1];\r\n    return this.viewModelContext.appContext.viewModelContextManager.getContextById(viewModelId);\r\n  }\r\n\r\n  /**\r\n   * 监听UIState变更\r\n   * @param viewModelContext ViewModel上下文\r\n   * @param expression UIState表达式\r\n   */\r\n  public subscribeUIStateChange(viewModelContext: ViewModelContext, expression: any) {\r\n    const uiStatePath = this.getStatePath(expression);\r\n\r\n    if (this.viewModelContextAndUIStatePathsMap.has(viewModelContext) === false) {\r\n      this.viewModelContextAndUIStatePathsMap.set(viewModelContext, this.uiStatePathList);\r\n      viewModelContext.uiState.changes.subscribe((uiStateChange) => {\r\n        const uiStatePathList = this.viewModelContextAndUIStatePathsMap.get(viewModelContext);\r\n        if (uiStateChange.field && uiStatePathList.indexOf(uiStateChange.field) > -1) {\r\n          this.stateMachine.render();\r\n        }\r\n      });\r\n    }\r\n\r\n    if (this.viewModelContextAndUIStatePathsMap.get(viewModelContext).indexOf(uiStatePath) === -1) {\r\n      this.uiStatePathList.push(uiStatePath);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 监听实体变更\r\n   */\r\n  public subscribeEntityChange(viewModelContext: ViewModelContext, expression: any) {\r\n\r\n    if (this.viewModelContextAndDataStatePathsMap.has(viewModelContext) === false) {\r\n      this.viewModelContextAndDataStatePathsMap.set(viewModelContext, this.dataStatePathList);\r\n      viewModelContext.bindingData.changes.subscribe((change: Change) => {\r\n\r\n        if (change.type === 'Load' || change.type === 'SelectionChanged') {\r\n          this.stateMachine.render();\r\n        }\r\n\r\n        const dataPathList = this.viewModelContextAndDataStatePathsMap.get(viewModelContext);\r\n        if (change.path.join() && this.isAccordingPath(dataPathList, change.path.join('/'))) {\r\n          this.stateMachine.render();\r\n        }\r\n      });\r\n    }\r\n\r\n    if (this.viewModelContextAndDataStatePathsMap.get(viewModelContext).indexOf(expression) === -1) {\r\n      this.dataStatePathList.push(expression);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 根据表达式获取对应的StatePath（移除了ViewModelId之外的部分）\r\n   * @param expression 变量表达式\r\n   */\r\n  private getStatePath(expression: any) {\r\n    return this.extractPaths(expression).split('/')[2];\r\n  }\r\n\r\n  /**\r\n   * 判断是否监听范围内的变更路径\r\n   */\r\n  public isAccordingPath(dataStatePaths: any, dataStatePath: string) {\r\n    const targetPath = dataStatePaths.find((item) => {\r\n      return item.indexOf(dataStatePath) > -1;\r\n    });\r\n\r\n    return targetPath === undefined ? false : true;\r\n  }\r\n\r\n  /**\r\n   * 暂时把这个方法放了这个地方，等季老师共用方法调整后，直接引用他的方法，该方法可删除\r\n   * @param expression 变量表达式\r\n   */\r\n  private extractPaths(expression: string): string {\r\n    let path: string;\r\n    const UI_STATE_PATTERN_G = /\\{UISTATE~(\\S+?)\\}/g;\r\n    const DATA_PATTERN_G = /\\{DATA~(\\S+?)\\}/g;\r\n    const uiStateVariables = expression.match(UI_STATE_PATTERN_G);\r\n    const dataVariables = expression.match(DATA_PATTERN_G);\r\n    if (uiStateVariables !== null) {\r\n      const UI_STATE_PATTERN = /\\{UISTATE~(\\S+?)\\}/;\r\n      uiStateVariables.forEach((uiStateVariable: string) => {\r\n        const pathMatches = uiStateVariable.match(UI_STATE_PATTERN);\r\n        if (pathMatches != null && pathMatches.length === 2) {\r\n          path = pathMatches[1];\r\n        }\r\n      });\r\n    }\r\n    if (dataVariables !== null) {\r\n      const DATA_PATTERN = /\\{DATA~(\\S+?)\\}/;\r\n      dataVariables.forEach((dataVariable: string) => {\r\n        const pathMatches = dataVariable.match(DATA_PATTERN);\r\n        if (pathMatches != null && pathMatches.length === 2) {\r\n          path = pathMatches[1];\r\n        }\r\n      });\r\n    }\r\n    return path;\r\n  }\r\n}","import { BehaviorSubject } from 'rxjs';\r\nimport { MetadataUtil } from '../core/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\n\r\nimport { State, initialUIState, StateDictionary, RenderStateDictionary, RenderDictionary } from './types';\r\nimport {\r\n  StatePropMetadata, ActionMethodMetadata, RenderStatePropMetadata,\r\n  STATE_PROP_META, RENDER_STATE_PROP_META, ACTION_METHOD_META\r\n} from './decorators';\r\nimport { StateMachineContext } from './state_machine_context';\r\nimport { StateMachineWatcher } from './state_machine_watcher';\r\n\r\n/**\r\n * 状态机\r\n */\r\nexport class StateMachine {\r\n\r\n  /**\r\n   * 初始状态\r\n   */\r\n  private initialState: State;\r\n\r\n  /**\r\n   * 状态字典\r\n   */\r\n  public states: StateDictionary;\r\n\r\n  /**\r\n   * 渲染状态字典\r\n   */\r\n  public renderStates: RenderStateDictionary;\r\n\r\n  /**\r\n   * 渲染器字典\r\n   */\r\n  public renders: RenderDictionary;\r\n\r\n  /**\r\n   * 状态机上下文\r\n   */\r\n  public context: StateMachineContext;\r\n\r\n  /**\r\n   * 状态变更\r\n   */\r\n  public stateChange: BehaviorSubject<string>;\r\n\r\n  /**\r\n   * ViewModel上下文\r\n   */\r\n  public viewModelContext: ViewModelContext;\r\n\r\n  /**\r\n   * 状态机事件监听\r\n   */\r\n  public stateMachineWatcher: StateMachineWatcher;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n    this.renderStates = {};\r\n    this.handlePropMetadatas();\r\n    this.stateChange = new BehaviorSubject<any>(false);\r\n    this.context = new StateMachineContext(this, this.initialState);\r\n    this.stateMachineWatcher = new StateMachineWatcher(this);\r\n  }\r\n\r\n  /**\r\n   * 初始化状态机\r\n   * @param viewModelContext ViewModel上下文\r\n   * @summary\r\n   * 状态机变更，为了在绑定数据之后执行状态机的操作，把render方法延后执行。\r\n   */\r\n  public init(viewModelContext: ViewModelContext) {\r\n    this.viewModelContext = viewModelContext;\r\n    this.context.init(this.viewModelContext);\r\n    this.stateMachineWatcher.init(this.viewModelContext);\r\n    this.render();\r\n  }\r\n\r\n  /**\r\n   * 批量处理属性元数据\r\n   */\r\n  private handlePropMetadatas() {\r\n    const propsMetadatas = MetadataUtil.getPropsMetadatas(this.constructor);\r\n\r\n    // 遍历所有属性装饰器，并调用相应的build方法\r\n    if (propsMetadatas) {\r\n      Object.keys(propsMetadatas).forEach((propName: string) => {\r\n        const propMetadatas = propsMetadatas[propName];\r\n        propMetadatas.forEach(propMetadata => {\r\n          this.handlePropMetadata(propName, propMetadata);\r\n        });\r\n      });\r\n    }\r\n\r\n    if (!this.initialState) {\r\n      throw new Error('请在StatePropMeta注解中指定状态机的初始状态。');\r\n    }\r\n  }\r\n  \r\n  /**\r\n   * 处理属性元数据\r\n   */\r\n  private handlePropMetadata(propName: string, propMetadata: any) {\r\n    const ngMetadataName =  propMetadata.ngMetadataName;\r\n    switch(ngMetadataName) {\r\n      case STATE_PROP_META:\r\n        this.buildState(propName, propMetadata);\r\n        break;\r\n      case RENDER_STATE_PROP_META:\r\n        this.buildRenderState(propName, propMetadata);\r\n        break;\r\n      case ACTION_METHOD_META:\r\n        this.buildAction(propName, propMetadata);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 包装State\r\n   * @param stateName 状态名称\r\n   * @param ngState   状态对象\r\n   */\r\n  private buildState(stateName: string, ngState: StatePropMetadata) {\r\n    this.states = this.states || {};\r\n    this[stateName] = new State(stateName);\r\n    this.states[stateName] = this[stateName];\r\n    if (ngState.initialState) {\r\n      this.initialState = this[stateName];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 包装RenderState\r\n   * @param renderStateName 渲染状态名称\r\n   * @param ngRenderState   渲染状态元数据\r\n   */\r\n  private buildRenderState(renderStateName: string, ngRenderState: RenderStatePropMetadata) {\r\n    this.renderStates = this.renderStates || {};\r\n    this[renderStateName] = initialUIState;\r\n    this.renderStates[renderStateName] = this[renderStateName];\r\n\r\n    // 将renderState上指定的render加入到renders中\r\n    this.renders = this.renders || {};\r\n    this.renders[renderStateName] = ngRenderState.render;\r\n  }\r\n\r\n  /**\r\n   * 包装Action\r\n   * @param actionName 动作名称\r\n   * @param ngAction 动作元数据\r\n   */\r\n  private buildAction(actionName: string, ngAction: ActionMethodMetadata) {\r\n    this[actionName] = () => {\r\n      const nextStateName = ngAction.transitTo;\r\n      const nextState: State = this.states[nextStateName];\r\n      this.context.transitTo(nextState.name);\r\n      this.render();\r\n    };\r\n  }\r\n\r\n  /**\r\n   * 重新计算所有渲染状态的值\r\n   * @sumamry\r\n   * 当 state切换的时候，调用遍历所有的render方法，更改renderState\r\n   */\r\n  render() {\r\n    for (const renderStateName in this.renderStates) {\r\n\r\n      if (this.renderStates.hasOwnProperty(renderStateName) === false) {\r\n        continue;\r\n      }\r\n\r\n      // 执行RenderState的render方法，更新renderState\r\n      const stateRender = this.renders[renderStateName];\r\n      if (!stateRender) {\r\n        continue;\r\n      }\r\n\r\n      this.renderStates[renderStateName] = stateRender(this.context);\r\n      this[renderStateName] = this.renderStates[renderStateName];\r\n    }\r\n    this.stateChange.next(this.context.state);\r\n  }\r\n}\r\n","import { DateUtil } from '../utils/index';\r\n\r\n/**\r\n * 绑定值转换器\r\n */\r\ninterface BindingValueConverter {\r\n\r\n  /**\r\n   * 将ControlValue转换为StateValue值\r\n   */\r\n  convertFrom(controlValue: any): any;\r\n\r\n  /**\r\n   * 将StateValue转换为ControlValue\r\n   */\r\n  convertTo(stateValue: any): any;\r\n}\r\n\r\n\r\n/**\r\n * 日期字符串转换器\r\n */\r\nclass DateStringValueConverter implements BindingValueConverter {\r\n\r\n  public convertFrom(dateObj: Date): string {\r\n    return  DateUtil.formatISO(dateObj);\r\n  }\r\n\r\n  public convertTo(dateString): Date {\r\n    return DateUtil.parse(dateString);\r\n  }\r\n}\r\n\r\n\r\n/**\r\n * 数组字符串转换器\r\n */\r\nclass ArrayStringValueConverter implements BindingValueConverter  {\r\n\r\n  public convertFrom(arr: any[]): string {\r\n    return  arr.join(',');\r\n  }\r\n\r\n  public convertTo(arrString): any[] {\r\n    return arrString.split(',');\r\n  }\r\n\r\n}\r\n\r\nexport { BindingValueConverter, DateStringValueConverter, ArrayStringValueConverter };\r\n\r\n\r\n\r\n","import { BindingData } from '../binding-data/index';\r\nimport { UIState } from '../ui-state/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { BindingPathConverter, DateUtil } from '../utils/index';\r\n\r\nimport { BindingType } from './types';\r\nimport { BindingValueConverter } from './binding_value_converter';\r\n\r\n/**\r\n * 绑定值访问器接口\r\n */\r\ninterface BindingValueAccessor {\r\n\r\n  getValue(): any;\r\n\r\n  setValue(controlValue: any): void;\r\n}\r\n\r\n/**\r\n * Entity值访问器\r\n */\r\nclass EntityBindingValueAccessor implements BindingValueAccessor {\r\n\r\n  private bindingData: BindingData;\r\n\r\n  private bindingPathSegments: string[];\r\n\r\n  private valueConverter: BindingValueConverter;\r\n\r\n  constructor(bindingData: BindingData, bindingPath: string, valueConverter: BindingValueConverter) {\r\n    this.bindingData = bindingData;\r\n    this.bindingPathSegments = this.getBindingPathSegments(bindingPath);\r\n    this.valueConverter = valueConverter;\r\n  }\r\n\r\n  public getValue(): any {\r\n    const stateValue = this.bindingData.getValue(this.bindingPathSegments);\r\n    const controlValue = this.valueConverter ? this.valueConverter.convertTo(stateValue) : stateValue;\r\n    return controlValue;\r\n  }\r\n\r\n  public setValue(controlValue: any): void {\r\n    const oldStateValue = this.bindingData.getValue(this.bindingPathSegments);\r\n    const stateValue = this.valueConverter ? this.valueConverter.convertFrom(controlValue) : controlValue;\r\n\r\n    if (this.isDateConverter(this.valueConverter) === true) {\r\n      if (DateUtil.isEqual(oldStateValue, stateValue) === true) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.bindingData.setValue(this.bindingPathSegments, stateValue, true, true);\r\n  }\r\n\r\n  private getBindingPathSegments(bindingPath: string) {\r\n    const parentPathSegments = BindingPathConverter.toBindingPathArray(this.bindingData.bindingPath);\r\n    bindingPath = bindingPath.replace(/\\./g, '\\/');\r\n    const bindingPathSegments = BindingPathConverter.toBindingPathArray(bindingPath);\r\n    return parentPathSegments.concat(bindingPathSegments);\r\n  }\r\n\r\n  /**\r\n   * 是否是DateConverter\r\n   */\r\n  private isDateConverter(converter: BindingValueConverter): boolean {\r\n    let isDateConverter = false;\r\n    if (converter && converter.hasOwnProperty('format') === true) {\r\n      isDateConverter = true;\r\n    }\r\n    return isDateConverter;\r\n  }\r\n}\r\n\r\n/**\r\n * UIState值访问器\r\n */\r\nclass UIStateBindingValueAccessor implements BindingValueAccessor {\r\n\r\n  private uiState: UIState;\r\n\r\n  private bindingPathSegments: string[];\r\n\r\n\r\n  constructor(uiState: UIState, bindingPath: string, valueConverter: BindingValueConverter) {\r\n    this.uiState = uiState;\r\n    this.bindingPathSegments = this.getUiStateBindingPath(bindingPath);\r\n  }\r\n\r\n  public getValue(): any {\r\n    let stateValue;\r\n    let obj = this.uiState;\r\n    this.bindingPathSegments.forEach(item => {\r\n      stateValue = obj[item];\r\n      obj = stateValue\r\n    })\r\n    return stateValue;\r\n  }\r\n\r\n  public setValue(controlValue: any): void {\r\n    const length = this.bindingPathSegments.length;\r\n    if (length === 1) {\r\n      this.uiState.setPropertyValue(this.bindingPathSegments, controlValue);\r\n    } else {\r\n      let obj;\r\n      for(let i = length-1 ; i > 0 ; i--){\r\n        obj = {[this.bindingPathSegments[i]]: controlValue};\r\n        controlValue = obj;\r\n      }\r\n      this.uiState.setPropertyValue(this.bindingPathSegments[0], obj);\r\n    }\r\n  }\r\n\r\n  // UISTATE获取路径\r\n  private getUiStateBindingPath(bindingPath: string) {\r\n    const index = bindingPath.search('/');\r\n    if (index !== -1) {\r\n      return bindingPath.split('/')\r\n    } else {\r\n      return [bindingPath]\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * 绑定值访问器工厂\r\n */\r\nclass BindingValueAccessorFactory {\r\n\r\n  static create(bindingType: BindingType, bindingBindingPath: string, bindingValueConverter, viewModelContext: ViewModelContext) {\r\n    switch (bindingType) {\r\n      case BindingType.EntityState:\r\n        const bindingData = viewModelContext.bindingData;\r\n        return new EntityBindingValueAccessor(bindingData, bindingBindingPath, bindingValueConverter);\r\n      case BindingType.UIState:\r\n        const uiState = viewModelContext.uiState;\r\n        return new UIStateBindingValueAccessor(uiState, bindingBindingPath, bindingValueConverter);\r\n      default:\r\n        throw new Error('Not Supported');\r\n    }\r\n  }\r\n}\r\n\r\nexport { BindingValueAccessor, EntityBindingValueAccessor, UIStateBindingValueAccessor, BindingValueAccessorFactory };\r\n","\r\nimport { makePropDecorator } from '../core/index';\r\nimport { BindingType } from './types';\r\nimport { BindingValueConverter } from './binding_value_converter';\r\nimport { ValidationRule } from '../validator';\r\n\r\n/**\r\n * FormControl元数据名称\r\n */\r\nexport const FORM_CONTROL_PROP_META = 'FormControlPropMeta';\r\n\r\n\r\n/**\r\n * FormControl元数据\r\n */\r\nexport interface FormControlMetadata {\r\n\r\n  /**\r\n   * 控件名称\r\n   */\r\n  name?: string;\r\n\r\n  /**\r\n   * 绑定字段路径\r\n   */\r\n  bindingType?: BindingType;\r\n\r\n  /**\r\n   * 绑定路径\r\n   */\r\n  bindingPath?: string;\r\n\r\n  /**\r\n   * 值转换器\r\n   */\r\n  valueConverter?: BindingValueConverter;\r\n\r\n    /**\r\n   * 值改变前监听器\r\n   */\r\n  valueChanging?: string;\r\n  /**\r\n   * 值改变后监听器\r\n   */\r\n  valueChanged?: string;\r\n  /**\r\n    * 验证规则\r\n    */\r\n  validRules?: ValidationRule | ValidationRule[] | null;\r\n}\r\n\r\n/**\r\n * 表单控件装饰器\r\n */\r\nexport interface FormControlPropMetaDecorator {\r\n  (obj?: FormControlMetadata): any;\r\n  new(obj?: FormControlMetadata): any;\r\n}\r\n\r\n/**\r\n * FormControl装饰器工厂\r\n */\r\nexport const FormControlPropMeta: FormControlPropMetaDecorator =\r\n  makePropDecorator(FORM_CONTROL_PROP_META, (obj: FormControlMetadata) => obj);\r\n","import { ValidationRule } from './types';\r\nimport { DateUtil } from '../utils/date_util'\r\n/**\r\n * 验证器工厂\r\n */\r\nclass ValidatorFactory {\r\n    /**\r\n     * 创建适配器\r\n     */\r\n    static create(validRules: ValidationRule | ValidationRule[]): any {\r\n        let validatorFn = [];\r\n        if (Array.isArray(validRules) && validRules.length > 1) {\r\n            validRules.forEach((validRule: ValidationRule) => {\r\n                validatorFn.push(this.initValidRuleFn(validRule))\r\n            })\r\n        } else if (Array.isArray(validRules) && validRules.length === 1) {\r\n            validatorFn.push(this.initValidRuleFn(validRules[0]))\r\n        } else {\r\n            validatorFn.push(this.initValidRuleFn(validRules as ValidationRule))\r\n        }\r\n        return validatorFn;\r\n    }\r\n\r\n    private static initValidRuleFn(validRule: ValidationRule): any {\r\n        const { type, constraints, message } = validRule;\r\n        switch (type) {\r\n            case 'required':\r\n                return (v) => {\r\n                    if (constraints[0] === true) {\r\n                        if (null === v || undefined === v || '' === v) {\r\n                            return { passing: false, message: message || '必填' }\r\n                        } else {\r\n                            return { passing: true, message: '' }\r\n\r\n                        }\r\n                    }\r\n                }\r\n            case 'NumberMaxValue':\r\n                return (v) => {\r\n                    if (typeof v !== 'number') {\r\n                        return\r\n                    }\r\n                    if (constraints[0] || 0 == constraints[0]) {\r\n                        if (v <= parseFloat(constraints[0])) {\r\n                            return { passing: true, message: '' }\r\n                        } else {\r\n                            return { passing: false, message: message || `输入值不能大于${constraints[0]}` }\r\n                        }\r\n                    }\r\n                }\r\n            case 'NumberMinValue':\r\n                return (v) => {\r\n                    if (typeof v !== 'number') {\r\n                        return\r\n                    }\r\n                    if (constraints[0] || 0 == constraints[0]) {\r\n                        if (v >= parseFloat(constraints[0])) {\r\n                            return { passing: true, message: '' }\r\n                        } else {\r\n                            return { passing: false, message: message || `输入值不能小于${constraints[0]}` }\r\n                        }\r\n                    }\r\n                }\r\n            case 'DateMaxValue':\r\n                return (v) => {\r\n                    if (constraints[0]) {\r\n                        if (DateUtil.isBefore(v, constraints[0]) || DateUtil.isSame(v, constraints[0])) {\r\n                            return { passing: true, message: '' }\r\n                        } else {\r\n                            return { passing: false, message: message || `输入日期不能大于${constraints[0]}` }\r\n                        }\r\n                    }\r\n                }\r\n            case 'DateMinValue':\r\n                return (v) => {\r\n                    if (constraints[0]) {\r\n                        if (DateUtil.isAfter(v, constraints[0]) || DateUtil.isSame(v, constraints[0])) {\r\n                            return { passing: true, message: '' }\r\n                        } else {\r\n                            return { passing: false, message: message || `输入日期不能小于${constraints[0]}` }\r\n                        }\r\n                    }\r\n                }\r\n            case 'StringMaxLength':\r\n                return (v) => {\r\n                    if (constraints[0]) {\r\n                        if (v.length <= constraints[0]) {\r\n                            return { passing: true, message: '' }\r\n                        } else {\r\n                            return { passing: false, message: message || `输入值长度不能大于${constraints[0]}` }\r\n                        }\r\n                    }\r\n                }\r\n            case 'StringMinLength':\r\n                return (v) => {\r\n                    if (constraints[0]) {\r\n                        if (v.length >= constraints[0]) {\r\n                            return { passing: true, message: '' }\r\n                        } else {\r\n                            return { passing: false, message: message || `输入值长度不能小于${constraints[0]}` }\r\n                        }\r\n                    }\r\n                }\r\n            case 'regex':\r\n                return (v) => {\r\n                    let constraintsTemp = [];\r\n                    if (typeof constraints[0] === 'string') {\r\n                        constraintsTemp = constraints[0].split(',');\r\n                    }\r\n                    for (let i = 0 ; i < constraintsTemp.length ; i++){\r\n                        if(constraintsTemp[i] === ''){\r\n                            return \r\n                        }\r\n                        const re = new RegExp(constraintsTemp[i]);\r\n                        if (re.test(v)) {\r\n                            return { passing: false, message: message  || `存在不可输入项${constraints[0]}` }\r\n                        } else {\r\n                            return { passing: true, message: '' }\r\n                        }\r\n                    }\r\n\r\n                }\r\n            case 'customFunction':\r\n                return (v) => {\r\n                    if (typeof constraints[0] === 'function') {\r\n                        let message = constraints[0](v)\r\n                        if (!message) {\r\n                            return { passing: true, message: '' }\r\n                        } else {\r\n                            return { passing: false, message }\r\n                        }\r\n                    }\r\n                }\r\n            default:\r\n                return () => {\r\n                    return { passing: true, message: '' }\r\n                }\r\n        }\r\n\r\n    }\r\n\r\n    /**\r\n     * 遍历生成的校验方法对当前值进行校验，当发现错误就返回校验结果\r\n     * 遍历完成没有错误则返回校验通过结果\r\n     * @param validatorFn 校验方法\r\n     * @param value 当前值\r\n     */\r\n    static executeValidator(validatorFn, value) {\r\n        for (let i = 0; i < validatorFn.length; i++) {\r\n            let validationResult = validatorFn[i](value);\r\n            if (validationResult['passing'] === false) {\r\n                return validationResult;\r\n            }\r\n        }\r\n        return { passing: true, message: '' };\r\n    }\r\n\r\n}\r\n\r\nexport { ValidatorFactory };","import { ViewModelContext } from '../view-model/index';\r\nimport { BindingType } from './types';\r\nimport { BindingValueConverter } from './binding_value_converter';\r\nimport { BindingValueAccessor, BindingValueAccessorFactory } from './binding_value_accessor';\r\nimport { ValidationRule, ValidatorFactory } from '../validator/index'\r\n\r\n/**\r\n * 表单控件配置\r\n */\r\ninterface FormControlConfig {\r\n  name: string;\r\n  bindingType: BindingType;\r\n  bindingPath: string;\r\n  valueConverter?: BindingValueConverter;\r\n  valueChanging?: string;\r\n  valueChanged?: string;\r\n  validRules?: ValidationRule | ValidationRule[] | null;\r\n}\r\n\r\n/**\r\n * FormControl定义\r\n */\r\nclass FormControl {\r\n\r\n  private valueAccessor: BindingValueAccessor;\r\n\r\n  private validatorFn: any;\r\n\r\n  private validationResult: any;\r\n\r\n  constructor(config: FormControlConfig, viewModelContext: ViewModelContext) {\r\n    this.valueAccessor = BindingValueAccessorFactory.create(\r\n      config.bindingType,\r\n      config.bindingPath,\r\n      config.valueConverter,\r\n      viewModelContext\r\n    );\r\n    this.validatorFn = config.validRules && ValidatorFactory.create(config.validRules)\r\n  }\r\n\r\n  public get value() {\r\n    return this.valueAccessor.getValue();\r\n  }\r\n\r\n  public set value(val) {\r\n    this.valueAccessor.setValue(val);\r\n  }\r\n}\r\n\r\nexport { FormControlConfig, FormControl };\r\n","import { MetadataUtil } from '../core/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { FormControlConfig, FormControl } from './form_control';\r\nimport { FormControlMetadata, FORM_CONTROL_PROP_META } from './decorators';\r\nimport { Subject } from 'rxjs';\r\nimport { ValidatorFactory } from '../validator'\r\n\r\n/**\r\n * Form抽象类\r\n */\r\nabstract class Form {\r\n\r\n  /**\r\n   * 表单控件配置\r\n   */\r\n  private formControlConfigs: FormControlConfig[];\r\n\r\n  /**\r\n   * ViewModel上下文\r\n   */\r\n  private viewModelContext: ViewModelContext;\r\n\r\n  private validateformControls: string[];\r\n\r\n  private validateformControlPathMap: Map<string, string>;\r\n\r\n  public changes: Subject<any>;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(viewModelContext: ViewModelContext) {\r\n    this.viewModelContext = viewModelContext;\r\n    this.formControlConfigs = [];\r\n    this.validateformControls = [];\r\n    this.validateformControlPathMap = new Map;\r\n    this.changes = new Subject();\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  public init() {\r\n    this.collectMetadatas();\r\n    this.createFormControls();\r\n  }\r\n\r\n  /**\r\n   * 全部校验 \r\n   *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回\r\n   */\r\n  validateFields() {\r\n    let validationResult = [];\r\n    if (this.validateformControls.length === 0) { return validationResult; }\r\n    this.validateformControls.forEach((formControl) => {\r\n      this[formControl]['validationResult'] = ValidatorFactory.executeValidator(this[formControl]['validatorFn'], this[formControl]['value']);\r\n      !this[formControl]['validationResult'].passing && validationResult.push(this[formControl])\r\n    });\r\n    this.changes.next({ type: 'validateFieldsFinished' })\r\n    return validationResult;\r\n  }\r\n\r\n  /**\r\n   * 获取某一个得校验错误信息\r\n   * @param name 属性名称\r\n   */\r\n  getFieldError(name: string) {\r\n    if (this.validateformControls.length === 0) {\r\n      return {}\r\n    }\r\n    const index = this.validateformControls.findIndex((item) => {\r\n      return item === name\r\n    });\r\n    if (index === -1) {\r\n      return {}\r\n    } else {\r\n      const result = ValidatorFactory.executeValidator(this[name]['validatorFn'], this[name]['value']);\r\n      this[name]['validationResult'] = result;\r\n      this.changes.next({ type: 'validateFieldsFinished', value: name });\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n * 根据form元数据中的path获取某一个得校验错误信息\r\n * @param path 属性名称数组\r\n */\r\n  getFieldErrorByPath(path: string[]) {\r\n    if (this.validateformControls.length === 0) {\r\n      return {}\r\n    }\r\n    let pathName = path[0]\r\n    if (path && path.length >= 2) {\r\n      pathName = path.join('.');\r\n    }\r\n    const index = this.validateformControlPathMap.has(pathName);\r\n    if (!index) {\r\n      return {}\r\n    } else {\r\n      const result = ValidatorFactory.executeValidator(this[this.validateformControlPathMap.get(pathName)]['validatorFn'], this[this.validateformControlPathMap.get(pathName)]['value']);\r\n      this[this.validateformControlPathMap.get(pathName)]['validationResult'] = result;\r\n      this.changes.next({ type: 'validateFieldsFinished', value: this.validateformControlPathMap.get(pathName) });\r\n      return result;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 清除一组字段验证状态\r\n   * @param fields 字段的数组\r\n   */\r\n  resetFieldsValidate(fields?: string[]) {\r\n    if (this.validateformControls.length === 0) {\r\n      return true;\r\n    } else {\r\n      if (fields && fields.length > 0) {\r\n        const sa = new Set(this.validateformControls);\r\n        const sb = new Set(fields);\r\n        // 交集\r\n        const intersect = this.validateformControls.filter(x => sb.has(x));\r\n        // 遍历清空所有校验结果数据\r\n        intersect.forEach(item => {\r\n          this[item]['validationResult'] = {};\r\n        })\r\n      } else {\r\n        // 没传数据全部清除\r\n        this.validateformControls.forEach(item => {\r\n          this[item]['validationResult'] = {};\r\n        })\r\n      }\r\n      this.changes.next({ type: 'validateFieldsFinished' })\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * 创建FormControls\r\n   */\r\n  private createFormControls() {\r\n    this.formControlConfigs.forEach((formControlConfig: FormControlConfig) => {\r\n      const name = formControlConfig.name;\r\n      const formControl = new FormControl(formControlConfig, this.viewModelContext);\r\n      this[name] = formControl;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 收集元数据\r\n   */\r\n  private collectMetadatas() {\r\n    const formControlMetadatas = MetadataUtil.getPropsMetadatasByName(this.constructor, FORM_CONTROL_PROP_META);\r\n    Object.keys(formControlMetadatas).forEach((name: string) => {\r\n      const formControlMetadata = formControlMetadatas[name] as FormControlMetadata;\r\n      if (formControlMetadata.validRules) {\r\n        this.validateformControls.push(name);\r\n        this.validateformControlPathMap.set(formControlMetadata.bindingPath, name);\r\n      }\r\n      const formControlConfig: FormControlConfig = {\r\n        name: name,\r\n        bindingType: formControlMetadata.bindingType,\r\n        bindingPath: formControlMetadata.bindingPath,\r\n        valueConverter: formControlMetadata.valueConverter,\r\n        valueChanging: formControlMetadata.valueChanging,\r\n        valueChanged: formControlMetadata.valueChanged,\r\n        validRules: formControlMetadata.validRules\r\n      };\r\n      this.formControlConfigs.push(formControlConfig);\r\n    });\r\n  }\r\n\r\n  public getEntityValueChangingListeners(): { [property: string]: string } {\r\n    const listeners = {};\r\n    this.formControlConfigs.forEach((formControl: FormControlConfig) => {\r\n      if (formControl.valueChanging) {\r\n        listeners[formControl.bindingPath] = formControl.valueChanging;\r\n      }\r\n    });\r\n    return listeners;\r\n  }\r\n\r\n  public getEntityValueChangedListeners(): { [property: string]: string } {\r\n    const listeners = {};\r\n    this.formControlConfigs.forEach((formControl: FormControlConfig) => {\r\n      if (formControl.valueChanged) {\r\n        listeners[formControl.bindingPath] = formControl.valueChanged;\r\n      }\r\n    });\r\n    return listeners;\r\n  }\r\n}\r\n\r\nexport { Form };\r\n","import { makePropDecorator } from '../core/index';\r\nimport { CommandParams, ParamDescriptions,  } from '../command/index';\r\n\r\n/**\r\n * 快捷键\r\n */\r\nexport interface Keybinding {\r\n  readonly ctrlKey: boolean;\r\n  readonly shiftKey: boolean;\r\n  readonly altKey: boolean;\r\n  readonly metaKey?: boolean;\r\n  readonly key: string;\r\n}\r\n\r\n/**\r\n * 命令描述\r\n */\r\nexport interface CommandMethodMetadata {\r\n\r\n  /**\r\n   * 命令名称\r\n   */\r\n  name: string;\r\n\r\n  /**\r\n   * 命令参数\r\n   */\r\n  params?: CommandParams;\r\n\r\n  /**\r\n   * 框架id\r\n   * 通过frameId确定命令执行的上下文，不指定则默认为当前Frame。\r\n   */\r\n  frameId?: string;\r\n\r\n  /**\r\n   * 参数描述，目前描述类型，后续可兼容精度等其他信息。\r\n   */\r\n  paramDescriptions?: ParamDescriptions;\r\n\r\n  /**\r\n   * 快捷键绑定\r\n   */\r\n  keyBinding?: Keybinding;\r\n}\r\n\r\n\r\n/**\r\n * 命令装饰器名称\r\n */\r\nexport const COMMAND_METHOD_META = 'CommandMethodMeta';\r\n\r\n/**\r\n * 命令装饰接口\r\n */\r\nexport interface CommandMethodMetaDecorator {\r\n  (ngCommand?: CommandMethodMetadata): any;\r\n  new(ngCommand?: CommandMethodMetadata): any;\r\n}\r\n\r\n/**\r\n * 命令装饰器工厂\r\n */\r\nexport const CommandMethodMeta: CommandMethodMetaDecorator =\r\n  makePropDecorator(COMMAND_METHOD_META, (obj: CommandMethodMetadata) => obj);\r\n","import { MetadataUtil } from '../core/index';\r\nimport { Injector } from '../core/index';\r\nimport { Entity } from '../entity/index';\r\nimport { Repository } from '../repository/index';\r\nimport { Command, CommandBus } from '../command/index';\r\nimport { BindingData, EntityValueChange, InvokeOnValueChange } from '../binding-data/index';\r\nimport { UIState } from '../ui-state/index';\r\nimport { StateMachine } from '../state-machine/index';\r\nimport { Form } from '../form/index';\r\nimport { ViewModelContext } from './view_model_context';\r\n\r\nimport { COMMAND_METHOD_META, CommandMethodMetadata, Keybinding } from './decorators';\r\nimport { EMPTY, from, Observable, of } from 'rxjs';\r\nimport { concatMap, every, tap } from 'rxjs/operators';\r\n\r\nabstract class ViewModel {\r\n\r\n  /**\r\n   * 命令元数据集合\r\n   */\r\n  public ngCommands: { [propName: string]: CommandMethodMetadata };\r\n\r\n  /**\r\n   * 名称\r\n   */\r\n  public id: string;\r\n\r\n  /**\r\n   * 注入器\r\n   */\r\n  public injector: Injector;\r\n\r\n  /**\r\n   * 视图模型上下文\r\n   */\r\n  public context: ViewModelContext;\r\n\r\n  /**\r\n   * 数据仓库\r\n   */\r\n  public repository: Repository<Entity>;\r\n\r\n  /**\r\n   * 绑定路径\r\n   */\r\n  public bindingPath: string;\r\n\r\n  /**\r\n   * 数据状态\r\n   */\r\n  public bindingData: BindingData;\r\n\r\n  /**\r\n   * UI状态\r\n   */\r\n  public uiState: UIState;\r\n\r\n  /**\r\n   * 状态机\r\n   */\r\n  public stateMachine: StateMachine;\r\n\r\n  /**\r\n   * 表单\r\n   */\r\n  public form: Form;\r\n\r\n  /**\r\n   * 命令总线\r\n   */\r\n  public commandBus: CommandBus;\r\n\r\n  /**\r\n   * 快捷键映射\r\n   */\r\n  public keybindingMap: Map<string, Keybinding>;\r\n\r\n  /**\r\n   * 值变化前监听器\r\n   */\r\n  private entityValueChangingListeners: Map<string, string>;\r\n\r\n  /**\r\n   * 值变化后监听器\r\n   */\r\n  private entityValueChangedListeners: Map<string, string>;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  public constructor(injector: Injector, id: string) {\r\n    this.injector = injector;\r\n    this.id = id;\r\n  }\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  public init() {\r\n    this.initRepository();\r\n    this.initContext();\r\n    this.initBindingData();\r\n    this.initUIState();\r\n    this.intiStateMachine();\r\n    this.initForm();\r\n    this.initCommandBus();\r\n    this.registerWithParent();\r\n    this.initListeners();\r\n    this.closeOldBeSession();\r\n  }\r\n\r\n  private initRepository() {\r\n    this.repository = this.injector.get(Repository);\r\n  }\r\n\r\n  private initContext() {\r\n    this.context = this.injector.get<ViewModelContext>(ViewModelContext);\r\n    this.context.init(this);\r\n  }\r\n\r\n  private initBindingData() {\r\n    this.bindingData = this.context.injector.get(BindingData);\r\n    this.entityValueChangingListeners = new Map<string, string>();\r\n    this.entityValueChangedListeners = new Map<string, string>();\r\n    if (this.bindingData) {\r\n      this.bindingData.setValueChangeInvokerFactory((paths: string[]): InvokeOnValueChange => {\r\n        return (preValue, value, entityChanged: boolean, primaryValue?: any): Observable<boolean> => {\r\n          const plainPath = '/' + paths.join('/');\r\n          let command: string;\r\n          if (entityChanged === false) {\r\n            command = this.entityValueChangingListeners[plainPath];\r\n          } else {\r\n            command = this.entityValueChangedListeners[plainPath];\r\n          }\r\n\r\n          if (!!command) {\r\n            const change: EntityValueChange = {\r\n              paths: paths,\r\n              preValue: preValue,\r\n              value: value,\r\n              changed: entityChanged\r\n            };\r\n            const commands = command.split(';').filter(p => p);\r\n            let valueChangeSuccess = true;\r\n            return from(commands).pipe(\r\n              concatMap(item => {\r\n                if (!valueChangeSuccess) {\r\n                  return EMPTY;\r\n                }\r\n                return this[item](change).pipe(\r\n                  tap((result: any) => {\r\n                    valueChangeSuccess = result;\r\n                  })\r\n                );\r\n              }),\r\n              every((result: any) => result)\r\n            );\r\n          } else {\r\n            return of(true);\r\n          }\r\n        };\r\n\r\n      });\r\n    }\r\n\r\n    const repositoryName = this.repository.name;\r\n    const bindingDataManager = this.context.appContext.bindingDataManager;\r\n    const repositoryBindingData = bindingDataManager.getBindingDataByName(repositoryName);\r\n    this.bindingData.initByBindingList(repositoryBindingData.list, this.context);\r\n  }\r\n\r\n  private initUIState() {\r\n    this.uiState = this.injector.get(UIState);\r\n  }\r\n\r\n  private intiStateMachine() {\r\n    this.stateMachine = this.injector.get(StateMachine, null);\r\n    if (!this.stateMachine) {\r\n      return;\r\n    }\r\n    this.stateMachine.init(this.context);\r\n  }\r\n\r\n  private initForm() {\r\n    this.form = this.injector.get(Form, null);\r\n    this.form.init();\r\n  }\r\n\r\n  private initCommandBus() {\r\n    this.commandBus = this.injector.get(CommandBus);\r\n    this.extendCommandMethods();\r\n  }\r\n\r\n  private extendCommandMethods() {\r\n    this.ngCommands = MetadataUtil.getPropsMetadatasByName(this.constructor, COMMAND_METHOD_META);\r\n    this.keybindingMap = new Map<string, Keybinding>();\r\n\r\n    Object.keys(this.ngCommands).forEach((propName: string) => {\r\n      const ngCommand: CommandMethodMetadata = this.ngCommands[propName];\r\n\r\n      Object.defineProperty(this, propName, {\r\n        value: (eventParams: any) => {\r\n          const command: Command = {\r\n            name: ngCommand.name,\r\n            params: ngCommand.params,\r\n            paramDescriptions: ngCommand.paramDescriptions,\r\n            eventParam: eventParams || null\r\n          };\r\n          return this.commandBus.dispatch(command);\r\n        }\r\n      });\r\n\r\n      if (ngCommand.keyBinding) {\r\n        this.keybindingMap.set(propName, ngCommand.keyBinding);\r\n      }\r\n    });\r\n  }\r\n\r\n  private registerWithParent() {\r\n    const parentContext = this.context.parent;\r\n    if (!parentContext || !parentContext.viewModel || !parentContext.viewModel['childViewModels']) {\r\n      return;\r\n    }\r\n\r\n    const parentViewModel = parentContext.viewModel;\r\n    const className = this.constructor.name;\r\n    const propName = parentViewModel['childViewModels'][className];\r\n    parentViewModel[propName] = this;\r\n  }\r\n\r\n  /**\r\n   * 关闭老的BeSession\r\n   */\r\n  private closeOldBeSession() {\r\n    const allViewModelContexts = this.context.appContext.viewModelContextManager.getContexts();\r\n    if (allViewModelContexts.length === 1 && allViewModelContexts[0] === this.context) {\r\n      this.context.repository.reset();\r\n    }\r\n  }\r\n\r\n  /**\r\n * 从Form获取监听器\r\n */\r\n  private initListeners() {\r\n    const extractPath = (bindingBasePath: string, bindingPath: string): string => {\r\n      return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter((item) => item.length > 0).join('/');\r\n    };\r\n\r\n    if (this.form) {\r\n      const valueChangingListeners = this.form.getEntityValueChangingListeners();\r\n      Object.keys(valueChangingListeners).forEach((bindingPath) => {\r\n        const plainPath = extractPath(this.bindingPath, bindingPath);\r\n        this.entityValueChangingListeners[plainPath] = valueChangingListeners[bindingPath];\r\n      });\r\n\r\n      const valueChangedListeners = this.form.getEntityValueChangedListeners();\r\n      Object.keys(valueChangedListeners).forEach((bindingPath) => {\r\n        const plainPath = extractPath(this.bindingPath, bindingPath);\r\n        this.entityValueChangedListeners[plainPath] = valueChangedListeners[bindingPath];\r\n      });\r\n    }\r\n  }\r\n\r\n}\r\n\r\nexport { ViewModel };\r\n","import { StaticProvider } from '../core/index';\r\nimport { ViewModel } from './view_model';\r\n\r\nclass ViewModelOptions {\r\n\r\n  id: string;\r\n\r\n  /**\r\n   * 应用providers\r\n   */\r\n  providers: StaticProvider[];\r\n\r\n  /**\r\n   * 父ViewModel\r\n   */\r\n  parent?: ViewModel;\r\n\r\n}\r\n\r\nexport { ViewModelOptions };\r\n","import { Subject, Subscription } from 'rxjs';\r\n\r\nclass AppEventBus {\r\n  /**\r\n* eventBus\r\n*/\r\n  private eventBus: Subject<any>;\r\n\r\n  private subscriptionsMap: Map<string, Subscription>;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n    this.eventBus = new Subject();\r\n    this.subscriptionsMap = new Map<string, Subscription>();\r\n  }\r\n\r\n  triggerEvent(event: any) {\r\n    this.eventBus.next(event);\r\n  }\r\n\r\n  subscribe(componentId: string, func: Function, funcError?: Function) {\r\n    if (this.subscriptionsMap.has(componentId) === false) {\r\n      const subscription = this.eventBus.subscribe(\r\n        (value) => func(value),\r\n        (value) => funcError(value)\r\n      )\r\n      this.subscriptionsMap.set(componentId, subscription);\r\n    }\r\n  }\r\n  \r\n  unsubscribe(componentId: string) {\r\n    if (this.subscriptionsMap.has(componentId) === true) {\r\n      this.subscriptionsMap.get(componentId).unsubscribe();\r\n      this.subscriptionsMap.delete(componentId);\r\n    }\r\n  }\r\n}\r\n\r\nexport { AppEventBus };","import { StaticProvider, Injector } from '../core/index';\r\nimport { BindingDataManager } from './binding_data_manager';\r\nimport { RepositoryManager } from './repository_mananger';\r\nimport { ViewModelContextManager } from './view_model_contex_manager';\r\nimport { AppContext } from './app_context';\r\nimport { AppEventBus } from './app_eventBus';\r\n\r\nconst APP_BASE_PROVIDERS: StaticProvider[] = [\r\n  { provide: AppEventBus, useClass: AppEventBus, deps: [] },\r\n  { provide: BindingDataManager, useClass: BindingDataManager, deps: [] },\r\n  { provide: RepositoryManager, useClass: RepositoryManager, deps: [] },\r\n  { provide: ViewModelContextManager, useClass: ViewModelContextManager, deps: [] },\r\n  {\r\n    provide: AppContext, useClass: AppContext,\r\n    deps: [Injector, AppEventBus, RepositoryManager, BindingDataManager, ViewModelContextManager]\r\n  }\r\n];\r\n\r\nexport { APP_BASE_PROVIDERS };\r\n","import { StaticProvider, Injector, createInjector} from '../core/index';\r\nimport { AppContext } from './app_context';\r\nimport { ViewModelContext, ViewModel, ViewModelOptions } from '../view-model/index';\r\n\r\nimport { APP_BASE_PROVIDERS } from './providers';\r\nimport { APP_VARIABLE_PROVIDERS } from '../variable/index';\r\nimport { VIEW_MODEL_COMMAND_PROVIDERS } from '../command/index';\r\nimport { HTTP_PROVIDERS } from '../http/index';\r\n\r\n\r\nclass App {\r\n\r\n  public context: AppContext;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(options: any) {\r\n\r\n    options.providers = options.providers || [];\r\n    const appProviders = [\r\n      ...APP_BASE_PROVIDERS,\r\n      ...APP_VARIABLE_PROVIDERS,\r\n      ...HTTP_PROVIDERS,\r\n      ...options.providers\r\n    ];\r\n    const appInjector = createInjector(appProviders);\r\n    this.context = appInjector.get(AppContext);\r\n  }\r\n\r\n  /**\r\n   * 启用ViewModel\r\n   */\r\n  createViewModel(options: ViewModelOptions): ViewModel {\r\n\r\n    const providers = options.providers || [];\r\n    const parent = options.parent || null;\r\n\r\n    const mergedProviders: StaticProvider[] = [\r\n      { provide: ViewModelContext, useClass: ViewModelContext, deps: [] },\r\n      ...VIEW_MODEL_COMMAND_PROVIDERS,\r\n      ...providers\r\n    ];\r\n\r\n    const parentInjector = parent ? parent.injector : this.context.injector;\r\n    const injector = createInjector(mergedProviders, parentInjector);\r\n    const viewModel = injector.get<ViewModel>(ViewModel);\r\n    viewModel.init();\r\n    return viewModel;\r\n  }\r\n\r\n}\r\n\r\nexport { App };\r\n","/*\r\n * StateMachine变量解析\r\n * @Author: Witt\r\n * @Date: 2018-12-04 17:09:42\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2019-10-30 11:07:10\r\n */\r\n\r\nimport { AppContext } from '../app/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { CommandContext } from '../command/index';\r\n\r\n/**\r\n * 解析辅助工具类\r\n */\r\nclass ParseUtil {\r\n\r\n  /**\r\n   * 获取应用上下文\r\n   */\r\n  static getAppContext(context: any): AppContext {\r\n    if (context instanceof CommandContext) {\r\n      return context.viewModelContext.appContext;\r\n    } else if (context instanceof ViewModelContext) {\r\n      return context.appContext;\r\n    } else  if (context instanceof AppContext) {\r\n      return context;\r\n    } else {\r\n      throw new Error('上下文中找不到AppContext，请检查！');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取当前Frame的Context\r\n   */\r\n  static getFrameContext(context: any): ViewModelContext {\r\n    if (context instanceof CommandContext) {\r\n      return context.viewModelContext;\r\n    } else if (context instanceof ViewModelContext) {\r\n      return context;\r\n    } else {\r\n      throw new Error('上下文中找不到FrameContext，请检查！');\r\n    }\r\n\r\n  }\r\n\r\n  /**\r\n   * 获取根Frame的Context\r\n   */\r\n  static getRootFrameContext(context: any): ViewModelContext {\r\n    const frameContext = this.getFrameContext(context);\r\n    return frameContext.root;\r\n  }\r\n\r\n  /**\r\n   * 根据frameId获取FrameContext\r\n   */\r\n  static getFrameContextById(context: any, frameId: string): ViewModelContext {\r\n    const appContext = this.getAppContext(context);\r\n    return appContext.viewModelContextManager.getContextById(frameId);\r\n  }\r\n}\r\n\r\nexport { ParseUtil };\r\n","/**\r\n * 数据源变量解析\r\n * @author Witt <jiwt@inspur.com>\r\n */\r\nimport { AppContext } from '../app/index';\r\nimport { VariableParser } from './variable_parser';\r\nimport { ParseUtil } from './parse_util';\r\n\r\n/**\r\n * 数据变量解析\r\n */\r\nclass DataVariableParser implements VariableParser {\r\n\r\n  /**\r\n   * 解析变量\r\n   * @param expression 表达式\r\n   * @param context 上下文\r\n   */\r\n  parse(expression: string, context: any): any {\r\n    const appContext = ParseUtil.getAppContext(context);\r\n    const paths: string[] = this.extractPaths(expression);\r\n\r\n    // 1、单个的表达式：直接求值\r\n    if (paths.length === 1 && expression === `{DATA~${paths[0]}}`) {\r\n      return this.getValue(paths[0], appContext);\r\n    }\r\n\r\n    // 2、其他情况：字符串替换\r\n    paths.forEach( (path: string) => {\r\n      const searchValue = `{DATA~${path}}`;\r\n      const replaceValue = this.getValue(path, appContext);\r\n      expression = expression.replace(searchValue, replaceValue);\r\n    });\r\n\r\n    return  expression;\r\n  }\r\n\r\n  /**\r\n   * 提取路径\r\n   */\r\n  private extractPaths(expression: string) {\r\n    const paths: string[]  = [];\r\n\r\n    // 查找所有的uiState变量字符串\r\n    const DATA_PATTERN_G = /\\{DATA~(\\S+?)\\}/g;\r\n    const dataVariables = expression.match(DATA_PATTERN_G);\r\n    if (dataVariables === null) {\r\n      return [];\r\n    }\r\n\r\n    // 提取后边的路径\r\n    const DATA_PATTERN = /\\{DATA~(\\S+?)\\}/;\r\n    dataVariables.forEach( dataVariable =>  {\r\n      const pathMatches = dataVariable.match(DATA_PATTERN);\r\n      if (pathMatches != null && pathMatches.length === 2) {\r\n        paths.push(pathMatches[1]);\r\n      }\r\n    });\r\n    return paths;\r\n  }\r\n\r\n  /**\r\n   * 获取值\r\n   * @param path 路径：/\r\n   */\r\n  private getValue(path: string, appContext: AppContext): any {\r\n    const parts = path.split('/').filter((part: string) => {\r\n      return part !== '';\r\n    });\r\n\r\n    const frameContext = appContext.viewModelContextManager.getContextById(parts[0]);\r\n    if (!frameContext) {\r\n      throw new Error(`${path}不正确，请检查！`);\r\n    }\r\n\r\n    const bindingData  = frameContext.bindingData;\r\n    if (!bindingData) {\r\n      throw new Error(`${path}不正确，请检查！`);\r\n    }\r\n    return bindingData.getValue(parts.slice(1));\r\n  }\r\n\r\n\r\n}\r\n\r\nexport { DataVariableParser };\r\n","/**\r\n * session变量解析\r\n * @author Witt <jiwt@inspur.com>\r\n */\r\n\r\nimport { VariableParser } from './variable_parser';\r\nimport { AppContext } from '../app/index';\r\nimport { ParseUtil } from './parse_util';\r\n\r\n/**\r\n * 数据变量解析\r\n */\r\nclass UIStateVariableParser implements VariableParser {\r\n\r\n  /**\r\n   * 解析变量\r\n   * @param expression 形如：/frameId/stateName\r\n   * @param context 上下文\r\n   */\r\n  public parse(expression: string, context: any): any {\r\n\r\n    const appContext = ParseUtil.getAppContext(context);\r\n    const paths = this.extractPaths(expression);\r\n\r\n    // 1、单个的表达式：直接求值\r\n    if (paths.length === 1 && expression === `{UISTATE~${paths[0]}}`) {\r\n      return this.getUIState(paths[0], appContext);\r\n    }\r\n\r\n    // 2、其他情况：字符串替换\r\n    paths.forEach(path => {\r\n      const searchValue = `{UISTATE~${path}}`;\r\n      const replaceValue = this.getUIState(path, appContext);\r\n      expression = expression.replace(searchValue, replaceValue);\r\n    });\r\n\r\n    return expression;\r\n  }\r\n\r\n  /**\r\n   * 提取路径\r\n   * 变量格式：{}\r\n   */\r\n  private extractPaths(expression: string): string[] {\r\n    const paths: string[] = [];\r\n\r\n    // 查找所有的uiState变量字符串\r\n    const UI_STATE_PATTERN_G = /\\{UISTATE~(\\S+?)\\}/g;\r\n    const uiStateVariables = expression.match(UI_STATE_PATTERN_G);\r\n    if (uiStateVariables === null) {\r\n      return [];\r\n    }\r\n\r\n    // 提取后边的路径\r\n    const UI_STATE_PATTERN = /\\{UISTATE~(\\S+?)\\}/;\r\n    uiStateVariables.forEach((uiStateVariable: string) => {\r\n      const pathMatches = uiStateVariable.match(UI_STATE_PATTERN);\r\n      if (pathMatches != null && pathMatches.length === 2) {\r\n        paths.push(pathMatches[1]);\r\n      }\r\n    });\r\n\r\n    return paths;\r\n  }\r\n\r\n  /**\r\n   * 获取UIState\r\n   */\r\n  private getUIState(path: string, appContext: AppContext) {\r\n    const parts = path.split('/').filter((part: string) => {\r\n      return part !== '';\r\n    });\r\n    const [frameId, stateName] = parts;\r\n    const frameContext = appContext.viewModelContextManager.getContextById(frameId);\r\n    let state = frameContext.uiState[stateName];\r\n    if (state && state.constructor.toString().startsWith('function Date()')) {\r\n      return this.formatDate(state);\r\n    }\r\n    for (let i = 2; i < parts.length; i++) {\r\n      state = state[parts[i]];\r\n\r\n      // 复杂对象一层层查找下去，如果某一层不存在，结果可以是undefined，但是要直接返回undefined避免报错。\r\n      if (!state) {\r\n        return state;\r\n      }\r\n    }\r\n    return state;\r\n  }\r\n\r\n  /**\r\n   * @todo：待删除\r\n   */\r\n  private formatDate(value: Date): string {\r\n    if (!value) {\r\n      return '';\r\n    }\r\n\r\n    // 年\r\n    const year = value.getFullYear();\r\n\r\n    // 月\r\n    let month = (value.getMonth() + 1).toString();\r\n    month = month.length === 1 ? ('0' + month) : month;\r\n\r\n    // 日\r\n    let day = value.getDate().toString();\r\n    day = day.length === 1 ? ('0' + day) : day;\r\n    return `${year}-${month}-${day}`;\r\n  }\r\n}\r\n\r\nexport { UIStateVariableParser };\r\n","/*\r\n * StateMachine变量解析\r\n * @Author: Witt\r\n * @Date: 2018-12-04 17:09:42\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2019-10-30 11:07:10\r\n */\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { StateMachine } from '../state-machine/index';\r\nimport { VariableParser } from './variable_parser';\r\nimport { ParseUtil } from './parse_util';\r\n\r\n/**\r\n * 状态机变量解析\r\n * @summary\r\n *\r\n * 解析策略：\r\n * 1、不带frameId，从顶层StateMachine中解析\r\n * {STATEMACHINE~/states/key}\r\n * {STATEMACHINE~/renderStates/key}\r\n *\r\n * 2、带frameId，从frameId对应的FrameContext的StateMachine中解析\r\n * {STATEMACHINE~/frameId/states/key}\r\n * {STATEMACHINE~/frameId/renderStates/key}\r\n *\r\n * 存在的问题：\r\n * 1、不带frameId从顶层StateMachine解析仅为了兼容，将来改为从当前FrameContext的StateMachine中解析；\r\n * 2、组合表单中顶层StateMachine是主表单的rootFrameContext的StateMachine，显然不合理（既成事实）；\r\n * 3、farmeId如果是states或renderStates，导致解析失败，几率很小，但又风险。\r\n */\r\nclass StateMachineVariableParser implements VariableParser {\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  public constructor() {\r\n  }\r\n\r\n  /**\r\n   * 解析变量\r\n   * @param expression 变量：格式形如：/frameId/componentId/stateName\r\n   * @param context 上下文\r\n   */\r\n  public parse(expression: string, context: any): any {\r\n    const paths = this.extractPaths(expression);\r\n\r\n    // 1、单个的表达式：直接求值\r\n    if (paths.length === 1 && expression === `{STATEMACHINE~${paths[0]}}`) {\r\n      return this.getValue(paths[0], context);\r\n    }\r\n\r\n    // 2、其他情况：字符串替换\r\n    paths.forEach( path => {\r\n      const searchValue = `{STATEMACHINE~${path}}`;\r\n      const replaceValue = this.getValue(path, context);\r\n      expression = expression.replace(searchValue, replaceValue);\r\n    });\r\n\r\n    return  expression;\r\n  }\r\n\r\n  /**\r\n   * 提取Session变量名\r\n   * 变量格式：{}\r\n   */\r\n  private extractPaths(expression: string): string[] {\r\n    const paths: string[]  = [];\r\n\r\n    // 查找所有的StateMachine变量字符串\r\n    const STATE_MACHINE_PATTERN_G = /\\{STATEMACHINE~(\\S+?)\\}/g;\r\n    const stateMachineVariables = expression.match(STATE_MACHINE_PATTERN_G);\r\n    if (stateMachineVariables === null) {\r\n      return [];\r\n    }\r\n\r\n    // 提取后边的路径\r\n    const STATE_MACHINE_PATTERN = /\\{STATEMACHINE~(\\S+?)\\}/;\r\n    stateMachineVariables.forEach( sessionVariable =>  {\r\n      const pathMatches = sessionVariable.match(STATE_MACHINE_PATTERN);\r\n      if (pathMatches != null && pathMatches.length === 2) {\r\n        paths.push(pathMatches[1]);\r\n      }\r\n    });\r\n\r\n    return paths;\r\n  }\r\n\r\n  /**\r\n   * 获取对应的值\r\n   */\r\n  private getValue(path: string, context: any): any {\r\n\r\n    const pathObj = this.getPathObj(path);\r\n    const stateMachine = this.getTargetStateMachine(pathObj.frameId, context);\r\n\r\n    if (pathObj.type === 'currentState') {\r\n      return stateMachine.context.state;\r\n    } else if (pathObj.type === 'renderStates') {\r\n      return stateMachine[pathObj.name] as boolean;\r\n    } else {\r\n      throw new Error(`不支类型为${pathObj.type}的状态机变量`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 解析path，并获取对应的StateMachine实例\r\n   */\r\n  private getTargetStateMachine(frameId: string, context): StateMachine {\r\n    let targetFrameContext: ViewModelContext;\r\n    if (frameId) {\r\n      targetFrameContext = ParseUtil.getFrameContextById(context, frameId);\r\n    } else {\r\n      targetFrameContext = ParseUtil.getRootFrameContext(context);\r\n    }\r\n\r\n    if (!targetFrameContext || !targetFrameContext.stateMachine) {\r\n      throw new Error('找不到对应的状态机实例，请检查！');\r\n    }\r\n    return targetFrameContext.stateMachine;\r\n  }\r\n\r\n  /**\r\n   * 将Path解析为格式化的Path对象\r\n   */\r\n  private getPathObj(path: string): any {\r\n    let parsedPathObj: any;\r\n    const parts = this.splitPath(path);\r\n\r\n    if (parts[0] === 'currentState' || parts[0] === 'renderStates') {\r\n      parsedPathObj = {\r\n        frameId: '',\r\n        type: parts[0],\r\n        name: parts[1]\r\n      };\r\n    } else {\r\n      parsedPathObj = {\r\n        frameId: parts[0],\r\n        type: parts[1],\r\n        name: parts[2]\r\n      };\r\n    }\r\n\r\n    return parsedPathObj;\r\n  }\r\n\r\n  /**\r\n   * 分隔Path\r\n   */\r\n  private splitPath(path: string): string[] {\r\n    const parts = path.split('/').filter((part: string) => {\r\n      return part !== '';\r\n    });\r\n    return parts;\r\n  }\r\n\r\n}\r\n\r\nexport { StateMachineVariableParser };\r\n","/**\r\n * session变量解析\r\n * @author Witt <jiwt@inspur.com>\r\n */\r\n\r\nimport { CommandContext } from '../command/index';\r\nimport { VariableParser } from './variable_parser';\r\n\r\n/**\r\n * 命令变量解析\r\n * {COMMAND~/params/key}\r\n * {COMMAND~/results/taskName}\r\n */\r\nclass CommandVariableParser implements VariableParser {\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  public constructor() {\r\n  }\r\n\r\n  /**\r\n   * 解析变量\r\n   * @param expression 变量：格式形如：/frameId/componentId/stateName\r\n   * @param context 上下文\r\n   */\r\n  public parse(expression: string, context: any): any {\r\n    const paths = this.extractPaths(expression);\r\n\r\n    // 1、单个的表达式：直接求值\r\n    if (paths.length === 1 && expression === `{COMMAND~${paths[0]}}`) {\r\n      return this.getValue(paths[0], context);\r\n    }\r\n\r\n    // 2、其他情况：字符串替换\r\n    paths.forEach( path => {\r\n      const searchValue = `{COMMAND~${path}}`;\r\n      const replaceValue = this.getValue(path, context);\r\n      expression = expression.replace(searchValue, replaceValue);\r\n    });\r\n\r\n    return  expression;\r\n  }\r\n\r\n  /**\r\n   * 提取Session变量名\r\n   * 变量格式：{}\r\n   */\r\n  private extractPaths(expression: string): string[] {\r\n    const paths: string[]  = [];\r\n\r\n    // 查找所有的uiState变量字符串\r\n    const UI_STATE_PATTERN_G = /\\{COMMAND~(\\S+?)\\}/g;\r\n    const uiStateVariables = expression.match(UI_STATE_PATTERN_G);\r\n    if (uiStateVariables === null) {\r\n      return [];\r\n    }\r\n\r\n    // 提取后边的路径\r\n    const UI_STATE_PATTERN = /\\{COMMAND~(\\S+?)\\}/;\r\n    uiStateVariables.forEach( sessionVariable =>  {\r\n      const pathMatches = sessionVariable.match(UI_STATE_PATTERN);\r\n      if (pathMatches != null && pathMatches.length === 2) {\r\n        paths.push(pathMatches[1]);\r\n      }\r\n    });\r\n\r\n    return paths;\r\n  }\r\n\r\n  /**\r\n   * 获取UIState\r\n   */\r\n  private getValue(path: string, context: any) {\r\n    if (context instanceof CommandContext === false) {\r\n      throw new Error('当前上下文不支持COMMAND变量，请检查！');\r\n    }\r\n    const parts = path.split('/').filter((part: string) => {\r\n      return part !== '';\r\n    });\r\n\r\n    const [type, name] = parts;\r\n    if (type === 'params') {\r\n      return context.command.params[name];\r\n    } else if (type === 'results') {\r\n      return context.results[name];\r\n    }\r\n  }\r\n}\r\n\r\nexport { CommandVariableParser };\r\n","/**\r\n * 变量解析服务\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\nimport { VariableParser, VARIABLE_PARSERS } from './variable_parser';\r\nimport { Injector  } from '../core/index';\r\n\r\n\r\n/**\r\n * 变量解析服务\r\n * 职责：\r\n * 1、解析字符串中的变量，并替换成相应的值；\r\n * 2、对表达式进行求值。\r\n *\r\n * @todo 对表达式求值的部分和表达式功能重叠，是否转移到表达式中？\r\n */\r\nclass VariableParseService {\r\n\r\n  /**\r\n   * 解析器集合\r\n   */\r\n  private parsers: VariableParser[];\r\n\r\n  /**\r\n   * 构造变量解析服务\r\n   * @param parsers 解析器集合\r\n   */\r\n  constructor(parsers: VariableParser[]) {\r\n    this.parsers = parsers;\r\n  }\r\n\r\n  /**\r\n   * 解析表达式\r\n   * @param expression 表达式\r\n   * @param context 上下文\r\n   */\r\n  public parse(target: any, context?: any): any {\r\n    if (typeof target === 'string' && target.length > 0) {\r\n\r\n      // 字符串，直接解析\r\n      return this.parseExpression(target, context);\r\n\r\n    } else if (Array.isArray(target)) {\r\n\r\n      // 遍历数组\r\n      target.forEach((item, itemIndex) =>  {\r\n        if (typeof item === 'string') {\r\n          target[itemIndex] = this.parseExpression(item, context);\r\n        } else {\r\n          target[itemIndex] = this.parse(item, context);\r\n        }\r\n      });\r\n\r\n    } else if (typeof target === 'object' && target !== null) {\r\n\r\n      // 遍历对象可枚举属性\r\n      const keys = Object.keys(target);\r\n      keys.forEach(key => {\r\n        if (typeof target[key] === 'string') {\r\n          target[key] = this.parseExpression(target[key], context);\r\n        } else {\r\n          target[key] = this.parse(target[key], context);\r\n        }\r\n      });\r\n    }\r\n\r\n    return target;\r\n  }\r\n\r\n  /**\r\n   * 表达式求值\r\n   */\r\n  public evaluate(expression: string, context?: any): any {\r\n    const parsedExpression = this.parse(expression, context);\r\n    return (new Function('return ' + parsedExpression))();\r\n  }\r\n\r\n  /**\r\n   * 解析表达式\r\n   * @param expression 表达式\r\n   * @param context 上下文\r\n   */\r\n  private parseExpression(expression: string, context: any): string {\r\n\r\n    // 空串直接返回\r\n    if (expression === '') {\r\n      return '';\r\n    }\r\n\r\n    this.parsers.forEach(parser => {\r\n      if (typeof expression === 'string') {\r\n        expression = parser.parse(expression, context);\r\n      }\r\n    });\r\n    return expression;\r\n  }\r\n}\r\n\r\nexport { VariableParseService };\r\n","import { StaticProvider } from '../core/index';\r\nimport { VARIABLE_PARSERS } from './variable_parser';\r\nimport { DataVariableParser } from './data_variable_parser';\r\nimport { UIStateVariableParser } from './ui_state_variable_parser';\r\nimport { StateMachineVariableParser } from './state_machine_variable_parser';\r\nimport { CommandVariableParser } from './command_variable_parser';\r\nimport { VariableParseService } from './variable_parse_service';\r\n\r\nconst APP_VARIABLE_PROVIDERS: StaticProvider[] = [\r\n  { provide: VARIABLE_PARSERS,     useClass: DataVariableParser,         multi: true, deps: [] },\r\n  { provide: VARIABLE_PARSERS,     useClass: UIStateVariableParser,      multi: true,  deps: [] },\r\n  { provide: VARIABLE_PARSERS,     useClass: StateMachineVariableParser, multi: true,  deps: [] },\r\n  { provide: VARIABLE_PARSERS,     useClass: CommandVariableParser,      multi: true,  deps: [] },\r\n  { provide: VariableParseService, useClass: VariableParseService,       deps: [VARIABLE_PARSERS] },\r\n];\r\n\r\nexport { APP_VARIABLE_PROVIDERS };\r\n","/* eslint-disable no-case-declarations */\r\nimport { VariableParseService } from '../../variable/index';\r\nimport { CommandContext } from '../command_context';\r\nimport { Injector } from '../../core/index';\r\n\r\n/**\r\n * 任务函数\r\n * @params result 上一步执行结果\r\n * @params context 执行上下文\r\n */\r\ntype LinkFunc = (context: CommandContext) => boolean;\r\n\r\n/**\r\n * 任务链接\r\n */\r\nclass TaskLink {\r\n\r\n  /**\r\n   * 源任务\r\n   */\r\n  from: string;\r\n\r\n  /**\r\n   * 目标任务\r\n   */\r\n  to: string;\r\n\r\n  /**\r\n   * 执行条件\r\n   * 1、表达式；\r\n   * 2、布尔值；\r\n   * 3、函数\r\n   */\r\n  condition: string | boolean| LinkFunc;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor(from: string, to: string, condition: string | boolean| LinkFunc) {\r\n    this.from = from;\r\n    this.to   = to;\r\n    this.condition = condition;\r\n  }\r\n\r\n  /**\r\n   * 是否能够\r\n   */\r\n  public canLink(context: CommandContext): boolean {\r\n    const type = typeof this.condition;\r\n    let canLink;\r\n    switch (type) {\r\n      case 'boolean':\r\n        canLink = this.condition as boolean;\r\n        break;\r\n      case 'function':\r\n        canLink = (this.condition as LinkFunc)(context);\r\n        break;\r\n      case 'string':\r\n        const parseService = context.viewModelContext.injector.get(VariableParseService);\r\n        canLink = parseService.evaluate(this.condition as string, context);\r\n        break;\r\n      default:\r\n        canLink = false;\r\n        break;\r\n    }\r\n    return canLink;\r\n  }\r\n}\r\n\r\nexport { LinkFunc, TaskLink };\r\n","/*\r\n * @Author: Witt\r\n * @Date: 2018-10-17 14:13:40\r\n * @Last Modified by: Witt\r\n * @Last Modified time: 2018-10-17 16:08:34\r\n */\r\n\r\nimport { TaskFunc, TaskNode } from './task_node';\r\nimport { LinkFunc, TaskLink } from './task_link';\r\nimport { CommandContext } from '../command_context';\r\n\r\n/**\r\n * 任务执行流程\r\n */\r\nclass TaskFlow {\r\n\r\n  /**\r\n   * 节点集合\r\n   */\r\n  private nodes: TaskNode[] = [];\r\n\r\n  /**\r\n   * 边集合\r\n   */\r\n  private links: TaskLink[] = [];\r\n\r\n\r\n  // #region 节点操作\r\n\r\n  /**\r\n   * 添加节点\r\n   */\r\n  public addNode(name: string, func: TaskFunc): void {\r\n    const node = new TaskNode(name, func);\r\n    this.nodes.push(node);\r\n  }\r\n\r\n\r\n  /**\r\n   * 批量添加链接\r\n   */\r\n  public addNodes(nodes: TaskNode[]) {\r\n    this.nodes = this.nodes.concat(nodes);\r\n  }\r\n\r\n  /**\r\n   * 在目标节点之前插入一个节点\r\n   * @param target 目标节点名称\r\n   * @param name 名称\r\n   * @param func 函数\r\n   */\r\n  public insertNode(target: string, name: string, func: TaskFunc): void {\r\n    const index = this.findNodeIndex(target);\r\n    const node = this.createNode(name, func);\r\n    this.nodes.splice(index, 0, node);\r\n  }\r\n\r\n  /**\r\n   * 在目标节点之前插入一个节点\r\n   */\r\n  public appendNode(target: string, name: string, func: TaskFunc) {\r\n    const index = this.findNodeIndex(target) + 1;\r\n    const node = this.createNode(name, func);\r\n    this.nodes.splice(index, 0, node);\r\n  }\r\n\r\n  /**\r\n   * 获取节点索引\r\n   * @param name 名称\r\n   */\r\n  private findNodeIndex(name: string): number {\r\n    return this.nodes.findIndex((node: TaskNode) => {\r\n      return node.name === name;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * 创建任务节点\r\n   * @param name 名称\r\n   * @param func 函数\r\n   */\r\n  private createNode(name: string, func: TaskFunc): TaskNode {\r\n    const node = new TaskNode(name, func);\r\n    return node;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 链接操作\r\n\r\n  /**\r\n   * 添加链接\r\n   * @param name 名称\r\n   * @param func 函数\r\n   */\r\n  public addLink(from: string, to: string, condition: string | boolean) {\r\n    const link = this.createLink(from, to, condition);\r\n    this.links.push(link);\r\n  }\r\n\r\n  /**\r\n   * 批量添加链接\r\n   */\r\n  public addLinks(links: TaskLink[]) {\r\n    this.links = this.links.concat(links);\r\n  }\r\n\r\n  /**\r\n   * 创建链接\r\n   */\r\n  private createLink(from: string, to: string, condition: string | boolean) {\r\n    const link = new TaskLink(from, to, condition);\r\n    return link;\r\n  }\r\n\r\n  // #endregion\r\n\r\n\r\n  // #region 流程控制\r\n  /**\r\n   * 获取下一个节点\r\n   * @param from    源节点名称\r\n   * @param context 上下文\r\n   */\r\n  getNext(from?: string, context?: CommandContext): TaskNode {\r\n    if (!from) {\r\n      return this.nodes.shift();\r\n    }\r\n\r\n    // 符合满足条件的边\r\n    const nextLink = this.links.find((link: TaskLink) => {\r\n      return link.from === from && link.canLink(context);\r\n    });\r\n    if (!nextLink) {\r\n      return;\r\n    }\r\n\r\n    return this.nodes.find((node: TaskNode) => {\r\n      return node.name === nextLink.to;\r\n    });\r\n  }\r\n\r\n  // #endregion\r\n\r\n  // #region 其他方法\r\n\r\n  /**\r\n   * 克隆任务流\r\n   */\r\n  clone() {\r\n    const taskFlow = new TaskFlow();\r\n    taskFlow.addNodes(this.nodes);\r\n    taskFlow.addLinks(this.links);\r\n    return taskFlow;\r\n  }\r\n\r\n  // #endregion\r\n}\r\n\r\nexport { TaskFlow };\r\n","import { ViewModelContext } from '../view-model/index';\r\nimport { Command } from './command';\r\n\r\n/**\r\n * Command上下文\r\n */\r\nclass CommandContext {\r\n\r\n  /**\r\n   * 命令实例\r\n   */\r\n  command: Command;\r\n\r\n  /**\r\n   * 组件上下文\r\n   */\r\n  viewModelContext: ViewModelContext;\r\n\r\n  /**\r\n   * 执行结果\r\n   */\r\n  results: {[taskName: string]: any} = {};\r\n\r\n  /**\r\n   * 最新的执行结果\r\n   */\r\n  latestResult: any;\r\n\r\n  /**\r\n   * 事件参数\r\n   */\r\n  eventParams: any;\r\n\r\n  /**\r\n   * 构造函数\r\n   * @param command 命令\r\n   * @param viewModelContext 视图模型上下文\r\n   */\r\n  constructor(command: Command, viewModelContext: ViewModelContext) {\r\n    this.command = command;\r\n    this.viewModelContext = viewModelContext;\r\n  }\r\n\r\n}\r\n\r\nexport { CommandContext };\r\n","import { Observable, Subject, BehaviorSubject } from 'rxjs';\r\nimport { concatMap, map, takeLast, take, timeout, throwIfEmpty } from 'rxjs/operators';\r\n\r\nimport { createInjectionToken, Injector } from '../core/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { VariableParseService } from '../variable/index';\r\n\r\nimport { Command, CommandParams, ParamDescriptions } from './command';\r\nimport { CommandContext } from './command_context';\r\nimport { TaskFunc, TaskFlow } from './flow/index';\r\n\r\n\r\n/**\r\n * 命令处理抽象类，所有具体的命令处理类必须继承它，并实现schedule方法。\r\n */\r\nabstract class CommandHandler {\r\n\r\n  /**\r\n   * 任务流程图\r\n   */\r\n  private taskFlow: TaskFlow;\r\n\r\n  /**\r\n   * 上下文\r\n   */\r\n  protected viewModelContext: ViewModelContext;\r\n\r\n  /**\r\n   * 变量解析服务\r\n   */\r\n  protected parseService: VariableParseService;\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  constructor() {\r\n  }\r\n\r\n  /**\r\n   * 构造执行流程\r\n   */\r\n  abstract schedule();\r\n\r\n  /**\r\n   * 初始化\r\n   */\r\n  public init(viewModelContext: ViewModelContext) {\r\n    this.viewModelContext = viewModelContext;\r\n    this.parseService = viewModelContext.injector.get(VariableParseService);\r\n    this.taskFlow = new TaskFlow();\r\n\r\n    this.schedule();\r\n  }\r\n\r\n  /**\r\n   * 执行任务\r\n   * @param command 要执行的命令\r\n   * @return 最后一个任务的执行结果\r\n   * @todo：按功能拆分小函数\r\n   */\r\n  public execute(command: Command): Observable<any> {\r\n    const lastTaskResult$ = new Subject();\r\n    const taskFlow = this.taskFlow.clone();\r\n\r\n    // setTimeout暂时不能去掉的原因：\r\n    // 1、树表单加载数据，依赖TreeTableBinding里设置的全局变量，需要延后执行加载时机；\r\n    // 2、关闭前命令需要延迟执行。\r\n    setTimeout(() => {\r\n\r\n      // 1、解析参数\r\n      // 避免解析变量时修改了原始的command\r\n      const { eventParam = null } = {\r\n        ...command\r\n      };\r\n      delete command.eventParam;\r\n      const commandToExecute = JSON.parse(JSON.stringify(command));\r\n      commandToExecute.params = this.parseService.parse(commandToExecute.params, this.viewModelContext);\r\n      command.eventParam = eventParam;\r\n      commandToExecute.eventParam = eventParam;\r\n\r\n      // 2、串联任务流\r\n      const initContext = new CommandContext(commandToExecute, this.viewModelContext);\r\n      initContext.eventParams = command.eventParam || null;\r\n      const context$ = new BehaviorSubject<CommandContext>(initContext);\r\n      let currentTask = taskFlow.getNext('', initContext);\r\n      const highOrder$ = context$.pipe(\r\n        concatMap((context: CommandContext) => {\r\n          const result$ = currentTask.execute(context);\r\n          return result$.pipe(\r\n            take(1),\r\n            map((result: any) => {\r\n\r\n              // 写入执行结果\r\n              context.results[currentTask.name] = result;\r\n              context.latestResult = result;\r\n              currentTask = taskFlow.getNext(currentTask.name, context);\r\n\r\n              // 操作控制流\r\n              if (currentTask) {\r\n                context$.next(context);\r\n              } else {\r\n                context$.complete();\r\n              }\r\n\r\n              // 将结果流转换为context流\r\n              return context;\r\n            }),\r\n            throwIfEmpty(() => {\r\n              context$.complete();\r\n            })\r\n          );\r\n        })\r\n      );\r\n\r\n      // 3、执行合并后的任务流\r\n      highOrder$.pipe(\r\n        takeLast(1)\r\n      ).subscribe({\r\n        next: (context: CommandContext) => {\r\n          lastTaskResult$.next(context.latestResult);\r\n        },\r\n        error: (error: any) => {\r\n          this.displayError(error);\r\n          lastTaskResult$.error(error);\r\n        },\r\n        complete: () => {\r\n          lastTaskResult$.complete();\r\n        },\r\n      });\r\n\r\n    }, 0);\r\n\r\n    return lastTaskResult$;\r\n  }\r\n\r\n  /**\r\n   * 显示错误信息\r\n   */\r\n  private displayError(error: any) {\r\n    if (!error) {\r\n      return;\r\n    }\r\n    if (!console || !console.error) {\r\n      return;\r\n    }\r\n    console.error(error);\r\n  }\r\n\r\n  /**\r\n   * 添加任务，只有子类可以添加任务，外部不能访问\r\n   * @param name  任务名称\r\n   * @param func 任务函数\r\n   */\r\n  protected addTask(name: string, func: TaskFunc) {\r\n    this.taskFlow.addNode(name, func);\r\n  }\r\n\r\n  /**\r\n   * 添加任务，只有子类可以添加任务，外部不能访问\r\n   * @param name  任务名称\r\n   * @param func 任务函数\r\n   */\r\n  protected addLink(from: string, to: string, condition: string | boolean) {\r\n    this.taskFlow.addLink(from, to, condition);\r\n  }\r\n\r\n  /**\r\n   * 插入任务\r\n   * @param  name 要扩展的任务名称\r\n   * @param  func 扩展函数\r\n   */\r\n  public insertTask(target: string, name: string, func: TaskFunc) {\r\n    throw new Error('Not Implemented');\r\n  }\r\n\r\n  /**\r\n   * 插入任务\r\n   * @param  name 要扩展的任务名称\r\n   * @param  func 扩展函数\r\n   */\r\n  public afterTask(target: string, name: string, func: TaskFunc) {\r\n    throw new Error('Not Implemented');\r\n  }\r\n\r\n  /**\r\n   * 替换任务\r\n   * @param  name 要替换的任务名称\r\n   * @param  func 替换函数\r\n   */\r\n  public replaceTask(name: string, func: TaskFunc) {\r\n    throw new Error('Not Implement');\r\n  }\r\n\r\n  /**\r\n   * 调用方法\r\n   */\r\n  public invoke(serviceInstance: any, method: string, args: any[], context: CommandContext) {\r\n    this.setContextToServiceInstance(serviceInstance, context);\r\n    const parsedArgs = this.parseService.parse(args, context);\r\n    return serviceInstance[method](...parsedArgs);\r\n  }\r\n\r\n  /**\r\n   * 为服务设置命令上下文\r\n   * @todo\r\n   * 通过这种方式存在很大问题：\r\n   * 1、会覆盖掉已有的context，给开发人员造成困扰和调试成本；\r\n   * 2、服务中依赖了一个没有声明的对象，不符合面向对象的原则。\r\n   * 建议解决方案：\r\n   * 1、将context修改为某个特殊属性名；\r\n   * 2、先检测服务上有没有一个CommandContext类型的context属性，有的话再赋值，\r\n   *    这就要求需要使用context的服务需要是实现一个IContext接口。\r\n   */\r\n  private setContextToServiceInstance(serviceInstance: any, context: CommandContext) {\r\n\r\n    // 如果服务上已经存在context属性，并且该属性不是CommandContext类型，则不能覆盖\r\n    const serviceContext = serviceInstance.context;\r\n    if (serviceContext && (serviceContext instanceof CommandContext === false)) {\r\n      return;\r\n    }\r\n\r\n    serviceInstance.context = context;\r\n  }\r\n}\r\n\r\n/**\r\n * 命令处理器注入Token\r\n */\r\nconst COMMAND_HANDLERS_TOKEN = createInjectionToken('@Farris/devkit COMMAND_HANDLERS_TOKEN');\r\n\r\nexport { CommandHandler, COMMAND_HANDLERS_TOKEN };\r\n","/**\r\n * 命令处理注册器相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\nimport { MetadataUtil, Injector, InjectFlags } from '../core/index';\r\nimport { COMMAND_HANDLER_META, CommandHandlerMetadata } from './decorators';\r\nimport { COMMAND_HANDLERS_TOKEN, CommandHandler } from './command_handler';\r\n\r\n/**\r\n * 命令处理注册器\r\n */\r\nclass CommandHandlerRegistry {\r\n\r\n  /**\r\n   * CommandHandler Map\r\n   */\r\n  private handlerMap: Map<string, CommandHandler>;\r\n\r\n  /**\r\n   * 构造函数\r\n   * @param handlers 命令处理实例数组\r\n   */\r\n  constructor(private injector: Injector) {\r\n    const handlers = this.injector.get(COMMAND_HANDLERS_TOKEN, null, InjectFlags.Optional);\r\n    this.handlerMap = new Map<string, CommandHandler>();\r\n    if (handlers) {\r\n      handlers.forEach((handler: CommandHandler) => {\r\n        this.regist(handler);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 添加命令处理\r\n   * @param  commandName    命令名称\r\n   * @param  commandHandler 命令处理实例\r\n   */\r\n  public set(commandName: string, commandHandler: CommandHandler) {\r\n    if (this.handlerMap.has(commandName)) {\r\n      throw new Error(commandName + '对应的CommandHandler已经存在');\r\n    }\r\n    this.handlerMap.set(commandName, commandHandler);\r\n  }\r\n\r\n  /**\r\n   * 获取命令处理\r\n   * @param   commandName 命令名称\r\n   * @returns 命令处理实例\r\n   */\r\n  public get(commandName: string): CommandHandler {\r\n    if (this.handlerMap.has(commandName) === false) {\r\n      throw new Error('找不到' + commandName + '对应的CommandHandler');\r\n    }\r\n    return this.handlerMap.get(commandName);\r\n  }\r\n\r\n  /**\r\n   * 注册命令处理\r\n   * @param handlers 命令处理实例\r\n   */\r\n  public regist(commandHandler: CommandHandler) {\r\n\r\n    // 根据metadata获取对应的Command名称\r\n    const handlerMetadata: CommandHandlerMetadata =\r\n      MetadataUtil.getClassMetadataByName(commandHandler.constructor, COMMAND_HANDLER_META);\r\n    if (!handlerMetadata) {\r\n      throw new Error('CommandHandler必须指定要处理的命令名称');\r\n    }\r\n    const commandName = handlerMetadata.commandName;\r\n    this.set(commandName, commandHandler);\r\n  }\r\n\r\n}\r\n\r\nexport { CommandHandlerRegistry };\r\n","import { TypeDecorator, makeDecorator, makePropDecorator } from '../core/index';\r\n\r\n/**\r\n * ----------------------------------------\r\n * CommandHandlerMeta\r\n * ----------------------------------------\r\n */\r\n\r\n/**\r\n * 命令处理描述\r\n */\r\nexport interface CommandHandlerMetadata {\r\n\r\n  /**\r\n   * 要处理的名称\r\n   */\r\n  commandName: string;\r\n}\r\n\r\n\r\n/**\r\n * 命令处理装饰器名称\r\n */\r\nexport const COMMAND_HANDLER_META = 'CommandHandlerMeta';\r\n\r\n\r\n/**\r\n * 命令处理装饰器接口\r\n */\r\nexport interface CommandHandlerMetaDecorator {\r\n  (handler?: CommandHandlerMetadata): TypeDecorator;\r\n  new(handler?: CommandHandlerMetadata): CommandHandlerMetadata;\r\n}\r\n\r\n\r\n/**\r\n * 命令处理装饰器工厂\r\n */\r\n\r\nexport function CommandHandlerMeta(options: CommandHandlerMetadata) {\r\n  const decoratorFactory = makeDecorator(COMMAND_HANDLER_META, (handler: CommandHandlerMetadata) => handler);\r\n  return decoratorFactory(options);\r\n}\r\n\r\n\r\n/**\r\n * ----------------------------------------\r\n * CommandExtenderMeta\r\n * ----------------------------------------\r\n */\r\n\r\n/**\r\n * 命令处理扩展描述\r\n */\r\nexport interface CommandHandlerExtenderMetadata {\r\n  commandName: string;\r\n}\r\n\r\n\r\n/**\r\n * 命令处理扩展装饰器名称\r\n */\r\nexport const COMMAND_HANDLER_EXTENDER_META = 'CommandHandlerExtenderMeta';\r\n\r\n\r\n/**\r\n * 命令处理扩展装饰器接口\r\n */\r\nexport interface CommandHandlerExtenderMetaDecorator {\r\n  (extender?: CommandHandlerExtenderMetadata): TypeDecorator;\r\n  new(extender?: CommandHandlerExtenderMetadata): CommandHandlerExtenderMetadata;\r\n}\r\n\r\n/**\r\n * 命令处理扩展装饰器工厂\r\n */\r\nexport function CommandHandlerExtenderMeta(options: CommandHandlerExtenderMetadata) {\r\n  const decoratorFactory = makeDecorator(COMMAND_HANDLER_EXTENDER_META, (extender: CommandHandlerExtenderMetadata) => extender);\r\n  return decoratorFactory(options);\r\n}\r\n","/**\r\n * 命令处理扩展相关\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\nimport { createInjectionToken, Injector } from '../core/index';\r\nimport { CommandHandler } from './command_handler';\r\n\r\n\r\nabstract class CommandHandlerExtender {\r\n\r\n  /**\r\n   * 扩展方法\r\n   * @param handler 要扩展的命令处理器\r\n   */\r\n  abstract extend(handler: CommandHandler): CommandHandler;\r\n\r\n}\r\n\r\n\r\n/**\r\n * 命令处理器扩展注入Token\r\n */\r\nconst COMMAND_HANDLER_EXTENDERS_TOKEN = createInjectionToken('@farris/devkit COMMAND_HANDLER_EXTENDERS_TOKEN');\r\n\r\nexport { CommandHandlerExtender, COMMAND_HANDLER_EXTENDERS_TOKEN };\r\n","/**\r\n * 命令处理扩展注册器相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\nimport { MetadataUtil, Injector, InjectFlags } from '../core/index';\r\nimport { COMMAND_HANDLER_EXTENDER_META, CommandHandlerExtenderMetadata } from './decorators';\r\nimport { COMMAND_HANDLER_EXTENDERS_TOKEN, CommandHandlerExtender } from './command_handler_extender';\r\n\r\n/**\r\n * 命令处理扩展注册器\r\n */\r\nclass CommandHandlerExtenderRegistry {\r\n\r\n  /**\r\n   * CommandHandlerExtender实例Map\r\n   * - key：命令名称\r\n   * - value：命令扩展实例\r\n   */\r\n  private extendersMap: Map<string, CommandHandlerExtender[]>;\r\n\r\n  /**\r\n   * 构造函数\r\n   * @param extenders 命令扩展实例数组\r\n   */\r\n  constructor(private injector: Injector) {\r\n    const extenders = this.injector.get(COMMAND_HANDLER_EXTENDERS_TOKEN, null, InjectFlags.Optional);\r\n    this.extendersMap = new Map<string, CommandHandlerExtender[]>();\r\n    if (extenders) {\r\n      extenders.forEach((extender: CommandHandlerExtender) => {\r\n        this.regist(extender);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 获取命令扩展实例数组\r\n   * @param   commandName 命令名称\r\n   * @returns 命令处理扩展实例数组\r\n   */\r\n  get(commandName: string): CommandHandlerExtender[] {\r\n    if (this.extendersMap.has(commandName) === false) {\r\n      return [];\r\n    }\r\n    return this.extendersMap.get(commandName);\r\n  }\r\n\r\n  /**\r\n   * 添加命令扩展\r\n   * @param commandName Command名称\r\n   * @param extender    CommandHandlerExtender实例\r\n   * @return void\r\n   */\r\n  set(commandName: string, extender: CommandHandlerExtender) {\r\n    if (this.extendersMap.has(commandName)) {\r\n\r\n      // 如果commandName对应的扩展已经存在，则在扩展数组中追加\r\n      this.extendersMap.get(commandName).push(extender);\r\n    } else {\r\n\r\n      // 如果不存在，则创建新的扩展数组，并追加\r\n      this.extendersMap.set(commandName, [extender]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 注册命令扩展\r\n   * @param extender CommandHandlerExtender实例\r\n   */\r\n  regist(extender: CommandHandlerExtender) {\r\n\r\n    // 通过元数据获取要扩展的Comamnd名称\r\n    const extenderMetadata: CommandHandlerExtenderMetadata =\r\n      MetadataUtil.getClassMetadataByName(extender.constructor, COMMAND_HANDLER_EXTENDER_META);\r\n    if (!extenderMetadata) {\r\n      throw new Error('CommandHandlerExtender必须指定要扩展的命令名称');\r\n    }\r\n    const commandName = extenderMetadata.commandName;\r\n\r\n    // 添加到Map中\r\n    this.set(commandName, extender);\r\n  }\r\n\r\n}\r\n\r\nexport { CommandHandlerExtenderRegistry };\r\n","/**\r\n * 命令处理器工厂相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { CommandHandler } from './command_handler';\r\nimport { CommandHandlerRegistry } from './command_handler_registry';\r\nimport { CommandHandlerExtender } from './command_handler_extender';\r\nimport { CommandHandlerExtenderRegistry } from './command_handler_extender_registry';\r\n\r\n/**\r\n * 命令处理器工厂\r\n */\r\nclass CommandHandlerFactory {\r\n  /**\r\n   * 构造函数\r\n   * @param handlerRegistry  命令处理注册器\r\n   * @param extenderRegistry 命令处理扩展注册器\r\n   */\r\n  constructor(\r\n    private handlerRegistry: CommandHandlerRegistry,\r\n    private extenderRegistry: CommandHandlerExtenderRegistry,\r\n    private viewModelContext: ViewModelContext\r\n  ) {\r\n  }\r\n\r\n  /**\r\n   * 创建命令处理器\r\n   * @param   commandName 命令名称\r\n   * @returns 对应的命令处理器实例\r\n   */\r\n  public create(commandName: string): CommandHandler {\r\n    const rawHandler = this.handlerRegistry.get(commandName);\r\n    rawHandler.init(this.viewModelContext);\r\n    const extenders  = this.extenderRegistry.get(commandName);\r\n\r\n    // 遍历extenders，依次对handler进行扩展\r\n    return extenders.reduce((handler: CommandHandler, extender: CommandHandlerExtender) => {\r\n      return extender.extend(handler);\r\n    }, rawHandler);\r\n  }\r\n\r\n}\r\n\r\nexport { CommandHandlerFactory };\r\n","/**\r\n * CommandBus相关定义\r\n * @author Witt<jiwt@inspur.com>\r\n */\r\n\r\nimport { Observable, BehaviorSubject, Subject } from 'rxjs';\r\nimport { tap } from 'rxjs/operators';\r\nimport { Injector } from '../core/index';\r\nimport { Command } from './command';\r\nimport { CommandHandlerFactory } from './command_handler_factory';\r\nimport { CommandHandlerRegistry } from './command_handler_registry';\r\nimport { CommandHandlerExtenderRegistry } from './command_handler_extender_registry';\r\n\r\n\r\n/**\r\n * CommandBus用于派发Command，它接受一个Command实例，查找对应的CommandHandler，并执行。\r\n */\r\nclass CommandBus {\r\n\r\n  /**\r\n   * handler工厂\r\n   */\r\n  private handlerFactory: CommandHandlerFactory;\r\n\r\n  /**\r\n   * 正在执行的命令数量流（请勿使用，后果自负）\r\n   */\r\n  public executingCommandCount$: BehaviorSubject<number>;\r\n\r\n  /**\r\n   * 正在执行的命令数量\r\n   */\r\n  private executingCommands: Command[];\r\n\r\n  /**\r\n   * 构造函数\r\n   */\r\n  public constructor(handlerFactory: CommandHandlerFactory) {\r\n    this.handlerFactory = handlerFactory;\r\n    this.executingCommands = [];\r\n    this.executingCommandCount$ = new BehaviorSubject<number>(this.executingCommands.length);\r\n  }\r\n\r\n  /**\r\n   * 派发命令\r\n   * @param command 要派发的命令\r\n   */\r\n  public dispatch(command: Command): Observable<any> {\r\n    const commandResult$ = new Subject();\r\n    this.executeCommand(command).subscribe({\r\n        next: (lastTaskResult: any) => {\r\n          commandResult$.next(lastTaskResult);\r\n          commandResult$.complete();\r\n        },\r\n        complete: () => {\r\n          commandResult$.complete();\r\n          this.removeCommandFromExecutingQueue(command);\r\n        },\r\n        error: (error: any)  => {\r\n          commandResult$.error(error);\r\n          this.removeCommandFromExecutingQueue(command);\r\n        }\r\n      });\r\n    return commandResult$;\r\n  }\r\n\r\n  /**\r\n   * 执行命令并返回最后一个任务的执行结果流\r\n   */\r\n  private executeCommand(command: Command): Observable<any> {\r\n    this.addCommandToExecutingQueue(command);\r\n    const commandName = command.name;\r\n    const handler = this.handlerFactory.create(commandName);\r\n    const lastTaskResult$ = handler.execute(command);\r\n    return lastTaskResult$;\r\n  }\r\n\r\n\r\n  /**\r\n   * 添加到执行队列\r\n   */\r\n  private addCommandToExecutingQueue(command: Command) {\r\n    this.executingCommands.push(command);\r\n    this.executingCommandCount$.next(this.executingCommands.length);\r\n  }\r\n\r\n  /**\r\n   * 从执行队列中移除\r\n   */\r\n  private removeCommandFromExecutingQueue(command: Command) {\r\n    this.executingCommands = this.executingCommands.filter((executingCommand: Command) => {\r\n      return executingCommand !== command;\r\n    });\r\n    this.executingCommandCount$.next(this.executingCommands.length);\r\n  }\r\n\r\n}\r\n\r\nexport { CommandBus };\r\n","import { StaticProvider, Injector } from '../core/index';\r\nimport { ViewModelContext } from '../view-model/index';\r\nimport { CommandHandlerRegistry } from './command_handler_registry';\r\nimport { CommandHandlerExtenderRegistry } from './command_handler_extender_registry';\r\nimport { CommandHandlerFactory } from './command_handler_factory';\r\nimport { CommandBus } from './command_bus';\r\n\r\nconst VIEW_MODEL_COMMAND_PROVIDERS: StaticProvider[] = [\r\n  {\r\n    provide: CommandHandlerRegistry,\r\n    useClass: CommandHandlerRegistry,\r\n    deps: [ Injector ]\r\n  },\r\n  {\r\n    provide: CommandHandlerExtenderRegistry,\r\n    useClass: CommandHandlerExtenderRegistry,\r\n    deps: [ Injector ]\r\n  },\r\n  {\r\n    provide: CommandHandlerFactory,\r\n    useClass: CommandHandlerFactory,\r\n    deps: [ CommandHandlerRegistry, CommandHandlerExtenderRegistry, ViewModelContext ]\r\n  },\r\n  {\r\n    provide: CommandBus,\r\n    useClass: CommandBus,\r\n    deps: [ CommandHandlerFactory ]\r\n  }\r\n];\r\n\r\nexport { VIEW_MODEL_COMMAND_PROVIDERS };\r\n","/*\r\n * @Author: aalizzwell \r\n * @Date: 2019-05-30 11:08:18 \r\n * @Last Modified by: aalizzwell\r\n * @Last Modified time: 2019-06-01 17:10:04\r\n */\r\n\r\nimport { IExceptionHandler } from './types';\r\nexport const EXCEPTION_HANDLER = '@farris/devkit ExceptionHandler';","import { Type, makeDecorator } from '../core/index';\r\n\r\n/**\r\n * REPOSITORY_META\r\n */\r\nexport const REPOSITORY_META = 'RepositoryMeta';\r\n\r\n\r\n/**\r\n * RepositoryMeta\r\n */\r\nexport interface RepositoryMeta {\r\n\r\n  /**\r\n   * 实体类型\r\n   */\r\n  entityType: Type<any>;\r\n}\r\n\r\n\r\n/**\r\n * RepositoryMetaDecorator\r\n */\r\nexport interface RepositoryMetaDecorator {\r\n  (obj?: RepositoryMeta): any;\r\n  new (obj?: RepositoryMeta): any;\r\n}\r\n\r\n\r\n/**\r\n * RepositoryMeta\r\n */\r\nexport function RepositoryMeta(options: RepositoryMeta) {\r\n  const decoratorFactory = makeDecorator(\r\n    REPOSITORY_META,\r\n    (obj: RepositoryMeta) => obj\r\n  );\r\n  return decoratorFactory(options);\r\n}\r\n"]}