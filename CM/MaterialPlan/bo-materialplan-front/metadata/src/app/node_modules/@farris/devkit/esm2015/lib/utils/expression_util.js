import { DataPropGroup } from "../core/index";
import { ENTITY_TEMPLATE, GROUP_FUNCTIONS } from "../resolver/index";
export class ExpressionUtil {
    static getGroupFunctionDependency(expr, entityTypeInfo) {
        const deps = [];
        // 获取聚合函数依赖项
        const groupFunctionRegex = new RegExp(`DefaultFunction\\.(${GROUP_FUNCTIONS.join('|')})\\s*\\([^\\r\\n\\)]*\\)`, "g");
        const groupFunctions = expr.match(groupFunctionRegex);
        if (groupFunctions && groupFunctions.length > 0) {
            // todo: 使用正则匹配时可能会因为参数中有逗号导致问题，后续使用ast解析
            const argumentsRegex = /\(([^\r\n\)]*)\)/;
            groupFunctions.forEach((groupFunction) => {
                const argumentMatchResult = groupFunction.match(argumentsRegex);
                if (argumentMatchResult.length === 2) {
                    const argument = argumentMatchResult[1];
                    const args = argument.split(',').map(p => p.replace(/\"/g, ''));
                    if (args && args.length === 2) {
                        let item = args.join('.');
                        item = this.convertToNodeCode(item, entityTypeInfo).join('.');
                        item = item.substr(item.indexOf('.') + 1);
                        const dep = item.split('.');
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                    else {
                        throw new Error(`无法解析参数： ${JSON.stringify(argument)}`);
                    }
                }
            });
        }
        return deps;
    }
    /**
     * 将voCode转换为前端nodeCode
     * @param entityExpression like Entity.Child.p1
     * @returns
     */
    static convertToNodeCode(entityExpression, entityTypeInfo) {
        // UserEntity.storys.p1
        const nodeCodes = [];
        if (entityTypeInfo && entityExpression.includes('.')) {
            const entityExpressions = entityExpression.split('.') || [];
            let dataTypeInfo = entityTypeInfo;
            for (let index = 0; index < entityExpressions.length; index++) {
                const prop = entityExpressions[index];
                if (dataTypeInfo && dataTypeInfo.entityInfo && dataTypeInfo.entityInfo.nodeCode === prop || dataTypeInfo.entityInfo.originalCode === prop) {
                    // 第一个是主表code，不能转nodeCode
                    if (index === 0) {
                        nodeCodes.push(dataTypeInfo.entityInfo.originalCode);
                    }
                    else {
                        nodeCodes.push(dataTypeInfo.entityInfo.nodeCode);
                    }
                    // 下一级可能为子表、对象或属性
                    const nextNodeCode = entityExpressions[index + 1];
                    if (!nextNodeCode) {
                        break;
                    }
                    const nextNodeCodePropInfo = dataTypeInfo.getPropInfoByName(nextNodeCode);
                    if (!nextNodeCodePropInfo) {
                        break;
                    }
                    // 下一级为子表或对象
                    if (nextNodeCodePropInfo.typeInfo) {
                        dataTypeInfo = nextNodeCodePropInfo.typeInfo;
                    }
                }
                else if (dataTypeInfo && dataTypeInfo.getPropInfoByName(prop)) {
                    const dataPropInfo = dataTypeInfo.getPropInfoByName(prop);
                    nodeCodes.push(dataPropInfo.name);
                }
                else {
                    //throw new Error(`错误的属性参数 ${entityExpression}`);
                    break;
                }
            }
        }
        return nodeCodes;
    }
    /**
     * 找到元数据中所有实体路径
     * @param dataTypeInfo
     * @param results
     * @param paths
     */
    static getChildrenEntityPaths(dataTypeInfo, results, paths = []) {
        const list = dataTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach((dataPropInfo) => {
                if (paths.length === 0) {
                    results.push([dataPropInfo.name]);
                }
                const childrens = dataPropInfo.typeInfo.getPropInfosByGroup(DataPropGroup.List);
                if (childrens && childrens.length > 0) {
                    paths.push(dataPropInfo.name);
                    childrens.forEach((dataPropInfo) => {
                        this.getChildrenEntityPaths(dataPropInfo.typeInfo, results, paths);
                    });
                }
                else {
                    if (paths.length !== 0) {
                        paths.push(dataPropInfo.name);
                        results.push([...paths]);
                    }
                    paths.length = 0;
                }
            });
        }
        else {
            if (paths.length > 0) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
                results.push([...paths]);
            }
            paths.length = 0;
        }
    }
    /**
     * 获取指定绑定路径的当前行数据
     * @param paths 绑定路径
     * @param bindingData
     * @returns
     */
    static getCurrentRowByPaths(paths, bindingData) {
        let result = null;
        const bindingList = bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            let primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            // 主表或下级表新增，此时事件行就是当前行，无需处理
            if (primaryValue) {
                const bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    }
    /**
     * 从实体路径中获取级数最大的从表或从从表
     * @param paths
     * @returns
     */
    static getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo) {
        let nodeCodes = [];
        paths = [...paths];
        while (paths.length > 0) {
            const dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo && dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    }
    /**
     * 从路径中获取绑定路径
     * @param paths 路径
     * @param entityTypeInfo entityTypeInfo
     * @returns
     */
    static getBindingPath(paths, entityTypeInfo) {
        paths = this.getEntityPath(paths);
        const entityPaths = this.getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo);
        return entityPaths;
    }
    static getEntityPath(path) {
        const paths = path.filter((value, index) => {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl91dGlsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvZXhwcmVzc2lvbl91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxhQUFhLEVBQThCLE1BQU0sZUFBZSxDQUFDO0FBQzFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFFckUsTUFBTSxPQUFPLGNBQWM7SUFDbEIsTUFBTSxDQUFDLDBCQUEwQixDQUFDLElBQVksRUFBRSxjQUE0QjtRQUNqRixNQUFNLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEIsWUFBWTtRQUNaLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxNQUFNLENBQUMsc0JBQXNCLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLDBCQUEwQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3RILE1BQU0sY0FBYyxHQUFxQixJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDeEUsSUFBSSxjQUFjLElBQUksY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0MseUNBQXlDO1lBQ3pDLE1BQU0sY0FBYyxHQUFHLGtCQUFrQixDQUFDO1lBQzFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxhQUFxQixFQUFFLEVBQUU7Z0JBQy9DLE1BQU0sbUJBQW1CLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztnQkFDaEUsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO29CQUNwQyxNQUFNLFFBQVEsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDeEMsTUFBTSxJQUFJLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FB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YmluZGluZy1kYXRhL2luZGV4XCI7XHJcbmltcG9ydCB7IERhdGFQcm9wR3JvdXAsIERhdGFQcm9wSW5mbywgRGF0YVR5cGVJbmZvIH0gZnJvbSBcIi4uL2NvcmUvaW5kZXhcIjtcclxuaW1wb3J0IHsgRU5USVRZX1RFTVBMQVRFLCBHUk9VUF9GVU5DVElPTlMgfSBmcm9tIFwiLi4vcmVzb2x2ZXIvaW5kZXhcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBFeHByZXNzaW9uVXRpbCB7XHJcbiAgcHVibGljIHN0YXRpYyBnZXRHcm91cEZ1bmN0aW9uRGVwZW5kZW5jeShleHByOiBzdHJpbmcsIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBkZXBzID0gW107XHJcbiAgICAvLyDojrflj5bogZrlkIjlh73mlbDkvp3otZbpoblcclxuICAgIGNvbnN0IGdyb3VwRnVuY3Rpb25SZWdleCA9IG5ldyBSZWdFeHAoYERlZmF1bHRGdW5jdGlvblxcXFwuKCR7R1JPVVBfRlVOQ1RJT05TLmpvaW4oJ3wnKX0pXFxcXHMqXFxcXChbXlxcXFxyXFxcXG5cXFxcKV0qXFxcXClgLCBcImdcIik7XHJcbiAgICBjb25zdCBncm91cEZ1bmN0aW9uczogUmVnRXhwTWF0Y2hBcnJheSA9IGV4cHIubWF0Y2goZ3JvdXBGdW5jdGlvblJlZ2V4KTtcclxuICAgIGlmIChncm91cEZ1bmN0aW9ucyAmJiBncm91cEZ1bmN0aW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vIHRvZG86IOS9v+eUqOato+WImeWMuemFjeaXtuWPr+iDveS8muWboOS4uuWPguaVsOS4reaciemAl+WPt+WvvOiHtOmXrumimO+8jOWQjue7reS9v+eUqGFzdOino+aekFxyXG4gICAgICBjb25zdCBhcmd1bWVudHNSZWdleCA9IC9cXCgoW15cXHJcXG5cXCldKilcXCkvO1xyXG4gICAgICBncm91cEZ1bmN0aW9ucy5mb3JFYWNoKChncm91cEZ1bmN0aW9uOiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCBhcmd1bWVudE1hdGNoUmVzdWx0ID0gZ3JvdXBGdW5jdGlvbi5tYXRjaChhcmd1bWVudHNSZWdleCk7XHJcbiAgICAgICAgaWYgKGFyZ3VtZW50TWF0Y2hSZXN1bHQubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICBjb25zdCBhcmd1bWVudCA9IGFyZ3VtZW50TWF0Y2hSZXN1bHRbMV07XHJcbiAgICAgICAgICBjb25zdCBhcmdzID0gYXJndW1lbnQuc3BsaXQoJywnKS5tYXAocCA9PiBwLnJlcGxhY2UoL1xcXCIvZywgJycpKTtcclxuICAgICAgICAgIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID09PSAyKSB7XHJcbiAgICAgICAgICAgIGxldCBpdGVtOiBhbnkgPSBhcmdzLmpvaW4oJy4nKTtcclxuICAgICAgICAgICAgaXRlbSA9IHRoaXMuY29udmVydFRvTm9kZUNvZGUoaXRlbSwgZW50aXR5VHlwZUluZm8pLmpvaW4oJy4nKTtcclxuICAgICAgICAgICAgaXRlbSA9IGl0ZW0uc3Vic3RyKGl0ZW0uaW5kZXhPZignLicpICsgMSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRlcCA9IGl0ZW0uc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgZGVwLnNwbGljZSgwLCAwLCBFTlRJVFlfVEVNUExBVEUpO1xyXG4gICAgICAgICAgICBkZXBzLnB1c2goZGVwLmpvaW4oJy8nKSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOazleino+aekOWPguaVsO+8miAke0pTT04uc3RyaW5naWZ5KGFyZ3VtZW50KX1gKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRlcHM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWwhnZvQ29kZei9rOaNouS4uuWJjeerr25vZGVDb2RlXHJcbiAgICogQHBhcmFtIGVudGl0eUV4cHJlc3Npb24gbGlrZSBFbnRpdHkuQ2hpbGQucDFcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGNvbnZlcnRUb05vZGVDb2RlKGVudGl0eUV4cHJlc3Npb246IHN0cmluZywgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbyk6IHN0cmluZ1tdIHtcclxuICAgIC8vIFVzZXJFbnRpdHkuc3RvcnlzLnAxXHJcbiAgICBjb25zdCBub2RlQ29kZXMgPSBbXTtcclxuICAgIGlmIChlbnRpdHlUeXBlSW5mbyAmJiBlbnRpdHlFeHByZXNzaW9uLmluY2x1ZGVzKCcuJykpIHtcclxuICAgICAgY29uc3QgZW50aXR5RXhwcmVzc2lvbnMgPSBlbnRpdHlFeHByZXNzaW9uLnNwbGl0KCcuJykgfHwgW107XHJcbiAgICAgIGxldCBkYXRhVHlwZUluZm8gPSBlbnRpdHlUeXBlSW5mbztcclxuICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGVudGl0eUV4cHJlc3Npb25zLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICAgIGNvbnN0IHByb3AgPSBlbnRpdHlFeHByZXNzaW9uc1tpbmRleF07XHJcbiAgICAgICAgaWYgKGRhdGFUeXBlSW5mbyAmJiBkYXRhVHlwZUluZm8uZW50aXR5SW5mbyAmJiBkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSA9PT0gcHJvcCB8fCBkYXRhVHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUgPT09IHByb3ApIHtcclxuICAgICAgICAgIC8vIOesrOS4gOS4quaYr+S4u+ihqGNvZGXvvIzkuI3og73ovaxub2RlQ29kZVxyXG4gICAgICAgICAgaWYgKGluZGV4ID09PSAwKSB7XHJcbiAgICAgICAgICAgIG5vZGVDb2Rlcy5wdXNoKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm9yaWdpbmFsQ29kZSk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBub2RlQ29kZXMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgLy8g5LiL5LiA57qn5Y+v6IO95Li65a2Q6KGo44CB5a+56LGh5oiW5bGe5oCnXHJcbiAgICAgICAgICBjb25zdCBuZXh0Tm9kZUNvZGUgPSBlbnRpdHlFeHByZXNzaW9uc1tpbmRleCArIDFdO1xyXG4gICAgICAgICAgaWYgKCFuZXh0Tm9kZUNvZGUpIHtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBjb25zdCBuZXh0Tm9kZUNvZGVQcm9wSW5mbyA9IGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb0J5TmFtZShuZXh0Tm9kZUNvZGUpO1xyXG4gICAgICAgICAgaWYgKCFuZXh0Tm9kZUNvZGVQcm9wSW5mbykge1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOS4i+S4gOe6p+S4uuWtkOihqOaIluWvueixoVxyXG4gICAgICAgICAgaWYgKG5leHROb2RlQ29kZVByb3BJbmZvLnR5cGVJbmZvKSB7XHJcbiAgICAgICAgICAgIGRhdGFUeXBlSW5mbyA9IG5leHROb2RlQ29kZVByb3BJbmZvLnR5cGVJbmZvO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoZGF0YVR5cGVJbmZvICYmIGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb0J5TmFtZShwcm9wKSkge1xyXG4gICAgICAgICAgY29uc3QgZGF0YVByb3BJbmZvID0gZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvQnlOYW1lKHByb3ApO1xyXG4gICAgICAgICAgbm9kZUNvZGVzLnB1c2goZGF0YVByb3BJbmZvLm5hbWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvL3Rocm93IG5ldyBFcnJvcihg6ZSZ6K+v55qE5bGe5oCn5Y+C5pWwICR7ZW50aXR5RXhwcmVzc2lvbn1gKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5vZGVDb2RlcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5om+5Yiw5YWD5pWw5o2u5Lit5omA5pyJ5a6e5L2T6Lev5b6EXHJcbiAgICogQHBhcmFtIGRhdGFUeXBlSW5mbyBcclxuICAgKiBAcGFyYW0gcmVzdWx0cyBcclxuICAgKiBAcGFyYW0gcGF0aHMgXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBnZXRDaGlsZHJlbkVudGl0eVBhdGhzKGRhdGFUeXBlSW5mbzogRGF0YVR5cGVJbmZvLCByZXN1bHRzOiBhbnlbXSwgcGF0aHM6IHN0cmluZ1tdID0gW10pIHtcclxuICAgIGNvbnN0IGxpc3Q6IERhdGFQcm9wSW5mb1tdID0gZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvc0J5R3JvdXAoRGF0YVByb3BHcm91cC5MaXN0KTtcclxuICAgIGlmIChsaXN0ICYmIGxpc3QubGVuZ3RoID4gMCkge1xyXG4gICAgICBsaXN0LmZvckVhY2goKGRhdGFQcm9wSW5mbzogRGF0YVByb3BJbmZvKSA9PiB7XHJcbiAgICAgICAgaWYgKHBhdGhzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgcmVzdWx0cy5wdXNoKFtkYXRhUHJvcEluZm8ubmFtZV0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjaGlsZHJlbnM6IERhdGFQcm9wSW5mb1tdID0gZGF0YVByb3BJbmZvLnR5cGVJbmZvLmdldFByb3BJbmZvc0J5R3JvdXAoRGF0YVByb3BHcm91cC5MaXN0KTtcclxuICAgICAgICBpZiAoY2hpbGRyZW5zICYmIGNoaWxkcmVucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICBwYXRocy5wdXNoKGRhdGFQcm9wSW5mby5uYW1lKTtcclxuICAgICAgICAgIGNoaWxkcmVucy5mb3JFYWNoKChkYXRhUHJvcEluZm86IERhdGFQcm9wSW5mbykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmdldENoaWxkcmVuRW50aXR5UGF0aHMoZGF0YVByb3BJbmZvLnR5cGVJbmZvLCByZXN1bHRzLCBwYXRocyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKHBhdGhzLmxlbmd0aCAhPT0gMCkge1xyXG4gICAgICAgICAgICBwYXRocy5wdXNoKGRhdGFQcm9wSW5mby5uYW1lKTtcclxuICAgICAgICAgICAgcmVzdWx0cy5wdXNoKFsuLi5wYXRoc10pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGF0aHMubGVuZ3RoID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKHBhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBwYXRocy5wdXNoKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlKTtcclxuICAgICAgICByZXN1bHRzLnB1c2goWy4uLnBhdGhzXSk7XHJcbiAgICAgIH1cclxuICAgICAgcGF0aHMubGVuZ3RoID0gMDtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5oyH5a6a57uR5a6a6Lev5b6E55qE5b2T5YmN6KGM5pWw5o2uXHJcbiAgICogQHBhcmFtIHBhdGhzIOe7keWumui3r+W+hFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nRGF0YSBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGdldEN1cnJlbnRSb3dCeVBhdGhzKHBhdGhzOiBzdHJpbmdbXSwgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhKTogbnVsbCB8IHsgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcclxuICAgIGxldCByZXN1bHQgPSBudWxsO1xyXG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgaWYgKGJpbmRpbmdMaXN0ICYmIGJpbmRpbmdMaXN0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgbGV0IHByaW1hcnlWYWx1ZSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSB8fCBudWxsO1xyXG4gICAgICAvLyDkvb/nlKjkuovku7bkuK3nmoTkuLvplK5cclxuICAgICAgLy8g5Li76KGo5oiW5LiL57qn6KGo5paw5aKe77yM5q2k5pe25LqL5Lu26KGM5bCx5piv5b2T5YmN6KGM77yM5peg6ZyA5aSE55CGXHJcbiAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcclxuICAgICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcclxuICAgICAgICBpZiAoYmluZGluZ09iamVjdCkge1xyXG4gICAgICAgICAgcmVzdWx0ID0gYmluZGluZ09iamVjdC50b0pTT04oKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOS7juWunuS9k+i3r+W+hOS4reiOt+WPlue6p+aVsOacgOWkp+eahOS7juihqOaIluS7juS7juihqFxyXG4gICAqIEBwYXJhbSBwYXRocyBcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHM6IHN0cmluZ1tdLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10ge1xyXG4gICAgbGV0IG5vZGVDb2RlcyA9IFtdO1xyXG4gICAgcGF0aHMgPSBbLi4ucGF0aHNdO1xyXG4gICAgd2hpbGUgKHBhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgZGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICBpZiAoZGF0YVByb3BJbmZvICYmIGRhdGFQcm9wSW5mby5ncm91cCA9PT0gJ0xpc3QnKSB7XHJcbiAgICAgICAgbm9kZUNvZGVzID0gcGF0aHM7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgICAgcGF0aHMucG9wKCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbm9kZUNvZGVzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDku47ot6/lvoTkuK3ojrflj5bnu5Hlrprot6/lvoRcclxuICAgKiBAcGFyYW0gcGF0aHMg6Lev5b6EXHJcbiAgICogQHBhcmFtIGVudGl0eVR5cGVJbmZvIGVudGl0eVR5cGVJbmZvXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBnZXRCaW5kaW5nUGF0aChwYXRoczogc3RyaW5nW10sIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pIHtcclxuICAgIHBhdGhzID0gdGhpcy5nZXRFbnRpdHlQYXRoKHBhdGhzKTtcclxuICAgIGNvbnN0IGVudGl0eVBhdGhzID0gdGhpcy5nZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKHBhdGhzLCBlbnRpdHlUeXBlSW5mbyk7XHJcbiAgICByZXR1cm4gZW50aXR5UGF0aHM7XHJcbiAgfVxyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0RW50aXR5UGF0aChwYXRoOiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5maWx0ZXIoKHZhbHVlOiBzdHJpbmcsIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgaWYgKGluZGV4ICUgMiA9PT0gMCAmJiB2YWx1ZS5pbmNsdWRlcygnOicpKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBwYXRocztcclxuICB9XHJcbn0iXX0=