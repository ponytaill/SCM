/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { LocaleService } from '@farris/ui-locale';
import { Pipe, Injector, Optional, ElementRef, LOCALE_ID } from '@angular/core';
import { Utils } from './utils';
import { ColumnFormatService } from '@farris/ui-common/column';
export class FormatCellDataPipe {
    /**
     * @param {?} cfs
     * @param {?=} injector
     */
    constructor(cfs, injector) {
        this.cfs = cfs;
        this.injector = injector;
        this.localeId = 'ZH-CHS';
        this.localeId = this.injector.get(LOCALE_ID);
    }
    /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    transform(col, rowData, groupFooter = false, footer = false) {
        if (rowData && col && col.field) {
            /** @type {?} */
            const value = Utils.getValue(col.field, rowData);
            if (col.editor && col.editor.options && col.editor.options.isPassword && !col.formatter) {
                return value ? '******' : '';
            }
            /** @type {?} */
            let formatterFn = col.formatter;
            if (groupFooter) {
                formatterFn = col.groupFooter ? col.groupFooter.formatter : undefined;
            }
            else if (footer) {
                formatterFn = col.footer ? col.footer.formatter : undefined;
                if (typeof formatterFn === 'object') {
                    if (!formatterFn.options) {
                        /** @type {?} */
                        const opts = { type: formatterFn.type, options: formatterFn };
                        formatterFn = opts;
                    }
                }
            }
            if (!formatterFn) {
                /** @type {?} */
                let resoultStr = value;
                if (col.isMultilingualField) {
                    resoultStr = this.getMultilingualValue(value);
                }
                else {
                    if (value !== null && value !== undefined && value !== '0' && typeof value === 'string') {
                        if (value.indexOf('\n') > -1) {
                            // return value.replace(/\n/g, '<br>');
                            this.getDatagridInstance();
                            if (this.dataGrid && this.dataGrid.nowrap) {
                                resoultStr = value.replace(/\n/g, ' ');
                            }
                        }
                    }
                    // value.replace(/ /g, '&ensp;');
                }
                return this.setPlaceHolderWhenEnableEditCellStyle(col, resoultStr, rowData, groupFooter || footer);
            }
            else {
                if (formatterFn) {
                    if (formatterFn.type === 'number') {
                        if (!formatterFn.options || !Object.keys(formatterFn.options).length) {
                            formatterFn.options = {
                                thousand: ',',
                                precision: 2
                            };
                        }
                    }
                    if (formatterFn.type === 'datetime') {
                        if (formatterFn.options) {
                            if (col.editor && col.editor.options) {
                                const { dateRange, dateRangeDatesDelimiter } = col.editor.options;
                                formatterFn.options = Object.assign({ dateRange, dateRangeDatesDelimiter }, formatterFn.options);
                            }
                        }
                    }
                    if (formatterFn.type === 'timeago') {
                        if (formatterFn.options) {
                            formatterFn.options.locale = formatterFn.options.locale || this.localeId;
                        }
                        else {
                            formatterFn.options = {
                                locale: this.localeId
                            };
                        }
                    }
                }
                this.getDatagridInstance();
                if (this.dataGrid) {
                    /** @type {?} */
                    const r = this.cfs.format(value, rowData, formatterFn, { utils: this.dataGrid.commonUtils, locale: this.localeId });
                    return this.setPlaceHolderWhenEnableEditCellStyle(col, r, rowData, groupFooter || footer);
                }
                else {
                    return this.cfs.format(value, rowData, formatterFn, { locale: this.localeId });
                }
            }
        }
        return '';
    }
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    getMultilingualValue(valObj) {
        if (valObj && typeof valObj === 'object' && Object.keys(valObj).length > 0) {
            if (this.injector) {
                this.localeService = this.injector.get(LocaleService);
            }
            if (this.localeService) {
                /** @type {?} */
                const localeId = this.localeService.localeId;
                return Utils.getMultilingualValue(valObj, localeId);
            }
            else {
                return valObj['zh-CHS'];
            }
        }
        else {
            return '';
        }
    }
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    setPlaceHolderWhenEnableEditCellStyle(col, val, rowData, isFooter) {
        this.getDatagridInstance();
        if (this.dataGrid) {
            /*
            if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                if (this.elRef) {
                    const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') > -1) {
                        span.className = span.className.replace('cell-empty', ' ');
                    }
                }

                return val;
            }
*/
            if (this.dataGrid.enableEditCellStyle) {
                if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                    if (this.elRef) {
                        /** @type {?} */
                        const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                        if (span && span.className.indexOf('cell-empty') > -1) {
                            span.className = span.className.replace('cell-empty', ' ');
                        }
                    }
                    return val;
                }
                if (this.elRef) {
                    /** @type {?} */
                    const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') === -1) {
                        span.className = span.className + ' cell-empty';
                    }
                }
                return Utils.getWhenEmptyText(col, this.localeId);
            }
            return val;
        }
        return val;
    }
    /**
     * @private
     * @return {?}
     */
    getDatagridInstance() {
        if (!this.dataGrid) {
            this.dataGrid = this.injector.get(DatagridComponent, null);
        }
        if (!this.elRef) {
            this.elRef = this.injector.get(ElementRef, null);
        }
    }
    /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    cellIsReadOnly(col, rowData) {
        return this.dataGrid.cellIsReadOnly(col, rowData);
    }
}
FormatCellDataPipe.decorators = [
    { type: Pipe, args: [{ name: 'formatCellData', pure: false },] }
];
/** @nocollapse */
FormatCellDataPipe.ctorParameters = () => [
    { type: ColumnFormatService },
    { type: Injector, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeService;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.dataGrid;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.cfs;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0LWNlbGwtZGF0YS5waXBlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9mb3JtYXQtY2VsbC1kYXRhLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFpQixRQUFRLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUkvRCxNQUFNLE9BQU8sa0JBQWtCOzs7OztJQU0zQixZQUFvQixHQUF3QixFQUFzQixRQUFtQjtRQUFqRSxRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBRDdFLGFBQVEsR0FBRyxRQUFRLENBQUM7UUFFeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7Ozs7OztJQUVELFNBQVMsQ0FBQyxHQUFRLEVBQUUsT0FBWSxFQUFFLFdBQVcsR0FBRyxLQUFLLEVBQUUsTUFBTSxHQUFHLEtBQUs7UUFDakUsSUFBSSxPQUFPLElBQUksR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUU7O2tCQUN2QixLQUFLLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQztZQUNoRCxJQUFJLEdBQUcsQ0FBQyxNQUFNLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksR0FBRyxD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bUJBQW1CO1lBRkUsUUFBUSx1QkFZYSxRQUFROzs7Ozs7O0lBSnZELDJDQUFxQzs7Ozs7SUFDckMsc0NBQW9DOzs7OztJQUNwQyxtQ0FBMEI7Ozs7O0lBQzFCLHNDQUE0Qjs7Ozs7SUFDaEIsaUNBQWdDOzs7OztJQUFFLHNDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1sb2NhbGUnO1xyXG5pbXBvcnQgeyBQaXBlLCBQaXBlVHJhbnNmb3JtLCBJbmplY3RvciwgT3B0aW9uYWwsIEVsZW1lbnRSZWYsIExPQ0FMRV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBVdGlscyB9IGZyb20gJy4vdXRpbHMnO1xyXG5pbXBvcnQgeyBDb2x1bW5Gb3JtYXRTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vY29sdW1uJztcclxuaW1wb3J0IHsgRGF0YUNvbHVtbiB9IGZyb20gJy4uL3R5cGVzL2RhdGEtY29sdW1uJztcclxuXHJcbkBQaXBlKHtuYW1lOiAnZm9ybWF0Q2VsbERhdGEnLCBwdXJlOiBmYWxzZX0pXHJcbmV4cG9ydCBjbGFzcyBGb3JtYXRDZWxsRGF0YVBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcclxuXHJcbiAgICBwcml2YXRlIGxvY2FsZVNlcnZpY2U6IExvY2FsZVNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGRhdGFHcmlkOiBEYXRhZ3JpZENvbXBvbmVudDtcclxuICAgIHByaXZhdGUgZWxSZWY6IEVsZW1lbnRSZWY7XHJcbiAgICBwcml2YXRlIGxvY2FsZUlkID0gJ1pILUNIUyc7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNmczogQ29sdW1uRm9ybWF0U2VydmljZSwgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3Rvcj86IEluamVjdG9yKSB7XHJcbiAgICAgICAgdGhpcy5sb2NhbGVJZCA9IHRoaXMuaW5qZWN0b3IuZ2V0KExPQ0FMRV9JRCk7XHJcbiAgICB9XHJcblxyXG4gICAgdHJhbnNmb3JtKGNvbDogYW55LCByb3dEYXRhOiBhbnksIGdyb3VwRm9vdGVyID0gZmFsc2UsIGZvb3RlciA9IGZhbHNlKTogYW55IHtcclxuICAgICAgICBpZiAocm93RGF0YSAmJiBjb2wgJiYgY29sLmZpZWxkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gVXRpbHMuZ2V0VmFsdWUoY29sLmZpZWxkLCByb3dEYXRhKTtcclxuICAgICAgICAgICAgaWYgKGNvbC5lZGl0b3IgJiYgY29sLmVkaXRvci5vcHRpb25zICYmIGNvbC5lZGl0b3Iub3B0aW9ucy5pc1Bhc3N3b3JkICYmICFjb2wuZm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gIHZhbHVlID8gJyoqKioqKicgOiAnJztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IGZvcm1hdHRlckZuID0gY29sLmZvcm1hdHRlcjtcclxuICAgICAgICAgICAgaWYgKGdyb3VwRm9vdGVyKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbiA9IGNvbC5ncm91cEZvb3RlciA/IGNvbC5ncm91cEZvb3Rlci5mb3JtYXR0ZXIgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZm9vdGVyKSB7XHJcbiAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbiA9IGNvbC5mb290ZXIgPyBjb2wuZm9vdGVyLmZvcm1hdHRlciA6IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZm9ybWF0dGVyRm4gPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFmb3JtYXR0ZXJGbi5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wdHMgPSB7IHR5cGU6IGZvcm1hdHRlckZuLnR5cGUsIG9wdGlvbnM6IGZvcm1hdHRlckZuIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuID0gb3B0cztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICghZm9ybWF0dGVyRm4pIHtcclxuICAgICAgICAgICAgICAgIGxldCByZXNvdWx0U3RyID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sLmlzTXVsdGlsaW5ndWFsRmllbGQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXNvdWx0U3RyID0gdGhpcy5nZXRNdWx0aWxpbmd1YWxWYWx1ZSh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSAnMCcgJiYgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUuaW5kZXhPZignXFxuJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHZhbHVlLnJlcGxhY2UoL1xcbi9nLCAnPGJyPicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5nZXREYXRhZ3JpZEluc3RhbmNlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXRhR3JpZCAmJiB0aGlzLmRhdGFHcmlkLm5vd3JhcCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc291bHRTdHIgPSB2YWx1ZS5yZXBsYWNlKC9cXG4vZywgJyAnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyB2YWx1ZS5yZXBsYWNlKC8gL2csICcmZW5zcDsnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFBsYWNlSG9sZGVyV2hlbkVuYWJsZUVkaXRDZWxsU3R5bGUoY29sLCByZXNvdWx0U3RyLCByb3dEYXRhLCBncm91cEZvb3RlciB8fCBmb290ZXIpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlckZuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBmb3JtYXR0ZXJGbi50eXBlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZvcm1hdHRlckZuLm9wdGlvbnMgfHwgIU9iamVjdC5rZXlzKGZvcm1hdHRlckZuLm9wdGlvbnMpLmxlbmd0aCApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuLm9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhvdXNhbmQ6ICcsJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmVjaXNpb246IDJcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBmb3JtYXR0ZXJGbi50eXBlID09PSAnZGF0ZXRpbWUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZXJGbi5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY29sLmVkaXRvciAmJiBjb2wuZWRpdG9yLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRhdGVSYW5nZSwgZGF0ZVJhbmdlRGF0ZXNEZWxpbWl0ZXIgfSA9IGNvbC5lZGl0b3Iub3B0aW9ucztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbi5vcHRpb25zID0gT2JqZWN0LmFzc2lnbih7IGRhdGVSYW5nZSwgZGF0ZVJhbmdlRGF0ZXNEZWxpbWl0ZXIgfSwgZm9ybWF0dGVyRm4ub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZXJGbi50eXBlID09PSAndGltZWFnbycpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlckZuLm9wdGlvbnMgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbi5vcHRpb25zLmxvY2FsZSA9IGZvcm1hdHRlckZuLm9wdGlvbnMubG9jYWxlIHx8IHRoaXMubG9jYWxlSWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbi5vcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsZTogdGhpcy5sb2NhbGVJZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXREYXRhZ3JpZEluc3RhbmNlKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXRhR3JpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNmcy5mb3JtYXQodmFsdWUsIHJvd0RhdGEsIGZvcm1hdHRlckZuLCB7IHV0aWxzOiB0aGlzLmRhdGFHcmlkLmNvbW1vblV0aWxzLCBsb2NhbGU6IHRoaXMubG9jYWxlSWQgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0UGxhY2VIb2xkZXJXaGVuRW5hYmxlRWRpdENlbGxTdHlsZShjb2wsIHIsIHJvd0RhdGEsIGdyb3VwRm9vdGVyIHx8IGZvb3Rlcik7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNmcy5mb3JtYXQodmFsdWUsIHJvd0RhdGEsIGZvcm1hdHRlckZuLCB7bG9jYWxlOiB0aGlzLmxvY2FsZUlkIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W5aSa6K+t5pWw5o2uXHJcbiAgICBwcml2YXRlIGdldE11bHRpbGluZ3VhbFZhbHVlKHZhbE9iaikge1xyXG4gICAgICAgIGlmICh2YWxPYmogJiYgdHlwZW9mIHZhbE9iaiA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmtleXModmFsT2JqKS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluamVjdG9yKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChMb2NhbGVTZXJ2aWNlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAodGhpcy5sb2NhbGVTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsb2NhbGVJZCA9IHRoaXMubG9jYWxlU2VydmljZS5sb2NhbGVJZDtcclxuICAgICAgICAgICAgICAgIHJldHVybiBVdGlscy5nZXRNdWx0aWxpbmd1YWxWYWx1ZSh2YWxPYmosIGxvY2FsZUlkKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWxPYmpbJ3poLUNIUyddO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDlkK/nlKjmoIfor4blj6/nvJbovpHljZXlhYPmoLzml7bvvIzlhoXlrrnkuLrnqbrml7borr7nva7mj5DnpLror61cclxuICAgIHByaXZhdGUgc2V0UGxhY2VIb2xkZXJXaGVuRW5hYmxlRWRpdENlbGxTdHlsZShjb2wsIHZhbCwgcm93RGF0YSwgaXNGb290ZXIpIHtcclxuICAgICAgICB0aGlzLmdldERhdGFncmlkSW5zdGFuY2UoKTtcclxuICAgICAgICBpZiAodGhpcy5kYXRhR3JpZCkge1xyXG4gICAgICAgICAgICAvKlxyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZGF0YUdyaWQuZWRpdGFibGUgfHwgKHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHVuZGVmaW5lZCAmJiB2YWwgIT09ICcnKSB8fCBpc0Zvb3RlciB8fCB0aGlzLmNlbGxJc1JlYWRPbmx5KGNvbCwgcm93RGF0YSkpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IHRoaXMuZWxSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuY2VsbC10ZXh0LWJveCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzcGFuICYmIHNwYW4uY2xhc3NOYW1lLmluZGV4T2YoJ2NlbGwtZW1wdHknKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gc3Bhbi5jbGFzc05hbWUucmVwbGFjZSgnY2VsbC1lbXB0eScsICcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgICAgIH1cclxuKi9cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGF0YUdyaWQuZW5hYmxlRWRpdENlbGxTdHlsZSApIHtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZGF0YUdyaWQuZWRpdGFibGUgfHwgKHZhbCAhPT0gbnVsbCAmJiB2YWwgIT09IHVuZGVmaW5lZCAmJiB2YWwgIT09ICcnKSB8fCBpc0Zvb3RlciB8fCB0aGlzLmNlbGxJc1JlYWRPbmx5KGNvbCwgcm93RGF0YSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jZWxsLXRleHQtYm94Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzcGFuICYmIHNwYW4uY2xhc3NOYW1lLmluZGV4T2YoJ2NlbGwtZW1wdHknKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGFuLmNsYXNzTmFtZSA9IHNwYW4uY2xhc3NOYW1lLnJlcGxhY2UoJ2NlbGwtZW1wdHknLCAnICcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jZWxsLXRleHQtYm94Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4gJiYgc3Bhbi5jbGFzc05hbWUuaW5kZXhPZignY2VsbC1lbXB0eScpID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzcGFuLmNsYXNzTmFtZSA9IHNwYW4uY2xhc3NOYW1lICsgJyBjZWxsLWVtcHR5JztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gVXRpbHMuZ2V0V2hlbkVtcHR5VGV4dChjb2wsIHRoaXMubG9jYWxlSWQpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldERhdGFncmlkSW5zdGFuY2UoKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmRhdGFHcmlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YUdyaWQgPSB0aGlzLmluamVjdG9yLmdldChEYXRhZ3JpZENvbXBvbmVudCwgbnVsbCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXRoaXMuZWxSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5lbFJlZiA9IHRoaXMuaW5qZWN0b3IuZ2V0KEVsZW1lbnRSZWYsIG51bGwpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjZWxsSXNSZWFkT25seShjb2w6IERhdGFDb2x1bW4sIHJvd0RhdGEpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5kYXRhR3JpZC5jZWxsSXNSZWFkT25seShjb2wsIHJvd0RhdGEpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==