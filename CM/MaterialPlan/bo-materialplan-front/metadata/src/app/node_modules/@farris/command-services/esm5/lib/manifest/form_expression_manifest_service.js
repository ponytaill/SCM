import { HttpClient } from "@angular/common/http";
import { Inject, Injectable, Injector } from "@angular/core";
import { of } from "rxjs";
import { share, switchMap } from "rxjs/operators";
import { FORM_PATH_TOKEN, FrameContext, FORM_MANIFEST_SERVICE_TOKEN } from "@farris/devkit";
var FormExpressionManifestService = /** @class */ (function () {
    function FormExpressionManifestService(injector, frameContext, httpClient, modulePath, formManifestService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.httpClient = httpClient;
        this.modulePath = modulePath;
        this.formManifestService = formManifestService;
    }
    FormExpressionManifestService.prototype.load = function () {
        var _this = this;
        if (this.modulePath.endsWith('\/')) {
            this.modulePath = this.modulePath.substring(0, this.modulePath.length - 1);
        }
        return this.formManifestService.load().pipe(switchMap(function (formManifest) {
            var expressions = formManifest.expressions;
            var expressionManifest = expressions.find(function (expressionManifest) { return expressionManifest.ns === _this.frameContext.namespace; });
            if (expressionManifest) {
                var expressionPath = _this.modulePath + "/expressions/" + expressionManifest.path + "?version=" + new Date().valueOf().toString();
                var key = _this.modulePath + "/expressions/" + expressionManifest.path;
                var request$ = FormExpressionManifestService.mainfests.get(key);
                if (request$) {
                    return request$;
                }
                else {
                    var req$ = _this.httpClient.get(expressionPath, { responseType: 'json' }).pipe(share());
                    FormExpressionManifestService.mainfests.set(key, req$);
                    return req$;
                }
            }
            else {
                return of({});
            }
        }));
    };
    FormExpressionManifestService.mainfests = new Map();
    FormExpressionManifestService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FormExpressionManifestService.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: HttpClient },
        { type: undefined, decorators: [{ type: Inject, args: [FORM_PATH_TOKEN,] }] },
        { type: undefined, decorators: [{ type: Inject, args: [FORM_MANIFEST_SERVICE_TOKEN,] }] }
    ]; };
    return FormExpressionManifestService;
}());
export { FormExpressionManifestService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybV9leHByZXNzaW9uX21hbmlmZXN0X3NlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbWFuaWZlc3QvZm9ybV9leHByZXNzaW9uX21hbmlmZXN0X3NlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxZQUFZLEVBQXlFLDJCQUEyQixFQUF3QixNQUFNLGdCQUFnQixDQUFDO0FBRXpMO0lBR0UsdUNBQ1UsUUFBa0IsRUFDbEIsWUFBMEIsRUFDMUIsVUFBc0IsRUFDRyxVQUFVLEVBQ0UsbUJBQXlDO1FBSjlFLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUNHLGVBQVUsR0FBVixVQUFVLENBQUE7UUFDRSx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXNCO0lBQUksQ0FBQztJQUV0Riw0Q0FBSSxHQUFYO1FBQUEsaUJBeUJDO1FBeEJDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbEMsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDNUU7UUFFRCxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLENBQ3pDLFNBQVMsQ0FBQyxVQUFDLFlBQTBCO1lBQ25DLElBQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7WUFDN0MsSUFBTSxrQkFBa0IsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLFVBQUMsa0JBQTJDLElBQUssT0FBQSxrQkFBa0IsQ0FBQyxFQUFFLEtBQUssS0FBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQXJELENBQXFELENBQUMsQ0FBQztZQUNwSixJQUFJLGtCQUFrQixFQUFFO2dCQUN0QixJQUFNLGNBQWMsR0FBTSxLQUFJLENBQUMsVUFBVSxxQkFBZ0Isa0JBQWtCLENBQUMsSUFBSSxpQkFBWSxJQUFJLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsRUFBSSxDQUFDO2dCQUM5SCxJQUFNLEdBQUcsR0FBTSxLQUFJLENBQUMsVUFBVSxxQkFBZ0Isa0JBQWtCLENBQUMsSUFBTSxDQUFDO2dCQUN4RSxJQUFNLFFBQVEsR0FBRyw2QkFBNkIsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNsRSxJQUFJLFFBQVEsRUFBRTtvQkFDWixPQUFPLFFBQVEsQ0FBQztpQkFDakI7cUJBQU07b0JBQ0wsSUFBTSxJQUFJLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7b0JBQ3pGLDZCQUE2QixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN2RCxPQUFPLElBQUksQ0FBQztpQkFDYjthQUNGO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ2Y7UUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQWpDYyx1Q0FBUyxHQUFHLElBQUksR0FBRyxFQUEyQixDQUFDOztnQkFGL0QsVUFBVTs7OztnQkFMa0IsUUFBUTtnQkFHWCxZQUFZO2dCQUo3QixVQUFVO2dEQWFkLE1BQU0sU0FBQyxlQUFlO2dEQUN0QixNQUFNLFNBQUMsMkJBQTJCOztJQTRCdkMsb0NBQUM7Q0FBQSxBQXBDRCxJQW9DQztTQW5DWSw2QkFBNkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50IH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vbi9odHRwXCI7XHJcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IHNoYXJlLCBzd2l0Y2hNYXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcclxuaW1wb3J0IHsgRk9STV9QQVRIX1RPS0VOLCBGcmFtZUNvbnRleHQsIEZvcm1FeHByZXNzaW9uc01hbmlmZXN0LCBGb3JtTWFuaWZlc3QsIElGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZSwgRk9STV9NQU5JRkVTVF9TRVJWSUNFX1RPS0VOLCBJRm9ybU1hbmlmZXN0U2VydmljZSB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2UgaW1wbGVtZW50cyBJRm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2Uge1xyXG4gIHByaXZhdGUgc3RhdGljIG1haW5mZXN0cyA9IG5ldyBNYXA8c3RyaW5nLCBPYnNlcnZhYmxlPGFueT4+KCk7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIGh0dHBDbGllbnQ6IEh0dHBDbGllbnQsXHJcbiAgICBASW5qZWN0KEZPUk1fUEFUSF9UT0tFTikgcHJpdmF0ZSBtb2R1bGVQYXRoLFxyXG4gICAgQEluamVjdChGT1JNX01BTklGRVNUX1NFUlZJQ0VfVE9LRU4pIHByaXZhdGUgZm9ybU1hbmlmZXN0U2VydmljZTogSUZvcm1NYW5pZmVzdFNlcnZpY2UpIHsgfVxyXG5cclxuICBwdWJsaWMgbG9hZCgpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKHRoaXMubW9kdWxlUGF0aC5lbmRzV2l0aCgnXFwvJykpIHtcclxuICAgICAgdGhpcy5tb2R1bGVQYXRoID0gdGhpcy5tb2R1bGVQYXRoLnN1YnN0cmluZygwLCB0aGlzLm1vZHVsZVBhdGgubGVuZ3RoIC0gMSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZm9ybU1hbmlmZXN0U2VydmljZS5sb2FkKCkucGlwZShcclxuICAgICAgc3dpdGNoTWFwKChmb3JtTWFuaWZlc3Q6IEZvcm1NYW5pZmVzdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGV4cHJlc3Npb25zID0gZm9ybU1hbmlmZXN0LmV4cHJlc3Npb25zO1xyXG4gICAgICAgIGNvbnN0IGV4cHJlc3Npb25NYW5pZmVzdCA9IGV4cHJlc3Npb25zLmZpbmQoKGV4cHJlc3Npb25NYW5pZmVzdDogRm9ybUV4cHJlc3Npb25zTWFuaWZlc3QpID0+IGV4cHJlc3Npb25NYW5pZmVzdC5ucyA9PT0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlKTtcclxuICAgICAgICBpZiAoZXhwcmVzc2lvbk1hbmlmZXN0KSB7XHJcbiAgICAgICAgICBjb25zdCBleHByZXNzaW9uUGF0aCA9IGAke3RoaXMubW9kdWxlUGF0aH0vZXhwcmVzc2lvbnMvJHtleHByZXNzaW9uTWFuaWZlc3QucGF0aH0/dmVyc2lvbj0ke25ldyBEYXRlKCkudmFsdWVPZigpLnRvU3RyaW5nKCl9YDtcclxuICAgICAgICAgIGNvbnN0IGtleSA9IGAke3RoaXMubW9kdWxlUGF0aH0vZXhwcmVzc2lvbnMvJHtleHByZXNzaW9uTWFuaWZlc3QucGF0aH1gO1xyXG4gICAgICAgICAgY29uc3QgcmVxdWVzdCQgPSBGb3JtRXhwcmVzc2lvbk1hbmlmZXN0U2VydmljZS5tYWluZmVzdHMuZ2V0KGtleSk7XHJcbiAgICAgICAgICBpZiAocmVxdWVzdCQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcXVlc3QkO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgcmVxJCA9IHRoaXMuaHR0cENsaWVudC5nZXQoZXhwcmVzc2lvblBhdGgsIHsgcmVzcG9uc2VUeXBlOiAnanNvbicgfSkucGlwZShzaGFyZSgpKTtcclxuICAgICAgICAgICAgRm9ybUV4cHJlc3Npb25NYW5pZmVzdFNlcnZpY2UubWFpbmZlc3RzLnNldChrZXksIHJlcSQpO1xyXG4gICAgICAgICAgICByZXR1cm4gcmVxJDtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKHt9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxufSJdfQ==