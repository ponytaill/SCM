import { Inject, Injectable, LOCALE_ID, Optional } from '@angular/core';
import { from } from 'rxjs';
import { MessagerService } from '@farris/ui-messager';
import { LanguageService } from './languag.service';
import { ExceptionFactory } from './error/index';
/**
 * 表单消息服务
 * @scope FormModule
 * @summary
 * 1、包装@farris/ui的消息服务；
 * 2、提供针对表单的快捷方法；
 */
class FormMessageService {
    /**
     * 构造函数
     * 注入@farris/ui的LoadingService
     */
    constructor(messagerService, languageService, curLanguage) {
        this.messagerService = messagerService;
        this.languageService = languageService;
        this.curLanguage = curLanguage;
        this.languageService = this.languageService || LanguageService.getInstance();
    }
    /**
     * question弹窗
     */
    question(content) {
        const confirmResult$ = this.confirmPromise(content);
        return from(confirmResult$);
    }
    /**
     * 带默认焦点的弹出提示
     * @param content 内容
     */
    question2(content) {
        const promise$ = new Promise((resolve, reject) => {
            const dialogRef = this.messagerService.question2(content, [
                {
                    text: this.languageService.no,
                    cls: 'btn btn-secondary',
                    handle: () => {
                        resolve(false);
                        dialogRef.close();
                    }
                },
                {
                    text: this.languageService.yes,
                    cls: 'btn btn-primary',
                    defaultFocus: true,
                    handle: () => {
                        resolve(true);
                        dialogRef.close();
                    }
                }
            ]);
        });
        return from(promise$);
    }
    /**
     * 弹出输入对话框
     * @param title 标题
     */
    prompt(title) {
        return this.messagerService.prompt(title);
    }
    /**
     * 使用Promise实例包装回调方法，以同步回调方法执行后结果
     * @param content
     */
    confirmPromise(content) {
        return new Promise((resolve, reject) => {
            this.messagerService.question(content, () => { resolve(true); }, () => { resolve(false); });
        });
    }
    /**
     * 确认弹框
     * @param content 弹出内容提示
     */
    confirm(content) {
        return this.messagerService.confirm(content);
    }
    /**
     * 消息弹框
     */
    info(content) {
        this.messagerService.info(content);
    }
    /**
     * 错误弹框
     */
    error(content) {
        this.messagerService.error(content);
    }
    /**
     * 警告弹框
     */
    warning(content) {
        this.messagerService.warning(content);
    }
    /**
     * 服务器端异常提示弹框
     */
    httpErrorInServer(httpError) {
        let error = httpError.error;
        if (typeof (error) === 'string') {
            try {
                error = JSON.parse(error);
            }
            catch (e) { }
        }
        if (!error || error.Level == null || error.Level == undefined) { // 未封装error或未设置异常等级
            this.messagerService.error(httpError.message);
            return;
        }
        const exceptionStrategy = ExceptionFactory.getInstance(this.messagerService, this.languageService).getExceptionHandleStrategy(error.Level);
        exceptionStrategy.handleException(error);
    }
    /**
     * 客户端异常提示弹框
     */
    httpErrorInClient(httpError) {
        if (!httpError) {
            return;
        }
        const message = httpError.error && httpError.error.error && httpError.error.error.message;
        const exceptionMsg = message || httpError.message && httpError.message.replace(/http:\/\/[a-zA-Z0-9.:]{1,}/, '');
        const options = {
            // title: this.languageService.clientNotifyTitle,
            // showMaxButton: true,
            showHeader: false,
            width: 400,
            height: 200,
            safeHtml: false
        };
        this.messagerService.show('error', exceptionMsg, options);
    }
    /**
     * 401异常处理
     * 为了独立弹出重新登录提示框，切换到运行框架http服务后可以删除
     * @param httpError 异常
     */
    http401Error(httpError) {
        const dialogShownKey = '401ErrorShownFlag';
        if (!httpError || window[dialogShownKey]) {
            return;
        }
        const i18n = {
            en: {
                title: 'Warning',
                sessionInvalid: 'Your login has expired, please login again.',
                ok: 'ok',
                cancel: 'cancel'
            },
            'zh-CHS': {
                title: '提示',
                sessionInvalid: '用户登录信息已失效，是否重新登录?',
                ok: '确认',
                cancel: '取消'
            }
        };
        this.curLanguage = this.curLanguage || 'zh-CHS';
        const messageOptions = {
            title: i18n[this.curLanguage].title,
            initialState: {
                okText: i18n[this.curLanguage].ok,
                okHandle: () => {
                    modalRef.close();
                    window[dialogShownKey] = false;
                    const eventResult = httpError && httpError.error || {};
                    const redirectUri = eventResult.redirect_uri || '/login.html';
                    window.location.href = `/logout.html#?logout-before-redirect=true&loginUri=${redirectUri}`;
                },
                cancelText: i18n[this.curLanguage].cancel,
                cancelHandle: () => {
                    modalRef.close();
                    window[dialogShownKey] = false;
                }
            },
            showHeader: true,
            width: 420,
            height: 180,
            fitContent: false
        };
        const modalRef = this.messagerService.show('question', i18n[this.curLanguage].sessionInvalid, messageOptions);
        window[dialogShownKey] = true;
        if (modalRef && modalRef.dialog && modalRef.dialog.instance.closed) {
            modalRef.dialog.instance.closed.subscribe(() => {
                window[dialogShownKey] = false;
            });
        }
    }
}
FormMessageService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FormMessageService.ctorParameters = () => [
    { type: MessagerService },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] }
];
export { FormMessageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1tZXNzYWdlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZm9ybS1tZXNzYWdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV4RSxPQUFPLEVBQTJCLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFdEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBeUIsZ0JBQWdCLEVBQXNCLE1BQU0sZUFBZSxDQUFDO0FBRzVGOzs7Ozs7R0FNRztBQUNILE1BQ00sa0JBQWtCO0lBRXRCOzs7T0FHRztJQUNILFlBQ1UsZUFBZ0MsRUFDcEIsZUFBZ0MsRUFDekIsV0FBbUI7UUFGdEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ3BCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUN6QixnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUU5QyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLElBQUksZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQy9FLENBQUM7SUFDRDs7T0FFRztJQUNJLFFBQVEsQ0FBQyxPQUFlO1FBQzdCLE1BQU0sY0FBYyxHQUFxQixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3RFLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzlCLENBQUM7SUFFRDs7O09BR0c7SUFDSSxTQUFTLENBQUMsT0FBZTtRQUM5QixNQUFNLFFBQVEsR0FBcUIsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDakUsTUFBTSxTQUFT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QUFDLENBQUM7UUFDOUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUM5QixJQUFJLFFBQVEsSUFBSSxRQUFRLENBQUMsTUFBTSxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtZQUNsRSxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtnQkFDN0MsTUFBTSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEtBQUssQ0FBQztZQUNqQyxDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQzs7O1lBeE1GLFVBQVU7Ozs7WUFiRixlQUFlO1lBRWYsZUFBZSx1QkFvQm5CLFFBQVE7eUNBQ1IsTUFBTSxTQUFDLFNBQVM7O0FBa01yQixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgTE9DQUxFX0lELCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBvZiwgZnJvbSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tZXNzYWdlcic7XG5pbXBvcnQgeyBmcm9tUHJvbWlzZSB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS9mcm9tUHJvbWlzZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XG5pbXBvcnQgeyBTZXJ2ZXJFeGNlcHRpb25FbnRpdHksIEV4Y2VwdGlvbkZhY3RvcnksIElFeGNlcHRpb25TdHJhdGVneSB9IGZyb20gJy4vZXJyb3IvaW5kZXgnO1xuaW1wb3J0IHsgQnNNb2RhbFJlZiB9IGZyb20gJ0BmYXJyaXMvdWktbW9kYWwnO1xuXG4vKipcbiAqIOihqOWNlea2iOaBr+acjeWKoVxuICogQHNjb3BlIEZvcm1Nb2R1bGVcbiAqIEBzdW1tYXJ5XG4gKiAx44CB5YyF6KOFQGZhcnJpcy91aeeahOa2iOaBr+acjeWKoe+8m1xuICogMuOAgeaPkOS+m+mSiOWvueihqOWNleeahOW/q+aNt+aWueazle+8m1xuICovXG5ASW5qZWN0YWJsZSgpXG5jbGFzcyBGb3JtTWVzc2FnZVNlcnZpY2Uge1xuXG4gIC8qKlxuICAgKiDmnoTpgKDlh73mlbBcbiAgICog5rOo5YWlQGZhcnJpcy91aeeahExvYWRpbmdTZXJ2aWNlXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG1lc3NhZ2VyU2VydmljZTogTWVzc2FnZXJTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXG4gICAgQEluamVjdChMT0NBTEVfSUQpIHByaXZhdGUgY3VyTGFuZ3VhZ2U6IHN0cmluZywgLy8g5Li65LqG54us56uL5by55Ye66YeN5paw55m75b2V5o+Q56S65qGG77yM5YiH5o2i5Yiw6L+Q6KGM5qGG5p62aHR0cOacjeWKoeWQjuWPr+S7peWIoOmZpFxuICApIHtcbiAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IHRoaXMubGFuZ3VhZ2VTZXJ2aWNlIHx8IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICB9XG4gIC8qKlxuICAgKiBxdWVzdGlvbuW8ueeql1xuICAgKi9cbiAgcHVibGljIHF1ZXN0aW9uKGNvbnRlbnQ6IHN0cmluZyk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGNvbmZpcm1SZXN1bHQkOiBQcm9taXNlPGJvb2xlYW4+ID0gdGhpcy5jb25maXJtUHJvbWlzZShjb250ZW50KTtcbiAgICByZXR1cm4gZnJvbShjb25maXJtUmVzdWx0JCk7XG4gIH1cblxuICAvKipcbiAgICog5bim6buY6K6k54Sm54K555qE5by55Ye65o+Q56S6XG4gICAqIEBwYXJhbSBjb250ZW50IOWGheWuuVxuICAgKi9cbiAgcHVibGljIHF1ZXN0aW9uMihjb250ZW50OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBwcm9taXNlJDogUHJvbWlzZTxib29sZWFuPiA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGNvbnN0IGRpYWxvZ1JlZiA9IHRoaXMubWVzc2FnZXJTZXJ2aWNlLnF1ZXN0aW9uMihcbiAgICAgICAgY29udGVudCxcbiAgICAgICAgW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHRleHQ6IHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vLFxuICAgICAgICAgICAgY2xzOiAnYnRuIGJ0bi1zZWNvbmRhcnknLFxuICAgICAgICAgICAgaGFuZGxlOiAoKSA9PiB7XG4gICAgICAgICAgICAgIHJlc29sdmUoZmFsc2UpO1xuICAgICAgICAgICAgICBkaWFsb2dSZWYuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9LFxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHRleHQ6IHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnllcyxcbiAgICAgICAgICAgIGNsczogJ2J0biBidG4tcHJpbWFyeScsXG4gICAgICAgICAgICBkZWZhdWx0Rm9jdXM6IHRydWUsXG4gICAgICAgICAgICBoYW5kbGU6ICgpID0+IHtcbiAgICAgICAgICAgICAgcmVzb2x2ZSh0cnVlKTtcbiAgICAgICAgICAgICAgZGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICBdKTtcbiAgICB9KTtcbiAgICByZXR1cm4gZnJvbShwcm9taXNlJCk7XG4gIH1cblxuICAvKipcbiAgICog5by55Ye66L6T5YWl5a+56K+d5qGGXG4gICAqIEBwYXJhbSB0aXRsZSDmoIfpophcbiAgICovXG4gIHB1YmxpYyBwcm9tcHQodGl0bGU6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMubWVzc2FnZXJTZXJ2aWNlLnByb21wdCh0aXRsZSk7XG4gIH1cblxuICAvKipcbiAgICog5L2/55SoUHJvbWlzZeWunuS+i+WMheijheWbnuiwg+aWueazle+8jOS7peWQjOatpeWbnuiwg+aWueazleaJp+ihjOWQjue7k+aenFxuICAgKiBAcGFyYW0gY29udGVudFxuICAgKi9cbiAgcHJpdmF0ZSBjb25maXJtUHJvbWlzZShjb250ZW50OiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5tZXNzYWdlclNlcnZpY2UucXVlc3Rpb24oXG4gICAgICAgIGNvbnRlbnQsXG4gICAgICAgICgpID0+IHsgcmVzb2x2ZSh0cnVlKTsgfSxcbiAgICAgICAgKCkgPT4geyByZXNvbHZlKGZhbHNlKTsgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDnoa7orqTlvLnmoYZcbiAgICogQHBhcmFtIGNvbnRlbnQg5by55Ye65YaF5a655o+Q56S6XG4gICAqL1xuICBwdWJsaWMgY29uZmlybShjb250ZW50OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5tZXNzYWdlclNlcnZpY2UuY29uZmlybShjb250ZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmtojmga/lvLnmoYZcbiAgICovXG4gIHB1YmxpYyBpbmZvKGNvbnRlbnQ6IHN0cmluZykge1xuICAgIHRoaXMubWVzc2FnZXJTZXJ2aWNlLmluZm8oY29udGVudCk7XG4gIH1cblxuICAvKipcbiAgICog6ZSZ6K+v5by55qGGXG4gICAqL1xuICBwdWJsaWMgZXJyb3IoY29udGVudDogc3RyaW5nKSB7XG4gICAgdGhpcy5tZXNzYWdlclNlcnZpY2UuZXJyb3IoY29udGVudCk7XG4gIH1cblxuICAvKipcbiAgICog6K2m5ZGK5by55qGGXG4gICAqL1xuICBwdWJsaWMgd2FybmluZyhjb250ZW50OiBzdHJpbmcpIHtcbiAgICB0aGlzLm1lc3NhZ2VyU2VydmljZS53YXJuaW5nKGNvbnRlbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIOacjeWKoeWZqOerr+W8guW4uOaPkOekuuW8ueahhlxuICAgKi9cbiAgcHVibGljIGh0dHBFcnJvckluU2VydmVyKGh0dHBFcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpOiB2b2lkIHtcbiAgICBsZXQgZXJyb3I6IFNlcnZlckV4Y2VwdGlvbkVudGl0eSA9IGh0dHBFcnJvci5lcnJvcjtcbiAgICBpZiAodHlwZW9mIChlcnJvcikgPT09ICdzdHJpbmcnKSB7XG4gICAgICB0cnkge1xuICAgICAgICBlcnJvciA9IEpTT04ucGFyc2UoZXJyb3IpO1xuICAgICAgfSBjYXRjaCAoZSkgeyB9XG4gICAgfVxuICAgIGlmICghZXJyb3IgfHwgZXJyb3IuTGV2ZWwgPT0gbnVsbCB8fCBlcnJvci5MZXZlbCA9PSB1bmRlZmluZWQpIHsgLy8g5pyq5bCB6KOFZXJyb3LmiJbmnKrorr7nva7lvILluLjnrYnnuqdcbiAgICAgIHRoaXMubWVzc2FnZXJTZXJ2aWNlLmVycm9yKGh0dHBFcnJvci5tZXNzYWdlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgZXhjZXB0aW9uU3RyYXRlZ3k6IElFeGNlcHRpb25TdHJhdGVneSA9IEV4Y2VwdGlvbkZhY3RvcnkuZ2V0SW5zdGFuY2UodGhpcy5tZXNzYWdlclNlcnZpY2UsIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlKS5nZXRFeGNlcHRpb25IYW5kbGVTdHJhdGVneShlcnJvci5MZXZlbCk7XG4gICAgZXhjZXB0aW9uU3RyYXRlZ3kuaGFuZGxlRXhjZXB0aW9uKGVycm9yKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlrqLmiLfnq6/lvILluLjmj5DnpLrlvLnmoYZcbiAgICovXG4gIHB1YmxpYyBodHRwRXJyb3JJbkNsaWVudChodHRwRXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKTogdm9pZCB7XG4gICAgaWYgKCFodHRwRXJyb3IpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgbWVzc2FnZSA9IGh0dHBFcnJvci5lcnJvciAmJiBodHRwRXJyb3IuZXJyb3IuZXJyb3IgJiYgaHR0cEVycm9yLmVycm9yLmVycm9yLm1lc3NhZ2U7XG4gICAgY29uc3QgZXhjZXB0aW9uTXNnID0gbWVzc2FnZSB8fCBodHRwRXJyb3IubWVzc2FnZSAmJiBodHRwRXJyb3IubWVzc2FnZS5yZXBsYWNlKC9odHRwOlxcL1xcL1thLXpBLVowLTkuOl17MSx9LywgJycpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICAvLyB0aXRsZTogdGhpcy5sYW5ndWFnZVNlcnZpY2UuY2xpZW50Tm90aWZ5VGl0bGUsXG4gICAgICAvLyBzaG93TWF4QnV0dG9uOiB0cnVlLFxuICAgICAgc2hvd0hlYWRlcjogZmFsc2UsXG4gICAgICB3aWR0aDogNDAwLFxuICAgICAgaGVpZ2h0OiAyMDAsXG4gICAgICBzYWZlSHRtbDogZmFsc2VcbiAgICB9O1xuXG4gICAgdGhpcy5tZXNzYWdlclNlcnZpY2Uuc2hvdygnZXJyb3InLCBleGNlcHRpb25Nc2csIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIDQwMeW8guW4uOWkhOeQhlxuICAgKiDkuLrkuobni6znq4vlvLnlh7rph43mlrDnmbvlvZXmj5DnpLrmoYbvvIzliIfmjaLliLDov5DooYzmoYbmnrZodHRw5pyN5Yqh5ZCO5Y+v5Lul5Yig6ZmkXG4gICAqIEBwYXJhbSBodHRwRXJyb3Ig5byC5bi4XG4gICAqL1xuICBwdWJsaWMgaHR0cDQwMUVycm9yKGh0dHBFcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpOiB2b2lkIHtcbiAgICBjb25zdCBkaWFsb2dTaG93bktleSA9ICc0MDFFcnJvclNob3duRmxhZyc7XG5cbiAgICBpZiAoIWh0dHBFcnJvciB8fCB3aW5kb3dbZGlhbG9nU2hvd25LZXldKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaTE4biA9IHtcbiAgICAgIGVuOiB7XG4gICAgICAgIHRpdGxlOiAnV2FybmluZycsXG4gICAgICAgIHNlc3Npb25JbnZhbGlkOiAnWW91ciBsb2dpbiBoYXMgZXhwaXJlZCwgcGxlYXNlIGxvZ2luIGFnYWluLicsXG4gICAgICAgIG9rOiAnb2snLFxuICAgICAgICBjYW5jZWw6ICdjYW5jZWwnXG4gICAgICB9LFxuICAgICAgJ3poLUNIUyc6IHtcbiAgICAgICAgdGl0bGU6ICfmj5DnpLonLFxuICAgICAgICBzZXNzaW9uSW52YWxpZDogJ+eUqOaIt+eZu+W9leS/oeaBr+W3suWkseaViO+8jOaYr+WQpumHjeaWsOeZu+W9lT8nLFxuICAgICAgICBvazogJ+ehruiupCcsXG4gICAgICAgIGNhbmNlbDogJ+WPlua2iCdcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMuY3VyTGFuZ3VhZ2UgPSB0aGlzLmN1ckxhbmd1YWdlIHx8ICd6aC1DSFMnO1xuXG4gICAgY29uc3QgbWVzc2FnZU9wdGlvbnMgPSB7XG4gICAgICB0aXRsZTogaTE4blt0aGlzLmN1ckxhbmd1YWdlXS50aXRsZSxcbiAgICAgIGluaXRpYWxTdGF0ZToge1xuICAgICAgICBva1RleHQ6IGkxOG5bdGhpcy5jdXJMYW5ndWFnZV0ub2ssXG4gICAgICAgIG9rSGFuZGxlOiAoKSA9PiB7XG4gICAgICAgICAgbW9kYWxSZWYuY2xvc2UoKTtcbiAgICAgICAgICB3aW5kb3dbZGlhbG9nU2hvd25LZXldID0gZmFsc2U7XG4gICAgICAgICAgY29uc3QgZXZlbnRSZXN1bHQgPSBodHRwRXJyb3IgJiYgaHR0cEVycm9yLmVycm9yIHx8IHt9O1xuICAgICAgICAgIGNvbnN0IHJlZGlyZWN0VXJpID0gZXZlbnRSZXN1bHQucmVkaXJlY3RfdXJpIHx8ICcvbG9naW4uaHRtbCc7XG4gICAgICAgICAgd2luZG93LmxvY2F0aW9uLmhyZWYgPSBgL2xvZ291dC5odG1sIz9sb2dvdXQtYmVmb3JlLXJlZGlyZWN0PXRydWUmbG9naW5Vcmk9JHtyZWRpcmVjdFVyaX1gO1xuICAgICAgICB9LFxuICAgICAgICBjYW5jZWxUZXh0OiBpMThuW3RoaXMuY3VyTGFuZ3VhZ2VdLmNhbmNlbCxcbiAgICAgICAgY2FuY2VsSGFuZGxlOiAoKSA9PiB7XG4gICAgICAgICAgbW9kYWxSZWYuY2xvc2UoKTtcbiAgICAgICAgICB3aW5kb3dbZGlhbG9nU2hvd25LZXldID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBzaG93SGVhZGVyOiB0cnVlLFxuICAgICAgd2lkdGg6IDQyMCxcbiAgICAgIGhlaWdodDogMTgwLFxuICAgICAgZml0Q29udGVudDogZmFsc2VcbiAgICB9O1xuICAgIGNvbnN0IG1vZGFsUmVmID0gdGhpcy5tZXNzYWdlclNlcnZpY2Uuc2hvdygncXVlc3Rpb24nLCBpMThuW3RoaXMuY3VyTGFuZ3VhZ2VdLnNlc3Npb25JbnZhbGlkLCBtZXNzYWdlT3B0aW9ucyk7XG4gICAgd2luZG93W2RpYWxvZ1Nob3duS2V5XSA9IHRydWU7XG4gICAgaWYgKG1vZGFsUmVmICYmIG1vZGFsUmVmLmRpYWxvZyAmJiBtb2RhbFJlZi5kaWFsb2cuaW5zdGFuY2UuY2xvc2VkKSB7XG4gICAgICBtb2RhbFJlZi5kaWFsb2cuaW5zdGFuY2UuY2xvc2VkLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHdpbmRvd1tkaWFsb2dTaG93bktleV0gPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG59XG5cbmV4cG9ydCB7IEZvcm1NZXNzYWdlU2VydmljZSB9O1xuXG4iXX0=