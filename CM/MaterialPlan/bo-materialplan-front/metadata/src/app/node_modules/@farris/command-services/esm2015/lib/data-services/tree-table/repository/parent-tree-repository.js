import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { FieldMetadataUtil } from '@farris/devkit';
/**
 * 父子树仓库
 */
class ParentTreeRepository {
    /**
     * 添加兄弟节点
     */
    addSibling(repository, id) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSiblingUri = `${baseUri}/service/parenthierarchycreatesibling`;
        const body = {
            dataID: id,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSiblingUri, 'PUT', null, options).pipe(map((responseInfo) => {
            const entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    }
    /**
     * 添加兄弟节点
     */
    addChild(repository, parentId) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addChildUri = `${baseUri}/service/parenthierarchycreatechildlayer`;
        const body = {
            dataID: parentId,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addChildUri, 'PUT', null, options).pipe(map((responseInfo) => {
            const entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    }
    /**
     * 添加子表兄弟节点
     */
    addSubSibling(repository, nodes, ids) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSubSiblingUri = `${baseUri}/service/childnodeparenthierarchycreatesibling`;
        const body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubSiblingUri, 'PUT', null, options).pipe(map((responseInfo) => {
            let path = this.getPaths(nodes, ids);
            const entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    }
    /**
     * 添加子表子节点
     */
    addSubChild(repository, nodes, ids) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const addSubChildUri = `${baseUri}/service/childnodeparenthierarchycreatechildlayer`;
        const body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubChildUri, 'PUT', null, options).pipe(map((responseInfo) => {
            let paths = this.getPaths(nodes, ids);
            const entity = repository.entityManager.appendEntityByPath(paths, responseInfo.returnValue);
            return entity;
        }));
    }
    getPaths(nodes, ids) {
        let paths = '';
        if (nodes && nodes.length > 0 && ids && ids.length > 0) {
            for (let i = 0; i < ids.length; i++) {
                if (nodes[i]) {
                    paths = paths + `/${ids[i]}`;
                    paths = paths + `/${nodes[i]}s`;
                }
            }
        }
        return paths;
    }
    /**
     * 加载父节点
     */
    // tslint:disable-next-line: max-line-length
    loadByParentId(repository, hierarchyInfoKey, parentId, filters, sorts, frozenCurrentRow = false, pagination, frameContext, reload = false) {
        const localEntities = this.getChildren(repository, hierarchyInfoKey, parentId);
        if (localEntities && localEntities.length > 0 && !reload) {
            return of(localEntities);
        }
        const restService = repository.restService;
        const parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        const originalHierarchyInfoKey = this.getOriginalHierarchyInfoKey(repository, hierarchyInfoKey);
        const filtersWithParent = this.buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filters);
        const isUsePagination = pagination && pagination.pageSize > 0 || false;
        // 组织EntityFilter
        const entityFilter = {
            FilterConditions: filtersWithParent,
            SortConditions: sorts,
            IsUsePagination: isUsePagination,
            Pagination: { PageIndex: pagination && pagination.pageIndex || 0, PageSize: pagination && pagination.pageSize || 0, PageCount: 0, TotalCount: 0 }
        };
        const requestInfo = restService.buildRequestInfo();
        return restService.extendQuery(entityFilter, requestInfo).pipe(map((responseInfo) => {
            const paginationInfo = this.getPaginationInfo(responseInfo);
            if (parentId) {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.params.set(`_NODE_${parentId}_PAGINATION_INFO_`, paginationInfo);
                }
            }
            else {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.repository.entityCollection.updatePaginationInfoByPath('/', paginationInfo);
                }
            }
            // 先清空下级实体
            this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            const listData = responseInfo.returnValue.result;
            const entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities);
            }
            else {
                repository.entityCollection.addEntities(entities);
            }
            return entities;
        }));
    }
    // tslint:disable-next-line: max-line-length
    loadFullTree(repository, hierarchyInfoKey, parentId, propertyName, fullTreeType, loadType, filters, context) {
        const restService = repository.restService;
        const baseUri = restService.baseUri;
        const queryUrl = `${baseUri}/service/parentidfulltreequery`;
        const parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        const entityFilter = this.buildEntityFilter(filters, null, 0, 0);
        const body = {
            dataId: parentId || '',
            isUsePagination: false,
            virtualPropertyName: propertyName,
            pagination: {},
            fullTreeType,
            loadType,
            filter: entityFilter,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(queryUrl, 'PUT', null, options).pipe(tap((responseInfo) => {
            // 保存展开的节点
            if (responseInfo.returnValue && responseInfo.returnValue.selectedRowId && context && context.frameContext) {
                const frameContext = context.frameContext;
                const virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext() || null;
                if (virtualRootFrameContext) {
                    const list = responseInfo.returnValue.result;
                    const selectedRowId = responseInfo.returnValue.selectedRowId;
                    // 从顶层开始计算所有需要展开的节点
                    const leafNodeInfo = list.find(item => item[repository.primaryKey] === selectedRowId);
                    const hierarchyInfo = leafNodeInfo[hierarchyInfoKey];
                    const ids = this.getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository);
                    virtualRootFrameContext.params.set('_DEVKIT_expandRowIds', ids.join(','));
                    virtualRootFrameContext.params.set('_DEVKIT_selectedRowId', selectedRowId);
                    virtualRootFrameContext.uiState.setPropertyValue('__DEVKIT__selectedRow', selectedRowId);
                }
            }
        }), map((responseInfo) => {
            const frozenCurrentRow = context && context.frozenCurrentRow || false;
            // 先清空下级实体
            this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            const listData = responseInfo.returnValue.result;
            const entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities);
            }
            else {
                repository.entityCollection.addEntities(entities);
            }
            return entities;
        }));
    }
    /**
     * 插入对父节点的过滤
     */
    buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filterArray) {
        const relationType = filterArray && filterArray.length >= 1 ? 1 : 0;
        const parentLayer = parentHierarchyInfo ? parentHierarchyInfo['layer'] : 0;
        const parentElement = parentHierarchyInfo ? parentHierarchyInfo['id'] : '';
        const parentFilterArray = [
            {
                "FilterField": `${originalHierarchyInfoKey}.Layer`,
                "Value": parentLayer + 1,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": 1,
                "Expresstype": 0,
                "Compare": 0
            }
        ];
        if (parentElement) {
            parentFilterArray.push({
                "FilterField": `${originalHierarchyInfoKey}.ParentElement`,
                "Value": parentElement,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": relationType,
                "Expresstype": 0,
                "Compare": 0
            });
        }
        else {
            parentFilterArray[0].Relation = relationType;
        }
        return parentFilterArray.concat(filterArray);
    }
    buildEntityFilter(filter, sort, pageSize, pageIndex) {
        // @todo：临时兼容老代码，降低改动带来的风险
        if (!filter && !sort && !pageSize && !pageIndex) {
            return null;
        }
        if (!filter) {
            filter = [];
        }
        if (!sort) {
            sort = [];
        }
        // 纠正最后一个过滤条件的Relation
        if (filter && filter.length > 0) {
            filter[filter.length - 1].Relation = 0;
        }
        const entityFilter = {
            FilterConditions: filter,
            SortConditions: sort,
            IsUsePagination: pageSize === 0 ? false : true,
            Pagination: {
                PageIndex: pageIndex,
                PageSize: pageSize,
                PageCount: 0,
                TotalCount: 0
            }
        };
        return entityFilter;
    }
    /**
     * 清空后代实体
     * @description parentHierarchyInfo中layer为要清空后代节点的layer，但里面的parentElement不是父级的id，而是要清空后代节点的id
     */
    clearDescendantEntities(repository, hierarchyInfokey, parentHierarchyInfo, frozenCurrentRow = false) {
        // 清空根节点
        if (!parentHierarchyInfo) {
            repository.entityCollection.clear();
            return;
        }
        const nodes = this.getChildNodes(repository, hierarchyInfokey, parentHierarchyInfo);
        if (frozenCurrentRow) {
            repository.entityCollection.removeEntities((entity) => {
                const id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
        else {
            repository.entityCollection.removeData((entity) => {
                const id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
    }
    /**
     * 获取某个节点的所有子节点
     * @param repository repository
     * @param hierarchyInfokey hierarchyInfokey
     * @param parentHierarchyInfo parentHierarchyInfo
     */
    getChildNodes(repository, hierarchyInfokey, parentHierarchyInfo) {
        const fparentElement = parentHierarchyInfo.id;
        const flayer = parentHierarchyInfo.layer;
        let nodes = [];
        repository.entityCollection.getAllEntities().forEach(entity => {
            const hierarchyInfo = entity[hierarchyInfokey];
            const parentElement = hierarchyInfo.parentElement;
            const layer = hierarchyInfo.layer;
            const result = layer >= (flayer + 1) && parentElement === fparentElement;
            if (result) {
                const id = entity[entity.primaryKey];
                nodes.push(id);
                const childHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfokey, id);
                const childs = this.getChildNodes(repository, hierarchyInfokey, childHierarchyInfo);
                if (childs && childs.length > 0) {
                    nodes = nodes.concat(childs);
                }
            }
        });
        return nodes;
    }
    /**
     * 获取实体的分级信息
     */
    getHierarchyInfoById(repository, hierarchyInfokey, id) {
        if (!id) {
            return null;
        }
        const entity = repository.entityCollection.getEntityById(id);
        const hierarchyInfoEntity = entity[hierarchyInfokey];
        const result = hierarchyInfoEntity.toJSON();
        result['id'] = id;
        return result;
    }
    getHierarchyInfo(entity, hierarchyInfokey) {
        return entity[hierarchyInfokey];
    }
    /**
     * 获取分级码的原始的字段名
     */
    getOriginalHierarchyInfoKey(repository, hierarchyInfokey) {
        const ngObjects = FieldMetadataUtil.getNgObjects(repository.entityType);
        const hierarchyInfoNgObject = ngObjects[hierarchyInfokey];
        return hierarchyInfoNgObject.originalDataField;
    }
    getPaginationInfo(responseInfo) {
        return responseInfo && responseInfo.returnValue && responseInfo.returnValue.pagination || null;
    }
    findParent(hierarchyInfo, list, hierarchyInfoKey) {
        return list.find(item => {
            const currentHierarchyInfo = item[hierarchyInfoKey];
            return currentHierarchyInfo.layer === hierarchyInfo.layer - 1 && hierarchyInfo.parentElement === currentHierarchyInfo.parentElement;
        });
    }
    getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository) {
        let item = this.findParent(hierarchyInfo, list, hierarchyInfoKey);
        const ids = [];
        while (item) {
            ids.push(item[repository.primaryKey]);
            item = this.findParent(item[hierarchyInfoKey], list, hierarchyInfoKey);
        }
        return ids;
    }
    /**
     * 查找节点下所有子级（第一级）
     * @param repository repository
     * @param hierarchyInfoKey 分级码字段
     * @param id id
     * @returns
     */
    getChildren(repository, hierarchyInfoKey, id) {
        const hierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, id);
        if (!hierarchyInfo) {
            return null;
        }
        const layer = hierarchyInfo.layer;
        const parentElement = hierarchyInfo.parentElement;
        const entities = repository.entityCollection.getEntities((entity) => {
            const hierarchyInfo = this.getHierarchyInfo(entity, hierarchyInfoKey);
            const matched = hierarchyInfo.layer === layer + 1 && (hierarchyInfo.parentElement === parentElement || !parentElement && !hierarchyInfo.parentElement);
            if (matched) {
                return entity;
            }
            else {
                return null;
            }
        });
        return entities;
    }
}
export { ParentTreeRepository };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyZW50LXRyZWUtcmVwb3NpdG9yeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3RyZWUtdGFibGUvcmVwb3NpdG9yeS9wYXJlbnQtdHJlZS1yZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsRUFBRSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFVLGlCQUFpQixFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBR3JGOztHQUVHO0FBQ0gsTUFBTSxvQkFBb0I7SUFFeEI7O09BRUc7SUFDSSxVQUFVLENBQUMsVUFBaUMsRUFBRSxFQUFVO1FBQzdELE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxNQUFNLGFBQWEsR0FBRyxHQUFHLE9BQU8sdUNBQXVDLENBQUM7UUFDeEUsTUFBTSxJQUFJLEdBQUc7WUFDWCxNQUFNLEVBQUUsRUFBRTtZQUNWLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsT0FBTyxFQUFFLElBQUksV0FBVyxDQUFDLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLENBQUM7WUFDaEUsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDakUsR0FBRyxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFO1lBQ2pD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LE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztZQUN0RSxNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsS0FBSyxLQUFLLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxLQUFLLGFBQWEsSUFBSSxDQUFDLGFBQWEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUN2SixJQUFJLE9BQU8sRUFBRTtnQkFDWCxPQUFPLE1BQU0sQ0FBQzthQUNmO2lCQUFNO2dCQUNMLE9BQU8sSUFBSSxDQUFDO2FBQ2I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7Q0FDRjtBQUVELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBvZiwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBFbnRpdHksIEZpZWxkTWV0YWRhdGFVdGlsLCBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBSZXNwb25zZUluZm8sIEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XG5cbi8qKlxuICog54i25a2Q5qCR5LuT5bqTXG4gKi9cbmNsYXNzIFBhcmVudFRyZWVSZXBvc2l0b3J5IHtcblxuICAvKipcbiAgICog5re75Yqg5YWE5byf6IqC54K5XG4gICAqL1xuICBwdWJsaWMgYWRkU2libGluZyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcbiAgICBjb25zdCBhZGRTaWJsaW5nVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9wYXJlbnRoaWVyYXJjaHljcmVhdGVzaWJsaW5nYDtcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgZGF0YUlEOiBpZCxcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRTaWJsaW5nVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5idWlsZEVudGl0eShyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpO1xuICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXR5KGVudGl0eSk7XG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICog5re75Yqg5YWE5byf6IqC54K5XG4gICAqL1xuICBwdWJsaWMgYWRkQ2hpbGQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBwYXJlbnRJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IGFkZENoaWxkVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9wYXJlbnRoaWVyYXJjaHljcmVhdGVjaGlsZGxheWVyYDtcblxuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBkYXRhSUQ6IHBhcmVudElkLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXG4gICAgICBib2R5OiBib2R5XG4gICAgfTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZENoaWxkVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5idWlsZEVudGl0eShyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpO1xuICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXR5KGVudGl0eSk7XG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICog5re75Yqg5a2Q6KGo5YWE5byf6IqC54K5XG4gICAqL1xuICBwdWJsaWMgYWRkU3ViU2libGluZyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIG5vZGVzOiBBcnJheTxzdHJpbmc+LCBpZHM6IEFycmF5PHN0cmluZz4pOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcbiAgICBjb25zdCBhZGRTdWJTaWJsaW5nVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9jaGlsZG5vZGVwYXJlbnRoaWVyYXJjaHljcmVhdGVzaWJsaW5nYDtcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgbm9kZXM6IG5vZGVzLFxuICAgICAgaWRzOiBpZHMsXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcbiAgICAgIGJvZHk6IGJvZHlcbiAgICB9O1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkU3ViU2libGluZ1VyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgIGxldCBwYXRoID0gdGhpcy5nZXRQYXRocyhub2RlcywgaWRzKTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmFwcGVuZEVudGl0eUJ5UGF0aChwYXRoLCByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUpXG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICog5re75Yqg5a2Q6KGo5a2Q6IqC54K5XG4gICAqL1xuICBwdWJsaWMgYWRkU3ViQ2hpbGQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBub2RlczogQXJyYXk8c3RyaW5nPiwgaWRzOiBBcnJheTxzdHJpbmc+KSB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IGFkZFN1YkNoaWxkVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9jaGlsZG5vZGVwYXJlbnRoaWVyYXJjaHljcmVhdGVjaGlsZGxheWVyYDtcblxuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBub2Rlczogbm9kZXMsXG4gICAgICBpZHM6IGlkcyxcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRTdWJDaGlsZFVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgIGxldCBwYXRocyA9IHRoaXMuZ2V0UGF0aHMobm9kZXMsIGlkcyk7XG4gICAgICAgIGNvbnN0IGVudGl0eSA9IHJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5hcHBlbmRFbnRpdHlCeVBhdGgocGF0aHMsIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSk7XG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFBhdGhzKG5vZGVzOiBzdHJpbmdbXSwgaWRzOiBzdHJpbmdbXSkge1xuICAgIGxldCBwYXRocyA9ICcnO1xuICAgIGlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGggPiAwICYmIGlkcyAmJiBpZHMubGVuZ3RoID4gMCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpZHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKG5vZGVzW2ldKSB7XG4gICAgICAgICAgcGF0aHMgPSBwYXRocyArIGAvJHtpZHNbaV19YDtcbiAgICAgICAgICBwYXRocyA9IHBhdGhzICsgYC8ke25vZGVzW2ldfXNgO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBwYXRocztcbiAgfVxuXG4gIC8qKlxuICAgKiDliqDovb3niLboioLngrlcbiAgICovXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXG4gIHB1YmxpYyBsb2FkQnlQYXJlbnRJZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcGFyZW50SWQ6IHN0cmluZywgZmlsdGVyczogYW55W10sIHNvcnRzOiBhbnlbXSwgZnJvemVuQ3VycmVudFJvdzogYm9vbGVhbiA9IGZhbHNlLCBwYWdpbmF0aW9uPzogeyBwYWdlU2l6ZTogbnVtYmVyLCBwYWdlSW5kZXg6IG51bWJlciB9LCBmcmFtZUNvbnRleHQ/OiBGcmFtZUNvbnRleHQsIHJlbG9hZDogYm9vbGVhbiA9IGZhbHNlKTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xuICAgIGNvbnN0IGxvY2FsRW50aXRpZXMgPSB0aGlzLmdldENoaWxkcmVuKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudElkKTtcbiAgICBpZiAobG9jYWxFbnRpdGllcyAmJiBsb2NhbEVudGl0aWVzLmxlbmd0aCA+IDAgJiYgIXJlbG9hZCkge1xuICAgICAgcmV0dXJuIG9mKGxvY2FsRW50aXRpZXMpO1xuICAgIH1cbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgcGFyZW50SGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xuICAgIGNvbnN0IG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleSA9IHRoaXMuZ2V0T3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5KHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgIGNvbnN0IGZpbHRlcnNXaXRoUGFyZW50ID0gdGhpcy5idWlsZEZpbHRlcnNXaXRoUGFyZW50KG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleSwgcGFyZW50SGllcmFyY2h5SW5mbywgZmlsdGVycyk7XG4gICAgY29uc3QgaXNVc2VQYWdpbmF0aW9uID0gcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VTaXplID4gMCB8fCBmYWxzZTtcbiAgICAvLyDnu4Tnu4dFbnRpdHlGaWx0ZXJcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB7XG4gICAgICBGaWx0ZXJDb25kaXRpb25zOiBmaWx0ZXJzV2l0aFBhcmVudCxcbiAgICAgIFNvcnRDb25kaXRpb25zOiBzb3J0cyxcbiAgICAgIElzVXNlUGFnaW5hdGlvbjogaXNVc2VQYWdpbmF0aW9uLFxuICAgICAgUGFnaW5hdGlvbjogeyBQYWdlSW5kZXg6IHBhZ2luYXRpb24gJiYgcGFnaW5hdGlvbi5wYWdlSW5kZXggfHwgMCwgUGFnZVNpemU6IHBhZ2luYXRpb24gJiYgcGFnaW5hdGlvbi5wYWdlU2l6ZSB8fCAwLCBQYWdlQ291bnQ6IDAsIFRvdGFsQ291bnQ6IDAgfVxuICAgIH07XG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKCk7XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmV4dGVuZFF1ZXJ5KGVudGl0eUZpbHRlciwgcmVxdWVzdEluZm8pLnBpcGUoXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgIGNvbnN0IHBhZ2luYXRpb25JbmZvID0gdGhpcy5nZXRQYWdpbmF0aW9uSW5mbyhyZXNwb25zZUluZm8pO1xuICAgICAgICBpZiAocGFyZW50SWQpIHtcbiAgICAgICAgICBpZiAocGFnaW5hdGlvbkluZm8gJiYgcGFnaW5hdGlvbkluZm8ucGFnZVNpemUgIT09IDAgJiYgZnJhbWVDb250ZXh0KSB7XG4gICAgICAgICAgICBmcmFtZUNvbnRleHQucGFyYW1zLnNldChgX05PREVfJHtwYXJlbnRJZH1fUEFHSU5BVElPTl9JTkZPX2AsIHBhZ2luYXRpb25JbmZvKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHBhZ2luYXRpb25JbmZvICYmIHBhZ2luYXRpb25JbmZvLnBhZ2VTaXplICE9PSAwICYmIGZyYW1lQ29udGV4dCkge1xuICAgICAgICAgICAgZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi51cGRhdGVQYWdpbmF0aW9uSW5mb0J5UGF0aCgnLycsIHBhZ2luYXRpb25JbmZvKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8g5YWI5riF56m65LiL57qn5a6e5L2TXG4gICAgICAgIHRoaXMuY2xlYXJEZXNjZW5kYW50RW50aXRpZXMocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SGllcmFyY2h5SW5mbywgZnJvemVuQ3VycmVudFJvdyk7XG4gICAgICAgIC8vIOi/veWKoOS4i+e6p+WunuS9k1xuICAgICAgICBjb25zdCBsaXN0RGF0YSA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5yZXN1bHQ7XG4gICAgICAgIGNvbnN0IGVudGl0aWVzID0gcmVwb3NpdG9yeS5idWlsZEVudGl0aWVzKGxpc3REYXRhKTtcbiAgICAgICAgaWYgKGZyb3plbkN1cnJlbnRSb3cpIHtcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRGF0YShlbnRpdGllcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZW50aXRpZXM7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcbiAgcHVibGljIGxvYWRGdWxsVHJlZShyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcGFyZW50SWQ6IHN0cmluZywgcHJvcGVydHlOYW1lOiBzdHJpbmcsIGZ1bGxUcmVlVHlwZTogc3RyaW5nLCBsb2FkVHlwZTogc3RyaW5nLCBmaWx0ZXJzPzogYW55W10sIGNvbnRleHQ/OiBhbnkpOiBPYnNlcnZhYmxlPEVudGl0eVtdPiB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IHF1ZXJ5VXJsID0gYCR7YmFzZVVyaX0vc2VydmljZS9wYXJlbnRpZGZ1bGx0cmVlcXVlcnlgO1xuICAgIGNvbnN0IHBhcmVudEhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudElkKTtcbiAgICBjb25zdCBlbnRpdHlGaWx0ZXIgPSB0aGlzLmJ1aWxkRW50aXR5RmlsdGVyKGZpbHRlcnMsIG51bGwsIDAsIDApO1xuXG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIGRhdGFJZDogcGFyZW50SWQgfHwgJycsXG4gICAgICBpc1VzZVBhZ2luYXRpb246IGZhbHNlLFxuICAgICAgdmlydHVhbFByb3BlcnR5TmFtZTogcHJvcGVydHlOYW1lLFxuICAgICAgcGFnaW5hdGlvbjoge30sXG4gICAgICBmdWxsVHJlZVR5cGUsXG4gICAgICBsb2FkVHlwZSxcbiAgICAgIGZpbHRlcjogZW50aXR5RmlsdGVyLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGJvZHk6IGJvZHlcbiAgICB9O1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UocXVlcnlVcmwsICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgdGFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICAvLyDkv53lrZjlsZXlvIDnmoToioLngrlcbiAgICAgICAgaWYgKHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUuc2VsZWN0ZWRSb3dJZCAmJiBjb250ZXh0ICYmIGNvbnRleHQuZnJhbWVDb250ZXh0KSB7XG4gICAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gY29udGV4dC5mcmFtZUNvbnRleHQgYXMgRnJhbWVDb250ZXh0O1xuICAgICAgICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpIHx8IG51bGw7XG4gICAgICAgICAgaWYgKHZpcnR1YWxSb290RnJhbWVDb250ZXh0KSB7XG4gICAgICAgICAgICBjb25zdCBsaXN0ID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdCBhcyBhbnlbXTtcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkUm93SWQgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUuc2VsZWN0ZWRSb3dJZDtcbiAgICAgICAgICAgIC8vIOS7jumhtuWxguW8gOWni+iuoeeul+aJgOaciemcgOimgeWxleW8gOeahOiKgueCuVxuICAgICAgICAgICAgY29uc3QgbGVhZk5vZGVJbmZvID0gbGlzdC5maW5kKGl0ZW0gPT4gaXRlbVtyZXBvc2l0b3J5LnByaW1hcnlLZXldID09PSBzZWxlY3RlZFJvd0lkKTtcbiAgICAgICAgICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSBsZWFmTm9kZUluZm9baGllcmFyY2h5SW5mb0tleV0gYXMgeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGFyZW50RWxlbWVudDogc3RyaW5nIH07XG4gICAgICAgICAgICBjb25zdCBpZHMgPSB0aGlzLmdldEFsbFBhcmVudElkcyhoaWVyYXJjaHlJbmZvLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5LCByZXBvc2l0b3J5KTtcbiAgICAgICAgICAgIHZpcnR1YWxSb290RnJhbWVDb250ZXh0LnBhcmFtcy5zZXQoJ19ERVZLSVRfZXhwYW5kUm93SWRzJywgaWRzLmpvaW4oJywnKSk7XG4gICAgICAgICAgICB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KCdfREVWS0lUX3NlbGVjdGVkUm93SWQnLCBzZWxlY3RlZFJvd0lkKTtcbiAgICAgICAgICAgIHZpcnR1YWxSb290RnJhbWVDb250ZXh0LnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnX19ERVZLSVRfX3NlbGVjdGVkUm93Jywgc2VsZWN0ZWRSb3dJZCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgY29uc3QgZnJvemVuQ3VycmVudFJvdyA9IGNvbnRleHQgJiYgY29udGV4dC5mcm96ZW5DdXJyZW50Um93IHx8IGZhbHNlO1xuICAgICAgICAvLyDlhYjmuIXnqbrkuIvnuqflrp7kvZNcbiAgICAgICAgdGhpcy5jbGVhckRlc2NlbmRhbnRFbnRpdGllcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvLCBmcm96ZW5DdXJyZW50Um93KTtcbiAgICAgICAgLy8g6L+95Yqg5LiL57qn5a6e5L2TXG4gICAgICAgIGNvbnN0IGxpc3REYXRhID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdDtcbiAgICAgICAgY29uc3QgZW50aXRpZXMgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xuICAgICAgICBpZiAoZnJvemVuQ3VycmVudFJvdykge1xuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGREYXRhKGVudGl0aWVzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXRpZXMoZW50aXRpZXMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbnRpdGllcztcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5o+S5YWl5a+554i26IqC54K555qE6L+H5rukXG4gICAqL1xuICBwdWJsaWMgYnVpbGRGaWx0ZXJzV2l0aFBhcmVudChvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55LCBmaWx0ZXJBcnJheTogYW55W10pOiBhbnkge1xuICAgIGNvbnN0IHJlbGF0aW9uVHlwZSA9IGZpbHRlckFycmF5ICYmIGZpbHRlckFycmF5Lmxlbmd0aCA+PSAxID8gMSA6IDA7XG4gICAgY29uc3QgcGFyZW50TGF5ZXIgPSBwYXJlbnRIaWVyYXJjaHlJbmZvID8gcGFyZW50SGllcmFyY2h5SW5mb1snbGF5ZXInXSA6IDA7XG4gICAgY29uc3QgcGFyZW50RWxlbWVudCA9IHBhcmVudEhpZXJhcmNoeUluZm8gPyBwYXJlbnRIaWVyYXJjaHlJbmZvWydpZCddIDogJyc7XG5cbiAgICBjb25zdCBwYXJlbnRGaWx0ZXJBcnJheSA9IFtcbiAgICAgIHtcbiAgICAgICAgXCJGaWx0ZXJGaWVsZFwiOiBgJHtvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXl9LkxheWVyYCxcbiAgICAgICAgXCJWYWx1ZVwiOiBwYXJlbnRMYXllciArIDEsXG4gICAgICAgIFwiTGJyYWNrZXRcIjogbnVsbCxcbiAgICAgICAgXCJSYnJhY2tldFwiOiBudWxsLFxuICAgICAgICBcIlJlbGF0aW9uXCI6IDEsXG4gICAgICAgIFwiRXhwcmVzc3R5cGVcIjogMCxcbiAgICAgICAgXCJDb21wYXJlXCI6IDBcbiAgICAgIH1cbiAgICBdO1xuICAgIGlmIChwYXJlbnRFbGVtZW50KSB7XG4gICAgICBwYXJlbnRGaWx0ZXJBcnJheS5wdXNoKFxuICAgICAgICB7XG4gICAgICAgICAgXCJGaWx0ZXJGaWVsZFwiOiBgJHtvcmlnaW5hbEhpZXJhcmNoeUluZm9LZXl9LlBhcmVudEVsZW1lbnRgLFxuICAgICAgICAgIFwiVmFsdWVcIjogcGFyZW50RWxlbWVudCxcbiAgICAgICAgICBcIkxicmFja2V0XCI6IG51bGwsXG4gICAgICAgICAgXCJSYnJhY2tldFwiOiBudWxsLFxuICAgICAgICAgIFwiUmVsYXRpb25cIjogcmVsYXRpb25UeXBlLFxuICAgICAgICAgIFwiRXhwcmVzc3R5cGVcIjogMCxcbiAgICAgICAgICBcIkNvbXBhcmVcIjogMFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJlbnRGaWx0ZXJBcnJheVswXS5SZWxhdGlvbiA9IHJlbGF0aW9uVHlwZTtcbiAgICB9XG4gICAgcmV0dXJuIHBhcmVudEZpbHRlckFycmF5LmNvbmNhdChmaWx0ZXJBcnJheSk7XG4gIH1cbiAgcHVibGljIGJ1aWxkRW50aXR5RmlsdGVyKGZpbHRlcjogYW55W10sIHNvcnQ6IGFueVtdLCBwYWdlU2l6ZTogbnVtYmVyLCBwYWdlSW5kZXg6IG51bWJlcikge1xuXG4gICAgLy8gQHRvZG/vvJrkuLTml7blhbzlrrnogIHku6PnoIHvvIzpmY3kvY7mlLnliqjluKbmnaXnmoTpo47pmalcbiAgICBpZiAoIWZpbHRlciAmJiAhc29ydCAmJiAhcGFnZVNpemUgJiYgIXBhZ2VJbmRleCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGlmICghZmlsdGVyKSB7XG4gICAgICBmaWx0ZXIgPSBbXTtcbiAgICB9XG4gICAgaWYgKCFzb3J0KSB7XG4gICAgICBzb3J0ID0gW107XG4gICAgfVxuICAgIC8vIOe6oOato+acgOWQjuS4gOS4qui/h+a7pOadoeS7tueahFJlbGF0aW9uXG4gICAgaWYgKGZpbHRlciAmJiBmaWx0ZXIubGVuZ3RoID4gMCkge1xuICAgICAgZmlsdGVyW2ZpbHRlci5sZW5ndGggLSAxXS5SZWxhdGlvbiA9IDA7XG4gICAgfVxuICAgIGNvbnN0IGVudGl0eUZpbHRlciA9IHtcbiAgICAgIEZpbHRlckNvbmRpdGlvbnM6IGZpbHRlcixcbiAgICAgIFNvcnRDb25kaXRpb25zOiBzb3J0LFxuICAgICAgSXNVc2VQYWdpbmF0aW9uOiBwYWdlU2l6ZSA9PT0gMCA/IGZhbHNlIDogdHJ1ZSxcbiAgICAgIFBhZ2luYXRpb246IHtcbiAgICAgICAgUGFnZUluZGV4OiBwYWdlSW5kZXgsXG4gICAgICAgIFBhZ2VTaXplOiBwYWdlU2l6ZSxcbiAgICAgICAgUGFnZUNvdW50OiAwLFxuICAgICAgICBUb3RhbENvdW50OiAwXG4gICAgICB9XG4gICAgfTtcbiAgICByZXR1cm4gZW50aXR5RmlsdGVyO1xuICB9XG4gIC8qKlxuICAgKiDmuIXnqbrlkI7ku6Plrp7kvZNcbiAgICogQGRlc2NyaXB0aW9uIHBhcmVudEhpZXJhcmNoeUluZm/kuK1sYXllcuS4uuimgea4heepuuWQjuS7o+iKgueCueeahGxheWVy77yM5L2G6YeM6Z2i55qEcGFyZW50RWxlbWVudOS4jeaYr+eItue6p+eahGlk77yM6ICM5piv6KaB5riF56m65ZCO5Luj6IqC54K555qEaWRcbiAgICovXG4gIHB1YmxpYyBjbGVhckRlc2NlbmRhbnRFbnRpdGllcyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55LCBmcm96ZW5DdXJyZW50Um93OiBib29sZWFuID0gZmFsc2UpOiB2b2lkIHtcbiAgICAvLyDmuIXnqbrmoLnoioLngrlcbiAgICBpZiAoIXBhcmVudEhpZXJhcmNoeUluZm8pIHtcbiAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5jbGVhcigpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBub2RlcyA9IHRoaXMuZ2V0Q2hpbGROb2RlcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZva2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvKTtcbiAgICBpZiAoZnJvemVuQ3VycmVudFJvdykge1xuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnJlbW92ZUVudGl0aWVzKChlbnRpdHk6IEVudGl0eSkgPT4ge1xuICAgICAgICBjb25zdCBpZCA9IGVudGl0eVtlbnRpdHkucHJpbWFyeUtleV07XG4gICAgICAgIHJldHVybiBub2Rlcy5pbmNsdWRlcyhpZCk7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnJlbW92ZURhdGEoKGVudGl0eTogRW50aXR5KSA9PiB7XG4gICAgICAgIGNvbnN0IGlkID0gZW50aXR5W2VudGl0eS5wcmltYXJ5S2V5XTtcbiAgICAgICAgcmV0dXJuIG5vZGVzLmluY2x1ZGVzKGlkKTtcbiAgICAgIH0pO1xuICAgIH1cblxuICB9XG4gIC8qKlxuICAgKiDojrflj5bmn5DkuKroioLngrnnmoTmiYDmnInlrZDoioLngrlcbiAgICogQHBhcmFtIHJlcG9zaXRvcnkgcmVwb3NpdG9yeVxuICAgKiBAcGFyYW0gaGllcmFyY2h5SW5mb2tleSBoaWVyYXJjaHlJbmZva2V5XG4gICAqIEBwYXJhbSBwYXJlbnRIaWVyYXJjaHlJbmZvIHBhcmVudEhpZXJhcmNoeUluZm9cbiAgICovXG4gIHByaXZhdGUgZ2V0Q2hpbGROb2RlcyhyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZywgcGFyZW50SGllcmFyY2h5SW5mbzogYW55KSB7XG4gICAgY29uc3QgZnBhcmVudEVsZW1lbnQgPSBwYXJlbnRIaWVyYXJjaHlJbmZvLmlkO1xuICAgIGNvbnN0IGZsYXllciA9IHBhcmVudEhpZXJhcmNoeUluZm8ubGF5ZXI7XG4gICAgbGV0IG5vZGVzID0gW107XG4gICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEFsbEVudGl0aWVzKCkuZm9yRWFjaChlbnRpdHkgPT4ge1xuICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IGVudGl0eVtoaWVyYXJjaHlJbmZva2V5XTtcbiAgICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSBoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQ7XG4gICAgICBjb25zdCBsYXllciA9IGhpZXJhcmNoeUluZm8ubGF5ZXI7XG4gICAgICBjb25zdCByZXN1bHQgPSBsYXllciA+PSAoZmxheWVyICsgMSkgJiYgcGFyZW50RWxlbWVudCA9PT0gZnBhcmVudEVsZW1lbnQ7XG4gICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgIGNvbnN0IGlkID0gZW50aXR5W2VudGl0eS5wcmltYXJ5S2V5XTtcbiAgICAgICAgbm9kZXMucHVzaChpZCk7XG4gICAgICAgIGNvbnN0IGNoaWxkSGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb2tleSwgaWQpO1xuICAgICAgICBjb25zdCBjaGlsZHMgPSB0aGlzLmdldENoaWxkTm9kZXMocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb2tleSwgY2hpbGRIaWVyYXJjaHlJbmZvKTtcbiAgICAgICAgaWYgKGNoaWxkcyAmJiBjaGlsZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIG5vZGVzID0gbm9kZXMuY29uY2F0KGNoaWxkcyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gbm9kZXM7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluWunuS9k+eahOWIhue6p+S/oeaBr1xuICAgKi9cbiAgcHVibGljIGdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nLCBpZDogc3RyaW5nKTogYW55IHtcbiAgICBpZiAoIWlkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZW50aXR5OiBFbnRpdHkgPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChpZCk7XG4gICAgY29uc3QgaGllcmFyY2h5SW5mb0VudGl0eTogRW50aXR5ID0gZW50aXR5W2hpZXJhcmNoeUluZm9rZXldO1xuICAgIGNvbnN0IHJlc3VsdCA9IGhpZXJhcmNoeUluZm9FbnRpdHkudG9KU09OKCk7XG4gICAgcmVzdWx0WydpZCddID0gaWQ7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICBwdWJsaWMgZ2V0SGllcmFyY2h5SW5mbyhlbnRpdHk6IEVudGl0eSwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nKTogeyBwYXJlbnRFbGVtZW50OiBzdHJpbmcsIGxheWVyOiBudW1iZXIsIGlzRGV0YWlsOiBib29sZWFuIH0ge1xuICAgIHJldHVybiBlbnRpdHlbaGllcmFyY2h5SW5mb2tleV07XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluWIhue6p+eggeeahOWOn+Wni+eahOWtl+auteWQjVxuICAgKi9cbiAgcHVibGljIGdldE9yaWdpbmFsSGllcmFyY2h5SW5mb0tleShyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9rZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgY29uc3QgbmdPYmplY3RzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdPYmplY3RzKHJlcG9zaXRvcnkuZW50aXR5VHlwZSk7XG4gICAgY29uc3QgaGllcmFyY2h5SW5mb05nT2JqZWN0ID0gbmdPYmplY3RzW2hpZXJhcmNoeUluZm9rZXldO1xuICAgIHJldHVybiBoaWVyYXJjaHlJbmZvTmdPYmplY3Qub3JpZ2luYWxEYXRhRmllbGQgYXMgc3RyaW5nO1xuICB9XG4gIHByaXZhdGUgZ2V0UGFnaW5hdGlvbkluZm8ocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pIHtcbiAgICByZXR1cm4gcmVzcG9uc2VJbmZvICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSAmJiByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucGFnaW5hdGlvbiB8fCBudWxsO1xuICB9XG4gIHByaXZhdGUgZmluZFBhcmVudChoaWVyYXJjaHlJbmZvOiB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXJlbnRFbGVtZW50OiBzdHJpbmcgfSwgbGlzdDogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZykge1xuICAgIHJldHVybiBsaXN0LmZpbmQoaXRlbSA9PiB7XG4gICAgICBjb25zdCBjdXJyZW50SGllcmFyY2h5SW5mbyA9IGl0ZW1baGllcmFyY2h5SW5mb0tleV0gYXMgeyBpc0RldGFpbDogYm9vbGVhbiwgbGF5ZXI6IG51bWJlciwgcGFyZW50RWxlbWVudDogc3RyaW5nIH07XG4gICAgICByZXR1cm4gY3VycmVudEhpZXJhcmNoeUluZm8ubGF5ZXIgPT09IGhpZXJhcmNoeUluZm8ubGF5ZXIgLSAxICYmIGhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudCA9PT0gY3VycmVudEhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudDtcbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIGdldEFsbFBhcmVudElkcyhoaWVyYXJjaHlJbmZvOiB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXJlbnRFbGVtZW50OiBzdHJpbmcgfSwgbGlzdDogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+KSB7XG4gICAgbGV0IGl0ZW0gPSB0aGlzLmZpbmRQYXJlbnQoaGllcmFyY2h5SW5mbywgbGlzdCwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgY29uc3QgaWRzID0gW107XG4gICAgd2hpbGUgKGl0ZW0pIHtcbiAgICAgIGlkcy5wdXNoKGl0ZW1bcmVwb3NpdG9yeS5wcmltYXJ5S2V5XSk7XG4gICAgICBpdGVtID0gdGhpcy5maW5kUGFyZW50KGl0ZW1baGllcmFyY2h5SW5mb0tleV0sIGxpc3QsIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgIH1cbiAgICByZXR1cm4gaWRzO1xuICB9XG4gIC8qKlxuICAgKiDmn6Xmib7oioLngrnkuIvmiYDmnInlrZDnuqfvvIjnrKzkuIDnuqfvvIlcbiAgICogQHBhcmFtIHJlcG9zaXRvcnkgcmVwb3NpdG9yeVxuICAgKiBAcGFyYW0gaGllcmFyY2h5SW5mb0tleSDliIbnuqfnoIHlrZfmrrVcbiAgICogQHBhcmFtIGlkIGlkXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRDaGlsZHJlbihyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgaWQ6IHN0cmluZyk6IEVudGl0eVtdIHtcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBpZCk7XG4gICAgaWYgKCFoaWVyYXJjaHlJbmZvKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgbGF5ZXIgPSBoaWVyYXJjaHlJbmZvLmxheWVyO1xuICAgIGNvbnN0IHBhcmVudEVsZW1lbnQgPSBoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQ7XG4gICAgY29uc3QgZW50aXRpZXM6IEVudGl0eVtdID0gcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0aWVzKChlbnRpdHk6IEVudGl0eSkgPT4ge1xuICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mbyhlbnRpdHksIGhpZXJhcmNoeUluZm9LZXkpO1xuICAgICAgY29uc3QgbWF0Y2hlZCA9IGhpZXJhcmNoeUluZm8ubGF5ZXIgPT09IGxheWVyICsgMSAmJiAoaGllcmFyY2h5SW5mby5wYXJlbnRFbGVtZW50ID09PSBwYXJlbnRFbGVtZW50IHx8ICFwYXJlbnRFbGVtZW50ICYmICFoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQpO1xuICAgICAgaWYgKG1hdGNoZWQpIHtcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBlbnRpdGllcztcbiAgfVxufVxuXG5leHBvcnQgeyBQYXJlbnRUcmVlUmVwb3NpdG9yeSB9O1xuIl19