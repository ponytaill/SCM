!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@farris/ui-lookup"),require("rxjs"),require("rxjs/operators"),require("@farris/ui-locale"),require("@farris/ui-common"),require("@angular/platform-browser"),require("resize-observer-polyfill"),require("@farris/ui-notify"),require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("@angular/forms"),require("@farris/ui-input-group"),require("@farris/ui-datalist"),require("@farris/ui-loading")):"function"==typeof define&&define.amd?define("@farris/ui-combo-list",["exports","@farris/ui-lookup","rxjs","rxjs/operators","@farris/ui-locale","@farris/ui-common","@angular/platform-browser","resize-observer-polyfill","@farris/ui-notify","@angular/core","@angular/common","@angular/common/http","@angular/forms","@farris/ui-input-group","@farris/ui-datalist","@farris/ui-loading"],t):t((e.farris=e.farris||{},e.farris["ui-combo-list"]={}),e.uiLookup,e.rxjs,e.rxjs.operators,e.uiLocale,e.uiCommon,e.ng.platformBrowser,e.ResizeObserver,e.uiNotify,e.ng.core,e.ng.common,e.ng.common.http,e.ng.forms,e.uiInputGroup,e.uiDatalist,e.uiLoading)}(this,function(e,t,c,u,i,a,l,o,h,p,n,s,r,d,f,m){"use strict";o=o&&o.hasOwnProperty("default")?o["default"]:o;var y=new p.InjectionToken("Combo Grid HTTP service"),g=(Object.defineProperty(v.prototype,"uri",{get:function(){return this._uri},set:function(e){this._uri=e,this.data$.next([])},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"data",{get:function(){return this._data},set:function(e){this._data=e||[],Array.isArray(e)&&this.data$.next(e)},enumerable:!0,configurable:!0}),v.prototype.injectService=function(){this.injector&&!this.comboHttp&&(this.lookupUtils=this.injector.get(t.LookupUtils,null),-1<this.displayType.indexOf("LOOKUP")?this.comboHttp=this.injector.get(t.ServerSideToken,null):this.comboHttp=this.injector.get(y,null))},v.prototype.toBoolean=function(e){return null!=e&&""+e!="false"},v.prototype.selectItem=function(t,e,i){var n=this;void 0===i&&(i=!0),this.multiSelect||(this.selections=[]),Array.isArray(t)?t.forEach(function(t){-1===n.selections.findIndex(function(e){return e[n.idField]===t[n.idField]})&&n.selections.push(t)}):-1===this.selections.findIndex(function(e){return e[n.idField]===t[n.idField]})&&this.selections.push(t),i&&this.selections$.next({action:"clicked"})},v.prototype.unSelectItem=function(t){this.selections=this.selections.filter(function(e){return JSON.stringify(e)!==JSON.stringify(t)}),this.selections$.next({action:"clicked"})},v.prototype.selectAll=function(e){var i=this;(e||[]).forEach(function(t){i.selections.find(function(e){return e[i.idField]===t[i.idField]})||i.selections.push(t)}),this.selections$.next({action:"clicked"})},v.prototype.unSelectAll=function(e){var i=this;e=e||[],this.selections=(this.selections||[]).filter(function(t){return-1===e.findIndex(function(e){return e[i.idField]===t[i.idField]})}),this.selections$.next({action:"clicked"})},v.prototype.isSelect=function(t){var i=this;return!(!this.selections||!this.selections.length)&&this.selections.find(function(e){return e[i.idField]===t})!==undefined},v.prototype.loadData=function(t,e,i){if(void 0===e&&(e=""),t){if(null!==e&&e!==undefined||(e=""),"boolean"==typeof e&&(e=""+e),e){var n=[e+""];this.multiSelect&&(n=(e+"").split(this.separator));var o=n.map(function(e){return i(t,e)});o=o.filter(function(e){return e}),this.selections=o}else this.selections=[];this.selections$.next({action:"initData"})}},v.prototype.filterDataOnServer=function(e){var t=this;this.getData(e).subscribe(function(e){if(t.closeLoading(),t.loadingService.clearAll(),e&&e.items)switch(t.displayType){case"LOOKUPLIST":t.loadLookUpDataTable(e,!0);break;case"LOOKUPTREELIST":t.loadLookUpDataTree(e)}else t.data$.next([])})},v.prototype.filterData=function(i,n){var o=this;if(void 0===n&&(n="text"),i){var e=[];"LOOKUPLIST"!==this.displayType&&"LIST"!==this.displayType||(e=this.data.filter(function(e){var t=o.getValueByObj(n,e);return""!=t&&null!==t&&t!==undefined&&(t=String(t).toLowerCase()),-1<t.indexOf(i.toLowerCase())})),this.data$.next(e)}else this.data$.next(this.data)},v.prototype.getSelections=function(){return this.selections},v.prototype.clearSelections=function(){this.selections=[]},v.prototype.getValue=function(t,e){var i=this;if((e=e||this.selections)&&e.length){var n=e.map(function(e){return i.getValueByObj(t,e)});return n&&(1<n.length||0===n.length)?n.join(this.separator):n[0]}return""},v.prototype.getValueByObj=function(e,t){return t?-1===e.indexOf(".")?t.hasOwnProperty(e)?t[e]:null:e.split(".").reduce(function(e,t){return e?e[t]:null},t):""},v.prototype.initData=function(e,t,i){var n=this;switch(void 0===e&&(e={}),void 0===t&&(t="get"),void 0===i&&(i=""),this.displayType){case"TreeList":case"LIST":e.data&&(e=e.data),this.getData(e,t).subscribe(function(e){var t=e;n.uri||(t=n.data),"TreeList"===n.displayType?n.loadDataTree(t):n.loadDataTable(t),n.loadSuccess$.next(!0)});break;case"LOOKUPLIST":case"LOOKUPTREELIST":i||(this.selections=[],this.selectedValues=""),this.loadLookupData(e,i,"get","LOOKUPTREELIST"===this.displayType)}return this.loadSuccess$},v.prototype.loadLookupData=function(e,i,t,n){var o=this;void 0===t&&(t="get"),void 0===n&&(n=!1);var s=e.data,r=e.enableFullTree,a=e.loadTreeDataType,l=e.searchValue;s&&(e={customData:s}),"LOOKUPTREELIST"!==this.displayType||this.treeToList||(e.enableFullTree=r,e.searchValue='{"category":"all"}',this.treeloadconfig={enableFullTree:r,loadTreeDataType:a}),l&&(e.searchValue=l),this.treeToList&&(n=!1,this.displayType="LOOKUPLIST"),this.getData(e,t).pipe(u.switchMap(function(t){return i?o.getSelectedItems(i).pipe(u.map(function(e){return e&&e.items?t.selectedItems=n?e.items.map(function(e){return e.data}):e.items:Array.isArray(e)&&(t.selectedItems=(i+"").split(o.separator).map(function(t){return n?o.treeNodeToFlatData(e,t,o.idField):e.find(function(e){return e[o.idField]+""==t||e[o.textField]==t})})),t}),u.catchError(function(){return c.of(t)})):c.of(t)})).subscribe(function(e){o.loadingService.clearAll(),e&&(n?o.loadLookUpDataTree(e):o.loadLookUpDataTable(e)),o.loadSuccess$.next(!0)})},v.prototype.getSelectedItems=function(e){var t={category:"fav",favoriteIds:(""+e).split(this.separator)},i={searchValue:JSON.stringify(t),enableFullTree:!1,loadTreeDataType:"default"};return this.getData(i)},v.prototype.getData=function(e,t,i){var n=this;return void 0===e&&(e={}),void 0===t&&(t="get"),void 0===i&&(i=!1),this.uri?(this.data&&this.data.length&&!i&&(this.data=[]),e.treeToList=this.treeToList,e.navTreeToList=this.navTreeToList,this.treeToList&&(this.displayType="LOOKUPLIST"),this.showLoading(),this.comboHttp?(this.context&&(this.comboHttp.context=this.context),this.comboHttp.getData(this.uri,e,t).pipe(u.tap(function(){n.closeLoading()}))):this.http.request(t,this.uri,e).pipe(u.tap(function(){n.closeLoading()}))):this.data?c.of(this.data).pipe(u.delay(10)):c.of([]).pipe(u.delay(10))},v.prototype.loadDataTable=function(e){var i=this;e instanceof Array?this.data=e:this.data=e?e.returnValue:[],this.loadData(this.data,this.selectedValues,function(e,t){return e.find(function(e){return e[i.idField]+""==t||e[i.textField]==t})}),this.closeLoading()},v.prototype.loadDataTree=function(e){var i=this;e instanceof Array?this.data=e:this.data=e?e.returnValue:[],this.loadData(this.data,this.selectedValues,function(e,t){return function o(e,t,i){var n="";return e.find(function(e){return e.data[i]==t?(n=e.data,!0):!(!e.children||!e.children.length)&&void(n=o(e.children,t,i))}),n}(e,t,i.idField)}),this.closeLoading()},v.prototype.loadLookUpDataTable=function(e,t){var n=this;if(void 0===t&&(t=!1),this.closeLoading(),"object"==typeof e&&(e.returnValue&&(e=e.returnValue),!t&&e.columns&&(this.columns=e.columns),e.pageInfo&&(this.pageInfo=e.pageInfo,this.pageInfo.total=e.total?e.total:0),e.items&&(this.data=e.items),e.selectedItems&&(this.selections=e.selectedItems||[])),this.selections){var i=this.selections.map(function(e){return e[n.idField]}).join(this.separator);i!==this.selectedValues&&(this.selectedValues=i)}this.loadData(this.data,this.selectedValues,function(e,t){var i=e.find(function(e){return e[n.idField]+""==t});return n.selections&&(i=i||n.selections.find(function(e){return e[n.idField]+""==t})),i})},v.prototype.checkNodeCanBeSelect=function(e,t){var i=this;return void 0===t&&(t=!0),e&&e.length?e.map(function(e){return e.hasOwnProperty("addtional")&&(e.selectable=!e.addtional),e.children&&e.children.length?i.checkNodeCanBeSelect(e.children,t):t&&(e.leaf=!0),e}):e},v.prototype.loadLookUpDataTree=function(e){var i=this;this.closeLoading(),e&&(e instanceof Array?this.data=e:(e.returnValue&&(e=e.returnValue),this.columns=e.columns,this.treeInfo=e.treeInfo,this.treeInfo$.next(this.treeInfo),e.selectedItems&&(this.selections=e.selectedItems||[]),this.treeInfo&&!this.treeInfo.treeDataIsInit?"pathcode"===this.treeInfo.layerType.toLowerCase()?this.data=this.lookupUtils.makeTree(e.items,this.treeInfo):this.data=this.lookupUtils.makeTreeWithParentID(e.items,"",this.treeInfo.dataField+"."+this.treeInfo.parentField,this.idField):e.items&&(this.data=this.checkNodeCanBeSelect(e.items,"default"===i.treeloadconfig.loadTreeDataType?"all"===i.treeInfo.loadDataType:"loadall"===i.treeloadconfig.loadTreeDataType))),this.loadData(this.data,this.selectedValues,function(e,t){return i.treeNodeToFlatData(e,t,i.idField)}))},v.prototype.treeNodeToFlatData=function(e,t,i){var n=this,o="";return e.find(function(e){return e.data&&e.data[i]==t||e[i]==t?(o=e.data,!0):!(!e.children||!e.children.length||!(o=n.treeNodeToFlatData(e.children,t,i)))}),o},v.prototype.showLoading=function(){this.loading=this.loadingService.show({container:this.panelElement,delay:100})},v.prototype.closeLoading=function(){this.loading&&(this.loading.close(),this.loading=null)},v.decorators=[{type:p.Injectable}],v.ctorParameters=function(){return[{type:s.HttpClient},{type:m.LoadingService},{type:p.Injector}]},v);function v(e,t,i){var n=this;this.http=e,this.loadingService=t,this.injector=i,this.selections$=new c.Subject,this.isOpen$=new c.BehaviorSubject(!1),this.data$=new c.BehaviorSubject(""),this.serachValue$=new c.Subject,this.loadSuccess$=new c.Subject,this.treeInfo$=new c.BehaviorSubject(null),this.displayType="LIST",this.separator=",",this.selectedValues="",this.columns=[],this.remoteSearch=!0,this.panelElement=null,this.treeSearchHandler=null,this.treeloadconfig=null,this._data=[],this.serachValue$.pipe(u.debounceTime(300)).subscribe(function(e){n.remoteSearch?n.filterDataOnServer(e):n.filterData(e,n.textField)})}var b=function(e,t){return(b=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};var S=function(){return(S=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var o in t=arguments[i])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};var T=(x.prototype.getLocaleConfig=function(){var e=this.localeService.localeId;return this.localeConfig=this.localeService.getResources(e+".combo"),this.localeConfig},x.decorators=[{type:p.Injectable}],x.ctorParameters=function(){return[{type:i.LocaleService}]},x);function x(e){this.localeService=e,this.localeConfig={ZH_CN:{placeholder:"请选择"},EN_US:{placeholder:"Please Select"}}}var C=0,E=(Object.defineProperty(I.prototype,"context",{set:function(e){this.comboService.context=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"mappingField",{get:function(){return this.mapFields},set:function(e){this.mapFields=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"data",{get:function(){return this.comboService.data},set:function(e){this.comboService.data=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"idField",{get:function(){return this.comboService.idField},set:function(e){this.comboService.idField=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"valueField",{get:function(){return this.comboService.valueField?this.comboService.valueField:this.idField},set:function(e){this.comboService.valueField=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"textField",{get:function(){return this.comboService.textField},set:function(e){this.comboService.textField=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"multiSelect",{get:function(){return this.comboService.multiSelect},set:function(e){this.comboService.multiSelect=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"uri",{get:function(){return this.comboService.uri},set:function(e){this.comboService.uri=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"selectedValues",{get:function(){return this.comboService.selectedValues},set:function(e){this.comboService.selectedValues=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"selectedValuesStr",{get:function(){return null!==this.selectedValues&&this.selectedValues!==undefined||(this.selectedValues=""),this.selectedValues+""},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"remoteSearch",{get:function(){return this.comboService.remoteSearch},set:function(e){this.comboService.remoteSearch=e},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"cmbPanel",{set:function(e){e?(this._cmbPanel=e,this.ro.observe(e.nativeElement),this._comboPanelCreated$.next(e)):(this._cmbPanel=null,this.ro&&this.ro.disconnect(),this._comboPanelCreated$.next(null))},enumerable:!0,configurable:!0}),Object.defineProperty(I.prototype,"selections",{get:function(){return this.comboService.selections?this.comboService.selections.filter(function(e){return null!==e&&e!==undefined}):[]},set:function(e){this.comboService.selections=e},enumerable:!0,configurable:!0}),I.prototype.ngOnInit=function(){if(this.localeService=this.injector.get(T,""),this.localeService){var e=this.localeService.getLocaleConfig();e&&(this.placeholder||(this.placeholder=e.placeholder||"请选择"))}this.comboService.separator=this.separator,this.comboService.treeToList=this.treeToList,this.comboService.navTreeToList=this.navTreeToList},I.prototype.ngAfterViewInit=function(){var t=this,i=this;if(this.ngControl=this.injector.get(r.NgControl,null),c.fromEvent(window,"resize").pipe(u.takeUntil(this.destroy$)).pipe(u.debounceTime(100),u.throttle(function(e){return c.interval(100)})).subscribe(function(){t.updatePanelWidth(),t.isOpen&&(t.comboService.isOpen$.next(!1),t.willHide$.next())}),this.ngZone){this.ngZone.runOutsideAngular(function(){setTimeout(function(){i.updatePanelWidth()})});var n=null;this.ro=new o(function(e){t.ngZone.runOutsideAngular(function(){n&&clearTimeout(n),n=setTimeout(function(){i._cmbPanel&&i.panelElement&&a.reqAnimFrame(function(){i.updatePosition(i._cmbPanel.nativeElement),-1===i._cmbPanel.nativeElement.className.indexOf("f-area-show")&&i.render.addClass(i._cmbPanel.nativeElement,"f-area-show")})},10)})})}this.comboService.injectService()},I.prototype.ngOnDestroy=function(){this.destroy$.next(),this.destroy$.complete(),this.comboService.serachValue$.unsubscribe(),this.mouseWheelEvent&&this.mouseWheelEvent()},I.prototype.updatePanelWidth=function(){var e=this.getInputSizeInfo().width;this.panelWidth=this.autoWidth?e:this.panelWidth},I.prototype.onClick=function(e){void 0===e&&(e=null),e&&(e.stopPropagation?e.stopPropagation():e.originalEvent&&e.originalEvent.stopPropagation()),this.comboService.isOpen$.next(!this.isOpen),this.input&&this.input.textbox&&this.input.textbox.nativeElement.focus()},I.prototype.onBlur=function(e){this.onTouched()},I.prototype.onFocus=function(e){},I.prototype.onInputclick=function(e){e&&e.stopPropagation&&e.stopPropagation(),this.comboService.isOpen$.next(!this.isOpen)},I.prototype.onEnter=function(e){},I.prototype.blur=function(){this.input.textbox.nativeElement.blur()},I.prototype.focus=function(){this.input.textbox.nativeElement.focus()},I.prototype.onClear=function(){this.selectedValues="",this.selections=[],this.onValueChange({text:"",value:"",selections:[]}),this.clear.emit(),this.isOpen&&this.hidePanelOnClear&&this.willHide$.next()},I.prototype.getInputSizeInfo=function(){return("text"===this.viewType?this.input.inputGroup:this.input2).nativeElement.getBoundingClientRect()},I.prototype.emitTextChange=function(){var o=this;return this.textChangeSubject.pipe(u.debounceTime(200)).subscribe(function(e){o.selectedValues;var t=e||o.displayText;if(""===e?o.onClear():o.nosearch&&o.onValueChange({text:e,value:"",selections:o.selections,nosearch:!0}),o.remoteSearch)o.filterDataOnServer(t,"*");else if(o.multiSelect){var i=(t+"").split(o.separator),n=i[i.length-1]?i[i.length-1]:"";o.comboService.serachValue$.next(n)}else"LOOKUPTREELIST"===o.comboService.displayType?o.treeClientSearch.next(t):o.comboService.serachValue$.next(t)})},I.prototype.__createPanel=function(e,t){var i=this;void 0===t&&(t=null);var n={},o="get";if(e instanceof Object){var s=e.params,r=e.data,a=e.method;if(!1===e.showDialog)return;this.customData=r?(n={data:r},r):s?(n={data:s},s):null,a&&(o=a)}else if("boolean"==typeof e&&!1===e)return;this.initCreatPanelAction(),this.uri?(this.updateSelectedValues(),this.isLookup()&&(this.isOpen=!0)):this.isOpen=!0,"LOOKUPTREELIST"===this.comboService.displayType&&(n.enableFullTree=this.enableFullTree,n.loadTreeDataType=this.loadTreeDataType),this.isLookup()&&this.input&&this.nosearch&&(this.input.textbox.nativeElement.disabled=!0);var l=function(){i.isLookup()&&i.input&&i.nosearch&&(i.input.textbox.nativeElement.disabled=!1,i.input.focus())};t&&(n.searchValue=t.searchValue),this.initdataSubscription=this.comboService.initData(n,o,this.selectedValues).pipe(u.throwIfEmpty(l)).subscribe(function(e){i.isOpen||(i.isOpen=!0),l(),i.cdr.detectChanges()}),this.ngZone.runOutsideAngular(function(){i.registerDocumentEvent()})},I.prototype.onBeforeShow=function(){return this.beforeShow||(this.beforeShow=function(){return c.of("")}),this.beforeShow(this).pipe(u.take(1))},I.prototype.isLookup=function(){return-1<this.comboService.displayType.indexOf("LOOKUP")},I.prototype.onBeforeHide=function(){var t=this;this.beforeHide||(this.beforeHide=function(){return c.of("")}),this.beforeHide(this).pipe(u.take(1)).subscribe(function(e){"boolean"==typeof e?e&&t.hide(!0):"object"==typeof e?e.hide?t.hide(!0):e.message&&t.notifySer&&t.notifySer.warning(e.message):t.hide(!0)})},I.prototype.initToggleAction=function(){var n=this;this.comboService.isOpen$.pipe(u.debounceTime(20),u.takeUntil(this.destroy$),u.skip(1)).subscribe(function(e){if(!n.readonly&&!n.disabled){var t=e,i=null;"object"==typeof e&&(t=e.isOpen,i=e.search),t?n.onBeforeShow().subscribe(function(e){n.__createPanel(e,i)}):(n.onBeforeHide(),n.cdr.detectChanges())}}),this._comboPanelCreated$.pipe(u.takeUntil(this.destroy$),u.filter(function(e){return!!e})).subscribe(function(e){e.nativeElement.style.display="",n.initCreatPanelAction(),n.panelElement.appendChild(e.nativeElement);var t=!0;e.nativeElement.addEventListener("transitionend",function(e){e.target===e.currentTarget&&t&&(t=!1,n.showPanel.emit(n))}),n.isLookup()&&(e.nativeElement.style.width=n.panelWidth+"px",e.nativeElement.style.height=n.panelHeight+"px",n.render.addClass(e.nativeElement,"f-area-show"))}),this.destroy$.pipe(u.take(1)).subscribe(function(){n.comboService.closeLoading(),C=0,n.panelListener&&n.panelListener(),n.initdataSubscription&&(n.initdataSubscription.unsubscribe(),n.initdataSubscription=null),n.removePanelElement()})},I.prototype.iframeEventHandle=function(e){var t,i,n=Array.from(document.querySelectorAll("iframe"));if(n&&n.length)try{for(var o=function a(e){var t="function"==typeof Symbol&&e[Symbol.iterator],i=0;return t?t.call(e):{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}}}(n),s=o.next();!s.done;s=o.next()){var r=s.value.contentDocument;r&&(r[e]("mousedown",this._documentClickEvent),r[e]("mousewheel",this._documentClickEvent),r[e]("DOMMouseScroll",this._documentClickEvent))}}catch(l){t={error:l}}finally{try{s&&!s.done&&(i=o["return"])&&i.call(o)}finally{if(t)throw t.error}}},I.prototype.removeDocumentListener=function(){this._documentClickEvent&&(document.removeEventListener("mousedown",this._documentClickEvent,!0),document.removeEventListener("mousewheel",this._documentClickEvent,!0),document.removeEventListener("DOMMouseScroll",this._documentClickEvent,!0),top!==window&&top.document.body.removeEventListener("mousedown",this._documentClickEvent,!0),this.iframeEventHandle("removeEventListener"),this._documentClickEvent=null)},I.prototype.registerDocumentEvent=function(){var t=this;document.addEventListener("mousedown",this._documentClickEvent=function(e){"mousewheel"===e.type&&t.el.nativeElement.contains(e.target)?t.comboService.isOpen$.next(!1):t.el.nativeElement.contains(e.target)||!t._cmbPanel||t.contains(t._cmbPanel,e)||t.comboService.isOpen$.next(!1)},!0),document.addEventListener("mousewheel",this._documentClickEvent,!0),document.addEventListener("DOMMouseScroll",this._documentClickEvent,!0),top!==window&&top.document.body.addEventListener("mousedown",this._documentClickEvent,!0),this.iframeEventHandle("addEventListener")},I.prototype.initCreatPanelAction=function(){this.panelElement||(this.createPanel(document.body),this.panelListener=this.render.listen(this.panelElement,"click",function(e){e.stopPropagation()}))},I.prototype.removePanelElement=function(){var e=this;a.reqAnimFrame(function(){e.panelElement&&(document.body.removeChild(e.panelElement),e.panelElement=null)})},I.prototype.initSelectionsChangeAction=function(){var t=this;this.comboService.selections$.pipe(u.takeUntil(this.destroy$),u.debounceTime(100)).subscribe(function(e){"initData"===e.action?t.onSelectionsChange(t.selections):t.onSelectionsChangeDefault()})},I.prototype.initDatasChangeAction=function(){},I.prototype.onSelectionsChangeDefault=function(){var e=this.comboService.getValue(this.textField),t=this.comboService.getValue(this.idField);this.displayText===e||this.nosearch||(this.displayText=e||this.displayText,this.displayText=this.displayText||"",this.originalText=t?e:this.displayText),this.input&&(this.input.textbox.nativeElement.value=this.displayText),this.selectedValues=""!==t&&t!==undefined&&null!==t?t:this.selectedValues,this.cdr.destroyed||this.cdr.detectChanges()},I.prototype.onSelectionsChange=function(e){},I.prototype.updateMappingFieldValue=function(e){if(void 0===e&&(e=!1),this.mappingField&&this.ngControl&&this.ngControl.formDirective&&this.ngControl.formDirective.form&&this.ngControl.formDirective.form.bindingData){var t=this.ngControl.formDirective.form.bindingData;if(e&&(this.selectedValues=""),t.setValue){var i=this.ngControl.formDirective.form.bindingPath,n=[];i&&(n=i.split("/").filter(function(e){return""!==e}));var o=this.mappingField?this.mappingField:"";t.setValue(n.concat(o.split(".")),this.selectedValues,!0,!0)}else this.commonUtils&&this.commonUtils.setValue(t,this.mappingField,this.selectedValues)}},I.prototype.updateSelectedValues=function(){if(this.mappingField&&this.ngControl&&this.ngControl.formDirective&&this.ngControl.formDirective.form&&this.ngControl.formDirective.form.bindingData){var e=this.ngControl.formDirective.form.bindingData;if(e.getValue){var t=this.ngControl.formDirective.form.bindingPath,i=[];t&&(i=t.split("/").filter(function(e){return""!==e}));var n=this.mappingField?this.mappingField:"";this.selectedValues=e.getValue(i.concat(n.split(".")))}else this.commonUtils&&(this.selectedValues=this.commonUtils.getValue(this.mappingField,e))}else this.mappingField},I.prototype.onTextChange=function(e){this.isTextChange=!0,this.nosearch&&(this.selectedValues=e,this.updateMappingFieldValue(this.isLookup()),this.onChange(e)),this.textChangeSubject.next(e)},I.prototype.onValueChange=function(e){this.displayText=e.text,this.originalText=this.displayText,!this.uri&&this.data&&0<this.data.length&&(!this.displayType||this.useValue)?this.onChange(this.selectedValues):this.onChange(this.displayText),this.valueChange.emit(e),this.updateMappingFieldValue(),this.onTouched()},I.prototype.onSelect=function(e){},I.prototype.onUnSelected=function(e){},I.prototype.hide=function(e){void 0===e&&(e=!0),this.isOpen&&(this.removeDocumentListener(),this.isOpen=!1,e&&this.willHide$.next(),this.initdataSubscription&&(this.initdataSubscription.unsubscribe(),this.initdataSubscription=null),this.removePanelElement())},I.prototype.show=function(){var t=this;this.isOpen||(this.onBeforeShow().subscribe(function(e){t.__createPanel(e)}),this.cdr.detectChanges())},I.prototype.createPanel=function(e){if(this.panelElement=this.document.createElement("div"),this.panelElement.id="overlay-"+C++,this.panelElement.classList.add("overlay-pane"),this.panelElement.style.display="none",e.appendChild(this.panelElement),this.comboService.panelElement=this.panelElement,this.isLookup()){var t=this.getPanelSize(),i=t.panelWidth,n=t.top,o=t.left;this.panelElement.style.width=i+"px",this.panelElement.style.height=this.panelHeight+"px",this.panelElement.style.top=n+"px",this.panelElement.style.left=o+"px",this.panelElement.style.zIndex=10001,this.panelElement.classList.add("f-combo-lookup")}else this.panelElement.style.overflow="hidden",this.render.setStyle(this.panelElement,"top","0"),this.render.setStyle(this.panelElement,"left","0"),this.panelElement.classList.add("f-combo-lookup");this.panelElement.style.display=""},I.prototype.getPanelSize=function(e){var t=this.panelHeight;if(this.innerPanelHeight=202,this.autoWidth){var i=this.getInputSizeInfo().width;this.panelWidth=i||this.panelWidth}if(e&&e.tagName&&"auto"===t){var n=e.scrollHeight;e.querySelector(".f-table-norecords-content"),this.data&&this.data.length&&("LIST"===this.comboService.displayType&&e.querySelector(".list-group")?this.innerPanelHeight=e.querySelector(".list-group").offsetHeight+2:this.innerPanelHeight=n)}else e&&e.tagName&&t&&!String(t).includes("px")&&(t=t);var o=this.el.nativeElement.getBoundingClientRect(),s=o.top,r=o.height,a=o.left;o.right,r+=1;var l=window.innerHeight-r-s;"auto"===t&&(t=this.maxHeight&&this.maxHeight>this.innerPanelHeight?this.innerPanelHeight:this.maxHeight);var c=l<s?s:l,u=c===l,h="top";t<l?s+=r:l<s?(s=c<t?(t=c-10,10):s-parseInt(""+t,10)-5,h="bottom"):(c<t&&(t=c-10),s+=r);var p=this.panelWidth;return window.innerWidth-a<this.panelWidth&&(a+this.el.nativeElement.offsetWidth>this.panelWidth?a=a+this.el.nativeElement.offsetWidth-this.panelWidth:(a=0,p=window.innerWidth>this.panelWidth?this.panelWidth:window.innerWidth-10)),{panelWidth:p,panelHeight:t,top:s,left:a,below:u,fx:h}},I.prototype.compatibleScrollTop=function(){return document.scrollingElement?document.scrollingElement.scrollTop:Math.max(window.pageYOffset,document.documentElement.scrollTop,document.body.scrollTop)},I.prototype.compatibleScrollLeft=function(){return document.scrollingElement?document.scrollingElement.scrollLeft:Math.max(window.pageXOffset,document.documentElement.scrollLeft,document.body.scrollLeft)},I.prototype.updatePosition=function(i){var n=this,e=this.getPanelSize(i),t=e.panelHeight,o=e.left,s=e.top,r=(e.below,e.fx);if(this.isLookup())this.comPosition={width:this.panelWidth,height:t};else{var a=s,l=t;s<0&&(l=this.innerPanelHeight+s-10,a=10),a+=this.compatibleScrollTop(),"auto"!==this.panelHeight&&this.maxHeight<l&&(this.maxHeight=l),this.comPosition={left:o+this.compatibleScrollLeft(),top:a,width:this.panelWidth,height:"auto"===l?"auto":l,"max-height":this.maxHeight}}return this.panelElement.style.overflow="",i.style.display="",Object.keys(this.comPosition).forEach(function(e){var t=n.comPosition[e];"auto"!==t&&(t+="px"),n.render.setStyle(i,e,t)}),i.style.transformOrigin="100% "+r,this.comPosition},I.prototype.contains=function(e,t){return e.nativeElement.contains(t.target)},I.prototype.filterSelections=function(e,i){var n=this;return String(e).split(this.separator).map(function(t){var e=i.find(function(e){return t==n.commonUtils.getValue(n.idField,e)+""});return e?n.commonUtils.getValue(n.textField,e):""}).filter(function(e){return e})},I.prototype.updateSelections=function(e,i){var n=this;null!==e&&e!==undefined||(this.selections=[]),"boolean"!=typeof e&&"number"!=typeof e||(e=""+e);var t=e?String(e).split(this.separator).map(function(t){return"LOOKUPTREELIST"===n.comboService.displayType?n.comboService.treeNodeToFlatData(i,t,n.idField):i.find(function(e){return""+t==n.commonUtils.getValue(n.idField,e)+""})}):[];this.selections=t||[]},I.prototype.getDisplayText=function(e,t){if(null===e||e===undefined)return"";var i=this.filterSelections(e,t);return i&&i.length?i.filter(function(e){return!!e}).join(this.separator):e},I.prototype.writeValue=function(e){var o=this,t=[];if(this.data instanceof Array?t=this.data:this.data&&(t=this.data.items instanceof Array?this.data.items:t),this.originalText=e,this.selectedValues="",!this.uri&&t&&0<t.length)this.selectedValues=e,this.updateSelections(e,t),this.displayText=this.getDisplayText(e,this.selections||[]),this.originalText=this.displayText;else if(this.displayText=e,this.updateSelectedValues(),this.selectedValues||(this.selectedValues=e),"tag"===this.viewType&&this.multiSelect&&null!==this.displayText&&this.displayText!==undefined){var i=this.displayText.split(this.separator).filter(function(e){return e});this.selections=i.reduce(function(e,t,i){var n;return e.push(((n={})[o.textField]=t,n)),e},[])}this.cdr.markForCheck()},I.prototype.registerOnChange=function(e){this.onChange=e},I.prototype.registerOnTouched=function(e){this.onTouched=e},I.prototype.setDisabledState=function(e){this.disabled=e,this.cdr.markForCheck()},I.prototype.filterDataOnServer=function(e,t){},I.ctorParameters=function(){return[{type:p.ElementRef},{type:p.ChangeDetectorRef},{type:undefined,decorators:[{type:p.Inject,args:[n.DOCUMENT]}]},{type:p.Renderer2},{type:g},{type:p.Injector}]},I.propDecorators={disabled:[{type:p.Input}],readonly:[{type:p.Input}],editable:[{type:p.Input}],placeholder:[{type:p.Input}],panelWidth:[{type:p.Input}],panelHeight:[{type:p.Input}],autoWidth:[{type:p.Input}],enableClear:[{type:p.Input}],mapFields:[{type:p.Input}],forcePlaceholder:[{type:p.Input}],nosearch:[{type:p.Input}],maxLength:[{type:p.Input}],enableTitle:[{type:p.Input}],viewType:[{type:p.Input}],context:[{type:p.Input}],mappingField:[{type:p.Input}],data:[{type:p.Input}],idField:[{type:p.Input}],valueField:[{type:p.Input}],textField:[{type:p.Input}],multiSelect:[{type:p.Input}],uri:[{type:p.Input}],selectedValues:[{type:p.Input}],displayText:[{type:p.Input}],maxHeight:[{type:p.Input}],enableCancelSelected:[{type:p.Input}],remoteSearch:[{type:p.Input}],beforeShow:[{type:p.Input}],beforeHide:[{type:p.Input}],hidePanelOnClear:[{type:p.Input}],useValue:[{type:p.Input}],separator:[{type:p.Input}],treeToList:[{type:p.Input}],navTreeToList:[{type:p.Input}],showPanel:[{type:p.Output}],hidePanel:[{type:p.Output}],clear:[{type:p.Output}],valueChange:[{type:p.Output}],selectChange:[{type:p.Output}],cmbPanel:[{type:p.ViewChild,args:["comboPanel"]}],input:[{type:p.ViewChild,args:["input"]}],input2:[{type:p.ViewChild,args:["input2"]}]},I);function I(e,t,i,n,o,s){var r=this;this.el=e,this.cdr=t,this.document=i,this.render=n,this.comboService=o,this.injector=s,this.disabled=!1,this.readonly=!1,this.editable=!0,this.placeholder="",this.panelWidth=300,this.panelHeight="auto",this.autoWidth=!0,this.enableClear=!0,this.forcePlaceholder=!1,this.nosearch=!1,this.enableTitle=!0,this.viewType="text",this.displayText="",this.maxHeight=200,this.enableCancelSelected=!1,this.hidePanelOnClear=!1,this.useValue=!1,this.separator=",",this.treeToList=!1,this.navTreeToList=!1,this.showPanel=new p.EventEmitter,this.hidePanel=new p.EventEmitter,this.clear=new p.EventEmitter,this.valueChange=new p.EventEmitter,this.selectChange=new p.EventEmitter,this.isOpen=!1,this.comPosition={},this.destroy$=new c.Subject,this.ngControl=null,this.groupIcon='<span class="f-icon f-icon-arrow-60-down"></span>',this._cmbPanel=null,this._comboPanelCreated$=new c.Subject,this.willHide$=new c.Subject,this.panelListener=null,this.ngZone=null,this.mouseWheelEvent=null,this.textChangeSubject=new c.Subject,this.initdataSubscription=null,this.customData=null,this.originalText="",this.isTextChange=!1,this.treeClientSearch=new c.Subject,this.ro=null,this.onChange=function(){return null},this.onTouched=function(){return null},this.initToggleAction(),this.initSelectionsChangeAction(),this.initDatasChangeAction(),this.commonUtils=this.injector.get(a.CommonUtils,null),this.willHide$.pipe(u.takeUntil(this.destroy$)).subscribe(function(e){if(!r.nosearch&&r.displayText!==r.originalText)if(r.displayText=r.originalText,r.isLookup())r.onChange(r.displayText);else{var t=r.comboService.getValue(r.textField);r.onValueChange({text:t,value:r.selectedValues,selections:r.selections})}r._searchKeyWords="",r.onTouched(),r.hidePanel.emit(r)}),this.ngZone=this.injector.get(p.NgZone),this.eventMgr=this.injector.get(l.EventManager),this.emitTextChange(),this.notifySer=this.injector.get(h.NotifyService,null)}var V,w={provide:r.NG_VALUE_ACCESSOR,useExisting:p.forwardRef(function(){return O}),multi:!0},O=(function D(e,t){function i(){this.constructor=e}b(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(L,V=E),Object.defineProperty(L.prototype,"clsTag",{get:function(){return"tag"===this.viewType},enumerable:!0,configurable:!0}),L.prototype.ngOnInit=function(){V.prototype.ngOnInit.call(this),this.multiSelect&&(this.enableCancelSelected=this.multiSelect),this.remoteSearch=!1},L.prototype.ngOnChanges=function(e){if(e.data&&!e.data.firstChange&&!this.uri&&!this.nosearch){var t=e.data.currentValue,i=this.selectedValues;if(this.selectedValues!==undefined&&null!==this.selectedValues||(i=this.displayText),i!==undefined&&null!==i&&t&&0<t.length){var n=this.filterSelections(i,this.data);this.displayText=n.filter(function(e){return!!e}).join(this.separator),this.updateSelections(i,this.data),this.comboService.selections$.next({action:"initData"})}else this.selections=[],this.displayText=""}},L.prototype.registerKeyboardEvent=function(e){var i=this;if(!(this.multiSelect||this.readonly||this.disabled)){"ArrowUp"!==e.code&&"ArrowDown"!==e.code&&(this.editable||this.readonly||this.disabled||"Space"!==e.code)||(e.preventDefault(),e.stopPropagation());var t=function(e){i.comboService.selectItem(n[e],e,!1);var t={data:n[e],index:e};i.isOpen&&i.scrollToCurrentItem(e),i.updateSelectValues(t)},n=this.filterData&&this.filterData.length?this.filterData:this.data;if(this._cmbPanel||(n=this.data),"ArrowUp"===e.code&&this.selectedValues){var o=n.findIndex(function(e){return i.commonUtils.getValue(i.idField,e)===i.selectedValues})-1;o<0&&(o=n.length-1),t(o)}if("ArrowDown"===e.code||"Space"===e.code&&!this.editable){var s=n.findIndex(function(e){return i.commonUtils.getValue(i.idField,e)===i.selectedValues})+1;s>=n.length&&(s=0),t(s)}}},L.prototype.escHandlerEvent=function(e){this.isOpen&&this.hide(!1)},L.prototype.onSelectionsChange=function(e){var t=this;this.uri&&this.selections&&this.selections.length&&(this.selectedValues=this.selections.map(function(e){return e[t.idField]}).join(this.separator))},L.prototype.updateSelectValues=function(e,t){void 0===t&&(t=!0);var i=S({},e),n=i.data,o=i.index;this.comboService.selectItem(n,o),this.dataListRef&&(this.selectedValues=this.dataListRef.selectedValues),this.multiSelect||(this.selectedValues=n[this.idField]);var s=this.comboService.getValue(this.textField);t&&(this.selectChange.emit({data:n,index:o,instance:this,selections:this.selections}),this.cdr.markForCheck(),this.onValueChange({text:s,value:this.selectedValues,selections:this.selections}))},L.prototype.scrollToCurrentItem=function(e){if(this.dataListRef&&this.dataListRef.el){var t=this.dataListRef.el.nativeElement.querySelector("ul.list-group");t&&t.children&&t.children[e]&&t.children[e].scrollIntoView({block:"nearest"})}},L.prototype.onSelect=function(e){this.updateSelectValues(e,!0),this.multiSelect||this.comboService.isOpen$.next(!1)},L.prototype.onUnSelected=function(e){var t=S({},e).data;this.comboService.unSelectItem(t),this.dataListRef&&(this.selectedValues=this.dataListRef.selectedValues);var i=this.comboService.getValue(this.textField);this.cdr.markForCheck(),this.onValueChange({text:i,value:this.selectedValues,selections:this.selections})},L.prototype.onEnter=function(e){this.isOpen&&this.hide()},L.prototype.onKeyup=function(e){},L.prototype.onKeydown=function(e){"Tab"===e.code&&this.hide(!1)},L.prototype.onFocus=function(e){"focus"===this.showPanelType&&this.show()},L.prototype.removeSelectItem=function(e,t){e&&e.stopPropagation(),this.comboService.unSelectItem(t),this.selectedValues=this.comboService.getValue(this.idField);var i=this.comboService.getValue(this.textField);this.cdr.detectChanges(),this.onValueChange({text:i,value:this.selectedValues,selections:this.selections})},L.prototype.initDatasChangeAction=function(){var n=this;this.comboService.data$.subscribe(function(e){if((n.filterData=e)&&e.length&&!n.editable){if("boolean"==typeof n.selectedValues)return;if(n.selectedValues){var t,i=[];i="number"==typeof n.selectedValues||"boolean"==typeof n.selectedValues?e.filter(function(e){return e[n.idField]===n.selectedValues||e[n.textField]===n.selectedValues}):n.selectedValues.split(n.separator).map(function(i){return e.find(function(e,t){return e[n.idField]===i||e[n.textField]===i})}),n.selections&&n.selections.length||i&&i.length&&(n.selectedValues=i.map(function(e){return n.commonUtils.getValue(n.idField,e)}).join(n.separator),n.selections=i),-1<(t=e.findIndex(function(e){return n.commonUtils.getValue(n.idField,e)===n.commonUtils.getValue(n.idField,n.selections[0])||n.commonUtils.getValue(n.textField,e)===n.commonUtils.getValue(n.textField,n.selections[0])}))&&setTimeout(function(){n.scrollToCurrentItem(t)},300)}}})},L.decorators=[{type:p.Component,args:[{selector:"farris-combo-list",template:'<input-group *ngIf="!viewType || viewType === \'text\'"\r\n    #input\r\n    [attr.title]="enableTitle? displayText: \'\'"\r\n    [class.actived]="isOpen"\r\n    [(value)]="displayText"\r\n    [disabled]="disabled"\r\n    [readonly]="readonly"\r\n    [forcePlaceholder]="forcePlaceholder"\r\n    [editable]="editable"\r\n    [groupText]="groupIcon"\r\n    [placeholder]="placeholder"\r\n    [enableClear] = "enableClear"\r\n    [maxLength]="maxLength"\r\n    (clickHandle)="onClick($event)"\r\n    (enterHandle)="onEnter($event)"\r\n    (blurHandle)="onBlur($event)"\r\n    (inputClick)="onInputclick($event)"\r\n    (focusHandle)="onFocus($event)"\r\n    (valueChange)="onTextChange($event)"\r\n    (clear)="onClear()"\r\n    (keyupHandle)="onKeyup($event)"\r\n    (keydownHandle)="onKeydown($event)"\r\n    style="display: block;">\r\n</input-group>\r\n\r\n<div #input2 class="f-cmp-inputgroup" *ngIf="viewType === \'tag\'" (click)="onClick($event)" [attr.title]="displayText">\r\n    <div class="input-group" [class.f-state-disabled]="disabled" [class.f-state-readonly]="readonly">\r\n        <div class="form-control f-cmp-inputgroup--multi-wrapper multi-more">\r\n            <div class="multi--content">\r\n                <span class="multi--item" *ngFor="let it of selections" >\r\n                    {{it[textField]}}\r\n                    <i class="f-icon multi--close" *ngIf="!readonly && !disabled " (click)="removeSelectItem($event, it)"></i>\r\n                </span>\r\n            </div>\r\n            <div class="multi--more" *ngIf="selections && selections.length">\r\n                <i class="f-icon multi--more-icon"></i><span class="multi--more-text">{{selections.length}}</span>\r\n            </div>\r\n        </div>\r\n        <div class="input-group-append" >\r\n            <span class="input-group-text input-group-clear ng-star-inserted" style="display: none;">\r\n                <i class="f-icon modal_close"></i>\r\n            </span>\r\n            <span class="input-group-text ng-star-inserted" (click)="onClick($event)">\r\n                <span class="f-icon f-icon-arrow-60-down"></span>\r\n            </span>\r\n        </div>\r\n    </div>\r\n</div>\r\n\r\n\r\n<div class="comboPanel f-area-hide" *ngIf="isOpen" style="z-index: 99999;transition: transform 0.12s ease;"  #comboPanel>\r\n    <farris-datalist\r\n        #dl\r\n        [itemHeight]="itemHeight"\r\n        [height]="panelHeight"\r\n        [data]="comboService.data$ | async"\r\n        [idField]="idField"\r\n        [multiSelect]="multiSelect"\r\n        [selectedValues]="selectedValuesStr"\r\n        [valueField]="valueField"\r\n        [textField]="textField"\r\n        [enableCancelSelected]="enableCancelSelected"\r\n        (selected)="onSelect($event)"\r\n        (unSelected)="onUnSelected($event)"\r\n        [separator]="separator"\r\n        style="position: relative;"\r\n    >\r\n        <ng-template list-item-tmp let-item="data.data" let-idx="index" *ngIf="itemTemplate">\r\n            <ng-container *ngTemplateOutlet="itemTemplate; context: { $implicit: item, index: idx }"> </ng-container>\r\n        </ng-template>\r\n    </farris-datalist>\r\n</div>\r\n',encapsulation:p.ViewEncapsulation.None,changeDetection:p.ChangeDetectionStrategy.OnPush,providers:[w,g]}]}],L.ctorParameters=function(){return[{type:p.ElementRef},{type:p.ChangeDetectorRef},{type:undefined,decorators:[{type:p.Inject,args:[n.DOCUMENT]}]},{type:p.Renderer2},{type:g},{type:p.Injector}]},L.propDecorators={itemTemplate:[{type:p.Input}],showPanelType:[{type:p.Input}],dataListRef:[{type:p.ViewChild,args:["dl"]}],itemHeight:[{type:p.Input}],cls:[{type:p.HostBinding,args:["class.f-combo-list"]}],clsTag:[{type:p.HostBinding,args:["class.f-combo-list--tag"]}],registerKeyboardEvent:[{type:p.HostListener,args:["keydown",["$event"]]}],escHandlerEvent:[{type:p.HostListener,args:["keydown.esc",["$event"]]}]},L);function L(e,t,i,n,o,s){var r=V.call(this,e,t,i,n,o,s)||this;return r.el=e,r.cdr=t,r.document=i,r.render=n,r.comboService=o,r.injector=s,r.showPanelType="click",r.cls=!0,r.filterData=[],r}var P=(F.decorators=[{type:p.NgModule,args:[{declarations:[O],imports:[n.CommonModule,r.FormsModule,s.HttpClientModule,d.InputGroupModule,m.LoadingModule.forRoot(),f.DatalistModule,h.NotifyModule.forRoot()],exports:[O],providers:[T]}]}],F);function F(){}e.ComboService=g,e.INPUT_COMBO_VALUE_ACCESSOR=w,e.ComboListComponent=O,e.ComboListModule=P,e.BaseComboComponent=E,e.ComboServerSideToken=y,e.ComboLocaleService=T,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=farris-ui-combo-list.umd.min.js.map