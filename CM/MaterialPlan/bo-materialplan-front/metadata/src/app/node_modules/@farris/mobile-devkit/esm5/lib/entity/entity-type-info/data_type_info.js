/*
 * @Author: Witt
 * @Date: 2018-12-07 09:05:09
 * @Last Modified by: Witt
 * @Last Modified time: 2018-12-27 20:35:02
 */
import { EntityMetadataUtil } from '../metadata/index';
import { DataPropGroup } from './data_prop_info';
/**
 * 实体类型信息
 * @todo：
 * 1、构造时不应该识别Entity模块的东西，应该是更抽象的；
 * 2、构造函数应该接收一个Builder接口，由Entity或者其他实现层来实现这个接口。
 */
var DataTypeInfo = /** @class */ (function () {
    /**
     * 构造函数
     * @todo：不应该识别
     */
    function DataTypeInfo(type) {
        this.type = type;
        this.primaryKey = '';
        this.foreignKey = '';
        this.propInfoMap = new Map();
        this.collectPropInfos();
    }
    Object.defineProperty(DataTypeInfo.prototype, "isValueObject", {
        /**
         * 是否为值对象
         */
        get: function () {
            return !this.primaryKey;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 获取全部属性信息
     */
    DataTypeInfo.prototype.getPropInfos = function () {
        return Array.from(this.propInfoMap.values());
    };
    /**
     * 获取全部属性的名称
     */
    DataTypeInfo.prototype.getPropNames = function () {
        var propNames = [];
        var propInfos = this.getPropInfos();
        propInfos.forEach(function (propInfo) {
            propNames.push(propInfo.name);
        });
        return propNames;
    };
    /**
     * 根据group获取属性信息数组
     */
    DataTypeInfo.prototype.getPropInfosByGroup = function (group) {
        var allPropInfos = Array.from(this.propInfoMap.values());
        var propInfos = allPropInfos.filter(function (propInfo) {
            return propInfo.group === group;
        });
        return propInfos;
    };
    /**
     * 根据group获取属性名称数组
     * @param group 属性分组
     */
    DataTypeInfo.prototype.getPropNamesByGroup = function (group) {
        var propNames = [];
        var propInfos = this.getPropInfosByGroup(group);
        propInfos.forEach(function (propInfo) {
            propNames.push(propInfo.name);
        });
        return propNames;
    };
    /**
     * 根据propName获取属性信息
     */
    DataTypeInfo.prototype.getPropInfoByName = function (propName) {
        if (this.propInfoMap.has(propName)) {
            return this.propInfoMap.get(propName);
        }
        return null;
    };
    /**
     * 根据path获取属性信息
     */
    DataTypeInfo.prototype.getPropInfoByPath = function (path) {
        // 先复制，防止shift方法产生污染
        var arrPath = path.concat([]);
        if (arrPath.length === 0) {
            throw Error("\u5C5E\u6027\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A");
        }
        // 循环查找
        var typeInfo = this;
        var propInfo = null;
        while (typeInfo && arrPath.length > 0) {
            var propName = arrPath.shift();
            propInfo = typeInfo.getPropInfoByName(propName);
            if (!propInfo) {
                throw Error("\u8DEF\u5F84" + path + "\u4E2D\u5B58\u5728\u4E0D\u6B63\u786E\u7684\u8282\u70B9" + propName + "\uFF0C\u8BF7\u68C0\u67E5");
            }
            typeInfo = propInfo.typeInfo;
            // 如果是动态列，并且路径数组里还有属性，统一设置为null(动态列不再描述属性信息)
            if (propInfo.group === DataPropGroup.Dynamic && arrPath.length > 0) {
                propInfo = null;
                typeInfo = null;
            }
        }
        return propInfo;
    };
    /**
     * 根据path获取对应属性的TypeInfo
     */
    DataTypeInfo.prototype.getTypeInfoByPath = function (path) {
        // 空数组时返回
        if (path.length === 0) {
            return this;
        }
        // 获取对应属性信息
        var propInfo = this.getPropInfoByPath(path);
        if (!propInfo.typeInfo) {
            throw Error("\u8DEF\u5F84" + path + "\u65E0\u6CD5\u5B9A\u4F4D\u5230\u4E00\u4E2AEntityTypeInfo\uFF0C\u8BF7\u68C0\u67E5");
        }
        return propInfo.typeInfo;
    };
    /**
     * 获取主键的属性信息
     */
    DataTypeInfo.prototype.getPrimaryKeyPropInfo = function () {
        return this.getPropInfoByName(this.primaryKey);
    };
    /**
     * 根据name获取影射名
     */
    DataTypeInfo.prototype.getPropMappingByName = function (name) {
        var propInfo = this.getPropInfoByName(name);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    };
    /**
     * 根据path获取映射名
     */
    DataTypeInfo.prototype.getPropMappingByPath = function (path) {
        var propInfo = this.getPropInfoByPath(path);
        if (!propInfo) {
            return '';
        }
        return propInfo.mapping;
    };
    /**
     * 检查属性是否属于特定的分组
     */
    DataTypeInfo.prototype.checkPropGroup = function (propName, propGroup) {
        var propInfo = this.getPropInfoByName(propName);
        if (propInfo && propInfo.group === propGroup) {
            return true;
        }
        return false;
    };
    /**
     * --------------------------------------------------------------------------------
     * 属性元数据 => 属性描述信息
     * --------------------------------------------------------------------------------
     */
    /**
     * 搜集所有属性信息
     * @todo：消除重复代码，ts不支持interface类型检测，暂时通过遍历实现。
     */
    DataTypeInfo.prototype.collectPropInfos = function () {
        var _this = this;
        // 简单属性
        var ngPlainProperties = EntityMetadataUtil.getNgFieldProperties(this.type);
        Object.keys(ngPlainProperties).forEach(function (propName) {
            var ngProperty = ngPlainProperties[propName];
            if (ngProperty.primary === true) {
                _this.primaryKey = propName;
            }
            if (ngProperty.foreign === true) {
                _this.foreignKey = propName;
            }
            _this.addPropInfo(DataPropGroup.Primitive, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体属性
        var ngEntityProperties = EntityMetadataUtil.getNgObjectProperties(this.type);
        Object.keys(ngEntityProperties).forEach(function (propName) {
            var ngProperty = ngEntityProperties[propName];
            _this.addPropInfo(DataPropGroup.Object, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
        // 动态实体属性
        var ngDynamicProperties = EntityMetadataUtil.getNgDynamicProperties(this.type);
        Object.keys(ngDynamicProperties).forEach(function (propName) {
            var ngProperty = ngDynamicProperties[propName];
            _this.addPropInfo(DataPropGroup.Dynamic, propName, ngProperty.dataField, null, ngProperty);
        });
        // 实体列表属性
        var ngEntityListProperties = EntityMetadataUtil.getNgListProperties(this.type);
        Object.keys(ngEntityListProperties).forEach(function (propName) {
            var ngProperty = ngEntityListProperties[propName];
            _this.addPropInfo(DataPropGroup.List, propName, ngProperty.dataField, ngProperty.type, ngProperty);
        });
    };
    /**
     * 添加属性信息
     */
    DataTypeInfo.prototype.addPropInfo = function (group, name, mapping, type, metadataInfo) {
        // 没有设置影射时，用属性名充当影射
        mapping = mapping ? mapping : name;
        var typeInfo = null;
        if (type) {
            typeInfo = new DataTypeInfo(type);
        }
        var propInfo = { group: group, name: name, mapping: mapping, typeInfo: typeInfo, metadataInfo: metadataInfo };
        this.propInfoMap.set(name, propInfo);
    };
    return DataTypeInfo;
}());
export { DataTypeInfo };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YV90eXBlX2luZm8uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2VudGl0eS10eXBlLWluZm8vZGF0YV90eXBlX2luZm8udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFHSCxPQUFPLEVBRUwsa0JBQWtCLEVBQ25CLE1BQU0sbUJBQW1CLENBQUM7QUFDM0IsT0FBTyxFQUFFLGFBQWEsRUFBZ0IsTUFBTSxrQkFBa0IsQ0FBQztBQUUvRDs7Ozs7R0FLRztBQUNIO0lBNkJFOzs7T0FHRztJQUNILHNCQUFZLElBQVM7UUFDbkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFVBQVUsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FBQztRQUNuRCxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBZEQsc0JBQVcsdUNBQWE7UUFIeEI7O1dBRUc7YUFDSDtZQUNFLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzFCLENBQUM7OztPQUFBO0lBY0Q7O09BRUc7SUFDSSxtQ0FBWSxHQUFuQjtRQUNFLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVEOztPQUVHO0lBQ0ksbUNBQVksR0FBbkI7UUFDRSxJQUFNLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RDLFNBQVMsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFRO1lBQ3pCLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxD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elBELElBeVBDO0FBRUQsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogV2l0dFxyXG4gKiBARGF0ZTogMjAxOC0xMi0wNyAwOTowNTowOVxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogV2l0dFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE4LTEyLTI3IDIwOjM1OjAyXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgVHlwZSB9IGZyb20gJy4uLy4uL2NvcmUvdHlwZXMnO1xyXG5pbXBvcnQge1xyXG4gIFByb3BNZXRhZGF0YSwgUHJpbWl0aXZlUHJvcE1ldGFkYXRhLCBPYmplY3RQcm9wTWV0YWRhdGEsIER5bmFtaWNQcm9wTWV0YWRhdGEsIExpc3RQcm9wTWV0YWRhdGEsXHJcbiAgRW50aXR5TWV0YWRhdGFVdGlsXHJcbn0gZnJvbSAnLi4vbWV0YWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBEYXRhUHJvcEdyb3VwLCBEYXRhUHJvcEluZm8gfSBmcm9tICcuL2RhdGFfcHJvcF9pbmZvJztcclxuXHJcbi8qKlxyXG4gKiDlrp7kvZPnsbvlnovkv6Hmga9cclxuICogQHRvZG/vvJpcclxuICogMeOAgeaehOmAoOaXtuS4jeW6lOivpeivhuWIq0VudGl0eeaooeWdl+eahOS4nOilv++8jOW6lOivpeaYr+abtOaKveixoeeahO+8m1xyXG4gKiAy44CB5p6E6YCg5Ye95pWw5bqU6K+l5o6l5pS25LiA5LiqQnVpbGRlcuaOpeWPo++8jOeUsUVudGl0eeaIluiAheWFtuS7luWunueOsOWxguadpeWunueOsOi/meS4quaOpeWPo+OAglxyXG4gKi9cclxuY2xhc3MgRGF0YVR5cGVJbmZvIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5pWw5o2u57G75Z6LXHJcbiAgICovXHJcbiAgcHVibGljIHR5cGU6IFR5cGU8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICog5bGe5oCn6ZuG5ZCIXHJcbiAgICovXHJcbiAgcHVibGljIHByb3BJbmZvTWFwOiBNYXA8c3RyaW5nLCBEYXRhUHJvcEluZm8+O1xyXG5cclxuICAvKipcclxuICAgKiDkuLvplK5cclxuICAgKi9cclxuICBwdWJsaWMgcHJpbWFyeUtleTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDlpJbplK5cclxuICAgKi9cclxuICBwdWJsaWMgZm9yZWlnbktleTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDmmK/lkKbkuLrlgLzlr7nosaFcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGlzVmFsdWVPYmplY3QoKSB7XHJcbiAgICByZXR1cm4gIXRoaXMucHJpbWFyeUtleTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqIEB0b2Rv77ya5LiN5bqU6K+l6K+G5YirXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IodHlwZTogYW55KSB7XHJcbiAgICB0aGlzLnR5cGUgPSB0eXBlO1xyXG4gICAgdGhpcy5wcmltYXJ5S2V5ID0gJyc7XHJcbiAgICB0aGlzLmZvcmVpZ25LZXkgPSAnJztcclxuICAgIHRoaXMucHJvcEluZm9NYXAgPSBuZXcgTWFwPHN0cmluZywgRGF0YVByb3BJbmZvPigpO1xyXG4gICAgdGhpcy5jb2xsZWN0UHJvcEluZm9zKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blhajpg6jlsZ7mgKfkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UHJvcEluZm9zKCk6IERhdGFQcm9wSW5mb1tdIHtcclxuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMucHJvcEluZm9NYXAudmFsdWVzKCkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5YWo6YOo5bGe5oCn55qE5ZCN56ewXHJcbiAgICovXHJcbiAgcHVibGljIGdldFByb3BOYW1lcygpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwcm9wTmFtZXMgPSBbXTtcclxuICAgIGNvbnN0IHByb3BJbmZvcyA9IHRoaXMuZ2V0UHJvcEluZm9zKCk7XHJcbiAgICBwcm9wSW5mb3MuZm9yRWFjaCgocHJvcEluZm8pID0+IHtcclxuICAgICAgcHJvcE5hbWVzLnB1c2gocHJvcEluZm8ubmFtZSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBwcm9wTmFtZXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja5ncm91cOiOt+WPluWxnuaAp+S/oeaBr+aVsOe7hFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcm9wSW5mb3NCeUdyb3VwKGdyb3VwOiBEYXRhUHJvcEdyb3VwKTogRGF0YVByb3BJbmZvW10ge1xyXG4gICAgY29uc3QgYWxsUHJvcEluZm9zID0gQXJyYXkuZnJvbSh0aGlzLnByb3BJbmZvTWFwLnZhbHVlcygpKTtcclxuICAgIGNvbnN0IHByb3BJbmZvcyA9IGFsbFByb3BJbmZvcy5maWx0ZXIoKHByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcclxuICAgICAgcmV0dXJuIHByb3BJbmZvLmdyb3VwID09PSBncm91cDtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHByb3BJbmZvcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrmdyb3Vw6I635Y+W5bGe5oCn5ZCN56ew5pWw57uEXHJcbiAgICogQHBhcmFtIGdyb3VwIOWxnuaAp+WIhue7hFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcm9wTmFtZXNCeUdyb3VwKGdyb3VwOiBEYXRhUHJvcEdyb3VwKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcHJvcE5hbWVzID0gW107XHJcbiAgICBjb25zdCBwcm9wSW5mb3MgPSB0aGlzLmdldFByb3BJbmZvc0J5R3JvdXAoZ3JvdXApO1xyXG4gICAgcHJvcEluZm9zLmZvckVhY2goKHByb3BJbmZvKSA9PiB7XHJcbiAgICAgIHByb3BOYW1lcy5wdXNoKHByb3BJbmZvLm5hbWUpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcHJvcE5hbWVzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucHJvcE5hbWXojrflj5blsZ7mgKfkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UHJvcEluZm9CeU5hbWUocHJvcE5hbWU6IHN0cmluZyk6IERhdGFQcm9wSW5mbyB7XHJcbiAgICBpZiAodGhpcy5wcm9wSW5mb01hcC5oYXMocHJvcE5hbWUpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnByb3BJbmZvTWFwLmdldChwcm9wTmFtZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrnBhdGjojrflj5blsZ7mgKfkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UHJvcEluZm9CeVBhdGgocGF0aDogc3RyaW5nW10pOiBEYXRhUHJvcEluZm8ge1xyXG5cclxuICAgIC8vIOWFiOWkjeWItu+8jOmYsuatonNoaWZ05pa55rOV5Lqn55Sf5rGh5p+TXHJcbiAgICBjb25zdCBhcnJQYXRoID0gcGF0aC5jb25jYXQoW10pO1xyXG4gICAgaWYgKGFyclBhdGgubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRocm93IEVycm9yKGDlsZ7mgKfot6/lvoTkuI3og73kuLrnqbpgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDlvqrnjq/mn6Xmib5cclxuICAgIGxldCB0eXBlSW5mbyA9IHRoaXM7XHJcbiAgICBsZXQgcHJvcEluZm8gPSBudWxsO1xyXG4gICAgd2hpbGUgKHR5cGVJbmZvICYmIGFyclBhdGgubGVuZ3RoID4gMCkge1xyXG5cclxuICAgICAgY29uc3QgcHJvcE5hbWUgPSBhcnJQYXRoLnNoaWZ0KCk7XHJcbiAgICAgIHByb3BJbmZvID0gdHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUocHJvcE5hbWUpO1xyXG4gICAgICBpZiAoIXByb3BJbmZvKSB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoYOi3r+W+hCR7cGF0aH3kuK3lrZjlnKjkuI3mraPnoa7nmoToioLngrkke3Byb3BOYW1lfe+8jOivt+ajgOafpWApO1xyXG4gICAgICB9XHJcbiAgICAgIHR5cGVJbmZvID0gcHJvcEluZm8udHlwZUluZm87XHJcblxyXG4gICAgICAvLyDlpoLmnpzmmK/liqjmgIHliJfvvIzlubbkuJTot6/lvoTmlbDnu4Tph4zov5jmnInlsZ7mgKfvvIznu5/kuIDorr7nva7kuLpudWxsKOWKqOaAgeWIl+S4jeWGjeaPj+i/sOWxnuaAp+S/oeaBrylcclxuICAgICAgaWYgKHByb3BJbmZvLmdyb3VwID09PSBEYXRhUHJvcEdyb3VwLkR5bmFtaWMgJiYgYXJyUGF0aC5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcHJvcEluZm8gPSBudWxsO1xyXG4gICAgICAgIHR5cGVJbmZvID0gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwcm9wSW5mbztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrnBhdGjojrflj5blr7nlupTlsZ7mgKfnmoRUeXBlSW5mb1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRUeXBlSW5mb0J5UGF0aChwYXRoOiBzdHJpbmdbXSk6IERhdGFUeXBlSW5mbyB7XHJcblxyXG4gICAgLy8g56m65pWw57uE5pe26L+U5ZueXHJcbiAgICBpZiAocGF0aC5sZW5ndGggPT09IDApIHtcclxuICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W5a+55bqU5bGe5oCn5L+h5oGvXHJcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMuZ2V0UHJvcEluZm9CeVBhdGgocGF0aCk7XHJcbiAgICBpZiAoIXByb3BJbmZvLnR5cGVJbmZvKSB7XHJcbiAgICAgIHRocm93IEVycm9yKGDot6/lvoQke3BhdGh95peg5rOV5a6a5L2N5Yiw5LiA5LiqRW50aXR5VHlwZUluZm/vvIzor7fmo4Dmn6VgKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcHJvcEluZm8udHlwZUluZm87XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bkuLvplK7nmoTlsZ7mgKfkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UHJpbWFyeUtleVByb3BJbmZvKCk6IERhdGFQcm9wSW5mbyB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRQcm9wSW5mb0J5TmFtZSh0aGlzLnByaW1hcnlLZXkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ubmFtZeiOt+WPluW9seWwhOWQjVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRQcm9wTWFwcGluZ0J5TmFtZShuYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcHJvcEluZm8gPSB0aGlzLmdldFByb3BJbmZvQnlOYW1lKG5hbWUpO1xyXG4gICAgaWYgKCFwcm9wSW5mbykge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcHJvcEluZm8ubWFwcGluZztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrnBhdGjojrflj5bmmKDlsITlkI1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UHJvcE1hcHBpbmdCeVBhdGgocGF0aDogc3RyaW5nW10pOiBzdHJpbmcge1xyXG4gICAgY29uc3QgcHJvcEluZm8gPSB0aGlzLmdldFByb3BJbmZvQnlQYXRoKHBhdGgpO1xyXG4gICAgaWYgKCFwcm9wSW5mbykge1xyXG4gICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcHJvcEluZm8ubWFwcGluZztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOajgOafpeWxnuaAp+aYr+WQpuWxnuS6jueJueWumueahOWIhue7hFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGVja1Byb3BHcm91cChwcm9wTmFtZTogc3RyaW5nLCBwcm9wR3JvdXA6IERhdGFQcm9wR3JvdXApOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHByb3BJbmZvID0gdGhpcy5nZXRQcm9wSW5mb0J5TmFtZShwcm9wTmFtZSk7XHJcbiAgICBpZiAocHJvcEluZm8gJiYgcHJvcEluZm8uZ3JvdXAgPT09IHByb3BHcm91cCkge1xyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAqIOWxnuaAp+WFg+aVsOaNriA9PiDlsZ7mgKfmj4/ov7Dkv6Hmga9cclxuICAgKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxyXG4gICAqL1xyXG5cclxuICAvKipcclxuICAgKiDmkJzpm4bmiYDmnInlsZ7mgKfkv6Hmga9cclxuICAgKiBAdG9kb++8mua2iOmZpOmHjeWkjeS7o+egge+8jHRz5LiN5pSv5oyBaW50ZXJmYWNl57G75Z6L5qOA5rWL77yM5pqC5pe26YCa6L+H6YGN5Y6G5a6e546w44CCXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb2xsZWN0UHJvcEluZm9zKCkge1xyXG5cclxuICAgIC8vIOeugOWNleWxnuaAp1xyXG4gICAgY29uc3QgbmdQbGFpblByb3BlcnRpZXMgPSBFbnRpdHlNZXRhZGF0YVV0aWwuZ2V0TmdGaWVsZFByb3BlcnRpZXModGhpcy50eXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nUGxhaW5Qcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nUHJvcGVydHkgPSBuZ1BsYWluUHJvcGVydGllc1twcm9wTmFtZV0gYXMgUHJpbWl0aXZlUHJvcE1ldGFkYXRhO1xyXG4gICAgICBpZiAobmdQcm9wZXJ0eS5wcmltYXJ5ID09PSB0cnVlKSB7XHJcbiAgICAgICAgdGhpcy5wcmltYXJ5S2V5ID0gcHJvcE5hbWU7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKG5nUHJvcGVydHkuZm9yZWlnbiA9PT0gdHJ1ZSkge1xyXG4gICAgICAgIHRoaXMuZm9yZWlnbktleSA9IHByb3BOYW1lO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuYWRkUHJvcEluZm8oRGF0YVByb3BHcm91cC5QcmltaXRpdmUsIHByb3BOYW1lLCBuZ1Byb3BlcnR5LmRhdGFGaWVsZCwgbnVsbCwgbmdQcm9wZXJ0eSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDlrp7kvZPlsZ7mgKdcclxuICAgIGNvbnN0IG5nRW50aXR5UHJvcGVydGllcyA9IEVudGl0eU1ldGFkYXRhVXRpbC5nZXROZ09iamVjdFByb3BlcnRpZXModGhpcy50eXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRW50aXR5UHJvcGVydGllcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBuZ1Byb3BlcnR5ID0gbmdFbnRpdHlQcm9wZXJ0aWVzW3Byb3BOYW1lXSBhcyBPYmplY3RQcm9wTWV0YWRhdGE7XHJcbiAgICAgIHRoaXMuYWRkUHJvcEluZm8oRGF0YVByb3BHcm91cC5PYmplY3QsIHByb3BOYW1lLCBuZ1Byb3BlcnR5LmRhdGFGaWVsZCwgbmdQcm9wZXJ0eS50eXBlLCBuZ1Byb3BlcnR5KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOWKqOaAgeWunuS9k+WxnuaAp1xyXG4gICAgY29uc3QgbmdEeW5hbWljUHJvcGVydGllcyA9IEVudGl0eU1ldGFkYXRhVXRpbC5nZXROZ0R5bmFtaWNQcm9wZXJ0aWVzKHRoaXMudHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0R5bmFtaWNQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nUHJvcGVydHkgPSBuZ0R5bmFtaWNQcm9wZXJ0aWVzW3Byb3BOYW1lXSBhcyBEeW5hbWljUHJvcE1ldGFkYXRhO1xyXG4gICAgICB0aGlzLmFkZFByb3BJbmZvKERhdGFQcm9wR3JvdXAuRHluYW1pYywgcHJvcE5hbWUsIG5nUHJvcGVydHkuZGF0YUZpZWxkLCBudWxsLCBuZ1Byb3BlcnR5KTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOWunuS9k+WIl+ihqOWxnuaAp1xyXG4gICAgY29uc3QgbmdFbnRpdHlMaXN0UHJvcGVydGllcyA9IEVudGl0eU1ldGFkYXRhVXRpbC5nZXROZ0xpc3RQcm9wZXJ0aWVzKHRoaXMudHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0VudGl0eUxpc3RQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nUHJvcGVydHkgPSBuZ0VudGl0eUxpc3RQcm9wZXJ0aWVzW3Byb3BOYW1lXSBhcyBMaXN0UHJvcE1ldGFkYXRhO1xyXG4gICAgICB0aGlzLmFkZFByb3BJbmZvKERhdGFQcm9wR3JvdXAuTGlzdCwgcHJvcE5hbWUsIG5nUHJvcGVydHkuZGF0YUZpZWxkLCBuZ1Byb3BlcnR5LnR5cGUsIG5nUHJvcGVydHkpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDlsZ7mgKfkv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGFkZFByb3BJbmZvKGdyb3VwOiBEYXRhUHJvcEdyb3VwLCBuYW1lOiBzdHJpbmcsIG1hcHBpbmc6IHN0cmluZywgdHlwZTogVHlwZTxhbnk+LCBtZXRhZGF0YUluZm86IFByb3BNZXRhZGF0YSkge1xyXG5cclxuICAgIC8vIOayoeacieiuvue9ruW9seWwhOaXtu+8jOeUqOWxnuaAp+WQjeWFheW9k+W9seWwhFxyXG4gICAgbWFwcGluZyA9IG1hcHBpbmcgPyBtYXBwaW5nIDogbmFtZTtcclxuICAgIGxldCB0eXBlSW5mbyA9IG51bGw7XHJcbiAgICBpZiAodHlwZSkge1xyXG4gICAgICB0eXBlSW5mbyA9IG5ldyBEYXRhVHlwZUluZm8odHlwZSk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBwcm9wSW5mbyA9IHsgZ3JvdXAsIG5hbWUsIG1hcHBpbmcsIHR5cGVJbmZvLCBtZXRhZGF0YUluZm8gfTtcclxuICAgIHRoaXMucHJvcEluZm9NYXAuc2V0KG5hbWUsIHByb3BJbmZvKTtcclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBEYXRhVHlwZUluZm8gfTtcclxuIl19