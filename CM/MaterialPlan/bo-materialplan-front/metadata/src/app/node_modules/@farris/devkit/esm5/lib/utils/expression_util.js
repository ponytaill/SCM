import * as tslib_1 from "tslib";
import { DataPropGroup } from "../core/index";
import { ENTITY_TEMPLATE, GROUP_FUNCTIONS } from "../resolver/index";
var ExpressionUtil = /** @class */ (function () {
    function ExpressionUtil() {
    }
    ExpressionUtil.getGroupFunctionDependency = function (expr, entityTypeInfo) {
        var _this = this;
        var deps = [];
        // 获取聚合函数依赖项
        var groupFunctionRegex = new RegExp("DefaultFunction\\.(" + GROUP_FUNCTIONS.join('|') + ")\\s*\\([^\\r\\n\\)]*\\)", "g");
        var groupFunctions = expr.match(groupFunctionRegex);
        if (groupFunctions && groupFunctions.length > 0) {
            // todo: 使用正则匹配时可能会因为参数中有逗号导致问题，后续使用ast解析
            var argumentsRegex_1 = /\(([^\r\n\)]*)\)/;
            var methodNameRegex_1 = /DefaultFunction\.(\S*)\(/;
            groupFunctions.forEach(function (groupFunction) {
                var argumentMatchResult = groupFunction.match(argumentsRegex_1);
                var methodNameMatchResult = groupFunction.match(methodNameRegex_1);
                var methodName = null;
                if (methodNameMatchResult && methodNameMatchResult.length == 2) {
                    methodName = methodNameMatchResult[1];
                }
                if (argumentMatchResult.length === 2) {
                    var argument = argumentMatchResult[1];
                    var args = argument.split(',').map(function (p) { return p.replace(/\"/g, ''); });
                    if (args && args.length === 2) {
                        var item = args.join('.');
                        item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                        // 移除主表code
                        item = item.substr(item.indexOf('.') + 1);
                        var dep = item.split('.');
                        dep.splice(0, 0, ENTITY_TEMPLATE);
                        deps.push(dep.join('/'));
                    }
                    else if (args && args.length === 3 && methodName === 'MultiplyChildNumber') {
                        // support MultiplyChildNumber
                        // [Entity.childrens,prop1,prop2]
                        var prefix = args[0]; // like Entity.childrens
                        //const tableName = args[0];// prefix.substring(prefix.indexOf('.')+1);
                        var prop1FullPath = prefix + "." + args[1];
                        var prop2FullPath = prefix + "." + args[2];
                        [prop1FullPath, prop2FullPath].forEach(function (item) {
                            item = _this.convertToNodeCode(item, entityTypeInfo).join('.');
                            item = item.substr(item.indexOf('.') + 1);
                            var dep = item.split('.');
                            dep.splice(0, 0, ENTITY_TEMPLATE);
                            deps.push(dep.join('/'));
                        });
                    }
                    else {
                        throw new Error("\u65E0\u6CD5\u89E3\u6790\u53C2\u6570\uFF1A " + JSON.stringify(argument));
                    }
                }
            });
        }
        return deps;
    };
    /**
     * 将voCode转换为前端nodeCode
     * @param entityExpression like Entity.Child.p1
     * @returns
     */
    ExpressionUtil.convertToNodeCode = function (entityExpression, entityTypeInfo) {
        // UserEntity.storys.p1
        var nodeCodes = [];
        if (entityTypeInfo && entityExpression.includes('.')) {
            var entityExpressions = entityExpression.split('.') || [];
            var dataTypeInfo = entityTypeInfo;
            for (var index = 0; index < entityExpressions.length; index++) {
                var prop = entityExpressions[index];
                if (dataTypeInfo && dataTypeInfo.entityInfo && dataTypeInfo.entityInfo.nodeCode === prop || dataTypeInfo.entityInfo.originalCode === prop) {
                    // 第一个是主表code，不能转nodeCode
                    if (index === 0) {
                        nodeCodes.push(dataTypeInfo.entityInfo.originalCode);
                    }
                    else {
                        nodeCodes.push(dataTypeInfo.entityInfo.nodeCode);
                    }
                    // 下一级可能为子表、对象或属性
                    var nextNodeCode = entityExpressions[index + 1];
                    if (!nextNodeCode) {
                        break;
                    }
                    var nextNodeCodePropInfo = dataTypeInfo.getPropInfoByName(nextNodeCode);
                    if (!nextNodeCodePropInfo) {
                        break;
                    }
                    // 下一级为子表或对象
                    if (nextNodeCodePropInfo.typeInfo) {
                        dataTypeInfo = nextNodeCodePropInfo.typeInfo;
                    }
                }
                else if (dataTypeInfo && dataTypeInfo.getPropInfoByName(prop)) {
                    var dataPropInfo = dataTypeInfo.getPropInfoByName(prop);
                    nodeCodes.push(dataPropInfo.name);
                }
                else {
                    //throw new Error(`错误的属性参数 ${entityExpression}`);
                    break;
                }
            }
        }
        return nodeCodes;
    };
    /**
     * 找到元数据中所有实体路径
     * @param dataTypeInfo
     * @param results
     * @param paths
     */
    ExpressionUtil.getChildrenEntityPaths = function (dataTypeInfo, results, paths) {
        var _this = this;
        if (paths === void 0) { paths = []; }
        var list = dataTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach(function (dataPropInfo) {
                if (paths.length === 0) {
                    results.push([dataPropInfo.name]);
                }
                var childrens = dataPropInfo.typeInfo.getPropInfosByGroup(DataPropGroup.List);
                if (childrens && childrens.length > 0) {
                    paths.push(dataPropInfo.name);
                    childrens.forEach(function (dataPropInfo) {
                        _this.getChildrenEntityPaths(dataPropInfo.typeInfo, results, paths);
                    });
                }
                else {
                    if (paths.length !== 0) {
                        paths.push(dataPropInfo.name);
                        results.push(tslib_1.__spread(paths));
                    }
                    paths.length = 0;
                }
            });
        }
        else {
            if (paths.length > 0) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
                results.push(tslib_1.__spread(paths));
            }
            paths.length = 0;
        }
    };
    /**
     * 获取指定绑定路径的当前行数据
     * @param paths 绑定路径
     * @param bindingData
     * @returns
     */
    ExpressionUtil.getCurrentRowByPaths = function (paths, bindingData) {
        var result = null;
        var bindingList = bindingData.getValue(paths);
        if (bindingList && bindingList.length > 0) {
            var primaryValue = bindingList.currentItem.primaryKeyValue || null;
            // 使用事件中的主键
            // 主表或下级表新增，此时事件行就是当前行，无需处理
            if (primaryValue) {
                var bindingObject = bindingList.findById(primaryValue);
                if (bindingObject) {
                    result = bindingObject.toJSON();
                }
            }
        }
        return result;
    };
    /**
     * 从实体路径中获取级数最大的从表或从从表
     * @param paths
     * @returns
     */
    ExpressionUtil.getAvailableChildrenPathsFromEntityPaths = function (paths, entityTypeInfo) {
        var nodeCodes = [];
        paths = tslib_1.__spread(paths);
        while (paths.length > 0) {
            var dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo && dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    };
    /**
     * 从路径中获取绑定路径
     * @param paths 路径
     * @param entityTypeInfo entityTypeInfo
     * @returns
     */
    ExpressionUtil.getBindingPath = function (paths, entityTypeInfo) {
        paths = this.getEntityPath(paths);
        var entityPaths = this.getAvailableChildrenPathsFromEntityPaths(paths, entityTypeInfo);
        return entityPaths;
    };
    ExpressionUtil.getEntityPath = function (path) {
        var paths = path.filter(function (value, index) {
            if (index % 2 === 0 && value.includes(':')) {
                return false;
            }
            else {
                return true;
            }
        });
        return paths;
    };
    return ExpressionUtil;
}());
export { ExpressionUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl91dGlsLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvdXRpbHMvZXhwcmVzc2lvbl91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsYUFBYSxFQUE4QixNQUFNLGVBQWUsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZUFBZSxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXJFO0lBQUE7SUErTEEsQ0FBQztJQTlMZSx5Q0FBMEIsR0FBeEMsVUFBeUMsSUFBWSxFQUFFLGNBQTRCO1FBQW5GLGlCQWdEQztRQS9DQyxJQUFNLElBQUksR0FBRyxFQUFFLENBQUM7UUFDaEIsWUFBWTtRQUNaLElBQU0sa0JBQWtCLEdBQUcsSUFBSSxNQUFNLENBQUMsd0JBQXNCLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLDZCQUEwQixFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3RILElBQU0sY0FBYyxHQUFxQixJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDeEUsSUFBSSxjQUFjLElBQUksY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0MseUNBQXlDO1lBQ3pDLElBQU0sZ0JBQWMsR0FBRyxrQkFBa0IsQ0FBQztZQUMxQyxJQUFNLGlCQUFlLEdBQUcsMEJBQTBCLENBQUM7WUFDbkQsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFDLGFBQXFCO2dCQUMzQyxJQUFNLG1CQUFtQixHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsZ0JBQWMsQ0FBQyxDQUFDO2dCQUNoRSxJQUFNLHFCQUFxQixHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUMsaUJBQWUsQ0FBQyxDQUFDO2dCQUNuRSxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUM7Z0JBQ3RCLElBQUkscUJBQXFCLElBQUkscUJBQXFCLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtvQkFDOUQs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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0IH0gZnJvbSBcIi4uL2JpbmRpbmctZGF0YS9pbmRleFwiO1xyXG5pbXBvcnQgeyBEYXRhUHJvcEdyb3VwLCBEYXRhUHJvcEluZm8sIERhdGFUeXBlSW5mbyB9IGZyb20gXCIuLi9jb3JlL2luZGV4XCI7XHJcbmltcG9ydCB7IEVOVElUWV9URU1QTEFURSwgR1JPVVBfRlVOQ1RJT05TIH0gZnJvbSBcIi4uL3Jlc29sdmVyL2luZGV4XCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvblV0aWwge1xyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0R3JvdXBGdW5jdGlvbkRlcGVuZGVuY3koZXhwcjogc3RyaW5nLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgZGVwcyA9IFtdO1xyXG4gICAgLy8g6I635Y+W6IGa5ZCI5Ye95pWw5L6d6LWW6aG5XHJcbiAgICBjb25zdCBncm91cEZ1bmN0aW9uUmVnZXggPSBuZXcgUmVnRXhwKGBEZWZhdWx0RnVuY3Rpb25cXFxcLigke0dST1VQX0ZVTkNUSU9OUy5qb2luKCd8Jyl9KVxcXFxzKlxcXFwoW15cXFxcclxcXFxuXFxcXCldKlxcXFwpYCwgXCJnXCIpO1xyXG4gICAgY29uc3QgZ3JvdXBGdW5jdGlvbnM6IFJlZ0V4cE1hdGNoQXJyYXkgPSBleHByLm1hdGNoKGdyb3VwRnVuY3Rpb25SZWdleCk7XHJcbiAgICBpZiAoZ3JvdXBGdW5jdGlvbnMgJiYgZ3JvdXBGdW5jdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAvLyB0b2RvOiDkvb/nlKjmraPliJnljLnphY3ml7blj6/og73kvJrlm6DkuLrlj4LmlbDkuK3mnInpgJflj7flr7zoh7Tpl67popjvvIzlkI7nu63kvb/nlKhhc3Top6PmnpBcclxuICAgICAgY29uc3QgYXJndW1lbnRzUmVnZXggPSAvXFwoKFteXFxyXFxuXFwpXSopXFwpLztcclxuICAgICAgY29uc3QgbWV0aG9kTmFtZVJlZ2V4ID0gL0RlZmF1bHRGdW5jdGlvblxcLihcXFMqKVxcKC87XHJcbiAgICAgIGdyb3VwRnVuY3Rpb25zLmZvckVhY2goKGdyb3VwRnVuY3Rpb246IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IGFyZ3VtZW50TWF0Y2hSZXN1bHQgPSBncm91cEZ1bmN0aW9uLm1hdGNoKGFyZ3VtZW50c1JlZ2V4KTtcclxuICAgICAgICBjb25zdCBtZXRob2ROYW1lTWF0Y2hSZXN1bHQgPSBncm91cEZ1bmN0aW9uLm1hdGNoKG1ldGhvZE5hbWVSZWdleCk7XHJcbiAgICAgICAgbGV0IG1ldGhvZE5hbWUgPSBudWxsO1xyXG4gICAgICAgIGlmIChtZXRob2ROYW1lTWF0Y2hSZXN1bHQgJiYgbWV0aG9kTmFtZU1hdGNoUmVzdWx0Lmxlbmd0aCA9PSAyKSB7XHJcbiAgICAgICAgICBtZXRob2ROYW1lID0gbWV0aG9kTmFtZU1hdGNoUmVzdWx0WzFdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYXJndW1lbnRNYXRjaFJlc3VsdC5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICAgIGNvbnN0IGFyZ3VtZW50ID0gYXJndW1lbnRNYXRjaFJlc3VsdFsxXTtcclxuICAgICAgICAgIGNvbnN0IGFyZ3MgPSBhcmd1bWVudC5zcGxpdCgnLCcpLm1hcChwID0+IHAucmVwbGFjZSgvXFxcIi9nLCAnJykpO1xyXG4gICAgICAgICAgaWYgKGFyZ3MgJiYgYXJncy5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICAgICAgbGV0IGl0ZW06IGFueSA9IGFyZ3Muam9pbignLicpO1xyXG4gICAgICAgICAgICBpdGVtID0gdGhpcy5jb252ZXJ0VG9Ob2RlQ29kZShpdGVtLCBlbnRpdHlUeXBlSW5mbykuam9pbignLicpO1xyXG4gICAgICAgICAgICAvLyDnp7vpmaTkuLvooahjb2RlXHJcbiAgICAgICAgICAgIGl0ZW0gPSBpdGVtLnN1YnN0cihpdGVtLmluZGV4T2YoJy4nKSArIDEpO1xyXG4gICAgICAgICAgICBjb25zdCBkZXAgPSBpdGVtLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGRlcC5zcGxpY2UoMCwgMCwgRU5USVRZX1RFTVBMQVRFKTtcclxuICAgICAgICAgICAgZGVwcy5wdXNoKGRlcC5qb2luKCcvJykpO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChhcmdzICYmIGFyZ3MubGVuZ3RoID09PSAzICYmIG1ldGhvZE5hbWUgPT09ICdNdWx0aXBseUNoaWxkTnVtYmVyJykge1xyXG4gICAgICAgICAgICAvLyBzdXBwb3J0IE11bHRpcGx5Q2hpbGROdW1iZXJcclxuICAgICAgICAgICAgLy8gW0VudGl0eS5jaGlsZHJlbnMscHJvcDEscHJvcDJdXHJcbiAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IGFyZ3NbMF07IC8vIGxpa2UgRW50aXR5LmNoaWxkcmVuc1xyXG4gICAgICAgICAgICAvL2NvbnN0IHRhYmxlTmFtZSA9IGFyZ3NbMF07Ly8gcHJlZml4LnN1YnN0cmluZyhwcmVmaXguaW5kZXhPZignLicpKzEpO1xyXG4gICAgICAgICAgICBjb25zdCBwcm9wMUZ1bGxQYXRoID0gYCR7cHJlZml4fS4ke2FyZ3NbMV19YDtcclxuICAgICAgICAgICAgY29uc3QgcHJvcDJGdWxsUGF0aCA9IGAke3ByZWZpeH0uJHthcmdzWzJdfWA7XHJcbiAgICAgICAgICAgIFtwcm9wMUZ1bGxQYXRoLCBwcm9wMkZ1bGxQYXRoXS5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgIGl0ZW0gPSB0aGlzLmNvbnZlcnRUb05vZGVDb2RlKGl0ZW0sIGVudGl0eVR5cGVJbmZvKS5qb2luKCcuJyk7XHJcbiAgICAgICAgICAgICAgaXRlbSA9IGl0ZW0uc3Vic3RyKGl0ZW0uaW5kZXhPZignLicpICsgMSk7XHJcbiAgICAgICAgICAgICAgY29uc3QgZGVwID0gaXRlbS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICAgIGRlcC5zcGxpY2UoMCwgMCwgRU5USVRZX1RFTVBMQVRFKTtcclxuICAgICAgICAgICAgICBkZXBzLnB1c2goZGVwLmpvaW4oJy8nKSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGDml6Dms5Xop6PmnpDlj4LmlbDvvJogJHtKU09OLnN0cmluZ2lmeShhcmd1bWVudCl9YCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBkZXBzO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlsIZ2b0NvZGXovazmjaLkuLrliY3nq69ub2RlQ29kZVxyXG4gICAqIEBwYXJhbSBlbnRpdHlFeHByZXNzaW9uIGxpa2UgRW50aXR5LkNoaWxkLnAxXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBjb252ZXJ0VG9Ob2RlQ29kZShlbnRpdHlFeHByZXNzaW9uOiBzdHJpbmcsIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pOiBzdHJpbmdbXSB7XHJcbiAgICAvLyBVc2VyRW50aXR5LnN0b3J5cy5wMVxyXG4gICAgY29uc3Qgbm9kZUNvZGVzID0gW107XHJcbiAgICBpZiAoZW50aXR5VHlwZUluZm8gJiYgZW50aXR5RXhwcmVzc2lvbi5pbmNsdWRlcygnLicpKSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eUV4cHJlc3Npb25zID0gZW50aXR5RXhwcmVzc2lvbi5zcGxpdCgnLicpIHx8IFtdO1xyXG4gICAgICBsZXQgZGF0YVR5cGVJbmZvID0gZW50aXR5VHlwZUluZm87XHJcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBlbnRpdHlFeHByZXNzaW9ucy5sZW5ndGg7IGluZGV4KyspIHtcclxuICAgICAgICBjb25zdCBwcm9wID0gZW50aXR5RXhwcmVzc2lvbnNbaW5kZXhdO1xyXG4gICAgICAgIGlmIChkYXRhVHlwZUluZm8gJiYgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8gJiYgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUgPT09IHByb3AgfHwgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlID09PSBwcm9wKSB7XHJcbiAgICAgICAgICAvLyDnrKzkuIDkuKrmmK/kuLvooahjb2Rl77yM5LiN6IO96L2sbm9kZUNvZGVcclxuICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xyXG4gICAgICAgICAgICBub2RlQ29kZXMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgbm9kZUNvZGVzLnB1c2goZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIOS4i+S4gOe6p+WPr+iDveS4uuWtkOihqOOAgeWvueixoeaIluWxnuaAp1xyXG4gICAgICAgICAgY29uc3QgbmV4dE5vZGVDb2RlID0gZW50aXR5RXhwcmVzc2lvbnNbaW5kZXggKyAxXTtcclxuICAgICAgICAgIGlmICghbmV4dE5vZGVDb2RlKSB7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgbmV4dE5vZGVDb2RlUHJvcEluZm8gPSBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUobmV4dE5vZGVDb2RlKTtcclxuICAgICAgICAgIGlmICghbmV4dE5vZGVDb2RlUHJvcEluZm8pIHtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyDkuIvkuIDnuqfkuLrlrZDooajmiJblr7nosaFcclxuICAgICAgICAgIGlmIChuZXh0Tm9kZUNvZGVQcm9wSW5mby50eXBlSW5mbykge1xyXG4gICAgICAgICAgICBkYXRhVHlwZUluZm8gPSBuZXh0Tm9kZUNvZGVQcm9wSW5mby50eXBlSW5mbztcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKGRhdGFUeXBlSW5mbyAmJiBkYXRhVHlwZUluZm8uZ2V0UHJvcEluZm9CeU5hbWUocHJvcCkpIHtcclxuICAgICAgICAgIGNvbnN0IGRhdGFQcm9wSW5mbyA9IGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb0J5TmFtZShwcm9wKTtcclxuICAgICAgICAgIG5vZGVDb2Rlcy5wdXNoKGRhdGFQcm9wSW5mby5uYW1lKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy90aHJvdyBuZXcgRXJyb3IoYOmUmeivr+eahOWxnuaAp+WPguaVsCAke2VudGl0eUV4cHJlc3Npb259YCk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBub2RlQ29kZXM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJvuWIsOWFg+aVsOaNruS4reaJgOacieWunuS9k+i3r+W+hFxyXG4gICAqIEBwYXJhbSBkYXRhVHlwZUluZm8gXHJcbiAgICogQHBhcmFtIHJlc3VsdHMgXHJcbiAgICogQHBhcmFtIHBhdGhzIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0Q2hpbGRyZW5FbnRpdHlQYXRocyhkYXRhVHlwZUluZm86IERhdGFUeXBlSW5mbywgcmVzdWx0czogYW55W10sIHBhdGhzOiBzdHJpbmdbXSA9IFtdKSB7XHJcbiAgICBjb25zdCBsaXN0OiBEYXRhUHJvcEluZm9bXSA9IGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb3NCeUdyb3VwKERhdGFQcm9wR3JvdXAuTGlzdCk7XHJcbiAgICBpZiAobGlzdCAmJiBsaXN0Lmxlbmd0aCA+IDApIHtcclxuICAgICAgbGlzdC5mb3JFYWNoKChkYXRhUHJvcEluZm86IERhdGFQcm9wSW5mbykgPT4ge1xyXG4gICAgICAgIGlmIChwYXRocy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgIHJlc3VsdHMucHVzaChbZGF0YVByb3BJbmZvLm5hbWVdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgY2hpbGRyZW5zOiBEYXRhUHJvcEluZm9bXSA9IGRhdGFQcm9wSW5mby50eXBlSW5mby5nZXRQcm9wSW5mb3NCeUdyb3VwKERhdGFQcm9wR3JvdXAuTGlzdCk7XHJcbiAgICAgICAgaWYgKGNoaWxkcmVucyAmJiBjaGlsZHJlbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgcGF0aHMucHVzaChkYXRhUHJvcEluZm8ubmFtZSk7XHJcbiAgICAgICAgICBjaGlsZHJlbnMuZm9yRWFjaCgoZGF0YVByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5nZXRDaGlsZHJlbkVudGl0eVBhdGhzKGRhdGFQcm9wSW5mby50eXBlSW5mbywgcmVzdWx0cywgcGF0aHMpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmIChwYXRocy5sZW5ndGggIT09IDApIHtcclxuICAgICAgICAgICAgcGF0aHMucHVzaChkYXRhUHJvcEluZm8ubmFtZSk7XHJcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChbLi4ucGF0aHNdKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHBhdGhzLmxlbmd0aCA9IDA7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgcGF0aHMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XHJcbiAgICAgICAgcmVzdWx0cy5wdXNoKFsuLi5wYXRoc10pO1xyXG4gICAgICB9XHJcbiAgICAgIHBhdGhzLmxlbmd0aCA9IDA7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaMh+Wumue7keWumui3r+W+hOeahOW9k+WJjeihjOaVsOaNrlxyXG4gICAqIEBwYXJhbSBwYXRocyDnu5Hlrprot6/lvoRcclxuICAgKiBAcGFyYW0gYmluZGluZ0RhdGEgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBnZXRDdXJyZW50Um93QnlQYXRocyhwYXRoczogc3RyaW5nW10sIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSk6IG51bGwgfCB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSB7XHJcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcclxuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IGJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgIGlmIChiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGxldCBwcmltYXJ5VmFsdWUgPSBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUgfHwgbnVsbDtcclxuICAgICAgLy8g5L2/55So5LqL5Lu25Lit55qE5Li76ZSuXHJcbiAgICAgIC8vIOS4u+ihqOaIluS4i+e6p+ihqOaWsOWinu+8jOatpOaXtuS6i+S7tuihjOWwseaYr+W9k+WJjeihjO+8jOaXoOmcgOWkhOeQhlxyXG4gICAgICBpZiAocHJpbWFyeVZhbHVlKSB7XHJcbiAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGJpbmRpbmdMaXN0LmZpbmRCeUlkKHByaW1hcnlWYWx1ZSk7XHJcbiAgICAgICAgaWYgKGJpbmRpbmdPYmplY3QpIHtcclxuICAgICAgICAgIHJlc3VsdCA9IGJpbmRpbmdPYmplY3QudG9KU09OKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDku47lrp7kvZPot6/lvoTkuK3ojrflj5bnuqfmlbDmnIDlpKfnmoTku47ooajmiJbku47ku47ooahcclxuICAgKiBAcGFyYW0gcGF0aHMgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIHN0YXRpYyBnZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKHBhdGhzOiBzdHJpbmdbXSwgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbyk6IHN0cmluZ1tdIHtcclxuICAgIGxldCBub2RlQ29kZXMgPSBbXTtcclxuICAgIHBhdGhzID0gWy4uLnBhdGhzXTtcclxuICAgIHdoaWxlIChwYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IGRhdGFQcm9wSW5mbyA9IGVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcclxuICAgICAgaWYgKGRhdGFQcm9wSW5mbyAmJiBkYXRhUHJvcEluZm8uZ3JvdXAgPT09ICdMaXN0Jykge1xyXG4gICAgICAgIG5vZGVDb2RlcyA9IHBhdGhzO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICAgIHBhdGhzLnBvcCgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5vZGVDb2RlcztcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5LuO6Lev5b6E5Lit6I635Y+W57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIHBhdGhzIOi3r+W+hFxyXG4gICAqIEBwYXJhbSBlbnRpdHlUeXBlSW5mbyBlbnRpdHlUeXBlSW5mb1xyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0aWMgZ2V0QmluZGluZ1BhdGgocGF0aHM6IHN0cmluZ1tdLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKSB7XHJcbiAgICBwYXRocyA9IHRoaXMuZ2V0RW50aXR5UGF0aChwYXRocyk7XHJcbiAgICBjb25zdCBlbnRpdHlQYXRocyA9IHRoaXMuZ2V0QXZhaWxhYmxlQ2hpbGRyZW5QYXRoc0Zyb21FbnRpdHlQYXRocyhwYXRocywgZW50aXR5VHlwZUluZm8pO1xyXG4gICAgcmV0dXJuIGVudGl0eVBhdGhzO1xyXG4gIH1cclxuICBwdWJsaWMgc3RhdGljIGdldEVudGl0eVBhdGgocGF0aDogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwYXRocyA9IHBhdGguZmlsdGVyKCh2YWx1ZTogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgIGlmIChpbmRleCAlIDIgPT09IDAgJiYgdmFsdWUuaW5jbHVkZXMoJzonKSkge1xyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG59Il19