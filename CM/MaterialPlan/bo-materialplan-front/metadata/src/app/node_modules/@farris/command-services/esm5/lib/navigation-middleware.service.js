import { Injectable, Optional } from '@angular/core';
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { BefRepositoryUtil } from '@farris/bef';
import { TAB_EVENT } from './types';
import { NavigationService } from './navigation.service';
import { FrameContext, UID } from '@farris/devkit';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { CardDataService } from './data-services/card-data.service';
/**
 * 导航中间件服务
 * @scope FrameComponent
 */
// tslint:disable: no-string-literal
var NavigationMiddlewareService = /** @class */ (function () {
    function NavigationMiddlewareService(navigationService, frameContext, msgService, languageService, cardDataService) {
        this.navigationService = navigationService;
        this.frameContext = frameContext;
        this.msgService = msgService;
        this.languageService = languageService;
        this.cardDataService = cardDataService;
        this.repository = frameContext.repository;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        if (this.frameContext) {
            this.appContext = this.frameContext.getFormAppContext() || null;
        }
    }
    /**
     * 关闭前处理
     */
    NavigationMiddlewareService.prototype.onClosing = function () {
        var _this = this;
        if (this.isInDialog()) {
            return;
        }
        this.navigationService.addEventListener(TAB_EVENT.onTabClosing, function (options) {
            if (_this.isChanged && !_this.appContext.opened) {
                // 如果需要用户确认就切换到当前tab
                if (options && options.beforeCloseHandle && typeof options.beforeCloseHandle === 'function') {
                    options.beforeCloseHandle({ selectedChange: true });
                }
                var conform = _this.msgService.question(_this.languageService['exitWithoutSave']);
                /*记录弹窗已打开*/
                _this.appContext.opened = true;
                return conform.pipe(switchMap(function (result) {
                    _this.appContext.opened = false;
                    if (result) {
                        /*记录用户关闭弹窗*/
                        if (!!_this.cardDataService) {
                            var revert$ = _this.cardDataService.revert(options);
                            return revert$.pipe(switchMap(function () { return of(result); }));
                        }
                    }
                    return of(result);
                }));
            }
            else if (_this.isChanged && _this.appContext.opened) {
                return of(false);
            }
            else {
                return of(true);
            }
        });
    };
    /**
     * 是否在是弹窗窗口内
     */
    NavigationMiddlewareService.prototype.isInDialog = function () {
        var frameContext = this.frameContext;
        var isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'] || false;
        while (frameContext.parent !== null && !isDialogRootComponent) {
            frameContext = frameContext.parent;
            isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'];
        }
        return isDialogRootComponent;
    };
    /**
     * 获取tabid,如果targetId存在则直接使用targetId
     * @description 将用户要查看的数据id转换为运行框架需要的tabId
     * @param params router参数
     * @param targetId 要编辑/查看的数据id
     */
    NavigationMiddlewareService.prototype.getTabId = function (params, targetId) {
        if (!!targetId) {
            return targetId;
        }
        var paramsObj = null;
        if (!!params && params.startsWith('{') && params.endsWith('}')) {
            paramsObj = JSON.parse(params);
        }
        var paramId = null;
        if (paramsObj && paramsObj.hasOwnProperty('id') && !!paramsObj.id) {
            paramId = paramsObj.id;
        }
        else {
            paramId = UID.create();
        }
        return paramId;
    };
    Object.defineProperty(NavigationMiddlewareService.prototype, "isChanged", {
        /**
         * 是否有未保存的变更
         */
        get: function () {
            var befRepository = this.repository;
            return BefRepositoryUtil.isExistUnsaveData(befRepository);
        },
        enumerable: true,
        configurable: true
    });
    NavigationMiddlewareService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NavigationMiddlewareService.ctorParameters = function () { return [
        { type: NavigationService },
        { type: FrameContext },
        { type: FormMessageService },
        { type: LanguageService, decorators: [{ type: Optional }] },
        { type: CardDataService }
    ]; };
    return NavigationMiddlewareService;
}());
export { NavigationMiddlewareService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFpQixpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQWMsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRTs7O0dBR0c7QUFDSCxvQ0FBb0M7QUFDcEM7SUFLRSxxQ0FDVSxpQkFBb0MsRUFDcEMsWUFBMEIsRUFDMUIsVUFBOEIsRUFDbEIsZUFBZ0MsRUFDNUMsZUFBZ0M7UUFKaEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUNsQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDNUMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBRXhDLElBQUksQ0FBQyxVQUFVLEdBQUcsWUFBWSxDQUFDLFVB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O1FBQ0QsSUFBSSxTQUFTLEdBQVEsSUFBSSxDQUFDO1FBQzFCLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDOUQsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDaEM7UUFDRCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxTQUFTLElBQUksU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRTtZQUNqRSxPQUFPLEdBQUcsU0FBUyxDQUFDLEVBQUUsQ0FBQztTQUN4QjthQUFNO1lBQ0wsT0FBTyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUN4QjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFJRCxzQkFBWSxrREFBUztRQUhyQjs7V0FFRzthQUNIO1lBQ0UsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQWdDLENBQUM7WUFDNUQsT0FBTyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM1RCxDQUFDOzs7T0FBQTs7Z0JBbEdGLFVBQVU7Ozs7Z0JBVkYsaUJBQWlCO2dCQUNqQixZQUFZO2dCQUNaLGtCQUFrQjtnQkFDbEIsZUFBZSx1QkFnQm5CLFFBQVE7Z0JBZkosZUFBZTs7SUF5R3hCLGtDQUFDO0NBQUEsQUFuR0QsSUFtR0M7U0FsR1ksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5LCBCZWZSZXBvc2l0b3J5VXRpbCB9IGZyb20gJ0BmYXJyaXMvYmVmJztcclxuaW1wb3J0IHsgVEFCX0VWRU5UIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IE5hdmlnYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi9uYXZpZ2F0aW9uLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnksIFVJRCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQ2FyZERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9kYXRhLXNlcnZpY2VzL2NhcmQtZGF0YS5zZXJ2aWNlJztcclxuLyoqXHJcbiAqIOWvvOiIquS4remXtOS7tuacjeWKoVxyXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcclxuICovXHJcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBOYXZpZ2F0aW9uTWlkZGxld2FyZVNlcnZpY2Uge1xyXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+O1xyXG5cclxuICBwcml2YXRlIGFwcENvbnRleHQ6IGFueTtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgbmF2aWdhdGlvblNlcnZpY2U6IE5hdmlnYXRpb25TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIHByaXZhdGUgbXNnU2VydmljZTogRm9ybU1lc3NhZ2VTZXJ2aWNlLFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcclxuICAgIHByaXZhdGUgY2FyZERhdGFTZXJ2aWNlOiBDYXJkRGF0YVNlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMucmVwb3NpdG9yeSA9IGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5O1xyXG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xyXG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHRoaXMuYXBwQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCkgfHwgbnVsbDtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5YWz6Zet5YmN5aSE55CGXHJcbiAgICovXHJcbiAgcHVibGljIG9uQ2xvc2luZygpIHtcclxuICAgIGlmICh0aGlzLmlzSW5EaWFsb2coKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLm5hdmlnYXRpb25TZXJ2aWNlLmFkZEV2ZW50TGlzdGVuZXIoVEFCX0VWRU5ULm9uVGFiQ2xvc2luZywgKG9wdGlvbnMpID0+IHtcclxuICAgICAgaWYgKHRoaXMuaXNDaGFuZ2VkICYmICF0aGlzLmFwcENvbnRleHQub3BlbmVkKSB7XHJcbiAgICAgICAgLy8g5aaC5p6c6ZyA6KaB55So5oi356Gu6K6k5bCx5YiH5o2i5Yiw5b2T5YmNdGFiXHJcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5iZWZvcmVDbG9zZUhhbmRsZSAmJiB0eXBlb2Ygb3B0aW9ucy5iZWZvcmVDbG9zZUhhbmRsZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgb3B0aW9ucy5iZWZvcmVDbG9zZUhhbmRsZSh7IHNlbGVjdGVkQ2hhbmdlOiB0cnVlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjb25mb3JtID0gdGhpcy5tc2dTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydleGl0V2l0aG91dFNhdmUnXSk7XHJcbiAgICAgICAgLyrorrDlvZXlvLnnqpflt7LmiZPlvIAqL1xyXG4gICAgICAgIHRoaXMuYXBwQ29udGV4dC5vcGVuZWQgPSB0cnVlO1xyXG4gICAgICAgIHJldHVybiBjb25mb3JtLnBpcGUoXHJcbiAgICAgICAgICBzd2l0Y2hNYXAoKHJlc3VsdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmFwcENvbnRleHQub3BlbmVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAvKuiusOW9leeUqOaIt+WFs+mXreW8ueeqlyovXHJcbiAgICAgICAgICAgICAgaWYgKCEhdGhpcy5jYXJkRGF0YVNlcnZpY2UpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJldmVydCQgPSB0aGlzLmNhcmREYXRhU2VydmljZS5yZXZlcnQob3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV2ZXJ0JC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4gb2YocmVzdWx0KSlcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBvZihyZXN1bHQpO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuaXNDaGFuZ2VkICYmIHRoaXMuYXBwQ29udGV4dC5vcGVuZWQpIHtcclxuICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuWcqOaYr+W8ueeql+eql+WPo+WGhVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNJbkRpYWxvZygpIHtcclxuICAgIGxldCBmcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dDtcclxuICAgIGxldCBpc0RpYWxvZ1Jvb3RDb21wb25lbnQgPSBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddIHx8IGZhbHNlO1xyXG4gICAgd2hpbGUgKGZyYW1lQ29udGV4dC5wYXJlbnQgIT09IG51bGwgJiYgIWlzRGlhbG9nUm9vdENvbXBvbmVudCkge1xyXG4gICAgICBmcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQucGFyZW50O1xyXG4gICAgICBpc0RpYWxvZ1Jvb3RDb21wb25lbnQgPSBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGlzRGlhbG9nUm9vdENvbXBvbmVudDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+WdGFiaWQs5aaC5p6cdGFyZ2V0SWTlrZjlnKjliJnnm7TmjqXkvb/nlKh0YXJnZXRJZFxyXG4gICAqIEBkZXNjcmlwdGlvbiDlsIbnlKjmiLfopoHmn6XnnIvnmoTmlbDmja5pZOi9rOaNouS4uui/kOihjOahhuaetumcgOimgeeahHRhYklkXHJcbiAgICogQHBhcmFtIHBhcmFtcyByb3V0ZXLlj4LmlbBcclxuICAgKiBAcGFyYW0gdGFyZ2V0SWQg6KaB57yW6L6RL+afpeeci+eahOaVsOaNrmlkXHJcbiAgICovXHJcbiAgcHVibGljIGdldFRhYklkKHBhcmFtczogc3RyaW5nLCB0YXJnZXRJZDogc3RyaW5nKTogYW55IHtcclxuICAgIGlmICghIXRhcmdldElkKSB7XHJcbiAgICAgIHJldHVybiB0YXJnZXRJZDtcclxuICAgIH1cclxuICAgIGxldCBwYXJhbXNPYmo6IGFueSA9IG51bGw7XHJcbiAgICBpZiAoISFwYXJhbXMgJiYgcGFyYW1zLnN0YXJ0c1dpdGgoJ3snKSAmJiBwYXJhbXMuZW5kc1dpdGgoJ30nKSkge1xyXG4gICAgICBwYXJhbXNPYmogPSBKU09OLnBhcnNlKHBhcmFtcyk7XHJcbiAgICB9XHJcbiAgICBsZXQgcGFyYW1JZCA9IG51bGw7XHJcbiAgICBpZiAocGFyYW1zT2JqICYmIHBhcmFtc09iai5oYXNPd25Qcm9wZXJ0eSgnaWQnKSAmJiAhIXBhcmFtc09iai5pZCkge1xyXG4gICAgICBwYXJhbUlkID0gcGFyYW1zT2JqLmlkO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGFyYW1JZCA9IFVJRC5jcmVhdGUoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBwYXJhbUlkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKbmnInmnKrkv53lrZjnmoTlj5jmm7RcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBpc0NoYW5nZWQoKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgIHJldHVybiBCZWZSZXBvc2l0b3J5VXRpbC5pc0V4aXN0VW5zYXZlRGF0YShiZWZSZXBvc2l0b3J5KTtcclxuICB9XHJcbn1cclxuIl19