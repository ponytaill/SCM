import { Injectable, Injector } from "@angular/core";
import { AppContext, FrameContext, Repository } from "@farris/devkit";
import { BindingPathService } from "./binding-path.service";
import { FormControlService } from './form-control.service';
export class FrameContextService {
    constructor(injector, appContext, frameContext, repository, bindingPathService, formControlService) {
        this.injector = injector;
        this.appContext = appContext;
        this.frameContext = frameContext;
        this.repository = repository;
        this.bindingPathService = bindingPathService;
        this.formControlService = formControlService;
    }
    /**
       * 通过BE表名获取对应的frameContext
       * @param tableName
       * @returns
       */
    getFrameContextsByTableName(tableName) {
        if (!tableName) {
            throw new Error('tableName 不能为空。');
        }
        const dataTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!dataTypeInfo) {
            return null;
        }
        const bindingPaths = [];
        this.bindingPathService.getBindingPathsByTableName(dataTypeInfo, tableName, bindingPaths);
        const frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        if (!frameContexts || frameContexts.length === 0) {
            return null;
        }
        return frameContexts.filter((frameContext) => frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(p => p).join('/') === bindingPaths.join('/'));
    }
    /**
     * 根据字段完整路径获取所在的上下文
     * @param propertyPath
     * @param separtor
     * @returns
     */
    getFrameContextsByPropertyPath(propertyPath, separtor = '/') {
        if (!propertyPath) {
            throw new Error('propertyPath 不能为空。');
        }
        const frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter((frameContext) => {
            const formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            const bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                const key = Object.keys(formControls).find((key) => {
                    const formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    const bindings = formControl.binding.split('.').filter(p => p);
                    const bindingPaths = bindingPath.split('/').filter(p => p);
                    const fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(p => p).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    }
    /**
     * 通过BE字段名获取字段的bindingPath
     * @param bindingPaths 绑定路径
     * @param columnName BE字段名
     * @returns
     */
    getFrameContextsByColumnName(bindingPaths, columnName) {
        if (!bindingPaths) {
            throw new Error('bindingPath 不能为空。');
        }
        if (!columnName) {
            throw new Error('columnName 不能为空。');
        }
        bindingPaths = bindingPaths.filter(p => p);
        const entityTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!entityTypeInfo) {
            return null;
        }
        const dataTypeInfo = entityTypeInfo.getTypeInfoByPath(bindingPaths);
        const dataPropInfos = dataTypeInfo && dataTypeInfo.getPropInfos() || [];
        const columnPropInfo = dataPropInfos.find((dataPropInfo) => dataPropInfo.metadataInfo && (dataPropInfo.metadataInfo.originalDataField === columnName || dataPropInfo.metadataInfo.dataField === columnName));
        if (!columnPropInfo || !columnPropInfo.metadataInfo) {
            return null;
        }
        const frameContexts = this.appContext.frameContextManager.getFrameContexts();
        return frameContexts.filter((frameContext) => {
            const ngFormControls = this.formControlService.getFormControlsByFrameContext(frameContext);
            if (!ngFormControls || Object.keys(ngFormControls).length < 1) {
                return false;
            }
            const currentBindingPaths = this.bindingPathService.getBindingPathsByFrameContext(frameContext) || [];
            const isValidFrameContext = currentBindingPaths.join('/') === bindingPaths.join('/');
            if (!isValidFrameContext) {
                return false;
            }
            const ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(item => item.binding === columnPropInfo.metadataInfo.path);
            return ngFormControl ? true : false;
        });
    }
    /**
     * 通过绑定路径获取对应的组件上下文数组
     * @param bindingPath bindingPath字符串
     * @param namespace ns,默认为''
     */
    getFrameContextsByBindingPath(bindingPath, namespace = '') {
        if (Array.isArray(bindingPath)) {
            bindingPath = bindingPath.join('/');
        }
        const frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter((frameContext) => frameContext && frameContext.namespace === namespace && frameContext.viewModel.bindingPath === bindingPath);
    }
}
FrameContextService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FrameContextService.ctorParameters = () => [
    { type: Injector },
    { type: AppContext },
    { type: FrameContext },
    { type: Repository },
    { type: BindingPathService },
    { type: FormControlService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWUtY29udGV4dC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZyYW1lLWNvbnRleHQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUF3QixZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFHNUQsTUFBTSxPQUFPLG1CQUFtQjtJQUM5QixZQUNVLFFBQWtCLEVBQ2xCLFVBQXNCLEVBQ3RCLFlBQTBCLEVBQzFCLFVBQThCLEVBQzlCLGtCQUFzQyxFQUN0QyxrQkFBc0M7UUFMdEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtJQUMxQyxDQUFDO0lBQ1A7Ozs7U0FJSztJQUNFLDJCQUEyQixDQUFDLFNBQWlCO1FBQ2xELElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDcEM7UUFDRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQztRQUMvRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxNQUFNLFlB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QUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDdEcsT0FBTyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFLENBQUMsWUFBWSxJQUFJLFlBQVksQ0FBQyxTQUFTLEtBQUssU0FBUyxJQUFJLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxLQUFLLFdBQVcsQ0FBQyxDQUFDO0lBQzFLLENBQUM7OztZQWhIRixVQUFVOzs7O1lBTFUsUUFBUTtZQUNwQixVQUFVO1lBQXdCLFlBQVk7WUFBRSxVQUFVO1lBQzFELGtCQUFrQjtZQUNsQixrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBBcHBDb250ZXh0LCBEYXRhUHJvcEluZm8sIEVudGl0eSwgRnJhbWVDb250ZXh0LCBSZXBvc2l0b3J5IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XG5pbXBvcnQgeyBCaW5kaW5nUGF0aFNlcnZpY2UgfSBmcm9tIFwiLi9iaW5kaW5nLXBhdGguc2VydmljZVwiO1xuaW1wb3J0IHsgRm9ybUNvbnRyb2xTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLWNvbnRyb2wuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGcmFtZUNvbnRleHRTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIFxuICAgIHByaXZhdGUgYXBwQ29udGV4dDogQXBwQ29udGV4dCwgXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PEVudGl0eT4sXG4gICAgcHJpdmF0ZSBiaW5kaW5nUGF0aFNlcnZpY2U6IEJpbmRpbmdQYXRoU2VydmljZSxcbiAgICBwcml2YXRlIGZvcm1Db250cm9sU2VydmljZTogRm9ybUNvbnRyb2xTZXJ2aWNlXG4gICAgKSB7IH1cbiAgLyoqXG4gICAgICog6YCa6L+HQkXooajlkI3ojrflj5blr7nlupTnmoRmcmFtZUNvbnRleHRcbiAgICAgKiBAcGFyYW0gdGFibGVOYW1lIFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqL1xuICBwdWJsaWMgZ2V0RnJhbWVDb250ZXh0c0J5VGFibGVOYW1lKHRhYmxlTmFtZTogc3RyaW5nKTogbnVsbCB8IEZyYW1lQ29udGV4dFtdIHtcbiAgICBpZiAoIXRhYmxlTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCd0YWJsZU5hbWUg5LiN6IO95Li656m644CCJyk7XG4gICAgfVxuICAgIGNvbnN0IGRhdGFUeXBlSW5mbyA9IHRoaXMucmVwb3NpdG9yeSAmJiB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8gfHwgbnVsbDtcbiAgICBpZiAoIWRhdGFUeXBlSW5mbykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IFtdO1xuICAgIHRoaXMuYmluZGluZ1BhdGhTZXJ2aWNlLmdldEJpbmRpbmdQYXRoc0J5VGFibGVOYW1lKGRhdGFUeXBlSW5mbywgdGFibGVOYW1lLCBiaW5kaW5nUGF0aHMpO1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmFwcENvbnRleHQgJiYgdGhpcy5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpIHx8IFtdO1xuICAgIGlmICghZnJhbWVDb250ZXh0cyB8fCBmcmFtZUNvbnRleHRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5qb2luKCcvJykgPT09IGJpbmRpbmdQYXRocy5qb2luKCcvJykpO1xuICB9XG4gIC8qKlxuICAgKiDmoLnmja7lrZfmrrXlrozmlbTot6/lvoTojrflj5bmiYDlnKjnmoTkuIrkuIvmlodcbiAgICogQHBhcmFtIHByb3BlcnR5UGF0aCBcbiAgICogQHBhcmFtIHNlcGFydG9yIFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRGcmFtZUNvbnRleHRzQnlQcm9wZXJ0eVBhdGgocHJvcGVydHlQYXRoOiBzdHJpbmcsIHNlcGFydG9yOiBzdHJpbmcgPSAnLycpOiBGcmFtZUNvbnRleHRbXSB7XG4gICAgaWYgKCFwcm9wZXJ0eVBhdGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigncHJvcGVydHlQYXRoIOS4jeiDveS4uuepuuOAgicpO1xuICAgIH1cbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0ICYmIHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKSB8fCBbXTtcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICBjb25zdCBmb3JtQ29udHJvbHMgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMgfHwge307XG4gICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggfHwgJyc7XG4gICAgICBpZiAoZm9ybUNvbnRyb2xzICYmIE9iamVjdC5rZXlzKGZvcm1Db250cm9scykubGVuZ3RoID4gMCkge1xuICAgICAgICBjb25zdCBrZXkgPSBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmZpbmQoKGtleTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgY29uc3QgZm9ybUNvbnRyb2wgPSBmb3JtQ29udHJvbHNba2V5XTtcbiAgICAgICAgICBpZiAoIWZvcm1Db250cm9sIHx8ICFmb3JtQ29udHJvbC5iaW5kaW5nKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGJpbmRpbmdzID0gZm9ybUNvbnRyb2wuYmluZGluZy5zcGxpdCgnLicpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgICAgICAgY29uc3QgZnVsbFBhdGggPSBiaW5kaW5nUGF0aHMuY29uY2F0KGJpbmRpbmdzKTtcbiAgICAgICAgICByZXR1cm4gcHJvcGVydHlQYXRoLnNwbGl0KHNlcGFydG9yKS5maWx0ZXIocCA9PiBwKS5qb2luKCcvJykgPT09IGZ1bGxQYXRoLmpvaW4oJy8nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBrZXkgPyB0cnVlIDogZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG4gIH1cbiAgLyoqXG4gICAqIOmAmui/h0JF5a2X5q615ZCN6I635Y+W5a2X5q6155qEYmluZGluZ1BhdGhcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRocyDnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIGNvbHVtbk5hbWUgQkXlrZfmrrXlkI1cbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0RnJhbWVDb250ZXh0c0J5Q29sdW1uTmFtZShiaW5kaW5nUGF0aHM6IHN0cmluZ1tdLCBjb2x1bW5OYW1lOiBzdHJpbmcpOiBGcmFtZUNvbnRleHRbXSB8IG51bGwge1xuICAgIGlmICghYmluZGluZ1BhdGhzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2JpbmRpbmdQYXRoIOS4jeiDveS4uuepuuOAgicpO1xuICAgIH1cbiAgICBpZiAoIWNvbHVtbk5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignY29sdW1uTmFtZSDkuI3og73kuLrnqbrjgIInKTtcbiAgICB9XG4gICAgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGhzLmZpbHRlcihwID0+IHApO1xuICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvID0gdGhpcy5yZXBvc2l0b3J5ICYmIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyB8fCBudWxsO1xuICAgIGlmICghZW50aXR5VHlwZUluZm8pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBkYXRhVHlwZUluZm8gPSBlbnRpdHlUeXBlSW5mby5nZXRUeXBlSW5mb0J5UGF0aChiaW5kaW5nUGF0aHMpO1xuICAgIGNvbnN0IGRhdGFQcm9wSW5mb3MgPSBkYXRhVHlwZUluZm8gJiYgZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvcygpIHx8IFtdO1xuICAgIGNvbnN0IGNvbHVtblByb3BJbmZvID0gZGF0YVByb3BJbmZvcy5maW5kKChkYXRhUHJvcEluZm86IERhdGFQcm9wSW5mbykgPT4gZGF0YVByb3BJbmZvLm1ldGFkYXRhSW5mbyAmJiAoZGF0YVByb3BJbmZvLm1ldGFkYXRhSW5mby5vcmlnaW5hbERhdGFGaWVsZCA9PT0gY29sdW1uTmFtZSB8fCBkYXRhUHJvcEluZm8ubWV0YWRhdGFJbmZvLmRhdGFGaWVsZCA9PT0gY29sdW1uTmFtZSkpO1xuICAgIGlmICghY29sdW1uUHJvcEluZm8gfHwgIWNvbHVtblByb3BJbmZvLm1ldGFkYXRhSW5mbykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgY29uc3QgbmdGb3JtQ29udHJvbHMgPSB0aGlzLmZvcm1Db250cm9sU2VydmljZS5nZXRGb3JtQ29udHJvbHNCeUZyYW1lQ29udGV4dChmcmFtZUNvbnRleHQpO1xuICAgICAgaWYgKCFuZ0Zvcm1Db250cm9scyB8fCBPYmplY3Qua2V5cyhuZ0Zvcm1Db250cm9scykubGVuZ3RoIDwgMSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBjb25zdCBjdXJyZW50QmluZGluZ1BhdGhzID0gdGhpcy5iaW5kaW5nUGF0aFNlcnZpY2UuZ2V0QmluZGluZ1BhdGhzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0KSB8fCBbXTtcbiAgICAgIGNvbnN0IGlzVmFsaWRGcmFtZUNvbnRleHQgPSBjdXJyZW50QmluZGluZ1BhdGhzLmpvaW4oJy8nKSA9PT0gYmluZGluZ1BhdGhzLmpvaW4oJy8nKTtcbiAgICAgIGlmICghaXNWYWxpZEZyYW1lQ29udGV4dCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICBjb25zdCBuZ0Zvcm1Db250cm9sID0gT2JqZWN0LnZhbHVlcyhmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0ubmdGb3JtQ29udHJvbHMpLmZpbmQoaXRlbSA9PiBpdGVtLmJpbmRpbmcgPT09IGNvbHVtblByb3BJbmZvLm1ldGFkYXRhSW5mby5wYXRoKTtcbiAgICAgIHJldHVybiBuZ0Zvcm1Db250cm9sID8gdHJ1ZSA6IGZhbHNlO1xuICAgIH0pO1xuICB9XG4gIFxuICAvKipcbiAgICog6YCa6L+H57uR5a6a6Lev5b6E6I635Y+W5a+55bqU55qE57uE5Lu25LiK5LiL5paH5pWw57uEXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCBiaW5kaW5nUGF0aOWtl+espuS4slxuICAgKiBAcGFyYW0gbmFtZXNwYWNlIG5zLOm7mOiupOS4uicnXG4gICAqL1xuICAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeUJpbmRpbmdQYXRoKGJpbmRpbmdQYXRoOiBzdHJpbmcgfCBzdHJpbmdbXSwgbmFtZXNwYWNlOiBzdHJpbmcgPSAnJyk6IEZyYW1lQ29udGV4dFtdIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShiaW5kaW5nUGF0aCkpIHtcbiAgICAgIGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGguam9pbignLycpO1xuICAgIH1cbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0ICYmIHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKSB8fCBbXTtcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKTtcbiAgfVxufSJdfQ==