/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { of } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { FavoriteAction, FAVORITE_FIELD_NAME } from '../lookup-displaytype';
var DataTableEventManager = /** @class */ (function () {
    function DataTableEventManager(ins) {
        this.ins = ins;
        this._sortState = null;
        this.lookupSelectionSer = this.ins.lookupSelectionSer;
    }
    /**
     * @param {?=} $event
     * @return {?}
     */
    DataTableEventManager.prototype.onSearch = /**
     * @param {?=} $event
     * @return {?}
     */
    function ($event) {
        var _this = this;
        if ($event === void 0) { $event = { field: '*', value: '' }; }
        if ($event && $event.field !== '*' && !$event.value) {
            this.ins.messagerService.warning(this.ins.mustWriteSomething);
            return;
        }
        /** @type {?} */
        var p = {
            pageInfo: { pageIndex: 1, pageSize: this.ins.gridOptions.pageSize },
            search: $event
        };
        if (this._sortState) {
            var _a = this._sortState, sortName = _a.sortName, sortOrder = _a.sortOrder;
            if (sortName) {
                p['sortName'] = sortName;
                p['sortOrder'] = sortOrder;
            }
        }
        if (this.ins.uri) {
            if (!this.ins.searching) {
                this.ins.searching = true;
                if (this.ins['navNodePathCode']) {
                    p['navNodePathCode'] = this.ins['navNodePathCode'];
                }
                this.ins.httpMgr.getData(p, 'list').pipe(catchError((/**
                 * @param {?} err
                 * @return {?}
                 */
                function (err) {
                    _this.ins.searching = false;
                    return of({ "_ERROR_": err });
                })), tap((/**
                 * @return {?}
                 */
                function () {
                    _this.ins.searching = false;
                }))).subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                function (data) {
                    _this.ins.searching = false;
                    _this.ins.closeLoading();
                    if (!data['_ERROR_']) {
                        _this._loadData(data);
                    }
                    else {
                        throw new Error(data['_ERROR_']);
                    }
                }));
            }
        }
        else {
            this.ins.search.emit(p);
        }
    };
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    DataTableEventManager.prototype._loadData = /**
     * @private
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var self = this.ins;
        self.closeLoading();
        self.favHelper.updateFavoritesStatus(data.items);
        self.loadDataTableData(data);
        // 选中数据
        this.ins.selectionMgr.selectCurrentValue();
    };
    /**
     * @return {?}
     */
    DataTableEventManager.prototype.bindDataTableEvent = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var self = this.ins;
        /** @type {?} */
        var dt = (/** @type {?} */ (self.componentRef.instance));
        dt.selectedRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (_this.ins.singleSelect) {
                _this.lookupSelectionSer.clearSelections();
            }
            _this.ins.checkedChange.emit({ data: [e.data], isCheck: true });
            _this.lookupSelectionSer.updateSelections([e.data]);
            dt.cd.detectChanges();
        }));
        dt.unSelectRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.lookupSelectionSer.unSelect(e.data[self.idField]);
            _this.ins.checkedChange.emit({ data: [e.data], isCheck: false });
        }));
        dt.checkAll.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.lookupSelectionSer.updateSelections(dt.data, e);
            _this.ins.checkedChange.emit({ data: dt.data, isCheck: e });
        }));
        dt.pageChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                function (data) {
                    _this._loadData(data);
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.pageSizeChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                function (data) {
                    _this._loadData(data);
                }), (/**
                 * @param {?} err
                 * @return {?}
                 */
                function (err) {
                    self.closeLoading();
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.search.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            // if (JSON.stringify(self._searchState || {}) !== JSON.stringify(e || {})) {
            //     this.ins.searching = false;
            // }
            self._searchState = tslib_1.__assign({}, (e || {}));
            _this.onSearch(e);
        }));
        dt.searchValueChange.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e && e.value) {
                self._searchState = tslib_1.__assign({}, e);
            }
            else {
                self._searchState = null;
            }
        }));
        // 双击事件
        dt.rowDblClick.subscribe((/**
         * @param {?} rowData
         * @return {?}
         */
        function (rowData) {
            if (self.gridOptions.singleSelect) {
                // this.lookupSelectionSer.updateSelections([rowData]);
                self.selectItem(rowData);
            }
        }));
        // 收藏事件
        dt.cellClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e.col.field === FAVORITE_FIELD_NAME) {
                /** @type {?} */
                var classList = e.event.target['classList'];
                if (classList.contains('f-lookup-favorite')) {
                    e.event.stopPropagation();
                    self.items.forEach((/**
                     * @param {?} item
                     * @return {?}
                     */
                    function (item) {
                        /** @type {?} */
                        var id = self.utils.getValue(self.idField, item);
                        if (id === self.utils.getValue(self.idField, e.row)) {
                            item[FAVORITE_FIELD_NAME] = !item[FAVORITE_FIELD_NAME];
                        }
                    }));
                    dt.loadData({
                        pageSize: self.gridOptions.pageSize,
                        pageIndex: self.gridOptions.pageIndex,
                        total: self.gridOptions.total,
                        data: self.gridOptions.items
                    });
                    // 更新收藏数据
                    /** @type {?} */
                    var faction = e.row[FAVORITE_FIELD_NAME] ? FavoriteAction.add : FavoriteAction.delete;
                    if (faction === FavoriteAction.add) {
                        _this.ins.favoriteItems = tslib_1.__spread(_this.ins.favoriteItems, [e.row]);
                    }
                    else {
                        _this.ins.favoriteItems = _this.ins.favoriteItems.filter((/**
                         * @param {?} n
                         * @return {?}
                         */
                        function (n) {
                            return self.utils.getValue(self.idField, n) !== self.utils.getValue(self.idField, e.row);
                        }));
                    }
                    _this.lookupSelectionSer.updateFavoriteData(e.row, faction);
                }
            }
        }));
        dt.columnSorted.subscribe((/**
         * @param {?} sort
         * @return {?}
         */
        function (sort) {
            _this._sortState = sort;
            if (!_this.ins.remoteSort) {
                return;
            }
            var _a = tslib_1.__assign({}, sort), sortName = _a.sortName, sortOrder = _a.sortOrder;
            /** @type {?} */
            var col = _this.ins.columns.find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.field === sortName; }));
            /** @type {?} */
            var _sortName = col ? col.fieldPath ? col.fieldPath : col.field : sortName;
            /** @type {?} */
            var param = {
                sortName: _sortName,
                sortOrder: sortOrder,
                search: self._searchState,
                pageInfo: {
                    pageSize: self.pageSize,
                    pageIndex: 1
                }
            };
            self.httpMgr.getData(param, 'search').subscribe((/**
             * @param {?} d
             * @return {?}
             */
            function (d) {
                self.loadDataTableData(d);
                self.closeLoading();
            }));
        }));
        dt.clearSearchValue.subscribe((/**
         * @return {?}
         */
        function () {
            self._searchState = null;
            _this.onSearch();
        }));
        dt.cellStyler = (/**
         * @param {?} val
         * @return {?}
         */
        function (val) {
            var field = val.field;
            if (field === FAVORITE_FIELD_NAME) {
                return {
                    'text-overflow': 'unset'
                };
            }
            return null;
        });
    };
    return DataTableEventManager;
}());
export { DataTableEventManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.lookupSelectionSer;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype._sortState;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZC1kYXRhdGFibGUtZXZlbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9iaW5kLWRhdGF0YWJsZS1ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLFVBQVUsRUFBUSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFLNUU7SUFNSSwrQkFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFGcEMsZUFBVSxHQUFHLElBQUksQ0FBQztRQUd0QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztJQUMxRCxDQUFDOzs7OztJQUVELHdDQUFROzs7O0lBQVIsVUFBUyxNQUFvRTtRQUE3RSxpQkFrREM7UUFsRFEsdUJBQUEsRUFBQSxXQUE2QyxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUU7UUFDekUsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLEtBQUssS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFO1lBQ2pELElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDOUQsT0FBTztTQUNWOztZQUVLLENBQUMsR0FBRztZQUNOLFFBQVEsRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRTtZQUNuRSxNQUFNLEVBQUUsTUFBTTtTQUNqQjtRQUVELElBQUksSUFBSSxDQUFDLFVB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TztvQkFDSCxlQUFlLEVBQUUsT0FBTztpQkFDM0IsQ0FBQzthQUNMO1lBRUQsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQyxDQUFBLENBQUE7SUFDTCxDQUFDO0lBQ0wsNEJBQUM7QUFBRCxDQUFDLEFBaE9ELElBZ09DOzs7Ozs7O0lBOU5HLG1EQUFtRDs7Ozs7SUFFbkQsMkNBQTBCOzs7OztJQUVkLG9DQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YXRhYmxlJztcclxuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgdGFrZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGYXZvcml0ZUFjdGlvbiwgRkFWT1JJVEVfRklFTERfTkFNRSB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRSZXN1bHQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvb2t1cFNlbGVjdGlvblNlcnZpY2UgfSBmcm9tICcuL2xvb2t1cC1zZWxlY3Rpb24uc2VydmljZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YVRhYmxlRXZlbnRNYW5hZ2VyIHtcclxuXHJcbiAgICBwcml2YXRlIGxvb2t1cFNlbGVjdGlvblNlcjogTG9va3VwU2VsZWN0aW9uU2VydmljZTtcclxuXHJcbiAgICBwcml2YXRlIF9zb3J0U3RhdGUgPSBudWxsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIgPSB0aGlzLmlucy5sb29rdXBTZWxlY3Rpb25TZXI7XHJcbiAgICB9XHJcblxyXG4gICAgb25TZWFyY2goJGV2ZW50OiB7IGZpZWxkOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfSA9IHsgZmllbGQ6ICcqJywgdmFsdWU6ICcnIH0pIHtcclxuICAgICAgICBpZiAoJGV2ZW50ICYmICRldmVudC5maWVsZCAhPT0gJyonICYmICEkZXZlbnQudmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubWVzc2FnZXJTZXJ2aWNlLndhcm5pbmcodGhpcy5pbnMubXVzdFdyaXRlU29tZXRoaW5nKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcCA9IHtcclxuICAgICAgICAgICAgcGFnZUluZm86IHsgcGFnZUluZGV4OiAxLCBwYWdlU2l6ZTogdGhpcy5pbnMuZ3JpZE9wdGlvbnMucGFnZVNpemUgfSxcclxuICAgICAgICAgICAgc2VhcmNoOiAkZXZlbnRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAodGhpcy5fc29ydFN0YXRlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHtzb3J0TmFtZSwgc29ydE9yZGVyfSA9IHRoaXMuX3NvcnRTdGF0ZTtcclxuICAgICAgICAgICAgaWYgKHNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBwWydzb3J0TmFtZSddID0gc29ydE5hbWU7XHJcbiAgICAgICAgICAgICAgICBwWydzb3J0T3JkZXInXSA9IHNvcnRPcmRlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnVyaSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaW5zLnNlYXJjaGluZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcFsnbmF2Tm9kZVBhdGhDb2RlJ10gPSB0aGlzLmluc1snbmF2Tm9kZVBhdGhDb2RlJ107XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuaHR0cE1nci5nZXREYXRhKHAsICdsaXN0JykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoeyBcIl9FUlJPUl9cIjogZXJyIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICApLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGFbJ19FUlJPUl8nXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9hZERhdGEoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZGF0YVsnX0VSUk9SXyddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5zZWFyY2guZW1pdChwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfbG9hZERhdGEoZGF0YTogTG9va3VwR3JpZFJlc3VsdCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzLmlucztcclxuICAgICAgICBzZWxmLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgIHNlbGYuZmF2SGVscGVyLnVwZGF0ZUZhdm9yaXRlc1N0YXR1cyhkYXRhLml0ZW1zKTtcclxuICAgICAgICBzZWxmLmxvYWREYXRhVGFibGVEYXRhKGRhdGEpO1xyXG4gICAgICAgIC8vIOmAieS4reaVsOaNrlxyXG4gICAgICAgIHRoaXMuaW5zLnNlbGVjdGlvbk1nci5zZWxlY3RDdXJyZW50VmFsdWUoKTtcclxuICAgIH1cclxuXHJcbiAgICBiaW5kRGF0YVRhYmxlRXZlbnQoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXMuaW5zO1xyXG4gICAgICAgIGNvbnN0IGR0ID0gc2VsZi5jb21wb25lbnRSZWYuaW5zdGFuY2UgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG5cclxuICAgICAgICBkdC5zZWxlY3RlZFJvdy5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci5jbGVhclNlbGVjdGlvbnMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmlucy5jaGVja2VkQ2hhbmdlLmVtaXQoeyBkYXRhOiBbZS5kYXRhXSwgaXNDaGVjazogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhbZS5kYXRhXSk7XHJcbiAgICAgICAgICAgIGR0LmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQudW5TZWxlY3RSb3cuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51blNlbGVjdChlLmRhdGFbc2VsZi5pZEZpZWxkXSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNoZWNrZWRDaGFuZ2UuZW1pdCh7IGRhdGE6IFtlLmRhdGFdLCBpc0NoZWNrOiBmYWxzZSB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuY2hlY2tBbGwuc3Vic2NyaWJlKChlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoZHQuZGF0YSwgZSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNoZWNrZWRDaGFuZ2UuZW1pdCh7IGRhdGE6IGR0LmRhdGEsIGlzQ2hlY2s6IGUgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LnBhZ2VDaGFuZ2VkLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLnVyaSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEoZSwgJ2xpc3QnKS5zdWJzY3JpYmUoKGRhdGE6IExvb2t1cEdyaWRSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5wYWdlckNoYW5nZWQuZW1pdChzZWxmLmh0dHBNZ3IuYnVpbGRRdWVyeVBhcmFtcyhlLCAnbGlzdCcpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5wYWdlU2l6ZUNoYW5nZWQuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VsZi51cmkpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuaHR0cE1nci5nZXREYXRhKGUsICdsaXN0Jykuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGYucGFnZXJDaGFuZ2VkLmVtaXQoc2VsZi5odHRwTWdyLmJ1aWxkUXVlcnlQYXJhbXMoZSwgJ2xpc3QnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuc2VhcmNoLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGlmIChKU09OLnN0cmluZ2lmeShzZWxmLl9zZWFyY2hTdGF0ZSB8fCB7fSkgIT09IEpTT04uc3RyaW5naWZ5KGUgfHwge30pKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmlucy5zZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICBzZWxmLl9zZWFyY2hTdGF0ZSA9IHsuLi4oZSB8fCB7fSl9O1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKGUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5zZWFyY2hWYWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZSAmJiBlLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9zZWFyY2hTdGF0ZSA9IHsuLi5lfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3NlYXJjaFN0YXRlID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDlj4zlh7vkuovku7ZcclxuICAgICAgICBkdC5yb3dEYmxDbGljay5zdWJzY3JpYmUoKHJvd0RhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VsZi5ncmlkT3B0aW9ucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoW3Jvd0RhdGFdKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2VsZWN0SXRlbShyb3dEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDmlLbol4/kuovku7ZcclxuICAgICAgICBkdC5jZWxsQ2xpY2suc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGUuY29sLmZpZWxkID09PSBGQVZPUklURV9GSUVMRF9OQU1FKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjbGFzc0xpc3QgPSBlLmV2ZW50LnRhcmdldFsnY2xhc3NMaXN0J107XHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdmLWxvb2t1cC1mYXZvcml0ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZS5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLml0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWQgPT09IHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBlLnJvdykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bRkFWT1JJVEVfRklFTERfTkFNRV0gPSAhaXRlbVtGQVZPUklURV9GSUVMRF9OQU1FXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGR0LmxvYWREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IHNlbGYuZ3JpZE9wdGlvbnMucGFnZVNpemUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogc2VsZi5ncmlkT3B0aW9ucy5wYWdlSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBzZWxmLmdyaWRPcHRpb25zLnRvdGFsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBzZWxmLmdyaWRPcHRpb25zLml0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOabtOaWsOaUtuiXj+aVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhY3Rpb24gPSBlLnJvd1tGQVZPUklURV9GSUVMRF9OQU1FXSA/IEZhdm9yaXRlQWN0aW9uLmFkZCA6IEZhdm9yaXRlQWN0aW9uLmRlbGV0ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZhY3Rpb24gPT09ICBGYXZvcml0ZUFjdGlvbi5hZGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVJdGVtcyA9IFsuLi50aGlzLmlucy5mYXZvcml0ZUl0ZW1zLCBlLnJvd107XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVJdGVtcyA9IHRoaXMuaW5zLmZhdm9yaXRlSXRlbXMuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBuKSAhPT0gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIGUucm93KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51cGRhdGVGYXZvcml0ZURhdGEoZS5yb3csIGZhY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LmNvbHVtblNvcnRlZC5zdWJzY3JpYmUoKHNvcnQ6IHsgc29ydE5hbWU6IHN0cmluZzsgc29ydE9yZGVyOiBhbnkgfSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fc29ydFN0YXRlID0gc29ydDtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pbnMucmVtb3RlU29ydCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB7IHNvcnROYW1lLCBzb3J0T3JkZXIgfSA9IHsgLi4uc29ydCB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29sID0gdGhpcy5pbnMuY29sdW1ucy5maW5kKG4gPT4gbi5maWVsZCA9PT0gc29ydE5hbWUpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgX3NvcnROYW1lID0gY29sID8gY29sLmZpZWxkUGF0aCA/IGNvbC5maWVsZFBhdGggOiBjb2wuZmllbGQgOiBzb3J0TmFtZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmFtID0ge1xyXG4gICAgICAgICAgICAgICAgc29ydE5hbWU6IF9zb3J0TmFtZSxcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcixcclxuICAgICAgICAgICAgICAgIHNlYXJjaDogc2VsZi5fc2VhcmNoU3RhdGUsXHJcbiAgICAgICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiBzZWxmLnBhZ2VTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogMVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEocGFyYW0sICdzZWFyY2gnKS5zdWJzY3JpYmUoZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmxvYWREYXRhVGFibGVEYXRhKGQpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LmNsZWFyU2VhcmNoVmFsdWUuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgc2VsZi5fc2VhcmNoU3RhdGUgPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LmNlbGxTdHlsZXIgPSAodmFsOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgeyBmaWVsZCB9ID0gdmFsO1xyXG4gICAgICAgICAgICBpZiAoZmllbGQgPT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ3RleHQtb3ZlcmZsb3cnOiAndW5zZXQnXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==