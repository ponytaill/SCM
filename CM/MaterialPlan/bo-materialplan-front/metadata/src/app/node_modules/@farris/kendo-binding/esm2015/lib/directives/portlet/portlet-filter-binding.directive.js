import { Directive, Injector, Input } from "@angular/core";
import { ChangeType, FrameContext, VariableParseService } from "@farris/devkit";
import { PortletComponent } from '@gspwidget/portlet';
import { Subject } from "rxjs";
import { filter } from "rxjs/operators";
import { ExpressionType } from "./types";
const DATA_PATTERN = /\{:?DATA~(\S+?)\}/;
const DATA_PATTERN_GLOBAL = new RegExp(DATA_PATTERN, 'g');
const UI_STATE_PATTERN = /\{:?UISTATE~(\S+?)\}/;
const UI_STATE_PATTERN_GLOBAL = new RegExp(UI_STATE_PATTERN, 'g');
export class PortletFilterBindingDirective {
    constructor(injector, portletComponent, frameContext, variableParseService) {
        this.injector = injector;
        this.portletComponent = portletComponent;
        this.frameContext = frameContext;
        this.variableParseService = variableParseService;
        this.subject = new Subject();
        this.FilterFieldKey = 'dpId';
        this.FilterValueKey = 'value';
    }
    get changes() {
        return this.subject;
    }
    ngOnInit() {
        // 监听数据变化，执行第一次的绑定
        this.frameContext.bindingData.changes.pipe(filter((change) => {
            return (change.type === ChangeType.Load || change.type === ChangeType.Remove || change.type === ChangeType.Update || change.type === ChangeType.SelectionChanged) && (!change.path || change.path.length < 1);
        })).subscribe((change) => {
            this.filter();
        });
        this.changes.subscribe(() => {
            this.filter();
        });
        this.observeChanges();
    }
    filter() {
        const filters = this.buildFilters();
        this.portletComponent.widget.handleFilterChange(filters);
    }
    deserializeFilter() {
        if (!this.filters) {
            return [];
        }
        let filters = [];
        if (typeof this.filters === 'string') {
            filters = JSON.parse(this.filters);
        }
        else if (Array.isArray(this.filters)) {
            filters = this.filters;
        }
        else {
            console.error('invalid filters');
        }
        return filters;
    }
    /**
     * 将表单配置的过滤条件转换为小部件支持的过滤条件
     * @returns
     */
    buildFilters() {
        const filters = this.deserializeFilter();
        const result = [];
        if (!filters || filters.length < 1) {
            return result;
        }
        filters.forEach(filter => {
            result.push({
                dpId: filter[this.FilterFieldKey],
                value: this.variableParseService.parse(filter[this.FilterValueKey], this.frameContext)
            });
        });
        return result;
    }
    collectDependencies(expression) {
        const bindingDataDependencies = this.getBindingDataDependencies(expression);
        const uistateDependencies = this.getUIstateDependencies(expression);
        return bindingDataDependencies.concat(uistateDependencies);
    }
    getBindingDataDependencies(expression) {
        const matchs = expression.match(DATA_PATTERN_GLOBAL);
        return this.buildDependencies(matchs, DATA_PATTERN, ExpressionType.BindingData);
    }
    getUIstateDependencies(expression) {
        const matchs = expression.match(UI_STATE_PATTERN_GLOBAL);
        return this.buildDependencies(matchs, UI_STATE_PATTERN, ExpressionType.UIState);
    }
    buildDependencies(expressions, expr, expressionType) {
        const dependencies = [];
        expressions && expressions.forEach((expression) => {
            const pathMatches = expression.match(expr);
            const dependency = this.buildDependency(pathMatches, expressionType);
            dependencies.push(dependency);
        });
        return dependencies;
    }
    buildDependency(matchs, expressionType) {
        if (matchs && matchs.length === 2) {
            const exps = matchs[1].split('/').filter(p => p);
            const frameId = exps.shift();
            const paths = exps;
            const dependency = {
                type: expressionType,
                frameId,
                paths
            };
            return dependency;
        }
    }
    getFrameContext(frameId) {
        frameId = this.frameContext.getFrameId(frameId);
        return this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
    }
    observeChanges() {
        const filters = this.deserializeFilter();
        filters && filters.forEach((filter) => {
            const dependencies = this.collectDependencies(filter[this.FilterValueKey]);
            if (dependencies && dependencies.length > 0) {
                dependencies.forEach((dep) => {
                    const frameContext = this.getFrameContext(dep.frameId);
                    if (dep.type === ExpressionType.BindingData) {
                        this.observeBindingDataChange(frameContext, dep.paths);
                    }
                    else if (dep.type === ExpressionType.UIState) {
                        this.observeUIStateChange(frameContext, dep.paths.pop());
                    }
                });
            }
        });
    }
    observeUIStateChange(frameContext, path) {
        frameContext.uiState.changes.subscribe((change) => {
            if (change.field === path) {
                this.subject.next();
            }
        });
    }
    observeBindingDataChange(frameContext, paths) {
        frameContext.bindingData.changes.pipe(
        // 只监听主表变化
        filter((change) => change.type === ChangeType.ValueChanged)).subscribe((change) => {
            if (change.path.join('/') === paths.join('/')) {
                this.subject.next();
            }
        });
    }
}
PortletFilterBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: "[portlet-filter-binding]"
            },] }
];
/** @nocollapse */
PortletFilterBindingDirective.ctorParameters = () => [
    { type: Injector },
    { type: PortletComponent },
    { type: FrameContext },
    { type: VariableParseService }
];
PortletFilterBindingDirective.propDecorators = {
    filters: [{ type: Input, args: ["portlet-filter-binding",] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9ydGxldC1maWx0ZXItYmluZGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9wb3J0bGV0L3BvcnRsZXQtZmlsdGVyLWJpbmRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNuRSxPQUFPLEVBQVUsVUFBVSxFQUFFLFlBQVksRUFBeUMsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMvSCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN0RCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsY0FBYyxFQUFxQixNQUFNLFNBQVMsQ0FBQztBQUU1RCxNQUFNLFlBQVksR0FBRyxtQkFBbUIsQ0FBQztBQUN6QyxNQUFNLG1CQUFtQixHQUFHLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztBQUMxRCxNQUFNLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDO0FBQ2hELE1BQU0sdUJBQXVCLEdBQUcsSUFBSSxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFLbEUsTUFBTSxPQUFPLDZCQUE2QjtJQVV4QyxZQUFvQixRQUFrQixFQUFVLGdCQUFrQyxFQUFVLFlBQTBCLEVBQVUsb0JBQTBDO1FBQXRKLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBVGxLLFlBQU8sR0FBaUIsSUFB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QUFRLEVBQUUsMEJBQTBCO2FBQ3JDOzs7O1lBZG1CLFFBQVE7WUFFbkIsZ0JBQWdCO1lBREksWUFBWTtZQUF5QyxvQkFBb0I7OztzQkFzQm5HLEtBQUssU0FBQyx3QkFBd0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIEluamVjdG9yLCBJbnB1dCwgT25Jbml0IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQ2hhbmdlLCBDaGFuZ2VUeXBlLCBGcmFtZUNvbnRleHQsIFVJU3RhdGVDaGFuZ2UsIFVJU3RhdGVPYnNlcnZhYmxlUGFyYW0sIFZhcmlhYmxlUGFyc2VTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcbmltcG9ydCB7IFBvcnRsZXRDb21wb25lbnQgfSBmcm9tICdAZ3Nwd2lkZ2V0L3BvcnRsZXQnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgZmlsdGVyIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25UeXBlLCBJRmlsdGVyRGVwZW5kZW5jeSB9IGZyb20gXCIuL3R5cGVzXCI7XHJcblxyXG5jb25zdCBEQVRBX1BBVFRFUk4gPSAvXFx7Oj9EQVRBfihcXFMrPylcXH0vO1xyXG5jb25zdCBEQVRBX1BBVFRFUk5fR0xPQkFMID0gbmV3IFJlZ0V4cChEQVRBX1BBVFRFUk4sICdnJyk7XHJcbmNvbnN0IFVJX1NUQVRFX1BBVFRFUk4gPSAvXFx7Oj9VSVNUQVRFfihcXFMrPylcXH0vO1xyXG5jb25zdCBVSV9TVEFURV9QQVRURVJOX0dMT0JBTCA9IG5ldyBSZWdFeHAoVUlfU1RBVEVfUEFUVEVSTiwgJ2cnKTtcclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiBcIltwb3J0bGV0LWZpbHRlci1iaW5kaW5nXVwiXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb3J0bGV0RmlsdGVyQmluZGluZ0RpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcbiAgcHJpdmF0ZSBzdWJqZWN0OiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBGaWx0ZXJGaWVsZEtleSA9ICdkcElkJztcclxuICBwcml2YXRlIHJlYWRvbmx5IEZpbHRlclZhbHVlS2V5ID0gJ3ZhbHVlJztcclxuXHJcbiAgcHJpdmF0ZSBnZXQgY2hhbmdlcygpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc3ViamVjdDtcclxuICB9XHJcbiAgQElucHV0KFwicG9ydGxldC1maWx0ZXItYmluZGluZ1wiKSBmaWx0ZXJzOiBzdHJpbmcgfCBhbnlbXTtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgcG9ydGxldENvbXBvbmVudDogUG9ydGxldENvbXBvbmVudCwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSB2YXJpYWJsZVBhcnNlU2VydmljZTogVmFyaWFibGVQYXJzZVNlcnZpY2UpIHsgfVxyXG4gIHB1YmxpYyBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIC8vIOebkeWQrOaVsOaNruWPmOWMlu+8jOaJp+ihjOesrOS4gOasoeeahOe7keWumlxyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5waXBlKGZpbHRlcigoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgcmV0dXJuIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5VcGRhdGUgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCkgJiYgKCFjaGFuZ2UucGF0aCB8fCBjaGFuZ2UucGF0aC5sZW5ndGggPCAxKTtcclxuICAgIH0pKS5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIHRoaXMuZmlsdGVyKCk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMuY2hhbmdlcy5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLmZpbHRlcigpO1xyXG4gICAgfSk7XHJcbiAgICB0aGlzLm9ic2VydmVDaGFuZ2VzKCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZmlsdGVyKCkge1xyXG4gICAgY29uc3QgZmlsdGVycyA9IHRoaXMuYnVpbGRGaWx0ZXJzKCk7XHJcbiAgICB0aGlzLnBvcnRsZXRDb21wb25lbnQud2lkZ2V0LmhhbmRsZUZpbHRlckNoYW5nZShmaWx0ZXJzKTtcclxuICB9XHJcbiAgcHVibGljIGRlc2VyaWFsaXplRmlsdGVyKCkge1xyXG4gICAgaWYgKCF0aGlzLmZpbHRlcnMpIHtcclxuICAgICAgcmV0dXJuIFtdO1xyXG4gICAgfVxyXG4gICAgbGV0IGZpbHRlcnMgPSBbXTtcclxuICAgIGlmICh0eXBlb2YgdGhpcy5maWx0ZXJzID09PSAnc3RyaW5nJykge1xyXG4gICAgICBmaWx0ZXJzID0gSlNPTi5wYXJzZSh0aGlzLmZpbHRlcnMpO1xyXG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHRoaXMuZmlsdGVycykpIHtcclxuICAgICAgZmlsdGVycyA9IHRoaXMuZmlsdGVycztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ2ludmFsaWQgZmlsdGVycycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZpbHRlcnM7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWwhuihqOWNlemFjee9rueahOi/h+a7pOadoeS7tui9rOaNouS4uuWwj+mDqOS7tuaUr+aMgeeahOi/h+a7pOadoeS7tlxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRGaWx0ZXJzKCk6IGFueVtdIHtcclxuICAgIGNvbnN0IGZpbHRlcnMgPSB0aGlzLmRlc2VyaWFsaXplRmlsdGVyKCk7XHJcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgIGlmICghZmlsdGVycyB8fCBmaWx0ZXJzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIGZpbHRlcnMuZm9yRWFjaChmaWx0ZXIgPT4ge1xyXG4gICAgICByZXN1bHQucHVzaCh7XHJcbiAgICAgICAgZHBJZDogZmlsdGVyW3RoaXMuRmlsdGVyRmllbGRLZXldLFxyXG4gICAgICAgIHZhbHVlOiB0aGlzLnZhcmlhYmxlUGFyc2VTZXJ2aWNlLnBhcnNlKGZpbHRlclt0aGlzLkZpbHRlclZhbHVlS2V5XSwgdGhpcy5mcmFtZUNvbnRleHQpXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuICBwcml2YXRlIGNvbGxlY3REZXBlbmRlbmNpZXMoZXhwcmVzc2lvbjogc3RyaW5nKTogSUZpbHRlckRlcGVuZGVuY3lbXSB7XHJcbiAgICBjb25zdCBiaW5kaW5nRGF0YURlcGVuZGVuY2llcyA9IHRoaXMuZ2V0QmluZGluZ0RhdGFEZXBlbmRlbmNpZXMoZXhwcmVzc2lvbik7XHJcbiAgICBjb25zdCB1aXN0YXRlRGVwZW5kZW5jaWVzID0gdGhpcy5nZXRVSXN0YXRlRGVwZW5kZW5jaWVzKGV4cHJlc3Npb24pO1xyXG4gICAgcmV0dXJuIGJpbmRpbmdEYXRhRGVwZW5kZW5jaWVzLmNvbmNhdCh1aXN0YXRlRGVwZW5kZW5jaWVzKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nRGF0YURlcGVuZGVuY2llcyhleHByZXNzaW9uOiBzdHJpbmcpOiBJRmlsdGVyRGVwZW5kZW5jeVtdIHtcclxuICAgIGNvbnN0IG1hdGNocyA9IGV4cHJlc3Npb24ubWF0Y2goREFUQV9QQVRURVJOX0dMT0JBTCk7XHJcbiAgICByZXR1cm4gdGhpcy5idWlsZERlcGVuZGVuY2llcyhtYXRjaHMsIERBVEFfUEFUVEVSTiwgRXhwcmVzc2lvblR5cGUuQmluZGluZ0RhdGEpO1xyXG4gIH1cclxuICBwcml2YXRlIGdldFVJc3RhdGVEZXBlbmRlbmNpZXMoZXhwcmVzc2lvbjogc3RyaW5nKTogSUZpbHRlckRlcGVuZGVuY3lbXSB7XHJcbiAgICBjb25zdCBtYXRjaHMgPSBleHByZXNzaW9uLm1hdGNoKFVJX1NUQVRFX1BBVFRFUk5fR0xPQkFMKTtcclxuICAgIHJldHVybiB0aGlzLmJ1aWxkRGVwZW5kZW5jaWVzKG1hdGNocywgVUlfU1RBVEVfUEFUVEVSTiwgRXhwcmVzc2lvblR5cGUuVUlTdGF0ZSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGREZXBlbmRlbmNpZXMoZXhwcmVzc2lvbnM6IFJlZ0V4cE1hdGNoQXJyYXksIGV4cHI6IFJlZ0V4cCwgZXhwcmVzc2lvblR5cGU6IEV4cHJlc3Npb25UeXBlKSB7XHJcbiAgICBjb25zdCBkZXBlbmRlbmNpZXM6IElGaWx0ZXJEZXBlbmRlbmN5W10gPSBbXTtcclxuICAgIGV4cHJlc3Npb25zICYmIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb246IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBwYXRoTWF0Y2hlcyA9IGV4cHJlc3Npb24ubWF0Y2goZXhwcik7XHJcbiAgICAgIGNvbnN0IGRlcGVuZGVuY3kgPSB0aGlzLmJ1aWxkRGVwZW5kZW5jeShwYXRoTWF0Y2hlcywgZXhwcmVzc2lvblR5cGUpO1xyXG4gICAgICBkZXBlbmRlbmNpZXMucHVzaChkZXBlbmRlbmN5KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGRlcGVuZGVuY2llcztcclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZERlcGVuZGVuY3kobWF0Y2hzOiBSZWdFeHBNYXRjaEFycmF5LCBleHByZXNzaW9uVHlwZTogRXhwcmVzc2lvblR5cGUpIHtcclxuICAgIGlmIChtYXRjaHMgJiYgbWF0Y2hzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICBjb25zdCBleHBzID0gbWF0Y2hzWzFdLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgIGNvbnN0IGZyYW1lSWQgPSBleHBzLnNoaWZ0KCk7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gZXhwcztcclxuICAgICAgY29uc3QgZGVwZW5kZW5jeTogSUZpbHRlckRlcGVuZGVuY3kgPSB7XHJcbiAgICAgICAgdHlwZTogZXhwcmVzc2lvblR5cGUsXHJcbiAgICAgICAgZnJhbWVJZCxcclxuICAgICAgICBwYXRoc1xyXG4gICAgICB9O1xyXG4gICAgICByZXR1cm4gZGVwZW5kZW5jeTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHQoZnJhbWVJZDogc3RyaW5nKSB7XHJcbiAgICBmcmFtZUlkID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0RnJhbWVJZChmcmFtZUlkKTtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBvYnNlcnZlQ2hhbmdlcygpIHtcclxuICAgIGNvbnN0IGZpbHRlcnMgPSB0aGlzLmRlc2VyaWFsaXplRmlsdGVyKCk7XHJcbiAgICBmaWx0ZXJzICYmIGZpbHRlcnMuZm9yRWFjaCgoZmlsdGVyOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgZGVwZW5kZW5jaWVzID0gdGhpcy5jb2xsZWN0RGVwZW5kZW5jaWVzKGZpbHRlclt0aGlzLkZpbHRlclZhbHVlS2V5XSk7XHJcbiAgICAgIGlmIChkZXBlbmRlbmNpZXMgJiYgZGVwZW5kZW5jaWVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBkZXBlbmRlbmNpZXMuZm9yRWFjaCgoZGVwOiBJRmlsdGVyRGVwZW5kZW5jeSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoZGVwLmZyYW1lSWQpO1xyXG4gICAgICAgICAgaWYgKGRlcC50eXBlID09PSBFeHByZXNzaW9uVHlwZS5CaW5kaW5nRGF0YSkge1xyXG4gICAgICAgICAgICB0aGlzLm9ic2VydmVCaW5kaW5nRGF0YUNoYW5nZShmcmFtZUNvbnRleHQsIGRlcC5wYXRocyk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGRlcC50eXBlID09PSBFeHByZXNzaW9uVHlwZS5VSVN0YXRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMub2JzZXJ2ZVVJU3RhdGVDaGFuZ2UoZnJhbWVDb250ZXh0LCBkZXAucGF0aHMucG9wKCkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIG9ic2VydmVVSVN0YXRlQ2hhbmdlKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwYXRoOiBzdHJpbmcpIHtcclxuICAgIGZyYW1lQ29udGV4dC51aVN0YXRlLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IFVJU3RhdGVPYnNlcnZhYmxlUGFyYW0pID0+IHtcclxuICAgICAgaWYgKGNoYW5nZS5maWVsZCA9PT0gcGF0aCkge1xyXG4gICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIG9ic2VydmVCaW5kaW5nRGF0YUNoYW5nZShmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcGF0aHM6IHN0cmluZ1tdKSB7XHJcbiAgICBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5waXBlKFxyXG4gICAgICAvLyDlj6rnm5HlkKzkuLvooajlj5jljJZcclxuICAgICAgZmlsdGVyKChjaGFuZ2U6IENoYW5nZSkgPT4gY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkKVxyXG4gICAgKS5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2UucGF0aC5qb2luKCcvJykgPT09IHBhdGhzLmpvaW4oJy8nKSkge1xyXG4gICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxufSJdfQ==