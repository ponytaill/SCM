/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, Directive, HostListener, Injector, Input, NgZone, Renderer2 } from '@angular/core';
import { reqAnimFrame } from '@farris/ui-common';
import { InputGroupComponent } from '@farris/ui-input-group';
import { debounceTime, filter, map } from 'rxjs/operators';
import { LookupGridDisplayType } from '../lookup-displaytype';
import { LookupGridComponent } from '../lookup-grid.component';
import { LookupQuickSelectPanelComponent } from './quick-select-panel.component';
export class LookupQuickSelectDirective {
    /**
     * @param {?} injector
     * @param {?} ngzone
     * @param {?} render
     * @param {?} inputRef
     * @param {?} lookupRef
     * @param {?} cfr
     */
    constructor(injector, ngzone, render, inputRef, lookupRef, cfr) {
        this.injector = injector;
        this.ngzone = ngzone;
        this.render = render;
        this.inputRef = inputRef;
        this.lookupRef = lookupRef;
        this.cfr = cfr;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        if (this.options && this.options.enable) {
            this.inputRef.inputClick.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                if (!this.panelElement) {
                    // 执行帮助前
                    this.lookupRef.dictPicking({
                        instance: this,
                    }).subscribe((/**
                     * @param {?} pr
                     * @return {?}
                     */
                    (pr) => {
                        if (this.lookupRef.displayType === LookupGridDisplayType.TreeList || !this.lookupRef.singleSelect) {
                            return;
                        }
                        const { show, customData, message } = this.lookupRef.dialogMgr.checkDictPickingResult(pr);
                        this.lookupRef.customData = customData;
                        if (show) {
                            this.createDataPanel();
                        }
                        else {
                            if (message) {
                                this.lookupRef.notifyService.warning(message);
                            }
                        }
                    }));
                }
            }));
            this.inputRef.valueChange.pipe(debounceTime(200)).subscribe((/**
             * @param {?} val
             * @return {?}
             */
            (val) => {
                this.lookupRef.dictPicking({ instance: this }).subscribe((/**
                 * @param {?} pr
                 * @return {?}
                 */
                (pr) => {
                    if (this.lookupRef.displayType === LookupGridDisplayType.TreeList || !this.lookupRef.singleSelect) {
                        return;
                    }
                    const { show, customData, message } = this.lookupRef.dialogMgr.checkDictPickingResult(pr);
                    this.lookupRef.customData = customData;
                    if (!this.panelElement) {
                        this.createDataPanel();
                    }
                    else {
                        this.loadData();
                    }
                }));
            }));
            this.inputRef.keydownHandle.pipe(filter((/**
             * @param {?} event
             * @return {?}
             */
            (event) => {
                return event.key === 'Escape' || event.key === 'Tab' || event.key === 'ArrowRight' || event.key === 'F2';
            }))).subscribe((/**
             * @return {?}
             */
            () => {
                this.hide();
            }));
        }
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.lookupRef.overLayService.destory(this.lookupRef.el.nativeElement);
    }
    /**
     * @private
     * @return {?}
     */
    removePanelElement() {
        document.body.removeChild(this.panelElement);
        this.panelElement = null;
    }
    /**
     * @param {?=} e
     * @return {?}
     */
    hide(e) {
        reqAnimFrame((/**
         * @return {?}
         */
        () => {
            if (this.panelElement) {
                if (e && (e.type === 'mousewheel' || e.type === 'wheel')) {
                    this.removePanelElement();
                }
                else {
                    this.panelElement.classList.remove('f-area-show');
                    setTimeout((/**
                     * @return {?}
                     */
                    () => {
                        this.removePanelElement();
                    }), 120);
                }
                this.lookupRef.overLayService.destory(this.lookupRef.el.nativeElement);
            }
        }));
    }
    /**
     * @private
     * @return {?}
     */
    createDataPanel() {
        this.panelElement = document.createElement('div');
        this.panelElement.classList.add('overlay-pane', 'f-lookup_quick-panel', 'f-area-hide');
        document.body.appendChild(this.panelElement);
        const { width, left, top, height } = this.getPanelSize();
        this.panelElement.style.width = `${width}px`;
        this.panelElement.style.height = `${height}px`;
        this.panelElement.style.top = `${top}px`;
        this.panelElement.style.left = `${left}px`;
        this.panelElement.style.zIndex = '10001';
        // 创建数据展示组件
        /** @type {?} */
        const cmpFact = this.cfr.resolveComponentFactory(LookupQuickSelectPanelComponent);
        this.cmpRef = cmpFact.create(this.injector);
        this.cmpRef.instance.showMore = this.options.showMore;
        this.cmpRef.instance.textField = this.lookupRef.textField;
        this.cmpRef.instance.formatter = this.options.formatter;
        // cmpRef.location.nativeElement.classList.add('farris-main-area');
        this.panelElement.appendChild(this.cmpRef.location.nativeElement);
        this.cmpRef.changeDetectorRef.detectChanges();
        // more clicked 打开帮助窗口
        this.cmpRef.instance.moreClcik.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.hide(e);
            this.lookupRef.showDialog();
        }));
        this.cmpRef.instance.itemClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            const { data } = e;
            this.lookupRef.selectItem(data);
            this.hide();
        }));
        // 注册鼠标滚轮，点击事件，用于隐藏Panel
        this.lookupRef.overLayService.registerMouseEvent(this.lookupRef.el.nativeElement, (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (!this.panelElement || e.target['closest']('.f-lookup_quick-panel')) {
                return;
            }
            if (this.cmpRef) {
                this.cmpRef.destroy();
                this.cmpRef = null;
            }
            this.hide(e);
            if (this.lookupRef.inputGroup.textbox.nativeElement === e.target) {
                return false;
            }
        }));
        this.panelElement.classList.add('f-area-show');
        this.loadData();
    }
    /**
     * @private
     * @return {?}
     */
    calculationPanelHeight() {
        return this.options.showItemsCount * 30 + (this.options.showMore ? 50 : 0) + this.options.footerHeight + 5;
    }
    /**
     * @private
     * @return {?}
     */
    getInputSizeInfo() {
        /** @type {?} */
        const el = this.lookupRef.viewType === 'text' ? this.inputRef.inputGroup : this.lookupRef.tagbox;
        return el.nativeElement.getBoundingClientRect();
    }
    /**
     * @private
     * @return {?}
     */
    getPanelSize() {
        let { width, height, top, left } = this.getInputSizeInfo();
        /** @type {?} */
        const bottom = window.innerHeight - height - top;
        /** @type {?} */
        let panelHeight = this.calculationPanelHeight();
        /** @type {?} */
        const h = top > bottom ? top : bottom;
        if (bottom > panelHeight) {
            top = top + height;
            // 面板由上向下展开
            this.panelElement.style.transformOrigin = '100% top';
        }
        else {
            if (top > bottom) {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                    top = 10;
                }
                else {
                    top = top - parseInt('' + panelHeight, 10) - 5;
                }
                // 面板由下向上展开
                this.panelElement.style.transformOrigin = '100% bottom';
            }
            else {
                if (h < panelHeight) {
                    panelHeight = h - 10;
                }
                top = top + height;
            }
        }
        return { width, top, height: panelHeight, left };
    }
    /**
     * @private
     * @return {?}
     */
    getData() {
        /** @type {?} */
        let p = {
            pageInfo: {
                pageSize: this.options.showItemsCount,
                pageIndex: 1,
            },
        };
        /** @type {?} */
        let t = "all";
        if (this.lookupRef.isTextChange) {
            this.lookupRef._searchState = {
                field: this.lookupRef.textField,
                //"*",
                value: this.lookupRef.displayText
            };
            p = {
                search: this.lookupRef._searchState
            };
            t = 'search';
        }
        return this.lookupRef.httpMgr.lookupRequest(p, t).pipe(map((/**
         * @param {?} restData
         * @return {?}
         */
        (restData) => {
            if (restData) {
                return restData.items || [];
            }
            if (this.lookupRef.displayText && this.lookupRef.isTextChange) {
                return this.lookupRef.items.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return n[this.lookupRef.textField].indexOf(this.lookupRef.displayText) > -1;
                })).slice(0, this.options.showItemsCount);
            }
            return this.lookupRef.items.slice(0, this.options.showItemsCount);
        })));
    }
    /**
     * @private
     * @return {?}
     */
    loadData() {
        /** @type {?} */
        const loadingRef = this.lookupRef.loadingService.show({ container: this.panelElement });
        this.getData().subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            this.cmpRef.instance.loadData(data);
            loadingRef.close();
        }));
    }
    /**
     * @param {?} $event
     * @return {?}
     */
    registerKeyboardEvent($event) {
        if (!this.lookupRef.singleSelect) {
            return;
        }
        /** @type {?} */
        let rows = [];
        if (this.cmpRef) {
            rows = this.cmpRef.instance.data;
        }
        if (!rows || !rows.length) {
            return;
        }
        if ($event.code === 'ArrowUp' || $event.code === 'ArrowDown') {
            $event.preventDefault();
            $event.stopPropagation();
        }
        /** @type {?} */
        const idx = this.cmpRef.instance.activeIndex;
        /** @type {?} */
        let activeIndex = idx;
        /** @type {?} */
        const selectItem = (/**
         * @param {?} index
         * @return {?}
         */
        (index) => {
            activeIndex = index;
            this.cmpRef.instance.setActiveItem(index);
        });
        if ($event.code === 'ArrowUp') { // up
            if (idx > -1) {
                /** @type {?} */
                let prevIdx = idx - 1;
                if (prevIdx < 0) {
                    prevIdx = rows.length - 1;
                }
                selectItem(prevIdx);
            }
            else {
                selectItem(rows.length - 1);
            }
        }
        if ($event.code === 'ArrowDown') { // down
            // down
            /** @type {?} */
            let nextIdx = idx + 1;
            if (nextIdx >= rows.length) {
                nextIdx = 0;
            }
            selectItem(nextIdx);
        }
        if ($event.key === 'Enter') {
            if (rows && rows.length) {
                /** @type {?} */
                const data = rows[idx];
                this.lookupRef.selectItem(data);
                this.hide();
            }
        }
    }
}
LookupQuickSelectDirective.decorators = [
    { type: Directive, args: [{ selector: '[quick-select]' },] }
];
/** @nocollapse */
LookupQuickSelectDirective.ctorParameters = () => [
    { type: Injector },
    { type: NgZone },
    { type: Renderer2 },
    { type: InputGroupComponent },
    { type: LookupGridComponent },
    { type: ComponentFactoryResolver }
];
LookupQuickSelectDirective.propDecorators = {
    options: [{ type: Input, args: ['quick-select',] }],
    registerKeyboardEvent: [{ type: HostListener, args: ['keydown', ['$event'],] }]
};
if (false) {
    /** @type {?} */
    LookupQuickSelectDirective.prototype.options;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.panelElement;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.cmpRef;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.inputRef;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.lookupRef;
    /**
     * @type {?}
     * @private
     */
    LookupQuickSelectDirective.prototype.cfr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLXF1aWNrLXNlbGVjdC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9xdWljay1zZWxlY3QvbG9va3VwLXF1aWNrLXNlbGVjdC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBaUIsd0JBQXdCLEVBQWdCLFNBQVMsRUFBYyxZQUFZLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQXFCLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsTCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDakQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFN0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0QsT0FBTyxFQUFFLHFCQUFxQixFQUFxQixNQUFNLHVCQUF1QixDQUFDO0FBRWpGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBR2pGLE1BQU0sT0FBTywwQkFBMEI7Ozs7Ozs7OztJQUtuQyxZQUFvQixRQUFrQixFQUFVLE1BQWMsRUFBVSxNQUFpQixFQUFXLFFBQTZCLEVBQVUsU0FBOEIsRUFDN0osR0FBNkI7UUFEckIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQVcsYUFBUSxHQUFSLFFBQVEsQ0FBcUI7UUFBVSxjQUFTLEdBQVQsU0FBUyxDQUFxQjtRQUM3SixRQUFHLEdBQUgsR0FBRyxDQUEwQjtJQUN6QyxDQUFDOzs7O0lBRUQsUUFBUTtJQUVSLENBQUM7Ozs7SUFFRCxlQUFlO1FBQ1gsSUFBSSxJQUFJLENB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OlsiaW1wb3J0IHsgQWZ0ZXJWaWV3SW5pdCwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgSG9zdExpc3RlbmVyLCBJbmplY3RvciwgSW5wdXQsIE5nWm9uZSwgT25EZXN0cm95LCBPbkluaXQsIFJlbmRlcmVyMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyByZXFBbmltRnJhbWUgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IElucHV0R3JvdXBDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWlucHV0LWdyb3VwJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIGZpbHRlciwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgTG9va3VwR3JpZERpc3BsYXlUeXBlLCBRdWlja1NlbGVjdE9wdGlvbiB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IERpc3BsYXlJbmZvLCBMT0FEX0RBVEFfVFlQRSwgTG9va3VwR3JpZFJlc3VsdCwgUGlja2luZ1Jlc3VsdCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgTG9va3VwUXVpY2tTZWxlY3RQYW5lbENvbXBvbmVudCB9IGZyb20gJy4vcXVpY2stc2VsZWN0LXBhbmVsLmNvbXBvbmVudCc7XHJcblxyXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbcXVpY2stc2VsZWN0XSd9KVxyXG5leHBvcnQgY2xhc3MgTG9va3VwUXVpY2tTZWxlY3REaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XHJcbiAgICBASW5wdXQoJ3F1aWNrLXNlbGVjdCcpIG9wdGlvbnM6IFF1aWNrU2VsZWN0T3B0aW9uO1xyXG5cclxuICAgIHByaXZhdGUgcGFuZWxFbGVtZW50OiBIVE1MRWxlbWVudDtcclxuICAgIHByaXZhdGUgY21wUmVmOiBDb21wb25lbnRSZWY8TG9va3VwUXVpY2tTZWxlY3RQYW5lbENvbXBvbmVudD47XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBuZ3pvbmU6IE5nWm9uZSwgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcmVyMiwgIHByaXZhdGUgaW5wdXRSZWY6IElucHV0R3JvdXBDb21wb25lbnQsIHByaXZhdGUgbG9va3VwUmVmOiBMb29rdXBHcmlkQ29tcG9uZW50LFxyXG4gICAgICAgIHByaXZhdGUgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpIHtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBcclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucyAmJiB0aGlzLm9wdGlvbnMuZW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRSZWYuaW5wdXRDbGljay5zdWJzY3JpYmUoKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMucGFuZWxFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5omn6KGM5biu5Yqp5YmNXHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYuZGljdFBpY2tpbmcoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZTogdGhpcyxcclxuICAgICAgICAgICAgICAgICAgICB9KS5zdWJzY3JpYmUoKHByOiBQaWNraW5nUmVzdWx0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb2t1cFJlZi5kaXNwbGF5VHlwZSA9PT0gTG9va3VwR3JpZERpc3BsYXlUeXBlLlRyZWVMaXN0IHx8ICF0aGlzLmxvb2t1cFJlZi5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHNob3csIGN1c3RvbURhdGEsIG1lc3NhZ2UgfSA9IHRoaXMubG9va3VwUmVmLmRpYWxvZ01nci5jaGVja0RpY3RQaWNraW5nUmVzdWx0KHByKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYuY3VzdG9tRGF0YSA9IGN1c3RvbURhdGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaG93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZURhdGFQYW5lbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1lc3NhZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFJlZi5ub3RpZnlTZXJ2aWNlLndhcm5pbmcobWVzc2FnZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRSZWYudmFsdWVDaGFuZ2UucGlwZShcclxuICAgICAgICAgICAgICAgIGRlYm91bmNlVGltZSgyMDApXHJcbiAgICAgICAgICAgICkuc3Vic2NyaWJlKCh2YWw6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYuZGljdFBpY2tpbmcoe2luc3RhbmNlOiB0aGlzfSkuc3Vic2NyaWJlKChwcjogUGlja2luZ1Jlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb2t1cFJlZi5kaXNwbGF5VHlwZSA9PT0gTG9va3VwR3JpZERpc3BsYXlUeXBlLlRyZWVMaXN0IHx8ICF0aGlzLmxvb2t1cFJlZi5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHNob3csIGN1c3RvbURhdGEsIG1lc3NhZ2UgfSA9IHRoaXMubG9va3VwUmVmLmRpYWxvZ01nci5jaGVja0RpY3RQaWNraW5nUmVzdWx0KHByKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFJlZi5jdXN0b21EYXRhID0gY3VzdG9tRGF0YTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMucGFuZWxFbGVtZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlRGF0YVBhbmVsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkRGF0YSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5pbnB1dFJlZi5rZXlkb3duSGFuZGxlLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBmaWx0ZXIoKGV2ZW50OiBLZXlib2FyZEV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2ZW50LmtleSA9PT0gJ0VzY2FwZScgfHwgZXZlbnQua2V5ID09PSAnVGFiJyB8fCBldmVudC5rZXkgPT09ICdBcnJvd1JpZ2h0JyB8fCBldmVudC5rZXkgPT09ICdGMic7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubG9va3VwUmVmLm92ZXJMYXlTZXJ2aWNlLmRlc3RvcnkodGhpcy5sb29rdXBSZWYuZWwubmF0aXZlRWxlbWVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZW1vdmVQYW5lbEVsZW1lbnQoKSB7XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLnBhbmVsRWxlbWVudCk7XHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQgPSBudWxsO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBoaWRlKGU/OiBhbnkpIHtcclxuICAgICAgICByZXFBbmltRnJhbWUoKCkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5wYW5lbEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlICYmICggZS50eXBlID09PSAnbW91c2V3aGVlbCcgfHwgZS50eXBlID09PSAnd2hlZWwnKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlUGFuZWxFbGVtZW50KCk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2YtYXJlYS1zaG93Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlUGFuZWxFbGVtZW50KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwxMjApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFJlZi5vdmVyTGF5U2VydmljZS5kZXN0b3J5KHRoaXMubG9va3VwUmVmLmVsLm5hdGl2ZUVsZW1lbnQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgY3JlYXRlRGF0YVBhbmVsKCkge1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnb3ZlcmxheS1wYW5lJywgJ2YtbG9va3VwX3F1aWNrLXBhbmVsJywgJ2YtYXJlYS1oaWRlJyk7XHJcblxyXG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5wYW5lbEVsZW1lbnQpO1xyXG4gICAgICAgIGNvbnN0IHsgd2lkdGgsIGxlZnQsIHRvcCwgaGVpZ2h0IH0gPSB0aGlzLmdldFBhbmVsU2l6ZSgpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLndpZHRoID0gYCR7d2lkdGh9cHhgO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLmhlaWdodCA9IGAke2hlaWdodH1weGA7XHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUudG9wID0gYCR7dG9wfXB4YDtcclxuICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS5sZWZ0ID0gYCR7bGVmdH1weGA7XHJcbiAgICAgICAgdGhpcy5wYW5lbEVsZW1lbnQuc3R5bGUuekluZGV4ID0gJzEwMDAxJztcclxuICAgICAgICBcclxuICAgICAgICAvLyDliJvlu7rmlbDmja7lsZXnpLrnu4Tku7ZcclxuICAgICAgICBjb25zdCBjbXBGYWN0ID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoTG9va3VwUXVpY2tTZWxlY3RQYW5lbENvbXBvbmVudCk7XHJcbiAgICAgICAgdGhpcy5jbXBSZWYgPSBjbXBGYWN0LmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuICAgICAgICBcclxuICAgICAgICB0aGlzLmNtcFJlZi5pbnN0YW5jZS5zaG93TW9yZSA9IHRoaXMub3B0aW9ucy5zaG93TW9yZTtcclxuICAgICAgICB0aGlzLmNtcFJlZi5pbnN0YW5jZS50ZXh0RmllbGQgPSB0aGlzLmxvb2t1cFJlZi50ZXh0RmllbGQ7XHJcbiAgICAgICAgdGhpcy5jbXBSZWYuaW5zdGFuY2UuZm9ybWF0dGVyID0gdGhpcy5vcHRpb25zLmZvcm1hdHRlcjtcclxuXHJcbiAgICAgICAgLy8gY21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnZmFycmlzLW1haW4tYXJlYScpO1xyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmFwcGVuZENoaWxkKHRoaXMuY21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQpO1xyXG5cclxuICAgICAgICB0aGlzLmNtcFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIC8vIG1vcmUgY2xpY2tlZCDmiZPlvIDluK7liqnnqpflj6NcclxuICAgICAgICB0aGlzLmNtcFJlZi5pbnN0YW5jZS5tb3JlQ2xjaWsuc3Vic2NyaWJlKChlKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZShlKTtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBSZWYuc2hvd0RpYWxvZygpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmNtcFJlZi5pbnN0YW5jZS5pdGVtQ2xpY2suc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgeyBkYXRhIH0gPSBlO1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFJlZi5zZWxlY3RJdGVtKGRhdGEpO1xyXG4gICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgIC8vIOazqOWGjOm8oOagh+a7mui9ru+8jOeCueWHu+S6i+S7tu+8jOeUqOS6jumakOiXj1BhbmVsXHJcbiAgICAgICAgdGhpcy5sb29rdXBSZWYub3ZlckxheVNlcnZpY2UucmVnaXN0ZXJNb3VzZUV2ZW50KHRoaXMubG9va3VwUmVmLmVsLm5hdGl2ZUVsZW1lbnQsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5wYW5lbEVsZW1lbnQgfHwgZS50YXJnZXRbJ2Nsb3Nlc3QnXSgnLmYtbG9va3VwX3F1aWNrLXBhbmVsJykpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuY21wUmVmKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNtcFJlZi5kZXN0cm95KCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNtcFJlZiA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuaGlkZShlKTtcclxuXHJcbiAgICAgICAgICAgIGlmKHRoaXMubG9va3VwUmVmLmlucHV0R3JvdXAudGV4dGJveC5uYXRpdmVFbGVtZW50ID09PSBlLnRhcmdldCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMucGFuZWxFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2YtYXJlYS1zaG93Jyk7XHJcblxyXG4gICAgICAgIHRoaXMubG9hZERhdGEoKTtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHByaXZhdGUgY2FsY3VsYXRpb25QYW5lbEhlaWdodCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5vcHRpb25zLnNob3dJdGVtc0NvdW50ICogMzAgKyAodGhpcy5vcHRpb25zLnNob3dNb3JlID8gNTA6IDApICsgdGhpcy5vcHRpb25zLmZvb3RlckhlaWdodCArIDU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRJbnB1dFNpemVJbmZvKCkge1xyXG4gICAgICAgIGNvbnN0IGVsOiBhbnkgPSB0aGlzLmxvb2t1cFJlZi52aWV3VHlwZSA9PT0gJ3RleHQnID8gdGhpcy5pbnB1dFJlZi5pbnB1dEdyb3VwIDogdGhpcy5sb29rdXBSZWYudGFnYm94O1xyXG4gICAgICAgIHJldHVybiBlbC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0UGFuZWxTaXplKCkge1xyXG4gICAgICAgIGxldCB7IHdpZHRoLCBoZWlnaHQsIHRvcCwgbGVmdCB9ID0gdGhpcy5nZXRJbnB1dFNpemVJbmZvKCk7XHJcbiAgICAgICAgY29uc3QgYm90dG9tID0gd2luZG93LmlubmVySGVpZ2h0IC0gaGVpZ2h0IC0gdG9wO1xyXG4gICAgICAgIGxldCBwYW5lbEhlaWdodCA9IHRoaXMuY2FsY3VsYXRpb25QYW5lbEhlaWdodCgpO1xyXG5cclxuICAgICAgICBjb25zdCBoID0gdG9wID4gYm90dG9tID8gdG9wIDogYm90dG9tO1xyXG4gICAgICAgIGlmIChib3R0b20gPiBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgKyBoZWlnaHQ7XHJcbiAgICAgICAgICAgIC8vIOmdouadv+eUseS4iuWQkeS4i+WxleW8gFxyXG4gICAgICAgICAgICB0aGlzLnBhbmVsRWxlbWVudC5zdHlsZS50cmFuc2Zvcm1PcmlnaW4gPSAnMTAwJSB0b3AnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0b3AgPiBib3R0b20pIHtcclxuICAgICAgICAgICAgICAgIGlmIChoIDwgcGFuZWxIZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYW5lbEhlaWdodCA9IGggLSAxMDtcclxuICAgICAgICAgICAgICAgICAgICB0b3AgPSAxMDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdG9wID0gdG9wIC0gcGFyc2VJbnQoJycgKyBwYW5lbEhlaWdodCwgMTApIC0gNTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyDpnaLmnb/nlLHkuIvlkJHkuIrlsZXlvIBcclxuICAgICAgICAgICAgICAgIHRoaXMucGFuZWxFbGVtZW50LnN0eWxlLnRyYW5zZm9ybU9yaWdpbiA9ICcxMDAlIGJvdHRvbSc7XHJcblxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGggPCBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhbmVsSGVpZ2h0ID0gaCAtIDEwO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdG9wID0gdG9wICsgaGVpZ2h0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4geyB3aWR0aCwgdG9wLCBoZWlnaHQ6IHBhbmVsSGVpZ2h0LCBsZWZ0IH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXREYXRhKCk6IE9ic2VydmFibGU8QXJyYXk8YW55Pj4ge1xyXG4gICAgICAgIGxldCBwOiBhbnkgPSB7XHJcbiAgICAgICAgICAgIHBhZ2VJbmZvOiB7XHJcbiAgICAgICAgICAgICAgICBwYWdlU2l6ZTogdGhpcy5vcHRpb25zLnNob3dJdGVtc0NvdW50LFxyXG4gICAgICAgICAgICAgICAgcGFnZUluZGV4OiAxLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IHQ6IExPQURfREFUQV9UWVBFID0gXCJhbGxcIjtcclxuICAgICAgICBpZiAodGhpcy5sb29rdXBSZWYuaXNUZXh0Q2hhbmdlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwUmVmLl9zZWFyY2hTdGF0ZSA9IHsgXHJcbiAgICAgICAgICAgICAgICBmaWVsZDogdGhpcy5sb29rdXBSZWYudGV4dEZpZWxkLCAvL1wiKlwiLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMubG9va3VwUmVmLmRpc3BsYXlUZXh0XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcCA9IHtcclxuICAgICAgICAgICAgICAgIHNlYXJjaDogdGhpcy5sb29rdXBSZWYuX3NlYXJjaFN0YXRlXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIFxyXG4gICAgICAgICAgICB0ID0gJ3NlYXJjaCc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLmxvb2t1cFJlZi5odHRwTWdyLmxvb2t1cFJlcXVlc3QocCwgdCkucGlwZShcclxuICAgICAgICAgICAgbWFwKChyZXN0RGF0YTogTG9va3VwR3JpZFJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc3REYXRhKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3REYXRhLml0ZW1zIHx8IFtdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb2t1cFJlZi5kaXNwbGF5VGV4dCAmJiB0aGlzLmxvb2t1cFJlZi5pc1RleHRDaGFuZ2UpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5sb29rdXBSZWYuaXRlbXMuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gblt0aGlzLmxvb2t1cFJlZi50ZXh0RmllbGRdLmluZGV4T2YodGhpcy5sb29rdXBSZWYuZGlzcGxheVRleHQpID4gLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgfSkuc2xpY2UoMCwgdGhpcy5vcHRpb25zLnNob3dJdGVtc0NvdW50KVxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvb2t1cFJlZi5pdGVtcy5zbGljZSgwLCB0aGlzLm9wdGlvbnMuc2hvd0l0ZW1zQ291bnQpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBsb2FkRGF0YSgpIHtcclxuICAgICAgICBjb25zdCBsb2FkaW5nUmVmID0gdGhpcy5sb29rdXBSZWYubG9hZGluZ1NlcnZpY2Uuc2hvdyh7Y29udGFpbmVyOiB0aGlzLnBhbmVsRWxlbWVudH0pO1xyXG4gICAgICAgIHRoaXMuZ2V0RGF0YSgpLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuY21wUmVmLmluc3RhbmNlLmxvYWREYXRhKGRhdGEpO1xyXG4gICAgICAgICAgICBsb2FkaW5nUmVmLmNsb3NlKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxyXG4gICAgcmVnaXN0ZXJLZXlib2FyZEV2ZW50KCRldmVudDogS2V5Ym9hcmRFdmVudCkge1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMubG9va3VwUmVmLnNpbmdsZVNlbGVjdCkgIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IHJvd3M9IFtdO1xyXG4gICAgICAgIGlmICh0aGlzLmNtcFJlZikge1xyXG4gICAgICAgICAgICByb3dzID0gdGhpcy5jbXBSZWYuaW5zdGFuY2UuZGF0YTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghcm93cyB8fCAhcm93cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCRldmVudC5jb2RlID09PSAnQXJyb3dVcCcgfHwgJGV2ZW50LmNvZGUgPT09ICdBcnJvd0Rvd24nKSB7XHJcbiAgICAgICAgICAgICRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBpZHggPSB0aGlzLmNtcFJlZi5pbnN0YW5jZS5hY3RpdmVJbmRleDtcclxuICAgICAgICBsZXQgYWN0aXZlSW5kZXggPSBpZHg7XHJcblxyXG4gICAgICAgIGNvbnN0IHNlbGVjdEl0ZW0gPSAoaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgYWN0aXZlSW5kZXggPSBpbmRleDtcclxuICAgICAgICAgICAgdGhpcy5jbXBSZWYuaW5zdGFuY2Uuc2V0QWN0aXZlSXRlbShpbmRleCk7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKCRldmVudC5jb2RlID09PSAnQXJyb3dVcCcpIHsgIC8vIHVwXHJcbiAgICAgICAgICAgIGlmIChpZHggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHByZXZJZHggPSBpZHggLSAxO1xyXG4gICAgICAgICAgICAgICAgaWYgKHByZXZJZHggPCAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJldklkeCA9IHJvd3MubGVuZ3RoIC0gMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHNlbGVjdEl0ZW0ocHJldklkeCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RJdGVtKHJvd3MubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCRldmVudC5jb2RlID09PSAnQXJyb3dEb3duJykgeyAvLyBkb3duXHJcbiAgICAgICAgICAgIGxldCBuZXh0SWR4ID0gaWR4ICsgMTtcclxuICAgICAgICAgICAgaWYgKG5leHRJZHggPj0gcm93cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIG5leHRJZHggPSAwO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBzZWxlY3RJdGVtKG5leHRJZHgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYoJGV2ZW50LmtleSA9PT0gJ0VudGVyJykge1xyXG4gICAgICAgICAgICBpZiAocm93cyAmJiByb3dzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJvd3NbaWR4XTtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9va3VwUmVmLnNlbGVjdEl0ZW0oZGF0YSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZGUoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufSJdfQ==