import { Inject, Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import moment from 'moment';
import { UserSettingsToken } from "@farris/devkit";
var LocalizationService = /** @class */ (function () {
    function LocalizationService(injector, userSettings) {
        this.injector = injector;
        this.userSettings = userSettings;
    }
    Object.defineProperty(LocalizationService.prototype, "formats", {
        /**
         * 用户配置格式
         */
        get: function () {
            var _a = this.userSettings || {}, _b = _a.dateFormat, dateFormat = _b === void 0 ? null : _b, _c = _a.timeFormat, timeFormat = _c === void 0 ? null : _c;
            var dateTimeFormat = null;
            if (dateFormat && timeFormat) {
                dateTimeFormat = dateFormat + " " + timeFormat;
            }
            var date = {
                dateFormat: dateFormat,
                timeFormat: timeFormat,
                dateTimeFormat: dateTimeFormat
            };
            var _d = this.numberFormat || {}, _e = _d.negativeSign, negativeSign = _e === void 0 ? null : _e, _f = _d.numberDecimalDigits, numberDecimalDigits = _f === void 0 ? null : _f, _g = _d.numberDecimalSeparator, numberDecimalSeparator = _g === void 0 ? null : _g, _h = _d.numberGroupSeparator, numberGroupSeparator = _h === void 0 ? null : _h;
            var number = {
                negativeSign: negativeSign,
                numberDecimalDigits: numberDecimalDigits,
                numberDecimalSeparator: numberDecimalSeparator,
                numberGroupSeparator: numberGroupSeparator
            };
            return { date: date, number: number };
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 根据数据类型本地化数据
     * @param value value
     * @param dataType 数据类型
     * @returns string
     */
    LocalizationService.prototype.localize = function (value, dataType) {
        if (dataType && value) {
            dataType = dataType.toLowerCase();
            if (dataType === 'date') {
                return this.transformDate(value);
            }
            else if (dataType === 'datetime') {
                return this.transformDateTime(value);
            }
            else if (dataType === 'number') {
                return this.transformNumber(value);
            }
            else {
                return value;
            }
        }
        else {
            return value;
        }
    };
    /**
     * 根据国际化类型获取格式化字符串
     * @param localizationType 国际化类型
     * @returns
     */
    LocalizationService.prototype.getFormat = function (localizationType) {
        if (localizationType) {
            localizationType = localizationType.toLowerCase();
        }
        if (localizationType === 'date') {
            return this.formats.date.dateFormat;
        }
        else if (localizationType === 'datetime') {
            return this.formats.date.dateTimeFormat;
        }
        else {
            return '';
        }
    };
    /**
     * 转换日期
     * @param value value
     */
    LocalizationService.prototype.transformDate = function (value) {
        var dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        if (!dateFormat || !value) {
            return value;
        }
        var date = moment(value);
        var isValid = date.isValid();
        if (!isValid) {
            return value;
        }
        dateFormat = this.parseDateFormat(dateFormat);
        return date.format(dateFormat);
    };
    /**
     * 转换日期时间
     * @param value value
     * todo: 目前无法定义日期时间格式
     */
    LocalizationService.prototype.transformDateTime = function (value) {
        var dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        var timeFormat = this.userSettings && this.userSettings.timeFormat || 'HH:mm:ss';
        if (!dateFormat || !timeFormat) {
            return value;
        }
        var dateTime = moment(value);
        var isValid = dateTime.isValid();
        if (!isValid) {
            return value;
        }
        if (dateFormat) {
            dateFormat = this.parseDateFormat(dateFormat);
        }
        if (timeFormat) {
            timeFormat = this.parseTimeFormat(timeFormat);
        }
        var dateTimeFormat = dateFormat + ' ' + timeFormat;
        return dateTime.format(dateTimeFormat);
    };
    /**
     * 转换数字
     * @param value value
     */
    LocalizationService.prototype.transformNumber = function (value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        var bigNumber = new BigNumber(value);
        // 如果不是数字，不做任何处理
        if (!BigNumber.isBigNumber(bigNumber)) {
            return value;
        }
        var isNegative = bigNumber.isNegative();
        var format = this.buildNumberFormat();
        var _a = this.numberFormat || {}, _b = _a.negativeSign, negativeSign = _b === void 0 ? null : _b, _c = _a.numberDecimalDigits, numberDecimalDigits = _c === void 0 ? null : _c;
        if (isNegative) {
            if (negativeSign !== null) {
                format.prefix = negativeSign;
                return bigNumber.absoluteValue().toFormat(numberDecimalDigits, null, format);
            }
        }
        return bigNumber.toFormat(numberDecimalDigits, null, format);
    };
    /**
     * 转换日期格式规则为moment的format规则
     * @param format format
     */
    LocalizationService.prototype.parseDateFormat = function (format) {
        return format.replace(/y/g, 'Y').replace(/d/g, 'D');
    };
    /**
     * 转换时间格式规则为moment的format规则
     * @param format format
     */
    LocalizationService.prototype.parseTimeFormat = function (format) {
        return format.replace(/M/g, 'm');
    };
    /**
     * 构造bignumber数字格式化选项
     */
    LocalizationService.prototype.buildNumberFormat = function () {
        if (this.numberFormat) {
            var _a = this.numberFormat, _b = _a.numberDecimalSeparator, numberDecimalSeparator = _b === void 0 ? null : _b, _c = _a.numberGroupSeparator, numberGroupSeparator = _c === void 0 ? null : _c;
            var format = {
                groupSize: 3,
            };
            if (numberDecimalSeparator !== null) {
                format.decimalSeparator = numberDecimalSeparator;
            }
            if (numberGroupSeparator !== null) {
                format.groupSeparator = numberGroupSeparator;
            }
            return format;
        }
    };
    Object.defineProperty(LocalizationService.prototype, "numberFormat", {
        get: function () {
            return this.userSettings && this.userSettings.numberFormat || null;
        },
        enumerable: true,
        configurable: true
    });
    LocalizationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    LocalizationService.ctorParameters = function () { return [
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [UserSettingsToken,] }] }
    ]; };
    return LocalizationService;
}());
export { LocalizationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxpemF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbG9jYWxpemF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBOEIsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUvRTtJQUVFLDZCQUFvQixRQUFrQixFQUFxQyxZQUEwQjtRQUFqRixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQXFDLGlCQUFZLEdBQVosWUFBWSxDQUFjO0lBQUksQ0FBQztJQUsxRyxzQkFBVyx3Q0FBTztRQUhsQjs7V0FFRzthQUNIO1lBQ1EsSUFBQSw0QkFBa0UsRUFBaEUsa0JBQWlCLEVBQWpCLHNDQUFpQixFQUFFLGtCQUFpQixFQUFqQixzQ0FBNkMsQ0FBQztZQUN6RSxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUM7WUFDMUIsSUFBSSxVQUFVLElBQUksVUFBVSxFQUFFO2dCQUM1QixjQUFjLEdBQU0sVUFBVSxTQUFJLFVBQVksQ0FBQzthQUNoRDtZQUNELElBQU0sSUFBSSxHQUFHO2dCQUNYLFVBQVUsWUFBQTtnQkFDVixVQUFVLFlBQUE7Z0JBQ1YsY0FBYyxnQkFBQTthQUNmLENBQUM7WUFDSSxJQUFBLDRCQUF5SSxFQUF2SSxvQkFBbUIsRUFBbkIsd0NBQW1CLEVBQUUsMkJBQTBCLEVBQTFCLCtDQUEwQixFQUFFLDhCQUE2QixFQUE3QixrREFBNkIsRUFBRSw0QkFBMkIsRUFBM0IsZ0RBQXVELENBQUM7WUFDaEosSUFBTSxNQUFNLEdBQUc7Z0JBQ2IsWUFBWSxjQUFBO2dCQUNaLG1CQUFtQixx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Y3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdiaWdudW1iZXIuanMnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHsgTnVtYmVyRm9ybWF0LCBVc2VyU2V0dGluZ3MsIFVzZXJTZXR0aW5nc1Rva2VuIH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBMb2NhbGl6YXRpb25TZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIEBJbmplY3QoVXNlclNldHRpbmdzVG9rZW4pIHByaXZhdGUgdXNlclNldHRpbmdzOiBVc2VyU2V0dGluZ3MpIHsgfVxuXG4gIC8qKlxuICAgKiDnlKjmiLfphY3nva7moLzlvI9cbiAgICovXG4gIHB1YmxpYyBnZXQgZm9ybWF0cygpOiB7IGRhdGU6IHsgZGF0ZUZvcm1hdDogc3RyaW5nLCB0aW1lRm9ybWF0OiBzdHJpbmcsIGRhdGVUaW1lRm9ybWF0OiBzdHJpbmcgfSwgbnVtYmVyOiB7IG5lZ2F0aXZlU2lnbjogc3RyaW5nLCBudW1iZXJEZWNpbWFsRGlnaXRzOiBudW1iZXIsIG51bWJlckRlY2ltYWxTZXBhcmF0b3I6IHN0cmluZywgbnVtYmVyR3JvdXBTZXBhcmF0b3I6IHN0cmluZyB9LCBbcHJvcDogc3RyaW5nXTogYW55IH0ge1xuICAgIGNvbnN0IHsgZGF0ZUZvcm1hdCA9IG51bGwsIHRpbWVGb3JtYXQgPSBudWxsIH0gPSB0aGlzLnVzZXJTZXR0aW5ncyB8fCB7fTtcbiAgICBsZXQgZGF0ZVRpbWVGb3JtYXQgPSBudWxsO1xuICAgIGlmIChkYXRlRm9ybWF0ICYmIHRpbWVGb3JtYXQpIHtcbiAgICAgIGRhdGVUaW1lRm9ybWF0ID0gYCR7ZGF0ZUZvcm1hdH0gJHt0aW1lRm9ybWF0fWA7XG4gICAgfVxuICAgIGNvbnN0IGRhdGUgPSB7XG4gICAgICBkYXRlRm9ybWF0LFxuICAgICAgdGltZUZvcm1hdCxcbiAgICAgIGRhdGVUaW1lRm9ybWF0XG4gICAgfTtcbiAgICBjb25zdCB7IG5lZ2F0aXZlU2lnbiA9IG51bGwsIG51bWJlckRlY2ltYWxEaWdpdHMgPSBudWxsLCBudW1iZXJEZWNpbWFsU2VwYXJhdG9yID0gbnVsbCwgbnVtYmVyR3JvdXBTZXBhcmF0b3IgPSBudWxsIH0gPSB0aGlzLm51bWJlckZvcm1hdCB8fCB7fTtcbiAgICBjb25zdCBudW1iZXIgPSB7XG4gICAgICBuZWdhdGl2ZVNpZ24sXG4gICAgICBudW1iZXJEZWNpbWFsRGlnaXRzLFxuICAgICAgbnVtYmVyRGVjaW1hbFNlcGFyYXRvcixcbiAgICAgIG51bWJlckdyb3VwU2VwYXJhdG9yXG4gICAgfTtcbiAgICByZXR1cm4geyBkYXRlLCBudW1iZXIgfTtcbiAgfVxuICAvKipcbiAgICog5qC55o2u5pWw5o2u57G75Z6L5pys5Zyw5YyW5pWw5o2uXG4gICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxuICAgKiBAcGFyYW0gZGF0YVR5cGUg5pWw5o2u57G75Z6LXG4gICAqIEByZXR1cm5zIHN0cmluZ1xuICAgKi9cbiAgcHVibGljIGxvY2FsaXplKHZhbHVlOiBhbnksIGRhdGFUeXBlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChkYXRhVHlwZSAmJiB2YWx1ZSkge1xuICAgICAgZGF0YVR5cGUgPSBkYXRhVHlwZS50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKGRhdGFUeXBlID09PSAnZGF0ZScpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMudHJhbnNmb3JtRGF0ZSh2YWx1ZSk7XG4gICAgICB9IGVsc2UgaWYgKGRhdGFUeXBlID09PSAnZGF0ZXRpbWUnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybURhdGVUaW1lKHZhbHVlKTtcbiAgICAgIH0gZWxzZSBpZiAoZGF0YVR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybU51bWJlcih2YWx1ZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOagueaNruWbvemZheWMluexu+Wei+iOt+WPluagvOW8j+WMluWtl+espuS4slxuICAgKiBAcGFyYW0gbG9jYWxpemF0aW9uVHlwZSDlm73pmYXljJbnsbvlnotcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0Rm9ybWF0KGxvY2FsaXphdGlvblR5cGU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKGxvY2FsaXphdGlvblR5cGUpIHtcbiAgICAgIGxvY2FsaXphdGlvblR5cGUgPSBsb2NhbGl6YXRpb25UeXBlLnRvTG93ZXJDYXNlKCk7XG4gICAgfVxuICAgIGlmIChsb2NhbGl6YXRpb25UeXBlID09PSAnZGF0ZScpIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdHMuZGF0ZS5kYXRlRm9ybWF0O1xuICAgIH0gZWxzZSBpZiAobG9jYWxpemF0aW9uVHlwZSA9PT0gJ2RhdGV0aW1lJykge1xuICAgICAgcmV0dXJuIHRoaXMuZm9ybWF0cy5kYXRlLmRhdGVUaW1lRm9ybWF0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDovazmjaLml6XmnJ9cbiAgICogQHBhcmFtIHZhbHVlIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIHRyYW5zZm9ybURhdGUodmFsdWU6IGFueSkge1xuICAgIGxldCBkYXRlRm9ybWF0ID0gdGhpcy51c2VyU2V0dGluZ3MgJiYgdGhpcy51c2VyU2V0dGluZ3MuZGF0ZUZvcm1hdCB8fCAnWVlZWS1NTS1ERCc7XG4gICAgaWYgKCFkYXRlRm9ybWF0IHx8ICF2YWx1ZSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBjb25zdCBkYXRlID0gbW9tZW50KHZhbHVlKTtcbiAgICBjb25zdCBpc1ZhbGlkID0gZGF0ZS5pc1ZhbGlkKCk7XG4gICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGRhdGVGb3JtYXQgPSB0aGlzLnBhcnNlRGF0ZUZvcm1hdChkYXRlRm9ybWF0KTtcbiAgICByZXR1cm4gZGF0ZS5mb3JtYXQoZGF0ZUZvcm1hdCk7XG4gIH1cbiAgLyoqXG4gICAqIOi9rOaNouaXpeacn+aXtumXtFxuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcbiAgICogdG9kbzog55uu5YmN5peg5rOV5a6a5LmJ5pel5pyf5pe26Ze05qC85byPXG4gICAqL1xuICBwcml2YXRlIHRyYW5zZm9ybURhdGVUaW1lKHZhbHVlOiBhbnkpIHtcbiAgICBsZXQgZGF0ZUZvcm1hdCA9IHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLmRhdGVGb3JtYXQgfHwgJ1lZWVktTU0tREQnO1xuICAgIGxldCB0aW1lRm9ybWF0ID0gdGhpcy51c2VyU2V0dGluZ3MgJiYgdGhpcy51c2VyU2V0dGluZ3MudGltZUZvcm1hdCB8fCAnSEg6bW06c3MnO1xuICAgIGlmICghZGF0ZUZvcm1hdCB8fCAhdGltZUZvcm1hdCkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBjb25zdCBkYXRlVGltZSA9IG1vbWVudCh2YWx1ZSk7XG4gICAgY29uc3QgaXNWYWxpZCA9IGRhdGVUaW1lLmlzVmFsaWQoKTtcbiAgICBpZiAoIWlzVmFsaWQpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgaWYgKGRhdGVGb3JtYXQpIHtcbiAgICAgIGRhdGVGb3JtYXQgPSB0aGlzLnBhcnNlRGF0ZUZvcm1hdChkYXRlRm9ybWF0KTtcbiAgICB9XG4gICAgaWYgKHRpbWVGb3JtYXQpIHtcbiAgICAgIHRpbWVGb3JtYXQgPSB0aGlzLnBhcnNlVGltZUZvcm1hdCh0aW1lRm9ybWF0KTtcbiAgICB9XG4gICAgY29uc3QgZGF0ZVRpbWVGb3JtYXQgPSBkYXRlRm9ybWF0ICsgJyAnICsgdGltZUZvcm1hdDtcbiAgICByZXR1cm4gZGF0ZVRpbWUuZm9ybWF0KGRhdGVUaW1lRm9ybWF0KTtcbiAgfVxuICAvKipcbiAgICog6L2s5o2i5pWw5a2XXG4gICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSB0cmFuc2Zvcm1OdW1iZXIodmFsdWUpOiBzdHJpbmcge1xuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSAnJykge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgICBjb25zdCBiaWdOdW1iZXIgPSBuZXcgQmlnTnVtYmVyKHZhbHVlKTtcbiAgICAvLyDlpoLmnpzkuI3mmK/mlbDlrZfvvIzkuI3lgZrku7vkvZXlpITnkIZcbiAgICBpZiAoIUJpZ051bWJlci5pc0JpZ051bWJlcihiaWdOdW1iZXIpKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGNvbnN0IGlzTmVnYXRpdmUgPSBiaWdOdW1iZXIuaXNOZWdhdGl2ZSgpO1xuICAgIGNvbnN0IGZvcm1hdCA9IHRoaXMuYnVpbGROdW1iZXJGb3JtYXQoKTtcbiAgICBjb25zdCB7IG5lZ2F0aXZlU2lnbiA9IG51bGwsIG51bWJlckRlY2ltYWxEaWdpdHMgPSBudWxsIH0gPSB0aGlzLm51bWJlckZvcm1hdCB8fCB7fTtcbiAgICBpZiAoaXNOZWdhdGl2ZSkge1xuICAgICAgaWYgKG5lZ2F0aXZlU2lnbiAhPT0gbnVsbCkge1xuICAgICAgICBmb3JtYXQucHJlZml4ID0gbmVnYXRpdmVTaWduO1xuICAgICAgICByZXR1cm4gYmlnTnVtYmVyLmFic29sdXRlVmFsdWUoKS50b0Zvcm1hdChudW1iZXJEZWNpbWFsRGlnaXRzLCBudWxsLCBmb3JtYXQpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gYmlnTnVtYmVyLnRvRm9ybWF0KG51bWJlckRlY2ltYWxEaWdpdHMsIG51bGwsIGZvcm1hdCk7XG4gIH1cbiAgLyoqXG4gICAqIOi9rOaNouaXpeacn+agvOW8j+inhOWImeS4um1vbWVudOeahGZvcm1hdOinhOWImVxuICAgKiBAcGFyYW0gZm9ybWF0IGZvcm1hdFxuICAgKi9cbiAgcHJpdmF0ZSBwYXJzZURhdGVGb3JtYXQoZm9ybWF0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZm9ybWF0LnJlcGxhY2UoL3kvZywgJ1knKS5yZXBsYWNlKC9kL2csICdEJyk7XG4gIH1cbiAgLyoqXG4gICAqIOi9rOaNouaXtumXtOagvOW8j+inhOWImeS4um1vbWVudOeahGZvcm1hdOinhOWImVxuICAgKiBAcGFyYW0gZm9ybWF0IGZvcm1hdFxuICAgKi9cbiAgcHJpdmF0ZSBwYXJzZVRpbWVGb3JtYXQoZm9ybWF0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZm9ybWF0LnJlcGxhY2UoL00vZywgJ20nKTtcbiAgfVxuICAvKipcbiAgICog5p6E6YCgYmlnbnVtYmVy5pWw5a2X5qC85byP5YyW6YCJ6aG5XG4gICAqL1xuICBwcml2YXRlIGJ1aWxkTnVtYmVyRm9ybWF0KCkge1xuICAgIGlmICh0aGlzLm51bWJlckZvcm1hdCkge1xuICAgICAgY29uc3QgeyBudW1iZXJEZWNpbWFsU2VwYXJhdG9yID0gbnVsbCwgbnVtYmVyR3JvdXBTZXBhcmF0b3IgPSBudWxsIH0gPSB0aGlzLm51bWJlckZvcm1hdDtcbiAgICAgIGNvbnN0IGZvcm1hdDogYW55ID0ge1xuICAgICAgICBncm91cFNpemU6IDMsXG4gICAgICB9O1xuICAgICAgaWYgKG51bWJlckRlY2ltYWxTZXBhcmF0b3IgIT09IG51bGwpIHtcbiAgICAgICAgZm9ybWF0LmRlY2ltYWxTZXBhcmF0b3IgPSBudW1iZXJEZWNpbWFsU2VwYXJhdG9yO1xuICAgICAgfVxuICAgICAgaWYgKG51bWJlckdyb3VwU2VwYXJhdG9yICE9PSBudWxsKSB7XG4gICAgICAgIGZvcm1hdC5ncm91cFNlcGFyYXRvciA9IG51bWJlckdyb3VwU2VwYXJhdG9yO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZvcm1hdDtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBnZXQgbnVtYmVyRm9ybWF0KCk6IE51bWJlckZvcm1hdCB7XG4gICAgcmV0dXJuIHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLm51bWJlckZvcm1hdCB8fCBudWxsO1xuICB9XG59Il19