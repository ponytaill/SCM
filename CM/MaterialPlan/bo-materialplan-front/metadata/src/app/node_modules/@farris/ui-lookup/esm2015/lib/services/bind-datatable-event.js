/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { FavoriteAction, FAVORITE_FIELD_NAME } from '../lookup-displaytype';
export class DataTableEventManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        this._sortState = null;
        this.lookupSelectionSer = this.ins.lookupSelectionSer;
    }
    /**
     * @param {?=} $event
     * @return {?}
     */
    onSearch($event = { field: '*', value: '' }) {
        if ($event && $event.field !== '*' && !$event.value) {
            this.ins.messagerService.warning(this.ins.mustWriteSomething);
            return;
        }
        /** @type {?} */
        const p = {
            pageInfo: { pageIndex: 1, pageSize: this.ins.gridOptions.pageSize },
            search: $event
        };
        if (this._sortState) {
            const { sortName, sortOrder } = this._sortState;
            if (sortName) {
                p['sortName'] = sortName;
                p['sortOrder'] = sortOrder;
            }
        }
        if (this.ins.uri) {
            if (!this.ins.searching) {
                this.ins.searching = true;
                if (this.ins['navNodePathCode']) {
                    p['navNodePathCode'] = this.ins['navNodePathCode'];
                }
                this.ins.httpMgr.getData(p, 'list').pipe(catchError((/**
                 * @param {?} err
                 * @return {?}
                 */
                err => {
                    this.ins.searching = false;
                    return of({ "_ERROR_": err });
                })), tap((/**
                 * @return {?}
                 */
                () => {
                    this.ins.searching = false;
                }))).subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                data => {
                    this.ins.searching = false;
                    this.ins.closeLoading();
                    if (!data['_ERROR_']) {
                        this._loadData(data);
                    }
                    else {
                        throw new Error(data['_ERROR_']);
                    }
                }));
            }
        }
        else {
            this.ins.search.emit(p);
        }
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    _loadData(data) {
        /** @type {?} */
        const self = this.ins;
        self.closeLoading();
        self.favHelper.updateFavoritesStatus(data.items);
        self.loadDataTableData(data);
        // 选中数据
        this.ins.selectionMgr.selectCurrentValue();
    }
    /**
     * @return {?}
     */
    bindDataTableEvent() {
        /** @type {?} */
        const self = this.ins;
        /** @type {?} */
        const dt = (/** @type {?} */ (self.componentRef.instance));
        dt.selectedRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.ins.singleSelect) {
                this.lookupSelectionSer.clearSelections();
            }
            this.ins.checkedChange.emit({ data: [e.data], isCheck: true });
            this.lookupSelectionSer.updateSelections([e.data]);
            dt.cd.detectChanges();
        }));
        dt.unSelectRow.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            this.lookupSelectionSer.unSelect(e.data[self.idField]);
            this.ins.checkedChange.emit({ data: [e.data], isCheck: false });
        }));
        dt.checkAll.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.lookupSelectionSer.updateSelections(dt.data, e);
            this.ins.checkedChange.emit({ data: dt.data, isCheck: e });
        }));
        dt.pageChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                (data) => {
                    this._loadData(data);
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.pageSizeChanged.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        e => {
            if (self.uri) {
                self.httpMgr.getData(e, 'list').subscribe((/**
                 * @param {?} data
                 * @return {?}
                 */
                data => {
                    this._loadData(data);
                }), (/**
                 * @param {?} err
                 * @return {?}
                 */
                err => {
                    self.closeLoading();
                }));
            }
            else {
                self.pagerChanged.emit(self.httpMgr.buildQueryParams(e, 'list'));
            }
        }));
        dt.search.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            // if (JSON.stringify(self._searchState || {}) !== JSON.stringify(e || {})) {
            //     this.ins.searching = false;
            // }
            self._searchState = Object.assign({}, (e || {}));
            this.onSearch(e);
        }));
        dt.searchValueChange.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (e && e.value) {
                self._searchState = Object.assign({}, e);
            }
            else {
                self._searchState = null;
            }
        }));
        // 双击事件
        dt.rowDblClick.subscribe((/**
         * @param {?} rowData
         * @return {?}
         */
        (rowData) => {
            if (self.gridOptions.singleSelect) {
                // this.lookupSelectionSer.updateSelections([rowData]);
                self.selectItem(rowData);
            }
        }));
        // 收藏事件
        dt.cellClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (e.col.field === FAVORITE_FIELD_NAME) {
                /** @type {?} */
                const classList = e.event.target['classList'];
                if (classList.contains('f-lookup-favorite')) {
                    e.event.stopPropagation();
                    self.items.forEach((/**
                     * @param {?} item
                     * @return {?}
                     */
                    item => {
                        /** @type {?} */
                        const id = self.utils.getValue(self.idField, item);
                        if (id === self.utils.getValue(self.idField, e.row)) {
                            item[FAVORITE_FIELD_NAME] = !item[FAVORITE_FIELD_NAME];
                        }
                    }));
                    dt.loadData({
                        pageSize: self.gridOptions.pageSize,
                        pageIndex: self.gridOptions.pageIndex,
                        total: self.gridOptions.total,
                        data: self.gridOptions.items
                    });
                    // 更新收藏数据
                    /** @type {?} */
                    const faction = e.row[FAVORITE_FIELD_NAME] ? FavoriteAction.add : FavoriteAction.delete;
                    if (faction === FavoriteAction.add) {
                        this.ins.favoriteItems = [...this.ins.favoriteItems, e.row];
                    }
                    else {
                        this.ins.favoriteItems = this.ins.favoriteItems.filter((/**
                         * @param {?} n
                         * @return {?}
                         */
                        n => {
                            return self.utils.getValue(self.idField, n) !== self.utils.getValue(self.idField, e.row);
                        }));
                    }
                    this.lookupSelectionSer.updateFavoriteData(e.row, faction);
                }
            }
        }));
        dt.columnSorted.subscribe((/**
         * @param {?} sort
         * @return {?}
         */
        (sort) => {
            this._sortState = sort;
            if (!this.ins.remoteSort) {
                return;
            }
            const { sortName, sortOrder } = Object.assign({}, sort);
            /** @type {?} */
            const col = this.ins.columns.find((/**
             * @param {?} n
             * @return {?}
             */
            n => n.field === sortName));
            /** @type {?} */
            const _sortName = col ? col.fieldPath ? col.fieldPath : col.field : sortName;
            /** @type {?} */
            const param = {
                sortName: _sortName,
                sortOrder,
                search: self._searchState,
                pageInfo: {
                    pageSize: self.pageSize,
                    pageIndex: 1
                }
            };
            self.httpMgr.getData(param, 'search').subscribe((/**
             * @param {?} d
             * @return {?}
             */
            d => {
                self.loadDataTableData(d);
                self.closeLoading();
            }));
        }));
        dt.clearSearchValue.subscribe((/**
         * @return {?}
         */
        () => {
            self._searchState = null;
            this.onSearch();
        }));
        dt.cellStyler = (/**
         * @param {?} val
         * @return {?}
         */
        (val) => {
            const { field } = val;
            if (field === FAVORITE_FIELD_NAME) {
                return {
                    'text-overflow': 'unset'
                };
            }
            return null;
        });
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.lookupSelectionSer;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype._sortState;
    /**
     * @type {?}
     * @private
     */
    DataTableEventManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZC1kYXRhdGFibGUtZXZlbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9iaW5kLWRhdGF0YWJsZS1ldmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUUsVUFBVSxFQUFRLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxjQUFjLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUs1RSxNQUFNLE9BQU8scUJBQXFCOzs7O0lBTTlCLFlBQW9CLEdBQXdCO1FBQXhCLFFBQUcsR0FBSCxHQUFHLENBQXFCO1FBRnBDLGVBQVUsR0FBRyxJQUFJLENBQUM7UUFHdEIsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7SUFDMUQsQ0FBQzs7Ozs7SUFFRCxRQUFRLENBQUMsU0FBMkMsRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUU7UUFDekUsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLEtBQUssS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFO1lBQ2pELElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDOUQsT0FBTztTQUNWOztjQUVLLENBQUMsR0FBRztZQUNOLFFBQVEsRUFBRSxFQUFFLFNBQVMsRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLFFBQVEsRUFBRTtZQUNuRSxNQUFNLEVBQUUsTUFBTTtTQUNqQjtRQUVELElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtrQkFDWCxFQUFDLFFB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QUFDLEVBQUMsQ0FBQztRQUVILEVBQUUsQ0FBQyxVQUFVOzs7O1FBQUcsQ0FBQyxHQUFRLEVBQUUsRUFBRTtrQkFDbkIsRUFBRSxLQUFLLEVBQUUsR0FBRyxHQUFHO1lBQ3JCLElBQUksS0FBSyxLQUFLLG1CQUFtQixFQUFFO2dCQUMvQixPQUFPO29CQUNILGVBQWUsRUFBRSxPQUFPO2lCQUMzQixDQUFDO2FBQ0w7WUFFRCxPQUFPLElBQUksQ0FBQztRQUNoQixDQUFDLENBQUEsQ0FBQTtJQUNMLENBQUM7Q0FDSjs7Ozs7O0lBOU5HLG1EQUFtRDs7Ozs7SUFFbkQsMkNBQTBCOzs7OztJQUVkLG9DQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERhdGFUYWJsZUNvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YXRhYmxlJztcclxuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY2F0Y2hFcnJvciwgdGFrZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBGYXZvcml0ZUFjdGlvbiwgRkFWT1JJVEVfRklFTERfTkFNRSB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRSZXN1bHQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvb2t1cFNlbGVjdGlvblNlcnZpY2UgfSBmcm9tICcuL2xvb2t1cC1zZWxlY3Rpb24uc2VydmljZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YVRhYmxlRXZlbnRNYW5hZ2VyIHtcclxuXHJcbiAgICBwcml2YXRlIGxvb2t1cFNlbGVjdGlvblNlcjogTG9va3VwU2VsZWN0aW9uU2VydmljZTtcclxuXHJcbiAgICBwcml2YXRlIF9zb3J0U3RhdGUgPSBudWxsO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIgPSB0aGlzLmlucy5sb29rdXBTZWxlY3Rpb25TZXI7XHJcbiAgICB9XHJcblxyXG4gICAgb25TZWFyY2goJGV2ZW50OiB7IGZpZWxkOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfSA9IHsgZmllbGQ6ICcqJywgdmFsdWU6ICcnIH0pIHtcclxuICAgICAgICBpZiAoJGV2ZW50ICYmICRldmVudC5maWVsZCAhPT0gJyonICYmICEkZXZlbnQudmFsdWUpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnMubWVzc2FnZXJTZXJ2aWNlLndhcm5pbmcodGhpcy5pbnMubXVzdFdyaXRlU29tZXRoaW5nKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcCA9IHtcclxuICAgICAgICAgICAgcGFnZUluZm86IHsgcGFnZUluZGV4OiAxLCBwYWdlU2l6ZTogdGhpcy5pbnMuZ3JpZE9wdGlvbnMucGFnZVNpemUgfSxcclxuICAgICAgICAgICAgc2VhcmNoOiAkZXZlbnRcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBpZiAodGhpcy5fc29ydFN0YXRlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHtzb3J0TmFtZSwgc29ydE9yZGVyfSA9IHRoaXMuX3NvcnRTdGF0ZTtcclxuICAgICAgICAgICAgaWYgKHNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBwWydzb3J0TmFtZSddID0gc29ydE5hbWU7XHJcbiAgICAgICAgICAgICAgICBwWydzb3J0T3JkZXInXSA9IHNvcnRPcmRlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnVyaSkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuaW5zLnNlYXJjaGluZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcFsnbmF2Tm9kZVBhdGhDb2RlJ10gPSB0aGlzLmluc1snbmF2Tm9kZVBhdGhDb2RlJ107XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnMuaHR0cE1nci5nZXREYXRhKHAsICdsaXN0JykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBjYXRjaEVycm9yKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YoeyBcIl9FUlJPUl9cIjogZXJyIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNlYXJjaGluZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICApLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICAgICBkYXRhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuc2VhcmNoaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWRhdGFbJ19FUlJPUl8nXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbG9hZERhdGEoZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZGF0YVsnX0VSUk9SXyddKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmlucy5zZWFyY2guZW1pdChwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfbG9hZERhdGEoZGF0YTogTG9va3VwR3JpZFJlc3VsdCkge1xyXG4gICAgICAgIGNvbnN0IHNlbGYgPSB0aGlzLmlucztcclxuICAgICAgICBzZWxmLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgIHNlbGYuZmF2SGVscGVyLnVwZGF0ZUZhdm9yaXRlc1N0YXR1cyhkYXRhLml0ZW1zKTtcclxuICAgICAgICBzZWxmLmxvYWREYXRhVGFibGVEYXRhKGRhdGEpO1xyXG4gICAgICAgIC8vIOmAieS4reaVsOaNrlxyXG4gICAgICAgIHRoaXMuaW5zLnNlbGVjdGlvbk1nci5zZWxlY3RDdXJyZW50VmFsdWUoKTtcclxuICAgIH1cclxuXHJcbiAgICBiaW5kRGF0YVRhYmxlRXZlbnQoKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXMuaW5zO1xyXG4gICAgICAgIGNvbnN0IGR0ID0gc2VsZi5jb21wb25lbnRSZWYuaW5zdGFuY2UgYXMgRGF0YVRhYmxlQ29tcG9uZW50O1xyXG5cclxuICAgICAgICBkdC5zZWxlY3RlZFJvdy5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci5jbGVhclNlbGVjdGlvbnMoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmlucy5jaGVja2VkQ2hhbmdlLmVtaXQoeyBkYXRhOiBbZS5kYXRhXSwgaXNDaGVjazogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBTZWxlY3Rpb25TZXIudXBkYXRlU2VsZWN0aW9ucyhbZS5kYXRhXSk7XHJcbiAgICAgICAgICAgIGR0LmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQudW5TZWxlY3RSb3cuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51blNlbGVjdChlLmRhdGFbc2VsZi5pZEZpZWxkXSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNoZWNrZWRDaGFuZ2UuZW1pdCh7IGRhdGE6IFtlLmRhdGFdLCBpc0NoZWNrOiBmYWxzZSB9KTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuY2hlY2tBbGwuc3Vic2NyaWJlKChlOiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoZHQuZGF0YSwgZSk7XHJcbiAgICAgICAgICAgIHRoaXMuaW5zLmNoZWNrZWRDaGFuZ2UuZW1pdCh7IGRhdGE6IGR0LmRhdGEsIGlzQ2hlY2s6IGUgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LnBhZ2VDaGFuZ2VkLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChzZWxmLnVyaSkge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEoZSwgJ2xpc3QnKS5zdWJzY3JpYmUoKGRhdGE6IExvb2t1cEdyaWRSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc2VsZi5wYWdlckNoYW5nZWQuZW1pdChzZWxmLmh0dHBNZ3IuYnVpbGRRdWVyeVBhcmFtcyhlLCAnbGlzdCcpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5wYWdlU2l6ZUNoYW5nZWQuc3Vic2NyaWJlKGUgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VsZi51cmkpIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuaHR0cE1nci5nZXREYXRhKGUsICdsaXN0Jykuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgIGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGYucGFnZXJDaGFuZ2VkLmVtaXQoc2VsZi5odHRwTWdyLmJ1aWxkUXVlcnlQYXJhbXMoZSwgJ2xpc3QnKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZHQuc2VhcmNoLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGlmIChKU09OLnN0cmluZ2lmeShzZWxmLl9zZWFyY2hTdGF0ZSB8fCB7fSkgIT09IEpTT04uc3RyaW5naWZ5KGUgfHwge30pKSB7XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLmlucy5zZWFyY2hpbmcgPSBmYWxzZTtcclxuICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICBzZWxmLl9zZWFyY2hTdGF0ZSA9IHsuLi4oZSB8fCB7fSl9O1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKGUpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBkdC5zZWFyY2hWYWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoZSAmJiBlLnZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLl9zZWFyY2hTdGF0ZSA9IHsuLi5lfTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGYuX3NlYXJjaFN0YXRlID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDlj4zlh7vkuovku7ZcclxuICAgICAgICBkdC5yb3dEYmxDbGljay5zdWJzY3JpYmUoKHJvd0RhdGE6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoc2VsZi5ncmlkT3B0aW9ucy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgIC8vIHRoaXMubG9va3VwU2VsZWN0aW9uU2VyLnVwZGF0ZVNlbGVjdGlvbnMoW3Jvd0RhdGFdKTtcclxuICAgICAgICAgICAgICAgIHNlbGYuc2VsZWN0SXRlbShyb3dEYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyDmlLbol4/kuovku7ZcclxuICAgICAgICBkdC5jZWxsQ2xpY2suc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKGUuY29sLmZpZWxkID09PSBGQVZPUklURV9GSUVMRF9OQU1FKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjbGFzc0xpc3QgPSBlLmV2ZW50LnRhcmdldFsnY2xhc3NMaXN0J107XHJcbiAgICAgICAgICAgICAgICBpZiAoY2xhc3NMaXN0LmNvbnRhaW5zKCdmLWxvb2t1cC1mYXZvcml0ZScpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZS5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICBzZWxmLml0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkID0gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIGl0ZW0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaWQgPT09IHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBlLnJvdykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1bRkFWT1JJVEVfRklFTERfTkFNRV0gPSAhaXRlbVtGQVZPUklURV9GSUVMRF9OQU1FXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGR0LmxvYWREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcGFnZVNpemU6IHNlbGYuZ3JpZE9wdGlvbnMucGFnZVNpemUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogc2VsZi5ncmlkT3B0aW9ucy5wYWdlSW5kZXgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRvdGFsOiBzZWxmLmdyaWRPcHRpb25zLnRvdGFsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhOiBzZWxmLmdyaWRPcHRpb25zLml0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOabtOaWsOaUtuiXj+aVsOaNrlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZhY3Rpb24gPSBlLnJvd1tGQVZPUklURV9GSUVMRF9OQU1FXSA/IEZhdm9yaXRlQWN0aW9uLmFkZCA6IEZhdm9yaXRlQWN0aW9uLmRlbGV0ZTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZhY3Rpb24gPT09ICBGYXZvcml0ZUFjdGlvbi5hZGQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVJdGVtcyA9IFsuLi50aGlzLmlucy5mYXZvcml0ZUl0ZW1zLCBlLnJvd107XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZmF2b3JpdGVJdGVtcyA9IHRoaXMuaW5zLmZhdm9yaXRlSXRlbXMuZmlsdGVyKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYudXRpbHMuZ2V0VmFsdWUoc2VsZi5pZEZpZWxkLCBuKSAhPT0gc2VsZi51dGlscy5nZXRWYWx1ZShzZWxmLmlkRmllbGQsIGUucm93KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvb2t1cFNlbGVjdGlvblNlci51cGRhdGVGYXZvcml0ZURhdGEoZS5yb3csIGZhY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LmNvbHVtblNvcnRlZC5zdWJzY3JpYmUoKHNvcnQ6IHsgc29ydE5hbWU6IHN0cmluZzsgc29ydE9yZGVyOiBhbnkgfSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgdGhpcy5fc29ydFN0YXRlID0gc29ydDtcclxuXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pbnMucmVtb3RlU29ydCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCB7IHNvcnROYW1lLCBzb3J0T3JkZXIgfSA9IHsgLi4uc29ydCB9O1xyXG5cclxuICAgICAgICAgICAgY29uc3QgY29sID0gdGhpcy5pbnMuY29sdW1ucy5maW5kKG4gPT4gbi5maWVsZCA9PT0gc29ydE5hbWUpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgX3NvcnROYW1lID0gY29sID8gY29sLmZpZWxkUGF0aCA/IGNvbC5maWVsZFBhdGggOiBjb2wuZmllbGQgOiBzb3J0TmFtZTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmFtID0ge1xyXG4gICAgICAgICAgICAgICAgc29ydE5hbWU6IF9zb3J0TmFtZSxcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcixcclxuICAgICAgICAgICAgICAgIHNlYXJjaDogc2VsZi5fc2VhcmNoU3RhdGUsXHJcbiAgICAgICAgICAgICAgICBwYWdlSW5mbzoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VTaXplOiBzZWxmLnBhZ2VTaXplLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogMVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgc2VsZi5odHRwTWdyLmdldERhdGEocGFyYW0sICdzZWFyY2gnKS5zdWJzY3JpYmUoZCA9PiB7XHJcbiAgICAgICAgICAgICAgICBzZWxmLmxvYWREYXRhVGFibGVEYXRhKGQpO1xyXG4gICAgICAgICAgICAgICAgc2VsZi5jbG9zZUxvYWRpbmcoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LmNsZWFyU2VhcmNoVmFsdWUuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgc2VsZi5fc2VhcmNoU3RhdGUgPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLm9uU2VhcmNoKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGR0LmNlbGxTdHlsZXIgPSAodmFsOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgeyBmaWVsZCB9ID0gdmFsO1xyXG4gICAgICAgICAgICBpZiAoZmllbGQgPT09IEZBVk9SSVRFX0ZJRUxEX05BTUUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgJ3RleHQtb3ZlcmZsb3cnOiAndW5zZXQnXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==