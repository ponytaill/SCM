import { Injectable, Injector } from "@angular/core";
import { EMPTY, of } from "rxjs";
import { switchMap, tap } from "rxjs/operators";
import { FrameContext, DataPathCreator, Repository } from "@farris/devkit";
import { LanguageService } from "./languag.service";
import { FormMessageService } from "./form-message.service";
var PopUpService = /** @class */ (function () {
    function PopUpService(injector, frameContext, repository, languageService, messageService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.repository = repository;
        this.languageService = languageService;
        this.messageService = messageService;
    }
    PopUpService.prototype.confirm = function () { };
    /**
     * 取消变更
     * @param frameId
     * @param id
     * @returns
     */
    PopUpService.prototype.cancel = function (frameId, id) {
        var frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
        if (!frameContext) {
            throw new Error("[PopUpService]Invalid frameId " + frameId);
        }
        var primaryValue = this.frameContext.bindingData.list.currentId;
        var bindingPath = frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        if (!id) {
            var bindingList = this.frameContext.bindingData.getList();
            id = bindingList.currentId;
        }
        var befRepository = this.repository;
        var longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map(function (path) { return path.split(':')[1]; });
        var entityListPaths = Array.from(longPaths);
        //舍弃当前表当前行
        entityListPaths.pop();
        var dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityListPaths.length < 1) {
            // 主表
            var entity = this.repository.entityCollection.getEntityById(id);
            var originalData = entity['originalData'];
            entity.load(originalData, { loadChild: false });
        }
        else {
            var entityList_1 = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
            if (entityList_1) {
                var originalData = entityList_1['originalData'];
                var item_1 = originalData.find(function (item) { return item.id === id; });
                if (item_1) {
                    // 已有数据，还原变更
                    var entity_1 = befRepository.entityManager.getEntityByPath(longPaths);
                    if (entity_1.changes && entity_1.changes.length > 0) {
                        return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(tap(function (result) {
                            if (result) {
                                entity_1.load(item_1, { loadChild: false });
                                entity_1.changes.splice(0, entity_1.changes.length);
                            }
                        }));
                    }
                    else {
                        // 没有修改，直接关闭
                        if (dialogRef) {
                            dialogRef.close();
                        }
                    }
                }
                else {
                    // 新增的数据，删除
                    var paths_1 = this.buildPath(bindingPath, primaryValue);
                    return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(switchMap(function (result) {
                        if (result) {
                            return befRepository.removeEntityByPath(paths_1, id).pipe(tap(function () {
                                befRepository.entityManager.removeEntityByPath(paths_1, id);
                                if (entityList_1.count() === 0 && dialogRef) {
                                    dialogRef.close();
                                }
                            }));
                        }
                        else {
                            return EMPTY;
                        }
                    }));
                }
            }
        }
        return of([]);
    };
    /**
     * 同步当前行
     */
    PopUpService.prototype.updateCurrentRow = function (id) {
        var _this = this;
        var bindingPath = this.frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        // const frameId = this.frameContext.frameId;
        var root = this.frameContext.appContext.frameContextManager.getRootFrameContext();
        var primaryKeyValue = root.bindingData.list.currentId;
        this.frameContext.bindingData.list.setCurrentId(primaryKeyValue);
        if (bindingPaths.length > 0) {
            var paths_2 = [];
            bindingPaths.forEach(function (path, index, array) {
                paths_2.push(path);
                var bindingList = root.bindingData.getValue(paths_2);
                if (bindingList) {
                    var currentId = bindingList.currentId;
                    var modalBindingList = _this.frameContext.bindingData.getValue(paths_2);
                    if (index === bindingPath.length - 1 && id) {
                        modalBindingList.setCurrentId(id);
                    }
                    else if (modalBindingList) {
                        modalBindingList.setCurrentId(currentId);
                    }
                }
            });
        }
    };
    PopUpService.prototype.closeCheck = function () {
        var frameContext = this.frameContext;
        var bindingPath = frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        var befRepository = this.repository;
        var longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map(function (path) { return path.split(':')[1]; });
        var entityListPaths = Array.from(longPaths);
        entityListPaths.pop();
        var entityList = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
        var dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityList.count() === 0 && dialogRef) {
            dialogRef.close();
        }
    };
    /**
     * 构造子表路径
     * @param bindingPath 绑定路径
     * @param id id
     */
    PopUpService.prototype.buildPath = function (bindingPath, id) {
        var path = '/' + id;
        var subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (var index = 1; index < subPaths.length - 1; index++) {
                var subPath = subPaths[index];
                var subData = this.frameContext.viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error("\u83B7\u53D6\u5B50\u8868\u5B8C\u6574\u8DEF\u5F84\u51FA\u9519\uFF0C\u627E\u4E0D\u5230" + subData + "\u5BF9\u5E94\u7684\u5B50\u8868\uFF0C\u6216\u5BF9\u5E94\u5B50\u8868\u6CA1\u6709\u5F53\u524D\u884C\u3002");
                }
                path += "/" + subPath + "/" + subData.currentId;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    };
    PopUpService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PopUpService.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: Repository },
        { type: LanguageService },
        { type: FormMessageService }
    ]; };
    return PopUpService;
}());
export { PopUpService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wX3VwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcG9wX3VwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQTZDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTVEO0lBRUUsc0JBQ1UsUUFBa0IsRUFDbEIsWUFBMEIsRUFDMUIsVUFBMkIsRUFDM0IsZUFBZ0MsRUFDaEMsY0FBa0M7UUFKbEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQW9CO0lBQ3hDLENBQUM7SUFDRSw4QkFBTyxHQUFkLGNBQW1CLENBQUM7SUFDcEI7Ozs7O09BS0c7SUFDSSw2QkFBTSxHQUFiLFVBQWMsT0FBZSxFQUFFLEVBQVc7UUFDeEMsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkcsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFpQyxPQUFT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QUMsQ0FBQztRQUN4QyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZCLDZEQUE2RDtZQUM3RCxjQUFjO1lBQ2QsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUN4RCxJQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2hDLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDakUsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUU7b0JBQ2xDLE1BQU0sS0FBSyxDQUFDLHlGQUFpQixPQUFPLDJHQUFtQixDQUFDLENBQUM7aUJBQzFEO2dCQUNELElBQUksSUFBSSxNQUFJLE9BQU8sU0FBSSxPQUFPLENBQUMsU0FBVyxDQUFDO2FBQzVDO1NBQ0Y7UUFDRCxJQUFJLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTVDLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7Z0JBdkpGLFVBQVU7Ozs7Z0JBUlUsUUFBUTtnQkFJcEIsWUFBWTtnQkFBbUIsVUFBVTtnQkFDekMsZUFBZTtnQkFDZixrQkFBa0I7O0lBMEozQixtQkFBQztDQUFBLEFBeEpELElBd0pDO1NBdkpZLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEVNUFRZLCBvZiB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCwgdGFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tIFwiQGZhcnJpcy9iZWZcIjtcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBEYXRhUGF0aENyZWF0b3IsIFJlcG9zaXRvcnksIERhdGFQYXRoLCBFbnRpdHlMaXN0LCBCaW5kaW5nTGlzdCwgRW50aXR5IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XHJcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gXCIuL2xhbmd1YWcuc2VydmljZVwiO1xyXG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tIFwiLi9mb3JtLW1lc3NhZ2Uuc2VydmljZVwiO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgUG9wVXBTZXJ2aWNlIHtcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxyXG4gICAgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcclxuICAgIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZVxyXG4gICkgeyB9XHJcbiAgcHVibGljIGNvbmZpcm0oKSB7IH1cclxuICAvKipcclxuICAgKiDlj5bmtojlj5jmm7RcclxuICAgKiBAcGFyYW0gZnJhbWVJZCBcclxuICAgKiBAcGFyYW0gaWQgXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGNhbmNlbChmcmFtZUlkOiBzdHJpbmcsIGlkPzogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKTtcclxuICAgIGlmICghZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgW1BvcFVwU2VydmljZV1JbnZhbGlkIGZyYW1lSWQgJHtmcmFtZUlkfWApO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcHJpbWFyeVZhbHVlID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgaWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICB9XHJcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcclxuICAgIGNvbnN0IGxvbmdQYXRocyA9IChEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpIGFzIERhdGFQYXRoKS50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHBhdGguc3BsaXQoJzonKVsxXSk7XHJcbiAgICBjb25zdCBlbnRpdHlMaXN0UGF0aHMgPSBBcnJheS5mcm9tKGxvbmdQYXRocyk7XHJcbiAgICAvL+iIjeW8g+W9k+WJjeihqOW9k+WJjeihjFxyXG4gICAgZW50aXR5TGlzdFBhdGhzLnBvcCgpO1xyXG4gICAgY29uc3QgZGlhbG9nUmVmID0gdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2RpYWxvZ1JlZiddO1xyXG4gICAgaWYgKGVudGl0eUxpc3RQYXRocy5sZW5ndGggPCAxKSB7XHJcbiAgICAgIC8vIOS4u+ihqFxyXG4gICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKSBhcyBFbnRpdHk7XHJcbiAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IGVudGl0eVsnb3JpZ2luYWxEYXRhJ107XHJcbiAgICAgIGVudGl0eS5sb2FkKG9yaWdpbmFsRGF0YSwgeyBsb2FkQ2hpbGQ6IGZhbHNlIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgZW50aXR5TGlzdCA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5nZXRFbnRpdHlOb2RlQnlQYXRoKGVudGl0eUxpc3RQYXRocykgYXMgRW50aXR5TGlzdDxhbnk+O1xyXG4gICAgICBpZiAoZW50aXR5TGlzdCkge1xyXG4gICAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YTogYW55W10gPSBlbnRpdHlMaXN0WydvcmlnaW5hbERhdGEnXTtcclxuICAgICAgICBjb25zdCBpdGVtID0gb3JpZ2luYWxEYXRhLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBpZCk7XHJcbiAgICAgICAgaWYgKGl0ZW0pIHtcclxuICAgICAgICAgIC8vIOW3suacieaVsOaNru+8jOi/mOWOn+WPmOabtFxyXG4gICAgICAgICAgY29uc3QgZW50aXR5OiBFbnRpdHkgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5QnlQYXRoKGxvbmdQYXRocykgYXMgRW50aXR5O1xyXG4gICAgICAgICAgaWYgKGVudGl0eS5jaGFuZ2VzICYmIGVudGl0eS5jaGFuZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMubWVzc2FnZVNlcnZpY2UuY29uZmlybSh0aGlzLmxhbmd1YWdlU2VydmljZS5jYW5jZWxXaXRob3V0U2F2ZSkucGlwZShcclxuICAgICAgICAgICAgICB0YXAoKHJlc3VsdDogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICBlbnRpdHkubG9hZChpdGVtLCB7IGxvYWRDaGlsZDogZmFsc2UgfSk7XHJcbiAgICAgICAgICAgICAgICAgIGVudGl0eS5jaGFuZ2VzLnNwbGljZSgwLCBlbnRpdHkuY2hhbmdlcy5sZW5ndGgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyDmsqHmnInkv67mlLnvvIznm7TmjqXlhbPpl61cclxuICAgICAgICAgICAgaWYgKGRpYWxvZ1JlZikge1xyXG4gICAgICAgICAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIOaWsOWinueahOaVsOaNru+8jOWIoOmZpFxyXG4gICAgICAgICAgY29uc3QgcGF0aHMgPSB0aGlzLmJ1aWxkUGF0aChiaW5kaW5nUGF0aCwgcHJpbWFyeVZhbHVlKTtcclxuICAgICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmNvbmZpcm0odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsV2l0aG91dFNhdmUpLnBpcGUoXHJcbiAgICAgICAgICAgIHN3aXRjaE1hcChyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBiZWZSZXBvc2l0b3J5LnJlbW92ZUVudGl0eUJ5UGF0aChwYXRocywgaWQpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLnJlbW92ZUVudGl0eUJ5UGF0aChwYXRocywgaWQpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoZW50aXR5TGlzdC5jb3VudCgpID09PSAwICYmIGRpYWxvZ1JlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgZGlhbG9nUmVmLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gb2YoW10pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlkIzmraXlvZPliY3ooYxcclxuICAgKi9cclxuICBwdWJsaWMgdXBkYXRlQ3VycmVudFJvdyhpZD86IHN0cmluZykge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgLy8gY29uc3QgZnJhbWVJZCA9IHRoaXMuZnJhbWVDb250ZXh0LmZyYW1lSWQ7XHJcbiAgICBjb25zdCByb290ID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldFJvb3RGcmFtZUNvbnRleHQoKTtcclxuICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IHJvb3QuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LnNldEN1cnJlbnRJZChwcmltYXJ5S2V5VmFsdWUpO1xyXG4gICAgaWYgKGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gW107XHJcbiAgICAgIGJpbmRpbmdQYXRocy5mb3JFYWNoKChwYXRoOiBzdHJpbmcsIGluZGV4OiBudW1iZXIsIGFycmF5KSA9PiB7XHJcbiAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcclxuICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHJvb3QuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICAgIGlmIChiaW5kaW5nTGlzdCkge1xyXG4gICAgICAgICAgY29uc3QgY3VycmVudElkID0gYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgICAgICAgY29uc3QgbW9kYWxCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgICAgICAgIGlmIChpbmRleCA9PT0gYmluZGluZ1BhdGgubGVuZ3RoIC0gMSAmJiBpZCkge1xyXG4gICAgICAgICAgICBtb2RhbEJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChpZCk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKG1vZGFsQmluZGluZ0xpc3QpIHtcclxuICAgICAgICAgICAgbW9kYWxCaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoY3VycmVudElkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgY2xvc2VDaGVjaygpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0O1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xyXG4gICAgY29uc3QgbG9uZ1BhdGhzID0gKERhdGFQYXRoQ3JlYXRvci5jcmVhdGVCeVNob3J0UGF0aEZyb21Sb290KGJpbmRpbmdQYXRocywgYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLCB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YSkgYXMgRGF0YVBhdGgpLnRvQXJyYXkoKS5tYXAoKHBhdGg6IHN0cmluZykgPT4gcGF0aC5zcGxpdCgnOicpWzFdKTtcclxuICAgIGNvbnN0IGVudGl0eUxpc3RQYXRocyA9IEFycmF5LmZyb20obG9uZ1BhdGhzKTtcclxuICAgIGVudGl0eUxpc3RQYXRocy5wb3AoKTtcclxuICAgIGNvbnN0IGVudGl0eUxpc3QgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5Tm9kZUJ5UGF0aChlbnRpdHlMaXN0UGF0aHMpIGFzIEVudGl0eUxpc3Q8YW55PjtcclxuICAgIGNvbnN0IGRpYWxvZ1JlZiA9IHRoaXMuZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50WydkaWFsb2dSZWYnXTtcclxuICAgIGlmIChlbnRpdHlMaXN0LmNvdW50KCkgPT09IDAgJiYgZGlhbG9nUmVmKSB7XHJcbiAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDlrZDooajot6/lvoRcclxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGgg57uR5a6a6Lev5b6EXHJcbiAgICogQHBhcmFtIGlkIGlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBidWlsZFBhdGgoYmluZGluZ1BhdGg6IHN0cmluZywgaWQ6IGFueSkge1xyXG4gICAgbGV0IHBhdGggPSAnLycgKyBpZDtcclxuICAgIGNvbnN0IHN1YlBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcclxuICAgIGlmIChzdWJQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIC8vIGVnOmJpbmRpbmdQYXRo5b2i5aaCL2VkdXMvZ3JhZGVzLHNwbGl05ZCO5pivWycnLCAnZWR1cycsICdncmFkZXMnXVxyXG4gICAgICAvLyDlm6DmraRpbmRleOS7jjHlvIDlp4tcclxuICAgICAgZm9yIChsZXQgaW5kZXggPSAxOyBpbmRleCA8IHN1YlBhdGhzLmxlbmd0aCAtIDE7IGluZGV4KyspIHtcclxuICAgICAgICBjb25zdCBzdWJQYXRoID0gc3ViUGF0aHNbaW5kZXhdO1xyXG4gICAgICAgIGNvbnN0IHN1YkRhdGEgPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ0RhdGFbc3ViUGF0aF07XHJcbiAgICAgICAgaWYgKCFzdWJEYXRhIHx8ICFzdWJEYXRhLmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgdGhyb3cgRXJyb3IoYOiOt+WPluWtkOihqOWujOaVtOi3r+W+hOWHuumUme+8jOaJvuS4jeWIsCR7c3ViRGF0YX3lr7nlupTnmoTlrZDooajvvIzmiJblr7nlupTlrZDooajmsqHmnInlvZPliY3ooYzjgIJgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGF0aCArPSBgLyR7c3ViUGF0aH0vJHtzdWJEYXRhLmN1cnJlbnRJZH1gO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBwYXRoICs9ICcvJyArIHN1YlBhdGhzW3N1YlBhdGhzLmxlbmd0aCAtIDFdO1xyXG5cclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxufSJdfQ==