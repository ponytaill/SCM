import { Directive, Input, Injector, Optional } from '@angular/core';
import { FrameContext, ChangeType } from '@farris/devkit';
import { FFilePreviewComponent, UploadAndPreviewComponent } from '@farris/extend-file-upload';
/**
 * 树表格绑定指令
 */
var FarrisFilePreviewBindingDirective = /** @class */ (function () {
    /**
     * 构造函数
     */
    function FarrisFilePreviewBindingDirective(previewComponent, frameContext, uploadAndPreviewComponent, injector) {
        this.previewComponent = previewComponent;
        this.frameContext = frameContext;
        this.uploadAndPreviewComponent = uploadAndPreviewComponent;
        this.injector = injector;
    }
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "bindingData", {
        /**
         * 绑定数据
         */
        get: function () {
            return this.frameContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "bindingList", {
        /**
         * 绑定数据列表
         */
        get: function () {
            return this.bindingData.getList();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 指令初始化
     */
    FarrisFilePreviewBindingDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.bindData();
        if (this.uploadAndPreviewComponent) {
            this.uploadAndPreviewComponent.orderField = 'fileSortOrder';
        }
        this.bindingData.changes.subscribe(function (change) {
            if (change.type === ChangeType.Load
                || change.type === ChangeType.Append
                || change.type === ChangeType.Remove) {
                _this.bindData();
            }
        });
    };
    /**
     * 指令输入变更
     */
    FarrisFilePreviewBindingDirective.prototype.ngOnChanges = function (changes) {
    };
    /**
     * 绑定数据
     */
    FarrisFilePreviewBindingDirective.prototype.bindData = function () {
        var fileInfos = this.getFileInfos();
        if (this.componentRef) {
            this.componentRef.fileInfos = fileInfos;
        }
    };
    /**
     * 获取附件信息列表
     */
    FarrisFilePreviewBindingDirective.prototype.getFileInfos = function () {
        var _this = this;
        var listData = this.bindingList.toJSON();
        var idKey = this.bindingList.primaryKey;
        var fileInfos = [];
        listData.forEach(function (itemData) {
            var id = _this.getValueByPath(itemData, idKey);
            var fileId = _this.getValueByPath(itemData, _this.fileIdKey);
            var fileName = _this.getValueByPath(itemData, _this.fileNameKey);
            var fileSize = _this.getValueByPath(itemData, _this.fileSizeKey);
            var fileCreateTime = _this.getValueByPath(itemData, _this.fileCreateTimeKey);
            var fileInfo = {
                id: fileId,
                name: fileName,
                size: fileSize,
                createTime: fileCreateTime,
                originalData: itemData,
                extend: {
                    metadataId: fileId
                }
            };
            if (_this.extendFileInfo && Array.isArray(_this.extendFileInfo) && _this.extendFileInfo.length > 0) {
                _this.extendFileInfo.forEach(function (item) {
                    fileInfo[item.key] = _this.getValueByPath(itemData, item.path);
                });
            }
            if (_this.fileSortOrderKey) {
                var fileSortOrder = _this.getValueByPath(itemData, _this.fileSortOrderKey);
                fileInfo.fileSortOrder = fileSortOrder;
            }
            fileInfos.push(fileInfo);
        });
        return fileInfos;
    };
    /**
     * 根据字段路径获取值
     */
    FarrisFilePreviewBindingDirective.prototype.getValueByPath = function (data, path) {
        var keys = path.split('.');
        var currentValue = data;
        keys.forEach(function (key) {
            currentValue = currentValue && currentValue[key];
        });
        return currentValue;
    };
    FarrisFilePreviewBindingDirective.prototype.getUdtPaths = function () {
        var paths = this.fileIdKey.split('.');
        paths.pop();
        return paths;
    };
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "fileSizeKey", {
        get: function () {
            var basePaths = this.getUdtPaths();
            return basePaths.concat(['fileSize']).join('.');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "fileCreateTimeKey", {
        get: function () {
            var basePaths = this.getUdtPaths();
            return basePaths.concat(['fileCreateTime']).join('.');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "componentRef", {
        get: function () {
            return this.previewComponent || this.uploadAndPreviewComponent || null;
        },
        enumerable: true,
        configurable: true
    });
    FarrisFilePreviewBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farrisFilePreviewBinding]'
                },] }
    ];
    /** @nocollapse */
    FarrisFilePreviewBindingDirective.ctorParameters = function () { return [
        { type: FFilePreviewComponent, decorators: [{ type: Optional }] },
        { type: FrameContext },
        { type: UploadAndPreviewComponent, decorators: [{ type: Optional }] },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    FarrisFilePreviewBindingDirective.propDecorators = {
        extendFileInfo: [{ type: Input, args: ['extendFileInfo',] }],
        fileIdKey: [{ type: Input, args: ['farrisFileIdKey',] }],
        fileSortOrderKey: [{ type: Input, args: ['farrisFileSortOrderKey',] }],
        fileNameKey: [{ type: Input, args: ['farrisFileNameKey',] }]
    };
    return FarrisFilePreviewBindingDirective;
}());
export { FarrisFilePreviewBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWZpbGUtcHJldmlldy1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2ZpbGUtcHJldmlldy9mYXJyaXMtZmlsZS1wcmV2aWV3LWJpbmRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQW9DLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZHLE9BQU8sRUFBNEIsWUFBWSxFQUFVLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVGLE9BQU8sRUFBYyxxQkFBcUIsRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFHOztHQUVHO0FBQ0g7SUFxQ0U7O09BRUc7SUFDSCwyQ0FDc0IsZ0JBQXVDLEVBQ25ELFlBQTBCLEVBQ2QseUJBQW9ELEVBQ3BELFFBQWtCO1FBSGxCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBdUI7UUFDbkQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDZCw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELGFBQVEsR0FBUixRQUFRLENBQVU7SUFFeEMsQ0FBQztJQXBCRCxzQkFBWSwwREFBVztRQUh2Qjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUtELHNCQUFZLDBEQUFXO1FBSHZCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDcEMsQ0FBQzs7O09BQUE7SUFhRDs7T0FFRztJQUNILG9EQUFRLEdBQVI7UUFBQSxpQkFhQztRQVpDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLElBQUksQ0FBQyx5QkFBeUIsRUFBRTtZQUNs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QUM7b0JBQ1QsUUFBUSxFQUFFLDRCQUE0QjtpQkFDdkM7Ozs7Z0JBUG9CLHFCQUFxQix1QkE4Q3JDLFFBQVE7Z0JBL0NzQixZQUFZO2dCQUNILHlCQUF5Qix1QkFnRGhFLFFBQVE7Z0JBbERnRCxRQUFRLHVCQW1EaEUsUUFBUTs7O2lDQXZDVixLQUFLLFNBQUMsZ0JBQWdCOzRCQUt0QixLQUFLLFNBQUMsaUJBQWlCO21DQUt2QixLQUFLLFNBQUMsd0JBQXdCOzhCQUs5QixLQUFLLFNBQUMsbUJBQW1COztJQWtJNUIsd0NBQUM7Q0FBQSxBQXRKRCxJQXNKQztBQUVELE9BQU8sRUFBRSxpQ0FBaUMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgSW5wdXQsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIEZyYW1lQ29udGV4dCwgQ2hhbmdlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBVcGxvYWRGaWxlLCBGRmlsZVByZXZpZXdDb21wb25lbnQsIFVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL2V4dGVuZC1maWxlLXVwbG9hZCc7XHJcblxyXG4vKipcclxuICog5qCR6KGo5qC857uR5a6a5oyH5LukXHJcbiAqL1xyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXNGaWxlUHJldmlld0JpbmRpbmddJ1xyXG59KVxyXG5jbGFzcyBGYXJyaXNGaWxlUHJldmlld0JpbmRpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XHJcblxyXG4gIEBJbnB1dCgnZXh0ZW5kRmlsZUluZm8nKVxyXG4gIHB1YmxpYyBleHRlbmRGaWxlSW5mbzogeyBrZXk6IHN0cmluZywgcGF0aDogYW55IH1bXTtcclxuICAvKipcclxuICAgKiDmlofku7ZpZOWtl+autei3r+W+hFxyXG4gICAqL1xyXG4gIEBJbnB1dCgnZmFycmlzRmlsZUlkS2V5JylcclxuICBwdWJsaWMgZmlsZUlkS2V5OiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICog5o6S5bqP5a2X5q61XHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXNGaWxlU29ydE9yZGVyS2V5JylcclxuICBwdWJsaWMgZmlsZVNvcnRPcmRlcktleTogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIOaWh+S7tm5hbWXlrZfmrrXot6/lvoRcclxuICAgKi9cclxuICBASW5wdXQoJ2ZhcnJpc0ZpbGVOYW1lS2V5JylcclxuICBwdWJsaWMgZmlsZU5hbWVLZXk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0RhdGEoKTogQmluZGluZ0RhdGEge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2u5YiX6KGoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHByZXZpZXdDb21wb25lbnQ6IEZGaWxlUHJldmlld0NvbXBvbmVudCxcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQ6IFVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5oyH5Luk5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgICBpZiAodGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudC5vcmRlckZpZWxkID0gJ2ZpbGVTb3J0T3JkZXInO1xyXG4gICAgfVxyXG4gICAgdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWRcclxuICAgICAgICB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5BcHBlbmRcclxuICAgICAgICB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5SZW1vdmVcclxuICAgICAgKSB7XHJcbiAgICAgICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaMh+S7pOi+k+WFpeWPmOabtFxyXG4gICAqL1xyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDnu5HlrprmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGJpbmREYXRhKCkge1xyXG4gICAgY29uc3QgZmlsZUluZm9zID0gdGhpcy5nZXRGaWxlSW5mb3MoKTtcclxuICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xyXG4gICAgICB0aGlzLmNvbXBvbmVudFJlZi5maWxlSW5mb3MgPSBmaWxlSW5mb3M7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bpmYTku7bkv6Hmga/liJfooahcclxuICAgKi9cclxuICBwcml2YXRlIGdldEZpbGVJbmZvcygpOiBVcGxvYWRGaWxlW10ge1xyXG4gICAgY29uc3QgbGlzdERhdGEgPSB0aGlzLmJpbmRpbmdMaXN0LnRvSlNPTigpO1xyXG4gICAgY29uc3QgaWRLZXkgPSB0aGlzLmJpbmRpbmdMaXN0LnByaW1hcnlLZXk7XHJcbiAgICBjb25zdCBmaWxlSW5mb3M6IFVwbG9hZEZpbGVbXSA9IFtdO1xyXG5cclxuICAgIGxpc3REYXRhLmZvckVhY2goKGl0ZW1EYXRhOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgaWQgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCBpZEtleSk7XHJcbiAgICAgIGNvbnN0IGZpbGVJZCA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZUlkS2V5KTtcclxuICAgICAgY29uc3QgZmlsZU5hbWUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCB0aGlzLmZpbGVOYW1lS2V5KTtcclxuICAgICAgY29uc3QgZmlsZVNpemUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCB0aGlzLmZpbGVTaXplS2V5KTtcclxuICAgICAgY29uc3QgZmlsZUNyZWF0ZVRpbWUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCB0aGlzLmZpbGVDcmVhdGVUaW1lS2V5KTtcclxuXHJcbiAgICAgIGNvbnN0IGZpbGVJbmZvOiBhbnkgPSB7XHJcbiAgICAgICAgaWQ6IGZpbGVJZCxcclxuICAgICAgICBuYW1lOiBmaWxlTmFtZSxcclxuICAgICAgICBzaXplOiBmaWxlU2l6ZSxcclxuICAgICAgICBjcmVhdGVUaW1lOiBmaWxlQ3JlYXRlVGltZSxcclxuICAgICAgICBvcmlnaW5hbERhdGE6IGl0ZW1EYXRhLFxyXG4gICAgICAgIGV4dGVuZDoge1xyXG4gICAgICAgICAgbWV0YWRhdGFJZDogZmlsZUlkXHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgICBpZiAodGhpcy5leHRlbmRGaWxlSW5mbyAmJiBBcnJheS5pc0FycmF5KHRoaXMuZXh0ZW5kRmlsZUluZm8pICYmIHRoaXMuZXh0ZW5kRmlsZUluZm8ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kRmlsZUluZm8uZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgIGZpbGVJbmZvW2l0ZW0ua2V5XSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIGl0ZW0ucGF0aCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMuZmlsZVNvcnRPcmRlcktleSkge1xyXG4gICAgICAgIGNvbnN0IGZpbGVTb3J0T3JkZXIgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCB0aGlzLmZpbGVTb3J0T3JkZXJLZXkpO1xyXG4gICAgICAgIGZpbGVJbmZvLmZpbGVTb3J0T3JkZXIgPSBmaWxlU29ydE9yZGVyO1xyXG4gICAgICB9XHJcbiAgICAgIGZpbGVJbmZvcy5wdXNoKGZpbGVJbmZvKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBmaWxlSW5mb3M7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja7lrZfmrrXot6/lvoTojrflj5blgLxcclxuICAgKi9cclxuICBwcml2YXRlIGdldFZhbHVlQnlQYXRoKGRhdGE6IGFueSwgcGF0aDogc3RyaW5nKTogYW55IHtcclxuICAgIGNvbnN0IGtleXMgPSBwYXRoLnNwbGl0KCcuJyk7XHJcbiAgICBsZXQgY3VycmVudFZhbHVlID0gZGF0YTtcclxuICAgIGtleXMuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgY3VycmVudFZhbHVlID0gY3VycmVudFZhbHVlICYmIGN1cnJlbnRWYWx1ZVtrZXldO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gY3VycmVudFZhbHVlO1xyXG4gIH1cclxuICBwcml2YXRlIGdldFVkdFBhdGhzKCk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHBhdGhzID0gdGhpcy5maWxlSWRLZXkuc3BsaXQoJy4nKTtcclxuICAgIHBhdGhzLnBvcCgpO1xyXG4gICAgcmV0dXJuIHBhdGhzO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCBmaWxlU2l6ZUtleSgpIHtcclxuICAgIGNvbnN0IGJhc2VQYXRocyA9IHRoaXMuZ2V0VWR0UGF0aHMoKTtcclxuICAgIHJldHVybiBiYXNlUGF0aHMuY29uY2F0KFsnZmlsZVNpemUnXSkuam9pbignLicpO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCBmaWxlQ3JlYXRlVGltZUtleSgpIHtcclxuICAgIGNvbnN0IGJhc2VQYXRocyA9IHRoaXMuZ2V0VWR0UGF0aHMoKTtcclxuICAgIHJldHVybiBiYXNlUGF0aHMuY29uY2F0KFsnZmlsZUNyZWF0ZVRpbWUnXSkuam9pbignLicpO1xyXG4gIH1cclxuICBwcml2YXRlIGdldCBjb21wb25lbnRSZWYoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5wcmV2aWV3Q29tcG9uZW50IHx8IHRoaXMudXBsb2FkQW5kUHJldmlld0NvbXBvbmVudCB8fCBudWxsO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgRmFycmlzRmlsZVByZXZpZXdCaW5kaW5nRGlyZWN0aXZlIH07XHJcbiJdfQ==