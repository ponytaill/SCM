import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { FrameContext } from '@farris/devkit';
import { FormLoadingService } from './form-loading/form-loading.service';
import { RuntimeFrameworkService } from './rtf-service';
import { tap } from 'rxjs/operators';
import { EMPTY } from 'rxjs';
// tslint:disable: max-line-length
var DiscussionGroupService = /** @class */ (function () {
    function DiscussionGroupService(injector, frameContext, loadingService, runtimeFrameworkService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.loadingService = loadingService;
        this.runtimeFrameworkService = runtimeFrameworkService;
    }
    Object.defineProperty(DiscussionGroupService.prototype, "repository", {
        /**
         * 实体仓库
         */
        get: function () {
            return this.frameContext.repository;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DiscussionGroupService.prototype, "params", {
        /**
         * 命令参数
         */
        get: function () {
            return this['context'] && this['context']['eventParam'] || {};
        },
        enumerable: true,
        configurable: true
    });
    DiscussionGroupService.prototype.addComment = function (id, summary, configId, text, visibility, parentId) {
        var _this = this;
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        var params = this.buildAddCommentParam(id, text, parentId, summary, visibility, configId);
        var restService = this.repository.restService;
        var url = '/api/runtime/comment/v1.0/bill-comment/comment';
        var requestInfo = restService.buildRequestInfo();
        var options = {
            body: tslib_1.__assign({ requestInfo: requestInfo }, params)
        };
        this.loadingService.show();
        return restService.invoke(url, 'POST', null, options).pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询评论
     * @param id id
     */
    DiscussionGroupService.prototype.queryComments = function (id, configId, pageIndex, pageSize) {
        var _this = this;
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        var restService = this.repository.restService;
        var url = this.buildQueryCommentsUrl(id, pageIndex, pageSize, configId);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询所有部门信息
     */
    DiscussionGroupService.prototype.queryAllOrgs = function () {
        var _this = this;
        var restService = this.repository.restService;
        var url = '/api/runtime/sys/v1.0/sysOrgs?param={"layer":"1"}';
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询常用@用户
     * @param pageIndex
     * @param pageSize
     */
    DiscussionGroupService.prototype.queryFrequentAtUsers = function (pageIndex, pageSize) {
        var _this = this;
        var restService = this.repository.restService;
        var url = this.buildQueryFrequentAtUsersUrl(pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 获取at用户列表
     * @param user 用户编号或者用户名称（过滤使用）
     * @param pageIndex pageIndex
     * @param pageSize pageSize
     */
    DiscussionGroupService.prototype.queryAtUsers = function (user, pageIndex, pageSize) {
        var _this = this;
        var restService = this.repository.restService;
        var url = this.buildQueryAtUsersUrl(user, pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 构造获取评论列表的url
     * @param id id
     */
    DiscussionGroupService.prototype.buildQueryCommentsUrl = function (id, pageIndex, pageSize, configId) {
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 10;
        }
        var serverUri = this.repository.serverUri;
        // const funcId = this.runtimeFrameworkService && this.runtimeFrameworkService.funcId || '';
        return "/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId=" + configId + "&billId=" + id + "&pageSize=" + pageSize + "&pageIndex=" + pageIndex;
    };
    /**
     * 构造获取@用户url
     */
    DiscussionGroupService.prototype.buildQueryAtUsersUrl = function (user, pageIndex, pageSize) {
        var params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 1000;
        }
        if (user) {
            params.push("param=" + user);
        }
        params.push("pageSize=" + pageSize);
        params.push("pageIndex=" + pageIndex);
        return "/api/runtime/comment/v1.0/bill-comment/atUser?" + params.join('&');
    };
    DiscussionGroupService.prototype.buildQueryFrequentAtUsersUrl = function (pageIndex, pageSize) {
        var params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 6;
        }
        params.push("pageSize=" + pageSize);
        params.push("pageIndex=" + pageIndex);
        return "/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?" + params.join('&');
    };
    DiscussionGroupService.prototype.buildAddCommentParam = function (id, text, parentId, summary, visibility, configId) {
        if (typeof text === 'undefined') {
            text = this.params.text;
        }
        if (typeof parentId === 'undefined') {
            parentId = this.params.parentId;
        }
        if (typeof visibility === 'undefined') {
            visibility = this.params.visibility;
        }
        return {
            'bill': {
                'billId': id,
                'configId': configId,
                'summary': summary
            },
            'comment': {
                'billId': id,
                'configId': configId,
                'parentId': parentId || null,
                'text': text,
                'visibility': visibility
            }
        };
    };
    DiscussionGroupService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DiscussionGroupService.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: FormLoadingService },
        { type: RuntimeFrameworkService }
    ]; };
    return DiscussionGroupService;
}());
export { DiscussionGroupService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzY3Vzc2lvbi1ncm91cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2Rpc2N1c3Npb24tZ3JvdXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBVSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFrQixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0Msa0NBQWtDO0FBQ2xDO0lBY0UsZ0NBQW9CLFFBQWtCLEVBQVUsWUFBMEIsRUFBVSxjQUFrQyxFQUFVLHVCQUFnRDtRQUE1SixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBb0I7UUFBVSw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO0lBQ2hMLENBQUM7SUFWRCxzQkFBWSw4Q0FBVTtRQUh0Qjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQW1DLENBQUM7UUFDL0QsQ0FBQzs7O09BQUE7SUFJRCxzQkFBWSwwQ0FBTTtRQUhsQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoRSxDQUFDOzs7T0FBQTtJQUlNLDJDQUFVLEdBQWpCLFVBQWtCLEVBQVcsRUFBRSxPQUFnQixFQUFFLFFB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QWtCO2dCQUNsQix1QkFBdUI7O0lBaUxoQyw2QkFBQztDQUFBLEFBN0tELElBNktDO1NBNUtZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgRW50aXR5IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xyXG5pbXBvcnQgeyBGb3JtTG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XHJcbmltcG9ydCB7IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnLi9ydGYtc2VydmljZSc7XHJcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGlzY3Vzc2lvbkdyb3VwU2VydmljZSB7XHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5LuT5bqTXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgcmVwb3NpdG9yeSgpOiBCZWZSZXBvc2l0b3J5PEVudGl0eT4ge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxFbnRpdHk+O1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlkb3ku6Tlj4LmlbBcclxuICAgKi9cclxuICBwcml2YXRlIGdldCBwYXJhbXMoKSB7XHJcbiAgICByZXR1cm4gdGhpc1snY29udGV4dCddICYmIHRoaXNbJ2NvbnRleHQnXVsnZXZlbnRQYXJhbSddIHx8IHt9O1xyXG4gIH1cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLCBwcml2YXRlIHJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlOiBSdW50aW1lRnJhbWV3b3JrU2VydmljZSkge1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFkZENvbW1lbnQoaWQ/OiBzdHJpbmcsIHN1bW1hcnk/OiBzdHJpbmcsIGNvbmZpZ0lkPzogc3RyaW5nLCB0ZXh0Pzogc3RyaW5nLCB2aXNpYmlsaXR5Pzogc3RyaW5nLCBwYXJlbnRJZD86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZCA9IGlkIHx8IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkIHx8IG51bGw7XHJcbiAgICBpZiAoIWlkKSB7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuYnVpbGRBZGRDb21tZW50UGFyYW0oaWQsIHRleHQsIHBhcmVudElkLCBzdW1tYXJ5LCB2aXNpYmlsaXR5LCBjb25maWdJZCk7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IHVybCA9ICcvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9jb21tZW50JztcclxuICAgIGNvbnN0IHJlcXVlc3RJbmZvID0gcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpO1xyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgYm9keToge1xyXG4gICAgICAgIHJlcXVlc3RJbmZvLFxyXG4gICAgICAgIC4uLnBhcmFtc1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ1BPU1QnLCBudWxsLCBvcHRpb25zKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l6K+i6K+E6K66XHJcbiAgICogQHBhcmFtIGlkIGlkXHJcbiAgICovXHJcbiAgcHVibGljIHF1ZXJ5Q29tbWVudHMoaWQ6IHN0cmluZywgY29uZmlnSWQ6IHN0cmluZywgcGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGlkID0gaWQgfHwgdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgfHwgbnVsbDtcclxuICAgIGlmICghaWQpIHtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xyXG5cclxuICAgIGNvbnN0IHVybCA9IHRoaXMuYnVpbGRRdWVyeUNvbW1lbnRzVXJsKGlkLCBwYWdlSW5kZXgsIHBhZ2VTaXplLCBjb25maWdJZCk7XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJykucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOafpeivouaJgOaciemDqOmXqOS/oeaBr1xyXG4gICAqL1xyXG4gIHB1YmxpYyBxdWVyeUFsbE9yZ3MoKSB7XHJcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcclxuICAgIGNvbnN0IHVybCA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvc3lzT3Jncz9wYXJhbT17XCJsYXllclwiOlwiMVwifSc7XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJykucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOafpeivouW4uOeUqEDnlKjmiLcgXHJcbiAgICogQHBhcmFtIHBhZ2VJbmRleCBcclxuICAgKiBAcGFyYW0gcGFnZVNpemUgXHJcbiAgICovXHJcbiAgcHVibGljIHF1ZXJ5RnJlcXVlbnRBdFVzZXJzKHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkUXVlcnlGcmVxdWVudEF0VXNlcnNVcmwocGFnZUluZGV4LCBwYWdlU2l6ZSk7XHJcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJykucGlwZShcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlmF055So5oi35YiX6KGoXHJcbiAgICogQHBhcmFtIHVzZXIg55So5oi357yW5Y+35oiW6ICF55So5oi35ZCN56ew77yI6L+H5ruk5L2/55So77yJXHJcbiAgICogQHBhcmFtIHBhZ2VJbmRleCBwYWdlSW5kZXhcclxuICAgKiBAcGFyYW0gcGFnZVNpemUgcGFnZVNpemVcclxuICAgKi9cclxuICBwdWJsaWMgcXVlcnlBdFVzZXJzKHVzZXI/OiBzdHJpbmcsIHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xyXG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XHJcbiAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkUXVlcnlBdFVzZXJzVXJsKHVzZXIsIHBhZ2VJbmRleCwgcGFnZVNpemUpO1xyXG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XHJcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcpLnBpcGUoXHJcbiAgICAgIHRhcCgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDojrflj5bor4TorrrliJfooajnmoR1cmxcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkUXVlcnlDb21tZW50c1VybChpZDogc3RyaW5nLCBwYWdlSW5kZXg6IG51bWJlciB8IG51bGwsIHBhZ2VTaXplOiBudW1iZXIgfCBudWxsLCBjb25maWdJZDogc3RyaW5nKSB7XHJcbiAgICBpZiAodHlwZW9mIHBhZ2VJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZUluZGV4ID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiBwYWdlU2l6ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZVNpemUgPT09IG51bGwpIHtcclxuICAgICAgcGFnZVNpemUgPSB0aGlzLnBhcmFtcy5wYWdlU2l6ZSB8fCAxMDtcclxuICAgIH1cclxuICAgIGNvbnN0IHNlcnZlclVyaSA9IHRoaXMucmVwb3NpdG9yeS5zZXJ2ZXJVcmk7XHJcbiAgICAvLyBjb25zdCBmdW5jSWQgPSB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlICYmIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuZnVuY0lkIHx8ICcnO1xyXG4gICAgcmV0dXJuIGAvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9jb21tZW50L2J5QmlsbD9jb25maWdJZD0ke2NvbmZpZ0lkfSZiaWxsSWQ9JHtpZH0mcGFnZVNpemU9JHtwYWdlU2l6ZX0mcGFnZUluZGV4PSR7cGFnZUluZGV4fWA7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOiOt+WPlkDnlKjmiLd1cmxcclxuICAgKi9cclxuICBwcml2YXRlIGJ1aWxkUXVlcnlBdFVzZXJzVXJsKHVzZXI/OiBzdHJpbmcsIHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xyXG4gICAgY29uc3QgcGFyYW1zOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgaWYgKHR5cGVvZiBwYWdlSW5kZXggPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VJbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICBwYWdlSW5kZXggPSB0aGlzLnBhcmFtcy5wYWdlSW5kZXggfHwgMDtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGFnZVNpemUgPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VTaXplID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VTaXplID0gdGhpcy5wYXJhbXMucGFnZVNpemUgfHwgMTAwMDtcclxuICAgIH1cclxuICAgIGlmICh1c2VyKSB7XHJcbiAgICAgIHBhcmFtcy5wdXNoKGBwYXJhbT0ke3VzZXJ9YCk7XHJcbiAgICB9XHJcbiAgICBwYXJhbXMucHVzaChgcGFnZVNpemU9JHtwYWdlU2l6ZX1gKTtcclxuICAgIHBhcmFtcy5wdXNoKGBwYWdlSW5kZXg9JHtwYWdlSW5kZXh9YCk7XHJcbiAgICByZXR1cm4gYC9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2F0VXNlcj8ke3BhcmFtcy5qb2luKCcmJyl9YDtcclxuICB9XHJcbiAgcHJpdmF0ZSBidWlsZFF1ZXJ5RnJlcXVlbnRBdFVzZXJzVXJsKHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xyXG4gICAgY29uc3QgcGFyYW1zOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgaWYgKHR5cGVvZiBwYWdlSW5kZXggPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VJbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICBwYWdlSW5kZXggPSB0aGlzLnBhcmFtcy5wYWdlSW5kZXggfHwgMDtcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGFnZVNpemUgPT09ICd1bmRlZmluZWQnIHx8IHBhZ2VTaXplID09PSBudWxsKSB7XHJcbiAgICAgIHBhZ2VTaXplID0gdGhpcy5wYXJhbXMucGFnZVNpemUgfHwgNjtcclxuICAgIH1cclxuICAgIHBhcmFtcy5wdXNoKGBwYWdlU2l6ZT0ke3BhZ2VTaXplfWApO1xyXG4gICAgcGFyYW1zLnB1c2goYHBhZ2VJbmRleD0ke3BhZ2VJbmRleH1gKTtcclxuICAgIHJldHVybiBgL2FwaS9ydW50aW1lL2NvbW1lbnQvdjEuMC9iaWxsLWNvbW1lbnQvZnJlcXVlbnRBdFVzZXJzPyR7cGFyYW1zLmpvaW4oJyYnKX1gO1xyXG4gIH1cclxuICBwcml2YXRlIGJ1aWxkQWRkQ29tbWVudFBhcmFtKGlkOiBzdHJpbmcsIHRleHQ6IHN0cmluZywgcGFyZW50SWQ6IHN0cmluZywgc3VtbWFyeTogc3RyaW5nLCB2aXNpYmlsaXR5OiBzdHJpbmcsIGNvbmZpZ0lkOiBzdHJpbmcpIHtcclxuICAgIGlmICh0eXBlb2YgdGV4dCA9PT0gJ3VuZGVmaW5lZCcpIHtcclxuICAgICAgdGV4dCA9IHRoaXMucGFyYW1zLnRleHQ7XHJcbiAgICB9XHJcbiAgICBpZiAodHlwZW9mIHBhcmVudElkID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICBwYXJlbnRJZCA9IHRoaXMucGFyYW1zLnBhcmVudElkO1xyXG4gICAgfVxyXG4gICAgaWYgKHR5cGVvZiB2aXNpYmlsaXR5ID09PSAndW5kZWZpbmVkJykge1xyXG4gICAgICB2aXNpYmlsaXR5ID0gdGhpcy5wYXJhbXMudmlzaWJpbGl0eTtcclxuICAgIH1cclxuICAgIHJldHVybiB7XHJcbiAgICAgICdiaWxsJzoge1xyXG4gICAgICAgICdiaWxsSWQnOiBpZCxcclxuICAgICAgICAnY29uZmlnSWQnOiBjb25maWdJZCxcclxuICAgICAgICAnc3VtbWFyeSc6IHN1bW1hcnlcclxuICAgICAgfSxcclxuICAgICAgJ2NvbW1lbnQnOiB7XHJcbiAgICAgICAgJ2JpbGxJZCc6IGlkLFxyXG4gICAgICAgICdjb25maWdJZCc6IGNvbmZpZ0lkLFxyXG4gICAgICAgICdwYXJlbnRJZCc6IHBhcmVudElkIHx8IG51bGwsXHJcbiAgICAgICAgJ3RleHQnOiB0ZXh0LFxyXG4gICAgICAgICd2aXNpYmlsaXR5JzogdmlzaWJpbGl0eVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==