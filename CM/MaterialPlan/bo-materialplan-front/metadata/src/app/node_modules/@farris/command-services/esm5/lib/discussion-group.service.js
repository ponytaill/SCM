import * as tslib_1 from "tslib";
import { Injectable, Injector } from '@angular/core';
import { FrameContext } from '@farris/devkit';
import { FormLoadingService } from './form-loading/form-loading.service';
import { RuntimeFrameworkService } from './rtf-service';
import { tap } from 'rxjs/operators';
import { EMPTY } from 'rxjs';
// tslint:disable: max-line-length
var DiscussionGroupService = /** @class */ (function () {
    function DiscussionGroupService(injector, frameContext, loadingService, runtimeFrameworkService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.loadingService = loadingService;
        this.runtimeFrameworkService = runtimeFrameworkService;
    }
    Object.defineProperty(DiscussionGroupService.prototype, "repository", {
        /**
         * 实体仓库
         */
        get: function () {
            return this.frameContext.repository;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(DiscussionGroupService.prototype, "params", {
        /**
         * 命令参数
         */
        get: function () {
            return this['context'] && this['context']['eventParam'] || {};
        },
        enumerable: true,
        configurable: true
    });
    DiscussionGroupService.prototype.addComment = function (id, summary, configId, text, visibility, parentId) {
        var _this = this;
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        var params = this.buildAddCommentParam(id, text, parentId, summary, visibility, configId);
        var restService = this.repository.restService;
        var url = '/api/runtime/comment/v1.0/bill-comment/comment';
        var requestInfo = restService.buildRequestInfo();
        var options = {
            body: tslib_1.__assign({ requestInfo: requestInfo }, params)
        };
        this.loadingService.show();
        return restService.invoke(url, 'POST', null, options).pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询评论
     * @param id id
     */
    DiscussionGroupService.prototype.queryComments = function (id, configId, pageIndex, pageSize) {
        var _this = this;
        id = id || this.frameContext && this.frameContext.bindingData.list.currentId || null;
        if (!id) {
            return EMPTY;
        }
        var restService = this.repository.restService;
        var url = this.buildQueryCommentsUrl(id, pageIndex, pageSize, configId);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询所有部门信息
     */
    DiscussionGroupService.prototype.queryAllOrgs = function () {
        var _this = this;
        var restService = this.repository.restService;
        var url = '/api/runtime/sys/v1.0/sysOrgs?param={"layer":"1"}';
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 查询常用@用户
     * @param pageIndex
     * @param pageSize
     */
    DiscussionGroupService.prototype.queryFrequentAtUsers = function (pageIndex, pageSize) {
        var _this = this;
        var restService = this.repository.restService;
        var url = this.buildQueryFrequentAtUsersUrl(pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 获取at用户列表
     * @param user 用户编号或者用户名称（过滤使用）
     * @param pageIndex pageIndex
     * @param pageSize pageSize
     */
    DiscussionGroupService.prototype.queryAtUsers = function (user, pageIndex, pageSize) {
        var _this = this;
        var restService = this.repository.restService;
        var url = this.buildQueryAtUsersUrl(user, pageIndex, pageSize);
        this.loadingService.show();
        return restService.invoke(url, 'GET').pipe(tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 构造获取评论列表的url
     * @param id id
     */
    DiscussionGroupService.prototype.buildQueryCommentsUrl = function (id, pageIndex, pageSize, configId) {
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 10;
        }
        var serverUri = this.repository.serverUri;
        // const funcId = this.runtimeFrameworkService && this.runtimeFrameworkService.funcId || '';
        return "/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId=" + configId + "&billId=" + id + "&pageSize=" + pageSize + "&pageIndex=" + pageIndex;
    };
    /**
     * 构造获取@用户url
     */
    DiscussionGroupService.prototype.buildQueryAtUsersUrl = function (user, pageIndex, pageSize) {
        var params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 1000;
        }
        if (user) {
            params.push("param=" + user);
        }
        params.push("pageSize=" + pageSize);
        params.push("pageIndex=" + pageIndex);
        return "/api/runtime/comment/v1.0/bill-comment/atUser?" + params.join('&');
    };
    DiscussionGroupService.prototype.buildQueryFrequentAtUsersUrl = function (pageIndex, pageSize) {
        var params = [];
        if (typeof pageIndex === 'undefined' || pageIndex === null) {
            pageIndex = this.params.pageIndex || 0;
        }
        if (typeof pageSize === 'undefined' || pageSize === null) {
            pageSize = this.params.pageSize || 6;
        }
        params.push("pageSize=" + pageSize);
        params.push("pageIndex=" + pageIndex);
        return "/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?" + params.join('&');
    };
    DiscussionGroupService.prototype.buildAddCommentParam = function (id, text, parentId, summary, visibility, configId) {
        if (typeof text === 'undefined') {
            text = this.params.text;
        }
        if (typeof parentId === 'undefined') {
            parentId = this.params.parentId;
        }
        if (typeof visibility === 'undefined') {
            visibility = this.params.visibility;
        }
        return {
            'bill': {
                'billId': id,
                'configId': configId,
                'summary': summary
            },
            'comment': {
                'billId': id,
                'configId': configId,
                'parentId': parentId || null,
                'text': text,
                'visibility': visibility
            }
        };
    };
    DiscussionGroupService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DiscussionGroupService.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: FormLoadingService },
        { type: RuntimeFrameworkService }
    ]; };
    return DiscussionGroupService;
}());
export { DiscussionGroupService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlzY3Vzc2lvbi1ncm91cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2Rpc2N1c3Npb24tZ3JvdXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBVSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFrQixLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0Msa0NBQWtDO0FBQ2xDO0lBY0UsZ0NBQW9CLFFBQWtCLEVBQVUsWUFBMEIsRUFBVSxjQUFrQyxFQUFVLHVCQUFnRDtRQUE1SixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBb0I7UUFBVSw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO0lBQ2hMLENBQUM7SUFWRCxzQkFBWSw4Q0FBVTtRQUh0Qjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQW1DLENBQUM7UUFDL0QsQ0FBQzs7O09BQUE7SUFJRCxzQkFBWSwwQ0FBTTtRQUhsQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoRSxDQUFDOzs7T0FBQTtJQUlNLDJDQUFVLEdBQWpCLFVBQWtCLEVBQVcsRUFBRSxPQUFnQixFQUFFLFFB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QWtCO2dCQUNsQix1QkFBdUI7O0lBaUxoQyw2QkFBQztDQUFBLEFBN0tELElBNktDO1NBNUtZLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIEVudGl0eSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XG5pbXBvcnQgeyBGb3JtTG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XG5pbXBvcnQgeyBSdW50aW1lRnJhbWV3b3JrU2VydmljZSB9IGZyb20gJy4vcnRmLXNlcnZpY2UnO1xuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIEVNUFRZIH0gZnJvbSAncnhqcyc7XG4vLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGlzY3Vzc2lvbkdyb3VwU2VydmljZSB7XG4gIC8qKlxuICAgKiDlrp7kvZPku5PlupNcbiAgICovXG4gIHByaXZhdGUgZ2V0IHJlcG9zaXRvcnkoKTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+IHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PEVudGl0eT47XG4gIH1cbiAgLyoqXG4gICAqIOWRveS7pOWPguaVsFxuICAgKi9cbiAgcHJpdmF0ZSBnZXQgcGFyYW1zKCkge1xuICAgIHJldHVybiB0aGlzWydjb250ZXh0J10gJiYgdGhpc1snY29udGV4dCddWydldmVudFBhcmFtJ10gfHwge307XG4gIH1cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IEZvcm1Mb2FkaW5nU2VydmljZSwgcHJpdmF0ZSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UpIHtcbiAgfVxuXG4gIHB1YmxpYyBhZGRDb21tZW50KGlkPzogc3RyaW5nLCBzdW1tYXJ5Pzogc3RyaW5nLCBjb25maWdJZD86IHN0cmluZywgdGV4dD86IHN0cmluZywgdmlzaWJpbGl0eT86IHN0cmluZywgcGFyZW50SWQ/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlkID0gaWQgfHwgdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQgfHwgbnVsbDtcbiAgICBpZiAoIWlkKSB7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuYnVpbGRBZGRDb21tZW50UGFyYW0oaWQsIHRleHQsIHBhcmVudElkLCBzdW1tYXJ5LCB2aXNpYmlsaXR5LCBjb25maWdJZCk7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2NvbW1lbnQnO1xuICAgIGNvbnN0IHJlcXVlc3RJbmZvID0gcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBib2R5OiB7XG4gICAgICAgIHJlcXVlc3RJbmZvLFxuICAgICAgICAuLi5wYXJhbXNcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXJsLCAnUE9TVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5p+l6K+i6K+E6K66XG4gICAqIEBwYXJhbSBpZCBpZFxuICAgKi9cbiAgcHVibGljIHF1ZXJ5Q29tbWVudHMoaWQ6IHN0cmluZywgY29uZmlnSWQ6IHN0cmluZywgcGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZCA9IGlkIHx8IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkIHx8IG51bGw7XG4gICAgaWYgKCFpZCkge1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuXG4gICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFF1ZXJ5Q29tbWVudHNVcmwoaWQsIHBhZ2VJbmRleCwgcGFnZVNpemUsIGNvbmZpZ0lkKTtcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5p+l6K+i5omA5pyJ6YOo6Zeo5L+h5oGvXG4gICAqL1xuICBwdWJsaWMgcXVlcnlBbGxPcmdzKCkge1xuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IHVybCA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvc3lzT3Jncz9wYXJhbT17XCJsYXllclwiOlwiMVwifSc7XG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOafpeivouW4uOeUqEDnlKjmiLcgXG4gICAqIEBwYXJhbSBwYWdlSW5kZXggXG4gICAqIEBwYXJhbSBwYWdlU2l6ZSBcbiAgICovXG4gIHB1YmxpYyBxdWVyeUZyZXF1ZW50QXRVc2VycyhwYWdlSW5kZXg/OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZT86IG51bWJlciB8IG51bGwpIHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCB1cmwgPSB0aGlzLmJ1aWxkUXVlcnlGcmVxdWVudEF0VXNlcnNVcmwocGFnZUluZGV4LCBwYWdlU2l6ZSk7XG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPlmF055So5oi35YiX6KGoXG4gICAqIEBwYXJhbSB1c2VyIOeUqOaIt+e8luWPt+aIluiAheeUqOaIt+WQjeensO+8iOi/h+a7pOS9v+eUqO+8iVxuICAgKiBAcGFyYW0gcGFnZUluZGV4IHBhZ2VJbmRleFxuICAgKiBAcGFyYW0gcGFnZVNpemUgcGFnZVNpemVcbiAgICovXG4gIHB1YmxpYyBxdWVyeUF0VXNlcnModXNlcj86IHN0cmluZywgcGFnZUluZGV4PzogbnVtYmVyIHwgbnVsbCwgcGFnZVNpemU/OiBudW1iZXIgfCBudWxsKSB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgdXJsID0gdGhpcy5idWlsZFF1ZXJ5QXRVc2Vyc1VybCh1c2VyLCBwYWdlSW5kZXgsIHBhZ2VTaXplKTtcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcpLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5p6E6YCg6I635Y+W6K+E6K665YiX6KGo55qEdXJsXG4gICAqIEBwYXJhbSBpZCBpZFxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFF1ZXJ5Q29tbWVudHNVcmwoaWQ6IHN0cmluZywgcGFnZUluZGV4OiBudW1iZXIgfCBudWxsLCBwYWdlU2l6ZTogbnVtYmVyIHwgbnVsbCwgY29uZmlnSWQ6IHN0cmluZykge1xuICAgIGlmICh0eXBlb2YgcGFnZUluZGV4ID09PSAndW5kZWZpbmVkJyB8fCBwYWdlSW5kZXggPT09IG51bGwpIHtcbiAgICAgIHBhZ2VJbmRleCA9IHRoaXMucGFyYW1zLnBhZ2VJbmRleCB8fCAwO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIHBhZ2VTaXplID09PSAndW5kZWZpbmVkJyB8fCBwYWdlU2l6ZSA9PT0gbnVsbCkge1xuICAgICAgcGFnZVNpemUgPSB0aGlzLnBhcmFtcy5wYWdlU2l6ZSB8fCAxMDtcbiAgICB9XG4gICAgY29uc3Qgc2VydmVyVXJpID0gdGhpcy5yZXBvc2l0b3J5LnNlcnZlclVyaTtcbiAgICAvLyBjb25zdCBmdW5jSWQgPSB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlICYmIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuZnVuY0lkIHx8ICcnO1xuICAgIHJldHVybiBgL2FwaS9ydW50aW1lL2NvbW1lbnQvdjEuMC9iaWxsLWNvbW1lbnQvY29tbWVudC9ieUJpbGw/Y29uZmlnSWQ9JHtjb25maWdJZH0mYmlsbElkPSR7aWR9JnBhZ2VTaXplPSR7cGFnZVNpemV9JnBhZ2VJbmRleD0ke3BhZ2VJbmRleH1gO1xuICB9XG4gIC8qKlxuICAgKiDmnoTpgKDojrflj5ZA55So5oi3dXJsXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkUXVlcnlBdFVzZXJzVXJsKHVzZXI/OiBzdHJpbmcsIHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xuICAgIGNvbnN0IHBhcmFtczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAodHlwZW9mIHBhZ2VJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZUluZGV4ID09PSBudWxsKSB7XG4gICAgICBwYWdlSW5kZXggPSB0aGlzLnBhcmFtcy5wYWdlSW5kZXggfHwgMDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBwYWdlU2l6ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZVNpemUgPT09IG51bGwpIHtcbiAgICAgIHBhZ2VTaXplID0gdGhpcy5wYXJhbXMucGFnZVNpemUgfHwgMTAwMDtcbiAgICB9XG4gICAgaWYgKHVzZXIpIHtcbiAgICAgIHBhcmFtcy5wdXNoKGBwYXJhbT0ke3VzZXJ9YCk7XG4gICAgfVxuICAgIHBhcmFtcy5wdXNoKGBwYWdlU2l6ZT0ke3BhZ2VTaXplfWApO1xuICAgIHBhcmFtcy5wdXNoKGBwYWdlSW5kZXg9JHtwYWdlSW5kZXh9YCk7XG4gICAgcmV0dXJuIGAvYXBpL3J1bnRpbWUvY29tbWVudC92MS4wL2JpbGwtY29tbWVudC9hdFVzZXI/JHtwYXJhbXMuam9pbignJicpfWA7XG4gIH1cbiAgcHJpdmF0ZSBidWlsZFF1ZXJ5RnJlcXVlbnRBdFVzZXJzVXJsKHBhZ2VJbmRleD86IG51bWJlciB8IG51bGwsIHBhZ2VTaXplPzogbnVtYmVyIHwgbnVsbCkge1xuICAgIGNvbnN0IHBhcmFtczogc3RyaW5nW10gPSBbXTtcbiAgICBpZiAodHlwZW9mIHBhZ2VJbmRleCA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZUluZGV4ID09PSBudWxsKSB7XG4gICAgICBwYWdlSW5kZXggPSB0aGlzLnBhcmFtcy5wYWdlSW5kZXggfHwgMDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBwYWdlU2l6ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFnZVNpemUgPT09IG51bGwpIHtcbiAgICAgIHBhZ2VTaXplID0gdGhpcy5wYXJhbXMucGFnZVNpemUgfHwgNjtcbiAgICB9XG4gICAgcGFyYW1zLnB1c2goYHBhZ2VTaXplPSR7cGFnZVNpemV9YCk7XG4gICAgcGFyYW1zLnB1c2goYHBhZ2VJbmRleD0ke3BhZ2VJbmRleH1gKTtcbiAgICByZXR1cm4gYC9hcGkvcnVudGltZS9jb21tZW50L3YxLjAvYmlsbC1jb21tZW50L2ZyZXF1ZW50QXRVc2Vycz8ke3BhcmFtcy5qb2luKCcmJyl9YDtcbiAgfVxuICBwcml2YXRlIGJ1aWxkQWRkQ29tbWVudFBhcmFtKGlkOiBzdHJpbmcsIHRleHQ6IHN0cmluZywgcGFyZW50SWQ6IHN0cmluZywgc3VtbWFyeTogc3RyaW5nLCB2aXNpYmlsaXR5OiBzdHJpbmcsIGNvbmZpZ0lkOiBzdHJpbmcpIHtcbiAgICBpZiAodHlwZW9mIHRleHQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICB0ZXh0ID0gdGhpcy5wYXJhbXMudGV4dDtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBwYXJlbnRJZCA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHBhcmVudElkID0gdGhpcy5wYXJhbXMucGFyZW50SWQ7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdmlzaWJpbGl0eSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHZpc2liaWxpdHkgPSB0aGlzLnBhcmFtcy52aXNpYmlsaXR5O1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgJ2JpbGwnOiB7XG4gICAgICAgICdiaWxsSWQnOiBpZCxcbiAgICAgICAgJ2NvbmZpZ0lkJzogY29uZmlnSWQsXG4gICAgICAgICdzdW1tYXJ5Jzogc3VtbWFyeVxuICAgICAgfSxcbiAgICAgICdjb21tZW50Jzoge1xuICAgICAgICAnYmlsbElkJzogaWQsXG4gICAgICAgICdjb25maWdJZCc6IGNvbmZpZ0lkLFxuICAgICAgICAncGFyZW50SWQnOiBwYXJlbnRJZCB8fCBudWxsLFxuICAgICAgICAndGV4dCc6IHRleHQsXG4gICAgICAgICd2aXNpYmlsaXR5JzogdmlzaWJpbGl0eVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19