/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, EventEmitter } from '@angular/core';
import { Subject } from 'rxjs';
import { ColumnFilterType, DatagridUtils } from '@farris/ui-datagrid';
import { FilterOperator } from './operations/operators';
var DatagridFilterRowService = /** @class */ (function () {
    function DatagridFilterRowService() {
        this.columnConditionSubject = new Subject();
        this.filterRowConditions$ = this.columnConditionSubject.asObservable();
        this.columnConditions = {};
        this.filterTextboxChanged = new EventEmitter();
        this.removeField = new EventEmitter();
    }
    /**
     * @param {?} frp
     * @return {?}
     */
    DatagridFilterRowService.prototype.setFilterPanel = /**
     * @param {?} frp
     * @return {?}
     */
    function (frp) {
        this.currentFilterPanel = frp;
    };
    /**
     * @return {?}
     */
    DatagridFilterRowService.prototype.hasFilterPanel = /**
     * @return {?}
     */
    function () {
        return !!this.currentFilterPanel;
    };
    /**
     * @return {?}
     */
    DatagridFilterRowService.prototype.closeFilterPanel = /**
     * @return {?}
     */
    function () {
        if (this.hasFilterPanel()) {
            if (this.currentFilterPanel.instance.documentClickHandle) {
                this.currentFilterPanel.instance.documentClickHandle();
            }
            document.body.removeChild(this.currentFilterPanel.location.nativeElement);
            this.currentFilterPanel.destroy();
            this.currentFilterPanel = null;
            document.body.style.overflow = 'auto';
        }
    };
    /**
     * @param {?=} emitEvent
     * @return {?}
     */
    DatagridFilterRowService.prototype.clear = /**
     * @param {?=} emitEvent
     * @return {?}
     */
    function (emitEvent) {
        if (emitEvent === void 0) { emitEvent = true; }
        this.columnConditions = {};
        if (emitEvent) {
            this.columnConditionSubject.next({});
        }
    };
    /**
     * @param {?} field
     * @param {?=} opts
     * @return {?}
     */
    DatagridFilterRowService.prototype.removeFilterField = /**
     * @param {?} field
     * @param {?=} opts
     * @return {?}
     */
    function (field, opts) {
        if (this.columnConditions) {
            delete this.columnConditions[field];
            if (!opts || (opts && opts.emitEvent)) {
                this.emitColumnConditionChanged(this.columnConditions);
            }
            this.removeField.emit(field);
        }
    };
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    DatagridFilterRowService.prototype._updateColumnConditions = /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    function (field, colCondition) {
        var _this = this;
        var _a, _b;
        /** @type {?} */
        var currentCondition = this.columnConditions[field];
        if (!currentCondition) {
            this.columnConditions = Object.assign(this.columnConditions, (_a = {}, _a[field] = colCondition, _a));
        }
        else {
            if (JSON.stringify(currentCondition) !== JSON.stringify(colCondition)) {
                this.columnConditions = Object.assign(this.columnConditions, (_b = {}, _b[field] = colCondition, _b));
            }
        }
        // 值为 ‘’ ，则代表着不参与查询
        Object.keys(this.columnConditions).forEach((/**
         * @param {?} k
         * @return {?}
         */
        function (k) {
            if (!_this.columnConditions[k]) {
                // delete this.columnConditions[k];
                _this.columnConditions[k] = null;
            }
        }));
    };
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    DatagridFilterRowService.prototype.updateColumnConditions = /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    function (field, colCondition) {
        this._updateColumnConditions(field, colCondition);
        this.emitColumnConditionChanged(this.columnConditions);
    };
    /**
     * @private
     * @param {?} conditions
     * @return {?}
     */
    DatagridFilterRowService.prototype.emitColumnConditionChanged = /**
     * @private
     * @param {?} conditions
     * @return {?}
     */
    function (conditions) {
        // const farr = this.gridInstance.remoteFilter ? this.convert2FilterArray(this.columnConditions) : this.columnConditions;
        this.columnConditionSubject.next(conditions);
    };
    // 获取过滤行显示文本
    // 获取过滤行显示文本
    /**
     * @param {?} column
     * @param {?} condition
     * @return {?}
     */
    DatagridFilterRowService.prototype.condition2string = 
    // 获取过滤行显示文本
    /**
     * @param {?} column
     * @param {?} condition
     * @return {?}
     */
    function (column, condition) {
        if (!condition || typeof condition === 'string') {
            return '';
        }
        /** @type {?} */
        var andText = this.gridInstance.localeService.getValue('datagrid.filter.and');
        /** @type {?} */
        var orText = this.gridInstance.localeService.getValue('datagrid.filter.or');
        /** @type {?} */
        var getRelationLabel = (/**
         * @param {?} r
         * @return {?}
         */
        function (r) {
            if (r === 'and') {
                return andText;
            }
            else if (r === 'or') {
                return orText;
            }
            else {
                return '';
            }
        });
        /** @type {?} */
        var filterPreViewString = '';
        if (column.filter.type === ColumnFilterType.fromdata) {
            filterPreViewString = "(" + condition.value1.length + ")";
            if (condition.value1) {
                filterPreViewString += " " + condition.value1.join(',');
            }
        }
        else if (column.filter.type === ColumnFilterType.enum) {
            /** @type {?} */
            var enumOpts = (/** @type {?} */ (this.getEnumOptions(column)));
            var valueField_1 = enumOpts.valueField, textField_1 = enumOpts.textField, data_1 = enumOpts.data;
            filterPreViewString = "(" + condition.value1.length + ")";
            if (condition.value1) {
                filterPreViewString += " " + condition.value1.map((/**
                 * @param {?} v
                 * @return {?}
                 */
                function (v) {
                    /** @type {?} */
                    var enumItem = data_1.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) { return d[valueField_1] == v; }));
                    return enumItem[textField_1];
                })).join(',');
            }
        }
        else {
            if (condition) {
                /** @type {?} */
                var operator1Label = this.getOperatorLabel(condition.operator1);
                if (!this.isEmpty(condition.value1)) {
                    filterPreViewString = operator1Label + " " + condition.value1;
                    /** @type {?} */
                    var operator2Label = this.getOperatorLabel(condition.operator2);
                    if (!this.isEmpty(condition.value2)) {
                        filterPreViewString += " " + getRelationLabel(condition.relation) + " " + operator2Label + " " + condition.value2;
                    }
                    else {
                        if (condition.operator2 !== undefined) {
                            /** @type {?} */
                            var op2 = parseInt('' + condition.operator2, 10);
                            if (op2 === FilterOperator.Empty || op2 === FilterOperator.NotEmpty) {
                                filterPreViewString += " " + getRelationLabel(condition.relation) + " " + operator2Label;
                            }
                        }
                    }
                }
                else {
                    /** @type {?} */
                    var op1 = parseInt('' + condition.operator1, 10);
                    if (op1 === FilterOperator.Empty || op1 === FilterOperator.NotEmpty) {
                        filterPreViewString = "" + operator1Label;
                    }
                }
            }
        }
        return filterPreViewString;
    };
    /**
     * @private
     * @param {?} v
     * @return {?}
     */
    DatagridFilterRowService.prototype.isEmpty = /**
     * @private
     * @param {?} v
     * @return {?}
     */
    function (v) {
        return v === '' || v === undefined || v === null;
    };
    /**
     * @param {?} column
     * @return {?}
     */
    DatagridFilterRowService.prototype.getEnumOptions = /**
     * @param {?} column
     * @return {?}
     */
    function (column) {
        /** @type {?} */
        var colFilter = (/** @type {?} */ (column.filter));
        /** @type {?} */
        var datatype = colFilter.type;
        /** @type {?} */
        var enumSetting = null;
        if (datatype === ColumnFilterType.enum) {
            /** @type {?} */
            var fmt = (/** @type {?} */ (column.formatter));
            if (fmt) {
                enumSetting = fmt.options;
            }
            else {
                if (colFilter.options) {
                    enumSetting = colFilter.options;
                }
            }
        }
        else { // enum 数据源来自grid 数据列表
            // enum 数据源来自grid 数据列表
            /** @type {?} */
            var columnData = this.gridInstance.dfs.getData(true).map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return DatagridUtils.getValue(column.field, n);
            }));
            // 去除重复
            /** @type {?} */
            var enumData = Array.from(new Set(columnData)).map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return {
                    value: n, label: n
                };
            }));
            enumSetting = {
                valueField: 'value', textField: 'label', data: enumData, idField: 'value'
            };
        }
        return enumSetting;
    };
    // 获取操作符标签
    // 获取操作符标签
    /**
     * @param {?} code
     * @return {?}
     */
    DatagridFilterRowService.prototype.getOperatorLabel = 
    // 获取操作符标签
    /**
     * @param {?} code
     * @return {?}
     */
    function (code) {
        /** @type {?} */
        var strOper = FilterOperator[code];
        if (strOper) {
            /** @type {?} */
            var operName = strOper[0].toLowerCase() + strOper.substr(1);
            /** @type {?} */
            var key = "datagrid.filter.operators." + operName;
            return this.gridInstance.localeService.getValue(key);
        }
        return '';
    };
    DatagridFilterRowService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DatagridFilterRowService.ctorParameters = function () { return []; };
    return DatagridFilterRowService;
}());
export { DatagridFilterRowService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridFilterRowService.prototype.columnConditionSubject;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterRowConditions$;
    /** @type {?} */
    DatagridFilterRowService.prototype.columnConditions;
    /** @type {?} */
    DatagridFilterRowService.prototype.currentFilterPanel;
    /** @type {?} */
    DatagridFilterRowService.prototype.gridInstance;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterTextboxChanged;
    /** @type {?} */
    DatagridFilterRowService.prototype.removeField;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC1maWx0ZXIvIiwic291cmNlcyI6WyJsaWIvZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBQUMsZ0JBQWdCLEVBQWMsYUFBYSxFQUFtQyxNQUFNLHFCQUFxQixDQUFDO0FBRWxILE9BQU8sRUFDZ0IsY0FBYyxFQUFjLE1BQU0sd0JBQXdCLENBQUM7QUFHbEY7SUFZSTtRQVZRLDJCQUFzQixHQUFHLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ25FLHlCQUFvQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxxQkFBZ0IsR0FBMEIsRUFBRSxDQUFDO1FBSzdDLHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO0lBRXpCLENBQUM7Ozs7O0lBRWpCLGlEQUFjOzs7O0lBQWQsVUFBZSxHQUEwQztRQUNyRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0lBQ2xDLENBQUM7Ozs7SUFFRCxpREFBYzs7O0lBQWQ7UUFDSSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUM7SUFDckMsQ0FBQzs7OztJQUVELG1EQUFnQjs7O0lBQWhCO1FBQ0ksSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUU7WUFDdkIsSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFO2dCQUN0RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLG1C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Qzs7SUFDMUMsK0NBQXlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgQ29tcG9uZW50UmVmLCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHtDb2x1bW5GaWx0ZXJUeXBlLCBEYXRhQ29sdW1uLCBEYXRhZ3JpZFV0aWxzLCBEYXRhZ3JpZENvbXBvbmVudCwgQ29sdW1uRmlsdGVyIH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcblxyXG5pbXBvcnQgeyBDb2x1bW5GaWx0ZXJDb25kaXRpb24sIEZpbHRlckNvbmRpdGlvbiwgRmlsdGVyQ29uZGl0aW9uVmFsdWUsIEFsbEZpbHRlck9wZXJhdG9yLFxyXG4gICAgRmlsdGVyRW51bVNldHRpbmcsIEZpbHRlck9wZXJhdG9yLCBGaWx0ZXJEYXRhIH0gZnJvbSAnLi9vcGVyYXRpb25zL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEZpbHRlclJvd1BhbmVsQ29tcG9uZW50IH0gZnJvbSAnLi9maWx0ZXItZWRpdG9ycy9maWx0ZXItcm93LXBhbmVsLmNvbXBvbmVudCc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBEYXRhZ3JpZEZpbHRlclJvd1NlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSBjb2x1bW5Db25kaXRpb25TdWJqZWN0ID0gbmV3IFN1YmplY3Q8RmlsdGVyRGF0YVtdIHwgYW55PigpO1xyXG4gICAgZmlsdGVyUm93Q29uZGl0aW9ucyQgPSB0aGlzLmNvbHVtbkNvbmRpdGlvblN1YmplY3QuYXNPYnNlcnZhYmxlKCk7XHJcbiAgICBjb2x1bW5Db25kaXRpb25zOiBDb2x1bW5GaWx0ZXJDb25kaXRpb24gPSB7fTtcclxuICAgIGN1cnJlbnRGaWx0ZXJQYW5lbDogQ29tcG9uZW50UmVmPEZpbHRlclJvd1BhbmVsQ29tcG9uZW50PjtcclxuXHJcbiAgICBncmlkSW5zdGFuY2U6IERhdGFncmlkQ29tcG9uZW50O1xyXG5cclxuICAgIGZpbHRlclRleHRib3hDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG4gICAgcmVtb3ZlRmllbGQgPSBuZXcgRXZlbnRFbWl0dGVyPHN0cmluZz4oKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHsgfVxyXG5cclxuICAgIHNldEZpbHRlclBhbmVsKGZycDogQ29tcG9uZW50UmVmPEZpbHRlclJvd1BhbmVsQ29tcG9uZW50Pikge1xyXG4gICAgICAgIHRoaXMuY3VycmVudEZpbHRlclBhbmVsID0gZnJwO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc0ZpbHRlclBhbmVsKCkge1xyXG4gICAgICAgIHJldHVybiAhIXRoaXMuY3VycmVudEZpbHRlclBhbmVsO1xyXG4gICAgfVxyXG5cclxuICAgIGNsb3NlRmlsdGVyUGFuZWwoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaGFzRmlsdGVyUGFuZWwoKSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RmlsdGVyUGFuZWwuaW5zdGFuY2UuZG9jdW1lbnRDbGlja0hhbmRsZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwuaW5zdGFuY2UuZG9jdW1lbnRDbGlja0hhbmRsZSgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGhpcy5jdXJyZW50RmlsdGVyUGFuZWwubG9jYXRpb24ubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgICAgIHRoaXMuY3VycmVudEZpbHRlclBhbmVsLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwgPSBudWxsO1xyXG5cclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS5vdmVyZmxvdyA9ICdhdXRvJztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXIoZW1pdEV2ZW50ID0gdHJ1ZSkge1xyXG4gICAgICAgIHRoaXMuY29sdW1uQ29uZGl0aW9ucyA9IHt9O1xyXG4gICAgICAgIGlmIChlbWl0RXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25TdWJqZWN0Lm5leHQoe30pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW1vdmVGaWx0ZXJGaWVsZChmaWVsZDogc3RyaW5nLCBvcHRzPzoge2VtaXRFdmVudDogYm9vbGVhbn0pIHtcclxuICAgICAgICBpZiAodGhpcy5jb2x1bW5Db25kaXRpb25zKSB7XHJcbiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmNvbHVtbkNvbmRpdGlvbnNbZmllbGRdO1xyXG4gICAgICAgICAgICBpZiAoIW9wdHMgfHwgKG9wdHMgJiYgb3B0cy5lbWl0RXZlbnQpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXRDb2x1bW5Db25kaXRpb25DaGFuZ2VkKHRoaXMuY29sdW1uQ29uZGl0aW9ucyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5yZW1vdmVGaWVsZC5lbWl0KGZpZWxkKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgX3VwZGF0ZUNvbHVtbkNvbmRpdGlvbnMoZmllbGQ6IHN0cmluZywgY29sQ29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24gfCBGaWx0ZXJDb25kaXRpb25WYWx1ZSApIHtcclxuICAgICAgICBjb25zdCBjdXJyZW50Q29uZGl0aW9uID0gdGhpcy5jb2x1bW5Db25kaXRpb25zW2ZpZWxkXTtcclxuICAgICAgICBpZiAoIWN1cnJlbnRDb25kaXRpb24pIHtcclxuICAgICAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25zID0gT2JqZWN0LmFzc2lnbih0aGlzLmNvbHVtbkNvbmRpdGlvbnMsIHtbZmllbGRdOiBjb2xDb25kaXRpb259KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoSlNPTi5zdHJpbmdpZnkoY3VycmVudENvbmRpdGlvbikgIT09IEpTT04uc3RyaW5naWZ5KGNvbENvbmRpdGlvbikpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29sdW1uQ29uZGl0aW9ucyA9IE9iamVjdC5hc3NpZ24odGhpcy5jb2x1bW5Db25kaXRpb25zLCB7W2ZpZWxkXTogY29sQ29uZGl0aW9ufSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5YC85Li6IOKAmOKAmSDvvIzliJnku6PooajnnYDkuI3lj4LkuI7mn6Xor6JcclxuICAgICAgICBPYmplY3Qua2V5cyh0aGlzLmNvbHVtbkNvbmRpdGlvbnMpLmZvckVhY2goayA9PiB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5jb2x1bW5Db25kaXRpb25zW2tdKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBkZWxldGUgdGhpcy5jb2x1bW5Db25kaXRpb25zW2tdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25zW2tdID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUNvbHVtbkNvbmRpdGlvbnMoZmllbGQ6IHN0cmluZywgY29sQ29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24gfCBGaWx0ZXJDb25kaXRpb25WYWx1ZSApIHtcclxuICAgICAgICB0aGlzLl91cGRhdGVDb2x1bW5Db25kaXRpb25zKGZpZWxkLCBjb2xDb25kaXRpb24pO1xyXG4gICAgICAgIHRoaXMuZW1pdENvbHVtbkNvbmRpdGlvbkNoYW5nZWQodGhpcy5jb2x1bW5Db25kaXRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGVtaXRDb2x1bW5Db25kaXRpb25DaGFuZ2VkKGNvbmRpdGlvbnMpIHtcclxuICAgICAgICAvLyBjb25zdCBmYXJyID0gdGhpcy5ncmlkSW5zdGFuY2UucmVtb3RlRmlsdGVyID8gdGhpcy5jb252ZXJ0MkZpbHRlckFycmF5KHRoaXMuY29sdW1uQ29uZGl0aW9ucykgOiB0aGlzLmNvbHVtbkNvbmRpdGlvbnM7XHJcbiAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25TdWJqZWN0Lm5leHQoY29uZGl0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W6L+H5ruk6KGM5pi+56S65paH5pysXHJcbiAgICBjb25kaXRpb24yc3RyaW5nKGNvbHVtbjogRGF0YUNvbHVtbiwgY29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24pIHtcclxuICAgICAgICBpZiAoIWNvbmRpdGlvbiB8fCB0eXBlb2YgY29uZGl0aW9uID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBhbmRUZXh0ID0gdGhpcy5ncmlkSW5zdGFuY2UubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZGF0YWdyaWQuZmlsdGVyLmFuZCcpO1xyXG4gICAgICAgIGNvbnN0IG9yVGV4dCA9IHRoaXMuZ3JpZEluc3RhbmNlLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2RhdGFncmlkLmZpbHRlci5vcicpO1xyXG5cclxuICAgICAgICBjb25zdCBnZXRSZWxhdGlvbkxhYmVsID0gKHIpID0+IHtcclxuICAgICAgICAgICAgaWYgKHIgPT09ICdhbmQnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYW5kVGV4dDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChyID09PSAnb3InKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JUZXh0O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGxldCBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gJyc7XHJcbiAgICAgICAgaWYgKGNvbHVtbi5maWx0ZXIudHlwZSA9PT0gQ29sdW1uRmlsdGVyVHlwZS5mcm9tZGF0YSkge1xyXG4gICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCgke2NvbmRpdGlvbi52YWx1ZTEubGVuZ3RofSlgO1xyXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uLnZhbHVlMSkge1xyXG4gICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Y29uZGl0aW9uLnZhbHVlMS5qb2luKCcsJyl9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoY29sdW1uLmZpbHRlci50eXBlID09PSBDb2x1bW5GaWx0ZXJUeXBlLmVudW0pIHtcclxuICAgICAgICAgICAgY29uc3QgZW51bU9wdHMgPSB0aGlzLmdldEVudW1PcHRpb25zKGNvbHVtbikgYXMgRmlsdGVyRW51bVNldHRpbmc7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgdmFsdWVGaWVsZCwgdGV4dEZpZWxkLCBkYXRhIH0gPSBlbnVtT3B0cztcclxuICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAoJHtjb25kaXRpb24udmFsdWUxLmxlbmd0aH0pYDtcclxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi52YWx1ZTEpIHtcclxuICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2NvbmRpdGlvbi52YWx1ZTEubWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVudW1JdGVtID0gZGF0YS5maW5kKGQgPT4gZFt2YWx1ZUZpZWxkXSA9PSB2KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW51bUl0ZW1bdGV4dEZpZWxkXTtcclxuICAgICAgICAgICAgICAgIH0pLmpvaW4oJywnKX1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BlcmF0b3IxTGFiZWwgPSB0aGlzLmdldE9wZXJhdG9yTGFiZWwoY29uZGl0aW9uLm9wZXJhdG9yMSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoICF0aGlzLmlzRW1wdHkoY29uZGl0aW9uLnZhbHVlMSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCR7b3BlcmF0b3IxTGFiZWx9ICR7Y29uZGl0aW9uLnZhbHVlMX1gO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wZXJhdG9yMkxhYmVsID0gdGhpcy5nZXRPcGVyYXRvckxhYmVsKGNvbmRpdGlvbi5vcGVyYXRvcjIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VtcHR5KGNvbmRpdGlvbi52YWx1ZTIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2dldFJlbGF0aW9uTGFiZWwoY29uZGl0aW9uLnJlbGF0aW9uKX0gJHtvcGVyYXRvcjJMYWJlbH0gJHtjb25kaXRpb24udmFsdWUyfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi5vcGVyYXRvcjIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3AyID0gcGFyc2VJbnQoJycgKyBjb25kaXRpb24ub3BlcmF0b3IyLCAxMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AyID09PSBGaWx0ZXJPcGVyYXRvci5FbXB0eSB8fCBvcDIgPT09IEZpbHRlck9wZXJhdG9yLk5vdEVtcHR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Z2V0UmVsYXRpb25MYWJlbChjb25kaXRpb24ucmVsYXRpb24pfSAke29wZXJhdG9yMkxhYmVsfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wMSA9IHBhcnNlSW50KCcnICsgY29uZGl0aW9uLm9wZXJhdG9yMSwgMTApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcDEgPT09IEZpbHRlck9wZXJhdG9yLkVtcHR5IHx8IG9wMSA9PT0gRmlsdGVyT3BlcmF0b3IuTm90RW1wdHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAke29wZXJhdG9yMUxhYmVsfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmaWx0ZXJQcmVWaWV3U3RyaW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNFbXB0eSh2KSB7XHJcbiAgICAgICAgcmV0dXJuIHYgPT09ICcnIHx8IHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXRFbnVtT3B0aW9ucyhjb2x1bW46IERhdGFDb2x1bW4pIHtcclxuICAgICAgICBjb25zdCBjb2xGaWx0ZXIgPSBjb2x1bW4uZmlsdGVyIGFzIENvbHVtbkZpbHRlcjtcclxuICAgICAgICBjb25zdCBkYXRhdHlwZSA9IGNvbEZpbHRlci50eXBlO1xyXG4gICAgICAgIGxldCBlbnVtU2V0dGluZyA9IG51bGw7XHJcbiAgICAgICAgaWYgKGRhdGF0eXBlID09PSBDb2x1bW5GaWx0ZXJUeXBlLmVudW0pIHtcclxuICAgICAgICAgICAgY29uc3QgZm10ID0gY29sdW1uLmZvcm1hdHRlciBhcyBhbnk7XHJcbiAgICAgICAgICAgIGlmIChmbXQpIHtcclxuICAgICAgICAgICAgICAgIGVudW1TZXR0aW5nID0gZm10Lm9wdGlvbnM7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sRmlsdGVyLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtU2V0dGluZyA9IGNvbEZpbHRlci5vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHsgLy8gZW51bSDmlbDmja7mupDmnaXoh6pncmlkIOaVsOaNruWIl+ihqFxyXG4gICAgICAgICAgICBjb25zdCBjb2x1bW5EYXRhOiBzdHJpbmdbXSA9IHRoaXMuZ3JpZEluc3RhbmNlLmRmcy5nZXREYXRhKHRydWUpLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBEYXRhZ3JpZFV0aWxzLmdldFZhbHVlKGNvbHVtbi5maWVsZCwgbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyDljrvpmaTph43lpI1cclxuICAgICAgICAgICAgY29uc3QgZW51bURhdGEgPSBBcnJheS5mcm9tKG5ldyBTZXQoY29sdW1uRGF0YSkpLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG4sIGxhYmVsOiBuXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgZW51bVNldHRpbmcgPSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZUZpZWxkOiAndmFsdWUnLCB0ZXh0RmllbGQ6ICdsYWJlbCcsIGRhdGE6IGVudW1EYXRhLCBpZEZpZWxkOiAndmFsdWUnXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZW51bVNldHRpbmc7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIOiOt+WPluaTjeS9nOespuagh+etvlxyXG4gICAgZ2V0T3BlcmF0b3JMYWJlbChjb2RlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBzdHJPcGVyID0gRmlsdGVyT3BlcmF0b3JbY29kZV07XHJcbiAgICAgICAgaWYgKHN0ck9wZXIpIHtcclxuICAgICAgICAgICAgY29uc3Qgb3Blck5hbWUgPSBzdHJPcGVyWzBdLnRvTG93ZXJDYXNlKCkgKyBzdHJPcGVyLnN1YnN0cigxKTtcclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gYGRhdGFncmlkLmZpbHRlci5vcGVyYXRvcnMuJHtvcGVyTmFtZX1gO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ncmlkSW5zdGFuY2UubG9jYWxlU2VydmljZS5nZXRWYWx1ZShrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==