/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, EventEmitter } from '@angular/core';
import { Subject } from 'rxjs';
import { ColumnFilterType, DatagridUtils } from '@farris/ui-datagrid';
import { FilterOperator } from './operations/operators';
var DatagridFilterRowService = /** @class */ (function () {
    function DatagridFilterRowService() {
        this.columnConditionSubject = new Subject();
        this.filterRowConditions$ = this.columnConditionSubject.asObservable();
        this.columnConditions = {};
        this.filterTextboxChanged = new EventEmitter();
        this.removeField = new EventEmitter();
    }
    /**
     * @param {?} frp
     * @return {?}
     */
    DatagridFilterRowService.prototype.setFilterPanel = /**
     * @param {?} frp
     * @return {?}
     */
    function (frp) {
        this.currentFilterPanel = frp;
    };
    /**
     * @return {?}
     */
    DatagridFilterRowService.prototype.hasFilterPanel = /**
     * @return {?}
     */
    function () {
        return !!this.currentFilterPanel;
    };
    /**
     * @return {?}
     */
    DatagridFilterRowService.prototype.closeFilterPanel = /**
     * @return {?}
     */
    function () {
        if (this.hasFilterPanel()) {
            if (this.currentFilterPanel.instance.documentClickHandle) {
                this.currentFilterPanel.instance.documentClickHandle();
            }
            document.body.removeChild(this.currentFilterPanel.location.nativeElement);
            this.currentFilterPanel.destroy();
            this.currentFilterPanel = null;
        }
    };
    /**
     * @param {?=} emitEvent
     * @return {?}
     */
    DatagridFilterRowService.prototype.clear = /**
     * @param {?=} emitEvent
     * @return {?}
     */
    function (emitEvent) {
        if (emitEvent === void 0) { emitEvent = true; }
        this.columnConditions = {};
        if (emitEvent) {
            this.columnConditionSubject.next({});
        }
    };
    /**
     * @param {?} field
     * @param {?=} opts
     * @return {?}
     */
    DatagridFilterRowService.prototype.removeFilterField = /**
     * @param {?} field
     * @param {?=} opts
     * @return {?}
     */
    function (field, opts) {
        if (this.columnConditions) {
            delete this.columnConditions[field];
            if (!opts || (opts && opts.emitEvent)) {
                this.emitColumnConditionChanged(this.columnConditions);
            }
            this.removeField.emit(field);
        }
    };
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    DatagridFilterRowService.prototype._updateColumnConditions = /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    function (field, colCondition) {
        var _this = this;
        var _a, _b;
        /** @type {?} */
        var currentCondition = this.columnConditions[field];
        if (!currentCondition) {
            this.columnConditions = Object.assign(this.columnConditions, (_a = {}, _a[field] = colCondition, _a));
        }
        else {
            if (JSON.stringify(currentCondition) !== JSON.stringify(colCondition)) {
                this.columnConditions = Object.assign(this.columnConditions, (_b = {}, _b[field] = colCondition, _b));
            }
        }
        // 值为 ‘’ ，则代表着不参与查询
        Object.keys(this.columnConditions).forEach((/**
         * @param {?} k
         * @return {?}
         */
        function (k) {
            if (!_this.columnConditions[k]) {
                delete _this.columnConditions[k];
            }
        }));
    };
    /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    DatagridFilterRowService.prototype.updateColumnConditions = /**
     * @param {?} field
     * @param {?} colCondition
     * @return {?}
     */
    function (field, colCondition) {
        this._updateColumnConditions(field, colCondition);
        this.emitColumnConditionChanged(this.columnConditions);
    };
    /**
     * @private
     * @param {?} conditions
     * @return {?}
     */
    DatagridFilterRowService.prototype.emitColumnConditionChanged = /**
     * @private
     * @param {?} conditions
     * @return {?}
     */
    function (conditions) {
        // const farr = this.gridInstance.remoteFilter ? this.convert2FilterArray(this.columnConditions) : this.columnConditions;
        this.columnConditionSubject.next(conditions);
    };
    // 获取过滤行显示文本
    // 获取过滤行显示文本
    /**
     * @param {?} column
     * @param {?} condition
     * @return {?}
     */
    DatagridFilterRowService.prototype.condition2string = 
    // 获取过滤行显示文本
    /**
     * @param {?} column
     * @param {?} condition
     * @return {?}
     */
    function (column, condition) {
        if (!condition || typeof condition === 'string') {
            return '';
        }
        /** @type {?} */
        var andText = this.gridInstance.localeService.getValue('datagrid.filter.and');
        /** @type {?} */
        var orText = this.gridInstance.localeService.getValue('datagrid.filter.or');
        /** @type {?} */
        var getRelationLabel = (/**
         * @param {?} r
         * @return {?}
         */
        function (r) {
            if (r === 'and') {
                return andText;
            }
            else if (r === 'or') {
                return orText;
            }
            else {
                return '';
            }
        });
        /** @type {?} */
        var filterPreViewString = '';
        if (column.filter.type === ColumnFilterType.fromdata) {
            filterPreViewString = "(" + condition.value1.length + ")";
            if (condition.value1) {
                filterPreViewString += " " + condition.value1.join(',');
            }
        }
        else if (column.filter.type === ColumnFilterType.enum) {
            /** @type {?} */
            var enumOpts = (/** @type {?} */ (this.getEnumOptions(column)));
            var valueField_1 = enumOpts.valueField, textField_1 = enumOpts.textField, data_1 = enumOpts.data;
            filterPreViewString = "(" + condition.value1.length + ")";
            if (condition.value1) {
                filterPreViewString += " " + condition.value1.map((/**
                 * @param {?} v
                 * @return {?}
                 */
                function (v) {
                    /** @type {?} */
                    var enumItem = data_1.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    function (d) { return d[valueField_1] == v; }));
                    return enumItem[textField_1];
                })).join(',');
            }
        }
        else {
            if (condition) {
                /** @type {?} */
                var operator1Label = this.getOperatorLabel(condition.operator1);
                if (!this.isEmpty(condition.value1)) {
                    filterPreViewString = operator1Label + " " + condition.value1;
                    /** @type {?} */
                    var operator2Label = this.getOperatorLabel(condition.operator2);
                    if (!this.isEmpty(condition.value2)) {
                        filterPreViewString += " " + getRelationLabel(condition.relation) + " " + operator2Label + " " + condition.value2;
                    }
                    else {
                        if (condition.operator2 !== undefined) {
                            /** @type {?} */
                            var op2 = parseInt('' + condition.operator2, 10);
                            if (op2 === FilterOperator.Empty || op2 === FilterOperator.NotEmpty) {
                                filterPreViewString += " " + getRelationLabel(condition.relation) + " " + operator2Label;
                            }
                        }
                    }
                }
                else {
                    /** @type {?} */
                    var op1 = parseInt('' + condition.operator1, 10);
                    if (op1 === FilterOperator.Empty || op1 === FilterOperator.NotEmpty) {
                        filterPreViewString = "" + operator1Label;
                    }
                }
            }
        }
        return filterPreViewString;
    };
    /**
     * @private
     * @param {?} v
     * @return {?}
     */
    DatagridFilterRowService.prototype.isEmpty = /**
     * @private
     * @param {?} v
     * @return {?}
     */
    function (v) {
        return v === '' || v === undefined || v === null;
    };
    /**
     * @param {?} column
     * @return {?}
     */
    DatagridFilterRowService.prototype.getEnumOptions = /**
     * @param {?} column
     * @return {?}
     */
    function (column) {
        /** @type {?} */
        var colFilter = (/** @type {?} */ (column.filter));
        /** @type {?} */
        var datatype = colFilter.type;
        /** @type {?} */
        var enumSetting = null;
        if (datatype === ColumnFilterType.enum) {
            /** @type {?} */
            var fmt = (/** @type {?} */ (column.formatter));
            if (fmt) {
                enumSetting = fmt.options;
            }
            else {
                if (colFilter.options) {
                    enumSetting = colFilter.options;
                }
            }
        }
        else { // enum 数据源来自grid 数据列表
            // enum 数据源来自grid 数据列表
            /** @type {?} */
            var columnData = this.gridInstance.dfs.getData(true).map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return DatagridUtils.getValue(column.field, n);
            }));
            // 去除重复
            /** @type {?} */
            var enumData = Array.from(new Set(columnData)).map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return {
                    value: n, label: n
                };
            }));
            enumSetting = {
                valueField: 'value', textField: 'label', data: enumData, idField: 'value'
            };
        }
        return enumSetting;
    };
    // 获取操作符标签
    // 获取操作符标签
    /**
     * @param {?} code
     * @return {?}
     */
    DatagridFilterRowService.prototype.getOperatorLabel = 
    // 获取操作符标签
    /**
     * @param {?} code
     * @return {?}
     */
    function (code) {
        /** @type {?} */
        var strOper = FilterOperator[code];
        if (strOper) {
            /** @type {?} */
            var operName = strOper[0].toLowerCase() + strOper.substr(1);
            /** @type {?} */
            var key = "datagrid.filter.operators." + operName;
            return this.gridInstance.localeService.getValue(key);
        }
        return '';
    };
    DatagridFilterRowService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    DatagridFilterRowService.ctorParameters = function () { return []; };
    return DatagridFilterRowService;
}());
export { DatagridFilterRowService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridFilterRowService.prototype.columnConditionSubject;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterRowConditions$;
    /** @type {?} */
    DatagridFilterRowService.prototype.columnConditions;
    /** @type {?} */
    DatagridFilterRowService.prototype.currentFilterPanel;
    /** @type {?} */
    DatagridFilterRowService.prototype.gridInstance;
    /** @type {?} */
    DatagridFilterRowService.prototype.filterTextboxChanged;
    /** @type {?} */
    DatagridFilterRowService.prototype.removeField;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC1maWx0ZXIvIiwic291cmNlcyI6WyJsaWIvZGF0YWdyaWQtZmlsdGVyLXJvdy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBQUMsZ0JBQWdCLEVBQWMsYUFBYSxFQUFtQyxNQUFNLHFCQUFxQixDQUFDO0FBRWxILE9BQU8sRUFDZ0IsY0FBYyxFQUFjLE1BQU0sd0JBQXdCLENBQUM7QUFHbEY7SUFZSTtRQVZRLDJCQUFzQixHQUFHLElBQUksT0FBTyxFQUFzQixDQUFDO1FBQ25FLHlCQUFvQixHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUNsRSxxQkFBZ0IsR0FBMEIsRUFBRSxDQUFDO1FBSzdDLHlCQUFvQixHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDMUMsZ0JBQVcsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO0lBRXpCLENBQUM7Ozs7O0lBRWpCLGlEQUFjOzs7O0lBQWQsVUFBZSxHQUEwQztRQUNyRCxJQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxDQUFDO0lBQ2xDLENBQUM7Ozs7SUFFRCxpREFBYzs7O0lBQWQ7UUFDSSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUM7SUFDckMsQ0FBQzs7OztJQUVELG1EQUFnQjs7O0lBQWhCO1FBQ0ksSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUU7WUFDdkIsSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFO2dCQUN0RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLG1C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RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQge0NvbHVtbkZpbHRlclR5cGUsIERhdGFDb2x1bW4sIERhdGFncmlkVXRpbHMsIERhdGFncmlkQ29tcG9uZW50LCBDb2x1bW5GaWx0ZXIgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuXHJcbmltcG9ydCB7IENvbHVtbkZpbHRlckNvbmRpdGlvbiwgRmlsdGVyQ29uZGl0aW9uLCBGaWx0ZXJDb25kaXRpb25WYWx1ZSwgQWxsRmlsdGVyT3BlcmF0b3IsXHJcbiAgICBGaWx0ZXJFbnVtU2V0dGluZywgRmlsdGVyT3BlcmF0b3IsIEZpbHRlckRhdGEgfSBmcm9tICcuL29wZXJhdGlvbnMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRmlsdGVyUm93UGFuZWxDb21wb25lbnQgfSBmcm9tICcuL2ZpbHRlci1lZGl0b3JzL2ZpbHRlci1yb3ctcGFuZWwuY29tcG9uZW50JztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkRmlsdGVyUm93U2VydmljZSB7XHJcbiAgICBwcml2YXRlIGNvbHVtbkNvbmRpdGlvblN1YmplY3QgPSBuZXcgU3ViamVjdDxGaWx0ZXJEYXRhW10gfCBhbnk+KCk7XHJcbiAgICBmaWx0ZXJSb3dDb25kaXRpb25zJCA9IHRoaXMuY29sdW1uQ29uZGl0aW9uU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICAgIGNvbHVtbkNvbmRpdGlvbnM6IENvbHVtbkZpbHRlckNvbmRpdGlvbiA9IHt9O1xyXG4gICAgY3VycmVudEZpbHRlclBhbmVsOiBDb21wb25lbnRSZWY8RmlsdGVyUm93UGFuZWxDb21wb25lbnQ+O1xyXG5cclxuICAgIGdyaWRJbnN0YW5jZTogRGF0YWdyaWRDb21wb25lbnQ7XHJcblxyXG4gICAgZmlsdGVyVGV4dGJveENoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XHJcbiAgICByZW1vdmVGaWVsZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkgeyB9XHJcblxyXG4gICAgc2V0RmlsdGVyUGFuZWwoZnJwOiBDb21wb25lbnRSZWY8RmlsdGVyUm93UGFuZWxDb21wb25lbnQ+KSB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwgPSBmcnA7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzRmlsdGVyUGFuZWwoKSB7XHJcbiAgICAgICAgcmV0dXJuICEhdGhpcy5jdXJyZW50RmlsdGVyUGFuZWw7XHJcbiAgICB9XHJcblxyXG4gICAgY2xvc2VGaWx0ZXJQYW5lbCgpIHtcclxuICAgICAgICBpZiAodGhpcy5oYXNGaWx0ZXJQYW5lbCgpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5pbnN0YW5jZS5kb2N1bWVudENsaWNrSGFuZGxlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5pbnN0YW5jZS5kb2N1bWVudENsaWNrSGFuZGxlKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZCh0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbC5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICAgICAgdGhpcy5jdXJyZW50RmlsdGVyUGFuZWwuZGVzdHJveSgpO1xyXG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRGaWx0ZXJQYW5lbCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyKGVtaXRFdmVudCA9IHRydWUpIHtcclxuICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnMgPSB7fTtcclxuICAgICAgICBpZiAoZW1pdEV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sdW1uQ29uZGl0aW9uU3ViamVjdC5uZXh0KHt9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlRmlsdGVyRmllbGQoZmllbGQ6IHN0cmluZywgb3B0cz86IHtlbWl0RXZlbnQ6IGJvb2xlYW59KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuY29sdW1uQ29uZGl0aW9ucykge1xyXG4gICAgICAgICAgICBkZWxldGUgdGhpcy5jb2x1bW5Db25kaXRpb25zW2ZpZWxkXTtcclxuICAgICAgICAgICAgaWYgKCFvcHRzIHx8IChvcHRzICYmIG9wdHMuZW1pdEV2ZW50KSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0Q29sdW1uQ29uZGl0aW9uQ2hhbmdlZCh0aGlzLmNvbHVtbkNvbmRpdGlvbnMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlRmllbGQuZW1pdChmaWVsZCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIF91cGRhdGVDb2x1bW5Db25kaXRpb25zKGZpZWxkOiBzdHJpbmcsIGNvbENvbmRpdGlvbjogRmlsdGVyQ29uZGl0aW9uIHwgRmlsdGVyQ29uZGl0aW9uVmFsdWUgKSB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudENvbmRpdGlvbiA9IHRoaXMuY29sdW1uQ29uZGl0aW9uc1tmaWVsZF07XHJcbiAgICAgICAgaWYgKCFjdXJyZW50Q29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sdW1uQ29uZGl0aW9ucyA9IE9iamVjdC5hc3NpZ24odGhpcy5jb2x1bW5Db25kaXRpb25zLCB7W2ZpZWxkXTogY29sQ29uZGl0aW9ufSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKEpTT04uc3RyaW5naWZ5KGN1cnJlbnRDb25kaXRpb24pICE9PSBKU09OLnN0cmluZ2lmeShjb2xDb25kaXRpb24pKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNvbHVtbkNvbmRpdGlvbnMgPSBPYmplY3QuYXNzaWduKHRoaXMuY29sdW1uQ29uZGl0aW9ucywge1tmaWVsZF06IGNvbENvbmRpdGlvbn0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOWAvOS4uiDigJjigJkg77yM5YiZ5Luj6KGo552A5LiN5Y+C5LiO5p+l6K+iXHJcbiAgICAgICAgT2JqZWN0LmtleXModGhpcy5jb2x1bW5Db25kaXRpb25zKS5mb3JFYWNoKGsgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29sdW1uQ29uZGl0aW9uc1trXSkge1xyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY29sdW1uQ29uZGl0aW9uc1trXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZUNvbHVtbkNvbmRpdGlvbnMoZmllbGQ6IHN0cmluZywgY29sQ29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24gfCBGaWx0ZXJDb25kaXRpb25WYWx1ZSApIHtcclxuICAgICAgICB0aGlzLl91cGRhdGVDb2x1bW5Db25kaXRpb25zKGZpZWxkLCBjb2xDb25kaXRpb24pO1xyXG4gICAgICAgIHRoaXMuZW1pdENvbHVtbkNvbmRpdGlvbkNoYW5nZWQodGhpcy5jb2x1bW5Db25kaXRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGVtaXRDb2x1bW5Db25kaXRpb25DaGFuZ2VkKGNvbmRpdGlvbnMpIHtcclxuICAgICAgICAvLyBjb25zdCBmYXJyID0gdGhpcy5ncmlkSW5zdGFuY2UucmVtb3RlRmlsdGVyID8gdGhpcy5jb252ZXJ0MkZpbHRlckFycmF5KHRoaXMuY29sdW1uQ29uZGl0aW9ucykgOiB0aGlzLmNvbHVtbkNvbmRpdGlvbnM7XHJcbiAgICAgICAgdGhpcy5jb2x1bW5Db25kaXRpb25TdWJqZWN0Lm5leHQoY29uZGl0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g6I635Y+W6L+H5ruk6KGM5pi+56S65paH5pysXHJcbiAgICBjb25kaXRpb24yc3RyaW5nKGNvbHVtbjogRGF0YUNvbHVtbiwgY29uZGl0aW9uOiBGaWx0ZXJDb25kaXRpb24pIHtcclxuICAgICAgICBpZiAoIWNvbmRpdGlvbiB8fCB0eXBlb2YgY29uZGl0aW9uID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBhbmRUZXh0ID0gdGhpcy5ncmlkSW5zdGFuY2UubG9jYWxlU2VydmljZS5nZXRWYWx1ZSgnZGF0YWdyaWQuZmlsdGVyLmFuZCcpO1xyXG4gICAgICAgIGNvbnN0IG9yVGV4dCA9IHRoaXMuZ3JpZEluc3RhbmNlLmxvY2FsZVNlcnZpY2UuZ2V0VmFsdWUoJ2RhdGFncmlkLmZpbHRlci5vcicpO1xyXG5cclxuICAgICAgICBjb25zdCBnZXRSZWxhdGlvbkxhYmVsID0gKHIpID0+IHtcclxuICAgICAgICAgICAgaWYgKHIgPT09ICdhbmQnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYW5kVGV4dDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChyID09PSAnb3InKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JUZXh0O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICAnJztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGxldCBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gJyc7XHJcbiAgICAgICAgaWYgKGNvbHVtbi5maWx0ZXIudHlwZSA9PT0gQ29sdW1uRmlsdGVyVHlwZS5mcm9tZGF0YSkge1xyXG4gICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCgke2NvbmRpdGlvbi52YWx1ZTEubGVuZ3RofSlgO1xyXG4gICAgICAgICAgICBpZiAoY29uZGl0aW9uLnZhbHVlMSkge1xyXG4gICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Y29uZGl0aW9uLnZhbHVlMS5qb2luKCcsJyl9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoY29sdW1uLmZpbHRlci50eXBlID09PSBDb2x1bW5GaWx0ZXJUeXBlLmVudW0pIHtcclxuICAgICAgICAgICAgY29uc3QgZW51bU9wdHMgPSB0aGlzLmdldEVudW1PcHRpb25zKGNvbHVtbikgYXMgRmlsdGVyRW51bVNldHRpbmc7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgdmFsdWVGaWVsZCwgdGV4dEZpZWxkLCBkYXRhIH0gPSBlbnVtT3B0cztcclxuICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAoJHtjb25kaXRpb24udmFsdWUxLmxlbmd0aH0pYDtcclxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi52YWx1ZTEpIHtcclxuICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2NvbmRpdGlvbi52YWx1ZTEubWFwKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVudW1JdGVtID0gZGF0YS5maW5kKGQgPT4gZFt2YWx1ZUZpZWxkXSA9PSB2KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZW51bUl0ZW1bdGV4dEZpZWxkXTtcclxuICAgICAgICAgICAgICAgIH0pLmpvaW4oJywnKX1gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BlcmF0b3IxTGFiZWwgPSB0aGlzLmdldE9wZXJhdG9yTGFiZWwoY29uZGl0aW9uLm9wZXJhdG9yMSk7XHJcbiAgICAgICAgICAgICAgICBpZiAoICF0aGlzLmlzRW1wdHkoY29uZGl0aW9uLnZhbHVlMSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXJQcmVWaWV3U3RyaW5nID0gYCR7b3BlcmF0b3IxTGFiZWx9ICR7Y29uZGl0aW9uLnZhbHVlMX1gO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wZXJhdG9yMkxhYmVsID0gdGhpcy5nZXRPcGVyYXRvckxhYmVsKGNvbmRpdGlvbi5vcGVyYXRvcjIpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VtcHR5KGNvbmRpdGlvbi52YWx1ZTIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbHRlclByZVZpZXdTdHJpbmcgKz0gYCAke2dldFJlbGF0aW9uTGFiZWwoY29uZGl0aW9uLnJlbGF0aW9uKX0gJHtvcGVyYXRvcjJMYWJlbH0gJHtjb25kaXRpb24udmFsdWUyfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbmRpdGlvbi5vcGVyYXRvcjIgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3AyID0gcGFyc2VJbnQoJycgKyBjb25kaXRpb24ub3BlcmF0b3IyLCAxMCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3AyID09PSBGaWx0ZXJPcGVyYXRvci5FbXB0eSB8fCBvcDIgPT09IEZpbHRlck9wZXJhdG9yLk5vdEVtcHR5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyArPSBgICR7Z2V0UmVsYXRpb25MYWJlbChjb25kaXRpb24ucmVsYXRpb24pfSAke29wZXJhdG9yMkxhYmVsfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wMSA9IHBhcnNlSW50KCcnICsgY29uZGl0aW9uLm9wZXJhdG9yMSwgMTApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChvcDEgPT09IEZpbHRlck9wZXJhdG9yLkVtcHR5IHx8IG9wMSA9PT0gRmlsdGVyT3BlcmF0b3IuTm90RW1wdHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsdGVyUHJlVmlld1N0cmluZyA9IGAke29wZXJhdG9yMUxhYmVsfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmaWx0ZXJQcmVWaWV3U3RyaW5nO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNFbXB0eSh2KSB7XHJcbiAgICAgICAgcmV0dXJuIHYgPT09ICcnIHx8IHYgPT09IHVuZGVmaW5lZCB8fCB2ID09PSBudWxsO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXRFbnVtT3B0aW9ucyhjb2x1bW46IERhdGFDb2x1bW4pIHtcclxuICAgICAgICBjb25zdCBjb2xGaWx0ZXIgPSBjb2x1bW4uZmlsdGVyIGFzIENvbHVtbkZpbHRlcjtcclxuICAgICAgICBjb25zdCBkYXRhdHlwZSA9IGNvbEZpbHRlci50eXBlO1xyXG4gICAgICAgIGxldCBlbnVtU2V0dGluZyA9IG51bGw7XHJcbiAgICAgICAgaWYgKGRhdGF0eXBlID09PSBDb2x1bW5GaWx0ZXJUeXBlLmVudW0pIHtcclxuICAgICAgICAgICAgY29uc3QgZm10ID0gY29sdW1uLmZvcm1hdHRlciBhcyBhbnk7XHJcbiAgICAgICAgICAgIGlmIChmbXQpIHtcclxuICAgICAgICAgICAgICAgIGVudW1TZXR0aW5nID0gZm10Lm9wdGlvbnM7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29sRmlsdGVyLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICBlbnVtU2V0dGluZyA9IGNvbEZpbHRlci5vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHsgLy8gZW51bSDmlbDmja7mupDmnaXoh6pncmlkIOaVsOaNruWIl+ihqFxyXG4gICAgICAgICAgICBjb25zdCBjb2x1bW5EYXRhOiBzdHJpbmdbXSA9IHRoaXMuZ3JpZEluc3RhbmNlLmRmcy5nZXREYXRhKHRydWUpLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBEYXRhZ3JpZFV0aWxzLmdldFZhbHVlKGNvbHVtbi5maWVsZCwgbik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAvLyDljrvpmaTph43lpI1cclxuICAgICAgICAgICAgY29uc3QgZW51bURhdGEgPSBBcnJheS5mcm9tKG5ldyBTZXQoY29sdW1uRGF0YSkpLm1hcChuID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG4sIGxhYmVsOiBuXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgZW51bVNldHRpbmcgPSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZUZpZWxkOiAndmFsdWUnLCB0ZXh0RmllbGQ6ICdsYWJlbCcsIGRhdGE6IGVudW1EYXRhLCBpZEZpZWxkOiAndmFsdWUnXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZW51bVNldHRpbmc7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIC8vIOiOt+WPluaTjeS9nOespuagh+etvlxyXG4gICAgZ2V0T3BlcmF0b3JMYWJlbChjb2RlOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBzdHJPcGVyID0gRmlsdGVyT3BlcmF0b3JbY29kZV07XHJcbiAgICAgICAgaWYgKHN0ck9wZXIpIHtcclxuICAgICAgICAgICAgY29uc3Qgb3Blck5hbWUgPSBzdHJPcGVyWzBdLnRvTG93ZXJDYXNlKCkgKyBzdHJPcGVyLnN1YnN0cigxKTtcclxuICAgICAgICAgICAgY29uc3Qga2V5ID0gYGRhdGFncmlkLmZpbHRlci5vcGVyYXRvcnMuJHtvcGVyTmFtZX1gO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5ncmlkSW5zdGFuY2UubG9jYWxlU2VydmljZS5nZXRWYWx1ZShrZXkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==