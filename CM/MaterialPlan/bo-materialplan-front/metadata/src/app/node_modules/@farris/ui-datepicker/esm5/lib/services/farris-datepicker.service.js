/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { PX, EMPTY_STR } from '../constants/constants';
import { Year } from '../enums/year.enum';
import { UtilService } from './farris-datepicker.util.service';
var DatePickerService = /** @class */ (function () {
    function DatePickerService(opts) {
        this._mouseWheelHandle = null;
        this._mouseScrollHandle = null;
        this.opts = opts;
        this.utilService = new UtilService();
    }
    /**
     * @param {?} opts
     * @param {?} defaultOpts
     * @return {?}
     */
    DatePickerService.parseOptions = /**
     * @param {?} opts
     * @param {?} defaultOpts
     * @return {?}
     */
    function (opts, defaultOpts) {
        if (defaultOpts !== undefined) {
            Object.keys(defaultOpts).forEach((/**
             * @param {?} k
             * @return {?}
             */
            function (k) {
                if (defaultOpts[k] !== undefined && defaultOpts[k] !== '') {
                    ((/** @type {?} */ (opts)))[k] = defaultOpts[k];
                }
            }));
        }
        if (opts.minYear < Year.min) {
            opts.minYear = Year.min;
        }
        if (opts.maxYear > Year.max) {
            opts.maxYear = Year.max;
        }
        return opts;
    };
    /**
     * @param {?} value
     * @return {?}
     */
    DatePickerService.prototype.validate = /**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        var dateRange = this.opts.dateRange;
        /** @type {?} */
        var valid = false;
        if (!dateRange) {
            /** @type {?} */
            var date = this.utilService.isDateValid(value, this.opts);
            valid = this.utilService.isInitializedDate(date);
        }
        else {
            /** @type {?} */
            var _dateRange = this.utilService.isDateValidDateRange(value, this.opts);
            var begin = _dateRange.begin, end = _dateRange.end;
            valid = this.utilService.isInitializedDate(begin) && this.utilService.isInitializedDate(end);
        }
        return valid;
    };
    /**
     * @param {?} fn
     * @return {?}
     */
    DatePickerService.prototype.registerScrollEvent = /**
     * @param {?} fn
     * @return {?}
     */
    function (fn) {
        this._mouseScrollHandle = fn;
        document.addEventListener('scroll', this._mouseScrollHandle);
    };
    /**
     * @return {?}
     */
    DatePickerService.prototype.removeMouseEvent = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var container = document.querySelector('.date-overlay-container');
        if (container) {
            container.removeEventListener('mousewheel', this._mouseWheelHandle);
        }
        document.removeEventListener('scroll', this._mouseScrollHandle);
    };
    /**
     * @param {?} elem
     * @return {?}
     */
    DatePickerService.prototype.appendSelector = /**
     * @param {?} elem
     * @return {?}
     */
    function (elem) {
        /** @type {?} */
        var container = document.querySelector('.date-overlay-container');
        if (container) {
            if (container.hasChildNodes()) {
                container.childNodes.forEach((/**
                 * @param {?} el
                 * @return {?}
                 */
                function (el) {
                    if (el !== elem) {
                        container.removeChild(el);
                    }
                }));
            }
        }
        else {
            container = document.createElement('div');
            container.classList.add('date-overlay-container');
            container.classList.add('overlay-container');
            document.body.appendChild(container);
        }
        container.addEventListener('mousewheel', this._mouseWheelHandle = (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            /** @type {?} */
            var target = (/** @type {?} */ (e.target));
            if (!target.closest('.calendar-time-picker-select')) {
                e.preventDefault();
            }
            return;
        }));
        container.appendChild(elem);
    };
    /**
     * @param {?} elem
     * @param {?=} calendarRef
     * @return {?}
     */
    DatePickerService.prototype.getSelectorPosition = /**
     * @param {?} elem
     * @param {?=} calendarRef
     * @return {?}
     */
    function (elem, calendarRef) {
        if (calendarRef === void 0) { calendarRef = null; }
        /** @type {?} */
        var top = 0;
        /** @type {?} */
        var left = 0;
        /** @type {?} */
        var _selectorHeight = 0;
        /** @type {?} */
        var _selectorWidth = 0;
        var _a = this.opts, selectorHeight = _a.selectorHeight, selectorWidth = _a.selectorWidth, showTime = _a.showTime, dateRange = _a.dateRange, showType = _a.showType, enableDynamic = _a.enableDynamic, showPresent = _a.showPresent;
        /** @type {?} */
        var b = document.body.getBoundingClientRect();
        /** @type {?} */
        var e = elem.getBoundingClientRect();
        top = e.top - b.top;
        left = e.left - b.left;
        /** @type {?} */
        var position = 'bottom';
        if (dateRange && showType !== 4) {
            _selectorWidth = this.getSelectorDimension(selectorWidth) * 2;
        }
        else {
            _selectorWidth = this.getSelectorDimension(selectorWidth);
        }
        _selectorHeight = this.getSelectorDimension(selectorHeight);
        // if (showTime || enableDynamic) {
        //     top = top - 6;
        // }
        top = top - 6;
        if ((showPresent && (!dateRange || showType === 4)) || showTime || enableDynamic) {
            _selectorHeight += 45;
        }
        if (top + elem.offsetHeight + _selectorHeight > window.innerHeight && top - _selectorHeight - 2 > 0) {
            top = top - _selectorHeight - 2;
            position = 'top';
        }
        else {
            top = top + elem.offsetHeight + 2;
        }
        if (window.innerHeight - top < _selectorHeight) {
            top = top - (_selectorHeight - (window.innerHeight - e.top - e.height - 15));
            if (calendarRef) {
                /** @type {?} */
                var calendarElem = calendarRef.location.nativeElement;
                /** @type {?} */
                var arrow = calendarElem.querySelector('.arrow');
                if (arrow) {
                    arrow.style.display = 'none';
                }
            }
        }
        if (left + _selectorWidth > b.width) {
            left = b.width - _selectorWidth - 15;
        }
        left = left > 0 ? left : 0;
        /** @type {?} */
        var scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
        top -= scrollTop;
        return { top: top, left: left, position: position };
    };
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    DatePickerService.prototype.getSelectorDimension = /**
     * @private
     * @param {?} value
     * @return {?}
     */
    function (value) {
        return Number(value.replace(PX, EMPTY_STR));
    };
    return DatePickerService;
}());
export { DatePickerService };
if (false) {
    /** @type {?} */
    DatePickerService.prototype.opts;
    /** @type {?} */
    DatePickerService.prototype.utilService;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseWheelHandle;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseScrollHandle;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWRhdGVwaWNrZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0ZXBpY2tlci8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9mYXJyaXMtZGF0ZXBpY2tlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHL0Q7SUFPSSwyQkFBWSxJQUFJO1FBSFIsc0JBQWlCLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLHVCQUFrQixHQUFHLElBQUksQ0FBQztRQUc5QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7SUFDekMsQ0FBQzs7Ozs7O0lBRU0sOEJBQVk7Ozs7O0lBQW5CLFVBQW9CLElBQWdCLEVBQUUsV0FBVztRQUM3QyxJQUFJLFdBQVcsS0FBSyxTQUFTLEVBQUU7WUFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPOzs7O1lBQUMsVUFBQSxDQUFDO2dCQUM5QixJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtvQkFDdkQsQ0FBQyxtQkFBQSxJQUFJLEVBQWMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDNUM7WUFDTCxDQUFDLEVBQUMsQ0FBQztTQUNOO1FBQ0QsSUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDekIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJ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QyxTQUFTLElBQUksUUFBUSxDQUFDLGVBQWUsQ0FBQyxTQUFTO1FBQy9FLEdBQUcsSUFBSSxTQUFTLENBQUM7UUFFakIsT0FBTyxFQUFFLEdBQUcsS0FBQSxFQUFFLElBQUksTUFBQSxFQUFFLFFBQVEsVUFBQSxFQUFFLENBQUM7SUFDbkMsQ0FBQzs7Ozs7O0lBQ08sZ0RBQW9COzs7OztJQUE1QixVQUE2QixLQUFhO1FBQ3RDLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7SUFDaEQsQ0FBQztJQUVMLHdCQUFDO0FBQUQsQ0FBQyxBQTlKRCxJQThKQzs7OztJQTdKRyxpQ0FBSzs7SUFDTCx3Q0FBWTs7Ozs7SUFFWiw4Q0FBaUM7Ozs7O0lBQ2pDLCtDQUFrQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElNeURhdGUsIElNeURhdGVSYW5nZSwgSU15U2VsZWN0b3JQb3NpdGlvbiwgSU15T3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvcHVibGljLWFwaSc7XHJcbmltcG9ydCB7IFBYLCBFTVBUWV9TVFIgfSBmcm9tICcuLi9jb25zdGFudHMvY29uc3RhbnRzJztcclxuaW1wb3J0IHsgWWVhciB9IGZyb20gJy4uL2VudW1zL3llYXIuZW51bSc7XHJcbmltcG9ydCB7IFV0aWxTZXJ2aWNlIH0gZnJvbSAnLi9mYXJyaXMtZGF0ZXBpY2tlci51dGlsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBEYXRlUGlja2VyU2VydmljZSB7XHJcbiAgICBvcHRzO1xyXG4gICAgdXRpbFNlcnZpY2U7XHJcblxyXG4gICAgcHJpdmF0ZSBfbW91c2VXaGVlbEhhbmRsZSA9IG51bGw7XHJcbiAgICBwcml2YXRlIF9tb3VzZVNjcm9sbEhhbmRsZSA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3Iob3B0cykge1xyXG4gICAgICAgIHRoaXMub3B0cyA9IG9wdHM7XHJcbiAgICAgICAgdGhpcy51dGlsU2VydmljZSA9IG5ldyBVdGlsU2VydmljZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBwYXJzZU9wdGlvbnMob3B0czogSU15T3B0aW9ucywgZGVmYXVsdE9wdHMpOiBJTXlPcHRpb25zIHtcclxuICAgICAgICBpZiAoZGVmYXVsdE9wdHMgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhkZWZhdWx0T3B0cykuZm9yRWFjaChrID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0T3B0c1trXSAhPT0gdW5kZWZpbmVkICYmIGRlZmF1bHRPcHRzW2tdICE9PSAnJykge1xyXG4gICAgICAgICAgICAgICAgICAgIChvcHRzIGFzIElNeU9wdGlvbnMpW2tdID0gZGVmYXVsdE9wdHNba107XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0cy5taW5ZZWFyIDwgWWVhci5taW4pIHtcclxuICAgICAgICAgICAgb3B0cy5taW5ZZWFyID0gWWVhci5taW47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRzLm1heFllYXIgPiBZZWFyLm1heCkge1xyXG4gICAgICAgICAgICBvcHRzLm1heFllYXIgPSBZZWFyLm1heDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG9wdHM7XHJcbiAgICB9XHJcblxyXG4gICAgdmFsaWRhdGUodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHsgZGF0ZVJhbmdlIH0gPSB0aGlzLm9wdHM7XHJcblxyXG4gICAgICAgIGxldCB2YWxpZCA9IGZhbHNlO1xyXG4gICAgICAgIGlmICghZGF0ZVJhbmdlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGU6IElNeURhdGUgPSB0aGlzLnV0aWxTZXJ2aWNlLmlzRGF0ZVZhbGlkKHZhbHVlLCB0aGlzLm9wdHMpO1xyXG5cclxuICAgICAgICAgICAgdmFsaWQgPSB0aGlzLnV0aWxTZXJ2aWNlLmlzSW5pdGlhbGl6ZWREYXRlKGRhdGUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IF9kYXRlUmFuZ2U6IElNeURhdGVSYW5nZSA9IHRoaXMudXRpbFNlcnZpY2UuaXNEYXRlVmFsaWREYXRlUmFuZ2UodmFsdWUsIHRoaXMub3B0cyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgYmVnaW4sIGVuZCB9ID0gX2RhdGVSYW5nZTtcclxuICAgICAgICAgICAgdmFsaWQgPSB0aGlzLnV0aWxTZXJ2aWNlLmlzSW5pdGlhbGl6ZWREYXRlKGJlZ2luKSAmJiB0aGlzLnV0aWxTZXJ2aWNlLmlzSW5pdGlhbGl6ZWREYXRlKGVuZCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmVnaXN0ZXJTY3JvbGxFdmVudChmbikge1xyXG4gICAgICAgIHRoaXMuX21vdXNlU2Nyb2xsSGFuZGxlID0gZm47XHJcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5fbW91c2VTY3JvbGxIYW5kbGUpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICByZW1vdmVNb3VzZUV2ZW50KCkge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kYXRlLW92ZXJsYXktY29udGFpbmVyJyk7XHJcbiAgICAgICAgaWYgKGNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHRoaXMuX21vdXNlV2hlZWxIYW5kbGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5fbW91c2VTY3JvbGxIYW5kbGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGFwcGVuZFNlbGVjdG9yKGVsZW06IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGxldCBjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZGF0ZS1vdmVybGF5LWNvbnRhaW5lcicpO1xyXG4gICAgICAgIGlmIChjb250YWluZXIpIHtcclxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5oYXNDaGlsZE5vZGVzKCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jaGlsZE5vZGVzLmZvckVhY2goZWwgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlbCAhPT0gZWxlbSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoZWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdkYXRlLW92ZXJsYXktY29udGFpbmVyJyk7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdvdmVybGF5LWNvbnRhaW5lcicpO1xyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNvbnRhaW5lcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHRoaXMuX21vdXNlV2hlZWxIYW5kbGUgPSAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldCBhcyBhbnk7XHJcbiAgICAgICAgICAgIGlmICghdGFyZ2V0LmNsb3Nlc3QoJy5jYWxlbmRhci10aW1lLXBpY2tlci1zZWxlY3QnKSkge1xyXG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGVsZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNlbGVjdG9yUG9zaXRpb24oZWxlbTogYW55LCBjYWxlbmRhclJlZjogQ29tcG9uZW50UmVmPGFueT4gID0gbnVsbCk6IElNeVNlbGVjdG9yUG9zaXRpb24ge1xyXG4gICAgICAgIGxldCB0b3AgPSAwO1xyXG4gICAgICAgIGxldCBsZWZ0ID0gMDtcclxuICAgICAgICBsZXQgX3NlbGVjdG9ySGVpZ2h0ID0gMDtcclxuICAgICAgICBsZXQgX3NlbGVjdG9yV2lkdGggPSAwO1xyXG4gICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgICAgc2VsZWN0b3JIZWlnaHQsXHJcbiAgICAgICAgICAgIHNlbGVjdG9yV2lkdGgsXHJcbiAgICAgICAgICAgIHNob3dUaW1lLFxyXG4gICAgICAgICAgICBkYXRlUmFuZ2UsXHJcbiAgICAgICAgICAgIHNob3dUeXBlLFxyXG4gICAgICAgICAgICBlbmFibGVEeW5hbWljLFxyXG4gICAgICAgICAgICBzaG93UHJlc2VudFxyXG4gICAgICAgIH0gPSB0aGlzLm9wdHM7XHJcblxyXG4gICAgICAgIGNvbnN0IGI6IGFueSA9IGRvY3VtZW50LmJvZHkuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3QgZTogYW55ID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICB0b3AgPSBlLnRvcCAtIGIudG9wO1xyXG4gICAgICAgIGxlZnQgPSBlLmxlZnQgLSBiLmxlZnQ7XHJcbiAgICAgICAgbGV0IHBvc2l0aW9uID0gJ2JvdHRvbSc7XHJcbiAgICAgICAgaWYgKGRhdGVSYW5nZSAmJiBzaG93VHlwZSAhPT0gNCkge1xyXG4gICAgICAgICAgICBfc2VsZWN0b3JXaWR0aCA9IHRoaXMuZ2V0U2VsZWN0b3JEaW1lbnNpb24oc2VsZWN0b3JXaWR0aCkgKiAyO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIF9zZWxlY3RvcldpZHRoID0gdGhpcy5nZXRTZWxlY3RvckRpbWVuc2lvbihzZWxlY3RvcldpZHRoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIF9zZWxlY3RvckhlaWdodCA9IHRoaXMuZ2V0U2VsZWN0b3JEaW1lbnNpb24oc2VsZWN0b3JIZWlnaHQpO1xyXG4gICAgICAgIC8vIGlmIChzaG93VGltZSB8fCBlbmFibGVEeW5hbWljKSB7XHJcbiAgICAgICAgLy8gICAgIHRvcCA9IHRvcCAtIDY7XHJcbiAgICAgICAgLy8gfVxyXG5cclxuICAgICAgICB0b3AgPSB0b3AgLSA2O1xyXG4gICAgICAgIGlmICgoc2hvd1ByZXNlbnQgJiYgICghZGF0ZVJhbmdlIHx8IHNob3dUeXBlID09PSA0KSkgfHwgc2hvd1RpbWUgfHwgZW5hYmxlRHluYW1pYykge1xyXG4gICAgICAgICAgICBfc2VsZWN0b3JIZWlnaHQgKz0gNDU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodG9wICsgZWxlbS5vZmZzZXRIZWlnaHQgKyBfc2VsZWN0b3JIZWlnaHQgPiB3aW5kb3cuaW5uZXJIZWlnaHQgJiYgdG9wIC0gX3NlbGVjdG9ySGVpZ2h0IC0gMiA+IDApIHtcclxuICAgICAgICAgICAgdG9wID0gdG9wIC0gX3NlbGVjdG9ySGVpZ2h0IC0gMiA7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uID0gJ3RvcCc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdG9wID0gdG9wICsgZWxlbS5vZmZzZXRIZWlnaHQgKyAyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHdpbmRvdy5pbm5lckhlaWdodCAtIHRvcCA8IF9zZWxlY3RvckhlaWdodCkge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgLSAoX3NlbGVjdG9ySGVpZ2h0IC0gKHdpbmRvdy5pbm5lckhlaWdodCAtIGUudG9wIC0gZS5oZWlnaHQgLSAxNSkpO1xyXG5cclxuICAgICAgICAgICAgaWYgKGNhbGVuZGFyUmVmKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjYWxlbmRhckVsZW0gPSBjYWxlbmRhclJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXJyb3cgPSBjYWxlbmRhckVsZW0ucXVlcnlTZWxlY3RvcignLmFycm93Jyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoYXJyb3cpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnJvdy5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAobGVmdCArIF9zZWxlY3RvcldpZHRoID4gYi53aWR0aCkge1xyXG4gICAgICAgICAgICBsZWZ0ID0gYi53aWR0aCAtIF9zZWxlY3RvcldpZHRoIC0gMTU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxlZnQgPSBsZWZ0ID4gMCA/IGxlZnQgOiAwO1xyXG5cclxuICAgICAgICBjb25zdCBzY3JvbGxUb3AgPSBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wO1xyXG4gICAgICAgIHRvcCAtPSBzY3JvbGxUb3A7XHJcblxyXG4gICAgICAgIHJldHVybiB7IHRvcCwgbGVmdCwgcG9zaXRpb24gfTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgZ2V0U2VsZWN0b3JEaW1lbnNpb24odmFsdWU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICAgICAgcmV0dXJuIE51bWJlcih2YWx1ZS5yZXBsYWNlKFBYLCBFTVBUWV9TVFIpKTtcclxuICAgIH1cclxuXHJcbn1cclxuIl19