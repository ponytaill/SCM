/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { cloneDeep } from 'lodash-es';
var SearchHandle = /** @class */ (function () {
    function SearchHandle(ttInstance) {
        this.ttInstance = ttInstance;
        this.allNodes = [];
    }
    // 刷新查询结果
    // 刷新查询结果
    /**
     * @param {?=} from
     * @return {?}
     */
    SearchHandle.prototype.research = 
    // 刷新查询结果
    /**
     * @param {?=} from
     * @return {?}
     */
    function (from) {
        if (from === void 0) { from = 'client'; }
        var _a = this.ttInstance.searchData, field = _a.field, value = _a.value;
        this.allNodes = [];
        this.search(field, value, from);
    };
    /**
     * @param {?} field
     * @param {?} value
     * @param {?=} from
     * @return {?}
     */
    SearchHandle.prototype.search = /**
     * @param {?} field
     * @param {?} value
     * @param {?=} from
     * @return {?}
     */
    function (field, value, from) {
        var _this = this;
        if (from === void 0) { from = 'client'; }
        if (!this.allNodes.length) {
            this.allNodes = cloneDeep(this.ttInstance.state.rowNodes);
        }
        switch (from) {
            case 'server':
                this.searchOnServer(field, value);
                break;
            default:
                if (value !== '' && value !== undefined) {
                    /** @type {?} */
                    var values = this.searchOnClient(field, value, this.allNodes);
                    this.ttInstance.state.searchRowNodes = null;
                    this._updateSerializedValues(values);
                }
                else {
                    this.ttInstance.updateSerializedValue();
                }
                if (this.ttInstance.checkeds && this.ttInstance.checkeds.length) {
                    this.ttInstance.checkedNodes(this.ttInstance.checkeds.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    function (n) { return n.data[_this.ttInstance.idField]; })));
                }
                else {
                    this.ttInstance.resize();
                    this.ttInstance.detectChanges();
                    if (this.ttInstance.psRef) {
                        this.ttInstance.psRef.directiveRef.update();
                    }
                }
                break;
        }
    };
    /**
     * @private
     * @param {?} visibleItems
     * @return {?}
     */
    SearchHandle.prototype._updateSerializedValues = /**
     * @private
     * @param {?} visibleItems
     * @return {?}
     */
    function (visibleItems) {
        var _this = this;
        /** @type {?} */
        var pids = ((/** @type {?} */ (visibleItems.map((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return tslib_1.__spread(n.parents, [n.id]); }))))).flat();
        /** @type {?} */
        var pidArr = Array.from(new Set(pids));
        /** @type {?} */
        var rowNodes = this.allNodes.filter((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return pidArr.some((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item == n.id; })); })).map((/**
         * @param {?} r
         * @return {?}
         */
        function (r) {
            r.expanded = true;
            _this.ttInstance.updateNodeProperty(r.id, { expanded: true });
            return r;
        }));
        this.ttInstance.serializedValue = this.resetTreeData(null, rowNodes);
        this.ttInstance.state.searchRowNodes = this.ttInstance.serializedValue;
    };
    /**
     * @param {?} item
     * @param {?} allNodes
     * @return {?}
     */
    SearchHandle.prototype.findParent = /**
     * @param {?} item
     * @param {?} allNodes
     * @return {?}
     */
    function (item, allNodes) {
        var _this = this;
        /** @type {?} */
        var res = [];
        if (item && allNodes && allNodes.length) {
            /** @type {?} */
            var p = allNodes.find((/**
             * @param {?} t1
             * @return {?}
             */
            function (t1) { return t1.id === item.data[_this.ttInstance.idField]; }));
            res.push(p);
            if (p.parent) {
                res = res.concat(this.findParent(p.parent, allNodes));
            }
        }
        return res;
    };
    /**
     * @private
     * @param {?} item
     * @param {?} value
     * @param {?=} fields
     * @return {?}
     */
    SearchHandle.prototype.searchExpression = /**
     * @private
     * @param {?} item
     * @param {?} value
     * @param {?=} fields
     * @return {?}
     */
    function (item, value, fields) {
        var _this = this;
        if (fields === void 0) { fields = []; }
        /** @type {?} */
        var _fields = fields.length ? fields : this.ttInstance.columns.map((/**
         * @param {?} c
         * @return {?}
         */
        function (c) { return c.field; }));
        /** @type {?} */
        var results = _fields.map((/**
         * @param {?} f
         * @return {?}
         */
        function (f) {
            /** @type {?} */
            var targetValue = '' + _this.getValue(f, item.node.data);
            if (targetValue !== undefined) {
                if (typeof targetValue === 'number') {
                    return targetValue === parseFloat(value);
                }
                else {
                    return targetValue.indexOf(value) > -1;
                }
            }
            else {
                _this.ttInstance.writeConsole("\u4E0D\u5B58\u5728\u5217 " + f);
            }
        }));
        return results.reduce((/**
         * @param {?} flag
         * @param {?} curr
         * @return {?}
         */
        function (flag, curr) {
            return flag || curr;
        }), false);
    };
    /**
     * @private
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    SearchHandle.prototype.getValue = /**
     * @private
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    function (field, data) {
        if (field) {
            if (field.indexOf('.') > -1) {
                try {
                    return field.split('.').reduce((/**
                     * @param {?} r
                     * @param {?} f
                     * @return {?}
                     */
                    function (r, f) {
                        if (r) {
                            return r[f];
                        }
                        else {
                            return null;
                        }
                    }), data);
                }
                catch (_a) {
                    this.ttInstance.writeConsole("\u5B57\u6BB5 " + field + " \u4E0D\u5B58\u5728\u3002");
                }
            }
            else {
                return data[field];
            }
        }
    };
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    SearchHandle.prototype.getFindTextTotal = /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    function (field, value, nodes) {
        var _this = this;
        /** @type {?} */
        var t = 0;
        /** @type {?} */
        var getCount = (/**
         * @param {?} fields
         * @return {?}
         */
        function (fields) {
            /** @type {?} */
            var c = 0;
            nodes.forEach((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                fields.forEach((/**
                 * @param {?} f
                 * @return {?}
                 */
                function (f) {
                    /** @type {?} */
                    var targetValue = '' + _this.getValue(f, n.node.data);
                    if (targetValue !== undefined) {
                        if (targetValue.indexOf(value) > -1) {
                            c++;
                        }
                    }
                }));
            }));
            return c;
        });
        /** @type {?} */
        var _fields = [field];
        if (field === '*') {
            _fields = this.ttInstance.columns.map((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.field; }));
        }
        else if (field.indexOf(',') > -1) {
            _fields = field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            function (f) { return f.trim(); }));
        }
        t = getCount(_fields);
        return t;
    };
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    SearchHandle.prototype.searchOnClient = /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    function (field, value, nodes) {
        var _this = this;
        /** @type {?} */
        var resultNodes = [];
        if (!value) {
            return [];
        }
        if (field === '*') {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return _this.searchExpression(n, value); }));
        }
        else if (field.indexOf(',') > -1) {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return _this.searchExpression(n, value, field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            function (f) { return f.trim(); }))); }));
        }
        else {
            value = value.toLowerCase();
            if (field.indexOf('.') === -1) {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return ('' + n.node.data[field]).toLowerCase().indexOf(value) > -1; }));
            }
            else {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return ('' + _this.getValue(field, n.node.data)).toLowerCase().indexOf(value) > -1; }));
            }
        }
        return resultNodes;
    };
    /**
     * @param {?} rowNodes
     * @param {?} allNodes
     * @return {?}
     */
    SearchHandle.prototype.findParents = /**
     * @param {?} rowNodes
     * @param {?} allNodes
     * @return {?}
     */
    function (rowNodes, allNodes) {
        var _this = this;
        /** @type {?} */
        var res = [];
        rowNodes.forEach((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            res = res.concat(_this.findParent(item.node, allNodes));
        }));
        return Array.from(new Set(res));
    };
    /**
     * @private
     * @param {?} parentNode
     * @param {?} visibleItems
     * @return {?}
     */
    SearchHandle.prototype.resetTreeData = /**
     * @private
     * @param {?} parentNode
     * @param {?} visibleItems
     * @return {?}
     */
    function (parentNode, visibleItems) {
        var _this = this;
        /** @type {?} */
        var res = [];
        /** @type {?} */
        var arr = [];
        if (parentNode === null) {
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            function (t2) { return t2.parent === parentNode; }));
        }
        else {
            parentNode.node.expanded = true;
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            function (t2) { return t2.parent && t2.parent.data[_this.ttInstance.idField] === parentNode.id; }));
            if (!arr.length) {
                parentNode.node.children = [];
            }
            else {
                parentNode.node.children = arr.map((/**
                 * @param {?} tn
                 * @return {?}
                 */
                function (tn) { return tn.node; }));
            }
        }
        arr.forEach((/**
         * @param {?} a
         * @return {?}
         */
        function (a) {
            a.visible = true;
            res.push(a);
            res = res.concat(_this.resetTreeData(a, visibleItems));
        }));
        return res;
    };
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    SearchHandle.prototype.searchOnServer = /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    function (field, value) {
    };
    return SearchHandle;
}());
export { SearchHandle };
if (false) {
    /** @type {?} */
    SearchHandle.prototype.allNodes;
    /**
     * @type {?}
     * @private
     */
    SearchHandle.prototype.ttInstance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLmhhbmRsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktdHJlZXRhYmxlLyIsInNvdXJjZXMiOlsibGliL3NlYXJjaC5oYW5kbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFXQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDO0lBRUksc0JBQW9CLFVBQThCO1FBQTlCLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBRGxELGFBQVEsR0FBRyxFQUFFLENBQUM7SUFFZCxDQUFDO0lBRUQsU0FBUzs7Ozs7O0lBQ1QsK0JBQVE7Ozs7OztJQUFSLFVBQVMsSUFBa0M7UUFBbEMscUJBQUEsRUFBQSxlQUFrQztRQUNqQyxJQUFBLCtCQUE2QyxFQUEzQyxnQkFBSyxFQUFFLGdCQUFvQztRQUNuRCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQzs7Ozs7OztJQUVELDZCQUFNOzs7Ozs7SUFBTixVQUFPLEtBQWEsRUFBRSxLQUFhLEVBQUUsSUFBa0M7UUFBdkUsaUJBNEJDO1FBNUJvQyxxQkFBQSxFQUFBLGVBQWtDO1FBQ25FLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtZQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM3RDtRQUNELFFBQVEsSUFBSSxFQUFFO1lBQ1YsS0FBSyxRQUFRO2dCQUNULElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUNsQyxNQUFNO1lBQ1Y7Z0JBQ0ksSUFBSSxLQUFLLEtBQUssRUFBRSxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7O3dCQUMvQixNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUM7b0JBQy9ELElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7b0JBQzVDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDeEM7cUJBQU07b0JBQ0gsSUFBSSxDQUFDLFVBQVUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO2lCQUMzQztnQkFFRCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtvQkFDN0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsR0FBRzs7OztvQkFBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsRUFBL0IsQ0FBK0IsRUFBQyxDQUFDLENBQUM7aUJBQ3BHO3FCQUFNO29CQUNILElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUM7b0JBQ3pCLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLENBQUM7b0JBQ2hDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUU7d0JBQ3ZCLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsQ0FBQztxQkFDL0M7aUJBQ0o7Z0JBQ0QsTUFBTTtTQUNiO0lBQ0wsQ0FBQzs7Ozs7O0lBRU8sOENBQXVCOzs7OztJQUEvQixVQUFnQyxZQUF1QjtRQUF2RCxpQkFZQzs7WUFYUyxJQUFJLEdBQUcsQ0FBQyxtQkFBQSxZQUFZLENBQUMsR0FBRzs7OztRQUFDLFVBQUEsQ0FBQyxJQUFJLHdCQUFJLENBQUMsQ0FBQyxPQUFPLEdBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBbkIsQ0FBb0IsRUFBQyxFQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUU7O1lBQ2xFLE1BQU0sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDOztZQUVsQyxRQUFRLEdBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNOzs7O1FBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxNQUFNLENBQUMsSUFBSTs7OztRQUFDLFVBQUEsSUFBSSxJQUFFLE9BQUEsSUFBSSxJQUFFLENBQUMsQ0FBQyxFQUFFLEVBQVYsQ0FBVSxFQUFDLEVBQTdCLENBQTZCLEVBQUMsQ0FBQyxHQUFHOzs7O1FBQUMsVUFBQSxDQUFDO1lBQzVFLENBQUMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLEtBQUksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQzVELE9BQU8sQ0FBQyxDQUFDO1FBQ2IsQ0FBQyxFQUFDO1FBRUYsSUFBSSxDQUFDLFVBQVUsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDO0lBQzNFLENBQUM7Ozs7OztJQUVELGlDQUFVOzs7OztJQUFWLFVBQVcsSUFBYyxFQUFFLFFBQWU7UUFBMUMsaUJBVUM7O1lBVE8sR0FBRyxHQUFHLEVBQUU7UUFDWixJQUFJLElBQUksSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTs7Z0JBQy9CLENBQUMsR0FBRyxRQUFRLENBQUMsSUFBSTs7OztZQUFDLFVBQUEsRUFBRSxJQUFJLE9BQUEsRUFBRSxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQTVDLENBQTRDLEVBQUM7WUFDM0UsR0FBRyxDQUFD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RyxFQUFFLENBQUM7YUFDakM7aUJBQU07Z0JBQ0gsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDLEdBQUc7Ozs7Z0JBQUUsVUFBQSxFQUFFLElBQUksT0FBQSxFQUFFLENBQUMsSUFBSSxFQUFQLENBQU8sRUFBRSxDQUFDO2FBQ3ZEO1NBQ0o7UUFDRCxHQUFHLENBQUMsT0FBTzs7OztRQUFFLFVBQUEsQ0FBQztZQUNWLENBQUMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1lBQ2pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDWixHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFJLENBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDO1FBQzFELENBQUMsRUFBQyxDQUFDO1FBQ0gsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDOzs7Ozs7O0lBRU8scUNBQWM7Ozs7OztJQUF0QixVQUF1QixLQUFhLEVBQUUsS0FBYTtJQUVuRCxDQUFDO0lBRUwsbUJBQUM7QUFBRCxDQUFDLEFBaE1ELElBZ01DOzs7O0lBL0xHLGdDQUFjOzs7OztJQUNGLGtDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4dGVuZCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbi8qXHJcbiAqIEBBdXRob3I6IOeWr+eLguengOaJjShsdWNhcyBodWFuZylcclxuICogQERhdGU6IDIwMTgtMTItMTggMTM6Mzg6NTFcclxuICogQExhc3RFZGl0b3JzOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMTktMTEtMTUgMTU6MTM6NTZcclxuICogQENvbXBhbnk6IEluc3B1clxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBUcmVlVGFibGVDb21wb25lbnQgfSBmcm9tICcuL3RyZWV0YWJsZS5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBSb3dOb2RlLCBUcmVlTm9kZSB9IGZyb20gJy4vdHlwZXMvdHJlZW5vZGUnO1xyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5leHBvcnQgY2xhc3MgU2VhcmNoSGFuZGxlIHtcclxuICAgIGFsbE5vZGVzID0gW107XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHR0SW5zdGFuY2U6IFRyZWVUYWJsZUNvbXBvbmVudCkge1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWIt+aWsOafpeivoue7k+aenFxyXG4gICAgcmVzZWFyY2goZnJvbTogJ2NsaWVudCd8J3NlcnZlcicgPSAnY2xpZW50JyApIHtcclxuICAgICAgICBjb25zdCB7IGZpZWxkLCB2YWx1ZSB9ID0gdGhpcy50dEluc3RhbmNlLnNlYXJjaERhdGE7XHJcbiAgICAgICAgdGhpcy5hbGxOb2RlcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuc2VhcmNoKGZpZWxkLCB2YWx1ZSwgZnJvbSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VhcmNoKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIGZyb206ICdjbGllbnQnfCdzZXJ2ZXInID0gJ2NsaWVudCcpOiBhbnkge1xyXG4gICAgICAgIGlmICghdGhpcy5hbGxOb2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5hbGxOb2RlcyA9IGNsb25lRGVlcCh0aGlzLnR0SW5zdGFuY2Uuc3RhdGUucm93Tm9kZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzd2l0Y2ggKGZyb20pIHtcclxuICAgICAgICAgICAgY2FzZSAnc2VydmVyJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoT25TZXJ2ZXIoZmllbGQsIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSAnJyAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVzID0gdGhpcy5zZWFyY2hPbkNsaWVudChmaWVsZCwgdmFsdWUsIHRoaXMuYWxsTm9kZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS5zdGF0ZS5zZWFyY2hSb3dOb2RlcyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2VyaWFsaXplZFZhbHVlcyh2YWx1ZXMpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2UudXBkYXRlU2VyaWFsaXplZFZhbHVlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudHRJbnN0YW5jZS5jaGVja2VkcyAmJiB0aGlzLnR0SW5zdGFuY2UuY2hlY2tlZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLmNoZWNrZWROb2Rlcyh0aGlzLnR0SW5zdGFuY2UuY2hlY2tlZHMubWFwKG4gPT4gbi5kYXRhW3RoaXMudHRJbnN0YW5jZS5pZEZpZWxkXSkpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2UucmVzaXplKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy50dEluc3RhbmNlLnBzUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS5wc1JlZi5kaXJlY3RpdmVSZWYudXBkYXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3VwZGF0ZVNlcmlhbGl6ZWRWYWx1ZXModmlzaWJsZUl0ZW1zOiBSb3dOb2RlW10pIHtcclxuICAgICAgICBjb25zdCBwaWRzID0gKHZpc2libGVJdGVtcy5tYXAobiA9PiBbLi4ubi5wYXJlbnRzLCBuLmlkXSkgYXMgYW55KS5mbGF0KCk7XHJcbiAgICAgICAgY29uc3QgcGlkQXJyID0gQXJyYXkuZnJvbShuZXcgU2V0KHBpZHMpKTtcclxuXHJcbiAgICAgICAgY29uc3Qgcm93Tm9kZXMgPSAgdGhpcy5hbGxOb2Rlcy5maWx0ZXIobiA9PiBwaWRBcnIuc29tZShpdGVtPT5pdGVtPT1uLmlkKSkubWFwKHIgPT4ge1xyXG4gICAgICAgICAgICByLmV4cGFuZGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLnVwZGF0ZU5vZGVQcm9wZXJ0eShyLmlkLCB7ZXhwYW5kZWQ6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnR0SW5zdGFuY2Uuc2VyaWFsaXplZFZhbHVlID0gdGhpcy5yZXNldFRyZWVEYXRhKG51bGwsIHJvd05vZGVzKTtcclxuICAgICAgICB0aGlzLnR0SW5zdGFuY2Uuc3RhdGUuc2VhcmNoUm93Tm9kZXMgPSB0aGlzLnR0SW5zdGFuY2Uuc2VyaWFsaXplZFZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIGZpbmRQYXJlbnQoaXRlbTogVHJlZU5vZGUsIGFsbE5vZGVzOiBhbnlbXSkge1xyXG4gICAgICAgIGxldCByZXMgPSBbXTtcclxuICAgICAgICBpZiAoaXRlbSAmJiBhbGxOb2RlcyAmJiBhbGxOb2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3QgcCA9IGFsbE5vZGVzLmZpbmQodDEgPT4gdDEuaWQgPT09IGl0ZW0uZGF0YVt0aGlzLnR0SW5zdGFuY2UuaWRGaWVsZF0pO1xyXG4gICAgICAgICAgICByZXMucHVzaChwKTtcclxuICAgICAgICAgICAgaWYgKHAucGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICByZXMgPSByZXMuY29uY2F0KHRoaXMuZmluZFBhcmVudChwLnBhcmVudCwgYWxsTm9kZXMpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VhcmNoRXhwcmVzc2lvbihpdGVtOiBSb3dOb2RlLCB2YWx1ZTogc3RyaW5nLCBmaWVsZHM6IHN0cmluZ1tdID0gW10pIHtcclxuICAgICAgICBjb25zdCBfZmllbGRzID0gZmllbGRzLmxlbmd0aCA/IGZpZWxkcyA6IHRoaXMudHRJbnN0YW5jZS5jb2x1bW5zLm1hcChjID0+IGMuZmllbGQpO1xyXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSBfZmllbGRzLm1hcChmID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSAnJyArICAgdGhpcy5nZXRWYWx1ZShmLCBpdGVtLm5vZGUuZGF0YSk7XHJcbiAgICAgICAgICAgIGlmICh0YXJnZXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRhcmdldFZhbHVlID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRWYWx1ZSA9PT0gcGFyc2VGbG9hdCh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRWYWx1ZS5pbmRleE9mKHZhbHVlKSA+IC0xO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLndyaXRlQ29uc29sZShg5LiN5a2Y5Zyo5YiXICR7Zn1gKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0cy5yZWR1Y2UoKGZsYWcsIGN1cnIpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGZsYWcgfHwgY3VycjtcclxuICAgICAgICB9LCBmYWxzZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRWYWx1ZShmaWVsZCwgZGF0YSkge1xyXG4gICAgICAgIGlmIChmaWVsZCkge1xyXG4gICAgICAgICAgICBpZiAoZmllbGQuaW5kZXhPZignLicpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmllbGQuc3BsaXQoJy4nKS5yZWR1Y2UoIChyLCBmKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJbZl07XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSwgZGF0YSApO1xyXG4gICAgICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS53cml0ZUNvbnNvbGUoYOWtl+autSAke2ZpZWxkfSDkuI3lrZjlnKjjgIJgKVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YVtmaWVsZF07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RmluZFRleHRUb3RhbChmaWVsZDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBub2RlczogUm93Tm9kZVtdKSB7XHJcbiAgICAgICAgbGV0IHQgPSAwO1xyXG4gICAgICAgIGNvbnN0IGdldENvdW50ID0gKGZpZWxkcyk6IGFueSA9PiB7XHJcbiAgICAgICAgICAgIGxldCBjID0gMDtcclxuICAgICAgICAgICAgbm9kZXMuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgICAgIGZpZWxkcy5mb3JFYWNoKGYgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gJycgKyAgIHRoaXMuZ2V0VmFsdWUoZiwgbi5ub2RlLmRhdGEpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRWYWx1ZS5pbmRleE9mKHZhbHVlKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBjO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IF9maWVsZHMgPSBbZmllbGRdO1xyXG4gICAgICAgIGlmIChmaWVsZCA9PT0gJyonKSB7XHJcbiAgICAgICAgICAgIF9maWVsZHMgPSB0aGlzLnR0SW5zdGFuY2UuY29sdW1ucy5tYXAoYyA9PiBjLmZpZWxkKTtcclxuXHJcbiAgICAgICAgfSBlbHNlIGlmIChmaWVsZC5pbmRleE9mKCcsJykgPiAtMSkge1xyXG4gICAgICAgICAgICBfZmllbGRzID0gZmllbGQuc3BsaXQoJywnKS5tYXAoZiA9PiBmLnRyaW0oKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0ID0gZ2V0Q291bnQoX2ZpZWxkcyk7XHJcbiAgICAgICAgcmV0dXJuIHQ7XHJcbiAgICB9XHJcblxyXG4gICAgc2VhcmNoT25DbGllbnQoZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZywgbm9kZXM6IFJvd05vZGVbXSkge1xyXG4gICAgICAgIGxldCByZXN1bHROb2RlczogUm93Tm9kZVtdID0gW107XHJcbiAgICAgICAgaWYgKCF2YWx1ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChmaWVsZCA9PT0gJyonKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdE5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gdGhpcy5zZWFyY2hFeHByZXNzaW9uKG4sIHZhbHVlKSk7XHJcbiAgICAgICAgfSBlbHNlIGlmIChmaWVsZC5pbmRleE9mKCcsJykgPiAtMSkge1xyXG4gICAgICAgICAgICByZXN1bHROb2RlcyA9IG5vZGVzLmZpbHRlcihuID0+IHRoaXMuc2VhcmNoRXhwcmVzc2lvbihuLCB2YWx1ZSwgZmllbGQuc3BsaXQoJywnKS5tYXAoZiA9PiBmLnRyaW0oKSkpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHROb2RlcyA9IG5vZGVzLmZpbHRlcihuID0+ICgnJyArIG4ubm9kZS5kYXRhW2ZpZWxkXSkudG9Mb3dlckNhc2UoKS5pbmRleE9mKHZhbHVlKSA+IC0xKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdE5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gKCcnICsgdGhpcy5nZXRWYWx1ZShmaWVsZCwgbi5ub2RlLmRhdGEpKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodmFsdWUpID4gLTEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0Tm9kZXM7XHJcbiAgICB9XHJcblxyXG4gICAgZmluZFBhcmVudHMocm93Tm9kZXMsIGFsbE5vZGVzKSB7XHJcbiAgICAgICAgbGV0IHJlcyA9IFtdO1xyXG4gICAgICAgIHJvd05vZGVzLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgIHJlcyA9IHJlcy5jb25jYXQodGhpcy5maW5kUGFyZW50KGl0ZW0ubm9kZSwgYWxsTm9kZXMpKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20obmV3IFNldChyZXMpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2V0VHJlZURhdGEocGFyZW50Tm9kZTogUm93Tm9kZSwgdmlzaWJsZUl0ZW1zOiBSb3dOb2RlW10pIHtcclxuICAgICAgICBsZXQgcmVzID0gW107XHJcbiAgICAgICAgbGV0IGFyciA9IFtdO1xyXG4gICAgICAgIGlmIChwYXJlbnROb2RlID09PSBudWxsKSB7XHJcbiAgICAgICAgICAgIGFyciA9IHZpc2libGVJdGVtcy5maWx0ZXIodDIgPT4gdDIucGFyZW50ID09PSBwYXJlbnROb2RlKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBwYXJlbnROb2RlLm5vZGUuZXhwYW5kZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICBhcnIgPSB2aXNpYmxlSXRlbXMuZmlsdGVyKHQyID0+IHQyLnBhcmVudCAmJiB0Mi5wYXJlbnQuZGF0YVt0aGlzLnR0SW5zdGFuY2UuaWRGaWVsZF0gPT09IHBhcmVudE5vZGUuaWQpO1xyXG4gICAgICAgICAgICBpZiAoIWFyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudE5vZGUubm9kZS5jaGlsZHJlbiA9IFtdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50Tm9kZS5ub2RlLmNoaWxkcmVuID0gYXJyLm1hcCggdG4gPT4gdG4ubm9kZSApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGFyci5mb3JFYWNoKCBhID0+IHtcclxuICAgICAgICAgICAgYS52aXNpYmxlID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmVzLnB1c2goYSk7XHJcbiAgICAgICAgICAgIHJlcyA9IHJlcy5jb25jYXQodGhpcy5yZXNldFRyZWVEYXRhKGEsIHZpc2libGVJdGVtcykpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZWFyY2hPblNlcnZlcihmaWVsZDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XHJcblxyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=