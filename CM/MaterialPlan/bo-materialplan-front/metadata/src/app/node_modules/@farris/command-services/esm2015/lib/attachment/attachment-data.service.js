import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { tap, switchMap, map } from 'rxjs/operators';
import { FrameContext, BindingPathConverter } from '@farris/devkit';
import { BefDataPathUtil } from '@farris/bef';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { AttachmentUtil } from './attachment.util';
/**
 * 附件调用
 */
class AttachmentDataService {
    constructor(frameContext, loadingService) {
        this.frameContext = frameContext;
        this.loadingService = loadingService;
    }
    /**
     * 实体仓库
     */
    get repository() {
        return this.frameContext.repository;
    }
    /**
     * 绑定数据
     */
    get bindingData() {
        return this.frameContext.bindingData;
    }
    /**
     * 更新附件信息
     */
    updateRow(attachmentInfoFieldPath, attachmentInfo) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/updateattachment`;
        const serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        const body = {
            updateAttachInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        this.loadingService.show();
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.syncAttachmentInfosToClient();
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 通过属性名更新附件信息
     * @param attachmentInfoFieldPath 附件字段
     * @param attachmentInfo 附件信息
     */
    updateRowWithPropertyName(attachmentInfoFieldPath, attachmentInfo) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/updateattachmentwithproptyname`;
        const serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        const propertyName = attachmentInfoFieldPath.split('/').filter(p => p).pop();
        const body = {
            updateAttachInfo: serverAttachInfo,
            propertyName,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        this.loadingService.show();
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.syncAttachmentInfosToClient();
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 批量创建附件行数据
     */
    updateRows(attachmentInfoFieldPath, attachmentInfos) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/batchuploadattachment`;
        const serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        const body = {
            batchUploadInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.appendAttachmentInfosToClient(responseInfo.returnValue, isRootEntity);
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 批量创建附件行数据
     */
    updateRowsWithConfigs(attachmentInfoFieldPath, attachmentInfos, configs) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/batchuploadattachment`;
        const serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        // const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        const body = {
            batchUploadInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.appendAttachmentInfos(responseInfo.returnValue, configs);
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 根据属性名批量创建附件行数据
     */
    updateRowsWithPropertyName(attachmentInfoFieldPath, attachmentInfos) {
        const restService = this.repository.restService;
        const baseUri = restService.baseUri;
        const updateUri = `${baseUri}/service/batchuploadattachmentwithproptyname`;
        const serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        const propertyName = attachmentInfoFieldPath.split('/').filter(p => p).pop();
        const body = {
            batchUploadInfo: serverAttachInfo,
            propertyName,
            requestInfo: restService.buildRequestInfo()
        };
        const options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap((responseInfo) => {
            return this.appendAttachmentInfosToClient(responseInfo.returnValue, isRootEntity);
        }), tap(() => {
            this.loadingService.hide();
        }));
    }
    /**
     * 创建服务器端需要的更新信息
     */
    createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo) {
        const attachmentId = attachmentInfo.attachmentId;
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        const nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        const hiretryIds = BefDataPathUtil.convertToDataIdsForUpdate(parentBindingPathArray, this.bindingData);
        const serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: [attachmentId],
            AttachmentId: attachmentId
        };
        return serverAttachInfo;
    }
    /**
     * 创建服务器端需要的批量新增附件信息
     */
    createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfo) {
        const attachmentIds = AttachmentUtil.peekAttachmentIds(attachmentInfo);
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        const nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        const hiretryIds = BefDataPathUtil.convertToDataIdsForAdd(parentBindingPathArray, this.bindingData);
        const serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: attachmentIds,
            AttachmentId: null
        };
        return serverAttachInfo;
    }
    /**
     * 同步服务器端最新信息到客户端
     * @todo:
     * 1、主对象批量新增时不支持
     */
    syncAttachmentInfosToClient() {
        const rootDataId = this.bindingData.list.currentId;
        return this.repository.updateEntityById(rootDataId);
    }
    /**
     * 追加主表数据到客户端
     */
    appendAttachmentInfosToClient(listData, isRootEntity) {
        if (isRootEntity === true) {
            const entities = this.repository.buildEntities(listData);
            this.repository.entityCollection.addEntities(entities);
            return of(listData);
        }
        else {
            const rootDataId = this.bindingData.list.currentId;
            return this.repository.updateEntityById(rootDataId).pipe(map(() => listData));
        }
    }
    appendAttachmentInfos(listData, keyValues) {
        const entities = this.repository.buildEntities(listData);
        this.repository.entityCollection.addEntities(entities);
        // 更新实体使之产生变更集
        this.updateEntities(entities, keyValues);
        return of(listData);
    }
    updateEntities(entities, keyValues) {
        entities.forEach((entity) => {
            this.updateEntity(entity, keyValues);
        });
    }
    updateEntity(target, keyValues) {
        Object.keys(keyValues).forEach((key) => {
            this.setValueByPath(target, key, keyValues[key]);
        });
    }
    setValueByPath(target, path, value) {
        if (target) {
            const paths = path.split('.');
            if (paths.length <= 1) {
                target[path] = value;
            }
            else {
                paths.slice(0, -1).reduce((prev, path) => {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    }
}
AttachmentDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AttachmentDataService.ctorParameters = () => [
    { type: FrameContext },
    { type: FormLoadingService }
];
export { AttachmentDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYXR0YWNobWVudC9hdHRhY2htZW50LWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBdUIsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RixPQUFPLEVBQWlCLGVBQWUsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFMUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRW5EOztHQUVHO0FBQ0gsTUFDTSxxQkFBcUI7SUFnQnpCLFlBQW9CLFlBQTBCLEVBQVUsY0FBa0M7UUFBdEUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBb0I7SUFDMUYsQ0FBQztJQWZEOztPQUVHO0lBQ0gsSUFBWSxVQUFVO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFtQyxDQUFDO0lBQy9ELENBQUM7SUFFRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO0lBQ3ZDLENBQUM7SUFLRDs7T0FFRztJQUNJLFNBQVMsQ0FBQyx1QkFBK0IsRUFBRSxjQUE4QjtRQUM5RSxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUNoRCxNQUFNLE9BQU8sR0FB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LENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFO29CQUN2QyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTt3QkFDMUUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztxQkFDakI7b0JBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3BCLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQzthQUM3QztTQUNGO0lBQ0gsQ0FBQzs7O1lBN1BGLFVBQVU7Ozs7WUFURixZQUFZO1lBRVosa0JBQWtCOztBQXdRM0IsT0FBTyxFQUFFLHFCQUFxQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwLCBzd2l0Y2hNYXAsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgRW50aXR5LCBCaW5kaW5nRGF0YSwgQmluZGluZ1BhdGhDb252ZXJ0ZXIgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5LCBCZWZEYXRhUGF0aFV0aWwsIFJlc3BvbnNlSW5mbyB9IGZyb20gJ0BmYXJyaXMvYmVmJztcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XG5pbXBvcnQgeyBBdHRhY2htZW50SW5mbywgU2VydmVyQXR0YWNobWVudEluZm8gfSBmcm9tICcuL3R5cGVzJztcbmltcG9ydCB7IEF0dGFjaG1lbnRVdGlsIH0gZnJvbSAnLi9hdHRhY2htZW50LnV0aWwnO1xuXG4vKipcbiAqIOmZhOS7tuiwg+eUqFxuICovXG5ASW5qZWN0YWJsZSgpXG5jbGFzcyBBdHRhY2htZW50RGF0YVNlcnZpY2Uge1xuXG4gIC8qKlxuICAgKiDlrp7kvZPku5PlupNcbiAgICovXG4gIHByaXZhdGUgZ2V0IHJlcG9zaXRvcnkoKTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+IHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PEVudGl0eT47XG4gIH1cblxuICAvKipcbiAgICog57uR5a6a5pWw5o2uXG4gICAqL1xuICBwcml2YXRlIGdldCBiaW5kaW5nRGF0YSgpOiBCaW5kaW5nRGF0YSB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlKSB7XG4gIH1cblxuICAvKipcbiAgICog5pu05paw6ZmE5Lu25L+h5oGvXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlUm93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvOiBBdHRhY2htZW50SW5mbyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgdXBkYXRlVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS91cGRhdGVhdHRhY2htZW50YDtcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0gdGhpcy5jcmVhdGVVcGRhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mbyk7XG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIHVwZGF0ZUF0dGFjaEluZm86IHNlcnZlckF0dGFjaEluZm8sXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cGRhdGVVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zeW5jQXR0YWNobWVudEluZm9zVG9DbGllbnQoKTtcbiAgICAgIH0pLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOmAmui/h+WxnuaAp+WQjeabtOaWsOmZhOS7tuS/oeaBr1xuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm9GaWVsZFBhdGgg6ZmE5Lu25a2X5q61XG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mbyDpmYTku7bkv6Hmga9cbiAgICovXG4gIHB1YmxpYyB1cGRhdGVSb3dXaXRoUHJvcGVydHlOYW1lKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvOiBBdHRhY2htZW50SW5mbyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgdXBkYXRlVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS91cGRhdGVhdHRhY2htZW50d2l0aHByb3B0eW5hbWVgO1xuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZVVwZGF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvKTtcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnBvcCgpO1xuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICB1cGRhdGVBdHRhY2hJbmZvOiBzZXJ2ZXJBdHRhY2hJbmZvLFxuICAgICAgcHJvcGVydHlOYW1lLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGJvZHk6IGJvZHlcbiAgICB9O1xuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXBkYXRlVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3luY0F0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KCk7XG4gICAgICB9KSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmibnph4/liJvlu7rpmYTku7booYzmlbDmja5cbiAgICovXG4gIHB1YmxpYyB1cGRhdGVSb3dzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvczogQXR0YWNobWVudEluZm9bXSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgdXBkYXRlVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9iYXRjaHVwbG9hZGF0dGFjaG1lbnRgO1xuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZUJhdGNoQ3JlYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcbiAgICBjb25zdCBpc1Jvb3RFbnRpdHkgPSBzZXJ2ZXJBdHRhY2hJbmZvLk5vZGVDb2Rlcy5sZW5ndGggPT09IDA7XG5cbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgYmF0Y2hVcGxvYWRJbmZvOiBzZXJ2ZXJBdHRhY2hJbmZvLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGJvZHk6IGJvZHlcbiAgICB9O1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXBkYXRlVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLCBpc1Jvb3RFbnRpdHkpO1xuICAgICAgfSksXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5om56YeP5Yib5bu66ZmE5Lu26KGM5pWw5o2uXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlUm93c1dpdGhDb25maWdzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvczogQXR0YWNobWVudEluZm9bXSwgY29uZmlnczogeyBbcHJvcDogc3RyaW5nXTogYW55IH0pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IHVwZGF0ZVVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvYmF0Y2h1cGxvYWRhdHRhY2htZW50YDtcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0gdGhpcy5jcmVhdGVCYXRjaENyZWF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcyk7XG4gICAgLy8gY29uc3QgaXNSb290RW50aXR5ID0gc2VydmVyQXR0YWNoSW5mby5Ob2RlQ29kZXMubGVuZ3RoID09PSAwO1xuXG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIGJhdGNoVXBsb2FkSW5mbzogc2VydmVyQXR0YWNoSW5mbyxcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBib2R5OiBib2R5XG4gICAgfTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVwZGF0ZVVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmFwcGVuZEF0dGFjaG1lbnRJbmZvcyhyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUsIGNvbmZpZ3MpO1xuICAgICAgfSksXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5qC55o2u5bGe5oCn5ZCN5om56YeP5Yib5bu66ZmE5Lu26KGM5pWw5o2uXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlUm93c1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2JhdGNodXBsb2FkYXR0YWNobWVudHdpdGhwcm9wdHluYW1lYDtcbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvID0gdGhpcy5jcmVhdGVCYXRjaENyZWF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcyk7XG4gICAgY29uc3QgaXNSb290RW50aXR5ID0gc2VydmVyQXR0YWNoSW5mby5Ob2RlQ29kZXMubGVuZ3RoID09PSAwO1xuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkucG9wKCk7XG5cbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgYmF0Y2hVcGxvYWRJbmZvOiBzZXJ2ZXJBdHRhY2hJbmZvLFxuICAgICAgcHJvcGVydHlOYW1lLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGJvZHk6IGJvZHlcbiAgICB9O1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXBkYXRlVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLCBpc1Jvb3RFbnRpdHkpO1xuICAgICAgfSksXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliJvlu7rmnI3liqHlmajnq6/pnIDopoHnmoTmm7TmlrDkv6Hmga9cbiAgICovXG4gIHByaXZhdGUgY3JlYXRlVXBkYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mbzogQXR0YWNobWVudEluZm8pOiBTZXJ2ZXJBdHRhY2htZW50SW5mbyB7XG5cbiAgICBjb25zdCBhdHRhY2htZW50SWQgPSBhdHRhY2htZW50SW5mby5hdHRhY2htZW50SWQ7XG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcbiAgICBjb25zdCBub2RlQ29kZXMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvT2JqZWN0Q29kZXMocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XG4gICAgY29uc3QgaGlyZXRyeUlkcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9EYXRhSWRzRm9yVXBkYXRlKHBhcmVudEJpbmRpbmdQYXRoQXJyYXksIHRoaXMuYmluZGluZ0RhdGEpO1xuXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbzogU2VydmVyQXR0YWNobWVudEluZm8gPSB7XG4gICAgICBOb2RlQ29kZXM6IG5vZGVDb2RlcyxcbiAgICAgIEhpcmV0cnlJZHM6IGhpcmV0cnlJZHMsXG4gICAgICBBdHRhY2htZW50SWRzOiBbYXR0YWNobWVudElkXSxcbiAgICAgIEF0dGFjaG1lbnRJZDogYXR0YWNobWVudElkXG4gICAgfTtcblxuICAgIHJldHVybiBzZXJ2ZXJBdHRhY2hJbmZvO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIm+W7uuacjeWKoeWZqOerr+mcgOimgeeahOaJuemHj+aWsOWinumZhOS7tuS/oeaBr1xuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVCYXRjaENyZWF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvW10pOiBTZXJ2ZXJBdHRhY2htZW50SW5mbyB7XG4gICAgY29uc3QgYXR0YWNobWVudElkcyA9IEF0dGFjaG1lbnRVdGlsLnBlZWtBdHRhY2htZW50SWRzKGF0dGFjaG1lbnRJbmZvKTtcblxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xuICAgIHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XG4gICAgY29uc3Qgbm9kZUNvZGVzID0gQmVmRGF0YVBhdGhVdGlsLmNvbnZlcnRUb09iamVjdENvZGVzKHBhcmVudEJpbmRpbmdQYXRoQXJyYXksIHRoaXMuYmluZGluZ0RhdGEpO1xuICAgIGNvbnN0IGhpcmV0cnlJZHMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvRGF0YUlkc0ZvckFkZChwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcblxuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB7XG4gICAgICBOb2RlQ29kZXM6IG5vZGVDb2RlcyxcbiAgICAgIEhpcmV0cnlJZHM6IGhpcmV0cnlJZHMsXG4gICAgICBBdHRhY2htZW50SWRzOiBhdHRhY2htZW50SWRzLFxuICAgICAgQXR0YWNobWVudElkOiBudWxsXG4gICAgfTtcblxuICAgIHJldHVybiBzZXJ2ZXJBdHRhY2hJbmZvO1xuICB9XG5cbiAgLyoqXG4gICAqIOWQjOatpeacjeWKoeWZqOerr+acgOaWsOS/oeaBr+WIsOWuouaIt+err1xuICAgKiBAdG9kbzpcbiAgICogMeOAgeS4u+WvueixoeaJuemHj+aWsOWinuaXtuS4jeaUr+aMgVxuICAgKi9cbiAgcHVibGljIHN5bmNBdHRhY2htZW50SW5mb3NUb0NsaWVudCgpIHtcbiAgICBjb25zdCByb290RGF0YUlkID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcbiAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZUVudGl0eUJ5SWQocm9vdERhdGFJZCk7XG4gIH1cblxuICAvKipcbiAgICog6L+95Yqg5Li76KGo5pWw5o2u5Yiw5a6i5oi356uvXG4gICAqL1xuICBwdWJsaWMgYXBwZW5kQXR0YWNobWVudEluZm9zVG9DbGllbnQobGlzdERhdGE6IGFueVtdLCBpc1Jvb3RFbnRpdHk6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGFueVtdPiB7XG4gICAgaWYgKGlzUm9vdEVudGl0eSA9PT0gdHJ1ZSkge1xuICAgICAgY29uc3QgZW50aXRpZXMgPSB0aGlzLnJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XG4gICAgICB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XG4gICAgICByZXR1cm4gb2YobGlzdERhdGEpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCByb290RGF0YUlkID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnkudXBkYXRlRW50aXR5QnlJZChyb290RGF0YUlkKS5waXBlKFxuICAgICAgICBtYXAoKCkgPT4gbGlzdERhdGEpXG4gICAgICApO1xuICAgIH1cbiAgfVxuICBwdWJsaWMgYXBwZW5kQXR0YWNobWVudEluZm9zKGxpc3REYXRhOiBhbnlbXSwga2V5VmFsdWVzOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IE9ic2VydmFibGU8YW55W10+IHtcbiAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMucmVwb3NpdG9yeS5idWlsZEVudGl0aWVzKGxpc3REYXRhKTtcbiAgICB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XG4gICAgLy8g5pu05paw5a6e5L2T5L2/5LmL5Lqn55Sf5Y+Y5pu06ZuGXG4gICAgdGhpcy51cGRhdGVFbnRpdGllcyhlbnRpdGllcywga2V5VmFsdWVzKTtcbiAgICByZXR1cm4gb2YobGlzdERhdGEpO1xuICB9XG4gIHByaXZhdGUgdXBkYXRlRW50aXRpZXMoZW50aXRpZXM6IEVudGl0eVtdLCBrZXlWYWx1ZXM6IHsgW3Byb3A6IHN0cmluZ106IGFueSB9KSB7XG4gICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlRW50aXR5KGVudGl0eSwga2V5VmFsdWVzKTtcbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIHVwZGF0ZUVudGl0eSh0YXJnZXQ6IEVudGl0eSwga2V5VmFsdWVzOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSkge1xuICAgIE9iamVjdC5rZXlzKGtleVZhbHVlcykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIHRoaXMuc2V0VmFsdWVCeVBhdGgodGFyZ2V0LCBrZXksIGtleVZhbHVlc1trZXldKTtcbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIHNldFZhbHVlQnlQYXRoKHRhcmdldDogb2JqZWN0LCBwYXRoOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICBpZiAodGFyZ2V0KSB7XG4gICAgICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy4nKTtcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPD0gMSkge1xuICAgICAgICB0YXJnZXRbcGF0aF0gPSB2YWx1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhdGhzLnNsaWNlKDAsIC0xKS5yZWR1Y2UoKHByZXYsIHBhdGgpID0+IHtcbiAgICAgICAgICBpZiAoIShwcmV2Lmhhc093blByb3BlcnR5KHBhdGgpIHx8IHByZXZbJ19fcHJvdG9fXyddLmhhc093blByb3BlcnR5KHBhdGgpKSkge1xuICAgICAgICAgICAgcHJldltwYXRoXSA9IHt9O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcHJldltwYXRoXTtcbiAgICAgICAgfSwgdGFyZ2V0KVtwYXRoc1twYXRocy5sZW5ndGggLSAxXV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuXG5leHBvcnQgeyBBdHRhY2htZW50RGF0YVNlcnZpY2UgfTtcbiJdfQ==