import { ParseUtil } from './parse_util';
/**
 * 状态机变量解析
 * @summary
 *
 * 解析策略：
 * 1、不带frameId，从顶层StateMachine中解析
 * {STATEMACHINE~/states/key}
 * {STATEMACHINE~/renderStates/key}
 *
 * 2、带frameId，从frameId对应的FrameContext的StateMachine中解析
 * {STATEMACHINE~/frameId/states/key}
 * {STATEMACHINE~/frameId/renderStates/key}
 *
 * 存在的问题：
 * 1、不带frameId从顶层StateMachine解析仅为了兼容，将来改为从当前FrameContext的StateMachine中解析；
 * 2、组合表单中顶层StateMachine是主表单的rootFrameContext的StateMachine，显然不合理（既成事实）；
 * 3、farmeId如果是states或renderStates，导致解析失败，几率很小，但又风险。
 */
var StateMachineVariableParser = /** @class */ (function () {
    /**
     * 构造函数
     */
    function StateMachineVariableParser() {
    }
    /**
     * 解析变量
     * @param expression 变量：格式形如：/frameId/componentId/stateName
     * @param context 上下文
     */
    StateMachineVariableParser.prototype.parse = function (expression, context) {
        var _this = this;
        var paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === "{STATEMACHINE~" + paths[0] + "}") {
            return this.getValue(paths[0], context);
        }
        // 2、其他情况：字符串替换
        paths.forEach(function (path) {
            var searchValue = "{STATEMACHINE~" + path + "}";
            var replaceValue = _this.getValue(path, context);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    };
    /**
     * 提取Session变量名
     * 变量格式：{}
     */
    StateMachineVariableParser.prototype.extractPaths = function (expression) {
        var paths = [];
        // 查找所有的StateMachine变量字符串
        var STATE_MACHINE_PATTERN_G = /\{STATEMACHINE~(\S+?)\}/g;
        var stateMachineVariables = expression.match(STATE_MACHINE_PATTERN_G);
        if (stateMachineVariables === null) {
            return [];
        }
        // 提取后边的路径
        var STATE_MACHINE_PATTERN = /\{STATEMACHINE~(\S+?)\}/;
        stateMachineVariables.forEach(function (sessionVariable) {
            var pathMatches = sessionVariable.match(STATE_MACHINE_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    };
    /**
     * 获取对应的值
     */
    StateMachineVariableParser.prototype.getValue = function (path, context) {
        var pathObj = this.getPathObj(path);
        var stateMachine = this.getTargetStateMachine(pathObj.frameId, context);
        if (pathObj.type === 'currentState') {
            return stateMachine.context.state;
        }
        else if (pathObj.type === 'renderStates') {
            return stateMachine[pathObj.name];
        }
        else {
            throw new Error("\u4E0D\u652F\u7C7B\u578B\u4E3A" + pathObj.type + "\u7684\u72B6\u6001\u673A\u53D8\u91CF");
        }
    };
    /**
     * 解析path，并获取对应的StateMachine实例
     */
    StateMachineVariableParser.prototype.getTargetStateMachine = function (frameId, context) {
        var targetFrameContext;
        if (frameId) {
            targetFrameContext = ParseUtil.getFrameContextById(context, frameId);
        }
        else {
            targetFrameContext = ParseUtil.getRootFrameContext(context);
        }
        if (!targetFrameContext || !targetFrameContext.stateMachine) {
            throw new Error('找不到对应的状态机实例，请检查！');
        }
        return targetFrameContext.stateMachine;
    };
    /**
     * 将Path解析为格式化的Path对象
     */
    StateMachineVariableParser.prototype.getPathObj = function (path) {
        var parsedPathObj;
        var parts = this.splitPath(path);
        if (parts[0] === 'currentState' || parts[0] === 'renderStates') {
            parsedPathObj = {
                frameId: '',
                type: parts[0],
                name: parts[1]
            };
        }
        else {
            parsedPathObj = {
                frameId: parts[0],
                type: parts[1],
                name: parts[2]
            };
        }
        return parsedPathObj;
    };
    /**
     * 分隔Path
     */
    StateMachineVariableParser.prototype.splitPath = function (path) {
        var parts = path.split('/').filter(function (part) {
            return part !== '';
        });
        return parts;
    };
    return StateMachineVariableParser;
}());
export { StateMachineVariableParser };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfbWFjaGluZV92YXJpYWJsZV9wYXJzZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvdmFyaWFibGUvc3RhdGVfbWFjaGluZV92YXJpYWJsZV9wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBVUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUV6Qzs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQkc7QUFDSDtJQUVFOztPQUVHO0lBQ0g7SUFDQSxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLDBDQUFLLEdBQVosVUFBYSxVQUFrQixFQUFFLE9BQVk7UUFBN0MsaUJBZ0JDO1FBZkMsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU1QyxnQkFBZ0I7UUFDaEIsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxVQUFVLEtBQUssbUJBQWlCLEtBQUssQ0FBQyxDQUFDLENBQUMsTUFBRyxFQUFFO1lBQ3JFLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7U0FDekM7UUFFRCxlQUFlO1FBQ2YsS0FBSyxDQUFDLE9BQU8sQ0FBRSxVQUFBLElBQUk7WUFDakIsSUFBTSxXQUFXLEdBQUcsbUJBQWlCLElBQUksTUFBRyxDQUFDO1lBQzdDLElBQU0sWUFBWSxHQUFHLEtBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELFVBQVUsR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQVEsVUFBVSxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7O09BR0c7SUFDSyxpREFBWSxHQUFwQixVQUFxQixVQUFrQjtRQUNyQyxJQUFNLEtBQUss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QUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssOENBQVMsR0FBakIsVUFBa0IsSUFBWTtRQUM1QixJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLElBQVk7WUFDaEQsT0FBTyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ3JCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUgsaUNBQUM7QUFBRCxDQUFDLEFBN0hELElBNkhDO0FBRUQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBTdGF0ZU1hY2hpbmXlj5jph4/op6PmnpBcclxuICogQEF1dGhvcjogV2l0dFxyXG4gKiBARGF0ZTogMjAxOC0xMi0wNCAxNzowOTo0MlxyXG4gKiBATGFzdCBNb2RpZmllZCBieTogV2l0dFxyXG4gKiBATGFzdCBNb2RpZmllZCB0aW1lOiAyMDE5LTEwLTMwIDExOjA3OjEwXHJcbiAqL1xyXG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi4vdmlldy1tb2RlbC9pbmRleCc7XHJcbmltcG9ydCB7IFN0YXRlTWFjaGluZSB9IGZyb20gJy4uL3N0YXRlLW1hY2hpbmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBWYXJpYWJsZVBhcnNlciB9IGZyb20gJy4vdmFyaWFibGVfcGFyc2VyJztcclxuaW1wb3J0IHsgUGFyc2VVdGlsIH0gZnJvbSAnLi9wYXJzZV91dGlsJztcclxuXHJcbi8qKlxyXG4gKiDnirbmgIHmnLrlj5jph4/op6PmnpBcclxuICogQHN1bW1hcnlcclxuICpcclxuICog6Kej5p6Q562W55Wl77yaXHJcbiAqIDHjgIHkuI3luKZmcmFtZUlk77yM5LuO6aG25bGCU3RhdGVNYWNoaW5l5Lit6Kej5p6QXHJcbiAqIHtTVEFURU1BQ0hJTkV+L3N0YXRlcy9rZXl9XHJcbiAqIHtTVEFURU1BQ0hJTkV+L3JlbmRlclN0YXRlcy9rZXl9XHJcbiAqXHJcbiAqIDLjgIHluKZmcmFtZUlk77yM5LuOZnJhbWVJZOWvueW6lOeahEZyYW1lQ29udGV4dOeahFN0YXRlTWFjaGluZeS4reino+aekFxyXG4gKiB7U1RBVEVNQUNISU5Ffi9mcmFtZUlkL3N0YXRlcy9rZXl9XHJcbiAqIHtTVEFURU1BQ0hJTkV+L2ZyYW1lSWQvcmVuZGVyU3RhdGVzL2tleX1cclxuICpcclxuICog5a2Y5Zyo55qE6Zeu6aKY77yaXHJcbiAqIDHjgIHkuI3luKZmcmFtZUlk5LuO6aG25bGCU3RhdGVNYWNoaW5l6Kej5p6Q5LuF5Li65LqG5YW85a6577yM5bCG5p2l5pS55Li65LuO5b2T5YmNRnJhbWVDb250ZXh055qEU3RhdGVNYWNoaW5l5Lit6Kej5p6Q77ybXHJcbiAqIDLjgIHnu4TlkIjooajljZXkuK3pobblsYJTdGF0ZU1hY2hpbmXmmK/kuLvooajljZXnmoRyb290RnJhbWVDb250ZXh055qEU3RhdGVNYWNoaW5l77yM5pi+54S25LiN5ZCI55CG77yI5pei5oiQ5LqL5a6e77yJ77ybXHJcbiAqIDPjgIFmYXJtZUlk5aaC5p6c5pivc3RhdGVz5oiWcmVuZGVyU3RhdGVz77yM5a+86Ie06Kej5p6Q5aSx6LSl77yM5Yeg546H5b6I5bCP77yM5L2G5Y+I6aOO6Zmp44CCXHJcbiAqL1xyXG5jbGFzcyBTdGF0ZU1hY2hpbmVWYXJpYWJsZVBhcnNlciBpbXBsZW1lbnRzIFZhcmlhYmxlUGFyc2VyIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnN0cnVjdG9yKCkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6Kej5p6Q5Y+Y6YePXHJcbiAgICogQHBhcmFtIGV4cHJlc3Npb24g5Y+Y6YeP77ya5qC85byP5b2i5aaC77yaL2ZyYW1lSWQvY29tcG9uZW50SWQvc3RhdGVOYW1lXHJcbiAgICogQHBhcmFtIGNvbnRleHQg5LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIHBhcnNlKGV4cHJlc3Npb246IHN0cmluZywgY29udGV4dDogYW55KTogYW55IHtcclxuICAgIGNvbnN0IHBhdGhzID0gdGhpcy5leHRyYWN0UGF0aHMoZXhwcmVzc2lvbik7XHJcblxyXG4gICAgLy8gMeOAgeWNleS4queahOihqOi+vuW8j++8muebtOaOpeaxguWAvFxyXG4gICAgaWYgKHBhdGhzLmxlbmd0aCA9PT0gMSAmJiBleHByZXNzaW9uID09PSBge1NUQVRFTUFDSElORX4ke3BhdGhzWzBdfX1gKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKHBhdGhzWzBdLCBjb250ZXh0KTtcclxuICAgIH1cclxuXHJcbiAgICAvLyAy44CB5YW25LuW5oOF5Ya177ya5a2X56ym5Liy5pu/5o2iXHJcbiAgICBwYXRocy5mb3JFYWNoKCBwYXRoID0+IHtcclxuICAgICAgY29uc3Qgc2VhcmNoVmFsdWUgPSBge1NUQVRFTUFDSElORX4ke3BhdGh9fWA7XHJcbiAgICAgIGNvbnN0IHJlcGxhY2VWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUocGF0aCwgY29udGV4dCk7XHJcbiAgICAgIGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2Uoc2VhcmNoVmFsdWUsIHJlcGxhY2VWYWx1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gIGV4cHJlc3Npb247XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmj5Dlj5ZTZXNzaW9u5Y+Y6YeP5ZCNXHJcbiAgICog5Y+Y6YeP5qC85byP77yae31cclxuICAgKi9cclxuICBwcml2YXRlIGV4dHJhY3RQYXRocyhleHByZXNzaW9uOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwYXRoczogc3RyaW5nW10gID0gW107XHJcblxyXG4gICAgLy8g5p+l5om+5omA5pyJ55qEU3RhdGVNYWNoaW5l5Y+Y6YeP5a2X56ym5LiyXHJcbiAgICBjb25zdCBTVEFURV9NQUNISU5FX1BBVFRFUk5fRyA9IC9cXHtTVEFURU1BQ0hJTkV+KFxcUys/KVxcfS9nO1xyXG4gICAgY29uc3Qgc3RhdGVNYWNoaW5lVmFyaWFibGVzID0gZXhwcmVzc2lvbi5tYXRjaChTVEFURV9NQUNISU5FX1BBVFRFUk5fRyk7XHJcbiAgICBpZiAoc3RhdGVNYWNoaW5lVmFyaWFibGVzID09PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmj5Dlj5blkI7ovrnnmoTot6/lvoRcclxuICAgIGNvbnN0IFNUQVRFX01BQ0hJTkVfUEFUVEVSTiA9IC9cXHtTVEFURU1BQ0hJTkV+KFxcUys/KVxcfS87XHJcbiAgICBzdGF0ZU1hY2hpbmVWYXJpYWJsZXMuZm9yRWFjaCggc2Vzc2lvblZhcmlhYmxlID0+ICB7XHJcbiAgICAgIGNvbnN0IHBhdGhNYXRjaGVzID0gc2Vzc2lvblZhcmlhYmxlLm1hdGNoKFNUQVRFX01BQ0hJTkVfUEFUVEVSTik7XHJcbiAgICAgIGlmIChwYXRoTWF0Y2hlcyAhPSBudWxsICYmIHBhdGhNYXRjaGVzLmxlbmd0aCA9PT0gMikge1xyXG4gICAgICAgIHBhdGhzLnB1c2gocGF0aE1hdGNoZXNbMV0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blr7nlupTnmoTlgLxcclxuICAgKi9cclxuICBwcml2YXRlIGdldFZhbHVlKHBhdGg6IHN0cmluZywgY29udGV4dDogYW55KTogYW55IHtcclxuXHJcbiAgICBjb25zdCBwYXRoT2JqID0gdGhpcy5nZXRQYXRoT2JqKHBhdGgpO1xyXG4gICAgY29uc3Qgc3RhdGVNYWNoaW5lID0gdGhpcy5nZXRUYXJnZXRTdGF0ZU1hY2hpbmUocGF0aE9iai5mcmFtZUlkLCBjb250ZXh0KTtcclxuXHJcbiAgICBpZiAocGF0aE9iai50eXBlID09PSAnY3VycmVudFN0YXRlJykge1xyXG4gICAgICByZXR1cm4gc3RhdGVNYWNoaW5lLmNvbnRleHQuc3RhdGU7XHJcbiAgICB9IGVsc2UgaWYgKHBhdGhPYmoudHlwZSA9PT0gJ3JlbmRlclN0YXRlcycpIHtcclxuICAgICAgcmV0dXJuIHN0YXRlTWFjaGluZVtwYXRoT2JqLm5hbWVdIGFzIGJvb2xlYW47XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYOS4jeaUr+exu+Wei+S4uiR7cGF0aE9iai50eXBlfeeahOeKtuaAgeacuuWPmOmHj2ApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6Kej5p6QcGF0aO+8jOW5tuiOt+WPluWvueW6lOeahFN0YXRlTWFjaGluZeWunuS+i1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VGFyZ2V0U3RhdGVNYWNoaW5lKGZyYW1lSWQ6IHN0cmluZywgY29udGV4dCk6IFN0YXRlTWFjaGluZSB7XHJcbiAgICBsZXQgdGFyZ2V0RnJhbWVDb250ZXh0OiBWaWV3TW9kZWxDb250ZXh0O1xyXG4gICAgaWYgKGZyYW1lSWQpIHtcclxuICAgICAgdGFyZ2V0RnJhbWVDb250ZXh0ID0gUGFyc2VVdGlsLmdldEZyYW1lQ29udGV4dEJ5SWQoY29udGV4dCwgZnJhbWVJZCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0YXJnZXRGcmFtZUNvbnRleHQgPSBQYXJzZVV0aWwuZ2V0Um9vdEZyYW1lQ29udGV4dChjb250ZXh0KTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXRhcmdldEZyYW1lQ29udGV4dCB8fCAhdGFyZ2V0RnJhbWVDb250ZXh0LnN0YXRlTWFjaGluZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ+aJvuS4jeWIsOWvueW6lOeahOeKtuaAgeacuuWunuS+i++8jOivt+ajgOafpe+8gScpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRhcmdldEZyYW1lQ29udGV4dC5zdGF0ZU1hY2hpbmU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIZQYXRo6Kej5p6Q5Li65qC85byP5YyW55qEUGF0aOWvueixoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UGF0aE9iaihwYXRoOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgbGV0IHBhcnNlZFBhdGhPYmo6IGFueTtcclxuICAgIGNvbnN0IHBhcnRzID0gdGhpcy5zcGxpdFBhdGgocGF0aCk7XHJcblxyXG4gICAgaWYgKHBhcnRzWzBdID09PSAnY3VycmVudFN0YXRlJyB8fCBwYXJ0c1swXSA9PT0gJ3JlbmRlclN0YXRlcycpIHtcclxuICAgICAgcGFyc2VkUGF0aE9iaiA9IHtcclxuICAgICAgICBmcmFtZUlkOiAnJyxcclxuICAgICAgICB0eXBlOiBwYXJ0c1swXSxcclxuICAgICAgICBuYW1lOiBwYXJ0c1sxXVxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcGFyc2VkUGF0aE9iaiA9IHtcclxuICAgICAgICBmcmFtZUlkOiBwYXJ0c1swXSxcclxuICAgICAgICB0eXBlOiBwYXJ0c1sxXSxcclxuICAgICAgICBuYW1lOiBwYXJ0c1syXVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwYXJzZWRQYXRoT2JqO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YiG6ZqUUGF0aFxyXG4gICAqL1xyXG4gIHByaXZhdGUgc3BsaXRQYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIGNvbnN0IHBhcnRzID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcigocGFydDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiBwYXJ0ICE9PSAnJztcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHBhcnRzO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IFN0YXRlTWFjaGluZVZhcmlhYmxlUGFyc2VyIH07XHJcbiJdfQ==