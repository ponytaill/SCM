import { Injectable } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { switchMap } from 'rxjs/operators';
import { Observable, Subject } from 'rxjs';
import { of } from 'rxjs/observable/of';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
var POSTER = 'iframePoster';
var RECEIVER = 'iframeReceiver';
var REPOSITORY = 'repository';
// window.hash中funcId的属性名
var FUNC_ID = 'funcId=';
var TAB_ID = 'tabId=';
/**
 * ChangeItemService
 * @scope FrameComponent
 */
var ChangeItemService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ChangeItemService(repository, frameContext, notifyService, languageService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.top = top;
        this.itemChangePoster = new Subject();
        this.itemChangeReceiver = new Subject();
    }
    ChangeItemService.prototype.init = function () {
        this.top['topMap'] = this.top['topMap'] || {};
        this.changeItem = this.changeItem.bind(this);
    };
    ChangeItemService.prototype.setBykey = function (key, value) {
        this.top['topMap'] = this.top['topMap'] || {};
        this.top['topMap'][this.tabId] = this.top['topMap'][this.tabId] || {};
        var topObject = this.top['topMap'][this.tabId];
        topObject[key] = value;
    };
    ChangeItemService.prototype.getByKey = function (key) {
        var topObject = this.top['topMap'][this.tabId] || {};
        return topObject[key];
    };
    // 建立iframe通信
    ChangeItemService.prototype.setIframePoster = function () {
        if (this.getByKey[POSTER]) {
            return;
        }
        else {
            this.setBykey(POSTER, this.itemChangePoster);
        }
    };
    ChangeItemService.prototype.getIframePoster = function () {
        this.itemChangePoster = this.getByKey(RECEIVER);
        this.setBykey(RECEIVER, this.itemChangeReceiver);
    };
    ChangeItemService.prototype.changeItem = function (type, id, parentId) {
        var _this = this;
        // 根据是否是弹出式卡片取不同的tabId
        var virtualRootFrameContext = this.frameContext.getVirtualRootFrameContext();
        var virtualRootComponent = virtualRootFrameContext.frameComponent;
        var isDialogComponent = virtualRootComponent['isDialogRootComponent'] || false;
        if (isDialogComponent) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
        }
        else {
            this.tabId = parentId;
        }
        this.itemChangeReceiver = this.getByKey(RECEIVER);
        return Observable.create(function (subscriber) {
            _this.getNextItemByCurrentId(id, type).subscribe(function (result) {
                subscriber.next(result);
            });
        });
    };
    // 在list初始化时调用，缓存list的repository
    ChangeItemService.prototype.setRepository = function () {
        if (window.location.hash.includes(TAB_ID)) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
            this.setBykey(REPOSITORY, this.frameContext.repository);
            this.setIframePoster();
            this.getIframePoster();
        }
    };
    // 根据类型和id获取相邻的数据
    ChangeItemService.prototype.getNextItemByCurrentId = function (currentId, type) {
        var repository = this.getByKey(REPOSITORY);
        var _a = repository.entityCollection.paginationInfo, pageSize = _a.pageSize, pageIndex = _a.pageIndex, total = _a.total;
        var currentIdx = null;
        var list = repository.entityCollection.getAllEntities();
        list.find(function (x, idx) {
            if (x.id === currentId) {
                currentIdx = idx;
            }
        });
        // 没有在列表中找到数据，返回空
        if (currentIdx === null) {
            // 新增取消当前无数据时点上一条下一条
            if (list.length) {
                switch (type) {
                    case 'prev':
                        return of(list[list.length - 1].id);
                        break;
                    case 'next':
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return of(null);
                        break;
                }
            }
            return of(null);
        }
        var nextIdx = currentIdx;
        switch (type) {
            case 'prev':
                // 当前页第一条,且非第一页,取上一页最后一条
                if (currentIdx === 0 && pageIndex !== 1) {
                    return repository.getEntities([], [], pageSize, pageIndex - 1).pipe(switchMap(function (result) {
                        nextIdx = pageSize - 1;
                        return of(result[nextIdx].id);
                    }));
                }
                // 第一页第一条，仍返回原有数据
                else if (currentIdx === 0 && pageIndex === 1) {
                    this.notifyService.info(this.languageService.changeToFirst, { hideTitle: true });
                    return of(list[nextIdx].id);
                }
                // 不是第一条，返回上一条
                else {
                    nextIdx = currentIdx - 1;
                    return of(list[nextIdx].id);
                }
                break;
            case 'next':
                // 超过当前页
                if (currentIdx + 1 + 1 > list.length) {
                    // 且非最后一条数据,取下一页第一条数据
                    if (((pageIndex - 1) * pageSize + currentIdx + 1) < total) {
                        return repository.getEntities([], [], pageSize, pageIndex + 1).pipe(switchMap(function (result) {
                            return of(result[0].id);
                        }));
                    }
                    // 最后一条数据，仍返回原数据
                    else {
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return of(list[nextIdx].id);
                    }
                }
                else {
                    nextIdx = currentIdx + 1;
                    return of(list[nextIdx].id);
                }
                break;
        }
    };
    ChangeItemService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ChangeItemService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext },
        { type: FormNotifyService },
        { type: LanguageService }
    ]; };
    return ChangeItemService;
}());
export { ChangeItemService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlLWl0ZW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9jaGFuZ2UtaXRlbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUdwRCxJQUFNLE1BQU0sR0FBRyxjQUFjLENBQUM7QUFDOUIsSUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUM7QUFDbEMsSUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDO0FBQ2hDLHlCQUF5QjtBQUN6QixJQUFNLE9BQU8sR0FBRyxTQUFTLENBQUM7QUFDMUIsSUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDO0FBQ3hCOzs7R0FHRztBQUNIO0lBUUU7O09BRUc7SUFDSCwyQkFDVSxVQUEyQixFQUMzQixZQUEwQixFQUMxQixhQUFnQyxFQUNoQyxlQUFnQztRQUhoQyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixrQkFBYSxHQUFiLGFBQWEsQ0FBbUI7UUFDaEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBWm5DLFFBQUcsR0FBRyxHQUFHLENBQUM7UUFHVixxQkFBZ0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO1FB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QyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztxQkFDN0I7aUJBQ0Y7cUJBQU07b0JBQ0wsT0FBTyxHQUFHLFVBQVUsR0FBRyxDQUFDLENBQUM7b0JBQ3pCLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztpQkFDN0I7Z0JBQ0QsTUFBTTtTQUNUO0lBQ0gsQ0FBQzs7Z0JBcEpGLFVBQVU7Ozs7Z0JBbEJGLFVBQVU7Z0JBQUUsWUFBWTtnQkFJeEIsaUJBQWlCO2dCQUNqQixlQUFlOztJQW9LeEIsd0JBQUM7Q0FBQSxBQXZKRCxJQXVKQztBQUVELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeSwgRnJhbWVDb250ZXh0fSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpYmVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS9vZic7XG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4vZm9ybS1ub3RpZnkuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XG5cblxuY29uc3QgUE9TVEVSID0gJ2lmcmFtZVBvc3Rlcic7XG5jb25zdCBSRUNFSVZFUiA9ICdpZnJhbWVSZWNlaXZlcic7XG5jb25zdCBSRVBPU0lUT1JZID0gJ3JlcG9zaXRvcnknO1xuLy8gd2luZG93Lmhhc2jkuK1mdW5jSWTnmoTlsZ7mgKflkI1cbmNvbnN0IEZVTkNfSUQgPSAnZnVuY0lkPSc7XG5jb25zdCBUQUJfSUQgPSAndGFiSWQ9Jztcbi8qKlxuICogQ2hhbmdlSXRlbVNlcnZpY2VcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxuICovXG5ASW5qZWN0YWJsZSgpXG5jbGFzcyBDaGFuZ2VJdGVtU2VydmljZSB7XG5cbiAgcHVibGljIHRvcCA9IHRvcDtcbiAgcHJpdmF0ZSBmdW5jSWQ6IHN0cmluZztcbiAgcHJpdmF0ZSB0YWJJZDogc3RyaW5nO1xuICBwdWJsaWMgaXRlbUNoYW5nZVBvc3RlciA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgcHVibGljIGl0ZW1DaGFuZ2VSZWNlaXZlciA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcbiAgICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2VcbiAgKSB7XG4gIH1cblxuICBpbml0KCkge1xuICAgIHRoaXMudG9wWyd0b3BNYXAnXSA9IHRoaXMudG9wWyd0b3BNYXAnXSB8fCB7fTtcbiAgICB0aGlzLmNoYW5nZUl0ZW0gPSB0aGlzLmNoYW5nZUl0ZW0uYmluZCh0aGlzKTtcbiAgfVxuXG4gIHNldEJ5a2V5KGtleTogc3RyaW5nLCB2YWx1ZTogYW55KSB7XG4gICAgdGhpcy50b3BbJ3RvcE1hcCddID0gdGhpcy50b3BbJ3RvcE1hcCddIHx8IHt9O1xuICAgIHRoaXMudG9wWyd0b3BNYXAnXVt0aGlzLnRhYklkXSA9IHRoaXMudG9wWyd0b3BNYXAnXVt0aGlzLnRhYklkXSB8fCB7fTtcbiAgICBjb25zdCB0b3BPYmplY3QgPSB0aGlzLnRvcFsndG9wTWFwJ11bdGhpcy50YWJJZF07XG4gICAgdG9wT2JqZWN0W2tleV0gPSB2YWx1ZTtcbiAgfVxuXG4gIGdldEJ5S2V5KGtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgdG9wT2JqZWN0ID0gdGhpcy50b3BbJ3RvcE1hcCddW3RoaXMudGFiSWRdIHx8IHt9O1xuICAgIHJldHVybiB0b3BPYmplY3Rba2V5XTtcbiAgfVxuXG4gIC8vIOW7uueri2lmcmFtZemAmuS/oVxuICBzZXRJZnJhbWVQb3N0ZXIoKSB7XG4gICAgaWYgKHRoaXMuZ2V0QnlLZXlbUE9TVEVSXSkge1xuICAgICAgcmV0dXJuO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldEJ5a2V5KFBPU1RFUiwgdGhpcy5pdGVtQ2hhbmdlUG9zdGVyKTtcbiAgICB9XG4gIH1cblxuICBnZXRJZnJhbWVQb3N0ZXIoKSB7XG4gICAgdGhpcy5pdGVtQ2hhbmdlUG9zdGVyID0gdGhpcy5nZXRCeUtleShSRUNFSVZFUik7XG4gICAgdGhpcy5zZXRCeWtleShSRUNFSVZFUiwgdGhpcy5pdGVtQ2hhbmdlUmVjZWl2ZXIpO1xuICB9XG5cbiAgY2hhbmdlSXRlbSh0eXBlOiBzdHJpbmcsIGlkOiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcpIHtcbiAgICAvLyDmoLnmja7mmK/lkKbmmK/lvLnlh7rlvI/ljaHniYflj5bkuI3lkIznmoR0YWJJZFxuICAgIGNvbnN0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcbiAgICBjb25zdCB2aXJ0dWFsUm9vdENvbXBvbmVudCA9IHZpcnR1YWxSb290RnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50O1xuICAgIGNvbnN0IGlzRGlhbG9nQ29tcG9uZW50ID0gdmlydHVhbFJvb3RDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddIHx8IGZhbHNlO1xuICAgIGlmIChpc0RpYWxvZ0NvbXBvbmVudCkge1xuICAgICAgdGhpcy50YWJJZCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KFRBQl9JRClbMV0uc2xpY2UoMCwgd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoVEFCX0lEKVsxXS5pbmRleE9mKCcmJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRhYklkID0gcGFyZW50SWQ7XG4gICAgfVxuICAgIHRoaXMuaXRlbUNoYW5nZVJlY2VpdmVyID0gdGhpcy5nZXRCeUtleShSRUNFSVZFUik7XG4gICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChzdWJzY3JpYmVyOiBTdWJzY3JpYmVyPGFueT4pID0+IHtcbiAgICAgIHRoaXMuZ2V0TmV4dEl0ZW1CeUN1cnJlbnRJZChpZCwgdHlwZSkuc3Vic2NyaWJlKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICBzdWJzY3JpYmVyLm5leHQocmVzdWx0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8g5ZyobGlzdOWIneWni+WMluaXtuiwg+eUqO+8jOe8k+WtmGxpc3TnmoRyZXBvc2l0b3J5XG4gIHNldFJlcG9zaXRvcnkoKSB7XG4gICAgaWYgKHdpbmRvdy5sb2NhdGlvbi5oYXNoLmluY2x1ZGVzKFRBQl9JRCkpIHtcbiAgICAgIHRoaXMudGFiSWQgPSB3aW5kb3cubG9jYXRpb24uaGFzaC5zcGxpdChUQUJfSUQpWzFdLnNsaWNlKDAsIHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KFRBQl9JRClbMV0uaW5kZXhPZignJicpKTtcbiAgICAgIHRoaXMuc2V0QnlrZXkoUkVQT1NJVE9SWSwgdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSk7XG4gICAgICB0aGlzLnNldElmcmFtZVBvc3RlcigpO1xuICAgICAgdGhpcy5nZXRJZnJhbWVQb3N0ZXIoKTtcbiAgICB9XG4gIH1cblxuICAvLyDmoLnmja7nsbvlnovlkoxpZOiOt+WPluebuOmCu+eahOaVsOaNrlxuICBnZXROZXh0SXRlbUJ5Q3VycmVudElkKGN1cnJlbnRJZDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gdGhpcy5nZXRCeUtleShSRVBPU0lUT1JZKTtcbiAgICBjb25zdCB7IHBhZ2VTaXplLCBwYWdlSW5kZXgsIHRvdGFsIH0gPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24ucGFnaW5hdGlvbkluZm87XG4gICAgbGV0IGN1cnJlbnRJZHggPSBudWxsO1xuICAgIGNvbnN0IGxpc3QgPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKTtcbiAgICBsaXN0LmZpbmQoKHg6IGFueSwgaWR4OiBzdHJpbmcpID0+IHtcbiAgICAgIGlmICh4LmlkID09PSBjdXJyZW50SWQpIHtcbiAgICAgICAgY3VycmVudElkeCA9IGlkeDtcbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyDmsqHmnInlnKjliJfooajkuK3mib7liLDmlbDmja7vvIzov5Tlm57nqbpcbiAgICBpZiAoY3VycmVudElkeCA9PT0gbnVsbCkge1xuICAgICAgLy8g5paw5aKe5Y+W5raI5b2T5YmN5peg5pWw5o2u5pe254K55LiK5LiA5p2h5LiL5LiA5p2hXG4gICAgICBpZiAobGlzdC5sZW5ndGgpIHtcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgY2FzZSAncHJldic6XG4gICAgICAgICAgICByZXR1cm4gb2YobGlzdFtsaXN0Lmxlbmd0aCAtIDFdLmlkKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ25leHQnOlxuICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2hhbmdlVG9MYXN0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gb2YobnVsbCk7XG4gICAgfVxuICAgIGxldCBuZXh0SWR4ID0gY3VycmVudElkeDtcbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ3ByZXYnOlxuICAgICAgICAvLyDlvZPliY3pobXnrKzkuIDmnaEs5LiU6Z2e56ys5LiA6aG1LOWPluS4iuS4gOmhteacgOWQjuS4gOadoVxuICAgICAgICBpZiAoY3VycmVudElkeCA9PT0gMCAmJiBwYWdlSW5kZXggIT09IDEpIHtcbiAgICAgICAgICByZXR1cm4gcmVwb3NpdG9yeS5nZXRFbnRpdGllcyhbXSwgW10sIHBhZ2VTaXplLCBwYWdlSW5kZXggLSAxKS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgIG5leHRJZHggPSBwYWdlU2l6ZSAtIDE7XG4gICAgICAgICAgICAgIHJldHVybiBvZihyZXN1bHRbbmV4dElkeF0uaWQpO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIC8vIOesrOS4gOmhteesrOS4gOadoe+8jOS7jei/lOWbnuWOn+acieaVsOaNrlxuICAgICAgICBlbHNlIGlmIChjdXJyZW50SWR4ID09PSAwICYmIHBhZ2VJbmRleCA9PT0gMSkge1xuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNoYW5nZVRvRmlyc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcbiAgICAgICAgfVxuICAgICAgICAvLyDkuI3mmK/nrKzkuIDmnaHvvIzov5Tlm57kuIrkuIDmnaFcbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgbmV4dElkeCA9IGN1cnJlbnRJZHggLSAxO1xuICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ25leHQnOlxuICAgICAgICAvLyDotoXov4flvZPliY3pobVcbiAgICAgICAgaWYgKGN1cnJlbnRJZHggKyAxICsgMSA+IGxpc3QubGVuZ3RoKSB7XG4gICAgICAgICAgLy8g5LiU6Z2e5pyA5ZCO5LiA5p2h5pWw5o2uLOWPluS4i+S4gOmhteesrOS4gOadoeaVsOaNrlxuICAgICAgICAgIGlmICgoKHBhZ2VJbmRleCAtIDEpICogcGFnZVNpemUgKyBjdXJyZW50SWR4ICsgMSkgPCB0b3RhbCkge1xuICAgICAgICAgICAgcmV0dXJuIHJlcG9zaXRvcnkuZ2V0RW50aXRpZXMoW10sIFtdLCBwYWdlU2l6ZSwgcGFnZUluZGV4ICsgMSkucGlwZShzd2l0Y2hNYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3VsdFswXS5pZCk7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIOacgOWQjuS4gOadoeaVsOaNru+8jOS7jei/lOWbnuWOn+aVsOaNrlxuICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2hhbmdlVG9MYXN0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbmV4dElkeCA9IGN1cnJlbnRJZHggKyAxO1xuICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuXG59XG5cbmV4cG9ydCB7IENoYW5nZUl0ZW1TZXJ2aWNlIH07XG4iXX0=