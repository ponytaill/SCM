/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
export class SearchHandle {
    /**
     * @param {?} ttInstance
     */
    constructor(ttInstance) {
        this.ttInstance = ttInstance;
        this.allNodes = [];
    }
    // 刷新查询结果
    /**
     * @param {?=} from
     * @return {?}
     */
    research(from = 'client') {
        const { field, value } = this.ttInstance.searchData;
        this.allNodes = [];
        this.search(field, value, from);
    }
    /**
     * @param {?} field
     * @param {?} value
     * @param {?=} from
     * @return {?}
     */
    search(field, value, from = 'client') {
        if (!this.allNodes.length) {
            this.allNodes = cloneDeep(this.ttInstance.state.rowNodes);
        }
        switch (from) {
            case 'server':
                this.searchOnServer(field, value);
                break;
            default:
                if (value !== '' && value !== undefined) {
                    /** @type {?} */
                    const values = this.searchOnClient(field, value, this.allNodes);
                    this.ttInstance.state.searchRowNodes = null;
                    this._updateSerializedValues(values);
                }
                else {
                    this.ttInstance.updateSerializedValue();
                }
                if (this.ttInstance.checkeds && this.ttInstance.checkeds.length) {
                    this.ttInstance.checkedNodes(this.ttInstance.checkeds.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n.data[this.ttInstance.idField])));
                    this.ttInstance['updateNodeStatus']();
                    this.ttInstance.detectChanges();
                }
                else {
                    this.ttInstance.resize();
                    this.ttInstance.detectChanges();
                    if (this.ttInstance.psRef) {
                        this.ttInstance.psRef.directiveRef.update();
                    }
                }
                break;
        }
    }
    /**
     * @private
     * @param {?} visibleItems
     * @return {?}
     */
    _updateSerializedValues(visibleItems) {
        /** @type {?} */
        const pids = ((/** @type {?} */ (visibleItems.map((/**
         * @param {?} n
         * @return {?}
         */
        n => [...n.parents, n.id]))))).flat();
        /** @type {?} */
        const pidArr = Array.from(new Set(pids));
        /** @type {?} */
        const rowNodes = this.allNodes.filter((/**
         * @param {?} n
         * @return {?}
         */
        n => pidArr.some((/**
         * @param {?} item
         * @return {?}
         */
        item => item == n.id)))).map((/**
         * @param {?} r
         * @return {?}
         */
        r => {
            r.expanded = true;
            this.ttInstance.updateNodeProperty(r.id, { expanded: true });
            return r;
        }));
        this.ttInstance.serializedValue = this.resetTreeData(null, rowNodes);
        this.ttInstance.state.searchRowNodes = this.ttInstance.serializedValue;
    }
    /**
     * @param {?} item
     * @param {?} allNodes
     * @return {?}
     */
    findParent(item, allNodes) {
        /** @type {?} */
        let res = [];
        if (item && allNodes && allNodes.length) {
            /** @type {?} */
            const p = allNodes.find((/**
             * @param {?} t1
             * @return {?}
             */
            t1 => t1.id === item.data[this.ttInstance.idField]));
            res.push(p);
            if (p.parent) {
                res = res.concat(this.findParent(p.parent, allNodes));
            }
        }
        return res;
    }
    /**
     * @private
     * @param {?} item
     * @param {?} value
     * @param {?=} fields
     * @return {?}
     */
    searchExpression(item, value, fields = []) {
        /** @type {?} */
        const _fields = fields.length ? fields : this.ttInstance.columns.map((/**
         * @param {?} c
         * @return {?}
         */
        c => c.field));
        /** @type {?} */
        const results = _fields.map((/**
         * @param {?} f
         * @return {?}
         */
        f => {
            /** @type {?} */
            const targetValue = '' + this.getValue(f, item.node.data);
            if (targetValue !== undefined) {
                if (typeof targetValue === 'number') {
                    return targetValue === parseFloat(value);
                }
                else {
                    return targetValue.indexOf(value) > -1;
                }
            }
            else {
                this.ttInstance.writeConsole(`不存在列 ${f}`);
            }
        }));
        return results.reduce((/**
         * @param {?} flag
         * @param {?} curr
         * @return {?}
         */
        (flag, curr) => {
            return flag || curr;
        }), false);
    }
    /**
     * @private
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    getValue(field, data) {
        if (field) {
            if (field.indexOf('.') > -1) {
                try {
                    return field.split('.').reduce((/**
                     * @param {?} r
                     * @param {?} f
                     * @return {?}
                     */
                    (r, f) => {
                        if (r) {
                            return r[f];
                        }
                        else {
                            return null;
                        }
                    }), data);
                }
                catch (_a) {
                    this.ttInstance.writeConsole(`字段 ${field} 不存在。`);
                }
            }
            else {
                return data[field];
            }
        }
    }
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    getFindTextTotal(field, value, nodes) {
        /** @type {?} */
        let t = 0;
        /** @type {?} */
        const getCount = (/**
         * @param {?} fields
         * @return {?}
         */
        (fields) => {
            /** @type {?} */
            let c = 0;
            nodes.forEach((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                fields.forEach((/**
                 * @param {?} f
                 * @return {?}
                 */
                f => {
                    /** @type {?} */
                    const targetValue = '' + this.getValue(f, n.node.data);
                    if (targetValue !== undefined) {
                        if (targetValue.indexOf(value) > -1) {
                            c++;
                        }
                    }
                }));
            }));
            return c;
        });
        /** @type {?} */
        let _fields = [field];
        if (field === '*') {
            _fields = this.ttInstance.columns.map((/**
             * @param {?} c
             * @return {?}
             */
            c => c.field));
        }
        else if (field.indexOf(',') > -1) {
            _fields = field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            f => f.trim()));
        }
        t = getCount(_fields);
        return t;
    }
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    searchOnClient(field, value, nodes) {
        /** @type {?} */
        let resultNodes = [];
        if (!value) {
            return [];
        }
        if (field === '*') {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => this.searchExpression(n, value)));
        }
        else if (field.indexOf(',') > -1) {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => this.searchExpression(n, value, field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            f => f.trim())))));
        }
        else {
            value = value.toLowerCase();
            if (field.indexOf('.') === -1) {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => ('' + n.node.data[field]).toLowerCase().indexOf(value) > -1));
            }
            else {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => ('' + this.getValue(field, n.node.data)).toLowerCase().indexOf(value) > -1));
            }
        }
        return resultNodes;
    }
    /**
     * @param {?} rowNodes
     * @param {?} allNodes
     * @return {?}
     */
    findParents(rowNodes, allNodes) {
        /** @type {?} */
        let res = [];
        rowNodes.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            res = res.concat(this.findParent(item.node, allNodes));
        }));
        return Array.from(new Set(res));
    }
    /**
     * @private
     * @param {?} parentNode
     * @param {?} visibleItems
     * @return {?}
     */
    resetTreeData(parentNode, visibleItems) {
        /** @type {?} */
        let res = [];
        /** @type {?} */
        let arr = [];
        if (parentNode === null) {
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            t2 => t2.parent === parentNode));
        }
        else {
            parentNode.node.expanded = true;
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            t2 => t2.parent && t2.parent.data[this.ttInstance.idField] === parentNode.id));
            if (!arr.length) {
                parentNode.node.children = [];
            }
            else {
                parentNode.node.children = arr.map((/**
                 * @param {?} tn
                 * @return {?}
                 */
                tn => tn.node));
            }
        }
        arr.forEach((/**
         * @param {?} a
         * @return {?}
         */
        a => {
            a.visible = true;
            res.push(a);
            res = res.concat(this.resetTreeData(a, visibleItems));
        }));
        return cloneDeep(res);
    }
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    searchOnServer(field, value) {
    }
}
if (false) {
    /** @type {?} */
    SearchHandle.prototype.allNodes;
    /**
     * @type {?}
     * @private
     */
    SearchHandle.prototype.ttInstance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLmhhbmRsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktdHJlZXRhYmxlLyIsInNvdXJjZXMiOlsibGliL3NlYXJjaC5oYW5kbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQVdBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsTUFBTSxPQUFPLFlBQVk7Ozs7SUFFckIsWUFBb0IsVUFBOEI7UUFBOUIsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFEbEQsYUFBUSxHQUFHLEVBQUUsQ0FBQztJQUVkLENBQUM7Ozs7OztJQUdELFFBQVEsQ0FBQyxPQUEwQixRQUFRO2NBQ2pDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVTtRQUNuRCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQzs7Ozs7OztJQUVELE1BQU0sQ0FBQyxLQUFhLEVBQUUsS0FBYSxFQUFFLE9BQTBCLFFBQVE7UUFDbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsUUFBUSxJQUFJLEVBQUU7WUFDVixLQUFLLFFBQVE7Z0JBQ1QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ2xDLE1BQU07WUFDVjtnQkFDSSxJQUFJLEtBQUssS0FBSyxFQUFFLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTs7MEJBQy9CLE1BQU0sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEs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QUMsQ0FBQztZQUNaLEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxFQUFDLENBQUM7UUFDSCxPQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDOzs7Ozs7O0lBRU8sY0FBYyxDQUFDLEtBQWEsRUFBRSxLQUFhO0lBRW5ELENBQUM7Q0FFSjs7O0lBbE1HLGdDQUFjOzs7OztJQUNGLGtDQUFzQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGV4dGVuZCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbi8qXHJcbiAqIEBBdXRob3I6IOeWr+eLguengOaJjShsdWNhcyBodWFuZylcclxuICogQERhdGU6IDIwMTgtMTItMTggMTM6Mzg6NTFcclxuICogQExhc3RFZGl0b3JzOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMTktMTEtMTUgMTU6MTM6NTZcclxuICogQENvbXBhbnk6IEluc3B1clxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBUcmVlVGFibGVDb21wb25lbnQgfSBmcm9tICcuL3RyZWV0YWJsZS5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBSb3dOb2RlLCBUcmVlTm9kZSB9IGZyb20gJy4vdHlwZXMvdHJlZW5vZGUnO1xyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5leHBvcnQgY2xhc3MgU2VhcmNoSGFuZGxlIHtcclxuICAgIGFsbE5vZGVzID0gW107XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHR0SW5zdGFuY2U6IFRyZWVUYWJsZUNvbXBvbmVudCkge1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOWIt+aWsOafpeivoue7k+aenFxyXG4gICAgcmVzZWFyY2goZnJvbTogJ2NsaWVudCd8J3NlcnZlcicgPSAnY2xpZW50JyApIHtcclxuICAgICAgICBjb25zdCB7IGZpZWxkLCB2YWx1ZSB9ID0gdGhpcy50dEluc3RhbmNlLnNlYXJjaERhdGE7XHJcbiAgICAgICAgdGhpcy5hbGxOb2RlcyA9IFtdO1xyXG4gICAgICAgIHRoaXMuc2VhcmNoKGZpZWxkLCB2YWx1ZSwgZnJvbSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VhcmNoKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIGZyb206ICdjbGllbnQnfCdzZXJ2ZXInID0gJ2NsaWVudCcpOiBhbnkge1xyXG4gICAgICAgIGlmICghdGhpcy5hbGxOb2Rlcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5hbGxOb2RlcyA9IGNsb25lRGVlcCh0aGlzLnR0SW5zdGFuY2Uuc3RhdGUucm93Tm9kZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBzd2l0Y2ggKGZyb20pIHtcclxuICAgICAgICAgICAgY2FzZSAnc2VydmVyJzpcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VhcmNoT25TZXJ2ZXIoZmllbGQsIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSAnJyAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWVzID0gdGhpcy5zZWFyY2hPbkNsaWVudChmaWVsZCwgdmFsdWUsIHRoaXMuYWxsTm9kZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS5zdGF0ZS5zZWFyY2hSb3dOb2RlcyA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU2VyaWFsaXplZFZhbHVlcyh2YWx1ZXMpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2UudXBkYXRlU2VyaWFsaXplZFZhbHVlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudHRJbnN0YW5jZS5jaGVja2VkcyAmJiB0aGlzLnR0SW5zdGFuY2UuY2hlY2tlZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLmNoZWNrZWROb2Rlcyh0aGlzLnR0SW5zdGFuY2UuY2hlY2tlZHMubWFwKG4gPT4gbi5kYXRhW3RoaXMudHRJbnN0YW5jZS5pZEZpZWxkXSkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZVsndXBkYXRlTm9kZVN0YXR1cyddKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLnJlc2l6ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHRJbnN0YW5jZS5wc1JlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2UucHNSZWYuZGlyZWN0aXZlUmVmLnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfdXBkYXRlU2VyaWFsaXplZFZhbHVlcyh2aXNpYmxlSXRlbXM6IFJvd05vZGVbXSkge1xyXG4gICAgICAgIGNvbnN0IHBpZHMgPSAodmlzaWJsZUl0ZW1zLm1hcChuID0+IFsuLi5uLnBhcmVudHMsIG4uaWRdKSBhcyBhbnkpLmZsYXQoKTtcclxuICAgICAgICBjb25zdCBwaWRBcnIgPSBBcnJheS5mcm9tKG5ldyBTZXQocGlkcykpO1xyXG5cclxuICAgICAgICBjb25zdCByb3dOb2RlcyA9ICB0aGlzLmFsbE5vZGVzLmZpbHRlcihuID0+IHBpZEFyci5zb21lKGl0ZW09Pml0ZW09PW4uaWQpKS5tYXAociA9PiB7XHJcbiAgICAgICAgICAgIHIuZXhwYW5kZWQgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2UudXBkYXRlTm9kZVByb3BlcnR5KHIuaWQsIHtleHBhbmRlZDogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHI7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMudHRJbnN0YW5jZS5zZXJpYWxpemVkVmFsdWUgPSB0aGlzLnJlc2V0VHJlZURhdGEobnVsbCwgcm93Tm9kZXMpO1xyXG4gICAgICAgIHRoaXMudHRJbnN0YW5jZS5zdGF0ZS5zZWFyY2hSb3dOb2RlcyA9IHRoaXMudHRJbnN0YW5jZS5zZXJpYWxpemVkVmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZmluZFBhcmVudChpdGVtOiBUcmVlTm9kZSwgYWxsTm9kZXM6IGFueVtdKSB7XHJcbiAgICAgICAgbGV0IHJlcyA9IFtdO1xyXG4gICAgICAgIGlmIChpdGVtICYmIGFsbE5vZGVzICYmIGFsbE5vZGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCBwID0gYWxsTm9kZXMuZmluZCh0MSA9PiB0MS5pZCA9PT0gaXRlbS5kYXRhW3RoaXMudHRJbnN0YW5jZS5pZEZpZWxkXSk7XHJcbiAgICAgICAgICAgIHJlcy5wdXNoKHApO1xyXG4gICAgICAgICAgICBpZiAocC5wYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgIHJlcyA9IHJlcy5jb25jYXQodGhpcy5maW5kUGFyZW50KHAucGFyZW50LCBhbGxOb2RlcykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZWFyY2hFeHByZXNzaW9uKGl0ZW06IFJvd05vZGUsIHZhbHVlOiBzdHJpbmcsIGZpZWxkczogc3RyaW5nW10gPSBbXSkge1xyXG4gICAgICAgIGNvbnN0IF9maWVsZHMgPSBmaWVsZHMubGVuZ3RoID8gZmllbGRzIDogdGhpcy50dEluc3RhbmNlLmNvbHVtbnMubWFwKGMgPT4gYy5maWVsZCk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0cyA9IF9maWVsZHMubWFwKGYgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXRWYWx1ZSA9ICcnICsgICB0aGlzLmdldFZhbHVlKGYsIGl0ZW0ubm9kZS5kYXRhKTtcclxuICAgICAgICAgICAgaWYgKHRhcmdldFZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0VmFsdWUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFZhbHVlID09PSBwYXJzZUZsb2F0KHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFZhbHVlLmluZGV4T2YodmFsdWUpID4gLTE7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2Uud3JpdGVDb25zb2xlKGDkuI3lrZjlnKjliJcgJHtmfWApO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHRzLnJlZHVjZSgoZmxhZywgY3VycikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZmxhZyB8fCBjdXJyO1xyXG4gICAgICAgIH0sIGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFZhbHVlKGZpZWxkLCBkYXRhKSB7XHJcbiAgICAgICAgaWYgKGZpZWxkKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCcuJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmaWVsZC5zcGxpdCgnLicpLnJlZHVjZSggKHIsIGYpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcltmXTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCBkYXRhICk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2gge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLndyaXRlQ29uc29sZShg5a2X5q61ICR7ZmllbGR9IOS4jeWtmOWcqOOAgmApXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW2ZpZWxkXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRGaW5kVGV4dFRvdGFsKGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIG5vZGVzOiBSb3dOb2RlW10pIHtcclxuICAgICAgICBsZXQgdCA9IDA7XHJcbiAgICAgICAgY29uc3QgZ2V0Q291bnQgPSAoZmllbGRzKTogYW55ID0+IHtcclxuICAgICAgICAgICAgbGV0IGMgPSAwO1xyXG4gICAgICAgICAgICBub2Rlcy5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgZmllbGRzLmZvckVhY2goZiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0VmFsdWUgPSAnJyArICAgdGhpcy5nZXRWYWx1ZShmLCBuLm5vZGUuZGF0YSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFZhbHVlLmluZGV4T2YodmFsdWUpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGMrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGM7XHJcbiAgICAgICAgfTtcclxuICAgICAgICBsZXQgX2ZpZWxkcyA9IFtmaWVsZF07XHJcbiAgICAgICAgaWYgKGZpZWxkID09PSAnKicpIHtcclxuICAgICAgICAgICAgX2ZpZWxkcyA9IHRoaXMudHRJbnN0YW5jZS5jb2x1bW5zLm1hcChjID0+IGMuZmllbGQpO1xyXG5cclxuICAgICAgICB9IGVsc2UgaWYgKGZpZWxkLmluZGV4T2YoJywnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIF9maWVsZHMgPSBmaWVsZC5zcGxpdCgnLCcpLm1hcChmID0+IGYudHJpbSgpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHQgPSBnZXRDb3VudChfZmllbGRzKTtcclxuICAgICAgICByZXR1cm4gdDtcclxuICAgIH1cclxuXHJcbiAgICBzZWFyY2hPbkNsaWVudChmaWVsZDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBub2RlczogUm93Tm9kZVtdKSB7XHJcbiAgICAgICAgbGV0IHJlc3VsdE5vZGVzOiBSb3dOb2RlW10gPSBbXTtcclxuICAgICAgICBpZiAoIXZhbHVlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGZpZWxkID09PSAnKicpIHtcclxuICAgICAgICAgICAgcmVzdWx0Tm9kZXMgPSBub2Rlcy5maWx0ZXIobiA9PiB0aGlzLnNlYXJjaEV4cHJlc3Npb24obiwgdmFsdWUpKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGZpZWxkLmluZGV4T2YoJywnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdE5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gdGhpcy5zZWFyY2hFeHByZXNzaW9uKG4sIHZhbHVlLCBmaWVsZC5zcGxpdCgnLCcpLm1hcChmID0+IGYudHJpbSgpKSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgICAgaWYgKGZpZWxkLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdE5vZGVzID0gbm9kZXMuZmlsdGVyKG4gPT4gKCcnICsgbi5ub2RlLmRhdGFbZmllbGRdKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodmFsdWUpID4gLTEpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0Tm9kZXMgPSBub2Rlcy5maWx0ZXIobiA9PiAoJycgKyB0aGlzLmdldFZhbHVlKGZpZWxkLCBuLm5vZGUuZGF0YSkpLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih2YWx1ZSkgPiAtMSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHROb2RlcztcclxuICAgIH1cclxuXHJcbiAgICBmaW5kUGFyZW50cyhyb3dOb2RlcywgYWxsTm9kZXMpIHtcclxuICAgICAgICBsZXQgcmVzID0gW107XHJcbiAgICAgICAgcm93Tm9kZXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgICAgcmVzID0gcmVzLmNvbmNhdCh0aGlzLmZpbmRQYXJlbnQoaXRlbS5ub2RlLCBhbGxOb2RlcykpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbShuZXcgU2V0KHJlcykpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgcmVzZXRUcmVlRGF0YShwYXJlbnROb2RlOiBSb3dOb2RlLCB2aXNpYmxlSXRlbXM6IFJvd05vZGVbXSkge1xyXG4gICAgICAgIGxldCByZXMgPSBbXTtcclxuICAgICAgICBsZXQgYXJyID0gW107XHJcbiAgICAgICAgaWYgKHBhcmVudE5vZGUgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgYXJyID0gdmlzaWJsZUl0ZW1zLmZpbHRlcih0MiA9PiB0Mi5wYXJlbnQgPT09IHBhcmVudE5vZGUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHBhcmVudE5vZGUubm9kZS5leHBhbmRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIGFyciA9IHZpc2libGVJdGVtcy5maWx0ZXIodDIgPT4gdDIucGFyZW50ICYmIHQyLnBhcmVudC5kYXRhW3RoaXMudHRJbnN0YW5jZS5pZEZpZWxkXSA9PT0gcGFyZW50Tm9kZS5pZCk7XHJcbiAgICAgICAgICAgIGlmICghYXJyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcGFyZW50Tm9kZS5ub2RlLmNoaWxkcmVuID0gW107XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnROb2RlLm5vZGUuY2hpbGRyZW4gPSBhcnIubWFwKCB0biA9PiB0bi5ub2RlICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgYXJyLmZvckVhY2goIGEgPT4ge1xyXG4gICAgICAgICAgICBhLnZpc2libGUgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXMucHVzaChhKTtcclxuICAgICAgICAgICAgcmVzID0gcmVzLmNvbmNhdCh0aGlzLnJlc2V0VHJlZURhdGEoYSwgdmlzaWJsZUl0ZW1zKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIGNsb25lRGVlcChyZXMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VhcmNoT25TZXJ2ZXIoZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xyXG5cclxuICAgIH1cclxuXHJcbn1cclxuIl19