/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { NumberHelperService } from '@farris/ui-common/number';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { Compare, FilterRelation, CompareOperators, SortType } from '@farris/ui-common/types';
import * as i0 from "@angular/core";
import * as i1 from "@farris/ui-common/date";
import * as i2 from "@farris/ui-common/number";
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-01-02 14:12:47
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-18 13:59:34
 * @Company: Inspur
 * @Version: v0.0.1
 */
export class ColumnFormatService {
    /**
     * @param {?} datehelper
     * @param {?} numberhelper
     */
    constructor(datehelper, numberhelper) {
        this.datehelper = datehelper;
        this.numberhelper = numberhelper;
    }
    /**
     * @param {?} value
     * @param {?=} data
     * @param {?=} formatter
     * @param {?=} context
     * @return {?}
     */
    format(value, data, formatter, context) {
        if (formatter) {
            if (typeof (formatter) === 'function') {
                context = context || {};
                return formatter(value, data, Object.assign({ date: this.datehelper, number: this.numberhelper, format: this }, context));
            }
            else {
                if (formatter['type']) {
                    /** @type {?} */
                    const fmt = (/** @type {?} */ (formatter));
                    switch (fmt.type) {
                        case 'datetime':
                            if (fmt.options && fmt.options.format) {
                                return this.dateTimeFormat(value, fmt.options);
                            }
                            return value;
                        case 'number':
                            return this.numberFormat(value, fmt.options);
                        case 'enum':
                            return this.enumFormat(value, fmt.options);
                        case 'image':
                            return this.imageFormat(value, fmt.options);
                        case 'boolean':
                            return this.booleanFormat(value, fmt.options);
                        default:
                            return value;
                    }
                }
            }
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?} opts
     * @return {?}
     */
    dateTimeFormat(value, opts) {
        if (value) {
            /** @type {?} */
            let fmt = 'yyyy-MM-dd';
            if (typeof (opts) === 'string') {
                fmt = opts;
            }
            else if (typeof (opts) === 'object') {
                fmt = opts.format;
            }
            fmt = fmt.replace('YYYY', 'yyyy').replace('-DD', '-dd');
            if (typeof (opts) === 'object' && opts.dateRange) {
                /** @type {?} */
                const splitStr = opts.dateRangeDatesDelimiter || '~';
                let [beginDate, endDate] = value.split(splitStr);
                beginDate = this.datehelper.formatTo(beginDate, fmt);
                endDate = this.datehelper.formatTo(endDate, fmt);
                return beginDate + splitStr + endDate;
            }
            return this.datehelper.formatTo(value, fmt);
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    numberFormat(value, opts) {
        return this.numberhelper.formatNumber(value, opts);
        // if (value !== undefined && value !== '' && value !== NaN) {
        //     return this.numberhelper.formatMoney(value, opts);
        // }
        // return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    enumFormat(value, opts) {
        if (value === undefined || value === null) {
            value = '';
        }
        if (opts && opts.data && opts.data.length) {
            /** @type {?} */
            const val = value.toString();
            /** @type {?} */
            let arr = [val];
            if (val.indexOf(',') > -1) { // 多选
                arr = val.split(',');
            }
            /** @type {?} */
            const str = [];
            arr.forEach((/**
             * @param {?} v
             * @return {?}
             */
            v => {
                /** @type {?} */
                const n = opts.data.find((/**
                 * @param {?} item
                 * @return {?}
                 */
                item => item[opts.valueField].toString() == v));
                if (n) {
                    str.push(n[opts.textField]);
                }
            }));
            if (str.length) {
                return str.join(',');
            }
            return value;
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    imageFormat(value, opts) {
        if (value) {
            if (opts) {
                /** @type {?} */
                const arrStr = [`<img src="${value}" `];
                if (opts.width) {
                    arrStr.push(`width="${opts.width}"`);
                }
                if (opts.height) {
                    arrStr.push(`height="${opts.height}"`);
                }
                arrStr.push('>');
                return arrStr.join('');
            }
            else {
                return `<img src="${value}">`;
            }
        }
        return value;
    }
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    booleanFormat(value, opts) {
        if (value !== undefined) {
            if (opts) {
                /** @type {?} */
                const val = value ? opts.trueText : opts.falseText;
                if (val === null || val === undefined) {
                    return value;
                }
                return val;
            }
            else {
                return value;
            }
        }
        return '';
    }
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    convertCompare(val) {
        /** @type {?} */
        const op = CompareOperators.find((/**
         * @param {?} item
         * @return {?}
         */
        (item) => item.value === val));
        if (op) {
            return op.label;
        }
    }
    /**
     * @param {?} sorts
     * @return {?}
     */
    buildSortString(sorts) {
        if (sorts && sorts.length) {
            /** @type {?} */
            let str = sorts.map((/**
             * @param {?} s
             * @return {?}
             */
            s => {
                return `${s.sortField} ${SortType[s.sortType].toString().toLowerCase()},`;
            })).join(' ');
            if (str) {
                str = str.substr(0, str.length - 1);
            }
            return str;
        }
        return '';
    }
    /**
     * @param {?} conditions
     * @return {?}
     */
    buildSqlWhere(conditions) {
        if (conditions && conditions.length) {
            /** @type {?} */
            const result = [];
            /** @type {?} */
            const conditionList = conditions.filter((/**
             * @param {?} c
             * @return {?}
             */
            c => c.filterField !== ''));
            conditionList.forEach((/**
             * @param {?} condition
             * @param {?} index
             * @return {?}
             */
            (condition, index) => {
                if (!condition.filterField) {
                    return;
                }
                result.push(condition.lbracket);
                result.push(condition.filterField);
                /** @type {?} */
                const opCode = parseInt(condition.compare.toString(), 10);
                /** @type {?} */
                const op = this.convertCompare(opCode);
                result.push(' ' + op.replace(/\%/g, '').replace('...', ''));
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.NotLikeEndWith
                    || opCode === Compare.LikeEndWith) {
                    result.push('\'');
                    result.push('%');
                }
                else {
                    result.push(' ');
                    result.push('\'');
                }
                if (opCode === Compare.In || opCode === Compare.NotIn) {
                    result.push(condition.value.replace(/\r\n/g, ','));
                }
                else {
                    result.push(condition.value);
                }
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.LikeStartWith || opCode === Compare.NotLikeStartWith) {
                    result.push('%');
                }
                result.push('\'');
                result.push(condition.rbracket);
                result.push(' ');
                if (index !== conditionList.length - 1) {
                    result.push(condition.relation === FilterRelation.Empty ? '' :
                        FilterRelation[condition.relation].toString().toLowerCase());
                    result.push(' ');
                }
            }));
            return result.join('');
        }
        return '';
    }
}
ColumnFormatService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
ColumnFormatService.ctorParameters = () => [
    { type: DateTimeHelperService },
    { type: NumberHelperService }
];
/** @nocollapse */ ColumnFormatService.ngInjectableDef = i0.defineInjectable({ factory: function ColumnFormatService_Factory() { return new ColumnFormatService(i0.inject(i1.DateTimeHelperService), i0.inject(i2.NumberHelperService)); }, token: ColumnFormatService, providedIn: "root" });
if (false) {
    /** @type {?} */
    ColumnFormatService.prototype.datehelper;
    /** @type {?} */
    ColumnFormatService.prototype.numberhelper;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vY29sdW1uLyIsInNvdXJjZXMiOlsiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFzQixNQUFNLGVBQWUsQ0FBQztBQUMvRCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUUvRCxPQUFPLEVBQW1CLE9BQU8sRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQWlCLFFBQVEsRUFBRSxNQUFNLHlCQUF5QixDQUFDOzs7Ozs7Ozs7Ozs7QUFZOUgsTUFBTSxPQUFPLG1CQUFtQjs7Ozs7SUFDNUIsWUFBbUIsVUFBaUMsRUFBUyxZQUFpQztRQUEzRSxlQUFVLEdBQVYsVUFBVSxDQUF1QjtRQUFTLGlCQUFZLEdBQVosWUFBWSxDQUFxQjtJQUM5RixDQUFDOzs7Ozs7OztJQUVELE1BQU0sQ0FBQyxLQUFVLEVBQUUsSUFBVSxFQUFFLFNBQWUsRUFBRSxPQUFhO1FBQ3pELElBQUksU0FBUyxFQUFFO1lBQ1gsSUFBSSxPQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssVUFBVSxFQUFFO2dCQUNsQyxPQUFPLEdBQUcsT0FBTyxJQUFJLEVBQUUsQ0FBQztnQkFDeEIsT0FBTyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksa0JBQUksSUFBSSxFQUFFLElBQUksQ0FBQyxVQUFVLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLElBQUksSUFBSyxPQUFPLEVBQUcsQ0FBQzthQUNqSDtpQkFBTTtnQkFDSCxJQUFJLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRTs7MEJBQ2IsR0FBRyxHQUFHLG1CQUFBLFNBQVMsRUFBbUI7b0JBQ3hDLFFBQVEsR0FBRyxDQUFD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QUssYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQ3BDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsS0FBSyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDOUIsY0FBYyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO29CQUM3RixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNwQjtZQUNMLENBQUMsRUFBQyxDQUFDO1lBRUgsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQzFCO1FBRUQsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDOzs7WUF0TkosVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7O1lBYlEscUJBQXFCO1lBRHJCLG1CQUFtQjs7Ozs7SUFnQloseUNBQXdDOztJQUFFLDJDQUF3QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBOdW1iZXJIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vbnVtYmVyJztcclxuaW1wb3J0IHsgRGF0ZVRpbWVIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vZGF0ZSc7XHJcbmltcG9ydCB7IENvbHVtbkZvcm1hdHRlciwgTnVtYmVyRm9ybWF0T3B0aW9ucywgRW51bUZvcm1hdE9wdGlvbnMsIEltYWdlRm9ybWF0T3B0aW9ucywgQm9vbGVhbkZvcm1hdE9wdGlvbnMgfSBmcm9tICcuL2NvbHVtbi1mb3JtYXQub3B0aW9ucyc7XHJcbmltcG9ydCB7IEZpbHRlckNvbmRpdGlvbiwgQ29tcGFyZSwgRmlsdGVyUmVsYXRpb24sIENvbXBhcmVPcGVyYXRvcnMsIFNvcnRDb25kaXRpb24sIFNvcnRUeXBlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vdHlwZXMnO1xyXG4vKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE5LTAxLTAyIDE0OjEyOjQ3XHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTEwLTE4IDEzOjU5OjM0XHJcbiAqIEBDb21wYW55OiBJbnNwdXJcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDb2x1bW5Gb3JtYXRTZXJ2aWNlIHtcclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBkYXRlaGVscGVyOiBEYXRlVGltZUhlbHBlclNlcnZpY2UsIHB1YmxpYyBudW1iZXJoZWxwZXI6IE51bWJlckhlbHBlclNlcnZpY2UpIHtcclxuICAgIH1cclxuXHJcbiAgICBmb3JtYXQodmFsdWU6IGFueSwgZGF0YT86IGFueSwgZm9ybWF0dGVyPzogYW55LCBjb250ZXh0PzogYW55KSB7XHJcbiAgICAgICAgaWYgKGZvcm1hdHRlcikge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mKGZvcm1hdHRlcikgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0IHx8IHt9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZvcm1hdHRlcih2YWx1ZSwgZGF0YSwgeyBkYXRlOiB0aGlzLmRhdGVoZWxwZXIsIG51bWJlcjogdGhpcy5udW1iZXJoZWxwZXIsIGZvcm1hdDogdGhpcywgLi4uY29udGV4dCB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZXJbJ3R5cGUnXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZtdCA9IGZvcm1hdHRlciBhcyBDb2x1bW5Gb3JtYXR0ZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChmbXQudHlwZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdkYXRldGltZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm10Lm9wdGlvbnMgJiYgZm10Lm9wdGlvbnMuZm9ybWF0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0ZVRpbWVGb3JtYXQodmFsdWUsIGZtdC5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm51bWJlckZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdlbnVtJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmVudW1Gb3JtYXQodmFsdWUsIGZtdC5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnaW1hZ2UnOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW1hZ2VGb3JtYXQodmFsdWUsIGZtdC5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5ib29sZWFuRm9ybWF0KHZhbHVlLCBmbXQub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGRhdGVUaW1lRm9ybWF0KHZhbHVlOiBhbnksIG9wdHM6IGFueSkge1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBsZXQgZm10ID0gJ3l5eXktTU0tZGQnO1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mKG9wdHMpID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICAgICAgZm10ID0gb3B0cztcclxuICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Yob3B0cykgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICBmbXQgPSBvcHRzLmZvcm1hdDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgZm10ID0gZm10LnJlcGxhY2UoJ1lZWVknLCAneXl5eScpLnJlcGxhY2UoJy1ERCcsICctZGQnKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Yob3B0cykgPT09ICdvYmplY3QnICYmIG9wdHMuZGF0ZVJhbmdlKSB7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc3BsaXRTdHIgPSBvcHRzLmRhdGVSYW5nZURhdGVzRGVsaW1pdGVyIHx8ICd+JztcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgW2JlZ2luRGF0ZSwgZW5kRGF0ZSBdID0gdmFsdWUuc3BsaXQoc3BsaXRTdHIpO1xyXG4gICAgICAgICAgICAgICAgYmVnaW5EYXRlID0gdGhpcy5kYXRlaGVscGVyLmZvcm1hdFRvKGJlZ2luRGF0ZSwgZm10KTtcclxuICAgICAgICAgICAgICAgIGVuZERhdGUgPSB0aGlzLmRhdGVoZWxwZXIuZm9ybWF0VG8oZW5kRGF0ZSwgZm10KTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYmVnaW5EYXRlICsgc3BsaXRTdHIgKyAgZW5kRGF0ZTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGF0ZWhlbHBlci5mb3JtYXRUbyh2YWx1ZSwgZm10KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIG51bWJlckZvcm1hdCh2YWx1ZTogYW55LCBvcHRzPzogTnVtYmVyRm9ybWF0T3B0aW9ucykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm51bWJlcmhlbHBlci5mb3JtYXROdW1iZXIodmFsdWUsIG9wdHMpO1xyXG4gICAgICAgIC8vIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSAnJyAmJiB2YWx1ZSAhPT0gTmFOKSB7XHJcbiAgICAgICAgLy8gICAgIHJldHVybiB0aGlzLm51bWJlcmhlbHBlci5mb3JtYXRNb25leSh2YWx1ZSwgb3B0cyk7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIC8vIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGVudW1Gb3JtYXQodmFsdWU6IGFueSwgb3B0cz86IEVudW1Gb3JtYXRPcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwgKSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAob3B0cyAmJiBvcHRzLmRhdGEgJiYgb3B0cy5kYXRhLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCB2YWwgPSB2YWx1ZS50b1N0cmluZygpO1xyXG4gICAgICAgICAgICBsZXQgYXJyID0gW3ZhbF07XHJcbiAgICAgICAgICAgIGlmICh2YWwuaW5kZXhPZignLCcpID4gLTEpIHsgIC8vIOWkmumAiVxyXG4gICAgICAgICAgICAgICAgYXJyID0gdmFsLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IHN0ciA9IFtdO1xyXG4gICAgICAgICAgICBhcnIuZm9yRWFjaCh2ID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG4gPSBvcHRzLmRhdGEuZmluZChpdGVtID0+IGl0ZW1bb3B0cy52YWx1ZUZpZWxkXS50b1N0cmluZygpID09IHYpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG4pIHtcclxuICAgICAgICAgICAgICAgICAgICBzdHIucHVzaChuW29wdHMudGV4dEZpZWxkXSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHN0ci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzdHIuam9pbignLCcpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGltYWdlRm9ybWF0KHZhbHVlLCBvcHRzPzogSW1hZ2VGb3JtYXRPcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmIChvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhcnJTdHIgPSBbIGA8aW1nIHNyYz1cIiR7dmFsdWV9XCIgYF07XHJcbiAgICAgICAgICAgICAgICBpZiAob3B0cy53aWR0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFyclN0ci5wdXNoKGB3aWR0aD1cIiR7b3B0cy53aWR0aH1cImApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKG9wdHMuaGVpZ2h0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyU3RyLnB1c2goYGhlaWdodD1cIiR7b3B0cy5oZWlnaHR9XCJgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBhcnJTdHIucHVzaCgnPicpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFyclN0ci5qb2luKCcnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgPGltZyBzcmM9XCIke3ZhbHVlfVwiPmA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGJvb2xlYW5Gb3JtYXQodmFsdWUsIG9wdHM/OiBCb29sZWFuRm9ybWF0T3B0aW9ucykge1xyXG4gICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIGlmIChvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSB2YWx1ZSA/IG9wdHMudHJ1ZVRleHQgOiBvcHRzLmZhbHNlVGV4dDtcclxuICAgICAgICAgICAgICAgIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIHByaXZhdGUgY29udmVydENvbXBhcmUodmFsOiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBvcCA9IENvbXBhcmVPcGVyYXRvcnMuZmluZCggKGl0ZW06IGFueSkgPT4gaXRlbS52YWx1ZSA9PT0gdmFsKTtcclxuICAgICAgICBpZiAob3ApIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9wLmxhYmVsO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBidWlsZFNvcnRTdHJpbmcoc29ydHM6IFNvcnRDb25kaXRpb25bXSk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKHNvcnRzICYmIHNvcnRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBsZXQgc3RyID0gc29ydHMubWFwKHMgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke3Muc29ydEZpZWxkfSAke1NvcnRUeXBlW3Muc29ydFR5cGVdLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKX0sYDtcclxuICAgICAgICAgICAgfSkuam9pbignICcpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHN0cikge1xyXG4gICAgICAgICAgICAgICAgc3RyID0gc3RyLnN1YnN0cigwLCBzdHIubGVuZ3RoIC0gMSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBzdHI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgYnVpbGRTcWxXaGVyZShjb25kaXRpb25zOiBGaWx0ZXJDb25kaXRpb25bXSk6IHN0cmluZyB7XHJcbiAgICAgICAgaWYgKGNvbmRpdGlvbnMgJiYgY29uZGl0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbmRpdGlvbkxpc3QgPSBjb25kaXRpb25zLmZpbHRlcihjID0+IGMuZmlsdGVyRmllbGQgIT09ICcnKTtcclxuICAgICAgICAgICAgY29uZGl0aW9uTGlzdC5mb3JFYWNoKChjb25kaXRpb24sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbmRpdGlvbi5maWx0ZXJGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi5sYnJhY2tldCk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24uZmlsdGVyRmllbGQpO1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IG9wQ29kZSA9IHBhcnNlSW50KGNvbmRpdGlvbi5jb21wYXJlLnRvU3RyaW5nKCksIDEwKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9wID0gdGhpcy5jb252ZXJ0Q29tcGFyZShvcENvZGUpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyAnICsgb3AucmVwbGFjZSgvXFwlL2csICcnKS5yZXBsYWNlKCcuLi4nLCAnJykpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChvcENvZGUgPT09IENvbXBhcmUuTGlrZSB8fCBvcENvZGUgPT09IENvbXBhcmUuTm90TGlrZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCBvcENvZGUgPT09IENvbXBhcmUuTm90TGlrZUVuZFdpdGhcclxuICAgICAgICAgICAgICAgICAgICAgICAgfHwgb3BDb2RlID09PSBDb21wYXJlLkxpa2VFbmRXaXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1xcJycpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCclJyk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJ1xcJycpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChvcENvZGUgPT09IENvbXBhcmUuSW4gfHwgb3BDb2RlID09PSBDb21wYXJlLk5vdEluKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLnZhbHVlLnJlcGxhY2UoL1xcclxcbi9nLCAnLCcpKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLnZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAob3BDb2RlID09PSBDb21wYXJlLkxpa2UgfHwgb3BDb2RlID09PSBDb21wYXJlLk5vdExpa2VcclxuICAgICAgICAgICAgICAgICAgICB8fCBvcENvZGUgPT09IENvbXBhcmUuTGlrZVN0YXJ0V2l0aCB8fCBvcENvZGUgPT09IENvbXBhcmUuTm90TGlrZVN0YXJ0V2l0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCclJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXFwnJyk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24ucmJyYWNrZXQpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyAnKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoaW5kZXggIT09IGNvbmRpdGlvbkxpc3QubGVuZ3RoIC0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi5yZWxhdGlvbiA9PT0gRmlsdGVyUmVsYXRpb24uRW1wdHkgPyAnJyA6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGaWx0ZXJSZWxhdGlvbltjb25kaXRpb24ucmVsYXRpb25dLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyAnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0LmpvaW4oJycpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==