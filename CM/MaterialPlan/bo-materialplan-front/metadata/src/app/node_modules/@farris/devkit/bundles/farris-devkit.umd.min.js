!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("moment"),require("immutable"),require("@angular/forms"),require("validator"),require("date-fns"),require("@angular/common/http"),require("@angular/router"),require("@farris/expression-engine"),require("bignumber.js"),require("rxjs/operators"),require("rxjs"),require("@angular/core")):"function"==typeof define&&define.amd?define("@farris/devkit",["exports","moment","immutable","@angular/forms","validator","date-fns","@angular/common/http","@angular/router","@farris/expression-engine","bignumber.js","rxjs/operators","rxjs","@angular/core"],e):e((t.farris=t.farris||{},t.farris.devkit={}),t.moment,t.immutable,t.ng.forms,t.ValidatorJS,t.dateFns,t.ng.common.http,t.ng.router,t.expressionEngine,t.bignumber_js,t.rxjs.operators,t.rxjs,t.ng.core)}(this,function(x,i,e,a,t,s,o,p,u,y,l,h,d){"use strict";i=i&&i.hasOwnProperty("default")?i["default"]:i;var n="default"in t?t["default"]:t,r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function c(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var E=function(){return(E=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function f(r,i){var o,a,s,t,p={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),"throw":e(1),"return":e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function n(t){if(o)throw new TypeError("Generator is already executing.");for(;p;)try{if(o=1,a&&(s=2&t[0]?a["return"]:t[0]?a["throw"]||((s=a["return"])&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return p.label++,{value:t[1],done:!1};case 5:p.label++,a=t[1],t=[0];continue;case 7:t=p.ops.pop(),p.trys.pop();continue;default:if(!(s=0<(s=p.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){p=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){p.label=t[1];break}if(6===t[0]&&p.label<s[1]){p.label=s[1],s=t;break}if(s&&p.label<s[2]){p.label=s[2],p.ops.push(t);break}s[2]&&p.ops.pop(),p.trys.pop();continue}t=i.call(r,p)}catch(e){t=[6,e],a=0}finally{o=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([e,t])}}}function P(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function g(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),a=[];try{for(;(void 0===e||0<e--)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o["return"])&&n.call(o)}finally{if(i)throw i.error}}return a}function b(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(g(arguments[e]));return t}var m="__annotations__",v="__parameters__",C="__prop__metadata__";function I(t,e,n,i,o){var a=T(e);function s(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(this instanceof s)return a.call.apply(a,b([this],e)),this;var n=new(s.bind.apply(s,b([void 0],e))),r=function(t){return o&&o.apply(void 0,b([t],e)),(t.hasOwnProperty(m)?t[m]:Object.defineProperty(t,m,{value:[]})[m]).push(n),t};return i&&i(r),r}return n&&(s.prototype=Object.create(n.prototype)),s.prototype.ngMetadataName=t,s.annotationCls=s}function T(i){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(i){var n=i.apply(void 0,b(t));for(var r in n)this[r]=n[r]}}}function M(t,e,n){var r=T(e);function o(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this instanceof o)return r.apply(this,t),this;var i=new(o.bind.apply(o,b([void 0],t)));return function(t,e){var n=t.constructor,r=n.hasOwnProperty(C)?n[C]:Object.defineProperty(n,C,{value:{}})[C];r[e]=r.hasOwnProperty(e)&&r[e]||[],r[e].unshift(i)}}return n&&(o.prototype=Object.create(n.prototype)),o.prototype.ngMetadataName=t,o.annotationCls=o}var S=(j.getClassMetadatas=function(t){return t[m]},j.getClassMetadataByName=function(t,e){return this.getClassMetadataByNameWithTranslate(t,e,null,null)},j.getClassMetadataByNameWithTranslate=function(t,e,n,r){var i=this.getClassMetadatas(t);if(!i)return null;var o=i.find(function(t){return t.ngMetadataName===e});return this.translateMetadataByName(o,n,r),o},j.getPropsMetadatas=function(t){return t[C]},j.getPropsMetadatasByName=function(t,e){return this.getPropsMetadatasByNameWithTranslate(t,e)},j.getPropsMetadatasByNameWithTranslate=function(t,n,e,r){var i={},o=this.getPropsMetadatas(t);return o&&(Object.keys(o).forEach(function(t){var e=o[t].find(function(t){return t.ngMetadataName===n});e&&(i[t]=e)}),this.translateMetadatasByName(i,e,r)),i},j.translateMetadatasByName=function(e,n,r){var i=this;return Object.keys(e).forEach(function(t){i.translateMetadataByName(e[t],n,r)}),e},j.translateMetadataByName=function(i,o,t){return i&&o&&t&&t.forEach(function(t){var e=i[t];try{if(e&&e.startsWith("{{")&&e.endsWith("}}")){var n=e.replace("{{","").replace("}}","").trim();i[t]=o.transform(n,null)}}catch(r){console.info(r)}}),i},j.getPropMetadatasByName=function(t,e){return null},j.getPropMetadataByName=function(t,e,n){return null},j);function j(){}var w,O=function np(t,e,n,r,i){this.type=e,this.value=t,this.preValue=r,this.path=n,this.position=i};function N(t,e){return JSON.stringify(t)===JSON.stringify(e)}(w=x.ModifyType||(x.ModifyType={})).Add="ADD",w.AddData="AddData",w.Clone="CLONE",w.Remove="REMOVE",w.RemoveData="RemoveData",w.ValueChange="VALUE_CHANGE",w.Load="LOAD",w.UnChanged="UNCHANGED",w.PaginationInfoChange="PAGINATION_INFO_CHANGE",w.Insert="Insert",w.Update="UPDATE";var D=(Object.defineProperty(V.prototype,"changes",{get:function(){return this.modifications},enumerable:!0,configurable:!0}),V.prototype.append=function(t){switch(t.type){case x.ModifyType.ValueChange:this.appendValueChangeModification(t);break;case x.ModifyType.Add:case x.ModifyType.Insert:case x.ModifyType.Clone:this.appendAddModification(t);break;case x.ModifyType.Remove:this.appendRemoveModification(t);break;case x.ModifyType.Load:}},V.prototype.appendValueChangeModification=function(t){var e=t.value,n=this.findModifyItemsPath(t.path);if(n)n.value=e;else{var r=this.findNewAddItemsPath(t.path);r?r.value=Object.assign({},r.value,e):this.modifications.push(t)}},V.prototype.appendAddModification=function(t){var e=t.value,n=this.findNewAddItemsPath(t.path);n?n.value=n.value.concat(e):this.modifications.push(t)},V.prototype.appendRemoveModification=function(t){var e=t.path,n=Object.keys(t.value)[0],r=t.value[n];this.modifications.forEach(function(t){t.type!==x.ModifyType.Add&&t.type!==x.ModifyType.Insert&&t.type!==x.ModifyType.Clone||!1!==N(t.path,e)&&(t.value=t.value.filter(function(t){return t[n]!==r}))});var i=e.concat(n+":"+r);this.modifications=this.modifications.filter(function(t){if(t.type!==x.ModifyType.ValueChange)return!0;var e=Array.from(t.path);return e.pop(),!N(e,i)}),this.removeDescendantRemoveModifications(t),this.modifications.push(t)},V.prototype.clear=function(){this.modifications=[]},V.prototype.findNewAddItemsPath=function(n){return this.modifications.find(function(t,e){return N(n,t.path)&&(t.type===x.ModifyType.Add||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Clone)})},V.prototype.findModifyItemsPath=function(n){return this.modifications.find(function(t,e){return N(n,t.path)&&t.type===x.ModifyType.ValueChange})},V.prototype.removeDescendantRemoveModifications=function(t){var n=this,r=this.createRemovePathWithId(t);this.modifications=this.modifications.filter(function(t){if(t.type!==x.ModifyType.Remove)return!0;var e=n.createRemovePathWithId(t);return!n.isDescendantPath(r,e)})},V.prototype.createRemovePathWithId=function(t){var e=t.path,n=Object.keys(t.value)[0],r=t.value[n];return e.concat([n+":"+r])},V.prototype.isDescendantPath=function(t,n){if(t.length>n.length)return!1;var r=!0;return t.forEach(function(t,e){t===n[e]||(r=!1)}),r},V);function V(){this.modifications=[]}function F(t){if("object"==typeof t&&null!==t&&"[object Object]"===Object.prototype.toString.call({})){if(null===Object.getPrototypeOf(t))return 1;for(var e=t;null!==Object.getPrototypeOf(e);)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e}}var R="NgField";var _=M(R,function rp(t){var e={primary:!1,foreign:!1};if(t)switch(typeof t){case"boolean":e.primary=Boolean(t);break;case"string":e.dataField=String(t);break;case"object":e=Object.assign(e,t)}return e}),B="NgList";var A=M(B,function ip(t){if(F(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),L="NgObject";var k=M(L,function op(t){if(F(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),$="NgDynamic";var U=M($,function ap(t){if(F(t))return t;var e=typeof t;return"string"==e?{dataField:t}:"function"==e?{type:t}:void 0}),H="NgEntity";var K=(G.getNgFields=function(t){return S.getPropsMetadatasByName(t,R)},G.getNgField=function(t,e){return this.getNgFields(t)[e]},G.getDataField=function(t,e){return this.getNgField(t,e).dataField||e},G.getNgObjects=function(t){return S.getPropsMetadatasByName(t,L)},G.getNgDynamic=function(t){return S.getPropsMetadatasByName(t,$)},G.getNgList=function(t){return S.getPropsMetadatasByName(t,B)},G.getPrimaryFieldMetadata=function(t){var e=G.getNgFields(t),n=Object.keys(e).find(function(t){return e[t].primary});if(n){var r=e[n];return r.property=n,r.dataField||(r.dataField=n),r}return undefined},G.getPrimaryKey=function(t){var e=this.getPrimaryFieldMetadata(t);return e?e.property:""},G.getValidationMetadata=function(n){var r=G.getNgFields(n),i={};return Object.keys(r).forEach(function(e){if(!r[e].primary&&!r[e].foreign){var t=r[e].validRules;t&&t.length&&(t.map(function(t){t.property=e,t.targetName=n.name}),i[e]=t)}}),i},G.getValidationMetadataWithPath=function(t){var i=t.constructor,o=G.getNgFields(i),a=t.getPaths().path||[],s={};return Object.keys(o).forEach(function(e){if(!o[e].primary&&!o[e].foreign){var t=o[e].validRules;if(t&&t.length){var n=a.concat([]);n.push(e);var r=n.join(".");t.map(function(t){t.property=e,t.targetName=i.name,t.path=r}),s[e]=t}}}),s},G);function G(){}var z=(q.getAllNgProperties=function(t){var e=this.getNgFieldProperties(t),n=this.getNgObjectProperties(t),r=this.getNgDynamicProperties(t),i=this.getNgObjectProperties(t);return Object.assign({},e,n,r,i)},q.getNgEntityMatadata=function(t){return S.getClassMetadataByNameWithTranslate(t,H)},q.getNgFieldProperties=function(t){return S.getPropsMetadatasByName(t,R)},q.getNgObjectProperties=function(t){return S.getPropsMetadatasByName(t,L)},q.getNgDynamicProperties=function(t){return S.getPropsMetadatasByName(t,$)},q.getNgListProperties=function(t){return S.getPropsMetadatasByName(t,B)},q.getPrimaryKeyProperty=function(t){var n,r=q.getNgFieldProperties(t);return Object.keys(r).forEach(function(t){var e=r[t];!0===e.primary&&(n=e)}),n},q);function q(){}var J="__PARENT_PATH__",W="__PARENT__";function Y(t,e){return Z.create(t,e)}var Z=(X.create=function(t,e){var n=new(this.getType(t))(e);return n.constructor=t,n},X.createType=function(t){var e,n=(c(r,e=Fn),r);function r(t){return e.call(this,t)||this}var i=n.prototype;return this.extendProperties(t,i),n},X.extendProperties=function(t,e){var n=K.getNgFields(t),r=K.getNgObjects(t),i=K.getNgList(t),o=K.getNgDynamic(t);this.extendPlainProperty(e,n),this.extendListProperty(e,i),this.extendObjectProperty(e,r),this.extendDynamicProperty(e,o)},X.extendPlainProperty=function(t,e){Object.keys(e).forEach(function(r){var i=e[r];Object.defineProperty(t,r,{get:function(){return this.getPropValue(r,i)},set:function(t){var e=this.getPropValue(r,i);if(!1!==this.isPropValueChanged(r,i,t,e)){this.setPropValue(r,i,t);var n=this.preparePropValue(r,i,t);this.emitValueChange(r,i,t,e,n)}}})})},X.extendListProperty=function(t,u){Object.keys(u).forEach(function(s){var p="__"+s+"__";Object.defineProperty(t,s,{get:function(){var e=this,n=this[p];if(!n){var r=u[s],t=this.createPath(s),i=r.dataField||s,o=this.data[i];if((n=new gt)[W]=this,n[J]=t,o){var a=o.map(function(t){return Y(r.type,t)});n.loadEntities(a)}n.onListChanged.subscribe(function(t){t&&(n[J][0]!==t.path[0]&&(t.path=n[J].concat(t.path)),e.setChanges(t))}),this[p]=n}return n},set:function(t){this[p]=t}})})},X.extendObjectProperty=function(t,e){Object.keys(e).forEach(function(i){var o=e[i],a="__"+i+"__";Object.defineProperty(t,i,{get:function(){var t=this[a],e=this.createPath(i);if(!t){var n=o.dataField||i,r=this.data[n]||{};t=X.buildEntity(e,r,this,o),this[a]=t}return t},set:function(t){var e=this.createPath(i),n={path:e,value:t.data,preValue:this[i].data,type:x.ModifyType.ValueChange},r=X.buildEntity(e,t,this,o);this[a]=r,this.setChanges(n)}})})},X.extendDynamicProperty=function(t,e){Object.keys(e).forEach(function(i){var o=e[i],a="__"+i+"__";Object.defineProperty(t,i,{get:function(){var t=this[a],e=this.createPath(i);if(!t){var n=o.dataField||i,r=this.data[n]||{};t=X.buildDynamic(e,r,this,o),this[a]=t}return t},set:function(t){var e=this.createPath(i),n={path:e,value:t.data,preValue:this[i].data,type:x.ModifyType.ValueChange},r=X.buildDynamic(e,t,this,o);this[a]=r,this.setChanges(n)}})})},X.getType=function(t){if(this.buffer.has(t))return this.buffer.get(t);var e=this.createType(t);return this.buffer.set(t,e),e},X.buildEntity=function(t,e,n,r){var i;return(i=e instanceof r.type?e:Y(r.type,e))[W]=n,i[J]=t,i.onValueChanged.subscribe(function(t){t&&(t.path=(n[J]||[]).concat(t.path),n.setChanges(t))}),i},X.buildDynamic=function(t,e,n,r){var i;return(i=e instanceof r.type?e:function o(t,e){return new t(e)}(r.type,e))[W]=n,i[J]=t,i.onValueChanged.subscribe(function(t){t&&(t.path=(n[J]||[]).concat(t.path),n.setChanges(t))}),i},X.buffer=new Map,X);function X(){}function Q(t,e){var n;return(n=t&&t.prototype&&"ConcreteEntityPrototype"===t.prototype.typeName?new t(e):Z.create(t,e)).constructor=t,n}function tt(n,t){var r=[];return t.forEach(function(t){var e=Q(n,t);r.push(e)}),r}function et(t,e){return new t(e)}var nt={},rt=(it.isValidType=function(t){var e=this;return"isValidType"!==t&&"getMessage"!==t&&-1!==Object.keys(this).map(function(t){return e[t]}).indexOf(t)},it.getMessage=function(t){return(nt[this.CURRENT_LANGUAGE]||nt["zh-CHS"])[t]||""},it.setCurrentLanguage=function(t){this.CURRENT_LANGUAGE=t},it.CURRENT_LANGUAGE="zh-CNS",it.CUSTOM_VALIDATION="customValidation",it.REQUIRED="required",it.EQUALS="equals",it.NOT_EQUALS="notEquals",it.IS_NUMBER="isNumber",it.IS_INT="isInt",it.IS_FLOAT="isFloat",it.IS_STRING="isString",it.IS_BOOLEAN="isBoolean",it.IS_DATE="isDate",it.IS_DATE_STRING="isDateString",it.IS_BOOLEAN_STRING="isBooleanString",it.IS_NUMBER_STRING="isNumberString",it.IS_EMAIL="isEmail",it.IS_JSON="isJSON",it.IS_LOWERCASE="isLowercase",it.IS_UPPERCASE="isUppercase",it.RANGE="range",it.MIN="min",it.MINVALUE="minValue",it.MAX="max",it.MAXVALUE="maxValue",it.LENGTH="length",it.MAX_LENGTH="maxLength",it.MIN_LENGTH="minLength",it.MIN_DATE="minDate",it.MAX_DATE="maxDate",it.EXCLUDE="exclude",it.MATCHES="matches",it.FIELD_CONTAINER="fieldContainer",it);function it(){}nt["zh-CHS"]={fieldContainer:"$target 第 $value 行",required:"请输入'$property'",equals:"'$property'的值与$constraint1不相等",notEquals:"'$property'的值不能与'$constraint1'相同",isNumber:"'$property'的值不是数字",isInt:"'$property'的值不是整数",isFloat:"'$property'的值不是浮点型数字",isBoolean:"'$property'的值不是布尔值",isDate:"'$property'的值不是有效日期",isEmail:"邮箱地址不正确",min:"'$property'的值不应小于$constraint1",minValue:"'$property'的值不应小于$constraint1",minDate:"'$property'的日期不应早于$constraint1",max:"'$property'的值不应大于$constraint1",maxValue:"'$property'的值不应大于$constraint1",maxDate:"'$property'不应晚于$constraint1",isBooleanString:"'$property'的值不是有效布尔值",isDateString:"'$property'的值不是有效的日期",isLowercase:"'$property'的值应全部为小写字符串",isUppercase:"'$property'的值应全部为大写字符串",length:"'$property'的长度应介于$constraint1~$constraint2之间",range:"'$property'的值应介于$constraint1~$constraint2之间",maxLength:"'$property'的长度不得大于$constraint1",minLength:"'$property'的长度不得小于$constraint1",isNumberString:"'$property'的值不是数字",exclude:"'$property'的值不能包含：$constraint1",matches:"'$property'校验不通过"},nt.en={fieldContainer:"$target row $value",required:"Please input '$property'",equals:"'$property' should equals '$constraint1'",notEquals:"'$property' should not equals '$constraint1'",isNumber:"'$property' should be number",isInt:"'$property' should be integer",isFloat:"'$property' should be float",isBoolean:"'$property' should be boolean",isDate:"'$property' should be date",isEmail:"'$property' should be e-mail address",min:"'$property' should not less than $constraint1",minValue:"'$property' should not less than $constraint1",minDate:"'$property' should not early than $constraint1",max:"'$property' should not bigger than $constraint1",maxValue:"'$property' should not bigger than $constraint1",maxDate:"'$property' should not late than $constraint1",isBooleanString:"'$property' should be boolean string",isDateString:"'$property' should be date string",isLowercase:"'$property' should be lowercase charactor",isUppercase:"'$property' should be uppercase charactor",length:"'$property' length should between $constraint1~$constraint2之间",range:"'$property' value should between $constraint1~$constraint2之间",maxLength:"'$property' should not longer than $constraint1",minLength:"'$property' should not shorter than $constraint1",isNumberString:"'$property' should be number string",exclude:"'$property' should not include $constraint1",matches:"'$property' calibration failed"},nt["zh-CHT"]={fieldContainer:"$target 第 $value 行",required:"請輸入'$property'",equals:"'$property'的值與$constraint1不相等",notEquals:"'$property'的值不能與'$constraint1'相同",isNumber:"'$property'的值不是數字",isInt:"'$property'的值不是整數",isFloat:"'$property'的值不是浮點型數字",isBoolean:"'$property'的值不是佈爾值",isDate:"'$property'的值不是有效日期",isEmail:"郵箱地址不正確",min:"'$property'的值不應小於$constraint1",minValue:"'$property'的值不應小於$constraint1",minDate:"'$property'的日期不應早於$constraint1",max:"'$property'的值不應大於$constraint1",maxValue:"'$property'的值不應大於$constraint1",maxDate:"'$property'不應晚於$constraint1",isBooleanString:"'$property'的值不是有效佈爾值",isDateString:"'$property'的值不是有效的日期",isLowercase:"'$property'的值應全部爲小冩字符串",isUppercase:"'$property'的值應全部爲大冩字符串",length:"'$property'的長度應介於$constraint1~$constraint2之間",range:"'$property'的值應介於$constraint1~$constraint2之間",maxLength:"'$property'的長度不得大於$constraint1",minLength:"'$property'的長度不得小於$constraint1",isNumberString:"'$property'的值不是數字",exclude:"'$property'的值不能包含：$constraint1",matches:"'$property'校驗不通過"};var ot=function sp(){this.isArray=!1,this.index=undefined},at=(st.replaceMessageSpecialTokens=function(t,e,n){var r;return t instanceof Function?r=t(e):"string"==typeof t&&(r=t),r&&e.constraints instanceof Array&&e.constraints.forEach(function(t,e){r=r.replace(new RegExp("\\$constraint"+(e+1),"g"),t)}),r&&n!==undefined&&null!==n&&(r=r.replace(/\$value/g,n)),r=(r=r&&r.replace(/\$property/g,e.property))&&r.replace(/\$target/g,e.targetName)},st.prototype.execute=function(h,y,d,e,g,t,m,o){var v=this;!t&&o&&(t=o.form.getValidationRules());var E=K.getValidationMetadataWithPath(h),a=new Map;if(t){for(var n=[],r=h;r&&r!==r.__PARENT__;){var i=r.__PARENT_PATH__?r.__PARENT_PATH__[1]:"";n.push(i),(r=r.__PARENT__)instanceof gt&&(r=r.__PARENT__)}var s=n.reverse().join("/");t.forEach(function(e,t){if(t){var n=t.split("/"),r=n.pop(),i=n.join("/");if(s===i){if(E[r]=b(E[r]||[]),e.length){var o="";e.forEach(function(t){t.targetId&&t.targetId.length>o.length&&(o=t.targetId),E[r].push(t)}),E[r].forEach(function(t){t.targetId=o,t.targetName=e[0].targetName,t.property=e[0].property,e[0].frameContext&&(t.frameContext=e[0].frameContext),t.fullPath=e[0].fullPath,t.initialized=!0})}}else a.set(t,e)}})}E&&0<Object.keys(E).length&&Object.keys(E).forEach(function(t){var e=E[t];if(e&&0<e.length){var i=e[0].path;i&&e.forEach(function(t){if(!0!==t.initialized){var e=i.split("."),n=v.getForm(e,o),r=v.getFormControl(e,o);r&&(t.targetId=r.id,t.targetName=n&&n.formGroupName,t.property=r.name||r.defaultI18nValue||"")}})}}),e&&(E=Object.keys(E).filter(function(t){return t===e}).reduce(function(t,e){var n;return Object.assign({},t,((n={})[e]=E[e],n))},{})),Object.keys(E).filter(function(t){return h&&(h.hasOwnProperty(t)||h.constructor.prototype&&h.constructor.prototype.typeName&&h.constructor.prototype.hasOwnProperty(t)||h.__proto__.hasOwnProperty(t))}).forEach(function(t){var e=y;y===undefined&&(e=h[t]);var n=!1,r=v.getMultiLanguageFields(h);r&&0<r.length&&r.includes(t)&&(n=!0);var i=E[t];if(i.length){var o=i[0],a=o.property,s=o.targetId,p=o.frameContext,u=o.fullPath,c=Number.isInteger(g)?st.replaceMessageSpecialTokens(rt.getMessage(rt.FIELD_CONTAINER),i[0],g+1):i[0].targetName,l=c?c+" - "+a:""+a,f=v.generateValidationError(h,e,t,l,g,s,p,u);g!==undefined&&(f.index=g),d.push(f),v.defaultValidations(h,e,i,f,n,m)}}),this.objectValidations(h,d,e,g,a,m,o),this.listValidations(h,d,e,g,a,o)},st.prototype.getMultiLanguageFields=function(t){if(t&&t.constructor){var e=K.getNgFields(t.constructor);return Object.keys(e).filter(function(t){return e[t].enableMultiLangInput})}return null},st.prototype.stripEmptyErrors=function(t){var e=this;return t.filter(function(t){if(t.children&&(t.children=e.stripEmptyErrors(t.children)),0===Object.keys(t.constraints).length){if(0===t.children.length)return!1;delete t.constraints}return!0})},st.prototype.generateValidationError=function(t,e,n,r,i,o,a,s){var p=new ot;return p.target=t,p.value=e,p.property=n,p.propertyName=r,p.field=o,p.index=i,p.children=[],p.constraints={},a&&(p.frameContext=a),p.fullPath=s,p},st.prototype.defaultValidations=function(o,a,t,s,n,r){var p=this,u=s.constraints;return t.filter(function(i){var t=p.validator.validateValueByMetadata(o,a,i,n,r);if(t instanceof Promise){var e=t.then(function(t){if(!t){var e=p.createValidationError(o,a,i),n=e.type,r=e.messageString;u[n]=r,s.rule=i}});p.awaitingPromises.push(e)}return!t}).forEach(function(t){var e=p.createValidationError(o,a,t),n=e.type,r=e.messageString;u[n]=r,s.rule=t})},st.prototype.listValidations=function(i,o,e,a,s,p){var u=this,c="__ACTUAL_INDEX__",l=K.getNgList(i.constructor);if(l){var t=Object.keys(l);e&&(t=t.filter(function(t){return t===e})),t.forEach(function(t){l[t].type;var e=i[t];if(e){var n=i.getPaths().path||[];n.push(t);var r=u.generateValidationError(i,e.items,n.join("."),t,a);r.isArray=!0,o.push(r),e.items.forEach(function(t,e){var n=t[c]?t[c]:e;u.execute(t,undefined,r.children,undefined,n,s,t.primaryValue,p)})}})}},st.prototype.objectValidations=function(n,r,e,i,o,a,s){var p=this,u=K.getNgObjects(n.constructor);if(u&&!(Object.keys(u).length<1)){var t=Object.keys(u);e&&(t=t.filter(function(t){return t===e})),t.forEach(function(t){u[t].type;var e=n[t];e&&p.execute(e,undefined,r,undefined,i,o,a,s)})}},st.prototype.createValidationError=function(t,e,n){t.constructor?t.constructor.name:undefined;var r=n.type,i=n.message;if(i=i||rt.getMessage(r),rt.isValidType(r)&&(r===rt.MAXVALUE||r===rt.MINVALUE)&&this.isDateString(e)&&n.constraints&&n.constraints.length){var o=r===rt.MINVALUE?rt.MIN_DATE:rt.MAX_DATE;i=rt.getMessage(o)}return{type:r,messageString:st.replaceMessageSpecialTokens(i,n,e),metadata:n}},st.prototype.getFrameContext=function(t,e){if(!t||t.length<1||!e)return null;var n=t.concat([]);n.pop();var r=n.join("/");return e.appContext.frameContextManager.getFrameContexts().find(function(t){return t&&t.viewModel&&t.viewModel.bindingPath&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).join("/")===r})||null},st.prototype.getForm=function(t,e){if(!t||t.length<1||!e)return null;var n=this.getFrameContext(t,e);return n&&n.form||null},st.prototype.getFormControl=function(t,e){if(!t||t.length<1||!e)return null;var n=t.concat([]).pop(),r=this.getFrameContext(t,e);return r&&r.form&&r.form.ngFormControls&&r.form.ngFormControls[n]||null},st.prototype.isDateString=function(t){return/\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g.test(t)},st);function st(t){this.validator=t,this.awaitingPromises=[]}var pt=(ut.createDetailedErrorMessage=function(t,o,a){return void 0===o&&(o=[]),void 0===a&&(a=""),t.forEach(function(e){var t=e.target?e.target.constructor.name:"",n=e.propertyName,r=function(t){return"   - 属性 "+a+t+" 验证失败的规则:  \n"+Object.keys(e.constraints).map(function(t){return"        #"+t+": "+e.constraints[t]+"\n"}).join("")};if(a){var i=Number.isInteger(+e.index)?"["+e.index+"]."+n:(a?".":"")+n;e.constraints&&o.push(r(i)),e.children.length&&ut.createDetailedErrorMessage(e.children,o,a+i)}else o.push("类型为 "+t+" 的实例对象数据验证失败，详细信息：\n"),e.constraints&&o.push(r(n)),e.children.length&&ut.createDetailedErrorMessage(e.children,o,n)}),o},ut.convertErrorsToNormalObject=function(t,i){return t.forEach(function(t){var e,r,n=t.propertyName;t.isArray?i[n]=(e=t.children,r={},e.forEach(function(t){var e,n;t.children.length?r[t.index]=ut.convertErrorsToNormalObject(t.children,t):r[t.index]?r[t.index]=Object.assign({},r[t.index],((e={})[t.propertyName]=t.constraints,e)):r[t.index]=((n={})[t.propertyName]=t.constraints,n)}),r):t.children.length?i[n]=ut.convertErrorsToNormalObject(t.children,i):i[n]=t.constraints}),i},ut);function ut(){}var ct=(lt.formatISO=function(t){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var e=this.parse(t);return s.format(e,this.defaultISOFormat)},lt.format=function(t,e){if(!0===this.isEmptyDateOrDateString(t))return this.emptyISODateTimeString;var n=this.parse(t);return e=e||this.defaultDisplayFormat,s.format(n,e)},lt.parse=function(t){return!0===this.isEmptyDateOrDateString(t)?null:!0===this.isDate(t)?t:s.parseISO(t)},lt.isDate=function(t){return s.isDate(t)},lt.isEmptyDateOrDateString=function(t){return!0===this.isDate(t)?this.isEmptyDate(t):this.isEmptyDateString(t)},lt.isEmptyDate=function(t){return!t},lt.isEmptyDateString=function(t){return!t||!0===t.startsWith("0001-01-01")},lt.isEqual=function(t,e){var n=this.parse(t),r=this.parse(e);return n===r||s.isEqual(n,r)},lt.compare=function(t,e){var n=this.parse(t),r=this.parse(e);return!0===this.isEqual(n,r)?0:n||!0!==this.isDate(r)?r||!0!==this.isDate(n)?s.compareAsc(n,r):1:-1},lt.emptyDateTimeString=null,lt.emptyISODateTimeString=null,lt.defaultISOFormat="yyyy-MM-dd'T'HH:mm:ssxxx",lt.defaultDisplayFormat="yyyy-MM-dd HH:mm:ss",lt.defaultDateFormat="yyyy-MM-dd",lt.defaultTimeFormat="HH:mm:ss",lt);function lt(){}var ft=(ht.setTranslate=function(t){t&&(this.translate=t)},ht.getCurrentLanguage=function(){return this.translate&&this.translate.getCurrentLanguage()||this.defaultLanguage},ht.dispose=function(){this.translate=null},ht.defaultLanguage="zh-CHS",ht.translate=null,ht);function ht(){}var yt=(dt.prototype.validate=function(t,e,n,r,i,o){var a=this,s=[],p=new at(this);return p.execute(t,n,s,e,i,r,null,o),Promise.all(p.awaitingPromises).then(function(){var t=p.stripEmptyErrors(s);return a.sortValidationErrors(t),a.buildErrors(t)})},dt.prototype.sortValidationErrors=function(t){var e=this,n=!0;t.forEach(function(t){t.children&&1<t.children.length&&e.sortValidationErrors(t.children),"number"!=typeof t.index&&(n=!1)}),n&&t.sort(function(t,e){return t.index-e.index})},dt.prototype.verify=function(t,e,n,r,i,o,a){var s=this;void 0===a&&(a=!1);var p=[],u=new at(this);if(u.execute(t,n,p,e,i,r,null,o),u.awaitingPromises&&0<u.awaitingPromises.length&&!1===a)return Promise.all(u.awaitingPromises).then(function(){var t=u.stripEmptyErrors(p);return s.buildErrors(t)});var c=u.stripEmptyErrors(p);return this.buildErrors(c)},dt.prototype.validateValueByMetadata=function(e,n,t,r,i){var o,a=t.type,s=[];if(t.constraints?s=t.constraints.map(function(t){return"function"==typeof t?t(e,n):t}):t.constraints=[],rt.isValidType(a)){if(a===rt.MAXVALUE){var p=s[0];return this.isDateString(n)||this.isDate(n)||this.isDateString(p)||this.isDate(p)?!n||-1!==n.indexOf("~")||this[rt.MAX_DATE](ct.parse(n),r,new Date(s[0])):this[rt.MAXVALUE](n,r,s[0])}if(a!==rt.MINVALUE)return this[a].apply(this,b([n,r],s));if(null===s[0]||s[0]===undefined)return!0;if(this.isDateString(n)||this.isDate(n))return 0===s[0]||this[rt.MIN_DATE](ct.parse(n),r,ct.parse(s[0]));if(this.isNumber(n))return this[rt.MIN](n,r,s[0])}else if("function"==typeof t.eval){var u=t.bindingPath.split("/").filter(function(t){return t}),c=t.field;0!==u.length&&(c=u.join("/")+"/"+c.split(".").filter(function(t){return t}).join("/"));var l={patch:((o={})[c]=n,o),currentRows:[]},f=e&&"function"==typeof e.getEntityListPath&&e.getEntityListPath();if(4===f.length){var h=f.slice(1,3).reverse();l.currentRows.push({bindingPath:h[1],primaryValue:h[0].split(":")[1]})}if(i){if(0!==t.bindingPath.split("/").filter(function(t){return t}).length){var y=e&&"function"==typeof e.getMainEntityPrimaryValue&&e.getMainEntityPrimaryValue();l.currentRows.push({bindingPath:"/",primaryValue:y})}l.currentRow={bindingPath:t.bindingPath,primaryValue:i}}else y=e&&"function"==typeof e.getMainEntityPrimaryValue&&e.getMainEntityPrimaryValue(),l.currentRows.push({bindingPath:"/",primaryValue:y});var d=t.eval(l);if("require"!==t.type)return d;var g=this.required(n,r);return!d||g}return!0},dt.prototype.buildErrors=function(t){var e=new Set(pt.createDetailedErrorMessage(t)),n=[];return e.forEach(function(t){n.push(t)}),{isValid:0===t.length,errors:t,message:n.join("")}},dt.prototype.customValidation=function(t,e){return e},dt.prototype.isEmptyValue=function(t){return""===t||null===t||t===undefined||"0001-01-01"===t||"0001-01-01 00:00:00"===t||"0001-01-01T00:00:00"===t},dt.prototype.required=function(t,e){if(e){var n=ft.getCurrentLanguage();return!(Object.keys(t).length<1)&&(!n||!!t[n])}if("object"==typeof t&&null!==t){if(!Object.keys(t).length)return!1;t=Object.values(t)[0]}return""!==t&&null!==t&&t!==undefined&&"0001-01-01"!==t&&"0001-01-01 00:00:00"!==t&&"0001-01-01T00:00:00"!==t},dt.prototype.equals=function(t,e){return t===e},dt.prototype.notEquals=function(t,e){return t!==e},dt.prototype.isNumber=function(t,e){return void 0===e&&(e={}),t===Infinity||t===-Infinity?e.allowInfinity:Number.isNaN(t)?e.allowNaN:Number.isFinite(t)},dt.prototype.isInt=function(t){return Number.isInteger(t)},dt.prototype.isFloat=function(t){return!(!this.isNumber(t)&&!this.isNumberString(t))&&this.validatorJs.isFloat(t)},dt.prototype.isBoolean=function(t){return t instanceof Boolean||"boolean"==typeof t},dt.prototype.isString=function(t){return t instanceof String||"string"==typeof t},dt.prototype.isDate=function(t){return t instanceof Date&&!isNaN(t.getTime())},dt.prototype.isDateString=function(t){return this.isString(t)&&/\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])(T|\s?)?(([0-2]\d:[0-5]\d)?(:[0-5]\d(?:\.\d+)))?(?:Z|\+[0-2]\d(?:\:[0-5]\d)?)?/g.test(t)&&this.validatorJs.toDate(t)},dt.prototype.length=function(t,e,n,r){return"string"==typeof t&&this.validatorJs.isLength(t,e,n)},dt.prototype.minLength=function(t,e,n){if(e){if("object"==typeof t){var r=Object.values(t).filter(function(t){return t&&t.length<n});if(r&&0<r.length)return!1}return!0}return t&&"string"!=typeof t&&(t=t.toString()),!t||"string"==typeof t&&this.length(t,n)},dt.prototype.maxLength=function(t,e,n){if(e)return!("object"==typeof t&&0<Object.values(t).filter(function(t){return t&&t.length>n}).length);if("object"!=typeof t)return t&&"string"!=typeof t&&(t=t.toString()),!t||"string"==typeof t&&this.length(t,0,n);for(var r in t)if(t.hasOwnProperty(r)&&"string"==typeof t[r]&&!this.length(t[r],0,n))return!1;return!0},dt.prototype.range=function(t,e,n,r){return"number"==typeof t&&this.isNumber(n)&&this.isNumber(r)&&n<=t&&t<=r},dt.prototype.dateRange=function(t,e,n,r){if(!t)return!0;if("maxValue"===r||"maxDate"===r){if(this.isYearRange(t)||this.isMonthOrDayRange(t))return this.maxValue(parseInt(this.getRangeValue(t,1)),e,parseInt(n.split(" ")[0]));if(this.isDayTimeRange(t))return!0}else if("minValue"===r||"minDate"===r){if(this.isYearRange(t)||this.isMonthOrDayRange(t))return this.maxValue(parseInt(this.getRangeValue(t,0)),e,parseInt(n.split(" ")[0]));if(this.isDayTimeRange(t))return!0}return!1},dt.prototype.getRangeValue=function(t,e,n){return void 0===n&&(n="~"),t.split(n)[e]},dt.prototype.isDateRange=function(t){return"string"!=typeof t&&(t=t.toString()),/(\d{4}|\d{2})/.test(t)},dt.prototype.isYearRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^\d{4}~\d{4}$/.test(t)},dt.prototype.isYearMonthRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^\d{4}-\d{2}~\d{4}-\d{2}$/.test(t)},dt.prototype.isMonthOrDayRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^[0|1|2|3]\d{1}~[0|1|2|3]\d{1}$/.test(t)},dt.prototype.isDayTimeRange=function(t){return"string"!=typeof t&&(t=t.toString()),/^[0|1|2|3]\d{1} \d{2}:\d{2}:\d{2}~[0|1|2|3]\d{1} \d{2}:\d{2}:\d{2}$/.test(t)},dt.prototype.min=function(t,e,n){return"number"==typeof t&&"number"==typeof n&&n<=t},dt.prototype.minValue=function(t,e,n){if(null===t||t===undefined)return!0;if("string"==typeof t&&t.match(/^(-?\d+)(\.\d+)?$/g)){var r=new y.BigNumber(t),i=new y.BigNumber(n);return r.isGreaterThanOrEqualTo(i)}return"number"==typeof t&&"number"==typeof n&&n<=t},dt.prototype.max=function(t,e,n){return null===t||t===undefined||"number"==typeof t&&"number"==typeof n&&t<=n},dt.prototype.maxValue=function(t,e,n){if(null===t||t===undefined)return!0;if("string"==typeof t&&t.match(/^(-?\d+)(\.\d+)?$/g)){var r=new y.BigNumber(t),i=new y.BigNumber(n);return r.isLessThanOrEqualTo(i)}return"number"==typeof t&&"number"==typeof n&&t<=n},dt.prototype.minDate=function(t,e,n){return!t||t&&t.getTime()>=n.getTime()},dt.prototype.maxDate=function(t,e,n){return null===t||t===undefined||t&&t.getTime()<=n.getTime()},dt.prototype.isBooleanString=function(t){return"string"==typeof t&&this.validatorJs.isBoolean(t)},dt.prototype.isNumberString=function(t){return"string"==typeof t&&this.validatorJs.isNumeric(t)},dt.prototype.contains=function(t,e,n){return"string"==typeof t&&this.validatorJs.contains(t,n)},dt.prototype.notContains=function(t,e,n){return"string"==typeof t&&!this.validatorJs.contains(t,n)},dt.prototype.isEmail=function(t){return"string"==typeof t&&this.validatorJs.isEmail(t)},dt.prototype.isJSON=function(t){return"string"==typeof t&&this.validatorJs.isJSON(t)},dt.prototype.isLowercase=function(t){return"string"==typeof t&&this.validatorJs.isLowercase(t)},dt.prototype.isUppercase=function(t){return"string"==typeof t&&this.validatorJs.isUppercase(t)},dt.prototype.exclude=function(e,n,t){var r=this,i=t.split(""),o=0;return i.forEach(function(t){r.contains(e,n,t)&&o++}),0===o},dt.prototype.matches=function(t,e,n){return""===(t=null===t||t===undefined?"":t.toString())||this.validatorJs.matches(t,n)},dt);function dt(){this.validatorJs=n}var gt=(Object.defineProperty(mt.prototype,"items",{get:function(){return this.rawData},enumerable:!0,configurable:!0}),Object.defineProperty(mt.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),mt.prototype[Symbol.iterator]=function(){return f(this,function(t){switch(t.label){case 0:return[5,P(this.items)];case 1:return t.sent(),[2]}})},mt.prototype.loadEntities=function(t){var e=this;this.clear(),t.forEach(function(t){e.initEntity(t)});var n={path:[],value:t,preValue:undefined,type:x.ModifyType.Load,target:this};this.setChanges(n)},mt.prototype.clear=function(){this.rawData=[],this.originalData=[]},mt.prototype.appendNew=function(t,e){void 0===e&&(e=!1);var n=this.initEntity(t,!0),r={path:[],value:[n],preValue:undefined,type:x.ModifyType.Add};return!0===e&&(r.type=x.ModifyType.Clone),this.setChanges(r),n},mt.prototype.insert=function(t,e){var n=this.initEntity(t,!0),r={path:[],value:[n],preValue:undefined,type:x.ModifyType.Insert,position:e};return this.setChanges(r),n},mt.prototype.appendEntity=function(t){var e={path:[],value:[this.initEntity(t,!0)],preValue:undefined,type:x.ModifyType.Add};this.setChanges(e)},mt.prototype.appendEntities=function(t){var e=this,n={path:[],value:t.map(function(t){return e.initEntity(t,!0)}),preValue:undefined,type:x.ModifyType.Add};this.setChanges(n)},mt.prototype.remove=function(e){var t,n=this.count(),r=this.rawData.findIndex(function(t){return t.primaryValue===e});if(-1===r)return!1;var i=this.rawData[r];this.rawData.splice(r,1);var o={path:[],value:((t={})[i.primaryProperty.dataField]=e,t),preValue:undefined,type:x.ModifyType.Remove};return this.updateIndex(n),this.setChanges(o),!0},mt.prototype.get=function(e){return this.items.find(function(t){return t.primaryValue===e})},mt.prototype.setChanges=function(t){this.listChanged.next(t);var e=Object.assign({},t);(t.type===x.ModifyType.Add||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Clone)&&t.value[0]instanceof Fn&&(e.value=[t.value[0].data]),this.changeSet.append(e)},mt.prototype.count=function(){return this.items.length},mt.prototype.indexOf=function(t){return this.items.indexOf(t)},mt.prototype.sum=function(n){return 0===this.count()?0:this.items.reduce(function(t,e){return t+e[n]},0)},mt.prototype.validate=function(){var t=this.getPropertyName();return h.from(this.validator.validate(this[W],t))},mt.prototype.toJson=function(){return this.rawData},mt.prototype.toJSON=function(){var e=[];return this.items.forEach(function(t){e.push(t.toJSON())}),e},mt.prototype.toArray=function(){return this.items},mt.prototype.initEntity=function(t,e){var n=this;void 0===e&&(e=!1),t[W]=this,t[J]=this[J],t.onValueChanged.subscribe(function(t){var e={path:t.path,value:t.value,preValue:t.preValue,type:t.type};t.changeSetValue!==undefined&&(e.changeSetValue=t.changeSetValue),n.setChanges(e)});var r=this.rawData.push(t);return this[r-1]=t,e||this.originalData.push(t.toJSON()),t},mt.prototype.updateIndex=function(t){for(var n=this,e=0;e<t;e++)delete this[e];this.rawData.forEach(function(t,e){n[e]=t})},mt.prototype.getPropertyName=function(){var t=this[J];return t&&t.length?t[t.length-1]:undefined},mt);function mt(t,e){var n=this;this.__type__="EntityList",this.originalData=[],this.listChanged=new h.Subject,this.changeSet=new D,this.validator=new yt,this.onListChanged=this.listChanged.asObservable(),this.clear(),t&&t.forEach(function(t){n.initEntity(et(e,t))})}var vt,Et,bt,Ct="BigNumber";(vt=x.DataChangeType||(x.DataChangeType={}))[vt.Add=0]="Add",vt[vt.Delete=1]="Delete",(Et=x.HttpMethod||(x.HttpMethod={})).GET="GET",Et.POST="POST",Et.PUT="PUT",Et.DELETE="DELETE",function(t){var e;(e=t.Level||(t.Level={})).Error="Error",e.Info="Info",e.Warning="Warning";var n=function r(t,e){this.bizMessages=t,this.context=e};t.Message=n}(x.BackEndMessage||(x.BackEndMessage={})),(bt=x.RunMode||(x.RunMode={})).compatible="compatible",bt.highSpeed="highSpeed";var xt,Pt=new d.InjectionToken("@farris/devkit_run_mode");(xt=x.ComponentType||(x.ComponentType={})).farrisDataGridComponent="farrisDatagridComponent",xt.farrisTreeTalbeComponent="farrisTreeTalbeComponent",xt.primengTreeComponent="primengTreeComponent",xt.kendoGridComponent="kendoGridComponent";var It=(Tt.setUserSettings=function(t){this.userSettings=t,this.timeZone=undefined,this.timeZoneOffset=undefined},Tt.getTimeZone=function(){if(this.timeZone!==undefined)return this.timeZone;var t=this.userSettings&&this.userSettings.timeZone||null;return this.timeZone=t},Tt.getTimeZoneOffset=function(){if(this.timeZoneOffset!==undefined)return this.timeZoneOffset;var t=this.userSettings&&this.userSettings.timeZoneOffset||null;return this.timeZoneOffset=t},Tt.userSettings=null,Tt.timeZone=undefined,Tt.timeZoneOffset=undefined,Tt);function Tt(){}var Mt=(St.zonedTimeToSpecialTimeZoneOffsetTimeString=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n="YYYY-MM-DD HH:mm:ss.SSS");var r=60*e;return i(t).utc().add(r,"m").format(n)},St.timeZoneOffsetTimeToUtcTimeString=function(t,e,n){return void 0===n&&(n="YYYY-MM-DD HH:mm:ss.SSS"),i(t).utcOffset(e,!0).toISOString()},St);function St(){}var jt,wt,Ot,Nt=(Dt.prototype.getParams=function(t){return this.getAllParams()[t]||{}},Dt.prototype.setParams=function(t,e){var n=this.getAllParams();n[t]=e,this.setAllParams(n)},Dt.prototype.clearParams=function(){throw new Error("Not Implemented")},Dt.prototype.getAllParams=function(){var t=window.sessionStorage.getItem("ROUTER_PARAMS")||"{}";return JSON.parse(t)},Dt.prototype.setAllParams=function(t){t=t||{};var e=JSON.stringify(t);window.sessionStorage.setItem("ROUTER_PARAMS",e)},Dt.prototype.clearAllParams=function(){window.sessionStorage.setItem("ROUTER_PARAMS","{}")},Dt.decorators=[{type:d.Injectable}],Dt);function Dt(){}(jt=x.ChangeType||(x.ChangeType={})).Update="Update",jt.Load="Load",jt.Append="Append",jt.Remove="Remove",jt.Swap="Swap",jt.SelectionChanged="SelectionChanged",jt.ValueChanged="ValueChanged",jt.UpdateErrors="UpdateErrors",jt.GlobalSelectionChanged="GlobalSelectionChanged",jt.PaginationInfoChange="PaginationInfoChange",(wt=x.ViewChangeType||(x.ViewChangeType={}))[wt.ValueChanged=0]="ValueChanged",(Ot=x.BindingPropertyType||(x.BindingPropertyType={})).Plain="Plain",Ot.Object="Object",Ot.List="List",Ot.Dynamic="Dynamic";var Vt=(Object.defineProperty(Ft.prototype,"primaryKeyValue",{get:function(){return this.primaryKey?this.getValue(this.primaryKey):""},enumerable:!0,configurable:!0}),Ft.prototype.setShowValidationMsg=function(t){this.isShowValidationMsg=t},Ft.prototype.getValue=function(t){return this.innerValues.get(t)},Ft.prototype.setValue=function(r,i,o,t,a,s,p){var u=this;void 0===o&&(o=!1),void 0===t&&(t=!1);var c=this.getValue(r);if(s&&c!==i||(s=function(t,e,n,r){return h.of(!0)}),!0===t)s(c,i,!1,this.primaryKeyValue).subscribe(function(t){if(t){u.innerValues=u.innerValues.set(r,i);var e=u.buildViewChangesContext(r,i,c,a,p);if(u.viewChanges.next(e),!0===o){var n=u.buildChangesContext(r,i,p,a);u.changes.next(n)}s(c,i,!0,u.primaryKeyValue).subscribe()}else n=u.buildChangesContext(r,c,p,a),u.changes.next(n)});else{if(this.innerValues=this.innerValues.set(r,i),!0===o){var e=this.buildChangesContext(r,i,p,a);this.changes.next(e)}s(c,i,!0,this.primaryKeyValue).subscribe()}},Ft.prototype.toJSON=function(a){var s=this,p=this.getCurrentLanguage(),u={};return this.properties.forEach(function(t){var e,n=t.name;if(t.type===x.BindingPropertyType.List){var r=s[n];u[n]=r.toJSON(a)}else if(t.type===x.BindingPropertyType.Object){var i=s[n];u[n]=i.toJSON(a)}else if(t.type===x.BindingPropertyType.Dynamic)i=s[n],u[n]=i.toJSON(a);else if(!0===t.enableMultiLangInput)if(a&&!0===a.ignoreMultiLangInput){var o=s.getValue(n);u[n]=o?o[p]:o}else a&&a.useFullMultiLangProperty?(o=s.getValue(n))&&(u[n+"_MULTILANGUAGE"]=o,u[n]=o[p]):(o=s.getValue(n),u[n]=o||((e={})[p]=o,e));else u[n]=s.getValue(n)}),u},Ft.prototype.getCurrentLanguage=function(){return this.currentLanguage=this.currentLanguage||window.localStorage.getItem("languageCode")||"zh-CHS",this.currentLanguage},Ft.prototype.buildChangesContext=function(t,e,n,r,i){return void 0===i&&(i=x.ChangeType.ValueChanged),{type:i,path:[t],value:e,id:this.primaryKeyValue,errors:r,context:n}},Ft.prototype.buildViewChangesContext=function(t,e,n,r,i,o){return void 0===o&&(o=x.ViewChangeType.ValueChanged),{type:o,path:[t],value:e,preValue:n,errors:r,context:i}},Ft);function Ft(){this.__type__="BindingObject",this.isShowValidationMsg=!1,this.unsubscribe=new h.Subject,this.controlMap={},this.innerValues=e.Map(),this.changes=new h.Subject,this.viewChanges=new h.Subject}var Rt=(_t.getProperties=function(t){var n=[],r=K.getNgFields(t);Object.keys(r).forEach(function(t){var e=r[t];n.push({name:t,type:x.BindingPropertyType.Plain,isPrimaryKey:e.primary,isForeignKey:e.foreign,enableMultiLangInput:e.enableMultiLangInput})});var i=K.getNgObjects(t);Object.keys(i).forEach(function(t){var e=i[t];n.push({name:t,type:x.BindingPropertyType.Object,entityType:e.type})});var o=K.getNgList(t);Object.keys(o).forEach(function(t){var e=o[t];n.push({name:t,type:x.BindingPropertyType.List,entityType:e.type})});var a=K.getNgDynamic(t);return Object.keys(a).forEach(function(t){var e=a[t];n.push({name:t,type:x.BindingPropertyType.Dynamic,entityType:e.type})}),n},_t.getDynamicProperties=function(e){var n=[];return Object.keys(e).forEach(function(t){e.hasOwnProperty(t)&&(e[t]instanceof Object?n.push({name:t,type:x.BindingPropertyType.Dynamic,entityType:null}):n.push({name:t,type:x.BindingPropertyType.Plain,isPrimaryKey:!1,isForeignKey:!1}))}),n},_t.getPropertyByName=function(t,e){return t.find(function(t){return t.name===e})},_t.getPrimaryKey=function(t){var e=t.find(function(t){return!0===t.isPrimaryKey});return e?e.name:""},_t);function _t(){}var Bt,At=(c(Lt,Bt=Vt),Lt);function Lt(t){var e=Bt.call(this)||this;return e.properties=t,e.primaryKey=Rt.getPrimaryKey(t),e}var kt=($t.create=function(t){return new(this.getType(t))(t)},$t.createType=function(t){var e,n=(c(r,e=Pn),r);function r(t){return e.call(this,t)||this}var i=n.prototype;return this.extendProperties(i,t),n},$t.extendProperties=function(n,t){t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return this.currentItem[e]}})})},$t.getType=function(t){if(this.provider.has(t))return this.provider.get(t);var e=this.createType(t);return this.provider.set(t,e),e},$t.provider=new Map,$t);function $t(){}var Ut=(Ht.create=function(t){return kt.create(t)},Ht.extendProperties=function(n,t){t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return n.currentItem[e]}})})},Ht);function Ht(){}var Kt=(Gt.create=function(t){return new(this.getType(t))},Gt.createType=function(t){var e,n=(c(r,e=Vt),r);function r(){return e.call(this)||this}var i=Rt.getPrimaryKey(t);return n.prototype.primaryKey=i,n.prototype.properties=t,this.extendProperties(n.prototype,t),n},Gt.extendProperties=function(e,t){var n=this;t.forEach(function(t){t.type===x.BindingPropertyType.List?n.extendListProperty(e,t):t.type===x.BindingPropertyType.Object?n.extendObjectProperty(e,t):t.type===x.BindingPropertyType.Dynamic?n.extendDynamicObjectProperty(e,t):n.extendPlainProperty(e,t)})},Gt.extendListProperty=function(t,e){var i=e.name,o=Rt.getProperties(e.entityType),a="_"+i+"_";Object.defineProperty(t,i,{get:function(){var e=this,t=this[a];if(!t){t=Ut.create(o),this[a]=t;var n=this.getValue(i);if(n){var r=n.map(function(t){return Gt.create(o)});t.load(r)}t.parent=this,t.changes.subscribe(function(t){t.path.unshift(i),e.changes.next(t)})}return t},set:function(t){this[a]=t}})},Gt.extendObjectProperty=function(t,e){var n=e.name,r=Rt.getProperties(e.entityType),i="_"+n+"_";Object.defineProperty(t,n,{get:function(){var e=this,t=this[i];return t||(this.getValue(n),t=Gt.create(r),(this[i]=t).parent=this,t.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)})),t},set:function(t){this[i]=t}})},Gt.extendDynamicObjectProperty=function(t,e){t[e.name]=null},Gt.extendPlainProperty=function(t,n){var r=n.name;Object.defineProperty(t,r,{get:function(){var t,e;return!0!==n.enableMultiLangInput?e=this.getValue(r):(e=this.getValue(r,!1))?e:(e=this.getValue(r,!1),(t={})[ft.getCurrentLanguage()]=e,t)},set:function(t){t!==this.getValue(r)&&this.setValue(r,t,!0,!0)}})},Gt.getType=function(t){if(this.provider.has(t))return this.provider.get(t);var e=this.createType(t);return this.provider.set(t,e),e},Gt.provider=new Map,Gt);function Gt(){}var zt=(qt.create=function(t){return Kt.create(t)},qt.createDynamicBindingObject=function(t){var e=Rt.getDynamicProperties(t),n=Kt.create(e);return this.extendProperties(n,e),n},qt.extendProperties=function(e,t){var n=this;t.forEach(function(t){t.type===x.BindingPropertyType.List?n.extendListProperty(e,t):t.type===x.BindingPropertyType.Object?n.extendObjectProperty(e,t):t.type===x.BindingPropertyType.Dynamic?n.extendDynamicObjectProperty(e,t):n.extendPlainProperty(e,t)})},qt.extendListProperty=function(e,t){var n=t.name,r=Rt.getProperties(t.entityType),i=Ut.create(r);i.parent=e,i.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:i})},qt.extendObjectProperty=function(e,t){var n=t.name,r=Rt.getProperties(t.entityType),i=this.create(r);i.parent=e,i.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:i})},qt.extendDynamicObjectProperty=function(t,e){t[e.name]=null},qt.attachDynamicObjectProperty=function(e,n,t){t.parent=e,t.changes.subscribe(function(t){t.path.unshift(n),e.changes.next(t)}),Object.defineProperty(e,n,{value:t})},qt.extendPlainProperty=function(e,t){var n=t.name;Object.defineProperty(e,n,{get:function(){return e.getValue(n)},set:function(t){t!==e.getValue(n)&&e.setValue(n,t,!0,!0)}})},qt);function qt(){}var Jt="NgValidateForm";var Wt="NgChildForm",Yt=M(Wt,function(t){return t}),Zt="NgChildFormArray",Xt=M(Zt,function(t){return t}),Qt="NgFormControl",te=M(Qt,function(t){return t}),ee=(ne.toBindingPathArray=function(t){return"string"==typeof t?t.split("/").filter(function(t){return""!==t}):t.concat([])},ne.toBindingPathString=function(t){return"/"+t.join("/")},ne);function ne(){}var re=(ie.isEqual=function(t,e){var n=ee.toBindingPathArray(t),r=ee.toBindingPathArray(e);return n.every(function(t,e){return t===r[e]})},ie.isParent=function(t,e){var n=ee.toBindingPathArray(t),r=ee.toBindingPathArray(e);if(n.length===r.length+1)return this.isAncestor(t,e)},ie.isAncestor=function(t,e){var n=ee.toBindingPathArray(t),r=ee.toBindingPathArray(e);return!(t.length<=r.length)&&r.every(function(t,e){return t===n[e]})},ie);function ie(){}var oe=(ae.getLeafPathString=function(t){return ee.toBindingPathArray(t).pop()},ae.getParentPathString=function(t){var e=ee.toBindingPathArray(t);return e.pop(),"/"+e.join("/")},ae);function ae(){}var se=(pe.toEntityPathArray=function(t,e){var n=this,r=ee.toBindingPathArray(t),i=[];if(0===r.length)return i;var o=e.list.currentItem;return i.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),r.forEach(function(t){switch(Rt.getPropertyByName(o.properties,t).type){case x.BindingPropertyType.Plain:i.push(t);break;case x.BindingPropertyType.Object:o=o[t],i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case x.BindingPropertyType.List:var e=o[t];o=e.currentItem,i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}}),i},pe.createPrimaryKeyPath=function(t,e){return t+":"+e},pe);function pe(){}var ue,ce=function pp(){},le=(fe.toBindingPathArray=function(t){return t.split(".").filter(function(t){return""!==t})},fe);function fe(){}(ue=x.DataPathNodeType||(x.DataPathNodeType={})).DataId="DataId",ue.PropName="PropName";var he=function up(t,e){this.type=t,this.value=e,this.prev=null,this.next=null},ye=(de.prototype.unshift=function(t,e){var n=new he(t,e);n.next=this.head.next,n.prev=this.head,(this.head.next=n).next&&(n.next.prev=n),this.length++},de.prototype.push=function(t,e){var n=this.getTail(),r=new he(t,e);n.next=r,this.length++},de.prototype.getTail=function(){for(var t=this.head;t.next;)t=t.next;return t},de.prototype.toArray=function(){for(var t=[],e=this.head.next;e;)t.push(e.type+":"+e.value),e=e.next;return t},de.prototype.toString=function(){return"["+this.toArray().join(", ")+"]"},de.prototype.clone=function(){for(var t=new de,e=this.head.next;e;)t.push(e.type,e.value),e=e.next;return t},de);function de(){this.head=new he(null,null),this.length=0}var ge,me=(ve.createByLongPathFromRoot=function(t,e){var n=new ye,r=t;if(!r||0===r.length)return n;for(var i={nodeValue:r.shift(),nodeType:x.DataPathNodeType.DataId,entityTypeInfo:new be(e.entityType)};i;){n.push(i.nodeType,i.nodeValue);var o=r.shift();if(!o||!i.entityTypeInfo)break;i=this.getNextPathNodeInfo(i,o)}return n},ve.getNextPathNodeInfo=function(t,e){var n=t.nodeValue,r=t.nodeType,i=t.entityTypeInfo;if(!e||!i)return null;var o={nodeValue:e,nodeType:null,entityTypeInfo:null};if(r===x.DataPathNodeType.DataId)o.nodeType=x.DataPathNodeType.PropName,o.entityTypeInfo=i;else{var a=i.getPropInfoByName(n);a.group===x.DataPropGroup.List?(o.nodeType=x.DataPathNodeType.DataId,o.entityTypeInfo=a.typeInfo):(o.nodeType=x.DataPathNodeType.PropName,o.entityTypeInfo=a.group===x.DataPropGroup.Object?a.typeInfo:null)}return o},ve.createByShortPathFromRoot=function(t,e,n){var r=new ye,i=t,o=n.list.currentItem,a=new be(e.entityType);return r.push(x.DataPathNodeType.DataId,o.primaryKeyValue),i.forEach(function(t){var e=a.getPropInfoByName(t);switch(e.group){case x.DataPropGroup.Plain:r.push(x.DataPathNodeType.PropName,t);break;case x.DataPropGroup.Object:o=o[t],a=e.typeInfo,r.push(x.DataPathNodeType.PropName,t);break;case x.DataPropGroup.List:var n=o[t];o=n.currentItem,a=e.typeInfo,r.push(x.DataPathNodeType.PropName,t),r.push(x.DataPathNodeType.DataId,o.primaryKeyValue)}}),r},ve);function ve(){}(ge=x.DataPropGroup||(x.DataPropGroup={})).Plain="Plain",ge.Object="Object",ge.Dynamic="Dynamic",ge.List="List";var Ee=function cp(){},be=(Object.defineProperty(Ce.prototype,"isValueObject",{get:function(){return!this.primaryKey},enumerable:!0,configurable:!0}),Ce.prototype.getBindingPathByTableName=function(t){var e=this.getFullEntityPath(this,t);return e?(e.splice(0,1),"/"+e.join("/")):null},Ce.prototype.getFullEntityPath=function(t,e,n){if(void 0===n&&(n=[]),t.entityInfo&&(t.entityInfo.nodeCode===e||t.entityInfo.originalCode===e))return n.push(t.entityInfo.nodeCode),n;var r=Array.from(t.propInfoMap.values()).filter(function(t){return t.typeInfo});if(r.length<1)return n=[];t.entityInfo&&n.push(t.entityInfo.nodeCode);for(var i=0;i<r.length;i++){var o=r[i].typeInfo,a=this.getFullEntityPath(o,e);if(a&&!(a.length<1))return n=n.concat(a)}return null},Ce.prototype.getPropInfos=function(){return Array.from(this.propInfoMap.values()).filter(function(t){return!t.isVOField})},Ce.prototype.getPropNames=function(){var e=[];return this.getPropInfos().forEach(function(t){e.push(t.name)}),e},Ce.prototype.getPropInfosByGroup=function(e){return Array.from(this.propInfoMap.values()).filter(function(t){return t.group===e&&!t.isVOField})},Ce.prototype.getPropNamesByGroup=function(t){var e=[];return this.getPropInfosByGroup(t).forEach(function(t){e.push(t.name)}),e},Ce.prototype.getPropInfoByName=function(t){return this.propInfoMap.has(t)?this.propInfoMap.get(t):null},Ce.prototype.getPropInfoByPath=function(t){var e=t.concat([]);if(0===e.length)throw Error("属性路径不能为空");for(var n=this,r=null;n&&0<e.length;){var i=e.shift();if(!(r=n.getPropInfoByName(i)))throw Error("路径"+t+"中存在不正确的节点"+i+"，请检查");n=r.typeInfo,r.group===x.DataPropGroup.Dynamic&&0<e.length&&(n=r=null)}return r},Ce.prototype.getTypeInfoByPath=function(t){if(0===t.length)return this;var e=this.getPropInfoByPath(t);if(!e.typeInfo)throw Error("路径"+t+"无法定位到一个EntityTypeInfo，请检查");return e.typeInfo},Ce.prototype.getPrimaryKeyPropInfo=function(){return this.getPropInfoByName(this.primaryKey)},Ce.prototype.getPropMappingByName=function(t){var e=this.getPropInfoByName(t);return e?e.mapping:""},Ce.prototype.getPropMappingByPath=function(t){var e=this.getPropInfoByPath(t);return e?e.mapping:""},Ce.prototype.checkPropGroup=function(t,e){var n=this.getPropInfoByName(t);return!(!n||n.group!==e)},Ce.prototype.collectPropInfos=function(){var n=this,r=z.getNgFieldProperties(this.type);Object.keys(r).forEach(function(t){var e=r[t];!0===e.primary&&(n.primaryKey=t),!0===e.foreign&&(n.foreignKey=t),n.addPropInfo(x.DataPropGroup.Plain,t,e.dataField,null,e)});var i=z.getNgObjectProperties(this.type);Object.keys(i).forEach(function(t){var e=i[t];n.addPropInfo(x.DataPropGroup.Object,t,e.dataField,e.type,e)});var o=z.getNgDynamicProperties(this.type);Object.keys(o).forEach(function(t){var e=o[t];n.addPropInfo(x.DataPropGroup.Dynamic,t,e.dataField,null,e)});var a=z.getNgListProperties(this.type);Object.keys(a).forEach(function(t){var e=a[t];n.addPropInfo(x.DataPropGroup.List,t,e.dataField,e.type,e)})},Ce.prototype.collectEntityInfos=function(){var t=z.getNgEntityMatadata(this.type);t=t||{originalCode:this.type.code,nodeCode:this.type.label},this.entityInfo=t},Ce.prototype.addPropInfo=function(t,e,n,r,i){n=n||e;var o=null;r&&(o=new Ce(r));var a={group:t,name:e,mapping:n,typeInfo:o,metadataInfo:i};this.propInfoMap.set(e,a);var s=i&&i.originalDataField;if(s&&!this.propInfoMap.has(s))this.propInfoMap.set(s,E({},a,{isVOField:!0}));else if(i&&i.type){var p=z.getNgEntityMatadata(i.type);p&&p.originalCode&&this.propInfoMap.set(p.originalCode,E({},a,{isVOField:!0}))}},Ce);function Ce(t){this.type=t,this.primaryKey="",this.foreignKey="",this.propInfoMap=new Map,this.collectEntityInfos(),this.collectPropInfos()}var xe=new d.InjectionToken("@farris/devkit form path token"),Pe=new d.InjectionToken("@farris/devkit_back_end_message_handler"),Ie=new d.InjectionToken("@farris/message_service_token"),Te=new d.InjectionToken("@farris/notify_service_token"),Me=new d.InjectionToken("@farris/changeset_policy_token");var Se=(je.warn=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.warn.apply(console,b([t],e))},je.error=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.error.apply(console,b([t],e))},je.log=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];this.logable()&&console&&console.log.apply(console,b([t],e))},je.logable=function(){return window&&window.localStorage&&"true"===window.localStorage.getItem("__DEVKIT_LOGABLE__")||!1},je);function je(){}function we(t){return t&&"string"==typeof t?t.replace(/[\\]/g,"\\\\").replace(/[\"]/g,'\\"').replace(/[\/]/g,"\\/").replace(/[\b]/g,"\\b").replace(/[\f]/g,"\\f").replace(/[\n]/g,"\\n").replace(/[\r]/g,"\\r").replace(/[\t]/g,"\\t"):t}var Oe=new d.InjectionToken("@farris_resolver_token"),Ne="ENTITY~",De="STATE~",Ve=["SumByProp","CountByProp","AvgByProp","MaxByProp","MinByProp","IsExistRecord","ListContains","ListGreaterThan","ListLessThan","ListStartWith","ListEndWith","MultiplyChildNumber"],Fe=(Re.decorators=[{type:d.Injectable}],Re.ctorParameters=function(){return[{type:d.Injector},{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Oe]}]}]},Re);function Re(t,e){this.injector=t,this.resolvers=e}var _e="NgRepository";var Be=(Object.defineProperty(Ae.prototype,"changeSetPolicy",{get:function(){return this._changeSetPolicy},set:function(t){this._changeSetPolicy=t},enumerable:!0,configurable:!0}),Ae.prototype.count=function(){return this.innerEntitySet.size},Object.defineProperty(Ae.prototype,"entityTypeName",{get:function(){return this.entityType.name},enumerable:!0,configurable:!0}),Ae.prototype.has=function(t){return this.innerEntityMap.has(t)},Ae.prototype.clear=function(){this.innerEntityMap.clear(),this.innerEntitySet.clear(),this.notifyCollectionChanged(new O([],x.ModifyType.Load))},Ae.prototype.reset=function(t){if(void 0===t&&(t=!0),this.innerEntityMap.forEach(function(t){t.unsubscribe.next(),t.unsubscribe.complete()}),this.innerEntitySet.forEach(function(t){t.unsubscribe.next(),t.unsubscribe.complete()}),this.innerEntityMap.clear(),this.innerEntitySet.clear(),!0===t){var e=new O([],x.ModifyType.Load);e.isReset=!0,this.notifyCollectionChanged(e)}},Ae.prototype.toArray=function(){return Array.from(this.innerEntitySet)},Ae.prototype.toJSON=function(){var e=[];return this.toArray().forEach(function(t){e.push(t.toJSON())}),e},Ae.prototype.loadEntities=function(t,e){var n=this;void 0===e&&(e=!1),this.innerEntityMap.clear(),this.innerEntitySet.clear(),t.forEach(function(t){n.extendChangeSetPolicyProperty(t),n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)});var r=new O(t,x.ModifyType.Load);r.entityCreate=e,this.notifyCollectionChanged(r)},Ae.prototype.addEntity=function(t,e){void 0===e&&(e=!1),this.verifyEntityToAdd(t),this.extendChangeSetPolicyProperty(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t);var n=e?x.ModifyType.Clone:x.ModifyType.Add;this.notifyCollectionChanged(new O([t],n))},Ae.prototype.insertEntity=function(t,e){this.verifyEntityToAdd(t),this.extendChangeSetPolicyProperty(t),this.innerEntitySet.add(t),this.innerEntityMap.set(t[this.primaryKey],t),this.listenEntityChangeEvent(t),this.notifyCollectionChanged(new O(t,x.ModifyType.Insert,null,null,e))},Ae.prototype.updateEntity=function(t,e){t.load(e),this.notifyCollectionChanged(new O(e,x.ModifyType.Update,null,null))},Ae.prototype.addEntities=function(t,e){var n=this;if(void 0===e&&(e=null),t){var r=[];t.forEach(function(t){n.verifyEntityToAdd(t),r.push(t)}),r.forEach(function(t){n.extendChangeSetPolicyProperty(t),n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)});var i=e&&e.isTreeNodeLoadScene||!1,o=new O(r,x.ModifyType.Add);o.isTreeNodeLoadScene=i,this.notifyCollectionChanged(o)}},Ae.prototype.addData=function(t,e){var n=this;if(void 0===e&&(e=null),t){var r=[];t.forEach(function(t){n.verifyEntityToAdd(t),r.push(t)}),r.forEach(function(t){n.extendChangeSetPolicyProperty(t),n.innerEntitySet.add(t),n.innerEntityMap.set(t[n.primaryKey],t),n.listenEntityChangeEvent(t)});var i=e&&e.isTreeNodeLoadScene||!1,o=new O(r,x.ModifyType.AddData);o.isTreeNodeLoadScene=i,this.notifyCollectionChanged(o)}},Ae.prototype.extendChangeSetPolicyProperty=function(t){t&&(t.changeSetPolicy=this.changeSetPolicy)},Ae.prototype.getEntityById=function(t){return!1===this.innerEntityMap.has(t)?null:this.innerEntityMap.get(t)},Ae.prototype.getEntityByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),r=1;r<t.length&&n;r+=1){var i=t[r];n instanceof Fn||"ConcreteEntityPrototype"===n.typeName?-1===i.indexOf(":")&&(n=n[t[r]]):n=n.get(t[r].split(":")[1])}return n},Ae.prototype.getEntitiesByPath=function(t){for(var e=t[0].split(":")[1],n=this.getEntityById(e),r=1;r<t.length&&n;r+=2){if(!((n=n[t[r]])instanceof gt))throw new Error("路径格式错误");if(r+1<t.length){var i=t[r+1].split(":")[1];n=n.get(i)}}return n},Ae.prototype.getEntities=function(t){return Array.from(this.innerEntitySet).filter(t)},Ae.prototype.getAllEntities=function(){return Array.from(this.innerEntitySet)},Ae.prototype.removeEntityById=function(t){this.verifyEntityToRemove(t);var e=this.innerEntityMap.get(t);return this.innerEntityMap["delete"](t),this.innerEntitySet["delete"](e),this.notifyCollectionChanged(new O([e],x.ModifyType.Remove)),e},Ae.prototype.removeEntitiesByIds=function(t){},Ae.prototype.removeEntities=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach(function(t){e.innerEntityMap["delete"](t[e.primaryKey]),e.innerEntitySet["delete"](t)}),this.notifyCollectionChanged(new O(n,x.ModifyType.Remove)),n},Ae.prototype.removeData=function(t){var e=this,n=Array.from(this.innerEntitySet).filter(t);return n.forEach(function(t){e.innerEntityMap["delete"](t[e.primaryKey]),e.innerEntitySet["delete"](t)}),this.notifyCollectionChanged(new O(n,x.ModifyType.RemoveData)),n},Ae.prototype.resetEntities=function(t,e){if(-1===t[0].indexOf(":"))throw new Error("路径格式错误");var n=t[0].split(":")[1],r=this.innerEntityMap.get(n),i=r[t[1]];if(!r)throw new Error("找不到主键为"+n+"的实体");for(var o=2;o<t.length;o+=2){var a=t[o].split(":")[1];if(!(r=i.get(a)))throw new Error("找不到主键为"+n+"的实体");i=r[t[o+1]]}i.clear(),i.loadEntities(e)},Ae.prototype.verifyEntityToAdd=function(t){if(this.has(t[this.primaryKey]))throw new Error("The repository already had an item with the save identity of '"+t[this.primaryKey]+"'");return!0},Ae.prototype.verifyEntityToRemove=function(t){if(!this.has(t))throw new Error("The entity with identity of '"+t+" dose not exsit.'");return!0},Ae.prototype.notifyCollectionChanged=function(t){this.collectionChanged.next(t)},Ae.prototype.listenEntityChangeEvent=function(t){var e=this;t&&t.onValueChanged.subscribe(function(t){return e.changes.next(t)})},Object.defineProperty(Ae.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.pageSize||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageSize");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageSize:t}),this.notifyCollectionChanged(new O(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(Ae.prototype,"totalCount",{get:function(){return this.paginationInfo&&this.paginationInfo.total||0},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:total");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{total:t}),this.notifyCollectionChanged(new O(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Object.defineProperty(Ae.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.pageIndex||1},set:function(t){if("number"!=typeof t||t<0)throw new Error("Invalid parameter:pageIndex");var e=this.paginationInfo;this.paginationInfo=Object.assign({},e,{pageIndex:t}),this.notifyCollectionChanged(new O(this.paginationInfo,x.ModifyType.PaginationInfoChange))},enumerable:!0,configurable:!0}),Ae.prototype.updatePaginationInfoByPath=function(t,e){var n=this.paginationInfo,r=e.pageIndex,i=e.pageSize,o=e&&(e.totalCount||e.total)||0,a=Object.assign({},n,{pageIndex:r,pageSize:i,total:o});this.setPaginationConfigByPath(t,a)},Ae.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=t.split("/").filter(function(t){return!!t&&0<t.trim().length}).map(function(t){return t.trim()}),r=this.paginationInfo;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},Ae.prototype.setPaginationConfigByPath=function(r,t){var e=JSON.stringify(this.paginationInfo);return r&&"/"!==r?(Array.isArray(r)||(r=r.toString().match(/[^/[\]]+/g)||[]),r.slice(0,-1).reduce(function(t,e,n){return Object(t[e])===t[e]?t[e]:t[e]=Math.abs(r[n+1])>>0==+r[n+1]?[]:{}},this.paginationInfo)[r[r.length-1]]=t):this.paginationInfo=t,JSON.stringify(this.paginationInfo)!==e&&this.notifyCollectionChanged(new O(this.paginationInfo,x.ModifyType.PaginationInfoChange)),this.paginationInfo},Ae);function Ae(t){this.innerEntitySet=new Set,this.innerEntityMap=new Map,this.collectionChanged=new h.Subject,this.changes=new h.Subject,this.entityType=t,this.primaryKey=K.getPrimaryKey(this.entityType)||t.prototype.primaryKey}var Le=(ke.prototype.createEntity=function(t){return Q(this.entityType,t)},ke.prototype.createEntities=function(t,e){return tt(this.entityType,t)},ke.prototype.createEntitiesByPath=function(t,e){var n,r,i,o=t.split("/");if(o.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");if(e.length<1)return[];for(var a=2;a<o.length;a+=2){var s=o[a-1];i=o[a],n=(n?n.get(s):this.entityCollection.getEntityById(s))[i];var p=r?r.propEntityType:this.entityType;if(r=En.getPropInfo(p,i),!n)throw Error("fpath参数错误，无法找到"+i+"对应的子表。fpath为："+t)}return e.map(function(t){return Q(r.propEntityType,t)})},ke.prototype.getEntityByPath=function(t){return this.getEntityNodeByPath(t)},ke.prototype.getEntitiesByPath=function(t){var e=this.getEntityNodeByPath(t);return e.toArray()},ke.prototype.getEntityNodeByPath=function(t){for(var e=me.createByLongPathFromRoot(t,this),n=this.entityCollection,r=e.head.next;r;){if(!(n=r.type===x.DataPathNodeType.DataId?n instanceof Be==1?n.getEntityById(r.value):n.get(r.value):n[r.value]))throw new Error("找不到"+r.value+"对应的数据节点");r=r.next}return n},ke.prototype.getPropValueByPath=function(t){var e=t.pop();return this.getEntityByPath(t)[e]},ke.prototype.setPropValueByPath=function(t,e){var n=t.pop();this.getEntityByPath(t)[n]=e},ke.prototype.insertEntityBeforeByPath=function(t){throw new Error("Not Implemented")},ke.prototype.insertEntitiesBeforeByPath=function(){throw new Error("Not Implemented")},ke.prototype.insertEntityAfterByPath=function(){throw new Error("Not Implemented")},ke.prototype.insertEntitiesAfterByPath=function(){throw new Error("Not Implemented")},ke.prototype.appendEntityByPath=function(t,e,n,r){void 0===r&&(r=!1);var i,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var p=2;p<s.length;p+=2){var u=s[p-1];a=s[p],i=(i?i.get(u):this.entityCollection.getEntityById(u))[a];var c=o?o.propEntityType:this.entityType;if(o=En.getPropInfo(c,a),!i)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var l=Q(o.propEntityType,e);return i.appendNew(l,r),l},ke.prototype.insertEntityByPath=function(t,e,n,r){var i,o,a,s=t.split("/");if(s.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var p=2;p<s.length;p+=2){var u=s[p-1];a=s[p],i=(i?i.get(u):this.entityCollection.getEntityById(u))[a];var c=o?o.propEntityType:this.entityType;if(o=En.getPropInfo(c,a),!i)throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}var l=Q(o.propEntityType,e);return i.insert(l,r),l},ke.prototype.appendEntitiesByPath=function(t,e){var n=this.getEntityNodeByPath(t);n instanceof Be==1?n.addEntities(e):n.appendEntities(e)},ke.prototype.removeEntityByPath=function(t,e){var n,r=t.split("/");if(r.length<3)throw Error("根据path删除实体数据出错了。传入的path["+t+"]格式不对");for(var i=2;i<r.length;i+=2){var o=r[i-1],a=r[i];if(!(n=(n?n.get(o):this.entityCollection.getEntityById(o))[a]))throw Error("fpath参数错误，无法找到"+a+"对应的子表。fpath为："+t)}n.remove(e)},ke.prototype.removeEntitiesByPath=function(t,e){throw new Error("Not Implemented")},ke.prototype.clearAllEntityChanges=function(){this.entityCollection.toArray().forEach(function(t){t.changes.splice(0,t.changes.length)})},ke.prototype.clearEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);e&&e.changes.splice(0,e.changes.length)},ke.prototype.clearEntityChangesByIds=function(t){var e=this;!t||t.length<0||t.forEach(function(t){e.clearEntityChangesById(t)})},ke.prototype.checkAllEntityChanges=function(){return this.entityCollection.toArray().some(function(t){return 0<t.changes.length})},ke.prototype.checkEntityChangesById=function(t){var e=this.entityCollection.getEntityById(t);return!!e&&0<e.changes.length},ke.prototype.clearEntityChangesByArray=function(t){this.clearEntityChangesByIds(t)},ke);function ke(t){this.entityCollection=t,this.entityType=t.entityType}var $e=(Ue.prototype.expandMainEntityConfig=function(){var t=this.entityType.typeName||this.entityType.name;if(this.paginationConfig.hasOwnProperty(t)){var e=this.paginationConfig[t];this.paginationConfig=Object.assign(this.paginationConfig,e)}else this.paginationConfig=Object.assign(this.paginationConfig,{pageSize:this.paginationConfig.pageSize||0})},Ue.prototype.removeLasts=function(){var n=this,r=this.entityType.typeName||this.entityType.name;Object.keys(this.paginationConfig).forEach(function(t){if(t!==r&&t.endsWith("s")){var e=t.substring(0,t.length-1);n.paginationConfig[e]=n.paginationConfig[t],delete n.paginationConfig[t]}})},Ue.prototype.deleteMainEntityConfig=function(){var t=this.entityType.typeName||this.entityType.name;delete this.paginationConfig[t]},Object.defineProperty(Ue.prototype,"pagination",{get:function(){return this.paginationConfig},enumerable:!0,configurable:!0}),Ue.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationConfig;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter(function(t){return!!t&&0<t.trim().length}),r=this.paginationConfig;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},Ue.prototype.setPaginationConfigByPath=function(r,t){return Array.isArray(r)||(r=r.toString().match(/[^/[\]]+/g)||[]),r.slice(0,-1).reduce(function(t,e,n){return Object(t[e])===t[e]?t[e]:t[e]=Math.abs(r[n+1])>>0==+r[n+1]?[]:{}},this.paginationConfig)[r[r.length-1]]=t,this.paginationConfig},Ue.prototype.getNgListProperties=function(o){void 0===o&&(o=0);var a=function(t){var r=K.getNgList(t),i={};return Object.keys(r).length<1||Object.keys(r).forEach(function(t){var e=r[t].dataField;e.endsWith("s")&&(e=e.substring(0,e.length-1)),i[e]={pageSize:o};var n=a(r[t].type);null!==n&&0<Object.keys(n).length&&(i=Object.assign({},i,n))}),i},t=a(this.entityType);return Object.assign({},{pageSize:o},t)},Ue.decorators=[{type:d.Injectable}],Ue.ctorParameters=function(){return[{type:undefined},{type:undefined}]},Ue);function Ue(t,e){this.entityType=t,this.paginationConfig=e,null!==this.paginationConfig&&this.paginationConfig!==undefined||(this.paginationConfig=this.getNgListProperties()),this.expandMainEntityConfig(),this.deleteMainEntityConfig(),this.removeLasts()}var He=(Ke.prototype.addChange=function(t){this["on"+x.DataChangeType[t.changeType]+"Data"](t)},Ke.prototype.addChanges=function(t){var e=this;t.forEach(function(t){return e.addChange(t)})},Ke.prototype.clear=function(){this.history.splice(0,this.history.length)},Ke.prototype.clearByIds=function(s){this.history=this.history.filter(function(t){var e,n;if(!t.fpath||"/"===t.fpath||!t.fpath.includes("/"))return!s.includes(t.dataId);try{for(var r=P(s),i=r.next();!i.done;i=r.next()){var o=i.value;return!t.fpath.split("/").includes(o)}}catch(a){e={error:a}}finally{try{i&&!i.done&&(n=r["return"])&&n.call(r)}finally{if(e)throw e.error}}})},Ke.prototype.isChanged=function(){return 0<this.history.length},Ke.prototype.onAddData=function(t){this.history.push(t)},Ke.prototype.onDeleteData=function(e){var t=this.history.findIndex(function(t){return t.dataId===e.dataId&&t.changeType===x.DataChangeType.Add});0<=t?this.history.splice(t,1):this.history.push(e)},Ke);function Ke(){this.history=[]}var Ge=(ze.prototype.getConditionsByBindingPath=function(t,n){var e=this.sorts.get(t)||[];return e.length<1||"function"==typeof n&&(e=e.map(function(t){var e=n(t.SortType);return{SortField:t.SortField,SortType:e}})),e},ze.prototype.addCondition=function(t,e,n){if(e&&n){var r=this.sorts.has(t),i={SortField:e,SortType:n};if(r){var o=this.sorts.get(t)||[],a=o.findIndex(function(t){return t.SortField===e});-1!==a?o[a]=i:o.push(i)}else this.sorts.set(t,[i])}else this.sorts["delete"](t)},ze.prototype.removeCondition=function(t,e){throw new Error("not implement!")},ze.prototype.setConditions=function(t,e,n){if(e&&n){var r=e.split(",").filter(function(t){return t}),i=n.split(",").filter(function(t){return t});if(r.length!==i.length)throw new Error("arguments error,fields and direction are not match.");var o=[];r.forEach(function(t,e){var n={SortField:t,SortType:i[e]};o.push(n)}),this.sorts.set(t,o)}else this.sorts["delete"](t)},ze.prototype.clear=function(){this.sorts.clear()},ze);function ze(){this.sorts=new Map}var qe=(Je.prototype.getFilters=function(t){return this.filters.get(t)||[]},Je.prototype.mergeCondition=function(t,e){var n=e(this.filters.get(t)||[]);this.filters.set(t,n)},Je.prototype.addCondition=function(t,e){var n=this.filters.get(t),r=this.findConditionIndex(t,e);-1!==r?n[r]=e:n.push(e)},Je.prototype.addConditions=function(e,t){var n=this;!t||!Array.isArray(t)||t.length<1||t.forEach(function(t){n.addCondition(e,t)})},Je.prototype.removeCondition=function(n,t){var r=this,i=this.filters.get(n);if(i&&!(i.length<1)){var e=i.filter(t);e&&e.forEach(function(t){var e=r.findConditionIndex(n,t);0<=e&&i.splice(e,1)})}},Je.prototype.clear=function(){this.filters.clear()},Je.prototype.setConditions=function(t,e){this.filters.set(t,e)},Je.prototype.findConditionIndex=function(t,c){if(!c||"object"!=typeof c||Object.keys(c).length<1)return-1;var e=this.filters.get(t);return!e||e.length<1?-1:e.findIndex(function(t,e){var n,r,i=!0,o=Object.keys(c);try{for(var a=P(o),s=a.next();!s.done;s=a.next()){var p=s.value;if(!t||!t.hasOwnProperty(p)||t[p]!==c[p]){i=!1;break}}}catch(u){n={error:u}}finally{try{s&&!s.done&&(r=a["return"])&&r.call(a)}finally{if(n)throw n.error}}return i})},Je);function Je(){this.filters=new Map}var We=(Ye.create=function(t){var e=Date.now().valueOf();return(Ye.previous=Ye.previous<e?e:Ye.previous+100).toString(t)},Ye.previous=0,Ye);function Ye(){}var Ze=(Object.defineProperty(Xe.prototype,"primaryKey",{get:function(){return this.entityCollection.primaryKey},enumerable:!0,configurable:!0}),Object.defineProperty(Xe.prototype,"changes",{get:function(){return this.entityCollection.changes},enumerable:!0,configurable:!0}),Object.defineProperty(Xe.prototype,"entityCollectionChange",{get:function(){return this.entityCollection.collectionChanged},enumerable:!0,configurable:!0}),Object.defineProperty(Xe.prototype,"name",{get:function(){if(!this.innerName){var t=We.create();this.innerName="Repository_"+t}return this.innerName},set:function(t){this.innerName=t},enumerable:!0,configurable:!0}),Xe.prototype.dispose=function(t){this.paginationManager=null,this.destroy$&&(this.destroy$.next(),this.destroy$.complete(),this.destroy$=null),this.entityCollection&&this.entityCollection.reset(!1)},Xe.prototype.ngOnDestroy=function(){this.dispose()},Xe.prototype.updateEntityType=function(t){this.entityType=t,this.entityTypeInfo=new be(this.entityType),this.entityCollection=new Be(this.entityType)},Xe.prototype.readMetadata=function(){var t=S.getClassMetadataByName(this.constructor,"NgRepository");t&&(this.apiUri=t.apiUrl,this.entityType=t.entityType)},Xe.prototype.setPaginationConfig=function(t){this.paginationManager=new $e(this.entityType,t);var e=(this.paginationManager.getPaginationConfigByPath("/")||{}).pageSize,n=void 0===e?0:e;this.entityCollection.paginationInfo=Object.assign({pageSize:n},this.paginationManager.pagination,this.entityCollection.paginationInfo)},Xe.prototype.reset=function(){this.entityCollection.reset()},Xe.prototype.buildEntity=function(t){return Q(this.entityType,t)},Xe.prototype.buildEntities=function(t){return tt(this.entityType,t)},Xe.decorators=[{type:d.Injectable}],Xe.ctorParameters=function(){return[]},Xe);function Xe(){this.paginationInfo=null,this.readMetadata(),this.entityType&&(this.entityTypeInfo=new be(this.entityType),this.entityCollection=new Be(this.entityType)),this.dataChangeHistory=new He,this.sortConditionManager=new Ge,this.filterConditionManager=new qe,this.destroy$=new h.Subject}var Qe,tn=(c(en,Qe=Ze),en.prototype.getEntities=function(t,e,n,r){throw new Error("Not Implemented")},en.prototype.filter=function(t,e,n,r){throw new Error("Not Implemented")},en.prototype.getList=function(){throw new Error("Not Implemented")},en.prototype.getById=function(t){throw new Error("Not Implemented")},en.prototype.getEntityById=function(t){throw new Error("Not Implemented")},en.prototype.queryChild=function(t,e,n,r,i){throw new Error("Not Implemented")},en.prototype.updateById=function(t){throw new Error("Not Implemented")},en.prototype.updateEntityById=function(t){throw new Error("Not Implemented")},en.prototype.create=function(){throw new Error("Not Implemented")},en.prototype.append=function(){throw new Error("Not Implemented")},en.prototype.appendByPath=function(t){throw new Error("Not Implemented")},en.prototype.insert=function(t,e){throw new Error("Not Implemented")},en.prototype.insertByPath=function(t,e){throw new Error("Not Implemented")},en.prototype.removeById=function(t,e){throw new Error("Not Implemented")},en.prototype.batchRemove=function(t,e){throw new Error("Not Implemented")},en.prototype.removeByIds=function(t,e){throw new Error("Not Implemented")},en.prototype.removeByPath=function(t,e){throw new Error("Not Implemented")},en.prototype.updateChangesById=function(t){throw new Error("Not Implemented")},en.prototype.updateChangesByPath=function(t,e){throw new Error("Not Implemented")},en.prototype.updateAllChanges=function(){throw new Error("Not Implemented")},en.prototype.applyChanges=function(){throw new Error("Not Implemented")},en.prototype.applyChangesById=function(t){throw new Error("Not Implemented")},en.prototype.cancelChanges=function(t){throw new Error("Not Implemented")},en.prototype.batchRemoveByPath=function(t,e){throw new Error("Not Implemented")},en.prototype.batchAppendByPath=function(t,e){throw new Error("Not Implemented")},en.prototype.batchAppend=function(t){throw new Error("Not Implemented")},en.decorators=[{type:d.Injectable}],en.ctorParameters=function(){return[{type:d.Injector}]},en);function en(t){var e=Qe.call(this)||this;return e.injector=t,e.entityManager=new Le(e.entityCollection),e}var nn=(rn.prototype.resolve=function(t){var e=fn.getGroupFunctionDependency(t,this.repository.entityTypeInfo),n=this.getEntityDependency(t);e&&0<e.length&&n&&0<n.length&&e.forEach(function(e){var t=n.findIndex(function(t){return e.startsWith(t)});-1!==t&&n.splice(t,1)});var r=b(e,n);return b(new Set(r))},rn.prototype.getValidEntityPropertyExpression=function(t){var e=t.split("."),n=null;try{n=this.entityTypeInfo.getPropInfoByPath(e)}catch(r){}return n?t.split("."):1<e.length?(e.pop(),this.getValidEntityPropertyExpression(e.join("."))):null},rn.prototype.getEntityDependency=function(t){var n=this,r=[];if(this.entityTypeInfo){var e=new RegExp("[\\'\\\"]?\\s*("+this.entityTypeInfo.entityInfo.nodeCode+"|"+this.entityTypeInfo.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g"),i=t.match(e);Array.isArray(i)&&0<i.length&&i.forEach(function(t){if(-1!==t.indexOf(".")){t=t.trim().replace(/\"/g,""),t=(t=fn.convertToNodeCode(t,n.repository.entityTypeInfo).join(".")).substr(t.indexOf(".")+1);var e=n.getValidEntityPropertyExpression(t);e&&Array.isArray(e)&&0<e.length&&(e.splice(0,0,Ne),r.push(e.join("/")))}})}return r},rn.decorators=[{type:d.Injectable}],rn.ctorParameters=function(){return[{type:Ze}]},rn);function rn(t){this.repository=t,this.entityTypeInfo=this.repository&&this.repository.entityTypeInfo||null}var on=["GetContextParameter","GetSessionValue"],an=(sn.prototype.resolve=function(t){var i=[],e=new RegExp("DefaultFunction\\.("+on.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),n=t.match(e);if(n&&0<n.length){var o=/\(([^\r\n\)]*)\)/;n.forEach(function(t){var e=t.match(o);if(2===e.length){var n=e[1].trim().replace(/\"/g,""),r=["STATE~"];r.push(n),i.push(r.join("/"))}})}return i},sn);function sn(){}var pn=(un.prototype.resolve=function(t){var e=[];if(!t||t.length<1)return e;var n=t.match(/\/\*\*\s*__define__\((.*)\)\s*\*\//);if(n&&2===n.length){var r=n[1].trim(),i=null;try{i=JSON.parse(r)}catch(o){console.warn("自定义依赖解析失败："+r)}i&&i.hasOwnProperty("deps")&&Array.isArray(i.deps)&&e.push.apply(e,b(i.deps))}return e},un.decorators=[{type:d.Injectable}],un);function un(){}var cn=(ln.prototype.resolve=function(n){var r=[];if(this.resolverRegistry&&this.resolverRegistry.resolvers&&!(this.resolverRegistry.resolvers.length<1)){var t=this.resolverRegistry.resolvers.find(function(t){return t instanceof pn});if(t){var e=t.resolve(n);e&&Array.isArray(e)&&0<e.length&&r.push.apply(r,b(e))}return r&&0<r.length?r:(this.resolverRegistry.resolvers.forEach(function(t){if(!(t instanceof pn)){var e=t.resolve(n);e&&0<e.length&&r.push.apply(r,b(e))}}),b(new Set(r)))}},ln.decorators=[{type:d.Injectable}],ln.ctorParameters=function(){return[{type:d.Injector},{type:Fe}]},ln);function ln(t,e){this.injector=t,this.resolverRegistry=e}var fn=(hn.getGroupFunctionDependency=function(t,u){var c=this,l=[],e=new RegExp("DefaultFunction\\.("+Ve.join("|")+")\\s*\\([^\\r\\n\\)]*\\)","g"),n=t.match(e);if(n&&0<n.length){var f=/\(([^\r\n\)]*)\)/,h=/DefaultFunction\.(\S*)\(/;n.forEach(function(t){var e=t.match(f),n=t.match(h),r=null;if(n&&2==n.length&&(r=n[1]),2===e.length){var i=e[1],o=i.split(",").map(function(t){return t.replace(/\"/g,"")});if(o&&2===o.length){var a=o.join("."),s=(a=(a=c.convertToNodeCode(a,u).join(".")).substr(a.indexOf(".")+1)).split(".");s.splice(0,0,Ne),l.push(s.join("/"))}else{if(!o||3!==o.length||"MultiplyChildNumber"!==r)throw new Error("无法解析参数： "+JSON.stringify(i));var p=o[0];[p+"."+o[1],p+"."+o[2]].forEach(function(t){var e=(t=(t=c.convertToNodeCode(t,u).join(".")).substr(t.indexOf(".")+1)).split(".");e.splice(0,0,Ne),l.push(e.join("/"))})}}})}return l},hn.convertToNodeCode=function(t,e){var n=[];if(e&&t.includes("."))for(var r=t.split(".")||[],i=e,o=0;o<r.length;o++){var a=r[o];if(i&&i.entityInfo&&i.entityInfo.nodeCode===a||i.entityInfo.originalCode===a){0===o?n.push(i.entityInfo.originalCode):n.push(i.entityInfo.nodeCode);var s=r[o+1];if(!s)break;var p=i.getPropInfoByName(s);if(!p)break;p.typeInfo&&(i=p.typeInfo)}else{if(!i||!i.getPropInfoByName(a))break;var u=i.getPropInfoByName(a);n.push(u.name)}}return n},hn.getChildrenEntityPaths=function(t,n,r){var i=this;void 0===r&&(r=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){0===r.length&&n.push([t.name]);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?(r.push(t.name),e.forEach(function(t){i.getChildrenEntityPaths(t.typeInfo,n,r)})):(0!==r.length&&(r.push(t.name),n.push(b(r))),r.length=0)}):(0<r.length&&(r.push(t.entityInfo.nodeCode),n.push(b(r))),r.length=0)},hn.getCurrentRowByPaths=function(t,e){var n=null,r=e.getValue(t);if(r&&0<r.length){var i=r.currentItem.primaryKeyValue||null;if(i){var o=r.findById(i);o&&(n=o.toJSON())}}return n},hn.getAvailableChildrenPathsFromEntityPaths=function(t,e){var n=[];for(t=b(t);0<t.length;){var r=e.getPropInfoByPath(t);if(r&&"List"===r.group){n=t;break}t.pop()}return n},hn.getBindingPath=function(t,e){return t=this.getEntityPath(t),this.getAvailableChildrenPathsFromEntityPaths(t,e)},hn.getEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},hn);function hn(){}var yn=(dn.getChildrenNodeCodes=function(t,n){var r=this;void 0===n&&(n=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length&&e.forEach(function(t){n.push(t.name);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length&&e.forEach(function(t){n.push(t.name),r.getChildrenNodeCodes(t.typeInfo,n)})})},dn);function dn(){}var gn,mn=(c(vn,gn=a.FormGroup),Object.defineProperty(vn.prototype,"formGroupName",{get:function(){return this.ngValidateForm?this.ngValidateForm.formGroupName:""},enumerable:!0,configurable:!0}),Object.defineProperty(vn.prototype,"enableValidate",{get:function(){return!!this.ngValidateForm&&this.ngValidateForm.enableValidate},enumerable:!0,configurable:!0}),Object.defineProperty(vn.prototype,"translateService",{get:function(){return this.translate},enumerable:!0,configurable:!0}),vn.prototype.ngOnDestroy=function(){this.dispose()},vn.prototype.dispose=function(t){this.destroy$&&(this.destroy$.next(),this.destroy$.complete(),this.destroy$=null),vn.insMap[this.constructor.name]=null,this.frameContext=null,this.bindingData=null,this.ngChildForms=null,this.metaDatas=null,this.ngFormControls={},this.controls={},this.disposeValidation()},vn.updateErrors=function(n,r,i,o,a){Object.keys(vn.insMap).forEach(function(t){var e=vn.insMap[t];e&&(i&&e.setControlValue(n,o),e.enableValidate&&e.isFormValid(n,r,i,a))})},vn.prototype.setIsShowmap=function(t){this.isShowPropMap[t]=!0},vn.prototype.setShowValidationMsg=function(t){this.raisedByValidateEffector=!1,this.isShowValidationMsg=t},vn.prototype.setControlValue=function(t,e){var n=this.bindingData&&this.bindingData.getObject()||null;n&&n.controlMap&&(n.controlMap[t]=this.getGridItemControl(t,e))},vn.prototype.getCardControlErrors=function(t){return this.setIsShowmap(t),this.cardControls[t]&&this.cardControls[t].errors},vn.prototype.getFormControlErrors=function(t){return this.cardControls[t]&&this.cardControls[t].errors},vn.prototype.getGridControlErrors=function(t,e){return this.setIsShowmap(t),this.controlIdMap[e]&&this.controlIdMap[e][t]&&this.controlIdMap[e][t].errors},vn.prototype.isFormValid=function(t,s,e,n){var p=this,r="";if(!this.raisedByValidateEffector){var i=this.frameContext.frameComponent.isGridComponent;i!==undefined&&(n=i);var o=this.bindingPath.split("/").filter(function(t){return t});0<o.length&&(r=o.join(".").concat("."));var a=this.getDomPropertyNameByEntityProp(t,r);if(t&&!a)return!0;if(a&&!this.isShowPropMap[a])return!0;var u=!0,c=this.bindingData.getObject(),l=c.primaryKeyValue,f="/"!==this.bindingPath,h=this.bindingData.getList();if(f&&0===h.innerList.size)return!0;if(!l)return!0;if(e&&a&&(this.controlIdMap[e]=this.controlIdMap[e]||{},this.controlIdMap[e][a]={errors:s}),!e||e===l)return t||e||(c.controlMap={},this.controlIdMap={},this.cardControls={}),Object.keys(this.controls).forEach(function(t){!0===p.isShowPropMap[t]&&(t===a&&(s&&0<Object.keys(s).length?n||(Object.keys(s).map(function(t){var e=s[t]&&s[t].error||null;if(e){var n=e.rule,r=p.getngFormControlByBinding(n.field);if(r){n.property=r.name||r.defaultI18nValue,n.targetId=r.id,n.targetName=p.formGroupName;var i="require"===t?"required":t,o=rt.getMessage(i);if(o){var a=at.replaceMessageSpecialTokens(o,n,r.name);s[t].name=a}}}}),p.cardControls[t]={errors:s}):p.cardControls[t]={}),p.controls[t]&&p.controls[t].errors&&0<Object.keys(p.controls[t].errors).length&&(p.cardControls[t]={errors:E({},p.cardControls[t]&&p.cardControls[t].errors,p.controls[t].errors)},u=!1))}),this.cardControls&&Object.keys(this.cardControls).forEach(function(o){p.cardControls[o]&&p.cardControls[o].errors&&Object.keys(p.cardControls[o].errors).forEach(function(e){if("object"!=typeof p.cardControls[o].errors[e]){var t=p.ngFormControls[o].validRules||[],n=[].concat(t).find(function(t){return t.type===e});if(n){n.targetName=p.formGroupName;var r=rt.getMessage(e),i=at.replaceMessageSpecialTokens(r,n,"");p.cardControls[o].errors[o]={value:p.controls[o]&&p.controls[o].value||"",name:i}}}})}),Object.keys(this.cardControls).forEach(function(t){p.cardControls[t]&&p.cardControls[t].errors&&0<Object.keys(p.cardControls[t].errors).length&&(u=!1)}),u}},vn.prototype.updateFormErrors=function(e,t,n){var r=this;void 0===t&&(t=!1),void 0===n&&(n=""),n&&"backend"===n&&this.clearBackendError(),!0!==this.isShowValidationMsg&&!0!==t||(this.isShowValidationMsg=!0,Object.keys(e).forEach(function(t){e[t].errors&&0<Object.keys(e[t].errors).length?r.cardControls[t]={errors:E({},r.cardControls[t]&&r.cardControls[t].errors,e[t].errors)}:(r.cardControls[t]={errors:{}},r.controls[t].setErrors(null),r.controls[t].markAsTouched())}))},vn.prototype.clearBackendError=function(){var n=this;Object.keys(this.cardControls).forEach(function(t){var e=n.cardControls[t]&&n.cardControls[t].errors||null;e?(Object.keys(e).forEach(function(t){t&&t.startsWith("backend-message-")&&delete e[t]}),e&&0===Object.keys(e).length&&delete n.cardControls[t].errors):n.cardControls[t]={}})},vn.prototype.getngFormControlByBinding=function(e){return Object.values(this.ngFormControls).find(function(t){return t.binding&&t.binding===e})},vn.prototype.disposeValidation=function(){var n=this,t=this.constructor[C];t&&0<Object.keys(t).length&&Object.keys(t).forEach(function(t){var e=n.constructor[C][t];e&&0<e.length&&e.forEach(function(t){t.validRules&&Array.isArray(t.validRules)&&0<t.validRules.length&&(t.validRules=t.validRules.filter(function(t){return!(t.eval&&"function"==typeof t.eval)}))})})},vn.prototype.getErrorMessage=function(t,e){var n=this.ngFormControls[t];if(n){var r=n.validRules,i=[];Array.isArray(r)?i.push.apply(i,b(r)):i.push(r);var o=i.find(function(t){return t.type===e});if(o){var a=n.name,s=rt.getMessage(e);return at.replaceMessageSpecialTokens(s,o,a)}return null}return null},vn.prototype.init=function(t,e,n){var r=this;this.frameContext=n,this.bindingData=t,this.bindingPath=e,this.frameContext&&this.frameContext.viewModel&&this.frameContext.viewModel.verifycationChanged&&this.frameContext.viewModel.verifycationChanged.subscribe(function(t){(!t||t.length<1)&&r.resetCardValidMsg()}),this.buildForm(),vn.insMap[this.constructor.name]=this},vn.prototype.buildForm=function(){this.collectMetadatas(),this.createChildForms(),this.createControls()},vn.prototype.resetCardValidMsg=function(){var e=this;this.cardControls={},Object.keys(this.controlIdMap).forEach(function(t){e.bindingData.getList().innerList.map(function(t){return t.id}).includes(t)||delete e.controlIdMap[t]}),this.resetFormControls(),this.setShowValidationMsg(!1)},vn.prototype.updateFieldValidateRule=function(n,t){var r=this;if(n){var e=this.controls[n];e&&(e.clearValidators(),e.markAsUntouched(),e.markAsPristine(),e.setErrors([]));var i=this.ngFormControls[n],o=i&&i.validRules||[];Array.isArray(o)||(o=[o]);var a=o.findIndex(function(t){return t.type===rt.REQUIRED});if(t){if(-1==a){var s={type:rt.REQUIRED,constraints:[!0]},p=i&&(i.name||i.defaultI18nValue)||"";s.targetId=i&&i.id||null,s.targetName=this.formGroupName,s.property=p,s.field=i&&i.binding,o.push(s)}}else-1!==a&&o.splice(a,1);var u=[];Array.prototype.forEach.call(o,function(t){var e=r.getValidatorByRuleObj(t,r.ngFormControls[n]);e&&u.push(e)}),this.ngFormControls[n].validRules=o,this.controls[n].setValidators(u)}},vn.prototype.addFieldValidateRule=function(t,e,n,r){var i=this.controls[t];i&&i.setErrors(null);var o=this.ngFormControls[t],a=this.ngFormControls[t].validRules;a=a||[],Array.isArray(a)||(a=[a]);var s=a.findIndex(function(t){return t&&t.expressionId===n});-1!==s&&a.splice(s,1);var p=this.frameContext.viewModel.bindingPath.split("/").filter(function(t){return t});0!==p.length&&(p.join("/"),(o.binding||"").split(".").join("/"));var u=this.frameContext,c={type:r,message:e,expressionId:n,constraints:[],bindingPath:p.join("/"),eval:function(t){return u.viewModel.expression.validate(n,t)}};a.push(c),this.ngFormControls[t].validRules=a},vn.prototype.getValidatorByRuleObj=function(l,f){var h=this,t=l.type,e=l.constraints,a=void 0===e?[]:e,n=l.message,o=void 0===n?null:n;return f.name||f.defaultI18nValue,{required:function(t){var e=t.value,n=""!==e&&null!==e&&e!==undefined&&"0001-01-01"!==e&&"0001-01-01 00:00:00"!==e&&"0001-01-01T00:00:00"!==e,r=h.bindingPath.split("/").filter(function(t){return t}),i=f.binding.split("."),o=r.concat(i),a=h.getPropInfoByPath(o);if(a&&a.metadataInfo.enableMultiLangInput){var s=ft.getCurrentLanguage(),p=e&&e[s];n=""!==p&&null!==p&&p!==undefined&&"0001-01-01"!==p&&"0001-01-01 00:00:00"!==p&&"0001-01-01T00:00:00"!==p}var u=rt.getMessage(rt.REQUIRED),c=at.replaceMessageSpecialTokens(u,l,t.value);return n&&t.errors&&t.errors.required&&(delete t.errors.required,h.isFormValid(o.join("."))),n?null:{required:{value:t.value,name:c}}},maxLength:function(t){var e=t.value&&t.value.toString().length>a[0],n=rt.getMessage(rt.MAX_LENGTH),r=at.replaceMessageSpecialTokens(n,l,t.value);return e?{maxLength:{value:t.value,name:r}}:null},minLength:function(t){var e=t.value&&t.value.toString().length<a[0],n=rt.getMessage(rt.MAX_LENGTH),r=at.replaceMessageSpecialTokens(n,l,t.value);return e?{minLength:{value:t.value,name:r}}:null},minValue:function(t){var e=!1,n="";if(null===t.value||t.value===undefined)return null;if("number"==typeof t.value&&"number"==typeof a[0]){e=t.value<a[0];var r=rt.getMessage(rt.MINVALUE);n=at.replaceMessageSpecialTokens(r,l,t.value)}else if(f&&!0===f.bigNumber){var i=new y.BigNumber(a[0]),o=new y.BigNumber(t.value);e=i.isGreaterThan(o),r=rt.getMessage(rt.MINVALUE),n=at.replaceMessageSpecialTokens(r,l,t.value)}else{if(r=rt.getMessage(rt.MIN_DATE),!a||a.length<1||!a[0])return null;e=t.value instanceof Date?t.value<s.parseISO(a[0]):s.parseISO(t.value)<s.parseISO(a[0]),n=at.replaceMessageSpecialTokens(r,l,t.value)}return e?{minValue:{value:t.value,name:n}}:null},maxValue:function(t){var e=!1,n="";if(null===t.value||t.value===undefined)return null;if("number"==typeof t.value&&"number"==typeof a[0]){e=t.value>a[0];var r=rt.getMessage(rt.MAXVALUE);n=at.replaceMessageSpecialTokens(r,l,t.value)}else if(f&&!0===f.bigNumber){var i=new y.BigNumber(a[0]),o=new y.BigNumber(t.value);e=i.isLessThan(o),r=rt.getMessage(rt.MAXVALUE),n=at.replaceMessageSpecialTokens(r,l,t.value)}else r=rt.getMessage(rt.MAX_DATE),e=t.value instanceof Date?t.value>new Date(a[0]):new Date(t.value)>new Date(a[0]),n=at.replaceMessageSpecialTokens(r,l,t.value);return e?{maxValue:{value:t.value,name:n}}:null},exclude:function(t){var e="string"==typeof t.value&&!h.validatorJs.contains(t.value,a[0]),n=rt.getMessage(rt.EXCLUDE),r=at.replaceMessageSpecialTokens(n,l,t.value);return e?null:{exclude:{value:t.value,name:r}}},matches:function(t){var e=null===t.value||t.value===undefined?"":t.value.toString(),n=""===e||h.validatorJs.matches(e,a[0]),r=o;if(!r){var i=rt.getMessage(rt.MATCHES);r=at.replaceMessageSpecialTokens(i,l,t.value)}return n?null:{matches:{value:t.value,name:r}}}}[t]},vn.prototype.collectMetadatas=function(){this.ngValidateForm=this.frameContext.metadata.form?S.translateMetadataByName(this.frameContext.metadata.form,this.translateService,["formGroupName"]):S.getClassMetadataByNameWithTranslate(this.constructor,Jt,this.translateService,["formGroupName"]),this.ngFormControls=this.collectionFormControlMetadats(this.frameContext.metadata.formControls),this.ngChildForms=this.frameContext.metadata.subForms||S.getPropsMetadatasByName(this.constructor,Wt)},vn.prototype.collectionFormControlMetadats=function(t){var i=this;void 0===t&&(t=null);var o=t?S.translateMetadatasByName(t,this.translateService,["name"]):S.getPropsMetadatasByNameWithTranslate(this.constructor,Qt,this.translateService,["name"]);return o&&Object.keys(o).forEach(function(t){var e=o[t],n=e.name||e.defaultI18nValue||"",r=e.id;Array.isArray(e.validRules)&&e.validRules.forEach(function(t){t.targetId=r,t.targetName=i.formGroupName,t.property=n,t.field=e.binding})}),o},vn.prototype.getGridItemControl=function(t,e){var n,r,i=this;return n=t,r=[],i.ngFormControls[n]&&Array.isArray(i.ngFormControls[n].validRules)&&Array.prototype.forEach.call(i.ngFormControls[n].validRules,function(t){var e=i.getValidatorByRuleObj(t,i.ngFormControls[n]);e&&r.push(e)}),new a.FormControl(e,{validators:r,updateOn:"blur"})},vn.prototype.getDomPropertyNameByEntityProp=function(e,n){var r=this;void 0===n&&(n="");var i="";return Object.keys(this.ngFormControls).forEach(function(t){""+n+r.ngFormControls[t].binding===e&&(i=t)}),i},vn.prototype.createControls=function(){var o=this;Object.keys(this.ngFormControls).forEach(function(n){var t=o.ngFormControls[n],r=[];Array.isArray(o.ngFormControls[n].validRules)&&Array.prototype.forEach.call(o.ngFormControls[n].validRules,function(t){var e=o.getValidatorByRuleObj(t,o.ngFormControls[n]);e&&r.push(e)});var e=t.updateOn?t.updateOn:"blur",i=new a.FormControl(null,{validators:r,updateOn:e});t.binding&&o.setUpBindingDataPipeline(i,t.binding,t.valueConverter),o.controls[n]=i,o[n]=i})},vn.prototype.createChildForms=function(){var n=this;Object.keys(this.ngChildForms).forEach(function(t){var e=new n.ngChildForms[t].formType;e.init(n.bindingData,n.bindingPath,n.frameContext),n.controls[t]=e,n[t]=e})},vn.prototype.addControls=function(t,e){var n=t&&t.editor&&t.editor.updateOn?t.editor.updateOn:"blur",r=new a.FormControl("",{updateOn:n}),i=t.dataField;t.editor&&t.editor.binding&&(this.setUpBindingDataPipeline(r,i,e),this.controls[t.editor.binding.path]=r,this[t.editor.binding.path]=r)},vn.prototype.setUpBindingDataPipeline=function(a,i,s){var p=this;if(!this.bindingData)throw Error("当前组件上下文中找不到BindingData，请检查！");1<this.bindingPath.length&&(i=this.bindingPath.substr(1).replace(/\//g,".")+"."+i);var u=i.split("."),c=u[u.length-1],t=this.getValueFromBindingData(u,s);a.setValue(t),this.bindingData.changes.pipe(l.takeUntil(this.destroy$)).pipe(l.filter(function(t){var e=p.bindingData.getObject(),n=t.path.join(".");if(t.isUdt)return n===i;if(t.type===x.ChangeType.ValueChanged)return n===i;if(t.type!==x.ChangeType.Load&&t.type!==x.ChangeType.SelectionChanged&&t.type!==x.ChangeType.Remove&&t.type!==x.ChangeType.Update)return t.type===x.ChangeType.UpdateErrors&&(n===i?(p.cardControls[c]=p.cardControls[c]||{},i&&p.controls[c]&&e.primaryKeyValue===t.id&&(p.cardControls[c].errors=t.errors),t.path&&i&&t.errors||(p.cardControls[c].errors=null,p.isFormValid(i)),!1):void 0);var r=""===n?n:n+".";return t&&t.type===x.ChangeType.Load&&p.resetCardValidMsg(),0===i.indexOf(r)})).subscribe(function(t){var e=c,n="";t.isUdt&&(t.isGrid&&t.path.shift(),t.path.length&&(n=t.path.join(".")),e=n);var r=p.bindingData.getValue(u,!1),i=s?s.convertFrom(r):r,o=p.getDomPropertyNameByEntityProp(e);p.cardControls[o]=p.cardControls[o]||{},t.errors&&(p.cardControls[o].errors=t.errors),t.id&&(p.controlIdMap[t.id]&&0===Object.keys(p.controlIdMap[t.id]).length&&(p.controlIdMap[t.id]={}),p.controlIdMap[t.id]=p.controlIdMap[t.id]||{},t.errors&&(p.controlIdMap[t.id][o]={errors:t.errors})),JSON.stringify(a.value)!==JSON.stringify(i)&&a.setValue(i)}),a.valueChanges.pipe(l.takeUntil(this.destroy$)).subscribe(function(t){var e=p.bindingData.getValue(u);if(t&&t.constructor&&"Date"===t.constructor.name){if(isNaN(t))return;if(e&&s){var n=s.convertFrom(e);if(!0===p.compareDate(t,n))return}}if(!0!==p.isDate(s)||!0!==ct.isEqual(t,e)){var r=s?s.convertTo(t):t;if(JSON.stringify(e)!==JSON.stringify(r)){p.clearBackEndMessages(c);var i=p.frameContext.appContext.runMode===x.RunMode.highSpeed;p.bindingData.setValue(u,r,i,!0,null,{frameContext:p.frameContext})}}})},vn.prototype.isDate=function(t){var e=!1;return t&&!0===t.hasOwnProperty("format")&&(e=!0),e},vn.prototype.compareDate=function(t,e){return t&&e?t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()&&t.getHours()===e.getHours()&&t.getMinutes()===e.getMinutes()&&t.getSeconds()===e.getSeconds():t===e},vn.prototype.getPropInfoByPath=function(t){var e=this.frameContext&&this.frameContext.repository.entityType||null;return e?new be(e).getPropInfoByPath(t):null},vn.prototype.getValueFromBindingData=function(t,e){var n=this.bindingData.getValue(t);return e?e.convertFrom(n):n},vn.prototype.getEntityValueChangingListeners=function(){var n=this,r={};return Object.keys(this.ngFormControls).forEach(function(t){var e=n.ngFormControls[t];e.valueChanging&&(r[e.binding]=e.valueChanging)}),r},vn.prototype.getEntityValueChangedListeners=function(){var n=this,r={};return Object.keys(this.ngFormControls).forEach(function(t){var e=n.ngFormControls[t];e.valueChanged&&(r[e.binding]=e.valueChanged)}),r},vn.prototype.getValidationRules=function(){var a=this,s=new Map,p=this.bindingPath;return p.length&&"/"===p&&(p=""),Object.keys(this.ngFormControls).forEach(function(t){if(!0===a.isShowPropMap[t]||0===Object.keys(a.isShowPropMap).length){var e=a.ngFormControls[t],n=e.name||e.defaultI18nValue||"",r=e.binding?e.binding.split("."):[t],i=b([p],r).join("/");if(Array.isArray(e.validRules)&&0<e.validRules.length){var o=b(e.validRules);o.forEach(function(t){t.targetId=e.id,t.targetName=a.formGroupName,t.property=n,t.field=e.binding,t.fullPath=i,a.frameContext&&(t.frameContext=a.frameContext)}),s.set(i,o)}else s.set(i,[{type:"setDisplayInfo",targetId:e.id,targetName:a.formGroupName,property:n,fullPath:i,frameContext:a.frameContext}])}}),s},vn.prototype.setTranslateService=function(t){t&&(this.translate=t,rt.setCurrentLanguage(t.getCurrentLanguage()))},vn.prototype.resetFormControls=function(){var n=this;0<Object.keys(this.controls).length&&Object.keys(this.controls).forEach(function(t){var e=n.controls[t];e.markAsUntouched(),e.markAsPristine()})},vn.prototype.clearBackEndMessages=function(t){var r=this;if(t){if(this.cardControls[t]&&this.cardControls[t].errors&&Object.keys(this.cardControls[t].errors).find(function(t){return t.startsWith("message-")})){var e=Object.keys(this.cardControls[t].errors).filter(function(t){return t.startsWith("message-")}),n=E({},this.cardControls[t].errors);e.forEach(function(t){return delete n[t]}),this.cardControls[t]={errors:n}}}else Object.keys(this.cardControls).forEach(function(t){if(r.cardControls[t]&&r.cardControls[t].errors&&Object.keys(r.cardControls[t].errors).find(function(t){return t.startsWith("message-")})){var e=Object.keys(r.cardControls[t].errors).filter(function(t){return t.startsWith("message-")}),n=E({},r.cardControls[t].errors);e.forEach(function(t){return delete n[t]}),r.cardControls[t]={errors:n}}})},vn.insMap={},vn.decorators=[{type:d.Injectable}],vn.ctorParameters=function(){return[]},vn);function vn(){var t=gn.call(this,{},null,null)||this;return t.raisedByValidateEffector=!1,t.isShowValidationMsg=!1,t.validatorJs=n,t.controlIdMap={},t.cardControls={},t.isShowPropMap={},t.destroy$=new h.Subject,t}var En=(bn.loadEntity=function(i,o){var a=this;o.properties.forEach(function(t){var e=t.name;if(t.type===x.BindingPropertyType.List)a.loadEntityList(i[e]||i[W],o[e]);else if(t.type===x.BindingPropertyType.Object)i&&i[e]&&a.isEffectiveField(i,e)&&a.loadEntity(i[e],o[e]);else if(t.type===x.BindingPropertyType.Dynamic){if(i&&i[e]){var n=zt.createDynamicBindingObject(i[e].data);zt.attachDynamicObjectProperty(o,e,n),a.loadEntity(i[e],o[e])}}else if(a.isEffectiveField(i,e)){var r=i[e];o.setValue(e,r,!1,!1)}}),this.setUpEntityPipeline(i,o)},bn.setUpEntityPipeline=function(h,a){h&&a&&(h.onValueChanged.pipe(l.takeUntil(h.unsubscribe)).subscribe(function(t){if(t.type===x.ModifyType.ValueChange&&0!==t.path.length){var e=t.path[t.path.length-1],n=t.path[t.path.length-2];if(a.primaryKey&&"id"===a.primaryKey){var r=a.primaryKey;if(n!==r+":"+a.getValue(r))return}if(t.dynamic){if(a.__original__)return;var i=t.value,o=a[e];if(!o)return;Object.keys(i).forEach(function(t){o.getValue(t)!==i[t]&&o.setValue(t,i[t],!0,!1)})}else{if(a.getValue(e)===t.value)return;a.setValue(e,t.value,!0,!1,t.errors)}}}),a.viewChanges.pipe(l.takeUntil(a.unsubscribe)).subscribe(function(s){var e,n,p=s.value,u=s.path[0],t="",c=h.getPaths(),r=c.path,l=a.id;a.__original__=!0,e="",(n=function(t){t&&t&&t.id?e=t.id:t.parent&&n(t.parent)})(a),l=e,r.length&&(t=r.join(".")+".");var f=t+u,i=function(a){Object.values(mn.insMap).find(function(t){return t&&t.enableValidate})?h.validateFromUtilSync(u,p,function(t){var e,n={};t.errors&&0<t.errors.length&&t.errors.forEach(function(e){e.constraints&&Object.keys(e.constraints).forEach(function(t){n[t]={value:p,name:e.constraints[t],error:e}})}),mn.updateErrors(f,n,l,p,c.isGrid);var r=s.errors||{},i=Object.assign({},r,n),o=null;0<Object.keys(i).length&&((e={})[u]=i,o=e),"function"==typeof a&&a(o)},s.context):"function"==typeof a&&a(null)};if(a.primaryKey){var o=a.primaryKey;if(u!==o){if(!h[o]||h[o]!==a[o])return void i()}else if(h[u]!==p)return h[u]=p,void i()}h[u]!==p?i(function(t){h.errors=t,h[u]=p}):i()}))},bn.loadEntityList=function(t,e){this.loadEntities(t.items,e),this.setUpEntityListPipeline(t,e)},bn.setUpEntityListPipeline=function(m,v){var E=this;m.onListChanged.subscribe(function(t){var e=t.target;if(!e||e===m)switch(t.type){case x.ModifyType.Add:case x.ModifyType.Clone:if(0===t.value.length)return;var n=t.path,r=n[n.length-2],i=v.parent.primaryKeyValue;if(-1===r.indexOf(i))return;E.appendEntities(t.value,v,t.type===x.ModifyType.Clone);break;case x.ModifyType.Insert:var o=t.path,a=o[o.length-2],s=v.parent.primaryKeyValue,p=t.position;if(-1===a.indexOf(s))return;E.insertEntity(t.value[0],v,p);break;case x.ModifyType.Remove:var u=t.path,c=u[u.length-2],l=v.parent.primaryKeyValue;if(-1===c.indexOf(l))return;var f=t.value[v.primaryKey];v.removeByIds([f]);break;case x.ModifyType.Load:var h=t.path,y=h[h.length-2],d=v.parent.primaryKeyValue;if(-1===y.indexOf(d))return;var g=t.value;E.loadEntities(g,v)}})},bn.loadRepository=function(n,e){var r=this,t=Array.from(n.entityCollection.toArray());this.loadEntities(t,e),n.entityCollectionChange.pipe(l.takeUntil(n.destroy$)).subscribe(function(t){switch(t.type){case x.ModifyType.Load:e.clear(!0),r.loadEntities(t.value,e,t.entityCreate);break;case x.ModifyType.Add:case x.ModifyType.Clone:r.appendEntities(t.value,e,t.type===x.ModifyType.Clone,{isTreeNodeLoadScene:t.isTreeNodeLoadScene});break;case x.ModifyType.AddData:r.addData(t.value,e,{isTreeNodeLoadScene:t.isTreeNodeLoadScene});break;case x.ModifyType.Insert:r.insertEntity(t.value,e,t.position);break;case x.ModifyType.Remove:r.removeEntities(t.value,e);break;case x.ModifyType.RemoveData:r.removeData(t.value,e);break;case x.ModifyType.PaginationInfoChange:e.paginationInfo=t.value}}),e.changes.pipe(l.takeUntil(e.destroy$)).subscribe(function(t){if(t.type===x.ChangeType.PaginationInfoChange){var e=n.entityCollection;e.paginationInfo=Object.assign({},e.paginationInfo,t.value)}})},bn.loadEntities=function(t,e,n){void 0===n&&(n=!1);var r=this.createBindingObjects(t,e);e.load(r,n)},bn.appendEntities=function(t,e,n,r){void 0===n&&(n=!1),void 0===r&&(r=null);var i=this.createBindingObjects(t,e);e.append(i,n,r)},bn.isEffectiveField=function(t,e){if(!t||!e)return!1;if(e=e.toLowerCase(),t.__farris_effective_fields__)return t.__farris_effective_fields__.includes(e);if(t.farris_effective_fields&&"string"==typeof t.farris_effective_fields){var n=t.farris_effective_fields.split(",").filter(function(t){return t}).map(function(t){return t.toLowerCase()});return(t.__farris_effective_fields__=n).includes(e)}return!0},bn.addData=function(t,e,n){void 0===n&&(n=null);var r=this.createBindingObjects(t,e);e.addData(r,n)},bn.insertEntity=function(t,e,n){var r=this.createBindingObject(t,e);e.insert(r,n)},bn.removeEntities=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,r=[];t.forEach(function(t){r.push(t[n])}),e.removeByIds(r)}},bn.removeData=function(t,e){if(null!==t&&0!==t.length){var n=e.primaryKey,r=[];t.forEach(function(t){r.push(t[n])}),e.removeDataByIds(r)}},bn.createBindingObjects=function(t,n){var r=this;if(null===t||0===t.length)return[];var i=[];return t.forEach(function(t){var e=zt.create(n.properties);e._ENTITY_=t,r.loadEntity(t,e),i.push(e)}),i},bn.createBindingObject=function(t,e){var n=zt.create(e.properties);return this.loadEntity(t,n),n},bn.watchReposiroty=function(t,e){t.entityCollectionChange.subscribe(function(t){switch(t.type){case x.ModifyType.PaginationInfoChange:e.pagingInfo=t.value}})},bn.getPropInfo=function(t,e){var n,r,i=K.getNgFields(t);Object.keys(i).forEach(function(t){t===e&&(n="NgField",r=null)});var o=K.getNgObjects(t);Object.keys(o).forEach(function(t){t===e&&(n="NgObject",r=o[t].type)});var a=K.getNgList(t);Object.keys(a).forEach(function(t){t===e&&(n="NgList",r=a[t].type)});var s=K.getNgDynamic(t);return Object.keys(s).forEach(function(t){t===e&&(n="NgDynamic",r=s[t].type)}),{propType:n,propEntityType:r}},bn.getPrimaryKey=function(t){var e=K.getPrimaryFieldMetadata(t);return e?e.dataField:""},bn.isObjectProp=function(t,e){var n=!1,r=K.getNgObjects(t);return Object.keys(r).forEach(function(t){t===e&&(n=!0)}),n},bn.isDynamicProp=function(t,e){var n=!1,r=K.getNgDynamic(t);return Object.keys(r).forEach(function(t){t===e&&(n=!0)}),n},bn.appendInitialData=function(t,e){var n=Object.assign({},e);delete n.id,delete n.parentID,t.initialData=n},bn);function bn(){}var Cn=(Object.defineProperty(xn.prototype,"pagingInfo",{get:function(){return this.paginationInfo},set:function(t){this.paginationInfo=t,this.firePagingChangeEvent()},enumerable:!0,configurable:!0}),xn.prototype.dispose=function(t){this.list.dispose()},xn.prototype.ngOnDestroy=function(){this.dispose()},xn.prototype.setPagingInfo=function(t,e,n){if(n.length<1||"/"===n)this.paginationInfo=Object.assign(this.paginationInfo,{pageSize:e,pageIndex:t/e+1});else{var r=this.paginationInfo||{},i=n.substr(1).split("/").filter(function(t){return!!t&&0<t.length}),o=i[i.length-1];o=o.substr(0,o.length-1);var a=i.slice(0,i.length-1),s=this.getValue(a);s&&s[s.primaryKey]&&((r=r[""+o]||{}).pageIndex=(t/e||0)+1,r.pageSize=e||0)}this.firePagingChangeEvent()},xn.prototype.updatePagingInfo=function(t,e){if(e.length<1||"/"===e)this.paginationInfo=Object.assign(this.paginationInfo,t);else{var n=this.paginationInfo||{},r=e.substr(1).split("/").filter(function(t){return!!t&&0<t.length}),i=r[r.length-1];n[i=i.substr(0,i.length-1)]=Object.assign(n[i],t)}this.firePagingChangeEvent()},xn.prototype.firePagingChangeEvent=function(){this.list.changes.next({type:x.ChangeType.PaginationInfoChange,path:this.bindingPath&&this.bindingPath.split("/").filter(function(t){return t})||[],value:this.paginationInfo})},Object.defineProperty(xn.prototype,"changes",{get:function(){return this.list.changes},enumerable:!0,configurable:!0}),xn.prototype.setValueChangeInvokerFactory=function(t){this.valueChangeInvokerFactory=t},xn.prototype.getValudChangeInvokerFactory=function(){return this.valueChangeInvokerFactory},xn.prototype.init=function(t,e){this.initByRepository(t,e)},xn.prototype.initByRepository=function(t,e){this.bindingPath=e,this.properties=Rt.getProperties(t.entityType),this.list=Ut.create(this.properties),this.pagingInfo=t.entityCollection.paginationInfo,En.loadRepository(t,this.list),this.dataTypeInfo=t.entityTypeInfo,this.extendProperties(this.properties)},xn.prototype.initByBindingList=function(t,e){this.list=t,this.bindingPath=e,this.extendProperties(this.list.properties)},xn.prototype.setDataTypeInfo=function(t){this.dataTypeInfo=t},xn.prototype.getValue=function(t,e){void 0===e&&(e=!1);var n=this.list;if(t.forEach(function(t){n=n&&n[t]}),!0===e&&t&&0<t.length){var r=this.getInitValueByPaths(t);n===undefined&&n!==r&&(n=r)}return n},xn.prototype.setValue=function(t,e,n,r,i,o){if(void 0===n&&(n=!1),void 0===r&&(r=!0),void 0===i&&(i={}),!t||0===t.length)throw Error("路径不能为空");var a=t.slice(0,t.length-1),s=t[t.length-1],p=this.getValue(a);if(!p)throw Error("找不到要设置的对象");p instanceof xn?p=p.list.currentItem:p instanceof Pn&&(p=p.currentItem),this.valueChangeInvokerFactory?p.setValue(s,e,n,r,i,this.valueChangeInvokerFactory(t),o):p.setValue(s,e,n,r,i,null,o)},xn.prototype.clearValue=function(t,e,n,r){var i;void 0===e&&(e=!1),void 0===n&&(n=!0);var o=this.dataTypeInfo.getPropInfoByPath(t);i=o&&o.metadataInfo&&o.metadataInfo.initValue!==undefined?o.metadataInfo.initValue:"number"==typeof this.getValue(t)?0:"",this.setValue(t,i,e,n,null,r)},xn.prototype.getList=function(){if(!this.bindingPath||"/"===this.bindingPath)return this.list;var t=this.bindingPath.substr(1).split("/").filter(function(t){return""!==t});return this.getValue(t)},xn.prototype.getObject=function(){return this.getList().currentItem},xn.prototype.getPath=function(t){var n=this,e=t.filter(function(t){return t}),r=[this.list.primaryKey+":"+this.list.currentId];return e.forEach(function(t){r.push(t);var e=n[t];e&&r.push(e.primaryKey+":"+e.currentId)}),r},xn.prototype.reset=function(){this.list.clear(!0)},xn.prototype.getInitValueByPaths=function(t){var e,n=this.dataTypeInfo&&this.dataTypeInfo.getPropInfoByPath(t)||null;return n&&n.metadataInfo&&n.metadataInfo.initValue!==undefined&&(e=n.metadataInfo.initValue),e},xn.prototype.extendProperties=function(t){var n=this;t.forEach(function(t){var e=t.name;Object.defineProperty(n,e,{get:function(){return n.list.currentItem[e]},set:function(t){n.list.currentItem[e]=t}})})},xn.decorators=[{type:d.Injectable}],xn);function xn(){this.paginationInfo=null}var Pn=(Object.defineProperty(In.prototype,"paginationInfo",{get:function(){return this._paginationInfo},set:function(t){this._paginationInfo=t,this._paginationInfo!==t&&this.changes.next({type:x.ChangeType.PaginationInfoChange,path:[],value:this._paginationInfo})},enumerable:!0,configurable:!0}),Object.defineProperty(In.prototype,"pageIndex",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageIndex")?this.paginationInfo.pageIndex:1},enumerable:!0,configurable:!0}),Object.defineProperty(In.prototype,"pageSize",{get:function(){return this.paginationInfo&&this.paginationInfo.hasOwnProperty("pageSize")?this.paginationInfo.pageSize:0},enumerable:!0,configurable:!0}),Object.defineProperty(In.prototype,"total",{get:function(){return this.paginationInfo?this.paginationInfo.total||this.paginationInfo.totalCount:0},enumerable:!0,configurable:!0}),Object.defineProperty(In.prototype,"skip",{get:function(){return(this.pageIndex-1)*this.pageSize},enumerable:!0,configurable:!0}),In.prototype.setPaginationInfo=function(t,e){this.paginationInfo=Object.assign({},this.paginationInfo,{pageSize:e,pageIndex:t/e+1})},Object.defineProperty(In.prototype,"currentItem",{get:function(){var t=this.findById(this.currentId);return t||(this.emptyCurrentItem||(this.emptyCurrentItem=zt.create(this.properties)),this.emptyCurrentItem)},enumerable:!0,configurable:!0}),Object.defineProperty(In.prototype,"length",{get:function(){return this.innerList.count()},enumerable:!0,configurable:!0}),In.prototype.dispose=function(t){this.clear(!0),this.destroy$&&(this.destroy$.next(),this.destroy$.complete(),this.destroy$=null)},In.prototype[Symbol.iterator]=function(){var t=this,e=-1,n=this.innerList.size;return{next:function(){return++e<n?{done:!1,value:t.innerList.get(e)}:{done:!0,value:undefined}}}},In.prototype.load=function(t,e){var n=this;if(void 0===e&&(e=!1),this.innerList=this.innerList.clear(),0!==t.length){if(t.forEach(function(t){n.add(t)}),!this.findById(this.currentId)){var r=t[0][this.primaryKey];this.setCurrentId(r,!1,!1)}}else this.currentId=null;var i={type:x.ChangeType.Load,path:[],value:t};i.create=e,this.changes.next(i)},In.prototype.append=function(t,e,n){var r=this;if(void 0===e&&(e=!1),void 0===n&&(n=null),0!==t.length){t.forEach(function(t){r.add(t)});var i=t[t.length-1][this.primaryKey];this.setCurrentId(i,!0,!0);var o={type:x.ChangeType.Append,path:[],value:t,isTreeNodeLoadScene:n&&n.isTreeNodeLoadScene};e&&(o.isCloned=!0),this.changes.next(o)}},In.prototype.addData=function(t,e){var n=this;void 0===e&&(e=null),0!==t.length&&(t.forEach(function(t){n.add(t)}),this.changes.next({type:x.ChangeType.Append,path:[],value:t,isTreeNodeLoadScene:e&&e.isTreeNodeLoadScene}))},In.prototype.insert=function(t,e){var n=this,r=this.innerList.findIndex(function(t){return t.primaryKeyValue===n.currentId});this.innerList=1===e?this.innerList.insert(r+1,t):-1===e?this.innerList.insert(r,t):this.innerList.push(t),t.parent=this,t.changes.subscribe(function(t){n.changes.next(t)}),this.setCurrentId(t.primaryKeyValue,!0,!0),this.changes.next({type:x.ChangeType.Append,path:[],value:t})},In.prototype.add=function(t){var e=this;this.innerList=this.innerList.push(t),t.parent=this,t.changes.subscribe(function(t){e.changes.next(t)})},In.prototype.removeByIds=function(t){var n=this;if(t&&0!==t.length){var r=this.currentId;t.forEach(function(t){t===r&&(r=n.getCurrentIdBeforeDeleting());var e=n.getIndexById(t);-1!==e&&(n.innerList=n.innerList["delete"](e))}),0===this.innerList.count()?this.currentId=null:this.setCurrentId(r,!1,!1),this.changes.next({type:x.ChangeType.Remove,path:[],value:t})}},In.prototype.removeDataByIds=function(t){var n=this;t&&0!==t.length&&(t.forEach(function(t){var e=n.getIndexById(t);-1!==e&&(n.innerList=n.innerList["delete"](e))}),this.changes.next({type:x.ChangeType.Remove,path:[],value:t}))},In.prototype.clear=function(t){void 0===t&&(t=!1),this.innerList.forEach(function(t){t._ENTITY_=null,t.unsubscribe.next(),t.unsubscribe.complete(),t.changes.complete(),t.viewChanges.complete()}),this.innerList=this.innerList.clear(),t||(this.currentId=null,this.changes.next({type:x.ChangeType.Remove,path:[],value:[]}))},In.prototype.getCurrentIdBeforeDeleting=function(){var t=-1,e=this.getIndexById(this.currentId);return t=e===this.length-1?e-1:e+1,this.getIdByIndex(t)},In.prototype.findById=function(e){var t,n=this;return(t=this.innerList.find(function(t){return t.getValue(n.primaryKey)===e}))===undefined?null:t},In.prototype.setCurrentId=function(t,e,n,r){void 0===e&&(e=!0),void 0===n&&(n=!0),void 0===r&&(r=!1),this.currentId===t&&!r||(this.findById(t)||r)&&(this.currentId=t,!0===e&&this.changes.next({type:x.ChangeType.SelectionChanged,path:[],value:this.currentItem,force:r}),!0===n&&this.changes.next({type:x.ChangeType.GlobalSelectionChanged,path:[],value:this.currentItem,force:r}))},In.prototype.getIndexById=function(e){var n=this;return this.innerList.findIndex(function(t){return t[n.primaryKey]===e})},In.prototype.getIdByIndex=function(t){return t<0||t>this.length||!1===this.innerList.has(t)?null:this.innerList.get(t)[this.primaryKey]},In.prototype.toArray=function(){return this.innerList.toArray()},In.prototype.swapById=function(n,r){var i=this.innerList.find(function(t){return t.primaryKeyValue===n}),o=this.innerList.find(function(t){return t.primaryKeyValue===r});this.innerList=this.innerList.map(function(t,e){return t.primaryKeyValue===n?o:t.primaryKeyValue===r?i:t}).toList(),this.changes.next({type:x.ChangeType.Swap,path:[]})},In.prototype.toJSON=function(e){var n=[];return this.innerList.forEach(function(t){n.push(t.toJSON(e))}),n},In.prototype.getPaginationConfigByPath=function(t,e){if(!t||"/"===t)return this.paginationInfo;if("string"!=typeof t)throw new Error("路径必须为字符串！");var n=(t=t.substring(1)).split("/").filter(function(t){return!!t&&0<t.trim().length}).map(function(t){return t.trim()}),r=this.paginationInfo;return n.forEach(function(t){r=r&&r.hasOwnProperty(t)?r[t]:null}),r||(void 0!==e?e:undefined)},In.prototype.sortBy=function(t,e,n){var c=this;if(!t||t.length<1||!e||e.length<1)throw new Error("sortBy:argument error");var l,f,r="string"==typeof t?t.split(","):t||[],i="string"==typeof e?e.split(","):e||[];if(r.length!==i.length||r.length<1)throw new Error("sortBy:fields and directions not match");this.innerList=this.innerList.sort((l=r,f=i,function(p,u){return l.reduce(function(t,e){if(0===t){var n=c.properties.find(function(t){return t.name===e}),r=!1;n&&(r=n.enableMultiLangInput);var i=ft.getCurrentLanguage(),o=["asc"].includes(f[l.indexOf(e)])?1:-1,a=c.getValue(p,e,r,i),s=c.getValue(u,e,r,i);null!==a&&a!==undefined||(a=""),null!==s&&s!==undefined||(s=""),"string"==typeof a&&"string"==typeof s?t=a.localeCompare(s)*o:(s<a&&(t=o),a<s&&(t=-1*o))}return t},0)})).toList()},In.prototype.getValue=function(t,e,n,r){var i,o;void 0===n&&(n=!1),void 0===r&&(r="zh-CHS"),t instanceof In?t=t.currentItem:t instanceof Cn&&(t=t.list.currentItem);var a=null;if(-1===e.indexOf("."))a=t[e];else{var s=e.split(".");try{for(var p=P(s),u=p.next();!u.done;u=p.next()){var c=u.value;t=a=this.getValue(t,c,n,r)}}catch(l){i={error:l}}finally{try{u&&!u.done&&(o=p["return"])&&o.call(p)}finally{if(i)throw i.error}}}return n&&a&&a.hasOwnProperty(r)?a[r]:a},In);function In(t){this.__type__="BindingList",this._paginationInfo=null,this.properties=t,this.primaryKey=Rt.getPrimaryKey(t),this.changes=new h.Subject,this.innerList=e.List(),this.currentId=null,this.destroy$=new h.Subject}var Tn=(Mn.createFromRepository=function(t,e){var n=new Cn,r=Rt.getProperties(t.entityType),i=Ut.create(r);return n.initByBindingList(i,e),n.setDataTypeInfo(t.entityTypeInfo),En.loadRepository(t,i),n.pagingInfo=t.entityCollection.paginationInfo,n},Mn.createFromEntityManager=function(t,e){var n=new Cn,r=Rt.getProperties(t.entityType),i=Ut.create(r);n.initByBindingList(i,e);var o=t.getEntitiesByPath([]);return En.loadEntities(o,i),n},Mn.createFromExistingBindingData=function(t,e){var n=new Cn;return n.initByBindingList(t.list,e),n},Mn);function Mn(){}var Sn="NgBindingData";var jn=(wn.convertToBindingPathArray=function(t){return t.split("/").filter(function(t){return""!==t})},wn.convertToEntityPathArray=function(t,e){var n=this,r=this.convertToBindingPathArray(t),i=[];if(0===r.length)return i;var o=e.list.currentItem;return i.push(this.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue)),r.forEach(function(t){switch(Rt.getPropertyByName(o.properties,t).type){case x.BindingPropertyType.Plain:i.push(t);break;case x.BindingPropertyType.Object:o=o[t],i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue));break;case x.BindingPropertyType.List:var e=o[t];o=e.currentItem,i.push(t),i.push(n.createPrimaryKeyPath(o.primaryKey,o.primaryKeyValue))}}),i},wn.convertToRestUrl=function(t,e){var n=this.convertToBindingPathArray(t),r=[],i=e.list.currentItem;return r.push(i.primaryKeyValue),n.forEach(function(t){var e=Rt.getPropertyByName(i.properties,t);if(e.type!==x.BindingPropertyType.List)throw new Error(e.name+"不是子表对应的属性");var n=i[t];i=n.currentItem,r.push(t),r.push(i.primaryKeyValue)}),r.pop(),"/"+r.join("/")},wn.getLeafPath=function(t){return wn.convertToBindingPathArray(t).pop()},wn.getParentPath=function(t){var e=wn.convertToBindingPathArray(t);return e.pop(),"/"+e.join("/")},wn.createPrimaryKeyPath=function(t,e){return t+":"+e},wn);function wn(){}var On=(Nn.isGuid=function(t){var e=t.toString();return t&&(t instanceof Nn||Nn.validator.test(e))},Nn.create=function(){return new Nn(We.create())},Nn.createEmpty=function(){return new Nn("")},Nn.parse=function(t){return new Nn(t)},Nn.raw=function(){return We.create()},Nn.prototype.equals=function(t){return Nn.isGuid(t)&&this.value===t.toString()},Nn.prototype.isEmpty=function(){return this.value===Nn.EMPTY},Nn.prototype.toString=function(){return this.value},Nn.prototype.toJSON=function(){return{value:this.value}},Nn.validator=new RegExp("^[a-z0-9]+$","i"),Nn.EMPTY="",Nn);function Nn(t){if(!t)throw new TypeError("Invalid argument; `value` has no value.");this.value=Nn.EMPTY,t&&(this.value=t)}var Dn=(Vn.setRunMode=function(t){Vn.mode=t},Vn.getRunMode=function(){return Vn.mode},Vn.mode=null,Vn);function Vn(){}var Fn=(Object.defineProperty(Rn.prototype,"data",{get:function(){return this.newData},set:function(t){this.newData=t},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"errors",{get:function(){return this.validErrors},set:function(t){this.validErrors=t},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"changeSetPolicy",{get:function(){return this._changeSetPolicy},set:function(t){this._changeSetPolicy=t},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"changes",{get:function(){return this.changeSet.changes},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"primaryProperty",{get:function(){return this.primaryFieldMetadata||(this.primaryFieldMetadata=K.getPrimaryFieldMetadata(this.constructor)),this.primaryFieldMetadata},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"primaryKey",{get:function(){return this.primaryProperty?this.primaryProperty.property:""},enumerable:!0,configurable:!0}),Object.defineProperty(Rn.prototype,"primaryValue",{get:function(){if(this.primaryKey){var t=this[this.primaryProperty.property];return t||""}return""},enumerable:!0,configurable:!0}),Rn.prototype.setChanges=function(t){var e=t.path[t.path.length-1];this.valueChanged.next(t),this.validErrors&&Object.keys(this.validErrors).includes(e)&&"valid"===this.changeSetPolicy||(t&&t.changeSetValue!==undefined&&((t=JSON.parse(JSON.stringify(t))).value=t.changeSetValue),this.changeSet.append(t))},Rn.prototype.validate=function(t,e,n,r,i){var o=this;return h.from(this.validator.validate(this,t,e,n,r,i)).pipe(l.tap(function(t){t.isValid?o.validErrors={}:o.validErrors=pt.convertErrorsToNormalObject(t.errors,{})}))},Rn.prototype.validateAll=function(t){},Rn.prototype.validateFromUtil=function(t,e,n,r){var i=this;this.validErrors={},h.from(this.validator.validate(this,t,e,null,undefined,r&&r.frameContext||null)).subscribe(function(t){t.isValid||(i.validErrors=pt.convertErrorsToNormalObject(t.errors,{})),n(t)})},Rn.prototype.validateFromUtilSync=function(t,e,n,r){this.validErrors={};var i=this.validator.verify(this,t,e,null,undefined,r&&r.frameContext||null,!0);i&&!i.isValid&&(this.validErrors=pt.convertErrorsToNormalObject(i.errors,{})),n(i)},Rn.prototype.getPaths=function(){var r={path:[],isUdt:!1,isGrid:!1},i=function(t){var e=t[J];if(e){var n=e[e.length-1];-1<Object.keys(K.getNgObjects(t[W].constructor)).indexOf(n)&&(r.isUdt=!0),t instanceof gt==1?r.isGrid=!0:r.path.push(n)}t[W]&&i(t[W])};return i(this),r.path=r.path.reverse(),r},Rn.prototype.getEntityListPath=function(){var r=[],i=function(t){var e=t[J];if(e&&t instanceof gt==1){var n=e.concat([]).reverse();Array.prototype.push.apply(r,n)}t[W]&&i(t[W])};return i(this),r.reverse()},Rn.prototype.getMainEntityPrimaryValue=function(){for(var t=this;t[W];)t=t[W];return t.primaryValue},Rn.prototype.load=function(t,e){void 0===e&&(e={}),t=t||{},this.loadFields(t),(!e||e&&!1!==e.loadChild)&&this.loadLists(t),this.loadObjects(t),this.loadDynamicObjects(t),this.newData=Object.assign({},t),this.originalData=Object.assign({},t)},Rn.prototype.toJSON=function(r){var i=this,o={},a=K.getNgFields(this.constructor);Object.keys(a).forEach(function(t){var e=a[t],n=e.dataField||t;!0===r&&!0===e.enableTimeZone?o[n]=i.data[t]:o[n]=i[t]});var n=K.getNgObjects(this.constructor);Object.keys(n).forEach(function(t){var e=n[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var s=K.getNgDynamic(this.constructor);Object.keys(s).forEach(function(t){var e=s[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var p=K.getNgList(this.constructor);return Object.keys(p).forEach(function(t){var e=p[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}}),o},Rn.prototype.initialize=function(){var t=this.constructor,e=K.getNgFields(t),n=K.getNgObjects(t),r=K.getNgList(t),i=K.getNgDynamic(t);this.initializeNormalField(e),this.initializeList(r),this.initializeObject(n),this.initializeDynamic(i)},Rn.prototype.createPath=function(t){var e=this.primaryProperty;return e?[e.dataField+":"+this.primaryValue,t]:[":",t]},Rn.prototype.initializeNormalField=function(t){var e=this;Object.keys(t).forEach(function(r){var i=t[r];i.dataField,delete e[r]&&Object.defineProperty(e,r,{get:function(){return this.getPropValue(r,i)},set:function(t){var e=this.getPropValue(r,i);if(!1!==this.isPropValueChanged(r,i,t,e)){this.setPropValue(r,i,t);var n=this.preparePropValue(r,i,t);this.emitValueChange(r,i,t,e,n)}}})})},Rn.prototype.initializeList=function(s){var p=this;Object.keys(s).forEach(function(t){var e=s[t],n=p.createPath(t),r=e.dataField||t,i=p.data[r],o=new gt;if(o[W]=p,o[J]=n,i){var a=i.map(function(t){return Y(e.type,t)});o.loadEntities(a)}o.onListChanged.subscribe(function(t){t&&(o[J][0]!==t.path[0]&&(t.path=o[J].concat(t.path)),p.setChanges(t))}),p[t]=o})},Rn.prototype.initializeObject=function(s){var p=this;Object.keys(s).forEach(function(n){var r=s[n],i=p.createPath(n),t=r.dataField||n,e=p.data[t]||{},o=function(t){var e;return(e=t instanceof r.type?t:Y(r.type,t))[W]=p,e[J]=i,e.onValueChanged.subscribe(function(t){t&&(t.path=(p[J]||[]).concat(t.path),p.setChanges(t))}),e},a=o(e);delete p[n]&&Object.defineProperty(p,n,{get:function(){return a},set:function(t){var e={path:a[J],value:t.data,preValue:this[n].data,type:x.ModifyType.ValueChange};a=o(t),this.setChanges(e)}})})},Rn.prototype.initializeDynamic=function(s){var p=this;Object.keys(s).forEach(function(n){var r=s[n],i=p.createPath(n),t=r.dataField||n,e=p.data[t]||{},o=function(t){var e;return(e=t instanceof r.type?t:Y(r.type,t))[W]=p,e[J]=i,e.onValueChanged.subscribe(function(t){t&&(t.path=(p[J]||[]).concat(t.path),p.setChanges(t))}),e},a=o(e);delete p[n]&&Object.defineProperty(p,n,{get:function(){return a},set:function(t){var e={path:a[J],value:t.data,preValue:this[n].data,type:x.ModifyType.ValueChange};a=o(t),this.setChanges(e)}})})},Rn.prototype.loadFields=function(o){var a=this,s=K.getNgFields(this.constructor);Object.keys(s).forEach(function(t){var e=s[t],n=e.dataField||t,r=o[n];if(!0===e.enableTimeZone){var i=It.getTimeZoneOffset();null!==i&&r&&(r=Mt.zonedTimeToSpecialTimeZoneOffsetTimeString(r,i))}a[t]=r})},Rn.prototype.loadLists=function(a){var s=this,p=K.getNgList(this.constructor);Object.keys(p).forEach(function(t){var e=p[t],n=e.dataField||t,r=e.type,i=a[n];if(i){var o=i.map(function(t){return Y(r,t)});s[t].loadEntities(o)}else s[t].loadEntities([])})},Rn.prototype.loadObjects=function(i){var o=this,a=K.getNgObjects(this.constructor);Object.keys(a).forEach(function(t){var e=a[t].dataField||t,n=i[e],r=o[t];r&&n&&r.load(n)})},Rn.prototype.loadDynamicObjects=function(i){var o=this,a=K.getNgDynamic(this.constructor);Object.keys(a).forEach(function(t){var e=a[t].dataField||t,n=i[e]||{},r=o[t];r&&r.loadDynamicData(n)})},Rn.prototype.emitValueChange=function(t,e,n,r,i){void 0===i&&(i=undefined);var o={path:this.createPath(t),value:n,changeSetValue:i,preValue:r,type:x.ModifyType.ValueChange};this[J]&&(o.path=this[J].concat(o.path)),this.setChanges(o)},Rn.prototype.preparePropValue=function(t,e,n){var r=undefined;if(!0===e.enableTimeZone){var i=It.getTimeZoneOffset();null!==i&&n&&(r=Mt.timeZoneOffsetTimeToUtcTimeString(n,i))}return r},Rn.prototype.getPropValue=function(t,e){var n,r=e.dataField||t,i=this.data[r];if(!0===e.enableMultiLangInput&&!i){var o=window.localStorage.getItem("languageCode")||"zh-CHS",a=r.replace("_MULTILANGUAGE","");return(n={})[o]=this.data[a],n}if(!0===e.enableTimeZone){var s=It.getTimeZoneOffset();if(null!==s&&i)return Mt.zonedTimeToSpecialTimeZoneOffsetTimeString(i,s)}return e.originalDataFieldType===Ct&&(i=i&&i.toString()||null),i},Rn.prototype.setPropValue=function(t,e,n){var r=e.dataField||t;if(e.originalDataFieldType===Ct)this.data[r]=null===n?null:n&&n.toString()||"";else{if(!0===e.enableTimeZone){var i=It.getTimeZoneOffset();null!==i&&n&&(n=Mt.timeZoneOffsetTimeToUtcTimeString(n,i))}this.data[r]=n}},Rn.prototype.isPropValueChanged=function(t,e,n,r){return!0===e.enableMultiLangInput?(!0!==this.isEmptyMultiLangPropValue(n)||!0!==this.isEmptyMultiLangPropValue(r))&&JSON.stringify(n)!==JSON.stringify(r):(e.originalDataFieldType===Ct&&"string"!=typeof n&&null!==n&&n!==undefined&&(n=n.toString()),n!==r)},Rn.prototype.isEmptyMultiLangPropValue=function(t){return!t||0===Object.keys(t).length||!0===Object.values(t).every(function(t){return!t})},Rn);function Rn(t){this.validErrors={},this.primaryFieldMetadata=null,this.originalData=undefined,this.changeSet=new D,this.isValidating=!1,this.newData=undefined,this.unsubscribe=new h.Subject,this.valueChanged=new h.Subject,this.onValueChanged=this.valueChanged.asObservable(),this.onUpdate=new h.Subject,this.validator=new yt,this.newData=Object.assign({},t),this.originalData=Object.assign({},t),this.onValueChanged=this.valueChanged,Dn.getRunMode()===x.RunMode.compatible&&this.initialize()}var _n,Bn=(c(An,_n=Fn),Object.defineProperty(An.prototype,"IsNested",{get:function(){return this[W]instanceof An},enumerable:!0,configurable:!0}),An.prototype.loadDynamicData=function(t){this.initializeDynamicField(t)},An.prototype.initializeDynamicField=function(t){var e=this;Object.keys(t).forEach(function(r){var i=r;if(delete e[r])if(t[r]instanceof Object){var n=e.createPath(r),o=e.createDynamicEntityFromJsonData(t[r],n);Object.defineProperty(e,r,{get:function(){return o},set:function(t){var e={path:o[J],value:t.data,preValue:this[r].data,type:x.ModifyType.ValueChange};o=this.createDynamicEntityFromJsonData(t,n),this.setChanges(e)}})}else Object.defineProperty(e,r,{get:function(){return this.data[i]},set:function(t){var e=this.data[i];if(e!==t){this.data[i]=t;var n={type:x.ModifyType.ValueChange,path:this.createPath(r),value:t,preValue:e};this[J]&&(n.path=this[J].concat(n.path)),this.setChanges(n)}}})})},An.prototype.createDynamicEntityFromJsonData=function(t,e){var n,r=this;return t instanceof An?n=t:(n=new An(t)).constructor=An,n[W]=this,n[J]=e,n.onValueChanged.pipe(l.takeUntil(this.unsubscribe)).subscribe(function(t){t&&(t.path=(r[J]||[]).concat(t.path),r.setChanges(t))}),n},An.prototype.setChanges=function(t){var e,n=t.path[t.path.length-1],r=Object.assign({},this.data);this.newData=Object.assign(this.newData,((e={})[n]=t.value,e));var i=t.path;2<t.path.length&&(i=t.path.slice(0,t.path.length-2));var o={path:i,value:this.data,preValue:r,type:t.type,dynamic:!0};this.valueChanged.next(o),this.changeSet.append(t)},An.prototype.toJSON=function(){return this.data},An);function An(t){var e=_n.call(this,t)||this;return e.loadDynamicData(t),e}var Ln,kn,$n,Un=new d.InjectionToken("@farris/devkit ENTITY_DATA_SERVICE"),Hn={getFieldValue:function(t){var e,n=t.label,r=this.data[n];if(!0!==t.multiLanguage||r)return r;var i=window.localStorage.getItem("languageCode")||"zh-CHS",o=n.replace("_MULTILANGUAGE","");return(e={})[i]=this.data[o],e},setFieldValue:function(t,e){var n=t.label;this.data[n]=e},getComplexFieldValue:function(t){var e=t.label;return this.innerEntities[e]},setComplexFieldValue:function(t,e,n){var r=t.label,i=null;n instanceof e?i=n:(i=new e(n)).constructor=e;var o=this.innerEntities[r],a={path:o&&o[J]||i[J],value:n,preValue:this[r]&&this[r].data||null,type:x.ModifyType.ValueChange};this.innerEntities[r]=i,this.isInitializing||this.setChanges(a)},getEntities:function(t){var e=t.label;return this.innerEntities[e]},setEntities:function(t,e){var n=t.label;this.innerEntities[n]=e},isFieldValueChanged:function(t,e,n){return!0===t.multiLanguage?(!0!==this.isEmptyMultiLangPropValue(e)||!0!==this.isEmptyMultiLangPropValue(n))&&JSON.stringify(e)!==JSON.stringify(n):e!==n},isEmptyMultiLangPropValue:function(t){return!t||(0===Object.keys(t).length||!0===Object.values(t).every(function(t){return!t}))},emitFieldValueChange:function(t,e,n){if(!this.isInitializing){var r=t.label,i={path:this.createPath(r),value:e,preValue:n,type:x.ModifyType.ValueChange};this[J]&&(i.path=this[J].concat(i.path)),this.setChanges(i)}},setChanges:function(t){var e=t.path[t.path.length-1];this.valueChanged.next(t),this.validErrors&&Object.keys(this.validErrors).includes(e)||this.changeSet.append(t)},createPath:function(t){return this.primaryKey?[this.primaryKey+":"+this.primaryValue,t]:[":",t]},getPaths:function(){var r={path:[],isUdt:!1,isGrid:!1},i=function(t){var e=t[J];if(e){var n=e[e.length-1];-1<Object.keys(K.getNgObjects(t[W].constructor)).indexOf(n)&&(r.isUdt=!0),t instanceof gt==!0?r.isGrid=!0:r.path.push(n)}t[W]&&i(t[W])};return i(this),r.path=r.path.reverse(),r},validate:function(t,e,n,r){var i=this;return h.from(this.validator.validate(this,t,e,n,r)).pipe(l.tap(function(t){t.isValid?i.validErrors={}:i.validErrors=pt.convertErrorsToNormalObject(t.errors,{})}))},validateAll:function(t){},validateFromUtil:function(t,e,n){var r=this;this.validErrors={},h.from(this.validator.validate(this,t,e)).subscribe(function(t){t.isValid||(r.validErrors=pt.convertErrorsToNormalObject(t.errors,{})),n(t)})},toJSON:function(r){var i=this,o={},a=K.getNgFields(this.constructor);Object.keys(a).forEach(function(t){var e=a[t],n=e.dataField||t;!0===r&&!0===e.enableTimeZone?o[n]=i.data[t]:o[n]=i[t]});var n=K.getNgObjects(this.constructor);Object.keys(n).forEach(function(t){var e=n[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var s=K.getNgDynamic(this.constructor);Object.keys(s).forEach(function(t){var e=s[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}});var p=K.getNgList(this.constructor);return Object.keys(p).forEach(function(t){var e=p[t].dataField||t;o[e]=i[t]?i[t].toJSON(r):{}}),o}},Kn=function lp(){},Gn=function fp(){},zn=function hp(){},qn=function yp(){},Jn=function dp(){},Wn=function gp(){};(Ln=x.SchemaEntityField$Type||(x.SchemaEntityField$Type={})).SimpleField="SimpleField",Ln.ComplexField="ComplexField",(kn=x.SchemaEntityFieldType$Type||(x.SchemaEntityFieldType$Type={})).StringType="StringType",kn.TextType="TextType",kn.NumericType="NumericType",kn.BooleanType="BooleanType",kn.DateType="DateType",kn.DateTimeType="DateTimeType",kn.EnumType="EnumType",kn.EntityType="EntityType",kn.HierarchyType="HierarchyType",kn.ObjectType="ObjectType",kn.BigNumericType="BigNumericType",($n=x.SchemaEntityFieldTypeName||(x.SchemaEntityFieldTypeName={})).String="String",$n.DateTime="DateTime",$n.Date="Date",$n.Enum="Enum",$n.Boolean="Boolean",$n.Number="Number",$n.Text="Text",$n.BigNumber="BigNumber";var Yn=(Zn.prototype.create=function(t){var e=t.entities[0].type;return this.createClass(e,t.entities[0])},Zn.prototype.createClass=function(t,e){var o=this.createEntityInstanceDataInitializer(t),a=function(t){var e,n,r,i=this;this.changeSet=new D,this.isValidating=!1,this.unsubscribe=new h.Subject,this.validErrors={},this.validator=new yt,this.innerData=Object.assign({},t),this.innerEntities={},this.valueChanged=new h.Subject,this.onValueChanged=this.valueChanged,this.validateFromUtilSync=function(t,e,n,r){this.validErrors={};var i=this.validator.verify(this,t,e,null,undefined,r&&r.frameContext||null,!0);i&&!i.isValid&&(this.validErrors=pt.convertErrorsToNormalObject(i.errors,{})),n(i)},n=t,r=a,(e=this).isInitializing=!0,o(e,n,r),e.isInitializing=!1,this.load=function(t){o(i,t,a)}};a.typeName=t.name+"Entity",a.code=e.code,a.label=e.label,a.types={},a.__prop__metadata__={};var n=Object.assign({typeName:"ConcreteEntityPrototype"},Hn);return this.definePresetProperty(n,t),this.defineFieldsToPrototype(n,t.fields,t.primary,a),this.defineEntitiesToPrototype(n,t.entities,a),a.prototype=n,a},Zn.prototype.definePresetProperty=function(t,e){Object.defineProperty(t,"data",{get:function(){return this.innerData||(this.innerData={}),this.innerData},set:function(t){this.innerData=t}}),Object.defineProperty(t,"errors",{get:function(){return this.validErrors},set:function(t){this.validErrors=t}}),Object.defineProperty(t,"changes",{get:function(){return this.changeSet.changes}}),Object.defineProperty(t,"primaryProperty",{get:function(){return t.innerPrimaryProperty||{dataField:e.primary}}}),Object.defineProperty(t,"primaryKey",{get:function(){return e.primary||""}}),Object.defineProperty(t,"primaryValue",{get:function(){if(this.primaryKey){var t=this[this.primaryKey];return t||""}return""}})},Zn.prototype.defineFieldsToPrototype=function(e,t,n,r){var i=this;t&&t.length&&t.forEach(function(t){switch(t.$type){case x.SchemaEntityField$Type.SimpleField:i.defineSimpleFieldToPrototype(e,t,n,r);break;case x.SchemaEntityField$Type.ComplexField:i.defineComplexFieldToPrototype(e,t,r)}})},Zn.prototype.defineSimpleFieldToPrototype=function(t,n,e,r){var i=n.label;Object.defineProperty(t,i,{get:function(){return this.getFieldValue(n)},set:function(t){var e=this.getFieldValue(n);!1!==this.isFieldValueChanged(n,t,e)&&(this.setFieldValue(n,t),this.emitFieldValueChange(n,t,e))}});var o={dataField:this.getDataField(n),originalDataField:n.code,originalDataFieldType:n.type.name,path:n.path,primary:n.label===e,enableMultiLangInput:this.getEnableMultiLangInput(n),defaultValue:n.defaultValue,ngMetadataName:R};n.enableStdTimeFormat&&"DateTime"==o.originalDataFieldType&&(o.enableTimeZone=!0),o.primary&&(t.innerPrimaryProperty=o),r.__prop__metadata__[i]||(r.__prop__metadata__[i]=[]),r.__prop__metadata__[i].push(o)},Zn.prototype.getDataField=function(t){return t.multiLanguage?t.label+"_MULTILANGUAGE":t.label},Zn.prototype.getEnableMultiLangInput=function(t){if(t.multiLanguage)return!0},Zn.prototype.defineComplexFieldToPrototype=function(t,e,n){var r=this.createClass(e.type,e);n.types[e.type.name]=r;var i=e.label;Object.defineProperty(t,i,{get:function(){return this.getComplexFieldValue(e)},set:function(t){this.setComplexFieldValue(e,r,t)}});var o={dataField:e.label,originalDataField:e.code,type:r,path:e.path,ngMetadataName:L};n.__prop__metadata__[i]||(n.__prop__metadata__[i]=[]),n.__prop__metadata__[i].push(o)},Zn.prototype.defineEntitiesToPrototype=function(i,t,o){var a=this;t&&t.length&&t.forEach(function(e){var t=a.createClass(e.type,e);o.types[e.type.name]=t;var n=e.label;Object.defineProperty(i,n,{get:function(){return this.getEntities(e)},set:function(t){this.setEntities(e,t)}});var r={dataField:e.label,originalDataField:"",type:t,ngMetadataName:B};o.__prop__metadata__[n]||(o.__prop__metadata__[n]=[]),o.__prop__metadata__[n].push(r)})},Zn.prototype.createEntityInstanceDataInitializer=function(t){return function(p,u,c){t.fields.filter(function(t){return t.$type===x.SchemaEntityField$Type.ComplexField}).forEach(function(t){var e=t.label,n=c.types[t.type.name],r=u?u[e]:null,i=p.createPath(e),o=p[e];o instanceof n?o.load(r):((o=new n(r)).constructor=n,o[W]=c,o[J]=i,o.onValueChanged.subscribe(function(t){t&&(t.path=(p[J]||[]).concat(t.path),p.setChanges(t))}),p[e]=o)}),t.entities&&t.entities.forEach(function(t){var e=t.label,n=c.types,r=p.createPath(e),i=p[e];i instanceof gt||((i=new gt).onListChanged.subscribe(function(t){t&&(i[J][0]!==t.path[0]&&(t.path=i[J].concat(t.path)),p.setChanges(t))}),p[e]=i),i[W]=c,i[J]=r;var o=n[t.type.name],a=u?u[e]:null;if(a){var s=a.map(function(t){var e=new o(t);return e.constructor=o,e});i.loadEntities(s)}})}},Zn);function Zn(){}var Xn=(Qn.prototype.get=function(t,e,n){return this.request(t,"GET",e,n)},Qn.prototype.put=function(t,e,n,r){var i=this.addBody(r,e);return this.request(t,"PUT",n,i)},Qn.prototype.post=function(t,e,n,r){var i=this.addBody(r,e);return this.request(t,"POST",n,i)},Qn.prototype["delete"]=function(t,e,n){return this.request(t,"DELETE",e,n)},Qn.prototype.request=function(t,e,n,r){if(void 0===r&&(r={}),r=r||{},n){var i=this.buildParams(n);r.params=i}var o=e;return this.httpClient.request(o,t,r)},Qn.prototype.buildParams=function(t){var e=new o.HttpParams;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n].toString();e=e.append(n,r)}return e},Qn.prototype.addBody=function(t,e){return t=t||{},Object.assign(t,{body:e})},Qn.decorators=[{type:d.Injectable}],Qn.ctorParameters=function(){return[{type:o.HttpClient}]},Qn);function Qn(t){this.httpClient=t}var tr="NgCommandHandler";var er="NgCommandHandlerExtender";var nr=(rr.prototype.execute=function(t){var e,n=this.func(t);return(e=n)&&(e[Symbol.observable]&&e===e[Symbol.observable]()||e["@@observable"]&&e===e["@@observable"]()||e instanceof h.Observable)?n:h.of(n)},rr);function rr(t,e){this.name=t,this.func=e}var ir=new d.InjectionToken("variable parsers"),or=(ar.getAppContext=function(t){if("CommandContext"===t.typeName)return t.frameContext.appContext;if(t.appContext)return t.appContext;if("AppContext"===t.typeName)return t;throw new Error("上下文中找不到AppContext，请检查！")},ar.getFrameContext=function(t){if("CommandContext"===t.typeName)return t.frameContext;if("FrameContext"===t.typeName)return t;throw new Error("上下文中找不到FrameContext，请检查！")},ar.getRootFrameContext=function(t){return this.getFrameContext(t).root},ar.getFrameContextById=function(t,e){return this.getAppContext(t).frameContextManager.getFrameContextById(e)},ar);function ar(){}var sr=(pr.prototype.parse=function(o,t){var a=this,s=or.getAppContext(t),e=this.extractPaths(o);if(1===e.length){var n=this.getValue(e[0],s);if(o==="{DATA~"+e[0]+"}")return n;if(o==="{:DATA~"+e[0]+"}")return we(n)}return e.forEach(function(t){var e=a.getValue(t,s),n="{DATA~"+t+"}",r="{:DATA~"+t+"}";if((o=o.replace(n,e)).includes(r)){var i=we(e);o=o.replace(r,i)}}),o},pr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{:?DATA~(\S+?)\}/g);if(null===e)return[];var r=/\{:?DATA~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},pr.prototype.getValue=function(t,e){var n=t.split("/").filter(function(t){return""!==t}),r=e.getFrameContext(n[0]);if(!r)throw new Error(t+"不正确，请检查！");var i=r.bindingData;if(!i)throw new Error(t+"不正确，请检查！");return i.getValue(n.slice(1))},pr.decorators=[{type:d.Injectable}],pr);function pr(){}var ur=(cr.prototype.parse=function(o,t){var a=this,s=or.getAppContext(t),e=this.extractPaths(o);if(1===e.length){var n=this.getUIState(e[0],s);if(o==="{UISTATE~"+e[0]+"}")return n;if(o==="{:UISTATE~"+e[0]+"}")return we(n)}return e.forEach(function(t){var e="{UISTATE~"+t+"}",n=a.getUIState(t,s),r="{:UISTATE~"+t+"}";if((o=o.replace(e,n)).includes(r)){var i=we(n);o=o.replace(r,i)}}),o},cr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{:?UISTATE~(\S+?)\}/g);if(null===e)return[];var r=/\{:?UISTATE~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},cr.prototype.getUIState=function(t,e){var n=t.split("/").filter(function(t){return""!==t}),r=g(n,2),i=r[0],o=r[1],a=e.getFrameContext(i),s=a&&a.uiState[o];if(s&&s.constructor.toString().startsWith("function Date()"))return this.formatDate(s);for(var p=2;p<n.length;p++)if(!(s=s[n[p]]))return s;return s},cr.prototype.formatDate=function(t){if(!t)return"";var e=t.getFullYear(),n=(t.getMonth()+1).toString();n=1===n.length?"0"+n:n;var r=t.getDate().toString();return e+"-"+n+"-"+(r=1===r.length?"0"+r:r)},cr.decorators=[{type:d.Injectable}],cr);function cr(){}var lr=(fr.prototype.parse=function(r,i){var o=this,t=this.extractPaths(r);return 1===t.length&&r==="{STATEMACHINE~"+t[0]+"}"?this.getValue(t[0],i):(t.forEach(function(t){var e="{STATEMACHINE~"+t+"}",n=o.getValue(t,i);r=r.replace(e,n)}),r)},fr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{STATEMACHINE~(\S+?)\}/g);if(null===e)return[];var r=/\{STATEMACHINE~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},fr.prototype.getValue=function(t,e){var n=this.getPathObj(t),r=this.getTargetStateMachine(n.frameId,e);if("currentState"===n.type)return r.context.state;if("renderStates"===n.type)return r[n.name];throw new Error("不支类型为"+n.type+"的状态机变量")},fr.prototype.getTargetStateMachine=function(t,e){var n;if(!(n=t?or.getFrameContextById(e,t):or.getRootFrameContext(e))||!n.stateMachine)throw new Error("找不到对应的状态机实例，请检查！");return n.stateMachine},fr.prototype.getPathObj=function(t){var e=this.splitPath(t);return"currentState"===e[0]||"renderStates"===e[0]?{frameId:"",type:e[0],name:e[1]}:{frameId:e[0],type:e[1],name:e[2]}},fr.prototype.splitPath=function(t){return t.split("/").filter(function(t){return""!==t})},fr.decorators=[{type:d.Injectable}],fr.ctorParameters=function(){return[]},fr);function fr(){}var hr=(yr.prototype.parse=function(r,i){var o=this,t=this.extractPaths(r);return 1===t.length&&r==="{COMMAND~"+t[0]+"}"?this.getValue(t[0],i):(t.forEach(function(t){var e="{COMMAND~"+t+"}",n=o.getValue(t,i);r=r.replace(e,n)}),r)},yr.prototype.extractPaths=function(t){var n=[],e=t.match(/\{COMMAND~(\S+?)\}/g);if(null===e)return[];var r=/\{COMMAND~(\S+?)\}/;return e.forEach(function(t){var e=t.match(r);null!=e&&2===e.length&&n.push(e[1])}),n},yr.prototype.getValue=function(t,e){if(e instanceof Vr==0)throw new Error("当前上下文不支持COMMAND变量，请检查！");var n=t.split("/").filter(function(t){return""!==t}),r=n.shift();if("params"===r){var i=n.shift();return e.command.params[i]}if("results"===r)return n.reduce(function(t,e){return t&&t[e]},e.results)},yr.decorators=[{type:d.Injectable}],yr.ctorParameters=function(){return[]},yr);function yr(){}var dr=(gr.prototype.parse=function(n,r,i){var o=this;return"string"==typeof n&&0<n.length?this.parseExpression(n,r,i):(Array.isArray(n)?n.forEach(function(t,e){n[e]="string"==typeof t?o.parseExpression(t,r,i):o.parse(t,r,i)}):"object"==typeof n&&null!==n&&Object.keys(n).forEach(function(t){"string"==typeof n[t]?n[t]=o.parseExpression(n[t],r,i):n[t]=o.parse(n[t],r,i)}),n)},gr.prototype.evaluate=function(t,e,n){var r=this.parse(t,e,n);return new Function("return "+r)()},gr.prototype.parseExpression=function(e,n,r){return""===e?"":(this.parsers.forEach(function(t){"string"==typeof e&&(e=t.parse(e,n,r))}),e)},gr.decorators=[{type:d.Injectable}],gr.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Inject,args:[ir]}]}]},gr);function gr(t){this.parsers=t}var mr=/#{\S+?}/g,vr=(Er.prototype.parse=function(n,t){var r=this;this.context=t;var e=this.extractVariables(n);return!e||e.length<1||e.forEach(function(t){var e=r.getVariableValue(t);n=n.replace(mr,e)}),n},Er.prototype.getVariableValue=function(t){var e=t.substring(2,t.length-1);return this.getFullFrameId(e)},Er.prototype.extractVariables=function(t){return t?t.match(mr):[]},Er.prototype.getFullFrameId=function(t){var e=or.getFrameContext(this.context).namespace||"";return(e?e+"_":"")+t},Er.decorators=[{type:d.Injectable}],Er);function Er(){}var br=/\{FORMSTATE~\/(\S+?)\}/g,Cr=/\{FORMSTATE~\/(\S+?)\}/,xr=(Pr.prototype.parse=function(i,t){var o=this;this.context=t;var e=this.extractVariables(i);return!e||e.length<1||e.forEach(function(t){var e=t.match(Cr);if(e&&2===e.length){var n=e[1],r=o.getVariableValue(n);i=i.replace(Cr,r)}}),i},Pr.prototype.getVariableValue=function(t){return or.getFrameContext(this.context).appContext.params.get(t)},Pr.prototype.extractVariables=function(t){if(!t)return null;var e=t.match(br);return!e||e.length<1?null:e},Pr);function Pr(){}var Ir=/\{EVENTPARAM~\/(\S+?)\}/g,Tr=/\{EVENTPARAM~\/(\S+?)\}/,Mr=(Sr.prototype.parse=function(i,t,o){var a=this;this.context=t;var e=this.extractVariables(i);return!e||e.length<1||e.forEach(function(t){var e=t.match(Tr);if(e&&2===e.length){var n=e[1],r=a.getVariableValue(n,o);i=i.replace(Tr,r)}}),i},Sr.prototype.extractVariables=function(t){if(!t)return null;var e=t.match(Ir);return!e||e.length<1?null:e},Sr.prototype.getVariableValue=function(t,e){return e&&t?t.split("/").filter(function(t){return t}).reduce(function(t,e){return t?t[e]:null},e):null},Sr.decorators=[{type:d.Injectable}],Sr);function Sr(){}var jr=[{provide:ir,multi:!0,useClass:vr},{provide:ir,multi:!0,useClass:xr},{provide:ir,multi:!0,useClass:Mr},{provide:ir,multi:!0,useClass:sr},{provide:ir,multi:!0,useClass:ur},{provide:ir,multi:!0,useClass:lr},{provide:ir,multi:!0,useClass:hr},dr],wr=(Or.prototype.canLink=function(t){var e;switch(typeof this.condition){case"boolean":e=this.condition;break;case"function":e=this.condition(t);break;case"string":var n=t&&t.frameContext&&t.frameContext.injector&&t.frameContext.injector.get(dr);e=n&&n.evaluate(this.condition,t);break;default:e=!1}return e},Or);function Or(t,e,n){this.from=t,this.to=e,this.condition=n}var Nr=(Dr.prototype.addNode=function(t,e){var n=new nr(t,e);this.nodes.push(n)},Dr.prototype.addNodes=function(t){this.nodes=this.nodes.concat(t)},Dr.prototype.insertNode=function(t,e,n){var r=this.findNodeIndex(t),i=this.createNode(e,n);this.nodes.splice(r,0,i)},Dr.prototype.appendNode=function(t,e,n){var r=this.findNodeIndex(t)+1,i=this.createNode(e,n);this.nodes.splice(r,0,i)},Dr.prototype.findNodeIndex=function(e){return this.nodes.findIndex(function(t){return t.name===e})},Dr.prototype.createNode=function(t,e){return new nr(t,e)},Dr.prototype.addLink=function(t,e,n){var r=this.createLink(t,e,n);this.links.push(r)},Dr.prototype.addLinks=function(t){this.links=this.links.concat(t)},Dr.prototype.createLink=function(t,e,n){return new wr(t,e,n)},Dr.prototype.getNext=function(e,n){if(!e)return this.nodes.shift();var r=this.links.find(function(t){return t.from===e&&t.canLink(n)});return r?this.nodes.find(function(t){return t.name===r.to}):void 0},Dr.prototype.clone=function(){var t=new Dr;return t.addNodes(this.nodes),t.addLinks(this.links),t},Dr);function Dr(){this.nodes=[],this.links=[]}var Vr=(Fr.prototype.dispose=function(){this.eventParam=null,this.command=null,this.results=null,this.latestResult=null,this.frameContext=null},Fr.prototype.clearResults=function(){this.results=null},Fr);function Fr(t,e){this.typeName="CommandContext",this.results={},this.command=t,this.frameContext=e}var Rr=new d.InjectionToken("@farris/devkit TranslateToken"),_r=(Br.prototype.dispose=function(t){this.destroy$&&(this.destroy$.next(),this.destroy$.complete()),this.frameContext=null},Br.prototype.ngOnDestroy=function(){this.dispose()},Br.prototype.init=function(t,e){this.frameContext=t,this.parseService=e,this.taskFlow=new Nr,this.schedule()},Br.prototype.execute=function(a){var s=this,p=new h.Subject,u=this.taskFlow.clone();return setTimeout(function(){if(!s.frameContext||s.frameContext.isDisposed)return h.EMPTY;var t=E({},a).eventParam,e=void 0===t?null:t;delete a.eventParam;var n=JSON.parse(JSON.stringify(a));n.params=s.paramsTransform(n.params),n.params=s.parseService.parse(n.params,s.frameContext,e),a.eventParam=e,n.eventParam=e,s.transParamTypes(n.params,n.paramDescriptions);var r=new Vr(n,s.frameContext);r.eventParam=a.eventParam||null;var i=new h.BehaviorSubject(r),o=u.getNext("",r);i.pipe(l.concatMap(function(e){return o.execute(e).pipe(l.take(1),l.map(function(t){return e.results[o.name]=t,e.latestResult=t,(o=u.getNext(o.name,e))?i.next(e):i.complete(),e}),l.throwIfEmpty(function(){i.complete()}))})).pipe(l.takeLast(1)).subscribe({next:function(t){s.waitForDestroy(t),p.next(t.latestResult)},error:function(t){s.waitForDestroy(r),s.displayError(t),p.error(t||"")},complete:function(){s.waitForDestroy(r),p.complete()}})},0),p},Br.prototype.waitForDestroy=function(t){t&&(t.clearResults(),this.frameContext&&this.frameContext.appContext&&this.frameContext.appContext.destorySignal&&this.frameContext.appContext.destorySignal.pipe(l.takeUntil(this.destroy$)).subscribe(function(){t&&(t.dispose(),t=null)}))},Br.prototype.displayError=function(t){t&&console&&console.error&&console.error(t)},Br.prototype.paramsTransform=function(n){var r=/\{\{(\w+)\}\}/g;if(!n)return null;var i=this.frameContext&&this.frameContext.injector&&this.frameContext.injector.get(Rr,null)||null,t=Object.keys(n),o={};return 0===t.length?n:(t.forEach(function(t){var e=n[t];e&&r.test(e)&&i&&(e=e.replace(r,function(t,e){return i.transform(e,null)})),o[t]=e}),o)},Br.prototype.addTask=function(t,e){this.taskFlow.addNode(t,e)},Br.prototype.addLink=function(t,e,n){this.taskFlow.addLink(t,e,n)},Br.prototype.insertTask=function(t,e,n){throw new Error("Not Implemented")},Br.prototype.afterTask=function(t,e,n){throw new Error("Not Implemented")},Br.prototype.replaceTask=function(t,e){throw new Error("Not Implement")},Br.prototype.invoke=function(t,e,n,r){this.setContextToServiceInstance(t,r);var i=this.parseService.parse(n,r,r.eventParam);return t[e].apply(t,b(i))},Br.prototype.setContextToServiceInstance=function(t,e){var n=t.context;n&&n instanceof Vr==0||(t.context=e)},Br.prototype.transParamTypes=function(a,s){s&&Object.keys(a).forEach(function(t){if(s[t]&&s[t].type){var e=s[t].type,n=a[t];if(n!==undefined&&null!==n&&typeof n!==e)switch(e){case"string":a[t]=n+"";break;case"int":case"double":case"number":var r=Number(n);if(isNaN(r))throw Error("类型转换失败，参数"+t+"值为"+n+"，无法转换为"+e+"类型。");a[t]=r;break;case"boolean":var i=void 0,o=(n+"").toLowerCase();if("true"===o)i=!0;else{if("false"!==o)throw Error("类型转换失败，参数"+t+"值为"+n+"，无法转换为"+e+"类型。");i=!1}a[t]=i}}})},Br);function Br(){this.destroy$=new h.Subject}var Ar=new d.InjectionToken("@Farris Command Handlers"),Lr=(kr.prototype.set=function(t,e){if(this.handlerMap.has(t))throw new Error(t+"对应的CommandHandler已经存在");this.handlerMap.set(t,e)},kr.prototype.get=function(t){if(!1===this.handlerMap.has(t))throw new Error("找不到"+t+"对应的CommandHandler");return this.handlerMap.get(t)},kr.prototype.regist=function(t){var e=t.commandName;if(!e){var n=S.getClassMetadataByName(t.constructor,tr);if(!n)throw new Error("CommandHandler必须指定要处理的命令名称");e=n.commandName}this.set(e,t)},kr.prototype.dispose=function(){this.handlerMap&&this.handlerMap.forEach(function(t){t.dispose()}),this.handlerMap.clear()},kr.decorators=[{type:d.Injectable}],kr.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Ar]}]}]},kr);function kr(t){var e=this;this.handlerMap=new Map,t&&t.forEach(function(t){e.regist(t)})}var $r=(Ur.decorators=[{type:d.Injectable}],Ur);function Ur(){}var Hr=new d.InjectionToken("@farris/devkit CommandHandler Extenders"),Kr=(Gr.prototype.get=function(t){return!1===this.extendersMap.has(t)?[]:this.extendersMap.get(t)},Gr.prototype.set=function(t,e){this.extendersMap.has(t)?this.extendersMap.get(t).push(e):this.extendersMap.set(t,[e])},Gr.prototype.regist=function(t){var e=S.getClassMetadataByName(t.constructor,er);if(!e)throw new Error("CommandHandlerExtender必须指定要扩展的命令名称");var n=e.commandName;this.set(n,t)},Gr.prototype.dispose=function(){this.extendersMap.clear()},Gr.decorators=[{type:d.Injectable}],Gr.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Hr]}]}]},Gr);function Gr(t){var e=this;this.extendersMap=new Map,t&&t.forEach(function(t){e.regist(t)})}var zr="NgParam",qr=M(zr,function(t){return t}),Jr=(Wr.getUIFields=function(t){return S.getPropsMetadatasByName(t,zr)},Wr);function Wr(){}var Yr=(Zr.prototype._init=function(){var t=Jr.getUIFields(this.constructor);this.initializeUIField(t)},Zr.prototype.initialize=function(t){var e=t.metadata.uiStates||Jr.getUIFields(this.constructor);this.initializeUIField(e)},Zr.prototype.initializeUIField=function(n){var r=this;Object.keys(n).forEach(function(t){var e=n[t].stateName||t;delete r[t]&&r.defineProperty(t,e)})},Zr.prototype.isExistProperty=function(t){return!(!this.innerData.hasOwnProperty(t)&&!this.hasOwnProperty(t))},Zr.prototype.defineProperty=function(o,a){void 0===a&&(a=null),Object.defineProperty(this,o,{get:function(){return null!==a?this.innerData[a]:this.innerData[o]},set:function(t){var e=null!==a?this.innerData[a]:this.innerData[o];if(!0===this.paramTypeTransform){var n=Jr.getUIFields(this.constructor),r=n&&n[o]||null,i=r&&r.originalDataType||null;i&&(t=this.transform(t,i))}e!==t&&(null!==a?this.innerData[a]=t:this.innerData[o]=t,this.changes.next({field:o,value:t}))}})},Zr.prototype.setPropertyValue=function(t,e){""!==t&&t!==undefined&&(this.isExistProperty(t)||this.defineProperty(t),this[t]=e)},Zr.prototype.transform=function(t,e){if(!e)return t;if("string"===(e=e.toLowerCase()))return null===t||t===undefined?t:t.toString();if("number"===e){if(t===undefined)return undefined;var n=Number(t);if(isNaN(n))throw new Error(t+"无法转换为数字！");return n}if("boolean"===e){if("boolean"==typeof t)return t;if(null===t||t===undefined)return!1;if("false"===(t=t.toString().toLowerCase()))return!1;if("true"===t)return!0;throw new Error(t+"无法转换为布尔类型！")}if("date"===e||"datetime"===e)return t;if("object"!==e)return t;if("object"==typeof t)return t;try{return JSON.parse(t)}catch(r){throw new Error(t+"无法转换为对象！")}},Zr.decorators=[{type:d.Injectable}],Zr.ctorParameters=function(){return[]},Zr);function Zr(){this.paramTypeTransform=!1,this.changes=new h.Subject,this.innerData=Object.assign({}),this._init()}var Xr=new d.InjectionToken("@farris/devkit_param_type_transform"),Qr=function mp(t){this.name=t},ti=(ei.prototype.initialize=function(t,e){this.frameContext=this.stateMachine&&this.stateMachine.frameContext||null,this.state=this.state||(e?e.name:""),this.parser=t,this.stateMachineEvent=this.stateMachine.stateMachineEvent},ei.prototype.transitTo=function(t){var e=this.stateMachine.states[t];e&&(this.state=e.name,this.stateMachine.render())},ei.prototype.parse=function(t,e){if(null===t||t===undefined)return t;var n=this.stateMachineEvent.getFrameContext(t)||this.stateMachine.frameContext;switch(e){case"source":return this.parseSourceValue(t,n);case"target":return this.parser.parse(t,n)}},ei.prototype.parseSourceValue=function(t,e){if(null===t||t===undefined)return t;var n=t.trim();return"state"===(n=this.parser.parse(n,e))&&(n=this.state),n},ei.prototype.get=function(t){return this.getUIState(t)},ei.prototype.getUIState=function(t){if(t){var e=this.stateMachineEvent.getFrameContext(t);if(e){if(this.stateMachineEvent.ListenUIStateChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},ei.prototype.getData=function(t){if(t){var e=this.stateMachineEvent.getFrameContext(t);if(e){if(this.stateMachineEvent.ListenEntityChange(e,t),this.parser){var n=this.parser.parse(t,e);return null===n||"object"==typeof n&&0===Object.keys(n).length?null:n}throw new Error("未初始化变量解析器。")}}},ei);function ei(t){this.stateMachine=t}var ni=(Object.defineProperty(ri.prototype,"appContext",{get:function(){return this.stateMachine.appContext},enumerable:!0,configurable:!0}),ri.prototype.initialize=function(t){this.frameContext=t},ri.prototype.extractPaths=function(t){var n="";if("string"==typeof t){var e=t.match(/\{UISTATE~(\S+?)\}$/g),r=t.match(/\{DATA~(\S+?)\}$/g);if(null!==e){var i=/\{UISTATE~(\S+?)\}$/;e.forEach(function(t){var e=t.match(i);null!=e&&2===e.length&&(n=e[1])})}if(null!==r){var o=/\{DATA~(\S+?)\}$/;r.forEach(function(t){var e=t.match(o);null!=e&&2===e.length&&(n=e[1])})}}return n},ri.prototype.getFrameContext=function(t){var e=this.extractPaths(t).split("/")[1]||"";if(e.startsWith("#{")&&e.endsWith("}")&&this.frameContext){var n=e.substring(2,e.length-1);e=this.frameContext.namespace?this.frameContext.namespace+"_"+n:n}return this.appContext.getFrameContext(e)},ri.prototype.getFrameField=function(t){return this.extractPaths(t).split("/")[2]},ri.prototype.ListenUIStateChange=function(e,t){var n=this,r=this.getFrameField(t);this.frameContextMap.has(e)||(this.frameContextMap.set(e,this.uiFieldList),e.uiState.changes.subscribe(function(t){t.field&&-1<n.frameContextMap.get(e).indexOf(t.field)&&n.stateMachine.render()})),-1===this.frameContextMap.get(e).indexOf(r)&&this.uiFieldList.push(r)},ri.prototype.ListenEntityChange=function(e,t){var n=this;this.dataFrameContextMap.has(e)||(this.dataFrameContextMap.set(e,this.dataFieldList),e.bindingData.changes.subscribe(function(t){"Load"!==t.type&&"SelectionChanged"!==t.type||n.stateMachine.render(),t.path.join()&&n.isAccordingValue(n.dataFrameContextMap.get(e),t.path.join("/"))&&n.stateMachine.render()})),-1===this.dataFrameContextMap.get(e).indexOf(t)&&this.dataFieldList.push(t)},ri.prototype.isAccordingValue=function(t,e){return t.find(function(t){return-1<t.indexOf(e)})!==undefined},ri.decorators=[{type:d.Injectable}],ri.ctorParameters=function(){return[{type:oi}]},ri);function ri(t){this.stateMachine=t,this.uiFieldList=[],this.dataFieldList=[],this.frameContextMap=new Map,this.dataFrameContextMap=new Map}var ii={transit:{perform:function(t,e,n){void 0===n&&(n=[]);var r=t.states[e];t.context.transitTo(r.name),t.render()}}},oi=(ai.prototype.dispose=function(t){this.isDisposed=!0,this.frameContext=null,this.appContext=null,this.context=null,this.stateMachineEvent=null,this.metadatas=null},ai.prototype.ngOnDestroy=function(){this.dispose()},ai.prototype.initialize=function(t,e){this.appContext=t.appContext,this.frameContext=t;var n=this.appContext.metadata.stateMachine||this.collectionMetadata();this.metadatas=n,this.buildStateMachine(n),this.context.initialize(e,this.initialState),this.stateMachineEvent.initialize(this.frameContext),this.render()},ai.prototype.collectionMetadata=function(){var n={states:{},renderStates:{},actions:{}},t=S.getPropsMetadatas(this.constructor);return t&&Object.keys(t).forEach(function(e){t[e].forEach(function(t){switch(t.ngMetadataName){case"NgState":n.states[e]=t;break;case"NgRenderState":n.renderStates[e]=t;break;case"NgAction":n.actions[e]=t}})}),n},ai.prototype.buildStateMachine=function(e){var n=this;Object.keys(e.states).forEach(function(t){n.buildNgState(t,e.states[t])}),Object.keys(e.renderStates).forEach(function(t){n.buildNgRenderState(t,e.renderStates[t])}),Object.keys(e.actions).forEach(function(t){n.buildNgAction(t,e.actions[t])})},ai.prototype.buildNgState=function(t,e){this.states=this.states||{},this[t]=new Qr(t),this.states[t]=this[t],e.initialState&&(this.initialState=this[t])},ai.prototype.buildNgRenderState=function(t,e){this.renderStates=this.renderStates||{},this[t]=!1,this.renderStates[t]=this[t],this.renders=this.renders||{},this.renders[t]=e.render},ai.prototype.buildNgAction=function(t,e){var n=this;this[t]=function(){ii.transit.perform(n,e.transitTo,e.precondition)}},ai.prototype.render=function(){if(!this.isDisposed){for(var t in this.renderStates)if(!1!==this.renderStates.hasOwnProperty(t)){var e=this.renders[t];e&&(this.renderStates[t]=e(this.context),this[t]=this.renderStates[t])}this.stateChange.next(this.context.state)}},ai);function ai(){var n=this;this.isStateInited=!1,this.isDisposed=!1;var t=S.getPropsMetadatas(this.constructor);t&&Object.keys(t).forEach(function(e){t[e].forEach(function(t){n["build"+t.ngMetadataName](e,t)})}),this.stateChange=new h.BehaviorSubject(!1),this.context=new ti(this),this.stateMachineEvent=new ni(this)}var si=M("NgState",function(t){return t}),pi=M("NgRenderState",function(t){return t}),ui=M("NgAction",function(t){return t}),ci="NgCommand",li=M(ci,function(t){return t}),fi=(Object.defineProperty(hi.prototype,"expression",{get:function(){return this.frameContext.expressionManager},enumerable:!0,configurable:!0}),Object.defineProperty(hi.prototype,"expressionResult",{get:function(){return this.frameContext.expressionResult},enumerable:!0,configurable:!0}),hi.prototype.ngOnDestroy=function(){this.dispose()},hi.prototype.dispose=function(t){this.form=null,this.entityValueChangingListeners&&this.entityValueChangingListeners.clear(),this.entityValueChangedListeners&&this.entityValueChangedListeners.clear(),this.verifycationChanged&&(this.verifycationChanged.complete(),this.verifycationChanged=null)},hi.prototype.setMetadata=function(t){!this.bindingPath&&t&&t.bindingTo&&(this.bindingPath=t.bindingTo)},hi.prototype.init=function(t){var c=this;this.name||(this.name=t.metadata.viewModelCode||this.constructor.name),this.frameContext=t,this.bindingData=t.bindingData,this.uiState=t.uiState,this.form=t.form,this.stateMachine=t.stateMachine,this.buildCommands(t),this.entityValueChangingListeners=new Map,this.entityValueChangedListeners=new Map,this.bindingData&&this.bindingData.setValueChangeInvokerFactory(function(u){return function(t,e,n,r){var i,o="/"+u.join("/");if(i=!1===n?c.entityValueChangingListeners[o]:c.entityValueChangedListeners[o]){var a={paths:u,preValue:t,value:e,id:r,changed:n},s=i.split(";").filter(function(t){return t}),p=!0;return h.from(s).pipe(l.concatMap(function(t){return p?c[t](a).pipe(l.tap(function(t){p=t})):h.EMPTY}),l.every(function(t){return t}))}return h.of(!0)}}),this.initListeners()},hi.prototype.buildCommands=function(i){var e=this,n=i.metadata.commands||S.getPropsMetadatasByName(this.constructor,ci);this.metadatas=n,this.keybindingMap=new Map,Object.keys(n).forEach(function(t){var r=n[t];r.keyBinding&&e.keybindingMap.set(t,r.keyBinding),Object.defineProperty(e,t,{value:function(t){if(i.isDisposed)return h.EMPTY;var e=i;r.frameId&&(e=i.appContext.getFrameContext(r.frameId));var n={name:r.name,params:r.params,paramDescriptions:r.paramDescriptions,eventParam:t||null};return e.commandBus.dispatch(n)}})})},hi.prototype.initListeners=function(){var n=this,r=function(t,e){return"/"+t.split("/").concat(e.split(".")).filter(function(t){return 0<t.length}).join("/")};if(this.form){var i=this.form.getEntityValueChangingListeners();Object.keys(i).forEach(function(t){var e=r(n.bindingPath,t);n.entityValueChangingListeners[e]=i[t]});var o=this.form.getEntityValueChangedListeners();Object.keys(o).forEach(function(t){var e=r(n.bindingPath,t);n.entityValueChangedListeners[e]=o[t]})}},hi.prototype.bindToParent=function(t){var e=this;t&&t.verifycationChanged&&t.verifycationChanged.subscribe(function(t){e.verifycationChanged&&e.verifycationChanged.next(t)})},hi.prototype.transform=function(t){if(Array.isArray(t)){var e=t.find(function(t){return t&&"wf"===t.source});return e&&e.value?this.transform(e.value):this.transform(t[0])}return"boolean"!=typeof t&&"string"==typeof t?new Function("ctx","return "+t).apply(this.frameContext,[this]):t},hi.decorators=[{type:d.Injectable}],hi.ctorParameters=function(){return[]},hi);function hi(){this.verifyInformations=[],this.verifycationChanged=new h.Subject}var yi=(di.prototype.getParam=function(t){return this.params.get(t)},di.prototype.setParam=function(t,e){this.params.set(t,e)},di.decorators=[{type:d.Injectable}],di);function di(){this.params=new Map}var gi=(mi.prototype.getBindingDataMap=function(){return this.bindingDataMap},mi.prototype.getBindingDataByName=function(t){return this.bindingDataMap.get(t)},mi.prototype.regBindingData=function(t,e){this.bindingDataMap.set(t,e)},mi.prototype.unRegisteBindingData=function(t){this.bindingDataMap["delete"](t)},mi.prototype.ifBindingDataExits=function(t){return!!this.getBindingDataByName(t)},mi.prototype.dispose=function(){this.bindingDataMap.clear()},mi);function mi(){this.bindingDataMap=new Map}var vi=(Ei.prototype.regRepository=function(t,e){this.repositoryMap.set(t,e)},Ei.prototype.unRegisteRepository=function(t){this.repositoryMap["delete"](t)},Ei.prototype.getRepositoryMap=function(){return this.repositoryMap},Ei.prototype.getRepositories=function(){return Array.from(this.repositoryMap.values())},Ei.prototype.getRepositoryByName=function(t){return this.repositoryMap.get(t)},Ei.prototype.ifRepositoryExits=function(t){return!!this.getRepositoryByName(t)},Ei.prototype.dispose=function(){this.repositoryMap.clear()},Ei.decorators=[{type:d.Injectable}],Ei.ctorParameters=function(){return[]},Ei);function Ei(){this.repositoryMap=new Map}var bi=(Ci.prototype.refreshComponents=function(){this.frameComponentMap.forEach(function(t,e){"function"==typeof t.onFormLoad&&t.onFormLoad()})},Ci.prototype.regFrameComponent=function(t,e){this.frameComponentMap.set(t,e)},Ci.prototype.unregFrameContext=function(t){var e=t.frameId;this.frameComponentMap["delete"](e)},Ci.prototype.dispose=function(){this.frameComponentMap.clear()},Ci);function Ci(){this.frameComponentMap=new Map}var xi=(Object.defineProperty(Pi.prototype,"frameContexts",{get:function(){return this.frameContextManager.getFrameContexts()},enumerable:!0,configurable:!0}),Pi.prototype.reattach=function(){var t=this;setTimeout(function(){t.frameContexts.forEach(function(t){t.frameComponent.reattach(),t.frameComponent.detectChanges()})})},Pi.prototype.detach=function(){this.frameContexts.forEach(function(t){t.frameComponent.detach()})},Pi);function Pi(t){this.frameContextManager=t}var Ii=(Ti.prototype.registerAppContext=function(t){this.appContextSet.add(t)},Ti.prototype.unregisterAppContext=function(t){this.appContextSet["delete"](t)},Ti.prototype.getAppContexts=function(){return Array.from(this.appContextSet)},Ti);function Ti(){this.appContextSet=new Set}var Mi=(Si.prototype.get=function(t){if(!Array.isArray(t)||t.length<1)throw new Error("Argument error !");if(!this.appContext||!this.appContext.componentRefs||this.appContext.componentRefs.size<1)return null;var e=this.appContext.componentRefs;return t.forEach(function(t){e=e&&e.get(t)||null}),e},Si.prototype.getComponentsByFrameId=function(t){return!this.appContext||!this.appContext.componentRefs||this.appContext.componentRefs.size<1?null:this.appContext.componentRefs.get(t)},Si);function Si(t){this.appContext=t}var ji=new d.InjectionToken("@farris/devkit FORM_ID"),wi=(Oi.prototype.getElementByBinding=function(t,e,n){var r,i,o=[];try{for(var a=P(t),s=a.next();!s.done;s=a.next()){var p=s.value;if(p.fields){var u=this.getElementByBinding(p.fields,e,p);o.push.apply(o,b(u))}else p.contents?(u=this.getElementByBinding(p.contents,e,p),o.push.apply(o,b(u))):p.editor?(u=this.getElementByBinding([p.editor],e,p),o.push.apply(o,b(u))):p.binding&&p.binding.field===e&&o.push({element:p,parentElement:n})}}catch(c){r={error:c}}finally{try{s&&!s.done&&(i=a["return"])&&i.call(a)}finally{if(r)throw r.error}}return o},Oi);function Oi(){}var Ni=function vp(){},Di=function Ep(t){this.Id=t.Id,this.Code=t.Code,this.Name=t.Name,this.Contents=JSON.stringify(t.Contents)},Vi=function bp(){},Fi=function Cp(){},Ri=function xp(){},_i=(Bi.prototype.getFieldsByIds=function(t,e,n){var r=new Map,i=e.entities;if(i&&i.length&&n){var o=n.bindTo,a=this.getEntityFields(i,o),s=this.flattenFields(a);t.forEach(function(t){s.has(t)&&r.set(t,s.get(t))})}return r},Bi.prototype.flattenFields=function(t,e){var n,r;void 0===e&&(e=new Map);try{for(var i=P(t),o=i.next();!o.done;o=i.next()){var a=o.value;e.set(a.id,a),a.type&&a.type.fields&&0<a.type.fields.length&&this.flattenFields(a.type.fields,e)}}catch(s){n={error:s}}finally{try{o&&!o.done&&(r=i["return"])&&r.call(i)}finally{if(n)throw n.error}}return e},Bi.prototype.getEntityFields=function(t,e){var n,r;if(t&&t.length){var i=e.indexOf("/");-1<i&&(e=e.slice(i+1,e.length));try{for(var o=P(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(""===e||e===s.code||e===s.label)return s.type.fields;var p=this.getEntityFields(s.type.entities,e);if(p&&p.length)return p}}catch(u){n={error:u}}finally{try{a&&!a.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}}return[]},Bi);function Bi(){}var Ai=(Li.prototype.buildAppContextMetadata=function(t,e){var n=t.module,r=n.states;return{identify:n.code,namespace:"",stateMachine:this.buildStataMachineMetadata(e),uiStates:this.buildUiStateMetadata(r)}},Li.prototype.buildViewContextMetadata=function(t,e,n,r,i){return{identify:t.id,namespace:"",commands:this.buildCommand(e.commands),commandHandlers:this.buildCommandHandlers(e.commands,r),commandHandlerExtends:[],form:this.buildFormMetadata(e),formControls:this.buildFormControlMetadata(e.fields,e,n,t,i),subForms:null,uiStates:this.buildUiStateMetadata(e.states),bindingTo:e.bindTo,viewModelCode:e.code}},Li.prototype.buildCommand=function(t){var e={};return t.reduce(function(t,e){var n={name:e.code,params:{},paramDescriptions:{}};return e.params.reduce(function(t,e){return t.params[e.name]=e.value,t.paramDescriptions[e.name]={type:"string"},t},n),t[e.code]=n,t},e),e},Li.prototype.buildFormMetadata=function(t){return{formGroupName:t.name,enableValidate:t.enableValidation}},Li.prototype.buildFormControlMetadata=function(t,e,n,p,u){var c=this,r={},i=t.map(function(t){return t.id}),l=(new _i).getFieldsByIds(i,n,e),f=new wi;return t.reduce(function(t,e){var n,r,i=l.has(e.id)?l.get(e.id):null,o=i?i.bindingPath:"",a=f.getElementByBinding(p.contents,e.id,{}),s=[];return a&&1<=a.length&&(n=a[0].element,r=a[0].parentElement,Object.keys(n).forEach(function(t){"maxValue,minValue,required,require".includes(t)&&("maxValue"===t&&null!==n[t]&&n[t]!==undefined?s.push({type:"maxValue",constraints:[n[t]]}):"minValue"===t&&null!==n[t]&&n[t]!==undefined?s.push({type:"minValue",constraints:[n[t]]}):"required"!==t&&"require"!==t||"true"!==n[t]&&!0!==n[t]||s.push({type:"required",constraints:[!0]}))})),t[e.fieldName]={id:e.fieldName,name:c.getTitle(n,r,e.fieldName),binding:o,updateOn:e.updateOn,defaultI18nValue:c.getTitle(n,r,e.fieldName),valueChanging:e.valueChanging,valueChanged:e.valueChanged,valueConverter:c.generateConverter(i,u),validRules:s},t},r),r},Li.prototype.getTitle=function(t,e,n){return t?"GridField"==e.type?e.caption||n:t.title||n:n},Li.prototype.generateConverter=function(t,e){var n=e.valueConverterMap;if(n)return!t.type||"Date"!=t.type.name&&"DateTime"!=t.type.name||t.converter||(t.converter=n.Date),t.multiLanguage&&!t.converter&&(t.converter=n.MultiLang),t.converter},Li.prototype.buildStataMachineMetadata=function(i){var o=this,t={states:{},renderStates:{},actions:{}};return i&&(i.state.reduce(function(t,e){return t.states[e.state]={initialState:e.state===i.initialState},t},t),Object.keys(i.renderState).reduce(function(t,e){var n=i.renderState[e],r=o.buildRenderFunction(n);return t.renderStates[e]={render:r},t},t),Object.keys(i.action).reduce(function(t,e){var n=i.action[e];return t.actions[e]={precondition:n.precondition,transitTo:n.transitTo},t},t)),t},Li.prototype.buildUiStateMetadata=function(t){var e={};return t.reduce(function(t,e){return t[e.code]={stateName:e.code},t},e),e},Li.prototype.buildRenderFunction=function(t){if(t&&t.condition.length){var e=t.condition.reduce(function(t,e){var n=e.target;n.startsWith("'")||(n="'"+n),n.endsWith("'")||(n+="'");var r=e.source;r.indexOf("'")<0&&(r="'"+r+"'"),-1<r.indexOf("getUIState")&&(r=r.replace("getUIState","context.getUIState")),-1<r.indexOf("getData")&&(r=r.replace("getData","context.getData"));var i=(e.lBracket||"")+"context.parse("+r+",'source')"+e.compare+e.target+(e.rBracket||"");if(e.relation)switch(e.relation.trim().toLocaleLowerCase()){case"or":i+="||";break;case"and":i+="&&"}return t+i},"");if(e)return new Function("context","return "+e+";")}return new Function("context","return true;")},Li.prototype.buildCommandHandlers=function(t,s){var e=[];return t.reduce(function(t,e){var n=e.code,r=e.cmpId,i=s[r],o=Object.assign({},i.methods[e.handlerName]);o.params=o.params&&o.params.map(function(t){return Object.assign({},t)}),o.params&&o.params.length&&e.params.reduce(function(t,e){var n=t.params.find(function(t){return t.name===e.name});return n&&(n.expression=e.value),t},o);var a=new Os(n,o);return t.push(a),t},e),e},Li);function Li(){}var ki=($i.prototype.getViewModelMap=function(){return this.viewModelMap},$i.prototype.getViewModelByName=function(t){return this.viewModelMap.get(t)},$i.prototype.register=function(t,e){this.viewModelMap.set(t,e)},$i.prototype.exsit=function(t){return!!this.getViewModelByName(t)},$i.prototype.dispose=function(){this.viewModelMap.clear()},$i);function $i(){this.viewModelMap=new Map}var Ui=(Hi.prototype.getContextMetadataMap=function(){return this.contextMetadataMap},Hi.prototype.getContextMetadataByName=function(t){return this.contextMetadataMap.get(t)},Hi.prototype.register=function(t,e){this.contextMetadataMap.set(t,e)},Hi.prototype.exsit=function(t){return!!this.getContextMetadataByName(t)},Hi);function Hi(){this.contextMetadataMap=new Map}var Ki,Gi=new d.InjectionToken("@farris/devkit FRAME_ID"),zi=new d.InjectionToken("@farris/devkit NAMESPACE"),qi=new d.InjectionToken("@farris/frame_component_init_handler_token"),Ji=(c(Wi,Ki=yi),Object.defineProperty(Wi.prototype,"frameContexts",{get:function(){return this.frameContextManager.getFrameContextMap()},enumerable:!0,configurable:!0}),Object.defineProperty(Wi.prototype,"formModule",{get:function(){return this.formMetadataContent?this.formMetadataContent.module:null},enumerable:!0,configurable:!0}),Wi.prototype.dispose=function(t){this.disposed||(this.isFormDestoryed=!0,this.disposed=!0,this.router=null,this.unregisterFromManager(),this.componentRefs.clear(),this.stateMachine&&(this.stateMachine.dispose(),this.stateMachine=null),this.frameComponentRefresher.dispose(),this.frameContextManager.dispose(),this.repositoryManager.dispose(),this.viewModelManager.dispose(),this.bindingDataManager.dispose(),this.messagePipe&&(this.messagePipe.complete(),this.messagePipe=null),this.injector=null,this.destorySignal&&(this.destorySignal.next(),this.destorySignal.complete()))},Wi.prototype.ngOnDestroy=function(){this.dispose()},Wi.prototype.initializeByMetadata=function(t,e,n,r){this.metadata=this.contextMetadataBuilder.buildAppContextMetadata(t,e),this.stateMachine||(this.stateMachine=new oi),this.formMetadataContent=t,this.controllers=n,this.dynamicOptions=r},Wi.prototype.registerToManager=function(){this.appContextManager&&this.appContextManager.registerAppContext(this)},Wi.prototype.unregisterFromManager=function(){this.appContextManager&&this.appContextManager.unregisterAppContext(this)},Wi.prototype.regFrameContext=function(t){var e=t.repository,n=e.name;if(!1===this.repositoryManager.ifRepositoryExits(n)&&this.repositoryManager.regRepository(n,e),!1===this.bindingDataManager.ifBindingDataExits(n)){var r=null;this.runMode===x.RunMode.highSpeed&&(r=Tn.createFromRepository(e,"/"),this.bindingDataManager.regBindingData(n,r))}this.frameContextManager.regFrameContext(t)},Wi.prototype.regContextMetadata=function(t,e){this.contextMetadataManager.exsit(t)||this.contextMetadataManager.register(t,e)},Wi.prototype.getFormAppContext=function(){return this},Wi.prototype.destory=function(){this.dispose()},Object.defineProperty(Wi.prototype,"isDestoryed",{get:function(){return this.isFormDestoryed},enumerable:!0,configurable:!0}),Object.defineProperty(Wi.prototype,"ApplicationId",{get:function(){return this.applicationId||(this.applicationId=We.create()),this.applicationId},set:function(t){this.applicationId=t},enumerable:!0,configurable:!0}),Object.defineProperty(Wi.prototype,"Token",{get:function(){return this.token||(this.token=We.create()),this.token},set:function(t){this.token=t},enumerable:!0,configurable:!0}),Wi.prototype.registerCommandHandler=function(t,e){this.frameComponentRefresher.regFrameComponent(t,e)},Wi.prototype.refresh=function(){this.frameComponentRefresher.refreshComponents()},Wi.prototype.getFrameContext=function(t){return this.frameContextManager.getFrameContextById(t)},Wi.prototype.getContextById=function(t){return this.frameContextManager.getFrameContextById(t)},Wi.prototype.getAllFrameContexts=function(){return this.frameContextManager.getFrameContextMap()},Wi.prototype.handleSelectChange=function(r,i){var o=r.force||!1;this.frameContexts.forEach(function(t){if(t!==i&&t.repository===i.repository){var e=t.bindingData.getValue(r.path),n=r.value.id;(e&&e.currentId!==n||o)&&e.setCurrentId(n,!0,!1,o)}})},Wi.prototype.buildRenderViewContext=function(e){var t=this.formModule.viewmodels,n=this.formModule.components,r=this.formModule.schemas[0],i=n.find(function(t){return t.id===e}),o=t.find(function(t){return i.viewModel===t.id}),a=t.find(function(t){return t.id===o.parent});if(a){var s=n.find(function(t){return t.viewModel===a.id});s&&s.id}this.buildRenderViewContextRecursively(o,r)},Wi.prototype.buildRenderViewContextRecursively=function(e,n){var r=this,t=this.controllers,i=this.formModule.components.find(function(t){return t.viewModel===e.id}),o=this.contextMetadataBuilder.buildViewContextMetadata(i,e,n,t,this.dynamicOptions),a=(this.namespace?this.namespace+"_":"")+i.id;o.namespace=this.namespace||"",this.regContextMetadata(a,o);var s=this.formModule.viewmodels.filter(function(t){return t.parent===e.id});s&&s.length&&s.forEach(function(t){r.buildRenderViewContextRecursively(t,n)})},Wi.prototype.getComponentProviders=function(t){var e=this.contextMetadataManager.getContextMetadataByName(t),n=new Cn,r=new mn,i=e.namespace,o=this.repository||this.injector.get(Ze,null),a=this.stateMachine,s=new Yr,p=new fi;return p.setMetadata(e),[{provide:Gi,useValue:t},{provide:zi,useValue:i},{provide:gs,useClass:gs},{provide:Wi,useValue:this},{provide:Cn,useValue:n},{provide:mn,useValue:r},{provide:Ze,useValue:o},{provide:oi,useValue:a},{provide:Yr,useValue:s},{provide:fi,useValue:p},{provide:dr,useValue:new dr([new vr,new sr,new ur,new lr,new hr])}]},Wi.decorators=[{type:d.Injectable}],Wi.ctorParameters=function(){return[{type:d.Injector,decorators:[{type:d.Optional}]},{type:Ii,decorators:[{type:d.Optional}]},{type:Wi,decorators:[{type:d.Optional},{type:d.SkipSelf}]}]},Wi);function Wi(t,e,n){var r=Ki.call(this)||this;return r.typeName="AppContext",r.isFormDestoryed=!1,r.applicationId=null,r.token=null,r.useIsoluteEventBus=!1,r.metadata={},r.disposed=!1,r.destorySignal=new h.Subject,r.injector=t,r.appContextManager=e,r.formId=r.injector&&r.injector.get(ji,null)||null,r.runMode=r.injector&&r.injector.get(Pt,x.RunMode.compatible)||x.RunMode.compatible,Dn.setRunMode(r.runMode),r.params.set("formId",r.formId),r.params.set("appId",r.ApplicationId),r.params.set("token",r.Token),n?(r.parent=n,r.root=n.root):(r.parent=null,r.root=r),r.registerToManager(),r.frameContextManager=new Yi(r),r.frameComponentRefresher=new bi,r.repositoryManager=new vi,r.bindingDataManager=new gi,r.changeDetectionController=new xi(r.frameContextManager),r.messagePipe=new h.Subject,r.componentRefs=new Map,r.componentManager=new Mi(r),r.contextMetadataManager=new Ui,r.opened=!1,r.router=r.injector&&r.injector.get(p.Router),r.viewModelManager=new ki,r.contextMetadataBuilder=new Ai,r.variableParseService=new dr([new vr,new sr,new ur,new lr,new hr]),r}var Yi=(Zi.prototype.regFrameContext=function(t){var e=t.frameId;if(!0===this.frameContextMap.has(e)){var n=this.frameContextMap.get(e);this.frameContextMap["delete"](e),this.frameContextSet["delete"](n)}t.index=this.frameContextSet.size,this.frameContextMap.set(e,t),this.frameContextSet.add(t)},Zi.prototype.unregFrameContext=function(t){var e=t.frameId;if(this.frameContextMap["delete"](e),this.frameContextSet["delete"](t),this.appContext.runMode===x.RunMode.highSpeed){var n=t.namespace,r=t.repository&&t.repository.name,i=this.getFrameContextsByNamespace(n);(!i||i.length<1)&&this.appContext.bindingDataManager.unRegisteBindingData(r)}},Zi.prototype.getFrameContextMap=function(){return this.frameContextMap},Zi.prototype.getFrameContexts=function(){return Array.from(this.frameContextSet)},Zi.prototype.getFrameContextsByNamespace=function(e){return Array.from(this.frameContextSet).filter(function(t){return t&&t.namespace===e})},Zi.prototype.getFrameContextById=function(t){var e=this.frameContextMap.get(t);return e||this.getFrameContextFromAllAppContexts(t)},Zi.prototype.getRootFrameContext=function(){return this.getFrameContexts().find(function(t){return null===t.parent})},Zi.prototype.dispose=function(){this.frameContextMap.clear(),this.frameContextSet.clear()},Zi.prototype.getFrameContextFromAllAppContexts=function(n){var r;if(this.appContext.appContextManager)return this.appContext.appContextManager.getAppContexts().some(function(t){var e=t.frameContextManager.getFrameContextMap();return!0===e.has(n)&&(r=e.get(n),!0)}),r},Zi.decorators=[{type:d.Injectable}],Zi.ctorParameters=function(){return[{type:Ji}]},Zi);function Zi(t){this.frameContextMap=new Map,this.frameContextSet=new Set,this.appContext=t}var Xi=(Qi.prototype.post=function(t,e){this.eventBus.post(this.hostType,this.eventTokenValueProvider(),t,e)},Qi);function Qi(t,e,n){this.eventBus=t,this.hostType=e,this.eventTokenValueProvider=n}var to,eo="NgDeclaration";(to=x.EventTypeEnum||(x.EventTypeEnum={}))[to.COMPONENT=0]="COMPONENT",to[to.ROUTE=1]="ROUTE";var no=(ro.prototype.init=function(t){t&&this.bindDeclaration(t,null)},ro.prototype.initWithDeclarations=function(t,e){t&&this.bindDeclaration(t,null)},ro.prototype.bindDeclaration=function(t,e){var l=this,n=t.context;if(n){var r=e||this.getNgPublicEvent();r&&Object.keys(r).forEach(function(t){var e=r[t];Object.defineProperty(l,t,{value:function(){var r=n,t=r.root,i=e.token,o=e.token,a=e.name,s=JSON.parse(JSON.stringify(e.params)),p=e.type,u=r.eventBus||t.eventBus;if(u){var c=(r.injector||t.injector).get(dr);setTimeout(function(){s=c.parse(s,r);var t=r.frameComponent,e=r,n=(new Date).valueOf();if(p&&p===x.EventTypeEnum.ROUTE)for(;e;)e.eventBus.post(i,o,a,s,t,p,n),e=l.getParentContext(e);else u.post(i,o,a,s,t)},0)}}})})}},ro.prototype.getNgPublicEvent=function(){return S.getPropsMetadatasByName(this.constructor,eo)},ro.prototype.getParentContext=function(t){if(t.parent)return t.parent;var e=t.appContext.parent;return e?e.frameContextManager.getRootFrameContext():null},ro.decorators=[{type:d.Injectable}],ro.ctorParameters=function(){return[]},ro);function ro(){}var io="NgSubscription",oo=function Pp(){};var ao,so,po=(uo.prototype.init=function(t){if(t)return this.bindSubscription(t,null)},uo.prototype.initWithSubscriptions=function(t,e){if(t)return this.bindSubscription(t,e)},uo.prototype.bindSubscription=function(u,t){var c=this,l=u.context;if(l){var f=t||this.getNgEvents(u);if(f){var h=[];return Object.keys(f).forEach(function(t){var e=f[t],r=l,i=u,n=e.token,o=e.token,a=e.name,s=e.paramMapCollection,p=r.eventBus.on(n,o,a,i,function(t){c.subscriptionHandler(t,s,r);var e=u[a];if(e)try{e(i,t)}catch(n){throw new Error("Error invoking method "+a)}});h.push(p)}),h}}},uo.prototype.getNgEvents=function(t){return S.getPropsMetadatasByName(t.constructor,io)},uo.prototype.subscriptionHandler=function(t,e,n){t&&e&&!(e.length<=0)&&n&&this.paramMap2UiState(t,e,n)},uo.prototype.paramMap2UiState=function(t,e,n){for(var r=0;r<e.length;r++){var i=e[r].from,o=e[r].frameId,a=e[r].to;if(i&&o&&a){var s=this.getFrameContext(o,n);null!=s&&this.setUiStateProperty(a,t[i],s.uiState)}}},uo.prototype.getFrameContext=function(t,e){var n=null;try{n=e.appContext.getFrameContext(t)}catch(r){throw new Error("Error in Getting FrameContext")}return n},uo.prototype.setUiStateProperty=function(t,e,n){try{n.setPropertyValue(t,e)}catch(r){throw new Error("Error in Setting Property Value of the current UISTATE"+n)}},uo.decorators=[{type:d.Injectable}],uo);function uo(){}(so=ao=ao||{})[so.Compile=0]="Compile",so[so.Parsing=1]="Parsing";var co=(Object.defineProperty(lo.prototype,"subscriptions",{get:function(){return this.subscriptionMap},enumerable:!0,configurable:!0}),lo.prototype.post=function(t,e,n,r){var i={args:t,sender:e,eventType:n,eventId:r};this.eventSubject.next(i)},lo.prototype.subscribe=function(o,a){var s=this,t=this.subscriptionMap.get(a);null!=t&&(t.unsubscribe(),this.subscriptionMap["delete"](a));var e=this.eventSubject.subscribe(function(t){var e=t.args,n=t.sender,r=t.eventType||null,i=t.eventId||0;s.lastEventId>=i||(s.lastEventId=i,r!==x.EventTypeEnum.ROUTE&&!1===s.isInSampeScope(n,a)||o.call(a,e))});return this.subscriptionMap.set(a,e),this},lo.prototype.subscribeOnce=function(e,n){var t=this.eventSubject.subscribe(function(t){return e.call(n,t)});return this.onceSubscriptionMap.set(n,t),this},lo.prototype.unSubscribe=function(t){var e=this.subscriptionMap.get(t);e?(e.unsubscribe(),e=null,this.subscriptionMap["delete"](t)):(e=this.onceSubscriptionMap.get(t))&&(e.unsubscribe(),e=null,this.onceSubscriptionMap["delete"](t))},lo.prototype.unSubscribeForOnce=function(){var t,e;try{for(var n=P(Array.from(this.onceSubscriptionMap.keys())),r=n.next();!r.done;r=n.next()){var i=r.value;this.unSubscribe(i)}}catch(o){t={error:o}}finally{try{r&&!r.done&&(e=n["return"])&&e.call(n)}finally{if(t)throw t.error}}},lo.prototype.matchEmitterToken=function(t,e){return!(this.emitter&&t&&this.emitter!==t||this.tokenValue&&e&&this.tokenValue!==e)},lo.prototype.examByTargetToken=function(t,e){return this.emitter===t&&this.tokenValue===e},lo.prototype.dispose=function(t){var e=this;if(this.unSubscribe(t),0===this.subscriptionMap.size&&this.parentEventPipeList){var n=this.parentEventPipeList.findIndex(function(t){return t===e});-1!==n&&this.parentEventPipeList.splice(n,1)}},lo.prototype.disposeByCaller=function(t){var e=this.subscriptionMap.get(t);null!=e&&(e.unsubscribe(),this.subscriptionMap["delete"](t))},lo.prototype.isInSampeScope=function(t,e){if(this.eventPipeType===ao.Parsing)return!0;if(!t)return!0;if(t===e)return!0;if(!(t.context&&t.context.appContext&&e.context&&e.context.appContext))return!1;var n=t.context.appContext,r=e.context.appContext;return n===r||!!(n.useIsoluteEventBus&&n.isoluteEventBus||r.useIsoluteEventBus&&r.isoluteEventBus)},lo);function lo(t,e,n,r){this.name=t,this.tokenValue=e,this.emitter=n,this.parentEventPipeList=r,this.lastEventId=-1,this.eventPipeType=ao.Compile,this.eventSubject=new h.Subject,this.subscriptionMap=new Map,this.onceSubscriptionMap=new Map,this.parentEventPipeList&&this.parentEventPipeList.push(this)}var fo=(ho.prototype.getProxy=function(t,e){var n=t.constructor.typeName||t.constructor.name;return this.proxyMap.has(n)||this.proxyMap.set(n,new Xi(this,t,e)),this.proxyMap.get(n)},ho.prototype.post=function(t,e,n,r,i,o,a){var s,p,u=this.eventMap.get(n);if(u)if(t){var c;c=t instanceof d.Type?t.typeName||t.name:t,void 0===a&&(a=(new Date).valueOf());try{for(var l=P(u),f=l.next();!f.done;f=l.next()){var h=f.value;h.matchEmitterToken(c,e)&&(h.post(r,i,o,a),h.unSubscribeForOnce())}}catch(y){s={error:y}}finally{try{f&&!f.done&&(p=l["return"])&&p.call(l)}finally{if(s)throw s.error}}}else console.error("post方法的参数emitterType不能为空。")},ho.prototype.on=function(t,e,n,r,i){return this.getEventPipe(n,t,e).subscribe(i,r)},ho.prototype.off=function(e,n,r,i){var t=this.eventMap.get(r);if(t){var o=t.findIndex(function(t){return!!t.subscriptions.get(i)&&t.name===r&&t.tokenValue===n&&t.emitter===e});-1!==o&&t.splice(o,1)}},ho.prototype.once=function(t,e,n,r,i){return this.getEventPipe(n,t,e).subscribeOnce(i,r)},ho.prototype.requestFor=function(t,e,n,r,i,o){var a=this.findExistEventPipe(n,"RequestSubject",e);a?(this.once(t,e,n,this,function(t){"success"===t.status?i(t.data):o&&o("No target responser listening")}),a.post({target:t,token:e,data:r})):o&&o("No target responser listening.")},ho.prototype.responseOn=function(n,r,i){var o=this;this.on("RequestSubject",null,r,this,function(t){var e={status:"fail",data:null};n===t.target&&(e.data=i(t.data),e.status="success"),o.post(t.target,t.token,r,e)})},ho.prototype.getEventPipe=function(t,e,n){var r=this.eventMap.get(t);return r||(r=new Array,this.eventMap.set(t,r)),new co(t,n,e,r)},ho.prototype.findExistEventPipe=function(t,e,n){var r,i,o=this.eventMap.get(t);if(!o)return null;try{for(var a=P(o),s=a.next();!s.done;s=a.next()){var p=s.value;if(p.matchEmitterToken(e,n))return p}}catch(u){r={error:u}}finally{try{s&&!s.done&&(i=a["return"])&&i.call(a)}finally{if(r)throw r.error}}return null},ho.decorators=[{type:d.Injectable}],ho.ctorParameters=function(){return[]},ho);function ho(){this.proxyMap=new Map,this.eventMap=new Map}var yo=(go.setToken=function(t,e){go.tokens.set(t,e)},go.getToken=function(t){return go.tokens.get(t)},go.tokens=new Map,go);function go(){}var mo,vo,Eo,bo,Co,xo,Po,Io=new d.InjectionToken("@farris/devkit ExceptionHandler"),To=new d.InjectionToken("@farris/devkit UserSettingsToken");mo=x.Expression||(x.Expression={}),(vo=mo.ExpressionBindingType||(mo.ExpressionBindingType={})).State="State",vo.Field="Field",(Eo=mo.ExpressionType||(mo.ExpressionType={})).Required="require",Eo.Readonly="readonly",Eo.Compute="compute",Eo.Dependency="dependency",Eo.Visible="visible",Eo.Relative="relative",Eo.Validate="validate",Eo.DataPicking="dataPicking",(bo=mo.EventType||(mo.EventType={})).ValueChanged="VALUE_CHANGED",bo.SelectionChanged="SELECTION_CHANGED",bo.Load="Load",bo.Append="Append",bo.Remove="Remove",bo.Update="Update",(Co=mo.EventSource||(mo.EventSource={})).Field="Field",Co.State="State",Co.BindingData="BindingData",Co.Repository="Repository",(xo=mo.MessageType||(mo.MessageType={})).error="error",xo.info="info",xo.warning="warning",(Po=mo.EffectPath||(mo.EffectPath={}))[Po.currentRow=0]="currentRow",mo.MESSAGE={"zh-CHS":{require:"请输入'$property'",validate:"'$property'校验不通过",dataPicking:"帮助前表达式校验不通过"},en:{require:"Please input '$property'",validate:"'$property' calibration failed",dataPicking:"Failed to verify the expression before help"},"zh-CHT":{require:"請輸入'$property'",validate:"'$property'校驗不通過",dataPicking:"幫助前表達式校驗不通過"}},mo.DEPENDENCY_SPLITER="/";var Mo=new d.InjectionToken("@farris/form_manifest_service"),So=new d.InjectionToken("@farris/form_expression_manifest_service"),jo=(wo.prototype.load=function(){var i=this;return this.formExpressionManifestService.load().pipe(l.switchMap(function(t){var r=[];return Array.from(t).forEach(function(n){n.expressions.forEach(function(t){var e={id:t.id,ns:n.ns,path:n.path,bindingType:n.type,type:t.type,expression:t.value||t.expr||"",message:t.message||null,messageType:t.messageType||null,deps:[]};t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate&&t.type!==x.Expression.ExpressionType.DataPicking||(t.message||(e.message=i.getExpressionMessage(t.type)),t.messageType||(e.messageType="error")),e.message&&i.transform(e),r.push(e)})}),i._expressions=r,i.cleanSpecialCharacters(),h.of(r)}),l.catchError(function(t){return h.of([])}))},Object.defineProperty(wo.prototype,"expressions",{get:function(){return this._expressions?h.of(this._expressions):this.load()},enumerable:!0,configurable:!0}),wo.prototype.getExpressionById=function(e){return!this._expressions||this._expressions.length<1?null:this._expressions.find(function(t){return t.id===e})},wo.prototype.getExpressionMessage=function(t,e){if(t!==x.Expression.ExpressionType.Validate&&t!==x.Expression.ExpressionType.Required&&t!==x.Expression.ExpressionType.DataPicking)return null;if(!this.translate)return e;var n=this.translate.getCurrentLanguage()||"zh-CHS";return x.Expression.MESSAGE[n][t]},wo.prototype.transform=function(t){this.translate&&t.message&&t.message.startsWith("{{")&&t.message.endsWith("}}")&&(t.message=this.translate.transform(t.message.substr(2,t.message.length-4),null)||this.getExpressionMessage(t.type))},wo.prototype.cleanSpecialCharacters=function(){var r=this;if(this._expressions&&!(this._expressions.length<1)&&Array.isArray(this._expressions)){var t=this.injector.get(Ze,null);if(t){var e=t.entityTypeInfo,i=new RegExp("[\\'\\\"]?\\s*("+e.entityInfo.nodeCode+"|"+e.entityInfo.originalCode+")[\\.\\[\\]a-zA-Z0-9_]+\\s*[\\'\\\"]?","g");this._expressions.forEach(function(n){var t=n.expression.match(i);Array.isArray(t)&&0<t.length&&t.forEach(function(t){if(-1!==t.indexOf(".")){if(/\[\d\]/g.test(t)){var e=t.replace(/\[\d\]/g,"");n.expression=r.replaceAll(n.expression,t,e)}/\*/g.test(t)&&(e=t.replace(/\*/g,""),n.expression=r.replaceAll(n.expression,t,e))}})})}}},wo.prototype.replaceAll=function(t,e,n){return t.split(e).join(n)},wo.decorators=[{type:d.Injectable}],wo.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[So]}]},{type:undefined,decorators:[{type:d.Optional},{type:d.Inject,args:[Rr]}]}]},wo);function wo(t,e,n){this.injector=t,this.formExpressionManifestService=e,this.translate=n,this._expressions=null}var Oo=new d.InjectionToken("@Farris listener"),No=(Object.defineProperty(Do.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),Do.prototype.findEntityPaths=function(t,n,r){var i=this;void 0===r&&(r=[]);var e=t.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){r.push(t.name);var e=t.typeInfo.getPropInfosByGroup(x.DataPropGroup.List);e&&0<e.length?e.forEach(function(t){i.findEntityPaths(t.typeInfo,n,r)}):n.push(r)}):r&&0<r.length&&n.push(r)},Do);function Do(){this.subject=new h.Subject}var Vo=(Fo.prototype.compile=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);if(!t.factory){var r=new u.Expression(t.expression,n);t.factory=r.compile()}return t.factory.eval(n)},Fo.prototype.eval=function(t,e){if("[object Object]"!==Object.prototype.toString.call(e))throw new Error("上下文必须为对象！");var n=this.buildContext(e);return new u.ExpressionEngine(n).eval(t)},Fo.prototype.buildContext=function(e){var n=new u.ExpressionContext;return e&&0<Object.keys(e).length&&Object.keys(e).forEach(function(t){n.set(t,e[t])}),n},Fo.decorators=[{type:d.Injectable}],Fo);function Fo(){}var Ro=(_o.prototype.set=function(t,e){this[t]=e},_o.decorators=[{type:d.Injectable}],_o.ctorParameters=function(){return[{type:d.Injector}]},_o);function _o(t){this.injector=t}var Bo=(Ao.prototype.eval=function(t,e,n){var r=this.expressionRegistry.getExpressionById(t);if(r){var i={},o=e&&e.bindingPath||null;if(o&&n){var a=o.split("/").filter(function(t){return t}),s=this.frameContext.bindingData.getValue(a),p="id";s&&(p=s.primaryKey);var u=n[p]||s.currentId;u&&(i.currentRows=[{bindingPath:a.join("/"),primaryValue:u}])}var c=this.execute(r.expression,i);return r.type!==x.Expression.ExpressionType.Readonly&&r.type!==x.Expression.ExpressionType.Required&&r.type!==x.Expression.ExpressionType.Visible||(c=!0===c),this.expressionResult.set(t,c),c}return undefined},Ao.prototype.validate=function(t,e){var n=this.expressionRegistry.getExpressionById(t);if(n){var r=e&&e.patch||null,i={};r&&(i.patch=r);var o=e.currentRow||null,a=e.currentRows||[];o&&(i.currentRows=i.currentRows||[],i.currentRows.push(o)),a&&0<a.length&&(i.currentRows=i.currentRows||[],Array.prototype.push.apply(i.currentRows,a));var s=this.execute(n.expression,i);return this.expressionResult.set(t,s),s}return undefined},Ao.prototype.onDataPicking=function(t){var e=t&&t.expressionId||null;if(!e)return h.of(!0);var n=this.eval(e);if(n)return h.of(n);var r=this.expressionRegistry.getExpressionById(e);if(!r)return h.of(!0);var i=r.messageType||x.Expression.MessageType.warning,o=r.message;return o&&this.notifyService[i](o,{hideTitle:!0}),h.EMPTY},Ao.prototype.execute=function(t,e){var n,r=this.resolveService.resolve(t),i=fn.getGroupFunctionDependency(t,this.frameContext.repository.entityTypeInfo),o=this.buildEntityContext(r,i,e),a=this.buildStateContext(),s=e&&e.contexts||null,p=this.injector.get(Rr,null),u=E(((n={})[this.entityOriginalNodeCode]=o,n),a,{BigNumber:y.BigNumber,frameContext:this.frameContext,bindingData:this.frameContext.bindingData,repository:this.frameContext.repository,CurrentLanguage:p.getCurrentLanguage()||"zh-CHS"},s);return o?this.expressionExecutor.eval(t,u):undefined},Ao.prototype.executeAsync=function(t,e){var n=this.execute(t,e);return h.of(n)},Ao.prototype.buildEntityContext=function(t,n,e){var r=this,i=e&&e.currentRows||null,o=-1!==t.findIndex(function(e){return!!r.isEntityDependency(e)&&-1!==n.findIndex(function(t){return t===e})&&1==e.split("/").filter(function(t){return t}).length-1}),a={};i&&0<i.length&&i.forEach(function(t){a[t.bindingPath||"/"]=t.primaryValue});var s=this.getEntity(a),p=e&&e.patch||null;if(!s)return{};if(p&&0<Object.keys(p).length&&Object.keys(p).forEach(function(t){var e=t.split("/").filter(function(t){return t}),n=p[t];r.setValue(s,e,n)}),o){var u=this.frameContext.repository.entityCollection.toJSON();s.__type__="List",s.__items__=u}return s},Ao.prototype.setValue=function(t,e,n){if(1===e.length)t[e[0]]=n;else{var r=e.pop();e.reduce(function(t,e){return t&&t[e]},t)[r]=n}},Ao.prototype.isEntityDependency=function(t){return t.startsWith(Ne)},Ao.prototype.getEntity=function(d){var g=this,t=this.frameContext.repository.entityTypeInfo,m=this.frameContext.bindingData,e=[],v=null;return(v=d["/"]?(v=this.frameContext.bindingData.list.findById(d["/"]))&&v.toJSON():this.frameContext.bindingData.list.currentItem.toJSON())?(fn.getChildrenEntityPaths(t,e),v.__type__="Entity",!e||e.length<1||e.forEach(function(n){var t=null;if(d&&d[n.join("/")]){var e=n.slice(0,1);if(2==n.length&&d[e.join("/")]){var r=d[e.join("/")];t=g.getPropertyValue(v,e.concat([r,n[1],d[n.join("/")]]))}else{var i=m.getValue(n),o=d[n.join("/")],a=null;(a=o!==i.currentId?i.findById(o):i.currentItem)&&a.primaryKeyValue&&(t=a.toJSON())}}else if(d&&Object.keys(d).find(function(t){var e=t.split("/").join("/");return n.join("/").startsWith(e)})){var s=d&&d["/"]||m.list.currentId,p=g.frameContext.repository.entityCollection.getEntityById(s),u=[],c=n.reduce(function(t,e){u.push(e);var n=t&&t[e];if(n){var r=d&&d[u.join("/")]||n.items[0]&&n.items[0].primaryValue||null;if(r)return n.get(r)||null}return null},p);t=c?c.toJSON():{}}else t=fn.getCurrentRowByPaths(n,m);var l=n.pop(),f=n.reduce(function(t,e){return t&&t[e]||null},v),h=f[l],y=E({__items__:[]},t&&t||{},{__type__:"List"});y.length=function(){return y.__items__.length},h&&Array.isArray(h)&&(y.__items__=[].concat(h)),f[l]=y}),v):null},Ao.prototype.getPropertyValue=function(t,e){return e.reduce(function(t,e){return"List"===t.__type__?t.__items__.find(function(t){return t.id===e}):Array.isArray(t)?t.find(function(t){return t.id===e}):t&&t[e]},t)},Object.defineProperty(Ao.prototype,"entityOriginalNodeCode",{get:function(){var t=this.injector.get(Ze);return t&&t.entityTypeInfo&&t.entityTypeInfo.entityInfo&&t.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),Ao.prototype.buildStateContext=function(){var e={};if(this.frameContext){var t=this.frameContext.getVirtualRootFrameContext();if(t){var n=t.viewModel.uiState;(Object.getOwnPropertyNames(n)||[]).forEach(function(t){null!==t.match(/^[a-zA-Z0-9_\$]+$/g)&&(e[t]=n[t])})}}return e},Ao.decorators=[{type:d.Injectable}],Ao.ctorParameters=function(){return[{type:d.Injector},{type:cn},{type:Vo},{type:jo},{type:Ro},{type:undefined,decorators:[{type:d.Inject,args:[Ie]}]},{type:undefined,decorators:[{type:d.Inject,args:[Te]}]}]},Ao);function Ao(t,e,n,r,i,o,a){this.injector=t,this.resolveService=e,this.expressionExecutor=n,this.expressionRegistry=r,this.expressionResult=i,this.messageService=o,this.notifyService=a,this.frameContext=null,this.frameContext=this.injector.get(gs,null)}var Lo=(ko.prototype.registeEvent=function(){var n=this;this.expressionRegistry.expressions.subscribe(function(t){t.forEach(function(t){if(!(t.deps&&0<t.deps.length)){var e=n.expressionManager.eval(t.id);n.expressionResult[t.id]=e}})})},ko.decorators=[{type:d.Injectable}],ko.ctorParameters=function(){return[{type:d.Injector},{type:jo},{type:Bo},{type:Ro}]},ko);function ko(t,e,n,r){this.injector=t,this.expressionRegistry=e,this.expressionManager=n,this.expressionResult=r,this.registeEvent()}var $o,Uo=new d.InjectionToken("@Farris expression assigner"),Ho=new d.InjectionToken("@Farris_event_handler"),Ko=(c(Go,$o=No),Go.prototype.buildEventPath=function(t){return null},Go.prototype.registerEvent=function(){var n=this;this.uiState&&this.uiState.changes&&this.uiState.changes.subscribe(function(t){var e={ns:n.namespace,path:[t.field],type:x.Expression.EventType.ValueChanged,value:t.value,source:x.Expression.EventSource.State,frameId:n.frameId};n.subject.next(e)})},Go.decorators=[{type:d.Injectable}],Go.ctorParameters=function(){return[{type:d.Injector},{type:Yr},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]},{type:String,decorators:[{type:d.Inject,args:[Gi]}]},{type:Cn}]},Go);function Go(t,e,n,r,i){var o=$o.call(this)||this;return o.injector=t,o.uiState=e,o.namespace=n,o.frameId=r,o.bindingData=i,o.registerEvent(),o}x.Expression.EventType;var zo,qo=(c(Jo,zo=No),Jo.prototype.registerEvent=function(){var i=this;this.repository&&this.repository.changes&&this.repository.changes.subscribe(function(t){var e=i.convertEventType(t);if(e){var n=i.buildEventPath(t),r={ns:i.namespace,type:e,path:n,value:t.value,source:x.Expression.EventSource.Field};i.subject.next(r)}}),this.repository&&this.repository.entityCollectionChange&&this.repository.entityCollectionChange.subscribe(function(t){var e=i.convertEventType(t);if(e){var n=i.buildEventPath(t),r={ns:i.namespace,type:e,path:n,value:t.value,source:x.Expression.EventSource.Repository};i.subject.next(r)}})},Jo.prototype.buildEventPath=function(t){var n=this,e=t.path,r=[];return!e||e.length<1?r:r=e.filter(function(t,e){if(e%2==0&&t.includes(":")){if(":"===t)return!1;if(t.split(":")[0]!==n.repository.primaryKey)return!1}return!0})},Jo.prototype.convertEventType=function(t){var e=null;return t.type===x.ModifyType.Add||t.type===x.ModifyType.AddData||t.type===x.ModifyType.Insert||t.type===x.ModifyType.Remove||t.type===x.ModifyType.RemoveData||t.type===x.ModifyType.Load||t.type===x.ModifyType.ValueChange||t.type===x.ModifyType.Update&&(e=x.Expression.EventType.Update),e},Jo.decorators=[{type:d.Injectable}],Jo.ctorParameters=function(){return[{type:d.Injector},{type:Ze},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]}]},Jo);function Jo(t,e,n){var r=zo.call(this)||this;return r.injector=t,r.repository=e,r.namespace=n,r.bindingData=r.injector.get(Cn,null),r.registerEvent(),r}var Wo=(Yo.decorators=[{type:d.Injectable}],Yo.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Oo]}]},{type:d.Injector,decorators:[{type:d.Optional}]}]},Yo);function Yo(t,e){this.listeners=t,this.injector=e}var Zo,Xo=x.Expression.EventType,Qo=(c(ta,Zo=No),ta.prototype.registerEvent=function(){var i=this;this.bindingData&&this.bindingData.changes&&"function"==typeof this.bindingData.changes.subscribe&&this.bindingData.changes.subscribe(function(t){if(t.type===x.ChangeType.Append&&!0!==t.isCloned||t.type===x.ChangeType.ValueChanged||t.type===x.ChangeType.Remove||t.type===x.ChangeType.Load||t.type===x.ChangeType.SelectionChanged){var e=null;t.type===x.ChangeType.Append?e=Xo.Append:t.type===x.ChangeType.ValueChanged?e=Xo.ValueChanged:t.type===x.ChangeType.Remove?e=Xo.Remove:t.type===x.ChangeType.Load?e=!0===t.create?Xo.Append:Xo.Load:t.type===x.ChangeType.SelectionChanged&&(e=Xo.SelectionChanged);var n=i.buildEventPath(t),r={ns:i.namespace,path:n,type:e,source:x.Expression.EventSource.BindingData,value:t.value,id:t.id,isTreeNodeLoadScene:t.isTreeNodeLoadScene};i.subject.next(r)}})},ta.prototype.buildEventPath=function(t){var e=t.path,n=[],r=this.bindingData.list.currentItem.primaryKeyValue||t.id;r&&(t.type===x.ChangeType.Load&&0===t.path.length||n.push(this.bindingData.list.primaryKey+":"+r));for(var i=[],o=0;o<e.length;o++){var a=e[o];i.push(a);var s=this.bindingData.getValue(i);if(n.push(a),s instanceof Pn&&i.length<e.length){var p=s.currentItem.primaryKeyValue;o===e.length-2&&t.id&&(p=t.id),n.push(this.bindingData.list.primaryKey+":"+p)}}return n},ta.decorators=[{type:d.Injectable}],ta.ctorParameters=function(){return[{type:d.Injector},{type:Cn},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]}]},ta);function ta(t,e,n){var r=Zo.call(this)||this;return r.injector=t,r.bindingData=e,r.namespace=n,r.repository=null,r.repository=r.injector.get(Ze,null),r.registerEvent(),r}var ea=(Object.defineProperty(na.prototype,"onEvent",{get:function(){return this.subject},enumerable:!0,configurable:!0}),na.prototype.regist=function(){var e=this,t=this.registry&&this.registry.listeners||[];t&&0<t.length&&t.forEach(function(t){t.onEvent.subscribe(function(t){e.subject.next(t)})})},na.decorators=[{type:d.Injectable}],na.ctorParameters=function(){return[{type:Wo,decorators:[{type:d.Optional}]}]},na);function na(t){this.registry=t,this.subject=new h.Subject,this.regist()}var ra=(ia.prototype.attach=function(){return this.onEvent||(this.onEvent=new h.BehaviorSubject(this.events)),this.onEvent.asObservable()},ia.decorators=[{type:d.Injectable}],ia.ctorParameters=function(){return[{type:ea}]},ia);function ia(t){var n=this;this.listeners=t,this.events=new Array,this.listeners.onEvent.subscribe(function(t){if(n.onEvent&&0<n.onEvent.observers.length){var e=[];0<n.events.length&&(e=b(n.events)),e.push(t),n.onEvent.next(e),n.events=[]}else n.events.push(t)})}var oa=new d.InjectionToken("@farris/effector_token"),aa=(sa.prototype.effect=function(t,e,n){if(!n||!n.path)throw new Error("repository effector 需要指定行信息。");var r=n.path,i=r[0]||this.bindingData.list.currentItem.primaryKeyValue,o=this.repository.entityCollection.getEntityById(i);if(!i||o){for(var a=r.pop(),s=o,p=1;p<r.length;p++){var u=r[p];s=s instanceof gt?s.get(u):s[u]}s&&s[a]!==e&&(s[a]=e)}},sa.decorators=[{type:d.Injectable}],sa.ctorParameters=function(){return[{type:d.Injector},{type:Ze},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]},{type:Cn}]},sa);function sa(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.bindingData=r,this.ns=n}var pa=(ua.prototype.effect=function(t,e,n){this.uiState.setPropertyValue(t,e)},ua.decorators=[{type:d.Injectable}],ua.ctorParameters=function(){return[{type:d.Injector},{type:Yr},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]}]},ua);function ua(t,e,n){this.injector=t,this.uiState=e,this.namespace=n,this.ns=n}var ca=(la.prototype.effect=function(t,e,n){},la.decorators=[{type:d.Injectable}],la.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]},{type:gs}]},la);function la(t,e,n){this.injector=t,this.namespace=e,this.frameContext=n,this.ns=e}var fa=(ha.prototype.effect=function(t,e,n){if(!n||!n.path)throw new Error("DependencyEffector 需要指定行信息。");"boolean"!=typeof e&&console.warn("DependencyEffector 依赖表达式计算结果应该为true/false，当前值为："+e);var r=n.path,i=r[0]||this.bindingData.list.currentItem.primaryKeyValue,o=this.repository.entityCollection.getEntityById(i);if(i&&!o)throw new Error("找不到id："+i+"对应的实体！");for(var a=r.pop(),s=o,p=1;p<r.length;p++){var u=r[p];s=s instanceof gt?s.get(u):s[u]}if(!s)throw new Error("[DependencyEffector] 找不到实体对应的路径："+r.push(a));null!==s[a]&&!0===e&&(s[a]=null)},ha.decorators=[{type:d.Injectable}],ha.ctorParameters=function(){return[{type:d.Injector},{type:Ze},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]},{type:Cn}]},ha);function ha(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.bindingData=r,this.ns=n}var ya=(da.decorators=[{type:d.Injectable}],da.ctorParameters=function(){return[{type:d.Injector},{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[oa]}]}]},da);function da(t,e){this.injector=t,this.effectors=e}var ga=(ma.prototype.effect=function(t,e,n){if(!0===e&&n.message&&this.notifyService){var r=n.messageType||"info";this.notifyService[r](n.message,{hideTitle:!0})}},ma.decorators=[{type:d.Injectable}],ma.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[Ie]}]},{type:undefined,decorators:[{type:d.Inject,args:[Te]}]},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]}]},ma);function ma(t,e,n,r){this.injector=t,this.messageService=e,this.notifyService=n,this.namespace=r,this.ns=r}var va=(Ea.prototype.effect=function(t,e,n){var r,i=this.getDomInfoByEntityPath(t);if(i){var o=i.frameContext,a=(o&&o.getVirtualRootFrameContext(),n.expressionId),s=i.domPropertyName;if(a&&o.form.addFieldValidateRule(s,n.message,a,"validate"),!1===e&&n.message){if(!i.isGridComponent){var p=n.message.replace(/\$property/g,i.propertyName),u=this.buildFormErrors(s,p);o.form.updateFormErrors(u)}}else if(!0===e){var c=o.form.getFormControlErrors(s)||null;c?(c.hasOwnProperty("validate")&&delete c.validate,o.form.updateFormErrors(((r={})[s]={errors:c},r))):(u=this.buildFormErrors(s,null),o.form.updateFormErrors(u))}}},Ea.prototype.getDomInfoByEntityPath=function(t){var e,n,r,i,o=null;if(!t)return o;t=t.split("/").filter(function(t){return t}).join(".");var a=this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||null;if(a&&0<a.length)try{for(var s=P(a),p=s.next();!p.done;p=s.next()){var u=p.value;if(o)break;if(u&&u.form&&u.form.ngFormControls&&Object.keys(u.form.ngFormControls).length,u&&u.form&&u.form.ngFormControls&&0<Object.keys(u.form.ngFormControls).length){var c=Object.keys(u.form.ngFormControls);try{for(var l=P(c),f=l.next();!f.done;f=l.next()){var h=f.value,y=u.form.ngFormControls[h],d=(u.viewModel.bindingPath||"/").split("/").filter(function(t){return t}),g=y.binding.split(".");if(t===(g=d.concat(g)).join(".")){var m=u.viewModel.dataGridColumnsName||null,v=u.viewModel[m]||null;if(v&&Array.isArray(v)&&0<v.length&&!v.find(function(t){return!t.every(function(t){return!(t.hasOwnProperty("editor")&&t.editor)})}))continue;if(u&&u.frameComponent&&u.frameComponent.componentType===x.ComponentType.farrisTreeTalbeComponent)continue;var E=!1;m&&(E=!0),o={domPropertyName:h,propertyName:y.name||y.defaultI18nValue,frameContext:u,id:y.id,isGridComponent:E};break}}}catch(b){r={error:b}}finally{try{f&&!f.done&&(i=l["return"])&&i.call(l)}finally{if(r)throw r.error}}}}}catch(C){e={error:C}}finally{try{p&&!p.done&&(n=s["return"])&&n.call(s)}finally{if(e)throw e.error}}return o},Ea.prototype.getVerifyInformations=function(t){return(t&&t.getVirtualRootFrameContext()).viewModel.verifyInformations},Ea.prototype.buildFormErrors=function(t,e){var n,r;return e?(e=e.replace(/\$property/g,"domPropertyName"),(n={})[t]={errors:{validate:{name:e}}},n):((r={})[t]={errors:{}},r)},Ea.prototype.buildVerifyInformations=function(e,t,n,r){var i=this.getVerifyInformations(t),o=i.findIndex(function(t){return t.id===e});return-1!==o&&i.splice(o,1),i.push({id:e,namespace:t.namespace,targetField:n,index:i.length+1,title:t.form.formGroupName,msg:r,type:"error"}),i},Ea.prototype.removeValidateVerifyInformations=function(e,t){var n=this.getVerifyInformations(t),r=n.findIndex(function(t){return t.id===e});return-1!==r&&n.splice(r,1),n},Ea.decorators=[{type:d.Injectable}],Ea.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[Ie]}]},{type:undefined,decorators:[{type:d.Inject,args:[Te]}]},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]},{type:gs}]},Ea);function Ea(t,e,n,r,i){this.injector=t,this.messageService=e,this.notifyService=n,this.namespace=r,this.frameContext=i,this.ns=r}var ba=(Ca.prototype.effect=function(t,e,n){var r,i=this.getDomInfoByEntityPath(t);if(i){var o=i.frameContext,a=((o&&o.getVirtualRootFrameContext()).viewModel,i.domPropertyName),s=this.frameContext.bindingData.getValue(t.split("/").filter(function(t){return t})),p=n.expressionId;if(p&&o.form.addFieldValidateRule(a,n.message,p,"require"),!0===e){if(n.message)if(i.isGridComponent)this.updateColumnValidators(o,i.binding,i.datagridColumns,!0);else{var u=n.message.replace(/\$property/g,i.propertyName),c=this.buildFormErrors(a,u);this.isValidValue(t,s)||o.form.updateFormErrors(c)}}else if(i.isGridComponent)this.updateColumnValidators(o,i.binding,i.datagridColumns,!1);else{var l=o.form.getFormControlErrors(a)||null;l?(l.hasOwnProperty("require")&&delete l.require,o.form.updateFormErrors(((r={})[a]={errors:l},r))):(c=this.buildFormErrors(a,null),o.form.updateFormErrors(c))}}},Ca.prototype.updateColumnValidators=function(t,e,n,r){var i=t.frameId,o=t.appContext.componentManager.get([i]);if(o&&0<o.size){var a=Array.from(o.values())[0];if(a&&"function"==typeof a.updateColumn){var s=n.find(function(t){return t.find(function(t){return t.field===e})}),p=s&&s.find(function(t){return t.field===e})||null;if(p){var u=p.validators||[],c=u.findIndex(function(t){return"required"===t.type});r?-1===c&&u.push({type:"required",message:"该字段不能为空！"}):-1!==c&&u.splice(c,1),a.updateColumn(e,{validators:b(u)}),a.columnsChanged(!1)}}}},Ca.prototype.getDomInfoByEntityPath=function(t){var e,n,r,i,o=null;if(!t)return o;t=t.split("/").filter(function(t){return t}).join(".");var a=this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||null;if(a&&0<a.length)try{for(var s=P(a),p=s.next();!p.done;p=s.next()){var u=p.value;if(o)break;if(u&&u.form&&u.form.ngFormControls&&0<Object.keys(u.form.ngFormControls).length){var c=Object.keys(u.form.ngFormControls);try{for(var l=P(c),f=l.next();!f.done;f=l.next()){var h=f.value,y=u.form.ngFormControls[h],d=(u.viewModel.bindingPath||"/").split("/").filter(function(t){return t}),g=y.binding.split(".");if(t===(g=d.concat(g)).join(".")){var m=u.viewModel.dataGridColumnsName||null,v=u.viewModel[m]||null;if(v&&Array.isArray(v)&&0<v.length&&!v.find(function(t){return!t.every(function(t){return!(t.hasOwnProperty("editor")&&t.editor)})}))continue;if(u&&u.frameComponent&&u.frameComponent.componentType===x.ComponentType.farrisTreeTalbeComponent)continue;var E=!1;m&&(E=!0),o={domPropertyName:h,propertyName:y.name||y.defaultI18nValue,frameContext:u,id:y.id,isGridComponent:E,binding:y.binding,datagridColumns:v};break}}}catch(b){r={error:b}}finally{try{f&&!f.done&&(i=l["return"])&&i.call(l)}finally{if(r)throw r.error}}}}}catch(C){e={error:C}}finally{try{p&&!p.done&&(n=s["return"])&&n.call(s)}finally{if(e)throw e.error}}return o},Ca.prototype.getDataPropInfo=function(t){if(!t)return null;var e=t.split("/").filter(function(t){return t});return this.frameContext.repository.entityTypeInfo.getPropInfoByPath(e)},Ca.prototype.isValidValue=function(t,e){var n=this.getDataPropInfo(t);if(n&&n.metadataInfo&&!0===n.metadataInfo.enableMultiLangInput){var r=this.injector.get(Rr,null),i=r&&r.getCurrentLanguage()||"zh-CHS";return!(Object.keys(e).length<1)&&!!e[i]}return null!==e&&""!==e&&e!==undefined},Ca.prototype.buildFormErrors=function(t,e){var n,r;return e?((n={})[t]={errors:{require:{name:e}}},n):((r={})[t]={errors:{}},r)},Ca.decorators=[{type:d.Injectable}],Ca.ctorParameters=function(){return[{type:d.Injector},{type:Ze},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]},{type:gs}]},Ca);function Ca(t,e,n,r){this.injector=t,this.repository=e,this.namespace=n,this.frameContext=r,this.ns=n}var xa=(Pa.prototype.effect=function(t,e,n){var r,i=t.split("/").filter(function(t){return t}),o=this.getTablePaths(i),a=o.join("/");if(o&&0<o.length){if(this.isGridComponent(a)&&(r=this.getDatagridComponent(a))){var s=this.getPropertyPaths(i);if(s){var p=s.join(".");e?r.showColumn(p,!1):r.hideColumn(p,!1)}}}else(r=this.getDatagridComponent(a))&&r.columnsChanged(!1)},Pa.prototype.getTablePaths=function(t){return fn.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo)},Pa.prototype.getDatagridComponent=function(e){var i=this,t=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||[]).filter(function(t){return t.viewModel&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).toString()===e.split("/").filter(function(t){return t}).toString()}),o=null;return t&&t.every(function(t){var e=t.frameId,n=i.frameContext.appContext.componentManager.getComponentsByFrameId(e);if(!n)return!0;var r=Array.from(n.values()).find(function(t){return t&&"DatagridComponent"===t.__component_type__});return!r||(o=r,!1)}),o},Pa.prototype.getPropertyPaths=function(t){var e=fn.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo);return t.slice(e.length)},Pa.prototype.isGridComponent=function(e){var t=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace)||[]).find(function(t){return t.viewModel&&t.viewModel.bindingPath.split("/").filter(function(t){return t}).toString()===e.split("/").filter(function(t){return t}).toString()});return!!t&&!!t.viewModel.dataGridColumnsName},Pa.decorators=[{type:d.Injectable}],Pa.ctorParameters=function(){return[{type:d.Injector},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]},{type:gs},{type:Ze}]},Pa);function Pa(t,e,n,r){this.injector=t,this.namespace=e,this.frameContext=n,this.repository=r,this.ns=e}var Ia=(Ta.prototype.getEffector=function(t){t.path;var e=t.ns,n=t.bindingType,r=t.type,i=this.effectorRegistry.effectors.filter(function(t){return t.ns==e});if(r!==x.Expression.ExpressionType.Compute)return r===x.Expression.ExpressionType.Readonly?i.find(function(t){return t instanceof ca}):r===x.Expression.ExpressionType.Dependency?i.find(function(t){return t instanceof fa}):r===x.Expression.ExpressionType.Relative?i.find(function(t){return t instanceof ga}):r===x.Expression.ExpressionType.Validate?i.find(function(t){return t instanceof va}):r===x.Expression.ExpressionType.Required?i.find(function(t){return t instanceof ba}):r===x.Expression.ExpressionType.Visible?i.find(function(t){return t instanceof xa}):null;if(n===x.Expression.ExpressionBindingType.Field)return i.find(function(t){return t instanceof aa});if(n===x.Expression.ExpressionBindingType.State)return i.find(function(t){return t instanceof pa});throw new Error("不支持的绑定字段类型："+n)},Ta.decorators=[{type:d.Injectable}],Ta.ctorParameters=function(){return[{type:d.Injector},{type:ya}]},Ta);function Ta(t,e){this.injector=t,this.effectorRegistry=e}var Ma=(Sa.prototype.handleEvent=function(t,e){t=Object.assign({},t),this.expressionObjects=e,this.dispatch(t)},Object.defineProperty(Sa.prototype,"primaryValue",{get:function(){return this.bindingData.list.currentItem.primaryKeyValue},enumerable:!0,configurable:!0}),Object.defineProperty(Sa.prototype,"entityOriginalNodeCode",{get:function(){return this.repository&&this.repository.entityTypeInfo&&this.repository.entityTypeInfo.entityInfo&&this.repository.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),Sa.prototype.perform=function(t,e){return this.expressionExecutor.compile(t,e)},Sa.prototype.effect=function(t,n){var e=n.bindingType,r=this.effectorFactory.getEffector(n);if(r){if(e!==x.Expression.ExpressionBindingType.Field)throw new Error("not supported！");var i=n.effectPaths||[];if(0<i.length)i.forEach(function(t){var e={path:t.split("/"),message:n.message,expressionId:n.id};r.effect(n.path,n.result,e)});else if(n.type===x.Expression.ExpressionType.Required||n.type===x.Expression.ExpressionType.Validate||n.type===x.Expression.ExpressionType.Readonly||n.type===x.Expression.ExpressionType.Visible){var o={message:n.message,expressionId:n.id};r.effect(n.path,n.result,o)}}},Sa.prototype.isValidateOrRequiredExpression=function(t){return t&&(t.type===x.Expression.ExpressionType.Validate||t.type===x.Expression.ExpressionType.Required)},Sa.prototype.getEntityPathFromEvent=function(t){if(!(t=JSON.parse(JSON.stringify(t)))||!t.path||t.path.length<1)return[];var e=t.path;return this.getEntityPath(e)},Sa.prototype.getEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},Sa.prototype.buildEntityPath=function(t){return t.filter(function(t,e){return e%2!=0||!t.includes(":")})},Sa.prototype.cleanEventPath=function(t){return(t=t.filter(function(t){return!(!t||":"===t)})).map(function(t){return t.includes(":")?t.split(":")[1]:t})},Sa.prototype.getCurrentRowByPaths=function(t){var e=null,n=this.bindingData.getValue(t);if(n&&0<n.length){var r=n.currentItem.primaryKeyValue||null;if(r){var i=n.findById(r);i&&(e=i.toJSON())}}return e},Sa.prototype.getEventId=function(t,e){if(!t||t.length<1)throw new Error("invalid path!");var n=t.findIndex(function(t){return t===e});if(-1===n)return null;var r=n+1;if(r>t.length-1)throw new Error("invalid propertyName or path");var i=t[r];if(-1===i.indexOf(":"))throw new Error("compute error.");return i.split(":")[1]},Sa.prototype.buildStateContext=function(t){var e=t.ns,n=this.injector.get(Ji,null).frameContextManager.getFrameContextsByNamespace(e),r={};if(n&&0<n.length){var i=n[0].getVirtualRootFrameContext();if(i){var o=i.viewModel.uiState;(Object.getOwnPropertyNames(o)||[]).forEach(function(t){null!==t.match(/^[a-zA-Z0-9_\$]+$/g)&&(r[t]=o[t])})}}return r},Sa.prototype.buildEntityContext=function(t,e,c){var l=this,n=e.bindingType;if(n===x.Expression.ExpressionBindingType.Field){var r=this.repository.entityTypeInfo,i=[];fn.getChildrenEntityPaths(r,i);var o=c&&c.find(function(t){return""===t.bindingPath||"/"===t.bindingPath})||null,a=o&&o.primaryValue||this.bindingData.list.currentId,s=this.bindingData.list.findById(a);if(!s)return{};var f=s.toJSON();return f.__type__="Entity",!i||i.length<1||(i.sort(function(t,e){return t.length-e.length}),i.forEach(function(e){var t=l.bindingData.getValue(e),n=t.currentId,r=e[e.length-1],i=e.slice(0,e.length-1).reduce(function(t,e){return t&&t[e]||null},f);if(i){var o=i,a=null;if(n){if(c&&0<c.length){var s=c.find(function(t){return t.bindingPath.split("/").filter(function(t){return t}).join("/")===e.join("/")});s&&(n=s.primaryValue)}var p=t.findById(n),u=i[r];(a=E({__items__:[]},p&&p.toJSON()||{},{__type__:"List"})).length=function(){return a.__items__.length},u&&Array.isArray(u)&&(a.__items__=[].concat(u))}else a={__items__:[],__type__:"List",length:function(){return a.__items__.length}};o[r]=a}})),f}if(n!==x.Expression.ExpressionBindingType.State)return null},Sa.prototype.buildContext=function(t,e,n,r){var i,o=[];if(n)o.push(n);else{var a=this.buildEntityContext(e,t,r);o.push(a)}var s=this.buildStateContext(e),p=this.entityOriginalNodeCode,u=null;1===o.length?u=o.pop():((u=o[0]).__type__||(u.__type__="Entity"),u.__items__=o);var c=this.injector.get(Rr,null);return E(((i={})[p]=u,i),s,{BigNumber:y.BigNumber,frameContext:this.frameContext,bindingData:this.bindingData,repository:this.repository,CurrentLanguage:c.getCurrentLanguage()||"zh-CHS"})},Sa.prototype.buildEffectPath=function(t,e){var n=e.path.split("/").filter(function(t){return t}),r=t.path[0]&&t.path[0].split(":")[1];if(!r)throw new Error("Invalid event path!");if(1===n.length)return[r,n.pop()];for(var i=[r],o=0;o<n.length;o++){var a=n[o];i.push(a);var s=n.slice(0,o+1),p=this.repository.entityTypeInfo.getPropInfoByPath(s);if("List"===p.group){var u=this.getEventId(t.path,p.name)||null;if(!u){var c=this.bindingData.getValue(s);c&&(u=c.currentId)}i.push(u)}}return i},Sa.prototype.getPathInfo=function(t){var e=t.split("/").filter(function(t){return t}),n=fn.getAvailableChildrenPathsFromEntityPaths(e,this.repository.entityTypeInfo),r=e.slice(n.length).join("/");return{path:n.join("/"),propertyName:r,paths:n,propertyNames:r.split("/").filter(function(t){return t})}},Sa.prototype.getTablePathsFromEventPaths=function(t){return t=this.getEntityPath(t),fn.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo)},Sa.prototype.getPropertyPathsFromEventPaths=function(t){t=this.getEntityPath(t);var e=fn.getAvailableChildrenPathsFromEntityPaths(t,this.repository.entityTypeInfo);return t.slice(e.length)},Sa.prototype.analysis=function(t,e){var n=this.getPathInfo(e.path),r=this.getEntityPath(t.path.slice(0)),i=this.getPathInfo(r.join("/"));if(!n||!i)return console.warn("表达式路径或事件路径错误，获取路径信息失败。"),null;var o=n.path.split("/").filter(function(t){return t}),a=n.propertyName.split("/").filter(function(t){return t}),s=i.path.split("/").filter(function(t){return t}),p=i.propertyName.split("/").filter(function(t){return t}),u={distance:undefined,eventFromChildren:undefined,eventFromParent:undefined,expressionTablePaths:o,expressionPropertyNames:a,eventTablePaths:s,eventPropertyNames:p,isSameTable:!1};return u.distance=Math.abs(o.length-s.length),1===u.distance&&(u.eventFromChildren=s.length>o.length&&s.join("/").startsWith(o.join("/")),u.eventFromParent=s.length<o.length&&o.join("/").startsWith(s.join("/"))),u.isSameTable=o.join("/")===s.join("/"),u},Sa.prototype.buildCurrentRows=function(t,r){var i=new Array;if(!t||t.length<1)i.push({bindingPath:"/",primaryValue:r[0]});else{var o=[];t.forEach(function(t,e){0===e&&i.push({bindingPath:"/",primaryValue:r[0]}),o.push(t);var n=r[2*e+2];i.push({bindingPath:o.join("/"),primaryValue:n})})}return i},Sa.prototype.convertBooleanTypeExpressionResult=function(t,e){return this.isBooleanTypeExpression(t)?!0===e:e},Sa.prototype.isBooleanTypeExpression=function(t){return this.isReadonlyExpression(t)||this.isVisibleExpression(t)||this.isValidateExpression(t)||this.isRequiredExpression(t)||this.isDependencyExpression(t)},Sa.prototype.isReadonlyExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Readonly||!1},Sa.prototype.isVisibleExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Visible},Sa.prototype.isValidateExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Validate},Sa.prototype.isRequiredExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Required},Sa.prototype.isDependencyExpression=function(t){return t&&t.type===x.Expression.ExpressionType.Dependency},Sa.decorators=[{type:d.Injectable}],Sa.ctorParameters=function(){return[{type:d.Injector},{type:Ze},{type:Cn},{type:jo},{type:Ia},{type:Vo},{type:Ro}]},Sa);function Sa(t,e,n,r,i,o,a){this.injector=t,this.repository=e,this.bindingData=n,this.expressionRegistry=r,this.effectorFactory=i,this.expressionExecutor=o,this.expressionResult=a,this.frameContext=this.injector.get(gs)}var ja,wa=(c(Oa,ja=Ma),Oa.prototype.filter=function(t){return null},Oa.prototype.dispatch=function(t){},Oa.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Oa.decorators=[{type:d.Injectable}],Oa);function Oa(){return null!==ja&&ja.apply(this,arguments)||this}var Na=(Da.effect=function(n,r,t){!t||t.length<1||t.forEach(function(t){var e={path:t,message:r.message,expressionId:r.id};n.effect(r.path,r.result,e)})},Da);function Da(){}var Va,Fa=(c(Ra,Va=Ma),Ra.prototype.filter=function(i){var o=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1||i.ns!==t.ns)return!1;var n=o.cleanEventPath(i.path);n.splice(0,0,De);var r=n.join("/");return!!e.includes(r)}):null},Ra.prototype.dispatch=function(r){var i=this,t=this.filter(r);t&&0<t.length&&t.forEach(function(t){var e=i.buildContext(t,r),n=i.perform(t,e);n===undefined&&!i.isValidateOrRequiredExpression(t)||(t.result=i.convertBooleanTypeExpressionResult(t,n),t.id&&i.expressionResult.set(t.id,t.result),i.effect(r,t))})},Ra.prototype.effect=function(n,r){var i=this,o=this.effectorFactory.getEffector(r),t=r.bindingType;if(o)if(t===x.Expression.ExpressionBindingType.State)o.effect(r.path,r.result,{message:r.message});else if(t===x.Expression.ExpressionBindingType.Field){var e=this.getPathInfo(r.path),a=e.paths,s=this.repository.entityCollection.getAllEntities();!s||s.length<1||r.type===x.Expression.ExpressionType.Visible?o.effect(r.path,r.result,{message:r.message}):this.effectRows(s,a,e.propertyNames,function(t,e){i.output(n,r,t,o,[e])})}},Ra.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a!==undefined&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),Na.effect(r,e,i))},Ra.prototype.effectRows=function(t,i,o,a,s,p,u){var c=this;if(void 0===s&&(s=[]),void 0===p&&(p=[]),void 0===u&&(u=[]),!i||i.length<1)t.forEach(function(t){if(t&&t.primaryValue){var e=u.concat([t.primaryValue]).concat(o),n=s.concat([{bindingPath:p.join("/")||"/",primaryValue:t.primaryValue}]);a(n,e)}}),s.length=0,u.length=0;else{var l=!1,f=p;t.forEach(function(t){var e=i[0],n=t[e];if(n&&!(n.count()<1)){s.push({bindingPath:p.join("/")||"/",primaryValue:t.primaryValue}),u.push(t.primaryValue),u.push(e),!1===l&&(l=!0,f.push(e));var r=i.slice(1);c.effectRows(n.items,r,o,a,s,f,u)}})}},Ra.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Ra.decorators=[{type:d.Injectable}],Ra);function Ra(){return null!==Va&&Va.apply(this,arguments)||this}var _a,Ba=(c(Aa,_a=Ma),Aa.prototype.filter=function(t){return null},Aa.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=r,t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},Aa.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Aa.decorators=[{type:d.Injectable}],Aa);function Aa(){return null!==_a&&_a.apply(this,arguments)||this}var La,ka=(c($a,La=Ma),$a.prototype.filter=function(t){return null},$a.prototype.dispatch=function(t){},$a.decorators=[{type:d.Injectable}],$a);function $a(){return null!==La&&La.apply(this,arguments)||this}var Ua,Ha=(c(Ka,Ua=Ma),Ka.prototype.filter=function(t){return null},Ka.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=r,t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},Ka.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Ka.decorators=[{type:d.Injectable}],Ka);function Ka(){return null!==Ua&&Ua.apply(this,arguments)||this}var Ga,za=(c(qa,Ga=Ma),qa.prototype.filter=function(n){var r=this;return this.expressionObjects.filter(function(t){if(t.ns!==n.ns||!t.deps||0===t.deps.length||t.type===x.Expression.ExpressionType.Compute||t.type===x.Expression.ExpressionType.Dependency||t.type===x.Expression.ExpressionType.DataPicking)return!1;var e=r.analysis(n,t);return!!e&&0===e.expressionTablePaths.length&&-1!==t.deps.findIndex(function(t){if(!t.startsWith(Ne))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=r.getPathInfo(e.join("/"));return!!n&&0===n.paths.length})})},qa.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},qa.prototype.getCurrentRowByEvent=function(t,e){var n=null,r=this.bindingData.getValue(t),i=this.getEntityPath(e.path);if(r&&0<r.length){var o=r.currentItem.primaryKeyValue||null,a=fn.getAvailableChildrenPathsFromEntityPaths(i,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&(o=(o=e.id||null)||this.getEventId(e.path,t[t.length-1])),o){var s=r.findById(o);s&&(n=s.toJSON())}}return n},qa.decorators=[{type:d.Injectable}],qa);function qa(){return null!==Ga&&Ga.apply(this,arguments)||this}var Ja,Wa=(c(Ya,Ja=Ma),Ya.prototype.filter=function(o){var a=this;if(this.expressionObjects&&0<this.expressionObjects.length){var t=this.expressionObjects.filter(function(t){if(t.ns!==o.ns||!t.deps||t.deps.length<1)return!1;var r=a.buildEntityPath(o.path),i=a.analysis(o,t);return!(!i||0===r.length&&t.bindingType===x.Expression.ExpressionBindingType.Field||(r.splice(0,0,Ne),i.eventTablePaths.length-1!==i.expressionTablePaths.length||!i.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER).startsWith(i.expressionTablePaths.join(x.Expression.DEPENDENCY_SPLITER))||-1===t.deps.findIndex(function(t){if(!t.startsWith(r.join(x.Expression.DEPENDENCY_SPLITER)))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=a.getPathInfo(e.join(x.Expression.DEPENDENCY_SPLITER));return!(!n||n.paths.join(x.Expression.DEPENDENCY_SPLITER)!==i.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER))})))}),n=this.buildEntityPath(o.path),e=this.expressionObjects.filter(function(t){if(t.ns!==o.ns)return!1;if(a.getPathInfo(t.path).paths.join(x.Expression.DEPENDENCY_SPLITER)!==n.join(x.Expression.DEPENDENCY_SPLITER))return!1;if((t.type===x.Expression.ExpressionType.Compute||t.type===x.Expression.ExpressionType.Dependency)&&o.isTreeNodeLoadScene)return!1;if(!t.deps||t.deps.length<1)return!0;if(t.deps.every(function(t){return t.startsWith(De)}))return!0;var e=a.analysis(o,t);return!(!e||0!==e.distance||!e.isSameTable)}),r=this.expressionObjects.filter(function(t){if(t.ns!==o.ns||!t.deps||t.deps.length<1||t.type!==x.Expression.ExpressionType.Visible&&t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate)return!1;var e=t.deps.filter(function(t){return t.startsWith(Ne)});if(!e||e.length<1)return!1;if(!a.analysis(o,t))return!1;var n=o.path.filter(function(t){return t}).join("/");return-1!==e.findIndex(function(t){var e=t.split("/").slice(1).join("/");return a.getPathInfo(e).path===n})});return t.concat(e,r)}return null},Ya.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},Ya.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},Ya.prototype.effect=function(n,r){var i=this,t=r.bindingType,e=this.cleanEventPath(n.path),o=this.effectorFactory.getEffector(r);if(o){var a=this.analysis(n,r);if(a){var s=r.path.split("/").filter(function(t){return t});if(t===x.Expression.ExpressionBindingType.Field){var p=[],u=s.slice(a.expressionTablePaths.length);if(0===a.distance){if(!a.isSameTable)return;var c=e.slice(0);if(1===e.length)if(n.value&&Array.isArray(n.value))n.value.forEach(function(t){p.push([t.primaryKeyValue].concat(u))});else{var l=c.concat(u);p.push(l)}else if(n.value&&Array.isArray(n.value))n.value.forEach(function(t){p.push(c.concat([t.primaryKeyValue]).concat(u))});else{var f=this.bindingData.getValue(a.eventTablePaths);f&&f.currentId&&p.push(c.concat(f.currentId).concat(u))}}else if(!0===a.eventFromParent){if(1<a.expressionTablePaths.length)return;e.slice(0,e.length),l=(e&&0<e.length?e.slice(0,e.length):[this.bindingData.list.currentId,a.expressionTablePaths[0],null]).concat(u),p.push(l)}else{if(!0!==a.eventFromChildren)return;l=e.slice(0,e.length-1).concat(u),p.push(l)}p.forEach(function(t){var e=i.buildCurrentRows(a.expressionTablePaths,t);i.output(n,r,e,o,[t])})}else t===x.Expression.ExpressionBindingType.State&&console.error("not supported！")}}},Ya.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a!==undefined&&(e.result=a,e.id&&this.expressionResult.set(e.id,e.result),Na.effect(r,e,i))},Ya.decorators=[{type:d.Injectable}],Ya);function Ya(){return null!==Ja&&Ja.apply(this,arguments)||this}var Za,Xa=(c(Qa,Za=Ma),Qa.prototype.filter=function(r){var i=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1||r.ns!==t.ns)return!1;var n=i.getEntityPath(r.path);return n.splice(0,0,Ne),e.includes(n.join("/"))}):null},Qa.prototype.dispatch=function(e){var n=this,t=this.filter(e);t&&0<t.length&&t.forEach(function(t){n.effect(e,t)})},Qa.prototype.effect=function(t,e){var n,r,i=this.effectorFactory.getEffector(e);if(i){var o=this.analysis(t,e);if(o){var a=this.cleanEventPath(t.path),s=[];if(0===o.distance){if(!1===o.isSameTable)return;var p=(c=a.slice(0,a.length-o.eventPropertyNames.length)).concat(o.expressionPropertyNames),u=this.buildCurrentRows(o.eventTablePaths,p);s.push(p),this.output(t,e,u,i,s)}else if(!0===o.eventFromChildren){if(1<o.distance)return;p=(c=a.slice(0,a.length-o.eventPropertyNames.length-2)).concat(o.expressionPropertyNames),s.push(p),u=this.buildCurrentRows(o.eventTablePaths,a),this.output(t,e,u,i,s)}else if(!0===o.eventFromParent){if(1<o.distance)return;var c;(c=a.slice(0,a.length-o.eventPropertyNames.length)).push(o.expressionTablePaths.slice(0).pop()),o.expressionTablePaths;var l=a[0];if(!l)return;for(var f=this.frameContext.repository.entityCollection.getEntityById(l),h=1;h<c.length;h++){var y=c[h];f=f instanceof gt?f.get(y):f[y]}var d=f;if(d&&d instanceof gt)if(0===d.count()){if(e.type===x.Expression.ExpressionType.Visible||e.type===x.Expression.ExpressionType.Required){var g=this.buildContext(e,t),m=this.perform(e,g);if(m===undefined&&!this.isValidateOrRequiredExpression(e))return;e.result=this.convertBooleanTypeExpressionResult(e,m),e.id&&this.expressionResult.set(e.id,e.result),Za.prototype.effect.call(this,t,e)}}else try{for(var v=P(d),E=v.next();!E.done;E=v.next()){var b=E.value;b&&b.primaryValue&&(p=c.concat([b.primaryValue]).concat(o.expressionPropertyNames),u=this.buildCurrentRows(o.expressionTablePaths,p),this.output(t,e,u,i,[p]))}}catch(C){n={error:C}}finally{try{E&&!E.done&&(r=v["return"])&&r.call(v)}finally{if(n)throw n.error}}}}}},Qa.prototype.output=function(t,e,n,r,i){var o=this.buildContext(e,t,null,n),a=this.perform(e,o);a===undefined&&!this.isValidateOrRequiredExpression(e)||(e.result=this.convertBooleanTypeExpressionResult(e,a),e.id&&this.expressionResult.set(e.id,e.result),Na.effect(r,e,i))},Qa.prototype.getCurrentRowByEvent=function(t,e){e=JSON.parse(JSON.stringify(e));var n=null,r=this.bindingData.getValue(t),i=this.getEntityPath(e.path);if(r&&0<r.length){var o=r.currentItem.primaryKeyValue||null,a=fn.getAvailableChildrenPathsFromEntityPaths(i,this.repository.entityTypeInfo);if(a&&a.toString()===t.toString()&&(o=(o=e.id||null)||this.getEventId(e.path,t[t.length-1])),o){var s=r.findById(o);s&&(n=s.toJSON())}}return n},Qa.decorators=[{type:d.Injectable}],Qa);function Qa(){return null!==Za&&Za.apply(this,arguments)||this}var ts,es=(c(ns,ts=Ma),ns.prototype.filter=function(e){var o=this;if(this.expressionObjects&&0<this.expressionObjects.length)return this.expressionObjects.filter(function(t){if(t.ns!==e.ns||!t.deps||t.deps.length<1)return!1;var r=o.analysis(e,t);if(!r)return!1;var i=o.buildEntityPath(e.path);return(0!==i.length||t.bindingType!==x.Expression.ExpressionBindingType.Field)&&(i.splice(0,0,Ne),r.eventTablePaths.length-1===r.expressionTablePaths.length&&!!r.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER).startsWith(r.expressionTablePaths.join(x.Expression.DEPENDENCY_SPLITER))&&-1!==t.deps.findIndex(function(t){if(!t.startsWith(i.join(x.Expression.DEPENDENCY_SPLITER)))return!1;var e=t.split(x.Expression.DEPENDENCY_SPLITER).filter(function(t){return t}).slice(1),n=o.getPathInfo(e.join(x.Expression.DEPENDENCY_SPLITER));return!(!n||n.paths.join(x.Expression.DEPENDENCY_SPLITER)!==r.eventTablePaths.join(x.Expression.DEPENDENCY_SPLITER))}))})},ns.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},ns.prototype.effect=function(t,e){var n=e.bindingType,r=this.cleanEventPath(t.path),i=this.effectorFactory.getEffector(e);if(i){var o=this.analysis(t,e);if(o){var a=e.path.split("/").filter(function(t){return t});if(n===x.Expression.ExpressionBindingType.Field){var s=[],p=a.slice(o.expressionTablePaths.length);if(0!==o.distance){if(!0===o.eventFromParent)return;if(!0!==o.eventFromChildren)return;var u=r.slice(0,r.length-1).concat(p);s.push(u)}Na.effect(i,e,s)}else n===x.Expression.ExpressionBindingType.State&&console.error("not supported！")}}},ns.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},ns.decorators=[{type:d.Injectable}],ns);function ns(){return null!==ts&&ts.apply(this,arguments)||this}var rs,is=(c(os,rs=Ma),os.prototype.filter=function(i){var o=this;return(i.path&&0!==i.path.length||!i.value||!Array.isArray(i.value)||0!==i.value.length)&&this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){if(t.ns!==i.ns||t.type!==x.Expression.ExpressionType.Readonly&&t.type!==x.Expression.ExpressionType.Visible&&t.type!==x.Expression.ExpressionType.Required&&t.type!==x.Expression.ExpressionType.Validate)return!1;var e=o.analysis(i,t);if(!e)return!1;if(e.isSameTable)return!0;if(!t.deps||0===t.deps.length)return!0;var n=t.deps.filter(function(t){return t.startsWith(Ne)});if(!n||n.length<1)return!1;var r=i.path.filter(function(t){return t}).join("/");return-1!==n.findIndex(function(t){var e=t.split("/").slice(1).join("/");return o.getPathInfo(e).path===r})}):null},os.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},os.prototype.getCurrentRowByEvent=function(t,e){return this.getCurrentRowByPaths(t)},os.decorators=[{type:d.Injectable}],os);function os(){return null!==rs&&rs.apply(this,arguments)||this}var as,ss=(c(ps,as=Ma),ps.prototype.filter=function(i){var o=this;return this.expressionObjects&&0<this.expressionObjects.length?this.expressionObjects.filter(function(t){var e=t.deps;if(!e||e.length<1)return!1;var n=e.findIndex(function(t){return t.startsWith(Ne)});if(-1===n)return!1;var r=o.analysis(i,t);return!!r&&1===r.eventTablePaths.length&&2===r.expressionTablePaths.length&&!!r.expressionTablePaths.join("/").startsWith(r.eventTablePaths.join("/"))&&-1!==(n=e.findIndex(function(t){return t.startsWith(Ne+"/"+r.eventTablePaths[0])}))}):null},ps.prototype.dispatch=function(i){var o=this,t=this.filter(i);t&&0<t.length&&t.forEach(function(t){var e=o.buildEntityContext(i,t),n=o.buildContext(t,i,e),r=o.perform(t,n);r===undefined&&!o.isValidateOrRequiredExpression(t)||(t.result=o.convertBooleanTypeExpressionResult(t,r),t.id&&o.expressionResult.set(t.id,t.result),o.effect(i,t))})},ps.decorators=[{type:d.Injectable}],ps);function ps(){return null!==as&&as.apply(this,arguments)||this}var us=(Object.defineProperty(cs.prototype,"entityValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof wa})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"stateValueChangedEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Fa})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"repositoryAddEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Ba})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"repositoryRemoveEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof ka})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"entityUpdateEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof za})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"repositoryLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Ha})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"bindingDataAppendEntityEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Wa})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"bindingDataValueChangeEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof Xa})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"bindingDataRemoveObjectEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof es})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"bindingDataLoadEventHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof is})},enumerable:!0,configurable:!0}),Object.defineProperty(cs.prototype,"bindingDataSelectionChangedHandler",{get:function(){return this.handlers&&this.handlers.find(function(t){return t instanceof ss})},enumerable:!0,configurable:!0}),cs.decorators=[{type:d.Injectable}],cs.ctorParameters=function(){return[{type:Array,decorators:[{type:d.Optional},{type:d.Inject,args:[Ho]}]}]},cs);function cs(t){this.handlers=t}var ls=(fs.prototype.attachEvent=function(){var n=this;this.expressionEventEmitter.attach().subscribe(function(t){!t||t.length<1||!n.expressionObjects||n.expressionObjects.length<1||t.forEach(function(t){var e=n.getEventHandler(t);e?e.handleEvent(t,n.expressionObjects):Se.warn("没有对应的事件处理器,event="+t.type)})})},fs.prototype.resolveDependency=function(){var r=this;!this.resolverRegistry||!this.resolverRegistry.resolvers||this.resolverRegistry.resolvers.length<1||!this.expressionObjects||this.expressionObjects.length<1||!Array.isArray(this.expressionObjects)||this.expressionObjects.forEach(function(t){var e=t.expression,n=r.resolveService.resolve(e);t.deps=n})},fs.prototype.getEventHandler=function(t){if(t.type===x.Expression.EventType.ValueChanged){if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;if(t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.entityValueChangedEventHandler;if(t.source===x.Expression.EventSource.State)return this.eventHandlerRegistry.stateValueChangedEventHandler}else if(t.type===x.Expression.EventType.Append){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryAddEntityEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler}else if(t.type===x.Expression.EventType.Remove){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler}else if(t.type===x.Expression.EventType.Update){if(t.source===x.Expression.EventSource.Repository)return this.eventHandlerRegistry.entityUpdateEventHandler}else if(t.type===x.Expression.EventType.Load){if(t.source===x.Expression.EventSource.Repository||t.source===x.Expression.EventSource.Field)return this.eventHandlerRegistry.repositoryLoadEventHandler;if(t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataLoadEventHandler}else if(t.type===x.Expression.EventType.SelectionChanged&&t.source===x.Expression.EventSource.BindingData)return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;return null},fs.decorators=[{type:d.Injectable}],fs.ctorParameters=function(){return[{type:d.Injector},{type:jo},{type:ra},{type:Fe},{type:us},{type:cn}]},fs);function fs(t,e,n,r,i,o){var a=this;this.injector=t,this.expressionRegistry=e,this.expressionEventEmitter=n,this.resolverRegistry=r,this.eventHandlerRegistry=i,this.resolveService=o,this.expressionObjects=new Array,this.expressionRegistry.expressions.subscribe(function(t){t&&0<t.length&&(a.expressionObjects=t,a.resolveDependency()),a.attachEvent()})}var hs=(ys.prototype.add=function(t,e){var n=this.components.get(t);n?n.push(e):this.components.set(t,[e])},ys.prototype.remove=function(t){var e=this.components.get(t);e&&0<e.length&&(e.length=0,this.components["delete"](t))},ys.prototype.get=function(t){if(t){var e=this.components.get(t);if(e&&0<e.length)return e}return null},ys.prototype.clear=function(){this.components.clear()},ys);function ys(){this.components=new Map}var ds,gs=(c(ms,ds=yi),ms.prototype.dispose=function(t){var e=this;if(!this.isDisposed){if(this.isDestoried=!0,this.isDisposed=!0,this.destorySignal&&(this.destorySignal.next(),this.destorySignal.complete()),this.appContext&&(this.appContext.frameContextManager.unregFrameContext(this),this.appContext.frameComponentRefresher.unregFrameContext(this)),this.appContext&&!0===this.isRootFrameContext()){var n=this.viewModelNames;n&&Array.isArray(n)&&n.forEach(function(t){e[t]=null}),this.appContext.unregisterFromManager()}this.bindingData&&this.bindingData.dispose(),this.viewModel&&this.viewModel.dispose(),this.form&&(this.form.dispose(),this.form=null),this.commandBus&&(this.commandBus.dispose(),this.commandBus=null),ft.dispose(),this.frameComponent=null,this.repository=null,this.exceptionHandler=null,this.expressionManager=null,this.expressionEngineImpl=null,this.variableParseService=null,this.eventBus=null,this.translate=null,this.injector=null,this.expressionResult=null,It.setUserSettings(null)}},ms.prototype.ngOnDestroy=function(){this.dispose()},ms.prototype.getComponentById=function(t){var e=this.componentRefManager.get(t);return e&&0<e.length?e[0]:null},ms.prototype.getComponentsById=function(t){return this.componentRefManager.get(t)},ms.prototype.bindInjector=function(t){this.injector=t},ms.prototype.init=function(t){this.frameComponent=t,this.initializeBindingData(),this.initializeStateMachine(),this.initializeUiState(),this.initializeForm(),this.initializeCommandBus(),this.initializeViewModel(),this.registerExceptionHandler(),this.initExpression(),this.appContext.frameComponentRefresher.regFrameComponent(this.frameId,this.frameComponent)},ms.prototype.initExpression=function(){this.expressionEngineImpl=this.injector.get(ls,null),this.expressionManager=this.injector.get(Bo,null),this.injector.get(Lo,null),this.expressionResult=this.injector.get(Ro,null)},ms.prototype.registerExceptionHandler=function(){var n=this,t=this.getFormAppContext(),e=t.ApplicationId;if(window[window.location.href]=e,null!==this.exceptionHandler){var r=window[e]=window[e]||{};null!==this.eventBus&&this.isRootFrameContext()&&(r.isExceptionHandlerExist=!0,this.exceptionHandler.setContext(this.appContext),this.eventBus.on("Exception","","onException",t,function(t){if(!0!==n.isDestoried){if(t&&t.error)try{t.error.__frame_context__=n}catch(e){}n.exceptionHandler.handle(t)}})),this.destorySignal.subscribe(function(){n.eventBus.off("Exception","","onException",t)})}},ms.prototype.registerAppContextDestroyEvent=function(){var t=this;this.appContext&&this.appContext.destorySignal&&this.appContext.destorySignal.subscribe(function(){t.stateMachine&&(t.stateMachine.dispose(),t.stateMachine=null),t.repository&&t.repository.dispose()})},ms.prototype.getFormAppContext=function(){return this.appContext},ms.prototype.getFrameId=function(t){return t?this.namespace&&0<this.namespace.length?this.namespace+"_"+t:t:this.frameId},ms.prototype.initializeRepository=function(){this.repository.setPaginationConfig(this.repository.paginationInfo)},ms.prototype.initializeForm=function(){if(this.form=this.injector.get(mn,null),this.form){this.form.setTranslateService(this.injector.get(Rr,null));var t=this.viewModel.bindingPath||this.metadata.bindingTo;this.form.init(this.bindingData,t,this)}},ms.prototype.initializeStateMachine=function(){this.stateMachine=this.injector.get(oi,null),this.stateMachine&&this.stateMachine.initialize(this,this.variableParseService)},ms.prototype.initializeCommandBus=function(){var t=this.injector.get(Lr,new Lr(this.metadata.commandHandlers)),e=this.injector.get(Kr,new Kr(this.metadata.commandHandlerExtends)),n=new Ps(t,e,this,this.variableParseService);this.commandBus=new Ts(n)},ms.prototype.initializeViewModel=function(){this.metadata.bindingTo||(this.metadata.bindingTo=this.viewModel.bindingPath),this.viewModel.init(this),this.regViewModel(this.viewModel)},ms.prototype.initializeBindingData=function(){var e=this,t=this.repository.name,n=this.appContext.runMode===x.RunMode.highSpeed;if(t&&n){var r=this.appContext.bindingDataManager.getBindingDataByName(t);this.bindingData.initByBindingList(r.list,this.viewModel.bindingPath),this.bindingData.pagingInfo=r.pagingInfo,this.bindingData.setDataTypeInfo(this.repository.entityTypeInfo),En.watchReposiroty(this.repository,this.bindingData)}else this.bindingData.initByRepository(this.repository,this.viewModel.bindingPath),En.watchReposiroty(this.repository,this.bindingData),this.bindingData.changes.subscribe(function(t){t.type===x.ChangeType.GlobalSelectionChanged&&e.appContext.handleSelectChange(t,e)})},ms.prototype.initializeUiState=function(){var e=this,t=(window.location.href.indexOf("platform"),this.injector.get(Xr,!1));if(this.uiState=this.injector.get(Yr,null),this.uiState){this.uiState.paramTypeTransform=t,this.uiState.initialize(this);var n=this.appContext&&this.appContext.router&&this.appContext.router.url||"",r=(new Nt).getParams(n);Object.keys(r).forEach(function(t){Object.defineProperty(e.uiState,t,{get:function(){return r[t]}})})}},ms.prototype.regViewModel=function(t){this.appContext&&!1===this.appContext.viewModelManager.exsit(t.name)&&this.appContext.viewModelManager.register(t.name,t);var e=t.constructor.name,n=this.parent,r=null;if(n&&n.viewModel&&(r=n.viewModel),r){var i=r.childViewModels,o=null;if(i){var a=t.constructor.name;o=i[t.name]||i[a]}else 1===e.length?o=t.name.split("-").map(function(t,e){return 0<e&&t.length?t.charAt(0).toLocaleUpperCase()+t.substr(1,t.length-1):0===e&&t.length?t.charAt(0).toLocaleLowerCase()+t.substr(1,t.length-1):t}).join(""):t.relateChildName&&(o=t.relateChildName);o=o||e[0].toLowerCase()+e.substring(1,e.length),r.viewModelNames=r.viewModelNames||[],r[o]=t,r.viewModelNames.push(o),t.bindToParent(r)}},ms.prototype.isRootFrameContext=function(){return null===this.parent||this.appContext.runMode===x.RunMode.highSpeed&&!0===this.getVirtualRootFrameContext().frameComponent.isDialogRootComponent},ms.prototype.getVirtualRootFrameContext=function(){for(var t=this,e=this.parent;e&&e.namespace===this.namespace;)e=(t=e).parent;return t},ms.prototype.getContextById=function(t){return this.appContext.getContextById(t)},ms.prototype.getViewModel=function(t){var e=this.appContext;return e?e.viewModelManager.getViewModelByName(t):null},ms.prototype.attachViewComponent=function(t){this.frameComponent=t,this.appContext.frameComponentRefresher.regFrameComponent(this.frameId,this.frameComponent)},ms.prototype.invoke=function(t,e){var n=t.split("."),r=n[n.length-1],i=1===n.length?this.viewModel:this.getViewModel(n[n.length-2]);return i||alert("未匹配到'"+t+"'命令的视图模型，请检查事件是否配置正确。"),i[r](e)},ms.decorators=[{type:d.Injectable}],ms.ctorParameters=function(){return[{type:d.Injector},{type:ms,decorators:[{type:d.Optional},{type:d.SkipSelf}]}]},ms);function ms(t,e){var n=ds.call(this)||this;n.injector=t,n.typeName="FrameContext",n.isDestoried=!1,n.isDisposed=!1,n.metadata={identify:"",namespace:"",commands:null,form:null,formControls:null,subForms:null,stateMachine:null,uiStates:null,bindingTo:""},n.componentRefManager=new hs,n.appContext=t.get(Ji),n.destorySignal=new h.Subject,e&&e.appContext===n.appContext?(n.parent=e,n.root=e.root):(n.parent=null,n.root=n),n.frameId=t.get(Gi),n.appContext.contextMetadataManager.exsit(n.frameId)&&(n.metadata=n.appContext.contextMetadataManager.getContextMetadataByName(n.frameId)),n.namespace=t.get(zi,null),n.bindingData=n.injector.get(Cn,new Cn),!n.appContext.useIsoluteEventBus||n.appContext.useIsoluteEventBus&&!n.appContext.isoluteEventBus?n.eventBus=n.injector.get(fo,null,d.InjectFlags.Optional):n.eventBus=n.appContext.isoluteEventBus,n.form=n.injector.get(mn,new mn),n.repository=n.injector.get(Ze,n.appContext.repository);var r=n.injector.get(Me,"valid");n.repository&&(n.repository.entityCollection.changeSetPolicy=r),n.uiState=n.injector.get(Yr,new Yr);var i=new fi;i.setMetadata(n.metadata),n.viewModel=n.injector.get(fi,i),n.variableParseService=t.get(dr,new dr([new vr,new sr,new ur,new lr,new hr])),n.exceptionHandler=t.get(Io,null,d.InjectFlags.Optional);var o=t.get(Rr,null);n.translate=o,ft.setTranslate(o);var a=t.get(To,null);return It.setUserSettings(a),n.initializeRepository(),n.appContext.regFrameContext(n),n.registerAppContextDestroyEvent(),n}var vs=(Object.defineProperty(Es.prototype,"isGridComponent",{get:function(){return this.context&&this.context.viewModel?!!this.context.viewModel.dataGridColumnsName:undefined},enumerable:!0,configurable:!0}),Es.prototype.dispose=function(t){var e=this;this.eventPipes&&this.eventPipes.forEach(function(t){t.disposeByCaller(e)}),this.cd=null,this.context.dispose(),this.destorySignal&&(this.destorySignal.next(),this.destorySignal.complete())},Es.prototype.ngOnInit=function(){this.initialize()},Es.prototype.initialize=function(){this.initialized||(this.context.init(this),this.viewModel=this.context.viewModel,this.cd=this.getChangeDetectorRef(),this.initPublicEvent(),this.initSubscription(),this.restComponent(),this.onFrameComponentInit(),this.initialized=!0)},Es.prototype.onFrameComponentInit=function(){var e=this,t=this.injector.get(qi,null);t&&Array.isArray(t)&&0<t.length&&t.forEach(function(t){t.onComponentInit(e.context)})},Es.prototype.getChangeDetectorRef=function(){return this.injector.get(d.ChangeDetectorRef,null)},Es.prototype.detach=function(){!1!==this.isCdValid()&&this.cd.detach()},Es.prototype.reattach=function(){!1!==this.isCdValid()&&this.cd.reattach()},Es.prototype.detectChanges=function(){!1!==this.isCdValid()&&this.cd.detectChanges()},Es.prototype.isCdValid=function(){return this.cd&&!1===this.cd.destroyed||!1},Es.prototype.restComponent=function(){this.context===this.context.root&&(null!==this.context.appContext.parent&&null!==this.context.appContext.parent.parent||(this.context.repository.reset(),this.context.bindingData.reset()))},Es.prototype.ngOnDestroy=function(){this.dispose()},Es.prototype.initSubscription=function(){this.subscription=this.getSubscription(),this.subscription&&(this.eventPipes=this.subscription.init(this))},Es.prototype.getSubscription=function(){return this.injector.get(po,null)},Es.prototype.initPublicEvent=function(){this.declaration=this.getDeclaration(),this.declaration&&this.declaration.init(this)},Es.prototype.getDeclaration=function(){return this.injector.get(no,null)},Es.prototype.trigger=function(e){var n=this,r=this.context.commandBus.executingCommandCount$.subscribe(function(t){0===t&&(n.innerTrigger(e),r?r.unsubscribe():setTimeout(function(){r&&r.unsubscribe()},0))})},Es.prototype.innerTrigger=function(t){var e=this.declaration&&this.declaration[t];e&&e()},Es.decorators=[{type:d.Injectable}],Es.ctorParameters=function(){return[{type:d.Injector}]},Es);function Es(t){this.injector=t,this.initialized=!1,this.context=this.injector.get(gs,null),this.context&&this.initialize(),this.destorySignal=new h.Subject}var bs=function Ip(){},Cs=(xs.prototype.on=function(e,t,n){this.events.pipe(l.filter(function(t){return t.type===e&&(!t.frameIds||-1<t.frameIds.indexOf(n))})).subscribe(t)},xs.prototype.off=function(t,e){throw new Error("暂不实现")},xs.prototype.trigger=function(t,e,n){var r={type:t,data:e,frameIds:n};this.events.next(r)},xs.decorators=[{type:d.Injectable}],xs);function xs(){this.events=new h.Subject}var Ps=(Is.prototype.create=function(t){var e=this.handlerRegistry.get(t);return e.init(this.frameContext,this.variableParseService),this.extenderRegistry.get(t).reduce(function(t,e){return e.extend(t)},e)},Is.prototype.dispose=function(){this.handlerRegistry.dispose(),this.extenderRegistry.dispose(),this.frameContext=null,this.variableParseService=null},Is.decorators=[{type:d.Injectable}],Is.ctorParameters=function(){return[{type:Lr},{type:Kr},{type:gs},{type:dr}]},Is);function Is(t,e,n,r){this.handlerRegistry=t,this.extenderRegistry=e,this.frameContext=n,this.variableParseService=r}var Ts=(Ms.prototype.dispatch=function(e){var n=this,r=new h.Subject;return this.executeCommand(e).subscribe({next:function(t){r.next(t),r.complete()},complete:function(){r.complete(),n.removeCommandFromExecutingQueue(e)},error:function(t){r.error(t),n.removeCommandFromExecutingQueue(e,!n.is401Error(t))}}),r},Ms.prototype.dispose=function(){this.handlerFactory.dispose()},Ms.prototype.executeCommand=function(t){this.addCommandToExecutingQueue(t);var e=t.name;return this.handlerFactory.create(e).execute(t)},Ms.prototype.addCommandToExecutingQueue=function(t){this.executingCommands.push(t),this.executingCommandCount$.next(this.executingCommands.length)},Ms.prototype.removeCommandFromExecutingQueue=function(e,t){void 0===t&&(t=!0),this.executingCommands=this.executingCommands.filter(function(t){return t!==e}),!0===t&&this.executingCommandCount$.next(this.executingCommands.length)},Ms.prototype.is401Error=function(t){return t&&401===t.status},Ms.decorators=[{type:d.Injectable}],Ms.ctorParameters=function(){return[{type:Ps}]},Ms);function Ms(t){this.handlerFactory=t,this.executingCommands=[],this.executingCommandCount$=new h.BehaviorSubject(this.executingCommands.length)}var Ss,js=[Lr,Kr,Ps,Ts],ws={imports:{}},Os=(c(Ns,Ss=_r),Ns.prototype.dynamicInvoke=function(t,e,n,r){var i=r.frameContext.injector.get(t,null);if(i){this.setContextToServiceInstance(i,r);var o=this.parseService.parse(n,r).map(function(t){return t.expression});return i[e].apply(i,o)}},Ns.prototype.dynamicInvoke2=function(t,e){var n=this,r=t.source,i=t.service,o=t.method,a=t.params.map(function(t){return Object.assign({},t)}),s=new h.Subject,p=r&&r.toLowerCase();if(p){var u=ws.imports[p];u?setTimeout(function(){n.executeWithServiceModule(u,i,e,a,o,s)},0):System["import"](p).then(function(t){t&&(ws.imports[p]=t),n.executeWithServiceModule(t,i,e,a,o,s)})}return s},Ns.prototype.executeWithServiceModule=function(t,e,n,r,i,o){if(t[e]){var a=n.frameContext.injector,s=void 0;if(n.frameContext.injector.get(e,null))s=n.frameContext.injector.get(e);else{var p=this.loadProvidersFromModule(t),u=d.ReflectiveInjector.fromResolvedProviders(p,n.frameContext.injector);s=(n.frameContext.injector=u).get(e,null)}if(s){this.setContextToServiceInstance(s,n);var c=this.parseService.parse(r,n).map(function(t){return t.expression}),l=s[i];if(!l)return void console.error("未找到对应的命令:"+i);var f=l.apply(s,c);(h.isObservable(f)?f:h.of(f)).subscribe({next:function(t){o.next(t)},error:function(t){o.error(t)},complete:function(){o.complete(),n.frameContext.injector=a}})}}},Ns.prototype.schedule=function(){this.scheduleStages(this.method.stages,null)},Ns.prototype.scheduleStages=function(t,e){var r=this;t.reduce(function(t,e){if("executing"===e.type)r.addTask(e.name,function(t){return r.dynamicInvoke2(e,t)});else if("fork"===e.type)e.stages.forEach(function(t){r.scheduleStages(t.stages,t)}),r.scheduleStages(e.stages,e);else{if("determing"!==e.type)throw new Error("unknow method stage type, the "+e.name+"'s type is "+e.type);r.addTask(e.name,function(t){return h.of(!0)})}if(t){var n="determing"===t.type?t.condition:"1===1";r.addLink(t.name,e.name,n)}return e},e)},Ns.prototype.loadProvidersFromModule=function(t){var e=[];for(var n in t)if(Object.prototype.hasOwnProperty.call(t,n)){var r=t[n];if(this.isInjectableService(r)){var i=n;e.push({provide:i,useClass:r}),e.push(r)}}return d.ReflectiveInjector.resolve(e)},Ns.prototype.isInjectableService=function(t){var e=!1,n=t instanceof Function;if(n&&t.hasOwnProperty("decorators"))e=(r=t.decorators.filter(function(t){if(t.type&&t.type.prototype&&"Injectable"===t.type.prototype.ngMetadataName)return t}))&&0<r.length;else if(n&&t.hasOwnProperty("__annotations__")){var r;e=(r=t.__annotations__.filter(function(t){if(t&&t.ngMetadataName&&"Injectable"===t.ngMetadataName)return t}))&&0<r.length}return e},Ns);function Ns(t,e){var n=Ss.call(this)||this;return n.commandName=t,n.method=e,n}var Ds=new d.InjectionToken("@farris/common-service ValidationHandler"),Vs=[fo,po,Xn,jr,Ji,Nt,Cs,Ii],Fs=[fo,po,Xn,Nt,jr,Ii],Rs=[Ji],_s=[Wo,ea,ya,Ia,jo,ra,Vo,Bo,Ro,Lo,{provide:Oe,useClass:nn,multi:!0},{provide:Oe,useClass:an,multi:!0},{provide:Oe,useClass:pn,multi:!0},Fe,{provide:Ho,useClass:Ba,multi:!0},{provide:Ho,useClass:ka,multi:!0},{provide:Ho,useClass:wa,multi:!0},{provide:Ho,useClass:Fa,multi:!0},{provide:Ho,useClass:Ha,multi:!0},{provide:Ho,useClass:za,multi:!0},{provide:Ho,useClass:Wa,multi:!0},{provide:Ho,useClass:Xa,multi:!0},{provide:Ho,useClass:es,multi:!0},{provide:Ho,useClass:is,multi:!0},{provide:Ho,useClass:ss,multi:!0},us,ls,cn],Bs=[{provide:Oo,useClass:Ko,multi:!0},{provide:Oo,useClass:qo,multi:!0},{provide:Oo,useClass:Qo,multi:!0}],As=[{provide:oa,useClass:aa,multi:!0},{provide:oa,useClass:pa,multi:!0},{provide:oa,useClass:ca,multi:!0},{provide:oa,useClass:fa,multi:!0},{provide:oa,useClass:ga,multi:!0},{provide:oa,useClass:va,multi:!0},{provide:oa,useClass:ba,multi:!0},{provide:oa,useClass:xa,multi:!0}],Ls=[js,gs],ks=($s.decorators=[{type:d.NgModule,args:[{providers:Fs}]}],$s);function $s(){}var Us,Hs,Ks=(c(Gs,Us=No),Gs.prototype.buildEventPath=function(t){return null},Gs.decorators=[{type:d.Injectable}],Gs.ctorParameters=function(){return[{type:d.Injector},{type:Cn},{type:undefined,decorators:[{type:d.Inject,args:[zi]}]}]},Gs);function Gs(t,e,n){var r=Us.call(this)||this;return r.injector=t,r.bindingData=e,r.namespace=n,r}(Hs=x.CacheReturnType||(x.CacheReturnType={}))[Hs.Static=1]="Static",Hs[Hs.Promise=2]="Promise";var zs=(qs.prototype.compare=function(t,e){return t===e},qs);function qs(){}var Js=(Ws.prototype.isExpired=function(){return"number"==typeof this.ttl?Date.now().valueOf()>this.createAt.valueOf()+this.ttl:Date.now()>this.ttl.valueOf()},Ws);function Ws(t,e,n){this.key=t,this.content=e,this.ttl=n,this.createAt=new Date}var Ys=(Zs.prototype.get=function(t){var e=this.provider.get(t);return!e||this.isCacheObjectExpired(e)?undefined:e.content},Zs.prototype.set=function(t,e,n){var r=new Js(t,e,n||0);this.provider.set(r)},Zs.prototype.isCacheObjectExpired=function(t){return"number"==typeof t.ttl?Date.now().valueOf()>t.createAt.valueOf()+t.ttl:Date.now()>t.ttl.valueOf()},Zs);function Zs(t){this.provider=t,this.provider=t}var Xs=(Qs.prototype.has=function(e){var n=this;return!(this.store.length<1)&&-1!==this.store.findIndex(function(t){return t&&n.cacheKeyCompare.compare(e,t.key)})},Qs.prototype.length=function(){return this.store.length},Qs.prototype.set=function(t){this.store.push(t)},Qs.prototype.get=function(e){var n=this;return this.store.length<1?undefined:this.store.find(function(t){return n.cacheKeyCompare.compare(e,t.key)})},Qs.prototype["delete"]=function(e){var n=this;if(!(this.store.length<1)){var t=this.store.findIndex(function(t){return t&&n.cacheKeyCompare.compare(e,t.key)});this.store.splice(t,1)}},Qs.prototype.clear=function(){this.store.length=0},Qs.prototype.keys=function(){return this.store.keys()},Qs.prototype.values=function(){return this.store.values()},Qs);function Qs(t){this.store=new Array,this.cacheKeyCompare=t||new zs}var tp=(ep.prototype.has=function(t){return this.buffer.has(t)},ep.prototype.length=function(){return this.buffer.size},ep.prototype.set=function(t){this.buffer.set(t.key,t)},ep.prototype.get=function(t){return this.buffer.get(t)},ep.prototype["delete"]=function(t){this.buffer["delete"](t)},ep.prototype.clear=function(){this.buffer.clear()},ep.prototype.keys=function(){return this.buffer.keys()},ep.prototype.values=function(){return this.buffer.values()},ep);function ep(){this.buffer=new Map}x.ɵb=x.Expression,x.ɵc=No,x.ɵe=Ks,x.ɵa=xr,x.ANNOTATIONS=m,x.PARAMETERS=v,x.PROP_METADATA=C,x.makeDecorator=I,x.makeParamDecorator=function Tp(t,e,n){var r=T(e);function o(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(this instanceof o)return r.apply(this,t),this;var i=new(o.bind.apply(o,b([void 0],t)));return n.annotation=i,n;function n(t,e,n){for(var r=t.hasOwnProperty(v)?t[v]:Object.defineProperty(t,v,{value:[]})[v];r.length<=n;)r.push(null);return(r[n]=r[n]||[]).push(i),t}}return n&&(o.prototype=Object.create(n.prototype)),o.prototype.ngMetadataName=t,o.annotationCls=o},x.makePropDecorator=M,x.MetadataUtil=S,x.ChangeSet=D,x.Modification=O,x.Entity=Fn,x.DynamicEntity=Bn,x.createEntity=Q,x.createEntities=tt,x.EntityFactory=et,x.EntityList=gt,x.NG_FIELD=R,x.NgField=_,x.NG_LIST=B,x.NgList=A,x.NG_OBJECT=L,x.NgObject=k,x.NG_Dynamic=$,x.NgDynamic=U,x.NG_ENTITY=H,x.NgEntity=function Mp(t){return I(H,function(t){return t})(t)},x.FieldMetadataUtil=K,x.EntityMetadataUtil=z,x.PARENT_PATH=J,x.PARENT_CLASS=W,x.ENTITY_DATA_SERVICE_TOKEN=Un,x.ValidationTypes=rt,x.Validator=yt,x.ValidationError=ot,x.entityPrototype=Hn,x.EntityTypeFactory=Yn,x.EntityTypeCreator=Z,x.RestfulService=Xn,x.NG_REPOSITORY=_e,x.NgRepository=function Sp(t){return I(_e,function(t){return t})(t)},x.EntityCollection=Be,x.EntityManager=Le,x.Repository=Ze,x.DefaultRepository=tn,x.SortConditionManager=Ge,x.FilterConditionManager=qe,x.BigNumberType=Ct,x.DEVKIT_RUN_MODE=Pt,x.DataPathNode=he,x.DataPath=ye,x.DataPathCreator=me,x.DataPropInfo=Ee,x.DataTypeInfo=be,x.FORM_PATH_TOKEN=xe,x.BACK_END_MESSAGE_HANDLER_TOKEN=Pe,x.MESSAGE_SERVICE_TOKEN=Ie,x.NOTIFY_SERVICE_TOKEN=Te,x.CHANGE_SET_POLICY_TOKEN=Me,x.encodeUrl=function jp(t){return String(t).replace(/(^|[^\uD800-\uDBFF])[\uDC00-\uDFFF]|[\uD800-\uDBFF]([^\uDC00-\uDFFF]|$)/g,"$1�$2").replace(/(?:[^\x21\x25\x26-\x3B\x3D\x3F-\x5B\x5D\x5F\x61-\x7A\x7E]|%(?:[^0-9A-Fa-f]|[0-9A-Fa-f][^0-9A-Fa-f]|$))+/g,encodeURI).replace(/#/g,"%23").replace(/&/g,"%26")},x.Core=Se,x.escape=we,x.NG_COMMAND_HANDLER=tr,x.NgCommandHandler=function wp(t){return I(tr,function(t){return t})(t)},x.NG_COMMAND_HANDLER_EXTENDER=er,x.NgCommandHandlerExtender=function Op(t){return I(er,function(t){return t})(t)},x.TaskNode=nr,x.TaskLink=wr,x.TaskFlow=Nr,x.CommandContext=Vr,x.CommandHandler=_r,x.COMMAND_HANDLERS_TOKEN=Ar,x.CommandHandlerRegistry=Lr,x.CommandHandlerExtender=$r,x.COMMAND_HANDLER_EXTENDERS_TOKEN=Hr,x.CommandHandlerExtenderRegistry=Kr,x.CommandHandlerFactory=Ps,x.CommandBus=Ts,x.COMMAND_PROVIDERS=js,x.DynamicCommandHandler=Os,x.BaseBindingObject=Vt,x.BindingObject=At,x.BindingList=Pn,x.BindingData=Cn,x.PropertyUtil=Rt,x.EntityUtil=En,x.BindingListFactory=Ut,x.BindingObjectFactory=zt,x.BindingDataFactory=Tn,x.NG_BINDING_DATA=Sn,x.NgBindingData=function Np(t){return I(Sn,function(t){return t})(t)},x.BindingObjectTypeFactory=Kt,x.BindingListTypeFactory=kt,x.Form=mn,x.NG_VALIDATE_FORM=Jt,x.NgValidateForm=function Dp(t){return I(Jt,function(t){return t})(t)},x.NG_CHILD_FORM=Wt,x.NgChildForm=Yt,x.NG_CHILD_FORM_ARRAY=Zt,x.NgChildFormArray=Xt,x.NG_FORM_CONTROL=Qt,x.NgFormControl=te,x.State=Qr,x.initialUIState=!1,x.StateMachineContext=ti,x.effectHandlers=ii,x.StateMachine=oi,x.NgState=si,x.NgRenderState=pi,x.NgAction=ui,x.UIState=Yr,x.NG_COMPONENT_STATE=zr,x.NgParam=qr,x.UIStateMetadataUtil=Jr,x.PARAM_TYPE_TRANSFORM_TOKEN=Xr,x.EventBus=fo,x.EventCache=yo,x.EventBusProxy=Xi,x.EventPipe=co,x.NG_DECLARATION=eo,x.NgDeclaration=function Vp(t){return M(eo,function(t){return t})(t)},x.Declaration=no,x.NG_SUBSCRIPTION=io,x.ParamMap=oo,x.NgSubscription=function Fp(t){return M(io,function(t){return t})(t)},x.getNgSubscriptionDecoratorFactory=function Rp(){return M(io,function(t){return t})},x.Subscription=po,x.ViewModel=fi,x.NG_COMMAND=ci,x.NgCommand=li,x.Context=yi,x.BindingDataManager=gi,x.RepositoryManager=vi,x.FrameContextManager=Yi,x.FrameComponentRefresher=bi,x.AppContext=Ji,x.AppContextManager=Ii,x.ViewModelManager=ki,x.FORM_ID=ji,x.EXCEPTION_HANDLER=Io,x.VALIDATION_HANDLER=Ds,x.VARIABLE_PARSERS=ir,x.FrameIdVariableParser=vr,x.DataVariableParser=sr,x.UIStateVariableParser=ur,x.CommandVariableParser=hr,x.StateMachineVariableParser=lr,x.VariableParseService=dr,x.EventParamVariableParser=Mr,x.VARIABLE_PROVIDERS=jr,x.FrameContext=gs,x.FrameComponent=vs,x.FrameEvent=bs,x.FrameEventBus=Cs,x.FRAME_ID=Gi,x.NAMESPACE=zi,x.FRAME_COMPONENT_INIT_HANDLER_TOKEN=qi,x.RouterParamService=Nt,x.DataPathUtil=jn,x.UID=We,x.Guid=On,x.RunModeService=Dn,x.DateUtil=ct,x.BindingPathConverter=ee,x.BindingPathComparer=re,x.BindingPathTraverser=oe,x.EntityPathConverter=se,x.EntityPathComparer=ce,x.FormPathConverter=le,x.ExpressionUtil=fn,x.DataTypeInfoUtil=yn,x.FARRIS_DEVKIT_APP_PROVIDERS=Vs,x.FARRIS_DEVKIT_MODULE_PROVIDERS=Fs,x.FARRIS_DEVKIT_ROOT_FRAME_PROVIDERS=Rs,x.FARRIS_DEVKIT_EXPRESSION_ROOT_FRAME_PROVIDERS=_s,x.FARRIS_DEVKIT_EXPRESSION_LISTENER_PROVIDERS=Bs,x.FARRIS_DEVKIT_EXPRESSION_EFFECTOR_PROVIDERS=As,x.FARRIS_DEVKIT_FRAME_PROVIDERS=Ls,x.DevkitModule=ks,x.TranslateToken=Rr,x.UserSettingsToken=To,x.ZonedTime=Mt,x.Schema=Kn,x.SchemaEntity=Gn,x.SchemaEntityType=zn,x.SchemaEntityField=qn,x.SchemaEntityFieldType=Jn,x.SchemaEntityFieldEditor=Wn,x.DomService=wi,x.FormContent=Ni,x.FormContentForDB=Di,x.FormMetadaDataDom=Vi,x.FormModule=Fi,x.FormOptions=Ri,x.LISTENER_TOKEN=Oo,x.UIStateChangeListener=Ko,x.RepositoryChangeListener=qo,x.ListenerRegistry=Wo,x.BindingDataChangeListener=Qo,x.Listeners=ea,x.FORM_MANIFEST_SERVICE_TOKEN=Mo,x.FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN=So,x.ExpressionEventEmitter=ra,x.ExpressionRegistry=jo,x.ExpressionExecutor=Vo,x.ExpressionEngineImpl=ls,x.ExpressionManager=Bo,x.ExpressionResult=Ro,x.ExpressionResultFactory=Lo,x.ASSIGNER_TOKEN=Uo,x.EVENT_HANDLER_TOKEN=Ho,x.EFFECTOR_TOKEN=oa,x.RepositoryEffector=aa,x.UIStateEffector=pa,x.ReadonlyEffector=ca,x.DependencyEffector=fa,x.EffectorRegistry=ya,x.EffectorFactory=Ia,x.RelativeEffector=ga,x.ValidateEffector=va,x.RequiredEffector=ba,x.VisibleEffector=xa,x.RESOLVER_TOKEN=Oe,x.ENTITY_TEMPLATE=Ne,x.STATE_TEMPLATE=De,x.GROUP_FUNCTIONS=Ve,x.ResolverRegistry=Fe,x.EntityDependencyResolver=nn,x.StateDependencyResolver=an,x.CommentDependencyResolver=pn,x.ResolveService=cn,x.EntityValueChangedEventHandler=wa,x.StateValueChangedEventHandler=Fa,x.RepositoryAddEntityEventHandler=Ba,x.RepositoryRemoveEntityEventHandler=ka,x.RepositoryLoadEventHandler=Ha,x.EntityUpdateEventHandler=za,x.BindingDataAppendObjectEventHandler=Wa,x.BindingDataValueChangeEventHandler=Xa,x.BindingDataRemoveObjectEventHandler=es,x.BindingDataLoadEventHandler=is,x.BindingDataSelectionChangedEventHandler=ss,x.EventHandlerRegistry=us,x.EventHandler=Ma,x.CacheKeyCompare=zs,x.Cacheable=function _p(h){return function(t,c,e){e===undefined&&(e=Object.getOwnPropertyDescriptor(t,c));var l=t.name||t&&t.constructor&&t.constructor.name,f=e.value;return e.value=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=h&&h.ttl||0,r=h&&h.provider;if(!r)throw new Error("cache provider is not defined.");var i=h&&h.key||undefined;i&&i instanceof Function&&(i=i(this,t));var o=i;if(!o){var a=JSON.stringify(t);o=l+"#"+String(c)+"#"+a}var s=r.get(o);if(!s||n&&!0===s.isExpired()){var p=f.apply(this,t),u=new Js(o,p,n);return r.set(u),p}return s&&s.content},e}},x.CacheContainer=Ys,x.CacheObject=Js,x.MemoryCacheProvider=Xs,x.DefaultCacheProvider=tp,Object.defineProperty(x,"__esModule",{value:!0})});
//# sourceMappingURL=farris-devkit.umd.min.js.map