import { PARENT_CLASS, FieldMetadataUtil } from '../entity/index';
import { ModifyType } from '../changeset/index';
import { ChangeType } from './changes';
import { BindingPropertyType } from './binding_property';
import { BindingObjectFactory } from './binding_object_factory';
/**
 * 实体操作工具类
 */
var EntityUtil = /** @class */ (function () {
    function EntityUtil() {
    }
    /**
     * 将entity的数据加载到bindingObject中，并保持两者同步。
     * @param entity        实体对象
     * @param bindingObject 绑定对象
     */
    EntityUtil.loadEntity = function (entity, bindingObject) {
        var _this = this;
        // 遍历bindingObject的properties进行赋值
        bindingObject.properties.forEach(function (property) {
            var propertyName = property.name;
            if (property.type === BindingPropertyType.List) {
                _this.loadEntityList(entity[propertyName] || entity[PARENT_CLASS], bindingObject[propertyName]);
            }
            else if (property.type === BindingPropertyType.Object) {
                if (entity && entity[propertyName]) {
                    _this.loadEntity(entity[propertyName], bindingObject[propertyName]);
                }
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                if (entity && entity[propertyName]) {
                    var dynamicObject = BindingObjectFactory.createDynamicBindingObject(entity[propertyName].data);
                    BindingObjectFactory.attachDynamicObjectProperty(bindingObject, propertyName, dynamicObject);
                    _this.loadEntity(entity[propertyName], bindingObject[propertyName]);
                }
            }
            else {
                bindingObject.setValue(propertyName, entity[propertyName], false, false);
            }
        });
        this.setUpEntityPipeline(entity, bindingObject);
    };
    /**
     * 建立entity和bindingObject之间的关联
     * @param entity        实体对象
     * @param bindingObject 绑定对象
     */
    EntityUtil.setUpEntityPipeline = function (entity, bindingObject) {
        // 监听entity变更
        entity.onValueChanged.subscribe(function (modification) {
            if (modification.type !== ModifyType.ValueChange || modification.path.length === 0) {
                return;
            }
            var propertyName = modification.path[modification.path.length - 1];
            var primaryKeyPath = modification.path[modification.path.length - 2];
            // 验证主键是否匹配
            // 存在主键并且主键不是id时才检查（值对象、关联对象不检查）
            if (bindingObject.primaryKey && bindingObject.primaryKey === 'id') {
                var primaryKey = bindingObject.primaryKey;
                var primaryKeyValue = bindingObject.getValue(primaryKey);
                if (primaryKeyPath !== primaryKey + ":" + primaryKeyValue) {
                    return;
                }
            }
            // 值没有发生变化，不再设置
            // TODO: 通过bindingObject修改entity属性值时，entity总会触发一个变更回来，如果不截获这个重复的变更，会导致重复或死循环
            if (bindingObject.getValue(propertyName) === modification.value) {
                return;
            }
            bindingObject.setValue(propertyName, modification.value, true, false, modification.errors);
        });
        // 监听bindingObject变更
        bindingObject.viewChanges.subscribe(function (viewChange) {
            var value = viewChange.value;
            var propertyName = viewChange.path[0];
            var pathPrefix = '';
            var pathData = entity.getPaths();
            var paths = pathData.path;
            var id = bindingObject['id'];
            if (pathData.isUdt) {
                // grid中udt没有id，从父级中取出id，以便存放验证信息
                var getParentId = function (target) {
                    var parentId = '';
                    var findId = function (item) {
                        if (item && item && item['id']) {
                            parentId = item['id'];
                            return;
                        }
                        else if (item['parent']) {
                            findId(item['parent']);
                        }
                    };
                    findId(target);
                    return parentId;
                };
                id = getParentId(bindingObject);
                if (pathData.isGrid) {
                    // grid 将从表主字段去除
                    paths.shift();
                }
                if (paths.length) {
                    pathPrefix = paths.join('.') + '.';
                }
            }
            // 不是主键值字段时，要先检查主键是否存在，并且主键是否相等（防止后代变更冒泡上来）
            // 非主键属性变更时，要先检查主键是否匹配（如果主键也修改了，要求先修改主键再修改其他值）
            if (bindingObject.primaryKey) {
                var primaryKey = bindingObject.primaryKey;
                if (propertyName !== primaryKey) {
                    if (!entity[primaryKey] || entity[primaryKey] !== bindingObject[primaryKey]) {
                        return;
                    }
                }
            }
            // 如果BindingObject上的属性值和Entity上对应属性值一样，则不再设置
            if (entity[propertyName] === value) {
                return;
            }
            // 调用表单验证,通过后调用实体验证
            // bingdingObject变化后，先调用实体上的验证，通过后再设置实体的变动
            entity[propertyName] = value;
        });
    };
    /**
     * 将entityList中的Entity对象转换为BindingObject对象，加载到bindingList中，并保持entityList和bindingList同步。
     * @param entityList  实体列表
     * @param bindingList 绑定列表
     */
    EntityUtil.loadEntityList = function (entityList, bindingList) {
        this.loadEntities(entityList.items, bindingList);
        this.setUpEntityListPipeline(entityList, bindingList);
    };
    /**
     * 建立entityList和bindingList之间的关联
     * @param entityList  实体列表
     * @param bindingList 绑定列表
     */
    EntityUtil.setUpEntityListPipeline = function (entityList, bindingList) {
        var _this = this;
        entityList.onListChanged.subscribe(function (modification) {
            switch (modification.type) {
                // 添加实体
                case ModifyType.Add:
                    var entitiesToAdd = modification.value;
                    if (entitiesToAdd.length === 0) {
                        return;
                    }
                    // 检查父id是否一致，冒泡导致的变更不处理
                    var paths = modification.path;
                    var parentPath = paths[paths.length - 2];
                    var parentId = bindingList.parent.primaryKeyValue;
                    if (parentPath.indexOf(parentId) === -1) {
                        return;
                    }
                    _this.appendEntities(modification.value, bindingList);
                    break;
                // 删除实体
                case ModifyType.Remove:
                    // 删除实体（value格式待商榷，目前value的格式为 { primaryKey: primaryValue}）
                    var id = modification.value[bindingList.primaryKey];
                    bindingList.removeByIds([id]);
                    // this.removeEntities(<Entity[]>modification.value, bindingList);
                    break;
                // 加载实体
                case ModifyType.Load:
                    var entities = modification.value;
                    _this.loadEntities(entities, bindingList);
                    break;
                default:
                    break;
            }
        });
    };
    /**
     * 监听repository变化，保持repository和bindingList同步。
     * @param repository  实体仓库
     * @param bindingList 绑定列表
     */
    EntityUtil.loadRepository = function (repository, bindingList) {
        var _this = this;
        // 初次加载
        var entities = Array.from(repository.entityCollection.toArray());
        this.loadEntities(entities, bindingList);
        // 监听变化
        repository.entityCollectionChange.subscribe(function (modification) {
            switch (modification.type) {
                case ModifyType.Load:
                    _this.loadEntities(modification.value, bindingList);
                    break;
                case ModifyType.Add:
                    _this.appendEntities(modification.value, bindingList);
                    break;
                case ModifyType.Remove:
                    _this.removeEntities(modification.value, bindingList);
                    break;
                case ModifyType.PaginationInfoChange:
                    bindingList.paginationInfo = modification.value;
                    break;
                default:
                    break;
            }
        });
        // 监听BindingList数据变化
        bindingList.changes.subscribe(function (change) {
            if (change.type === ChangeType.PaginationInfoChange) {
                var entityCollection = repository.entityCollection;
                // const entityTypeName = entityCollection.entityTypeName;
                // const original = entityCollection.paginationInfo[entityTypeName];
                // const entityPaginationInfo = Object.assign({}, original, change.value);
                entityCollection.paginationInfo = Object.assign({}, entityCollection.paginationInfo, change.value);
            }
        });
    };
    /**
     * 将entities中的Entity对象转换为BindingObject对象，并加载到bindingList中
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.loadEntities = function (entities, bindingList) {
        var bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.load(bindingObjects);
    };
    /**
     * 将entities中的Entity对象转换为BIndingObject对象，并追加到bindingList中
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.appendEntities = function (entities, bindingList) {
        var bindingObjects = this.createBindingObjects(entities, bindingList);
        bindingList.append(bindingObjects);
    };
    /**
     * 从bindingList移除entities对应的BindingObject对象
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.removeEntities = function (entities, bindingList) {
        if (entities === null || entities.length === 0) {
            return;
        }
        // 归集要删除的id数组
        var primaryKey = bindingList.primaryKey;
        var ids = [];
        entities.forEach(function (entity) {
            ids.push(entity[primaryKey]);
        });
        bindingList.removeByIds(ids);
    };
    /**
     * 将entities中的Entity对象转换为BindingObject对象
     * @param entities    实体数组
     * @param bindingList 绑定列表
     */
    EntityUtil.createBindingObjects = function (entities, bindingList) {
        var _this = this;
        if (entities === null || entities.length === 0) {
            return [];
        }
        var bindingObjects = [];
        entities.forEach(function (entity) {
            var bindingObject = BindingObjectFactory.create(bindingList.properties);
            _this.loadEntity(entity, bindingObject);
            // // 为bindingObject设置默认值initialData属性
            // if (entity['initialData']) {
            //   bindingObject['initialData'] = entity['initialData'];
            // }
            bindingObjects.push(bindingObject);
        });
        return bindingObjects;
    };
    EntityUtil.watchReposiroty = function (repository, bindingData) {
        // reposiroty => bindingData
        repository.entityCollectionChange.subscribe(function (modification) {
            switch (modification.type) {
                case ModifyType.PaginationInfoChange:
                    bindingData.pagingInfo = modification.value;
                    break;
                default:
                    break;
            }
        });
    };
    /**
     * 查找属性的类型
     * @param entityType 实体类型
     * @param targetPropName 属性名称
     * @return 属性信息，包含属性类型（NgField、NgObject、NgList）和属性对应的实体类型（当NgField类型时为null）
     */
    EntityUtil.getPropInfo = function (entityType, targetPropName) {
        var propType;
        var propEntityType;
        // NgField
        var ngFieldProperties = FieldMetadataUtil.getNgFields(entityType);
        Object.keys(ngFieldProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgField';
                propEntityType = null;
            }
        });
        // NgObject
        var ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);
        Object.keys(ngObjectProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgObject';
                propEntityType = ngObjectProperties[propName].type;
            }
        });
        // NgList
        var ngListProperties = FieldMetadataUtil.getNgList(entityType);
        Object.keys(ngListProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgList';
                propEntityType = ngListProperties[propName].type;
            }
        });
        var ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);
        Object.keys(ngDynamicProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                propType = 'NgDynamic';
                propEntityType = ngDynamicProperties[propName].type;
            }
        });
        return { propType: propType, propEntityType: propEntityType };
    };
    /**
     * 获取实体的主键名
     * @param entityType 实体类型
     */
    EntityUtil.getPrimaryKey = function (entityType) {
        var primaryNgFiledProp = FieldMetadataUtil.getPrimaryFieldMetadata(entityType);
        if (primaryNgFiledProp) {
            return primaryNgFiledProp.dataField;
        }
        else {
            return '';
        }
    };
    /**
     * 是否为对象属性
     */
    EntityUtil.isObjectProp = function (entityType, targetPropName) {
        var isObjectProp = false;
        var ngObjectProperties = FieldMetadataUtil.getNgObjects(entityType);
        Object.keys(ngObjectProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                isObjectProp = true;
            }
        });
        return isObjectProp;
    };
    /**
     * 检查是否是动态列属性
     */
    EntityUtil.isDynamicProp = function (entityType, targetPropName) {
        var isDynamicProp = false;
        var ngDynamicProperties = FieldMetadataUtil.getNgDynamic(entityType);
        Object.keys(ngDynamicProperties).forEach(function (propName) {
            if (propName === targetPropName) {
                isDynamicProp = true;
            }
        });
        return isDynamicProp;
    };
    /**
     * 为实体增加initialData属性
     * @param entity 实体实例
     * @param initialData 默认值对象
     */
    EntityUtil.appendInitialData = function (entity, initialData) {
        var data = Object.assign({}, initialData);
        delete data.id;
        delete data.parentID;
        entity['initialData'] = data;
    };
    return EntityUtil;
}());
export { EntityUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3V0aWwuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1kYXRhL2VudGl0eV91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBc0IsWUFBWSxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDdEYsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5RCxPQUFPLEVBQXNCLFVBQVUsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUczRCxPQUFPLEVBQW1CLG1CQUFtQixFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDMUUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFJaEU7O0dBRUc7QUFDSDtJQUFBO0lBZ1pBLENBQUM7SUE5WUM7Ozs7T0FJRztJQUNJLHFCQUFVLEdBQWpCLFVBQWtCLE1BQWMsRUFBRSxhQUE0QjtRQUE5RCxpQkF1QkM7UUFyQkMsaUNBQWlDO1FBQ2pDLGFBQWEsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBeUI7WUFDekQsSUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztZQUNuQyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEtBQUssbUJBQW1CLENBQUMsSUFBSSxFQUFFO2dCQUM5QyxLQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUUsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7YUFDaEc7aUJBQU0sSUFBSSxRQUFRLENBQUMsSUFBSSxLQUFLLG1CQUFtQixDQUFDLE1BQU0sRUFBRTtnQkFDdkQsSUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFO29CQUNsQyxLQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsRUFBRSxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztpQkFDcEU7YUFDRjtpQkFBTSxJQUFJLFFBQVEsQ0FBQyxJQUFJLEtBQUssbUJBQW1CLENBQUMsT0FBTyxFQUFFO2dCQUN4RCxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUU7b0JBQ2xDLElBQU0sYUFBYSxHQUFHLG9CQUFvQixDQUFDLDBCQUEwQixDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDakcsb0JBQW9CLENBQUMsMkJBQTJCLENBQUMsYUFBYSxFQUFFLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztvQkFDN0YsS0FBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUUsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7aUJBQ3BFO2FBQ0Y7aUJBQU07Z0JBQ0wsYUFBYSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQzthQUMxRTtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLDhCQUFtQixHQUExQixVQUEyQixNQUFjLEVBQUUsYUFBNEI7UUFFckUsYUFBYTtRQUNiLE1BQU0sQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLFVBQUMsWUFBMEI7WUFDekQsSUFBSSxZQUFZLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxXQUFXLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNsRixPQUFPO2FBQ1I7WUFDRCxJQUFNLFlBQVksR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3JFLElBQU0sY0FBYyxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFFdkUsV0FBVztZQUNYLGdDQUFnQztZQUNoQyxJQUFJLGFBQWEsQ0FBQyxVQUFVLElBQUksYUFBYSxDQUFDLFVBQVUsS0FBSyxJQUFJLEVBQUU7Z0JBQ2pFLElBQU0sVUFBVSxHQUFHLGFBQWEsQ0FBQyxVQUFVLENBQUM7Z0JBQzVDLElBQU0sZUFBZSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7Z0JBQzNELElBQUksY0FBYyxLQUFRLFVBQVUsU0FBSSxlQUFpQixFQUFFO29CQUN6RCxPQUFPO2lCQUNSO2FBQ0Y7WUFFRCxlQUFlO1lBQ2YsNEVBQTRFO1lBQzVFLElBQUksYUFBYSxDQUFDLFFBQVEsQ0FBQyxZQUFZLENBQUMsS0FBSyxZQUFZLENBQUMsS0FBSyxFQUFFO2dCQUMvRCxPQUFPO2FBQ1I7WUFDRCxhQUFhLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdGLENBQUMsQ0FBQyxDQUFDO1FBRUgsb0JBQW9CO1FBQ3BCLGFBQWEsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLFVBQUMsVUFBc0I7WUFDekQsSUFBTSxLQUFLLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQztZQUMvQixJQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXhDLElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQztZQUNwQixJQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDbkMsSUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztZQUM1QixJQUFJLEVBQUUsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0IsSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFO2dCQUNsQixpQ0FBaUM7Z0JBQ2pDLElBQU0sV0FBVyxHQUFHLFVBQUMsTUFBVztvQkFDOUIsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO29CQUNsQixJQUFNLE1BQU0sR0FBRyxVQUFDLElBQVM7d0JBQ3ZCLElBQUksSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7NEJBQzlCLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQ3RCLE9BQU87eUJBQ1I7NkJBQU0sSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUU7NEJBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQzt5QkFDeEI7b0JBQ0gsQ0FBQyxDQUFDO29CQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDZixPQUFPLFFBQVEsQ0FBQztnQkFDbEIsQ0FBQyxDQUFDO2dCQUNGLEVBQUUsR0FBRyxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ2hDLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTtvQkFDbkIsZ0JBQWdCO29CQUNoQixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7aUJBQ2Y7Z0JBQ0QsSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFO29CQUNoQixVQUFVLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7aUJBQ3BDO2FBQ0Y7WUFFRCwyQ0FBMkM7WUFDM0MsOENBQThDO1lBQzlDLElBQUksYUFBYSxDQUFDLFVBQVUsRUFBRTtnQkFDNUIsSUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLFVBQVUsQ0FBQztnQkFDNUMsSUFBSSxZQUFZLEtBQUssVUFBVSxFQUFFO29CQUMvQixJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxhQUFhLENBQUMsVUFBVSxDQUFDLEVBQUU7d0JBQzNFLE9BQU87cUJBQ1I7aUJBQ0Y7YUFDRjtZQUVELDRDQUE0QztZQUM1QyxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsS0FBSyxLQUFLLEVBQUU7Z0JBQ2xDLE9BQU87YUFDUjtZQUVELG1CQUFtQjtZQUNuQiwwQ0FBMEM7WUFDMUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUMvQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7OztPQUlHO0lBQ0kseUJBQWMsR0FBckIsVUFBc0IsVUFBMkIsRUFBRSxXQUF3QjtRQUN6RSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFakQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFVBQVUsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLGtDQUF1QixHQUE5QixVQUErQixVQUEyQixFQUFFLFdBQXdCO1FBQXBGLGlCQXlDQztRQXZDQyxVQUFVLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxVQUFDLFlBQTBCO1lBQzVELFFBQVEsWUFBWSxDQUFDLElBQUksRUFBRTtnQkFFekIsT0FBTztnQkFDUCxLQUFLLFVBQVUsQ0FBQyxHQUFHO29CQUNqQixJQUFNLGFBQWEsR0FBYSxZQUFZLENBQUMsS0FBSyxDQUFDO29CQUNuRCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO3dCQUM5QixPQUFPO3FCQUNSO29CQUVELHVCQUF1QjtvQkFDdkIsSUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztvQkFDaEMsSUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQzNDLElBQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDO29CQUNwRCxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7d0JBQ3ZDLE9BQU87cUJBQ1I7b0JBRUQsS0FBSSxDQUFDLGNBQWMsQ0FBVyxZQUFZLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO29CQUMvRCxNQUFNO2dCQUVSLE9BQU87Z0JBQ1AsS0FBSyxVQUFVLENBQUMsTUFBTTtvQkFFcEIsMkRBQTJEO29CQUMzRCxJQUFNLEVBQUUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztvQkFDdEQsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQzlCLGtFQUFrRTtvQkFDbEUsTUFBTTtnQkFFUixPQUFPO2dCQUNQLEtBQUssVUFBVSxDQUFDLElBQUk7b0JBQ2xCLElBQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUM7b0JBQ3BDLEtBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFdBQVcsQ0FBQyxDQUFDO29CQUN6QyxNQUFNO2dCQUNSO29CQUNFLE1BQU07YUFDVDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSx5QkFBYyxHQUFyQixVQUFzQixVQUEyQixFQUFFLFdBQXdCO1FBQTNFLGlCQW9DQztRQWxDQyxPQUFPO1FBQ1AsSUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUNuRSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUV6QyxPQUFPO1FBQ1AsVUFBVSxDQUFDLHNCQUFzQixDQUFDLFNBQVMsQ0FBQyxVQUFDLFlBQTBCO1lBQ3JFLFFBQVEsWUFBWSxDQUFDLElBQUksRUFBRTtnQkFDekIsS0FBSyxVQUFVLENBQUMsSUFBSTtvQkFDbEIsS0FBSSxDQUFDLFlBQVksQ0FBVyxZQUFZLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO29CQUM3RCxNQUFNO2dCQUNSLEtBQUssVUFBVSxDQUFDLEdBQUc7b0JBQ2pCLEtBQUksQ0FBQyxjQUFjLENBQVcsWUFBWSxDQUFDLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztvQkFDL0QsTUFBTTtnQkFDUixLQUFLLFVBQVUsQ0FBQyxNQUFNO29CQUNwQixLQUFJLENBQUMsY0FBYyxDQUFXLFlBQVksQ0FBQyxLQUFLLEVBQUUsV0FBVyxDQUFDLENBQUM7b0JBQy9ELE1BQU07Z0JBQ1IsS0FBSyxVQUFVLENBQUMsb0JBQW9CO29CQUNsQyxXQUFXLENBQUMsY0FBYyxHQUFlLFlBQVksQ0FBQyxLQUFLLENBQUM7b0JBQzVELE1BQU07Z0JBQ1I7b0JBQ0UsTUFBTTthQUNUO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxvQkFBb0I7UUFDcEIsV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsVUFBQyxNQUFjO1lBQzNDLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsb0JBQW9CLEVBQUU7Z0JBQ25ELElBQU0sZ0JBQWdCLEdBQUcsVUFBVSxDQUFDLGdCQUFnQixDQUFDO2dCQUNyRCwwREFBMEQ7Z0JBQzFELG9FQUFvRTtnQkFDcEUsMEVBQTBFO2dCQUMxRSxnQkFBZ0IsQ0FBQyxjQUFjLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsZ0JBQWdCLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNwRztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSx1QkFBWSxHQUFuQixVQUFvQixRQUFrQixFQUFFLFdBQXdCO1FBQzlELElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDeEUsV0FBVyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLHlCQUFjLEdBQXJCLFVBQXNCLFFBQWtCLEVBQUUsV0FBd0I7UUFDaEUsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUN4RSxXQUFXLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7OztPQUlHO0lBQ0kseUJBQWMsR0FBckIsVUFBc0IsUUFBa0IsRUFBRSxXQUF3QjtRQUNoRSxJQUFJLFFBQVEsS0FBSyxJQUFJLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDOUMsT0FBTztTQUNSO1FBRUQsYUFBYTtRQUNiLElBQU0sVUFBVSxHQUFHLFdBQVcsQ0FBQyxVQUFVLENBQUM7UUFDMUMsSUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2YsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQWM7WUFDOUIsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUMsQ0FBQztRQUNILFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSwrQkFBb0IsR0FBM0IsVUFBNEIsUUFBa0IsRUFBRSxXQUF3QjtRQUF4RSxpQkFtQkM7UUFqQkMsSUFBSSxRQUFRLEtBQUssSUFBSSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzlDLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFFRCxJQUFNLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFDMUIsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQWM7WUFDOUIsSUFBTSxhQUFhLEdBQUcsb0JBQW9CLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMxRSxLQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxhQUFhLENBQUMsQ0FBQztZQUV2QyxzQ0FBc0M7WUFDdEMsK0JBQStCO1lBQy9CLDBEQUEwRDtZQUMxRCxJQUFJO1lBRUosY0FBYyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUNyQyxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFDYSwwQkFBZSxHQUE3QixVQUE4QixVQUEyQixFQUFFLFdBQXdCO1FBQ2pGLDRCQUE0QjtRQUM1QixVQUFVLENBQUMsc0JBQXNCLENBQUMsU0FBUyxDQUFDLFVBQUMsWUFBMEI7WUFDckUsUUFBUSxZQUFZLENBQUMsSUFBSSxFQUFFO2dCQUN6QixLQUFLLFVBQVUsQ0FBQyxvQkFBb0I7b0JBQ2xDLFdBQVcsQ0FBQyxVQUFVLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQztvQkFDNUMsTUFBTTtnQkFDUjtvQkFDRSxNQUFNO2FBQ1Q7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNJLHNCQUFXLEdBQWxCLFVBQW1CLFVBQWUsRUFBRSxjQUFzQjtRQUV4RCxJQUFJLFFBQWdCLENBQUM7UUFDckIsSUFBSSxjQUFtQixDQUFDO1FBRXhCLFVBQVU7UUFDVixJQUFNLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNwRSxNQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsUUFBZ0I7WUFDdEQsSUFBSSxRQUFRLEtBQUssY0FBYyxFQUFFO2dCQUMvQixRQUFRLEdBQUcsU0FBUyxDQUFDO2dCQUNyQixjQUFjLEdBQUcsSUFBSSxDQUFDO2FBQ3ZCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxXQUFXO1FBQ1gsSUFBTSxrQkFBa0IsR0FBRyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdEUsTUFBTSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQWdCO1lBQ3ZELElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtnQkFDL0IsUUFBUSxHQUFHLFVBQVUsQ0FBQztnQkFDdEIsY0FBYyxHQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQzthQUNwRDtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsU0FBUztRQUNULElBQU0sZ0JBQWdCLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2pFLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFnQjtZQUNyRCxJQUFJLFFBQVEsS0FBSyxjQUFjLEVBQUU7Z0JBQy9CLFFBQVEsR0FBRyxRQUFRLENBQUM7Z0JBQ3BCLGNBQWMsR0FBRyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDbEQ7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILElBQU0sbUJBQW1CLEdBQUcsaUJBQWlCLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3ZFLE1BQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFnQjtZQUN4RCxJQUFJLFFBQVEsS0FBSyxjQUFjLEVBQUU7Z0JBQy9CLFFBQVEsR0FBRyxXQUFXLENBQUM7Z0JBQ3ZCLGNBQWMsR0FBRyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUM7YUFDckQ7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sRUFBRSxRQUFRLFVBQUEsRUFBRSxjQUFjLGdCQUFBLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ksd0JBQWEsR0FBcEIsVUFBcUIsVUFBZTtRQUNsQyxJQUFNLGtCQUFrQixHQUFHLGlCQUFpQixDQUFDLHVCQUF1QixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2pGLElBQUksa0JBQWtCLEVBQUU7WUFDdEIsT0FBTyxrQkFBa0IsQ0FBQyxTQUFTLENBQUM7U0FDckM7YUFBTTtZQUNMLE9BQU8sRUFBRSxDQUFDO1NBQ1g7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSSx1QkFBWSxHQUFuQixVQUFvQixVQUFlLEVBQUUsY0FBc0I7UUFDekQsSUFBSSxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQ3pCLElBQU0sa0JBQWtCLEdBQUcsaUJBQWlCLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3RFLE1BQU0sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxRQUFnQjtZQUN2RCxJQUFJLFFBQVEsS0FBSyxjQUFjLEVBQUU7Z0JBQy9CLFlBQVksR0FBRyxJQUFJLENBQUM7YUFDckI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFFRDs7T0FFRztJQUNJLHdCQUFhLEdBQXBCLFVBQXFCLFVBQWUsRUFBRSxjQUFzQjtRQUMxRCxJQUFJLGFBQWEsR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBTSxtQkFBbUIsR0FBRyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDdkUsTUFBTSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFFBQWdCO1lBQ3hELElBQUksUUFBUSxLQUFLLGNBQWMsRUFBRTtnQkFDL0IsYUFBYSxHQUFHLElBQUksQ0FBQzthQUN0QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSw0QkFBaUIsR0FBeEIsVUFBeUIsTUFBTSxFQUFFLFdBQVc7UUFDMUMsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDNUMsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ2YsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBQ3JCLE1BQU0sQ0FBQyxhQUFhLENBQUMsR0FBRyxJQUFJLENBQUM7SUFDL0IsQ0FBQztJQUNILGlCQUFDO0FBQUQsQ0FBQyxBQWhaRCxJQWdaQztBQUVELE9BQU8sRUFBRSxVQUFVLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L2luZGV4JztcclxuaW1wb3J0IHsgRW50aXR5LCBFbnRpdHlMaXN0LCBQQVJFTlRfQ0xBU1MsIEZpZWxkTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vZW50aXR5L2luZGV4JztcclxuaW1wb3J0IHsgTW9kaWZpY2F0aW9uLCBNb2RpZnlUeXBlIH0gZnJvbSAnLi4vY2hhbmdlc2V0L2luZGV4JztcclxuaW1wb3J0IHsgVmlld0NoYW5nZSwgQ2hhbmdlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnLi9jaGFuZ2VzJztcclxuaW1wb3J0IHsgQmluZGluZ0xpc3QgfSBmcm9tICcuL2JpbmRpbmdfbGlzdCc7XHJcbmltcG9ydCB7IEJpbmRpbmdPYmplY3QgfSBmcm9tICcuL2JpbmRpbmdfb2JqZWN0JztcclxuaW1wb3J0IHsgQmluZGluZ1Byb3BlcnR5LCBCaW5kaW5nUHJvcGVydHlUeXBlIH0gZnJvbSAnLi9iaW5kaW5nX3Byb3BlcnR5JztcclxuaW1wb3J0IHsgQmluZGluZ09iamVjdEZhY3RvcnkgfSBmcm9tICcuL2JpbmRpbmdfb2JqZWN0X2ZhY3RvcnknO1xyXG5pbXBvcnQgeyBQYWdpbmF0aW9uIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcbmltcG9ydCB7IEJpbmRpbmdEYXRhIH0gZnJvbSAnLi9iaW5kaW5nX2RhdGEnO1xyXG5cclxuLyoqXHJcbiAqIOWunuS9k+aTjeS9nOW3peWFt+exu1xyXG4gKi9cclxuY2xhc3MgRW50aXR5VXRpbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhmVudGl0eeeahOaVsOaNruWKoOi9veWIsGJpbmRpbmdPYmplY3TkuK3vvIzlubbkv53mjIHkuKTogIXlkIzmraXjgIJcclxuICAgKiBAcGFyYW0gZW50aXR5ICAgICAgICDlrp7kvZPlr7nosaFcclxuICAgKiBAcGFyYW0gYmluZGluZ09iamVjdCDnu5Hlrprlr7nosaFcclxuICAgKi9cclxuICBzdGF0aWMgbG9hZEVudGl0eShlbnRpdHk6IEVudGl0eSwgYmluZGluZ09iamVjdDogQmluZGluZ09iamVjdCkge1xyXG5cclxuICAgIC8vIOmBjeWOhmJpbmRpbmdPYmplY3TnmoRwcm9wZXJ0aWVz6L+b6KGM6LWL5YC8XHJcbiAgICBiaW5kaW5nT2JqZWN0LnByb3BlcnRpZXMuZm9yRWFjaCgocHJvcGVydHk6IEJpbmRpbmdQcm9wZXJ0eSkgPT4ge1xyXG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eS5uYW1lO1xyXG4gICAgICBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5MaXN0KSB7XHJcbiAgICAgICAgdGhpcy5sb2FkRW50aXR5TGlzdChlbnRpdHlbcHJvcGVydHlOYW1lXSB8fCBlbnRpdHlbUEFSRU5UX0NMQVNTXSwgYmluZGluZ09iamVjdFtwcm9wZXJ0eU5hbWVdKTtcclxuICAgICAgfSBlbHNlIGlmIChwcm9wZXJ0eS50eXBlID09PSBCaW5kaW5nUHJvcGVydHlUeXBlLk9iamVjdCkge1xyXG4gICAgICAgIGlmIChlbnRpdHkgJiYgZW50aXR5W3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICAgIHRoaXMubG9hZEVudGl0eShlbnRpdHlbcHJvcGVydHlOYW1lXSwgYmluZGluZ09iamVjdFtwcm9wZXJ0eU5hbWVdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5EeW5hbWljKSB7XHJcbiAgICAgICAgaWYgKGVudGl0eSAmJiBlbnRpdHlbcHJvcGVydHlOYW1lXSkge1xyXG4gICAgICAgICAgY29uc3QgZHluYW1pY09iamVjdCA9IEJpbmRpbmdPYmplY3RGYWN0b3J5LmNyZWF0ZUR5bmFtaWNCaW5kaW5nT2JqZWN0KGVudGl0eVtwcm9wZXJ0eU5hbWVdLmRhdGEpO1xyXG4gICAgICAgICAgQmluZGluZ09iamVjdEZhY3RvcnkuYXR0YWNoRHluYW1pY09iamVjdFByb3BlcnR5KGJpbmRpbmdPYmplY3QsIHByb3BlcnR5TmFtZSwgZHluYW1pY09iamVjdCk7XHJcbiAgICAgICAgICB0aGlzLmxvYWRFbnRpdHkoZW50aXR5W3Byb3BlcnR5TmFtZV0sIGJpbmRpbmdPYmplY3RbcHJvcGVydHlOYW1lXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGJpbmRpbmdPYmplY3Quc2V0VmFsdWUocHJvcGVydHlOYW1lLCBlbnRpdHlbcHJvcGVydHlOYW1lXSwgZmFsc2UsIGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5zZXRVcEVudGl0eVBpcGVsaW5lKGVudGl0eSwgYmluZGluZ09iamVjdCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlu7rnq4tlbnRpdHnlkoxiaW5kaW5nT2JqZWN05LmL6Ze055qE5YWz6IGUXHJcbiAgICogQHBhcmFtIGVudGl0eSAgICAgICAg5a6e5L2T5a+56LGhXHJcbiAgICogQHBhcmFtIGJpbmRpbmdPYmplY3Qg57uR5a6a5a+56LGhXHJcbiAgICovXHJcbiAgc3RhdGljIHNldFVwRW50aXR5UGlwZWxpbmUoZW50aXR5OiBFbnRpdHksIGJpbmRpbmdPYmplY3Q6IEJpbmRpbmdPYmplY3QpIHtcclxuXHJcbiAgICAvLyDnm5HlkKxlbnRpdHnlj5jmm7RcclxuICAgIGVudGl0eS5vblZhbHVlQ2hhbmdlZC5zdWJzY3JpYmUoKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIGlmIChtb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZSB8fCBtb2RpZmljYXRpb24ucGF0aC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gbW9kaWZpY2F0aW9uLnBhdGhbbW9kaWZpY2F0aW9uLnBhdGgubGVuZ3RoIC0gMV07XHJcbiAgICAgIGNvbnN0IHByaW1hcnlLZXlQYXRoID0gbW9kaWZpY2F0aW9uLnBhdGhbbW9kaWZpY2F0aW9uLnBhdGgubGVuZ3RoIC0gMl07XHJcblxyXG4gICAgICAvLyDpqozor4HkuLvplK7mmK/lkKbljLnphY1cclxuICAgICAgLy8g5a2Y5Zyo5Li76ZSu5bm25LiU5Li76ZSu5LiN5pivaWTml7bmiY3mo4Dmn6XvvIjlgLzlr7nosaHjgIHlhbPogZTlr7nosaHkuI3mo4Dmn6XvvIlcclxuICAgICAgaWYgKGJpbmRpbmdPYmplY3QucHJpbWFyeUtleSAmJiBiaW5kaW5nT2JqZWN0LnByaW1hcnlLZXkgPT09ICdpZCcpIHtcclxuICAgICAgICBjb25zdCBwcmltYXJ5S2V5ID0gYmluZGluZ09iamVjdC5wcmltYXJ5S2V5O1xyXG4gICAgICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IGJpbmRpbmdPYmplY3QuZ2V0VmFsdWUocHJpbWFyeUtleSk7XHJcbiAgICAgICAgaWYgKHByaW1hcnlLZXlQYXRoICE9PSBgJHtwcmltYXJ5S2V5fToke3ByaW1hcnlLZXlWYWx1ZX1gKSB7XHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyDlgLzmsqHmnInlj5HnlJ/lj5jljJbvvIzkuI3lho3orr7nva5cclxuICAgICAgLy8gVE9ETzog6YCa6L+HYmluZGluZ09iamVjdOS/ruaUuWVudGl0eeWxnuaAp+WAvOaXtu+8jGVudGl0eeaAu+S8muinpuWPkeS4gOS4quWPmOabtOWbnuadpe+8jOWmguaenOS4jeaIquiOt+i/meS4qumHjeWkjeeahOWPmOabtO+8jOS8muWvvOiHtOmHjeWkjeaIluatu+W+queOr1xyXG4gICAgICBpZiAoYmluZGluZ09iamVjdC5nZXRWYWx1ZShwcm9wZXJ0eU5hbWUpID09PSBtb2RpZmljYXRpb24udmFsdWUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgYmluZGluZ09iamVjdC5zZXRWYWx1ZShwcm9wZXJ0eU5hbWUsIG1vZGlmaWNhdGlvbi52YWx1ZSwgdHJ1ZSwgZmFsc2UsIG1vZGlmaWNhdGlvbi5lcnJvcnMpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g55uR5ZCsYmluZGluZ09iamVjdOWPmOabtFxyXG4gICAgYmluZGluZ09iamVjdC52aWV3Q2hhbmdlcy5zdWJzY3JpYmUoKHZpZXdDaGFuZ2U6IFZpZXdDaGFuZ2UpID0+IHtcclxuICAgICAgY29uc3QgdmFsdWUgPSB2aWV3Q2hhbmdlLnZhbHVlO1xyXG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSB2aWV3Q2hhbmdlLnBhdGhbMF07XHJcblxyXG4gICAgICBsZXQgcGF0aFByZWZpeCA9ICcnO1xyXG4gICAgICBjb25zdCBwYXRoRGF0YSA9IGVudGl0eS5nZXRQYXRocygpO1xyXG4gICAgICBjb25zdCBwYXRocyA9IHBhdGhEYXRhLnBhdGg7XHJcbiAgICAgIGxldCBpZCA9IGJpbmRpbmdPYmplY3RbJ2lkJ107XHJcbiAgICAgIGlmIChwYXRoRGF0YS5pc1VkdCkge1xyXG4gICAgICAgIC8vIGdyaWTkuK11ZHTmsqHmnIlpZO+8jOS7jueItue6p+S4reWPluWHumlk77yM5Lul5L6/5a2Y5pS+6aqM6K+B5L+h5oGvXHJcbiAgICAgICAgY29uc3QgZ2V0UGFyZW50SWQgPSAodGFyZ2V0OiBhbnkpID0+IHtcclxuICAgICAgICAgIGxldCBwYXJlbnRJZCA9ICcnO1xyXG4gICAgICAgICAgY29uc3QgZmluZElkID0gKGl0ZW06IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAoaXRlbSAmJiBpdGVtICYmIGl0ZW1bJ2lkJ10pIHtcclxuICAgICAgICAgICAgICBwYXJlbnRJZCA9IGl0ZW1bJ2lkJ107XHJcbiAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW1bJ3BhcmVudCddKSB7XHJcbiAgICAgICAgICAgICAgZmluZElkKGl0ZW1bJ3BhcmVudCddKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIGZpbmRJZCh0YXJnZXQpO1xyXG4gICAgICAgICAgcmV0dXJuIHBhcmVudElkO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgaWQgPSBnZXRQYXJlbnRJZChiaW5kaW5nT2JqZWN0KTtcclxuICAgICAgICBpZiAocGF0aERhdGEuaXNHcmlkKSB7XHJcbiAgICAgICAgICAvLyBncmlkIOWwhuS7juihqOS4u+Wtl+auteWOu+mZpFxyXG4gICAgICAgICAgcGF0aHMuc2hpZnQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHBhdGhzLmxlbmd0aCkge1xyXG4gICAgICAgICAgcGF0aFByZWZpeCA9IHBhdGhzLmpvaW4oJy4nKSArICcuJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOS4jeaYr+S4u+mUruWAvOWtl+auteaXtu+8jOimgeWFiOajgOafpeS4u+mUruaYr+WQpuWtmOWcqO+8jOW5tuS4lOS4u+mUruaYr+WQpuebuOetie+8iOmYsuatouWQjuS7o+WPmOabtOWGkuazoeS4iuadpe+8iVxyXG4gICAgICAvLyDpnZ7kuLvplK7lsZ7mgKflj5jmm7Tml7bvvIzopoHlhYjmo4Dmn6XkuLvplK7mmK/lkKbljLnphY3vvIjlpoLmnpzkuLvplK7kuZ/kv67mlLnkuobvvIzopoHmsYLlhYjkv67mlLnkuLvplK7lho3kv67mlLnlhbbku5blgLzvvIlcclxuICAgICAgaWYgKGJpbmRpbmdPYmplY3QucHJpbWFyeUtleSkge1xyXG4gICAgICAgIGNvbnN0IHByaW1hcnlLZXkgPSBiaW5kaW5nT2JqZWN0LnByaW1hcnlLZXk7XHJcbiAgICAgICAgaWYgKHByb3BlcnR5TmFtZSAhPT0gcHJpbWFyeUtleSkge1xyXG4gICAgICAgICAgaWYgKCFlbnRpdHlbcHJpbWFyeUtleV0gfHwgZW50aXR5W3ByaW1hcnlLZXldICE9PSBiaW5kaW5nT2JqZWN0W3ByaW1hcnlLZXldKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIOWmguaenEJpbmRpbmdPYmplY3TkuIrnmoTlsZ7mgKflgLzlkoxFbnRpdHnkuIrlr7nlupTlsZ7mgKflgLzkuIDmoLfvvIzliJnkuI3lho3orr7nva5cclxuICAgICAgaWYgKGVudGl0eVtwcm9wZXJ0eU5hbWVdID09PSB2YWx1ZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g6LCD55So6KGo5Y2V6aqM6K+BLOmAmui/h+WQjuiwg+eUqOWunuS9k+mqjOivgVxyXG4gICAgICAvLyBiaW5nZGluZ09iamVjdOWPmOWMluWQju+8jOWFiOiwg+eUqOWunuS9k+S4iueahOmqjOivge+8jOmAmui/h+WQjuWGjeiuvue9ruWunuS9k+eahOWPmOWKqFxyXG4gICAgICBlbnRpdHlbcHJvcGVydHlOYW1lXSA9IHZhbHVlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIZlbnRpdHlMaXN05Lit55qERW50aXR55a+56LGh6L2s5o2i5Li6QmluZGluZ09iamVjdOWvueixoe+8jOWKoOi9veWIsGJpbmRpbmdMaXN05Lit77yM5bm25L+d5oyBZW50aXR5TGlzdOWSjGJpbmRpbmdMaXN05ZCM5q2l44CCXHJcbiAgICogQHBhcmFtIGVudGl0eUxpc3QgIOWunuS9k+WIl+ihqFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nTGlzdCDnu5HlrprliJfooahcclxuICAgKi9cclxuICBzdGF0aWMgbG9hZEVudGl0eUxpc3QoZW50aXR5TGlzdDogRW50aXR5TGlzdDxhbnk+LCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QpIHtcclxuICAgIHRoaXMubG9hZEVudGl0aWVzKGVudGl0eUxpc3QuaXRlbXMsIGJpbmRpbmdMaXN0KTtcclxuXHJcbiAgICB0aGlzLnNldFVwRW50aXR5TGlzdFBpcGVsaW5lKGVudGl0eUxpc3QsIGJpbmRpbmdMaXN0KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOW7uueri2VudGl0eUxpc3TlkoxiaW5kaW5nTGlzdOS5i+mXtOeahOWFs+iBlFxyXG4gICAqIEBwYXJhbSBlbnRpdHlMaXN0ICDlrp7kvZPliJfooahcclxuICAgKiBAcGFyYW0gYmluZGluZ0xpc3Qg57uR5a6a5YiX6KGoXHJcbiAgICovXHJcbiAgc3RhdGljIHNldFVwRW50aXR5TGlzdFBpcGVsaW5lKGVudGl0eUxpc3Q6IEVudGl0eUxpc3Q8YW55PiwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcblxyXG4gICAgZW50aXR5TGlzdC5vbkxpc3RDaGFuZ2VkLnN1YnNjcmliZSgobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgc3dpdGNoIChtb2RpZmljYXRpb24udHlwZSkge1xyXG5cclxuICAgICAgICAvLyDmt7vliqDlrp7kvZNcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuQWRkOlxyXG4gICAgICAgICAgY29uc3QgZW50aXRpZXNUb0FkZCA9IDxFbnRpdHlbXT5tb2RpZmljYXRpb24udmFsdWU7XHJcbiAgICAgICAgICBpZiAoZW50aXRpZXNUb0FkZC5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIOajgOafpeeItmlk5piv5ZCm5LiA6Ie077yM5YaS5rOh5a+86Ie055qE5Y+Y5pu05LiN5aSE55CGXHJcbiAgICAgICAgICBjb25zdCBwYXRocyA9IG1vZGlmaWNhdGlvbi5wYXRoO1xyXG4gICAgICAgICAgY29uc3QgcGFyZW50UGF0aCA9IHBhdGhzW3BhdGhzLmxlbmd0aCAtIDJdO1xyXG4gICAgICAgICAgY29uc3QgcGFyZW50SWQgPSBiaW5kaW5nTGlzdC5wYXJlbnQucHJpbWFyeUtleVZhbHVlO1xyXG4gICAgICAgICAgaWYgKHBhcmVudFBhdGguaW5kZXhPZihwYXJlbnRJZCkgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICB0aGlzLmFwcGVuZEVudGl0aWVzKDxFbnRpdHlbXT5tb2RpZmljYXRpb24udmFsdWUsIGJpbmRpbmdMaXN0KTtcclxuICAgICAgICAgIGJyZWFrO1xyXG5cclxuICAgICAgICAvLyDliKDpmaTlrp7kvZNcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuUmVtb3ZlOlxyXG5cclxuICAgICAgICAgIC8vIOWIoOmZpOWunuS9k++8iHZhbHVl5qC85byP5b6F5ZWG5qa377yM55uu5YmNdmFsdWXnmoTmoLzlvI/kuLogeyBwcmltYXJ5S2V5OiBwcmltYXJ5VmFsdWV977yJXHJcbiAgICAgICAgICBjb25zdCBpZCA9IG1vZGlmaWNhdGlvbi52YWx1ZVtiaW5kaW5nTGlzdC5wcmltYXJ5S2V5XTtcclxuICAgICAgICAgIGJpbmRpbmdMaXN0LnJlbW92ZUJ5SWRzKFtpZF0pO1xyXG4gICAgICAgICAgLy8gdGhpcy5yZW1vdmVFbnRpdGllcyg8RW50aXR5W10+bW9kaWZpY2F0aW9uLnZhbHVlLCBiaW5kaW5nTGlzdCk7XHJcbiAgICAgICAgICBicmVhaztcclxuXHJcbiAgICAgICAgLy8g5Yqg6L295a6e5L2TXHJcbiAgICAgICAgY2FzZSBNb2RpZnlUeXBlLkxvYWQ6XHJcbiAgICAgICAgICBjb25zdCBlbnRpdGllcyA9IG1vZGlmaWNhdGlvbi52YWx1ZTtcclxuICAgICAgICAgIHRoaXMubG9hZEVudGl0aWVzKGVudGl0aWVzLCBiaW5kaW5nTGlzdCk7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog55uR5ZCscmVwb3NpdG9yeeWPmOWMlu+8jOS/neaMgXJlcG9zaXRvcnnlkoxiaW5kaW5nTGlzdOWQjOatpeOAglxyXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5ICDlrp7kvZPku5PlupNcclxuICAgKiBAcGFyYW0gYmluZGluZ0xpc3Qg57uR5a6a5YiX6KGoXHJcbiAgICovXHJcbiAgc3RhdGljIGxvYWRSZXBvc2l0b3J5KHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PiwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcblxyXG4gICAgLy8g5Yid5qyh5Yqg6L29XHJcbiAgICBjb25zdCBlbnRpdGllcyA9IEFycmF5LmZyb20ocmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnRvQXJyYXkoKSk7XHJcbiAgICB0aGlzLmxvYWRFbnRpdGllcyhlbnRpdGllcywgYmluZGluZ0xpc3QpO1xyXG5cclxuICAgIC8vIOebkeWQrOWPmOWMllxyXG4gICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uQ2hhbmdlLnN1YnNjcmliZSgobW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgc3dpdGNoIChtb2RpZmljYXRpb24udHlwZSkge1xyXG4gICAgICAgIGNhc2UgTW9kaWZ5VHlwZS5Mb2FkOlxyXG4gICAgICAgICAgdGhpcy5sb2FkRW50aXRpZXMoPEVudGl0eVtdPm1vZGlmaWNhdGlvbi52YWx1ZSwgYmluZGluZ0xpc3QpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBNb2RpZnlUeXBlLkFkZDpcclxuICAgICAgICAgIHRoaXMuYXBwZW5kRW50aXRpZXMoPEVudGl0eVtdPm1vZGlmaWNhdGlvbi52YWx1ZSwgYmluZGluZ0xpc3QpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBNb2RpZnlUeXBlLlJlbW92ZTpcclxuICAgICAgICAgIHRoaXMucmVtb3ZlRW50aXRpZXMoPEVudGl0eVtdPm1vZGlmaWNhdGlvbi52YWx1ZSwgYmluZGluZ0xpc3QpO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBNb2RpZnlUeXBlLlBhZ2luYXRpb25JbmZvQ2hhbmdlOlxyXG4gICAgICAgICAgYmluZGluZ0xpc3QucGFnaW5hdGlvbkluZm8gPSA8UGFnaW5hdGlvbj5tb2RpZmljYXRpb24udmFsdWU7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOebkeWQrEJpbmRpbmdMaXN05pWw5o2u5Y+Y5YyWXHJcbiAgICBiaW5kaW5nTGlzdC5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlBhZ2luYXRpb25JbmZvQ2hhbmdlKSB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5Q29sbGVjdGlvbiA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbjtcclxuICAgICAgICAvLyBjb25zdCBlbnRpdHlUeXBlTmFtZSA9IGVudGl0eUNvbGxlY3Rpb24uZW50aXR5VHlwZU5hbWU7XHJcbiAgICAgICAgLy8gY29uc3Qgb3JpZ2luYWwgPSBlbnRpdHlDb2xsZWN0aW9uLnBhZ2luYXRpb25JbmZvW2VudGl0eVR5cGVOYW1lXTtcclxuICAgICAgICAvLyBjb25zdCBlbnRpdHlQYWdpbmF0aW9uSW5mbyA9IE9iamVjdC5hc3NpZ24oe30sIG9yaWdpbmFsLCBjaGFuZ2UudmFsdWUpO1xyXG4gICAgICAgIGVudGl0eUNvbGxlY3Rpb24ucGFnaW5hdGlvbkluZm8gPSBPYmplY3QuYXNzaWduKHt9LCBlbnRpdHlDb2xsZWN0aW9uLnBhZ2luYXRpb25JbmZvLCBjaGFuZ2UudmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhmVudGl0aWVz5Lit55qERW50aXR55a+56LGh6L2s5o2i5Li6QmluZGluZ09iamVjdOWvueixoe+8jOW5tuWKoOi9veWIsGJpbmRpbmdMaXN05LitXHJcbiAgICogQHBhcmFtIGVudGl0aWVzICAgIOWunuS9k+aVsOe7hFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nTGlzdCDnu5HlrprliJfooahcclxuICAgKi9cclxuICBzdGF0aWMgbG9hZEVudGl0aWVzKGVudGl0aWVzOiBFbnRpdHlbXSwgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0KSB7XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0cyA9IHRoaXMuY3JlYXRlQmluZGluZ09iamVjdHMoZW50aXRpZXMsIGJpbmRpbmdMaXN0KTtcclxuICAgIGJpbmRpbmdMaXN0LmxvYWQoYmluZGluZ09iamVjdHMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCGZW50aXRpZXPkuK3nmoRFbnRpdHnlr7nosaHovazmjaLkuLpCSW5kaW5nT2JqZWN05a+56LGh77yM5bm26L+95Yqg5YiwYmluZGluZ0xpc3TkuK1cclxuICAgKiBAcGFyYW0gZW50aXRpZXMgICAg5a6e5L2T5pWw57uEXHJcbiAgICogQHBhcmFtIGJpbmRpbmdMaXN0IOe7keWumuWIl+ihqFxyXG4gICAqL1xyXG4gIHN0YXRpYyBhcHBlbmRFbnRpdGllcyhlbnRpdGllczogRW50aXR5W10sIGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCkge1xyXG4gICAgY29uc3QgYmluZGluZ09iamVjdHMgPSB0aGlzLmNyZWF0ZUJpbmRpbmdPYmplY3RzKGVudGl0aWVzLCBiaW5kaW5nTGlzdCk7XHJcbiAgICBiaW5kaW5nTGlzdC5hcHBlbmQoYmluZGluZ09iamVjdHMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5LuOYmluZGluZ0xpc3Tnp7vpmaRlbnRpdGllc+WvueW6lOeahEJpbmRpbmdPYmplY3Tlr7nosaFcclxuICAgKiBAcGFyYW0gZW50aXRpZXMgICAg5a6e5L2T5pWw57uEXHJcbiAgICogQHBhcmFtIGJpbmRpbmdMaXN0IOe7keWumuWIl+ihqFxyXG4gICAqL1xyXG4gIHN0YXRpYyByZW1vdmVFbnRpdGllcyhlbnRpdGllczogRW50aXR5W10sIGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCkge1xyXG4gICAgaWYgKGVudGl0aWVzID09PSBudWxsIHx8IGVudGl0aWVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5b2S6ZuG6KaB5Yig6Zmk55qEaWTmlbDnu4RcclxuICAgIGNvbnN0IHByaW1hcnlLZXkgPSBiaW5kaW5nTGlzdC5wcmltYXJ5S2V5O1xyXG4gICAgY29uc3QgaWRzID0gW107XHJcbiAgICBlbnRpdGllcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICBpZHMucHVzaChlbnRpdHlbcHJpbWFyeUtleV0pO1xyXG4gICAgfSk7XHJcbiAgICBiaW5kaW5nTGlzdC5yZW1vdmVCeUlkcyhpZHMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCGZW50aXRpZXPkuK3nmoRFbnRpdHnlr7nosaHovazmjaLkuLpCaW5kaW5nT2JqZWN05a+56LGhXHJcbiAgICogQHBhcmFtIGVudGl0aWVzICAgIOWunuS9k+aVsOe7hFxyXG4gICAqIEBwYXJhbSBiaW5kaW5nTGlzdCDnu5HlrprliJfooahcclxuICAgKi9cclxuICBzdGF0aWMgY3JlYXRlQmluZGluZ09iamVjdHMoZW50aXRpZXM6IEVudGl0eVtdLCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QpIHtcclxuXHJcbiAgICBpZiAoZW50aXRpZXMgPT09IG51bGwgfHwgZW50aXRpZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0cyA9IFtdO1xyXG4gICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IEJpbmRpbmdPYmplY3RGYWN0b3J5LmNyZWF0ZShiaW5kaW5nTGlzdC5wcm9wZXJ0aWVzKTtcclxuICAgICAgdGhpcy5sb2FkRW50aXR5KGVudGl0eSwgYmluZGluZ09iamVjdCk7XHJcblxyXG4gICAgICAvLyAvLyDkuLpiaW5kaW5nT2JqZWN06K6+572u6buY6K6k5YC8aW5pdGlhbERhdGHlsZ7mgKdcclxuICAgICAgLy8gaWYgKGVudGl0eVsnaW5pdGlhbERhdGEnXSkge1xyXG4gICAgICAvLyAgIGJpbmRpbmdPYmplY3RbJ2luaXRpYWxEYXRhJ10gPSBlbnRpdHlbJ2luaXRpYWxEYXRhJ107XHJcbiAgICAgIC8vIH1cclxuXHJcbiAgICAgIGJpbmRpbmdPYmplY3RzLnB1c2goYmluZGluZ09iamVjdCk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBiaW5kaW5nT2JqZWN0cztcclxuICB9XHJcbiAgcHVibGljIHN0YXRpYyB3YXRjaFJlcG9zaXJvdHkocmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LCBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEpIHtcclxuICAgIC8vIHJlcG9zaXJvdHkgPT4gYmluZGluZ0RhdGFcclxuICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbkNoYW5nZS5zdWJzY3JpYmUoKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIHN3aXRjaCAobW9kaWZpY2F0aW9uLnR5cGUpIHtcclxuICAgICAgICBjYXNlIE1vZGlmeVR5cGUuUGFnaW5hdGlvbkluZm9DaGFuZ2U6XHJcbiAgICAgICAgICBiaW5kaW5nRGF0YS5wYWdpbmdJbmZvID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5p+l5om+5bGe5oCn55qE57G75Z6LXHJcbiAgICogQHBhcmFtIGVudGl0eVR5cGUg5a6e5L2T57G75Z6LXHJcbiAgICogQHBhcmFtIHRhcmdldFByb3BOYW1lIOWxnuaAp+WQjeensFxyXG4gICAqIEByZXR1cm4g5bGe5oCn5L+h5oGv77yM5YyF5ZCr5bGe5oCn57G75Z6L77yITmdGaWVsZOOAgU5nT2JqZWN044CBTmdMaXN077yJ5ZKM5bGe5oCn5a+55bqU55qE5a6e5L2T57G75Z6L77yI5b2TTmdGaWVsZOexu+Wei+aXtuS4um51bGzvvIlcclxuICAgKi9cclxuICBzdGF0aWMgZ2V0UHJvcEluZm8oZW50aXR5VHlwZTogYW55LCB0YXJnZXRQcm9wTmFtZTogc3RyaW5nKTogeyBwcm9wVHlwZTogc3RyaW5nLCBwcm9wRW50aXR5VHlwZTogYW55IH0ge1xyXG5cclxuICAgIGxldCBwcm9wVHlwZTogc3RyaW5nO1xyXG4gICAgbGV0IHByb3BFbnRpdHlUeXBlOiBhbnk7XHJcblxyXG4gICAgLy8gTmdGaWVsZFxyXG4gICAgY29uc3QgbmdGaWVsZFByb3BlcnRpZXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyhlbnRpdHlUeXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRmllbGRQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChwcm9wTmFtZSA9PT0gdGFyZ2V0UHJvcE5hbWUpIHtcclxuICAgICAgICBwcm9wVHlwZSA9ICdOZ0ZpZWxkJztcclxuICAgICAgICBwcm9wRW50aXR5VHlwZSA9IG51bGw7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIC8vIE5nT2JqZWN0XHJcbiAgICBjb25zdCBuZ09iamVjdFByb3BlcnRpZXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMoZW50aXR5VHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ09iamVjdFByb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHByb3BOYW1lID09PSB0YXJnZXRQcm9wTmFtZSkge1xyXG4gICAgICAgIHByb3BUeXBlID0gJ05nT2JqZWN0JztcclxuICAgICAgICBwcm9wRW50aXR5VHlwZSA9IG5nT2JqZWN0UHJvcGVydGllc1twcm9wTmFtZV0udHlwZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gTmdMaXN0XHJcbiAgICBjb25zdCBuZ0xpc3RQcm9wZXJ0aWVzID0gRmllbGRNZXRhZGF0YVV0aWwuZ2V0TmdMaXN0KGVudGl0eVR5cGUpO1xyXG4gICAgT2JqZWN0LmtleXMobmdMaXN0UHJvcGVydGllcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAocHJvcE5hbWUgPT09IHRhcmdldFByb3BOYW1lKSB7XHJcbiAgICAgICAgcHJvcFR5cGUgPSAnTmdMaXN0JztcclxuICAgICAgICBwcm9wRW50aXR5VHlwZSA9IG5nTGlzdFByb3BlcnRpZXNbcHJvcE5hbWVdLnR5cGU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IG5nRHluYW1pY1Byb3BlcnRpZXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0R5bmFtaWMoZW50aXR5VHlwZSk7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0R5bmFtaWNQcm9wZXJ0aWVzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChwcm9wTmFtZSA9PT0gdGFyZ2V0UHJvcE5hbWUpIHtcclxuICAgICAgICBwcm9wVHlwZSA9ICdOZ0R5bmFtaWMnO1xyXG4gICAgICAgIHByb3BFbnRpdHlUeXBlID0gbmdEeW5hbWljUHJvcGVydGllc1twcm9wTmFtZV0udHlwZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHsgcHJvcFR5cGUsIHByb3BFbnRpdHlUeXBlIH07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPnmoTkuLvplK7lkI1cclxuICAgKiBAcGFyYW0gZW50aXR5VHlwZSDlrp7kvZPnsbvlnotcclxuICAgKi9cclxuICBzdGF0aWMgZ2V0UHJpbWFyeUtleShlbnRpdHlUeXBlOiBhbnkpIHtcclxuICAgIGNvbnN0IHByaW1hcnlOZ0ZpbGVkUHJvcCA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldFByaW1hcnlGaWVsZE1ldGFkYXRhKGVudGl0eVR5cGUpO1xyXG4gICAgaWYgKHByaW1hcnlOZ0ZpbGVkUHJvcCkge1xyXG4gICAgICByZXR1cm4gcHJpbWFyeU5nRmlsZWRQcm9wLmRhdGFGaWVsZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuS4uuWvueixoeWxnuaAp1xyXG4gICAqL1xyXG4gIHN0YXRpYyBpc09iamVjdFByb3AoZW50aXR5VHlwZTogYW55LCB0YXJnZXRQcm9wTmFtZTogc3RyaW5nLCApIHtcclxuICAgIGxldCBpc09iamVjdFByb3AgPSBmYWxzZTtcclxuICAgIGNvbnN0IG5nT2JqZWN0UHJvcGVydGllcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nT2JqZWN0cyhlbnRpdHlUeXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nT2JqZWN0UHJvcGVydGllcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAocHJvcE5hbWUgPT09IHRhcmdldFByb3BOYW1lKSB7XHJcbiAgICAgICAgaXNPYmplY3RQcm9wID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gaXNPYmplY3RQcm9wO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qOA5p+l5piv5ZCm5piv5Yqo5oCB5YiX5bGe5oCnXHJcbiAgICovXHJcbiAgc3RhdGljIGlzRHluYW1pY1Byb3AoZW50aXR5VHlwZTogYW55LCB0YXJnZXRQcm9wTmFtZTogc3RyaW5nKSB7XHJcbiAgICBsZXQgaXNEeW5hbWljUHJvcCA9IGZhbHNlO1xyXG4gICAgY29uc3QgbmdEeW5hbWljUHJvcGVydGllcyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nRHluYW1pYyhlbnRpdHlUeXBlKTtcclxuICAgIE9iamVjdC5rZXlzKG5nRHluYW1pY1Byb3BlcnRpZXMpLmZvckVhY2goKHByb3BOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHByb3BOYW1lID09PSB0YXJnZXRQcm9wTmFtZSkge1xyXG4gICAgICAgIGlzRHluYW1pY1Byb3AgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBpc0R5bmFtaWNQcm9wO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Li65a6e5L2T5aKe5YqgaW5pdGlhbERhdGHlsZ7mgKdcclxuICAgKiBAcGFyYW0gZW50aXR5IOWunuS9k+WunuS+i1xyXG4gICAqIEBwYXJhbSBpbml0aWFsRGF0YSDpu5jorqTlgLzlr7nosaFcclxuICAgKi9cclxuICBzdGF0aWMgYXBwZW5kSW5pdGlhbERhdGEoZW50aXR5LCBpbml0aWFsRGF0YSkge1xyXG4gICAgY29uc3QgZGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIGluaXRpYWxEYXRhKTtcclxuICAgIGRlbGV0ZSBkYXRhLmlkO1xyXG4gICAgZGVsZXRlIGRhdGEucGFyZW50SUQ7XHJcbiAgICBlbnRpdHlbJ2luaXRpYWxEYXRhJ10gPSBkYXRhO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgRW50aXR5VXRpbCB9O1xyXG4iXX0=