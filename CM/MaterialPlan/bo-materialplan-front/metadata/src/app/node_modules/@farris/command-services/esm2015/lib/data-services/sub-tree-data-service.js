import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { tap, concatMap } from 'rxjs/operators';
import { FrameContext, ViewModel } from '@farris/devkit';
import { BaseDataService } from './base-data.service';
import { FormMessageService } from '../form-message.service';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { FormErrorService } from '../error/form-error.service';
import { FormNotifyService } from '../form-notify.service';
import { LanguageService } from '../languag.service';
import { TreeRepositoryFactory } from './tree-table/repository/tree-repository-factory';
import { TreeUtilFactory } from './tree-table/util/tree-util-factory';
/**
 * 树数据服务
 */
class SubTreeDataService extends BaseDataService {
    /**
     * 构造函数
     */
    constructor(frameContext, viewModel, messageService, loadingService, errorService, formNotifyService, languageService) {
        super(frameContext);
        this.viewModel = viewModel;
        this.messageService = messageService;
        this.loadingService = loadingService;
        this.errorService = errorService;
        this.formNotifyService = formNotifyService;
        this.languageService = languageService;
        if (!languageService) {
            this.languageService = LanguageService.getInstance();
        }
    }
    /**
     * 分级码信息
     */
    get hierarchyInfoKey() {
        return this.virtualRootFrameContext.getParam('hierarchyInfoKey');
    }
    get hierarchyInfoField() {
        return this.hierarchyInfoKey.split('/').filter(p => p).pop();
    }
    get virtualRootFrameContext() {
        return this.frameContext.getVirtualRootFrameContext();
    }
    get messagePipe() {
        if (this.viewModel && this.viewModel.frameContext) {
            const appContext = this.viewModel.frameContext.getFormAppContext() || null;
            if (appContext) {
                return appContext.messagePipe || null;
            }
        }
        return null;
    }
    /**
     * 新增子表同级
     */
    addSubSibling() {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'addSubSibling' });
        }
        let params = this.getParams();
        // 获取分级方式
        const hierarchyType = this.getHierarchyType();
        // 执行取数
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const repository = TreeRepositoryFactory.getInstance(hierarchyType);
        if (!repository) {
            // 错误的分级码
            throw new Error(this.languageService['errorHierarchyKey']);
        }
        const result$ = repository.addSubSibling(this.repository, params.nodeCodes, params.ids);
        return result$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, error => {
            this.errorService.exception(this.languageService.addSubSiblingFailed, error);
        }));
    }
    /**
     * 新增下级
     */
    addSubChild() {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'addSubChild' });
        }
        let params = this.getParams();
        // 获取分级方式
        const hierarchyType = this.getHierarchyType();
        const currentList = this.frameContext && this.frameContext.bindingData && this.frameContext.bindingData.getList();
        if (!currentList['currentId']) {
            // 请选择父节点
            this.formNotifyService.warning(this.languageService['plsSelectParentNode'], { hideTitle: true });
            return EMPTY;
        }
        // 执行取数
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const repository = TreeRepositoryFactory.getInstance(hierarchyType);
        if (!repository) {
            throw new Error(this.languageService['errorHierarchyKey']);
        }
        const addSubChild$ = repository.addSubChild(this.repository, params.nodeCodes, params.ids);
        const result$ = addSubChild$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, error => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.errorService.exception(this.languageService.addSubChildFailed, error);
        }));
        return result$;
    }
    /**
     * 删除子表树节点
     * @param id id
     */
    remove(id, successMsg) {
        // 参数检查
        if (!id) {
            this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
            return EMPTY;
        }
        // 获取分级方式
        const hierarchyType = this.getHierarchyType();
        // 有子节点时不允许删除
        const treeNodesData = this.frameContext.bindingData.getList().toJSON();
        const bindingList = this.frameContext.bindingData.getList();
        const treeNodeUtil = TreeUtilFactory.getInstance(hierarchyType);
        if (treeNodeUtil === null) {
            return EMPTY;
        }
        if (treeNodeUtil.hasChildNodes(treeNodesData, this.hierarchyInfoField, id) === true) {
            this.messageService.warning(this.languageService['deleteChildFirst']);
            return EMPTY;
        }
        // 确认删除
        const action$ = this.messageService.question(this.languageService.confirmDeletion);
        return action$.pipe(concatMap(result => {
            if (!result) {
                return EMPTY;
            }
            // 获取删除后要设置的节点id
            const nextNodeId = treeNodeUtil.getNextNodeId(treeNodesData, this.hierarchyInfoField, id);
            // 执行删除
            const loadingTimerId = this.loadingService.show();
            const path = this.getPath();
            const remove$ = this.frameContext.repository.removeByPath(path, id);
            return remove$.pipe(tap(() => {
                // 设置选中节点
                treeNodeUtil.selectNodeByBindingList(bindingList, this.hierarchyInfoField, nextNodeId);
                this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, error => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                this.errorService.exception(this.languageService.deleteFailed, error);
            }));
        }));
    }
    getHierarchyType() {
        const propInfo = this.repository.entityTypeInfo.getPropInfoByPath(this.hierarchyInfoKey.split('/'));
        let hierarchyType = propInfo.metadataInfo['hierarchyType'] || null;
        if (hierarchyType == null || hierarchyType.length < 1) {
            // '分级码配置信息错误'
            throw new Error(this.languageService['incorrectHierarchyConfig']);
        }
        return hierarchyType;
    }
    /**
     * 获取参数
     * /parentId/childCodes/childId/grandsonCodes
     * [childCodes, grandsonCodes]
     * [parntId, childId]
     */
    getParams() {
        let nodeCodes = this.viewModel.bindingPath.substr(1).split('/');
        let ids = [];
        let nodeCodeArray = [];
        const rid = this.viewModel.bindingData.list.currentId; // root表数据id
        ids.push(rid);
        let subData = this.viewModel.bindingData;
        if (nodeCodes.length > 0) {
            nodeCodes.map(nodeCode => {
                subData = subData[nodeCode];
                if (subData && subData.currentId) {
                    ids.push(subData.currentId);
                }
                //去除nodeCode的s
                nodeCode ? nodeCodeArray.push(nodeCode.substring(0, nodeCode.length - 1)) : nodeCodeArray.push(nodeCode);
            });
        }
        return { nodeCodes: nodeCodeArray, ids: ids };
    }
    /**
     * 获取完整路径
     * fixed by justin: 根据bindingPath，如果是从从表，需要获取主表数据id和从表数据id
     */
    getPath() {
        const bindingPath = this.viewModel.bindingPath;
        const rid = this.viewModel.bindingData.list.currentId; // root表数据id
        let path = '/' + rid;
        const subPaths = bindingPath.split('/').filter(p => p);
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['edus', 'grades']
            let subData = this.viewModel.bindingData;
            for (let index = 1; index < subPaths.length - 1; index++) {
                const subPath = subPaths[index];
                subData = subData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error(`获取子表完整路径出错，找不到${subData}对应的子表，或对应子表没有当前行。`);
                }
                path += `/${subPath}/${subData.currentId}`;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    }
}
SubTreeDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SubTreeDataService.ctorParameters = () => [
    { type: FrameContext },
    { type: ViewModel },
    { type: FormMessageService },
    { type: FormLoadingService },
    { type: FormErrorService },
    { type: FormNotifyService },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
export { SubTreeDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLXRyZWUtZGF0YS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2RhdGEtc2VydmljZXMvc3ViLXRyZWUtZGF0YS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxLQUFLLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekMsT0FBTyxFQUFFLEdBQUcsRUFBYSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUzRCxPQUFPLEVBQWUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3RFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUMxRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0saURBQWlELENBQUM7QUFDeEYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBSXRFOztHQUVHO0FBQ0gsTUFDTSxrQkFBbUIsU0FBUSxlQUFlO0lBZTlDOztPQUVHO0lBQ0gsWUFDRSxZQUEwQixFQUNsQixTQUFvQixFQUNwQixjQUFrQyxFQUNsQyxjQUFrQyxFQUNsQyxZQUE4QixFQUM5QixpQkFBb0MsRUFDeEIsZUFBZ0M7UUFFcEQsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBUFos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Q0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZCLHlEQUF5RDtZQUN6RCxJQUFJLE9BQU8sR0FBUSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztZQUM5QyxLQUFLLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRSxLQUFLLEdBQUcsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ3hELE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDM0IsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUU7b0JBQ2xDLE1BQU0sS0FBSyxDQUFDLGlCQUFpQixPQUFPLG1CQUFtQixDQUFDLENBQUM7aUJBQzFEO2dCQUNELElBQUksSUFBSSxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7YUFDNUM7U0FDRjtRQUNELElBQUksSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFNUMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDOzs7WUF2T0YsVUFBVTs7OztZQWZXLFlBQVk7WUFBRSxTQUFTO1lBRXBDLGtCQUFrQjtZQUNsQixrQkFBa0I7WUFDbEIsZ0JBQWdCO1lBQ2hCLGlCQUFpQjtZQUNqQixlQUFlLHVCQW1DbkIsUUFBUTs7QUErTWIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFTVBUWSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCwgY29uY2F0TWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgQmluZGluZ0xpc3QsIEZyYW1lQ29udGV4dCwgVmlld01vZGVsIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBCYXNlRGF0YVNlcnZpY2UgfSBmcm9tICcuL2Jhc2UtZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1tZXNzYWdlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtTG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBGb3JtRXJyb3JTZXJ2aWNlIH0gZnJvbSAnLi4vZXJyb3IvZm9ybS1lcnJvci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vbGFuZ3VhZy5zZXJ2aWNlJztcclxuaW1wb3J0IHsgVHJlZVJlcG9zaXRvcnlGYWN0b3J5IH0gZnJvbSAnLi90cmVlLXRhYmxlL3JlcG9zaXRvcnkvdHJlZS1yZXBvc2l0b3J5LWZhY3RvcnknO1xyXG5pbXBvcnQgeyBUcmVlVXRpbEZhY3RvcnkgfSBmcm9tICcuL3RyZWUtdGFibGUvdXRpbC90cmVlLXV0aWwtZmFjdG9yeSc7XHJcblxyXG5cclxuXHJcbi8qKlxyXG4gKiDmoJHmlbDmja7mnI3liqFcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgU3ViVHJlZURhdGFTZXJ2aWNlIGV4dGVuZHMgQmFzZURhdGFTZXJ2aWNlIHtcclxuXHJcbiAgLyoqXHJcbiAgICog5YiG57qn56CB5L+h5oGvXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgaGllcmFyY2h5SW5mb0tleSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIHRoaXMudmlydHVhbFJvb3RGcmFtZUNvbnRleHQuZ2V0UGFyYW0oJ2hpZXJhcmNoeUluZm9LZXknKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgaGllcmFyY2h5SW5mb0ZpZWxkKCk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5oaWVyYXJjaHlJbmZvS2V5LnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkucG9wKCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IHZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgcHJpdmF0ZSB2aWV3TW9kZWw6IFZpZXdNb2RlbCxcclxuICAgIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZSxcclxuICAgIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IEZvcm1Mb2FkaW5nU2VydmljZSxcclxuICAgIHByaXZhdGUgZXJyb3JTZXJ2aWNlOiBGb3JtRXJyb3JTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBmb3JtTm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICBzdXBlcihmcmFtZUNvbnRleHQpO1xyXG4gICAgaWYgKCFsYW5ndWFnZVNlcnZpY2UpIHtcclxuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0IG1lc3NhZ2VQaXBlKCkge1xyXG4gICAgaWYgKHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCkge1xyXG4gICAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCkgfHwgbnVsbDtcclxuICAgICAgaWYgKGFwcENvbnRleHQpIHtcclxuICAgICAgICByZXR1cm4gYXBwQ29udGV4dC5tZXNzYWdlUGlwZSB8fCBudWxsO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaWsOWinuWtkOihqOWQjOe6p1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRTdWJTaWJsaW5nKCk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBpZiAodGhpcy5tZXNzYWdlUGlwZSkge1xyXG4gICAgICB0aGlzLm1lc3NhZ2VQaXBlLm5leHQoeyBtZXNzYWdlVHlwZTogJ2FkZFN1YlNpYmxpbmcnIH0pO1xyXG4gICAgfVxyXG4gICAgbGV0IHBhcmFtczogeyBub2RlQ29kZXM6IHN0cmluZ1tdLCBpZHM6IHN0cmluZ1tdIH0gPSB0aGlzLmdldFBhcmFtcygpO1xyXG4gICAgLy8g6I635Y+W5YiG57qn5pa55byPXHJcbiAgICBjb25zdCBoaWVyYXJjaHlUeXBlOiBzdHJpbmcgPSB0aGlzLmdldEhpZXJhcmNoeVR5cGUoKTtcclxuICAgIC8vIOaJp+ihjOWPluaVsFxyXG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XHJcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gVHJlZVJlcG9zaXRvcnlGYWN0b3J5LmdldEluc3RhbmNlKGhpZXJhcmNoeVR5cGUpO1xyXG4gICAgaWYgKCFyZXBvc2l0b3J5KSB7XHJcbiAgICAgIC8vIOmUmeivr+eahOWIhue6p+eggVxyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ2Vycm9ySGllcmFyY2h5S2V5J10pO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0JCA9IHJlcG9zaXRvcnkuYWRkU3ViU2libGluZyh0aGlzLnJlcG9zaXRvcnksIHBhcmFtcy5ub2RlQ29kZXMsIHBhcmFtcy5pZHMpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgICgpID0+IHtcclxuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlcnJvciA9PiB7XHJcbiAgICAgICAgICB0aGlzLmVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuYWRkU3ViU2libGluZ0ZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgIH1cclxuICAgICAgKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaWsOWinuS4i+e6p1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRTdWJDaGlsZCgpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgaWYgKHRoaXMubWVzc2FnZVBpcGUpIHtcclxuICAgICAgdGhpcy5tZXNzYWdlUGlwZS5uZXh0KHsgbWVzc2FnZVR5cGU6ICdhZGRTdWJDaGlsZCcgfSk7XHJcbiAgICB9XHJcbiAgICBsZXQgcGFyYW1zOiB7IG5vZGVDb2Rlczogc3RyaW5nW10sIGlkczogc3RyaW5nW10gfSA9IHRoaXMuZ2V0UGFyYW1zKCk7XHJcbiAgICAvLyDojrflj5bliIbnuqfmlrnlvI9cclxuICAgIGNvbnN0IGhpZXJhcmNoeVR5cGUgPSB0aGlzLmdldEhpZXJhcmNoeVR5cGUoKTtcclxuXHJcbiAgICBjb25zdCBjdXJyZW50TGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhICYmIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKTtcclxuICAgIGlmICghY3VycmVudExpc3RbJ2N1cnJlbnRJZCddKSB7XHJcbiAgICAgIC8vIOivt+mAieaLqeeItuiKgueCuVxyXG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ3Bsc1NlbGVjdFBhcmVudE5vZGUnXSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIC8vIOaJp+ihjOWPluaVsFxyXG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XHJcblxyXG4gICAgY29uc3QgcmVwb3NpdG9yeSA9IFRyZWVSZXBvc2l0b3J5RmFjdG9yeS5nZXRJbnN0YW5jZShoaWVyYXJjaHlUeXBlKTtcclxuICAgIGlmICghcmVwb3NpdG9yeSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ2Vycm9ySGllcmFyY2h5S2V5J10pO1xyXG4gICAgfVxyXG4gICAgY29uc3QgYWRkU3ViQ2hpbGQkID0gcmVwb3NpdG9yeS5hZGRTdWJDaGlsZCh0aGlzLnJlcG9zaXRvcnksIHBhcmFtcy5ub2RlQ29kZXMsIHBhcmFtcy5pZHMpO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IGFkZFN1YkNoaWxkJC5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVycm9yID0+IHtcclxuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICB0aGlzLmVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuYWRkU3ViQ2hpbGRGYWlsZWQsIGVycm9yKTtcclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5Yig6Zmk5a2Q6KGo5qCR6IqC54K5XHJcbiAgICogQHBhcmFtIGlkIGlkXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZShpZDogc3RyaW5nLCBzdWNjZXNzTXNnPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIC8vIOWPguaVsOajgOafpVxyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ3Bsc1NlbGVjdERlbGV0ZURhdGEnXSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIC8vIOiOt+WPluWIhue6p+aWueW8j1xyXG4gICAgY29uc3QgaGllcmFyY2h5VHlwZSA9IHRoaXMuZ2V0SGllcmFyY2h5VHlwZSgpO1xyXG4gICAgLy8g5pyJ5a2Q6IqC54K55pe25LiN5YWB6K645Yig6ZmkXHJcbiAgICBjb25zdCB0cmVlTm9kZXNEYXRhID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpLnRvSlNPTigpO1xyXG4gICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRMaXN0KCk7XHJcbiAgICBjb25zdCB0cmVlTm9kZVV0aWwgPSBUcmVlVXRpbEZhY3RvcnkuZ2V0SW5zdGFuY2UoaGllcmFyY2h5VHlwZSk7XHJcbiAgICBpZiAodHJlZU5vZGVVdGlsID09PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBFTVBUWTtcclxuICAgIH1cclxuICAgIGlmICh0cmVlTm9kZVV0aWwuaGFzQ2hpbGROb2Rlcyh0cmVlTm9kZXNEYXRhLCB0aGlzLmhpZXJhcmNoeUluZm9GaWVsZCwgaWQpID09PSB0cnVlKSB7XHJcbiAgICAgIHRoaXMubWVzc2FnZVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZVsnZGVsZXRlQ2hpbGRGaXJzdCddKTtcclxuICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgfVxyXG4gICAgLy8g56Gu6K6k5Yig6ZmkXHJcbiAgICBjb25zdCBhY3Rpb24kID0gdGhpcy5tZXNzYWdlU2VydmljZS5xdWVzdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5jb25maXJtRGVsZXRpb24pO1xyXG4gICAgcmV0dXJuIGFjdGlvbiQucGlwZShcclxuICAgICAgY29uY2F0TWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgaWYgKCFyZXN1bHQpIHtcclxuICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6I635Y+W5Yig6Zmk5ZCO6KaB6K6+572u55qE6IqC54K5aWRcclxuICAgICAgICBjb25zdCBuZXh0Tm9kZUlkID0gdHJlZU5vZGVVdGlsLmdldE5leHROb2RlSWQodHJlZU5vZGVzRGF0YSwgdGhpcy5oaWVyYXJjaHlJbmZvRmllbGQsIGlkKTtcclxuXHJcbiAgICAgICAgLy8g5omn6KGM5Yig6ZmkXHJcbiAgICAgICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcclxuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5nZXRQYXRoKCk7XHJcbiAgICAgICAgY29uc3QgcmVtb3ZlJCA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkucmVtb3ZlQnlQYXRoKHBhdGgsIGlkKTtcclxuICAgICAgICByZXR1cm4gcmVtb3ZlJC5waXBlKFxyXG4gICAgICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAgICAgLy8g6K6+572u6YCJ5Lit6IqC54K5XHJcbiAgICAgICAgICAgIHRyZWVOb2RlVXRpbC5zZWxlY3ROb2RlQnlCaW5kaW5nTGlzdChiaW5kaW5nTGlzdCwgdGhpcy5oaWVyYXJjaHlJbmZvRmllbGQsIG5leHROb2RlSWQpO1xyXG4gICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xyXG4gICAgICAgICAgICBpZiAoc3VjY2Vzc01zZyAmJiBzdWNjZXNzTXNnLnRyaW0oKSkge1xyXG4gICAgICAgICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uuc3VjY2VzcyhzdWNjZXNzTXNnLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgICAgZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XHJcbiAgICAgICAgICAgICAgdGhpcy5lcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZUZhaWxlZCwgZXJyb3IpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICApXHJcbiAgICAgICAgKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEhpZXJhcmNoeVR5cGUoKSB7XHJcbiAgICBjb25zdCBwcm9wSW5mbyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aCh0aGlzLmhpZXJhcmNoeUluZm9LZXkuc3BsaXQoJy8nKSk7XHJcbiAgICBsZXQgaGllcmFyY2h5VHlwZSA9IHByb3BJbmZvLm1ldGFkYXRhSW5mb1snaGllcmFyY2h5VHlwZSddIHx8IG51bGw7XHJcbiAgICBpZiAoaGllcmFyY2h5VHlwZSA9PSBudWxsIHx8IGhpZXJhcmNoeVR5cGUubGVuZ3RoIDwgMSkge1xyXG4gICAgICAvLyAn5YiG57qn56CB6YWN572u5L+h5oGv6ZSZ6K+vJ1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ2luY29ycmVjdEhpZXJhcmNoeUNvbmZpZyddKTtcclxuICAgIH1cclxuICAgIHJldHVybiBoaWVyYXJjaHlUeXBlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y+C5pWwXHJcbiAgICogL3BhcmVudElkL2NoaWxkQ29kZXMvY2hpbGRJZC9ncmFuZHNvbkNvZGVzXHJcbiAgICogW2NoaWxkQ29kZXMsIGdyYW5kc29uQ29kZXNdXHJcbiAgICogW3Bhcm50SWQsIGNoaWxkSWRdXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQYXJhbXMoKTogeyBub2RlQ29kZXM6IHN0cmluZ1tdLCBpZHM6IHN0cmluZ1tdIH0ge1xyXG4gICAgbGV0IG5vZGVDb2RlcyA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLnN1YnN0cigxKS5zcGxpdCgnLycpO1xyXG4gICAgbGV0IGlkcyA9IFtdO1xyXG4gICAgbGV0IG5vZGVDb2RlQXJyYXkgPSBbXTtcclxuICAgIGNvbnN0IHJpZCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkOyAvLyByb2906KGo5pWw5o2uaWRcclxuICAgIGlkcy5wdXNoKHJpZCk7XHJcbiAgICBsZXQgc3ViRGF0YTogYW55ID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGE7XHJcbiAgICBpZiAobm9kZUNvZGVzLmxlbmd0aCA+IDApIHtcclxuICAgICAgbm9kZUNvZGVzLm1hcChub2RlQ29kZSA9PiB7XHJcbiAgICAgICAgc3ViRGF0YSA9IHN1YkRhdGFbbm9kZUNvZGVdO1xyXG4gICAgICAgIGlmIChzdWJEYXRhICYmIHN1YkRhdGEuY3VycmVudElkKSB7XHJcbiAgICAgICAgICBpZHMucHVzaChzdWJEYXRhLmN1cnJlbnRJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8v5Y676Zmkbm9kZUNvZGXnmoRzXHJcbiAgICAgICAgbm9kZUNvZGUgPyBub2RlQ29kZUFycmF5LnB1c2gobm9kZUNvZGUuc3Vic3RyaW5nKDAsIG5vZGVDb2RlLmxlbmd0aCAtIDEpKSA6IG5vZGVDb2RlQXJyYXkucHVzaChub2RlQ29kZSk7XHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgICByZXR1cm4geyBub2RlQ29kZXM6IG5vZGVDb2RlQXJyYXksIGlkczogaWRzIH07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWujOaVtOi3r+W+hFxyXG4gICAqIGZpeGVkIGJ5IGp1c3Rpbjog5qC55o2uYmluZGluZ1BhdGjvvIzlpoLmnpzmmK/ku47ku47ooajvvIzpnIDopoHojrflj5bkuLvooajmlbDmja5pZOWSjOS7juihqOaVsOaNrmlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRQYXRoKCk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoO1xyXG4gICAgY29uc3QgcmlkID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7IC8vIHJvb3TooajmlbDmja5pZFxyXG4gICAgbGV0IHBhdGggPSAnLycgKyByaWQ7XHJcblxyXG4gICAgY29uc3Qgc3ViUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgLy8gZWc6YmluZGluZ1BhdGjlvaLlpoIvZWR1cy9ncmFkZXMsc3BsaXTlkI7mmK9bJ2VkdXMnLCAnZ3JhZGVzJ11cclxuICAgICAgbGV0IHN1YkRhdGE6IGFueSA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhO1xyXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDE7IGluZGV4IDwgc3ViUGF0aHMubGVuZ3RoIC0gMTsgaW5kZXgrKykge1xyXG4gICAgICAgIGNvbnN0IHN1YlBhdGggPSBzdWJQYXRoc1tpbmRleF07XHJcbiAgICAgICAgc3ViRGF0YSA9IHN1YkRhdGFbc3ViUGF0aF07XHJcbiAgICAgICAgaWYgKCFzdWJEYXRhIHx8ICFzdWJEYXRhLmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgdGhyb3cgRXJyb3IoYOiOt+WPluWtkOihqOWujOaVtOi3r+W+hOWHuumUme+8jOaJvuS4jeWIsCR7c3ViRGF0YX3lr7nlupTnmoTlrZDooajvvIzmiJblr7nlupTlrZDooajmsqHmnInlvZPliY3ooYzjgIJgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGF0aCArPSBgLyR7c3ViUGF0aH0vJHtzdWJEYXRhLmN1cnJlbnRJZH1gO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBwYXRoICs9ICcvJyArIHN1YlBhdGhzW3N1YlBhdGhzLmxlbmd0aCAtIDFdO1xyXG5cclxuICAgIHJldHVybiBwYXRoO1xyXG4gIH1cclxufVxyXG5leHBvcnQgeyBTdWJUcmVlRGF0YVNlcnZpY2UgfTtcclxuIl19