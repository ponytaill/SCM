/**
 * @fileoverview added by tsickle
 * Generated from: lib/service/f-file-uploader.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EventEmitter, Optional } from "@angular/core";
import { Observable, Subject } from "rxjs";
import { mergeMap, finalize } from "rxjs/operators";
import { FFileUtils } from "../utils/index";
import { UploadStatus, UploadServerService, } from "../model/index";
export class FFileUploaderService {
    /**
     * @param {?} uploadServerSer
     */
    constructor(uploadServerSer) {
        this.uploadServerSer = uploadServerSer;
        this.allowedContentTypes = ["*"];
        //默认不限制,0代表不限制 Number.POSITIVE_INFINITY
        this.maxUploads = 0;
        /**
         * 单位M，默认是12M,0代表不限制
         */
        this.maxFileSize = 12;
        this.concurrency = Number.POSITIVE_INFINITY;
        this.uploadedCount = 0;
        this.extendServerConfig = null;
        this.queue = [];
        this.serviceEvents = new EventEmitter();
        this.uploadScheduler = new Subject();
        this.subs = [];
        this.uploadScheduler
            .pipe(mergeMap((/**
         * @param {?} upload
         * @return {?}
         */
        (upload) => {
            return this.serverMethod(upload);
        }), this.concurrency))
            .subscribe((/**
         * @param {?} uploadOutput
         * @return {?}
         */
        (uploadOutput) => {
            // if (uploadOutput.type == 'removed' || uploadOutput.type == 'done') {
            //   // 删除或者done移除
            //   const subIndex = this.subs.findIndex(sub => sub.id === uploadOutput.file.id);
            //   if (subIndex > -1 && this.subs[subIndex].sub) {
            //     this.subs[subIndex].sub.unsubscribe();
            //   }
            //   this.subs.splice(subIndex, 1);
            // }
            if (uploadOutput.type == "removed") {
                // 事件中返回的都是
                this.queue = this.queue.filter((/**
                 * @param {?} item
                 * @return {?}
                 */
                (item) => item.progress.status !== UploadStatus.Remove));
                if (!uploadOutput.hasOwnProperty("message")) {
                    uploadOutput["message"] = "被删除";
                }
            }
            if (uploadOutput.type == "error") {
                // 上传失败的附件移除
                this.queue = this.queue.filter((/**
                 * @param {?} queueItem
                 * @return {?}
                 */
                (queueItem) => {
                    return (uploadOutput.files.findIndex((/**
                     * @param {?} item
                     * @return {?}
                     */
                    (item) => queueItem.id == item.id)) <
                        0);
                }));
            }
            this.serviceEvents.emit(uploadOutput);
        }));
    }
    /**
     * @param {?} options
     * @return {?}
     */
    setOptions(options) {
        // 重置文件大小、类型、个数限制
        if (options) {
            for (let prop in options) {
                this[prop] = options[prop];
            }
        }
    }
    /**
     * @param {?} incomingFiles
     * @return {?}
     */
    handleFiles(incomingFiles) {
        /** @type {?} */
        const allowedIncomingFiles = [].reduce.call(incomingFiles, (/**
         * @param {?} acc
         * @param {?} checkFile
         * @param {?} i
         * @return {?}
         */
        (acc, checkFile, i) => {
            /** @type {?} */
            const futureQueueLength = acc.length + this.queue.length + 1;
            /** @type {?} */
            let judgeResult = this.rejectedReason(checkFile.name, checkFile.type, futureQueueLength, checkFile.size);
            if (judgeResult.allowed) {
                acc = acc.concat(checkFile);
            }
            else {
                // 不符合当前文件类型或者内容超出限制，抛出事件
                /** @type {?} */
                const rejectedFile = FFileUtils.makeUploadFile(checkFile, i);
                this.serviceEvents.emit({
                    type: "rejected",
                    file: rejectedFile,
                    message: judgeResult.message,
                });
            }
            return acc;
        }), []);
        // 构造文件结构，并单个抛出事件
        [].map.call(allowedIncomingFiles, (/**
         * @param {?} file
         * @param {?} i
         * @return {?}
         */
        (file, i) => {
            /** @type {?} */
            const uploadFile = FFileUtils.makeUploadFile(file, i);
            this.queue.push(uploadFile);
            this.serviceEvents.emit({ type: "addedToQueue", file: uploadFile });
        }));
        // 所有的文件都已经添加，抛出事件
        this.serviceEvents.emit({ type: "allAddedToQueue" });
    }
    /**
     * @private
     * @param {?} name
     * @param {?} type
     * @param {?} queuelength
     * @param {?} size
     * @return {?}
     */
    rejectedReason(name, type, queuelength, size) {
        /** @type {?} */
        let allowed = false;
        /** @type {?} */
        let message = "";
        // 已存在同名文件
        /** @type {?} */
        let findDuplicateIndex = this.queue.findIndex((/**
         * @param {?} file
         * @return {?}
         */
        (file) => file.name == name));
        if (findDuplicateIndex > -1) {
            message = "上传失败：已存在同名文件";
        }
        else if (!this.isContentTypeAllowed(name)) {
            message =
                "上传失败：只允许上传" +
                    this.allowedContentTypes.join(",") +
                    "类型的文档";
        }
        else if (this.maxUploads > 0 &&
            (this.maxUploads <= this.uploadedCount ||
                queuelength + this.uploadedCount > this.maxUploads)) {
            message = "上传失败：文件总个数超出" + this.maxUploads + "限制";
        }
        else if (!this.isFileSizeAllowed(size)) {
            message = "上传失败：单个文件大小超出" + this.maxFileSize + "MB的限制";
        }
        else if (size == 0) {
            message = "上传失败：不允许文件为空";
        }
        else {
            allowed = true;
        }
        return {
            allowed,
            message,
        };
    }
    /**
     * 从前端传来事件，进行服务器端方法类型判断
     * @param {?} input
     * @return {?}
     */
    initInputEvents(input) {
        //debugger
        return input.subscribe((/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            //debugger
            switch (event.type) {
                case 'sliceUpload':
                    /** @type {?} */
                    const _files = this.queue.filter((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.progress.status === UploadStatus.Queue));
                    if (_files.length > 0) {
                        this.uploadScheduler.next({
                            files: _files,
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "upload":
                case "multipartUpload":
                    /** @type {?} */
                    const uploadFileIndex = this.queue.findIndex((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file === event.file));
                    if (uploadFileIndex !== -1 && event.file) {
                        this.uploadScheduler.next({
                            files: [this.queue[uploadFileIndex]],
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "uploadAll":
                    /** @type {?} */
                    const files = this.queue.filter((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.progress.status === UploadStatus.Queue));
                    if (files.length > 0) {
                        event.type = "upload";
                        this.uploadScheduler.next({
                            files: files,
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "cancel":
                    /** @type {?} */
                    const id = event.id || null;
                    if (!id) {
                        return;
                    }
                    /** @type {?} */
                    const fileIndex = this.queue.findIndex((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.id === id));
                    if (fileIndex !== -1) {
                        this.serviceEvents.emit({
                            type: "cancelled",
                            files: [this.queue[fileIndex]],
                            message: "已取消附件上传",
                        });
                        this.queue.splice(fileIndex, 1);
                    }
                    break;
                    // case 'cancel':
                    // debugger
                    // const id = event.id || null;
                    // if (!id) {
                    //   return;
                    // }
                    // const subs = this.subs.filter(sub => sub.id === id);
                    // subs.forEach(sub => {
                    //   if (sub.sub) {
                    //     sub.sub.unsubscribe();
                    //     const fileIndex = this.queue.findIndex(file => file.id === id);
                    //     if (fileIndex !== -1) {
                    //       this.queue[fileIndex].progress.status = UploadStatus.Cancelled;
                    //       this.serviceEvents.emit({ type: 'cancelled', file: this.queue[fileIndex] });
                    //     }
                    //   }
                    // });
                    break;
                // case 'cancelAll':
                //   this.subs.forEach(sub => {
                //     if (sub.sub) {
                //       sub.sub.unsubscribe();
                //     }
                //     const file = this.queue.find(uploadFile => uploadFile.id === sub.id);
                //     if (file) {
                //       file.progress.status = UploadStatus.Cancelled;
                //       this.serviceEvents.emit({ type: 'cancelled', file: file });
                //     }
                //   });
                //   break;
                case "hide":
                    if (!event.id) {
                        return;
                    }
                    /** @type {?} */
                    let ids = event.id.split(",");
                    this.queue = this.queue.filter((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => {
                        /** @type {?} */
                        let tIndex = ids.findIndex((/**
                         * @param {?} tId
                         * @return {?}
                         */
                        (tId) => tId == file.id));
                        return tIndex > -1 ? false : true;
                    }));
                    break;
                case "cancelAll":
                    // 取消，直接从队列中移除，不用修改状态
                    /** @type {?} */
                    const queueFiles = this.queue.filter((/**
                     * @param {?} uploadFile
                     * @return {?}
                     */
                    (uploadFile) => uploadFile.progress.status === UploadStatus.Queue));
                    if (queueFiles.length) {
                        this.serviceEvents.emit({
                            type: "cancelled",
                            files: queueFiles,
                            message: "已取消附件上传",
                        });
                        this.queue = this.queue.filter((/**
                         * @param {?} uploadFile
                         * @return {?}
                         */
                        (uploadFile) => uploadFile.progress.status != UploadStatus.Queue));
                    }
                    break;
                case "remove":
                    if (!event.id) {
                        return;
                    }
                    /** @type {?} */
                    const removeIndex = this.queue.findIndex((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.id === event.id));
                    if (removeIndex !== -1) {
                        // 得有个开始删除和已经删除
                        this.queue[removeIndex].progress.status = UploadStatus.Remove;
                        this.uploadScheduler.next({
                            files: [this.queue[removeIndex]],
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "removeAll":
                    /** @type {?} */
                    const removeQueueFiles = this.queue.filter((/**
                     * @param {?} uploadFile
                     * @return {?}
                     */
                    (uploadFile) => uploadFile.progress.status === UploadStatus.Queue));
                    if (removeQueueFiles.length) {
                        this.serviceEvents.emit({
                            type: "cancelled",
                            files: removeQueueFiles,
                            message: "删除附件成功",
                        });
                        this.queue = this.queue.filter((/**
                         * @param {?} uploadFile
                         * @return {?}
                         */
                        (uploadFile) => uploadFile.progress.status != UploadStatus.Queue));
                    }
                    // 正在上传的附件是如何处理
                    // const doneFiles = this.queue.filter(uploadFile => uploadFile.progress.status === UploadStatus.Done);
                    if (this.queue.length) {
                        event.type = "remove";
                        this.queue.map((/**
                         * @param {?} item
                         * @return {?}
                         */
                        (item) => (item.progress.status = UploadStatus.Remove)));
                        this.uploadScheduler.next({
                            files: this.queue,
                            event: event,
                            file: null,
                        });
                    }
                    break;
            }
        }));
    }
    /**
     * @param {?} extendSer
     * @return {?}
     */
    setExtendServerConfig(extendSer) {
        this.extendServerConfig = extendSer;
    }
    /**
     * @param {?} upload
     * @return {?}
     */
    serverMethod(upload) {
        return new Observable((/**
         * @param {?} observer
         * @return {?}
         */
        (observer) => {
            /** @type {?} */
            let sub;
            /** @type {?} */
            let ids = upload.files.map((/**
             * @param {?} fileItem
             * @return {?}
             */
            (fileItem) => fileItem.id));
            switch (upload.event.type) {
                case 'sliceUpload':
                    sub = this.upload(upload.files, upload.event);
                    break;
                case "upload":
                    sub = this.upload(upload.files, upload.event);
                    break;
                case "multipartUpload":
                    sub = this.multipartUpload(upload.files[0], upload.event);
                    break;
                // case 'uploadAll':
                //   ids = upload.files.map(fileItem => fileItem.id);
                //   sub = this.uploadAll(upload.files, upload.event);
                //   break;
                case "remove":
                    sub = this.remove(upload.files, upload.event);
                    break;
                // case 'removeAll':
                //   ids = upload.files.map(fileItem => fileItem.id);
                //   sub = this.removeAll(upload.files, upload.event);
                //   break;
                default:
                    sub = null;
            }
            if (!sub) {
                return;
            }
            sub.pipe(finalize((/**
             * @return {?}
             */
            () => {
                // debugger;
                if (!observer.closed) {
                    observer.complete();
                }
            }))).subscribe((/**
             * @param {?} output
             * @return {?}
             */
            (output) => {
                // debugger;
                observer.next(output);
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                observer.next(err);
            }), (/**
             * @return {?}
             */
            () => {
                observer.complete();
            }));
            this.subs.push({ ids: ids, sub: sub, id: "" });
            // switch (upload.event.type) {
            //   case 'uploadAll':
            //     this.subs.push({ ids: ids, sub: sub, id: '' });
            //     break;
            //   case 'removeAll':
            //     this.subs.push({ ids: ids, sub: sub, id: '' });
            //     break;
            //   default:
            // }
        }));
    }
    /**
     * 单个文件上传
     * @param {?} file
     * @param {?} event
     * @return {?}
     */
    // uploadFile(file: UploadFile, event: UploadInput): Observable<UploadOutput> {
    //   const uploadFile = <BlobFile>file.nativeFile;
    //   const uploadIndex = this.queue.findIndex(outFile => outFile.nativeFile === uploadFile);
    //   // 已经被取消的不能被上传
    //   if (this.queue[uploadIndex].progress.status === UploadStatus.Cancelled) {
    //     return new Observable(observer => {
    //       observer.complete();
    //     });
    //   }
    //   // 抛出开始上传的事件
    //   this.serviceEvents.emit({ type: 'start', files: [file] });
    //   return this.uploadServerSer.upload(file, event, this.extendServerConfig);
    // }
    multipartUpload(file, event) {
        // 抛出开始上传的事件
        this.serviceEvents.emit({ type: "start", files: [file] });
        return this.uploadServerSer.multipartUpload(file, event, this.extendServerConfig);
    }
    /**
     * @param {?} files
     * @param {?} event
     * @return {?}
     */
    upload(files, event) {
        // 抛出开始上传的事件
        this.serviceEvents.emit({ type: "start", files: files });
        return this.uploadServerSer.upload(files, event, this.extendServerConfig);
    }
    /**
     * @param {?} files
     * @param {?} event
     * @return {?}
     */
    remove(files, event) {
        return this.uploadServerSer.remove(files, event, this.extendServerConfig);
    }
    // removeAll(files: UploadFile[], event: UploadInput): Observable<UploadOutput> {
    //   return this.uploadServerSer.removeAll(files, event, this.extendServerConfig);
    // }
    // 重置
    /**
     * @return {?}
     */
    reset() {
        this.queue = [];
        //this.uploadScheduler = new Subject();
        // this.subs.forEach(sub => {
        //   if (sub.sub) {
        //     sub.sub.unsubscribe();
        //   }
        // });
        this.subs = [];
    }
    // 暂时
    /**
     * @param {?} contentTypes
     * @return {?}
     */
    setContentTypes(contentTypes) {
        if (typeof contentTypes !== "undefined" && contentTypes instanceof Array) {
            if (contentTypes.find((/**
             * @param {?} type
             * @return {?}
             */
            (type) => type === "*")) !== undefined) {
                this.allowedContentTypes = ["*"];
            }
            else {
                this.allowedContentTypes = contentTypes;
            }
            return;
        }
        this.allowedContentTypes = ["*"];
    }
    /**
     * @return {?}
     */
    allContentTypesAllowed() {
        return (this.allowedContentTypes.find((/**
         * @param {?} type
         * @return {?}
         */
        (type) => type === "*")) !==
            undefined);
    }
    /**
     *
     * @param {?} name
     * @return {?}
     */
    isContentTypeAllowed(name) {
        if (this.allContentTypesAllowed()) {
            return true;
        }
        // 附件没有后缀
        if (name.lastIndexOf(".") < 0) {
            return false;
        }
        /** @type {?} */
        let namesuffix = name.substr(name.lastIndexOf("."));
        // 简化计算
        return (this.allowedContentTypes.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        (item) => item.toLowerCase() == namesuffix.toLowerCase())) > -1);
    }
    /**
     * @param {?} fileSize
     * @return {?}
     */
    isFileSizeAllowed(fileSize) {
        if (!this.maxFileSize) {
            return true;
        }
        // fileSize是b单位 maxFileSize是MB单位
        return fileSize <= this.maxFileSize * 1024 * 1024; // * 8
    }
}
/** @nocollapse */
FFileUploaderService.ctorParameters = () => [
    { type: UploadServerService, decorators: [{ type: Optional }] }
];
if (false) {
    /** @type {?} */
    FFileUploaderService.prototype.queue;
    /** @type {?} */
    FFileUploaderService.prototype.serviceEvents;
    /** @type {?} */
    FFileUploaderService.prototype.uploadScheduler;
    /** @type {?} */
    FFileUploaderService.prototype.subs;
    /** @type {?} */
    FFileUploaderService.prototype.allowedContentTypes;
    /** @type {?} */
    FFileUploaderService.prototype.maxUploads;
    /**
     * 单位M，默认是12M,0代表不限制
     * @type {?}
     */
    FFileUploaderService.prototype.maxFileSize;
    /** @type {?} */
    FFileUploaderService.prototype.concurrency;
    /** @type {?} */
    FFileUploaderService.prototype.uploadedCount;
    /**
     * @type {?}
     * @private
     */
    FFileUploaderService.prototype.extendServerConfig;
    /**
     * @type {?}
     * @private
     */
    FFileUploaderService.prototype.uploadServerSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZi1maWxlLXVwbG9hZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2V4dGVuZC1maWxlLXVwbG9hZC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlL2YtZmlsZS11cGxvYWRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQW9CLE1BQU0sTUFBTSxDQUFDO0FBQzdELE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFJSCxZQUFZLEVBRVosbUJBQW1CLEdBRXRCLE1BQU0sZ0JBQWdCLENBQUM7QUFFeEIsTUFBTSxPQUFPLG9CQUFvQjs7OztJQWlCN0IsWUFBZ0MsZUFBb0M7UUFBcEMsb0JBQWUsR0FBZixlQUFlLENBQXFCO1FBUnBFLHdCQUFtQixHQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7O1FBRXRDLGVBQVUsR0FBVyxDQUFDLENBQUM7Ozs7UUFFdkIsZ0JBQVcsR0FBVyxFQUFFLENBQUM7UUFDekIsZ0JBQVcsR0FBVyxNQUFNLENBQUMsaUJBQWlCLENBQUM7UUFDL0Msa0JBQWEsR0FBVyxDQUFDLENBQUM7UUFDbEIsdUJBQWtCLEdBQUcsSUFBSSxDQUFDO1FBRTlCLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxZQUFZLEVBQWdCLENBQUM7UUFDdEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRWYsSUFBSSxDQUFDLGVBQWU7YUFDZixJQUFJLENBQ0QsUUFBUTs7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O0lBQzdELENBQUM7Ozs7WUEvZEQsbUJBQW1CLHVCQXFCTixRQUFROzs7O0lBaEJyQixxQ0FBb0I7O0lBQ3BCLDZDQUEwQzs7SUFDMUMsK0NBSUc7O0lBQ0gsb0NBQTBEOztJQUMxRCxtREFBc0M7O0lBRXRDLDBDQUF1Qjs7Ozs7SUFFdkIsMkNBQXlCOztJQUN6QiwyQ0FBK0M7O0lBQy9DLDZDQUEwQjs7Ozs7SUFDMUIsa0RBQWtDOzs7OztJQUN0QiwrQ0FBd0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIsIE9wdGlvbmFsIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgU3Vic2NyaXB0aW9uLCBvZiB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IG1lcmdlTWFwLCBmaW5hbGl6ZSB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xyXG5pbXBvcnQgeyBGRmlsZVV0aWxzIH0gZnJvbSBcIi4uL3V0aWxzL2luZGV4XCI7XHJcbmltcG9ydCB7XHJcbiAgICBVcGxvYWRGaWxlLFxyXG4gICAgVXBsb2FkT3V0cHV0LFxyXG4gICAgVXBsb2FkSW5wdXQsXHJcbiAgICBVcGxvYWRTdGF0dXMsXHJcbiAgICBCbG9iRmlsZSxcclxuICAgIFVwbG9hZFNlcnZlclNlcnZpY2UsXHJcbiAgICBVcGxvYWRlck9wdGlvbnMsXHJcbn0gZnJvbSBcIi4uL21vZGVsL2luZGV4XCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRkZpbGVVcGxvYWRlclNlcnZpY2Uge1xyXG4gICAgcXVldWU6IFVwbG9hZEZpbGVbXTtcclxuICAgIHNlcnZpY2VFdmVudHM6IEV2ZW50RW1pdHRlcjxVcGxvYWRPdXRwdXQ+O1xyXG4gICAgdXBsb2FkU2NoZWR1bGVyOiBTdWJqZWN0PHtcclxuICAgICAgICBmaWxlOiBVcGxvYWRGaWxlO1xyXG4gICAgICAgIGV2ZW50OiBVcGxvYWRJbnB1dDtcclxuICAgICAgICBmaWxlcz86IFVwbG9hZEZpbGVbXTtcclxuICAgIH0+O1xyXG4gICAgc3ViczogeyBpZDogc3RyaW5nOyBzdWI6IFN1YnNjcmlwdGlvbjsgaWRzPzogc3RyaW5nW10gfVtdO1xyXG4gICAgYWxsb3dlZENvbnRlbnRUeXBlczogc3RyaW5nW10gPSBbXCIqXCJdO1xyXG4gICAgLy/pu5jorqTkuI3pmZDliLYsMOS7o+ihqOS4jemZkOWItiBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFlcclxuICAgIG1heFVwbG9hZHM6IG51bWJlciA9IDA7XHJcbiAgICAvKiog5Y2V5L2NTe+8jOm7mOiupOaYrzEyTSww5Luj6KGo5LiN6ZmQ5Yi2ICovXHJcbiAgICBtYXhGaWxlU2l6ZTogbnVtYmVyID0gMTI7XHJcbiAgICBjb25jdXJyZW5jeTogbnVtYmVyID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZO1xyXG4gICAgdXBsb2FkZWRDb3VudDogbnVtYmVyID0gMDtcclxuICAgIHByaXZhdGUgZXh0ZW5kU2VydmVyQ29uZmlnID0gbnVsbDtcclxuICAgIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIHByaXZhdGUgdXBsb2FkU2VydmVyU2VyOiBVcGxvYWRTZXJ2ZXJTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5xdWV1ZSA9IFtdO1xyXG4gICAgICAgIHRoaXMuc2VydmljZUV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXI8VXBsb2FkT3V0cHV0PigpO1xyXG4gICAgICAgIHRoaXMudXBsb2FkU2NoZWR1bGVyID0gbmV3IFN1YmplY3QoKTtcclxuICAgICAgICB0aGlzLnN1YnMgPSBbXTtcclxuXHJcbiAgICAgICAgdGhpcy51cGxvYWRTY2hlZHVsZXJcclxuICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBtZXJnZU1hcCgodXBsb2FkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VydmVyTWV0aG9kKHVwbG9hZCk7XHJcbiAgICAgICAgICAgICAgICB9LCB0aGlzLmNvbmN1cnJlbmN5KVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKHVwbG9hZE91dHB1dCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gaWYgKHVwbG9hZE91dHB1dC50eXBlID09ICdyZW1vdmVkJyB8fCB1cGxvYWRPdXRwdXQudHlwZSA9PSAnZG9uZScpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgLy8g5Yig6Zmk5oiW6ICFZG9uZeenu+mZpFxyXG4gICAgICAgICAgICAgICAgLy8gICBjb25zdCBzdWJJbmRleCA9IHRoaXMuc3Vicy5maW5kSW5kZXgoc3ViID0+IHN1Yi5pZCA9PT0gdXBsb2FkT3V0cHV0LmZpbGUuaWQpO1xyXG4gICAgICAgICAgICAgICAgLy8gICBpZiAoc3ViSW5kZXggPiAtMSAmJiB0aGlzLnN1YnNbc3ViSW5kZXhdLnN1Yikge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIHRoaXMuc3Vic1tzdWJJbmRleF0uc3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgIH1cclxuICAgICAgICAgICAgICAgIC8vICAgdGhpcy5zdWJzLnNwbGljZShzdWJJbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICBpZiAodXBsb2FkT3V0cHV0LnR5cGUgPT0gXCJyZW1vdmVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDkuovku7bkuK3ov5Tlm57nmoTpg73mmK9cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChpdGVtKSA9PiBpdGVtLnByb2dyZXNzLnN0YXR1cyAhPT0gVXBsb2FkU3RhdHVzLlJlbW92ZVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF1cGxvYWRPdXRwdXQuaGFzT3duUHJvcGVydHkoXCJtZXNzYWdlXCIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZE91dHB1dFtcIm1lc3NhZ2VcIl0gPSBcIuiiq+WIoOmZpFwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh1cGxvYWRPdXRwdXQudHlwZSA9PSBcImVycm9yXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDkuIrkvKDlpLHotKXnmoTpmYTku7bnp7vpmaRcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoKHF1ZXVlSXRlbSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkT3V0cHV0LmZpbGVzLmZpbmRJbmRleCgoaXRlbSkgPT4gcXVldWVJdGVtLmlkID09IGl0ZW0uaWQpIDxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDBcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHVwbG9hZE91dHB1dCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgc2V0T3B0aW9ucyhvcHRpb25zOiBVcGxvYWRlck9wdGlvbnMpIHtcclxuICAgICAgICAvLyDph43nva7mlofku7blpKflsI/jgIHnsbvlnovjgIHkuKrmlbDpmZDliLZcclxuICAgICAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBwcm9wIGluIG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXNbcHJvcF0gPSBvcHRpb25zW3Byb3BdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaGFuZGxlRmlsZXMoaW5jb21pbmdGaWxlczogRmlsZUxpc3QpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBhbGxvd2VkSW5jb21pbmdGaWxlczogRmlsZVtdID0gW10ucmVkdWNlLmNhbGwoXHJcbiAgICAgICAgICAgIGluY29taW5nRmlsZXMsXHJcbiAgICAgICAgICAgIChhY2M6IEZpbGVbXSwgY2hlY2tGaWxlOiBGaWxlLCBpOiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZ1dHVyZVF1ZXVlTGVuZ3RoID0gYWNjLmxlbmd0aCArIHRoaXMucXVldWUubGVuZ3RoICsgMTtcclxuICAgICAgICAgICAgICAgIGxldCBqdWRnZVJlc3VsdCA9IHRoaXMucmVqZWN0ZWRSZWFzb24oXHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLnR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgZnV0dXJlUXVldWVMZW5ndGgsXHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLnNpemVcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBpZiAoanVkZ2VSZXN1bHQuYWxsb3dlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFjYyA9IGFjYy5jb25jYXQoY2hlY2tGaWxlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5LiN56ym5ZCI5b2T5YmN5paH5Lu257G75Z6L5oiW6ICF5YaF5a656LaF5Ye66ZmQ5Yi277yM5oqb5Ye65LqL5Lu2XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVqZWN0ZWRGaWxlOiBVcGxvYWRGaWxlID0gRkZpbGVVdGlscy5tYWtlVXBsb2FkRmlsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwicmVqZWN0ZWRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogcmVqZWN0ZWRGaWxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBqdWRnZVJlc3VsdC5tZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgW11cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyDmnoTpgKDmlofku7bnu5PmnoTvvIzlubbljZXkuKrmipvlh7rkuovku7ZcclxuICAgICAgICBbXS5tYXAuY2FsbChhbGxvd2VkSW5jb21pbmdGaWxlcywgKGZpbGU6IEZpbGUsIGk6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB1cGxvYWRGaWxlOiBVcGxvYWRGaWxlID0gRkZpbGVVdGlscy5tYWtlVXBsb2FkRmlsZShmaWxlLCBpKTtcclxuICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHVwbG9hZEZpbGUpO1xyXG4gICAgICAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7IHR5cGU6IFwiYWRkZWRUb1F1ZXVlXCIsIGZpbGU6IHVwbG9hZEZpbGUgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOaJgOacieeahOaWh+S7tumDveW3sue7j+a3u+WKoO+8jOaKm+WHuuS6i+S7tlxyXG4gICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHsgdHlwZTogXCJhbGxBZGRlZFRvUXVldWVcIiB9KTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgcmVqZWN0ZWRSZWFzb24obmFtZSwgdHlwZSwgcXVldWVsZW5ndGgsIHNpemUpIHtcclxuICAgICAgICBsZXQgYWxsb3dlZCA9IGZhbHNlO1xyXG4gICAgICAgIGxldCBtZXNzYWdlID0gXCJcIjtcclxuICAgICAgICAvLyDlt7LlrZjlnKjlkIzlkI3mlofku7ZcclxuICAgICAgICBsZXQgZmluZER1cGxpY2F0ZUluZGV4ID0gdGhpcy5xdWV1ZS5maW5kSW5kZXgoKGZpbGUpID0+IGZpbGUubmFtZSA9PSBuYW1lKTtcclxuICAgICAgICBpZiAoZmluZER1cGxpY2F0ZUluZGV4ID4gLTEpIHtcclxuICAgICAgICAgICAgbWVzc2FnZSA9IFwi5LiK5Lyg5aSx6LSl77ya5bey5a2Y5Zyo5ZCM5ZCN5paH5Lu2XCI7XHJcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pc0NvbnRlbnRUeXBlQWxsb3dlZChuYW1lKSkge1xyXG4gICAgICAgICAgICBtZXNzYWdlID1cclxuICAgICAgICAgICAgICAgIFwi5LiK5Lyg5aSx6LSl77ya5Y+q5YWB6K645LiK5LygXCIgK1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hbGxvd2VkQ29udGVudFR5cGVzLmpvaW4oXCIsXCIpICtcclxuICAgICAgICAgICAgICAgIFwi57G75Z6L55qE5paH5qGjXCI7XHJcbiAgICAgICAgfSBlbHNlIGlmIChcclxuICAgICAgICAgICAgdGhpcy5tYXhVcGxvYWRzID4gMCAmJlxyXG4gICAgICAgICAgICAodGhpcy5tYXhVcGxvYWRzIDw9IHRoaXMudXBsb2FkZWRDb3VudCB8fFxyXG4gICAgICAgICAgICAgICAgcXVldWVsZW5ndGggKyB0aGlzLnVwbG9hZGVkQ291bnQgPiB0aGlzLm1heFVwbG9hZHMpXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBcIuS4iuS8oOWksei0pe+8muaWh+S7tuaAu+S4quaVsOi2heWHulwiICsgdGhpcy5tYXhVcGxvYWRzICsgXCLpmZDliLZcIjtcclxuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmlzRmlsZVNpemVBbGxvd2VkKHNpemUpKSB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBcIuS4iuS8oOWksei0pe+8muWNleS4quaWh+S7tuWkp+Wwj+i2heWHulwiICsgdGhpcy5tYXhGaWxlU2l6ZSArIFwiTULnmoTpmZDliLZcIjtcclxuICAgICAgICB9IGVsc2UgaWYgKHNpemUgPT0gMCkge1xyXG4gICAgICAgICAgICBtZXNzYWdlID0gXCLkuIrkvKDlpLHotKXvvJrkuI3lhYHorrjmlofku7bkuLrnqbpcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhbGxvd2VkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgYWxsb3dlZCxcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDku47liY3nq6/kvKDmnaXkuovku7bvvIzov5vooYzmnI3liqHlmajnq6/mlrnms5XnsbvlnovliKTmlq1cclxuICAgICAqIEBwYXJhbSBpbnB1dFxyXG4gICAgICovXHJcbiAgICBpbml0SW5wdXRFdmVudHMoaW5wdXQ6IEV2ZW50RW1pdHRlcjxVcGxvYWRJbnB1dD4pOiBTdWJzY3JpcHRpb24ge1xyXG4gICAgICAgIC8vZGVidWdnZXJcclxuICAgICAgICByZXR1cm4gaW5wdXQuc3Vic2NyaWJlKChldmVudDogVXBsb2FkSW5wdXQpID0+IHtcclxuICAgICAgICAgICAgLy9kZWJ1Z2dlclxyXG4gICAgICAgICAgICBzd2l0Y2ggKGV2ZW50LnR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3NsaWNlVXBsb2FkJzpcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBfZmlsZXMgPSB0aGlzLnF1ZXVlLmZpbHRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGUpID0+IGZpbGUucHJvZ3Jlc3Muc3RhdHVzID09PSBVcGxvYWRTdGF0dXMuUXVldWVcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChfZmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNjaGVkdWxlci5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzOiBfZmlsZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogZXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwidXBsb2FkXCI6XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwibXVsdGlwYXJ0VXBsb2FkXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBsb2FkRmlsZUluZGV4ID0gdGhpcy5xdWV1ZS5maW5kSW5kZXgoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChmaWxlKSA9PiBmaWxlID09PSBldmVudC5maWxlXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodXBsb2FkRmlsZUluZGV4ICE9PSAtMSAmJiBldmVudC5maWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkU2NoZWR1bGVyLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IFt0aGlzLnF1ZXVlW3VwbG9hZEZpbGVJbmRleF1dLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcInVwbG9hZEFsbFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5xdWV1ZS5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChmaWxlKSA9PiBmaWxlLnByb2dyZXNzLnN0YXR1cyA9PT0gVXBsb2FkU3RhdHVzLlF1ZXVlXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZXMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBldmVudC50eXBlID0gXCJ1cGxvYWRcIjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRTY2hlZHVsZXIubmV4dCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlczogZmlsZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogZXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiY2FuY2VsXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaWQgPSBldmVudC5pZCB8fCBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWxlSW5kZXggPSB0aGlzLnF1ZXVlLmZpbmRJbmRleCgoZmlsZSkgPT4gZmlsZS5pZCA9PT0gaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWxlSW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiY2FuY2VsbGVkXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlczogW3RoaXMucXVldWVbZmlsZUluZGV4XV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIuW3suWPlua2iOmZhOS7tuS4iuS8oFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWV1ZS5zcGxpY2UoZmlsZUluZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gY2FzZSAnY2FuY2VsJzpcclxuICAgICAgICAgICAgICAgICAgICAvLyBkZWJ1Z2dlclxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGlkID0gZXZlbnQuaWQgfHwgbnVsbDtcclxuICAgICAgICAgICAgICAgICAgICAvLyBpZiAoIWlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IHN1YnMgPSB0aGlzLnN1YnMuZmlsdGVyKHN1YiA9PiBzdWIuaWQgPT09IGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyBzdWJzLmZvckVhY2goc3ViID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgIGlmIChzdWIuc3ViKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIHN1Yi5zdWIudW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgY29uc3QgZmlsZUluZGV4ID0gdGhpcy5xdWV1ZS5maW5kSW5kZXgoZmlsZSA9PiBmaWxlLmlkID09PSBpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGlmIChmaWxlSW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgdGhpcy5xdWV1ZVtmaWxlSW5kZXhdLnByb2dyZXNzLnN0YXR1cyA9IFVwbG9hZFN0YXR1cy5DYW5jZWxsZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgdGhpcy5zZXJ2aWNlRXZlbnRzLmVtaXQoeyB0eXBlOiAnY2FuY2VsbGVkJywgZmlsZTogdGhpcy5xdWV1ZVtmaWxlSW5kZXhdIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAvLyBjYXNlICdjYW5jZWxBbGwnOlxyXG4gICAgICAgICAgICAgICAgLy8gICB0aGlzLnN1YnMuZm9yRWFjaChzdWIgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIGlmIChzdWIuc3ViKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICBzdWIuc3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vICAgICBjb25zdCBmaWxlID0gdGhpcy5xdWV1ZS5maW5kKHVwbG9hZEZpbGUgPT4gdXBsb2FkRmlsZS5pZCA9PT0gc3ViLmlkKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICBpZiAoZmlsZSkge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgZmlsZS5wcm9ncmVzcy5zdGF0dXMgPSBVcGxvYWRTdGF0dXMuQ2FuY2VsbGVkO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgICAgdGhpcy5zZXJ2aWNlRXZlbnRzLmVtaXQoeyB0eXBlOiAnY2FuY2VsbGVkJywgZmlsZTogZmlsZSB9KTtcclxuICAgICAgICAgICAgICAgIC8vICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyAgIH0pO1xyXG4gICAgICAgICAgICAgICAgLy8gICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJoaWRlXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFldmVudC5pZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBpZHMgPSBldmVudC5pZC5zcGxpdChcIixcIik7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWV1ZSA9IHRoaXMucXVldWUuZmlsdGVyKChmaWxlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0SW5kZXggPSBpZHMuZmluZEluZGV4KCh0SWQpID0+IHRJZCA9PSBmaWxlLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRJbmRleCA+IC0xID8gZmFsc2UgOiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImNhbmNlbEFsbFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOWPlua2iO+8jOebtOaOpeS7jumYn+WIl+S4reenu+mZpO+8jOS4jeeUqOS/ruaUueeKtuaAgVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXVlRmlsZXMgPSB0aGlzLnF1ZXVlLmZpbHRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgKHVwbG9hZEZpbGUpID0+IHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhdHVzID09PSBVcGxvYWRTdGF0dXMuUXVldWVcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChxdWV1ZUZpbGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImNhbmNlbGxlZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IHF1ZXVlRmlsZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIuW3suWPlua2iOmZhOS7tuS4iuS8oFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWV1ZSA9IHRoaXMucXVldWUuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHVwbG9hZEZpbGUpID0+IHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhdHVzICE9IFVwbG9hZFN0YXR1cy5RdWV1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJyZW1vdmVcIjpcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWV2ZW50LmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlSW5kZXggPSB0aGlzLnF1ZXVlLmZpbmRJbmRleChcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGUpID0+IGZpbGUuaWQgPT09IGV2ZW50LmlkXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlSW5kZXggIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOW+l+acieS4quW8gOWni+WIoOmZpOWSjOW3sue7j+WIoOmZpFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlW3JlbW92ZUluZGV4XS5wcm9ncmVzcy5zdGF0dXMgPSBVcGxvYWRTdGF0dXMuUmVtb3ZlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNjaGVkdWxlci5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzOiBbdGhpcy5xdWV1ZVtyZW1vdmVJbmRleF1dLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcInJlbW92ZUFsbFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92ZVF1ZXVlRmlsZXMgPSB0aGlzLnF1ZXVlLmZpbHRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgKHVwbG9hZEZpbGUpID0+IHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhdHVzID09PSBVcGxvYWRTdGF0dXMuUXVldWVcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVRdWV1ZUZpbGVzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcImNhbmNlbGxlZFwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IHJlbW92ZVF1ZXVlRmlsZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIuWIoOmZpOmZhOS7tuaIkOWKn1wiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5xdWV1ZSA9IHRoaXMucXVldWUuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKHVwbG9hZEZpbGUpID0+IHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhdHVzICE9IFVwbG9hZFN0YXR1cy5RdWV1ZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyDmraPlnKjkuIrkvKDnmoTpmYTku7bmmK/lpoLkvZXlpITnkIZcclxuICAgICAgICAgICAgICAgICAgICAvLyBjb25zdCBkb25lRmlsZXMgPSB0aGlzLnF1ZXVlLmZpbHRlcih1cGxvYWRGaWxlID0+IHVwbG9hZEZpbGUucHJvZ3Jlc3Muc3RhdHVzID09PSBVcGxvYWRTdGF0dXMuRG9uZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMucXVldWUubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBcInJlbW92ZVwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlLm1hcChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpdGVtKSA9PiAoaXRlbS5wcm9ncmVzcy5zdGF0dXMgPSBVcGxvYWRTdGF0dXMuUmVtb3ZlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNjaGVkdWxlci5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzOiB0aGlzLnF1ZXVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGV2ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0RXh0ZW5kU2VydmVyQ29uZmlnKGV4dGVuZFNlcikge1xyXG4gICAgICAgIHRoaXMuZXh0ZW5kU2VydmVyQ29uZmlnID0gZXh0ZW5kU2VyO1xyXG4gICAgfVxyXG5cclxuICAgIHNlcnZlck1ldGhvZCh1cGxvYWQ6IHtcclxuICAgICAgICBmaWxlOiBVcGxvYWRGaWxlO1xyXG4gICAgICAgIGV2ZW50OiBVcGxvYWRJbnB1dDtcclxuICAgICAgICBmaWxlcz86IFVwbG9hZEZpbGVbXTtcclxuICAgIH0pOiBPYnNlcnZhYmxlPFVwbG9hZE91dHB1dD4ge1xyXG4gICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXIpID0+IHtcclxuICAgICAgICAgICAgbGV0IHN1YjtcclxuICAgICAgICAgICAgbGV0IGlkcyA9IHVwbG9hZC5maWxlcy5tYXAoKGZpbGVJdGVtKSA9PiBmaWxlSXRlbS5pZCk7XHJcbiAgICAgICAgICAgIHN3aXRjaCAodXBsb2FkLmV2ZW50LnR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3NsaWNlVXBsb2FkJzpcclxuICAgICAgICAgICAgICAgICAgICBzdWIgPSB0aGlzLnVwbG9hZCh1cGxvYWQuZmlsZXMsIHVwbG9hZC5ldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwidXBsb2FkXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgc3ViID0gdGhpcy51cGxvYWQodXBsb2FkLmZpbGVzLCB1cGxvYWQuZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcIm11bHRpcGFydFVwbG9hZFwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHN1YiA9IHRoaXMubXVsdGlwYXJ0VXBsb2FkKHVwbG9hZC5maWxlc1swXSwgdXBsb2FkLmV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIC8vIGNhc2UgJ3VwbG9hZEFsbCc6XHJcbiAgICAgICAgICAgICAgICAvLyAgIGlkcyA9IHVwbG9hZC5maWxlcy5tYXAoZmlsZUl0ZW0gPT4gZmlsZUl0ZW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgLy8gICBzdWIgPSB0aGlzLnVwbG9hZEFsbCh1cGxvYWQuZmlsZXMsIHVwbG9hZC5ldmVudCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcInJlbW92ZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgIHN1YiA9IHRoaXMucmVtb3ZlKHVwbG9hZC5maWxlcywgdXBsb2FkLmV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIC8vIGNhc2UgJ3JlbW92ZUFsbCc6XHJcbiAgICAgICAgICAgICAgICAvLyAgIGlkcyA9IHVwbG9hZC5maWxlcy5tYXAoZmlsZUl0ZW0gPT4gZmlsZUl0ZW0uaWQpO1xyXG4gICAgICAgICAgICAgICAgLy8gICBzdWIgPSB0aGlzLnJlbW92ZUFsbCh1cGxvYWQuZmlsZXMsIHVwbG9hZC5ldmVudCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICBzdWIgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghc3ViKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3ViLnBpcGUoZmluYWxpemUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gZGVidWdnZXI7XHJcbiAgICAgICAgICAgICAgICBpZiAoIW9ic2VydmVyLmNsb3NlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAgICAgKG91dHB1dCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBkZWJ1Z2dlcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChvdXRwdXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgKGVycikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGVycik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgdGhpcy5zdWJzLnB1c2goeyBpZHM6IGlkcywgc3ViOiBzdWIsIGlkOiBcIlwiIH0pO1xyXG4gICAgICAgICAgICAvLyBzd2l0Y2ggKHVwbG9hZC5ldmVudC50eXBlKSB7XHJcbiAgICAgICAgICAgIC8vICAgY2FzZSAndXBsb2FkQWxsJzpcclxuICAgICAgICAgICAgLy8gICAgIHRoaXMuc3Vicy5wdXNoKHsgaWRzOiBpZHMsIHN1Yjogc3ViLCBpZDogJycgfSk7XHJcbiAgICAgICAgICAgIC8vICAgICBicmVhaztcclxuICAgICAgICAgICAgLy8gICBjYXNlICdyZW1vdmVBbGwnOlxyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy5zdWJzLnB1c2goeyBpZHM6IGlkcywgc3ViOiBzdWIsIGlkOiAnJyB9KTtcclxuICAgICAgICAgICAgLy8gICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAvLyAgIGRlZmF1bHQ6XHJcblxyXG4gICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIOWNleS4quaWh+S7tuS4iuS8oFxyXG4gICAgICogQHBhcmFtIGZpbGVcclxuICAgICAqIEBwYXJhbSBldmVudFxyXG4gICAgICovXHJcbiAgICAvLyB1cGxvYWRGaWxlKGZpbGU6IFVwbG9hZEZpbGUsIGV2ZW50OiBVcGxvYWRJbnB1dCk6IE9ic2VydmFibGU8VXBsb2FkT3V0cHV0PiB7XHJcbiAgICAvLyAgIGNvbnN0IHVwbG9hZEZpbGUgPSA8QmxvYkZpbGU+ZmlsZS5uYXRpdmVGaWxlO1xyXG4gICAgLy8gICBjb25zdCB1cGxvYWRJbmRleCA9IHRoaXMucXVldWUuZmluZEluZGV4KG91dEZpbGUgPT4gb3V0RmlsZS5uYXRpdmVGaWxlID09PSB1cGxvYWRGaWxlKTtcclxuXHJcbiAgICAvLyAgIC8vIOW3sue7j+iiq+WPlua2iOeahOS4jeiDveiiq+S4iuS8oFxyXG4gICAgLy8gICBpZiAodGhpcy5xdWV1ZVt1cGxvYWRJbmRleF0ucHJvZ3Jlc3Muc3RhdHVzID09PSBVcGxvYWRTdGF0dXMuQ2FuY2VsbGVkKSB7XHJcbiAgICAvLyAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IHtcclxuICAgIC8vICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XHJcbiAgICAvLyAgICAgfSk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vICAgLy8g5oqb5Ye65byA5aeL5LiK5Lyg55qE5LqL5Lu2XHJcbiAgICAvLyAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHsgdHlwZTogJ3N0YXJ0JywgZmlsZXM6IFtmaWxlXSB9KTtcclxuICAgIC8vICAgcmV0dXJuIHRoaXMudXBsb2FkU2VydmVyU2VyLnVwbG9hZChmaWxlLCBldmVudCwgdGhpcy5leHRlbmRTZXJ2ZXJDb25maWcpO1xyXG4gICAgLy8gfVxyXG4gICAgbXVsdGlwYXJ0VXBsb2FkKFxyXG4gICAgICAgIGZpbGU6IFVwbG9hZEZpbGUsXHJcbiAgICAgICAgZXZlbnQ6IFVwbG9hZElucHV0XHJcbiAgICApOiBPYnNlcnZhYmxlPFVwbG9hZE91dHB1dD4ge1xyXG4gICAgICAgIC8vIOaKm+WHuuW8gOWni+S4iuS8oOeahOS6i+S7tlxyXG4gICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHsgdHlwZTogXCJzdGFydFwiLCBmaWxlczogW2ZpbGVdIH0pO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnVwbG9hZFNlcnZlclNlci5tdWx0aXBhcnRVcGxvYWQoXHJcbiAgICAgICAgICAgIGZpbGUsXHJcbiAgICAgICAgICAgIGV2ZW50LFxyXG4gICAgICAgICAgICB0aGlzLmV4dGVuZFNlcnZlckNvbmZpZ1xyXG4gICAgICAgICk7XHJcbiAgICB9XHJcbiAgICB1cGxvYWQoZmlsZXM6IFVwbG9hZEZpbGVbXSwgZXZlbnQ6IFVwbG9hZElucHV0KTogT2JzZXJ2YWJsZTxVcGxvYWRPdXRwdXQ+IHtcclxuICAgICAgICAvLyDmipvlh7rlvIDlp4vkuIrkvKDnmoTkuovku7ZcclxuICAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7IHR5cGU6IFwic3RhcnRcIiwgZmlsZXM6IGZpbGVzIH0pO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnVwbG9hZFNlcnZlclNlci51cGxvYWQoZmlsZXMsIGV2ZW50LCB0aGlzLmV4dGVuZFNlcnZlckNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlKGZpbGVzOiBVcGxvYWRGaWxlW10sIGV2ZW50OiBVcGxvYWRJbnB1dCk6IE9ic2VydmFibGU8VXBsb2FkT3V0cHV0PiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXBsb2FkU2VydmVyU2VyLnJlbW92ZShmaWxlcywgZXZlbnQsIHRoaXMuZXh0ZW5kU2VydmVyQ29uZmlnKTtcclxuICAgIH1cclxuICAgIC8vIHJlbW92ZUFsbChmaWxlczogVXBsb2FkRmlsZVtdLCBldmVudDogVXBsb2FkSW5wdXQpOiBPYnNlcnZhYmxlPFVwbG9hZE91dHB1dD4ge1xyXG4gICAgLy8gICByZXR1cm4gdGhpcy51cGxvYWRTZXJ2ZXJTZXIucmVtb3ZlQWxsKGZpbGVzLCBldmVudCwgdGhpcy5leHRlbmRTZXJ2ZXJDb25maWcpO1xyXG4gICAgLy8gfVxyXG4gICAgLy8g6YeN572uXHJcbiAgICByZXNldCgpIHtcclxuICAgICAgICB0aGlzLnF1ZXVlID0gW107XHJcbiAgICAgICAgLy90aGlzLnVwbG9hZFNjaGVkdWxlciA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICAgICAgLy8gdGhpcy5zdWJzLmZvckVhY2goc3ViID0+IHtcclxuICAgICAgICAvLyAgIGlmIChzdWIuc3ViKSB7XHJcbiAgICAgICAgLy8gICAgIHN1Yi5zdWIudW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAvLyAgIH1cclxuICAgICAgICAvLyB9KTtcclxuICAgICAgICB0aGlzLnN1YnMgPSBbXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmmoLml7ZcclxuICAgIHNldENvbnRlbnRUeXBlcyhjb250ZW50VHlwZXM6IHN0cmluZ1tdKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBjb250ZW50VHlwZXMgIT09IFwidW5kZWZpbmVkXCIgJiYgY29udGVudFR5cGVzIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlcy5maW5kKCh0eXBlOiBzdHJpbmcpID0+IHR5cGUgPT09IFwiKlwiKSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFsbG93ZWRDb250ZW50VHlwZXMgPSBbXCIqXCJdO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hbGxvd2VkQ29udGVudFR5cGVzID0gY29udGVudFR5cGVzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5hbGxvd2VkQ29udGVudFR5cGVzID0gW1wiKlwiXTtcclxuICAgIH1cclxuXHJcbiAgICBhbGxDb250ZW50VHlwZXNBbGxvd2VkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIHRoaXMuYWxsb3dlZENvbnRlbnRUeXBlcy5maW5kKCh0eXBlOiBzdHJpbmcpID0+IHR5cGUgPT09IFwiKlwiKSAhPT1cclxuICAgICAgICAgICAgdW5kZWZpbmVkXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICpcclxuICAgICAqIEBwYXJhbSBuYW1lXHJcbiAgICAgKi9cclxuICAgIGlzQ29udGVudFR5cGVBbGxvd2VkKG5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh0aGlzLmFsbENvbnRlbnRUeXBlc0FsbG93ZWQoKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6ZmE5Lu25rKh5pyJ5ZCO57yAXHJcbiAgICAgICAgaWYgKG5hbWUubGFzdEluZGV4T2YoXCIuXCIpIDwgMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBuYW1lc3VmZml4ID0gbmFtZS5zdWJzdHIobmFtZS5sYXN0SW5kZXhPZihcIi5cIikpO1xyXG4gICAgICAgIC8vIOeugOWMluiuoeeul1xyXG4gICAgICAgIHJldHVybiAoXHJcbiAgICAgICAgICAgIHRoaXMuYWxsb3dlZENvbnRlbnRUeXBlcy5maW5kSW5kZXgoXHJcbiAgICAgICAgICAgICAgICAoaXRlbSkgPT4gaXRlbS50b0xvd2VyQ2FzZSgpID09IG5hbWVzdWZmaXgudG9Mb3dlckNhc2UoKVxyXG4gICAgICAgICAgICApID4gLTFcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGlzRmlsZVNpemVBbGxvd2VkKGZpbGVTaXplOiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAoIXRoaXMubWF4RmlsZVNpemUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIGZpbGVTaXpl5pivYuWNleS9jSBtYXhGaWxlU2l6ZeaYr01C5Y2V5L2NXHJcbiAgICAgICAgcmV0dXJuIGZpbGVTaXplIDw9IHRoaXMubWF4RmlsZVNpemUgKiAxMDI0ICogMTAyNDsgLy8gKiA4XHJcbiAgICB9XHJcbn1cclxuIl19