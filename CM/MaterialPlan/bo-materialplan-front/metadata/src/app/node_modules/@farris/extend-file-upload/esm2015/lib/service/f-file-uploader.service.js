/**
 * @fileoverview added by tsickle
 * Generated from: lib/service/f-file-uploader.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { EventEmitter, Optional } from "@angular/core";
import { Observable, Subject } from "rxjs";
import { mergeMap, finalize } from "rxjs/operators";
import { FFileUtils } from "../utils/index";
import { UploadStatus, UploadServerService, } from "../model/index";
export class FFileUploaderService {
    /**
     * @param {?} uploadServerSer
     */
    constructor(uploadServerSer) {
        this.uploadServerSer = uploadServerSer;
        this.allowedContentTypes = ["*"];
        //默认不限制,0代表不限制 Number.POSITIVE_INFINITY
        this.maxUploads = 0;
        /**
         * 单位M，默认是12M,0代表不限制
         */
        this.maxFileSize = 12;
        this.concurrency = Number.POSITIVE_INFINITY;
        this.uploadedCount = 0;
        this.extendServerConfig = null;
        this.queue = [];
        this.serviceEvents = new EventEmitter();
        this.uploadScheduler = new Subject();
        this.subs = [];
        this.uploadScheduler
            .pipe(mergeMap((/**
         * @param {?} upload
         * @return {?}
         */
        (upload) => {
            return this.serverMethod(upload);
        }), this.concurrency))
            .subscribe((/**
         * @param {?} uploadOutput
         * @return {?}
         */
        (uploadOutput) => {
            // if (uploadOutput.type == 'removed' || uploadOutput.type == 'done') {
            //   // 删除或者done移除
            //   const subIndex = this.subs.findIndex(sub => sub.id === uploadOutput.file.id);
            //   if (subIndex > -1 && this.subs[subIndex].sub) {
            //     this.subs[subIndex].sub.unsubscribe();
            //   }
            //   this.subs.splice(subIndex, 1);
            // }
            if (uploadOutput.type == "removed") {
                // 事件中返回的都是
                this.queue = this.queue.filter((/**
                 * @param {?} item
                 * @return {?}
                 */
                (item) => item.progress.status !== UploadStatus.Remove));
                if (!uploadOutput.hasOwnProperty("message")) {
                    uploadOutput["message"] = "被删除";
                }
            }
            if (uploadOutput.type == "error") {
                // 上传失败的附件移除
                this.queue = this.queue.filter((/**
                 * @param {?} queueItem
                 * @return {?}
                 */
                (queueItem) => {
                    return (uploadOutput.files.findIndex((/**
                     * @param {?} item
                     * @return {?}
                     */
                    (item) => queueItem.id == item.id)) <
                        0);
                }));
            }
            this.serviceEvents.emit(uploadOutput);
        }));
    }
    /**
     * @param {?} options
     * @return {?}
     */
    setOptions(options) {
        // 重置文件大小、类型、个数限制
        if (options) {
            for (let prop in options) {
                this[prop] = options[prop];
            }
        }
    }
    /**
     * @param {?} incomingFiles
     * @return {?}
     */
    handleFiles(incomingFiles) {
        /** @type {?} */
        const allowedIncomingFiles = [].reduce.call(incomingFiles, (/**
         * @param {?} acc
         * @param {?} checkFile
         * @param {?} i
         * @return {?}
         */
        (acc, checkFile, i) => {
            /** @type {?} */
            const futureQueueLength = acc.length + this.queue.length + 1;
            /** @type {?} */
            let judgeResult = this.rejectedReason(checkFile.name, checkFile.type, futureQueueLength, checkFile.size);
            if (judgeResult.allowed) {
                acc = acc.concat(checkFile);
            }
            else {
                // 不符合当前文件类型或者内容超出限制，抛出事件
                /** @type {?} */
                const rejectedFile = FFileUtils.makeUploadFile(checkFile, i);
                this.serviceEvents.emit({
                    type: "rejected",
                    file: rejectedFile,
                    message: judgeResult.message,
                });
            }
            return acc;
        }), []);
        // 构造文件结构，并单个抛出事件
        [].map.call(allowedIncomingFiles, (/**
         * @param {?} file
         * @param {?} i
         * @return {?}
         */
        (file, i) => {
            /** @type {?} */
            const uploadFile = FFileUtils.makeUploadFile(file, i);
            this.queue.push(uploadFile);
            this.serviceEvents.emit({ type: "addedToQueue", file: uploadFile });
        }));
        // 所有的文件都已经添加，抛出事件
        this.serviceEvents.emit({ type: "allAddedToQueue" });
    }
    /**
     * @private
     * @param {?} name
     * @param {?} type
     * @param {?} queuelength
     * @param {?} size
     * @return {?}
     */
    rejectedReason(name, type, queuelength, size) {
        /** @type {?} */
        let allowed = false;
        /** @type {?} */
        let message = "";
        // 已存在同名文件
        /** @type {?} */
        let findDuplicateIndex = this.queue.findIndex((/**
         * @param {?} file
         * @return {?}
         */
        (file) => file.name == name));
        if (findDuplicateIndex > -1) {
            message = "上传失败：已存在同名文件";
        }
        else if (!this.isContentTypeAllowed(name)) {
            message =
                "上传失败：只允许上传" +
                    this.allowedContentTypes.join(",") +
                    "类型的文档";
        }
        else if (this.maxUploads > 0 &&
            (this.maxUploads <= this.uploadedCount ||
                queuelength + this.uploadedCount > this.maxUploads)) {
            message = "上传失败：文件总个数超出" + this.maxUploads + "限制";
        }
        else if (!this.isFileSizeAllowed(size)) {
            message = "上传失败：单个文件大小超出" + this.maxFileSize + "MB的限制";
        }
        else if (size == 0) {
            message = "上传失败：不允许文件为空";
        }
        else {
            allowed = true;
        }
        return {
            allowed,
            message,
        };
    }
    /**
     * 从前端传来事件，进行服务器端方法类型判断
     * @param {?} input
     * @return {?}
     */
    initInputEvents(input) {
        //debugger
        return input.subscribe((/**
         * @param {?} event
         * @return {?}
         */
        (event) => {
            //debugger
            switch (event.type) {
                case 'sliceUpload':
                    /** @type {?} */
                    const _files = this.queue.filter((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.progress.status === UploadStatus.Queue && (!event.file || file.fileIndex === event.file.fileIndex)));
                    if (_files.length > 0) {
                        this.uploadScheduler.next({
                            files: _files,
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "upload":
                case "multipartUpload":
                    /** @type {?} */
                    const uploadFileIndex = this.queue.findIndex((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file === event.file));
                    if (uploadFileIndex !== -1 && event.file) {
                        this.uploadScheduler.next({
                            files: [this.queue[uploadFileIndex]],
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "uploadAll":
                    /** @type {?} */
                    const files = this.queue.filter((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.progress.status === UploadStatus.Queue));
                    if (files.length > 0) {
                        event.type = "upload";
                        this.uploadScheduler.next({
                            files: files,
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "cancel":
                    /** @type {?} */
                    const id = event.id || null;
                    if (!id) {
                        return;
                    }
                    /** @type {?} */
                    const fileIndex = this.queue.findIndex((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.id === id));
                    if (fileIndex !== -1) {
                        this.serviceEvents.emit({
                            type: "cancelled",
                            files: [this.queue[fileIndex]],
                            message: "已取消附件上传",
                        });
                        this.queue.splice(fileIndex, 1);
                    }
                    break;
                    // case 'cancel':
                    // debugger
                    // const id = event.id || null;
                    // if (!id) {
                    //   return;
                    // }
                    // const subs = this.subs.filter(sub => sub.id === id);
                    // subs.forEach(sub => {
                    //   if (sub.sub) {
                    //     sub.sub.unsubscribe();
                    //     const fileIndex = this.queue.findIndex(file => file.id === id);
                    //     if (fileIndex !== -1) {
                    //       this.queue[fileIndex].progress.status = UploadStatus.Cancelled;
                    //       this.serviceEvents.emit({ type: 'cancelled', file: this.queue[fileIndex] });
                    //     }
                    //   }
                    // });
                    break;
                // case 'cancelAll':
                //   this.subs.forEach(sub => {
                //     if (sub.sub) {
                //       sub.sub.unsubscribe();
                //     }
                //     const file = this.queue.find(uploadFile => uploadFile.id === sub.id);
                //     if (file) {
                //       file.progress.status = UploadStatus.Cancelled;
                //       this.serviceEvents.emit({ type: 'cancelled', file: file });
                //     }
                //   });
                //   break;
                case "hide":
                    if (!event.id) {
                        return;
                    }
                    /** @type {?} */
                    let ids = event.id.split(",");
                    this.queue = this.queue.filter((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => {
                        /** @type {?} */
                        let tIndex = ids.findIndex((/**
                         * @param {?} tId
                         * @return {?}
                         */
                        (tId) => tId == file.id));
                        return tIndex > -1 ? false : true;
                    }));
                    break;
                case "cancelAll":
                    // 取消，直接从队列中移除，不用修改状态
                    /** @type {?} */
                    const queueFiles = this.queue.filter((/**
                     * @param {?} uploadFile
                     * @return {?}
                     */
                    (uploadFile) => uploadFile.progress.status === UploadStatus.Queue));
                    if (queueFiles.length) {
                        this.serviceEvents.emit({
                            type: "cancelled",
                            files: queueFiles,
                            message: "已取消附件上传",
                        });
                        this.queue = this.queue.filter((/**
                         * @param {?} uploadFile
                         * @return {?}
                         */
                        (uploadFile) => uploadFile.progress.status != UploadStatus.Queue));
                    }
                    break;
                case "remove":
                    if (!event.id) {
                        return;
                    }
                    /** @type {?} */
                    const removeIndex = this.queue.findIndex((/**
                     * @param {?} file
                     * @return {?}
                     */
                    (file) => file.id === event.id));
                    if (removeIndex !== -1) {
                        // 得有个开始删除和已经删除
                        this.queue[removeIndex].progress.status = UploadStatus.Remove;
                        this.uploadScheduler.next({
                            files: [this.queue[removeIndex]],
                            event: event,
                            file: null,
                        });
                    }
                    break;
                case "removeAll":
                    /** @type {?} */
                    const removeQueueFiles = this.queue.filter((/**
                     * @param {?} uploadFile
                     * @return {?}
                     */
                    (uploadFile) => uploadFile.progress.status === UploadStatus.Queue));
                    if (removeQueueFiles.length) {
                        this.serviceEvents.emit({
                            type: "cancelled",
                            files: removeQueueFiles,
                            message: "删除附件成功",
                        });
                        this.queue = this.queue.filter((/**
                         * @param {?} uploadFile
                         * @return {?}
                         */
                        (uploadFile) => uploadFile.progress.status != UploadStatus.Queue));
                    }
                    // 正在上传的附件是如何处理
                    // const doneFiles = this.queue.filter(uploadFile => uploadFile.progress.status === UploadStatus.Done);
                    if (this.queue.length) {
                        event.type = "remove";
                        this.queue.map((/**
                         * @param {?} item
                         * @return {?}
                         */
                        (item) => (item.progress.status = UploadStatus.Remove)));
                        this.uploadScheduler.next({
                            files: this.queue,
                            event: event,
                            file: null,
                        });
                    }
                    break;
            }
        }));
    }
    /**
     * @param {?} extendSer
     * @return {?}
     */
    setExtendServerConfig(extendSer) {
        this.extendServerConfig = extendSer;
    }
    /**
     * @param {?} upload
     * @return {?}
     */
    serverMethod(upload) {
        return new Observable((/**
         * @param {?} observer
         * @return {?}
         */
        (observer) => {
            /** @type {?} */
            let sub;
            /** @type {?} */
            let ids = upload.files.map((/**
             * @param {?} fileItem
             * @return {?}
             */
            (fileItem) => fileItem.id));
            switch (upload.event.type) {
                case 'sliceUpload':
                    sub = this.upload(upload.files, upload.event);
                    break;
                case "upload":
                    sub = this.upload(upload.files, upload.event);
                    break;
                case "multipartUpload":
                    sub = this.multipartUpload(upload.files[0], upload.event);
                    break;
                // case 'uploadAll':
                //   ids = upload.files.map(fileItem => fileItem.id);
                //   sub = this.uploadAll(upload.files, upload.event);
                //   break;
                case "remove":
                    sub = this.remove(upload.files, upload.event);
                    break;
                // case 'removeAll':
                //   ids = upload.files.map(fileItem => fileItem.id);
                //   sub = this.removeAll(upload.files, upload.event);
                //   break;
                default:
                    sub = null;
            }
            if (!sub) {
                return;
            }
            sub.pipe(finalize((/**
             * @return {?}
             */
            () => {
                // debugger;
                if (!observer.closed) {
                    observer.complete();
                }
            }))).subscribe((/**
             * @param {?} output
             * @return {?}
             */
            (output) => {
                // debugger;
                observer.next(output);
            }), (/**
             * @param {?} err
             * @return {?}
             */
            (err) => {
                observer.next(err);
            }), (/**
             * @return {?}
             */
            () => {
                observer.complete();
            }));
            this.subs.push({ ids: ids, sub: sub, id: "" });
            // switch (upload.event.type) {
            //   case 'uploadAll':
            //     this.subs.push({ ids: ids, sub: sub, id: '' });
            //     break;
            //   case 'removeAll':
            //     this.subs.push({ ids: ids, sub: sub, id: '' });
            //     break;
            //   default:
            // }
        }));
    }
    /**
     * 单个文件上传
     * @param {?} file
     * @param {?} event
     * @return {?}
     */
    // uploadFile(file: UploadFile, event: UploadInput): Observable<UploadOutput> {
    //   const uploadFile = <BlobFile>file.nativeFile;
    //   const uploadIndex = this.queue.findIndex(outFile => outFile.nativeFile === uploadFile);
    //   // 已经被取消的不能被上传
    //   if (this.queue[uploadIndex].progress.status === UploadStatus.Cancelled) {
    //     return new Observable(observer => {
    //       observer.complete();
    //     });
    //   }
    //   // 抛出开始上传的事件
    //   this.serviceEvents.emit({ type: 'start', files: [file] });
    //   return this.uploadServerSer.upload(file, event, this.extendServerConfig);
    // }
    multipartUpload(file, event) {
        // 抛出开始上传的事件
        this.serviceEvents.emit({ type: "start", files: [file] });
        return this.uploadServerSer.multipartUpload(file, event, this.extendServerConfig);
    }
    /**
     * @param {?} files
     * @param {?} event
     * @return {?}
     */
    upload(files, event) {
        // 抛出开始上传的事件
        this.serviceEvents.emit({ type: "start", files: files });
        return this.uploadServerSer.upload(files, event, this.extendServerConfig);
    }
    /**
     * @param {?} files
     * @param {?} event
     * @return {?}
     */
    remove(files, event) {
        return this.uploadServerSer.remove(files, event, this.extendServerConfig);
    }
    // removeAll(files: UploadFile[], event: UploadInput): Observable<UploadOutput> {
    //   return this.uploadServerSer.removeAll(files, event, this.extendServerConfig);
    // }
    // 重置
    /**
     * @return {?}
     */
    reset() {
        this.queue = [];
        //this.uploadScheduler = new Subject();
        // this.subs.forEach(sub => {
        //   if (sub.sub) {
        //     sub.sub.unsubscribe();
        //   }
        // });
        this.subs = [];
    }
    // 暂时
    /**
     * @param {?} contentTypes
     * @return {?}
     */
    setContentTypes(contentTypes) {
        if (typeof contentTypes !== "undefined" && contentTypes instanceof Array) {
            if (contentTypes.find((/**
             * @param {?} type
             * @return {?}
             */
            (type) => type === "*")) !== undefined) {
                this.allowedContentTypes = ["*"];
            }
            else {
                this.allowedContentTypes = contentTypes;
            }
            return;
        }
        this.allowedContentTypes = ["*"];
    }
    /**
     * @return {?}
     */
    allContentTypesAllowed() {
        return (this.allowedContentTypes.find((/**
         * @param {?} type
         * @return {?}
         */
        (type) => type === "*")) !==
            undefined);
    }
    /**
     *
     * @param {?} name
     * @return {?}
     */
    isContentTypeAllowed(name) {
        if (this.allContentTypesAllowed()) {
            return true;
        }
        // 附件没有后缀
        if (name.lastIndexOf(".") < 0) {
            return false;
        }
        /** @type {?} */
        let namesuffix = name.substr(name.lastIndexOf("."));
        // 简化计算
        return (this.allowedContentTypes.findIndex((/**
         * @param {?} item
         * @return {?}
         */
        (item) => item.toLowerCase() == namesuffix.toLowerCase())) > -1);
    }
    /**
     * @param {?} fileSize
     * @return {?}
     */
    isFileSizeAllowed(fileSize) {
        if (!this.maxFileSize) {
            return true;
        }
        // fileSize是b单位 maxFileSize是MB单位
        return fileSize <= this.maxFileSize * 1024 * 1024; // * 8
    }
}
/** @nocollapse */
FFileUploaderService.ctorParameters = () => [
    { type: UploadServerService, decorators: [{ type: Optional }] }
];
if (false) {
    /** @type {?} */
    FFileUploaderService.prototype.queue;
    /** @type {?} */
    FFileUploaderService.prototype.serviceEvents;
    /** @type {?} */
    FFileUploaderService.prototype.uploadScheduler;
    /** @type {?} */
    FFileUploaderService.prototype.subs;
    /** @type {?} */
    FFileUploaderService.prototype.allowedContentTypes;
    /** @type {?} */
    FFileUploaderService.prototype.maxUploads;
    /**
     * 单位M，默认是12M,0代表不限制
     * @type {?}
     */
    FFileUploaderService.prototype.maxFileSize;
    /** @type {?} */
    FFileUploaderService.prototype.concurrency;
    /** @type {?} */
    FFileUploaderService.prototype.uploadedCount;
    /**
     * @type {?}
     * @private
     */
    FFileUploaderService.prototype.extendServerConfig;
    /**
     * @type {?}
     * @private
     */
    FFileUploaderService.prototype.uploadServerSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZi1maWxlLXVwbG9hZGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2V4dGVuZC1maWxlLXVwbG9hZC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlL2YtZmlsZS11cGxvYWRlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQW9CLE1BQU0sTUFBTSxDQUFDO0FBQzdELE9BQU8sRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFJSCxZQUFZLEVBRVosbUJBQW1CLEdBRXRCLE1BQU0sZ0JBQWdCLENBQUM7QUFHeEIsTUFBTSxPQUFPLG9CQUFvQjs7OztJQWlCN0IsWUFBZ0MsZUFBb0M7UUFBcEMsb0JBQWUsR0FBZixlQUFlLENBQXFCO1FBUnBFLHdCQUFtQixHQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7O1FBRXRDLGVBQVUsR0FBVyxDQUFDLENBQUM7Ozs7UUFFdkIsZ0JBQVcsR0FBVyxFQUFFLENBQUM7UUFDekIsZ0JBQVcsR0FBVyxNQUFNLENBQUMsaUJBQWlCLENBQUM7UUFDL0Msa0JBQWEsR0FBVyxDQUFDLENBQUM7UUFDbEIsdUJBQWtCLEdBQUcsSUFBSSxDQUFDO1FBRTlCLElBQUksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxZQUFZLEVBQWdCLENBQUM7UUFDdEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRWYsSUFBSSxDQUFDLGVBQWU7YUFDZixJQUFJLENBQ0QsUUFBUTs7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Q2Y7UUFDRCxnQ0FBZ0M7UUFDaEMsT0FBTyxRQUFRLElBQUksSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsTUFBTTtJQUM3RCxDQUFDOzs7O1lBamVELG1CQUFtQix1QkFzQk4sUUFBUTs7OztJQWhCckIscUNBQW9COztJQUNwQiw2Q0FBMEM7O0lBQzFDLCtDQUlHOztJQUNILG9DQUEwRDs7SUFDMUQsbURBQXNDOztJQUV0QywwQ0FBdUI7Ozs7O0lBRXZCLDJDQUF5Qjs7SUFDekIsMkNBQStDOztJQUMvQyw2Q0FBMEI7Ozs7O0lBQzFCLGtEQUFrQzs7Ozs7SUFDdEIsK0NBQXdEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBPcHRpb25hbCB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBtZXJnZU1hcCwgZmluYWxpemUgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcclxuaW1wb3J0IHsgRkZpbGVVdGlscyB9IGZyb20gXCIuLi91dGlscy9pbmRleFwiO1xyXG5pbXBvcnQge1xyXG4gICAgVXBsb2FkRmlsZSxcclxuICAgIFVwbG9hZE91dHB1dCxcclxuICAgIFVwbG9hZElucHV0LFxyXG4gICAgVXBsb2FkU3RhdHVzLFxyXG4gICAgQmxvYkZpbGUsXHJcbiAgICBVcGxvYWRTZXJ2ZXJTZXJ2aWNlLFxyXG4gICAgVXBsb2FkZXJPcHRpb25zLFxyXG59IGZyb20gXCIuLi9tb2RlbC9pbmRleFwiO1xyXG5pbXBvcnQgKiBhcyBlIGZyb20gXCJleHByZXNzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgRkZpbGVVcGxvYWRlclNlcnZpY2Uge1xyXG4gICAgcXVldWU6IFVwbG9hZEZpbGVbXTtcclxuICAgIHNlcnZpY2VFdmVudHM6IEV2ZW50RW1pdHRlcjxVcGxvYWRPdXRwdXQ+O1xyXG4gICAgdXBsb2FkU2NoZWR1bGVyOiBTdWJqZWN0PHtcclxuICAgICAgICBmaWxlOiBVcGxvYWRGaWxlO1xyXG4gICAgICAgIGV2ZW50OiBVcGxvYWRJbnB1dDtcclxuICAgICAgICBmaWxlcz86IFVwbG9hZEZpbGVbXTtcclxuICAgIH0+O1xyXG4gICAgc3ViczogeyBpZDogc3RyaW5nOyBzdWI6IFN1YnNjcmlwdGlvbjsgaWRzPzogc3RyaW5nW10gfVtdO1xyXG4gICAgYWxsb3dlZENvbnRlbnRUeXBlczogc3RyaW5nW10gPSBbXCIqXCJdO1xyXG4gICAgLy/pu5jorqTkuI3pmZDliLYsMOS7o+ihqOS4jemZkOWItiBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFlcclxuICAgIG1heFVwbG9hZHM6IG51bWJlciA9IDA7XHJcbiAgICAvKiog5Y2V5L2NTe+8jOm7mOiupOaYrzEyTSww5Luj6KGo5LiN6ZmQ5Yi2ICovXHJcbiAgICBtYXhGaWxlU2l6ZTogbnVtYmVyID0gMTI7XHJcbiAgICBjb25jdXJyZW5jeTogbnVtYmVyID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZO1xyXG4gICAgdXBsb2FkZWRDb3VudDogbnVtYmVyID0gMDtcclxuICAgIHByaXZhdGUgZXh0ZW5kU2VydmVyQ29uZmlnID0gbnVsbDtcclxuICAgIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIHByaXZhdGUgdXBsb2FkU2VydmVyU2VyOiBVcGxvYWRTZXJ2ZXJTZXJ2aWNlKSB7XHJcbiAgICAgICAgdGhpcy5xdWV1ZSA9IFtdO1xyXG4gICAgICAgIHRoaXMuc2VydmljZUV2ZW50cyA9IG5ldyBFdmVudEVtaXR0ZXI8VXBsb2FkT3V0cHV0PigpO1xyXG4gICAgICAgIHRoaXMudXBsb2FkU2NoZWR1bGVyID0gbmV3IFN1YmplY3QoKTtcclxuICAgICAgICB0aGlzLnN1YnMgPSBbXTtcclxuXHJcbiAgICAgICAgdGhpcy51cGxvYWRTY2hlZHVsZXJcclxuICAgICAgICAgICAgLnBpcGUoXHJcbiAgICAgICAgICAgICAgICBtZXJnZU1hcCgodXBsb2FkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VydmVyTWV0aG9kKHVwbG9hZCk7XHJcbiAgICAgICAgICAgICAgICB9LCB0aGlzLmNvbmN1cnJlbmN5KVxyXG4gICAgICAgICAgICApXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKHVwbG9hZE91dHB1dCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gaWYgKHVwbG9hZE91dHB1dC50eXBlID09ICdyZW1vdmVkJyB8fCB1cGxvYWRPdXRwdXQudHlwZSA9PSAnZG9uZScpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgLy8g5Yig6Zmk5oiW6ICFZG9uZeenu+mZpFxyXG4gICAgICAgICAgICAgICAgLy8gICBjb25zdCBzdWJJbmRleCA9IHRoaXMuc3Vicy5maW5kSW5kZXgoc3ViID0+IHN1Yi5pZCA9PT0gdXBsb2FkT3V0cHV0LmZpbGUuaWQpO1xyXG4gICAgICAgICAgICAgICAgLy8gICBpZiAoc3ViSW5kZXggPiAtMSAmJiB0aGlzLnN1YnNbc3ViSW5kZXhdLnN1Yikge1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIHRoaXMuc3Vic1tzdWJJbmRleF0uc3ViLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgIH1cclxuICAgICAgICAgICAgICAgIC8vICAgdGhpcy5zdWJzLnNwbGljZShzdWJJbmRleCwgMSk7XHJcbiAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICBpZiAodXBsb2FkT3V0cHV0LnR5cGUgPT0gXCJyZW1vdmVkXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDkuovku7bkuK3ov5Tlm57nmoTpg73mmK9cclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIChpdGVtKSA9PiBpdGVtLnByb2dyZXNzLnN0YXR1cyAhPT0gVXBsb2FkU3RhdHVzLlJlbW92ZVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF1cGxvYWRPdXRwdXQuaGFzT3duUHJvcGVydHkoXCJtZXNzYWdlXCIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZE91dHB1dFtcIm1lc3NhZ2VcIl0gPSBcIuiiq+WIoOmZpFwiO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmICh1cGxvYWRPdXRwdXQudHlwZSA9PSBcImVycm9yXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyDkuIrkvKDlpLHotKXnmoTpmYTku7bnp7vpmaRcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoKHF1ZXVlSXRlbSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBsb2FkT3V0cHV0LmZpbGVzLmZpbmRJbmRleCgoaXRlbSkgPT4gcXVldWVJdGVtLmlkID09IGl0ZW0uaWQpIDxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDBcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHVwbG9hZE91dHB1dCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgc2V0T3B0aW9ucyhvcHRpb25zOiBVcGxvYWRlck9wdGlvbnMpIHtcclxuICAgICAgICAvLyDph43nva7mlofku7blpKflsI/jgIHnsbvlnovjgIHkuKrmlbDpmZDliLZcclxuICAgICAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBwcm9wIGluIG9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgIHRoaXNbcHJvcF0gPSBvcHRpb25zW3Byb3BdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgaGFuZGxlRmlsZXMoaW5jb21pbmdGaWxlczogRmlsZUxpc3QpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBhbGxvd2VkSW5jb21pbmdGaWxlczogRmlsZVtdID0gW10ucmVkdWNlLmNhbGwoXHJcbiAgICAgICAgICAgIGluY29taW5nRmlsZXMsXHJcbiAgICAgICAgICAgIChhY2M6IEZpbGVbXSwgY2hlY2tGaWxlOiBGaWxlLCBpOiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGZ1dHVyZVF1ZXVlTGVuZ3RoID0gYWNjLmxlbmd0aCArIHRoaXMucXVldWUubGVuZ3RoICsgMTtcclxuICAgICAgICAgICAgICAgIGxldCBqdWRnZVJlc3VsdCA9IHRoaXMucmVqZWN0ZWRSZWFzb24oXHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLm5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLnR5cGUsXHJcbiAgICAgICAgICAgICAgICAgICAgZnV0dXJlUXVldWVMZW5ndGgsXHJcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLnNpemVcclxuICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICBpZiAoanVkZ2VSZXN1bHQuYWxsb3dlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGFjYyA9IGFjYy5jb25jYXQoY2hlY2tGaWxlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5LiN56ym5ZCI5b2T5YmN5paH5Lu257G75Z6L5oiW6ICF5YaF5a656LaF5Ye66ZmQ5Yi277yM5oqb5Ye65LqL5Lu2XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVqZWN0ZWRGaWxlOiBVcGxvYWRGaWxlID0gRkZpbGVVdGlscy5tYWtlVXBsb2FkRmlsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tGaWxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwicmVqZWN0ZWRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmlsZTogcmVqZWN0ZWRGaWxlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBqdWRnZVJlc3VsdC5tZXNzYWdlLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjYztcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgW11cclxuICAgICAgICApO1xyXG5cclxuICAgICAgICAvLyDmnoTpgKDmlofku7bnu5PmnoTvvIzlubbljZXkuKrmipvlh7rkuovku7ZcclxuICAgICAgICBbXS5tYXAuY2FsbChhbGxvd2VkSW5jb21pbmdGaWxlcywgKGZpbGU6IEZpbGUsIGk6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB1cGxvYWRGaWxlOiBVcGxvYWRGaWxlID0gRkZpbGVVdGlscy5tYWtlVXBsb2FkRmlsZShmaWxlLCBpKTtcclxuICAgICAgICAgICAgdGhpcy5xdWV1ZS5wdXNoKHVwbG9hZEZpbGUpO1xyXG4gICAgICAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7IHR5cGU6IFwiYWRkZWRUb1F1ZXVlXCIsIGZpbGU6IHVwbG9hZEZpbGUgfSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIOaJgOacieeahOaWh+S7tumDveW3sue7j+a3u+WKoO+8jOaKm+WHuuS6i+S7tlxyXG4gICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHsgdHlwZTogXCJhbGxBZGRlZFRvUXVldWVcIiB9KTtcclxuICAgIH1cclxuICAgIHByaXZhdGUgcmVqZWN0ZWRSZWFzb24obmFtZSwgdHlwZSwgcXVldWVsZW5ndGgsIHNpemUpIHtcclxuICAgICAgICBsZXQgYWxsb3dlZCA9IGZhbHNlO1xyXG4gICAgICAgIGxldCBtZXNzYWdlID0gXCJcIjtcclxuICAgICAgICAvLyDlt7LlrZjlnKjlkIzlkI3mlofku7ZcclxuICAgICAgICBsZXQgZmluZER1cGxpY2F0ZUluZGV4ID0gdGhpcy5xdWV1ZS5maW5kSW5kZXgoKGZpbGUpID0+IGZpbGUubmFtZSA9PSBuYW1lKTtcclxuICAgICAgICBpZiAoZmluZER1cGxpY2F0ZUluZGV4ID4gLTEpIHtcclxuICAgICAgICAgICAgbWVzc2FnZSA9IFwi5LiK5Lyg5aSx6LSl77ya5bey5a2Y5Zyo5ZCM5ZCN5paH5Lu2XCI7XHJcbiAgICAgICAgfSBlbHNlIGlmICghdGhpcy5pc0NvbnRlbnRUeXBlQWxsb3dlZChuYW1lKSkge1xyXG4gICAgICAgICAgICBtZXNzYWdlID1cclxuICAgICAgICAgICAgICAgIFwi5LiK5Lyg5aSx6LSl77ya5Y+q5YWB6K645LiK5LygXCIgK1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hbGxvd2VkQ29udGVudFR5cGVzLmpvaW4oXCIsXCIpICtcclxuICAgICAgICAgICAgICAgIFwi57G75Z6L55qE5paH5qGjXCI7XHJcbiAgICAgICAgfSBlbHNlIGlmIChcclxuICAgICAgICAgICAgdGhpcy5tYXhVcGxvYWRzID4gMCAmJlxyXG4gICAgICAgICAgICAodGhpcy5tYXhVcGxvYWRzIDw9IHRoaXMudXBsb2FkZWRDb3VudCB8fFxyXG4gICAgICAgICAgICAgICAgcXVldWVsZW5ndGggKyB0aGlzLnVwbG9hZGVkQ291bnQgPiB0aGlzLm1heFVwbG9hZHMpXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBcIuS4iuS8oOWksei0pe+8muaWh+S7tuaAu+S4quaVsOi2heWHulwiICsgdGhpcy5tYXhVcGxvYWRzICsgXCLpmZDliLZcIjtcclxuICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLmlzRmlsZVNpemVBbGxvd2VkKHNpemUpKSB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBcIuS4iuS8oOWksei0pe+8muWNleS4quaWh+S7tuWkp+Wwj+i2heWHulwiICsgdGhpcy5tYXhGaWxlU2l6ZSArIFwiTULnmoTpmZDliLZcIjtcclxuICAgICAgICB9IGVsc2UgaWYgKHNpemUgPT0gMCkge1xyXG4gICAgICAgICAgICBtZXNzYWdlID0gXCLkuIrkvKDlpLHotKXvvJrkuI3lhYHorrjmlofku7bkuLrnqbpcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBhbGxvd2VkID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgYWxsb3dlZCxcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDku47liY3nq6/kvKDmnaXkuovku7bvvIzov5vooYzmnI3liqHlmajnq6/mlrnms5XnsbvlnovliKTmlq1cclxuICAgICAqIEBwYXJhbSBpbnB1dFxyXG4gICAgICovXHJcbiAgICBpbml0SW5wdXRFdmVudHMoaW5wdXQ6IEV2ZW50RW1pdHRlcjxVcGxvYWRJbnB1dD4pOiBTdWJzY3JpcHRpb24ge1xyXG4gICAgICAgIC8vZGVidWdnZXJcclxuICAgICAgICByZXR1cm4gaW5wdXQuc3Vic2NyaWJlKChldmVudDogVXBsb2FkSW5wdXQpID0+IHtcclxuICAgICAgICAgICAgLy9kZWJ1Z2dlclxyXG4gICAgICAgICAgICBzd2l0Y2ggKGV2ZW50LnR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3NsaWNlVXBsb2FkJzpcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBfZmlsZXMgPSB0aGlzLnF1ZXVlLmZpbHRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGUpID0+IGZpbGUucHJvZ3Jlc3Muc3RhdHVzID09PSBVcGxvYWRTdGF0dXMuUXVldWUgJiYgKCFldmVudC5maWxlIHx8IGZpbGUuZmlsZUluZGV4ID09PSBldmVudC5maWxlLmZpbGVJbmRleCApXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKF9maWxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkU2NoZWR1bGVyLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IF9maWxlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiBldmVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGU6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJ1cGxvYWRcIjpcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJtdWx0aXBhcnRVcGxvYWRcIjpcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB1cGxvYWRGaWxlSW5kZXggPSB0aGlzLnF1ZXVlLmZpbmRJbmRleChcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGUpID0+IGZpbGUgPT09IGV2ZW50LmZpbGVcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1cGxvYWRGaWxlSW5kZXggIT09IC0xICYmIGV2ZW50LmZpbGUpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRTY2hlZHVsZXIubmV4dCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlczogW3RoaXMucXVldWVbdXBsb2FkRmlsZUluZGV4XV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogZXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwidXBsb2FkQWxsXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLnF1ZXVlLmZpbHRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgKGZpbGUpID0+IGZpbGUucHJvZ3Jlc3Muc3RhdHVzID09PSBVcGxvYWRTdGF0dXMuUXVldWVcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50LnR5cGUgPSBcInVwbG9hZFwiO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZFNjaGVkdWxlci5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzOiBmaWxlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV2ZW50OiBldmVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGU6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJjYW5jZWxcIjpcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpZCA9IGV2ZW50LmlkIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVJbmRleCA9IHRoaXMucXVldWUuZmluZEluZGV4KChmaWxlKSA9PiBmaWxlLmlkID09PSBpZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGVJbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXJ2aWNlRXZlbnRzLmVtaXQoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJjYW5jZWxsZWRcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVzOiBbdGhpcy5xdWV1ZVtmaWxlSW5kZXhdXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwi5bey5Y+W5raI6ZmE5Lu25LiK5LygXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlLnNwbGljZShmaWxlSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICAvLyBjYXNlICdjYW5jZWwnOlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGRlYnVnZ2VyXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc3QgaWQgPSBldmVudC5pZCB8fCBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIGlmICghaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICAvLyB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gY29uc3Qgc3VicyA9IHRoaXMuc3Vicy5maWx0ZXIoc3ViID0+IHN1Yi5pZCA9PT0gaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIHN1YnMuZm9yRWFjaChzdWIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgaWYgKHN1Yi5zdWIpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgc3ViLnN1Yi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICBjb25zdCBmaWxlSW5kZXggPSB0aGlzLnF1ZXVlLmZpbmRJbmRleChmaWxlID0+IGZpbGUuaWQgPT09IGlkKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgaWYgKGZpbGVJbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICB0aGlzLnF1ZXVlW2ZpbGVJbmRleF0ucHJvZ3Jlc3Muc3RhdHVzID0gVXBsb2FkU3RhdHVzLkNhbmNlbGxlZDtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7IHR5cGU6ICdjYW5jZWxsZWQnLCBmaWxlOiB0aGlzLnF1ZXVlW2ZpbGVJbmRleF0gfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyAgIH1cclxuICAgICAgICAgICAgICAgICAgICAvLyB9KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIC8vIGNhc2UgJ2NhbmNlbEFsbCc6XHJcbiAgICAgICAgICAgICAgICAvLyAgIHRoaXMuc3Vicy5mb3JFYWNoKHN1YiA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgaWYgKHN1Yi5zdWIpIHtcclxuICAgICAgICAgICAgICAgIC8vICAgICAgIHN1Yi5zdWIudW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgICAgICAgIC8vICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gICAgIGNvbnN0IGZpbGUgPSB0aGlzLnF1ZXVlLmZpbmQodXBsb2FkRmlsZSA9PiB1cGxvYWRGaWxlLmlkID09PSBzdWIuaWQpO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIGlmIChmaWxlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICBmaWxlLnByb2dyZXNzLnN0YXR1cyA9IFVwbG9hZFN0YXR1cy5DYW5jZWxsZWQ7XHJcbiAgICAgICAgICAgICAgICAvLyAgICAgICB0aGlzLnNlcnZpY2VFdmVudHMuZW1pdCh7IHR5cGU6ICdjYW5jZWxsZWQnLCBmaWxlOiBmaWxlIH0pO1xyXG4gICAgICAgICAgICAgICAgLy8gICAgIH1cclxuICAgICAgICAgICAgICAgIC8vICAgfSk7XHJcbiAgICAgICAgICAgICAgICAvLyAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcImhpZGVcIjpcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWV2ZW50LmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGlkcyA9IGV2ZW50LmlkLnNwbGl0KFwiLFwiKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoKGZpbGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRJbmRleCA9IGlkcy5maW5kSW5kZXgoKHRJZCkgPT4gdElkID09IGZpbGUuaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdEluZGV4ID4gLTEgPyBmYWxzZSA6IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwiY2FuY2VsQWxsXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgLy8g5Y+W5raI77yM55u05o6l5LuO6Zif5YiX5Lit56e76Zmk77yM5LiN55So5L+u5pS554q25oCBXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcXVldWVGaWxlcyA9IHRoaXMucXVldWUuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAodXBsb2FkRmlsZSkgPT4gdXBsb2FkRmlsZS5wcm9ncmVzcy5zdGF0dXMgPT09IFVwbG9hZFN0YXR1cy5RdWV1ZVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHF1ZXVlRmlsZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiY2FuY2VsbGVkXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlczogcXVldWVGaWxlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwi5bey5Y+W5raI6ZmE5Lu25LiK5LygXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodXBsb2FkRmlsZSkgPT4gdXBsb2FkRmlsZS5wcm9ncmVzcy5zdGF0dXMgIT0gVXBsb2FkU3RhdHVzLlF1ZXVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSBcInJlbW92ZVwiOlxyXG4gICAgICAgICAgICAgICAgICAgIGlmICghZXZlbnQuaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdmVJbmRleCA9IHRoaXMucXVldWUuZmluZEluZGV4KFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAoZmlsZSkgPT4gZmlsZS5pZCA9PT0gZXZlbnQuaWRcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZW1vdmVJbmRleCAhPT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g5b6X5pyJ5Liq5byA5aeL5Yig6Zmk5ZKM5bey57uP5Yig6ZmkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucXVldWVbcmVtb3ZlSW5kZXhdLnByb2dyZXNzLnN0YXR1cyA9IFVwbG9hZFN0YXR1cy5SZW1vdmU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkU2NoZWR1bGVyLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IFt0aGlzLnF1ZXVlW3JlbW92ZUluZGV4XV0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogZXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwicmVtb3ZlQWxsXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3ZlUXVldWVGaWxlcyA9IHRoaXMucXVldWUuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAodXBsb2FkRmlsZSkgPT4gdXBsb2FkRmlsZS5wcm9ncmVzcy5zdGF0dXMgPT09IFVwbG9hZFN0YXR1cy5RdWV1ZVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlbW92ZVF1ZXVlRmlsZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwiY2FuY2VsbGVkXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlczogcmVtb3ZlUXVldWVGaWxlcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwi5Yig6Zmk6ZmE5Lu25oiQ5YqfXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnF1ZXVlID0gdGhpcy5xdWV1ZS5maWx0ZXIoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAodXBsb2FkRmlsZSkgPT4gdXBsb2FkRmlsZS5wcm9ncmVzcy5zdGF0dXMgIT0gVXBsb2FkU3RhdHVzLlF1ZXVlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIOato+WcqOS4iuS8oOeahOmZhOS7tuaYr+WmguS9leWkhOeQhlxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGRvbmVGaWxlcyA9IHRoaXMucXVldWUuZmlsdGVyKHVwbG9hZEZpbGUgPT4gdXBsb2FkRmlsZS5wcm9ncmVzcy5zdGF0dXMgPT09IFVwbG9hZFN0YXR1cy5Eb25lKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5xdWV1ZS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZXZlbnQudHlwZSA9IFwicmVtb3ZlXCI7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucXVldWUubWFwKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGl0ZW0pID0+IChpdGVtLnByb2dyZXNzLnN0YXR1cyA9IFVwbG9hZFN0YXR1cy5SZW1vdmUpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkU2NoZWR1bGVyLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZXM6IHRoaXMucXVldWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBldmVudDogZXZlbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRFeHRlbmRTZXJ2ZXJDb25maWcoZXh0ZW5kU2VyKSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmRTZXJ2ZXJDb25maWcgPSBleHRlbmRTZXI7XHJcbiAgICB9XHJcblxyXG4gICAgc2VydmVyTWV0aG9kKHVwbG9hZDoge1xyXG4gICAgICAgIGZpbGU6IFVwbG9hZEZpbGU7XHJcbiAgICAgICAgZXZlbnQ6IFVwbG9hZElucHV0O1xyXG4gICAgICAgIGZpbGVzPzogVXBsb2FkRmlsZVtdO1xyXG4gICAgfSk6IE9ic2VydmFibGU8VXBsb2FkT3V0cHV0PiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcikgPT4ge1xyXG4gICAgICAgICAgICBsZXQgc3ViO1xyXG4gICAgICAgICAgICBsZXQgaWRzID0gdXBsb2FkLmZpbGVzLm1hcCgoZmlsZUl0ZW0pID0+IGZpbGVJdGVtLmlkKTtcclxuICAgICAgICAgICAgc3dpdGNoICh1cGxvYWQuZXZlbnQudHlwZSkge1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnc2xpY2VVcGxvYWQnOlxyXG4gICAgICAgICAgICAgICAgICAgIHN1YiA9IHRoaXMudXBsb2FkKHVwbG9hZC5maWxlcywgdXBsb2FkLmV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgXCJ1cGxvYWRcIjpcclxuICAgICAgICAgICAgICAgICAgICBzdWIgPSB0aGlzLnVwbG9hZCh1cGxvYWQuZmlsZXMsIHVwbG9hZC5ldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwibXVsdGlwYXJ0VXBsb2FkXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgc3ViID0gdGhpcy5tdWx0aXBhcnRVcGxvYWQodXBsb2FkLmZpbGVzWzBdLCB1cGxvYWQuZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgLy8gY2FzZSAndXBsb2FkQWxsJzpcclxuICAgICAgICAgICAgICAgIC8vICAgaWRzID0gdXBsb2FkLmZpbGVzLm1hcChmaWxlSXRlbSA9PiBmaWxlSXRlbS5pZCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgIHN1YiA9IHRoaXMudXBsb2FkQWxsKHVwbG9hZC5maWxlcywgdXBsb2FkLmV2ZW50KTtcclxuICAgICAgICAgICAgICAgIC8vICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlIFwicmVtb3ZlXCI6XHJcbiAgICAgICAgICAgICAgICAgICAgc3ViID0gdGhpcy5yZW1vdmUodXBsb2FkLmZpbGVzLCB1cGxvYWQuZXZlbnQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgLy8gY2FzZSAncmVtb3ZlQWxsJzpcclxuICAgICAgICAgICAgICAgIC8vICAgaWRzID0gdXBsb2FkLmZpbGVzLm1hcChmaWxlSXRlbSA9PiBmaWxlSXRlbS5pZCk7XHJcbiAgICAgICAgICAgICAgICAvLyAgIHN1YiA9IHRoaXMucmVtb3ZlQWxsKHVwbG9hZC5maWxlcywgdXBsb2FkLmV2ZW50KTtcclxuICAgICAgICAgICAgICAgIC8vICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIHN1YiA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKCFzdWIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzdWIucGlwZShmaW5hbGl6ZSgoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAvLyBkZWJ1Z2dlcjtcclxuICAgICAgICAgICAgICAgIGlmICghb2JzZXJ2ZXIuY2xvc2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSkpLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICAgICAob3V0cHV0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGRlYnVnZ2VyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KG91dHB1dCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAoZXJyKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZXJyKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLnN1YnMucHVzaCh7IGlkczogaWRzLCBzdWI6IHN1YiwgaWQ6IFwiXCIgfSk7XHJcbiAgICAgICAgICAgIC8vIHN3aXRjaCAodXBsb2FkLmV2ZW50LnR5cGUpIHtcclxuICAgICAgICAgICAgLy8gICBjYXNlICd1cGxvYWRBbGwnOlxyXG4gICAgICAgICAgICAvLyAgICAgdGhpcy5zdWJzLnB1c2goeyBpZHM6IGlkcywgc3ViOiBzdWIsIGlkOiAnJyB9KTtcclxuICAgICAgICAgICAgLy8gICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAvLyAgIGNhc2UgJ3JlbW92ZUFsbCc6XHJcbiAgICAgICAgICAgIC8vICAgICB0aGlzLnN1YnMucHVzaCh7IGlkczogaWRzLCBzdWI6IHN1YiwgaWQ6ICcnIH0pO1xyXG4gICAgICAgICAgICAvLyAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIC8vICAgZGVmYXVsdDpcclxuXHJcbiAgICAgICAgICAgIC8vIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIC8qKlxyXG4gICAgICog5Y2V5Liq5paH5Lu25LiK5LygXHJcbiAgICAgKiBAcGFyYW0gZmlsZVxyXG4gICAgICogQHBhcmFtIGV2ZW50XHJcbiAgICAgKi9cclxuICAgIC8vIHVwbG9hZEZpbGUoZmlsZTogVXBsb2FkRmlsZSwgZXZlbnQ6IFVwbG9hZElucHV0KTogT2JzZXJ2YWJsZTxVcGxvYWRPdXRwdXQ+IHtcclxuICAgIC8vICAgY29uc3QgdXBsb2FkRmlsZSA9IDxCbG9iRmlsZT5maWxlLm5hdGl2ZUZpbGU7XHJcbiAgICAvLyAgIGNvbnN0IHVwbG9hZEluZGV4ID0gdGhpcy5xdWV1ZS5maW5kSW5kZXgob3V0RmlsZSA9PiBvdXRGaWxlLm5hdGl2ZUZpbGUgPT09IHVwbG9hZEZpbGUpO1xyXG5cclxuICAgIC8vICAgLy8g5bey57uP6KKr5Y+W5raI55qE5LiN6IO96KKr5LiK5LygXHJcbiAgICAvLyAgIGlmICh0aGlzLnF1ZXVlW3VwbG9hZEluZGV4XS5wcm9ncmVzcy5zdGF0dXMgPT09IFVwbG9hZFN0YXR1cy5DYW5jZWxsZWQpIHtcclxuICAgIC8vICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT4ge1xyXG4gICAgLy8gICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcclxuICAgIC8vICAgICB9KTtcclxuICAgIC8vICAgfVxyXG4gICAgLy8gICAvLyDmipvlh7rlvIDlp4vkuIrkvKDnmoTkuovku7ZcclxuICAgIC8vICAgdGhpcy5zZXJ2aWNlRXZlbnRzLmVtaXQoeyB0eXBlOiAnc3RhcnQnLCBmaWxlczogW2ZpbGVdIH0pO1xyXG4gICAgLy8gICByZXR1cm4gdGhpcy51cGxvYWRTZXJ2ZXJTZXIudXBsb2FkKGZpbGUsIGV2ZW50LCB0aGlzLmV4dGVuZFNlcnZlckNvbmZpZyk7XHJcbiAgICAvLyB9XHJcbiAgICBtdWx0aXBhcnRVcGxvYWQoXHJcbiAgICAgICAgZmlsZTogVXBsb2FkRmlsZSxcclxuICAgICAgICBldmVudDogVXBsb2FkSW5wdXRcclxuICAgICk6IE9ic2VydmFibGU8VXBsb2FkT3V0cHV0PiB7XHJcbiAgICAgICAgLy8g5oqb5Ye65byA5aeL5LiK5Lyg55qE5LqL5Lu2XHJcbiAgICAgICAgdGhpcy5zZXJ2aWNlRXZlbnRzLmVtaXQoeyB0eXBlOiBcInN0YXJ0XCIsIGZpbGVzOiBbZmlsZV0gfSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXBsb2FkU2VydmVyU2VyLm11bHRpcGFydFVwbG9hZChcclxuICAgICAgICAgICAgZmlsZSxcclxuICAgICAgICAgICAgZXZlbnQsXHJcbiAgICAgICAgICAgIHRoaXMuZXh0ZW5kU2VydmVyQ29uZmlnXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuICAgIHVwbG9hZChmaWxlczogVXBsb2FkRmlsZVtdLCBldmVudDogVXBsb2FkSW5wdXQpOiBPYnNlcnZhYmxlPFVwbG9hZE91dHB1dD4ge1xyXG4gICAgICAgIC8vIOaKm+WHuuW8gOWni+S4iuS8oOeahOS6i+S7tlxyXG4gICAgICAgIHRoaXMuc2VydmljZUV2ZW50cy5lbWl0KHsgdHlwZTogXCJzdGFydFwiLCBmaWxlczogZmlsZXMgfSk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudXBsb2FkU2VydmVyU2VyLnVwbG9hZChmaWxlcywgZXZlbnQsIHRoaXMuZXh0ZW5kU2VydmVyQ29uZmlnKTtcclxuICAgIH1cclxuXHJcbiAgICByZW1vdmUoZmlsZXM6IFVwbG9hZEZpbGVbXSwgZXZlbnQ6IFVwbG9hZElucHV0KTogT2JzZXJ2YWJsZTxVcGxvYWRPdXRwdXQ+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy51cGxvYWRTZXJ2ZXJTZXIucmVtb3ZlKGZpbGVzLCBldmVudCwgdGhpcy5leHRlbmRTZXJ2ZXJDb25maWcpO1xyXG4gICAgfVxyXG4gICAgLy8gcmVtb3ZlQWxsKGZpbGVzOiBVcGxvYWRGaWxlW10sIGV2ZW50OiBVcGxvYWRJbnB1dCk6IE9ic2VydmFibGU8VXBsb2FkT3V0cHV0PiB7XHJcbiAgICAvLyAgIHJldHVybiB0aGlzLnVwbG9hZFNlcnZlclNlci5yZW1vdmVBbGwoZmlsZXMsIGV2ZW50LCB0aGlzLmV4dGVuZFNlcnZlckNvbmZpZyk7XHJcbiAgICAvLyB9XHJcbiAgICAvLyDph43nva5cclxuICAgIHJlc2V0KCkge1xyXG4gICAgICAgIHRoaXMucXVldWUgPSBbXTtcclxuICAgICAgICAvL3RoaXMudXBsb2FkU2NoZWR1bGVyID0gbmV3IFN1YmplY3QoKTtcclxuICAgICAgICAvLyB0aGlzLnN1YnMuZm9yRWFjaChzdWIgPT4ge1xyXG4gICAgICAgIC8vICAgaWYgKHN1Yi5zdWIpIHtcclxuICAgICAgICAvLyAgICAgc3ViLnN1Yi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgIC8vICAgfVxyXG4gICAgICAgIC8vIH0pO1xyXG4gICAgICAgIHRoaXMuc3VicyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOaaguaXtlxyXG4gICAgc2V0Q29udGVudFR5cGVzKGNvbnRlbnRUeXBlczogc3RyaW5nW10pOiB2b2lkIHtcclxuICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnRUeXBlcyAhPT0gXCJ1bmRlZmluZWRcIiAmJiBjb250ZW50VHlwZXMgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgICAgICBpZiAoY29udGVudFR5cGVzLmZpbmQoKHR5cGU6IHN0cmluZykgPT4gdHlwZSA9PT0gXCIqXCIpICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuYWxsb3dlZENvbnRlbnRUeXBlcyA9IFtcIipcIl07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmFsbG93ZWRDb250ZW50VHlwZXMgPSBjb250ZW50VHlwZXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmFsbG93ZWRDb250ZW50VHlwZXMgPSBbXCIqXCJdO1xyXG4gICAgfVxyXG5cclxuICAgIGFsbENvbnRlbnRUeXBlc0FsbG93ZWQoKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgdGhpcy5hbGxvd2VkQ29udGVudFR5cGVzLmZpbmQoKHR5cGU6IHN0cmluZykgPT4gdHlwZSA9PT0gXCIqXCIpICE9PVxyXG4gICAgICAgICAgICB1bmRlZmluZWRcclxuICAgICAgICApO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKlxyXG4gICAgICogQHBhcmFtIG5hbWVcclxuICAgICAqL1xyXG4gICAgaXNDb250ZW50VHlwZUFsbG93ZWQobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKHRoaXMuYWxsQ29udGVudFR5cGVzQWxsb3dlZCgpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDpmYTku7bmsqHmnInlkI7nvIBcclxuICAgICAgICBpZiAobmFtZS5sYXN0SW5kZXhPZihcIi5cIikgPCAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IG5hbWVzdWZmaXggPSBuYW1lLnN1YnN0cihuYW1lLmxhc3RJbmRleE9mKFwiLlwiKSk7XHJcbiAgICAgICAgLy8g566A5YyW6K6h566XXHJcbiAgICAgICAgcmV0dXJuIChcclxuICAgICAgICAgICAgdGhpcy5hbGxvd2VkQ29udGVudFR5cGVzLmZpbmRJbmRleChcclxuICAgICAgICAgICAgICAgIChpdGVtKSA9PiBpdGVtLnRvTG93ZXJDYXNlKCkgPT0gbmFtZXN1ZmZpeC50b0xvd2VyQ2FzZSgpXHJcbiAgICAgICAgICAgICkgPiAtMVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgaXNGaWxlU2l6ZUFsbG93ZWQoZmlsZVNpemU6IG51bWJlcik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICghdGhpcy5tYXhGaWxlU2l6ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8gZmlsZVNpemXmmK9i5Y2V5L2NIG1heEZpbGVTaXpl5pivTULljZXkvY1cclxuICAgICAgICByZXR1cm4gZmlsZVNpemUgPD0gdGhpcy5tYXhGaWxlU2l6ZSAqIDEwMjQgKiAxMDI0OyAvLyAqIDhcclxuICAgIH1cclxufVxyXG4iXX0=