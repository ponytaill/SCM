import { Directive, HostListener, EventEmitter, Output } from '@angular/core';
import { Subject } from 'rxjs';
import { BindingData, ChangeType, ViewModel, DataTypeInfo, EntityPathConverter, RunMode } from '@farris/devkit';
import { DatagridComponent } from '@farris/ui-datagrid';
import { debounceTime, finalize } from 'rxjs/operators';
// tslint:disable: max-line-length
/*
 * 使用绑定数据指令
 */
var FarrisDatagridUseBindingDataDirective = /** @class */ (function () {
    function FarrisDatagridUseBindingDataDirective(bindingData, viewModel, grid) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.grid = grid;
        // 排序字段
        this.sortFields = null;
        // 排序方向
        this.sortDirections = null;
        this.parentId = null;
        /**
         * 过滤条件
         */
        this.filters = null;
        /**
         * 渲染grid
         */
        this.renderGridSubject = new Subject();
        /**
         * 选中行切换事件
         */
        this.selectedRowChange = new EventEmitter();
        this.setChecks([]);
        this.registerEvent();
    }
    Object.defineProperty(FarrisDatagridUseBindingDataDirective.prototype, "props", {
        get: function () {
            return this._PROPS;
        },
        set: function (value) {
            this._PROPS = value;
        },
        enumerable: true,
        configurable: true
    });
    // #region Ng Event
    FarrisDatagridUseBindingDataDirective.prototype.ngOnInit = function () {
        var _this = this;
        var _a = (this.getPagingInfo() || {}).pageSize, pageSize = _a === void 0 ? 0 : _a;
        if (pageSize !== 0) {
            // 启用分页
            if ((!this.grid.pageList || this.grid.pageList.length < 1) && typeof this.grid['setPageList'] === 'function') {
                this.grid['setPageList']([pageSize, pageSize * 2, pageSize * 3, pageSize * 4]);
            }
        }
        this.setComponentRef();
        this.bindData();
        window.setTimeout(function () {
            _this.updateSelectedRow();
        }, 0);
        this.registerBindingDataChangeEvent();
        this.renderGridSubject.pipe(debounceTime(500)).subscribe(function (change) {
            if (!_this.viewModel || !_this.viewModel.frameContext || _this.viewModel.frameContext.isDisposed) {
                return;
            }
            _this.bindData(change);
        });
    };
    FarrisDatagridUseBindingDataDirective.prototype.ngOnChanges = function (changes) {
        this.bindData();
    };
    Object.defineProperty(FarrisDatagridUseBindingDataDirective.prototype, "primaryKey", {
        // #endregion
        /**
         * 主键
         */
        get: function () {
            return this.bindingList.primaryKey;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FarrisDatagridUseBindingDataDirective.prototype, "bindingList", {
        /**
         * 获取绑定数据
         */
        get: function () {
            // 根实体
            if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
                return this.bindingData.list;
            }
            // 子实体
            var bindingPath = this.viewModel.bindingPath.substr(1);
            bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
            var paths = bindingPath.split('/');
            var filteredPaths = paths.filter(function (part) {
                return part !== '';
            });
            return this.bindingData.getValue(filteredPaths);
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 设置组件引用
     */
    FarrisDatagridUseBindingDataDirective.prototype.setComponentRef = function () {
        var appContext = this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.getFormAppContext();
        var frameId = this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.frameId;
        var id = this.grid && this.grid.id;
        // 如果frameId不存在或farris grid没有id属性，说明不符合使用场景
        if (!frameId || !id) {
            return;
        }
        var map = appContext && appContext.componentRefs && appContext.componentRefs.get(frameId) || new Map();
        appContext && appContext.componentRefs && appContext.componentRefs.set(frameId, map.set(id, this.grid));
    };
    /**
     * 获取分页信息
     */
    FarrisDatagridUseBindingDataDirective.prototype.getPagingInfo = function () {
        var bindingPath = this.viewModel.bindingPath;
        var bindingData = this.viewModel.bindingData;
        var pagingInfo = bindingData && bindingData.pagingInfo || {};
        if (bindingPath === '/') {
            return pagingInfo;
        }
        else {
            var bindingPaths = bindingPath.substr(1).split('/').filter(function (item) { return !!item && item.length > 0; });
            // 从表及从从表分页和数据是关联的，因为不同的从表行有不同的从从表数据，分页信息的结构为nodeCode_parentId:{分页信息}且分页信息是平级的
            // {pagination:{a_pid:{pageSize:2,pageIndex:1},b_pid:{pageSize:2,pageIndex:1}}}
            // 取出当前路径下实体的nodeCode
            var nodeCode = bindingPaths[bindingPaths.length - 1];
            nodeCode = nodeCode.substr(0, nodeCode.length - 1);
            // 获取当前实体上级的主键
            // const result = pagingInfo[nodeCode] || {};
            // if (result.hasOwnProperty('totalCount')) {
            //   result.total = result.totalCount;
            // }
            // return result;
            var paths = bindingPaths.slice(0, bindingPaths.length - 1);
            var bindingList = bindingData.getValue(paths);
            var _a = (pagingInfo["" + nodeCode] || {}).pageSize, pageSize = _a === void 0 ? 0 : _a;
            // 上级表有数据
            if (bindingList && bindingList.currentId) {
                var key = nodeCode + "_" + bindingList.currentId;
                // const key = nodeCode;
                var result = pagingInfo[key] || {};
                if (result.hasOwnProperty('totalCount')) {
                    result.total = result.totalCount;
                }
                // 上级表虽然有数据，但上级表当前行的下级表可能没有数据，这就导致获取不到分页信息，所以需要在返回前对结果进行处理，如果没有分页信息的话起码应该返回分页大小及当前页码
                if (Object.keys(result).length < 1) {
                    result.pageIndex = 1;
                    result.pageSize = pageSize;
                }
                return result;
            }
            else {
                // 上级表没有数据，此时需要获取当前表的分页信息，如分页大小。当前页默认为1即可。
                return { pageIndex: 1, pageSize: pageSize };
            }
        }
    };
    // #region Input
    /**
     * 组件是否需要更新
     * @param props 当前属性
     * @param nextProps 新属性
     * @param change 变更
     */
    FarrisDatagridUseBindingDataDirective.prototype.shouldComponentUpdate = function (change, data) {
        var props = this.buildProps(data);
        if (this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.appContext && this.viewModel.frameContext.appContext.runMode === RunMode.highSpeed && change) {
            if (change.type === ChangeType.Load || change.type === ChangeType.Remove || change.type === ChangeType.PaginationInfoChange) {
                return { result: true, props: props };
            }
        }
        var gridProps = this.buildGridProps();
        if (JSON.stringify(props) === JSON.stringify(gridProps)) {
            return { result: false };
        }
        return { result: true, props: props };
    };
    FarrisDatagridUseBindingDataDirective.prototype.registerEvent = function () {
        var _this = this;
        // 排序事件
        this.grid && this.grid.columnSorted && this.grid.columnSorted.subscribe(function (event) {
            var isRemoteSort = _this.grid.remoteSort;
            // 本地排序
            if (!isRemoteSort) {
                _this.sortFields = _this.grid.sortName;
                _this.sortDirections = _this.grid.sortOrder;
                _this.sortBindingList();
                // this.props = this.buildProps();
            }
            else {
                // 服务器端排序
                var groupField = _this.grid && _this.grid.groupField || null;
                var sortFields = _this.grid.sortName && _this.grid.sortName.split(',') || [];
                var sortDirection = _this.grid.sortOrder && _this.grid.sortOrder.split(',') || [];
                if (groupField) {
                    if (!sortFields.includes(groupField)) {
                        sortFields.splice(0, 0, groupField);
                        sortDirection.splice(0, 0, 'asc');
                    }
                }
                // 获取当前entity上所有object属性
                var entityType = _this.viewModel && _this.viewModel.frameContext.repository.entityType || null;
                if (sortFields.length > 0) {
                    if (entityType) {
                        var dataTypeInfo_1 = new DataTypeInfo(entityType);
                        sortFields = sortFields.map(function (field) {
                            //if (field && field.indexOf('.') !== -1) {
                            var paths = field.split('.');
                            var propInfo = dataTypeInfo_1.getPropInfoByPath(paths);
                            var originalField = propInfo && propInfo.metadataInfo['path'] || null;
                            return originalField;
                            //}
                            //return field;
                        });
                    }
                }
                // 遍历属性，根据datafield转换为originalDataField
                var fields = sortFields.join(',');
                var directions = sortDirection.join(',') || 'asc';
                var frameContext = _this.viewModel && _this.viewModel.frameContext || null;
                if (frameContext) {
                    frameContext.repository.sortConditionManager.setConditions(_this.viewModel.bindingPath, fields, directions);
                }
            }
        });
        // 过滤事件
        this.grid && this.grid.filterChanged && this.grid.filterChanged.subscribe(function (event) {
            _this.filters = event;
            if (!_this.grid.remoteFilter) {
                if (_this.bindingList.length > 0 && !_this.bindingList.currentId) {
                    var id = _this.bindingList.getIdByIndex(0);
                    _this.bindingList.setCurrentId(id);
                }
                _this.bindData();
            }
        });
    };
    /**
     * 对bindingList排序
     */
    FarrisDatagridUseBindingDataDirective.prototype.sortBindingList = function () {
        var groupField = this.grid && this.grid.groupField || null;
        if (groupField) {
            var arrSortFields = this.sortFields && this.sortFields.split(',') || [];
            if (!arrSortFields.includes(groupField)) {
                arrSortFields.splice(0, 0, groupField);
                var arrSortDirection = this.sortDirections && this.sortDirections.split(',') || [];
                arrSortDirection.splice(0, 0, 'asc');
                this.sortFields = arrSortFields.join(',');
                this.sortDirections = arrSortDirection.join(',') || 'asc';
            }
        }
        if (this.sortFields && this.sortDirections) {
            this.bindingList.sortBy(this.sortFields, this.sortDirections);
            // this.props = this.buildProps();
        }
        this.bindData();
    };
    // #endregion
    // #region 数据绑定部分
    /**
     * 更新数据
     * @param change? 变更
     */
    FarrisDatagridUseBindingDataDirective.prototype.bindData = function (change) {
        var _this = this;
        var isRemoteFilter = this.grid && this.grid.remoteFilter || false;
        // 先执行排序
        if (this.sortFields && !this.grid.editable && change && (change.type === 'Load' || change.type === 'SelectionChanged')) {
            this.sortBindingList();
            return;
        }
        // 新增数据时清空表格筛选条件
        if ((this.grid.editable === true || change && change.type === ChangeType.Append) && this.filters && Object.keys(this.filters).length > 0 && !isRemoteFilter) {
            this.filters = {};
            this.grid.clearCondition();
        }
        // 再toJSON
        var data = this.bindingList.toJSON();
        if (this.filters && Object.keys(this.filters).length > 0 && !isRemoteFilter) {
            data = this.grid.clientFilterService.executeFilter(data, this.filters);
        }
        if (this.filters && Object.keys(this.filters).length > 0 && !isRemoteFilter && (!change || change && change.type !== ChangeType.SelectionChanged && change.type !== ChangeType.GlobalSelectionChanged)) {
            if (data && data.length > 0) {
                // 判断当前行是否在过滤后的数据中
                var row = data.find(function (item) { return item[_this.bindingList.primaryKey] === _this.bindingList.currentId; });
                if (!row) {
                    var firstRowId = data[0][this.bindingList.primaryKey];
                    this.bindingList.setCurrentId(firstRowId, true, true);
                }
            }
            else {
                // 本地过滤完之后没有数据了
                // this.bindingList.currentId = null;
                this.bindingList.setCurrentId(null, true, true, true);
                // 单选时清空ids
                if (!this.grid.multiSelect) {
                    this.setChecks([]);
                }
            }
        }
        var result = this.shouldComponentUpdate(change, data);
        if (!result.result) {
            return;
        }
        // const nextProps = this.buildProps(result);
        this.renderGrid(result.props);
        this.props = JSON.parse(JSON.stringify(result.props));
    };
    /**
     * 渲染grid
     * @param props 属性
     */
    FarrisDatagridUseBindingDataDirective.prototype.renderGrid = function (props) {
        var pageIndex = props.pageIndex, pageSize = props.pageSize, total = props.total, pagination = props.pagination, data = props.data;
        var virtualizedLoad = this.grid.virtualizedAsyncLoad || false;
        this.grid.total = total;
        this.grid.pageSize = pageSize;
        this.grid.pageIndex = pageIndex;
        this.grid.pagination = pagination;
        this.grid.controlPaginationState = false;
        // this.endCellEdit();
        if (pageSize === 0) {
            this.grid.pagination = false;
            this.grid.pageIndex = 1;
            // 修复不分页时grid启用分组仍会重新邦数的问题
            // this.grid.pageSize = total;
        }
        if (virtualizedLoad) {
            this.grid.loadVirtualData({
                items: data,
                pageIndex: pageIndex,
                pageSize: pageSize,
                total: total
            });
        }
        else {
            this.grid.loadData(data);
        }
    };
    /**
     * 构造表格数据属性
     */
    FarrisDatagridUseBindingDataDirective.prototype.buildProps = function (datas) {
        var data;
        if (typeof (datas) !== 'undefined') {
            data = datas;
        }
        else {
            data = this.bindingList.toJSON();
        }
        // let skip = 0;
        var _a = this.getPagingInfo() || {}, _b = _a.pageIndex, pageIndex = _b === void 0 ? 1 : _b, _c = _a.pageSize, pageSize = _c === void 0 ? 0 : _c;
        var _d = (this.getPagingInfo() || {}).total, total = _d === void 0 ? 0 : _d;
        // if (pageIndex > 0) {
        //   skip = (pageIndex - 1) * pageSize;
        // }
        if (pageSize === 0 && total === 0) {
            total = data.length;
        }
        return { data: data, pageIndex: pageIndex, pageSize: pageSize, total: total, pagination: pageSize !== 0 };
    };
    /**
     * 计算grid状态
     */
    FarrisDatagridUseBindingDataDirective.prototype.buildGridProps = function () {
        var data = this.grid.data || [];
        var skip = 0;
        var _a = { pageIndex: this.grid.pageIndex, pageSize: this.grid.pageSize }, _b = _a.pageIndex, pageIndex = _b === void 0 ? 1 : _b, _c = _a.pageSize, pageSize = _c === void 0 ? 0 : _c;
        var total = this.grid.total || 0;
        if (pageIndex > 0) {
            skip = (pageIndex - 1) * pageSize;
        }
        if (pageSize === 0 && total === 0) {
            total = data.length;
        }
        return { data: data, pageIndex: pageIndex, pageSize: pageSize, total: total, pagination: this.grid.pagination };
    };
    /**
     * 数据源发生变更
     * @param change 变更
     */
    FarrisDatagridUseBindingDataDirective.prototype.onBindingDataChange = function (change) {
        this.updateDataSource(change);
        this.updateSelectedRow(change);
        // this.updateGrid(change);
        // 不清除勾选行，需要保留勾选状态
        // this.clearCheckedRows(change);
        this.endCellEdit(change);
        // 更新勾选行数据
        this.updateCheckedRows(change);
        this.updateData(change);
    };
    /**
     * 更新数据
     */
    FarrisDatagridUseBindingDataDirective.prototype.updateDataSource = function (change) {
        /*if (change) {
          const isMatch = this.checkIfChangeMatchBindingPath(change);
          if (!isMatch) {
            return;
          }
        }*/
        if (change && change.type === ChangeType.ValueChanged) {
            this.renderGridSubject.next(change);
        }
        else if (change && (change.type === ChangeType.SelectionChanged || change.type === ChangeType.GlobalSelectionChanged)) {
            if (this.bindingList.currentId === (this.grid.selectedRow && this.grid.selectedRow.id) && this.grid.total > 0) {
            }
            else {
                this.bindData(change);
            }
        }
        else {
            this.bindData(change);
        }
    };
    // private endCellEdit() {
    //   const isEditing = this.grid.isEditing();
    //   if (isEditing) {
    //     this.grid.endCellEdit();
    //   }
    // }
    FarrisDatagridUseBindingDataDirective.prototype.endCellEdit = function (change) {
        var isEditing = this.grid.isEditing();
        if (change.type === ChangeType.Load && isEditing) {
            this.grid.endCellEdit();
        }
    };
    /**
     * 设置grid当前选择行
     * @param change 变更
     */
    FarrisDatagridUseBindingDataDirective.prototype.updateSelectedRow = function (change) {
        if (!this.bindingList || !this.bindingList.currentId) {
            return;
        }
        // 页码切换时不执行当前行切换
        if (change && change.type === ChangeType.PaginationInfoChange) {
            return;
        }
        if (this.viewModel && this.viewModel.frameContext.bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        var _a = (this.grid.selectedRow || {}).id, gridSelectedRowId = _a === void 0 ? null : _a;
        var currentId = this.bindingList.currentId;
        // grid当前行与bingingList当前行一致，无须切换
        if (gridSelectedRowId === currentId) {
            var isMatch = change && (change.path.toString() === this.viewModel.bindingPath.split('/').filter(function (p) { return p; }).toString());
            if (change && change.type === ChangeType.Load && isMatch) {
                this.grid.clearSelections();
                this.grid.selectRow(currentId, true, true);
            }
            return;
        }
        this.selectGridRow(this.bindingList.currentId);
    };
    /**
     * 注册bindingdata变化事件
     */
    FarrisDatagridUseBindingDataDirective.prototype.registerBindingDataChangeEvent = function () {
        var _this = this;
        this.bindingDataChangeEvent = this.bindingData.changes.subscribe(function (change) {
            _this.onBindingDataChange(change);
        });
        this.viewModel.frameContext.appContext.messagePipe.subscribe(function (message) {
            if (message === 'bindData') {
                _this.bindData();
            }
        });
    };
    /**
     * 取消bindingdata变化订阅
     */
    FarrisDatagridUseBindingDataDirective.prototype.unRegisterBindingDataChangeEvent = function () {
        if (this.bindingDataChangeEvent && typeof (this.bindingDataChangeEvent.unsubscribe) === 'function') {
            this.bindingDataChangeEvent.unsubscribe();
        }
    };
    /**
     * 触发页码切换事件
     * @description 本方法适用场景仅为父级grid数据重新load，需要触发该grid重新取数使用。其他场景请勿使用
     * @TODO: 待重构，控制下级数据加载应该依赖表格的行切换事件，临时这样处理，后续提供LoadChildren事件
     */
    FarrisDatagridUseBindingDataDirective.prototype.updateData = function (change) {
        var _this = this;
        if (!(change && (change.type === ChangeType.SelectionChanged || change.type === ChangeType.Load))) {
            return;
        }
        var bindingPath = this.viewModel.bindingPath;
        var eventBindingPath = '/' + change.path.join('/');
        var isRetrieve = this.viewModel.frameContext.appContext.params.get('retrieveing') || false;
        if (change.path.length < 1 || bindingPath === '/' || bindingPath === eventBindingPath || !bindingPath.startsWith(eventBindingPath)) {
            return;
        }
        // retrieve时会自动带回从表第一页及从表第一行的从从表数据，所以不需要再去单独请求
        if (isRetrieve) {
            return;
        }
        var fullPaths = EntityPathConverter.toEntityPathArray(this.viewModel.bindingPath, this.bindingData);
        var paths = fullPaths.slice(0, fullPaths.length - 1);
        var parent = this.bindingList.parent;
        var parentId = parent && parent[parent.primaryKey];
        // 上级表没有数据
        if (!parentId) {
            return;
        }
        // 获取nodecode
        var bindingPaths = this.viewModel.bindingPath.split('/').filter(function (item) { return item; });
        var nodeCode = bindingPaths[bindingPaths.length - 1];
        nodeCode = nodeCode.substr(0, nodeCode.length - 1);
        // const configPath = `/${nodeCode}_${parentId}`;
        var configPath = "/" + nodeCode;
        var _a = (this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(configPath) || {}).pageIndex, pageIndex = _a === void 0 ? 1 : _a;
        var _b = (this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(configPath) || {}).pageSize, pageSize = _b === void 0 ? 0 : _b;
        var parentNodeCode = change.path[change.path.length - 1];
        var parentConfigPath = '/' + parentNodeCode.substring(0, parentNodeCode.length - 1);
        var _c = (this.viewModel.frameContext.repository.entityCollection.getPaginationConfigByPath(parentConfigPath) || {}).pageSize, parentPageSize = _c === void 0 ? 0 : _c;
        var isQueryChild = this.viewModel.frameContext.appContext.params.get('queryChild') || false;
        if (isQueryChild) {
            // this.viewModel.frameContext.appContext.params.delete('queryChild');
            pageIndex = 1;
        }
        // 当上级表切换行时
        if (parentPageSize + pageSize !== 0) {
            this.viewModel.frameContext.appContext.params.set('forceQueryChild', true);
            this.viewModel.frameContext.repository.queryChild(paths, pageIndex, pageSize).pipe(finalize(function () { return _this.viewModel.frameContext.appContext.params.delete('forceQueryChild'); })).subscribe();
        }
    };
    FarrisDatagridUseBindingDataDirective.prototype.ngOnDestroy = function () {
        this.unRegisterBindingDataChangeEvent();
    };
    // #endregion
    // #region 事件发射器
    /**
     * 发射选中行切换事件
     * @description 统一单选模式和多选模式下的行切换事件
     */
    FarrisDatagridUseBindingDataDirective.prototype.fireSelectedRowChange = function (selectedRowContext) {
        this.selectedRowChange.emit(selectedRowContext);
    };
    /**
     * 清空选定行
     * @param change 变更
     */
    FarrisDatagridUseBindingDataDirective.prototype.clearCheckedRows = function (change) {
        if (change.type === ChangeType.Load && this.grid.multiSelect) {
            var isMatch = this.checkIfChangeMatchBindingPath(change);
            if (isMatch) {
                this.setChecks([]);
                if (typeof (this.grid.clearCheckeds) === 'function') {
                    this.grid.clearCheckeds();
                }
            }
        }
    };
    // #endregion
    // #region 通信
    /**
     * 设置BindingList的当前行
     * @param id 当前行内码
     */
    FarrisDatagridUseBindingDataDirective.prototype.setSelectionIdToBindingData = function (id) {
        // 如果当前行不存在，则强制设置
        if (!id) {
            this.bindingList.currentId = id;
            if (!this.grid.multiSelect) {
                this.setChecks([]);
            }
            return;
        }
        if (this.bindingList.currentId !== id) {
            this.bindingList.setCurrentId(id, true);
        }
        // 单选模式下将当前行设置到ids
        if (!this.grid.multiSelect) {
            this.setChecks([id]);
        }
    };
    FarrisDatagridUseBindingDataDirective.prototype.updateCheckedRows = function (changes) {
        if (changes.type === ChangeType.Load) {
            this.setCheckedRows();
        }
        else if (changes.type === ChangeType.ValueChanged) {
            var ids = this.getChecks();
            if (changes.id && ids.includes(changes.id)) {
                this.setCheckedRows();
            }
        }
    };
    /**
     * 设置选择行
     */
    FarrisDatagridUseBindingDataDirective.prototype.setChecks = function (ids) {
        this.viewModel.uiState.setPropertyValue('ids', ids);
        this.setCheckedRows(ids);
    };
    /**
     * 获取勾选行id数组
     * @returns
     */
    FarrisDatagridUseBindingDataDirective.prototype.getChecks = function () {
        return this.viewModel.uiState['ids'] || [];
    };
    /**
     * 更新勾选行数据
     */
    FarrisDatagridUseBindingDataDirective.prototype.setCheckedRows = function (ids) {
        var _this = this;
        // 高速模式时不再设置rows
        // if (this.viewModel.frameContext.appContext.runMode === RunMode.highSpeed) {
        //   return;
        // }
        if (typeof ids === 'undefined') {
            ids = this.viewModel.uiState['ids'] || [];
        }
        if (!Array.isArray(ids) || ids.length < 1) {
            // 此时ids没有值，rows中也不应该有
            this.viewModel.uiState.setPropertyValue('rows', null);
            return;
        }
        var list = [];
        // TODO：rows中数据在高速模式和普通模式下多语字段的值表现不一致，高速模式下多语字段值为对象，普通模式为当前语言。暂不处理高速模式场景
        if (this.viewModel.frameContext.appContext.runMode === RunMode.highSpeed) {
            list = this.grid.data || [];
        }
        else {
            list = this.bindingList.toJSON({ ignoreMultiLangInput: true });
        }
        var rows = this.viewModel.uiState['rows'] || new Map();
        var result = new Map();
        ids.forEach(function (id) {
            var item = list.find(function (item) { return item[_this.primaryKey] === id; });
            var otherPageItem = rows.get(id);
            if (item) {
                result.set(id, item);
            }
            else if (otherPageItem) {
                result.set(id, otherPageItem);
            }
        });
        this.viewModel.uiState.setPropertyValue('rows', result);
    };
    /**
     * 选中grid行
     * @param id id
     */
    FarrisDatagridUseBindingDataDirective.prototype.selectGridRow = function (id) {
        this.grid.selectRow(id);
        this.grid.scrollToCurrentRow();
    };
    // #endregion
    // #region 事件处理器
    /**
     * 页码切换事件
     * @param event event
     */
    FarrisDatagridUseBindingDataDirective.prototype.pageChangedHandler = function (event) {
        var pageIndex = event.pageIndex, pageSize = event.pageSize;
        if (pageIndex < 1) {
            pageIndex = 1;
        }
        var skip = (pageIndex - 1) * pageSize;
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    };
    /**
     * 行切换事件
     * @param event event
     */
    FarrisDatagridUseBindingDataDirective.prototype.selectedRowChanged = function (event) {
        var index = event.index, data = event.data;
        var id = data[this.primaryKey];
        this.setSelectionIdToBindingData(id);
        this.fireSelectedRowChange(event);
    };
    /**
     * 取消行选择事件
     * @param event event
     */
    FarrisDatagridUseBindingDataDirective.prototype.unSelected = function (event) {
        if (!event) {
            return;
        }
        var _a = event.data, data = _a === void 0 ? {} : _a;
        var id = data[this.primaryKey];
        var currentId = this.bindingList.currentId;
        if (id === currentId) {
            this.setSelectionIdToBindingData(null);
        }
        // this.fireSelectedRowChange(event);
    };
    /**
     * 勾选行发生变化
     * @param event event
     */
    FarrisDatagridUseBindingDataDirective.prototype.checkedChanged = function (event) {
        event = event || [];
        var ids = event.map(function (item) { return item.id; });
        this.setChecks(ids);
    };
    /**
     * 分页大小变更事件
     * @param event event
     */
    FarrisDatagridUseBindingDataDirective.prototype.pageSizeChanged = function (event) {
        var pageIndex = event.pageIndex, pageSize = event.pageSize;
        var skip = 0; //(pageIndex - 1) * pageSize;
        // this.bindingList.setPaginationInfo(skip, pageSize);
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    };
    /**
     * grid滚动加载数据
     * @param event event
     */
    FarrisDatagridUseBindingDataDirective.prototype.scrollY = function (event) {
        var pageIndex = event.pager, pageSize = event.pageSize;
        var skip = (pageIndex - 1) * pageSize;
        this.bindingData.setPagingInfo(skip, pageSize, this.bindingData.bindingPath);
    };
    FarrisDatagridUseBindingDataDirective.prototype.filterChanged = function (event) {
        this.filters = event;
    };
    // #endregion
    FarrisDatagridUseBindingDataDirective.prototype.checkIfChangeMatchBindingPath = function (change) {
        var isMatch = false;
        if (!change || !change.path) {
            return isMatch;
        }
        var changePathArray = change.path;
        if (!changePathArray) {
            return isMatch;
        }
        if (!(this.bindingData) && !(this.bindingData.bindingPath)) {
            return isMatch;
        }
        var bingdingPathArray = this.bindingData.bindingPath.split('/');
        if (bingdingPathArray.length <= 0) {
            return isMatch;
        }
        if (changePathArray.length === 0) { // 主表
            if (this.bindingData.bindingPath === '/') {
                isMatch = true;
            }
        }
        else if (change.path.length === 1) { // 主从表
            if (bingdingPathArray.length === 2 && bingdingPathArray[1] === change.path[0]) {
                isMatch = true;
            }
        }
        else if (change.path.length === 2) { // 主从从表
            if (bingdingPathArray.length === 3 && bingdingPathArray[1] === change.path[0] && bingdingPathArray[2] === change.path[1]) {
                isMatch = true;
            }
        }
        return isMatch;
    };
    FarrisDatagridUseBindingDataDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farris-use-binding-data]'
                },] }
    ];
    /** @nocollapse */
    FarrisDatagridUseBindingDataDirective.ctorParameters = function () { return [
        { type: BindingData },
        { type: ViewModel },
        { type: DatagridComponent }
    ]; };
    FarrisDatagridUseBindingDataDirective.propDecorators = {
        selectedRowChange: [{ type: Output }],
        pageChangedHandler: [{ type: HostListener, args: ['pageChanged', ['$event'],] }],
        selectedRowChanged: [{ type: HostListener, args: ['selectChanged', ['$event'],] }],
        unSelected: [{ type: HostListener, args: ['unSelect', ['$event'],] }],
        checkedChanged: [{ type: HostListener, args: ['checkedChange', ['$event'],] }],
        pageSizeChanged: [{ type: HostListener, args: ['pageSizeChanged', ['$event'],] }],
        scrollY: [{ type: HostListener, args: ['scrollYLoad', ['$event'],] }],
        filterChanged: [{ type: HostListener, args: ['filterChanged', ['$event'],] }]
    };
    return FarrisDatagridUseBindingDataDirective;
}());
export { FarrisDatagridUseBindingDataDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWRhdGFncmlkLXVzZS1iaW5kaW5nLWRhdGEuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZmFycmlzLWRhdGFncmlkL2ZhcnJpcy1kYXRhZ3JpZC11c2UtYmluZGluZy1kYXRhLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUErQyxZQUFZLEVBQ3BFLFlBQVksRUFBRSxNQUFNLEVBQ3JCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxPQUFPLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFBRSxXQUFXLEVBQXVCLFVBQVUsRUFBRSxTQUFTLEVBQStDLFlBQVksRUFBaUIsbUJBQW1CLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDak0sT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4RCxrQ0FBa0M7QUFFbEM7O0dBRUc7QUFDSDtJQThCRSwrQ0FBbUIsV0FBd0IsRUFBUyxTQUFvQixFQUFTLElBQXVCO1FBQXJGLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQVMsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUFTLFNBQUksR0FBSixJQUFJLENBQW1CO1FBekJ4RyxPQUFPO1FBQ0MsZUFBVSxHQUFXLElBQUksQ0FBQztRQUNsQyxPQUFPO1FBQ0MsbUJBQWMsR0FBVyxJQUFJLENBQUM7UUFDOUIsYUFBUSxHQUFXLElBQUksQ0FBQztRQUNoQzs7V0FFRztRQUNLLFlBQU8sR0FBUSxJQUFJLENBQUM7UUFRNUI7O1dBRUc7UUFDSyxzQkFBaUIsR0FBaUIsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUM3RDs7V0FFRztRQUNPLHNCQUFpQixHQUFz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S0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUN4SCxPQUFPLEdBQUcsSUFBSSxDQUFDO2FBQ2hCO1NBQ0Y7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOztnQkE1dkJGLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsMkJBQTJCO2lCQUN0Qzs7OztnQkFWUSxXQUFXO2dCQUFtQyxTQUFTO2dCQUN2RCxpQkFBaUI7OztvQ0FtQ3ZCLE1BQU07cUNBa25CTixZQUFZLFNBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDO3FDQWN0QyxZQUFZLFNBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDOzZCQVl4QyxZQUFZLFNBQUMsVUFBVSxFQUFFLENBQUMsUUFBUSxDQUFDO2lDQWlCbkMsWUFBWSxTQUFDLGVBQWUsRUFBRSxDQUFDLFFBQVEsQ0FBQztrQ0FVeEMsWUFBWSxTQUFDLGlCQUFpQixFQUFFLENBQUMsUUFBUSxDQUFDOzBCQVkxQyxZQUFZLFNBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDO2dDQU10QyxZQUFZLFNBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDOztJQXlDM0MsNENBQUM7Q0FBQSxBQTl2QkQsSUE4dkJDO1NBM3ZCWSxxQ0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSwgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgU2ltcGxlQ2hhbmdlcywgSG9zdExpc3RlbmVyLFxyXG4gIEV2ZW50RW1pdHRlciwgT3V0cHV0XHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIENoYW5nZSwgQ2hhbmdlVHlwZSwgVmlld01vZGVsLCBBcHBDb250ZXh0LCBGcmFtZUNvbnRleHQsIEZpZWxkTWV0YWRhdGFVdGlsLCBEYXRhVHlwZUluZm8sIEJpbmRpbmdPYmplY3QsIEVudGl0eVBhdGhDb252ZXJ0ZXIsIFJ1bk1vZGUgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1kYXRhZ3JpZCc7XHJcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZmluYWxpemUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcclxuXHJcbi8qXHJcbiAqIOS9v+eUqOe7keWumuaVsOaNruaMh+S7pFxyXG4gKi9cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbZmFycmlzLXVzZS1iaW5kaW5nLWRhdGFdJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRmFycmlzRGF0YWdyaWRVc2VCaW5kaW5nRGF0YURpcmVjdGl2ZSBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gIHByaXZhdGUgX1BST1BTOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH07XHJcbiAgLy8g5o6S5bqP5a2X5q61XHJcbiAgcHJpdmF0ZSBzb3J0RmllbGRzOiBzdHJpbmcgPSBudWxsO1xyXG4gIC8vIOaOkuW6j+aWueWQkVxyXG4gIHByaXZhdGUgc29ydERpcmVjdGlvbnM6IHN0cmluZyA9IG51bGw7XHJcbiAgcHJpdmF0ZSBwYXJlbnRJZDogc3RyaW5nID0gbnVsbDtcclxuICAvKipcclxuICAgKiDov4fmu6TmnaHku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGZpbHRlcnM6IGFueSA9IG51bGw7XHJcbiAgcHJvdGVjdGVkIGdldCBwcm9wcygpIHtcclxuICAgIHJldHVybiB0aGlzLl9QUk9QUztcclxuICB9XHJcbiAgcHJvdGVjdGVkIHNldCBwcm9wcyh2YWx1ZSkge1xyXG4gICAgdGhpcy5fUFJPUFMgPSB2YWx1ZTtcclxuICB9XHJcbiAgcHJvdGVjdGVkIGJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQ6IFN1YnNjcmlwdGlvbjtcclxuICAvKipcclxuICAgKiDmuLLmn5NncmlkXHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZW5kZXJHcmlkU3ViamVjdDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIC8qKlxyXG4gICAqIOmAieS4reihjOWIh+aNouS6i+S7tlxyXG4gICAqL1xyXG4gIEBPdXRwdXQoKSBzZWxlY3RlZFJvd0NoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSwgcHVibGljIHZpZXdNb2RlbDogVmlld01vZGVsLCBwdWJsaWMgZ3JpZDogRGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgIHRoaXMuc2V0Q2hlY2tzKFtdKTtcclxuICAgIHRoaXMucmVnaXN0ZXJFdmVudCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gI3JlZ2lvbiBOZyBFdmVudFxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIGNvbnN0IHsgcGFnZVNpemUgPSAwIH0gPSB0aGlzLmdldFBhZ2luZ0luZm8oKSB8fCB7fTtcclxuICAgIGlmIChwYWdlU2l6ZSAhPT0gMCkge1xyXG4gICAgICAvLyDlkK/nlKjliIbpobVcclxuICAgICAgaWYgKCghdGhpcy5ncmlkLnBhZ2VMaXN0IHx8IHRoaXMuZ3JpZC5wYWdlTGlzdC5sZW5ndGggPCAxKSAmJiB0eXBlb2YgdGhpcy5ncmlkWydzZXRQYWdlTGlzdCddID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgdGhpcy5ncmlkWydzZXRQYWdlTGlzdCddKFtwYWdlU2l6ZSwgcGFnZVNpemUgKiAyLCBwYWdlU2l6ZSAqIDMsIHBhZ2VTaXplICogNF0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICB0aGlzLnNldENvbXBvbmVudFJlZigpO1xyXG4gICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkUm93KCk7XHJcbiAgICB9LCAwKTtcclxuICAgIHRoaXMucmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCk7XHJcbiAgICB0aGlzLnJlbmRlckdyaWRTdWJqZWN0LnBpcGUoXHJcbiAgICAgIGRlYm91bmNlVGltZSg1MDApXHJcbiAgICApLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLnZpZXdNb2RlbCB8fCAhdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0IHx8IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5pc0Rpc3Bvc2VkKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMuYmluZERhdGEoY2hhbmdlKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5Li76ZSuXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBwcmltYXJ5S2V5KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGdldCBiaW5kaW5nTGlzdCgpOiBCaW5kaW5nTGlzdCB7XHJcbiAgICAvLyDmoLnlrp7kvZNcclxuICAgIGlmICh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gJy8nIHx8ICF0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5saXN0O1xyXG4gICAgfVxyXG4gICAgLy8g5a2Q5a6e5L2TXHJcbiAgICBsZXQgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zdWJzdHIoMSk7XHJcbiAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoWzBdLnRvTG93ZXJDYXNlKCkgKyBiaW5kaW5nUGF0aC5zdWJzdHJpbmcoMSwgYmluZGluZ1BhdGgubGVuZ3RoKTtcclxuICAgIGNvbnN0IHBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcclxuXHJcbiAgICBjb25zdCBmaWx0ZXJlZFBhdGhzID0gcGF0aHMuZmlsdGVyKChwYXJ0OiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuIHBhcnQgIT09ICcnO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShmaWx0ZXJlZFBhdGhzKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6+572u57uE5Lu25byV55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzZXRDb21wb25lbnRSZWYoKSB7XHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0ICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xyXG4gICAgY29uc3QgZnJhbWVJZCA9IHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuZnJhbWVJZDtcclxuICAgIGNvbnN0IGlkID0gdGhpcy5ncmlkICYmIHRoaXMuZ3JpZC5pZDtcclxuICAgIC8vIOWmguaenGZyYW1lSWTkuI3lrZjlnKjmiJZmYXJyaXMgZ3JpZOayoeaciWlk5bGe5oCn77yM6K+05piO5LiN56ym5ZCI5L2/55So5Zy65pmvXHJcbiAgICBpZiAoIWZyYW1lSWQgfHwgIWlkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG1hcCA9IGFwcENvbnRleHQgJiYgYXBwQ29udGV4dC5jb21wb25lbnRSZWZzICYmIGFwcENvbnRleHQuY29tcG9uZW50UmVmcy5nZXQoZnJhbWVJZCkgfHwgbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgIGFwcENvbnRleHQgJiYgYXBwQ29udGV4dC5jb21wb25lbnRSZWZzICYmIGFwcENvbnRleHQuY29tcG9uZW50UmVmcy5zZXQoZnJhbWVJZCwgbWFwLnNldChpZCwgdGhpcy5ncmlkKSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIhumhteS/oeaBr1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBnZXRQYWdpbmdJbmZvKCkge1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGE7XHJcbiAgICBsZXQgcGFnaW5nSW5mbyA9IGJpbmRpbmdEYXRhICYmIGJpbmRpbmdEYXRhLnBhZ2luZ0luZm8gfHwge307XHJcbiAgICBpZiAoYmluZGluZ1BhdGggPT09ICcvJykge1xyXG4gICAgICByZXR1cm4gcGFnaW5nSW5mbztcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnN1YnN0cigxKS5zcGxpdCgnLycpLmZpbHRlcihpdGVtID0+ICEhaXRlbSAmJiBpdGVtLmxlbmd0aCA+IDApO1xyXG4gICAgICAvLyDku47ooajlj4rku47ku47ooajliIbpobXlkozmlbDmja7mmK/lhbPogZTnmoTvvIzlm6DkuLrkuI3lkIznmoTku47ooajooYzmnInkuI3lkIznmoTku47ku47ooajmlbDmja7vvIzliIbpobXkv6Hmga/nmoTnu5PmnoTkuLpub2RlQ29kZV9wYXJlbnRJZDp75YiG6aG15L+h5oGvfeS4lOWIhumhteS/oeaBr+aYr+W5s+e6p+eahFxyXG4gICAgICAvLyB7cGFnaW5hdGlvbjp7YV9waWQ6e3BhZ2VTaXplOjIscGFnZUluZGV4OjF9LGJfcGlkOntwYWdlU2l6ZToyLHBhZ2VJbmRleDoxfX19XHJcbiAgICAgIC8vIOWPluWHuuW9k+WJjei3r+W+hOS4i+WunuS9k+eahG5vZGVDb2RlXHJcbiAgICAgIGxldCBub2RlQ29kZSA9IGJpbmRpbmdQYXRoc1tiaW5kaW5nUGF0aHMubGVuZ3RoIC0gMV07XHJcbiAgICAgIG5vZGVDb2RlID0gbm9kZUNvZGUuc3Vic3RyKDAsIG5vZGVDb2RlLmxlbmd0aCAtIDEpO1xyXG4gICAgICAvLyDojrflj5blvZPliY3lrp7kvZPkuIrnuqfnmoTkuLvplK5cclxuICAgICAgLy8gY29uc3QgcmVzdWx0ID0gcGFnaW5nSW5mb1tub2RlQ29kZV0gfHwge307XHJcbiAgICAgIC8vIGlmIChyZXN1bHQuaGFzT3duUHJvcGVydHkoJ3RvdGFsQ291bnQnKSkge1xyXG4gICAgICAvLyAgIHJlc3VsdC50b3RhbCA9IHJlc3VsdC50b3RhbENvdW50O1xyXG4gICAgICAvLyB9XHJcbiAgICAgIC8vIHJldHVybiByZXN1bHQ7XHJcblxyXG4gICAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRocy5zbGljZSgwLCBiaW5kaW5nUGF0aHMubGVuZ3RoIC0gMSk7XHJcbiAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICBjb25zdCB7IHBhZ2VTaXplID0gMCB9ID0gcGFnaW5nSW5mb1tgJHtub2RlQ29kZX1gXSB8fCB7fTtcclxuICAgICAgLy8g5LiK57qn6KGo5pyJ5pWw5o2uXHJcbiAgICAgIGlmIChiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5jdXJyZW50SWQpIHtcclxuICAgICAgICBjb25zdCBrZXkgPSBgJHtub2RlQ29kZX1fJHtiaW5kaW5nTGlzdC5jdXJyZW50SWR9YDtcclxuICAgICAgICAvLyBjb25zdCBrZXkgPSBub2RlQ29kZTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBwYWdpbmdJbmZvW2tleV0gfHwge307XHJcbiAgICAgICAgaWYgKHJlc3VsdC5oYXNPd25Qcm9wZXJ0eSgndG90YWxDb3VudCcpKSB7XHJcbiAgICAgICAgICByZXN1bHQudG90YWwgPSByZXN1bHQudG90YWxDb3VudDtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5LiK57qn6KGo6Jm954S25pyJ5pWw5o2u77yM5L2G5LiK57qn6KGo5b2T5YmN6KGM55qE5LiL57qn6KGo5Y+v6IO95rKh5pyJ5pWw5o2u77yM6L+Z5bCx5a+86Ie06I635Y+W5LiN5Yiw5YiG6aG15L+h5oGv77yM5omA5Lul6ZyA6KaB5Zyo6L+U5Zue5YmN5a+557uT5p6c6L+b6KGM5aSE55CG77yM5aaC5p6c5rKh5pyJ5YiG6aG15L+h5oGv55qE6K+d6LW356CB5bqU6K+l6L+U5Zue5YiG6aG15aSn5bCP5Y+K5b2T5YmN6aG156CBXHJcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKHJlc3VsdCkubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgICAgcmVzdWx0LnBhZ2VJbmRleCA9IDE7XHJcbiAgICAgICAgICByZXN1bHQucGFnZVNpemUgPSBwYWdlU2l6ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDkuIrnuqfooajmsqHmnInmlbDmja7vvIzmraTml7bpnIDopoHojrflj5blvZPliY3ooajnmoTliIbpobXkv6Hmga/vvIzlpoLliIbpobXlpKflsI/jgILlvZPliY3pobXpu5jorqTkuLox5Y2z5Y+v44CCXHJcbiAgICAgICAgcmV0dXJuIHsgcGFnZUluZGV4OiAxLCBwYWdlU2l6ZSB9O1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAjcmVnaW9uIElucHV0XHJcbiAgLyoqXHJcbiAgICog57uE5Lu25piv5ZCm6ZyA6KaB5pu05pawXHJcbiAgICogQHBhcmFtIHByb3BzIOW9k+WJjeWxnuaAp1xyXG4gICAqIEBwYXJhbSBuZXh0UHJvcHMg5paw5bGe5oCnXHJcbiAgICogQHBhcmFtIGNoYW5nZSDlj5jmm7RcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc2hvdWxkQ29tcG9uZW50VXBkYXRlKGNoYW5nZTogQ2hhbmdlLCBkYXRhOiBhbnksKTogeyByZXN1bHQ6IGJvb2xlYW4sIHByb3BzPzogYW55IH0ge1xyXG4gICAgY29uc3QgcHJvcHMgPSB0aGlzLmJ1aWxkUHJvcHMoZGF0YSk7XHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0ICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0ICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LnJ1bk1vZGUgPT09IFJ1bk1vZGUuaGlnaFNwZWVkICYmIGNoYW5nZSkge1xyXG4gICAgICBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5SZW1vdmUgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUGFnaW5hdGlvbkluZm9DaGFuZ2UpIHtcclxuICAgICAgICByZXR1cm4geyByZXN1bHQ6IHRydWUsIHByb3BzIH07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IGdyaWRQcm9wcyA9IHRoaXMuYnVpbGRHcmlkUHJvcHMoKTtcclxuICAgIGlmIChKU09OLnN0cmluZ2lmeShwcm9wcykgPT09IEpTT04uc3RyaW5naWZ5KGdyaWRQcm9wcykpIHtcclxuICAgICAgcmV0dXJuIHsgcmVzdWx0OiBmYWxzZSB9O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHsgcmVzdWx0OiB0cnVlLCBwcm9wcyB9O1xyXG4gIH1cclxuICBwcm90ZWN0ZWQgcmVnaXN0ZXJFdmVudCgpIHtcclxuICAgIC8vIOaOkuW6j+S6i+S7tlxyXG4gICAgdGhpcy5ncmlkICYmIHRoaXMuZ3JpZC5jb2x1bW5Tb3J0ZWQgJiYgdGhpcy5ncmlkLmNvbHVtblNvcnRlZC5zdWJzY3JpYmUoKGV2ZW50OiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgaXNSZW1vdGVTb3J0ID0gdGhpcy5ncmlkLnJlbW90ZVNvcnQ7XHJcbiAgICAgIC8vIOacrOWcsOaOkuW6j1xyXG4gICAgICBpZiAoIWlzUmVtb3RlU29ydCkge1xyXG4gICAgICAgIHRoaXMuc29ydEZpZWxkcyA9IHRoaXMuZ3JpZC5zb3J0TmFtZTtcclxuICAgICAgICB0aGlzLnNvcnREaXJlY3Rpb25zID0gdGhpcy5ncmlkLnNvcnRPcmRlcjtcclxuICAgICAgICB0aGlzLnNvcnRCaW5kaW5nTGlzdCgpO1xyXG4gICAgICAgIC8vIHRoaXMucHJvcHMgPSB0aGlzLmJ1aWxkUHJvcHMoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDmnI3liqHlmajnq6/mjpLluo9cclxuICAgICAgICBjb25zdCBncm91cEZpZWxkID0gdGhpcy5ncmlkICYmIHRoaXMuZ3JpZC5ncm91cEZpZWxkIHx8IG51bGw7XHJcbiAgICAgICAgbGV0IHNvcnRGaWVsZHMgPSB0aGlzLmdyaWQuc29ydE5hbWUgJiYgdGhpcy5ncmlkLnNvcnROYW1lLnNwbGl0KCcsJykgfHwgW107XHJcbiAgICAgICAgY29uc3Qgc29ydERpcmVjdGlvbiA9IHRoaXMuZ3JpZC5zb3J0T3JkZXIgJiYgdGhpcy5ncmlkLnNvcnRPcmRlci5zcGxpdCgnLCcpIHx8IFtdO1xyXG4gICAgICAgIGlmIChncm91cEZpZWxkKSB7XHJcbiAgICAgICAgICBpZiAoIXNvcnRGaWVsZHMuaW5jbHVkZXMoZ3JvdXBGaWVsZCkpIHtcclxuICAgICAgICAgICAgc29ydEZpZWxkcy5zcGxpY2UoMCwgMCwgZ3JvdXBGaWVsZCk7XHJcbiAgICAgICAgICAgIHNvcnREaXJlY3Rpb24uc3BsaWNlKDAsIDAsICdhc2MnKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g6I635Y+W5b2T5YmNZW50aXR55LiK5omA5pyJb2JqZWN05bGe5oCnXHJcbiAgICAgICAgY29uc3QgZW50aXR5VHlwZSA9IHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eVR5cGUgfHwgbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKHNvcnRGaWVsZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgaWYgKGVudGl0eVR5cGUpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YVR5cGVJbmZvID0gbmV3IERhdGFUeXBlSW5mbyhlbnRpdHlUeXBlKTtcclxuICAgICAgICAgICAgc29ydEZpZWxkcyA9IHNvcnRGaWVsZHMubWFwKGZpZWxkID0+IHtcclxuICAgICAgICAgICAgICAvL2lmIChmaWVsZCAmJiBmaWVsZC5pbmRleE9mKCcuJykgIT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgcGF0aHMgPSBmaWVsZC5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICAgIGNvbnN0IHByb3BJbmZvID0gZGF0YVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcclxuICAgICAgICAgICAgICBjb25zdCBvcmlnaW5hbEZpZWxkID0gcHJvcEluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvWydwYXRoJ10gfHwgbnVsbDtcclxuICAgICAgICAgICAgICByZXR1cm4gb3JpZ2luYWxGaWVsZDtcclxuICAgICAgICAgICAgICAvL31cclxuICAgICAgICAgICAgICAvL3JldHVybiBmaWVsZDtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOmBjeWOhuWxnuaAp++8jOagueaNrmRhdGFmaWVsZOi9rOaNouS4um9yaWdpbmFsRGF0YUZpZWxkXHJcbiAgICAgICAgY29uc3QgZmllbGRzID0gc29ydEZpZWxkcy5qb2luKCcsJyk7XHJcbiAgICAgICAgY29uc3QgZGlyZWN0aW9ucyA9IHNvcnREaXJlY3Rpb24uam9pbignLCcpIHx8ICdhc2MnO1xyXG4gICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0ID0gdGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0IHx8IG51bGw7XHJcbiAgICAgICAgaWYgKGZyYW1lQ29udGV4dCkge1xyXG4gICAgICAgICAgZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuc29ydENvbmRpdGlvbk1hbmFnZXIuc2V0Q29uZGl0aW9ucyh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCwgZmllbGRzLCBkaXJlY3Rpb25zKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgLy8g6L+H5ruk5LqL5Lu2XHJcbiAgICB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLmZpbHRlckNoYW5nZWQgJiYgdGhpcy5ncmlkLmZpbHRlckNoYW5nZWQuc3Vic2NyaWJlKChldmVudDogYW55KSA9PiB7XHJcbiAgICAgIHRoaXMuZmlsdGVycyA9IGV2ZW50O1xyXG4gICAgICBpZiAoIXRoaXMuZ3JpZC5yZW1vdGVGaWx0ZXIpIHtcclxuICAgICAgICBpZiAodGhpcy5iaW5kaW5nTGlzdC5sZW5ndGggPiAwICYmICF0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCkge1xyXG4gICAgICAgICAgY29uc3QgaWQgPSB0aGlzLmJpbmRpbmdMaXN0LmdldElkQnlJbmRleCgwKTtcclxuICAgICAgICAgIHRoaXMuYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWvuWJpbmRpbmdMaXN05o6S5bqPXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBzb3J0QmluZGluZ0xpc3QoKSB7XHJcbiAgICBjb25zdCBncm91cEZpZWxkID0gdGhpcy5ncmlkICYmIHRoaXMuZ3JpZC5ncm91cEZpZWxkIHx8IG51bGw7XHJcbiAgICBpZiAoZ3JvdXBGaWVsZCkge1xyXG4gICAgICBjb25zdCBhcnJTb3J0RmllbGRzID0gdGhpcy5zb3J0RmllbGRzICYmIHRoaXMuc29ydEZpZWxkcy5zcGxpdCgnLCcpIHx8IFtdO1xyXG4gICAgICBpZiAoIWFyclNvcnRGaWVsZHMuaW5jbHVkZXMoZ3JvdXBGaWVsZCkpIHtcclxuICAgICAgICBhcnJTb3J0RmllbGRzLnNwbGljZSgwLCAwLCBncm91cEZpZWxkKTtcclxuICAgICAgICBjb25zdCBhcnJTb3J0RGlyZWN0aW9uID0gdGhpcy5zb3J0RGlyZWN0aW9ucyAmJiB0aGlzLnNvcnREaXJlY3Rpb25zLnNwbGl0KCcsJykgfHwgW107XHJcbiAgICAgICAgYXJyU29ydERpcmVjdGlvbi5zcGxpY2UoMCwgMCwgJ2FzYycpO1xyXG4gICAgICAgIHRoaXMuc29ydEZpZWxkcyA9IGFyclNvcnRGaWVsZHMuam9pbignLCcpO1xyXG4gICAgICAgIHRoaXMuc29ydERpcmVjdGlvbnMgPSBhcnJTb3J0RGlyZWN0aW9uLmpvaW4oJywnKSB8fCAnYXNjJztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuc29ydEZpZWxkcyAmJiB0aGlzLnNvcnREaXJlY3Rpb25zKSB7XHJcbiAgICAgIHRoaXMuYmluZGluZ0xpc3Quc29ydEJ5KHRoaXMuc29ydEZpZWxkcywgdGhpcy5zb3J0RGlyZWN0aW9ucyk7XHJcbiAgICAgIC8vIHRoaXMucHJvcHMgPSB0aGlzLmJ1aWxkUHJvcHMoKTtcclxuICAgIH1cclxuICAgIHRoaXMuYmluZERhdGEoKTtcclxuICB9XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuICAvLyAjcmVnaW9uIOaVsOaNrue7keWumumDqOWIhlxyXG4gIC8qKlxyXG4gICAqIOabtOaWsOaVsOaNrlxyXG4gICAqIEBwYXJhbSBjaGFuZ2U/IOWPmOabtFxyXG4gICAqL1xyXG4gIGJpbmREYXRhKGNoYW5nZT86IENoYW5nZSkge1xyXG4gICAgY29uc3QgaXNSZW1vdGVGaWx0ZXIgPSB0aGlzLmdyaWQgJiYgdGhpcy5ncmlkLnJlbW90ZUZpbHRlciB8fCBmYWxzZTtcclxuICAgIC8vIOWFiOaJp+ihjOaOkuW6j1xyXG4gICAgaWYgKHRoaXMuc29ydEZpZWxkcyAmJiAhdGhpcy5ncmlkLmVkaXRhYmxlICYmIGNoYW5nZSAmJiAoY2hhbmdlLnR5cGUgPT09ICdMb2FkJyB8fCBjaGFuZ2UudHlwZSA9PT0gJ1NlbGVjdGlvbkNoYW5nZWQnKSkge1xyXG4gICAgICB0aGlzLnNvcnRCaW5kaW5nTGlzdCgpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDmlrDlop7mlbDmja7ml7bmuIXnqbrooajmoLznrZvpgInmnaHku7ZcclxuICAgIGlmICgodGhpcy5ncmlkLmVkaXRhYmxlID09PSB0cnVlIHx8IGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5BcHBlbmQpICYmIHRoaXMuZmlsdGVycyAmJiBPYmplY3Qua2V5cyh0aGlzLmZpbHRlcnMpLmxlbmd0aCA+IDAgJiYgIWlzUmVtb3RlRmlsdGVyKSB7XHJcbiAgICAgIHRoaXMuZmlsdGVycyA9IHt9O1xyXG4gICAgICB0aGlzLmdyaWQuY2xlYXJDb25kaXRpb24oKTtcclxuICAgIH1cclxuICAgIC8vIOWGjXRvSlNPTlxyXG4gICAgbGV0IGRhdGE6IGFueSA9IHRoaXMuYmluZGluZ0xpc3QudG9KU09OKCk7XHJcbiAgICBpZiAodGhpcy5maWx0ZXJzICYmIE9iamVjdC5rZXlzKHRoaXMuZmlsdGVycykubGVuZ3RoID4gMCAmJiAhaXNSZW1vdGVGaWx0ZXIpIHtcclxuICAgICAgZGF0YSA9IHRoaXMuZ3JpZC5jbGllbnRGaWx0ZXJTZXJ2aWNlLmV4ZWN1dGVGaWx0ZXIoZGF0YSwgdGhpcy5maWx0ZXJzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5maWx0ZXJzICYmIE9iamVjdC5rZXlzKHRoaXMuZmlsdGVycykubGVuZ3RoID4gMCAmJiAhaXNSZW1vdGVGaWx0ZXIgJiYgKCFjaGFuZ2UgfHwgY2hhbmdlICYmIGNoYW5nZS50eXBlICE9PSBDaGFuZ2VUeXBlLlNlbGVjdGlvbkNoYW5nZWQgJiYgY2hhbmdlLnR5cGUgIT09IENoYW5nZVR5cGUuR2xvYmFsU2VsZWN0aW9uQ2hhbmdlZCkpIHtcclxuICAgICAgaWYgKGRhdGEgJiYgZGF0YS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgLy8g5Yik5pat5b2T5YmN6KGM5piv5ZCm5Zyo6L+H5ruk5ZCO55qE5pWw5o2u5LitXHJcbiAgICAgICAgY29uc3Qgcm93ID0gKGRhdGEgYXMgW10pLmZpbmQoaXRlbSA9PiBpdGVtW3RoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleV0gPT09IHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKTtcclxuICAgICAgICBpZiAoIXJvdykge1xyXG4gICAgICAgICAgY29uc3QgZmlyc3RSb3dJZCA9IGRhdGFbMF1bdGhpcy5iaW5kaW5nTGlzdC5wcmltYXJ5S2V5XTtcclxuICAgICAgICAgIHRoaXMuYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGZpcnN0Um93SWQsIHRydWUsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyDmnKzlnLDov4fmu6TlrozkuYvlkI7msqHmnInmlbDmja7kuoZcclxuICAgICAgICAvLyB0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5iaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQobnVsbCwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgLy8g5Y2V6YCJ5pe25riF56m6aWRzXHJcbiAgICAgICAgaWYgKCF0aGlzLmdyaWQubXVsdGlTZWxlY3QpIHtcclxuICAgICAgICAgIHRoaXMuc2V0Q2hlY2tzKFtdKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuc2hvdWxkQ29tcG9uZW50VXBkYXRlKGNoYW5nZSwgZGF0YSk7XHJcbiAgICBpZiAoIXJlc3VsdC5yZXN1bHQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8gY29uc3QgbmV4dFByb3BzID0gdGhpcy5idWlsZFByb3BzKHJlc3VsdCk7XHJcbiAgICB0aGlzLnJlbmRlckdyaWQocmVzdWx0LnByb3BzKTtcclxuICAgIHRoaXMucHJvcHMgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHJlc3VsdC5wcm9wcykpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuLLmn5NncmlkXHJcbiAgICogQHBhcmFtIHByb3BzIOWxnuaAp1xyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVuZGVyR3JpZChwcm9wczogYW55KSB7XHJcbiAgICBjb25zdCB7IHBhZ2VJbmRleCwgcGFnZVNpemUsIHRvdGFsLCBwYWdpbmF0aW9uLCBkYXRhIH0gPSBwcm9wcztcclxuICAgIGNvbnN0IHZpcnR1YWxpemVkTG9hZCA9IHRoaXMuZ3JpZC52aXJ0dWFsaXplZEFzeW5jTG9hZCB8fCBmYWxzZTtcclxuICAgIHRoaXMuZ3JpZC50b3RhbCA9IHRvdGFsO1xyXG4gICAgdGhpcy5ncmlkLnBhZ2VTaXplID0gcGFnZVNpemU7XHJcbiAgICB0aGlzLmdyaWQucGFnZUluZGV4ID0gcGFnZUluZGV4O1xyXG4gICAgdGhpcy5ncmlkLnBhZ2luYXRpb24gPSBwYWdpbmF0aW9uO1xyXG4gICAgdGhpcy5ncmlkLmNvbnRyb2xQYWdpbmF0aW9uU3RhdGUgPSBmYWxzZTtcclxuICAgIC8vIHRoaXMuZW5kQ2VsbEVkaXQoKTtcclxuICAgIGlmIChwYWdlU2l6ZSA9PT0gMCkge1xyXG4gICAgICB0aGlzLmdyaWQucGFnaW5hdGlvbiA9IGZhbHNlO1xyXG4gICAgICB0aGlzLmdyaWQucGFnZUluZGV4ID0gMTtcclxuICAgICAgLy8g5L+u5aSN5LiN5YiG6aG15pe2Z3JpZOWQr+eUqOWIhue7hOS7jeS8mumHjeaWsOmCpuaVsOeahOmXrumimFxyXG4gICAgICAvLyB0aGlzLmdyaWQucGFnZVNpemUgPSB0b3RhbDtcclxuICAgIH1cclxuICAgIGlmICh2aXJ0dWFsaXplZExvYWQpIHtcclxuICAgICAgdGhpcy5ncmlkLmxvYWRWaXJ0dWFsRGF0YSh7XHJcbiAgICAgICAgaXRlbXM6IGRhdGEsXHJcbiAgICAgICAgcGFnZUluZGV4LFxyXG4gICAgICAgIHBhZ2VTaXplLFxyXG4gICAgICAgIHRvdGFsXHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5ncmlkLmxvYWREYXRhKGRhdGEpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDmnoTpgKDooajmoLzmlbDmja7lsZ7mgKdcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYnVpbGRQcm9wcyhkYXRhcz86IEFycmF5PGFueT4pIHtcclxuICAgIGxldCBkYXRhO1xyXG4gICAgaWYgKHR5cGVvZiAoZGF0YXMpICE9PSAndW5kZWZpbmVkJykge1xyXG4gICAgICBkYXRhID0gZGF0YXM7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBkYXRhID0gdGhpcy5iaW5kaW5nTGlzdC50b0pTT04oKTtcclxuICAgIH1cclxuICAgIC8vIGxldCBza2lwID0gMDtcclxuICAgIGxldCB7IHBhZ2VJbmRleCA9IDEsIHBhZ2VTaXplID0gMCB9ID0gdGhpcy5nZXRQYWdpbmdJbmZvKCkgfHwge307XHJcbiAgICBsZXQgeyB0b3RhbCA9IDAgfSA9IHRoaXMuZ2V0UGFnaW5nSW5mbygpIHx8IHt9O1xyXG4gICAgLy8gaWYgKHBhZ2VJbmRleCA+IDApIHtcclxuICAgIC8vICAgc2tpcCA9IChwYWdlSW5kZXggLSAxKSAqIHBhZ2VTaXplO1xyXG4gICAgLy8gfVxyXG4gICAgaWYgKHBhZ2VTaXplID09PSAwICYmIHRvdGFsID09PSAwKSB7XHJcbiAgICAgIHRvdGFsID0gZGF0YS5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICByZXR1cm4geyBkYXRhLCBwYWdlSW5kZXgsIHBhZ2VTaXplLCB0b3RhbCwgcGFnaW5hdGlvbjogcGFnZVNpemUgIT09IDAgfTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6h566XZ3JpZOeKtuaAgVxyXG4gICAqL1xyXG4gIHByaXZhdGUgYnVpbGRHcmlkUHJvcHMoKSB7XHJcbiAgICBjb25zdCBkYXRhID0gdGhpcy5ncmlkLmRhdGEgfHwgW107XHJcbiAgICBsZXQgc2tpcCA9IDA7XHJcbiAgICBjb25zdCB7IHBhZ2VJbmRleCA9IDEsIHBhZ2VTaXplID0gMCB9ID0geyBwYWdlSW5kZXg6IHRoaXMuZ3JpZC5wYWdlSW5kZXgsIHBhZ2VTaXplOiB0aGlzLmdyaWQucGFnZVNpemUgfTtcclxuICAgIGxldCB0b3RhbCA9IHRoaXMuZ3JpZC50b3RhbCB8fCAwO1xyXG4gICAgaWYgKHBhZ2VJbmRleCA+IDApIHtcclxuICAgICAgc2tpcCA9IChwYWdlSW5kZXggLSAxKSAqIHBhZ2VTaXplO1xyXG4gICAgfVxyXG4gICAgaWYgKHBhZ2VTaXplID09PSAwICYmIHRvdGFsID09PSAwKSB7XHJcbiAgICAgIHRvdGFsID0gZGF0YS5sZW5ndGg7XHJcbiAgICB9XHJcbiAgICByZXR1cm4geyBkYXRhLCBwYWdlSW5kZXgsIHBhZ2VTaXplLCB0b3RhbCwgcGFnaW5hdGlvbjogdGhpcy5ncmlkLnBhZ2luYXRpb24gfTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pWw5o2u5rqQ5Y+R55Sf5Y+Y5pu0XHJcbiAgICogQHBhcmFtIGNoYW5nZSDlj5jmm7RcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgb25CaW5kaW5nRGF0YUNoYW5nZShjaGFuZ2U6IENoYW5nZSkge1xyXG4gICAgdGhpcy51cGRhdGVEYXRhU291cmNlKGNoYW5nZSk7XHJcbiAgICB0aGlzLnVwZGF0ZVNlbGVjdGVkUm93KGNoYW5nZSk7XHJcbiAgICAvLyB0aGlzLnVwZGF0ZUdyaWQoY2hhbmdlKTtcclxuICAgIC8vIOS4jea4hemZpOWLvumAieihjO+8jOmcgOimgeS/neeVmeWLvumAieeKtuaAgVxyXG4gICAgLy8gdGhpcy5jbGVhckNoZWNrZWRSb3dzKGNoYW5nZSk7XHJcbiAgICB0aGlzLmVuZENlbGxFZGl0KGNoYW5nZSk7XHJcbiAgICAvLyDmm7TmlrDli77pgInooYzmlbDmja5cclxuICAgIHRoaXMudXBkYXRlQ2hlY2tlZFJvd3MoY2hhbmdlKTtcclxuICAgIHRoaXMudXBkYXRlRGF0YShjaGFuZ2UpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmm7TmlrDmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZURhdGFTb3VyY2UoY2hhbmdlOiBDaGFuZ2UpIHtcclxuICAgIC8qaWYgKGNoYW5nZSkge1xyXG4gICAgICBjb25zdCBpc01hdGNoID0gdGhpcy5jaGVja0lmQ2hhbmdlTWF0Y2hCaW5kaW5nUGF0aChjaGFuZ2UpO1xyXG4gICAgICBpZiAoIWlzTWF0Y2gpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH0qL1xyXG4gICAgaWYgKGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQpIHtcclxuICAgICAgdGhpcy5yZW5kZXJHcmlkU3ViamVjdC5uZXh0KGNoYW5nZSk7XHJcbiAgICB9IGVsc2UgaWYgKGNoYW5nZSAmJiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5HbG9iYWxTZWxlY3Rpb25DaGFuZ2VkKSkge1xyXG4gICAgICBpZiAodGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQgPT09ICh0aGlzLmdyaWQuc2VsZWN0ZWRSb3cgJiYgdGhpcy5ncmlkLnNlbGVjdGVkUm93LmlkKSAmJiB0aGlzLmdyaWQudG90YWwgPiAwKSB7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5iaW5kRGF0YShjaGFuZ2UpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmJpbmREYXRhKGNoYW5nZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8vIHByaXZhdGUgZW5kQ2VsbEVkaXQoKSB7XHJcbiAgLy8gICBjb25zdCBpc0VkaXRpbmcgPSB0aGlzLmdyaWQuaXNFZGl0aW5nKCk7XHJcbiAgLy8gICBpZiAoaXNFZGl0aW5nKSB7XHJcbiAgLy8gICAgIHRoaXMuZ3JpZC5lbmRDZWxsRWRpdCgpO1xyXG4gIC8vICAgfVxyXG4gIC8vIH1cclxuICBwcml2YXRlIGVuZENlbGxFZGl0KGNoYW5nZTogQ2hhbmdlKSB7XHJcbiAgICBjb25zdCBpc0VkaXRpbmcgPSB0aGlzLmdyaWQuaXNFZGl0aW5nKCk7XHJcbiAgICBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCAmJiBpc0VkaXRpbmcpIHtcclxuICAgICAgdGhpcy5ncmlkLmVuZENlbGxFZGl0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiuvue9rmdyaWTlvZPliY3pgInmi6nooYxcclxuICAgKiBAcGFyYW0gY2hhbmdlIOWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlU2VsZWN0ZWRSb3coY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBpZiAoIXRoaXMuYmluZGluZ0xpc3QgfHwgIXRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOmhteeggeWIh+aNouaXtuS4jeaJp+ihjOW9k+WJjeihjOWIh+aNolxyXG4gICAgaWYgKGNoYW5nZSAmJiBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5QYWdpbmF0aW9uSW5mb0NoYW5nZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLnJvd1NlbGVjdGVkRXZlbnRTdXNwZW5kID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHsgaWQ6IGdyaWRTZWxlY3RlZFJvd0lkID0gbnVsbCB9ID0gdGhpcy5ncmlkLnNlbGVjdGVkUm93IHx8IHt9O1xyXG4gICAgY29uc3QgY3VycmVudElkID0gdGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQ7XHJcbiAgICAvLyBncmlk5b2T5YmN6KGM5LiOYmluZ2luZ0xpc3TlvZPliY3ooYzkuIDoh7TvvIzml6DpobvliIfmjaJcclxuICAgIGlmIChncmlkU2VsZWN0ZWRSb3dJZCA9PT0gY3VycmVudElkKSB7XHJcbiAgICAgIGNvbnN0IGlzTWF0Y2ggPSBjaGFuZ2UgJiYgKGNoYW5nZS5wYXRoLnRvU3RyaW5nKCkgPT09IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSk7XHJcbiAgICAgIGlmIChjaGFuZ2UgJiYgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCAmJiBpc01hdGNoKSB7XHJcbiAgICAgICAgdGhpcy5ncmlkLmNsZWFyU2VsZWN0aW9ucygpO1xyXG4gICAgICAgIHRoaXMuZ3JpZC5zZWxlY3RSb3coY3VycmVudElkLCB0cnVlLCB0cnVlKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnNlbGVjdEdyaWRSb3codGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDms6jlhoxiaW5kaW5nZGF0YeWPmOWMluS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCkge1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50ID0gdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgdGhpcy5vbkJpbmRpbmdEYXRhQ2hhbmdlKGNoYW5nZSk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0Lm1lc3NhZ2VQaXBlLnN1YnNjcmliZShtZXNzYWdlID0+IHtcclxuICAgICAgaWYgKG1lc3NhZ2UgPT09ICdiaW5kRGF0YScpIHtcclxuICAgICAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5bmtohiaW5kaW5nZGF0YeWPmOWMluiuoumYhVxyXG4gICAqL1xyXG4gIHByaXZhdGUgdW5SZWdpc3RlckJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQoKSB7XHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50ICYmIHR5cGVvZiAodGhpcy5iaW5kaW5nRGF0YUNoYW5nZUV2ZW50LnVuc3Vic2NyaWJlKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmJpbmRpbmdEYXRhQ2hhbmdlRXZlbnQudW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6Kem5Y+R6aG156CB5YiH5o2i5LqL5Lu2XHJcbiAgICogQGRlc2NyaXB0aW9uIOacrOaWueazlemAgueUqOWcuuaZr+S7heS4uueItue6p2dyaWTmlbDmja7ph43mlrBsb2Fk77yM6ZyA6KaB6Kem5Y+R6K+lZ3JpZOmHjeaWsOWPluaVsOS9v+eUqOOAguWFtuS7luWcuuaZr+ivt+WLv+S9v+eUqFxyXG4gICAqIEBUT0RPOiDlvoXph43mnoTvvIzmjqfliLbkuIvnuqfmlbDmja7liqDovb3lupTor6Xkvp3otZbooajmoLznmoTooYzliIfmjaLkuovku7bvvIzkuLTml7bov5nmoLflpITnkIbvvIzlkI7nu63mj5DkvptMb2FkQ2hpbGRyZW7kuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIHVwZGF0ZURhdGEoY2hhbmdlPzogQ2hhbmdlKSB7XHJcbiAgICBpZiAoIShjaGFuZ2UgJiYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlNlbGVjdGlvbkNoYW5nZWQgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCkpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGg7XHJcbiAgICBjb25zdCBldmVudEJpbmRpbmdQYXRoID0gJy8nICsgY2hhbmdlLnBhdGguam9pbignLycpO1xyXG4gICAgY29uc3QgaXNSZXRyaWV2ZSA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LnBhcmFtcy5nZXQoJ3JldHJpZXZlaW5nJykgfHwgZmFsc2U7XHJcbiAgICBpZiAoY2hhbmdlLnBhdGgubGVuZ3RoIDwgMSB8fCBiaW5kaW5nUGF0aCA9PT0gJy8nIHx8IGJpbmRpbmdQYXRoID09PSBldmVudEJpbmRpbmdQYXRoIHx8ICFiaW5kaW5nUGF0aC5zdGFydHNXaXRoKGV2ZW50QmluZGluZ1BhdGgpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIHJldHJpZXZl5pe25Lya6Ieq5Yqo5bim5Zue5LuO6KGo56ys5LiA6aG15Y+K5LuO6KGo56ys5LiA6KGM55qE5LuO5LuO6KGo5pWw5o2u77yM5omA5Lul5LiN6ZyA6KaB5YaN5Y675Y2V54us6K+35rGCXHJcbiAgICBpZiAoaXNSZXRyaWV2ZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBmdWxsUGF0aHMgPSBFbnRpdHlQYXRoQ29udmVydGVyLnRvRW50aXR5UGF0aEFycmF5KHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLCB0aGlzLmJpbmRpbmdEYXRhKTtcclxuICAgIGNvbnN0IHBhdGhzID0gZnVsbFBhdGhzLnNsaWNlKDAsIGZ1bGxQYXRocy5sZW5ndGggLSAxKTtcclxuICAgIGNvbnN0IHBhcmVudCA9IHRoaXMuYmluZGluZ0xpc3QucGFyZW50O1xyXG4gICAgY29uc3QgcGFyZW50SWQgPSBwYXJlbnQgJiYgcGFyZW50W3BhcmVudC5wcmltYXJ5S2V5XTtcclxuICAgIC8vIOS4iue6p+ihqOayoeacieaVsOaNrlxyXG4gICAgaWYgKCFwYXJlbnRJZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDojrflj5Zub2RlY29kZVxyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIoaXRlbSA9PiBpdGVtKTtcclxuICAgIGxldCBub2RlQ29kZSA9IGJpbmRpbmdQYXRoc1tiaW5kaW5nUGF0aHMubGVuZ3RoIC0gMV07XHJcbiAgICBub2RlQ29kZSA9IG5vZGVDb2RlLnN1YnN0cigwLCBub2RlQ29kZS5sZW5ndGggLSAxKTtcclxuICAgIC8vIGNvbnN0IGNvbmZpZ1BhdGggPSBgLyR7bm9kZUNvZGV9XyR7cGFyZW50SWR9YDtcclxuICAgIGNvbnN0IGNvbmZpZ1BhdGggPSBgLyR7bm9kZUNvZGV9YDtcclxuICAgIGxldCB7IHBhZ2VJbmRleCA9IDEgfSA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0UGFnaW5hdGlvbkNvbmZpZ0J5UGF0aChjb25maWdQYXRoKSB8fCB7fTtcclxuICAgIGNvbnN0IHsgcGFnZVNpemUgPSAwIH0gPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldFBhZ2luYXRpb25Db25maWdCeVBhdGgoY29uZmlnUGF0aCkgfHwge307XHJcblxyXG4gICAgY29uc3QgcGFyZW50Tm9kZUNvZGUgPSBjaGFuZ2UucGF0aFtjaGFuZ2UucGF0aC5sZW5ndGggLSAxXTtcclxuICAgIGNvbnN0IHBhcmVudENvbmZpZ1BhdGggPSAnLycgKyBwYXJlbnROb2RlQ29kZS5zdWJzdHJpbmcoMCwgcGFyZW50Tm9kZUNvZGUubGVuZ3RoIC0gMSk7XHJcbiAgICBjb25zdCB7IHBhZ2VTaXplOiBwYXJlbnRQYWdlU2l6ZSA9IDAgfSA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0UGFnaW5hdGlvbkNvbmZpZ0J5UGF0aChwYXJlbnRDb25maWdQYXRoKSB8fCB7fTtcclxuICAgIGNvbnN0IGlzUXVlcnlDaGlsZCA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LnBhcmFtcy5nZXQoJ3F1ZXJ5Q2hpbGQnKSB8fCBmYWxzZTtcclxuICAgIGlmIChpc1F1ZXJ5Q2hpbGQpIHtcclxuICAgICAgLy8gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucGFyYW1zLmRlbGV0ZSgncXVlcnlDaGlsZCcpO1xyXG4gICAgICBwYWdlSW5kZXggPSAxO1xyXG4gICAgfVxyXG4gICAgLy8g5b2T5LiK57qn6KGo5YiH5o2i6KGM5pe2XHJcbiAgICBpZiAocGFyZW50UGFnZVNpemUgKyBwYWdlU2l6ZSAhPT0gMCkge1xyXG4gICAgICB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuc2V0KCdmb3JjZVF1ZXJ5Q2hpbGQnLCB0cnVlKTtcclxuICAgICAgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkucXVlcnlDaGlsZChwYXRocywgcGFnZUluZGV4LCBwYWdlU2l6ZSkucGlwZShcclxuICAgICAgICBmaW5hbGl6ZSgoKSA9PiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuZGVsZXRlKCdmb3JjZVF1ZXJ5Q2hpbGQnKSlcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLnVuUmVnaXN0ZXJCaW5kaW5nRGF0YUNoYW5nZUV2ZW50KCk7XHJcbiAgfVxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcbiAgLy8gI3JlZ2lvbiDkuovku7blj5HlsITlmahcclxuXHJcbiAgLyoqXHJcbiAgICog5Y+R5bCE6YCJ5Lit6KGM5YiH5o2i5LqL5Lu2XHJcbiAgICogQGRlc2NyaXB0aW9uIOe7n+S4gOWNlemAieaooeW8j+WSjOWkmumAieaooeW8j+S4i+eahOihjOWIh+aNouS6i+S7tlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBmaXJlU2VsZWN0ZWRSb3dDaGFuZ2Uoc2VsZWN0ZWRSb3dDb250ZXh0OiBhbnkpIHtcclxuICAgIHRoaXMuc2VsZWN0ZWRSb3dDaGFuZ2UuZW1pdChzZWxlY3RlZFJvd0NvbnRleHQpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuIXnqbrpgInlrprooYxcclxuICAgKiBAcGFyYW0gY2hhbmdlIOWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2xlYXJDaGVja2VkUm93cyhjaGFuZ2U6IENoYW5nZSkge1xyXG4gICAgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQgJiYgdGhpcy5ncmlkLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgIGNvbnN0IGlzTWF0Y2ggPSB0aGlzLmNoZWNrSWZDaGFuZ2VNYXRjaEJpbmRpbmdQYXRoKGNoYW5nZSk7XHJcbiAgICAgIGlmIChpc01hdGNoKSB7XHJcbiAgICAgICAgdGhpcy5zZXRDaGVja3MoW10pO1xyXG4gICAgICAgIGlmICh0eXBlb2YgKHRoaXMuZ3JpZC5jbGVhckNoZWNrZWRzKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgdGhpcy5ncmlkLmNsZWFyQ2hlY2tlZHMoKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG5cclxuICAvLyAjcmVnaW9uIOmAmuS/oVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5CaW5kaW5nTGlzdOeahOW9k+WJjeihjFxyXG4gICAqIEBwYXJhbSBpZCDlvZPliY3ooYzlhoXnoIFcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc2V0U2VsZWN0aW9uSWRUb0JpbmRpbmdEYXRhKGlkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIC8vIOWmguaenOW9k+WJjeihjOS4jeWtmOWcqO+8jOWImeW8uuWItuiuvue9rlxyXG4gICAgaWYgKCFpZCkge1xyXG4gICAgICB0aGlzLmJpbmRpbmdMaXN0LmN1cnJlbnRJZCA9IGlkO1xyXG4gICAgICBpZiAoIXRoaXMuZ3JpZC5tdWx0aVNlbGVjdCkge1xyXG4gICAgICAgIHRoaXMuc2V0Q2hlY2tzKFtdKTtcclxuICAgICAgfVxyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAodGhpcy5iaW5kaW5nTGlzdC5jdXJyZW50SWQgIT09IGlkKSB7XHJcbiAgICAgIHRoaXMuYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkLCB0cnVlKTtcclxuICAgIH1cclxuICAgIC8vIOWNlemAieaooeW8j+S4i+WwhuW9k+WJjeihjOiuvue9ruWIsGlkc1xyXG4gICAgaWYgKCF0aGlzLmdyaWQubXVsdGlTZWxlY3QpIHtcclxuICAgICAgdGhpcy5zZXRDaGVja3MoW2lkXSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlQ2hlY2tlZFJvd3MoY2hhbmdlczogQ2hhbmdlKSB7XHJcbiAgICBpZiAoY2hhbmdlcy50eXBlID09PSBDaGFuZ2VUeXBlLkxvYWQpIHtcclxuICAgICAgdGhpcy5zZXRDaGVja2VkUm93cygpO1xyXG4gICAgfSBlbHNlIGlmIChjaGFuZ2VzLnR5cGUgPT09IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkKSB7XHJcbiAgICAgIGNvbnN0IGlkcyA9IHRoaXMuZ2V0Q2hlY2tzKCk7XHJcbiAgICAgIGlmIChjaGFuZ2VzLmlkICYmIGlkcy5pbmNsdWRlcyhjaGFuZ2VzLmlkKSkge1xyXG4gICAgICAgIHRoaXMuc2V0Q2hlY2tlZFJvd3MoKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDorr7nva7pgInmi6nooYxcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc2V0Q2hlY2tzKGlkczogc3RyaW5nW10pIHtcclxuICAgIHRoaXMudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgnaWRzJywgaWRzKTtcclxuICAgIHRoaXMuc2V0Q2hlY2tlZFJvd3MoaWRzKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Yu+6YCJ6KGMaWTmlbDnu4RcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgZ2V0Q2hlY2tzKCk6IHN0cmluZ1tdIHtcclxuICAgIHJldHVybiB0aGlzLnZpZXdNb2RlbC51aVN0YXRlWydpZHMnXSB8fCBbXTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pu05paw5Yu+6YCJ6KGM5pWw5o2uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHNldENoZWNrZWRSb3dzKGlkcz86IHN0cmluZ1tdKSB7XHJcbiAgICAvLyDpq5jpgJ/mqKHlvI/ml7bkuI3lho3orr7nva5yb3dzXHJcbiAgICAvLyBpZiAodGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucnVuTW9kZSA9PT0gUnVuTW9kZS5oaWdoU3BlZWQpIHtcclxuICAgIC8vICAgcmV0dXJuO1xyXG4gICAgLy8gfVxyXG4gICAgaWYgKHR5cGVvZiBpZHMgPT09ICd1bmRlZmluZWQnKSB7XHJcbiAgICAgIGlkcyA9IHRoaXMudmlld01vZGVsLnVpU3RhdGVbJ2lkcyddIHx8IFtdO1xyXG4gICAgfVxyXG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGlkcykgfHwgaWRzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgLy8g5q2k5pe2aWRz5rKh5pyJ5YC877yMcm93c+S4reS5n+S4jeW6lOivpeaciVxyXG4gICAgICB0aGlzLnZpZXdNb2RlbC51aVN0YXRlLnNldFByb3BlcnR5VmFsdWUoJ3Jvd3MnLCBudWxsKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgbGV0IGxpc3QgPSBbXTtcclxuICAgIC8vIFRPRE/vvJpyb3dz5Lit5pWw5o2u5Zyo6auY6YCf5qih5byP5ZKM5pmu6YCa5qih5byP5LiL5aSa6K+t5a2X5q6155qE5YC86KGo546w5LiN5LiA6Ie077yM6auY6YCf5qih5byP5LiL5aSa6K+t5a2X5q615YC85Li65a+56LGh77yM5pmu6YCa5qih5byP5Li65b2T5YmN6K+t6KiA44CC5pqC5LiN5aSE55CG6auY6YCf5qih5byP5Zy65pmvXHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucnVuTW9kZSA9PT0gUnVuTW9kZS5oaWdoU3BlZWQpIHtcclxuICAgICAgbGlzdCA9IHRoaXMuZ3JpZC5kYXRhIHx8IFtdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGlzdCA9IHRoaXMuYmluZGluZ0xpc3QudG9KU09OKHtpZ25vcmVNdWx0aUxhbmdJbnB1dDogdHJ1ZX0pO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgcm93czogTWFwPHN0cmluZywgYW55PiA9IHRoaXMudmlld01vZGVsLnVpU3RhdGVbJ3Jvd3MnXSB8fCBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICBpZHMuZm9yRWFjaCgoaWQ6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtID0gbGlzdC5maW5kKGl0ZW0gPT4gaXRlbVt0aGlzLnByaW1hcnlLZXldID09PSBpZCk7XHJcbiAgICAgIGNvbnN0IG90aGVyUGFnZUl0ZW0gPSByb3dzLmdldChpZCk7XHJcbiAgICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgcmVzdWx0LnNldChpZCwgaXRlbSk7XHJcbiAgICAgIH0gZWxzZSBpZiAob3RoZXJQYWdlSXRlbSkge1xyXG4gICAgICAgIHJlc3VsdC5zZXQoaWQsIG90aGVyUGFnZUl0ZW0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHRoaXMudmlld01vZGVsLnVpU3RhdGUuc2V0UHJvcGVydHlWYWx1ZSgncm93cycsIHJlc3VsdCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmAieS4rWdyaWTooYxcclxuICAgKiBAcGFyYW0gaWQgaWRcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc2VsZWN0R3JpZFJvdyhpZDogYW55KSB7XHJcbiAgICB0aGlzLmdyaWQuc2VsZWN0Um93KGlkKTtcclxuICAgIHRoaXMuZ3JpZC5zY3JvbGxUb0N1cnJlbnRSb3coKTtcclxuICB9XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG4gIC8vICNyZWdpb24g5LqL5Lu25aSE55CG5ZmoXHJcblxyXG4gIC8qKlxyXG4gICAqIOmhteeggeWIh+aNouS6i+S7tlxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ3BhZ2VDaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgcGFnZUNoYW5nZWRIYW5kbGVyKGV2ZW50OiBhbnkpIHtcclxuICAgIGxldCB7IHBhZ2VJbmRleCwgcGFnZVNpemUgfSA9IGV2ZW50O1xyXG4gICAgaWYgKHBhZ2VJbmRleCA8IDEpIHtcclxuICAgICAgcGFnZUluZGV4ID0gMTtcclxuICAgIH1cclxuICAgIGNvbnN0IHNraXAgPSAocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZTtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0UGFnaW5nSW5mbyhza2lwLCBwYWdlU2l6ZSwgdGhpcy5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDooYzliIfmjaLkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBASG9zdExpc3RlbmVyKCdzZWxlY3RDaGFuZ2VkJywgWyckZXZlbnQnXSlcclxuICBwdWJsaWMgc2VsZWN0ZWRSb3dDaGFuZ2VkKGV2ZW50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgaW5kZXgsIGRhdGEgfSA9IGV2ZW50O1xyXG4gICAgY29uc3QgaWQgPSBkYXRhW3RoaXMucHJpbWFyeUtleV07XHJcbiAgICB0aGlzLnNldFNlbGVjdGlvbklkVG9CaW5kaW5nRGF0YShpZCk7XHJcbiAgICB0aGlzLmZpcmVTZWxlY3RlZFJvd0NoYW5nZShldmVudCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlj5bmtojooYzpgInmi6nkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBASG9zdExpc3RlbmVyKCd1blNlbGVjdCcsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIHVuU2VsZWN0ZWQoZXZlbnQ6IGFueSkge1xyXG4gICAgaWYgKCFldmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCB7IGRhdGEgPSB7fSB9ID0gZXZlbnQ7XHJcbiAgICBjb25zdCBpZCA9IGRhdGFbdGhpcy5wcmltYXJ5S2V5XTtcclxuICAgIGNvbnN0IGN1cnJlbnRJZCA9IHRoaXMuYmluZGluZ0xpc3QuY3VycmVudElkO1xyXG4gICAgaWYgKGlkID09PSBjdXJyZW50SWQpIHtcclxuICAgICAgdGhpcy5zZXRTZWxlY3Rpb25JZFRvQmluZGluZ0RhdGEobnVsbCk7XHJcbiAgICB9XHJcbiAgICAvLyB0aGlzLmZpcmVTZWxlY3RlZFJvd0NoYW5nZShldmVudCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWLvumAieihjOWPkeeUn+WPmOWMllxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqL1xyXG4gIEBIb3N0TGlzdGVuZXIoJ2NoZWNrZWRDaGFuZ2UnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBjaGVja2VkQ2hhbmdlZChldmVudDogYW55KSB7XHJcbiAgICBldmVudCA9IGV2ZW50IHx8IFtdO1xyXG4gICAgY29uc3QgaWRzID0gZXZlbnQubWFwKGl0ZW0gPT4gaXRlbS5pZCk7XHJcbiAgICB0aGlzLnNldENoZWNrcyhpZHMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDliIbpobXlpKflsI/lj5jmm7Tkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBASG9zdExpc3RlbmVyKCdwYWdlU2l6ZUNoYW5nZWQnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBwYWdlU2l6ZUNoYW5nZWQoZXZlbnQ6IGFueSkge1xyXG4gICAgY29uc3QgeyBwYWdlSW5kZXgsIHBhZ2VTaXplIH0gPSBldmVudDtcclxuICAgIGNvbnN0IHNraXAgPSAwOy8vKHBhZ2VJbmRleCAtIDEpICogcGFnZVNpemU7XHJcbiAgICAvLyB0aGlzLmJpbmRpbmdMaXN0LnNldFBhZ2luYXRpb25JbmZvKHNraXAsIHBhZ2VTaXplKTtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEuc2V0UGFnaW5nSW5mbyhza2lwLCBwYWdlU2l6ZSwgdGhpcy5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBncmlk5rua5Yqo5Yqg6L295pWw5o2uXHJcbiAgICogQHBhcmFtIGV2ZW50IGV2ZW50XHJcbiAgICovXHJcbiAgQEhvc3RMaXN0ZW5lcignc2Nyb2xsWUxvYWQnLCBbJyRldmVudCddKVxyXG4gIHB1YmxpYyBzY3JvbGxZKGV2ZW50OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgcGFnZXI6IHBhZ2VJbmRleCwgcGFnZVNpemUgfSA9IGV2ZW50O1xyXG4gICAgY29uc3Qgc2tpcCA9IChwYWdlSW5kZXggLSAxKSAqIHBhZ2VTaXplO1xyXG4gICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRQYWdpbmdJbmZvKHNraXAsIHBhZ2VTaXplLCB0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoKTtcclxuICB9XHJcbiAgQEhvc3RMaXN0ZW5lcignZmlsdGVyQ2hhbmdlZCcsIFsnJGV2ZW50J10pXHJcbiAgcHVibGljIGZpbHRlckNoYW5nZWQoZXZlbnQ6IGFueSkge1xyXG4gICAgdGhpcy5maWx0ZXJzID0gZXZlbnQ7XHJcbiAgfVxyXG4gIC8vICNlbmRyZWdpb25cclxuICBwcml2YXRlIGNoZWNrSWZDaGFuZ2VNYXRjaEJpbmRpbmdQYXRoKGNoYW5nZTogQ2hhbmdlKTogYm9vbGVhbiB7XHJcbiAgICBsZXQgaXNNYXRjaCA9IGZhbHNlO1xyXG4gICAgaWYgKCFjaGFuZ2UgfHwgIWNoYW5nZS5wYXRoKSB7XHJcbiAgICAgIHJldHVybiBpc01hdGNoO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNoYW5nZVBhdGhBcnJheSA9IGNoYW5nZS5wYXRoO1xyXG4gICAgaWYgKCFjaGFuZ2VQYXRoQXJyYXkpIHtcclxuICAgICAgcmV0dXJuIGlzTWF0Y2g7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCEodGhpcy5iaW5kaW5nRGF0YSkgJiYgISh0aGlzLmJpbmRpbmdEYXRhLmJpbmRpbmdQYXRoKSkge1xyXG4gICAgICByZXR1cm4gaXNNYXRjaDtcclxuICAgIH1cclxuICAgIGNvbnN0IGJpbmdkaW5nUGF0aEFycmF5ID0gdGhpcy5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aC5zcGxpdCgnLycpO1xyXG4gICAgaWYgKGJpbmdkaW5nUGF0aEFycmF5Lmxlbmd0aCA8PSAwKSB7XHJcbiAgICAgIHJldHVybiBpc01hdGNoO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChjaGFuZ2VQYXRoQXJyYXkubGVuZ3RoID09PSAwKSB7IC8vIOS4u+ihqFxyXG4gICAgICBpZiAodGhpcy5iaW5kaW5nRGF0YS5iaW5kaW5nUGF0aCA9PT0gJy8nKSB7XHJcbiAgICAgICAgaXNNYXRjaCA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoY2hhbmdlLnBhdGgubGVuZ3RoID09PSAxKSB7Ly8g5Li75LuO6KGoXHJcbiAgICAgIGlmIChiaW5nZGluZ1BhdGhBcnJheS5sZW5ndGggPT09IDIgJiYgYmluZ2RpbmdQYXRoQXJyYXlbMV0gPT09IGNoYW5nZS5wYXRoWzBdKSB7XHJcbiAgICAgICAgaXNNYXRjaCA9IHRydWU7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoY2hhbmdlLnBhdGgubGVuZ3RoID09PSAyKSB7IC8vIOS4u+S7juS7juihqFxyXG4gICAgICBpZiAoYmluZ2RpbmdQYXRoQXJyYXkubGVuZ3RoID09PSAzICYmIGJpbmdkaW5nUGF0aEFycmF5WzFdID09PSBjaGFuZ2UucGF0aFswXSAmJiBiaW5nZGluZ1BhdGhBcnJheVsyXSA9PT0gY2hhbmdlLnBhdGhbMV0pIHtcclxuICAgICAgICBpc01hdGNoID0gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBpc01hdGNoO1xyXG4gIH1cclxuXHJcbn1cclxuIl19