import { Injectable } from '@angular/core';
import { Repository, FrameContext } from '@farris/devkit';
import { switchMap } from 'rxjs/operators';
import { Observable, Subject } from 'rxjs';
import { of } from 'rxjs/observable/of';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
const POSTER = 'iframePoster';
const RECEIVER = 'iframeReceiver';
const REPOSITORY = 'repository';
// window.hash中funcId的属性名
const FUNC_ID = 'funcId=';
const TAB_ID = 'tabId=';
/**
 * ChangeItemService
 * @scope FrameComponent
 */
class ChangeItemService {
    /**
     * 构造函数
     */
    constructor(repository, frameContext, notifyService, languageService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.top = top;
        this.itemChangePoster = new Subject();
        this.itemChangeReceiver = new Subject();
    }
    init() {
        this.top['topMap'] = this.top['topMap'] || {};
        this.changeItem = this.changeItem.bind(this);
    }
    setBykey(key, value) {
        this.top['topMap'] = this.top['topMap'] || {};
        this.top['topMap'][this.tabId] = this.top['topMap'][this.tabId] || {};
        const topObject = this.top['topMap'][this.tabId];
        topObject[key] = value;
    }
    getByKey(key) {
        const topObject = this.top['topMap'][this.tabId] || {};
        return topObject[key];
    }
    // 建立iframe通信
    setIframePoster() {
        if (this.getByKey[POSTER]) {
            return;
        }
        else {
            this.setBykey(POSTER, this.itemChangePoster);
        }
    }
    getIframePoster() {
        this.itemChangePoster = this.getByKey(RECEIVER);
        this.setBykey(RECEIVER, this.itemChangeReceiver);
    }
    changeItem(type, id, parentId) {
        // 根据是否是弹出式卡片取不同的tabId
        const virtualRootFrameContext = this.frameContext.getVirtualRootFrameContext();
        const virtualRootComponent = virtualRootFrameContext.frameComponent;
        const isDialogComponent = virtualRootComponent['isDialogRootComponent'] || false;
        if (isDialogComponent) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
        }
        else {
            this.tabId = parentId;
        }
        this.itemChangeReceiver = this.getByKey(RECEIVER);
        return Observable.create((subscriber) => {
            this.getNextItemByCurrentId(id, type).subscribe((result) => {
                subscriber.next(result);
            });
        });
    }
    // 在list初始化时调用，缓存list的repository
    setRepository() {
        if (window.location.hash.includes(TAB_ID)) {
            this.tabId = window.location.hash.split(TAB_ID)[1].slice(0, window.location.hash.split(TAB_ID)[1].indexOf('&'));
            this.setBykey(REPOSITORY, this.frameContext.repository);
            this.setIframePoster();
            this.getIframePoster();
        }
    }
    // 根据类型和id获取相邻的数据
    getNextItemByCurrentId(currentId, type) {
        const repository = this.getByKey(REPOSITORY);
        const { pageSize, pageIndex, total } = repository.entityCollection.paginationInfo;
        let currentIdx = null;
        const list = repository.entityCollection.getAllEntities();
        list.find((x, idx) => {
            if (x.id === currentId) {
                currentIdx = idx;
            }
        });
        // 没有在列表中找到数据，返回空
        if (currentIdx === null) {
            // 新增取消当前无数据时点上一条下一条
            if (list.length) {
                switch (type) {
                    case 'prev':
                        return of(list[list.length - 1].id);
                        break;
                    case 'next':
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return of(null);
                        break;
                }
            }
            return of(null);
        }
        let nextIdx = currentIdx;
        switch (type) {
            case 'prev':
                // 当前页第一条,且非第一页,取上一页最后一条
                if (currentIdx === 0 && pageIndex !== 1) {
                    return repository.getEntities([], [], pageSize, pageIndex - 1).pipe(switchMap(result => {
                        nextIdx = pageSize - 1;
                        return of(result[nextIdx].id);
                    }));
                }
                // 第一页第一条，仍返回原有数据
                else if (currentIdx === 0 && pageIndex === 1) {
                    this.notifyService.info(this.languageService.changeToFirst, { hideTitle: true });
                    return of(list[nextIdx].id);
                }
                // 不是第一条，返回上一条
                else {
                    nextIdx = currentIdx - 1;
                    return of(list[nextIdx].id);
                }
                break;
            case 'next':
                // 超过当前页
                if (currentIdx + 1 + 1 > list.length) {
                    // 且非最后一条数据,取下一页第一条数据
                    if (((pageIndex - 1) * pageSize + currentIdx + 1) < total) {
                        return repository.getEntities([], [], pageSize, pageIndex + 1).pipe(switchMap(result => {
                            return of(result[0].id);
                        }));
                    }
                    // 最后一条数据，仍返回原数据
                    else {
                        this.notifyService.info(this.languageService.changeToLast, { hideTitle: true });
                        return of(list[nextIdx].id);
                    }
                }
                else {
                    nextIdx = currentIdx + 1;
                    return of(list[nextIdx].id);
                }
                break;
        }
    }
}
ChangeItemService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ChangeItemService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext },
    { type: FormNotifyService },
    { type: LanguageService }
];
export { ChangeItemService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlLWl0ZW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9jaGFuZ2UtaXRlbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUdwRCxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUM7QUFDOUIsTUFBTSxRQUFRLEdBQUcsZ0JBQWdCLENBQUM7QUFDbEMsTUFBTSxVQUFVLEdBQUcsWUFBWSxDQUFDO0FBQ2hDLHlCQUF5QjtBQUN6QixNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUM7QUFDMUIsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDO0FBQ3hCOzs7R0FHRztBQUNILE1BQ00saUJBQWlCO0lBT3JCOztPQUVHO0lBQ0gsWUFDVSxVQUEyQixFQUMzQixZQUEwQixFQUMxQixhQUFnQyxFQUNoQyxlQUFnQztRQUhoQyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixrQkFBYSxHQUFiLGFBQWEsQ0FBbUI7UUFDaEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBWm5DLFFBQUcsR0FBRyxHQUFHLENBQUM7UUFHVixxQkFBZ0IsR0FBRyxJQUFJLE9BQU8s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QUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO3FCQUM3QjtpQkFDRjtxQkFBTTtvQkFDTCxPQUFPLEdBQUcsVUFBVSxHQUFHLENBQUMsQ0FBQztvQkFDekIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUM3QjtnQkFDRCxNQUFNO1NBQ1Q7SUFDSCxDQUFDOzs7WUFwSkYsVUFBVTs7OztZQWxCRixVQUFVO1lBQUUsWUFBWTtZQUl4QixpQkFBaUI7WUFDakIsZUFBZTs7QUFzS3hCLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBGcmFtZUNvbnRleHR9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpYmVyIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL29mJztcclxuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XHJcblxyXG5cclxuY29uc3QgUE9TVEVSID0gJ2lmcmFtZVBvc3Rlcic7XHJcbmNvbnN0IFJFQ0VJVkVSID0gJ2lmcmFtZVJlY2VpdmVyJztcclxuY29uc3QgUkVQT1NJVE9SWSA9ICdyZXBvc2l0b3J5JztcclxuLy8gd2luZG93Lmhhc2jkuK1mdW5jSWTnmoTlsZ7mgKflkI1cclxuY29uc3QgRlVOQ19JRCA9ICdmdW5jSWQ9JztcclxuY29uc3QgVEFCX0lEID0gJ3RhYklkPSc7XHJcbi8qKlxyXG4gKiBDaGFuZ2VJdGVtU2VydmljZVxyXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuY2xhc3MgQ2hhbmdlSXRlbVNlcnZpY2Uge1xyXG5cclxuICBwdWJsaWMgdG9wID0gdG9wO1xyXG4gIHByaXZhdGUgZnVuY0lkOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSB0YWJJZDogc3RyaW5nO1xyXG4gIHB1YmxpYyBpdGVtQ2hhbmdlUG9zdGVyID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIHB1YmxpYyBpdGVtQ2hhbmdlUmVjZWl2ZXIgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZVxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgaW5pdCgpIHtcclxuICAgIHRoaXMudG9wWyd0b3BNYXAnXSA9IHRoaXMudG9wWyd0b3BNYXAnXSB8fCB7fTtcclxuICAgIHRoaXMuY2hhbmdlSXRlbSA9IHRoaXMuY2hhbmdlSXRlbS5iaW5kKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgc2V0QnlrZXkoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcclxuICAgIHRoaXMudG9wWyd0b3BNYXAnXSA9IHRoaXMudG9wWyd0b3BNYXAnXSB8fCB7fTtcclxuICAgIHRoaXMudG9wWyd0b3BNYXAnXVt0aGlzLnRhYklkXSA9IHRoaXMudG9wWyd0b3BNYXAnXVt0aGlzLnRhYklkXSB8fCB7fTtcclxuICAgIGNvbnN0IHRvcE9iamVjdCA9IHRoaXMudG9wWyd0b3BNYXAnXVt0aGlzLnRhYklkXTtcclxuICAgIHRvcE9iamVjdFtrZXldID0gdmFsdWU7XHJcbiAgfVxyXG5cclxuICBnZXRCeUtleShrZXk6IHN0cmluZykge1xyXG4gICAgY29uc3QgdG9wT2JqZWN0ID0gdGhpcy50b3BbJ3RvcE1hcCddW3RoaXMudGFiSWRdIHx8IHt9O1xyXG4gICAgcmV0dXJuIHRvcE9iamVjdFtrZXldO1xyXG4gIH1cclxuXHJcbiAgLy8g5bu656uLaWZyYW1l6YCa5L+hXHJcbiAgc2V0SWZyYW1lUG9zdGVyKCkge1xyXG4gICAgaWYgKHRoaXMuZ2V0QnlLZXlbUE9TVEVSXSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnNldEJ5a2V5KFBPU1RFUiwgdGhpcy5pdGVtQ2hhbmdlUG9zdGVyKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGdldElmcmFtZVBvc3RlcigpIHtcclxuICAgIHRoaXMuaXRlbUNoYW5nZVBvc3RlciA9IHRoaXMuZ2V0QnlLZXkoUkVDRUlWRVIpO1xyXG4gICAgdGhpcy5zZXRCeWtleShSRUNFSVZFUiwgdGhpcy5pdGVtQ2hhbmdlUmVjZWl2ZXIpO1xyXG4gIH1cclxuXHJcbiAgY2hhbmdlSXRlbSh0eXBlOiBzdHJpbmcsIGlkOiBzdHJpbmcsIHBhcmVudElkOiBzdHJpbmcpIHtcclxuICAgIC8vIOagueaNruaYr+WQpuaYr+W8ueWHuuW8j+WNoeeJh+WPluS4jeWQjOeahHRhYklkXHJcbiAgICBjb25zdCB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICBjb25zdCB2aXJ0dWFsUm9vdENvbXBvbmVudCA9IHZpcnR1YWxSb290RnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50O1xyXG4gICAgY29uc3QgaXNEaWFsb2dDb21wb25lbnQgPSB2aXJ0dWFsUm9vdENvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J10gfHwgZmFsc2U7XHJcbiAgICBpZiAoaXNEaWFsb2dDb21wb25lbnQpIHtcclxuICAgICAgdGhpcy50YWJJZCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KFRBQl9JRClbMV0uc2xpY2UoMCwgd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoVEFCX0lEKVsxXS5pbmRleE9mKCcmJykpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy50YWJJZCA9IHBhcmVudElkO1xyXG4gICAgfVxyXG4gICAgdGhpcy5pdGVtQ2hhbmdlUmVjZWl2ZXIgPSB0aGlzLmdldEJ5S2V5KFJFQ0VJVkVSKTtcclxuICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgoc3Vic2NyaWJlcjogU3Vic2NyaWJlcjxhbnk+KSA9PiB7XHJcbiAgICAgIHRoaXMuZ2V0TmV4dEl0ZW1CeUN1cnJlbnRJZChpZCwgdHlwZSkuc3Vic2NyaWJlKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAgIHN1YnNjcmliZXIubmV4dChyZXN1bHQpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8g5ZyobGlzdOWIneWni+WMluaXtuiwg+eUqO+8jOe8k+WtmGxpc3TnmoRyZXBvc2l0b3J5XHJcbiAgc2V0UmVwb3NpdG9yeSgpIHtcclxuICAgIGlmICh3aW5kb3cubG9jYXRpb24uaGFzaC5pbmNsdWRlcyhUQUJfSUQpKSB7XHJcbiAgICAgIHRoaXMudGFiSWQgPSB3aW5kb3cubG9jYXRpb24uaGFzaC5zcGxpdChUQUJfSUQpWzFdLnNsaWNlKDAsIHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KFRBQl9JRClbMV0uaW5kZXhPZignJicpKTtcclxuICAgICAgdGhpcy5zZXRCeWtleShSRVBPU0lUT1JZLCB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5KTtcclxuICAgICAgdGhpcy5zZXRJZnJhbWVQb3N0ZXIoKTtcclxuICAgICAgdGhpcy5nZXRJZnJhbWVQb3N0ZXIoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOagueaNruexu+Wei+WSjGlk6I635Y+W55u46YK755qE5pWw5o2uXHJcbiAgZ2V0TmV4dEl0ZW1CeUN1cnJlbnRJZChjdXJyZW50SWQ6IHN0cmluZywgdHlwZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCByZXBvc2l0b3J5ID0gdGhpcy5nZXRCeUtleShSRVBPU0lUT1JZKTtcclxuICAgIGNvbnN0IHsgcGFnZVNpemUsIHBhZ2VJbmRleCwgdG90YWwgfSA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5wYWdpbmF0aW9uSW5mbztcclxuICAgIGxldCBjdXJyZW50SWR4ID0gbnVsbDtcclxuICAgIGNvbnN0IGxpc3QgPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKTtcclxuICAgIGxpc3QuZmluZCgoeDogYW55LCBpZHg6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAoeC5pZCA9PT0gY3VycmVudElkKSB7XHJcbiAgICAgICAgY3VycmVudElkeCA9IGlkeDtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICAvLyDmsqHmnInlnKjliJfooajkuK3mib7liLDmlbDmja7vvIzov5Tlm57nqbpcclxuICAgIGlmIChjdXJyZW50SWR4ID09PSBudWxsKSB7XHJcbiAgICAgIC8vIOaWsOWinuWPlua2iOW9k+WJjeaXoOaVsOaNruaXtueCueS4iuS4gOadoeS4i+S4gOadoVxyXG4gICAgICBpZiAobGlzdC5sZW5ndGgpIHtcclxuICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgICAgIGNhc2UgJ3ByZXYnOlxyXG4gICAgICAgICAgICByZXR1cm4gb2YobGlzdFtsaXN0Lmxlbmd0aCAtIDFdLmlkKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICBjYXNlICduZXh0JzpcclxuICAgICAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmluZm8odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2hhbmdlVG9MYXN0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG9mKG51bGwpO1xyXG4gICAgfVxyXG4gICAgbGV0IG5leHRJZHggPSBjdXJyZW50SWR4O1xyXG4gICAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICAgIGNhc2UgJ3ByZXYnOlxyXG4gICAgICAgIC8vIOW9k+WJjemhteesrOS4gOadoSzkuJTpnZ7nrKzkuIDpobUs5Y+W5LiK5LiA6aG15pyA5ZCO5LiA5p2hXHJcbiAgICAgICAgaWYgKGN1cnJlbnRJZHggPT09IDAgJiYgcGFnZUluZGV4ICE9PSAxKSB7XHJcbiAgICAgICAgICByZXR1cm4gcmVwb3NpdG9yeS5nZXRFbnRpdGllcyhbXSwgW10sIHBhZ2VTaXplLCBwYWdlSW5kZXggLSAxKS5waXBlKFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICBuZXh0SWR4ID0gcGFnZVNpemUgLSAxO1xyXG4gICAgICAgICAgICAgIHJldHVybiBvZihyZXN1bHRbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g56ys5LiA6aG156ys5LiA5p2h77yM5LuN6L+U5Zue5Y6f5pyJ5pWw5o2uXHJcbiAgICAgICAgZWxzZSBpZiAoY3VycmVudElkeCA9PT0gMCAmJiBwYWdlSW5kZXggPT09IDEpIHtcclxuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNoYW5nZVRvRmlyc3QsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xyXG4gICAgICAgICAgcmV0dXJuIG9mKGxpc3RbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyDkuI3mmK/nrKzkuIDmnaHvvIzov5Tlm57kuIrkuIDmnaFcclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgIG5leHRJZHggPSBjdXJyZW50SWR4IC0gMTtcclxuICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgJ25leHQnOlxyXG4gICAgICAgIC8vIOi2hei/h+W9k+WJjemhtVxyXG4gICAgICAgIGlmIChjdXJyZW50SWR4ICsgMSArIDEgPiBsaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgLy8g5LiU6Z2e5pyA5ZCO5LiA5p2h5pWw5o2uLOWPluS4i+S4gOmhteesrOS4gOadoeaVsOaNrlxyXG4gICAgICAgICAgaWYgKCgocGFnZUluZGV4IC0gMSkgKiBwYWdlU2l6ZSArIGN1cnJlbnRJZHggKyAxKSA8IHRvdGFsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXBvc2l0b3J5LmdldEVudGl0aWVzKFtdLCBbXSwgcGFnZVNpemUsIHBhZ2VJbmRleCArIDEpLnBpcGUoc3dpdGNoTWFwKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKHJlc3VsdFswXS5pZCk7XHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIC8vIOacgOWQjuS4gOadoeaVsOaNru+8jOS7jei/lOWbnuWOn+aVsOaNrlxyXG4gICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5pbmZvKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNoYW5nZVRvTGFzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihsaXN0W25leHRJZHhdLmlkKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgbmV4dElkeCA9IGN1cnJlbnRJZHggKyAxO1xyXG4gICAgICAgICAgcmV0dXJuIG9mKGxpc3RbbmV4dElkeF0uaWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxufVxyXG5cclxuZXhwb3J0IHsgQ2hhbmdlSXRlbVNlcnZpY2UgfTtcclxuIl19