import * as tslib_1 from "tslib";
import { Directive, Input, Injector, NgZone, } from '@angular/core';
import { of } from 'rxjs';
import { BindingData, ViewModel } from '@farris/devkit';
import { DatagridComponent } from '@farris/ui-datagrid';
import { isNumber } from 'lodash-es';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { RuntimeStateService } from '@farris/ui-common';
import { DialogService } from '@farris/ui-dialog';
var EditableDirective = /** @class */ (function () {
    function EditableDirective(bindingData, viewModel, grid, dateService, injector, rts, dialogSer, ngZone) {
        this.bindingData = bindingData;
        this.viewModel = viewModel;
        this.grid = grid;
        this.dateService = dateService;
        this.injector = injector;
        this.rts = rts;
        this.dialogSer = dialogSer;
        this.ngZone = ngZone;
        /**
         * 编辑时取消分组
         */
        this.disableGroupOnEditing = true;
        /**
         * 临时记录grid分组字段
         */
        this.groupFields = [];
    }
    Object.defineProperty(EditableDirective.prototype, "bindingList", {
        get: function () {
            // 根实体
            if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
                return this.bindingData.list;
            }
            // 子实体
            var bindingPath = this.viewModel.bindingPath.substr(1);
            bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
            var paths = bindingPath.split('/');
            var filteredPaths = paths.filter(function (part) {
                return part !== '';
            });
            return this.bindingData.getValue(filteredPaths);
        },
        enumerable: true,
        configurable: true
    });
    EditableDirective.prototype.ngOnInit = function () {
        this.apply();
    };
    EditableDirective.prototype.ngOnChanges = function (changes) {
        this.apply();
    };
    EditableDirective.prototype.ngOnDestroy = function () {
        this.detach();
    };
    /**
     * 应用属性
     */
    EditableDirective.prototype.apply = function () {
        if (!this.grid) {
            return;
        }
        this.handleGroupStatus();
        if (this.gridEditable) {
            // if(!this.grid.remoteFilter){
            //   this.grid.clearCondition();
            // }
            this.grid.editable = true;
            this.grid.disableHeader(true);
            this.handleBeginEditEvent();
            this.handleAfterEditEvent();
            this.handleEndEditEvent();
        }
        else {
            this.grid.editable = false;
            this.grid.disableHeader(false);
            if (this.grid && typeof this.grid.sort === 'function' && this.grid.sortName) {
                this.grid.sort();
            }
            this.detach();
        }
    };
    /**
     * 编辑时取消分组
     */
    EditableDirective.prototype.handleGroupStatus = function () {
        if (this.disableGroupOnEditing === false) {
            return;
        }
        var groupField = this.grid && this.grid.groupField || null;
        if (groupField) {
            if (this.gridEditable) {
                this.groupFields = [groupField];
                this.grid.setGroupFields('');
            }
        }
        else {
            if (this.groupFields && this.groupFields.length > 0) {
                var groupField_1 = this.groupFields.pop();
                if (this.groupFields.length > 0) {
                    this.groupFields = [];
                }
                this.grid.setGroupFields(groupField_1);
            }
        }
    };
    /**
     * 处理开始编辑事件
     */
    EditableDirective.prototype.handleBeginEditEvent = function () {
        var _this = this;
        this.beginEditSubscription = this.grid.beginEdit.subscribe(function (e) {
            if (!e) {
                return;
            }
            var column = e.column;
            if (column && column.editor) {
                var editorInstance_1 = e.editor.componentRef.instance;
                if (!editorInstance_1 || !editorInstance_1.instance) {
                    return;
                }
                var mapFields_1 = editorInstance_1.instance.mapFields;
                if (column.editor.type === 'lookup' || column.editor.type === 'PersonnelSelector'
                    || column.editor.type === 'OrganizationSelector' || column.editor.type === 'external-integration' || 'EmployeeSelector' === column.editor.type || 'EmployeeOrgSelector' === column.editor.type) {
                    var subject = editorInstance_1.instance.selectedData;
                    if (subject) {
                        subject.subscribe(function (data) {
                            mapFields_1 = editorInstance_1.instance.mapFields;
                            _this.lookupMapping(data, mapFields_1);
                        });
                    }
                    var clearMappings = editorInstance_1.instance.clearMappings;
                    if (clearMappings) {
                        clearMappings.subscribe(function (result) {
                            var mapFields = Object.assign({}, editorInstance_1.instance.mapFields);
                            var value = result && result.value || null;
                            var binding = editorInstance_1.column && editorInstance_1.column.field;
                            var lookupTextField = editorInstance_1.instance.textField;
                            var data = {};
                            if (binding) {
                                var textFieldMapping = mapFields[lookupTextField];
                                if (textFieldMapping) {
                                    mapFields[lookupTextField] = textFieldMapping.split(',').filter(function (item) { return item !== binding; }).join(',');
                                }
                                var parentPaths = _this.getBindingPathArray();
                                _this.bindingData.setValue(parentPaths.concat(binding.split('.')), value, true, true);
                            }
                            // this.setValue(data, lookupTextField.split('.'), value);
                            Object.keys(mapFields).forEach(function (field) {
                                _this.setValue(data, field.split('.'), '');
                            });
                            _this.lookupMapping(data, mapFields, true);
                        });
                    }
                }
                if (column.editor.type === 'combo-lookup') {
                    editorInstance_1.instance.valueChange.subscribe(function (e) {
                        mapFields_1 = editorInstance_1.instance.mapFields;
                        _this.lookupMapping(e.selections || [], mapFields_1);
                    });
                }
                if (['combo-lookup', 'combolist', 'lookup', 'PersonnelSelector', 'OrganizationSelector', 'external-integration', 'EmployeeSelector', 'EmployeeOrgSelector'].includes(column.editor.type)) {
                    if (editorInstance_1.instance.clear && editorInstance_1.instance.clear.subscribe) {
                        editorInstance_1.instance.clear.subscribe(function () {
                            _this.lookupMapping(null, mapFields_1);
                        });
                    }
                }
                if (column.editor.type === 'combolist') {
                    if (mapFields_1) {
                        editorInstance_1.instance.valueChange.subscribe(function (e) {
                            var pathArr = _this.getBindingPathArray();
                            _this.viewModel.bindingData.setValue(pathArr.concat(mapFields_1.split('.')), editorInstance_1.instance.selectedValues, true, true);
                        });
                    }
                }
            }
        });
    };
    /**
     * 处理编辑事件
     */
    EditableDirective.prototype.handleAfterEditEvent = function () {
        var _this = this;
        this.grid.afterEdit = function (rowIndex, rowData, column, editor) {
            if (_this.dialogSer.hasDialogOpened()) {
                return of(false);
            }
            if (_this.rts) {
                // 帮助组件文本变化后去查询
                if (_this.rts.getFormState('lookup.pending')) {
                    return of(false);
                }
            }
            // 更新数据源
            if (!editor || !editor.formControl) {
                return of(false);
            }
            return of(true);
        };
    };
    /**
     * 处理结束编辑事件
     */
    EditableDirective.prototype.handleEndEditEvent = function () {
        var _this = this;
        this.endEditSubscription = this.grid && this.grid.endEdit && this.grid.endEdit.subscribe(function (event) {
            var _a = event || {}, _b = _a.value, value = _b === void 0 ? undefined : _b, _c = _a.column, column = _c === void 0 ? undefined : _c, _d = _a.rowData, rowData = _d === void 0 ? {} : _d;
            var primaryValue = rowData && rowData[_this.grid.idField] || null;
            _this.updateBindingData(value, column, primaryValue);
        });
    };
    /*
     * 给列表赋值 或给formcontrol赋值
     */
    EditableDirective.prototype.updateBindingData = function (value, column, primaryValue) {
        if (!column) {
            return;
        }
        var currentColumnType = column.dataType;
        // 同时判断gridOption的列对象
        var fieldPaths = column.field.split('.');
        // 是否为大数
        var isBigNumber = column && column.editor && column.editor.options && column.editor.options.bigNumber;
        // 存在行编辑器
        if (currentColumnType === 'date') {
            var result = void 0;
            if (value) {
                result = this.dateService.formatTo(value, 'yyyy-MM-dd');
            }
            else {
                result = value;
            }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), result);
        }
        else if (currentColumnType === 'datetime') {
            // if (!value) {
            //   value = '0001-01-01T00:00:00';
            // }
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
        else if (currentColumnType === 'number' && !isBigNumber) {
            if (value === null || value === undefined) {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), null);
            }
            else {
                this.updateBindingList(primaryValue, fieldPaths.join('.'), Number(value));
            }
        }
        else {
            this.updateBindingList(primaryValue, fieldPaths.join('.'), value);
        }
    };
    EditableDirective.prototype.updateBindingList = function (primaryValue, propertyName, value) {
        var viewModel = this.viewModel || null;
        if (!viewModel || !propertyName) {
            return;
        }
        // 更新主表部分行的字段
        var propertyNames = propertyName.split('.').filter(function (item) { return item; });
        var bindingPath = this.getBindingPathArray();
        // 取出来的一定是bindingList
        var list = this.bindingData.getValue(bindingPath);
        // 修改的是当前行
        if (list && primaryValue === list.currentItem.primaryKeyValue) {
            var paths = bindingPath.concat(propertyNames);
            this.bindingData.setValue(paths, value, true, true);
            return;
        }
        var bindingObject = this.bindingList.findById(primaryValue);
        if (!bindingObject) {
            return;
        }
        if (propertyNames.length < 2) {
            bindingObject.setValue(propertyName, value, true, true);
        }
        else {
            var targetBindingObject_1 = null;
            var fpaths = propertyNames.slice(0, propertyNames.length - 1);
            var targetPropertyName = propertyNames[propertyNames.length - 1];
            fpaths.forEach(function (prop) {
                targetBindingObject_1 = targetBindingObject_1 && targetBindingObject_1[prop] || bindingObject[prop];
            });
            // todo:需要添加值变化事件
            targetBindingObject_1.setValue(targetPropertyName, value, true, true);
        }
    };
    EditableDirective.prototype.detach = function () {
        if (this.beginEditSubscription && typeof this.beginEditSubscription.unsubscribe === 'function') {
            this.beginEditSubscription.unsubscribe();
        }
        if (this.endEditSubscription && typeof this.endEditSubscription.unsubscribe === 'function') {
            this.endEditSubscription.unsubscribe();
        }
    };
    //#region 帮助字段映射
    EditableDirective.prototype.lookupMapping = function (helpData, mapFields, asClear) {
        var _this = this;
        if (asClear === void 0) { asClear = false; }
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        var appContext = this.viewModel.frameContext.appContext;
        appContext.changeDetectionController.detach();
        var pathArr = this.getBindingPathArray();
        var helpFields = Object.keys(mapFields);
        var primaryInfo = this.getMapFieldsPrimaryKey(mapFields, pathArr);
        var primaryKeys = primaryInfo && primaryInfo.map(function (item) { return item.primaryKey; }) || [];
        var primaryFields = primaryInfo && primaryInfo.map(function (item) { return item.primaryField; }) || [];
        // 去重
        if (primaryKeys && primaryKeys.length > 0) {
            primaryKeys = tslib_1.__spread(new Set(primaryKeys));
            helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        }
        if (!helpData || asClear) {
            helpFields.reverse();
        }
        helpFields.forEach(function (f) {
            var val = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    val = helpData.map(function (h) {
                        return _this.getValue(f, h);
                    }).join(',');
                }
                else {
                    val = _this.getValue(f, helpData);
                }
            }
            var mappings = mapFields[f].split(',');
            var headMappings = mappings.filter(function (p) { return primaryFields.includes(p); });
            var leftMappings = mappings.filter(function (p) { return !primaryFields.includes(p); });
            if (!helpData) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            mappings.forEach(function (ff) {
                if (!helpData) {
                    _this.viewModel.bindingData.clearValue(pathArr.concat(ff.split('.')), true, true);
                }
                else {
                    _this.viewModel.bindingData.setValue(pathArr.concat(ff.split('.')), val, true, true);
                }
            });
        });
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    };
    EditableDirective.prototype.getValue = function (f, data) {
        var val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce(function (a, b) {
                return a[b];
            }, data);
        }
        return val;
    };
    EditableDirective.prototype.getBindingPathArray = function () {
        var path = this.viewModel.bindingPath;
        if (path) {
            return path.split('/').filter(function (n) { return n !== ''; });
        }
        return [];
    };
    EditableDirective.prototype.isNumberValue = function (field, data) {
        var currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    };
    //#endregion
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    EditableDirective.prototype.getMapFieldsPrimaryKey = function (mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        var results = [];
        // let primaryField = null;
        try {
            var entityTypeInfo_1 = this.viewModel.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach(function (key) {
                var mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    var mappings = mapField.split(',').filter(function (p) { return p; });
                    mappings.forEach(function (item) {
                        var paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        var propInfo = entityTypeInfo_1.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    };
    EditableDirective.prototype.setValue = function (target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce(function (prev, path) {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    };
    EditableDirective.prototype.sortMapFieldKeys = function (keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        // 过滤出非主键映射字段
        keys = keys.filter(function (p) { return !primaryKeys.includes(p); });
        return [].concat(primaryKeys).concat(keys);
    };
    EditableDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farris-datagrid-editable]'
                },] }
    ];
    /** @nocollapse */
    EditableDirective.ctorParameters = function () { return [
        { type: BindingData },
        { type: ViewModel },
        { type: DatagridComponent },
        { type: DateTimeHelperService },
        { type: Injector },
        { type: RuntimeStateService },
        { type: DialogService },
        { type: NgZone }
    ]; };
    EditableDirective.propDecorators = {
        gridEditable: [{ type: Input, args: ['farris-datagrid-editable',] }],
        disableGroupOnEditing: [{ type: Input, args: ['disableGroupOnEditing',] }]
    };
    return EditableDirective;
}());
export { EditableDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdGFibGUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZmFycmlzLWRhdGFncmlkL2VkaXRhYmxlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFBK0MsS0FBSyxFQUNDLFFBQVEsRUFBRSxNQUFNLEdBQy9FLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYyxFQUFFLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ3BELE9BQU8sRUFDTCxXQUFXLEVBQ21CLFNBQVMsRUFDeEMsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4QixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUV4RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVsRDtJQWtDRSwyQkFDUyxXQUF3QixFQUN4QixTQUFvQixFQUNwQixJQUF1QixFQUN0QixXQUFrQyxFQUNuQyxRQUFrQixFQUNqQixHQUF3QixFQUN6QixTQUF3QixFQUN4QixNQUFjO1FBUGQsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixTQUFJLEdBQUosSUFBSSxDQUFtQjtRQUN0QixnQkFBVyxHQUFYLFdBQVcsQ0FBdUI7UUFDbkMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNqQixRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQUN6QixjQUFTLEdBQVQsU0FBUyxDQUFlO1FBQ3hCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFsQ3ZCOztXQUVHO1FB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T25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSwgU2ltcGxlQ2hhbmdlcywgSW5wdXQsIEhvc3RMaXN0ZW5lciwgT3B0aW9uYWwsXHJcbiAgRXZlbnRFbWl0dGVyLCBPdXRwdXQsIEVsZW1lbnRSZWYsIENvbnRlbnRDaGlsZHJlbiwgUXVlcnlMaXN0LCBJbmplY3RvciwgTmdab25lLFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7XHJcbiAgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBDaGFuZ2UsIENoYW5nZVR5cGUsXHJcbiAgRnJhbWVFdmVudEJ1cywgVUlTdGF0ZSwgRm9ybSwgVmlld01vZGVsLCBEYXRhVHlwZUluZm8sIERhdGFQcm9wSW5mb1xyXG59IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWRhdGFncmlkJztcclxuXHJcbmltcG9ydCB7IGlzTnVtYmVyIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgRGF0ZVRpbWVIZWxwZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vZGF0ZSc7XHJcbmltcG9ydCB7IFJ1bnRpbWVTdGF0ZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbic7XHJcbmltcG9ydCB7IERpYWxvZ1NlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWRpYWxvZyc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXMtZGF0YWdyaWQtZWRpdGFibGVdJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgRWRpdGFibGVEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuICAvKipcclxuICAgKiBncmlk5piv5ZCm5Y+v5Lul57yW6L6RXHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXMtZGF0YWdyaWQtZWRpdGFibGUnKSBncmlkRWRpdGFibGU6IGJvb2xlYW47XHJcbiAgLyoqXHJcbiAgICog57yW6L6R5pe25Y+W5raI5YiG57uEXHJcbiAgICovXHJcbiAgQElucHV0KCdkaXNhYmxlR3JvdXBPbkVkaXRpbmcnKSBkaXNhYmxlR3JvdXBPbkVkaXRpbmc6IGJvb2xlYW4gPSB0cnVlO1xyXG5cclxuICBwcml2YXRlIGJlZ2luRWRpdFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgZW5kRWRpdFN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIC8qKlxyXG4gICAqIOS4tOaXtuiusOW9lWdyaWTliIbnu4TlrZfmrrVcclxuICAgKi9cclxuICBwcml2YXRlIGdyb3VwRmllbGRzOiBhbnlbXSA9IFtdO1xyXG4gIHByb3RlY3RlZCBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgLy8g5qC55a6e5L2TXHJcbiAgICBpZiAodGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09ICcvJyB8fCAhdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGgpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEubGlzdDtcclxuICAgIH1cclxuICAgIC8vIOWtkOWunuS9k1xyXG4gICAgbGV0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGguc3Vic3RyKDEpO1xyXG4gICAgYmluZGluZ1BhdGggPSBiaW5kaW5nUGF0aFswXS50b0xvd2VyQ2FzZSgpICsgYmluZGluZ1BhdGguc3Vic3RyaW5nKDEsIGJpbmRpbmdQYXRoLmxlbmd0aCk7XHJcbiAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XHJcblxyXG4gICAgY29uc3QgZmlsdGVyZWRQYXRocyA9IHBhdGhzLmZpbHRlcigocGFydDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHJldHVybiBwYXJ0ICE9PSAnJztcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0VmFsdWUoZmlsdGVyZWRQYXRocyk7XHJcbiAgfVxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHVibGljIGJpbmRpbmdEYXRhOiBCaW5kaW5nRGF0YSxcclxuICAgIHB1YmxpYyB2aWV3TW9kZWw6IFZpZXdNb2RlbCxcclxuICAgIHB1YmxpYyBncmlkOiBEYXRhZ3JpZENvbXBvbmVudCxcclxuICAgIHByaXZhdGUgZGF0ZVNlcnZpY2U6IERhdGVUaW1lSGVscGVyU2VydmljZSxcclxuICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICBwcml2YXRlIHJ0czogUnVudGltZVN0YXRlU2VydmljZSxcclxuICAgIHB1YmxpYyBkaWFsb2dTZXI6IERpYWxvZ1NlcnZpY2UsXHJcbiAgICBwdWJsaWMgbmdab25lOiBOZ1pvbmVcclxuICApIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuYXBwbHkoKTtcclxuICB9XHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gICAgdGhpcy5hcHBseSgpO1xyXG4gIH1cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuZGV0YWNoKCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOW6lOeUqOWxnuaAp1xyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwbHkoKSB7XHJcbiAgICBpZiAoIXRoaXMuZ3JpZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmhhbmRsZUdyb3VwU3RhdHVzKCk7XHJcbiAgICBpZiAodGhpcy5ncmlkRWRpdGFibGUpIHtcclxuICAgICAgLy8gaWYoIXRoaXMuZ3JpZC5yZW1vdGVGaWx0ZXIpe1xyXG4gICAgICAvLyAgIHRoaXMuZ3JpZC5jbGVhckNvbmRpdGlvbigpO1xyXG4gICAgICAvLyB9XHJcbiAgICAgIHRoaXMuZ3JpZC5lZGl0YWJsZSA9IHRydWU7XHJcbiAgICAgIHRoaXMuZ3JpZC5kaXNhYmxlSGVhZGVyKHRydWUpO1xyXG4gICAgICB0aGlzLmhhbmRsZUJlZ2luRWRpdEV2ZW50KCk7XHJcbiAgICAgIHRoaXMuaGFuZGxlQWZ0ZXJFZGl0RXZlbnQoKTtcclxuICAgICAgdGhpcy5oYW5kbGVFbmRFZGl0RXZlbnQoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZ3JpZC5lZGl0YWJsZSA9IGZhbHNlO1xyXG4gICAgICB0aGlzLmdyaWQuZGlzYWJsZUhlYWRlcihmYWxzZSk7XHJcbiAgICAgIGlmICh0aGlzLmdyaWQgJiYgdHlwZW9mIHRoaXMuZ3JpZC5zb3J0ID09PSAnZnVuY3Rpb24nICYmIHRoaXMuZ3JpZC5zb3J0TmFtZSkge1xyXG4gICAgICAgIHRoaXMuZ3JpZC5zb3J0KCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5kZXRhY2goKTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog57yW6L6R5pe25Y+W5raI5YiG57uEXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVHcm91cFN0YXR1cygpIHtcclxuICAgIGlmICh0aGlzLmRpc2FibGVHcm91cE9uRWRpdGluZyA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZ3JvdXBGaWVsZCA9IHRoaXMuZ3JpZCAmJiB0aGlzLmdyaWQuZ3JvdXBGaWVsZCB8fCBudWxsO1xyXG4gICAgaWYgKGdyb3VwRmllbGQpIHtcclxuICAgICAgaWYgKHRoaXMuZ3JpZEVkaXRhYmxlKSB7XHJcbiAgICAgICAgdGhpcy5ncm91cEZpZWxkcyA9IFtncm91cEZpZWxkXTtcclxuICAgICAgICB0aGlzLmdyaWQuc2V0R3JvdXBGaWVsZHMoJycpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAodGhpcy5ncm91cEZpZWxkcyAmJiB0aGlzLmdyb3VwRmllbGRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBjb25zdCBncm91cEZpZWxkID0gdGhpcy5ncm91cEZpZWxkcy5wb3AoKTtcclxuICAgICAgICBpZiAodGhpcy5ncm91cEZpZWxkcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICB0aGlzLmdyb3VwRmllbGRzID0gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZ3JpZC5zZXRHcm91cEZpZWxkcyhncm91cEZpZWxkKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDlpITnkIblvIDlp4vnvJbovpHkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZUJlZ2luRWRpdEV2ZW50KCkge1xyXG4gICAgdGhpcy5iZWdpbkVkaXRTdWJzY3JpcHRpb24gPSB0aGlzLmdyaWQuYmVnaW5FZGl0LnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgIGlmICghZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBjb2x1bW4gPSBlLmNvbHVtbjtcclxuICAgICAgaWYgKGNvbHVtbiAmJiBjb2x1bW4uZWRpdG9yKSB7XHJcbiAgICAgICAgY29uc3QgZWRpdG9ySW5zdGFuY2UgPSBlLmVkaXRvci5jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgICAgICAgaWYgKCFlZGl0b3JJbnN0YW5jZSB8fCAhZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UpIHtcclxuICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IG1hcEZpZWxkcyA9IGVkaXRvckluc3RhbmNlLmluc3RhbmNlLm1hcEZpZWxkcztcclxuICAgICAgICBpZiAoY29sdW1uLmVkaXRvci50eXBlID09PSAnbG9va3VwJyB8fCBjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdQZXJzb25uZWxTZWxlY3RvcidcclxuICAgICAgICAgIHx8IGNvbHVtbi5lZGl0b3IudHlwZSA9PT0gJ09yZ2FuaXphdGlvblNlbGVjdG9yJyB8fCBjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdleHRlcm5hbC1pbnRlZ3JhdGlvbicgfHwgJ0VtcGxveWVlU2VsZWN0b3InID09PSBjb2x1bW4uZWRpdG9yLnR5cGUgfHwgJ0VtcGxveWVlT3JnU2VsZWN0b3InID09PSBjb2x1bW4uZWRpdG9yLnR5cGUpIHtcclxuICAgICAgICAgIGNvbnN0IHN1YmplY3QgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5zZWxlY3RlZERhdGE7XHJcbiAgICAgICAgICBpZiAoc3ViamVjdCkge1xyXG4gICAgICAgICAgICBzdWJqZWN0LnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgbWFwRmllbGRzID0gZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UubWFwRmllbGRzO1xyXG4gICAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhkYXRhLCBtYXBGaWVsZHMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGNvbnN0IGNsZWFyTWFwcGluZ3MgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5jbGVhck1hcHBpbmdzO1xyXG4gICAgICAgICAgaWYgKGNsZWFyTWFwcGluZ3MpIHtcclxuICAgICAgICAgICAgY2xlYXJNYXBwaW5ncy5zdWJzY3JpYmUoKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgY29uc3QgbWFwRmllbGRzID0gT2JqZWN0LmFzc2lnbih7fSwgZWRpdG9ySW5zdGFuY2UuaW5zdGFuY2UubWFwRmllbGRzKTtcclxuICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHJlc3VsdCAmJiByZXN1bHQudmFsdWUgfHwgbnVsbDtcclxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nID0gZWRpdG9ySW5zdGFuY2UuY29sdW1uICYmIGVkaXRvckluc3RhbmNlLmNvbHVtbi5maWVsZDtcclxuICAgICAgICAgICAgICBjb25zdCBsb29rdXBUZXh0RmllbGQgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS50ZXh0RmllbGQ7XHJcbiAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHt9O1xyXG4gICAgICAgICAgICAgIGlmIChiaW5kaW5nKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0RmllbGRNYXBwaW5nID0gbWFwRmllbGRzW2xvb2t1cFRleHRGaWVsZF07XHJcbiAgICAgICAgICAgICAgICBpZiAodGV4dEZpZWxkTWFwcGluZykge1xyXG4gICAgICAgICAgICAgICAgICBtYXBGaWVsZHNbbG9va3VwVGV4dEZpZWxkXSA9IHRleHRGaWVsZE1hcHBpbmcuc3BsaXQoJywnKS5maWx0ZXIoaXRlbSA9PiBpdGVtICE9PSBiaW5kaW5nKS5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnRQYXRocyA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXJlbnRQYXRocy5jb25jYXQoYmluZGluZy5zcGxpdCgnLicpKSwgdmFsdWUsIHRydWUsIHRydWUpO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAvLyB0aGlzLnNldFZhbHVlKGRhdGEsIGxvb2t1cFRleHRGaWVsZC5zcGxpdCgnLicpLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgT2JqZWN0LmtleXMobWFwRmllbGRzKS5mb3JFYWNoKGZpZWxkID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWUoZGF0YSwgZmllbGQuc3BsaXQoJy4nKSwgJycpO1xyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhkYXRhLCBtYXBGaWVsZHMsIHRydWUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdjb21iby1sb29rdXAnKSB7XHJcbiAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS52YWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICBtYXBGaWVsZHMgPSBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5tYXBGaWVsZHM7XHJcbiAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhlLnNlbGVjdGlvbnMgfHwgW10sIG1hcEZpZWxkcyk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKFsnY29tYm8tbG9va3VwJywgJ2NvbWJvbGlzdCcsICdsb29rdXAnLCAnUGVyc29ubmVsU2VsZWN0b3InLCAnT3JnYW5pemF0aW9uU2VsZWN0b3InLCAnZXh0ZXJuYWwtaW50ZWdyYXRpb24nLCAnRW1wbG95ZWVTZWxlY3RvcicsICdFbXBsb3llZU9yZ1NlbGVjdG9yJ10uaW5jbHVkZXMoY29sdW1uLmVkaXRvci50eXBlKSkge1xyXG4gICAgICAgICAgaWYgKGVkaXRvckluc3RhbmNlLmluc3RhbmNlLmNsZWFyICYmIGVkaXRvckluc3RhbmNlLmluc3RhbmNlLmNsZWFyLnN1YnNjcmliZSkge1xyXG4gICAgICAgICAgICBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMubG9va3VwTWFwcGluZyhudWxsLCBtYXBGaWVsZHMpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjb2x1bW4uZWRpdG9yLnR5cGUgPT09ICdjb21ib2xpc3QnKSB7XHJcbiAgICAgICAgICBpZiAobWFwRmllbGRzKSB7XHJcbiAgICAgICAgICAgIGVkaXRvckluc3RhbmNlLmluc3RhbmNlLnZhbHVlQ2hhbmdlLnN1YnNjcmliZShlID0+IHtcclxuICAgICAgICAgICAgICBjb25zdCBwYXRoQXJyID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XHJcbiAgICAgICAgICAgICAgdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEuc2V0VmFsdWUocGF0aEFyci5jb25jYXQobWFwRmllbGRzLnNwbGl0KCcuJykpLCBlZGl0b3JJbnN0YW5jZS5pbnN0YW5jZS5zZWxlY3RlZFZhbHVlcywgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5aSE55CG57yW6L6R5LqL5Lu2XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBoYW5kbGVBZnRlckVkaXRFdmVudCgpIHtcclxuICAgIHRoaXMuZ3JpZC5hZnRlckVkaXQgPSAocm93SW5kZXgsIHJvd0RhdGEsIGNvbHVtbiwgZWRpdG9yKSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLmRpYWxvZ1Nlci5oYXNEaWFsb2dPcGVuZWQoKSkge1xyXG4gICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHRoaXMucnRzKSB7XHJcbiAgICAgICAgLy8g5biu5Yqp57uE5Lu25paH5pys5Y+Y5YyW5ZCO5Y675p+l6K+iXHJcbiAgICAgICAgaWYgKHRoaXMucnRzLmdldEZvcm1TdGF0ZSgnbG9va3VwLnBlbmRpbmcnKSkge1xyXG4gICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgLy8g5pu05paw5pWw5o2u5rqQXHJcbiAgICAgIGlmICghZWRpdG9yIHx8ICFlZGl0b3IuZm9ybUNvbnRyb2wpIHtcclxuICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH07XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhue7k+adn+e8lui+keS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFuZGxlRW5kRWRpdEV2ZW50KCkge1xyXG4gICAgdGhpcy5lbmRFZGl0U3Vic2NyaXB0aW9uID0gdGhpcy5ncmlkICYmIHRoaXMuZ3JpZC5lbmRFZGl0ICYmIHRoaXMuZ3JpZC5lbmRFZGl0LnN1YnNjcmliZSgoZXZlbnQ6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCB7IHZhbHVlID0gdW5kZWZpbmVkLCBjb2x1bW4gPSB1bmRlZmluZWQsIHJvd0RhdGEgPSB7fSB9ID0gZXZlbnQgfHwge307XHJcbiAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHJvd0RhdGEgJiYgcm93RGF0YVt0aGlzLmdyaWQuaWRGaWVsZF0gfHwgbnVsbDtcclxuICAgICAgdGhpcy51cGRhdGVCaW5kaW5nRGF0YSh2YWx1ZSwgY29sdW1uLCBwcmltYXJ5VmFsdWUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qXHJcbiAgICog57uZ5YiX6KGo6LWL5YC8IOaIlue7mWZvcm1jb250cm9s6LWL5YC8XHJcbiAgICovXHJcbiAgcHJpdmF0ZSB1cGRhdGVCaW5kaW5nRGF0YSh2YWx1ZTogYW55LCBjb2x1bW46IGFueSwgcHJpbWFyeVZhbHVlPzogYW55KSB7XHJcbiAgICBpZiAoIWNvbHVtbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBjdXJyZW50Q29sdW1uVHlwZSA9IGNvbHVtbi5kYXRhVHlwZTtcclxuICAgIC8vIOWQjOaXtuWIpOaWrWdyaWRPcHRpb27nmoTliJflr7nosaFcclxuXHJcbiAgICBjb25zdCBmaWVsZFBhdGhzID0gY29sdW1uLmZpZWxkLnNwbGl0KCcuJyk7XHJcbiAgICAvLyDmmK/lkKbkuLrlpKfmlbBcclxuICAgIGNvbnN0IGlzQmlnTnVtYmVyID0gY29sdW1uICYmIGNvbHVtbi5lZGl0b3IgJiYgY29sdW1uLmVkaXRvci5vcHRpb25zICYmIGNvbHVtbi5lZGl0b3Iub3B0aW9ucy5iaWdOdW1iZXI7XHJcbiAgICAvLyDlrZjlnKjooYznvJbovpHlmahcclxuICAgIGlmIChjdXJyZW50Q29sdW1uVHlwZSA9PT0gJ2RhdGUnKSB7XHJcbiAgICAgIGxldCByZXN1bHQ7XHJcbiAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgIHJlc3VsdCA9IHRoaXMuZGF0ZVNlcnZpY2UuZm9ybWF0VG8odmFsdWUsICd5eXl5LU1NLWRkJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgcmVzdWx0ID0gdmFsdWU7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWUsIGZpZWxkUGF0aHMuam9pbignLicpLCByZXN1bHQpO1xyXG4gICAgfSBlbHNlIGlmIChjdXJyZW50Q29sdW1uVHlwZSA9PT0gJ2RhdGV0aW1lJykge1xyXG4gICAgICAvLyBpZiAoIXZhbHVlKSB7XHJcbiAgICAgIC8vICAgdmFsdWUgPSAnMDAwMS0wMS0wMVQwMDowMDowMCc7XHJcbiAgICAgIC8vIH1cclxuICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChwcmltYXJ5VmFsdWUsIGZpZWxkUGF0aHMuam9pbignLicpLCB2YWx1ZSk7XHJcbiAgICB9IGVsc2UgaWYgKGN1cnJlbnRDb2x1bW5UeXBlID09PSAnbnVtYmVyJyAmJiAhaXNCaWdOdW1iZXIpIHtcclxuICAgICAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZSwgZmllbGRQYXRocy5qb2luKCcuJyksIG51bGwpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMudXBkYXRlQmluZGluZ0xpc3QocHJpbWFyeVZhbHVlLCBmaWVsZFBhdGhzLmpvaW4oJy4nKSwgTnVtYmVyKHZhbHVlKSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMudXBkYXRlQmluZGluZ0xpc3QocHJpbWFyeVZhbHVlLCBmaWVsZFBhdGhzLmpvaW4oJy4nKSwgdmFsdWUpO1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIHVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZTogYW55LCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgY29uc3Qgdmlld01vZGVsID0gdGhpcy52aWV3TW9kZWwgfHwgbnVsbDtcclxuICAgIGlmICghdmlld01vZGVsIHx8ICFwcm9wZXJ0eU5hbWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g5pu05paw5Li76KGo6YOo5YiG6KGM55qE5a2X5q61XHJcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWVzID0gcHJvcGVydHlOYW1lLnNwbGl0KCcuJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgLy8g5Y+W5Ye65p2l55qE5LiA5a6a5pivYmluZGluZ0xpc3RcclxuICAgIGNvbnN0IGxpc3QgPSB0aGlzLmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRoKSBhcyBCaW5kaW5nTGlzdDtcclxuICAgIC8vIOS/ruaUueeahOaYr+W9k+WJjeihjFxyXG4gICAgaWYgKGxpc3QgJiYgcHJpbWFyeVZhbHVlID09PSBsaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSkge1xyXG4gICAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRoLmNvbmNhdChwcm9wZXJ0eU5hbWVzKTtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRWYWx1ZShwYXRocywgdmFsdWUsIHRydWUsIHRydWUpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gdGhpcy5iaW5kaW5nTGlzdC5maW5kQnlJZChwcmltYXJ5VmFsdWUpO1xyXG4gICAgaWYgKCFiaW5kaW5nT2JqZWN0KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmIChwcm9wZXJ0eU5hbWVzLmxlbmd0aCA8IDIpIHtcclxuICAgICAgYmluZGluZ09iamVjdC5zZXRWYWx1ZShwcm9wZXJ0eU5hbWUsIHZhbHVlLCB0cnVlLCB0cnVlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGxldCB0YXJnZXRCaW5kaW5nT2JqZWN0ID0gbnVsbDtcclxuICAgICAgY29uc3QgZnBhdGhzID0gcHJvcGVydHlOYW1lcy5zbGljZSgwLCBwcm9wZXJ0eU5hbWVzLmxlbmd0aCAtIDEpO1xyXG4gICAgICBjb25zdCB0YXJnZXRQcm9wZXJ0eU5hbWUgPSBwcm9wZXJ0eU5hbWVzW3Byb3BlcnR5TmFtZXMubGVuZ3RoIC0gMV07XHJcbiAgICAgIGZwYXRocy5mb3JFYWNoKHByb3AgPT4ge1xyXG4gICAgICAgIHRhcmdldEJpbmRpbmdPYmplY3QgPSB0YXJnZXRCaW5kaW5nT2JqZWN0ICYmIHRhcmdldEJpbmRpbmdPYmplY3RbcHJvcF0gfHwgYmluZGluZ09iamVjdFtwcm9wXTtcclxuICAgICAgfSk7XHJcbiAgICAgIC8vIHRvZG866ZyA6KaB5re75Yqg5YC85Y+Y5YyW5LqL5Lu2XHJcbiAgICAgIHRhcmdldEJpbmRpbmdPYmplY3Quc2V0VmFsdWUodGFyZ2V0UHJvcGVydHlOYW1lLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZGV0YWNoKCkge1xyXG4gICAgaWYgKHRoaXMuYmVnaW5FZGl0U3Vic2NyaXB0aW9uICYmIHR5cGVvZiB0aGlzLmJlZ2luRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICB0aGlzLmJlZ2luRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbiAmJiB0eXBlb2YgdGhpcy5lbmRFZGl0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgIHRoaXMuZW5kRWRpdFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8jcmVnaW9uIOW4ruWKqeWtl+auteaYoOWwhFxyXG5cclxuICBwcml2YXRlIGxvb2t1cE1hcHBpbmcoaGVscERhdGE6IGFueSwgbWFwRmllbGRzOiBhbnksIGFzQ2xlYXI6IGJvb2xlYW4gPSBmYWxzZSkge1xyXG4gICAgaWYgKCFtYXBGaWVsZHMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g5YWz6Zet5Y+Y5pu05qOA5rWLXHJcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIuZGV0YWNoKCk7XHJcblxyXG4gICAgY29uc3QgcGF0aEFyciA9IHRoaXMuZ2V0QmluZGluZ1BhdGhBcnJheSgpO1xyXG4gICAgbGV0IGhlbHBGaWVsZHMgPSBPYmplY3Qua2V5cyhtYXBGaWVsZHMpO1xyXG4gICAgY29uc3QgcHJpbWFyeUluZm8gPSB0aGlzLmdldE1hcEZpZWxkc1ByaW1hcnlLZXkobWFwRmllbGRzLCBwYXRoQXJyKTtcclxuXHJcbiAgICBsZXQgcHJpbWFyeUtleXMgPSBwcmltYXJ5SW5mbyAmJiBwcmltYXJ5SW5mby5tYXAoaXRlbSA9PiBpdGVtLnByaW1hcnlLZXkpIHx8IFtdO1xyXG4gICAgY29uc3QgcHJpbWFyeUZpZWxkcyA9IHByaW1hcnlJbmZvICYmIHByaW1hcnlJbmZvLm1hcChpdGVtID0+IGl0ZW0ucHJpbWFyeUZpZWxkKSB8fCBbXTtcclxuICAgIC8vIOWOu+mHjVxyXG4gICAgaWYgKHByaW1hcnlLZXlzICYmIHByaW1hcnlLZXlzLmxlbmd0aCA+IDApIHtcclxuICAgICAgcHJpbWFyeUtleXMgPSBbLi4ubmV3IFNldChwcmltYXJ5S2V5cyldO1xyXG4gICAgICBoZWxwRmllbGRzID0gdGhpcy5zb3J0TWFwRmllbGRLZXlzKGhlbHBGaWVsZHMsIHByaW1hcnlLZXlzKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWhlbHBEYXRhIHx8IGFzQ2xlYXIpIHtcclxuICAgICAgaGVscEZpZWxkcy5yZXZlcnNlKCk7XHJcbiAgICB9XHJcbiAgICBoZWxwRmllbGRzLmZvckVhY2goKGY6IGFueSkgPT4ge1xyXG4gICAgICBsZXQgdmFsOiBhbnkgPSAnJztcclxuICAgICAgaWYgKGhlbHBEYXRhKSB7XHJcbiAgICAgICAgaWYgKGhlbHBEYXRhIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICAgIHZhbCA9IGhlbHBEYXRhLm1hcCgoaDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGYsIGgpO1xyXG4gICAgICAgICAgfSkuam9pbignLCcpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB2YWwgPSB0aGlzLmdldFZhbHVlKGYsIGhlbHBEYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGxldCBtYXBwaW5nczogYW55W10gPSBtYXBGaWVsZHNbZl0uc3BsaXQoJywnKTtcclxuICAgICAgY29uc3QgaGVhZE1hcHBpbmdzID0gbWFwcGluZ3MuZmlsdGVyKHAgPT4gcHJpbWFyeUZpZWxkcy5pbmNsdWRlcyhwKSk7XHJcbiAgICAgIGNvbnN0IGxlZnRNYXBwaW5ncyA9IG1hcHBpbmdzLmZpbHRlcihwID0+ICFwcmltYXJ5RmllbGRzLmluY2x1ZGVzKHApKTtcclxuICAgICAgaWYgKCFoZWxwRGF0YSkge1xyXG4gICAgICAgIG1hcHBpbmdzID0gW10uY29uY2F0KGxlZnRNYXBwaW5ncykuY29uY2F0KGhlYWRNYXBwaW5ncyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbWFwcGluZ3MgPSBbXS5jb25jYXQoaGVhZE1hcHBpbmdzKS5jb25jYXQobGVmdE1hcHBpbmdzKTtcclxuICAgICAgfVxyXG4gICAgICBtYXBwaW5ncy5mb3JFYWNoKChmZjogYW55KSA9PiB7XHJcbiAgICAgICAgaWYgKCFoZWxwRGF0YSkge1xyXG4gICAgICAgICAgdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEuY2xlYXJWYWx1ZShwYXRoQXJyLmNvbmNhdChmZi5zcGxpdCgnLicpKSwgdHJ1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhBcnIuY29uY2F0KGZmLnNwbGl0KCcuJykpLCB2YWwsIHRydWUsIHRydWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICAvLyDph43mlrDmiZPlvIDlj5jmm7Tmo4DmtYtcclxuICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5yZWF0dGFjaCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRWYWx1ZShmOiBzdHJpbmcsIGRhdGE6IGFueSkge1xyXG4gICAgbGV0IHZhbCA9ICcnO1xyXG4gICAgaWYgKGYuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICB2YWwgPSBkYXRhW2ZdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFsID0gZi5zcGxpdCgnLicpLnJlZHVjZSgoYSwgYikgPT4ge1xyXG4gICAgICAgIHJldHVybiBhW2JdO1xyXG4gICAgICB9LCBkYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdmFsO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRCaW5kaW5nUGF0aEFycmF5KCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHBhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcclxuICAgIGlmIChwYXRoKSB7XHJcbiAgICAgIHJldHVybiBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKG4gPT4gbiAhPT0gJycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc051bWJlclZhbHVlKGZpZWxkLCBkYXRhKSB7XHJcbiAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5nZXRWYWx1ZShmaWVsZCwgZGF0YSk7XHJcbiAgICByZXR1cm4gaXNOdW1iZXIoY3VycmVudFZhbCk7XHJcbiAgfVxyXG5cclxuICAvLyNlbmRyZWdpb25cclxuICAvKipcclxuICAgKiBcclxuICAgKiBAcGFyYW0gbWFwRmllbGRzICDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifSDmiJbogIUge2lkOid2aWQnLGNvZGU6J2NvZGUnLG5hbWU6J25hbWUnfVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHM6IGFueSwgYmluZGluZ1BhdGhzOiBzdHJpbmdbXSk6IEFycmF5PHsgcHJpbWFyeUtleTogc3RyaW5nLCBwcmltYXJ5RmllbGQ6IHN0cmluZyB9PiB7XHJcbiAgICBpZiAoIW1hcEZpZWxkcyB8fCBPYmplY3Qua2V5cyhtYXBGaWVsZHMpLmxlbmd0aCA8IDEpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHRzID0gW107XHJcbiAgICAvLyBsZXQgcHJpbWFyeUZpZWxkID0gbnVsbDtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8gPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcclxuICAgICAgT2JqZWN0LmtleXMobWFwRmllbGRzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IG1hcEZpZWxkID0gbWFwRmllbGRzW2tleV07XHJcbiAgICAgICAgaWYgKG1hcEZpZWxkICYmIHR5cGVvZiBtYXBGaWVsZCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgIGNvbnN0IG1hcHBpbmdzID0gbWFwRmllbGQuc3BsaXQoJywnKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgIG1hcHBpbmdzLmZvckVhY2goKGl0ZW06IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICBsZXQgcGF0aHMgPSBpdGVtLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGlmIChiaW5kaW5nUGF0aHMgJiYgYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICBwYXRocyA9IGJpbmRpbmdQYXRocy5jb25jYXQocGF0aHMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHByb3BJbmZvOiBEYXRhUHJvcEluZm8gPSBlbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb0J5UGF0aChwYXRocyk7XHJcbiAgICAgICAgICAgIGlmIChwcm9wSW5mbyAmJiBwcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvLnByaW1hcnkgPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICByZXN1bHRzLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgcHJpbWFyeUtleToga2V5LFxyXG4gICAgICAgICAgICAgICAgcHJpbWFyeUZpZWxkOiBpdGVtXHJcbiAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0cztcclxuICB9XHJcbiAgcHJpdmF0ZSBzZXRWYWx1ZSh0YXJnZXQ6IG9iamVjdCwgcGF0aHM6IHN0cmluZ1tdLCB2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPD0gMSkge1xyXG4gICAgICAgIHRhcmdldFtwYXRoc1swXV0gPSB2YWx1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBwYXRocy5zbGljZSgwLCAtMSkucmVkdWNlKChwcmV2LCBwYXRoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIShwcmV2Lmhhc093blByb3BlcnR5KHBhdGgpIHx8IHByZXZbJ19fcHJvdG9fXyddLmhhc093blByb3BlcnR5KHBhdGgpKSkge1xyXG4gICAgICAgICAgICBwcmV2W3BhdGhdID0ge307XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcHJldltwYXRoXTtcclxuICAgICAgICB9LCB0YXJnZXQpW3BhdGhzW3BhdGhzLmxlbmd0aCAtIDFdXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgc29ydE1hcEZpZWxkS2V5cyhrZXlzOiBzdHJpbmdbXSwgcHJpbWFyeUtleXM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgaWYgKCFwcmltYXJ5S2V5cyB8fCBwcmltYXJ5S2V5cy5sZW5ndGggPCAxIHx8ICFrZXlzIHx8IGtleXMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4ga2V5cztcclxuICAgIH1cclxuICAgIC8vIOi/h+a7pOWHuumdnuS4u+mUruaYoOWwhOWtl+autVxyXG4gICAga2V5cyA9IGtleXMuZmlsdGVyKHAgPT4gIXByaW1hcnlLZXlzLmluY2x1ZGVzKHApKTtcclxuICAgIHJldHVybiBbXS5jb25jYXQocHJpbWFyeUtleXMpLmNvbmNhdChrZXlzKTtcclxuICB9XHJcbn1cclxuIl19