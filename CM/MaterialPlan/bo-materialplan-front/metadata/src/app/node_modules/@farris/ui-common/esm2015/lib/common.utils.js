/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { ColumnFormatService } from '@farris/ui-common/column';
import * as i0 from "@angular/core";
export class CommonUtils {
    constructor() {
        this.cfs = null;
        if (!this.cfs) {
            this.cfs = new ColumnFormatService(null, null);
        }
    }
    /**
     * 获取对象中指定字段的值。 field: 可以为带有层级结构的路径，如： user.firstName | name 等
     * data: 获取字段的数据源，一般为JSON对象
     * safe: 为true, 将html字符进行转码输出，默认为 false
     * @param {?} field
     * @param {?} data
     * @param {?=} safe
     * @return {?}
     */
    getValue(field, data, safe = false) {
        if (!data) {
            return '';
        }
        /** @type {?} */
        let resultVal = '';
        if (field.indexOf('.') === -1 && data.hasOwnProperty(field)) {
            resultVal = data[field];
        }
        else {
            resultVal = field.split('.').reduce((/**
             * @param {?} obj
             * @param {?} key
             * @return {?}
             */
            (obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }), data);
        }
        if (safe) {
            return this.formatterValue(resultVal);
        }
        else {
            return resultVal;
        }
    }
    /**
     * 更新指定对象中某个字段的值
     * @param {?} obj 被更新对象
     * @param {?} field 被更新字段
     * @param {?} val 新值
     * @param {?=} nest 是否为嵌套，默认为 true
     * @return {?}
     */
    setValue(obj, field, val, nest = true) {
        if (field) {
            if (field.indexOf('.') > -1 && nest) {
                /** @type {?} */
                let lastObj = null;
                /** @type {?} */
                const _fields = field.split('.');
                _fields.reduce((/**
                 * @param {?} c
                 * @param {?} p
                 * @return {?}
                 */
                (c, p) => {
                    lastObj = c;
                    return c[p];
                }), obj);
                if (lastObj) {
                    lastObj[_fields.pop()] = val;
                }
            }
            else {
                obj[field] = val;
            }
        }
    }
    /**
     * @param {?} value
     * @param {?} enumData
     * @param {?} valueField
     * @return {?}
     */
    getEnumItem(value, enumData, valueField) {
        /** @type {?} */
        const item = enumData.find((/**
         * @param {?} n
         * @return {?}
         */
        n => n[valueField] == value));
        return item;
    }
    /**
     * @private
     * @param {?} value
     * @param {?} col
     * @return {?}
     */
    _getEnumTitleFromColumn(value, col) {
        /** @type {?} */
        const _col = (/** @type {?} */ (col));
        /** @type {?} */
        const formatter = (/** @type {?} */ (_col.formatter));
        if (formatter && typeof formatter === 'object') {
            if (formatter.type === 'enum' && formatter.options) {
                return this.getEnumTitleFromColumnOptions(value, formatter.options);
            }
        }
        return value;
    }
    /**
     * @param {?} col
     * @param {?} data
     * @return {?}
     */
    getEnumTitle(col, data) {
        /** @type {?} */
        const val = this.getValue(col.field, data);
        return this._getEnumTitleFromColumn(val, col);
    }
    /**
     * @param {?} value
     * @param {?} opts
     * @return {?}
     */
    getEnumTitleFromColumnOptions(value, opts) {
        const { data, valueField, textField } = opts;
        /** @type {?} */
        const item = this.getEnumItem(value, data, valueField);
        if (item) {
            return item[textField];
        }
        else {
            return value;
        }
    }
    /**
     * @param {?} str
     * @return {?}
     */
    escapeHtml(str) {
        if (str === null || str === undefined) {
            return '';
        }
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/\"/g, '&quot;')
            .replace(/\'/g, '&#39;')
            .replace(/\//g, '&#x2F;');
    }
    /**
     * @param {?} str
     * @return {?}
     */
    unescapeHtml(str) {
        if (str === null || str === undefined) {
            return '';
        }
        return str
            .replace(/&amp;/g, '&')
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x2F;/g, '/');
    }
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    formatterValue(val) {
        if (val === null || val === undefined || val === '') {
            return '';
        }
        if (typeof val === 'string') {
            return this.escapeHtml(val);
        }
        return val;
    }
    /**
     * 获取字符串在页面中的真实宽度
     * @param {?} txt
     * @param {?} font
     * @return {?}
     */
    getTextWidth(txt, font) {
        // const frag = document.createDocumentFragment();
        /** @type {?} */
        const canvas = document.createElement('canvas');
        /** @type {?} */
        const context = canvas.getContext('2d');
        context.font = font;
        /** @type {?} */
        const metrics = context.measureText(txt);
        return Math.round(metrics.width);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    removeStyleSheet(id) {
        /** @type {?} */
        const styleElement = document.querySelector('#' + id);
        if (styleElement) {
            styleElement.remove();
        }
    }
    /**
     * @param {?} styleSheetId
     * @return {?}
     */
    createStyleSheet(styleSheetId) {
        /** @type {?} */
        const htmlHead = document.querySelector('head');
        /** @type {?} */
        const styleEleId = styleSheetId;
        /** @type {?} */
        let styleElement = null;
        if (document.querySelector('#' + styleEleId)) {
            styleElement = document.querySelector('#' + styleEleId);
            styleElement.innerText = '';
        }
        else {
            styleElement = document.createElement('style');
            styleElement.id = styleEleId;
            htmlHead.appendChild(styleElement);
        }
        return styleElement;
    }
    /**
     * @param {?} styleSheetId
     * @return {?}
     */
    getStyleSheet(styleSheetId) {
        /** @type {?} */
        const styleSheets = (/** @type {?} */ (document.styleSheets));
        /** @type {?} */
        let styleSheet = null;
        for (const stylesheet of styleSheets) {
            if ((stylesheet.ownerNode || stylesheet['owningElement']).id === styleSheetId) {
                styleSheet = stylesheet;
                break;
            }
        }
        return styleSheet;
    }
    /**
     * 与现有样式合并
     * @param {?} rules
     * @param {?} styleSheet
     * @return {?}
     */
    appendCssRules(rules, styleSheet) {
        for (const rule of rules) {
            /** @type {?} */
            const ruleName = rule.slice(0, rule.indexOf('{'));
            /** @type {?} */
            const removedCssRule = this.removeCssRule(ruleName, styleSheet);
            /** @type {?} */
            let cssText = '';
            if (removedCssRule) {
                cssText += removedCssRule.cssText.slice(removedCssRule.cssText.indexOf('{') + 1, removedCssRule.cssText.indexOf('}'));
            }
            cssText += rule.slice(rule.indexOf('{') + 1, rule.indexOf('}')).replace(/"/g, '').replace(/,/g, ';') + ';';
            if (styleSheet.addRule) {
                styleSheet.addRule(ruleName, cssText, 0);
            }
            else {
                /** @type {?} */
                const _newRule = `${ruleName}{ ${cssText} }`;
                styleSheet.insertRule(_newRule, 0);
            }
        }
    }
    /**
     * 覆盖现有的样式
     * @param {?} rules
     * @param {?} styleSheet
     * @return {?}
     */
    appendCssRules2(rules, styleSheet) {
        for (const rule of rules) {
            /** @type {?} */
            const ruleName = rule.slice(0, rule.indexOf('{'));
            /** @type {?} */
            const removedCssRule = this.removeCssRule(ruleName, styleSheet);
            /** @type {?} */
            const cssText = rule.slice(rule.indexOf('{') + 1, rule.indexOf('}')).replace(/"/g, '').replace(/,/g, ';') + ';';
            if (styleSheet.addRule) {
                styleSheet.addRule(ruleName, cssText, 0);
            }
            else {
                /** @type {?} */
                const _newRule = `${ruleName}{ ${cssText} }`;
                styleSheet.insertRule(_newRule, 0);
            }
        }
    }
    /**
     * @param {?} ruleName
     * @param {?} styleSheet
     * @return {?}
     */
    getCssRule(ruleName, styleSheet) {
        /** @type {?} */
        const cssRules = (/** @type {?} */ ((styleSheet.cssRules || styleSheet.rules)));
        /** @type {?} */
        let r = null;
        for (const rule of cssRules) {
            if (rule.selectorText == ruleName) {
                r = rule;
            }
        }
        return r;
    }
    /**
     * @param {?} ruleName
     * @param {?} styleSheet
     * @return {?}
     */
    removeCssRule(ruleName, styleSheet) {
        /** @type {?} */
        const cssRules = (/** @type {?} */ ((styleSheet.cssRules || styleSheet.rules)));
        /** @type {?} */
        let ii = 0;
        /** @type {?} */
        let cssRule = false;
        do {
            cssRule = cssRules[ii];
            if (cssRule) {
                if (cssRule.selectorText.toLowerCase() == ruleName.toLowerCase()) {
                    if (styleSheet.cssRules) {
                        styleSheet.deleteRule(ii);
                    }
                    else {
                        styleSheet.removeRule(ii);
                    }
                    return cssRule;
                }
            }
            ii++;
        } while (cssRule);
    }
    /**
     * @param {?} val
     * @return {?}
     */
    isNullOrUndefined(val) {
        return val === null || val === undefined;
    }
    /**
     * @return {?}
     */
    isIE() {
        /** @type {?} */
        const uA = window.navigator.userAgent;
        return /msie\s|trident\/|edge\//i.test(uA) && !!('uniqueID' in document || 'documentMode' in document || ('ActiveXObject' in window) || 'MSInputMethodContext' in window);
    }
    /**
     * @param {?} sorts
     * @return {?}
     */
    buildSortString(sorts) {
        return this.cfs.buildSortString(sorts);
    }
    /**
     * @param {?} conditions
     * @return {?}
     */
    buildSqlWhere(conditions) {
        return this.cfs.buildSqlWhere(conditions);
    }
    /**
     * @return {?}
     */
    getBrowserType() {
        /** @type {?} */
        const ua = navigator.userAgent.toLowerCase();
        // 获取用户端信息
        /** @type {?} */
        const info = {
            ie: /msie/.test(ua) && !/opera/.test(ua),
            //  匹配IE浏览器
            op: /opera/.test(ua),
            //  匹配Opera浏览器
            sa: /version.*safari/.test(ua),
            // 匹配Safari浏览器
            ch: /chrome/.test(ua),
            //  匹配Chrome浏览器
            ff: /gecko/.test(ua) && !/webkit/.test(ua) // 匹配Firefox浏览器
        };
        return info;
    }
    /**
     * @return {?}
     */
    getFFVer() {
        /** @type {?} */
        const ua = navigator.userAgent;
        /** @type {?} */
        const b = ua.indexOf('Firefox/');
        if (b < 0) {
            return 0;
        }
        return parseFloat(ua.substring(b + 8, ua.lastIndexOf('\.')));
    }
    /**
     * @param {?} name
     * @param {?=} locationSearch
     * @return {?}
     */
    getQueryString(name, locationSearch = '') {
        /** @type {?} */
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        /** @type {?} */
        let _search = window.location.search;
        if (locationSearch) {
            _search = locationSearch;
        }
        /** @type {?} */
        var r = _search.substring(1).match(reg);
        if (r != null)
            return (r[2]);
        return null;
    }
    /**
     * 获取页面中body下所有元素的zIndex, 并返回下个浮层的新zindex
     * @param {?=} upperLayers
     * @return {?}
     */
    getFloatingLayerIndex(upperLayers = 1) {
        /** @type {?} */
        const overlays = Array.from(document.body.querySelectorAll('body>div, body>farris-dialog>.farris-modal,body>.farris-modal')).filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n)).map((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            return parseInt(window.getComputedStyle(n).zIndex, 10);
        })).filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n));
        /** @type {?} */
        const maxZindex = Math.max(...overlays);
        return maxZindex + upperLayers;
    }
}
CommonUtils.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */
CommonUtils.ctorParameters = () => [];
/** @nocollapse */ CommonUtils.ngInjectableDef = i0.defineInjectable({ factory: function CommonUtils_Factory() { return new CommonUtils(); }, token: CommonUtils, providedIn: "root" });
if (false) {
    /**
     * @type {?}
     * @private
     */
    CommonUtils.prototype.cfs;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLnV0aWxzLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vIiwic291cmNlcyI6WyJsaWIvY29tbW9uLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBa0QsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7QUFLL0csTUFBTSxPQUFPLFdBQVc7SUFFcEI7UUFEUSxRQUFHLEdBQXdCLElBQUksQ0FBQztRQUVwQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNYLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDbEQ7SUFDTCxDQUFDOzs7Ozs7Ozs7O0lBT0QsUUFBUSxDQUFDLEtBQWEsRUFBRSxJQUFTLEVBQUUsSUFBSSxHQUFHLEtBQUs7UUFDM0MsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNQLE9BQVEsRUFBRSxDQUFDO1NBQ2Q7O1lBQ0csU0FBUyxHQUFHLEVBQUU7UUFDbEIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDekQsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMzQjthQUFNO1lBQ0gsU0FBUyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTTs7Ozs7WUFBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtnQkFDN0MsSUFBSSxHQUFHLEVBQUU7b0JBQ0wsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ25CO3FCQUFNO29CQUNILE9BQU8sSUFBSSxDQUFDO2lCQUNmO1lBQ0wsQ0FBQyxHQUFFLElBQUksQ0FBQyxDQUFDO1NB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Z3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IERhdGFDb2x1bW4sIENvbHVtbkZvcm1hdHRlciwgRW51bUZvcm1hdE9wdGlvbnMsIENvbHVtbkZvcm1hdFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9jb2x1bW4nO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDb21tb25VdGlscyB7XHJcbiAgICBwcml2YXRlIGNmczogQ29sdW1uRm9ybWF0U2VydmljZSA9IG51bGw7XHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICBpZiAoIXRoaXMuY2ZzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2ZzID0gbmV3IENvbHVtbkZvcm1hdFNlcnZpY2UobnVsbCwgbnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W5a+56LGh5Lit5oyH5a6a5a2X5q6155qE5YC844CCIGZpZWxkOiDlj6/ku6XkuLrluKbmnInlsYLnuqfnu5PmnoTnmoTot6/lvoTvvIzlpoLvvJogdXNlci5maXJzdE5hbWUgfCBuYW1lIOetiVxyXG4gICAgICogZGF0YTog6I635Y+W5a2X5q6155qE5pWw5o2u5rqQ77yM5LiA6Iis5Li6SlNPTuWvueixoVxyXG4gICAgICogc2FmZTog5Li6dHJ1ZSwg5bCGaHRtbOWtl+espui/m+ihjOi9rOeggei+k+WHuu+8jOm7mOiupOS4uiBmYWxzZVxyXG4gICAgICovXHJcbiAgICBnZXRWYWx1ZShmaWVsZDogc3RyaW5nLCBkYXRhOiBhbnksIHNhZmUgPSBmYWxzZSkge1xyXG4gICAgICAgIGlmICghZGF0YSkge1xyXG4gICAgICAgICAgICByZXR1cm4gICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgcmVzdWx0VmFsID0gJyc7XHJcbiAgICAgICAgaWYgKGZpZWxkLmluZGV4T2YoJy4nKSA9PT0gLTEgJiYgZGF0YS5oYXNPd25Qcm9wZXJ0eShmaWVsZCkpIHtcclxuICAgICAgICAgICAgcmVzdWx0VmFsID0gZGF0YVtmaWVsZF07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0VmFsID0gZmllbGQuc3BsaXQoJy4nKS5yZWR1Y2UoKG9iaiwga2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAob2JqKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ialtrZXldO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSwgZGF0YSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc2FmZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5mb3JtYXR0ZXJWYWx1ZShyZXN1bHRWYWwpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHRWYWw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5pu05paw5oyH5a6a5a+56LGh5Lit5p+Q5Liq5a2X5q6155qE5YC8XHJcbiAgICAgKiBAcGFyYW0gb2JqIOiiq+abtOaWsOWvueixoVxyXG4gICAgICogQHBhcmFtIGZpZWxkIOiiq+abtOaWsOWtl+autVxyXG4gICAgICogQHBhcmFtIHZhbCDmlrDlgLxcclxuICAgICAqIEBwYXJhbSBuZXN0IOaYr+WQpuS4uuW1jOWll++8jOm7mOiupOS4uiB0cnVlXHJcbiAgICAgKi9cclxuICAgIHNldFZhbHVlKG9iajogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgZmllbGQ6IHN0cmluZywgdmFsOiBhbnksIG5lc3QgPSB0cnVlKSB7XHJcbiAgICAgICAgaWYgKGZpZWxkKSB7XHJcbiAgICAgICAgICAgIGlmIChmaWVsZC5pbmRleE9mKCcuJykgPiAtMSAmJiBuZXN0KSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgbGFzdE9iaiA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBfZmllbGRzID0gZmllbGQuc3BsaXQoJy4nKTtcclxuICAgICAgICAgICAgICAgIF9maWVsZHMucmVkdWNlKCAoYywgcCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGxhc3RPYmogPSBjO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBjW3BdO1xyXG4gICAgICAgICAgICAgICAgfSwgb2JqKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAobGFzdE9iaikge1xyXG4gICAgICAgICAgICAgICAgICAgIGxhc3RPYmpbX2ZpZWxkcy5wb3AoKV0gPSB2YWw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBvYmpbZmllbGRdID0gdmFsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldEVudW1JdGVtKHZhbHVlOiBhbnksIGVudW1EYXRhOiBhbnlbXSwgdmFsdWVGaWVsZCkge1xyXG4gICAgICAgIGNvbnN0IGl0ZW0gPSBlbnVtRGF0YS5maW5kKG4gPT4gblt2YWx1ZUZpZWxkXSA9PSB2YWx1ZSk7XHJcbiAgICAgICAgcmV0dXJuIGl0ZW07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZ2V0RW51bVRpdGxlRnJvbUNvbHVtbih2YWx1ZTogYW55LCBjb2w6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IF9jb2wgPSBjb2wgYXMgRGF0YUNvbHVtbjtcclxuICAgICAgICBjb25zdCBmb3JtYXR0ZXIgPSBfY29sLmZvcm1hdHRlciBhcyBDb2x1bW5Gb3JtYXR0ZXI7XHJcbiAgICAgICAgaWYgKGZvcm1hdHRlciAmJiB0eXBlb2YgZm9ybWF0dGVyID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICBpZiAoZm9ybWF0dGVyLnR5cGUgPT09ICdlbnVtJyAmJiBmb3JtYXR0ZXIub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RW51bVRpdGxlRnJvbUNvbHVtbk9wdGlvbnModmFsdWUsIGZvcm1hdHRlci5vcHRpb25zKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RW51bVRpdGxlKGNvbDogRGF0YUNvbHVtbiwgZGF0YTogYW55ICkge1xyXG4gICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZ2V0VmFsdWUoY29sLmZpZWxkLCBkYXRhKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0RW51bVRpdGxlRnJvbUNvbHVtbih2YWwsIGNvbCk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RW51bVRpdGxlRnJvbUNvbHVtbk9wdGlvbnModmFsdWU6IGFueSwgb3B0czogYW55KSB7XHJcbiAgICAgICAgY29uc3QgeyBkYXRhLCB2YWx1ZUZpZWxkLCB0ZXh0RmllbGQgfSA9IG9wdHM7XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuZ2V0RW51bUl0ZW0odmFsdWUsIGRhdGEsIHZhbHVlRmllbGQpO1xyXG4gICAgICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBpdGVtW3RleHRGaWVsZF07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBlc2NhcGVIdG1sKHN0cikge1xyXG4gICAgICAgIGlmIChzdHIgPT09IG51bGwgfHwgc3RyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuICAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0clxyXG4gICAgICAgIC5yZXBsYWNlKC8mL2csICcmYW1wOycpXHJcbiAgICAgICAgLnJlcGxhY2UoLzwvZywgJyZsdDsnKVxyXG4gICAgICAgIC5yZXBsYWNlKC8+L2csICcmZ3Q7JylcclxuICAgICAgICAucmVwbGFjZSgvXFxcIi9nLCAnJnF1b3Q7JylcclxuICAgICAgICAucmVwbGFjZSgvXFwnL2csICcmIzM5OycpXHJcbiAgICAgICAgLnJlcGxhY2UoL1xcLy9nLCAnJiN4MkY7Jyk7XHJcbiAgICB9XHJcblxyXG4gICAgdW5lc2NhcGVIdG1sKHN0cikge1xyXG4gICAgICAgIGlmIChzdHIgPT09IG51bGwgfHwgc3RyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuICAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHN0clxyXG4gICAgICAgIC5yZXBsYWNlKC8mYW1wOy9nLCAnJicpXHJcbiAgICAgICAgLnJlcGxhY2UoLyZsdDsvZywgJzwnKVxyXG4gICAgICAgIC5yZXBsYWNlKC8mZ3Q7L2csICc+JylcclxuICAgICAgICAucmVwbGFjZSgvJnF1b3Q7L2csICdcIicpXHJcbiAgICAgICAgLnJlcGxhY2UoLyYjMzk7L2csICdcXCcnKVxyXG4gICAgICAgIC5yZXBsYWNlKC8mI3gyRjsvZywgJy8nKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBmb3JtYXR0ZXJWYWx1ZSh2YWw6IGFueSkge1xyXG4gICAgICAgIGlmICh2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQgfHwgdmFsID09PSAnJykge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZW9mIHZhbCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXNjYXBlSHRtbCh2YWwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgIH1cclxuXHJcbiAgICAvKiog6I635Y+W5a2X56ym5Liy5Zyo6aG16Z2i5Lit55qE55yf5a6e5a695bqmICovXHJcbiAgICBnZXRUZXh0V2lkdGgodHh0OiBzdHJpbmcsIGZvbnQpIHtcclxuICAgICAgICAvLyBjb25zdCBmcmFnID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpO1xyXG4gICAgICAgIGNvbnN0IGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xyXG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgICAgICBjb250ZXh0LmZvbnQgPSBmb250O1xyXG4gICAgICAgIGNvbnN0IG1ldHJpY3MgPSBjb250ZXh0Lm1lYXN1cmVUZXh0KHR4dCk7XHJcbiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQobWV0cmljcy53aWR0aCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmVtb3ZlU3R5bGVTaGVldChpZDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3Qgc3R5bGVFbGVtZW50ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignIycgKyBpZCk7XHJcbiAgICAgICAgaWYgKHN0eWxlRWxlbWVudCkge1xyXG4gICAgICAgICAgICBzdHlsZUVsZW1lbnQucmVtb3ZlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZVN0eWxlU2hlZXQoc3R5bGVTaGVldElkOiBzdHJpbmcpOiBIVE1MU3R5bGVFbGVtZW50IHtcclxuICAgICAgICBjb25zdCBodG1sSGVhZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2hlYWQnKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3R5bGVFbGVJZCA9IHN0eWxlU2hlZXRJZDtcclxuICAgICAgICBsZXQgc3R5bGVFbGVtZW50ID0gbnVsbDtcclxuICAgICAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignIycgKyBzdHlsZUVsZUlkKSkge1xyXG4gICAgICAgICAgICBzdHlsZUVsZW1lbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjJyArIHN0eWxlRWxlSWQpO1xyXG4gICAgICAgICAgICBzdHlsZUVsZW1lbnQuaW5uZXJUZXh0ID0gJyc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgc3R5bGVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcclxuICAgICAgICAgICAgc3R5bGVFbGVtZW50LmlkID0gc3R5bGVFbGVJZDtcclxuICAgICAgICAgICAgaHRtbEhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVFbGVtZW50KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBzdHlsZUVsZW1lbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3R5bGVTaGVldChzdHlsZVNoZWV0SWQpIHtcclxuICAgICAgICBjb25zdCBzdHlsZVNoZWV0cyA9IGRvY3VtZW50LnN0eWxlU2hlZXRzIGFzIGFueTtcclxuICAgICAgICBsZXQgc3R5bGVTaGVldCA9IG51bGw7XHJcbiAgICAgICAgZm9yIChjb25zdCBzdHlsZXNoZWV0IG9mIHN0eWxlU2hlZXRzKSB7XHJcbiAgICAgICAgICAgIGlmICgoc3R5bGVzaGVldC5vd25lck5vZGUgfHwgc3R5bGVzaGVldFsnb3duaW5nRWxlbWVudCddKS5pZCA9PT0gc3R5bGVTaGVldElkKSB7XHJcbiAgICAgICAgICAgICAgICBzdHlsZVNoZWV0ID0gc3R5bGVzaGVldDtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gc3R5bGVTaGVldDtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5LiO546w5pyJ5qC35byP5ZCI5bm2ICovXHJcbiAgICBhcHBlbmRDc3NSdWxlcyhydWxlczogc3RyaW5nW10sIHN0eWxlU2hlZXQpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IHJ1bGUgb2YgcnVsZXMpIHtcclxuICAgICAgICAgICAgY29uc3QgcnVsZU5hbWUgPSBydWxlLnNsaWNlKDAsIHJ1bGUuaW5kZXhPZigneycpKTtcclxuICAgICAgICAgICAgY29uc3QgcmVtb3ZlZENzc1J1bGUgPSB0aGlzLnJlbW92ZUNzc1J1bGUocnVsZU5hbWUsIHN0eWxlU2hlZXQpO1xyXG4gICAgICAgICAgICBsZXQgY3NzVGV4dCA9ICcnO1xyXG4gICAgICAgICAgICBpZiAocmVtb3ZlZENzc1J1bGUpIHtcclxuICAgICAgICAgICAgICAgIGNzc1RleHQgKz0gcmVtb3ZlZENzc1J1bGUuY3NzVGV4dC5zbGljZShyZW1vdmVkQ3NzUnVsZS5jc3NUZXh0LmluZGV4T2YoJ3snKSArIDEsIHJlbW92ZWRDc3NSdWxlLmNzc1RleHQuaW5kZXhPZignfScpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjc3NUZXh0ICs9IHJ1bGUuc2xpY2UocnVsZS5pbmRleE9mKCd7JykgKyAxLCBydWxlLmluZGV4T2YoJ30nKSkucmVwbGFjZSgvXCIvZywgJycpLnJlcGxhY2UoLywvZywgJzsnKSArICc7JztcclxuICAgICAgICAgICAgaWYgKHN0eWxlU2hlZXQuYWRkUnVsZSkge1xyXG4gICAgICAgICAgICAgICAgc3R5bGVTaGVldC5hZGRSdWxlKHJ1bGVOYW1lLCBjc3NUZXh0LCAwKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IF9uZXdSdWxlID0gYCR7cnVsZU5hbWV9eyAke2Nzc1RleHR9IH1gO1xyXG4gICAgICAgICAgICAgICAgc3R5bGVTaGVldC5pbnNlcnRSdWxlKF9uZXdSdWxlLCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKiog6KaG55uW546w5pyJ55qE5qC35byPICovXHJcbiAgICBhcHBlbmRDc3NSdWxlczIocnVsZXM6IHN0cmluZ1tdLCBzdHlsZVNoZWV0KSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBydWxlIG9mIHJ1bGVzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJ1bGVOYW1lID0gcnVsZS5zbGljZSgwLCBydWxlLmluZGV4T2YoJ3snKSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZWRDc3NSdWxlID0gdGhpcy5yZW1vdmVDc3NSdWxlKHJ1bGVOYW1lLCBzdHlsZVNoZWV0KTtcclxuICAgICAgICAgICAgY29uc3QgY3NzVGV4dCA9IHJ1bGUuc2xpY2UocnVsZS5pbmRleE9mKCd7JykgKyAxLCBydWxlLmluZGV4T2YoJ30nKSkucmVwbGFjZSgvXCIvZywgJycpLnJlcGxhY2UoLywvZywgJzsnKSArICc7JztcclxuICAgICAgICAgICAgaWYgKHN0eWxlU2hlZXQuYWRkUnVsZSkge1xyXG4gICAgICAgICAgICAgICAgc3R5bGVTaGVldC5hZGRSdWxlKHJ1bGVOYW1lLCBjc3NUZXh0LCAwKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IF9uZXdSdWxlID0gYCR7cnVsZU5hbWV9eyAke2Nzc1RleHR9IH1gO1xyXG4gICAgICAgICAgICAgICAgc3R5bGVTaGVldC5pbnNlcnRSdWxlKF9uZXdSdWxlLCAwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRDc3NSdWxlKHJ1bGVOYW1lOiBzdHJpbmcsIHN0eWxlU2hlZXQpIHtcclxuICAgICAgICBjb25zdCBjc3NSdWxlcyA9IChzdHlsZVNoZWV0LmNzc1J1bGVzIHx8IHN0eWxlU2hlZXQucnVsZXMpIGFzIGFueTtcclxuICAgICAgICBsZXQgciA9IG51bGw7XHJcbiAgICAgICAgZm9yIChjb25zdCBydWxlIG9mIGNzc1J1bGVzKSB7XHJcbiAgICAgICAgICAgIGlmIChydWxlLnNlbGVjdG9yVGV4dCA9PSBydWxlTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgciA9IHJ1bGU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByO1xyXG4gICAgfVxyXG5cclxuICAgIHJlbW92ZUNzc1J1bGUocnVsZU5hbWU6IHN0cmluZywgc3R5bGVTaGVldCApIHtcclxuICAgICAgICBjb25zdCBjc3NSdWxlcyA9IChzdHlsZVNoZWV0LmNzc1J1bGVzIHx8IHN0eWxlU2hlZXQucnVsZXMpIGFzIGFueTtcclxuICAgICAgICBsZXQgaWkgPSAwO1xyXG4gICAgICAgIGxldCBjc3NSdWxlOiBhbnkgPSBmYWxzZTtcclxuICAgICAgICBkbyB7XHJcbiAgICAgICAgICAgIGNzc1J1bGUgPSBjc3NSdWxlc1tpaV07XHJcbiAgICAgICAgICAgIGlmIChjc3NSdWxlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoY3NzUnVsZS5zZWxlY3RvclRleHQudG9Mb3dlckNhc2UoKSA9PSBydWxlTmFtZS50b0xvd2VyQ2FzZSgpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0eWxlU2hlZXQuY3NzUnVsZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVTaGVldC5kZWxldGVSdWxlKGlpKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzdHlsZVNoZWV0LnJlbW92ZVJ1bGUoaWkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNzc1J1bGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWkrKztcclxuICAgICAgICB9IHdoaWxlIChjc3NSdWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBpc051bGxPclVuZGVmaW5lZCh2YWw6IGFueSkge1xyXG4gICAgICAgIHJldHVybiB2YWwgPT09IG51bGwgfHwgdmFsID09PSB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgaXNJRSgpIHtcclxuICAgICAgICBjb25zdCB1QSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50O1xyXG4gICAgICAgIHJldHVybiAvbXNpZVxcc3x0cmlkZW50XFwvfGVkZ2VcXC8vaS50ZXN0KHVBKSAmJiAhISgndW5pcXVlSUQnIGluIGRvY3VtZW50IHx8ICdkb2N1bWVudE1vZGUnIGluIGRvY3VtZW50IHx8ICgnQWN0aXZlWE9iamVjdCcgaW4gd2luZG93KSB8fCAnTVNJbnB1dE1ldGhvZENvbnRleHQnIGluIHdpbmRvdyk7XHJcbiAgICB9XHJcblxyXG4gICAgYnVpbGRTb3J0U3RyaW5nKHNvcnRzOiBhbnlbXSk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2ZzLmJ1aWxkU29ydFN0cmluZyhzb3J0cyk7XHJcbiAgICB9XHJcblxyXG4gICAgYnVpbGRTcWxXaGVyZShjb25kaXRpb25zOiBhbnlbXSk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuY2ZzLmJ1aWxkU3FsV2hlcmUoY29uZGl0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QnJvd3NlclR5cGUoKSB7XHJcbiAgICAgICAgY29uc3QgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7ICAvLyDojrflj5bnlKjmiLfnq6/kv6Hmga9cclxuICAgICAgICBjb25zdCBpbmZvID0ge1xyXG4gICAgICAgICAgICBpZSA6IC9tc2llLyAudGVzdCh1YSkgJiYgIS9vcGVyYS8gLnRlc3QodWEpLCAgLy8gIOWMuemFjUlF5rWP6KeI5ZmoXHJcbiAgICAgICAgICAgIG9wIDogL29wZXJhLyAudGVzdCh1YSksICAvLyAg5Yy56YWNT3BlcmHmtY/op4jlmahcclxuICAgICAgICAgICAgc2EgOiAvdmVyc2lvbi4qc2FmYXJpLy50ZXN0KHVhKSwgIC8vIOWMuemFjVNhZmFyaea1j+iniOWZqFxyXG4gICAgICAgICAgICBjaCA6IC9jaHJvbWUvLnRlc3QodWEpLCAgLy8gIOWMuemFjUNocm9tZea1j+iniOWZqFxyXG4gICAgICAgICAgICBmZiA6IC9nZWNrby8udGVzdCh1YSkgJiYgIS93ZWJraXQvLnRlc3QodWEpICAvLyDljLnphY1GaXJlZm945rWP6KeI5ZmoXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGluZm87XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGdldEZGVmVyKCkge1xyXG4gICAgICAgIGNvbnN0IHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDtcclxuICAgICAgICBjb25zdCBiID0gdWEuaW5kZXhPZignRmlyZWZveC8nKTtcclxuICAgICAgICBpZiAoYiA8IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBwYXJzZUZsb2F0ICh1YS5zdWJzdHJpbmcoYiArIDgsIHVhLmxhc3RJbmRleE9mKCdcXC4nKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFF1ZXJ5U3RyaW5nKG5hbWUsIGxvY2F0aW9uU2VhcmNoID0gJycpIHtcclxuICAgICAgICB2YXIgcmVnID0gbmV3IFJlZ0V4cChcIihefCYpXCIgKyBuYW1lICsgXCI9KFteJl0qKSgmfCQpXCIsIFwiaVwiKTtcclxuICAgICAgICBsZXQgX3NlYXJjaCA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7XHJcbiAgICAgICAgaWYgKGxvY2F0aW9uU2VhcmNoKSB7XHJcbiAgICAgICAgICAgIF9zZWFyY2ggPSBsb2NhdGlvblNlYXJjaDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdmFyIHIgPSBfc2VhcmNoLnN1YnN0cmluZygxKS5tYXRjaChyZWcpO1xyXG4gICAgICAgIGlmIChyICE9IG51bGwpIHJldHVybiAoclsyXSk7IHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog6I635Y+W6aG16Z2i5LitYm9keeS4i+aJgOacieWFg+e0oOeahHpJbmRleCwg5bm26L+U5Zue5LiL5Liq5rWu5bGC55qE5pawemluZGV4XHJcbiAgICAgKi9cclxuICAgIGdldEZsb2F0aW5nTGF5ZXJJbmRleCh1cHBlckxheWVycyA9IDEpIHtcclxuICAgICAgICBjb25zdCBvdmVybGF5cyA9IEFycmF5LmZyb20oZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKCdib2R5PmRpdiwgYm9keT5mYXJyaXMtZGlhbG9nPi5mYXJyaXMtbW9kYWwsYm9keT4uZmFycmlzLW1vZGFsJykpLmZpbHRlcihuID0+IG4pLm1hcChuID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKG4pLnpJbmRleCwgMTApO1xyXG4gICAgICAgIH0pLmZpbHRlcihuID0+IG4pO1xyXG4gICAgICAgIGNvbnN0IG1heFppbmRleCA9IE1hdGgubWF4KC4uLm92ZXJsYXlzKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIG1heFppbmRleCArIHVwcGVyTGF5ZXJzO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==