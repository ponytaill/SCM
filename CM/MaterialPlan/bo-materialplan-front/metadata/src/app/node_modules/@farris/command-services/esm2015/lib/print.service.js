import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { CloudprintService, OutputType, FileType, PrintType } from '@gsp-svc/cloudprint';
import { FormNotifyService } from './form-notify.service';
// tslint:disable: unified-signatures
// tslint:disable: max-line-length
/**
 * 打印服务
 * @Scope FrameComponent
 */
class PrintService {
    /**
     * 构造函数
     */
    constructor(msgService, languageService, printService, formNotifyService) {
        this.msgService = msgService;
        this.languageService = languageService;
        this.printService = printService;
        this.formNotifyService = formNotifyService;
    }
    /**
     * 打印单据
     * @param beMetaId BE元数据标识
     * @param bizBillId 业务单据标识
     */
    printSingle(beMetaId, bizBillId) {
        if (!bizBillId) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        return this.printArray(beMetaId, [bizBillId]);
    }
    /**
     * 打印单据（通过id或ids）
     * @param beMetaId be元数据Id
     * @param ids 单据id或ids
     */
    printByIds(beMetaId, ids) {
        if (!ids) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        const dataIds = ids.split(',').filter(item => item);
        return this.printArray(beMetaId, dataIds);
    }
    /**
     * 打印单据（带维度）
     * @param beMetaId be元数据Id
     * @param ids 单据id或ids
     * @param dim1 维度1值
     * @param dim2 维度2值
     * @param billCategoryId 单据类型Id
     */
    printByIdsWithDimension(beMetaId, ids, dim1, dim2, billCategoryId) {
        if (!ids) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        const dataIds = ids.split(',').filter(item => item);
        return this.printArray(beMetaId, dataIds, dim1, dim2, billCategoryId);
    }
    /**
     * 打印多个单据
     * @param beMetaId BE元数据标识
     * @param dataIds 业务单据标识数组
     * @param dim1 维度1
     * @param dim2 维度2
     * @param billCategoryId 业务单据类型Id
     */
    printArray(beMetaId, dataIds, dim1, dim2, billCategoryId) {
        if (!dataIds || dataIds.length === 0) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        const sourceOptions = this.buildSourceOptions({
            dataIds: dataIds,
            sourceId: beMetaId
        });
        const outputOptions = this.buildOutputOptions();
        if (typeof dim1 !== 'undefined') {
            sourceOptions.FirstDimensionVal = dim1;
        }
        if (typeof dim2 !== 'undefined') {
            sourceOptions.SecondDimensionVal = dim2;
        }
        if (typeof billCategoryId !== 'undefined') {
            sourceOptions.billCategoryId = billCategoryId;
        }
        return this.printService.outputBEData(sourceOptions, outputOptions, 'tab');
    }
    /**
     * 按照BE取数方式批量打印单据
     * @param beMetaId BE元数据标识
     * @param filterCondition 过滤条件
     * @param sortCondition 排序条件
     * @param includeChildData 包含子表数据
     */
    printMulti(beMetaId, filterCondition, sortCondition, includeChildData = true) {
        const entryFilter = { 'isUsePagination': false, 'filterConditions': [], 'sortConditions': [], 'pagination': null };
        if (filterCondition) {
            // 统一纠正最后一个过滤条件的Relation
            const filters = JSON.parse(filterCondition);
            if (filters && filters.length > 0) {
                filters[filters.length - 1].Relation = 0;
            }
            entryFilter.filterConditions = filters;
        }
        if (sortCondition) {
            entryFilter.sortConditions = JSON.parse(sortCondition);
        }
        // sfo:SourceFilterOptions
        const sourceFilterOptions = this.buildSourceFilterOptions({ sourceId: beMetaId, entryFilter, includeChildData });
        const outputOptions = this.buildOutputOptions();
        return this.printService.outputBEDataWithFilter(sourceFilterOptions, outputOptions, 'tab');
    }
    /**
     * 按照BE取数方式批量打印单据(带维度)
     * @param beMetaId BE元数据标识
     * @param filterCondition 过滤条件
     * @param sortCondition 排序条件
     * @param dim1 维度1value
     * @param dim2 维度2value
     * @param billCategoryId 业务单据类型Id
     * @param includeChildData 包含子表数据
     */
    printMultiWithDimension(beMetaId, filterCondition, sortCondition, dim1, dim2, billCategoryId, includeChildData = true) {
        const entryFilter = { 'isUsePagination': false, 'filterConditions': [], 'sortConditions': [], 'pagination': null };
        if (filterCondition) {
            // 统一纠正最后一个过滤条件的Relation
            const filters = JSON.parse(filterCondition);
            if (filters && filters.length > 0) {
                filters[filters.length - 1].Relation = 0;
            }
            entryFilter.filterConditions = filters;
        }
        if (sortCondition) {
            entryFilter.sortConditions = JSON.parse(sortCondition);
        }
        const sfo = this.buildSourceFilterOptions({ sourceId: beMetaId, entryFilter, includeChildData });
        if (typeof dim1 !== 'undefined') {
            sfo.FirstDimensionVal = dim1;
        }
        if (typeof dim2 !== 'undefined') {
            sfo.SecondDimensionVal = dim2;
        }
        if (typeof billCategoryId !== 'undefined') {
            sfo.billCategoryId = billCategoryId;
        }
        const outputOptions = this.buildOutputOptions();
        return this.printService.outputBEDataWithFilter(sfo, outputOptions, 'tab');
    }
    /**
     * 构造SourceOptions
     * @param options options
     */
    buildSourceOptions(options) {
        const so = {
            DataIds: options && options.dataIds || undefined,
            SourceId: options && options.sourceId || undefined,
            FirstDimensionVal: options && options.dim1 || undefined,
            SecondDimensionVal: options && options.dim2 || undefined,
            RetrieveParam: options && options.retrieveParam || undefined,
            FormatId: options && options.formatId || undefined,
            billCategoryId: options && options.billCategoryId || undefined,
            ServiceUnit: options && options.serviceUnit || undefined,
            currentPage: options && options.currentPage || undefined,
            pageRowCount: options && options.pageRowCount || undefined,
            queryType: options && options.queryType || undefined,
            queryServiceId: options && options.queryServiceId || undefined,
            queryParam: options && options.queryParam || undefined
        };
        return so;
    }
    /**
     * 构造OutputOptions
     * @param options options
     */
    buildOutputOptions(options) {
        const oo = {
            OutputType: options && options.outputType || OutputType.PRINT,
            FileType: options && options.fileType || FileType.Html5,
            Path: options && options.path || undefined,
            DeviceId: options && options.deviceId || undefined,
            printJob: options && options.printJob || undefined,
            printerName: options && options.printerName || undefined,
            printSetting: options && options.printSetting || undefined,
            printType: options && options.printType || PrintType.Form
        };
        return oo;
    }
    /**
     * 构造SourceFilterOptions
     * @param options options
     */
    buildSourceFilterOptions(options) {
        const entryFilter = { 'isUsePagination': false, 'filterConditions': [], 'sortConditions': [], 'pagination': null };
        const sfo = {
            SourceId: options.sourceId,
            EntityFilter: options && options.entryFilter || entryFilter,
            FirstDimensionVal: options && options.dim1 || undefined,
            SecondDimensionVal: options && options.dim2 || undefined,
            FormatId: options && options.formatId || undefined,
            ServiceUnit: options && options.serviceUnit || undefined,
            billCategoryId: options && options.billCategoryId || undefined,
            currentPage: options && options.currentPage || undefined,
            pageRowCount: options && options.pageRowCount || undefined,
            queryParam: options && options.queryParam || undefined,
            queryServiceId: options && options.queryServiceId || undefined,
            queryType: options && options.queryType || undefined,
            includeChildData: options && options.hasOwnProperty('includeChildData') ? options.includeChildData : true
        };
        return sfo;
    }
    /**
     * 展示错误消息
     * @param message 错误消息
     */
    showWarning(message) {
        if (this.notifyService) {
            this.notifyService.warning(message, { hideTitle: true });
        }
        else if (this.msgService) {
            this.msgService.error(message);
        }
    }
    get notifyService() {
        if (this.formNotifyService) {
            return this.formNotifyService;
        }
        else if (this.injector) {
            return this.injector.get(FormNotifyService, null);
        }
        return null;
    }
    get commandContext() {
        return this['context'] || null;
    }
    get frameContext() {
        return this.commandContext && this.commandContext.frameContext || null;
    }
    get injector() {
        return this.frameContext && this.frameContext.injector || null;
    }
}
PrintService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PrintService.ctorParameters = () => [
    { type: FormMessageService },
    { type: LanguageService },
    { type: CloudprintService },
    { type: FormNotifyService, decorators: [{ type: Optional }] }
];
export { PrintService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9wcmludC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVksUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBR3BELE9BQU8sRUFBRSxpQkFBaUIsRUFBZ0MsVUFBVSxFQUFFLFFBQVEsRUFBdUIsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUksT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQscUNBQXFDO0FBQ3JDLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSCxNQUNNLFlBQVk7SUFNaEI7O09BRUc7SUFDSCxZQUNVLFVBQThCLEVBQzlCLGVBQWdDLEVBQ2hDLFlBQStCLEVBQ25CLGlCQUFvQztRQUhoRCxlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5QixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsaUJBQVksR0FBWixZQUFZLENBQW1CO1FBQ25CLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7SUFFMUQsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxXQUFXLENBQUMsUUFBZ0IsRUFBRSxTQUFpQjtRQUNwRCxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2QscUVBQXFFO1lBQ3JFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1lBQzdELE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFF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RixVQUFVOzs7O1lBWkYsa0JBQWtCO1lBQ2xCLGVBQWU7WUFHZixpQkFBaUI7WUFDakIsaUJBQWlCLHVCQXFCckIsUUFBUTs7QUE0T2IsT0FBTyxFQUFFLFlBQVksRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBFTVBUWSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW1lc3NhZ2Uuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xuaW1wb3J0IHsgQ29tbWFuZENvbnRleHQsIEVudGl0eSwgRnJhbWVDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuaW1wb3J0IHsgQ2xvdWRwcmludFNlcnZpY2UsIE91dHB1dE9wdGlvbnMsIFNvdXJjZU9wdGlvbnMsIE91dHB1dFR5cGUsIEZpbGVUeXBlLCBTb3VyY2VGaWx0ZXJPcHRpb25zLCBQcmludFR5cGUgfSBmcm9tICdAZ3NwLXN2Yy9jbG91ZHByaW50JztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcbi8vIHRzbGludDpkaXNhYmxlOiB1bmlmaWVkLXNpZ25hdHVyZXNcbi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcbi8qKlxuICog5omT5Y2w5pyN5YqhXG4gKiBAU2NvcGUgRnJhbWVDb21wb25lbnRcbiAqL1xuQEluamVjdGFibGUoKVxuY2xhc3MgUHJpbnRTZXJ2aWNlIHtcbiAgLyoqXG4gICAqIOWunuS9k+S7k+W6k1xuICAgKi9cbiAgcHJpdmF0ZSByZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT47XG5cbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcbiAgICBwcml2YXRlIHByaW50U2VydmljZTogQ2xvdWRwcmludFNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBmb3JtTm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXG4gICkge1xuICB9XG5cbiAgLyoqXG4gICAqIOaJk+WNsOWNleaNrlxuICAgKiBAcGFyYW0gYmVNZXRhSWQgQkXlhYPmlbDmja7moIfor4ZcbiAgICogQHBhcmFtIGJpekJpbGxJZCDkuJrliqHljZXmja7moIfor4ZcbiAgICovXG4gIHB1YmxpYyBwcmludFNpbmdsZShiZU1ldGFJZDogc3RyaW5nLCBiaXpCaWxsSWQ6IHN0cmluZykge1xuICAgIGlmICghYml6QmlsbElkKSB7XG4gICAgICAvLyB0aGlzLm1zZ1NlcnZpY2UuZXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHRoaXMuc2hvd1dhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJpbnRBcnJheShiZU1ldGFJZCwgW2JpekJpbGxJZF0pO1xuICB9XG4gIC8qKlxuICAgKiDmiZPljbDljZXmja7vvIjpgJrov4dpZOaIlmlkc++8iVxuICAgKiBAcGFyYW0gYmVNZXRhSWQgYmXlhYPmlbDmja5JZFxuICAgKiBAcGFyYW0gaWRzIOWNleaNrmlk5oiWaWRzXG4gICAqL1xuICBwdWJsaWMgcHJpbnRCeUlkcyhiZU1ldGFJZDogc3RyaW5nLCBpZHM6IHN0cmluZykge1xuICAgIGlmICghaWRzKSB7XG4gICAgICAvLyB0aGlzLm1zZ1NlcnZpY2UuZXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHRoaXMuc2hvd1dhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgY29uc3QgZGF0YUlkczogQXJyYXk8c3RyaW5nPiA9IGlkcy5zcGxpdCgnLCcpLmZpbHRlcihpdGVtID0+IGl0ZW0pO1xuICAgIHJldHVybiB0aGlzLnByaW50QXJyYXkoYmVNZXRhSWQsIGRhdGFJZHMpO1xuICB9XG4gIC8qKlxuICAgKiDmiZPljbDljZXmja7vvIjluKbnu7TluqbvvIlcbiAgICogQHBhcmFtIGJlTWV0YUlkIGJl5YWD5pWw5o2uSWRcbiAgICogQHBhcmFtIGlkcyDljZXmja5pZOaIlmlkc1xuICAgKiBAcGFyYW0gZGltMSDnu7TluqYx5YC8XG4gICAqIEBwYXJhbSBkaW0yIOe7tOW6pjLlgLxcbiAgICogQHBhcmFtIGJpbGxDYXRlZ29yeUlkIOWNleaNruexu+Wei0lkXG4gICAqL1xuICBwdWJsaWMgcHJpbnRCeUlkc1dpdGhEaW1lbnNpb24oYmVNZXRhSWQ6IHN0cmluZywgaWRzOiBzdHJpbmcsIGRpbTE6IHN0cmluZywgZGltMjogc3RyaW5nLCBiaWxsQ2F0ZWdvcnlJZD86IHN0cmluZykge1xuICAgIGlmICghaWRzKSB7XG4gICAgICAvLyB0aGlzLm1zZ1NlcnZpY2UuZXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHRoaXMuc2hvd1dhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgY29uc3QgZGF0YUlkczogQXJyYXk8c3RyaW5nPiA9IGlkcy5zcGxpdCgnLCcpLmZpbHRlcihpdGVtID0+IGl0ZW0pO1xuICAgIHJldHVybiB0aGlzLnByaW50QXJyYXkoYmVNZXRhSWQsIGRhdGFJZHMsIGRpbTEsIGRpbTIsIGJpbGxDYXRlZ29yeUlkKTtcbiAgfVxuICAvKipcbiAgICog5omT5Y2w5aSa5Liq5Y2V5o2uXG4gICAqIEBwYXJhbSBiZU1ldGFJZCBCReWFg+aVsOaNruagh+ivhlxuICAgKiBAcGFyYW0gZGF0YUlkcyDkuJrliqHljZXmja7moIfor4bmlbDnu4RcbiAgICogQHBhcmFtIGRpbTEg57u05bqmMVxuICAgKiBAcGFyYW0gZGltMiDnu7TluqYyXG4gICAqIEBwYXJhbSBiaWxsQ2F0ZWdvcnlJZCDkuJrliqHljZXmja7nsbvlnotJZFxuICAgKi9cbiAgcHVibGljIHByaW50QXJyYXkoYmVNZXRhSWQ6IHN0cmluZywgZGF0YUlkczogc3RyaW5nW10sIGRpbTE/OiBhbnksIGRpbTI/OiBhbnksIGJpbGxDYXRlZ29yeUlkPzogc3RyaW5nKSB7XG4gICAgaWYgKCFkYXRhSWRzIHx8IGRhdGFJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyB0aGlzLm1zZ1NlcnZpY2UuZXJyb3IodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHRoaXMuc2hvd1dhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UudW5hbGxvd0VtcHR5Qml6QmlsbElkKTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgY29uc3Qgc291cmNlT3B0aW9uczogU291cmNlT3B0aW9ucyA9IHRoaXMuYnVpbGRTb3VyY2VPcHRpb25zKHtcbiAgICAgIGRhdGFJZHM6IGRhdGFJZHMsXG4gICAgICBzb3VyY2VJZDogYmVNZXRhSWRcbiAgICB9KTtcblxuICAgIGNvbnN0IG91dHB1dE9wdGlvbnM6IE91dHB1dE9wdGlvbnMgPSB0aGlzLmJ1aWxkT3V0cHV0T3B0aW9ucygpO1xuXG4gICAgaWYgKHR5cGVvZiBkaW0xICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgc291cmNlT3B0aW9ucy5GaXJzdERpbWVuc2lvblZhbCA9IGRpbTE7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgZGltMiAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHNvdXJjZU9wdGlvbnMuU2Vjb25kRGltZW5zaW9uVmFsID0gZGltMjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBiaWxsQ2F0ZWdvcnlJZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHNvdXJjZU9wdGlvbnMuYmlsbENhdGVnb3J5SWQgPSBiaWxsQ2F0ZWdvcnlJZDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJpbnRTZXJ2aWNlLm91dHB1dEJFRGF0YShzb3VyY2VPcHRpb25zLCBvdXRwdXRPcHRpb25zLCAndGFiJyk7XG4gIH1cblxuICAvKipcbiAgICog5oyJ54WnQkXlj5bmlbDmlrnlvI/mibnph4/miZPljbDljZXmja5cbiAgICogQHBhcmFtIGJlTWV0YUlkIEJF5YWD5pWw5o2u5qCH6K+GXG4gICAqIEBwYXJhbSBmaWx0ZXJDb25kaXRpb24g6L+H5ruk5p2h5Lu2XG4gICAqIEBwYXJhbSBzb3J0Q29uZGl0aW9uIOaOkuW6j+adoeS7tlxuICAgKiBAcGFyYW0gaW5jbHVkZUNoaWxkRGF0YSDljIXlkKvlrZDooajmlbDmja5cbiAgICovXG4gIHB1YmxpYyBwcmludE11bHRpKGJlTWV0YUlkOiBzdHJpbmcsIGZpbHRlckNvbmRpdGlvbjogc3RyaW5nLCBzb3J0Q29uZGl0aW9uOiBzdHJpbmcsIGluY2x1ZGVDaGlsZERhdGE6IGJvb2xlYW4gPSB0cnVlKSB7XG4gICAgY29uc3QgZW50cnlGaWx0ZXIgPSB7ICdpc1VzZVBhZ2luYXRpb24nOiBmYWxzZSwgJ2ZpbHRlckNvbmRpdGlvbnMnOiBbXSwgJ3NvcnRDb25kaXRpb25zJzogW10sICdwYWdpbmF0aW9uJzogbnVsbCB9O1xuICAgIGlmIChmaWx0ZXJDb25kaXRpb24pIHtcbiAgICAgIC8vIOe7n+S4gOe6oOato+acgOWQjuS4gOS4qui/h+a7pOadoeS7tueahFJlbGF0aW9uXG4gICAgICBjb25zdCBmaWx0ZXJzID0gSlNPTi5wYXJzZShmaWx0ZXJDb25kaXRpb24pO1xuICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZpbHRlcnNbZmlsdGVycy5sZW5ndGggLSAxXS5SZWxhdGlvbiA9IDA7XG4gICAgICB9XG4gICAgICBlbnRyeUZpbHRlci5maWx0ZXJDb25kaXRpb25zID0gZmlsdGVycztcbiAgICB9XG5cbiAgICBpZiAoc29ydENvbmRpdGlvbikge1xuICAgICAgZW50cnlGaWx0ZXIuc29ydENvbmRpdGlvbnMgPSBKU09OLnBhcnNlKHNvcnRDb25kaXRpb24pO1xuICAgIH1cbiAgICAvLyBzZm86U291cmNlRmlsdGVyT3B0aW9uc1xuICAgIGNvbnN0IHNvdXJjZUZpbHRlck9wdGlvbnM6IFNvdXJjZUZpbHRlck9wdGlvbnMgPSB0aGlzLmJ1aWxkU291cmNlRmlsdGVyT3B0aW9ucyh7IHNvdXJjZUlkOiBiZU1ldGFJZCwgZW50cnlGaWx0ZXIsIGluY2x1ZGVDaGlsZERhdGEgfSk7XG4gICAgY29uc3Qgb3V0cHV0T3B0aW9uczogT3V0cHV0T3B0aW9ucyA9IHRoaXMuYnVpbGRPdXRwdXRPcHRpb25zKCk7XG4gICAgcmV0dXJuIHRoaXMucHJpbnRTZXJ2aWNlLm91dHB1dEJFRGF0YVdpdGhGaWx0ZXIoc291cmNlRmlsdGVyT3B0aW9ucywgb3V0cHV0T3B0aW9ucywgJ3RhYicpO1xuICB9XG4gIC8qKlxuICAgKiDmjInnhadCReWPluaVsOaWueW8j+aJuemHj+aJk+WNsOWNleaNrijluKbnu7TluqYpXG4gICAqIEBwYXJhbSBiZU1ldGFJZCBCReWFg+aVsOaNruagh+ivhlxuICAgKiBAcGFyYW0gZmlsdGVyQ29uZGl0aW9uIOi/h+a7pOadoeS7tlxuICAgKiBAcGFyYW0gc29ydENvbmRpdGlvbiDmjpLluo/mnaHku7ZcbiAgICogQHBhcmFtIGRpbTEg57u05bqmMXZhbHVlXG4gICAqIEBwYXJhbSBkaW0yIOe7tOW6pjJ2YWx1ZVxuICAgKiBAcGFyYW0gYmlsbENhdGVnb3J5SWQg5Lia5Yqh5Y2V5o2u57G75Z6LSWRcbiAgICogQHBhcmFtIGluY2x1ZGVDaGlsZERhdGEg5YyF5ZCr5a2Q6KGo5pWw5o2uXG4gICAqL1xuICBwdWJsaWMgcHJpbnRNdWx0aVdpdGhEaW1lbnNpb24oYmVNZXRhSWQ6IHN0cmluZywgZmlsdGVyQ29uZGl0aW9uOiBzdHJpbmcsIHNvcnRDb25kaXRpb246IHN0cmluZywgZGltMTogc3RyaW5nLCBkaW0yOiBzdHJpbmcsIGJpbGxDYXRlZ29yeUlkPzogc3RyaW5nLCBpbmNsdWRlQ2hpbGREYXRhOiBib29sZWFuID0gdHJ1ZSkge1xuICAgIGNvbnN0IGVudHJ5RmlsdGVyID0geyAnaXNVc2VQYWdpbmF0aW9uJzogZmFsc2UsICdmaWx0ZXJDb25kaXRpb25zJzogW10sICdzb3J0Q29uZGl0aW9ucyc6IFtdLCAncGFnaW5hdGlvbic6IG51bGwgfTtcbiAgICBpZiAoZmlsdGVyQ29uZGl0aW9uKSB7XG4gICAgICAvLyDnu5/kuIDnuqDmraPmnIDlkI7kuIDkuKrov4fmu6TmnaHku7bnmoRSZWxhdGlvblxuICAgICAgY29uc3QgZmlsdGVycyA9IEpTT04ucGFyc2UoZmlsdGVyQ29uZGl0aW9uKTtcbiAgICAgIGlmIChmaWx0ZXJzICYmIGZpbHRlcnMubGVuZ3RoID4gMCkge1xuICAgICAgICBmaWx0ZXJzW2ZpbHRlcnMubGVuZ3RoIC0gMV0uUmVsYXRpb24gPSAwO1xuICAgICAgfVxuICAgICAgZW50cnlGaWx0ZXIuZmlsdGVyQ29uZGl0aW9ucyA9IGZpbHRlcnM7XG4gICAgfVxuXG4gICAgaWYgKHNvcnRDb25kaXRpb24pIHtcbiAgICAgIGVudHJ5RmlsdGVyLnNvcnRDb25kaXRpb25zID0gSlNPTi5wYXJzZShzb3J0Q29uZGl0aW9uKTtcbiAgICB9XG4gICAgY29uc3Qgc2ZvOiBTb3VyY2VGaWx0ZXJPcHRpb25zID0gdGhpcy5idWlsZFNvdXJjZUZpbHRlck9wdGlvbnMoeyBzb3VyY2VJZDogYmVNZXRhSWQsIGVudHJ5RmlsdGVyLCBpbmNsdWRlQ2hpbGREYXRhIH0pO1xuICAgIGlmICh0eXBlb2YgZGltMSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHNmby5GaXJzdERpbWVuc2lvblZhbCA9IGRpbTE7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgZGltMiAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHNmby5TZWNvbmREaW1lbnNpb25WYWwgPSBkaW0yO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGJpbGxDYXRlZ29yeUlkICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgc2ZvLmJpbGxDYXRlZ29yeUlkID0gYmlsbENhdGVnb3J5SWQ7XG4gICAgfVxuICAgIGNvbnN0IG91dHB1dE9wdGlvbnM6IE91dHB1dE9wdGlvbnMgPSB0aGlzLmJ1aWxkT3V0cHV0T3B0aW9ucygpO1xuICAgIHJldHVybiB0aGlzLnByaW50U2VydmljZS5vdXRwdXRCRURhdGFXaXRoRmlsdGVyKHNmbywgb3V0cHV0T3B0aW9ucywgJ3RhYicpO1xuICB9XG4gIC8qKlxuICAgKiDmnoTpgKBTb3VyY2VPcHRpb25zXG4gICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcbiAgICovXG4gIHByaXZhdGUgYnVpbGRTb3VyY2VPcHRpb25zKG9wdGlvbnM6IHsgZGF0YUlkczogc3RyaW5nW10sIHNvdXJjZUlkOiBzdHJpbmcsIFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IFNvdXJjZU9wdGlvbnMge1xuICAgIGNvbnN0IHNvOiBTb3VyY2VPcHRpb25zID0ge1xuICAgICAgRGF0YUlkczogb3B0aW9ucyAmJiBvcHRpb25zLmRhdGFJZHMgfHwgdW5kZWZpbmVkLFxuICAgICAgU291cmNlSWQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5zb3VyY2VJZCB8fCB1bmRlZmluZWQsXG4gICAgICBGaXJzdERpbWVuc2lvblZhbDogb3B0aW9ucyAmJiBvcHRpb25zLmRpbTEgfHwgdW5kZWZpbmVkLFxuICAgICAgU2Vjb25kRGltZW5zaW9uVmFsOiBvcHRpb25zICYmIG9wdGlvbnMuZGltMiB8fCB1bmRlZmluZWQsXG4gICAgICBSZXRyaWV2ZVBhcmFtOiBvcHRpb25zICYmIG9wdGlvbnMucmV0cmlldmVQYXJhbSB8fCB1bmRlZmluZWQsXG4gICAgICBGb3JtYXRJZDogb3B0aW9ucyAmJiBvcHRpb25zLmZvcm1hdElkIHx8IHVuZGVmaW5lZCxcbiAgICAgIGJpbGxDYXRlZ29yeUlkOiBvcHRpb25zICYmIG9wdGlvbnMuYmlsbENhdGVnb3J5SWQgfHwgdW5kZWZpbmVkLFxuICAgICAgU2VydmljZVVuaXQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5zZXJ2aWNlVW5pdCB8fCB1bmRlZmluZWQsXG4gICAgICBjdXJyZW50UGFnZTogb3B0aW9ucyAmJiBvcHRpb25zLmN1cnJlbnRQYWdlIHx8IHVuZGVmaW5lZCxcbiAgICAgIHBhZ2VSb3dDb3VudDogb3B0aW9ucyAmJiBvcHRpb25zLnBhZ2VSb3dDb3VudCB8fCB1bmRlZmluZWQsXG4gICAgICBxdWVyeVR5cGU6IG9wdGlvbnMgJiYgb3B0aW9ucy5xdWVyeVR5cGUgfHwgdW5kZWZpbmVkLFxuICAgICAgcXVlcnlTZXJ2aWNlSWQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5xdWVyeVNlcnZpY2VJZCB8fCB1bmRlZmluZWQsXG4gICAgICBxdWVyeVBhcmFtOiBvcHRpb25zICYmIG9wdGlvbnMucXVlcnlQYXJhbSB8fCB1bmRlZmluZWRcbiAgICB9O1xuICAgIHJldHVybiBzbztcbiAgfVxuICAvKipcbiAgICog5p6E6YCgT3V0cHV0T3B0aW9uc1xuICAgKiBAcGFyYW0gb3B0aW9ucyBvcHRpb25zXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkT3V0cHV0T3B0aW9ucyhvcHRpb25zPzogeyBbcHJvcDogc3RyaW5nXTogYW55IH0pOiBPdXRwdXRPcHRpb25zIHtcbiAgICBjb25zdCBvbzogT3V0cHV0T3B0aW9ucyA9IHtcbiAgICAgIE91dHB1dFR5cGU6IG9wdGlvbnMgJiYgb3B0aW9ucy5vdXRwdXRUeXBlIHx8IE91dHB1dFR5cGUuUFJJTlQsXG4gICAgICBGaWxlVHlwZTogb3B0aW9ucyAmJiBvcHRpb25zLmZpbGVUeXBlIHx8IEZpbGVUeXBlLkh0bWw1LFxuICAgICAgUGF0aDogb3B0aW9ucyAmJiBvcHRpb25zLnBhdGggfHwgdW5kZWZpbmVkLFxuICAgICAgRGV2aWNlSWQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5kZXZpY2VJZCB8fCB1bmRlZmluZWQsXG4gICAgICBwcmludEpvYjogb3B0aW9ucyAmJiBvcHRpb25zLnByaW50Sm9iIHx8IHVuZGVmaW5lZCxcbiAgICAgIHByaW50ZXJOYW1lOiBvcHRpb25zICYmIG9wdGlvbnMucHJpbnRlck5hbWUgfHwgdW5kZWZpbmVkLFxuICAgICAgcHJpbnRTZXR0aW5nOiBvcHRpb25zICYmIG9wdGlvbnMucHJpbnRTZXR0aW5nIHx8IHVuZGVmaW5lZCxcbiAgICAgIHByaW50VHlwZTogb3B0aW9ucyAmJiBvcHRpb25zLnByaW50VHlwZSB8fCBQcmludFR5cGUuRm9ybVxuICAgIH07XG4gICAgcmV0dXJuIG9vO1xuICB9XG4gIC8qKlxuICAgKiDmnoTpgKBTb3VyY2VGaWx0ZXJPcHRpb25zXG4gICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcbiAgICovXG4gIHByaXZhdGUgYnVpbGRTb3VyY2VGaWx0ZXJPcHRpb25zKG9wdGlvbnM6IHsgc291cmNlSWQ6IHN0cmluZywgW3Byb3A6IHN0cmluZ106IGFueSB9KTogU291cmNlRmlsdGVyT3B0aW9ucyB7XG4gICAgY29uc3QgZW50cnlGaWx0ZXIgPSB7ICdpc1VzZVBhZ2luYXRpb24nOiBmYWxzZSwgJ2ZpbHRlckNvbmRpdGlvbnMnOiBbXSwgJ3NvcnRDb25kaXRpb25zJzogW10sICdwYWdpbmF0aW9uJzogbnVsbCB9O1xuICAgIGNvbnN0IHNmbzogU291cmNlRmlsdGVyT3B0aW9ucyAmIHsgW3Byb3A6IHN0cmluZ106IGFueSB9ID0ge1xuICAgICAgU291cmNlSWQ6IG9wdGlvbnMuc291cmNlSWQsXG4gICAgICBFbnRpdHlGaWx0ZXI6IG9wdGlvbnMgJiYgb3B0aW9ucy5lbnRyeUZpbHRlciB8fCBlbnRyeUZpbHRlcixcbiAgICAgIEZpcnN0RGltZW5zaW9uVmFsOiBvcHRpb25zICYmIG9wdGlvbnMuZGltMSB8fCB1bmRlZmluZWQsXG4gICAgICBTZWNvbmREaW1lbnNpb25WYWw6IG9wdGlvbnMgJiYgb3B0aW9ucy5kaW0yIHx8IHVuZGVmaW5lZCxcbiAgICAgIEZvcm1hdElkOiBvcHRpb25zICYmIG9wdGlvbnMuZm9ybWF0SWQgfHwgdW5kZWZpbmVkLFxuICAgICAgU2VydmljZVVuaXQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5zZXJ2aWNlVW5pdCB8fCB1bmRlZmluZWQsXG4gICAgICBiaWxsQ2F0ZWdvcnlJZDogb3B0aW9ucyAmJiBvcHRpb25zLmJpbGxDYXRlZ29yeUlkIHx8IHVuZGVmaW5lZCxcbiAgICAgIGN1cnJlbnRQYWdlOiBvcHRpb25zICYmIG9wdGlvbnMuY3VycmVudFBhZ2UgfHwgdW5kZWZpbmVkLFxuICAgICAgcGFnZVJvd0NvdW50OiBvcHRpb25zICYmIG9wdGlvbnMucGFnZVJvd0NvdW50IHx8IHVuZGVmaW5lZCxcbiAgICAgIHF1ZXJ5UGFyYW06IG9wdGlvbnMgJiYgb3B0aW9ucy5xdWVyeVBhcmFtIHx8IHVuZGVmaW5lZCxcbiAgICAgIHF1ZXJ5U2VydmljZUlkOiBvcHRpb25zICYmIG9wdGlvbnMucXVlcnlTZXJ2aWNlSWQgfHwgdW5kZWZpbmVkLFxuICAgICAgcXVlcnlUeXBlOiBvcHRpb25zICYmIG9wdGlvbnMucXVlcnlUeXBlIHx8IHVuZGVmaW5lZCxcbiAgICAgIGluY2x1ZGVDaGlsZERhdGE6IG9wdGlvbnMgJiYgb3B0aW9ucy5oYXNPd25Qcm9wZXJ0eSgnaW5jbHVkZUNoaWxkRGF0YScpID8gb3B0aW9ucy5pbmNsdWRlQ2hpbGREYXRhIDogdHJ1ZVxuICAgIH07XG4gICAgcmV0dXJuIHNmbztcbiAgfVxuICAvKipcbiAgICog5bGV56S66ZSZ6K+v5raI5oGvXG4gICAqIEBwYXJhbSBtZXNzYWdlIOmUmeivr+a2iOaBr1xuICAgKi9cbiAgcHJpdmF0ZSBzaG93V2FybmluZyhtZXNzYWdlOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy5ub3RpZnlTZXJ2aWNlKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyhtZXNzYWdlLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICB9IGVsc2UgaWYgKHRoaXMubXNnU2VydmljZSkge1xuICAgICAgdGhpcy5tc2dTZXJ2aWNlLmVycm9yKG1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGdldCBub3RpZnlTZXJ2aWNlKCk6IEZvcm1Ob3RpZnlTZXJ2aWNlIHwgbnVsbCB7XG4gICAgaWYgKHRoaXMuZm9ybU5vdGlmeVNlcnZpY2UpIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlO1xuICAgIH0gZWxzZSBpZiAodGhpcy5pbmplY3Rvcikge1xuICAgICAgcmV0dXJuIHRoaXMuaW5qZWN0b3IuZ2V0PEZvcm1Ob3RpZnlTZXJ2aWNlPihGb3JtTm90aWZ5U2VydmljZSwgbnVsbCk7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG4gIHByaXZhdGUgZ2V0IGNvbW1hbmRDb250ZXh0KCk6IENvbW1hbmRDb250ZXh0IHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXNbJ2NvbnRleHQnXSB8fCBudWxsO1xuICB9XG4gIHByaXZhdGUgZ2V0IGZyYW1lQ29udGV4dCgpOiBGcmFtZUNvbnRleHQgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5jb21tYW5kQ29udGV4dCAmJiB0aGlzLmNvbW1hbmRDb250ZXh0LmZyYW1lQ29udGV4dCB8fCBudWxsO1xuICB9XG4gIHByaXZhdGUgZ2V0IGluamVjdG9yKCk6IEluamVjdG9yIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yIHx8IG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IHsgUHJpbnRTZXJ2aWNlIH07XG4iXX0=