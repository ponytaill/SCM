/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { LocaleService } from '@farris/ui-locale';
import { Pipe, Injector, Optional, ElementRef, LOCALE_ID } from '@angular/core';
import { Utils } from './utils';
import { ColumnFormatService } from '@farris/ui-common/column';
var FormatCellDataPipe = /** @class */ (function () {
    function FormatCellDataPipe(cfs, injector) {
        this.cfs = cfs;
        this.injector = injector;
        this.localeId = 'ZH-CHS';
        this.localeId = this.injector.get(LOCALE_ID);
    }
    /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    FormatCellDataPipe.prototype.transform = /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    function (col, rowData, groupFooter, footer) {
        if (groupFooter === void 0) { groupFooter = false; }
        if (footer === void 0) { footer = false; }
        if (rowData && col && col.field) {
            /** @type {?} */
            var value = Utils.getValue(col.field, rowData);
            if (col.editor && col.editor.options && col.editor.options.isPassword && !col.formatter) {
                return value ? '******' : '';
            }
            /** @type {?} */
            var formatterFn = col.formatter;
            if (groupFooter) {
                formatterFn = col.groupFooter ? col.groupFooter.formatter : undefined;
            }
            else if (footer) {
                formatterFn = col.footer ? col.footer.formatter : undefined;
                if (typeof formatterFn === 'object') {
                    if (!formatterFn.options) {
                        /** @type {?} */
                        var opts = { type: formatterFn.type, options: formatterFn };
                        formatterFn = opts;
                    }
                }
            }
            if (!formatterFn) {
                /** @type {?} */
                var resoultStr = value;
                if (col.isMultilingualField) {
                    resoultStr = this.getMultilingualValue(value);
                }
                else {
                    if (value !== null && value !== undefined && value !== '0' && typeof value === 'string') {
                        if (value.indexOf('\n') > -1) {
                            // return value.replace(/\n/g, '<br>');
                            this.getDatagridInstance();
                            if (this.dataGrid && this.dataGrid.nowrap) {
                                resoultStr = value.replace(/\n/g, ' ');
                            }
                        }
                    }
                    // value.replace(/ /g, '&ensp;');
                }
                return this.setPlaceHolderWhenEnableEditCellStyle(col, resoultStr, rowData, groupFooter || footer);
            }
            else {
                if (formatterFn) {
                    if (formatterFn.type === 'number') {
                        if (!formatterFn.options || !Object.keys(formatterFn.options).length) {
                            formatterFn.options = {
                                thousand: ',',
                                precision: 2
                            };
                        }
                    }
                    if (formatterFn.type === 'datetime') {
                        if (formatterFn.options) {
                            if (col.editor && col.editor.options) {
                                var _a = col.editor.options, dateRange = _a.dateRange, dateRangeDatesDelimiter = _a.dateRangeDatesDelimiter;
                                formatterFn.options = Object.assign({ dateRange: dateRange, dateRangeDatesDelimiter: dateRangeDatesDelimiter }, formatterFn.options);
                            }
                        }
                    }
                    if (formatterFn.type === 'timeago') {
                        if (formatterFn.options) {
                            formatterFn.options.locale = formatterFn.options.locale || this.localeId;
                        }
                        else {
                            formatterFn.options = {
                                locale: this.localeId
                            };
                        }
                    }
                }
                this.getDatagridInstance();
                if (this.dataGrid) {
                    /** @type {?} */
                    var r = this.cfs.format(value, rowData, formatterFn, { utils: this.dataGrid.commonUtils, locale: this.localeId });
                    return this.setPlaceHolderWhenEnableEditCellStyle(col, r, rowData, groupFooter || footer);
                }
                else {
                    return this.cfs.format(value, rowData, formatterFn, { locale: this.localeId });
                }
            }
        }
        return '';
    };
    // 获取多语数据
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    FormatCellDataPipe.prototype.getMultilingualValue = 
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    function (valObj) {
        if (valObj && typeof valObj === 'object' && Object.keys(valObj).length > 0) {
            if (this.injector) {
                this.localeService = this.injector.get(LocaleService);
            }
            if (this.localeService) {
                /** @type {?} */
                var localeId = this.localeService.localeId;
                return Utils.getMultilingualValue(valObj, localeId);
            }
            else {
                return valObj['zh-CHS'];
            }
        }
        else {
            return '';
        }
    };
    // 启用标识可编辑单元格时，内容为空时设置提示语
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    FormatCellDataPipe.prototype.setPlaceHolderWhenEnableEditCellStyle = 
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    function (col, val, rowData, isFooter) {
        this.getDatagridInstance();
        if (this.dataGrid) {
            /*
            if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                if (this.elRef) {
                    const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') > -1) {
                        span.className = span.className.replace('cell-empty', ' ');
                    }
                }

                return val;
            }
*/
            if (this.dataGrid.enableEditCellStyle) {
                if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                    if (this.elRef) {
                        /** @type {?} */
                        var span = this.elRef.nativeElement.querySelector('.cell-text-box');
                        if (span && span.className.indexOf('cell-empty') > -1) {
                            span.className = span.className.replace('cell-empty', ' ');
                        }
                    }
                    return val;
                }
                if (this.elRef) {
                    /** @type {?} */
                    var span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') === -1) {
                        span.className = span.className + ' cell-empty';
                    }
                }
                return Utils.getWhenEmptyText(col, this.localeId);
            }
            return val;
        }
        return val;
    };
    /**
     * @private
     * @return {?}
     */
    FormatCellDataPipe.prototype.getDatagridInstance = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.dataGrid) {
            this.dataGrid = this.injector.get(DatagridComponent, null);
        }
        if (!this.elRef) {
            this.elRef = this.injector.get(ElementRef, null);
        }
    };
    /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    FormatCellDataPipe.prototype.cellIsReadOnly = /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    function (col, rowData) {
        return this.dataGrid.cellIsReadOnly(col, rowData);
    };
    FormatCellDataPipe.decorators = [
        { type: Pipe, args: [{ name: 'formatCellData', pure: false },] }
    ];
    /** @nocollapse */
    FormatCellDataPipe.ctorParameters = function () { return [
        { type: ColumnFormatService },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    return FormatCellDataPipe;
}());
export { FormatCellDataPipe };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeService;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.dataGrid;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.cfs;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0LWNlbGwtZGF0YS5waXBlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9mb3JtYXQtY2VsbC1kYXRhLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFpQixRQUFRLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUcvRDtJQU9JLDRCQUFvQixHQUF3QixFQUFzQixRQUFtQjtRQUFqRSxRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBRDdFLGFBQVEsR0FBRyxRQUFRLENBQUM7UUFFeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7Ozs7OztJQUVELHNDQUFTOzs7Ozs7O0lBQVQsVUFBVSxHQUFRLEVBQUUsT0FBWSxFQUFFLFdBQW1CLEVBQUUsTUFBYztRQUFuQyw0QkFBQSxFQUFBLG1CQUFtQjtRQUFFLHVCQUFBLEVBQUEsY0FBYztRQUNqRSxJQUFJLE9BQU8sSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRTs7Z0JBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDO1lBQ2hELElBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFD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QUM7O2dCQXZLSixJQUFJLFNBQUMsRUFBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBQzs7OztnQkFIbEMsbUJBQW1CO2dCQUZFLFFBQVEsdUJBWWEsUUFBUTs7SUFpSzNELHlCQUFDO0NBQUEsQUF4S0QsSUF3S0M7U0F2S1ksa0JBQWtCOzs7Ozs7SUFFM0IsMkNBQXFDOzs7OztJQUNyQyxzQ0FBb0M7Ozs7O0lBQ3BDLG1DQUEwQjs7Ozs7SUFDMUIsc0NBQTRCOzs7OztJQUNoQixpQ0FBZ0M7Ozs7O0lBQUUsc0NBQXVDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICcuLy4uL2RhdGFncmlkLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IFBpcGUsIFBpcGVUcmFuc2Zvcm0sIEluamVjdG9yLCBPcHRpb25hbCwgRWxlbWVudFJlZiwgTE9DQUxFX0lEIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi91dGlscyc7XHJcbmltcG9ydCB7IENvbHVtbkZvcm1hdFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9jb2x1bW4nO1xyXG5pbXBvcnQgeyBEYXRhQ29sdW1uIH0gZnJvbSAnLi4vdHlwZXMvZGF0YS1jb2x1bW4nO1xyXG5cclxuQFBpcGUoe25hbWU6ICdmb3JtYXRDZWxsRGF0YScsIHB1cmU6IGZhbHNlfSlcclxuZXhwb3J0IGNsYXNzIEZvcm1hdENlbGxEYXRhUGlwZSBpbXBsZW1lbnRzIFBpcGVUcmFuc2Zvcm0ge1xyXG5cclxuICAgIHByaXZhdGUgbG9jYWxlU2VydmljZTogTG9jYWxlU2VydmljZTtcclxuICAgIHByaXZhdGUgZGF0YUdyaWQ6IERhdGFncmlkQ29tcG9uZW50O1xyXG4gICAgcHJpdmF0ZSBlbFJlZjogRWxlbWVudFJlZjtcclxuICAgIHByaXZhdGUgbG9jYWxlSWQgPSAnWkgtQ0hTJztcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgY2ZzOiBDb2x1bW5Gb3JtYXRTZXJ2aWNlLCBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yPzogSW5qZWN0b3IpIHtcclxuICAgICAgICB0aGlzLmxvY2FsZUlkID0gdGhpcy5pbmplY3Rvci5nZXQoTE9DQUxFX0lEKTtcclxuICAgIH1cclxuXHJcbiAgICB0cmFuc2Zvcm0oY29sOiBhbnksIHJvd0RhdGE6IGFueSwgZ3JvdXBGb290ZXIgPSBmYWxzZSwgZm9vdGVyID0gZmFsc2UpOiBhbnkge1xyXG4gICAgICAgIGlmIChyb3dEYXRhICYmIGNvbCAmJiBjb2wuZmllbGQpIHtcclxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBVdGlscy5nZXRWYWx1ZShjb2wuZmllbGQsIHJvd0RhdGEpO1xyXG4gICAgICAgICAgICBpZiAoY29sLmVkaXRvciAmJiBjb2wuZWRpdG9yLm9wdGlvbnMgJiYgY29sLmVkaXRvci5vcHRpb25zLmlzUGFzc3dvcmQgJiYgIWNvbC5mb3JtYXR0ZXIpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiAgdmFsdWUgPyAnKioqKioqJyA6ICcnO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgZm9ybWF0dGVyRm4gPSBjb2wuZm9ybWF0dGVyO1xyXG4gICAgICAgICAgICBpZiAoZ3JvdXBGb290ZXIpIHtcclxuICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuID0gY29sLmdyb3VwRm9vdGVyID8gY29sLmdyb3VwRm9vdGVyLmZvcm1hdHRlciA6IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChmb290ZXIpIHtcclxuICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuID0gY29sLmZvb3RlciA/IGNvbC5mb290ZXIuZm9ybWF0dGVyIDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmb3JtYXR0ZXJGbiA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWZvcm1hdHRlckZuLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0cyA9IHsgdHlwZTogZm9ybWF0dGVyRm4udHlwZSwgb3B0aW9uczogZm9ybWF0dGVyRm4gfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4gPSBvcHRzO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFmb3JtYXR0ZXJGbikge1xyXG4gICAgICAgICAgICAgICAgbGV0IHJlc291bHRTdHIgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChjb2wuaXNNdWx0aWxpbmd1YWxGaWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc291bHRTdHIgPSB0aGlzLmdldE11bHRpbGluZ3VhbFZhbHVlKHZhbHVlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09ICcwJyAmJiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5pbmRleE9mKCdcXG4nKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZXR1cm4gdmFsdWUucmVwbGFjZSgvXFxuL2csICc8YnI+Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmdldERhdGFncmlkSW5zdGFuY2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGFHcmlkICYmIHRoaXMuZGF0YUdyaWQubm93cmFwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VsdFN0ciA9IHZhbHVlLnJlcGxhY2UoL1xcbi9nLCAnICcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIC8vIHZhbHVlLnJlcGxhY2UoLyAvZywgJyZlbnNwOycpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2V0UGxhY2VIb2xkZXJXaGVuRW5hYmxlRWRpdENlbGxTdHlsZShjb2wsIHJlc291bHRTdHIsIHJvd0RhdGEsIGdyb3VwRm9vdGVyIHx8IGZvb3Rlcik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyRm4pIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGZvcm1hdHRlckZuLnR5cGUgPT09ICdudW1iZXInKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZm9ybWF0dGVyRm4ub3B0aW9ucyB8fCAhT2JqZWN0LmtleXMoZm9ybWF0dGVyRm4ub3B0aW9ucykubGVuZ3RoICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4ub3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aG91c2FuZDogJywnLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHByZWNpc2lvbjogMlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGZvcm1hdHRlckZuLnR5cGUgPT09ICdkYXRldGltZScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlckZuLm9wdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2wuZWRpdG9yICYmIGNvbC5lZGl0b3Iub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgZGF0ZVJhbmdlLCBkYXRlUmFuZ2VEYXRlc0RlbGltaXRlciB9ID0gY29sLmVkaXRvci5vcHRpb25zO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuLm9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHsgZGF0ZVJhbmdlLCBkYXRlUmFuZ2VEYXRlc0RlbGltaXRlciB9LCBmb3JtYXR0ZXJGbi5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlckZuLnR5cGUgPT09ICd0aW1lYWdvJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyRm4ub3B0aW9ucyApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuLm9wdGlvbnMubG9jYWxlID0gZm9ybWF0dGVyRm4ub3B0aW9ucy5sb2NhbGUgfHwgdGhpcy5sb2NhbGVJZDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdHRlckZuLm9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxlOiB0aGlzLmxvY2FsZUlkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICB0aGlzLmdldERhdGFncmlkSW5zdGFuY2UoKTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmRhdGFHcmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IHRoaXMuY2ZzLmZvcm1hdCh2YWx1ZSwgcm93RGF0YSwgZm9ybWF0dGVyRm4sIHsgdXRpbHM6IHRoaXMuZGF0YUdyaWQuY29tbW9uVXRpbHMsIGxvY2FsZTogdGhpcy5sb2NhbGVJZCB9KTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRQbGFjZUhvbGRlcldoZW5FbmFibGVFZGl0Q2VsbFN0eWxlKGNvbCwgciwgcm93RGF0YSwgZ3JvdXBGb290ZXIgfHwgZm9vdGVyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2ZzLmZvcm1hdCh2YWx1ZSwgcm93RGF0YSwgZm9ybWF0dGVyRm4sIHtsb2NhbGU6IHRoaXMubG9jYWxlSWQgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5blpJror63mlbDmja5cclxuICAgIHByaXZhdGUgZ2V0TXVsdGlsaW5ndWFsVmFsdWUodmFsT2JqKSB7XHJcbiAgICAgICAgaWYgKHZhbE9iaiAmJiB0eXBlb2YgdmFsT2JqID09PSAnb2JqZWN0JyAmJiBPYmplY3Qua2V5cyh2YWxPYmopLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5qZWN0b3IpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KExvY2FsZVNlcnZpY2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxvY2FsZVNlcnZpY2UpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsZUlkID0gdGhpcy5sb2NhbGVTZXJ2aWNlLmxvY2FsZUlkO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFV0aWxzLmdldE11bHRpbGluZ3VhbFZhbHVlKHZhbE9iaiwgbG9jYWxlSWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbE9ialsnemgtQ0hTJ107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOWQr+eUqOagh+ivhuWPr+e8lui+keWNleWFg+agvOaXtu+8jOWGheWuueS4uuepuuaXtuiuvue9ruaPkOekuuivrVxyXG4gICAgcHJpdmF0ZSBzZXRQbGFjZUhvbGRlcldoZW5FbmFibGVFZGl0Q2VsbFN0eWxlKGNvbCwgdmFsLCByb3dEYXRhLCBpc0Zvb3Rlcikge1xyXG4gICAgICAgIHRoaXMuZ2V0RGF0YWdyaWRJbnN0YW5jZSgpO1xyXG4gICAgICAgIGlmICh0aGlzLmRhdGFHcmlkKSB7XHJcbiAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5kYXRhR3JpZC5lZGl0YWJsZSB8fCAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gJycpIHx8IGlzRm9vdGVyIHx8IHRoaXMuY2VsbElzUmVhZE9ubHkoY29sLCByb3dEYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jZWxsLXRleHQtYm94Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4gJiYgc3Bhbi5jbGFzc05hbWUuaW5kZXhPZignY2VsbC1lbXB0eScpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5jbGFzc05hbWUgPSBzcGFuLmNsYXNzTmFtZS5yZXBsYWNlKCdjZWxsLWVtcHR5JywgJyAnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgICAgICAgfVxyXG4qL1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhR3JpZC5lbmFibGVFZGl0Q2VsbFN0eWxlICkge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5kYXRhR3JpZC5lZGl0YWJsZSB8fCAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gJycpIHx8IGlzRm9vdGVyIHx8IHRoaXMuY2VsbElzUmVhZE9ubHkoY29sLCByb3dEYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNlbGwtdGV4dC1ib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4gJiYgc3Bhbi5jbGFzc05hbWUuaW5kZXhPZignY2VsbC1lbXB0eScpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gc3Bhbi5jbGFzc05hbWUucmVwbGFjZSgnY2VsbC1lbXB0eScsICcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNlbGwtdGV4dC1ib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3BhbiAmJiBzcGFuLmNsYXNzTmFtZS5pbmRleE9mKCdjZWxsLWVtcHR5JykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gc3Bhbi5jbGFzc05hbWUgKyAnIGNlbGwtZW1wdHknO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBVdGlscy5nZXRXaGVuRW1wdHlUZXh0KGNvbCwgdGhpcy5sb2NhbGVJZCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGF0YWdyaWRJbnN0YW5jZSgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuZGF0YUdyaWQpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhR3JpZCA9IHRoaXMuaW5qZWN0b3IuZ2V0KERhdGFncmlkQ29tcG9uZW50LCBudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmVsUmVmID0gdGhpcy5pbmplY3Rvci5nZXQoRWxlbWVudFJlZiwgbnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNlbGxJc1JlYWRPbmx5KGNvbDogRGF0YUNvbHVtbiwgcm93RGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFHcmlkLmNlbGxJc1JlYWRPbmx5KGNvbCwgcm93RGF0YSk7XHJcbiAgICB9XHJcbn1cclxuIl19