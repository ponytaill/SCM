/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { DatagridComponent } from './../datagrid.component';
import { LocaleService } from '@farris/ui-locale';
import { Pipe, Injector, Optional, ElementRef, LOCALE_ID } from '@angular/core';
import { Utils } from './utils';
import { ColumnFormatService } from '@farris/ui-common/column';
var FormatCellDataPipe = /** @class */ (function () {
    function FormatCellDataPipe(cfs, injector) {
        this.cfs = cfs;
        this.injector = injector;
        this.localeId = 'ZH-CHS';
        this.localeId = this.injector.get(LOCALE_ID);
    }
    /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    FormatCellDataPipe.prototype.transform = /**
     * @param {?} col
     * @param {?} rowData
     * @param {?=} groupFooter
     * @param {?=} footer
     * @return {?}
     */
    function (col, rowData, groupFooter, footer) {
        if (groupFooter === void 0) { groupFooter = false; }
        if (footer === void 0) { footer = false; }
        if (rowData && col && col.field) {
            /** @type {?} */
            var value = Utils.getValue(col.field, rowData);
            if (col.editor && col.editor.options && col.editor.options.isPassword && !col.formatter) {
                return value ? '******' : '';
            }
            /** @type {?} */
            var formatterFn = col.formatter;
            if (groupFooter) {
                formatterFn = col.groupFooter ? col.groupFooter.formatter : undefined;
            }
            else if (footer) {
                formatterFn = col.footer ? col.footer.formatter : undefined;
                if (typeof formatterFn === 'object') {
                    if (!formatterFn.options) {
                        /** @type {?} */
                        var opts = { type: formatterFn.type, options: formatterFn };
                        formatterFn = opts;
                    }
                }
            }
            if (!formatterFn) {
                /** @type {?} */
                var resoultStr = value;
                if (col.isMultilingualField) {
                    resoultStr = this.getMultilingualValue(value);
                }
                else {
                    if (value !== null && value !== undefined && value !== '0' && typeof value === 'string') {
                        if (value.indexOf('\n') > -1) {
                            // return value.replace(/\n/g, '<br>');
                            this.getDatagridInstance();
                            if (this.dataGrid && this.dataGrid.nowrap) {
                                resoultStr = value.replace(/\n/g, ' ');
                            }
                        }
                    }
                    // value.replace(/ /g, '&ensp;');
                }
                return this.setPlaceHolderWhenEnableEditCellStyle(col, resoultStr, rowData, groupFooter || footer);
            }
            else {
                if (formatterFn) {
                    if (formatterFn.type === 'number') {
                        if (!formatterFn.options || !Object.keys(formatterFn.options).length) {
                            formatterFn.options = {
                                thousand: ',',
                                precision: 2
                            };
                        }
                    }
                    if (formatterFn.type === 'datetime') {
                        if (formatterFn.options) {
                            if (col.editor && col.editor.options) {
                                var _a = col.editor.options, dateRange = _a.dateRange, dateRangeDatesDelimiter = _a.dateRangeDatesDelimiter;
                                formatterFn.options = Object.assign({ dateRange: dateRange, dateRangeDatesDelimiter: dateRangeDatesDelimiter }, formatterFn.options);
                            }
                        }
                    }
                }
                this.getDatagridInstance();
                if (this.dataGrid) {
                    /** @type {?} */
                    var r = this.cfs.format(value, rowData, formatterFn, { utils: this.dataGrid.commonUtils });
                    return this.setPlaceHolderWhenEnableEditCellStyle(col, r, rowData, groupFooter || footer);
                }
                else {
                    return this.cfs.format(value, rowData, formatterFn);
                }
            }
        }
        return '';
    };
    // 获取多语数据
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    FormatCellDataPipe.prototype.getMultilingualValue = 
    // 获取多语数据
    /**
     * @private
     * @param {?} valObj
     * @return {?}
     */
    function (valObj) {
        if (valObj && typeof valObj === 'object' && Object.keys(valObj).length > 0) {
            if (this.injector) {
                this.localeService = this.injector.get(LocaleService);
            }
            if (this.localeService) {
                /** @type {?} */
                var localeId = this.localeService.localeId;
                return Utils.getMultilingualValue(valObj, localeId);
            }
            else {
                return valObj['zh-CHS'];
            }
        }
        else {
            return '';
        }
    };
    // 启用标识可编辑单元格时，内容为空时设置提示语
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    FormatCellDataPipe.prototype.setPlaceHolderWhenEnableEditCellStyle = 
    // 启用标识可编辑单元格时，内容为空时设置提示语
    /**
     * @private
     * @param {?} col
     * @param {?} val
     * @param {?} rowData
     * @param {?} isFooter
     * @return {?}
     */
    function (col, val, rowData, isFooter) {
        this.getDatagridInstance();
        if (this.dataGrid) {
            /*
            if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                if (this.elRef) {
                    const span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') > -1) {
                        span.className = span.className.replace('cell-empty', ' ');
                    }
                }

                return val;
            }
*/
            if (this.dataGrid.enableEditCellStyle) {
                if (!this.dataGrid.editable || (val !== null && val !== undefined && val !== '') || isFooter || this.cellIsReadOnly(col, rowData)) {
                    if (this.elRef) {
                        /** @type {?} */
                        var span = this.elRef.nativeElement.querySelector('.cell-text-box');
                        if (span && span.className.indexOf('cell-empty') > -1) {
                            span.className = span.className.replace('cell-empty', ' ');
                        }
                    }
                    return val;
                }
                if (this.elRef) {
                    /** @type {?} */
                    var span = this.elRef.nativeElement.querySelector('.cell-text-box');
                    if (span && span.className.indexOf('cell-empty') === -1) {
                        span.className = span.className + ' cell-empty';
                    }
                }
                return Utils.getWhenEmptyText(col, this.localeId);
            }
            return val;
        }
        return val;
    };
    /**
     * @private
     * @return {?}
     */
    FormatCellDataPipe.prototype.getDatagridInstance = /**
     * @private
     * @return {?}
     */
    function () {
        if (!this.dataGrid) {
            this.dataGrid = this.injector.get(DatagridComponent, null);
        }
        if (!this.elRef) {
            this.elRef = this.injector.get(ElementRef, null);
        }
    };
    /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    FormatCellDataPipe.prototype.cellIsReadOnly = /**
     * @param {?} col
     * @param {?} rowData
     * @return {?}
     */
    function (col, rowData) {
        return this.dataGrid.cellIsReadOnly(col, rowData);
    };
    FormatCellDataPipe.decorators = [
        { type: Pipe, args: [{ name: 'formatCellData', pure: false },] }
    ];
    /** @nocollapse */
    FormatCellDataPipe.ctorParameters = function () { return [
        { type: ColumnFormatService },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    return FormatCellDataPipe;
}());
export { FormatCellDataPipe };
if (false) {
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeService;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.dataGrid;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.elRef;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.localeId;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.cfs;
    /**
     * @type {?}
     * @private
     */
    FormatCellDataPipe.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybWF0LWNlbGwtZGF0YS5waXBlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy9mb3JtYXQtY2VsbC1kYXRhLnBpcGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzVELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsSUFBSSxFQUFpQixRQUFRLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0YsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUcvRDtJQU9JLDRCQUFvQixHQUF3QixFQUFzQixRQUFtQjtRQUFqRSxRQUFHLEdBQUgsR0FBRyxDQUFxQjtRQUFzQixhQUFRLEdBQVIsUUFBUSxDQUFXO1FBRDdFLGFBQVEsR0FBRyxRQUFRLENBQUM7UUFFeEIsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDOzs7Ozs7OztJQUVELHNDQUFTOzs7Ozs7O0lBQVQsVUFBVSxHQUFRLEVBQUUsT0FBWSxFQUFFLFdBQW1CLEVBQUUsTUFBYztRQUFuQyw0QkFBQSxFQUFBLG1CQUFtQjtRQUFFLHVCQUFBLEVBQUEsY0FBYztRQUNqRSxJQUFJLE9BQU8sSUFBSSxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssRUFBRTs7Z0JBQ3ZCLEtBQUssR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDO1lBQ2hELElBQUksR0FBRyxDQUFDLE1BQU0sSUFBSSxHQUFHLENBQUMsTUFBTSxDQUFD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QUFHLElBQUksQ0FBQyxTQUFTLEdBQUcsYUFBYSxDQUFDO3FCQUNuRDtpQkFDSjtnQkFDRCxPQUFPLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3JEO1lBRUQsT0FBTyxHQUFHLENBQUM7U0FDZDtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQzs7Ozs7SUFFTyxnREFBbUI7Ozs7SUFBM0I7UUFDSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNoQixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxDQUFDO1NBQzlEO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDYixJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUNwRDtJQUNMLENBQUM7Ozs7OztJQUVELDJDQUFjOzs7OztJQUFkLFVBQWUsR0FBZSxFQUFFLE9BQU87UUFDbkMsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdEQsQ0FBQzs7Z0JBN0pKLElBQUksU0FBQyxFQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDOzs7O2dCQUhsQyxtQkFBbUI7Z0JBRkUsUUFBUSx1QkFZYSxRQUFROztJQXVKM0QseUJBQUM7Q0FBQSxBQTlKRCxJQThKQztTQTdKWSxrQkFBa0I7Ozs7OztJQUUzQiwyQ0FBcUM7Ozs7O0lBQ3JDLHNDQUFvQzs7Ozs7SUFDcEMsbUNBQTBCOzs7OztJQUMxQixzQ0FBNEI7Ozs7O0lBQ2hCLGlDQUFnQzs7Ozs7SUFBRSxzQ0FBdUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJy4vLi4vZGF0YWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgTG9jYWxlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbG9jYWxlJztcclxuaW1wb3J0IHsgUGlwZSwgUGlwZVRyYW5zZm9ybSwgSW5qZWN0b3IsIE9wdGlvbmFsLCBFbGVtZW50UmVmLCBMT0NBTEVfSUQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgVXRpbHMgfSBmcm9tICcuL3V0aWxzJztcclxuaW1wb3J0IHsgQ29sdW1uRm9ybWF0U2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uL2NvbHVtbic7XHJcbmltcG9ydCB7IERhdGFDb2x1bW4gfSBmcm9tICcuLi90eXBlcy9kYXRhLWNvbHVtbic7XHJcblxyXG5AUGlwZSh7bmFtZTogJ2Zvcm1hdENlbGxEYXRhJywgcHVyZTogZmFsc2V9KVxyXG5leHBvcnQgY2xhc3MgRm9ybWF0Q2VsbERhdGFQaXBlIGltcGxlbWVudHMgUGlwZVRyYW5zZm9ybSB7XHJcblxyXG4gICAgcHJpdmF0ZSBsb2NhbGVTZXJ2aWNlOiBMb2NhbGVTZXJ2aWNlO1xyXG4gICAgcHJpdmF0ZSBkYXRhR3JpZDogRGF0YWdyaWRDb21wb25lbnQ7XHJcbiAgICBwcml2YXRlIGVsUmVmOiBFbGVtZW50UmVmO1xyXG4gICAgcHJpdmF0ZSBsb2NhbGVJZCA9ICdaSC1DSFMnO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjZnM6IENvbHVtbkZvcm1hdFNlcnZpY2UsIEBPcHRpb25hbCgpIHByaXZhdGUgaW5qZWN0b3I/OiBJbmplY3Rvcikge1xyXG4gICAgICAgIHRoaXMubG9jYWxlSWQgPSB0aGlzLmluamVjdG9yLmdldChMT0NBTEVfSUQpO1xyXG4gICAgfVxyXG5cclxuICAgIHRyYW5zZm9ybShjb2w6IGFueSwgcm93RGF0YTogYW55LCBncm91cEZvb3RlciA9IGZhbHNlLCBmb290ZXIgPSBmYWxzZSk6IGFueSB7XHJcbiAgICAgICAgaWYgKHJvd0RhdGEgJiYgY29sICYmIGNvbC5maWVsZCkge1xyXG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IFV0aWxzLmdldFZhbHVlKGNvbC5maWVsZCwgcm93RGF0YSk7XHJcbiAgICAgICAgICAgIGlmIChjb2wuZWRpdG9yICYmIGNvbC5lZGl0b3Iub3B0aW9ucyAmJiBjb2wuZWRpdG9yLm9wdGlvbnMuaXNQYXNzd29yZCAmJiAhY29sLmZvcm1hdHRlcikge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICB2YWx1ZSA/ICcqKioqKionIDogJyc7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGxldCBmb3JtYXR0ZXJGbiA9IGNvbC5mb3JtYXR0ZXI7XHJcbiAgICAgICAgICAgIGlmIChncm91cEZvb3Rlcikge1xyXG4gICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4gPSBjb2wuZ3JvdXBGb290ZXIgPyBjb2wuZ3JvdXBGb290ZXIuZm9ybWF0dGVyIDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGZvb3Rlcikge1xyXG4gICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4gPSBjb2wuZm9vdGVyID8gY29sLmZvb3Rlci5mb3JtYXR0ZXIgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZvcm1hdHRlckZuID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghZm9ybWF0dGVyRm4ub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcHRzID0geyB0eXBlOiBmb3JtYXR0ZXJGbi50eXBlLCBvcHRpb25zOiBmb3JtYXR0ZXJGbiB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbiA9IG9wdHM7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoIWZvcm1hdHRlckZuKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVzb3VsdFN0ciA9IHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbC5pc011bHRpbGluZ3VhbEZpZWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzb3VsdFN0ciA9IHRoaXMuZ2V0TXVsdGlsaW5ndWFsVmFsdWUodmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gJzAnICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLmluZGV4T2YoJ1xcbicpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiB2YWx1ZS5yZXBsYWNlKC9cXG4vZywgJzxicj4nKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0RGF0YWdyaWRJbnN0YW5jZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZGF0YUdyaWQgJiYgdGhpcy5kYXRhR3JpZC5ub3dyYXApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvdWx0U3RyID0gdmFsdWUucmVwbGFjZSgvXFxuL2csICcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdmFsdWUucmVwbGFjZSgvIC9nLCAnJmVuc3A7Jyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRQbGFjZUhvbGRlcldoZW5FbmFibGVFZGl0Q2VsbFN0eWxlKGNvbCwgcmVzb3VsdFN0ciwgcm93RGF0YSwgZ3JvdXBGb290ZXIgfHwgZm9vdGVyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChmb3JtYXR0ZXJGbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICggZm9ybWF0dGVyRm4udHlwZSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmb3JtYXR0ZXJGbi5vcHRpb25zIHx8ICFPYmplY3Qua2V5cyhmb3JtYXR0ZXJGbi5vcHRpb25zKS5sZW5ndGggKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXJGbi5vcHRpb25zID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRob3VzYW5kOiAnLCcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlY2lzaW9uOiAyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGlmICggZm9ybWF0dGVyRm4udHlwZSA9PT0gJ2RhdGV0aW1lJykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm9ybWF0dGVyRm4ub3B0aW9ucykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbC5lZGl0b3IgJiYgY29sLmVkaXRvci5vcHRpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBkYXRlUmFuZ2UsIGRhdGVSYW5nZURhdGVzRGVsaW1pdGVyIH0gPSBjb2wuZWRpdG9yLm9wdGlvbnM7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyRm4ub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oeyBkYXRlUmFuZ2UsIGRhdGVSYW5nZURhdGVzRGVsaW1pdGVyIH0sIGZvcm1hdHRlckZuLm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5nZXREYXRhZ3JpZEluc3RhbmNlKCk7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kYXRhR3JpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSB0aGlzLmNmcy5mb3JtYXQodmFsdWUsIHJvd0RhdGEsIGZvcm1hdHRlckZuLCB7IHV0aWxzOiB0aGlzLmRhdGFHcmlkLmNvbW1vblV0aWxzIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNldFBsYWNlSG9sZGVyV2hlbkVuYWJsZUVkaXRDZWxsU3R5bGUoY29sLCByLCByb3dEYXRhLCBncm91cEZvb3RlciB8fCBmb290ZXIpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jZnMuZm9ybWF0KHZhbHVlLCByb3dEYXRhLCBmb3JtYXR0ZXJGbik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICAvLyDojrflj5blpJror63mlbDmja5cclxuICAgIHByaXZhdGUgZ2V0TXVsdGlsaW5ndWFsVmFsdWUodmFsT2JqKSB7XHJcbiAgICAgICAgaWYgKHZhbE9iaiAmJiB0eXBlb2YgdmFsT2JqID09PSAnb2JqZWN0JyAmJiBPYmplY3Qua2V5cyh2YWxPYmopLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5qZWN0b3IpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9jYWxlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KExvY2FsZVNlcnZpY2UpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxvY2FsZVNlcnZpY2UpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxvY2FsZUlkID0gdGhpcy5sb2NhbGVTZXJ2aWNlLmxvY2FsZUlkO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFV0aWxzLmdldE11bHRpbGluZ3VhbFZhbHVlKHZhbE9iaiwgbG9jYWxlSWQpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbE9ialsnemgtQ0hTJ107XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIOWQr+eUqOagh+ivhuWPr+e8lui+keWNleWFg+agvOaXtu+8jOWGheWuueS4uuepuuaXtuiuvue9ruaPkOekuuivrVxyXG4gICAgcHJpdmF0ZSBzZXRQbGFjZUhvbGRlcldoZW5FbmFibGVFZGl0Q2VsbFN0eWxlKGNvbCwgdmFsLCByb3dEYXRhLCBpc0Zvb3Rlcikge1xyXG4gICAgICAgIHRoaXMuZ2V0RGF0YWdyaWRJbnN0YW5jZSgpO1xyXG4gICAgICAgIGlmICh0aGlzLmRhdGFHcmlkKSB7XHJcbiAgICAgICAgICAgIC8qXHJcbiAgICAgICAgICAgIGlmICghdGhpcy5kYXRhR3JpZC5lZGl0YWJsZSB8fCAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gJycpIHx8IGlzRm9vdGVyIHx8IHRoaXMuY2VsbElzUmVhZE9ubHkoY29sLCByb3dEYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZWxSZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5jZWxsLXRleHQtYm94Jyk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4gJiYgc3Bhbi5jbGFzc05hbWUuaW5kZXhPZignY2VsbC1lbXB0eScpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc3Bhbi5jbGFzc05hbWUgPSBzcGFuLmNsYXNzTmFtZS5yZXBsYWNlKCdjZWxsLWVtcHR5JywgJyAnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbDtcclxuICAgICAgICAgICAgfVxyXG4qL1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhR3JpZC5lbmFibGVFZGl0Q2VsbFN0eWxlICkge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5kYXRhR3JpZC5lZGl0YWJsZSB8fCAodmFsICE9PSBudWxsICYmIHZhbCAhPT0gdW5kZWZpbmVkICYmIHZhbCAhPT0gJycpIHx8IGlzRm9vdGVyIHx8IHRoaXMuY2VsbElzUmVhZE9ubHkoY29sLCByb3dEYXRhKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmVsUmVmKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNlbGwtdGV4dC1ib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNwYW4gJiYgc3Bhbi5jbGFzc05hbWUuaW5kZXhPZignY2VsbC1lbXB0eScpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gc3Bhbi5jbGFzc05hbWUucmVwbGFjZSgnY2VsbC1lbXB0eScsICcgJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQucXVlcnlTZWxlY3RvcignLmNlbGwtdGV4dC1ib3gnKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoc3BhbiAmJiBzcGFuLmNsYXNzTmFtZS5pbmRleE9mKCdjZWxsLWVtcHR5JykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gc3Bhbi5jbGFzc05hbWUgKyAnIGNlbGwtZW1wdHknO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBVdGlscy5nZXRXaGVuRW1wdHlUZXh0KGNvbCwgdGhpcy5sb2NhbGVJZCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB2YWw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0RGF0YWdyaWRJbnN0YW5jZSgpIHtcclxuICAgICAgICBpZiAoIXRoaXMuZGF0YUdyaWQpIHtcclxuICAgICAgICAgICAgdGhpcy5kYXRhR3JpZCA9IHRoaXMuaW5qZWN0b3IuZ2V0KERhdGFncmlkQ29tcG9uZW50LCBudWxsKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5lbFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmVsUmVmID0gdGhpcy5pbmplY3Rvci5nZXQoRWxlbWVudFJlZiwgbnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNlbGxJc1JlYWRPbmx5KGNvbDogRGF0YUNvbHVtbiwgcm93RGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRhdGFHcmlkLmNlbGxJc1JlYWRPbmx5KGNvbCwgcm93RGF0YSk7XHJcbiAgICB9XHJcbn1cclxuIl19