/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
import { IdService } from '@farris/ui-common';
import { Component, ViewChild, TemplateRef, Renderer2, ElementRef, NgZone, Injector, Input, HostListener, Optional } from '@angular/core';
import { FilterPanelService } from '@farris/ui-filter-panel';
import { DatagridComponent } from '../../datagrid.component';
import { DatagridSmartFilterService } from '../../services/datagrid-smart-filter.service';
var DatagridSmartFilterComponent = /** @class */ (function () {
    function DatagridSmartFilterComponent(render, el, zone, inject, filterPanelService, smartFilterSer, dg) {
        this.render = render;
        this.el = el;
        this.zone = zone;
        this.inject = inject;
        this.filterPanelService = filterPanelService;
        this.smartFilterSer = smartFilterSer;
        this.dg = dg;
        this.filterData = null;
        this.disabled = false;
        this.smartFilterDataChanged$ = null;
        this.removeFilter$ = null;
        this.clearAllFilter$ = null;
        this.smartFilterEvents = [];
        this.idService = this.inject.get(IdService, null);
    }
    /**
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        var _this = this;
        if (!this.removeFilter$) {
            this.removeFilter$ = this.smartFilterSer.removeFilter.subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                if (e && e.labelCode === _this.column.field) {
                    _this.filterData = null;
                    _this.render.removeClass(_this.el.nativeElement, 'active');
                }
            }));
            this.smartFilterEvents.push(this.removeFilter$);
        }
        if (!this.clearAllFilter$) {
            this.clearAllFilter$ = this.smartFilterSer.clearAllFilter.subscribe((/**
             * @return {?}
             */
            function () {
                _this.filterData = null;
                _this.render.removeClass(_this.el.nativeElement, 'active');
            }));
            this.smartFilterEvents.push(this.clearAllFilter$);
        }
        if (this.dg && !this.smartFilterDataChanged$) {
            this.smartFilterDataChanged$ = this.dg.dgs['smartFilterDataChange'].subscribe((/**
             * @param {?} e
             * @return {?}
             */
            function (e) {
                if (e && _this.column.field === e.fieldCode) {
                    _this.filterData.value = e.value;
                    _this.filterData.control.single = e.control.single;
                }
            }));
            this.smartFilterEvents.push(this.smartFilterDataChanged$);
        }
        this.dg.dgs.clearFilter.subscribe((/**
         * @return {?}
         */
        function () {
            _this.filterData = null;
            _this.dg.smartFilterResult = { controlData: [], conditions: [] };
            _this.smartFilterSer.clearAll();
            _this.render.removeClass(_this.el.nativeElement, 'active');
        }));
    };
    /**
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        if (this.filterPanelRef) {
            this.filterPanelService.hidePanel();
            this.filterPanelRef = null;
        }
        if (this.smartFilterEvents && this.smartFilterEvents.length) {
            this.smartFilterEvents.forEach((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                n.unsubscribe();
                n = null;
            }));
            this.smartFilterEvents = [];
        }
    };
    /**
     * @private
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.getFilterData = /**
     * @private
     * @return {?}
     */
    function () {
        var _a = this.column, field = _a.field, title = _a.title;
        if (!this.filterData) {
            this.filterData = this.smartFilterSer.controlData.find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.id === field; }));
        }
        if (!this.filterData) {
            this.filterData = {
                id: field,
                labelCode: field,
                code: field,
                name: title,
                control: this.smartFilterSer.getColumnFilterData(this.column),
                placeHolder: '',
                value: {
                    value: ''
                }
            };
        }
        return cloneDeep(this.filterData);
    };
    /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.getPanelPosition = /**
     * @private
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        /** @type {?} */
        var x = $event.pageX - 33;
        /** @type {?} */
        var y = $event.pageY + 9;
        /** @type {?} */
        var targetRect = $event.target.getBoundingClientRect();
        /** @type {?} */
        var moveArrow = 0;
        if (window.innerWidth - x < 380) {
            /** @type {?} */
            var i = 380 - (window.innerWidth - x);
            x = x - i - 20;
            moveArrow = targetRect.left - x;
        }
        return { x: x, y: y, moveArrow: moveArrow };
    };
    /**
     * @private
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.hideFilterPanel = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.filterPanelRef) {
            this.filterPanelService.hidePanel();
            this.filterPanelRef = null;
            if (!this.filterData || (this.filterData.control.controltype === 'bool-check' ? !this.filterData.value.value : !this.filterData.valueText)) {
                this.render.removeClass(this.el.nativeElement, 'active');
            }
        }
    };
    /**
     * @private
     * @param {?} e
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.clearColumnFilter = /**
     * @private
     * @param {?} e
     * @return {?}
     */
    function (e) {
        this.filterData = null;
        this.hideFilterPanel();
        this.smartFilterSer.removeCondition(e);
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.showFilterPanel = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        var _this = this;
        $event.stopPropagation();
        this.render.addClass(this.el.nativeElement, 'active');
        var _a = this.getPanelPosition($event), x = _a.x, y = _a.y, moveArrow = _a.moveArrow;
        this.filterPanelRef = this.filterPanelService.showPanel({
            left: x,
            top: y,
            item: this.getFilterData(),
            panelExtendTemplate: this.column.sortable ? this.sortTmp : null,
            localStorageKey: 'smartfilter_' + this.dg.dgs.createConfigKey(this.dg.id),
            target: $event.target
        });
        if (moveArrow) {
            /** @type {?} */
            var arrowEl = this.filterPanelRef['el'].querySelector('.f-filter-panel-arrow');
            if (arrowEl) {
                this.render.setStyle(arrowEl, 'left', moveArrow + "px");
            }
        }
        this.filterPanelRef.dataChange.subscribe((/**
         * @param {?} item
         * @return {?}
         */
        function (item) {
            if (_this.filterData && _this.filterData.id == item.id) {
                if (item.value && item.value.single !== undefined) {
                    _this.filterData.value = item.value;
                    _this.filterData.control.single = item.value.single;
                }
            }
        }));
        this.filterPanelRef.hidePanel.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.hideFilterPanel();
        }));
        this.filterPanelRef.filterSubmit.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (e.filter && e.filter.length) {
                _this.filterData = e.item || null;
                _this.hideFilterPanel();
                _this.smartFilterSer.filterConditionChanged({ conditions: e.filter, controlData: e.item, from: 'panel' });
            }
            else {
                _this.clearColumnFilter(e.item);
            }
        }));
        this.filterPanelRef.clearFilter.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            _this.clearColumnFilter(e);
        }));
    };
    /**
     * @param {?} $event
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.onClick = /**
     * @param {?} $event
     * @return {?}
     */
    function ($event) {
        $event.stopPropagation();
        if (this.disabled) {
            return;
        }
        this.showFilterPanel($event);
        return false;
    };
    /**
     * @param {?} $event
     * @param {?} order
     * @return {?}
     */
    DatagridSmartFilterComponent.prototype.onSort = /**
     * @param {?} $event
     * @param {?} order
     * @return {?}
     */
    function ($event, order) {
        var _this = this;
        $event.stopPropagation();
        if (this.column.order === order) {
            this.column.order = '';
        }
        else {
            this.column.order = order;
        }
        /** @type {?} */
        var sortName = this.dg.sortName;
        /** @type {?} */
        var sortOrder = this.dg.sortOrder;
        /** @type {?} */
        var sortFields = [];
        /** @type {?} */
        var sortOrders = [];
        if (sortName) {
            sortFields = sortName.split(',');
            sortOrders = sortOrder.split(',');
        }
        /** @type {?} */
        var newOrder = this.column.order;
        /** @type {?} */
        var i = sortFields.findIndex((/**
         * @param {?} n
         * @return {?}
         */
        function (n) { return n === _this.column.field; }));
        if (i >= 0) {
            if (newOrder === '') {
                newOrder = undefined;
                sortFields.splice(i, 1);
                sortOrders.splice(i, 1);
            }
            else {
                sortOrders[i] = newOrder;
            }
        }
        else {
            if (this.dg.multiSort) {
                sortFields.push(this.column.field);
                sortOrders.push(newOrder);
            }
            else {
                sortFields = [this.column.field];
                sortOrders = [newOrder];
            }
        }
        this.hideFilterPanel();
        this.dg.sortName = sortFields.join(',');
        this.dg.sortOrder = sortOrders.join(',');
        this.dg.dfs.setSortInfo(this.dg.sortName, this.dg.sortOrder);
        this.dg.beforeSortColumn(this.dg.sortName, this.dg.sortOrder, this.dg).subscribe((/**
         * @return {?}
         */
        function () {
            _this.dg.onColumnSorted();
        }));
    };
    DatagridSmartFilterComponent.decorators = [
        { type: Component, args: [{
                    selector: 'datagrid-smart-filter, [datagrid-smart-filter]',
                    template: "<ng-template #sort>\r\n    <div class=\"f-filter-panel-sort-wrapper f-filter-panel-sort-wrapper-hasfilter\">\r\n        <div class=\"f-filter-panel-sort\">\r\n            <div class=\"panel-sort-up panel-sort-item\" [class.active]=\"column?.order === 'asc'\" (click)=\"onSort($event, 'asc')\">\r\n                <span class=\"panel-sort-item-icon f-icon f-icon-col-ascendingorder\"></span>\r\n                <span class=\"panel-sort-item-text\">{{ 'datagrid.settings.asc' | locale: '\u5347\u5E8F' }}</span>\r\n            </div>\r\n            <div class=\"panel-sort-down panel-sort-item\" [class.active]=\"column?.order === 'desc'\"  (click)=\"onSort($event, 'desc')\">\r\n                <span class=\"panel-sort-item-icon f-icon f-icon-col-descendingorder\"></span>\r\n                <span class=\"panel-sort-item-text\">{{ 'datagrid.settings.desc' | locale: '\u964D\u5E8F' }}</span>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</ng-template>",
                    providers: [
                        FilterPanelService
                    ]
                }] }
    ];
    /** @nocollapse */
    DatagridSmartFilterComponent.ctorParameters = function () { return [
        { type: Renderer2 },
        { type: ElementRef },
        { type: NgZone },
        { type: Injector },
        { type: FilterPanelService },
        { type: DatagridSmartFilterService },
        { type: DatagridComponent, decorators: [{ type: Optional }] }
    ]; };
    DatagridSmartFilterComponent.propDecorators = {
        column: [{ type: Input }],
        filterData: [{ type: Input }],
        disabled: [{ type: Input }],
        sortTmp: [{ type: ViewChild, args: ['sort',] }],
        onClick: [{ type: HostListener, args: ['click', ['$event'],] }]
    };
    return DatagridSmartFilterComponent;
}());
export { DatagridSmartFilterComponent };
if (false) {
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.column;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.filterData;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.disabled;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.sortTmp;
    /** @type {?} */
    DatagridSmartFilterComponent.prototype.filterPanelRef;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.idService;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterDataChanged$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.removeFilter$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.clearAllFilter$;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterEvents;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.zone;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.inject;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.filterPanelService;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.smartFilterSer;
    /**
     * @type {?}
     * @private
     */
    DatagridSmartFilterComponent.prototype.dg;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc21hcnQtZmlsdGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQvIiwic291cmNlcyI6WyJsaWIvcGx1Z2lucy9zbWFydC1maWx0ZXIvZGF0YWdyaWQtc21hcnQtZmlsdGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUNILFNBQVMsRUFBVSxTQUFTLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQ2hFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFhLFlBQVksRUFBRSxRQUFRLEVBQzdELE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxrQkFBa0IsRUFBd0IsTUFBTSx5QkFBeUIsQ0FBQztBQUNuRixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUUxRjtJQW9CSSxzQ0FDWSxNQUFpQixFQUFVLEVBQWMsRUFDekMsSUFBWSxFQUFVLE1BQWdCLEVBQ3RDLGtCQUFzQyxFQUN0QyxjQUEwQyxFQUM5QixFQUFxQjtRQUpqQyxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQVUsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUN6QyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBVTtRQUN0Qyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLG1CQUFjLEdBQWQsY0FBYyxDQUE0QjtRQUM5QixPQUFFLEdBQUYsRUFBRSxDQUFtQjtRQWhCcEMsZUFBVSxHQUFHLElBQUksQ0FBQztRQUNsQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBTWxCLDRCQUF1QixH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cG9ydCB7IGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XHJcbmltcG9ydCB7IElkU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuaW1wb3J0IHtcclxuICAgIENvbXBvbmVudCwgT25Jbml0LCBWaWV3Q2hpbGQsIFRlbXBsYXRlUmVmLCBSZW5kZXJlcjIsIEVsZW1lbnRSZWYsXHJcbiAgICBOZ1pvbmUsIEluamVjdG9yLCBJbnB1dCwgT25EZXN0cm95LCBIb3N0TGlzdGVuZXIsIE9wdGlvbmFsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEZpbHRlclBhbmVsU2VydmljZSwgRmlsdGVyUGFuZWxDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWZpbHRlci1wYW5lbCc7XHJcbmltcG9ydCB7IERhdGFncmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZGF0YWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgRGF0YWdyaWRTbWFydEZpbHRlclNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9kYXRhZ3JpZC1zbWFydC1maWx0ZXIuc2VydmljZSc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnZGF0YWdyaWQtc21hcnQtZmlsdGVyLCBbZGF0YWdyaWQtc21hcnQtZmlsdGVyXScsXHJcbiAgICB0ZW1wbGF0ZVVybDogJ2RhdGFncmlkLXNtYXJ0LWZpbHRlci5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICBGaWx0ZXJQYW5lbFNlcnZpY2VcclxuICAgIF1cclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkU21hcnRGaWx0ZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcbiAgICBASW5wdXQoKSBjb2x1bW47XHJcbiAgICBASW5wdXQoKSBmaWx0ZXJEYXRhID0gbnVsbDtcclxuICAgIEBJbnB1dCgpIGRpc2FibGVkID0gZmFsc2U7XHJcblxyXG4gICAgQFZpZXdDaGlsZCgnc29ydCcpIHNvcnRUbXA6IFRlbXBsYXRlUmVmPGFueT47XHJcblxyXG4gICAgZmlsdGVyUGFuZWxSZWY6IEZpbHRlclBhbmVsQ29tcG9uZW50O1xyXG4gICAgcHJpdmF0ZSBpZFNlcnZpY2U6IElkU2VydmljZTtcclxuICAgIHByaXZhdGUgc21hcnRGaWx0ZXJEYXRhQ2hhbmdlZCQgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSByZW1vdmVGaWx0ZXIkID0gbnVsbDtcclxuICAgIHByaXZhdGUgY2xlYXJBbGxGaWx0ZXIkID0gbnVsbDtcclxuICAgIHByaXZhdGUgc21hcnRGaWx0ZXJFdmVudHMgPSBbXTtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsIHByaXZhdGUgZWw6IEVsZW1lbnRSZWYsXHJcbiAgICAgICAgcHJpdmF0ZSB6b25lOiBOZ1pvbmUsIHByaXZhdGUgaW5qZWN0OiBJbmplY3RvcixcclxuICAgICAgICBwcml2YXRlIGZpbHRlclBhbmVsU2VydmljZTogRmlsdGVyUGFuZWxTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgc21hcnRGaWx0ZXJTZXI6IERhdGFncmlkU21hcnRGaWx0ZXJTZXJ2aWNlLFxyXG4gICAgICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZGc6IERhdGFncmlkQ29tcG9uZW50XHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaWRTZXJ2aWNlID0gdGhpcy5pbmplY3QuZ2V0KElkU2VydmljZSwgbnVsbCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCkge1xyXG5cclxuICAgICAgICBpZiAoIXRoaXMucmVtb3ZlRmlsdGVyJCkge1xyXG4gICAgICAgICAgICB0aGlzLnJlbW92ZUZpbHRlciQgPSB0aGlzLnNtYXJ0RmlsdGVyU2VyLnJlbW92ZUZpbHRlci5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGUgJiYgZS5sYWJlbENvZGUgID09PSB0aGlzLmNvbHVtbi5maWVsZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2xhc3ModGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlckV2ZW50cy5wdXNoKHRoaXMucmVtb3ZlRmlsdGVyJCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIXRoaXMuY2xlYXJBbGxGaWx0ZXIkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY2xlYXJBbGxGaWx0ZXIkID0gdGhpcy5zbWFydEZpbHRlclNlci5jbGVhckFsbEZpbHRlci5zdWJzY3JpYmUoICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVDbGFzcyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyRXZlbnRzLnB1c2godGhpcy5jbGVhckFsbEZpbHRlciQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5kZyAmJiAhdGhpcy5zbWFydEZpbHRlckRhdGFDaGFuZ2VkJCkge1xyXG4gICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyRGF0YUNoYW5nZWQkID0gdGhpcy5kZy5kZ3NbJ3NtYXJ0RmlsdGVyRGF0YUNoYW5nZSddLnN1YnNjcmliZSgoZTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZSAmJiB0aGlzLmNvbHVtbi5maWVsZCA9PT0gZS5maWVsZENvZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEudmFsdWUgPSBlLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YS5jb250cm9sLnNpbmdsZSA9IGUuY29udHJvbC5zaW5nbGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNtYXJ0RmlsdGVyRXZlbnRzLnB1c2godGhpcy5zbWFydEZpbHRlckRhdGFDaGFuZ2VkJCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmRnLmRncy5jbGVhckZpbHRlci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmZpbHRlckRhdGEgPSBudWxsO1xyXG4gICAgICAgICAgICB0aGlzLmRnLnNtYXJ0RmlsdGVyUmVzdWx0ID0geyBjb250cm9sRGF0YTogW10sIGNvbmRpdGlvbnM6IFtdIH07XHJcbiAgICAgICAgICAgIHRoaXMuc21hcnRGaWx0ZXJTZXIuY2xlYXJBbGwoKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2xhc3ModGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZmlsdGVyUGFuZWxSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFNlcnZpY2UuaGlkZVBhbmVsKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUGFuZWxSZWYgPSBudWxsO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuc21hcnRGaWx0ZXJFdmVudHMgJiYgdGhpcy5zbWFydEZpbHRlckV2ZW50cy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlckV2ZW50cy5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgICAgICAgbiA9IG51bGw7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zbWFydEZpbHRlckV2ZW50cyA9IFtdO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHByaXZhdGUgZ2V0RmlsdGVyRGF0YSgpIHtcclxuICAgICAgICBjb25zdCB7IGZpZWxkLCB0aXRsZSB9ID0gdGhpcy5jb2x1bW47XHJcbiAgICAgICAgaWYgKCF0aGlzLmZpbHRlckRhdGEpIHtcclxuICAgICAgICAgICAgdGhpcy5maWx0ZXJEYXRhID0gdGhpcy5zbWFydEZpbHRlclNlci5jb250cm9sRGF0YS5maW5kKG4gPT4gbi5pZCA9PT0gZmllbGQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmZpbHRlckRhdGEpIHtcclxuICAgICAgICAgICAgdGhpcy5maWx0ZXJEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgaWQ6IGZpZWxkLFxyXG4gICAgICAgICAgICAgICAgbGFiZWxDb2RlOiBmaWVsZCxcclxuICAgICAgICAgICAgICAgIGNvZGU6IGZpZWxkLFxyXG4gICAgICAgICAgICAgICAgbmFtZTogdGl0bGUsXHJcbiAgICAgICAgICAgICAgICBjb250cm9sOiB0aGlzLnNtYXJ0RmlsdGVyU2VyLmdldENvbHVtbkZpbHRlckRhdGEodGhpcy5jb2x1bW4pLFxyXG4gICAgICAgICAgICAgICAgcGxhY2VIb2xkZXI6ICcnLFxyXG4gICAgICAgICAgICAgICAgdmFsdWU6IHtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogJydcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBjbG9uZURlZXAodGhpcy5maWx0ZXJEYXRhKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBnZXRQYW5lbFBvc2l0aW9uKCRldmVudCkge1xyXG4gICAgICAgIGxldCB4ID0gJGV2ZW50LnBhZ2VYIC0gMzM7XHJcbiAgICAgICAgY29uc3QgeSA9ICRldmVudC5wYWdlWSArICA5O1xyXG4gICAgICAgIGNvbnN0IHRhcmdldFJlY3QgPSAkZXZlbnQudGFyZ2V0LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIGxldCBtb3ZlQXJyb3cgPSAwO1xyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCAtIHggPCAzODApIHtcclxuICAgICAgICAgICAgY29uc3QgaSA9IDM4MCAtICh3aW5kb3cuaW5uZXJXaWR0aCAtIHgpO1xyXG4gICAgICAgICAgICB4ID0geCAtIGkgLSAyMDtcclxuICAgICAgICAgICAgbW92ZUFycm93ID0gdGFyZ2V0UmVjdC5sZWZ0IC0geDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7IHgsIHksIG1vdmVBcnJvd307XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBoaWRlRmlsdGVyUGFuZWwoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZmlsdGVyUGFuZWxSZWYpIHtcclxuICAgICAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFNlcnZpY2UuaGlkZVBhbmVsKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsdGVyUGFuZWxSZWYgPSBudWxsO1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZmlsdGVyRGF0YSB8fCAgKHRoaXMuZmlsdGVyRGF0YS5jb250cm9sLmNvbnRyb2x0eXBlID09PSAnYm9vbC1jaGVjaycgPyAhdGhpcy5maWx0ZXJEYXRhLnZhbHVlLnZhbHVlIDogIXRoaXMuZmlsdGVyRGF0YS52YWx1ZVRleHQpKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVDbGFzcyh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsICdhY3RpdmUnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNsZWFyQ29sdW1uRmlsdGVyKGUpIHtcclxuICAgICAgICB0aGlzLmZpbHRlckRhdGEgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuaGlkZUZpbHRlclBhbmVsKCk7XHJcbiAgICAgICAgdGhpcy5zbWFydEZpbHRlclNlci5yZW1vdmVDb25kaXRpb24oZSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2hvd0ZpbHRlclBhbmVsKCRldmVudCkge1xyXG4gICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICAgICAgdGhpcy5yZW5kZXIuYWRkQ2xhc3ModGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnYWN0aXZlJyk7XHJcbiAgICAgICAgY29uc3QgeyB4LCB5LCBtb3ZlQXJyb3cgfSA9IHRoaXMuZ2V0UGFuZWxQb3NpdGlvbigkZXZlbnQpO1xyXG4gICAgICAgIHRoaXMuZmlsdGVyUGFuZWxSZWYgPSB0aGlzLmZpbHRlclBhbmVsU2VydmljZS5zaG93UGFuZWwoe1xyXG4gICAgICAgICAgICBsZWZ0OiB4LFxyXG4gICAgICAgICAgICB0b3A6IHksXHJcbiAgICAgICAgICAgIGl0ZW06IHRoaXMuZ2V0RmlsdGVyRGF0YSgpLFxyXG4gICAgICAgICAgICBwYW5lbEV4dGVuZFRlbXBsYXRlOiB0aGlzLmNvbHVtbi5zb3J0YWJsZSA/IHRoaXMuc29ydFRtcCA6IG51bGwsXHJcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZUtleTogJ3NtYXJ0ZmlsdGVyXycgKyB0aGlzLmRnLmRncy5jcmVhdGVDb25maWdLZXkodGhpcy5kZy5pZCksXHJcbiAgICAgICAgICAgIHRhcmdldDogJGV2ZW50LnRhcmdldFxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBpZiAobW92ZUFycm93KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFycm93RWwgPSB0aGlzLmZpbHRlclBhbmVsUmVmWydlbCddLnF1ZXJ5U2VsZWN0b3IoJy5mLWZpbHRlci1wYW5lbC1hcnJvdycpO1xyXG4gICAgICAgICAgICBpZiAoYXJyb3dFbCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoYXJyb3dFbCwgJ2xlZnQnLCBgJHttb3ZlQXJyb3d9cHhgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5maWx0ZXJQYW5lbFJlZi5kYXRhQ2hhbmdlLnN1YnNjcmliZShpdGVtID0+IHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZmlsdGVyRGF0YSAmJiB0aGlzLmZpbHRlckRhdGEuaWQgPT0gaXRlbS5pZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0udmFsdWUgJiYgaXRlbS52YWx1ZS5zaW5nbGUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YS52YWx1ZSA9IGl0ZW0udmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJEYXRhLmNvbnRyb2wuc2luZ2xlID0gaXRlbS52YWx1ZS5zaW5nbGU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG5cclxuICAgICAgICB0aGlzLmZpbHRlclBhbmVsUmVmLmhpZGVQYW5lbC5zdWJzY3JpYmUoZSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZUZpbHRlclBhbmVsKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVyUGFuZWxSZWYuZmlsdGVyU3VibWl0LnN1YnNjcmliZShlID0+IHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGlmIChlLmZpbHRlciAmJiBlLmZpbHRlci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyRGF0YSA9IGUuaXRlbSB8fCBudWxsO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5oaWRlRmlsdGVyUGFuZWwoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc21hcnRGaWx0ZXJTZXIuZmlsdGVyQ29uZGl0aW9uQ2hhbmdlZCh7IGNvbmRpdGlvbnM6IGUuZmlsdGVyLCBjb250cm9sRGF0YTogZS5pdGVtICwgZnJvbTogJ3BhbmVsJ30pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhckNvbHVtbkZpbHRlcihlLml0ZW0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuZmlsdGVyUGFuZWxSZWYuY2xlYXJGaWx0ZXIuc3Vic2NyaWJlKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5jbGVhckNvbHVtbkZpbHRlcihlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50J10pXHJcbiAgICBvbkNsaWNrKCRldmVudCkge1xyXG4gICAgICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICBpZiAodGhpcy5kaXNhYmxlZCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc2hvd0ZpbHRlclBhbmVsKCRldmVudCk7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU29ydCgkZXZlbnQsIG9yZGVyKSB7XHJcbiAgICAgICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5jb2x1bW4ub3JkZXIgPT09IG9yZGVyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29sdW1uLm9yZGVyID0gJyc7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jb2x1bW4ub3JkZXIgPSBvcmRlcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHNvcnROYW1lID0gdGhpcy5kZy5zb3J0TmFtZTtcclxuICAgICAgICBjb25zdCBzb3J0T3JkZXIgPSB0aGlzLmRnLnNvcnRPcmRlcjtcclxuICAgICAgICBsZXQgc29ydEZpZWxkcyA9IFtdO1xyXG4gICAgICAgIGxldCBzb3J0T3JkZXJzID0gW107XHJcbiAgICAgICAgaWYgKHNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgIHNvcnRGaWVsZHMgPSBzb3J0TmFtZS5zcGxpdCgnLCcpO1xyXG4gICAgICAgICAgICBzb3J0T3JkZXJzID0gc29ydE9yZGVyLnNwbGl0KCcsJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbmV3T3JkZXIgPSAgdGhpcy5jb2x1bW4ub3JkZXI7XHJcbiAgICAgICAgY29uc3QgaSA9IHNvcnRGaWVsZHMuZmluZEluZGV4KG4gPT4gbiA9PT0gdGhpcy5jb2x1bW4uZmllbGQpO1xyXG4gICAgICAgIGlmIChpID49IDApIHtcclxuICAgICAgICAgICAgaWYgKG5ld09yZGVyID09PSAnJykge1xyXG4gICAgICAgICAgICAgICAgbmV3T3JkZXIgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICBzb3J0RmllbGRzLnNwbGljZShpLCAxKTtcclxuICAgICAgICAgICAgICAgIHNvcnRPcmRlcnMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgc29ydE9yZGVyc1tpXSA9IG5ld09yZGVyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGcubXVsdGlTb3J0KSB7XHJcbiAgICAgICAgICAgICAgICBzb3J0RmllbGRzLnB1c2godGhpcy5jb2x1bW4uZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgc29ydE9yZGVycy5wdXNoKG5ld09yZGVyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNvcnRGaWVsZHMgPSBbdGhpcy5jb2x1bW4uZmllbGRdO1xyXG4gICAgICAgICAgICAgICAgc29ydE9yZGVycyA9IFtuZXdPcmRlcl07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuaGlkZUZpbHRlclBhbmVsKCk7XHJcblxyXG5cclxuICAgICAgICB0aGlzLmRnLnNvcnROYW1lID0gc29ydEZpZWxkcy5qb2luKCcsJyk7XHJcbiAgICAgICAgdGhpcy5kZy5zb3J0T3JkZXIgPSBzb3J0T3JkZXJzLmpvaW4oJywnKTtcclxuICAgICAgICB0aGlzLmRnLmRmcy5zZXRTb3J0SW5mbyh0aGlzLmRnLnNvcnROYW1lLCB0aGlzLmRnLnNvcnRPcmRlcik7XHJcblxyXG4gICAgICAgIHRoaXMuZGcuYmVmb3JlU29ydENvbHVtbih0aGlzLmRnLnNvcnROYW1lLCB0aGlzLmRnLnNvcnRPcmRlciwgdGhpcy5kZykuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5kZy5vbkNvbHVtblNvcnRlZCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==