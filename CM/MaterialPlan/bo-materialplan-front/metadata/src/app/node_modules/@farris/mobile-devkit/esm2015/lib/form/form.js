import { MetadataUtil } from '../core/index';
import { FormControl } from './form_control';
import { FORM_CONTROL_PROP_META } from './decorators';
import { Subject } from 'rxjs';
import { ValidatorFactory } from '../validator';
/**
 * Form抽象类
 */
class Form {
    /**
     * 构造函数
     */
    constructor(viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.formControlConfigs = [];
        this.validateformControls = [];
        this.validateformControlPathMap = new Map;
        this.changes = new Subject();
    }
    /**
     * 初始化
     */
    init() {
        this.collectMetadatas();
        this.createFormControls();
    }
    /**
     * 全部校验
     *  formControlConfigs 上所有的formControl的存在方法调用一遍 将错误信息集中返回
     */
    validateFields() {
        let validationResult = [];
        if (this.validateformControls.length === 0) {
            return validationResult;
        }
        this.validateformControls.forEach((formControl) => {
            this[formControl]['validationResult'] = ValidatorFactory.executeValidator(this[formControl]['validatorFn'], this[formControl]['value']);
            !this[formControl]['validationResult'].passing && validationResult.push(this[formControl]);
        });
        this.changes.next({ type: 'validateFieldsFinished' });
        return validationResult;
    }
    /**
     * 获取某一个得校验错误信息
     * @param name 属性名称
     */
    getFieldError(name) {
        if (this.validateformControls.length === 0) {
            return {};
        }
        const index = this.validateformControls.findIndex((item) => {
            return item === name;
        });
        if (index === -1) {
            return {};
        }
        else {
            const result = ValidatorFactory.executeValidator(this[name]['validatorFn'], this[name]['value']);
            this[name]['validationResult'] = result;
            this.changes.next({ type: 'validateFieldsFinished', value: name });
            return result;
        }
    }
    /**
   * 根据form元数据中的path获取某一个得校验错误信息
   * @param path 属性名称数组
   */
    getFieldErrorByPath(path) {
        if (this.validateformControls.length === 0) {
            return {};
        }
        let pathName = path[0];
        if (path && path.length >= 2) {
            pathName = path.join('.');
        }
        const index = this.validateformControlPathMap.has(pathName);
        if (!index) {
            return {};
        }
        else {
            const result = ValidatorFactory.executeValidator(this[this.validateformControlPathMap.get(pathName)]['validatorFn'], this[this.validateformControlPathMap.get(pathName)]['value']);
            this[this.validateformControlPathMap.get(pathName)]['validationResult'] = result;
            this.changes.next({ type: 'validateFieldsFinished', value: this.validateformControlPathMap.get(pathName) });
            return result;
        }
    }
    /**
     * 清除一组字段验证状态
     * @param fields 字段的数组
     */
    resetFieldsValidate(fields) {
        if (this.validateformControls.length === 0) {
            return true;
        }
        else {
            if (fields && fields.length > 0) {
                const sa = new Set(this.validateformControls);
                const sb = new Set(fields);
                // 交集
                const intersect = this.validateformControls.filter(x => sb.has(x));
                // 遍历清空所有校验结果数据
                intersect.forEach(item => {
                    this[item]['validationResult'] = {};
                });
            }
            else {
                // 没传数据全部清除
                this.validateformControls.forEach(item => {
                    this[item]['validationResult'] = {};
                });
            }
            this.changes.next({ type: 'validateFieldsFinished' });
        }
    }
    /**
     * 创建FormControls
     */
    createFormControls() {
        this.formControlConfigs.forEach((formControlConfig) => {
            const name = formControlConfig.name;
            const formControl = new FormControl(formControlConfig, this.viewModelContext);
            this[name] = formControl;
        });
    }
    /**
     * 收集元数据
     */
    collectMetadatas() {
        const formControlMetadatas = MetadataUtil.getPropsMetadatasByName(this.constructor, FORM_CONTROL_PROP_META);
        Object.keys(formControlMetadatas).forEach((name) => {
            const formControlMetadata = formControlMetadatas[name];
            if (formControlMetadata.validRules) {
                this.validateformControls.push(name);
                this.validateformControlPathMap.set(formControlMetadata.bindingPath, name);
            }
            const formControlConfig = {
                name: name,
                bindingType: formControlMetadata.bindingType,
                bindingPath: formControlMetadata.bindingPath,
                valueConverter: formControlMetadata.valueConverter,
                valueChanging: formControlMetadata.valueChanging,
                valueChanged: formControlMetadata.valueChanged,
                validRules: formControlMetadata.validRules
            };
            this.formControlConfigs.push(formControlConfig);
        });
    }
    getEntityValueChangingListeners() {
        const listeners = {};
        this.formControlConfigs.forEach((formControl) => {
            if (formControl.valueChanging) {
                listeners[formControl.bindingPath] = formControl.valueChanging;
            }
        });
        return listeners;
    }
    getEntityValueChangedListeners() {
        const listeners = {};
        this.formControlConfigs.forEach((formControl) => {
            if (formControl.valueChanged) {
                listeners[formControl.bindingPath] = formControl.valueChanged;
            }
        });
        return listeners;
    }
}
export { Form };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9mb3JtL2Zvcm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU3QyxPQUFPLEVBQXFCLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hFLE9BQU8sRUFBdUIsc0JBQXNCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDM0UsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMvQixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFFL0M7O0dBRUc7QUFDSCxNQUFlLElBQUk7SUFrQmpCOztPQUVHO0lBQ0gsWUFBWSxnQkFBa0M7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO1FBQ3pDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsMEJBQTBCLEdBQUcsSUFBSSxHQUFHLENBQUM7UUFDMUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRDs7T0FFRztJQUNJLElBQUk7UUFDVCxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsY0FBYztRQUNaLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFBRSxPQUFPLGdCQUFnQixDQUFDO1NBQUU7UUFDeEUsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFF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QUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTSwrQkFBK0I7UUFDcEMsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUE4QixFQUFFLEVBQUU7WUFDakUsSUFBSSxXQUFXLENBQUMsYUFBYSxFQUFFO2dCQUM3QixTQUFTLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxhQUFhLENBQUM7YUFDaEU7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTSw4QkFBOEI7UUFDbkMsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUE4QixFQUFFLEVBQUU7WUFDakUsSUFBSSxXQUFXLENBQUMsWUFBWSxFQUFFO2dCQUM1QixTQUFTLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxZQUFZLENBQUM7YUFDL0Q7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FDRjtBQUVELE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi4vdmlldy1tb2RlbC9pbmRleCc7XHJcbmltcG9ydCB7IEZvcm1Db250cm9sQ29uZmlnLCBGb3JtQ29udHJvbCB9IGZyb20gJy4vZm9ybV9jb250cm9sJztcclxuaW1wb3J0IHsgRm9ybUNvbnRyb2xNZXRhZGF0YSwgRk9STV9DT05UUk9MX1BST1BfTUVUQSB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgVmFsaWRhdG9yRmFjdG9yeSB9IGZyb20gJy4uL3ZhbGlkYXRvcidcclxuXHJcbi8qKlxyXG4gKiBGb3Jt5oq96LGh57G7XHJcbiAqL1xyXG5hYnN0cmFjdCBjbGFzcyBGb3JtIHtcclxuXHJcbiAgLyoqXHJcbiAgICog6KGo5Y2V5o6n5Lu26YWN572uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmb3JtQ29udHJvbENvbmZpZ3M6IEZvcm1Db250cm9sQ29uZmlnW107XHJcblxyXG4gIC8qKlxyXG4gICAqIFZpZXdNb2RlbOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHByaXZhdGUgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcclxuXHJcbiAgcHJpdmF0ZSB2YWxpZGF0ZWZvcm1Db250cm9sczogc3RyaW5nW107XHJcblxyXG4gIHByaXZhdGUgdmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXA6IE1hcDxzdHJpbmcsIHN0cmluZz47XHJcblxyXG4gIHB1YmxpYyBjaGFuZ2VzOiBTdWJqZWN0PGFueT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHZpZXdNb2RlbENvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQpIHtcclxuICAgIHRoaXMudmlld01vZGVsQ29udGV4dCA9IHZpZXdNb2RlbENvbnRleHQ7XHJcbiAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncyA9IFtdO1xyXG4gICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scyA9IFtdO1xyXG4gICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcCA9IG5ldyBNYXA7XHJcbiAgICB0aGlzLmNoYW5nZXMgPSBuZXcgU3ViamVjdCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgcHVibGljIGluaXQoKSB7XHJcbiAgICB0aGlzLmNvbGxlY3RNZXRhZGF0YXMoKTtcclxuICAgIHRoaXMuY3JlYXRlRm9ybUNvbnRyb2xzKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhajpg6jmoKHpqowgXHJcbiAgICogIGZvcm1Db250cm9sQ29uZmlncyDkuIrmiYDmnInnmoRmb3JtQ29udHJvbOeahOWtmOWcqOaWueazleiwg+eUqOS4gOmBjSDlsIbplJnor6/kv6Hmga/pm4bkuK3ov5Tlm55cclxuICAgKi9cclxuICB2YWxpZGF0ZUZpZWxkcygpIHtcclxuICAgIGxldCB2YWxpZGF0aW9uUmVzdWx0ID0gW107XHJcbiAgICBpZiAodGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5sZW5ndGggPT09IDApIHsgcmV0dXJuIHZhbGlkYXRpb25SZXN1bHQ7IH1cclxuICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMuZm9yRWFjaCgoZm9ybUNvbnRyb2wpID0+IHtcclxuICAgICAgdGhpc1tmb3JtQ29udHJvbF1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IFZhbGlkYXRvckZhY3RvcnkuZXhlY3V0ZVZhbGlkYXRvcih0aGlzW2Zvcm1Db250cm9sXVsndmFsaWRhdG9yRm4nXSwgdGhpc1tmb3JtQ29udHJvbF1bJ3ZhbHVlJ10pO1xyXG4gICAgICAhdGhpc1tmb3JtQ29udHJvbF1bJ3ZhbGlkYXRpb25SZXN1bHQnXS5wYXNzaW5nICYmIHZhbGlkYXRpb25SZXN1bHQucHVzaCh0aGlzW2Zvcm1Db250cm9sXSlcclxuICAgIH0pO1xyXG4gICAgdGhpcy5jaGFuZ2VzLm5leHQoeyB0eXBlOiAndmFsaWRhdGVGaWVsZHNGaW5pc2hlZCcgfSlcclxuICAgIHJldHVybiB2YWxpZGF0aW9uUmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5p+Q5LiA5Liq5b6X5qCh6aqM6ZSZ6K+v5L+h5oGvXHJcbiAgICogQHBhcmFtIG5hbWUg5bGe5oCn5ZCN56ewXHJcbiAgICovXHJcbiAgZ2V0RmllbGRFcnJvcihuYW1lOiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4ge31cclxuICAgIH1cclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5maW5kSW5kZXgoKGl0ZW0pID0+IHtcclxuICAgICAgcmV0dXJuIGl0ZW0gPT09IG5hbWVcclxuICAgIH0pO1xyXG4gICAgaWYgKGluZGV4ID09PSAtMSkge1xyXG4gICAgICByZXR1cm4ge31cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFZhbGlkYXRvckZhY3RvcnkuZXhlY3V0ZVZhbGlkYXRvcih0aGlzW25hbWVdWyd2YWxpZGF0b3JGbiddLCB0aGlzW25hbWVdWyd2YWx1ZSddKTtcclxuICAgICAgdGhpc1tuYW1lXVsndmFsaWRhdGlvblJlc3VsdCddID0gcmVzdWx0O1xyXG4gICAgICB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJywgdmFsdWU6IG5hbWUgfSk7XHJcbiAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICog5qC55o2uZm9ybeWFg+aVsOaNruS4reeahHBhdGjojrflj5bmn5DkuIDkuKrlvpfmoKHpqozplJnor6/kv6Hmga9cclxuICogQHBhcmFtIHBhdGgg5bGe5oCn5ZCN56ew5pWw57uEXHJcbiAqL1xyXG4gIGdldEZpZWxkRXJyb3JCeVBhdGgocGF0aDogc3RyaW5nW10pIHtcclxuICAgIGlmICh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4ge31cclxuICAgIH1cclxuICAgIGxldCBwYXRoTmFtZSA9IHBhdGhbMF1cclxuICAgIGlmIChwYXRoICYmIHBhdGgubGVuZ3RoID49IDIpIHtcclxuICAgICAgcGF0aE5hbWUgPSBwYXRoLmpvaW4oJy4nKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGluZGV4ID0gdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5oYXMocGF0aE5hbWUpO1xyXG4gICAgaWYgKCFpbmRleCkge1xyXG4gICAgICByZXR1cm4ge31cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHJlc3VsdCA9IFZhbGlkYXRvckZhY3RvcnkuZXhlY3V0ZVZhbGlkYXRvcih0aGlzW3RoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuZ2V0KHBhdGhOYW1lKV1bJ3ZhbGlkYXRvckZuJ10sIHRoaXNbdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5nZXQocGF0aE5hbWUpXVsndmFsdWUnXSk7XHJcbiAgICAgIHRoaXNbdGhpcy52YWxpZGF0ZWZvcm1Db250cm9sUGF0aE1hcC5nZXQocGF0aE5hbWUpXVsndmFsaWRhdGlvblJlc3VsdCddID0gcmVzdWx0O1xyXG4gICAgICB0aGlzLmNoYW5nZXMubmV4dCh7IHR5cGU6ICd2YWxpZGF0ZUZpZWxkc0ZpbmlzaGVkJywgdmFsdWU6IHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuZ2V0KHBhdGhOYW1lKSB9KTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4hemZpOS4gOe7hOWtl+autemqjOivgeeKtuaAgVxyXG4gICAqIEBwYXJhbSBmaWVsZHMg5a2X5q6155qE5pWw57uEXHJcbiAgICovXHJcbiAgcmVzZXRGaWVsZHNWYWxpZGF0ZShmaWVsZHM/OiBzdHJpbmdbXSkge1xyXG4gICAgaWYgKHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKGZpZWxkcyAmJiBmaWVsZHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIGNvbnN0IHNhID0gbmV3IFNldCh0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzKTtcclxuICAgICAgICBjb25zdCBzYiA9IG5ldyBTZXQoZmllbGRzKTtcclxuICAgICAgICAvLyDkuqTpm4ZcclxuICAgICAgICBjb25zdCBpbnRlcnNlY3QgPSB0aGlzLnZhbGlkYXRlZm9ybUNvbnRyb2xzLmZpbHRlcih4ID0+IHNiLmhhcyh4KSk7XHJcbiAgICAgICAgLy8g6YGN5Y6G5riF56m65omA5pyJ5qCh6aqM57uT5p6c5pWw5o2uXHJcbiAgICAgICAgaW50ZXJzZWN0LmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICB0aGlzW2l0ZW1dWyd2YWxpZGF0aW9uUmVzdWx0J10gPSB7fTtcclxuICAgICAgICB9KVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIC8vIOayoeS8oOaVsOaNruWFqOmDqOa4hemZpFxyXG4gICAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbHMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICAgIHRoaXNbaXRlbV1bJ3ZhbGlkYXRpb25SZXN1bHQnXSA9IHt9O1xyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoeyB0eXBlOiAndmFsaWRhdGVGaWVsZHNGaW5pc2hlZCcgfSlcclxuICAgIH1cclxuXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7pGb3JtQ29udHJvbHNcclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZUZvcm1Db250cm9scygpIHtcclxuICAgIHRoaXMuZm9ybUNvbnRyb2xDb25maWdzLmZvckVhY2goKGZvcm1Db250cm9sQ29uZmlnOiBGb3JtQ29udHJvbENvbmZpZykgPT4ge1xyXG4gICAgICBjb25zdCBuYW1lID0gZm9ybUNvbnRyb2xDb25maWcubmFtZTtcclxuICAgICAgY29uc3QgZm9ybUNvbnRyb2wgPSBuZXcgRm9ybUNvbnRyb2woZm9ybUNvbnRyb2xDb25maWcsIHRoaXMudmlld01vZGVsQ29udGV4dCk7XHJcbiAgICAgIHRoaXNbbmFtZV0gPSBmb3JtQ29udHJvbDtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pS26ZuG5YWD5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb2xsZWN0TWV0YWRhdGFzKCkge1xyXG4gICAgY29uc3QgZm9ybUNvbnRyb2xNZXRhZGF0YXMgPSBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXNCeU5hbWUodGhpcy5jb25zdHJ1Y3RvciwgRk9STV9DT05UUk9MX1BST1BfTUVUQSk7XHJcbiAgICBPYmplY3Qua2V5cyhmb3JtQ29udHJvbE1ldGFkYXRhcykuZm9yRWFjaCgobmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IGZvcm1Db250cm9sTWV0YWRhdGEgPSBmb3JtQ29udHJvbE1ldGFkYXRhc1tuYW1lXSBhcyBGb3JtQ29udHJvbE1ldGFkYXRhO1xyXG4gICAgICBpZiAoZm9ybUNvbnRyb2xNZXRhZGF0YS52YWxpZFJ1bGVzKSB7XHJcbiAgICAgICAgdGhpcy52YWxpZGF0ZWZvcm1Db250cm9scy5wdXNoKG5hbWUpO1xyXG4gICAgICAgIHRoaXMudmFsaWRhdGVmb3JtQ29udHJvbFBhdGhNYXAuc2V0KGZvcm1Db250cm9sTWV0YWRhdGEuYmluZGluZ1BhdGgsIG5hbWUpO1xyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGZvcm1Db250cm9sQ29uZmlnOiBGb3JtQ29udHJvbENvbmZpZyA9IHtcclxuICAgICAgICBuYW1lOiBuYW1lLFxyXG4gICAgICAgIGJpbmRpbmdUeXBlOiBmb3JtQ29udHJvbE1ldGFkYXRhLmJpbmRpbmdUeXBlLFxyXG4gICAgICAgIGJpbmRpbmdQYXRoOiBmb3JtQ29udHJvbE1ldGFkYXRhLmJpbmRpbmdQYXRoLFxyXG4gICAgICAgIHZhbHVlQ29udmVydGVyOiBmb3JtQ29udHJvbE1ldGFkYXRhLnZhbHVlQ29udmVydGVyLFxyXG4gICAgICAgIHZhbHVlQ2hhbmdpbmc6IGZvcm1Db250cm9sTWV0YWRhdGEudmFsdWVDaGFuZ2luZyxcclxuICAgICAgICB2YWx1ZUNoYW5nZWQ6IGZvcm1Db250cm9sTWV0YWRhdGEudmFsdWVDaGFuZ2VkLFxyXG4gICAgICAgIHZhbGlkUnVsZXM6IGZvcm1Db250cm9sTWV0YWRhdGEudmFsaWRSdWxlc1xyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLmZvcm1Db250cm9sQ29uZmlncy5wdXNoKGZvcm1Db250cm9sQ29uZmlnKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldEVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMoKTogeyBbcHJvcGVydHk6IHN0cmluZ106IHN0cmluZyB9IHtcclxuICAgIGNvbnN0IGxpc3RlbmVycyA9IHt9O1xyXG4gICAgdGhpcy5mb3JtQ29udHJvbENvbmZpZ3MuZm9yRWFjaCgoZm9ybUNvbnRyb2w6IEZvcm1Db250cm9sQ29uZmlnKSA9PiB7XHJcbiAgICAgIGlmIChmb3JtQ29udHJvbC52YWx1ZUNoYW5naW5nKSB7XHJcbiAgICAgICAgbGlzdGVuZXJzW2Zvcm1Db250cm9sLmJpbmRpbmdQYXRoXSA9IGZvcm1Db250cm9sLnZhbHVlQ2hhbmdpbmc7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGxpc3RlbmVycztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRFbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnMoKTogeyBbcHJvcGVydHk6IHN0cmluZ106IHN0cmluZyB9IHtcclxuICAgIGNvbnN0IGxpc3RlbmVycyA9IHt9O1xyXG4gICAgdGhpcy5mb3JtQ29udHJvbENvbmZpZ3MuZm9yRWFjaCgoZm9ybUNvbnRyb2w6IEZvcm1Db250cm9sQ29uZmlnKSA9PiB7XHJcbiAgICAgIGlmIChmb3JtQ29udHJvbC52YWx1ZUNoYW5nZWQpIHtcclxuICAgICAgICBsaXN0ZW5lcnNbZm9ybUNvbnRyb2wuYmluZGluZ1BhdGhdID0gZm9ybUNvbnRyb2wudmFsdWVDaGFuZ2VkO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBsaXN0ZW5lcnM7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBGb3JtIH07XHJcbiJdfQ==