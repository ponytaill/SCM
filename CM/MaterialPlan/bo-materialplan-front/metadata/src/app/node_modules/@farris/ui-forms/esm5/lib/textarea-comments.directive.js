/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ComponentFactoryResolver, Directive, ElementRef, Injector, Input, Renderer2 } from "@angular/core";
import { NgControl } from "@angular/forms";
import { OverLayHiddenService } from "@farris/ui-common";
import { LocaleService } from "@farris/ui-locale";
import { CommentsHttpToken } from "./comments/get-data.interface";
import { SingleListComponent } from "./comments/single-list.component";
var TextareaCommentsDirective = /** @class */ (function () {
    function TextareaCommentsDirective(injector, el, render, localeSer, cfr) {
        this.injector = injector;
        this.el = el;
        this.render = render;
        this.localeSer = localeSer;
        this.cfr = cfr;
        this.useComments = true;
        this.maxHeight = 300;
        this.title = '';
        this.mgrText = '';
        this.commentsBtnElement = null;
        this.singListRef = null;
        this.listPanelElRef = null;
        this.commentSer = this.injector.get(CommentsHttpToken, null);
        this.overlaySer = this.injector.get(OverLayHiddenService, null);
        if (!this.overlaySer) {
            this.overlaySer = new OverLayHiddenService();
        }
    }
    /**
     * @return {?}
     */
    TextareaCommentsDirective.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        this.ngControl = this.injector.get(NgControl, null);
    };
    /**
     * @return {?}
     */
    TextareaCommentsDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.init();
        this.listenAttributesChanged();
    };
    /**
     * @param {?} changes
     * @return {?}
     */
    TextareaCommentsDirective.prototype.ngOnChanges = /**
     * @param {?} changes
     * @return {?}
     */
    function (changes) {
        if (changes.useComments && !changes.useComments.isFirstChange()) {
            this.init();
        }
    };
    /**
     * @private
     * @return {?}
     */
    TextareaCommentsDirective.prototype.init = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var readonly = this.el.nativeElement.readOnly;
        /** @type {?} */
        var disabled = this.el.nativeElement.disabled;
        if (this.useComments && (!readonly && !disabled)) {
            this.createCommentsButton();
        }
        else {
            this.destroy();
        }
    };
    /**
     * @return {?}
     */
    TextareaCommentsDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.destroy();
        this.hideListPanel();
        // 停止观察属性变化
        this.observer.disconnect();
        this.observer = null;
    };
    /**
     * @return {?}
     */
    TextareaCommentsDirective.prototype.listenAttributesChanged = /**
     * @return {?}
     */
    function () {
        var _this = this;
        // 选择需要观察变动的节点
        /** @type {?} */
        var targetNode = this.el.nativeElement;
        // 观察器的配置（需要观察什么变动）
        /** @type {?} */
        var config = { attributes: true };
        // 当观察到变动时执行的回调函数
        /** @type {?} */
        var callback = (/**
         * @param {?} mutationsList
         * @param {?} observer
         * @return {?}
         */
        function (mutationsList, observer) {
            var e_1, _a;
            try {
                // Use traditional 'for loops' for IE 11
                for (var mutationsList_1 = tslib_1.__values(mutationsList), mutationsList_1_1 = mutationsList_1.next(); !mutationsList_1_1.done; mutationsList_1_1 = mutationsList_1.next()) {
                    var mutation = mutationsList_1_1.value;
                    if (mutation.type === 'attributes' && (mutation.attributeName === 'readonly' || mutation.attributeName === 'disabled')) {
                        _this.init();
                    }
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (mutationsList_1_1 && !mutationsList_1_1.done && (_a = mutationsList_1.return)) _a.call(mutationsList_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        });
        // 创建一个观察器实例并传入回调函数
        this.observer = new MutationObserver(callback);
        // 以上述配置开始观察目标节点
        this.observer.observe(targetNode, config);
    };
    /**
     * @return {?}
     */
    TextareaCommentsDirective.prototype.destroy = /**
     * @return {?}
     */
    function () {
        if (this.commentsBtnElement) {
            this.commentsBtnElement.remove();
        }
    };
    /**
     * @private
     * @return {?}
     */
    TextareaCommentsDirective.prototype.createID = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var tagName = this.el.nativeElement.tagName;
        if (this.ngControl) {
            /** @type {?} */
            var ctrlName = this.ngControl.name;
            return tagName + "_COMMENTS_" + ctrlName;
        }
        else {
            if (this.el.nativeElement.id) {
                return tagName + "_COMMENTS_" + this.el.nativeElement.id;
            }
        }
        return '';
    };
    /**
     * @private
     * @return {?}
     */
    TextareaCommentsDirective.prototype.createCommentsButton = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var commentsBtn = this.render.createElement('span');
        commentsBtn.className = 'dropdown-toggle';
        commentsBtn.title = this.title ? this.title : (this.localeSer.getValue('text.comments.title') || '常用意见');
        /** @type {?} */
        var id = this.createID();
        if (id) {
            commentsBtn.id = id;
        }
        this.render.setStyle(commentsBtn, 'position', 'absolute');
        this.render.setStyle(commentsBtn, 'left', '3px');
        this.render.setStyle(commentsBtn, 'bottom', '0px');
        this.render.setStyle(commentsBtn, 'cursor', 'pointer');
        /** @type {?} */
        var icon = this.render.createElement('span');
        this.render.appendChild(commentsBtn, icon);
        icon.className = 'f-icon f-icon-message';
        this.render.setStyle(icon, 'position', 'relative');
        // this.render.setStyle(icon, 'margin-right', '3px');
        this.render.setStyle(icon, 'top', '1px');
        this.render.setStyle(icon, 'font-size', '13px');
        this.el.nativeElement.after(commentsBtn);
        this.commentsBtnElement = commentsBtn;
        this.render.listen(commentsBtn, 'click', (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            e.stopPropagation();
            if (!_this.listPanelElRef) {
                _this.showListPanel();
            }
            else {
                _this.hideListPanel();
            }
        }));
    };
    /**
     * @private
     * @return {?}
     */
    TextareaCommentsDirective.prototype.showListPanel = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var listPanelEl = this.render.createElement('div');
        var _a = this.commentsBtnElement.getBoundingClientRect(), left = _a.left, bottom = _a.bottom;
        this.render.setStyle(listPanelEl, 'width', '200px');
        this.render.setStyle(listPanelEl, 'max-height', this.maxHeight + "px");
        this.render.setStyle(listPanelEl, 'position', 'absolute');
        this.render.setStyle(listPanelEl, 'left', left + "px");
        this.render.setStyle(listPanelEl, 'top', '0px');
        this.render.setStyle(listPanelEl, 'z-index', '9999999');
        this.render.setStyle(listPanelEl, 'box-shadow', '0 2px 8px 0 #dedede');
        this.render.setStyle(listPanelEl, 'border-radius', '6px');
        this.render.setStyle(listPanelEl, 'background', 'white');
        this.render.setStyle(listPanelEl, 'visibility', 'hidden');
        document.body.append(listPanelEl);
        this.listPanelElRef = listPanelEl;
        /** @type {?} */
        var singListCmf = this.cfr.resolveComponentFactory(SingleListComponent);
        this.singListRef = singListCmf.create(this.injector);
        this.singListRef.instance.showButtons = true;
        this.singListRef.instance.emptyDataMsg = this.localeSer.getValue('text.comments.empty');
        this.singListRef.instance.buttons = [
            {
                text: this.mgrText ? this.mgrText : this.localeSer.getValue('text.comments.manager'),
                iconCls: 'f-icon f-icon-home-setup', handler: (/**
                 * @return {?}
                 */
                function () {
                    if (_this.commentSer) {
                        _this.hideListPanel();
                        _this.commentSer.showCommentManageDialog({ type: 'forms' }).subscribe((/**
                         * @param {?} e
                         * @return {?}
                         */
                        function (e) {
                            console.log(e);
                        }));
                    }
                })
            }
        ];
        this.singListRef.instance.textField = 'message';
        this.singListRef.instance.maxItems = 999999;
        this.singListRef.instance.itemClick.subscribe((/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            /** @type {?} */
            var val = e.data['message'];
            /** @type {?} */
            var _text = _this.el.nativeElement.value || '';
            _text += val;
            if (_this.ngControl) {
                _this.ngControl.control.patchValue(_text);
            }
            else {
                _this.el.nativeElement.value = _text;
            }
            _this.hideListPanel();
        }));
        listPanelEl.appendChild(this.singListRef.location.nativeElement);
        this.singListRef.changeDetectorRef.detectChanges();
        this.loadData(this.singListRef);
        this.overlaySer.registerMouseEvent(listPanelEl, (/**
         * @param {?} e
         * @return {?}
         */
        function (e) {
            if (_this.listPanelElRef.contains(e.target) || _this.commentsBtnElement === e.target || _this.commentsBtnElement.contains(e.target)) {
                return;
            }
            _this.hideListPanel();
        }));
    };
    /**
     * @return {?}
     */
    TextareaCommentsDirective.prototype.hideListPanel = /**
     * @return {?}
     */
    function () {
        if (this.singListRef) {
            this.singListRef.destroy();
            this.singListRef = null;
        }
        if (this.listPanelElRef) {
            this.listPanelElRef.remove();
            this.overlaySer.destory(this.listPanelElRef);
            this.listPanelElRef = null;
        }
    };
    /**
     * @private
     * @param {?} singListRef
     * @return {?}
     */
    TextareaCommentsDirective.prototype.loadData = /**
     * @private
     * @param {?} singListRef
     * @return {?}
     */
    function (singListRef) {
        var _this = this;
        if (this.commentSer) {
            this.commentSer.getCommonComments({ type: 'forms' }).subscribe((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                singListRef.instance.loadData(data);
                setTimeout((/**
                 * @return {?}
                 */
                function () {
                    _this.resetPosition();
                }));
            }));
        }
    };
    /**
     * @private
     * @return {?}
     */
    TextareaCommentsDirective.prototype.resetPosition = /**
     * @private
     * @return {?}
     */
    function () {
        var _a = this.commentsBtnElement.getBoundingClientRect(), top = _a.top, bottom = _a.bottom, left = _a.left;
        /** @type {?} */
        var panelHeight = this.listPanelElRef.offsetHeight;
        if (window.innerHeight - bottom > this.maxHeight || window.innerHeight - bottom > panelHeight) {
            this.render.setStyle(this.listPanelElRef, 'top', bottom + "px");
            this.render.removeStyle(this.listPanelElRef, 'visibility');
            return;
        }
        else {
            if (top > this.maxHeight || top > panelHeight) {
                this.render.setStyle(this.listPanelElRef, 'top', top - panelHeight + "px");
            }
            else {
                this.render.setStyle(this.listPanelElRef, 'top', '0px');
                if (left > 200) {
                    this.render.setStyle(this.listPanelElRef, 'left', left - 200 + "px");
                }
            }
            this.render.removeStyle(this.listPanelElRef, 'visibility');
        }
    };
    TextareaCommentsDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[common-comments]',
                },] }
    ];
    /** @nocollapse */
    TextareaCommentsDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: ElementRef },
        { type: Renderer2 },
        { type: LocaleService },
        { type: ComponentFactoryResolver }
    ]; };
    TextareaCommentsDirective.propDecorators = {
        useComments: [{ type: Input, args: ['common-comments',] }],
        maxHeight: [{ type: Input }],
        title: [{ type: Input }],
        mgrText: [{ type: Input }]
    };
    return TextareaCommentsDirective;
}());
export { TextareaCommentsDirective };
if (false) {
    /** @type {?} */
    TextareaCommentsDirective.prototype.useComments;
    /** @type {?} */
    TextareaCommentsDirective.prototype.maxHeight;
    /** @type {?} */
    TextareaCommentsDirective.prototype.title;
    /** @type {?} */
    TextareaCommentsDirective.prototype.mgrText;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.commentSer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.eventManager;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.ngControl;
    /** @type {?} */
    TextareaCommentsDirective.prototype.commentsBtnElement;
    /** @type {?} */
    TextareaCommentsDirective.prototype.singListRef;
    /** @type {?} */
    TextareaCommentsDirective.prototype.listPanelElRef;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.overlaySer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.observer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    TextareaCommentsDirective.prototype.cfr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGFyZWEtY29tbWVudHMuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1mb3Jtcy8iLCJzb3VyY2VzIjpbImxpYi90ZXh0YXJlYS1jb21tZW50cy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQWlCLHdCQUF3QixFQUFnQixTQUFTLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQWdDLFNBQVMsRUFBaUIsTUFBTSxlQUFlLENBQUM7QUFDdEwsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNsRCxPQUFPLEVBQUUsaUJBQWlCLEVBQXdCLE1BQU0sK0JBQStCLENBQUM7QUFDeEYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHdkU7SUFvQkksbUNBQW9CLFFBQWtCLEVBQVUsRUFBYyxFQUFVLE1BQWlCLEVBQzdFLFNBQXdCLEVBQVUsR0FBNkI7UUFEdkQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLE9BQUUsR0FBRixFQUFFLENBQVk7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFXO1FBQzdFLGNBQVMsR0FBVCxTQUFTLENBQWU7UUFBVSxRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQWhCakQsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFDcEMsY0FBUyxHQUFHLEdBQUcsQ0FBQztRQUNoQixVQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ1gsWUFBTyxHQUFHLEVBQUUsQ0FBQztRQUt0Qix1QkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDMUIsZ0JBQVcsR0FBc0MsSUFBSSxDQUFDO1FBQ3RELG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBT2xCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFB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dEQsbURBQXNCOzs7OztJQUN0QiwrQ0FBeUM7Ozs7O0lBRXpDLDZDQUFtQzs7Ozs7SUFFdkIsNkNBQTBCOzs7OztJQUFFLHVDQUFzQjs7Ozs7SUFBRSwyQ0FBeUI7Ozs7O0lBQ3JGLDhDQUFnQzs7Ozs7SUFBRSx3Q0FBcUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlclZpZXdJbml0LCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIENvbXBvbmVudFJlZiwgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBJbmplY3RvciwgSW5wdXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBPbkluaXQsIFJlbmRlcmVyMiwgU2ltcGxlQ2hhbmdlcyB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IE5nQ29udHJvbCB9IGZyb20gXCJAYW5ndWxhci9mb3Jtc1wiO1xyXG5pbXBvcnQgeyBFdmVudE1hbmFnZXIgfSBmcm9tIFwiQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3NlclwiO1xyXG5pbXBvcnQgeyBPdmVyTGF5SGlkZGVuU2VydmljZSB9IGZyb20gXCJAZmFycmlzL3VpLWNvbW1vblwiO1xyXG5pbXBvcnQgeyBMb2NhbGVTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktbG9jYWxlXCI7XHJcbmltcG9ydCB7IENvbW1lbnRzSHR0cFRva2VuLCBJQ29tbWVudHNIdHRwU2VydmljZSB9IGZyb20gXCIuL2NvbW1lbnRzL2dldC1kYXRhLmludGVyZmFjZVwiO1xyXG5pbXBvcnQgeyBTaW5nbGVMaXN0Q29tcG9uZW50IH0gZnJvbSBcIi4vY29tbWVudHMvc2luZ2xlLWxpc3QuY29tcG9uZW50XCI7XHJcblxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tjb21tb24tY29tbWVudHNdJyxcclxufSlcclxuZXhwb3J0IGNsYXNzIFRleHRhcmVhQ29tbWVudHNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcclxuXHJcbiAgICBASW5wdXQoJ2NvbW1vbi1jb21tZW50cycpIHVzZUNvbW1lbnRzID0gdHJ1ZTtcclxuICAgIEBJbnB1dCgpIG1heEhlaWdodCA9IDMwMDtcclxuICAgIEBJbnB1dCgpIHRpdGxlID0gJyc7XHJcbiAgICBASW5wdXQoKSBtZ3JUZXh0ID0gJyc7XHJcblxyXG4gICAgcHJpdmF0ZSBjb21tZW50U2VyOiBJQ29tbWVudHNIdHRwU2VydmljZTtcclxuICAgIHByaXZhdGUgZXZlbnRNYW5hZ2VyOiBFdmVudE1hbmFnZXI7XHJcbiAgICBwcml2YXRlIG5nQ29udHJvbDogTmdDb250cm9sO1xyXG4gICAgY29tbWVudHNCdG5FbGVtZW50ID0gbnVsbDtcclxuICAgIHNpbmdMaXN0UmVmOiBDb21wb25lbnRSZWY8U2luZ2xlTGlzdENvbXBvbmVudD4gPSBudWxsO1xyXG4gICAgbGlzdFBhbmVsRWxSZWYgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBvdmVybGF5U2VyOiBPdmVyTGF5SGlkZGVuU2VydmljZTtcclxuXHJcbiAgICBwcml2YXRlIG9ic2VydmVyOiBNdXRhdGlvbk9ic2VydmVyO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyLCBcclxuICAgICAgICBwcml2YXRlIGxvY2FsZVNlcjogTG9jYWxlU2VydmljZSwgcHJpdmF0ZSBjZnI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcikge1xyXG4gICAgICAgIHRoaXMuY29tbWVudFNlciA9IHRoaXMuaW5qZWN0b3IuZ2V0KENvbW1lbnRzSHR0cFRva2VuLCBudWxsKTtcclxuICAgICAgICB0aGlzLm92ZXJsYXlTZXIgPSB0aGlzLmluamVjdG9yLmdldChPdmVyTGF5SGlkZGVuU2VydmljZSwgbnVsbCk7XHJcbiAgICAgICAgaWYgKCF0aGlzLm92ZXJsYXlTZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5vdmVybGF5U2VyID0gbmV3IE92ZXJMYXlIaWRkZW5TZXJ2aWNlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubmdDb250cm9sID0gdGhpcy5pbmplY3Rvci5nZXQoTmdDb250cm9sLCBudWxsKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICAgICAgdGhpcy5pbml0KCk7XHJcbiAgICAgICAgdGhpcy5saXN0ZW5BdHRyaWJ1dGVzQ2hhbmdlZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy51c2VDb21tZW50cyAmJiAhY2hhbmdlcy51c2VDb21tZW50cy5pc0ZpcnN0Q2hhbmdlKCkpIHtcclxuICAgICAgICAgICAgdGhpcy5pbml0KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdCgpIHtcclxuICAgICAgICBjb25zdCByZWFkb25seSA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5yZWFkT25seTtcclxuICAgICAgICBjb25zdCBkaXNhYmxlZCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC5kaXNhYmxlZDtcclxuICAgICAgICBpZiAodGhpcy51c2VDb21tZW50cyAmJiAoIXJlYWRvbmx5ICYmICFkaXNhYmxlZCkpIHtcclxuICAgICAgICAgICAgdGhpcy5jcmVhdGVDb21tZW50c0J1dHRvbigpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgICAgICB0aGlzLmhpZGVMaXN0UGFuZWwoKTtcclxuICAgICAgICAvLyDlgZzmraLop4Llr5/lsZ7mgKflj5jljJZcclxuICAgICAgICB0aGlzLm9ic2VydmVyLmRpc2Nvbm5lY3QoKTtcclxuICAgICAgICB0aGlzLm9ic2VydmVyID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBsaXN0ZW5BdHRyaWJ1dGVzQ2hhbmdlZCgpIHtcclxuICAgICAgICAvLyDpgInmi6npnIDopoHop4Llr5/lj5jliqjnmoToioLngrlcclxuICAgICAgICBjb25zdCB0YXJnZXROb2RlID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50O1xyXG5cclxuICAgICAgICAvLyDop4Llr5/lmajnmoTphY3nva7vvIjpnIDopoHop4Llr5/ku4DkuYjlj5jliqjvvIlcclxuICAgICAgICBjb25zdCBjb25maWcgPSB7IGF0dHJpYnV0ZXM6IHRydWUgfTtcclxuXHJcbiAgICAgICAgLy8g5b2T6KeC5a+f5Yiw5Y+Y5Yqo5pe25omn6KGM55qE5Zue6LCD5Ye95pWwXHJcbiAgICAgICAgY29uc3QgY2FsbGJhY2sgPSAobXV0YXRpb25zTGlzdCwgb2JzZXJ2ZXIpID0+IHtcclxuICAgICAgICAgICAgLy8gVXNlIHRyYWRpdGlvbmFsICdmb3IgbG9vcHMnIGZvciBJRSAxMVxyXG4gICAgICAgICAgICBmb3IobGV0IG11dGF0aW9uIG9mIG11dGF0aW9uc0xpc3QpIHtcclxuICAgICAgICAgICAgICAgIGlmIChtdXRhdGlvbi50eXBlID09PSAnYXR0cmlidXRlcycgJiYgKG11dGF0aW9uLmF0dHJpYnV0ZU5hbWUgPT09ICdyZWFkb25seScgfHwgbXV0YXRpb24uYXR0cmlidXRlTmFtZSA9PT0gJ2Rpc2FibGVkJykpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmluaXQoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIC8vIOWIm+W7uuS4gOS4quinguWvn+WZqOWunuS+i+W5tuS8oOWFpeWbnuiwg+WHveaVsFxyXG4gICAgICAgIHRoaXMub2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihjYWxsYmFjayk7XHJcblxyXG4gICAgICAgIC8vIOS7peS4iui/sOmFjee9ruW8gOWni+inguWvn+ebruagh+iKgueCuVxyXG4gICAgICAgIHRoaXMub2JzZXJ2ZXIub2JzZXJ2ZSh0YXJnZXROb2RlLCBjb25maWcpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBkZXN0cm95KCkge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbW1lbnRzQnRuRWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLmNvbW1lbnRzQnRuRWxlbWVudC5yZW1vdmUoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVJRCgpIHtcclxuICAgICAgICBjb25zdCB0YWdOYW1lID0gdGhpcy5lbC5uYXRpdmVFbGVtZW50LnRhZ05hbWU7XHJcbiAgICAgICAgaWYgKHRoaXMubmdDb250cm9sKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN0cmxOYW1lID0gdGhpcy5uZ0NvbnRyb2wubmFtZTtcclxuICAgICAgICAgICAgcmV0dXJuIGAke3RhZ05hbWV9X0NPTU1FTlRTXyR7Y3RybE5hbWV9YDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5lbC5uYXRpdmVFbGVtZW50LmlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYCR7dGFnTmFtZX1fQ09NTUVOVFNfJHt0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuaWR9YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVDb21tZW50c0J1dHRvbigpIHtcclxuICAgICAgICBjb25zdCBjb21tZW50c0J0biA9IHRoaXMucmVuZGVyLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICBjb21tZW50c0J0bi5jbGFzc05hbWUgPSAnZHJvcGRvd24tdG9nZ2xlJztcclxuICAgICAgICBjb21tZW50c0J0bi50aXRsZSA9IHRoaXMudGl0bGUgPyB0aGlzLnRpdGxlIDogKHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCd0ZXh0LmNvbW1lbnRzLnRpdGxlJykgfHwgJ+W4uOeUqOaEj+ingScpO1xyXG4gICAgICAgIGNvbnN0IGlkID0gdGhpcy5jcmVhdGVJRCgpO1xyXG4gICAgICAgIGlmIChpZCkge1xyXG4gICAgICAgICAgICBjb21tZW50c0J0bi5pZCA9IGlkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoY29tbWVudHNCdG4sICdwb3NpdGlvbicsICdhYnNvbHV0ZScpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGNvbW1lbnRzQnRuLCAnbGVmdCcsICczcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShjb21tZW50c0J0biwgJ2JvdHRvbScsICcwcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShjb21tZW50c0J0biwgJ2N1cnNvcicsICdwb2ludGVyJyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGljb24gPSB0aGlzLnJlbmRlci5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuYXBwZW5kQ2hpbGQoY29tbWVudHNCdG4sIGljb24pO1xyXG5cclxuICAgICAgICBpY29uLmNsYXNzTmFtZSA9ICdmLWljb24gZi1pY29uLW1lc3NhZ2UnO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGljb24sICdwb3NpdGlvbicsICdyZWxhdGl2ZScpO1xyXG4gICAgICAgIC8vIHRoaXMucmVuZGVyLnNldFN0eWxlKGljb24sICdtYXJnaW4tcmlnaHQnLCAnM3B4Jyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUoaWNvbiwgJ3RvcCcsICcxcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShpY29uLCAnZm9udC1zaXplJywgJzEzcHgnKTtcclxuXHJcbiAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LmFmdGVyKGNvbW1lbnRzQnRuKTtcclxuICAgICAgICB0aGlzLmNvbW1lbnRzQnRuRWxlbWVudCA9IGNvbW1lbnRzQnRuO1xyXG5cclxuICAgICAgICB0aGlzLnJlbmRlci5saXN0ZW4oY29tbWVudHNCdG4sICdjbGljaycsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5saXN0UGFuZWxFbFJlZikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zaG93TGlzdFBhbmVsKCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhpZGVMaXN0UGFuZWwoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzaG93TGlzdFBhbmVsKCkge1xyXG4gICAgICAgIGNvbnN0IGxpc3RQYW5lbEVsID0gdGhpcy5yZW5kZXIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgY29uc3QgeyBsZWZ0LCBib3R0b20gfSA9IHRoaXMuY29tbWVudHNCdG5FbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnd2lkdGgnLCAnMjAwcHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ21heC1oZWlnaHQnLCBgJHt0aGlzLm1heEhlaWdodH1weGApO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAncG9zaXRpb24nLCAnYWJzb2x1dGUnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ2xlZnQnLCBgJHtsZWZ0fXB4YCk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUobGlzdFBhbmVsRWwsICd0b3AnLCAnMHB4Jyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUobGlzdFBhbmVsRWwsICd6LWluZGV4JywgJzk5OTk5OTknKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ2JveC1zaGFkb3cnLCAnMCAycHggOHB4IDAgI2RlZGVkZScpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKGxpc3RQYW5lbEVsLCAnYm9yZGVyLXJhZGl1cycsICc2cHgnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ2JhY2tncm91bmQnLCAnd2hpdGUnKTtcclxuICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZShsaXN0UGFuZWxFbCwgJ3Zpc2liaWxpdHknLCAnaGlkZGVuJyk7XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmQobGlzdFBhbmVsRWwpO1xyXG5cclxuICAgICAgICB0aGlzLmxpc3RQYW5lbEVsUmVmID0gbGlzdFBhbmVsRWw7XHJcblxyXG4gICAgICAgIGNvbnN0IHNpbmdMaXN0Q21mID0gdGhpcy5jZnIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoU2luZ2xlTGlzdENvbXBvbmVudCk7XHJcbiAgICAgICAgdGhpcy5zaW5nTGlzdFJlZiA9IHNpbmdMaXN0Q21mLmNyZWF0ZSh0aGlzLmluamVjdG9yKTtcclxuXHJcbiAgICAgICAgdGhpcy5zaW5nTGlzdFJlZi5pbnN0YW5jZS5zaG93QnV0dG9ucyA9IHRydWU7XHJcbiAgICAgICAgdGhpcy5zaW5nTGlzdFJlZi5pbnN0YW5jZS5lbXB0eURhdGFNc2cgPSB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgndGV4dC5jb21tZW50cy5lbXB0eScpO1xyXG4gICAgICAgIHRoaXMuc2luZ0xpc3RSZWYuaW5zdGFuY2UuYnV0dG9ucyA9IFtcclxuICAgICAgICAgICAgeyBcclxuICAgICAgICAgICAgICAgIHRleHQ6IHRoaXMubWdyVGV4dCA/IHRoaXMubWdyVGV4dCA6IHRoaXMubG9jYWxlU2VyLmdldFZhbHVlKCd0ZXh0LmNvbW1lbnRzLm1hbmFnZXInKSwgXHJcbiAgICAgICAgICAgICAgICBpY29uQ2xzOiAnZi1pY29uIGYtaWNvbi1ob21lLXNldHVwJywgaGFuZGxlcjogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmNvbW1lbnRTZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5oaWRlTGlzdFBhbmVsKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY29tbWVudFNlci5zaG93Q29tbWVudE1hbmFnZURpYWxvZyh7dHlwZTogJ2Zvcm1zJ30pLnN1YnNjcmliZSgoZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgXTtcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLnRleHRGaWVsZCA9ICdtZXNzYWdlJztcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLm1heEl0ZW1zID0gOTk5OTk5O1xyXG5cclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmluc3RhbmNlLml0ZW1DbGljay5zdWJzY3JpYmUoKGUpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdmFsID0gZS5kYXRhWydtZXNzYWdlJ107XHJcbiAgICAgICAgICAgIGxldCBfdGV4dCA9IHRoaXMuZWwubmF0aXZlRWxlbWVudC52YWx1ZSB8fCAnJztcclxuICAgICAgICAgICAgX3RleHQgKz0gdmFsO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5uZ0NvbnRyb2wpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubmdDb250cm9sLmNvbnRyb2wucGF0Y2hWYWx1ZShfdGV4dCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQudmFsdWUgPSBfdGV4dDtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdGhpcy5oaWRlTGlzdFBhbmVsKCk7XHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgbGlzdFBhbmVsRWwuYXBwZW5kQ2hpbGQodGhpcy5zaW5nTGlzdFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAgICAgdGhpcy5sb2FkRGF0YSh0aGlzLnNpbmdMaXN0UmVmKTtcclxuXHJcblxyXG4gICAgICAgIHRoaXMub3ZlcmxheVNlci5yZWdpc3Rlck1vdXNlRXZlbnQobGlzdFBhbmVsRWwsIChlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmxpc3RQYW5lbEVsUmVmLmNvbnRhaW5zKGUudGFyZ2V0KSB8fCB0aGlzLmNvbW1lbnRzQnRuRWxlbWVudCA9PT0gZS50YXJnZXQgfHwgdGhpcy5jb21tZW50c0J0bkVsZW1lbnQuY29udGFpbnMoZS50YXJnZXQpKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5oaWRlTGlzdFBhbmVsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgaGlkZUxpc3RQYW5lbCgpIHtcclxuICAgICAgICBpZiAodGhpcy5zaW5nTGlzdFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLnNpbmdMaXN0UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy5zaW5nTGlzdFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5saXN0UGFuZWxFbFJlZikge1xyXG4gICAgICAgICAgICB0aGlzLmxpc3RQYW5lbEVsUmVmLnJlbW92ZSgpO1xyXG4gICAgICAgICAgICB0aGlzLm92ZXJsYXlTZXIuZGVzdG9yeSh0aGlzLmxpc3RQYW5lbEVsUmVmKTtcclxuICAgICAgICAgICAgdGhpcy5saXN0UGFuZWxFbFJlZiA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbG9hZERhdGEoc2luZ0xpc3RSZWY6IENvbXBvbmVudFJlZjxTaW5nbGVMaXN0Q29tcG9uZW50Pikge1xyXG4gICAgICAgIGlmICh0aGlzLmNvbW1lbnRTZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5jb21tZW50U2VyLmdldENvbW1vbkNvbW1lbnRzKHt0eXBlOiAnZm9ybXMnfSkuc3Vic2NyaWJlKChkYXRhKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBzaW5nTGlzdFJlZi5pbnN0YW5jZS5sb2FkRGF0YShkYXRhKTtcclxuICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVzZXRQb3NpdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc2V0UG9zaXRpb24oKSB7XHJcbiAgICAgICAgY29uc3QgeyB0b3AsIGJvdHRvbSwgbGVmdCB9ID0gdGhpcy5jb21tZW50c0J0bkVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgY29uc3QgcGFuZWxIZWlnaHQgPSB0aGlzLmxpc3RQYW5lbEVsUmVmLm9mZnNldEhlaWdodDtcclxuICAgICAgICBpZiAod2luZG93LmlubmVySGVpZ2h0IC0gYm90dG9tICA+IHRoaXMubWF4SGVpZ2h0IHx8IHdpbmRvdy5pbm5lckhlaWdodCAtIGJvdHRvbSA+IHBhbmVsSGVpZ2h0KSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnNldFN0eWxlKHRoaXMubGlzdFBhbmVsRWxSZWYsICd0b3AnLCBgJHtib3R0b219cHhgKTtcclxuICAgICAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlU3R5bGUodGhpcy5saXN0UGFuZWxFbFJlZiwgJ3Zpc2liaWxpdHknKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0b3AgPiB0aGlzLm1heEhlaWdodCB8fCB0b3AgPiBwYW5lbEhlaWdodCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIuc2V0U3R5bGUodGhpcy5saXN0UGFuZWxFbFJlZiwgJ3RvcCcsIGAke3RvcCAtIHBhbmVsSGVpZ2h0fXB4YCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAndG9wJywgJzBweCcpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGxlZnQgPiAyMDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlci5zZXRTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAnbGVmdCcsIGAkeyBsZWZ0IC0gMjAwIH1weGAgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnJlbmRlci5yZW1vdmVTdHlsZSh0aGlzLmxpc3RQYW5lbEVsUmVmLCAndmlzaWJpbGl0eScpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSJdfQ==