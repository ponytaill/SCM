import * as tslib_1 from "tslib";
import { Modification, ModifyType } from '../changeset/index';
import { Subject } from 'rxjs';
import { Entity, FieldMetadataUtil } from '../entity/index';
// tslint:disable: no-bitwise
/**
 * 实体集合
 * @todo：应该用EntityList代替。
 */
var EntityCollection = /** @class */ (function () {
    /**
     * 构造函数
     */
    function EntityCollection(entityType) {
        this.innerEntitySet = new Set();
        this.innerEntityMap = new Map();
        this.collectionChanged = new Subject();
        this.entityType = entityType;
        this.primaryKey = FieldMetadataUtil.getPrimaryKey(this.entityType);
    }
    /**
     * 实体数量
     */
    EntityCollection.prototype.count = function () {
        return this.innerEntitySet.size;
    };
    Object.defineProperty(EntityCollection.prototype, "entityTypeName", {
        get: function () {
            return this.entityType.name;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 是否包含指定主键值的实体
     * @param id 主键值
     */
    EntityCollection.prototype.has = function (id) {
        return this.innerEntityMap.has(id);
    };
    /**
     * 清空全部实体
     */
    EntityCollection.prototype.clear = function () {
        this.innerEntityMap.clear();
        this.innerEntitySet.clear();
        this.notifyCollectionChanged(new Modification([], ModifyType.Load));
    };
    /**
     * 转换为实体数组
     */
    EntityCollection.prototype.toArray = function () {
        return Array.from(this.innerEntitySet);
    };
    /**
     * 转换为JSON数组
     */
    EntityCollection.prototype.toJSON = function () {
        var result = [];
        var entities = this.toArray();
        entities.forEach(function (entity) {
            result.push(entity.toJSON());
        });
        return result;
    };
    /**
     * 批量加载实体
     */
    EntityCollection.prototype.loadEntities = function (entities) {
        var _this = this;
        this.innerEntityMap.clear();
        this.innerEntitySet.clear();
        entities.forEach(function (entity) {
            _this.innerEntitySet.add(entity);
            _this.innerEntityMap.set(entity[_this.primaryKey], entity);
        });
        this.notifyCollectionChanged(new Modification(entities, ModifyType.Load));
    };
    /**
     * 追加实体
     * @param entity 要追加的实体
     */
    EntityCollection.prototype.addEntity = function (entity) {
        this.verifyEntityToAdd(entity);
        this.innerEntitySet.add(entity);
        this.innerEntityMap.set(entity[this.primaryKey], entity);
        this.notifyCollectionChanged(new Modification([entity], ModifyType.Add));
    };
    /**
     * 批量追加实体
     * @param entities 要加载的实体数组
     */
    EntityCollection.prototype.addEntities = function (entities) {
        var _this = this;
        if (!entities) {
            return;
        }
        var entitiesToAdd = [];
        entities.forEach(function (entity) {
            _this.verifyEntityToAdd(entity);
            entitiesToAdd.push(entity);
        });
        entitiesToAdd.forEach(function (entity) {
            _this.innerEntitySet.add(entity);
            _this.innerEntityMap.set(entity[_this.primaryKey], entity);
        });
        this.notifyCollectionChanged(new Modification(entitiesToAdd, ModifyType.Add));
    };
    /**
     * 根据主键值获取实体
     */
    EntityCollection.prototype.getEntityById = function (identity) {
        if (this.innerEntityMap.has(identity) === false) {
            return null;
        }
        var entity = this.innerEntityMap.get(identity);
        return entity;
    };
    /**
     * 根据路径获取实体
     */
    EntityCollection.prototype.getEntityByPath = function (pathArray) {
        var rootEntityId = pathArray[0].split(':')[1];
        var parentNode = this.getEntityById(rootEntityId);
        for (var i = 1; i < pathArray.length && parentNode; i = i + 1) {
            var currentPath = pathArray[i];
            if (parentNode instanceof Entity) {
                // @todo：强识了别冒号
                if (currentPath.indexOf(':') === -1) {
                    parentNode = parentNode[pathArray[i]];
                }
            }
            else {
                parentNode = parentNode.get(pathArray[i].split(':')[1]);
            }
        }
        return parentNode;
    };
    /**
     * 返回符合指定条件的实体集合
     * @param predicate 条件谓词
     */
    EntityCollection.prototype.getEntities = function (predicate) {
        var entities = Array.from(this.innerEntitySet);
        var matchedEntities = entities.filter(predicate);
        return matchedEntities;
    };
    /**
     * 获取全部实体
     */
    EntityCollection.prototype.getAllEntities = function () {
        return Array.from(this.innerEntitySet);
    };
    /**
     * 根据主键值删除对应实体
     * @param identity 主键值
     */
    EntityCollection.prototype.removeEntityById = function (identity) {
        this.verifyEntityToRemove(identity);
        var entityToRemove = this.innerEntityMap.get(identity);
        this.innerEntityMap.delete(identity);
        this.innerEntitySet.delete(entityToRemove);
        this.notifyCollectionChanged(new Modification([entityToRemove], ModifyType.Remove));
        return entityToRemove;
    };
    EntityCollection.prototype.removeEntitiesByIds = function (id) {
    };
    /**
     * 删除符合条件的实体集合
     */
    EntityCollection.prototype.removeEntities = function (predicate) {
        var _this = this;
        var entitiesToRemove = Array.from(this.innerEntitySet).filter(predicate);
        entitiesToRemove.forEach(function (entityToRemove) {
            _this.innerEntityMap.delete(entityToRemove[_this.primaryKey]);
            _this.innerEntitySet.delete(entityToRemove);
        });
        this.notifyCollectionChanged(new Modification(entitiesToRemove, ModifyType.Remove));
        return entitiesToRemove;
    };
    /**
     * 重置子表数据
     * @param paths 路径
     * 路径格式 ['实体主键:主键值','从表Codes','从从表Codes']
     * @param entities 实体数组
     */
    EntityCollection.prototype.resetEntities = function (paths, entities) {
        var e_1, _a;
        if (paths[0].indexOf(':') === -1) {
            throw new Error('路径格式错误');
        }
        // paths里面第一个一定是id
        var entityInfo = paths[0].split(':');
        var _b = tslib_1.__read(entityInfo, 2), entityPrimaryKey = _b[0], entityId = _b[1];
        var entity = null;
        try {
            for (var _c = tslib_1.__values(this.innerEntitySet), _d = _c.next(); !_d.done; _d = _c.next()) {
                var element = _d.value;
                if (element[entityPrimaryKey] === entityId) {
                    entity = element;
                    break;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (_d && !_d.done && (_a = _c.return)) _a.call(_c);
            }
            finally { if (e_1) throw e_1.error; }
        }
        // for (let index = 0; index < this.innerEntitySet; index++) {
        //   const element: T = this.innerEntitySet[index];
        //   if (element[entityPrimaryKey] === entityId) {
        //     entity = element;
        //     break;
        //   }
        // }
        if (!entity) {
            throw new Error("\u627E\u4E0D\u5230" + entityPrimaryKey + "\u4E3A" + entityId + "\u7684\u5B9E\u4F53");
        }
        var data = entity;
        paths.slice(1).forEach(function (path) {
            data = data[path];
        });
        var entityList = data;
        entityList.clear();
        entityList.loadEntities(entities);
    };
    /**
     * 验证实体是否能够添加
     */
    EntityCollection.prototype.verifyEntityToAdd = function (entity) {
        if (this.has(entity[this.primaryKey])) {
            this.innerEntitySet.delete(this.innerEntityMap.get(entity[this.primaryKey]));
            this.innerEntityMap.delete(entity[this.primaryKey]);
            // throw new Error(`The repository already had an item with the save identity of '${entity[this.primaryKey]}'`);
        }
        return true;
    };
    /**
     * 验证实体是否能移除
     */
    EntityCollection.prototype.verifyEntityToRemove = function (identity) {
        if (!this.has(identity)) {
            throw new Error("The entity with identity of '" + identity + " dose not exsit.'");
        }
        return true;
    };
    /**
     * 实体集合变更流
     */
    EntityCollection.prototype.notifyCollectionChanged = function (modification) {
        this.collectionChanged.next(modification);
    };
    Object.defineProperty(EntityCollection.prototype, "pageSize", {
        /**
         * 获取分页大小
         * @description 如果用户未指定分页大小则默认为0，即获取所有数据
         */
        get: function () {
            if (!!this.paginationInfo) {
                return this.paginationInfo.pageSize || 0;
            }
            return 0;
        },
        //#region 分页
        /**
         * 设置分页大小
         */
        set: function (pageSize) {
            if (typeof (pageSize) !== 'number' || pageSize < 0) {
                throw new Error('Invalid parameter:pageSize');
            }
            var original = this.paginationInfo;
            // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { pageSize });
            // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });
            // this.notifyCollectionChanged(new Modification(this.paginationInfo[this.entityTypeName], ModifyType.PaginationInfoChange));
            this.paginationInfo = Object.assign({}, original, { pageSize: pageSize });
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityCollection.prototype, "totalCount", {
        /**
         * 获取数据总条数
         */
        get: function () {
            if (!!this.paginationInfo) {
                return this.paginationInfo.total || 0;
            }
            return 0;
        },
        /**
         * 设置数据总条数
         */
        set: function (total) {
            if (typeof (total) !== 'number' || total < 0) {
                throw new Error('Invalid parameter:total');
            }
            var original = this.paginationInfo;
            // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { total });
            // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });
            this.paginationInfo = Object.assign({}, original, { total: total });
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityCollection.prototype, "pageIndex", {
        /**
         * 获取当前页码
         */
        get: function () {
            if (!!this.paginationInfo) {
                return this.paginationInfo.pageIndex || 1;
            }
            return 1;
        },
        /**
         * 设置当前页码
         */
        set: function (pageIndex) {
            if (typeof (pageIndex) !== 'number' || pageIndex < 0) {
                throw new Error('Invalid parameter:pageIndex');
            }
            var original = this.paginationInfo;
            // const entityPaginationInfo = Object.assign({}, original[this.entityTypeName], { pageIndex });
            // this.paginationInfo = Object.assign({}, original, { [this.entityTypeName]: entityPaginationInfo });
            this.paginationInfo = Object.assign({}, original, { pageIndex: pageIndex });
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 更新分页信息
     * @param path 绑定路径
     * @param pageInfo 分页信息
     */
    EntityCollection.prototype.updatePaginationInfoByPath = function (path, pageInfo) {
        var original = this.paginationInfo;
        var pageIndex = pageInfo.pageIndex, pageSize = pageInfo.pageSize, total = pageInfo.totalCount;
        var paginationInfo = Object.assign({}, original, { pageIndex: pageIndex, pageSize: pageSize, total: total });
        this.setPaginationConfigByPath(path, paginationInfo);
    };
    /**
     * 根据路径获取分页大小
     * @param path 路径
     */
    EntityCollection.prototype.getPaginationConfigByPath = function (path, defaultValue) {
        if (!path || path === '/') {
            return this.paginationInfo;
        }
        if (typeof path !== 'string') {
            throw new Error('路径必须为字符串！');
        }
        path = path.substring(1);
        var paths = path.split('/').filter(function (item) { return !!item && item.trim().length > 0; }).map(function (item) { return item.trim(); });
        var config = this.paginationInfo;
        paths.forEach(function (item) {
            if (config && config.hasOwnProperty(item)) {
                config = config[item];
            }
            else {
                config = null;
            }
        });
        return !!config ? config : typeof defaultValue !== 'undefined' ? defaultValue : undefined;
    };
    /**
     * 设置分页信息
     * @param path 路径
     * @param value 值
     */
    EntityCollection.prototype.setPaginationConfigByPath = function (path, value) {
        var original = JSON.stringify(this.paginationInfo);
        if (!path || path === '/') {
            this.paginationInfo = value;
        }
        else {
            if (!Array.isArray(path)) {
                path = path.toString().match(/[^/[\]]+/g) || [];
            }
            path.slice(0, -1).reduce(function (prev, current, index) {
                return Object(prev[current]) === prev[current]
                    ? prev[current]
                    : prev[current] = Math.abs(path[index + 1]) >> 0 === +path[index + 1]
                        ? []
                        : {};
            }, this.paginationInfo)[path[path.length - 1]] = value;
        }
        if (JSON.stringify(this.paginationInfo) !== original) {
            this.notifyCollectionChanged(new Modification(this.paginationInfo, ModifyType.PaginationInfoChange));
        }
        return this.paginationInfo;
    };
    return EntityCollection;
}());
export { EntityCollection };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2NvbGxlY3Rpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvcmVwb3NpdG9yeS9lbnRpdHlfY29sbGVjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBT0EsT0FBTyxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxNQUFNLEVBQUUsaUJBQWlCLEVBQWMsTUFBTSxpQkFBaUIsQ0FBQztBQUN4RSw2QkFBNkI7QUFDN0I7OztHQUdHO0FBQ0g7SUFrQ0U7O09BRUc7SUFDSCwwQkFBWSxVQUFtQjtRQUM3QixJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksR0FBRyxFQUFLLENBQUM7UUFDbkMsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBYSxDQUFDO1FBQzNDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLE9BQU8sRUFBZ0IsQ0FBQztRQUVyRCxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsVUFBVSxHQUFHLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDckUsQ0FBQztJQUVEOztPQUVHO0lBQ0ksZ0NBQUssR0FBWjtRQUNFLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUM7SUFDbEMsQ0FBQztJQUVELHNCQUFXLDRDQUFjO2FBQXpCO1lBQ0UsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztRQUM5QixDQUFDOzs7T0FBQTtJQUNEOzs7T0FHRztJQUNJLDhCQUFHLEdBQVYsVUFBVyxFQUFVO1FBQ25CLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVEOztP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QUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQzt3QkFDbkUsQ0FBQyxDQUFDLEVBQUU7d0JBQ0osQ0FBQyxDQUFDLEVBQUU7WUFKUixDQUlRLEVBQ1IsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBQ3ZEO1FBRUQsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxRQUFRLEVBQUU7WUFDcEQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsVUFBVSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQztTQUN0RztRQUNELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztJQUM3QixDQUFDO0lBRUgsdUJBQUM7QUFBRCxDQUFDLEFBdmFELElBdWFDO0FBRUQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE4LTEwLTAxIDE5OjM2OjUxXHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBhYWxpenp3ZWxsXHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTktMDktMDMgMTk6NDY6NDJcclxuICovXHJcbmltcG9ydCB7IFR5cGUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcclxuaW1wb3J0IHsgTW9kaWZpY2F0aW9uLCBNb2RpZnlUeXBlIH0gZnJvbSAnLi4vY2hhbmdlc2V0L2luZGV4JztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBFbnRpdHksIEZpZWxkTWV0YWRhdGFVdGlsLCBFbnRpdHlMaXN0IH0gZnJvbSAnLi4vZW50aXR5L2luZGV4JztcclxuLy8gdHNsaW50OmRpc2FibGU6IG5vLWJpdHdpc2VcclxuLyoqXHJcbiAqIOWunuS9k+mbhuWQiFxyXG4gKiBAdG9kb++8muW6lOivpeeUqEVudGl0eUxpc3Tku6Pmm7/jgIJcclxuICovXHJcbmNsYXNzIEVudGl0eUNvbGxlY3Rpb248VCBleHRlbmRzIEVudGl0eT4ge1xyXG5cclxuICAvKipcclxuICAgKiDlhoXpg6jlrp7kvZNTZXRcclxuICAgKi9cclxuICBwcml2YXRlIGlubmVyRW50aXR5U2V0OiBTZXQ8VD47XHJcblxyXG4gIC8qKlxyXG4gICAqIOWGhemDqOWunuS9k01hcFxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5uZXJFbnRpdHlNYXA6IE1hcDxzdHJpbmcsIFQ+O1xyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogRW50aXR56ZuG5ZCI5Y+Y5pu05rWBXHJcbiAgICovXHJcbiAgcHVibGljIGNvbGxlY3Rpb25DaGFuZ2VkOiBTdWJqZWN0PE1vZGlmaWNhdGlvbj47XHJcblxyXG4gIC8qKlxyXG4gICAqIOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIHB1YmxpYyByZWFkb25seSBlbnRpdHlUeXBlOiBUeXBlPFQ+O1xyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPkuLvplK5cclxuICAgKi9cclxuICBwdWJsaWMgcmVhZG9ubHkgcHJpbWFyeUtleTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPlvZPliY3liIbpobXkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgcGFnaW5hdGlvbkluZm86IGFueTtcclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGVudGl0eVR5cGU6IFR5cGU8VD4pIHtcclxuICAgIHRoaXMuaW5uZXJFbnRpdHlTZXQgPSBuZXcgU2V0PFQ+KCk7XHJcbiAgICB0aGlzLmlubmVyRW50aXR5TWFwID0gbmV3IE1hcDxzdHJpbmcsIFQ+KCk7XHJcbiAgICB0aGlzLmNvbGxlY3Rpb25DaGFuZ2VkID0gbmV3IFN1YmplY3Q8TW9kaWZpY2F0aW9uPigpO1xyXG5cclxuICAgIHRoaXMuZW50aXR5VHlwZSA9IGVudGl0eVR5cGU7XHJcbiAgICB0aGlzLnByaW1hcnlLZXkgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXRQcmltYXJ5S2V5KHRoaXMuZW50aXR5VHlwZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlrp7kvZPmlbDph49cclxuICAgKi9cclxuICBwdWJsaWMgY291bnQoKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLmlubmVyRW50aXR5U2V0LnNpemU7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0IGVudGl0eVR5cGVOYW1lKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZW50aXR5VHlwZS5uYW1lO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmmK/lkKbljIXlkKvmjIflrprkuLvplK7lgLznmoTlrp7kvZNcclxuICAgKiBAcGFyYW0gaWQg5Li76ZSu5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGhhcyhpZDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy5pbm5lckVudGl0eU1hcC5oYXMoaWQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF56m65YWo6YOo5a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyKCkge1xyXG4gICAgdGhpcy5pbm5lckVudGl0eU1hcC5jbGVhcigpO1xyXG4gICAgdGhpcy5pbm5lckVudGl0eVNldC5jbGVhcigpO1xyXG4gICAgdGhpcy5ub3RpZnlDb2xsZWN0aW9uQ2hhbmdlZChuZXcgTW9kaWZpY2F0aW9uKFtdLCBNb2RpZnlUeXBlLkxvYWQpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouS4uuWunuS9k+aVsOe7hFxyXG4gICAqL1xyXG4gIHB1YmxpYyB0b0FycmF5KCk6IEVudGl0eVtdIHtcclxuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuaW5uZXJFbnRpdHlTZXQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6L2s5o2i5Li6SlNPTuaVsOe7hFxyXG4gICAqL1xyXG4gIHB1YmxpYyB0b0pTT04oKTogYW55W10ge1xyXG4gICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMudG9BcnJheSgpO1xyXG4gICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgcmVzdWx0LnB1c2goZW50aXR5LnRvSlNPTigpKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+WKoOi9veWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBsb2FkRW50aXRpZXMoZW50aXRpZXM6IGFueVtdKSB7XHJcblxyXG4gICAgdGhpcy5pbm5lckVudGl0eU1hcC5jbGVhcigpO1xyXG4gICAgdGhpcy5pbm5lckVudGl0eVNldC5jbGVhcigpO1xyXG5cclxuICAgIGVudGl0aWVzLmZvckVhY2goZW50aXR5ID0+IHtcclxuICAgICAgdGhpcy5pbm5lckVudGl0eVNldC5hZGQoZW50aXR5KTtcclxuICAgICAgdGhpcy5pbm5lckVudGl0eU1hcC5zZXQoZW50aXR5W3RoaXMucHJpbWFyeUtleV0sIGVudGl0eSk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMubm90aWZ5Q29sbGVjdGlvbkNoYW5nZWQobmV3IE1vZGlmaWNhdGlvbihlbnRpdGllcywgTW9kaWZ5VHlwZS5Mb2FkKSk7XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6L+95Yqg5a6e5L2TXHJcbiAgICogQHBhcmFtIGVudGl0eSDopoHov73liqDnmoTlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgYWRkRW50aXR5KGVudGl0eTogVCkge1xyXG4gICAgdGhpcy52ZXJpZnlFbnRpdHlUb0FkZChlbnRpdHkpO1xyXG4gICAgdGhpcy5pbm5lckVudGl0eVNldC5hZGQoZW50aXR5KTtcclxuICAgIHRoaXMuaW5uZXJFbnRpdHlNYXAuc2V0KGVudGl0eVt0aGlzLnByaW1hcnlLZXldLCBlbnRpdHkpO1xyXG4gICAgdGhpcy5ub3RpZnlDb2xsZWN0aW9uQ2hhbmdlZChuZXcgTW9kaWZpY2F0aW9uKFtlbnRpdHldLCBNb2RpZnlUeXBlLkFkZCkpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP6L+95Yqg5a6e5L2TXHJcbiAgICogQHBhcmFtIGVudGl0aWVzIOimgeWKoOi9veeahOWunuS9k+aVsOe7hFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRFbnRpdGllcyhlbnRpdGllczogVFtdKSB7XHJcbiAgICBpZiAoIWVudGl0aWVzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGVudGl0aWVzVG9BZGQ6IFRbXSA9IFtdO1xyXG4gICAgZW50aXRpZXMuZm9yRWFjaChlbnRpdHkgPT4ge1xyXG4gICAgICB0aGlzLnZlcmlmeUVudGl0eVRvQWRkKGVudGl0eSk7XHJcbiAgICAgIGVudGl0aWVzVG9BZGQucHVzaChlbnRpdHkpO1xyXG4gICAgfSk7XHJcbiAgICBlbnRpdGllc1RvQWRkLmZvckVhY2goZW50aXR5ID0+IHtcclxuICAgICAgdGhpcy5pbm5lckVudGl0eVNldC5hZGQoZW50aXR5KTtcclxuICAgICAgdGhpcy5pbm5lckVudGl0eU1hcC5zZXQoZW50aXR5W3RoaXMucHJpbWFyeUtleV0sIGVudGl0eSk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMubm90aWZ5Q29sbGVjdGlvbkNoYW5nZWQobmV3IE1vZGlmaWNhdGlvbihlbnRpdGllc1RvQWRkLCBNb2RpZnlUeXBlLkFkZCkpO1xyXG4gIH1cclxuXHJcblxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja7kuLvplK7lgLzojrflj5blrp7kvZNcclxuICAgKi9cclxuICBnZXRFbnRpdHlCeUlkKGlkZW50aXR5OiBzdHJpbmcpOiBUIHtcclxuICAgIGlmICh0aGlzLmlubmVyRW50aXR5TWFwLmhhcyhpZGVudGl0eSkgPT09IGZhbHNlKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5pbm5lckVudGl0eU1hcC5nZXQoaWRlbnRpdHkpO1xyXG4gICAgcmV0dXJuIGVudGl0eTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNrui3r+W+hOiOt+WPluWunuS9k1xyXG4gICAqL1xyXG4gIGdldEVudGl0eUJ5UGF0aChwYXRoQXJyYXk6IHN0cmluZ1tdKTogYW55IHtcclxuICAgIGNvbnN0IHJvb3RFbnRpdHlJZCA9IHBhdGhBcnJheVswXS5zcGxpdCgnOicpWzFdO1xyXG5cclxuICAgIGxldCBwYXJlbnROb2RlOiBhbnkgPSB0aGlzLmdldEVudGl0eUJ5SWQocm9vdEVudGl0eUlkKTtcclxuICAgIGZvciAobGV0IGkgPSAxOyBpIDwgcGF0aEFycmF5Lmxlbmd0aCAmJiBwYXJlbnROb2RlOyBpID0gaSArIDEpIHtcclxuICAgICAgY29uc3QgY3VycmVudFBhdGggPSBwYXRoQXJyYXlbaV07XHJcbiAgICAgIGlmIChwYXJlbnROb2RlIGluc3RhbmNlb2YgRW50aXR5KSB7XHJcblxyXG4gICAgICAgIC8vIEB0b2Rv77ya5by66K+G5LqG5Yir5YaS5Y+3XHJcbiAgICAgICAgaWYgKGN1cnJlbnRQYXRoLmluZGV4T2YoJzonKSA9PT0gLTEpIHtcclxuICAgICAgICAgIHBhcmVudE5vZGUgPSBwYXJlbnROb2RlW3BhdGhBcnJheVtpXV07XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHBhcmVudE5vZGUgPSBwYXJlbnROb2RlLmdldChwYXRoQXJyYXlbaV0uc3BsaXQoJzonKVsxXSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcGFyZW50Tm9kZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi/lOWbnuespuWQiOaMh+WumuadoeS7tueahOWunuS9k+mbhuWQiFxyXG4gICAqIEBwYXJhbSBwcmVkaWNhdGUg5p2h5Lu26LCT6K+NXHJcbiAgICovXHJcbiAgZ2V0RW50aXRpZXMocHJlZGljYXRlOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIsIGFycmF5OiBUW10pID0+IFQpOiBUW10ge1xyXG4gICAgY29uc3QgZW50aXRpZXM6IFRbXSA9IEFycmF5LmZyb20odGhpcy5pbm5lckVudGl0eVNldCk7XHJcbiAgICBjb25zdCBtYXRjaGVkRW50aXRpZXMgPSBlbnRpdGllcy5maWx0ZXIocHJlZGljYXRlKTtcclxuICAgIHJldHVybiBtYXRjaGVkRW50aXRpZXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blhajpg6jlrp7kvZNcclxuICAgKi9cclxuICBnZXRBbGxFbnRpdGllcygpOiBUW10ge1xyXG4gICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5pbm5lckVudGl0eVNldCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja7kuLvplK7lgLzliKDpmaTlr7nlupTlrp7kvZNcclxuICAgKiBAcGFyYW0gaWRlbnRpdHkg5Li76ZSu5YC8XHJcbiAgICovXHJcbiAgcmVtb3ZlRW50aXR5QnlJZChpZGVudGl0eTogc3RyaW5nKTogVCB7XHJcbiAgICB0aGlzLnZlcmlmeUVudGl0eVRvUmVtb3ZlKGlkZW50aXR5KTtcclxuICAgIGNvbnN0IGVudGl0eVRvUmVtb3ZlID0gdGhpcy5pbm5lckVudGl0eU1hcC5nZXQoaWRlbnRpdHkpO1xyXG4gICAgdGhpcy5pbm5lckVudGl0eU1hcC5kZWxldGUoaWRlbnRpdHkpO1xyXG4gICAgdGhpcy5pbm5lckVudGl0eVNldC5kZWxldGUoZW50aXR5VG9SZW1vdmUpO1xyXG4gICAgdGhpcy5ub3RpZnlDb2xsZWN0aW9uQ2hhbmdlZChuZXcgTW9kaWZpY2F0aW9uKFtlbnRpdHlUb1JlbW92ZV0sIE1vZGlmeVR5cGUuUmVtb3ZlKSk7XHJcbiAgICByZXR1cm4gZW50aXR5VG9SZW1vdmU7XHJcbiAgfVxyXG5cclxuICByZW1vdmVFbnRpdGllc0J5SWRzKGlkOiBzdHJpbmcpIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOespuWQiOadoeS7tueahOWunuS9k+mbhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVFbnRpdGllcyhwcmVkaWNhdGU6ICh2YWx1ZTogVCwgaW5kZXg6IG51bWJlciwgYXJyYXk6IFRbXSkgPT4gYW55KTogVFtdIHtcclxuICAgIGNvbnN0IGVudGl0aWVzVG9SZW1vdmUgPSBBcnJheS5mcm9tKHRoaXMuaW5uZXJFbnRpdHlTZXQpLmZpbHRlcihwcmVkaWNhdGUpO1xyXG4gICAgZW50aXRpZXNUb1JlbW92ZS5mb3JFYWNoKGVudGl0eVRvUmVtb3ZlID0+IHtcclxuICAgICAgdGhpcy5pbm5lckVudGl0eU1hcC5kZWxldGUoZW50aXR5VG9SZW1vdmVbdGhpcy5wcmltYXJ5S2V5XSk7XHJcbiAgICAgIHRoaXMuaW5uZXJFbnRpdHlTZXQuZGVsZXRlKGVudGl0eVRvUmVtb3ZlKTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5ub3RpZnlDb2xsZWN0aW9uQ2hhbmdlZChuZXcgTW9kaWZpY2F0aW9uKGVudGl0aWVzVG9SZW1vdmUsIE1vZGlmeVR5cGUuUmVtb3ZlKSk7XHJcbiAgICByZXR1cm4gZW50aXRpZXNUb1JlbW92ZTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6YeN572u5a2Q6KGo5pWw5o2uXHJcbiAgICogQHBhcmFtIHBhdGhzIOi3r+W+hCAgXHJcbiAgICog6Lev5b6E5qC85byPIFsn5a6e5L2T5Li76ZSuOuS4u+mUruWAvCcsJ+S7juihqENvZGVzJywn5LuO5LuO6KGoQ29kZXMnXVxyXG4gICAqIEBwYXJhbSBlbnRpdGllcyDlrp7kvZPmlbDnu4RcclxuICAgKi9cclxuICBwdWJsaWMgcmVzZXRFbnRpdGllcyhwYXRoczogc3RyaW5nW10sIGVudGl0aWVzOiBUW10pIHtcclxuICAgIGlmIChwYXRoc1swXS5pbmRleE9mKCc6JykgPT09IC0xKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcign6Lev5b6E5qC85byP6ZSZ6K+vJyk7XHJcbiAgICB9XHJcbiAgICAvLyBwYXRoc+mHjOmdouesrOS4gOS4quS4gOWumuaYr2lkXHJcbiAgICBjb25zdCBlbnRpdHlJbmZvOiBzdHJpbmdbXSA9IHBhdGhzWzBdLnNwbGl0KCc6Jyk7XHJcbiAgICBjb25zdCBbZW50aXR5UHJpbWFyeUtleSwgZW50aXR5SWRdID0gZW50aXR5SW5mbztcclxuICAgIGxldCBlbnRpdHk6IFQgPSBudWxsO1xyXG4gICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHRoaXMuaW5uZXJFbnRpdHlTZXQpIHtcclxuICAgICAgaWYgKGVsZW1lbnRbZW50aXR5UHJpbWFyeUtleV0gPT09IGVudGl0eUlkKSB7XHJcbiAgICAgICAgZW50aXR5ID0gZWxlbWVudDtcclxuICAgICAgICBicmVhaztcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgLy8gZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IHRoaXMuaW5uZXJFbnRpdHlTZXQ7IGluZGV4KyspIHtcclxuICAgIC8vICAgY29uc3QgZWxlbWVudDogVCA9IHRoaXMuaW5uZXJFbnRpdHlTZXRbaW5kZXhdO1xyXG4gICAgLy8gICBpZiAoZWxlbWVudFtlbnRpdHlQcmltYXJ5S2V5XSA9PT0gZW50aXR5SWQpIHtcclxuICAgIC8vICAgICBlbnRpdHkgPSBlbGVtZW50O1xyXG4gICAgLy8gICAgIGJyZWFrO1xyXG4gICAgLy8gICB9XHJcbiAgICAvLyB9XHJcbiAgICBpZiAoIWVudGl0eSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYOaJvuS4jeWIsCR7ZW50aXR5UHJpbWFyeUtleX3kuLoke2VudGl0eUlkfeeahOWunuS9k2ApO1xyXG4gICAgfVxyXG4gICAgbGV0IGRhdGE6IGFueSA9IGVudGl0eTtcclxuICAgIHBhdGhzLnNsaWNlKDEpLmZvckVhY2gocGF0aCA9PiB7XHJcbiAgICAgIGRhdGEgPSBkYXRhW3BhdGhdO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBlbnRpdHlMaXN0ID0gZGF0YSBhcyBFbnRpdHlMaXN0PFQ+O1xyXG4gICAgZW50aXR5TGlzdC5jbGVhcigpO1xyXG4gICAgZW50aXR5TGlzdC5sb2FkRW50aXRpZXMoZW50aXRpZXMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6aqM6K+B5a6e5L2T5piv5ZCm6IO95aSf5re75YqgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB2ZXJpZnlFbnRpdHlUb0FkZChlbnRpdHk6IFQpOiBib29sZWFuIHtcclxuICAgIGlmICh0aGlzLmhhcyhlbnRpdHlbdGhpcy5wcmltYXJ5S2V5XSkpIHtcclxuICAgICAgdGhpcy5pbm5lckVudGl0eVNldC5kZWxldGUodGhpcy5pbm5lckVudGl0eU1hcC5nZXQoZW50aXR5W3RoaXMucHJpbWFyeUtleV0pKTtcclxuICAgICAgdGhpcy5pbm5lckVudGl0eU1hcC5kZWxldGUoZW50aXR5W3RoaXMucHJpbWFyeUtleV0pO1xyXG4gICAgICAvLyB0aHJvdyBuZXcgRXJyb3IoYFRoZSByZXBvc2l0b3J5IGFscmVhZHkgaGFkIGFuIGl0ZW0gd2l0aCB0aGUgc2F2ZSBpZGVudGl0eSBvZiAnJHtlbnRpdHlbdGhpcy5wcmltYXJ5S2V5XX0nYCk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOmqjOivgeWunuS9k+aYr+WQpuiDveenu+mZpFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdmVyaWZ5RW50aXR5VG9SZW1vdmUoaWRlbnRpdHk6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKCF0aGlzLmhhcyhpZGVudGl0eSkpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgZW50aXR5IHdpdGggaWRlbnRpdHkgb2YgJyR7aWRlbnRpdHl9IGRvc2Ugbm90IGV4c2l0LidgKTtcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T6ZuG5ZCI5Y+Y5pu05rWBXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBub3RpZnlDb2xsZWN0aW9uQ2hhbmdlZChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xyXG4gICAgdGhpcy5jb2xsZWN0aW9uQ2hhbmdlZC5uZXh0KG1vZGlmaWNhdGlvbik7XHJcbiAgfVxyXG5cclxuICAvLyNyZWdpb24g5YiG6aG1XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruWIhumhteWkp+Wwj1xyXG4gICAqL1xyXG4gIHNldCBwYWdlU2l6ZShwYWdlU2l6ZTogbnVtYmVyKSB7XHJcbiAgICBpZiAodHlwZW9mIChwYWdlU2l6ZSkgIT09ICdudW1iZXInIHx8IHBhZ2VTaXplIDwgMCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgcGFyYW1ldGVyOnBhZ2VTaXplJyk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgb3JpZ2luYWwgPSB0aGlzLnBhZ2luYXRpb25JbmZvO1xyXG4gICAgLy8gY29uc3QgZW50aXR5UGFnaW5hdGlvbkluZm8gPSBPYmplY3QuYXNzaWduKHt9LCBvcmlnaW5hbFt0aGlzLmVudGl0eVR5cGVOYW1lXSwgeyBwYWdlU2l6ZSB9KTtcclxuICAgIC8vIHRoaXMucGFnaW5hdGlvbkluZm8gPSBPYmplY3QuYXNzaWduKHt9LCBvcmlnaW5hbCwgeyBbdGhpcy5lbnRpdHlUeXBlTmFtZV06IGVudGl0eVBhZ2luYXRpb25JbmZvIH0pO1xyXG4gICAgLy8gdGhpcy5ub3RpZnlDb2xsZWN0aW9uQ2hhbmdlZChuZXcgTW9kaWZpY2F0aW9uKHRoaXMucGFnaW5hdGlvbkluZm9bdGhpcy5lbnRpdHlUeXBlTmFtZV0sIE1vZGlmeVR5cGUuUGFnaW5hdGlvbkluZm9DaGFuZ2UpKTtcclxuICAgIHRoaXMucGFnaW5hdGlvbkluZm8gPSBPYmplY3QuYXNzaWduKHt9LCBvcmlnaW5hbCwgeyBwYWdlU2l6ZSB9KTtcclxuICAgIHRoaXMubm90aWZ5Q29sbGVjdGlvbkNoYW5nZWQobmV3IE1vZGlmaWNhdGlvbih0aGlzLnBhZ2luYXRpb25JbmZvLCBNb2RpZnlUeXBlLlBhZ2luYXRpb25JbmZvQ2hhbmdlKSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWIhumhteWkp+Wwj1xyXG4gICAqIEBkZXNjcmlwdGlvbiDlpoLmnpznlKjmiLfmnKrmjIflrprliIbpobXlpKflsI/liJnpu5jorqTkuLow77yM5Y2z6I635Y+W5omA5pyJ5pWw5o2uXHJcbiAgICovXHJcbiAgZ2V0IHBhZ2VTaXplKCk6IG51bWJlciB7XHJcbiAgICBpZiAoISF0aGlzLnBhZ2luYXRpb25JbmZvKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnBhZ2luYXRpb25JbmZvLnBhZ2VTaXplIHx8IDA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6+572u5pWw5o2u5oC75p2h5pWwXHJcbiAgICovXHJcbiAgc2V0IHRvdGFsQ291bnQodG90YWw6IG51bWJlcikge1xyXG4gICAgaWYgKHR5cGVvZiAodG90YWwpICE9PSAnbnVtYmVyJyB8fCB0b3RhbCA8IDApIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHBhcmFtZXRlcjp0b3RhbCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG9yaWdpbmFsID0gdGhpcy5wYWdpbmF0aW9uSW5mbztcclxuICAgIC8vIGNvbnN0IGVudGl0eVBhZ2luYXRpb25JbmZvID0gT2JqZWN0LmFzc2lnbih7fSwgb3JpZ2luYWxbdGhpcy5lbnRpdHlUeXBlTmFtZV0sIHsgdG90YWwgfSk7XHJcbiAgICAvLyB0aGlzLnBhZ2luYXRpb25JbmZvID0gT2JqZWN0LmFzc2lnbih7fSwgb3JpZ2luYWwsIHsgW3RoaXMuZW50aXR5VHlwZU5hbWVdOiBlbnRpdHlQYWdpbmF0aW9uSW5mbyB9KTtcclxuICAgIHRoaXMucGFnaW5hdGlvbkluZm8gPSBPYmplY3QuYXNzaWduKHt9LCBvcmlnaW5hbCwgeyB0b3RhbCB9KTtcclxuICAgIHRoaXMubm90aWZ5Q29sbGVjdGlvbkNoYW5nZWQobmV3IE1vZGlmaWNhdGlvbih0aGlzLnBhZ2luYXRpb25JbmZvLCBNb2RpZnlUeXBlLlBhZ2luYXRpb25JbmZvQ2hhbmdlKSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaVsOaNruaAu+adoeaVsFxyXG4gICAqL1xyXG4gIGdldCB0b3RhbENvdW50KCk6IG51bWJlciB7XHJcbiAgICBpZiAoISF0aGlzLnBhZ2luYXRpb25JbmZvKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLnBhZ2luYXRpb25JbmZvLnRvdGFsIHx8IDA7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6K6+572u5b2T5YmN6aG156CBXHJcbiAgICovXHJcbiAgc2V0IHBhZ2VJbmRleChwYWdlSW5kZXg6IG51bWJlcikge1xyXG4gICAgaWYgKHR5cGVvZiAocGFnZUluZGV4KSAhPT0gJ251bWJlcicgfHwgcGFnZUluZGV4IDwgMCkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgcGFyYW1ldGVyOnBhZ2VJbmRleCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG9yaWdpbmFsID0gdGhpcy5wYWdpbmF0aW9uSW5mbztcclxuICAgIC8vIGNvbnN0IGVudGl0eVBhZ2luYXRpb25JbmZvID0gT2JqZWN0LmFzc2lnbih7fSwgb3JpZ2luYWxbdGhpcy5lbnRpdHlUeXBlTmFtZV0sIHsgcGFnZUluZGV4IH0pO1xyXG4gICAgLy8gdGhpcy5wYWdpbmF0aW9uSW5mbyA9IE9iamVjdC5hc3NpZ24oe30sIG9yaWdpbmFsLCB7IFt0aGlzLmVudGl0eVR5cGVOYW1lXTogZW50aXR5UGFnaW5hdGlvbkluZm8gfSk7XHJcbiAgICB0aGlzLnBhZ2luYXRpb25JbmZvID0gT2JqZWN0LmFzc2lnbih7fSwgb3JpZ2luYWwsIHsgcGFnZUluZGV4IH0pO1xyXG4gICAgdGhpcy5ub3RpZnlDb2xsZWN0aW9uQ2hhbmdlZChuZXcgTW9kaWZpY2F0aW9uKHRoaXMucGFnaW5hdGlvbkluZm8sIE1vZGlmeVR5cGUuUGFnaW5hdGlvbkluZm9DaGFuZ2UpKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5b2T5YmN6aG156CBXHJcbiAgICovXHJcbiAgZ2V0IHBhZ2VJbmRleCgpOiBudW1iZXIge1xyXG4gICAgaWYgKCEhdGhpcy5wYWdpbmF0aW9uSW5mbykge1xyXG4gICAgICByZXR1cm4gdGhpcy5wYWdpbmF0aW9uSW5mby5wYWdlSW5kZXggfHwgMTtcclxuICAgIH1cclxuICAgIHJldHVybiAxO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmm7TmlrDliIbpobXkv6Hmga9cclxuICAgKiBAcGFyYW0gcGF0aCDnu5Hlrprot6/lvoRcclxuICAgKiBAcGFyYW0gcGFnZUluZm8g5YiG6aG15L+h5oGvXHJcbiAgICovXHJcbiAgcHVibGljIHVwZGF0ZVBhZ2luYXRpb25JbmZvQnlQYXRoKHBhdGg6IHN0cmluZywgcGFnZUluZm86IHsgcGFnZUluZGV4OiBhbnksIHBhZ2VTaXplOiBhbnksIHRvdGFsQ291bnQ6IGFueSwgW3Byb3A6IHN0cmluZ106IGFueSB9KSB7XHJcbiAgICBjb25zdCBvcmlnaW5hbCA9IHRoaXMucGFnaW5hdGlvbkluZm87XHJcbiAgICBjb25zdCB7IHBhZ2VJbmRleCwgcGFnZVNpemUsIHRvdGFsQ291bnQ6IHRvdGFsIH0gPSBwYWdlSW5mbztcclxuICAgIGNvbnN0IHBhZ2luYXRpb25JbmZvID0gT2JqZWN0LmFzc2lnbih7fSwgb3JpZ2luYWwsIHsgcGFnZUluZGV4LCBwYWdlU2l6ZSwgdG90YWwgfSk7XHJcbiAgICB0aGlzLnNldFBhZ2luYXRpb25Db25maWdCeVBhdGgocGF0aCwgcGFnaW5hdGlvbkluZm8pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoLnmja7ot6/lvoTojrflj5bliIbpobXlpKflsI9cclxuICAgKiBAcGFyYW0gcGF0aCDot6/lvoRcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UGFnaW5hdGlvbkNvbmZpZ0J5UGF0aChwYXRoOiBzdHJpbmcsIGRlZmF1bHRWYWx1ZT86IGFueSkge1xyXG4gICAgaWYgKCFwYXRoIHx8IHBhdGggPT09ICcvJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5wYWdpbmF0aW9uSW5mbztcclxuICAgIH1cclxuICAgIGlmICh0eXBlb2YgcGF0aCAhPT0gJ3N0cmluZycpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCfot6/lvoTlv4XpobvkuLrlrZfnrKbkuLLvvIEnKTtcclxuICAgIH1cclxuICAgIHBhdGggPSBwYXRoLnN1YnN0cmluZygxKTtcclxuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihpdGVtID0+ICEhaXRlbSAmJiBpdGVtLnRyaW0oKS5sZW5ndGggPiAwKS5tYXAoaXRlbSA9PiBpdGVtLnRyaW0oKSk7XHJcbiAgICBsZXQgY29uZmlnID0gdGhpcy5wYWdpbmF0aW9uSW5mbztcclxuICAgIHBhdGhzLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLmhhc093blByb3BlcnR5KGl0ZW0pKSB7XHJcbiAgICAgICAgY29uZmlnID0gY29uZmlnW2l0ZW1dO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbmZpZyA9IG51bGw7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuICEhY29uZmlnID8gY29uZmlnIDogdHlwZW9mIGRlZmF1bHRWYWx1ZSAhPT0gJ3VuZGVmaW5lZCcgPyBkZWZhdWx0VmFsdWUgOiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiuvue9ruWIhumhteS/oeaBr1xyXG4gICAqIEBwYXJhbSBwYXRoIOi3r+W+hFxyXG4gICAqIEBwYXJhbSB2YWx1ZSDlgLxcclxuICAgKi9cclxuICBwdWJsaWMgc2V0UGFnaW5hdGlvbkNvbmZpZ0J5UGF0aChwYXRoOiBzdHJpbmcgfCBBcnJheTxhbnk+LCB2YWx1ZTogYW55KSB7XHJcbiAgICBjb25zdCBvcmlnaW5hbCA9IEpTT04uc3RyaW5naWZ5KHRoaXMucGFnaW5hdGlvbkluZm8pO1xyXG4gICAgaWYgKCFwYXRoIHx8IHBhdGggPT09ICcvJykge1xyXG4gICAgICB0aGlzLnBhZ2luYXRpb25JbmZvID0gdmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAoIUFycmF5LmlzQXJyYXkocGF0aCkpIHtcclxuICAgICAgICBwYXRoID0gcGF0aC50b1N0cmluZygpLm1hdGNoKC9bXi9bXFxdXSsvZykgfHwgW107XHJcbiAgICAgIH1cclxuICAgICAgcGF0aC5zbGljZSgwLCAtMSkucmVkdWNlKChwcmV2LCBjdXJyZW50LCBpbmRleCkgPT5cclxuICAgICAgICBPYmplY3QocHJldltjdXJyZW50XSkgPT09IHByZXZbY3VycmVudF1cclxuICAgICAgICAgID8gcHJldltjdXJyZW50XVxyXG4gICAgICAgICAgOiBwcmV2W2N1cnJlbnRdID0gTWF0aC5hYnMocGF0aFtpbmRleCArIDFdKSA+PiAwID09PSArcGF0aFtpbmRleCArIDFdXHJcbiAgICAgICAgICAgID8gW11cclxuICAgICAgICAgICAgOiB7fSxcclxuICAgICAgICB0aGlzLnBhZ2luYXRpb25JbmZvKVtwYXRoW3BhdGgubGVuZ3RoIC0gMV1dID0gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKEpTT04uc3RyaW5naWZ5KHRoaXMucGFnaW5hdGlvbkluZm8pICE9PSBvcmlnaW5hbCkge1xyXG4gICAgICB0aGlzLm5vdGlmeUNvbGxlY3Rpb25DaGFuZ2VkKG5ldyBNb2RpZmljYXRpb24odGhpcy5wYWdpbmF0aW9uSW5mbywgTW9kaWZ5VHlwZS5QYWdpbmF0aW9uSW5mb0NoYW5nZSkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMucGFnaW5hdGlvbkluZm87XHJcbiAgfVxyXG4gIC8vI2VuZHJlZ2lvblxyXG59XHJcblxyXG5leHBvcnQgeyBFbnRpdHlDb2xsZWN0aW9uIH07XHJcbiJdfQ==