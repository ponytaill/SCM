import * as tslib_1 from "tslib";
import { Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import { AppContext, FrameContext, Repository, ENTITY_TEMPLATE, ResolveService, ExpressionUtil, ExpressionExecutor } from "@farris/devkit";
import { of } from "rxjs";
var ExpressionService = /** @class */ (function () {
    function ExpressionService(injector, resolveService, frameContext, expressionExecutor) {
        this.injector = injector;
        this.resolveService = resolveService;
        this.frameContext = frameContext;
        this.expressionExecutor = expressionExecutor;
    }
    /**
     * 执行表达式计算
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionService.prototype.execute = function (expression, customContext) {
        var _a;
        var deps = this.resolveService.resolve(expression);
        var groupDependencies = ExpressionUtil.getGroupFunctionDependency(expression, this.frameContext.repository.entityTypeInfo);
        var entityContext = this.buildEntityContext(deps, groupDependencies);
        var stateContext = this.buildStateContext();
        var context = tslib_1.__assign((_a = {}, _a[this.entityOriginalNodeCode] = entityContext, _a), stateContext, { BigNumber: BigNumber, frameContext: this.frameContext, bindingData: this.frameContext.bindingData, repository: this.frameContext.repository }, customContext);
        return this.expressionExecutor.eval(expression, context);
    };
    /**
     * 执行表达式（返回可观察对象）
     * @param expression 表达式
     * @param customContext 自定义上下文
     * @returns
     */
    ExpressionService.prototype.executeAsync = function (expression, customContext) {
        var result = this.execute(expression, customContext);
        return of(result);
    };
    /**
     * 构造实体上下文
     * @param deps
     * @param groupDependencies
     * @param context
     * @returns
     */
    ExpressionService.prototype.buildEntityContext = function (deps, groupDependencies, context) {
        var _this = this;
        var isGroupdMainEntity = false;
        deps.forEach(function (dep) {
            var isEntityDependency = _this.isEntityDependency(dep);
            var isGroupDependency = groupDependencies.findIndex(function (item) { return item === dep; }) !== -1;
            // 如果依赖的是state，无需处理，现在需要确定的是返回多少实体的问题，和state没有关系
            // 表达式依赖了实体
            if (isEntityDependency) {
                // 是聚合依赖
                if (isGroupDependency) {
                    var dependencyLength = dep.split('/').filter(function (p) { return p; }).length - 1;
                    if (dependencyLength === 1) {
                        // 聚合了主表字段，所有主表数据都需要参与运算，此时已经确定计算的实体上下文了。
                        isGroupdMainEntity = true;
                    }
                    else {
                        // 聚合了子表字段，只需要传递当前实体
                    }
                }
                else {
                    // 当前依赖不是聚合，只需要传递当前实体
                }
            }
        });
        var data = this.getEntity();
        if (isGroupdMainEntity) {
            var collection = this.frameContext.repository.entityCollection.toJSON();
            data['__type__'] = 'List';
            data['__items__'] = collection;
        }
        return data;
    };
    /**
     * 是否为实体依赖
     * @param dep
     * @returns
     */
    ExpressionService.prototype.isEntityDependency = function (dep) {
        return dep.startsWith(ENTITY_TEMPLATE);
    };
    /**
     * 获取实体
     * @param event
     * @returns
     */
    ExpressionService.prototype.getEntity = function () {
        var entityTypeInfo = this.frameContext.repository.entityTypeInfo;
        var bindingData = this.frameContext.bindingData;
        var childrenEntityPaths = [];
        ExpressionUtil.getChildrenEntityPaths(entityTypeInfo, childrenEntityPaths);
        var entity = this.frameContext.bindingData.list.currentItem.toJSON();
        entity['__type__'] = 'Entity';
        if (!childrenEntityPaths || childrenEntityPaths.length < 1) {
            return entity;
        }
        // 找到所有子表
        childrenEntityPaths.forEach(function (paths) {
            var row = ExpressionUtil.getCurrentRowByPaths(paths, bindingData);
            if (row) {
                var propertyName = paths.pop();
                var parent_1 = paths.reduce(function (object, path) {
                    return object && object[path] || null;
                }, entity);
                var node = tslib_1.__assign({ __items__: tslib_1.__spread(parent_1[propertyName]) }, row, { __type__: 'List' });
                parent_1[propertyName] = node;
            }
        });
        return entity;
    };
    Object.defineProperty(ExpressionService.prototype, "entityOriginalNodeCode", {
        /**
         * 获取主实体原始字段名
         */
        get: function () {
            var repository = this.injector.get(Repository);
            return repository && repository.entityTypeInfo && repository.entityTypeInfo.entityInfo && repository.entityTypeInfo.entityInfo.originalCode || null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 构造变量上下文
     * @param event
     * @returns
     */
    ExpressionService.prototype.buildStateContext = function () {
        var ns = this.frameContext.namespace;
        var appContext = this.injector.get(AppContext, null);
        var frameContexts = appContext.frameContextManager.getFrameContextsByNamespace(ns);
        var result = {};
        if (frameContexts && frameContexts.length > 0) {
            var anonymousFrameContext = frameContexts[0];
            var rootFrameContext = anonymousFrameContext.getVirtualRootFrameContext();
            if (rootFrameContext) {
                var uiState_1 = rootFrameContext.viewModel.uiState;
                var propertyNames = Object.getOwnPropertyNames(uiState_1) || [];
                propertyNames.forEach(function (prop) {
                    if (prop.match(/^[a-zA-Z0-9_\$]+$/g) !== null) {
                        result[prop] = uiState_1[prop];
                    }
                });
            }
        }
        return result;
    };
    ExpressionService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ExpressionService.ctorParameters = function () { return [
        { type: Injector },
        { type: ResolveService },
        { type: FrameContext },
        { type: ExpressionExecutor }
    ]; };
    return ExpressionService;
}());
export { ExpressionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb25fc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN6QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzSSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRXRDO0lBRUUsMkJBQW9CLFFBQWtCLEVBQVUsY0FBOEIsRUFBVSxZQUEwQixFQUFVLGtCQUFzQztRQUE5SSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQVUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO0lBQUksQ0FBQztJQUN2Szs7Ozs7T0FLRztJQUNJLG1DQUFPLEdBQWQsVUFBZSxVQUFrQixFQUFFLGFBQXVDOztRQUN4RSxJQUFNLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNyRCxJQUFNLGlCQUFpQixHQUFHLGNBQWMsQ0FBQywwQkFBMEIsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDN0gsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZFLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFB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SUQsSUE2SUM7U0E1SVksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQmlnTnVtYmVyIH0gZnJvbSAnYmlnbnVtYmVyLmpzJztcbmltcG9ydCB7IEFwcENvbnRleHQsIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSwgRU5USVRZX1RFTVBMQVRFLCBSZXNvbHZlU2VydmljZSwgRXhwcmVzc2lvblV0aWwsIEV4cHJlc3Npb25FeGVjdXRvciB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRXhwcmVzc2lvblNlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSByZXNvbHZlU2VydmljZTogUmVzb2x2ZVNlcnZpY2UsIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIHByaXZhdGUgZXhwcmVzc2lvbkV4ZWN1dG9yOiBFeHByZXNzaW9uRXhlY3V0b3IpIHsgfVxuICAvKipcbiAgICog5omn6KGM6KGo6L6+5byP6K6h566XXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xuICAgKiBAcGFyYW0gY3VzdG9tQ29udGV4dCDoh6rlrprkuYnkuIrkuIvmlodcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZXhlY3V0ZShleHByZXNzaW9uOiBzdHJpbmcsIGN1c3RvbUNvbnRleHQ/OiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IGFueSB7XG4gICAgY29uc3QgZGVwcyA9IHRoaXMucmVzb2x2ZVNlcnZpY2UucmVzb2x2ZShleHByZXNzaW9uKTtcbiAgICBjb25zdCBncm91cERlcGVuZGVuY2llcyA9IEV4cHJlc3Npb25VdGlsLmdldEdyb3VwRnVuY3Rpb25EZXBlbmRlbmN5KGV4cHJlc3Npb24sIHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xuICAgIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChkZXBzLCBncm91cERlcGVuZGVuY2llcyk7XG4gICAgY29uc3Qgc3RhdGVDb250ZXh0ID0gdGhpcy5idWlsZFN0YXRlQ29udGV4dCgpO1xuICAgIGNvbnN0IGNvbnRleHQgPSB7XG4gICAgICBbdGhpcy5lbnRpdHlPcmlnaW5hbE5vZGVDb2RlXTogZW50aXR5Q29udGV4dCxcbiAgICAgIC4uLnN0YXRlQ29udGV4dCxcbiAgICAgIEJpZ051bWJlcixcbiAgICAgIGZyYW1lQ29udGV4dDogdGhpcy5mcmFtZUNvbnRleHQsXG4gICAgICBiaW5kaW5nRGF0YTogdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEsXG4gICAgICByZXBvc2l0b3J5OiB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LFxuICAgICAgLi4uY3VzdG9tQ29udGV4dFxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uRXhlY3V0b3IuZXZhbChleHByZXNzaW9uLCBjb250ZXh0KTtcbiAgfVxuICAvKipcbiAgICog5omn6KGM6KGo6L6+5byP77yI6L+U5Zue5Y+v6KeC5a+f5a+56LGh77yJXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOihqOi+vuW8j1xuICAgKiBAcGFyYW0gY3VzdG9tQ29udGV4dCDoh6rlrprkuYnkuIrkuIvmlodcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZXhlY3V0ZUFzeW5jKGV4cHJlc3Npb246IHN0cmluZywgY3VzdG9tQ29udGV4dD86IHsgW3Byb3A6IHN0cmluZ106IGFueSB9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmV4ZWN1dGUoZXhwcmVzc2lvbiwgY3VzdG9tQ29udGV4dCk7XG4gICAgcmV0dXJuIG9mKHJlc3VsdCk7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOWunuS9k+S4iuS4i+aWh1xuICAgKiBAcGFyYW0gZGVwcyBcbiAgICogQHBhcmFtIGdyb3VwRGVwZW5kZW5jaWVzIFxuICAgKiBAcGFyYW0gY29udGV4dCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkRW50aXR5Q29udGV4dChkZXBzOiBzdHJpbmdbXSwgZ3JvdXBEZXBlbmRlbmNpZXM6IHN0cmluZ1tdLCBjb250ZXh0PzogeyBbcHJvcDogc3RyaW5nXTogYW55IH0pIHtcbiAgICBsZXQgaXNHcm91cGRNYWluRW50aXR5ID0gZmFsc2U7XG4gICAgZGVwcy5mb3JFYWNoKChkZXA6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgaXNFbnRpdHlEZXBlbmRlbmN5ID0gdGhpcy5pc0VudGl0eURlcGVuZGVuY3koZGVwKTtcbiAgICAgIGNvbnN0IGlzR3JvdXBEZXBlbmRlbmN5ID0gZ3JvdXBEZXBlbmRlbmNpZXMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbSA9PT0gZGVwKSAhPT0gLTE7XG4gICAgICAvLyDlpoLmnpzkvp3otZbnmoTmmK9zdGF0Ze+8jOaXoOmcgOWkhOeQhu+8jOeOsOWcqOmcgOimgeehruWumueahOaYr+i/lOWbnuWkmuWwkeWunuS9k+eahOmXrumimO+8jOWSjHN0YXRl5rKh5pyJ5YWz57O7XG4gICAgICAvLyDooajovr7lvI/kvp3otZbkuoblrp7kvZNcbiAgICAgIGlmIChpc0VudGl0eURlcGVuZGVuY3kpIHtcbiAgICAgICAgLy8g5piv6IGa5ZCI5L6d6LWWXG4gICAgICAgIGlmIChpc0dyb3VwRGVwZW5kZW5jeSkge1xuICAgICAgICAgIGNvbnN0IGRlcGVuZGVuY3lMZW5ndGggPSBkZXAuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5sZW5ndGggLSAxO1xuICAgICAgICAgIGlmIChkZXBlbmRlbmN5TGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAvLyDogZrlkIjkuobkuLvooajlrZfmrrXvvIzmiYDmnInkuLvooajmlbDmja7pg73pnIDopoHlj4LkuI7ov5DnrpfvvIzmraTml7blt7Lnu4/noa7lrprorqHnrpfnmoTlrp7kvZPkuIrkuIvmlofkuobjgIJcbiAgICAgICAgICAgIGlzR3JvdXBkTWFpbkVudGl0eSA9IHRydWU7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIOiBmuWQiOS6huWtkOihqOWtl+aute+8jOWPqumcgOimgeS8oOmAkuW9k+WJjeWunuS9k1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyDlvZPliY3kvp3otZbkuI3mmK/ogZrlkIjvvIzlj6rpnIDopoHkvKDpgJLlvZPliY3lrp7kvZNcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmdldEVudGl0eSgpO1xuICAgIGlmIChpc0dyb3VwZE1haW5FbnRpdHkpIHtcbiAgICAgIGNvbnN0IGNvbGxlY3Rpb24gPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24udG9KU09OKCk7XG4gICAgICBkYXRhWydfX3R5cGVfXyddID0gJ0xpc3QnO1xuICAgICAgZGF0YVsnX19pdGVtc19fJ10gPSBjb2xsZWN0aW9uO1xuICAgIH1cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuICAvKipcbiAgICog5piv5ZCm5Li65a6e5L2T5L6d6LWWXG4gICAqIEBwYXJhbSBkZXAgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBpc0VudGl0eURlcGVuZGVuY3koZGVwOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZGVwLnN0YXJ0c1dpdGgoRU5USVRZX1RFTVBMQVRFKTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5a6e5L2TXG4gICAqIEBwYXJhbSBldmVudCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0RW50aXR5KCkge1xuICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbztcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xuICAgIGNvbnN0IGNoaWxkcmVuRW50aXR5UGF0aHMgPSBbXTtcbiAgICBFeHByZXNzaW9uVXRpbC5nZXRDaGlsZHJlbkVudGl0eVBhdGhzKGVudGl0eVR5cGVJbmZvLCBjaGlsZHJlbkVudGl0eVBhdGhzKTtcbiAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJdGVtLnRvSlNPTigpO1xuICAgIGVudGl0eVsnX190eXBlX18nXSA9ICdFbnRpdHknO1xuICAgIGlmICghY2hpbGRyZW5FbnRpdHlQYXRocyB8fCBjaGlsZHJlbkVudGl0eVBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgfVxuICAgIC8vIOaJvuWIsOaJgOacieWtkOihqFxuICAgIGNoaWxkcmVuRW50aXR5UGF0aHMuZm9yRWFjaCgocGF0aHM6IHN0cmluZ1tdKSA9PiB7XG4gICAgICBjb25zdCByb3cgPSBFeHByZXNzaW9uVXRpbC5nZXRDdXJyZW50Um93QnlQYXRocyhwYXRocywgYmluZGluZ0RhdGEpO1xuICAgICAgaWYgKHJvdykge1xuICAgICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5wb3AoKTtcbiAgICAgICAgbGV0IHBhcmVudCA9IHBhdGhzLnJlZHVjZSgob2JqZWN0OiBhbnksIHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgICAgIHJldHVybiBvYmplY3QgJiYgb2JqZWN0W3BhdGhdIHx8IG51bGw7XG4gICAgICAgIH0sIGVudGl0eSk7XG4gICAgICAgIGNvbnN0IG5vZGUgPSB7IF9faXRlbXNfXzogWy4uLnBhcmVudFtwcm9wZXJ0eU5hbWVdXSwgLi4ucm93LCBfX3R5cGVfXzogJ0xpc3QnIH07XG4gICAgICAgIHBhcmVudFtwcm9wZXJ0eU5hbWVdID0gbm9kZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gZW50aXR5O1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuLvlrp7kvZPljp/lp4vlrZfmrrXlkI1cbiAgICovXG4gIHByb3RlY3RlZCBnZXQgZW50aXR5T3JpZ2luYWxOb2RlQ29kZSgpOiBzdHJpbmcge1xuICAgIGNvbnN0IHJlcG9zaXRvcnkgPSB0aGlzLmluamVjdG9yLmdldChSZXBvc2l0b3J5KTtcbiAgICByZXR1cm4gcmVwb3NpdG9yeSAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvICYmIHJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZW50aXR5SW5mbyAmJiByZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlIHx8IG51bGw7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOWPmOmHj+S4iuS4i+aWh1xuICAgKiBAcGFyYW0gZXZlbnQgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGJ1aWxkU3RhdGVDb250ZXh0KCkge1xuICAgIGNvbnN0IG5zID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlO1xuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShucyk7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgaWYgKGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0cy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBhbm9ueW1vdXNGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHRzWzBdO1xuICAgICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dCA9IGFub255bW91c0ZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xuICAgICAgaWYgKHJvb3RGcmFtZUNvbnRleHQpIHtcbiAgICAgICAgY29uc3QgdWlTdGF0ZSA9IHJvb3RGcmFtZUNvbnRleHQudmlld01vZGVsLnVpU3RhdGU7XG4gICAgICAgIGNvbnN0IHByb3BlcnR5TmFtZXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh1aVN0YXRlKSB8fCBbXTtcbiAgICAgICAgcHJvcGVydHlOYW1lcy5mb3JFYWNoKChwcm9wOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICBpZiAocHJvcC5tYXRjaCgvXlthLXpBLVowLTlfXFwkXSskL2cpICE9PSBudWxsKSB7XG4gICAgICAgICAgICByZXN1bHRbcHJvcF0gPSB1aVN0YXRlW3Byb3BdO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbn0iXX0=