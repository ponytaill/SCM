/*
 * @Author: Witt
 * @Date: 2018-10-17 14:13:40
 * @Last Modified by: Witt
 * @Last Modified time: 2018-10-17 16:08:34
 */
import { TaskNode } from './task_node';
import { TaskLink } from './task_link';
/**
 * 任务执行流程
 */
class TaskFlow {
    constructor() {
        /**
         * 节点集合
         */
        this.nodes = [];
        /**
         * 边集合
         */
        this.links = [];
        // #endregion
    }
    // #region 节点操作
    /**
     * 添加节点
     */
    addNode(name, func) {
        const node = new TaskNode(name, func);
        this.nodes.push(node);
    }
    /**
     * 批量添加链接
     */
    addNodes(nodes) {
        this.nodes = this.nodes.concat(nodes);
    }
    /**
     * 在目标节点之前插入一个节点
     * @param target 目标节点名称
     * @param name 名称
     * @param func 函数
     */
    insertNode(target, name, func) {
        const index = this.findNodeIndex(target);
        const node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    }
    /**
     * 在目标节点之前插入一个节点
     */
    appendNode(target, name, func) {
        const index = this.findNodeIndex(target) + 1;
        const node = this.createNode(name, func);
        this.nodes.splice(index, 0, node);
    }
    /**
     * 获取节点索引
     * @param name 名称
     */
    findNodeIndex(name) {
        return this.nodes.findIndex((node) => {
            return node.name === name;
        });
    }
    /**
     * 创建任务节点
     * @param name 名称
     * @param func 函数
     */
    createNode(name, func) {
        const node = new TaskNode(name, func);
        return node;
    }
    // #endregion
    // #region 链接操作
    /**
     * 添加链接
     * @param name 名称
     * @param func 函数
     */
    addLink(from, to, condition) {
        const link = this.createLink(from, to, condition);
        this.links.push(link);
    }
    /**
     * 批量添加链接
     */
    addLinks(links) {
        this.links = this.links.concat(links);
    }
    /**
     * 创建链接
     */
    createLink(from, to, condition) {
        const link = new TaskLink(from, to, condition);
        return link;
    }
    // #endregion
    // #region 流程控制
    /**
     * 获取下一个节点
     * @param from    源节点名称
     * @param context 上下文
     */
    getNext(from, context) {
        if (!from) {
            return this.nodes.shift();
        }
        // 符合满足条件的边
        const nextLink = this.links.find((link) => {
            return link.from === from && link.canLink(context);
        });
        if (!nextLink) {
            return;
        }
        return this.nodes.find((node) => {
            return node.name === nextLink.to;
        });
    }
    // #endregion
    // #region 其他方法
    /**
     * 克隆任务流
     */
    clone() {
        const taskFlow = new TaskFlow();
        taskFlow.addNodes(this.nodes);
        taskFlow.addLinks(this.links);
        return taskFlow;
    }
}
export { TaskFlow };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFza19mbG93LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2NvbW1hbmQvZmxvdy90YXNrX2Zsb3cudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFFSCxPQUFPLEVBQVksUUFBUSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ2pELE9BQU8sRUFBWSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFHakQ7O0dBRUc7QUFDSCxNQUFNLFFBQVE7SUFBZDtRQUVFOztXQUVHO1FBQ0ssVUFBSyxHQUFlLEVBQUUsQ0FBQztRQUUvQjs7V0FFRztRQUNLLFVBQUssR0FBZSxFQUFFLENBQUM7UUFxSS9CLGFBQWE7SUFDZixDQUFDO0lBbklDLGVBQWU7SUFFZjs7T0FFRztJQUNJLE9BQU8sQ0FBQyxJQUFZLEVBQUUsSUFBYztRQUN6QyxNQUFNLElBQUksR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUdEOztPQUVHO0lBQ0ksUUFBUSxDQUFDLEtBQWlCO1FBQy9CLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ksVUFBVSxDQUFDLE1BQWMsRUFBRSxJQUFZLEVBQUUsSUFBYztRQUM1RCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxDQUFDLENB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QUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE4LTEwLTE3IDE0OjEzOjQwXHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBXaXR0XHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTgtMTAtMTcgMTY6MDg6MzRcclxuICovXHJcblxyXG5pbXBvcnQgeyBUYXNrRnVuYywgVGFza05vZGUgfSBmcm9tICcuL3Rhc2tfbm9kZSc7XHJcbmltcG9ydCB7IExpbmtGdW5jLCBUYXNrTGluayB9IGZyb20gJy4vdGFza19saW5rJztcclxuaW1wb3J0IHsgQ29tbWFuZENvbnRleHQgfSBmcm9tICcuLi9jb21tYW5kX2NvbnRleHQnO1xyXG5cclxuLyoqXHJcbiAqIOS7u+WKoeaJp+ihjOa1geeoi1xyXG4gKi9cclxuY2xhc3MgVGFza0Zsb3cge1xyXG5cclxuICAvKipcclxuICAgKiDoioLngrnpm4blkIhcclxuICAgKi9cclxuICBwcml2YXRlIG5vZGVzOiBUYXNrTm9kZVtdID0gW107XHJcblxyXG4gIC8qKlxyXG4gICAqIOi+uembhuWQiFxyXG4gICAqL1xyXG4gIHByaXZhdGUgbGlua3M6IFRhc2tMaW5rW10gPSBbXTtcclxuXHJcblxyXG4gIC8vICNyZWdpb24g6IqC54K55pON5L2cXHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOiKgueCuVxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGROb2RlKG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpOiB2b2lkIHtcclxuICAgIGNvbnN0IG5vZGUgPSBuZXcgVGFza05vZGUobmFtZSwgZnVuYyk7XHJcbiAgICB0aGlzLm5vZGVzLnB1c2gobm9kZSk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP5re75Yqg6ZO+5o6lXHJcbiAgICovXHJcbiAgcHVibGljIGFkZE5vZGVzKG5vZGVzOiBUYXNrTm9kZVtdKSB7XHJcbiAgICB0aGlzLm5vZGVzID0gdGhpcy5ub2Rlcy5jb25jYXQobm9kZXMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Zyo55uu5qCH6IqC54K55LmL5YmN5o+S5YWl5LiA5Liq6IqC54K5XHJcbiAgICogQHBhcmFtIHRhcmdldCDnm67moIfoioLngrnlkI3np7BcclxuICAgKiBAcGFyYW0gbmFtZSDlkI3np7BcclxuICAgKiBAcGFyYW0gZnVuYyDlh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgaW5zZXJ0Tm9kZSh0YXJnZXQ6IHN0cmluZywgbmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYyk6IHZvaWQge1xyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmZpbmROb2RlSW5kZXgodGFyZ2V0KTtcclxuICAgIGNvbnN0IG5vZGUgPSB0aGlzLmNyZWF0ZU5vZGUobmFtZSwgZnVuYyk7XHJcbiAgICB0aGlzLm5vZGVzLnNwbGljZShpbmRleCwgMCwgbm9kZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlnKjnm67moIfoioLngrnkuYvliY3mj5LlhaXkuIDkuKroioLngrlcclxuICAgKi9cclxuICBwdWJsaWMgYXBwZW5kTm9kZSh0YXJnZXQ6IHN0cmluZywgbmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYykge1xyXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmZpbmROb2RlSW5kZXgodGFyZ2V0KSArIDE7XHJcbiAgICBjb25zdCBub2RlID0gdGhpcy5jcmVhdGVOb2RlKG5hbWUsIGZ1bmMpO1xyXG4gICAgdGhpcy5ub2Rlcy5zcGxpY2UoaW5kZXgsIDAsIG5vZGUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W6IqC54K557Si5byVXHJcbiAgICogQHBhcmFtIG5hbWUg5ZCN56ewXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaW5kTm9kZUluZGV4KG5hbWU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5ub2Rlcy5maW5kSW5kZXgoKG5vZGU6IFRhc2tOb2RlKSA9PiB7XHJcbiAgICAgIHJldHVybiBub2RlLm5hbWUgPT09IG5hbWU7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIm+W7uuS7u+WKoeiKgueCuVxyXG4gICAqIEBwYXJhbSBuYW1lIOWQjeensFxyXG4gICAqIEBwYXJhbSBmdW5jIOWHveaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY3JlYXRlTm9kZShuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKTogVGFza05vZGUge1xyXG4gICAgY29uc3Qgbm9kZSA9IG5ldyBUYXNrTm9kZShuYW1lLCBmdW5jKTtcclxuICAgIHJldHVybiBub2RlO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDpk77mjqXmk43kvZxcclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg6ZO+5o6lXHJcbiAgICogQHBhcmFtIG5hbWUg5ZCN56ewXHJcbiAgICogQHBhcmFtIGZ1bmMg5Ye95pWwXHJcbiAgICovXHJcbiAgcHVibGljIGFkZExpbmsoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBjb25kaXRpb246IHN0cmluZyB8IGJvb2xlYW4pIHtcclxuICAgIGNvbnN0IGxpbmsgPSB0aGlzLmNyZWF0ZUxpbmsoZnJvbSwgdG8sIGNvbmRpdGlvbik7XHJcbiAgICB0aGlzLmxpbmtzLnB1c2gobGluayk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmibnph4/mt7vliqDpk77mjqVcclxuICAgKi9cclxuICBwdWJsaWMgYWRkTGlua3MobGlua3M6IFRhc2tMaW5rW10pIHtcclxuICAgIHRoaXMubGlua3MgPSB0aGlzLmxpbmtzLmNvbmNhdChsaW5rcyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7rpk77mjqVcclxuICAgKi9cclxuICBwcml2YXRlIGNyZWF0ZUxpbmsoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBjb25kaXRpb246IHN0cmluZyB8IGJvb2xlYW4pIHtcclxuICAgIGNvbnN0IGxpbmsgPSBuZXcgVGFza0xpbmsoZnJvbSwgdG8sIGNvbmRpdGlvbik7XHJcbiAgICByZXR1cm4gbGluaztcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5rWB56iL5o6n5Yi2XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5LiL5LiA5Liq6IqC54K5XHJcbiAgICogQHBhcmFtIGZyb20gICAg5rqQ6IqC54K55ZCN56ewXHJcbiAgICogQHBhcmFtIGNvbnRleHQg5LiK5LiL5paHXHJcbiAgICovXHJcbiAgZ2V0TmV4dChmcm9tPzogc3RyaW5nLCBjb250ZXh0PzogQ29tbWFuZENvbnRleHQpOiBUYXNrTm9kZSB7XHJcbiAgICBpZiAoIWZyb20pIHtcclxuICAgICAgcmV0dXJuIHRoaXMubm9kZXMuc2hpZnQoKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDnrKblkIjmu6HotrPmnaHku7bnmoTovrlcclxuICAgIGNvbnN0IG5leHRMaW5rID0gdGhpcy5saW5rcy5maW5kKChsaW5rOiBUYXNrTGluaykgPT4ge1xyXG4gICAgICByZXR1cm4gbGluay5mcm9tID09PSBmcm9tICYmIGxpbmsuY2FuTGluayhjb250ZXh0KTtcclxuICAgIH0pO1xyXG4gICAgaWYgKCFuZXh0TGluaykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMubm9kZXMuZmluZCgobm9kZTogVGFza05vZGUpID0+IHtcclxuICAgICAgcmV0dXJuIG5vZGUubmFtZSA9PT0gbmV4dExpbmsudG87XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcbiAgLy8gI3JlZ2lvbiDlhbbku5bmlrnms5VcclxuXHJcbiAgLyoqXHJcbiAgICog5YWL6ZqG5Lu75Yqh5rWBXHJcbiAgICovXHJcbiAgY2xvbmUoKSB7XHJcbiAgICBjb25zdCB0YXNrRmxvdyA9IG5ldyBUYXNrRmxvdygpO1xyXG4gICAgdGFza0Zsb3cuYWRkTm9kZXModGhpcy5ub2Rlcyk7XHJcbiAgICB0YXNrRmxvdy5hZGRMaW5rcyh0aGlzLmxpbmtzKTtcclxuICAgIHJldHVybiB0YXNrRmxvdztcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxufVxyXG5cclxuZXhwb3J0IHsgVGFza0Zsb3cgfTtcclxuIl19