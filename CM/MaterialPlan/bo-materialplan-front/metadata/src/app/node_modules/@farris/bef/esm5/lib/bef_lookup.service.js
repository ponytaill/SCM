/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_lookup.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { switchMap, map, catchError } from 'rxjs/operators';
import { Repository, FrameContext } from '@farris/devkit';
/**
 * 帮助Rest取数服务
 */
var BefLookupRestService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function BefLookupRestService(repository, frameContext) {
        this.frameContext = frameContext;
        this.befRepository = (/** @type {?} */ (repository));
        this.registerDestroyEvent();
    }
    /**
     * @private
     * @return {?}
     */
    BefLookupRestService.prototype.registerDestroyEvent = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        if (this.frameContext && this.frameContext.destorySignal) {
            this.frameContext.destorySignal.subscribe((/**
             * @return {?}
             */
            function () {
                _this.frameContext = null;
                _this.befRepository = null;
            }));
        }
    };
    /**
     * @param {?} helpMetadataId
     * @param {?=} data
     * @return {?}
     */
    BefLookupRestService.prototype.getData = /**
     * @param {?} helpMetadataId
     * @param {?=} data
     * @return {?}
     */
    function (helpMetadataId, data) {
        /** @type {?} */
        var tableName = helpMetadataId.split('.')[0];
        /** @type {?} */
        var labelId = helpMetadataId.split('.')[1];
        data = data || {};
        if (this.frameContext) {
            /** @type {?} */
            var primaryValue = this.frameContext.bindingData.list.currentId;
            data['currentForm'] = {
                id: primaryValue
            };
        }
        /** @type {?} */
        var enableExtendLoadMethod = this.ifEnableExtendLoadMethod(helpMetadataId);
        if (enableExtendLoadMethod === true) {
            return this.extendGetHelpData(labelId, tableName, data);
        }
        return this.getHelpData(labelId, tableName, data);
    };
    /**
     * @param {?} data
     * @return {?}
     */
    BefLookupRestService.prototype.saveUserSettings = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        var _this = this;
        /** @type {?} */
        var url = '/api/runtime/bcc/v1.0/datagrid/settings';
        return this.befRepository.restService.invoke(url, 'POST', null, { body: data }, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            /** @type {?} */
            var formAppContext = _this.befRepository.appContext.getFormAppContext();
            _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    };
    /**
     * @param {?} key
     * @return {?}
     */
    BefLookupRestService.prototype.getUserSettings = /**
     * @param {?} key
     * @return {?}
     */
    function (key) {
        var _this = this;
        /** @type {?} */
        var url = '/api/runtime/bcc/v1.0/datagrid/settings/' + key;
        return this.befRepository.restService.invoke(url, 'GET', null, null, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            /** @type {?} */
            var formAppContext = _this.befRepository.appContext.getFormAppContext();
            _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    };
    /**
     * 是否启用扩展取数方法
     */
    /**
     * 是否启用扩展取数方法
     * @private
     * @param {?} helpMetadataId
     * @return {?}
     */
    BefLookupRestService.prototype.ifEnableExtendLoadMethod = /**
     * 是否启用扩展取数方法
     * @private
     * @param {?} helpMetadataId
     * @return {?}
     */
    function (helpMetadataId) {
        // 优先使用context里的设置
        if (this.context && this.context.hasOwnProperty('enableExtendLoadMethod')) {
            return this.context.enableExtendLoadMethod;
        }
        // context没有设置时，继续使用通过指令设置的开关
        /** @type {?} */
        var enableExtendLoadMethod = false;
        if (this.frameContext) {
            /** @type {?} */
            var befApiUrl = this.frameContext.repository.apiUri;
            /** @type {?} */
            var enableKey = helpMetadataId + "@" + befApiUrl;
            enableExtendLoadMethod = this.frameContext.getParam(enableKey);
        }
        return enableExtendLoadMethod;
    };
    /**
     * 老的帮助取树
     */
    /**
     * 老的帮助取树
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    BefLookupRestService.prototype.getHelpData = /**
     * 老的帮助取树
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    function (labelId, tableName, data) {
        var _this = this;
        /** @type {?} */
        var url = this.befRepository.restService.baseUri + "/elementhelps/" + labelId;
        /** @type {?} */
        var update$ = this.befRepository.updateDataAndVariableChanges();
        /** @type {?} */
        var result$ = update$.pipe(switchMap((/**
         * @return {?}
         */
        function () {
            // tslint:disable-next-line: max-line-length
            return _this.befRepository.restService.invoke(url, 'GET', { nodeCode: tableName, queryParam: JSON.stringify(data) }, null, false).pipe(catchError((/**
             * @param {?} error
             * @return {?}
             */
            function (error) {
                /** @type {?} */
                var formAppContext = _this.befRepository.appContext.getFormAppContext();
                _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
                return EMPTY;
            })));
        })));
        return result$;
    };
    /**
     * 扩展的帮助取数
     */
    /**
     * 扩展的帮助取数
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    BefLookupRestService.prototype.extendGetHelpData = /**
     * 扩展的帮助取数
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    function (labelId, tableName, data) {
        var _this = this;
        /** @type {?} */
        var url = this.befRepository.restService.baseUri + "/extension/elementhelps";
        /** @type {?} */
        var body = {
            labelId: labelId,
            nodeCode: tableName,
            queryParam: data,
            requestInfo: this.befRepository.restService.buildRequestInfo()
        };
        /** @type {?} */
        var options = {
            body: body
        };
        /** @type {?} */
        var result$ = this.befRepository.restService.invoke(url, 'PUT', null, options, false, true, true);
        return result$.pipe(map((/**
         * @param {?} responseInfo
         * @return {?}
         */
        function (responseInfo) {
            return responseInfo && responseInfo.returnValue || null;
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        function (error) {
            /** @type {?} */
            var formAppContext = _this.befRepository.appContext.getFormAppContext();
            _this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    };
    /**
     * @private
     * @param {?} data
     * @param {?=} layer
     * @param {?=} parentPathCode
     * @return {?}
     */
    BefLookupRestService.prototype.convert2TreeDataWithPathCode = /**
     * @private
     * @param {?} data
     * @param {?=} layer
     * @param {?=} parentPathCode
     * @return {?}
     */
    function (data, layer, parentPathCode) {
        var _this = this;
        if (layer === void 0) { layer = 1; }
        if (parentPathCode === void 0) { parentPathCode = '01'; }
        /** @type {?} */
        var nodes = data.filter((/**
         * @param {?} d
         * @return {?}
         */
        function (d) { return d.layer === layer && d.pathcode === parentPathCode; }));
        if (layer > 1) {
            nodes = data.filter((/**
             * @param {?} d
             * @return {?}
             */
            function (d) { return d.layer === layer && d.pathcode.substr(0, (layer - 1) * 2) === parentPathCode; }));
        }
        if (nodes.length) {
            /** @type {?} */
            var treeNodes = nodes.map((/**
             * @param {?} n
             * @return {?}
             */
            function (n) {
                return {
                    data: n,
                    children: []
                };
            }));
            treeNodes.forEach((/**
             * @param {?} tn
             * @return {?}
             */
            function (tn) {
                var _a;
                /** @type {?} */
                var _tns = _this.convert2TreeDataWithPathCode(data, tn.data.layer + 1, tn.data.pathcode);
                (_a = tn.children).push.apply(_a, tslib_1.__spread(_tns));
            }));
            return treeNodes;
        }
    };
    BefLookupRestService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BefLookupRestService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext, decorators: [{ type: Optional }] }
    ]; };
    return BefLookupRestService;
}());
export { BefLookupRestService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.befRepository;
    /**
     * 帮助取数上下文
     * @type {?}
     */
    BefLookupRestService.prototype.context;
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.frameContext;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2xvb2t1cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9iZWYvIiwic291cmNlcyI6WyJsaWIvYmVmX2xvb2t1cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxLQUFLLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDekMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQU8sVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFakUsT0FBTyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQU8xRDtJQVVFOztPQUVHO0lBQ0gsOEJBQ0UsVUFBMkIsRUFDUCxZQUEwQjtRQUExQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUU5QyxJQUFJLENBQUMsYUFBYSxHQUFHLG1CQUFvQixVQUFVLEVBQUEsQ0FBQztRQUNwRCxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztJQUM5QixDQUFDOzs7OztJQUNPLG1EQUFvQjs7OztJQUE1QjtRQUFBLGlCQU9DO1FBTkMsSUFBSSxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFO1lBQ3hELElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFNBQVM7OztZQUFDO2dCQUN4QyxLQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztnQkFDekIsS0FBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7WUFDNUIsQ0FBQyxFQUFDLENBQUM7U0FDSjtJQUNILENBQUM7Ozs7OztJQUVNLHNDQUFPOzs7OztJQUFkLFVBQWUsY0FBc0IsRUFBRSxJQUFtQjs7WUFDbEQsU0FBUyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztZQUN4QyxPQUFPLEdBQUcs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IE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHN3aXRjaE1hcCwgbWFwLCB0YXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IElMb29rdXBIdHRwU2VydmljZSwgUmVtb3RlUGFyYW1zLCBMb29rdXBHcmlkUmVzdWx0IH0gZnJvbSAnQGZhcnJpcy91aS1sb29rdXAnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICcuL2JlZl9yZXBvc2l0b3J5JztcclxuaW1wb3J0IHsgUmVzcG9uc2VJbmZvIH0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG4vKipcclxuICog5biu5YqpUmVzdOWPluaVsOacjeWKoVxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQmVmTG9va3VwUmVzdFNlcnZpY2UgaW1wbGVtZW50cyBJTG9va3VwSHR0cFNlcnZpY2Uge1xyXG5cclxuICBwcml2YXRlIGJlZlJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8YW55PjtcclxuXHJcbiAgLyoqXHJcbiAgICog5biu5Yqp5Y+W5pWw5LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRleHQ6IGFueTtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0XHJcbiAgKSB7XHJcbiAgICB0aGlzLmJlZlJlcG9zaXRvcnkgPSA8QmVmUmVwb3NpdG9yeTxhbnk+PnJlcG9zaXRvcnk7XHJcbiAgICB0aGlzLnJlZ2lzdGVyRGVzdHJveUV2ZW50KCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgcmVnaXN0ZXJEZXN0cm95RXZlbnQoKSB7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuZGVzdG9yeVNpZ25hbCkge1xyXG4gICAgICB0aGlzLmZyYW1lQ29udGV4dC5kZXN0b3J5U2lnbmFsLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5mcmFtZUNvbnRleHQgPSBudWxsO1xyXG4gICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeSA9IG51bGw7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldERhdGEoaGVscE1ldGFkYXRhSWQ6IHN0cmluZywgZGF0YT86IFJlbW90ZVBhcmFtcyk6IE9ic2VydmFibGU8TG9va3VwR3JpZFJlc3VsdD4ge1xyXG4gICAgY29uc3QgdGFibGVOYW1lID0gaGVscE1ldGFkYXRhSWQuc3BsaXQoJy4nKVswXTtcclxuICAgIGNvbnN0IGxhYmVsSWQgPSBoZWxwTWV0YWRhdGFJZC5zcGxpdCgnLicpWzFdO1xyXG4gICAgZGF0YSA9IGRhdGEgfHwge307XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3QgcHJpbWFyeVZhbHVlID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XHJcbiAgICAgIGRhdGFbJ2N1cnJlbnRGb3JtJ10gPSB7XHJcbiAgICAgICAgaWQ6IHByaW1hcnlWYWx1ZVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gICAgY29uc3QgZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9IHRoaXMuaWZFbmFibGVFeHRlbmRMb2FkTWV0aG9kKGhlbHBNZXRhZGF0YUlkKTtcclxuICAgIGlmIChlbmFibGVFeHRlbmRMb2FkTWV0aG9kID09PSB0cnVlKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmV4dGVuZEdldEhlbHBEYXRhKGxhYmVsSWQsIHRhYmxlTmFtZSwgZGF0YSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5nZXRIZWxwRGF0YShsYWJlbElkLCB0YWJsZU5hbWUsIGRhdGEpO1xyXG4gIH1cclxuICBwdWJsaWMgc2F2ZVVzZXJTZXR0aW5ncyhkYXRhKSB7XHJcbiAgICBjb25zdCB1cmwgPSAnL2FwaS9ydW50aW1lL2JjYy92MS4wL2RhdGFncmlkL3NldHRpbmdzJztcclxuICAgIHJldHVybiB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ1BPU1QnLCBudWxsLCB7IGJvZHk6IGRhdGEgfSwgZmFsc2UpLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwcENvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRVc2VyU2V0dGluZ3Moa2V5KSB7XHJcbiAgICBjb25zdCB1cmwgPSAnL2FwaS9ydW50aW1lL2JjYy92MS4wL2RhdGFncmlkL3NldHRpbmdzLycgKyBrZXk7XHJcbiAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnLCBudWxsLCBudWxsLCBmYWxzZSkucGlwZShcclxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgY29uc3QgZm9ybUFwcENvbnRleHQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBwQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xyXG4gICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5ldmVudEJ1cy5wb3N0KCdFeGNlcHRpb24nLCAnJywgJ29uRXhjZXB0aW9uJywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5ZCv55So5omp5bGV5Y+W5pWw5pa55rOVXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpZkVuYWJsZUV4dGVuZExvYWRNZXRob2QoaGVscE1ldGFkYXRhSWQ6IHN0cmluZykge1xyXG5cclxuICAgIC8vIOS8mOWFiOS9v+eUqGNvbnRleHTph4znmoTorr7nva5cclxuICAgIGlmICh0aGlzLmNvbnRleHQgJiYgdGhpcy5jb250ZXh0Lmhhc093blByb3BlcnR5KCdlbmFibGVFeHRlbmRMb2FkTWV0aG9kJykpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuY29udGV4dC5lbmFibGVFeHRlbmRMb2FkTWV0aG9kO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnRleHTmsqHmnInorr7nva7ml7bvvIznu6fnu63kvb/nlKjpgJrov4fmjIfku6Torr7nva7nmoTlvIDlhbNcclxuICAgIGxldCBlbmFibGVFeHRlbmRMb2FkTWV0aG9kID0gZmFsc2U7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQpIHtcclxuICAgICAgY29uc3QgYmVmQXBpVXJsID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5hcGlVcmk7XHJcbiAgICAgIGNvbnN0IGVuYWJsZUtleSA9IGAke2hlbHBNZXRhZGF0YUlkfUAke2JlZkFwaVVybH1gO1xyXG4gICAgICBlbmFibGVFeHRlbmRMb2FkTWV0aG9kID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0UGFyYW0oZW5hYmxlS2V5KTtcclxuICAgIH1cclxuICAgIHJldHVybiBlbmFibGVFeHRlbmRMb2FkTWV0aG9kO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6ICB55qE5biu5Yqp5Y+W5qCRXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRIZWxwRGF0YShsYWJlbElkOiBzdHJpbmcsIHRhYmxlTmFtZTogc3RyaW5nLCBkYXRhOiBhbnkpOiBPYnNlcnZhYmxlPExvb2t1cEdyaWRSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHVybCA9IGAke3RoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5iYXNlVXJpfS9lbGVtZW50aGVscHMvJHtsYWJlbElkfWA7XHJcbiAgICBjb25zdCB1cGRhdGUkID0gdGhpcy5iZWZSZXBvc2l0b3J5LnVwZGF0ZURhdGFBbmRWYXJpYWJsZUNoYW5nZXMoKTtcclxuICAgIFxyXG4gICAgY29uc3QgcmVzdWx0JCA9IHVwZGF0ZSQucGlwZShcclxuICAgICAgc3dpdGNoTWFwKCgpID0+IHtcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxyXG4gICAgICAgIHJldHVybiB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ0dFVCcsIHsgbm9kZUNvZGU6IHRhYmxlTmFtZSwgcXVlcnlQYXJhbTogSlNPTi5zdHJpbmdpZnkoZGF0YSkgfSwgbnVsbCwgZmFsc2UpLnBpcGUoXHJcbiAgICAgICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZm9ybUFwcENvbnRleHQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBwQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xyXG4gICAgICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgICByZXR1cm4gcmVzdWx0JDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJqeWxleeahOW4ruWKqeWPluaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZXh0ZW5kR2V0SGVscERhdGEobGFiZWxJZDogc3RyaW5nLCB0YWJsZU5hbWU6IHN0cmluZywgZGF0YTogYW55KTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuYmFzZVVyaX0vZXh0ZW5zaW9uL2VsZW1lbnRoZWxwc2A7XHJcbiAgICBjb25zdCBib2R5ID0ge1xyXG4gICAgICBsYWJlbElkOiBsYWJlbElkLFxyXG4gICAgICBub2RlQ29kZTogdGFibGVOYW1lLFxyXG4gICAgICBxdWVyeVBhcmFtOiBkYXRhLFxyXG4gICAgICByZXF1ZXN0SW5mbzogdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxyXG4gICAgfTtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB7XHJcbiAgICAgIGJvZHk6IGJvZHlcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgcmVzdWx0JCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnUFVUJywgbnVsbCwgb3B0aW9ucywgZmFsc2UsIHRydWUsIHRydWUpO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xyXG4gICAgICAgIHJldHVybiByZXNwb25zZUluZm8gJiYgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlIHx8IG51bGw7XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcHBDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCk7XHJcbiAgICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmV2ZW50QnVzLnBvc3QoJ0V4Y2VwdGlvbicsICcnLCAnb25FeGNlcHRpb24nLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xyXG4gICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgfVxyXG4gICAgICApLFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29udmVydDJUcmVlRGF0YVdpdGhQYXRoQ29kZShkYXRhOiBhbnlbXSwgbGF5ZXIgPSAxLCBwYXJlbnRQYXRoQ29kZSA9ICcwMScpIHtcclxuICAgIGxldCBub2RlcyA9IGRhdGEuZmlsdGVyKGQgPT4gZC5sYXllciA9PT0gbGF5ZXIgJiYgZC5wYXRoY29kZSA9PT0gcGFyZW50UGF0aENvZGUpO1xyXG4gICAgaWYgKGxheWVyID4gMSkge1xyXG4gICAgICBub2RlcyA9IGRhdGEuZmlsdGVyKGQgPT4gZC5sYXllciA9PT0gbGF5ZXIgJiYgZC5wYXRoY29kZS5zdWJzdHIoMCwgKGxheWVyIC0gMSkgKiAyKSA9PT0gcGFyZW50UGF0aENvZGUpO1xyXG4gICAgfVxyXG4gICAgaWYgKG5vZGVzLmxlbmd0aCkge1xyXG4gICAgICBjb25zdCB0cmVlTm9kZXMgPSBub2Rlcy5tYXAobiA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgIGRhdGE6IG4sXHJcbiAgICAgICAgICBjaGlsZHJlbjogW11cclxuICAgICAgICB9O1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRyZWVOb2Rlcy5mb3JFYWNoKHRuID0+IHtcclxuICAgICAgICBjb25zdCBfdG5zID0gdGhpcy5jb252ZXJ0MlRyZWVEYXRhV2l0aFBhdGhDb2RlKGRhdGEsIHRuLmRhdGEubGF5ZXIgKyAxLCB0bi5kYXRhLnBhdGhjb2RlKTtcclxuICAgICAgICB0bi5jaGlsZHJlbi5wdXNoKC4uLl90bnMpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHJldHVybiB0cmVlTm9kZXM7XHJcbiAgICB9XHJcbiAgfVxyXG59Il19