import { Injectable } from '@angular/core';
import { of, from, EMPTY } from 'rxjs';
import { every, concatMap, switchMap, take, tap } from 'rxjs/operators';
import { RuntimeFrameworkService } from './rtf-service';
import { MenuStateService } from './menu-state.service';
import { TAB_EVENT } from './types';
import { QuerystringService } from './querystring';
import { UID } from '@farris/devkit';
/**
 * 导航事件服务
 * @scope FormModule
 */
var NavigationEventService = /** @class */ (function () {
    function NavigationEventService(runtimeFrameworkService, menuStateService, querystringService) {
        this.runtimeFrameworkService = runtimeFrameworkService;
        this.menuStateService = menuStateService;
        this.querystringService = querystringService;
        this.onClosedListeners = new Map();
        this.onClosingListeners = new Map();
        this.onTabSwitchListeners = new Map();
    }
    Object.defineProperty(NavigationEventService.prototype, "querystrings", {
        get: function () {
            var params = this.querystringService.parse(window.location.hash);
            // 修正formToken
            if (params) {
                params.formToken = this.runtimeFrameworkService.formToken;
            }
            return params;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 注册事件
     */
    NavigationEventService.prototype.registerEvent = function () {
        var _this = this;
        var options = this.querystrings;
        this.params = options;
        // 注册标签页切换事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabSwitched, function (e) { return _this.handleTabSwitchEvent(e); }, options);
        // 注册标签页关闭后事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosed, function (e) { return _this.handleTabClosedEvent(e); }, options);
        // 注册标签页关闭前事件
        this.runtimeFrameworkService.addEventListener(TAB_EVENT.onTabClosing, function (e) { return _this.handleTabClosingEvent(e); }, options);
    };
    /**
     * 处理标签页切换事件
     */
    NavigationEventService.prototype.handleTabSwitchEvent = function (e) {
        if (!e) {
            return;
        }
        // 选中的表单为系统表单，只能返回id，没有tabId
        var eventTabId = e.tabId || e.id || null;
        if (!eventTabId) {
            return;
        }
        var options = this.params; // this.querystrings;
        var tabId = options.tabId || options.funcId || options.appId;
        var menuState = this.menuStateService.getMenuState(eventTabId);
        if (!!tabId && tabId === eventTabId && !!menuState && menuState.length > 0) {
            this.formReload();
        }
        this.fireTabSwitchEvent(e);
    };
    /**
     * 触发tab切换事件
     * @param e e
     */
    NavigationEventService.prototype.fireTabSwitchEvent = function (e) {
        if (!this.onTabSwitchListeners || this.onTabSwitchListeners.size < 1) {
            return;
        }
        this.onTabSwitchListeners.forEach(function (handle, key, map) {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    };
    /**
     * 标签页关闭前事件
     */
    NavigationEventService.prototype.handleTabClosingEvent = function (e) {
        var _this = this;
        if (!e) {
            return;
        }
        // 要关闭的表单为系统表单，只能返回id，没有tabId
        var eventTabId = e.tabId || e.id || null;
        var options = this.params; // this.querystrings;
        var tabId = options.tabId || options.funcId || options.appId;
        if (!!eventTabId && !!tabId && tabId === eventTabId) {
            this.fireTabClosingEvent(e).subscribe(function (result) {
                if (result) {
                    setTimeout(function () { return _this.removeMenuState(eventTabId); }, 500);
                    var formEventServices = window['formEventServices'];
                    if (formEventServices.has(eventTabId)) {
                        formEventServices.delete(eventTabId);
                        window['formEventServices'] = formEventServices;
                    }
                    if (!(e && e.hasOwnProperty('token'))) {
                        e = Object.assign({}, e, { token: options.formToken });
                    }
                    if (_this.frameContext && _this.frameContext.appContext) {
                        _this.frameContext.appContext.dispose();
                    }
                    _this.runtimeFrameworkService.closeMenu(e);
                }
            });
        }
    };
    /**
     * 触发关闭前事件
     */
    NavigationEventService.prototype.fireTabClosingEvent = function (e) {
        if (!this.onClosingListeners || this.onClosingListeners.size < 1) {
            return of(true);
        }
        var listeners = this.onClosingListeners.values();
        var result$ = from(listeners);
        // 用户拒绝
        var userRejected = false;
        return result$.pipe(concatMap(function (handle) {
            if (userRejected) {
                return EMPTY;
            }
            return handle(e).pipe(take(1), tap(function (result) { return userRejected = !result; }), switchMap(function (result) { return of(result); }));
        }), every(function (result) { return result; }));
    };
    /**
     * 标签页关闭后事件
     */
    NavigationEventService.prototype.handleTabClosedEvent = function (e) {
        if (!e) {
            return;
        }
        var options = this.params; // this.querystrings;
        var tabId = options.tabId || options.funcId || options.appId;
        var eventTabId = e.tabId || e.id || null;
        if (tabId === eventTabId) {
            return;
        }
        var menuState = this.menuStateService.getMenuState(tabId, eventTabId);
        if (!!eventTabId && !!menuState && menuState.length > 0) {
            this.removeMenuState(eventTabId);
            this.formReload();
        }
        this.fireTabClosedEvent(e);
    };
    NavigationEventService.prototype.removeMenuState = function (tabId) {
        if (this['context']) {
            this.menuStateService.removeMenu(tabId);
        }
    };
    /**
     * 触发关闭后事件
     * @param e event
     */
    NavigationEventService.prototype.fireTabClosedEvent = function (e) {
        if (!this.onClosedListeners || this.onClosedListeners.size < 1) {
            return;
        }
        this.onClosedListeners.forEach(function (handle, key, map) {
            if (typeof handle === 'function') {
                handle(e);
            }
        });
    };
    // #endregion
    /**
     * 注册事件监听器
     * @param eventType 事件类型 onTabClosed
     * @param handler 处理器
     */
    NavigationEventService.prototype.addEventListener = function (eventType, handler) {
        var key = UID.create();
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.set(key, handler);
            return key;
        }
        else if (eventType === TAB_EVENT.onTabSwitched) {
            this.onTabSwitchListeners.set(key, handler);
            return key;
        }
        return null;
    };
    /**
     * 移除事件监听器
     * @param eventType 事件类型
     * @param key 事件标识
     */
    NavigationEventService.prototype.removeEventListener = function (eventType, key) {
        if (eventType === TAB_EVENT.onTabClosed) {
            return this.onClosedListeners.delete(key);
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            return this.onClosingListeners.delete(key);
        }
        return false;
    };
    /**
     * 清空事件监听器
     * @param eventType 事件类型
     */
    NavigationEventService.prototype.clearEventListener = function (eventType) {
        if (eventType === TAB_EVENT.onTabClosed) {
            this.onClosedListeners.clear();
        }
        else if (eventType === TAB_EVENT.onTabClosing) {
            this.onClosingListeners.clear();
        }
    };
    /**
     * 刷新组件数据
     */
    NavigationEventService.prototype.formReload = function () {
        try {
            // tslint:disable-next-line: no-string-literal
            this['context']['frameContext']['appContext']['refresh']();
        }
        catch (_a) { }
    };
    NavigationEventService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NavigationEventService.ctorParameters = function () { return [
        { type: RuntimeFrameworkService },
        { type: MenuStateService },
        { type: QuerystringService }
    ]; };
    return NavigationEventService;
}());
export { NavigationEventService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1ldmVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL25hdmlnYXRpb24tZXZlbnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFZLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxFQUFFLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXhFLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQWdCLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRW5EOzs7R0FHRztBQUNIO0lBY0UsZ0NBQ1UsdUJBQWdELEVBQ2hELGdCQUFrQyxFQUNsQyxrQkFBc0M7UUFGdEMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFFOUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksR0FBRyxFQUEwQyxDQUFDO1FBQzNFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsRUFBeUQsQ0FBQztRQUMzRixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxHQUFHLEVBQTBDLENBQUM7SUFDaEYsQ0FBQztJQUNELHNCQUFZLGdEQUFZO2FBQXhCO1lBQ0UsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ25FLGNBQWM7WUFDZCxJQUFJLE1BQU0sRUFBRTtnQkFDVixNQUFNLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxTQUFTLENBQUM7YUFDM0Q7WUFDRCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDOzs7T0FBQTtJQUNEOztPQUVHO0lBQ0ksOENBQWEsR0FBcEI7UUFBQSxpQkFTQztRQVJDLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7UUFDbEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUM7UUFDdEIsWUFBWTtRQUNaLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLFVBQUMsQ0FBQyxJQUFLLE9BQUEsS0FBSSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxFQUE1QixDQUE0QixFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3JILGFBQWE7UUFDYixJQUFJLENBQUMsdUJBQXVCLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxVQUFDLENBQUMsSUFBSyxPQUFBLEtBQUksQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsRUFBNUIsQ0FBNEIsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNuSCxhQUFhO1FBQ2IsSUFBSSxDQUFDLHVCQUF1QixDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsVUFBQyxDQUFDLElBQUssT0FBQSxLQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQyxDQUFDLEVBQTdCLENBQTZCLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDdkgsQ0FBQztJQUNEOztPQUVHO0lBQ0sscURBQW9CLEdBQTVCLFVBQTZCLENBQU07UUFDakMsSUFBSSxDQUFDLENBQUMsRUFBRTtZQUNOLE9BQU87U0FDUjtRQUNELDRCQUE0QjtRQUM1QixJQUFNLFVBQVUsR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDO1FBQzNDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDZixPQUFPO1NBQ1I7UUFDRCxJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMscUJBQXFCO1FBQ2xELElBQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQy9ELElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLENBQUMsS0FBSyxJQUFJLEtBQUssS0FBSyxVQUFVLElBQUksQ0FBQyxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMxRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDbkI7UUFDRCxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUNEOzs7T0FHRztJQUNLLG1EQUFrQixHQUExQixVQUEyQixDQUFNO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksR0FBRyxDQUFDLEVBQUU7WUFDcEUsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRztZQUNqRCxJQUFJLE9BQU8sTUFBTSxLQUFLLFVBQVUsRUFBRTtnQkFDaEMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRDs7T0FFRztJQUNLLHNEQUFxQixHQUE3QixVQUE4QixDQUFNO1FBQXBDLGlCQTJCQztRQTFCQyxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQ04sT0FBTztTQUNSO1FBQ0QsNkJBQTZCO1FBQzdCLElBQU0sVUFBVSxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxJQUFJLENBQUM7UUFDM0MsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLHFCQUFxQjtRQUNsRCxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQztRQUMvRCxJQUFJLENBQUMsQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxLQUFLLEtBQUssVUFBVSxFQUFFO1lBQ25ELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxNQUFNO2dCQUMxQyxJQUFJLE1BQU0sRUFBRTtvQkFDVixVQUFVLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLEVBQWhDLENBQWdDLEVBQUUsR0FBRyxDQUFDLENBQUM7b0JBQ3hELElBQU0saUJBQWlCLEdBQXFCLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO29CQUN4RSxJQUFJLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRTt3QkFDckMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO3dCQUNyQyxNQUFNLENBQUMsbUJBQW1CLENBQUMsR0FBRyxpQkFBaUIsQ0FBQztxQkFDakQ7b0JBQ0QsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRTt3QkFDckMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztxQkFDeEQ7b0JBQ0QsSUFBSSxLQUFJLENBQUMsWUFBWSxJQUFJLEtBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFO3dCQUNyRCxLQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztxQkFDeEM7b0JBQ0QsS0FBSSxDQUFDLHVCQUF1QixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDM0M7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUNEOztPQUVHO0lBQ0ssb0RBQW1CLEdBQTNCLFVBQTRCLENBQU07UUFDaEMsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxHQUFHLENBQUMsRUFBRTtZQUNoRSxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUNELElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNuRCxJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDaEMsT0FBTztRQUNQLElBQUksWUFBWSxHQUFHLEtBQUssQ0FBQztRQUN6QixPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLFNBQVMsQ0FBQyxVQUFBLE1BQU07WUFDZCxJQUFJLFlBQVksRUFBRTtnQkFDaEIsT0FBTyxLQUFLLENBQUM7YUFDZDtZQUNELE9BQU8sTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDbkIsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUNQLEdBQUcsQ0FBQyxVQUFBLE1BQU0sSUFBSSxPQUFBLFlBQVksR0FBRyxDQUFDLE1BQU0sRUFBdEIsQ0FBc0IsQ0FBQyxFQUNyQyxTQUFTLENBQUMsVUFBQSxNQUFNLElBQUksT0FBQSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQVYsQ0FBVSxDQUFDLENBQ2hDLENBQUM7UUFDSixDQUFDLENBQUMsRUFDRixLQUFLLENBQUMsVUFBQSxNQUFNLElBQUksT0FBQSxNQUFNLEVBQU4sQ0FBTSxDQUFDLENBQ3hCLENBQUM7SUFDSixDQUFDO0lBQ0Q7O09BRUc7SUFDSyxxREFBb0IsR0FBNUIsVUFBNkIsQ0FBTTtRQUNqQyxJQUFJLENBQUMsQ0FBQyxFQUFFO1lBQ04sT0FBTztTQUNSO1FBQ0QsSUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLHFCQUFxQjtRQUNsRCxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQztRQUMvRCxJQUFNLFVBQVUsR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksSUFBSSxDQUFDO1FBQzNDLElBQUksS0FBSyxLQUFLLFVBQVUsRUFBRTtZQUN4QixPQUFPO1NBQ1I7UUFDRCxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxVQUFVLENBQUMsQ0FBQztRQUN4RSxJQUFJLENBQUMsQ0FBQyxVQUFVLElBQUksQ0FBQyxDQUFDLFNBQVMsSUFBSSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUN2RCxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNuQjtRQUNELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBQ08sZ0RBQWUsR0FBdkIsVUFBd0IsS0FBYTtRQUNuQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNuQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3pDO0lBQ0gsQ0FBQztJQUNEOzs7T0FHRztJQUNLLG1EQUFrQixHQUExQixVQUEyQixDQUFNO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksR0FBRyxDQUFDLEVBQUU7WUFDOUQsT0FBTztTQUNSO1FBQ0QsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRztZQUM5QyxJQUFJLE9BQU8sTUFBTSxLQUFLLFVBQVUsRUFBRTtnQkFDaEMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDRCxhQUFhO0lBQ2I7Ozs7T0FJRztJQUNJLGlEQUFnQixHQUF2QixVQUF3QixTQUFpQixFQUFFLE9BQXFDO1FBQzlFLElBQU0sR0FBRyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUN6QixJQUFJLFNBQVMsS0FBSyxTQUFTLENBQUMsV0FBVyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sR0FBRyxDQUFDO1NBQ1o7YUFBTSxJQUFJLFNBQVMsS0FBSyxTQUFTLENBQUMsWUFBWSxFQUFFO1lBQy9DLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzFDLE9BQU8sR0FBRyxDQUFDO1NBQ1o7YUFBTSxJQUFJLFNBQVMsS0FBSyxTQUFTLENBQUMsYUFBYSxFQUFFO1lBQ2hELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzVDLE9BQU8sR0FBRyxDQUFDO1NBQ1o7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ksb0RBQW1CLEdBQTFCLFVBQTJCLFNBQWlCLEVBQUUsR0FBVztRQUN2RCxJQUFJLFNBQVMsS0FBSyxTQUFTLENBQUMsV0FBVyxFQUFFO1lBQ3ZDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMzQzthQUFNLElBQUksU0FBUyxLQUFLLFNBQVMsQ0FBQyxZQUFZLEVBQUU7WUFDL0MsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzVDO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ksbURBQWtCLEdBQXpCLFVBQTBCLFNBQWlCO1FBQ3pDLElBQUksU0FBUyxLQUFLLFNBQVMsQ0FBQyxXQUFXLEVBQUU7WUFDdkMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ2hDO2FBQU0sSUFBSSxTQUFTLEtBQUssU0FBUyxDQUFDLFlBQVksRUFBRTtZQUMvQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDakM7SUFDSCxDQUFDO0lBQ0Q7O09BRUc7SUFDSywyQ0FBVSxHQUFsQjtRQUNFLElBQUk7WUFDRiw4Q0FBOEM7WUFDOUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7U0FDNUQ7UUFBQyxXQUFNLEdBQUc7SUFDYixDQUFDOztnQkFqT0YsVUFBVTs7OztnQkFWRix1QkFBdUI7Z0JBQ3ZCLGdCQUFnQjtnQkFFaEIsa0JBQWtCOztJQXlPM0IsNkJBQUM7Q0FBQSxBQWxPRCxJQWtPQztTQWpPWSxzQkFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgZnJvbSwgRU1QVFkgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZXZlcnksIGNvbmNhdE1hcCwgc3dpdGNoTWFwLCB0YWtlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEFwcE9wdGlvbnMgfSBmcm9tICdAZ3NwLXN5cy9ydGYtY29tbW9uJztcclxuaW1wb3J0IHsgUnVudGltZUZyYW1ld29ya1NlcnZpY2UgfSBmcm9tICcuL3J0Zi1zZXJ2aWNlJztcclxuaW1wb3J0IHsgTWVudVN0YXRlU2VydmljZSB9IGZyb20gJy4vbWVudS1zdGF0ZS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgVEFCX0VWRU5UIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IFF1ZXJ5c3RyaW5nU2VydmljZSB9IGZyb20gJy4vcXVlcnlzdHJpbmcnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIFVJRCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuXHJcbi8qKlxyXG4gKiDlr7zoiKrkuovku7bmnI3liqFcclxuICogQHNjb3BlIEZvcm1Nb2R1bGVcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIE5hdmlnYXRpb25FdmVudFNlcnZpY2Uge1xyXG4gIHB1YmxpYyBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuICAvKipcclxuICAgKiDlhbPpl63lkI7kuovku7blpITnkIblmahcclxuICAgKi9cclxuICBwcml2YXRlIG9uQ2xvc2VkTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCAob3B0aW9ucz86IEFwcE9wdGlvbnMpID0+IHZvaWQ+O1xyXG4gIC8qKlxyXG4gICAqIOWFs+mXreWJjeWkhOeQhuWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgb25DbG9zaW5nTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCAob3B0aW9ucz86IEFwcE9wdGlvbnMpID0+IE9ic2VydmFibGU8Ym9vbGVhbj4+O1xyXG4gIHByaXZhdGUgb25UYWJTd2l0Y2hMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIChvcHRpb25zPzogQXBwT3B0aW9ucykgPT4gdm9pZD47XHJcbiAgcHJpdmF0ZSBwYXJhbXM6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnkgfTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIHJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlOiBSdW50aW1lRnJhbWV3b3JrU2VydmljZSxcclxuICAgIHByaXZhdGUgbWVudVN0YXRlU2VydmljZTogTWVudVN0YXRlU2VydmljZSxcclxuICAgIHByaXZhdGUgcXVlcnlzdHJpbmdTZXJ2aWNlOiBRdWVyeXN0cmluZ1NlcnZpY2VcclxuICApIHtcclxuICAgIHRoaXMub25DbG9zZWRMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiB2b2lkPigpO1xyXG4gICAgdGhpcy5vbkNsb3NpbmdMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgKG9wdGlvbnM/OiBBcHBPcHRpb25zKSA9PiBPYnNlcnZhYmxlPGJvb2xlYW4+PigpO1xyXG4gICAgdGhpcy5vblRhYlN3aXRjaExpc3RlbmVycyA9IG5ldyBNYXA8c3RyaW5nLCAob3B0aW9ucz86IEFwcE9wdGlvbnMpID0+IHZvaWQ+KCk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IHF1ZXJ5c3RyaW5ncygpIHtcclxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMucXVlcnlzdHJpbmdTZXJ2aWNlLnBhcnNlKHdpbmRvdy5sb2NhdGlvbi5oYXNoKTtcclxuICAgIC8vIOS/ruato2Zvcm1Ub2tlblxyXG4gICAgaWYgKHBhcmFtcykge1xyXG4gICAgICBwYXJhbXMuZm9ybVRva2VuID0gdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5mb3JtVG9rZW47XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcGFyYW1zO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDms6jlhozkuovku7ZcclxuICAgKi9cclxuICBwdWJsaWMgcmVnaXN0ZXJFdmVudCgpIHtcclxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnF1ZXJ5c3RyaW5ncztcclxuICAgIHRoaXMucGFyYW1zID0gb3B0aW9ucztcclxuICAgIC8vIOazqOWGjOagh+etvumhteWIh+aNouS6i+S7tlxyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5hZGRFdmVudExpc3RlbmVyKFRBQl9FVkVOVC5vblRhYlN3aXRjaGVkLCAoZSkgPT4gdGhpcy5oYW5kbGVUYWJTd2l0Y2hFdmVudChlKSwgb3B0aW9ucyk7XHJcbiAgICAvLyDms6jlhozmoIfnrb7pobXlhbPpl63lkI7kuovku7ZcclxuICAgIHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuYWRkRXZlbnRMaXN0ZW5lcihUQUJfRVZFTlQub25UYWJDbG9zZWQsIChlKSA9PiB0aGlzLmhhbmRsZVRhYkNsb3NlZEV2ZW50KGUpLCBvcHRpb25zKTtcclxuICAgIC8vIOazqOWGjOagh+etvumhteWFs+mXreWJjeS6i+S7tlxyXG4gICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZS5hZGRFdmVudExpc3RlbmVyKFRBQl9FVkVOVC5vblRhYkNsb3NpbmcsIChlKSA9PiB0aGlzLmhhbmRsZVRhYkNsb3NpbmdFdmVudChlKSwgb3B0aW9ucyk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWkhOeQhuagh+etvumhteWIh+aNouS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFuZGxlVGFiU3dpdGNoRXZlbnQoZTogYW55KSB7XHJcbiAgICBpZiAoIWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgLy8g6YCJ5Lit55qE6KGo5Y2V5Li657O757uf6KGo5Y2V77yM5Y+q6IO96L+U5ZueaWTvvIzmsqHmnIl0YWJJZFxyXG4gICAgY29uc3QgZXZlbnRUYWJJZCA9IGUudGFiSWQgfHwgZS5pZCB8fCBudWxsO1xyXG4gICAgaWYgKCFldmVudFRhYklkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLnBhcmFtczsgLy8gdGhpcy5xdWVyeXN0cmluZ3M7XHJcbiAgICBjb25zdCB0YWJJZCA9IG9wdGlvbnMudGFiSWQgfHwgb3B0aW9ucy5mdW5jSWQgfHwgb3B0aW9ucy5hcHBJZDtcclxuICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUoZXZlbnRUYWJJZCk7XHJcbiAgICBpZiAoISF0YWJJZCAmJiB0YWJJZCA9PT0gZXZlbnRUYWJJZCAmJiAhIW1lbnVTdGF0ZSAmJiBtZW51U3RhdGUubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLmZvcm1SZWxvYWQoKTtcclxuICAgIH1cclxuICAgIHRoaXMuZmlyZVRhYlN3aXRjaEV2ZW50KGUpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDop6blj5F0YWLliIfmjaLkuovku7ZcclxuICAgKiBAcGFyYW0gZSBlXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaXJlVGFiU3dpdGNoRXZlbnQoZTogYW55KSB7XHJcbiAgICBpZiAoIXRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMgfHwgdGhpcy5vblRhYlN3aXRjaExpc3RlbmVycy5zaXplIDwgMSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLm9uVGFiU3dpdGNoTGlzdGVuZXJzLmZvckVhY2goKGhhbmRsZSwga2V5LCBtYXApID0+IHtcclxuICAgICAgaWYgKHR5cGVvZiBoYW5kbGUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICBoYW5kbGUoZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmoIfnrb7pobXlhbPpl63liY3kuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGhhbmRsZVRhYkNsb3NpbmdFdmVudChlOiBhbnkpIHtcclxuICAgIGlmICghZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDopoHlhbPpl63nmoTooajljZXkuLrns7vnu5/ooajljZXvvIzlj6rog73ov5Tlm55pZO+8jOayoeaciXRhYklkXHJcbiAgICBjb25zdCBldmVudFRhYklkID0gZS50YWJJZCB8fCBlLmlkIHx8IG51bGw7XHJcbiAgICBjb25zdCBvcHRpb25zID0gdGhpcy5wYXJhbXM7IC8vIHRoaXMucXVlcnlzdHJpbmdzO1xyXG4gICAgY29uc3QgdGFiSWQgPSBvcHRpb25zLnRhYklkIHx8IG9wdGlvbnMuZnVuY0lkIHx8IG9wdGlvbnMuYXBwSWQ7XHJcbiAgICBpZiAoISFldmVudFRhYklkICYmICEhdGFiSWQgJiYgdGFiSWQgPT09IGV2ZW50VGFiSWQpIHtcclxuICAgICAgdGhpcy5maXJlVGFiQ2xvc2luZ0V2ZW50KGUpLnN1YnNjcmliZShyZXN1bHQgPT4ge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZW1vdmVNZW51U3RhdGUoZXZlbnRUYWJJZCksIDUwMCk7XHJcbiAgICAgICAgICBjb25zdCBmb3JtRXZlbnRTZXJ2aWNlczogTWFwPHN0cmluZywgYW55PiA9IHdpbmRvd1snZm9ybUV2ZW50U2VydmljZXMnXTtcclxuICAgICAgICAgIGlmIChmb3JtRXZlbnRTZXJ2aWNlcy5oYXMoZXZlbnRUYWJJZCkpIHtcclxuICAgICAgICAgICAgZm9ybUV2ZW50U2VydmljZXMuZGVsZXRlKGV2ZW50VGFiSWQpO1xyXG4gICAgICAgICAgICB3aW5kb3dbJ2Zvcm1FdmVudFNlcnZpY2VzJ10gPSBmb3JtRXZlbnRTZXJ2aWNlcztcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmICghKGUgJiYgZS5oYXNPd25Qcm9wZXJ0eSgndG9rZW4nKSkpIHtcclxuICAgICAgICAgICAgZSA9IE9iamVjdC5hc3NpZ24oe30sIGUsIHsgdG9rZW46IG9wdGlvbnMuZm9ybVRva2VuIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQpIHtcclxuICAgICAgICAgICAgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5kaXNwb3NlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmNsb3NlTWVudShlKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDop6blj5HlhbPpl63liY3kuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIGZpcmVUYWJDbG9zaW5nRXZlbnQoZTogYW55KTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XHJcbiAgICBpZiAoIXRoaXMub25DbG9zaW5nTGlzdGVuZXJzIHx8IHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLnNpemUgPCAxKSB7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGxpc3RlbmVycyA9IHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLnZhbHVlcygpO1xyXG4gICAgY29uc3QgcmVzdWx0JCA9IGZyb20obGlzdGVuZXJzKTtcclxuICAgIC8vIOeUqOaIt+aLkue7nVxyXG4gICAgbGV0IHVzZXJSZWplY3RlZCA9IGZhbHNlO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgY29uY2F0TWFwKGhhbmRsZSA9PiB7XHJcbiAgICAgICAgaWYgKHVzZXJSZWplY3RlZCkge1xyXG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaGFuZGxlKGUpLnBpcGUoXHJcbiAgICAgICAgICB0YWtlKDEpLFxyXG4gICAgICAgICAgdGFwKHJlc3VsdCA9PiB1c2VyUmVqZWN0ZWQgPSAhcmVzdWx0KSxcclxuICAgICAgICAgIHN3aXRjaE1hcChyZXN1bHQgPT4gb2YocmVzdWx0KSlcclxuICAgICAgICApO1xyXG4gICAgICB9KSxcclxuICAgICAgZXZlcnkocmVzdWx0ID0+IHJlc3VsdClcclxuICAgICk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOagh+etvumhteWFs+mXreWQjuS6i+S7tlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaGFuZGxlVGFiQ2xvc2VkRXZlbnQoZTogYW55KSB7XHJcbiAgICBpZiAoIWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMucGFyYW1zOyAvLyB0aGlzLnF1ZXJ5c3RyaW5ncztcclxuICAgIGNvbnN0IHRhYklkID0gb3B0aW9ucy50YWJJZCB8fCBvcHRpb25zLmZ1bmNJZCB8fCBvcHRpb25zLmFwcElkO1xyXG4gICAgY29uc3QgZXZlbnRUYWJJZCA9IGUudGFiSWQgfHwgZS5pZCB8fCBudWxsO1xyXG4gICAgaWYgKHRhYklkID09PSBldmVudFRhYklkKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUodGFiSWQsIGV2ZW50VGFiSWQpO1xyXG4gICAgaWYgKCEhZXZlbnRUYWJJZCAmJiAhIW1lbnVTdGF0ZSAmJiBtZW51U3RhdGUubGVuZ3RoID4gMCkge1xyXG4gICAgICB0aGlzLnJlbW92ZU1lbnVTdGF0ZShldmVudFRhYklkKTtcclxuICAgICAgdGhpcy5mb3JtUmVsb2FkKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmZpcmVUYWJDbG9zZWRFdmVudChlKTtcclxuICB9XHJcbiAgcHJpdmF0ZSByZW1vdmVNZW51U3RhdGUodGFiSWQ6IHN0cmluZykge1xyXG4gICAgaWYgKHRoaXNbJ2NvbnRleHQnXSkge1xyXG4gICAgICB0aGlzLm1lbnVTdGF0ZVNlcnZpY2UucmVtb3ZlTWVudSh0YWJJZCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOinpuWPkeWFs+mXreWQjuS6i+S7tlxyXG4gICAqIEBwYXJhbSBlIGV2ZW50XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBmaXJlVGFiQ2xvc2VkRXZlbnQoZTogYW55KSB7XHJcbiAgICBpZiAoIXRoaXMub25DbG9zZWRMaXN0ZW5lcnMgfHwgdGhpcy5vbkNsb3NlZExpc3RlbmVycy5zaXplIDwgMSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLmZvckVhY2goKGhhbmRsZSwga2V5LCBtYXApID0+IHtcclxuICAgICAgaWYgKHR5cGVvZiBoYW5kbGUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgICBoYW5kbGUoZSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuICAvLyAjZW5kcmVnaW9uXHJcbiAgLyoqXHJcbiAgICog5rOo5YaM5LqL5Lu255uR5ZCs5ZmoXHJcbiAgICogQHBhcmFtIGV2ZW50VHlwZSDkuovku7bnsbvlnosgb25UYWJDbG9zZWRcclxuICAgKiBAcGFyYW0gaGFuZGxlciDlpITnkIblmahcclxuICAgKi9cclxuICBwdWJsaWMgYWRkRXZlbnRMaXN0ZW5lcihldmVudFR5cGU6IHN0cmluZywgaGFuZGxlcjogKG9wdGlvbnM6IEFwcE9wdGlvbnMpID0+IGFueSk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBrZXkgPSBVSUQuY3JlYXRlKCk7XHJcbiAgICBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zZWQpIHtcclxuICAgICAgdGhpcy5vbkNsb3NlZExpc3RlbmVycy5zZXQoa2V5LCBoYW5kbGVyKTtcclxuICAgICAgcmV0dXJuIGtleTtcclxuICAgIH0gZWxzZSBpZiAoZXZlbnRUeXBlID09PSBUQUJfRVZFTlQub25UYWJDbG9zaW5nKSB7XHJcbiAgICAgIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLnNldChrZXksIGhhbmRsZXIpO1xyXG4gICAgICByZXR1cm4ga2V5O1xyXG4gICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYlN3aXRjaGVkKSB7XHJcbiAgICAgIHRoaXMub25UYWJTd2l0Y2hMaXN0ZW5lcnMuc2V0KGtleSwgaGFuZGxlcik7XHJcbiAgICAgIHJldHVybiBrZXk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog56e76Zmk5LqL5Lu255uR5ZCs5ZmoXHJcbiAgICogQHBhcmFtIGV2ZW50VHlwZSDkuovku7bnsbvlnotcclxuICAgKiBAcGFyYW0ga2V5IOS6i+S7tuagh+ivhlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50VHlwZTogc3RyaW5nLCBrZXk6IHN0cmluZykge1xyXG4gICAgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiQ2xvc2VkKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLmRlbGV0ZShrZXkpO1xyXG4gICAgfSBlbHNlIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NpbmcpIHtcclxuICAgICAgcmV0dXJuIHRoaXMub25DbG9zaW5nTGlzdGVuZXJzLmRlbGV0ZShrZXkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuIXnqbrkuovku7bnm5HlkKzlmahcclxuICAgKiBAcGFyYW0gZXZlbnRUeXBlIOS6i+S7tuexu+Wei1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckV2ZW50TGlzdGVuZXIoZXZlbnRUeXBlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmIChldmVudFR5cGUgPT09IFRBQl9FVkVOVC5vblRhYkNsb3NlZCkge1xyXG4gICAgICB0aGlzLm9uQ2xvc2VkTGlzdGVuZXJzLmNsZWFyKCk7XHJcbiAgICB9IGVsc2UgaWYgKGV2ZW50VHlwZSA9PT0gVEFCX0VWRU5ULm9uVGFiQ2xvc2luZykge1xyXG4gICAgICB0aGlzLm9uQ2xvc2luZ0xpc3RlbmVycy5jbGVhcigpO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDliLfmlrDnu4Tku7bmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGZvcm1SZWxvYWQoKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLXN0cmluZy1saXRlcmFsXHJcbiAgICAgIHRoaXNbJ2NvbnRleHQnXVsnZnJhbWVDb250ZXh0J11bJ2FwcENvbnRleHQnXVsncmVmcmVzaCddKCk7XHJcbiAgICB9IGNhdGNoIHsgfVxyXG4gIH1cclxufVxyXG4iXX0=