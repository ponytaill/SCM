/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, Subject } from "rxjs";
/**
 * 保存方案API
 * @type {?}
 */
var SCHEME_WEBAPI = '/api/runtime/sys/v1.0/querysolution';
/**
 * 获取方案列表API
 * @type {?}
 */
var SCHEME_WEBAPI_QUERY = SCHEME_WEBAPI + "/belongId/";
/**
 * 方案列表管理- 设默认、删除 API
 * @type {?}
 */
var SCHEME_WEBAPI_UPDATE = SCHEME_WEBAPI + "/batch";
/**
 * 权限验证
 * @type {?}
 */
var SCHEME_WEBAPI_Auth = '/api/runtime/sys/v1.0/querysolution/componentType/Datagrid';
/** @type {?} */
var LANGUAGE_WEBAPI = '/api/runtime/sys/v1.0/loginInfo?infoType=supportedLanguage';
var DatagridSchemeService = /** @class */ (function () {
    function DatagridSchemeService() {
        this.restService = null;
        this.state = {};
        this.schemeList$ = new Subject();
    }
    /**
     * @param {?} d
     * @param {?} gridId
     * @return {?}
     */
    DatagridSchemeService.prototype.update = /**
     * @param {?} d
     * @param {?} gridId
     * @return {?}
     */
    function (d, gridId) {
        if (!this.state[gridId]) {
            this.state[gridId] = {};
        }
        this.state[gridId] = Object.assign(this.state[gridId], d);
    };
    /**
     * @param {?} httpSer
     * @return {?}
     */
    DatagridSchemeService.prototype.setRestService = /**
     * @param {?} httpSer
     * @return {?}
     */
    function (httpSer) {
        if (httpSer && httpSer['befRepository']) {
            this.restService = httpSer['befRepository']['restService'];
        }
    };
    /**
     * @private
     * @return {?}
     */
    DatagridSchemeService.prototype.getWebFormKey = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var webformHash = window.location.hash.split('?')[0];
        return webformHash.substring(webformHash.lastIndexOf('/') + 1);
    };
    /**
     * @param {?} gridId
     * @return {?}
     */
    DatagridSchemeService.prototype.getSchemeKey = /**
     * @param {?} gridId
     * @return {?}
     */
    function (gridId) {
        /** @type {?} */
        var formKey = this.getWebFormKey();
        return formKey + "_DatagridScheme_" + gridId;
    };
    /**
     * @param {?} gridID
     * @return {?}
     */
    DatagridSchemeService.prototype.getSchemeList = /**
     * @param {?} gridID
     * @return {?}
     */
    function (gridID) {
        /** @type {?} */
        var uri = SCHEME_WEBAPI_QUERY + this.getSchemeKey(gridID);
        if (this.restService) {
            return this.restService.invoke(uri, 'GET', null, null, false);
        }
    };
    /**
     * @param {?} scheme
     * @param {?} gridID
     * @param {?=} isUpdate
     * @return {?}
     */
    DatagridSchemeService.prototype.saveScheme = /**
     * @param {?} scheme
     * @param {?} gridID
     * @param {?=} isUpdate
     * @return {?}
     */
    function (scheme, gridID, isUpdate) {
        if (isUpdate === void 0) { isUpdate = false; }
        if (this.restService) {
            /** @type {?} */
            var httpMethod = isUpdate ? 'PUT' : 'POST';
            scheme.belongId = this.getSchemeKey(gridID);
            return this.restService.invoke(SCHEME_WEBAPI, httpMethod, null, { body: scheme }, false);
        }
    };
    /**
     * @param {?} param
     * @param {?} gridID
     * @return {?}
     */
    DatagridSchemeService.prototype.updateScheme = /**
     * @param {?} param
     * @param {?} gridID
     * @return {?}
     */
    function (param, gridID) {
        if (!param) {
            return of(false);
        }
        /** @type {?} */
        var belongId = this.getSchemeKey(gridID);
        param.belongId = belongId;
        if (param.belongId) {
            return this.restService.invoke(SCHEME_WEBAPI_UPDATE, 'PUT', null, { body: param }, false);
        }
    };
    /**
     * @param {?} gridId
     * @param {...?} statePro
     * @return {?}
     */
    DatagridSchemeService.prototype.getStateValue = /**
     * @param {?} gridId
     * @param {...?} statePro
     * @return {?}
     */
    function (gridId) {
        var statePro = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            statePro[_i - 1] = arguments[_i];
        }
        /** @type {?} */
        var dgState = this.state[gridId];
        if (dgState) {
            if (statePro && statePro.length) {
                return statePro.reduce((/**
                 * @param {?} r
                 * @param {?} c
                 * @return {?}
                 */
                function (r, c) {
                    return r[c];
                }), dgState);
            }
            return dgState;
        }
        return null;
    };
    /**
     * @private
     * @param {?} gridId
     * @param {?} propertyName
     * @param {?} value
     * @return {?}
     */
    DatagridSchemeService.prototype.updateStateValue = /**
     * @private
     * @param {?} gridId
     * @param {?} propertyName
     * @param {?} value
     * @return {?}
     */
    function (gridId, propertyName, value) {
        var _a;
        this.update((_a = {}, _a[propertyName] = value, _a), gridId);
    };
    /**
     * @param {?} gridId
     * @param {?} newSchemeList
     * @return {?}
     */
    DatagridSchemeService.prototype.setSchemeList = /**
     * @param {?} gridId
     * @param {?} newSchemeList
     * @return {?}
     */
    function (gridId, newSchemeList) {
        this.updateStateValue(gridId, 'list', newSchemeList);
        this.schemeList$.next(newSchemeList);
    };
    /**
     * @param {?} gridId
     * @param {?} schemeName
     * @return {?}
     */
    DatagridSchemeService.prototype.hasSchemeName = /**
     * @param {?} gridId
     * @param {?} schemeName
     * @return {?}
     */
    function (gridId, schemeName) {
        /** @type {?} */
        var schemeList = this.getStateValue(gridId, 'list');
        if (!schemeList || !schemeList.length) {
            return false;
        }
        if (typeof schemeName === 'string') {
            return !!schemeList.find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.name === schemeName.trim(); }));
        }
        else {
            if (typeof schemeName === 'object') {
                /** @type {?} */
                var replayNames_1 = [];
                schemeList.forEach((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) {
                    if (n.name) {
                        /** @type {?} */
                        var nameObj = JSON.parse(n.name);
                        // const currentNames = Object.values(nameObj);
                        for (var k in schemeName) {
                            if (nameObj[k] === schemeName[k]) {
                                replayNames_1.push(k);
                            }
                        }
                    }
                }));
                return replayNames_1;
            }
        }
    };
    /**
     * @return {?}
     */
    DatagridSchemeService.prototype.checkAuthority = /**
     * @return {?}
     */
    function () {
        return this.restService.invoke(SCHEME_WEBAPI_Auth, 'GET', null, null, false);
    };
    /**
     * @return {?}
     */
    DatagridSchemeService.prototype.getLanguages = /**
     * @return {?}
     */
    function () {
        if (this.restService) {
            return this.restService.invoke(LANGUAGE_WEBAPI, 'GET', null, null, false);
        }
        else {
            return of([]);
        }
    };
    return DatagridSchemeService;
}());
export { DatagridSchemeService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.state;
    /** @type {?} */
    DatagridSchemeService.prototype.schemeList$;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc2NoZW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLXNldHRpbmdzLyIsInNvdXJjZXMiOlsibGliL2RhdGFncmlkLXNjaGVtZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7Ozs7SUFLekMsYUFBYSxHQUFHLHFDQUFxQzs7Ozs7SUFFckQsbUJBQW1CLEdBQU0sYUFBYSxlQUFZOzs7OztJQUVsRCxvQkFBb0IsR0FBTSxhQUFhLFdBQVE7Ozs7O0lBRS9DLGtCQUFrQixHQUFHLDREQUE0RDs7SUFFakYsZUFBZSxHQUFHLDREQUE0RDtBQUdwRjtJQU1JO1FBTFEsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFDbkIsVUFBSyxHQUFrQixFQUFFLENBQUM7UUFFbEMsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBRzVCLENBQUM7Ozs7OztJQUVELHNDQUFNOzs7OztJQUFOLFVBQU8sQ0FBYyxFQUFFLE1BQWM7UUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDM0I7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDOzs7OztJQUVELDhDQUFjOzs7O0lBQWQsVUFBZSxPQUFZO1FBQ3ZCLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUM5RDtJQUNMLENBQUM7Ozs7O0lBRU8sNkNBQWE7Ozs7SUFBckI7O1lBQ1UsV0FBVyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEQsT0FBTyxXQUFXLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDbkUsQ0FBQzs7Ozs7SUFFRCw0Q0FBWTs7OztJQUFaLFVBQWEsTUFBYzs7WUFDakIsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUU7UUFDcEMsT0FBVSxPQUFPLHdCQUFtQixNQUFRLENBQUM7SUFDakQsQ0FBQzs7Ozs7SUFFRCw2Q0FBYTs7OztJQUFiLFVBQWMsTUFBYzs7WUFDbEIsR0FBRyxHQUFHLG1CQUFtQixHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDO1FBQzNELElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNqRTtJQUNMLENBQUM7Ozs7Ozs7SUFFRCwwQ0FBVTs7Ozs7O0lBQVYsVUFBVyxNQUEyQixFQUFFLE1BQWMsRUFBRSxRQUFnQjtRQUFoQix5QkFBQSxFQUFBLGdCQUFnQjtRQUNwRSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7O2dCQUNaLFVBQVUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQSxDQUFDLENBQUMsTUFBTTtZQUMzQyxNQUFNLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDNUMsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzRjtJQUNMLENBQUM7Ozs7OztJQUVELDRDQUFZOzs7OztJQUFaLFVBQWEsS0FBa0IsRUFBRSxNQUFjO1FBQzNDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDUixPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNwQjs7WUFDSyxRQUFRLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUM7UUFDMUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUE7UUFFekIsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFO1lBQ2hCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsb0JBQW9CLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFDLElBQUksRUFBRSxLQUFLLEVBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUMzRjtJQUNMLENBQUM7Ozs7OztJQUVELDZDQUFhOzs7OztJQUFiLFVBQWMsTUFBTTtRQUFFLGtCQUFXO2FBQVgsVUFBVyxFQUFYLHFCQUFXLEVBQVgsSUFBVztZQUFYLGlDQUFXOzs7WUFDdkIsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ2xDLElBQUksT0FBTyxFQUFFO1lBQ1QsSUFBSSxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sRUFBRTtnQkFDN0IsT0FBTyxRQUFRLENBQUMsTUFBTTs7Ozs7Z0JBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQztvQkFDeEIsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsR0FBRSxPQUFPLENBQUMsQ0FBQTthQUNkO1lBRUQsT0FBTyxPQUFPLENBQUM7U0FDbEI7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzs7Ozs7OztJQUVPLGdEQUFnQjs7Ozs7OztJQUF4QixVQUF5QixNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUs7O1FBQ2hELElBQUksQ0FBQyxNQUFNLFdBQUUsR0FBQyxZQUFZLElBQUcsS0FBSyxPQUFHLE1BQU0sQ0FBQyxDQUFDO0lBQ2pELENBQUM7Ozs7OztJQUVELDZDQUFhOzs7OztJQUFiLFVBQWMsTUFBTSxFQUFFLGFBQWE7UUFDL0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDekMsQ0FBQzs7Ozs7O0lBRUQsNkNBQWE7Ozs7O0lBQWIsVUFBYyxNQUFNLEVBQUUsVUFBZTs7WUFDM0IsVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztRQUNyRCxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRTtZQUNuQyxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUVELElBQUksT0FBTyxVQUFVLEtBQUssUUFBUSxFQUFFO1lBQ2hDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJOzs7O1lBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLEVBQUUsRUFBNUIsQ0FBNEIsRUFBQyxDQUFDO1NBQy9EO2FBQU07WUFDSCxJQUFJLE9BQU8sVUFBVSxLQUFLLFFBQVEsRUFBRTs7b0JBQzFCLGFBQVcsR0FBRyxFQUFFO2dCQUN0QixVQUFVLENBQUMsT0FBTzs7OztnQkFBQyxVQUFBLENBQUM7b0JBQ2hCLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRTs7NEJBQ0YsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQzt3QkFDbEMsK0NBQStDO3dCQUMvQyxLQUFJLElBQUksQ0FBQyxJQUFJLFVBQVUsRUFBRTs0QkFDckIsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFO2dDQUM5QixhQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDOzZCQUN2Qjt5QkFDSjtxQkFDSjtnQkFDTCxDQUFDLEVBQUMsQ0FBQztnQkFFSCxPQUFPLGFBQVcsQ0FBQzthQUN0QjtTQUNKO0lBQ0wsQ0FBQzs7OztJQUVELDhDQUFjOzs7SUFBZDtRQUNJLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDakYsQ0FBQzs7OztJQUVELDRDQUFZOzs7SUFBWjtRQUNJLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM3RTthQUFNO1lBQ0gsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDakI7SUFDTCxDQUFDO0lBQ0wsNEJBQUM7QUFBRCxDQUFDLEFBekhELElBeUhDOzs7Ozs7O0lBeEhHLDRDQUEyQjs7Ozs7SUFDM0Isc0NBQWtDOztJQUVsQyw0Q0FBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3ViamVjdCB9IGZyb20gXCJyeGpzXCI7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xyXG5pbXBvcnQgeyBCYXRjaFNjaGVtZSwgRGF0YWdyaWRTY2hlbWVNb2RlbCwgRGdTY2hlbWVTdGF0ZSwgU2NoZW1lQXV0aE1vZGVsLCBTY2hlbWVTdGF0ZSB9IGZyb20gXCIuL3NldHRpbmcubW9kZWxcIjtcclxuXHJcbi8qKiDkv53lrZjmlrnmoYhBUEkgKi9cclxuY29uc3QgU0NIRU1FX1dFQkFQSSA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvcXVlcnlzb2x1dGlvbic7XHJcbi8qKiDojrflj5bmlrnmoYjliJfooahBUEkgKi9cclxuY29uc3QgU0NIRU1FX1dFQkFQSV9RVUVSWSA9IGAke1NDSEVNRV9XRUJBUEl9L2JlbG9uZ0lkL2A7XHJcbi8qKiDmlrnmoYjliJfooajnrqHnkIYtIOiuvum7mOiupOOAgeWIoOmZpCBBUEkgKi9cclxuY29uc3QgU0NIRU1FX1dFQkFQSV9VUERBVEUgPSBgJHtTQ0hFTUVfV0VCQVBJfS9iYXRjaGA7XHJcbi8qKiDmnYPpmZDpqozor4EgKi9cclxuY29uc3QgU0NIRU1FX1dFQkFQSV9BdXRoID0gJy9hcGkvcnVudGltZS9zeXMvdjEuMC9xdWVyeXNvbHV0aW9uL2NvbXBvbmVudFR5cGUvRGF0YWdyaWQnO1xyXG5cclxuY29uc3QgTEFOR1VBR0VfV0VCQVBJID0gJy9hcGkvcnVudGltZS9zeXMvdjEuMC9sb2dpbkluZm8/aW5mb1R5cGU9c3VwcG9ydGVkTGFuZ3VhZ2UnO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBEYXRhZ3JpZFNjaGVtZVNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSByZXN0U2VydmljZSA9IG51bGw7XHJcbiAgICBwcml2YXRlIHN0YXRlOiBEZ1NjaGVtZVN0YXRlID0ge307XHJcblxyXG4gICAgc2NoZW1lTGlzdCQgPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZShkOiBTY2hlbWVTdGF0ZSwgZ3JpZElkOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoIXRoaXMuc3RhdGVbZ3JpZElkXSkge1xyXG4gICAgICAgICAgICB0aGlzLnN0YXRlW2dyaWRJZF0gPSB7fTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5zdGF0ZVtncmlkSWRdID0gT2JqZWN0LmFzc2lnbih0aGlzLnN0YXRlW2dyaWRJZF0sIGQpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFJlc3RTZXJ2aWNlKGh0dHBTZXI6IGFueSkge1xyXG4gICAgICAgIGlmIChodHRwU2VyICYmIGh0dHBTZXJbJ2JlZlJlcG9zaXRvcnknXSkge1xyXG4gICAgICAgICAgICB0aGlzLnJlc3RTZXJ2aWNlID0gaHR0cFNlclsnYmVmUmVwb3NpdG9yeSddWydyZXN0U2VydmljZSddO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFdlYkZvcm1LZXkoKSB7XHJcbiAgICAgICAgY29uc3Qgd2ViZm9ybUhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaC5zcGxpdCgnPycpWzBdO1xyXG4gICAgICAgIHJldHVybiB3ZWJmb3JtSGFzaC5zdWJzdHJpbmcod2ViZm9ybUhhc2gubGFzdEluZGV4T2YoJy8nKSArIDEpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNjaGVtZUtleShncmlkSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGZvcm1LZXkgPSB0aGlzLmdldFdlYkZvcm1LZXkoKTtcclxuICAgICAgICByZXR1cm4gYCR7Zm9ybUtleX1fRGF0YWdyaWRTY2hlbWVfJHtncmlkSWR9YDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTY2hlbWVMaXN0KGdyaWRJRDogc3RyaW5nKTogT2JzZXJ2YWJsZTxEYXRhZ3JpZFNjaGVtZU1vZGVsW10+IHtcclxuICAgICAgICBjb25zdCB1cmkgPSBTQ0hFTUVfV0VCQVBJX1FVRVJZICsgdGhpcy5nZXRTY2hlbWVLZXkoZ3JpZElEKTtcclxuICAgICAgICBpZiAodGhpcy5yZXN0U2VydmljZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UodXJpLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzYXZlU2NoZW1lKHNjaGVtZTogRGF0YWdyaWRTY2hlbWVNb2RlbCwgZ3JpZElEOiBzdHJpbmcsIGlzVXBkYXRlID0gZmFsc2UpIHtcclxuICAgICAgICBpZiAodGhpcy5yZXN0U2VydmljZSkge1xyXG4gICAgICAgICAgICBjb25zdCBodHRwTWV0aG9kID0gaXNVcGRhdGUgPyAnUFVUJzogJ1BPU1QnO1xyXG4gICAgICAgICAgICBzY2hlbWUuYmVsb25nSWQgPSB0aGlzLmdldFNjaGVtZUtleShncmlkSUQpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UoU0NIRU1FX1dFQkFQSSwgaHR0cE1ldGhvZCwgbnVsbCwgeyBib2R5OiBzY2hlbWV9LCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZVNjaGVtZShwYXJhbTogQmF0Y2hTY2hlbWUsIGdyaWRJRDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBpZiAoIXBhcmFtKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGJlbG9uZ0lkID0gdGhpcy5nZXRTY2hlbWVLZXkoZ3JpZElEKTtcclxuICAgICAgICBwYXJhbS5iZWxvbmdJZCA9IGJlbG9uZ0lkXHJcblxyXG4gICAgICAgIGlmIChwYXJhbS5iZWxvbmdJZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UoU0NIRU1FX1dFQkFQSV9VUERBVEUsICdQVVQnLCBudWxsLCB7Ym9keTogcGFyYW19LCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldFN0YXRlVmFsdWUoZ3JpZElkLCAuLi5zdGF0ZVBybykge1xyXG4gICAgICAgIGNvbnN0IGRnU3RhdGUgPSB0aGlzLnN0YXRlW2dyaWRJZF07XHJcbiAgICAgICAgaWYgKGRnU3RhdGUpIHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlUHJvICYmIHN0YXRlUHJvLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0YXRlUHJvLnJlZHVjZSgociwgYykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByW2NdO1xyXG4gICAgICAgICAgICAgICAgfSwgZGdTdGF0ZSlcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIGRnU3RhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgdXBkYXRlU3RhdGVWYWx1ZShncmlkSWQsIHByb3BlcnR5TmFtZSwgdmFsdWUpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZSh7W3Byb3BlcnR5TmFtZV06IHZhbHVlfSwgZ3JpZElkKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRTY2hlbWVMaXN0KGdyaWRJZCwgbmV3U2NoZW1lTGlzdCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGVWYWx1ZShncmlkSWQsICdsaXN0JywgbmV3U2NoZW1lTGlzdCk7XHJcbiAgICAgICAgdGhpcy5zY2hlbWVMaXN0JC5uZXh0KG5ld1NjaGVtZUxpc3QpO1xyXG4gICAgfVxyXG5cclxuICAgIGhhc1NjaGVtZU5hbWUoZ3JpZElkLCBzY2hlbWVOYW1lOiBhbnkpIHtcclxuICAgICAgICBjb25zdCBzY2hlbWVMaXN0ID0gdGhpcy5nZXRTdGF0ZVZhbHVlKGdyaWRJZCwgJ2xpc3QnKTtcclxuICAgICAgICBpZiAoIXNjaGVtZUxpc3QgfHwgIXNjaGVtZUxpc3QubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0eXBlb2Ygc2NoZW1lTmFtZSA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgcmV0dXJuICEhc2NoZW1lTGlzdC5maW5kKG4gPT4gbi5uYW1lID09PSBzY2hlbWVOYW1lLnRyaW0oKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBzY2hlbWVOYW1lID09PSAnb2JqZWN0Jykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcmVwbGF5TmFtZXMgPSBbXTtcclxuICAgICAgICAgICAgICAgIHNjaGVtZUxpc3QuZm9yRWFjaChuID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobi5uYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVPYmogPSBKU09OLnBhcnNlKG4ubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IGN1cnJlbnROYW1lcyA9IE9iamVjdC52YWx1ZXMobmFtZU9iaik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihsZXQgayBpbiBzY2hlbWVOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobmFtZU9ialtrXSA9PT0gc2NoZW1lTmFtZVtrXSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxheU5hbWVzLnB1c2goayk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGF5TmFtZXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tBdXRob3JpdHkoKTogT2JzZXJ2YWJsZTxTY2hlbWVBdXRoTW9kZWw+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UoU0NIRU1FX1dFQkFQSV9BdXRoLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExhbmd1YWdlcygpIHtcclxuICAgICAgICBpZiAodGhpcy5yZXN0U2VydmljZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UoTEFOR1VBR0VfV0VCQVBJLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==