/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
import { FavoriteAction, LookupGridDisplayType } from '../lookup-displaytype';
import { of } from 'rxjs';
import { map, switchMap, tap } from 'rxjs/operators';
// 帮助默认个性化数据
/** @type {?} */
const DefaultUserConfig = {
    tabIndex: 'datalist',
    favorite: null,
    size: null
};
export class LookupHttpManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        // 每次帮助打开后，更新此值，做为个性化数据的初始值；
        // 关闭窗口时，与此进行对比。如果一样，则不保存；
        this._originalPersonalConfig = DefaultUserConfig;
    }
    /**
     * @private
     * @return {?}
     */
    disablePagination() {
        return {
            pageIndex: 1,
            pageSize: 500
        };
    }
    /**
     * 构造查询参数
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    buildQueryParams(event, type = 'all') {
        /** @type {?} */
        const params = {};
        if (this.ins.condition) {
            params.condition = cloneDeep(this.ins.condition);
        }
        /** @type {?} */
        const searchParam = { category: type };
        if (type !== 'fav') {
            if (this.ins.isDoublleList() && this.ins.navigationFilter && type !== 'all') {
                if (this.ins.navigationFilter.idValue && type !== 'textchange') {
                    params.relationFilter = [...this.ins.navigationFilter.idValue];
                }
            }
        }
        if (event) {
            if (type === 'fav' || type === 'selected') {
                event.pageInfo = this.disablePagination();
            }
            if (event.pageInfo) {
                params.pageIndex = event.pageInfo.pageIndex;
                params.pageSize = event.pageInfo.pageSize;
            }
            if (event.search) {
                /** @type {?} */
                let sfield = event.search.field;
                if (sfield && sfield === '*') {
                    sfield = '*';
                }
                if (event.search.value) {
                    event.search.value = event.search.value.trim();
                }
                searchParam.searchField = sfield;
                searchParam.searchValue = event.search.value;
                searchParam.searchType = event.search.type || 'like';
                if (event.search.value === '' && searchParam.category === 'search') {
                    searchParam.category = 'all';
                }
            }
            if (event.sortName) {
                searchParam.sortName = event.sortName;
            }
            if (event.sortOrder) {
                searchParam.sortOrder = event.sortOrder;
            }
        }
        if (type === 'fav' && event.favoriteIds) {
            searchParam.favoriteIds = event.favoriteIds;
        }
        if (this.ins.isTree() || this.ins.displayType === LookupGridDisplayType.NavTreeList) {
            params.enableFullTree = this.ins.enableFullTree;
        }
        params.treeToList = this.ins.treeToList;
        params.navTreeToList = this.ins.navTreeToList;
        // 查询时不构造完整树
        if (type === 'textchange') {
            params.enableFullTree = false;
        }
        if (type === 'selected') {
            searchParam.category = 'fav';
            params.enableFullTree = false;
            searchParam.favoriteIds = event.favoriteIds;
        }
        params.searchValue = JSON.stringify(searchParam);
        params.loadTreeDataType = this.ins.loadTreeDataType;
        params.customData = this.ins.customData;
        if (this.ins.helpId) {
            params.helpId = this.ins.helpId;
        }
        if (event.selectedInfo) {
            params.selectedInfo = event.selectedInfo;
        }
        if (event.navNodePathCode !== undefined) {
            params.navPathCode = event.navNodePathCode;
        }
        else {
            if (type === 'navAllChildren') {
                if (this.ins.includeSubordinates && this.ins['navNodePathCode']) {
                    params.navPathCode = this.ins['navNodePathCode'];
                }
            }
        }
        return params;
    }
    /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    getData(event, type = 'all') {
        /** @type {?} */
        const uri = this.ins.gridOptions.uri;
        if (this.ins.isDoublleList() && this.ins.navigationFilter && this.ins.navigationFilter.idValue && type !== 'fav') {
            if (this.ins.includeSubordinates && this.ins.navigationOptions.treeInfo.loadDataType === 'async') {
                type = 'navAllChildren';
            }
            else {
                type = 'list';
            }
        }
        /** @type {?} */
        const params = this.buildQueryParams(event, type);
        if (uri || this.ins.beUri) {
            if (this.ins.beUri && this.ins.columns && this.ins.columns.length) {
                /** @type {?} */
                const allSearchFields = this.ins.columns.map((/**
                 * @param {?} col
                 * @return {?}
                 */
                col => col.searchField)).filter((/**
                 * @param {?} f
                 * @return {?}
                 */
                f => f));
                if (!params.condition) {
                    params.condition = {};
                }
                if (!this.ins.isTree() && this.ins.pagination) {
                    const { pageSize = this.ins.pageSize || 20, pageIndex } = Object.assign({}, params);
                    params.condition.pagination = { pageSize, pageIndex };
                }
                else {
                    params.condition.pagination = { isUsePagination: false };
                }
                /** @type {?} */
                const searchParam = JSON.parse(params.searchValue);
                if (searchParam.searchValue) {
                    params.condition = this.ins.lookupUtils.mergeCondition(params.condition, allSearchFields, {
                        field: searchParam.searchField,
                        value: searchParam.searchValue
                    });
                }
            }
            /** @type {?} */
            const _uri = this.ins.beUri || uri;
            if (this.ins.http) {
                this.ins.http.context = this.ins.context;
            }
            if (this.ins._searchResult) {
                return of(this.ins._searchResult);
            }
            if (type !== 'allChildren') {
                return this.ins.http.getData(_uri, params);
            }
            else {
                /** @type {?} */
                const params1 = {
                    searchValue: JSON.stringify({ category: type }),
                    parentsIds: event.parentsIds,
                    customData: params.customData,
                    helpId: params.helpId
                };
                return this.ins.http.getData(_uri, params1);
            }
        }
        else {
            return of(false);
        }
    }
    // getFavoriteData(params) {
    //     return this.getData(params, 'fav');
    // }
    /**
     * @param {?} selIds
     * @return {?}
     */
    getSelecedItems(selIds) {
        return this.getData({ favoriteIds: selIds }, 'selected');
    }
    /**
     * @return {?}
     */
    getPersonalConfig() {
        /** @type {?} */
        const defaultConf = cloneDeep(DefaultUserConfig);
        // if (this.ins.customData) {
        //     const wrapKeyData = JSON.stringify({ key: this.ins.customData });
        //     const configKeyString = this.ins.getLookupBindingFields() + wrapKeyData;
        //     this.ins.personalConfigService.personalConfigKey = configKeyString;
        // }
        /** @type {?} */
        const key = this.ins.personalConfigService._newKey;
        /** @type {?} */
        let _conf = this.ins.personalConfigService.getPersonalData(key);
        if (!_conf || !Object.keys(_conf).length) {
            _conf = defaultConf;
        }
        /** @type {?} */
        const req = of(_conf);
        if (this.ins.favoriteDataFrom === 'locale' || this.ins.isTabChanged) {
            return req;
        }
        if (this.ins.http && this.ins.http['getUserSettings']) {
            return this.ins.http['getUserSettings'](key).pipe(map((/**
             * @param {?} ucs
             * @return {?}
             */
            (ucs) => {
                if (ucs) {
                    return ucs.textValue ? JSON.parse(ucs.textValue) : defaultConf;
                }
                return defaultConf;
            })));
        }
        else {
            return req;
        }
    }
    /**
     * @param {?=} event
     * @param {?=} type
     * @param {?=} isQuickSelect
     * @return {?}
     */
    lookupRequest(event, type = 'all', isQuickSelect = false) {
        if (!this.ins.usePersionalConf || isQuickSelect) {
            return this.getData(event, type);
        }
        /** @type {?} */
        const req = this.getPersonalConfig();
        return req.pipe(tap((/**
         * @param {?} c
         * @return {?}
         */
        (c) => {
            this.ins.personalConf = c;
            this.ins.personalConfigService.savePersonalConfig(c);
            if (!this.ins.isTabChanged) {
                this._originalPersonalConfig = cloneDeep(c);
            }
        })), switchMap((/**
         * @param {?} c
         * @return {?}
         */
        (c) => {
            const { tabIndex, favorite, size, cascadeStatus } = c;
            if (!this.ins.isTabChanged) {
                this.ins.activeTab = tabIndex || 'datalist';
            }
            if (size) {
                this.ins.dialogWidth = size.width;
                this.ins.dialogHeight = size.height;
                this.ins.dialog.reSize({ width: size.width, height: size.height });
            }
            if (cascadeStatus && this.ins.enableCascade) {
                this.ins.cascadeStatus = cascadeStatus;
            }
            if (this.ins.cascadeItems) {
                /** @type {?} */
                const keys = ['enable', 'up', 'down', 'disable'];
                keys.forEach((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    if (this.ins.cascadeItems[n] === undefined) {
                        this.ins.cascadeItems[n] = true;
                    }
                }));
                if (this.ins.cascadeItems[this.ins.cascadeStatus] === undefined) {
                    this.ins.cascadeStatus = (/** @type {?} */ (Object.keys(this.ins.cascadeItems)[0]));
                }
            }
            if (this.ins.activeTab === 'datalist') {
                return this.getData(event, type);
            }
            else if (this.ins.activeTab === 'favorite') {
                /** @type {?} */
                const favIds = favorite ? favorite[this.ins.localService.localeId] : [];
                if ((!favIds || !favIds.length) && !this.ins.isTabChanged) {
                    return this.getData(event, 'all').pipe(map((/**
                     * @param {?} r
                     * @return {?}
                     */
                    r => {
                        if (r && !r.items) {
                            r.items = [];
                        }
                        r.activeTab = 'datalist';
                        return r;
                    })));
                }
                // const _fids = favIds.filter(n => n);
                event.favoriteIds = favIds;
                event.search = null;
                return this.getData(event, 'fav').pipe(switchMap((/**
                 * @param {?} r
                 * @return {?}
                 */
                r => {
                    /** @type {?} */
                    const items = r ? r.items || [] : [];
                    // 加入数据权限后，没有返回数据且第1次打开窗口，非手动点击收藏标签时
                    if (!items.length && !this.ins.isTabChanged) {
                        return this.getData(event, 'all').pipe(map((/**
                         * @param {?} a
                         * @return {?}
                         */
                        a => {
                            if (a && !a.items) {
                                a.items = [];
                            }
                            a.activeTab = 'datalist';
                            return a;
                        })));
                    }
                    else {
                        return of(r);
                    }
                })));
            }
            else if (this.ins.activeTab === 'selected') {
                /** @type {?} */
                const selIds = this.ins.displayValue ? this.ins.displayValue.split(',') : [];
                /** @type {?} */
                const _sids = selIds.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n));
                return this.getSelecedItems(_sids);
            }
        })));
    }
    // 保存个性化数据
    /**
     * @param {?} action
     * @return {?}
     */
    submitFavoriteData(action) {
        // 如果数据与默认的数据一至则不保存。
        if (JSON.stringify(this.ins.personalConf) === JSON.stringify(this._originalPersonalConfig)) {
            return;
        }
        /** @type {?} */
        let msg = '';
        if (action === FavoriteAction.add) {
            msg = this.ins.addFavoriteSuccess;
        }
        else if (action === FavoriteAction.delete) {
            msg = this.ins.delFavoriteSuccess;
        }
        // 更新本地缓存
        localStorage.setItem(this.ins.personalConfigService._newKey, JSON.stringify(this.ins.personalConf));
        this.ins.personalConfigService.savePersonalConfig(this.ins.personalConf || {});
        if (this.ins.favoriteDataFrom !== 'locale') {
            this._originalPersonalConfig = cloneDeep(this.ins.personalConf);
            /** @type {?} */
            const configData = {
                configkey1: this.ins.personalConfigService.personalConfigKey,
                configkey2: '',
                configkey3: '',
                textvalue: JSON.stringify(this.ins.personalConf)
            };
            if (this.ins.http && this.ins.http['saveUserSettings']) {
                this.ins.savingFaoriteData = true;
                this.ins.showLoading();
                return this.ins.http['saveUserSettings'](configData).subscribe((/**
                 * @param {?} r
                 * @return {?}
                 */
                (r) => {
                    this.ins.savingFaoriteData = false;
                    this.ins.closeLoading();
                    if (msg) {
                        this.ins.notifyService.success(msg);
                    }
                }));
            }
            else {
                if (msg) {
                    this.ins.notifyService.success(msg);
                }
            }
        }
        else {
            if (msg) {
                this.ins.notifyService.success(msg);
            }
        }
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype._originalPersonalConfig;
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvaHR0cC1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFHQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxjQUFjLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5RSxPQUFPLEVBQWMsRUFBRSxFQUFZLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQzs7O01BRzdELGlCQUFpQixHQUFHO0lBQ3RCLFFBQVEsRUFBRSxVQUFVO0lBQ3BCLFFBQVEsRUFBRSxJQUFJO0lBQ2QsSUFBSSxFQUFFLElBQUk7Q0FDYjtBQUNELE1BQU0sT0FBTyxpQkFBaUI7Ozs7SUFLMUIsWUFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7OztRQUZwQyw0QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztJQUVKLENBQUM7Ozs7O0lBRXpDLGlCQUFpQjtRQUNyQixPQUFPO1lBQ0gsU0FBUyxFQUFFLENBQUM7WUFDWixRQUFRLEVBQUUsR0FBRztTQUNoQixDQUFDO0lBQ04sQ0FBQzs7Ozs7OztJQUdELGdCQUFnQixDQUFDLEtBQVcsRUFBRSxPQUF1QixLQUFLOztjQUNoRCxNQUFNLEdBQWlCLEVBQUU7UUFFL0IsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRTtZQUNwQixNQUFNLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ3BEOztjQUVLLFdBQVcsR0FBZ0IsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFO1FBRW5ELElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtZQUNoQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSxJQUFJLEtBQUssS0FBSyxFQUFFO2dCQUN6RSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxJQUFJLElBQUksS0FBSyxZQUFZLEVBQUU7b0JBQzVELE1BQU0sQ0FBQyxjQUFjLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUM7aUJBQ2xFO2FBQ0o7U0FDSjtRQUVELElBQUksS0FBSyxFQUFFO1lBQ1AsSUFBSSxJQUFJLEtBQUssS0FBSyxJQUFJLElBQUksS0FBSyxVQUFVLEVBQUU7Z0JBQ3ZDLEtBQUssQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7YUFDN0M7WUFFRCxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUU7Z0JBQ2hCLE1BQU0sQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUM7Z0JBQzVDLE1BQU0sQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUM7YUFDN0M7WUFFRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7O29CQUNWLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUs7Z0JBQy9CLElBQUksTUFBTSxJQUFJLE1BQU0sS0FBSyxHQUFHLEVBQUU7b0JBQzFCLE1BQU0sR0FBRyxHQUFHLENBQUM7aUJBQ2hCO2dCQUVELElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUU7b0JBQ3BCLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO2lCQUNsRDtnQkFFRCxXQUFXLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQztnQkFDakMsV0FBVyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQztnQkFDN0MsV0FBVyxDQUFDLFVBQVUsR0FBSSxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUM7Z0JBRXRELElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEtBQUssRUFBRSxJQUFLLFdBQVcsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO29CQUNqRSxXQUFXLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztpQkFDaEM7YUFDSjtZQUVELElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsV0FBVyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDO2FBQ3pDO1lBQ0QsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFO2dCQUNqQixXQUFXLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7YUFDM0M7U0FDSjtRQUVELElBQUksSUFBSSxLQUFLLEtBQUssSUFBSSxLQUFLLENBQUMsV0FBVyxFQUFFO1lBQ3JDLFdBQVcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztTQUMvQztRQUVELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsS0FBSyxxQkFBcUIsQ0FBQyxXQUFXLEVBQUU7WUFDakYsTUFBTSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQztTQUNuRDtRQUVELE1BQU0sQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUM7UUFDeEMsTUFBTSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQztRQUU5QyxZQUFZO1FBQ1osSUFBSSxJQUFJLEtBQUssWUFBWSxFQUFFO1lBQ3ZCLE1BQU0sQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1NBQ2pDO1FBRUQsSUFBSSxJQUFJLEtBQUssVUFBVSxFQUFFO1lBQ3JCLFdBQVcsQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxjQUFjLEdBQUcsS0FBSyxDQUFDO1lBQzlCLFdBQVcsQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztTQUMvQztRQUVELE1BQU0sQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqRCxNQUFNLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQztRQUVwRCxNQUFNLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO1FBRXhDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUU7WUFDakIsTUFBTSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztTQUNuQztRQUVELElBQUksS0FBSyxDQUFDLFlBQVksRUFBRTtZQUNwQixNQUFNLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUM7U0FDNUM7UUFFRCxJQUFJLEtBQUssQ0FBQyxlQUFlLEtBQUssU0FBUyxFQUFFO1lBQ3JDLE1BQU0sQ0FBQyxXQUFXLEdBQUcsS0FBSyxDQUFDLGVBQWUsQ0FBQztTQUM5QzthQUFNO1lBQ0gsSUFBSSxJQUFJLEtBQUssZ0JBQWdCLEVBQUU7Z0JBQzNCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFpQixDQUFDLEVBQUU7b0JBQzdELE1BQU0sQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2lCQUNwRDthQUNKO1NBQ0o7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDOzs7Ozs7SUFHRCxPQUFPLENBQUMsS0FBVyxFQUFFLE9BQXVCLEtBQUs7O2NBQ3ZDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHO1FBRXBDLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSyxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7WUFDL0csSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLFlBQVksS0FBSyxPQUFPLEVBQUU7Z0JBQzlGLElBQUksR0FBRyxnQkFBZ0IsQ0FBQzthQUMzQjtpQkFBTTtnQkFDSCxJQUFJLEdBQUcsTUFBTSxDQUFDO2FBQ2pCO1NBQ0o7O2NBRUssTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDO1FBRWpELElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFO1lBQ3ZCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFOztzQkFDekQsZUFBZSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUc7Ozs7Z0JBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFDLENBQUMsTUFBTTs7OztnQkFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQztnQkFDbkYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUU7b0JBQ25CLE1BQU0sQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDO2lCQUN6QjtnQkFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRTswQkFDckMsRUFBRSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksRUFBRSxFQUFFLFNBQVMsRUFBRSxxQkFBUSxNQUFNLENBQUU7b0JBQ3ZFLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxDQUFDO2lCQUN6RDtxQkFBTTtvQkFDSCxNQUFNLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsQ0FBQztpQkFDNUQ7O3NCQUNLLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUM7Z0JBQ2xELElBQUksV0FBVyxDQUFDLFdBQVcsRUFBRTtvQkFDekIsTUFBTSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxlQUFlLEVBQUU7d0JBQ3RGLEtBQUssRUFBRSxXQUFXLENBQUMsV0FBVzt3QkFDOUIsS0FBSyxFQUFFLFdBQVcsQ0FBQyxXQUFXO3FCQUNqQyxDQUFDLENBQUM7aUJBQ047YUFDSjs7a0JBRUssSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLEdBQUc7WUFFbEMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRTtnQkFDZixJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUM7YUFDNUM7WUFDRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFO2dCQUN4QixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2FBQ3JDO1lBRUQsSUFBSSxJQUFJLEtBQUssYUFBYSxFQUFFO2dCQUN4QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLENBQUM7YUFDOUM7aUJBQU07O3NCQUNHLE9BQU8sR0FBRztvQkFDWixXQUFXLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQztvQkFDL0MsVUFBVSxFQUFFLEtBQUssQ0FBQyxVQUFVO29CQUM1QixVQUFVLEVBQUUsTUFBTSxDQUFDLFVBQVU7b0JBQzdCLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTTtpQkFDeEI7Z0JBQ0QsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2FBQy9DO1NBQ0o7YUFBTTtZQUNILE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3BCO0lBQ0wsQ0FBQzs7Ozs7Ozs7SUFNRCxlQUFlLENBQUMsTUFBYTtRQUN6QixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDN0QsQ0FBQzs7OztJQUVELGlCQUFpQjs7Y0FDUCxXQUFXLEdBQUcsU0FBUyxDQUFDLGlCQUFpQixDQUFDOzs7Ozs7O2NBTzFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLE9BQU87O1lBRTlDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUM7UUFFL0QsSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxFQUFFO1lBQ3RDLEtBQUssR0FBRyxXQUFXLENBQUM7U0FDdkI7O2NBQ0ssR0FBRyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUM7UUFFckIsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtZQUNqRSxPQUFPLEdBQUcsQ0FBQztTQUNkO1FBRUQsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFO1lBQ25ELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQzdDLEdBQUc7Ozs7WUFBQyxDQUFDLEdBQVEsRUFBRSxFQUFFO2dCQUNiLElBQUksR0FBRyxFQUFFO29CQUNMLE9BQU8sR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztpQkFDbEU7Z0JBQ0QsT0FBTyxXQUFXLENBQUM7WUFDdkIsQ0FBQyxFQUFDLENBQ0wsQ0FBQztTQUNMO2FBQU07WUFDSCxPQUFPLEdBQUcsQ0FBQztTQUNkO0lBQ0wsQ0FBQzs7Ozs7OztJQUVELGFBQWEsQ0FBQyxLQUFXLEVBQUUsT0FBdUIsS0FBSyxFQUFFLGFBQWEsR0FBRyxLQUFLO1FBQzFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGdCQUFnQixJQUFJLGFBQWEsRUFBRTtZQUM3QyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3BDOztjQUVLLEdBQUcsR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7UUFFcEMsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUNYLEdBQUc7Ozs7UUFBQyxDQUFDLENBQU0sRUFBRSxFQUFFO1lBQ1gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckQsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFO2dCQUN4QixJQUFJLENBQUMsdUJBQXVCLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQy9DO1FBQ0wsQ0FBQyxFQUFDLEVBQ0YsU0FBUzs7OztRQUFDLENBQUMsQ0FBTSxFQUFFLEVBQUU7a0JBQ1gsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsR0FBRyxDQUFDO1lBRXJELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtnQkFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsUUFBUSxJQUFJLFVBQVUsQ0FBQzthQUMvQztZQUVELElBQUksSUFBSSxFQUFFO2dCQUNOLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7Z0JBQ2xDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ3BDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQzthQUN0RTtZQUVELElBQUksYUFBYSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFO2dCQUN6QyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7YUFDMUM7WUFFRCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFOztzQkFDakIsSUFBSSxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDO2dCQUNoRCxJQUFJLENBQUMsT0FBTzs7OztnQkFBQyxDQUFDLENBQUMsRUFBRTtvQkFDYixJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsRUFBRTt3QkFDeEMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDO3FCQUNuQztnQkFDTCxDQUFDLEVBQUMsQ0FBQztnQkFFSCxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEtBQUssU0FBUyxFQUFHO29CQUM5RCxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsR0FBRyxtQkFBQSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQU8sQ0FBQztpQkFDekU7YUFDSjtZQUVELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEtBQUssVUFBVSxFQUFFO2dCQUNuQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ3BDO2lCQUFNLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEtBQUssVUFBVSxFQUFFOztzQkFDcEMsTUFBTSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUN2RSxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRTtvQkFDdkQsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQ2xDLEdBQUc7Ozs7b0JBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ0osSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxFQUFFOzRCQUNmLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO3lCQUNoQjt3QkFDRCxDQUFDLENBQUMsU0FBUyxHQUFHLFVBQVUsQ0FBQzt3QkFDekIsT0FBTyxDQUFDLENBQUM7b0JBQ2IsQ0FBQyxFQUFDLENBQ0wsQ0FBQztpQkFDTDtnQkFFRCx1Q0FBdUM7Z0JBQ3ZDLEtBQUssQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDO2dCQUMzQixLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztnQkFDcEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQ2xDLFNBQVM7Ozs7Z0JBQUMsQ0FBQyxDQUFDLEVBQUU7OzBCQUNKLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNwQyxvQ0FBb0M7b0JBQ3BDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLEVBQUU7d0JBQ3pDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUNsQyxHQUFHOzs7O3dCQUFDLENBQUMsQ0FBQyxFQUFFOzRCQUNKLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRTtnQ0FDZixDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQzs2QkFDaEI7NEJBRUQsQ0FBQyxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUM7NEJBQ3pCLE9BQU8sQ0FBQyxDQUFDO3dCQUNiLENBQUMsRUFBQyxDQUNMLENBQUM7cUJBQ0w7eUJBQU07d0JBQ0gsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7cUJBQ2hCO2dCQUNMLENBQUMsRUFBQyxDQUNMLENBQUM7YUFDTDtpQkFBTSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxLQUFLLFVBQVUsRUFBRTs7c0JBQ3BDLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFOztzQkFDdEUsS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFDO2dCQUNuQyxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDdEM7UUFDTCxDQUFDLEVBQUMsQ0FDTCxDQUFDO0lBQ04sQ0FBQzs7Ozs7O0lBR0Qsa0JBQWtCLENBQUMsTUFBNEI7UUFDM0Msb0JBQW9CO1FBQ3BCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLEVBQUU7WUFDeEYsT0FBTztTQUNWOztZQUVHLEdBQUcsR0FBRyxFQUFFO1FBQ1osSUFBSSxNQUFNLEtBQUssY0FBYyxDQUFDLEdBQUcsRUFBRTtZQUMvQixHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQztTQUNyQzthQUFNLElBQUksTUFBTSxLQUFLLGNBQWMsQ0FBQyxNQUFNLEVBQUU7WUFDekMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUM7U0FDckM7UUFDRCxTQUFTO1FBQ1QsWUFBWSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNwRyxJQUFJLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRS9FLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsS0FBSyxRQUFRLEVBQUU7WUFDeEMsSUFBSSxDQUFDLHVCQUF1QixHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDOztrQkFFMUQsVUFBVSxHQUFxQjtnQkFDakMsVUFBVSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsaUJBQWlCO2dCQUM1RCxVQUFVLEVBQUUsRUFBRTtnQkFDZCxVQUFVLEVBQUUsRUFBRTtnQkFDZCxTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQzthQUNuRDtZQUVELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsRUFBRTtnQkFDcEQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7Z0JBQ2xDLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7Z0JBQ3ZCLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxTQUFTOzs7O2dCQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7b0JBQ2pFLElBQUksQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcsS0FBSyxDQUFDO29CQUNuQyxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO29CQUN4QixJQUFJLEdBQUcsRUFBRTt3QkFDTCxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7cUJBQ3ZDO2dCQUNMLENBQUMsRUFBQyxDQUFDO2FBQ047aUJBQU07Z0JBQ0gsSUFBSSxHQUFHLEVBQUU7b0JBQ0wsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUN2QzthQUNKO1NBQ0o7YUFBTTtZQUNILElBQUksR0FBRyxFQUFFO2dCQUNMLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN2QztTQUNKO0lBQ0wsQ0FBQztDQUVKOzs7Ozs7SUF4V0csb0RBQW9EOzs7OztJQUV4QyxnQ0FBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZW1vdGVQYXJhbXMsIFNlYXJjaFBhcmFtLCBVc2VyRmF2b3JpdGVEYXRhIH0gZnJvbSAnLi4vaHR0cC9SZW1vdGVQYXJhbXMnO1xyXG5pbXBvcnQgeyBMT0FEX0RBVEFfVFlQRSB9IGZyb20gJy4uL2xvb2t1cC1ncmlkLW9wdGlvbnMnO1xyXG5pbXBvcnQgeyBMb29rdXBHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi4vbG9va3VwLWdyaWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuaW1wb3J0IHsgRmF2b3JpdGVBY3Rpb24sIExvb2t1cEdyaWREaXNwbGF5VHlwZSB9IGZyb20gJy4uL2xvb2t1cC1kaXNwbGF5dHlwZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBmb3JrSm9pbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAsIHN3aXRjaE1hcCwgdGFwLCBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG4vLyDluK7liqnpu5jorqTkuKrmgKfljJbmlbDmja5cclxuY29uc3QgRGVmYXVsdFVzZXJDb25maWcgPSB7XHJcbiAgICB0YWJJbmRleDogJ2RhdGFsaXN0JyxcclxuICAgIGZhdm9yaXRlOiBudWxsLFxyXG4gICAgc2l6ZTogbnVsbFxyXG59O1xyXG5leHBvcnQgY2xhc3MgTG9va3VwSHR0cE1hbmFnZXIge1xyXG4gICAgLy8g5q+P5qyh5biu5Yqp5omT5byA5ZCO77yM5pu05paw5q2k5YC877yM5YGa5Li65Liq5oCn5YyW5pWw5o2u55qE5Yid5aeL5YC877ybXHJcbiAgICAvLyDlhbPpl63nqpflj6Pml7bvvIzkuI7mraTov5vooYzlr7nmr5TjgILlpoLmnpzkuIDmoLfvvIzliJnkuI3kv53lrZjvvJtcclxuICAgIHByaXZhdGUgX29yaWdpbmFsUGVyc29uYWxDb25maWcgPSBEZWZhdWx0VXNlckNvbmZpZztcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluczogTG9va3VwR3JpZENvbXBvbmVudCkgeyB9XHJcblxyXG4gICAgcHJpdmF0ZSBkaXNhYmxlUGFnaW5hdGlvbigpIHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBwYWdlSW5kZXg6IDEsXHJcbiAgICAgICAgICAgIHBhZ2VTaXplOiA1MDBcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIC8qKiDmnoTpgKDmn6Xor6Llj4LmlbAgKi9cclxuICAgIGJ1aWxkUXVlcnlQYXJhbXMoZXZlbnQ/OiBhbnksIHR5cGU6IExPQURfREFUQV9UWVBFID0gJ2FsbCcpIHtcclxuICAgICAgICBjb25zdCBwYXJhbXM6IFJlbW90ZVBhcmFtcyA9IHt9O1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuY29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24gPSBjbG9uZURlZXAodGhpcy5pbnMuY29uZGl0aW9uKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHNlYXJjaFBhcmFtOiBTZWFyY2hQYXJhbSA9IHsgY2F0ZWdvcnk6IHR5cGUgfTtcclxuXHJcbiAgICAgICAgaWYgKHR5cGUgIT09ICdmYXYnKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5pc0RvdWJsbGVMaXN0KCkgJiYgdGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlciAmJiB0eXBlICE9PSAnYWxsJykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIuaWRWYWx1ZSAmJiB0eXBlICE9PSAndGV4dGNoYW5nZScpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbXMucmVsYXRpb25GaWx0ZXIgPSBbLi4udGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlci5pZFZhbHVlXTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50KSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlID09PSAnZmF2JyB8fCB0eXBlID09PSAnc2VsZWN0ZWQnKSB7XHJcbiAgICAgICAgICAgICAgICBldmVudC5wYWdlSW5mbyA9IHRoaXMuZGlzYWJsZVBhZ2luYXRpb24oKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LnBhZ2VJbmZvKSB7XHJcbiAgICAgICAgICAgICAgICBwYXJhbXMucGFnZUluZGV4ID0gZXZlbnQucGFnZUluZm8ucGFnZUluZGV4O1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zLnBhZ2VTaXplID0gZXZlbnQucGFnZUluZm8ucGFnZVNpemU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChldmVudC5zZWFyY2gpIHtcclxuICAgICAgICAgICAgICAgIGxldCBzZmllbGQgPSBldmVudC5zZWFyY2guZmllbGQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2ZpZWxkICYmIHNmaWVsZCA9PT0gJyonKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2ZpZWxkID0gJyonO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChldmVudC5zZWFyY2gudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5zZWFyY2gudmFsdWUgPSBldmVudC5zZWFyY2gudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtLnNlYXJjaEZpZWxkID0gc2ZpZWxkO1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoUGFyYW0uc2VhcmNoVmFsdWUgPSBldmVudC5zZWFyY2gudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zZWFyY2hUeXBlID0gIGV2ZW50LnNlYXJjaC50eXBlIHx8ICdsaWtlJztcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuc2VhcmNoLnZhbHVlID09PSAnJyAmJiAgc2VhcmNoUGFyYW0uY2F0ZWdvcnkgPT09ICdzZWFyY2gnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoUGFyYW0uY2F0ZWdvcnkgPSAnYWxsJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LnNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zb3J0TmFtZSA9IGV2ZW50LnNvcnROYW1lO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChldmVudC5zb3J0T3JkZXIpIHtcclxuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtLnNvcnRPcmRlciA9IGV2ZW50LnNvcnRPcmRlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGUgPT09ICdmYXYnICYmIGV2ZW50LmZhdm9yaXRlSWRzKSB7XHJcbiAgICAgICAgICAgIHNlYXJjaFBhcmFtLmZhdm9yaXRlSWRzID0gZXZlbnQuZmF2b3JpdGVJZHM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkgfHwgdGhpcy5pbnMuZGlzcGxheVR5cGUgPT09IExvb2t1cEdyaWREaXNwbGF5VHlwZS5OYXZUcmVlTGlzdCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSB0aGlzLmlucy5lbmFibGVGdWxsVHJlZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBhcmFtcy50cmVlVG9MaXN0ID0gdGhpcy5pbnMudHJlZVRvTGlzdDtcclxuICAgICAgICBwYXJhbXMubmF2VHJlZVRvTGlzdCA9IHRoaXMuaW5zLm5hdlRyZWVUb0xpc3Q7XHJcblxyXG4gICAgICAgIC8vIOafpeivouaXtuS4jeaehOmAoOWujOaVtOagkVxyXG4gICAgICAgIGlmICh0eXBlID09PSAndGV4dGNoYW5nZScpIHtcclxuICAgICAgICAgICAgcGFyYW1zLmVuYWJsZUZ1bGxUcmVlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZSA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICBzZWFyY2hQYXJhbS5jYXRlZ29yeSA9ICdmYXYnO1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgc2VhcmNoUGFyYW0uZmF2b3JpdGVJZHMgPSBldmVudC5mYXZvcml0ZUlkcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBhcmFtcy5zZWFyY2hWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNlYXJjaFBhcmFtKTtcclxuICAgICAgICBwYXJhbXMubG9hZFRyZWVEYXRhVHlwZSA9IHRoaXMuaW5zLmxvYWRUcmVlRGF0YVR5cGU7XHJcblxyXG4gICAgICAgIHBhcmFtcy5jdXN0b21EYXRhID0gdGhpcy5pbnMuY3VzdG9tRGF0YTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmhlbHBJZCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuaGVscElkID0gdGhpcy5pbnMuaGVscElkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LnNlbGVjdGVkSW5mbykge1xyXG4gICAgICAgICAgICBwYXJhbXMuc2VsZWN0ZWRJbmZvID0gZXZlbnQuc2VsZWN0ZWRJbmZvO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50Lm5hdk5vZGVQYXRoQ29kZSAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHBhcmFtcy5uYXZQYXRoQ29kZSA9IGV2ZW50Lm5hdk5vZGVQYXRoQ29kZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodHlwZSA9PT0gJ25hdkFsbENoaWxkcmVuJykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmluY2x1ZGVTdWJvcmRpbmF0ZXMgJiYgdGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLm5hdlBhdGhDb2RlID0gdGhpcy5pbnNbJ25hdk5vZGVQYXRoQ29kZSddO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcGFyYW1zO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBnZXREYXRhKGV2ZW50PzogYW55LCB0eXBlOiBMT0FEX0RBVEFfVFlQRSA9ICdhbGwnKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICBjb25zdCB1cmkgPSB0aGlzLmlucy5ncmlkT3B0aW9ucy51cmk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5pc0RvdWJsbGVMaXN0KCkgJiYgIHRoaXMuaW5zLm5hdmlnYXRpb25GaWx0ZXIgJiYgdGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlci5pZFZhbHVlICYmIHR5cGUgIT09ICdmYXYnKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5pbmNsdWRlU3Vib3JkaW5hdGVzICYmIHRoaXMuaW5zLm5hdmlnYXRpb25PcHRpb25zLnRyZWVJbmZvLmxvYWREYXRhVHlwZSA9PT0gJ2FzeW5jJykge1xyXG4gICAgICAgICAgICAgICAgdHlwZSA9ICduYXZBbGxDaGlsZHJlbic7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0eXBlID0gJ2xpc3QnO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmJ1aWxkUXVlcnlQYXJhbXMoZXZlbnQsIHR5cGUpO1xyXG5cclxuICAgICAgICBpZiAodXJpIHx8IHRoaXMuaW5zLmJlVXJpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5iZVVyaSAmJiB0aGlzLmlucy5jb2x1bW5zICYmIHRoaXMuaW5zLmNvbHVtbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBhbGxTZWFyY2hGaWVsZHMgPSB0aGlzLmlucy5jb2x1bW5zLm1hcChjb2wgPT4gY29sLnNlYXJjaEZpZWxkKS5maWx0ZXIoZiA9PiBmKTtcclxuICAgICAgICAgICAgICAgIGlmICghcGFyYW1zLmNvbmRpdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24gPSB7fTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaW5zLmlzVHJlZSgpICYmIHRoaXMuaW5zLnBhZ2luYXRpb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHBhZ2VTaXplID0gdGhpcy5pbnMucGFnZVNpemUgfHwgMjAsIHBhZ2VJbmRleCB9ID0geyAuLi5wYXJhbXMgfTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbXMuY29uZGl0aW9uLnBhZ2luYXRpb24gPSB7IHBhZ2VTaXplLCBwYWdlSW5kZXggfTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmNvbmRpdGlvbi5wYWdpbmF0aW9uID0geyBpc1VzZVBhZ2luYXRpb246IGZhbHNlIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZWFyY2hQYXJhbSA9IEpTT04ucGFyc2UocGFyYW1zLnNlYXJjaFZhbHVlKTtcclxuICAgICAgICAgICAgICAgIGlmIChzZWFyY2hQYXJhbS5zZWFyY2hWYWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24gPSB0aGlzLmlucy5sb29rdXBVdGlscy5tZXJnZUNvbmRpdGlvbihwYXJhbXMuY29uZGl0aW9uLCBhbGxTZWFyY2hGaWVsZHMsIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmllbGQ6IHNlYXJjaFBhcmFtLnNlYXJjaEZpZWxkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc2VhcmNoUGFyYW0uc2VhcmNoVmFsdWVcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgX3VyaSA9IHRoaXMuaW5zLmJlVXJpIHx8IHVyaTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5odHRwKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5odHRwLmNvbnRleHQgPSB0aGlzLmlucy5jb250ZXh0O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5fc2VhcmNoUmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gb2YodGhpcy5pbnMuX3NlYXJjaFJlc3VsdCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh0eXBlICE9PSAnYWxsQ2hpbGRyZW4nKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cC5nZXREYXRhKF91cmksIHBhcmFtcyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJhbXMxID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlYXJjaFZhbHVlOiBKU09OLnN0cmluZ2lmeSh7IGNhdGVnb3J5OiB0eXBlIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudHNJZHM6IGV2ZW50LnBhcmVudHNJZHMsXHJcbiAgICAgICAgICAgICAgICAgICAgY3VzdG9tRGF0YTogcGFyYW1zLmN1c3RvbURhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgaGVscElkOiBwYXJhbXMuaGVscElkXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmh0dHAuZ2V0RGF0YShfdXJpLCBwYXJhbXMxKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGdldEZhdm9yaXRlRGF0YShwYXJhbXMpIHtcclxuICAgIC8vICAgICByZXR1cm4gdGhpcy5nZXREYXRhKHBhcmFtcywgJ2ZhdicpO1xyXG4gICAgLy8gfVxyXG5cclxuICAgIGdldFNlbGVjZWRJdGVtcyhzZWxJZHM6IGFueVtdKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YSh7IGZhdm9yaXRlSWRzOiBzZWxJZHMgfSwgJ3NlbGVjdGVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGVyc29uYWxDb25maWcoKSB7XHJcbiAgICAgICAgY29uc3QgZGVmYXVsdENvbmYgPSBjbG9uZURlZXAoRGVmYXVsdFVzZXJDb25maWcpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIGlmICh0aGlzLmlucy5jdXN0b21EYXRhKSB7XHJcbiAgICAgICAgLy8gICAgIGNvbnN0IHdyYXBLZXlEYXRhID0gSlNPTi5zdHJpbmdpZnkoeyBrZXk6IHRoaXMuaW5zLmN1c3RvbURhdGEgfSk7XHJcbiAgICAgICAgLy8gICAgIGNvbnN0IGNvbmZpZ0tleVN0cmluZyA9IHRoaXMuaW5zLmdldExvb2t1cEJpbmRpbmdGaWVsZHMoKSArIHdyYXBLZXlEYXRhO1xyXG4gICAgICAgIC8vICAgICB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2UucGVyc29uYWxDb25maWdLZXkgPSBjb25maWdLZXlTdHJpbmc7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIGNvbnN0IGtleSA9IHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5fbmV3S2V5O1xyXG5cclxuICAgICAgICBsZXQgX2NvbmYgPSB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2UuZ2V0UGVyc29uYWxEYXRhKGtleSk7XHJcblxyXG4gICAgICAgIGlmICghX2NvbmYgfHwgIU9iamVjdC5rZXlzKF9jb25mKS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgX2NvbmYgPSBkZWZhdWx0Q29uZjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcmVxID0gb2YoX2NvbmYpO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuZmF2b3JpdGVEYXRhRnJvbSA9PT0gJ2xvY2FsZScgfHwgdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaHR0cCAmJiB0aGlzLmlucy5odHRwWydnZXRVc2VyU2V0dGluZ3MnXSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cFsnZ2V0VXNlclNldHRpbmdzJ10oa2V5KS5waXBlKFxyXG4gICAgICAgICAgICAgICAgbWFwKCh1Y3M6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh1Y3MpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVjcy50ZXh0VmFsdWUgPyBKU09OLnBhcnNlKHVjcy50ZXh0VmFsdWUpIDogZGVmYXVsdENvbmY7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0Q29uZjtcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlcTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbG9va3VwUmVxdWVzdChldmVudD86IGFueSwgdHlwZTogTE9BRF9EQVRBX1RZUEUgPSAnYWxsJywgaXNRdWlja1NlbGVjdCA9IGZhbHNlKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLmlucy51c2VQZXJzaW9uYWxDb25mIHx8IGlzUXVpY2tTZWxlY3QpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YShldmVudCwgdHlwZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmdldFBlcnNvbmFsQ29uZmlnKCk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXEucGlwZShcclxuICAgICAgICAgICAgdGFwKChjOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnBlcnNvbmFsQ29uZiA9IGM7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2Uuc2F2ZVBlcnNvbmFsQ29uZmlnKGMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlucy5pc1RhYkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9vcmlnaW5hbFBlcnNvbmFsQ29uZmlnID0gY2xvbmVEZWVwKGMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgc3dpdGNoTWFwKChjOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgdGFiSW5kZXgsIGZhdm9yaXRlLCBzaXplLCBjYXNjYWRlU3RhdHVzIH0gPSBjO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuYWN0aXZlVGFiID0gdGFiSW5kZXggfHwgJ2RhdGFsaXN0JztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoc2l6ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ1dpZHRoID0gc2l6ZS53aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dIZWlnaHQgPSBzaXplLmhlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2cucmVTaXplKHsgd2lkdGg6IHNpemUud2lkdGgsIGhlaWdodDogc2l6ZS5oZWlnaHQgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKGNhc2NhZGVTdGF0dXMgJiYgdGhpcy5pbnMuZW5hYmxlQ2FzY2FkZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNhc2NhZGVTdGF0dXMgPSBjYXNjYWRlU3RhdHVzO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5jYXNjYWRlSXRlbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gWydlbmFibGUnLCAndXAnLCAnZG93bicsICdkaXNhYmxlJ107XHJcbiAgICAgICAgICAgICAgICAgICAga2V5cy5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMuY2FzY2FkZUl0ZW1zW25dID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNhc2NhZGVJdGVtc1tuXSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmNhc2NhZGVJdGVtc1t0aGlzLmlucy5jYXNjYWRlU3RhdHVzXSA9PT0gdW5kZWZpbmVkICkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5jYXNjYWRlU3RhdHVzID0gT2JqZWN0LmtleXModGhpcy5pbnMuY2FzY2FkZUl0ZW1zKVswXSBhcyBhbnk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdkYXRhbGlzdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhKGV2ZW50LCB0eXBlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnMuYWN0aXZlVGFiID09PSAnZmF2b3JpdGUnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmF2SWRzID0gZmF2b3JpdGUgPyBmYXZvcml0ZVt0aGlzLmlucy5sb2NhbFNlcnZpY2UubG9jYWxlSWRdIDogW107XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCghZmF2SWRzIHx8ICFmYXZJZHMubGVuZ3RoKSAmJiAhdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsICdhbGwnKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKHIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyICYmICFyLml0ZW1zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIuaXRlbXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgci5hY3RpdmVUYWIgPSAnZGF0YWxpc3QnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IF9maWRzID0gZmF2SWRzLmZpbHRlcihuID0+IG4pO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LmZhdm9yaXRlSWRzID0gZmF2SWRzO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnNlYXJjaCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YShldmVudCwgJ2ZhdicpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcChyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1zID0gciA/IHIuaXRlbXMgfHwgW10gOiBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIOWKoOWFpeaVsOaNruadg+mZkOWQju+8jOayoeaciei/lOWbnuaVsOaNruS4lOesrDHmrKHmiZPlvIDnqpflj6PvvIzpnZ7miYvliqjngrnlh7vmlLbol4/moIfnrb7ml7ZcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXRlbXMubGVuZ3RoICYmICF0aGlzLmlucy5pc1RhYkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhKGV2ZW50LCAnYWxsJykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKGEgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGEgJiYgIWEuaXRlbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLml0ZW1zID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhLmFjdGl2ZVRhYiA9ICdkYXRhbGlzdCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2Yocik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnMuYWN0aXZlVGFiID09PSAnc2VsZWN0ZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VsSWRzID0gdGhpcy5pbnMuZGlzcGxheVZhbHVlID8gdGhpcy5pbnMuZGlzcGxheVZhbHVlLnNwbGl0KCcsJykgOiBbXTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBfc2lkcyA9IHNlbElkcy5maWx0ZXIobiA9PiBuKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRTZWxlY2VkSXRlbXMoX3NpZHMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8g5L+d5a2Y5Liq5oCn5YyW5pWw5o2uXHJcbiAgICBzdWJtaXRGYXZvcml0ZURhdGEoYWN0aW9uOiBhbnkgfCBGYXZvcml0ZUFjdGlvbikge1xyXG4gICAgICAgIC8vIOWmguaenOaVsOaNruS4jum7mOiupOeahOaVsOaNruS4gOiHs+WImeS4jeS/neWtmOOAglxyXG4gICAgICAgIGlmIChKU09OLnN0cmluZ2lmeSh0aGlzLmlucy5wZXJzb25hbENvbmYpID09PSBKU09OLnN0cmluZ2lmeSh0aGlzLl9vcmlnaW5hbFBlcnNvbmFsQ29uZmlnKSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgbXNnID0gJyc7XHJcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gRmF2b3JpdGVBY3Rpb24uYWRkKSB7XHJcbiAgICAgICAgICAgIG1zZyA9IHRoaXMuaW5zLmFkZEZhdm9yaXRlU3VjY2VzcztcclxuICAgICAgICB9IGVsc2UgaWYgKGFjdGlvbiA9PT0gRmF2b3JpdGVBY3Rpb24uZGVsZXRlKSB7XHJcbiAgICAgICAgICAgIG1zZyA9IHRoaXMuaW5zLmRlbEZhdm9yaXRlU3VjY2VzcztcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5pu05paw5pys5Zyw57yT5a2YXHJcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLl9uZXdLZXksIEpTT04uc3RyaW5naWZ5KHRoaXMuaW5zLnBlcnNvbmFsQ29uZikpO1xyXG4gICAgICAgIHRoaXMuaW5zLnBlcnNvbmFsQ29uZmlnU2VydmljZS5zYXZlUGVyc29uYWxDb25maWcodGhpcy5pbnMucGVyc29uYWxDb25mIHx8IHt9KTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmZhdm9yaXRlRGF0YUZyb20gIT09ICdsb2NhbGUnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX29yaWdpbmFsUGVyc29uYWxDb25maWcgPSBjbG9uZURlZXAodGhpcy5pbnMucGVyc29uYWxDb25mKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGNvbmZpZ0RhdGE6IFVzZXJGYXZvcml0ZURhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICBjb25maWdrZXkxOiB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2UucGVyc29uYWxDb25maWdLZXksXHJcbiAgICAgICAgICAgICAgICBjb25maWdrZXkyOiAnJyxcclxuICAgICAgICAgICAgICAgIGNvbmZpZ2tleTM6ICcnLFxyXG4gICAgICAgICAgICAgICAgdGV4dHZhbHVlOiBKU09OLnN0cmluZ2lmeSh0aGlzLmlucy5wZXJzb25hbENvbmYpXHJcbiAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuaHR0cCAmJiB0aGlzLmlucy5odHRwWydzYXZlVXNlclNldHRpbmdzJ10pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNhdmluZ0Zhb3JpdGVEYXRhID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNob3dMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cFsnc2F2ZVVzZXJTZXR0aW5ncyddKGNvbmZpZ0RhdGEpLnN1YnNjcmliZSgocikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLnNhdmluZ0Zhb3JpdGVEYXRhID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuY2xvc2VMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1zZykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5ub3RpZnlTZXJ2aWNlLnN1Y2Nlc3MobXNnKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChtc2cpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5ub3RpZnlTZXJ2aWNlLnN1Y2Nlc3MobXNnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChtc2cpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLm5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyhtc2cpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=