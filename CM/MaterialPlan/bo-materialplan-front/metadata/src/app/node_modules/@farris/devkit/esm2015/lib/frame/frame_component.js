/*
 * @Author: Witt
 * @Date: 2019-03-12 14:59:22
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-06-15 17:26:07
 */
import { Injector, Injectable, ChangeDetectorRef } from '@angular/core';
import { FrameContext } from './frame_context';
import { Subscription, Declaration } from '../event-mechanism/index';
import { FRAME_COMPONENT_INIT_HANDLER_TOKEN } from './tokens';
import { Subject } from 'rxjs';
class FrameComponent {
    /**
     * 框架构造函数
     * @param injector 注入器
     */
    constructor(injector) {
        this.injector = injector;
        this.initialized = false;
        this.context = this.injector.get(FrameContext, null);
        if (this.context) {
            this.initialize();
        }
        this.destorySignal = new Subject();
        // this.context.init(this);
        // this.viewModel = this.context.viewModel;
        // this.cd = this.getChangeDetectorRef();
        // // 必须先执行context的初始化，然后再初始化Subscription
        // this.initPublicEvent();
        // this.initSubscription();
        // this.restComponent();
    }
    /**
     * 是否为表格组件
     * @description 返回true/false时可以信任，但如果返回的是undefined则不应信任
     * @warning 该属性依赖了生成代码，如果非标准的生成型工程也会导致判断失败。
     */
    get isGridComponent() {
        if (this.context && this.context.viewModel) {
            const dataGridColumnsName = this.context.viewModel['dataGridColumnsName'] || null;
            return dataGridColumnsName ? true : false;
        }
        return undefined;
    }
    dispose(options) {
        if (this.eventPipes) {
            this.eventPipes.forEach((eventPipe) => {
                eventPipe.disposeByCaller(this);
            });
        }
        this.cd = null;
        // this.viewModel = null;
        this.context.dispose();
        if (this.destorySignal) {
            this.destorySignal.next();
            this.destorySignal.complete();
        }
    }
    ngOnInit() {
        this.initialize();
    }
    initialize() {
        if (!this.initialized) {
            this.context.init(this);
            this.viewModel = this.context.viewModel;
            this.cd = this.getChangeDetectorRef();
            // 必须先执行context的初始化，然后再初始化Subscription
            this.initPublicEvent();
            this.initSubscription();
            this.restComponent();
            this.onFrameComponentInit();
            this.initialized = true;
        }
    }
    /**
     * 执行组件初始化
     */
    onFrameComponentInit() {
        const frameComponentInitHandlers = this.injector.get(FRAME_COMPONENT_INIT_HANDLER_TOKEN, null);
        if (frameComponentInitHandlers && Array.isArray(frameComponentInitHandlers) && frameComponentInitHandlers.length > 0) {
            frameComponentInitHandlers.forEach((handler) => {
                handler.onComponentInit(this.context);
            });
        }
    }
    /**
     * 获取变更检测器实例
     * @todo：应该通过注入获取，但注入会引起表单编译。
     */
    getChangeDetectorRef() {
        // const cd = this.get<ChangeDetectorRef>(ChangeDetectorRef, null, InjectFlags.Optional);
        const cd = this.injector.get(ChangeDetectorRef, null);
        return cd;
    }
    /**
     * 将当前组件脱离变更检测树
     */
    detach() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detach();
    }
    /**
     * 将当前组件重新加入变更检测树
     */
    reattach() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.reattach();
    }
    /**
     * 对当前组件进行一次变更检查
     */
    detectChanges() {
        if (this.isCdValid() === false) {
            return;
        }
        this.cd.detectChanges();
    }
    /**
     * 检测ChangeDetection是否有效
     * @todo: Can't be depend on the destroyed property, destroyed.
     */
    isCdValid() {
        return this.cd && this.cd['destroyed'] === false || false;
    }
    /**
     * 重置组件状态
     * @todo：AppContext是全局的，
     */
    restComponent() {
        if (this.context !== this.context.root) {
            return;
        }
        // 1、如果AppContext不是root并且父AppContext也不是root不清理;
        // 2、表单Module里注入了FARRIS_DEVKIT_APP_PROVIDERS里面有一个冗余的AppContext注入
        //    导致所有AppContext的根是该冗余的AppContext，所以要检测parent.parent。
        // 只清理根组件的session
        if (this.context.appContext.parent !== null && this.context.appContext.parent.parent !== null) {
            return;
        }
        // Repository被注册到全局了，模块依赖注入中的对象，没有重置时机，临时在根组件中进行注销。
        // @todo：应该清理全部repository，目前缺少全局管理所有Repository的地方。
        this.context.repository.reset();
        // 重置组件绑定数据
        this.context.bindingData.reset();
    }
    ngOnDestroy() {
        this.dispose();
    }
    /**
     * 初始化事件订阅
     */
    initSubscription() {
        this.subscription = this.getSubscription();
        if (!this.subscription) {
            return;
        }
        this.eventPipes = this.subscription.init(this);
    }
    /**
     * 获取component对应的订阅
     * @returns
     */
    getSubscription() {
        return this.injector.get(Subscription, null);
    }
    initPublicEvent() {
        this.declaration = this.getDeclaration();
        if (!this.declaration) {
            return;
        }
        this.declaration.init(this);
    }
    /**
     * 获取当前component对应的declaration
     * @returns
     */
    getDeclaration() {
        return this.injector.get(Declaration, null);
    }
    /**
     * 事件触发器，触发事件发布
     * @param eventName 待发布事件
     */
    trigger(eventName) {
        const subscription = this.context.commandBus.executingCommandCount$.subscribe((executingCommandCount) => {
            if (executingCommandCount !== 0) {
                return;
            }
            this.innerTrigger(eventName);
            // @todo
            // subscription存在未undefine的情况，待进一步排查。
            if (subscription) {
                subscription.unsubscribe();
            }
            else {
                setTimeout(() => {
                    if (subscription) {
                        subscription.unsubscribe();
                    }
                }, 0);
            }
        });
    }
    /**
     * 内部触发变更检测
     */
    innerTrigger(eventName) {
        // 根据事件名，查找对应的事件处理器
        const eventHandler = this.declaration && this.declaration[eventName];
        if (!eventHandler) {
            return;
        }
        // 执行事件
        eventHandler();
    }
}
FrameComponent.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FrameComponent.ctorParameters = () => [
    { type: Injector }
];
export { FrameComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWVfY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZnJhbWUvZnJhbWVfY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQXlCLGlCQUFpQixFQUFzRixNQUFNLGVBQWUsQ0FBQztBQUNuTCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUdyRSxPQUFPLEVBQUUsa0NBQWtDLEVBQXdCLE1BQU0sVUFBVSxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFL0IsTUFDZSxjQUFjO0lBOEMzQjs7O09BR0c7SUFDSCxZQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBYmhDLGdCQUFXLEdBQUcsS0FBSyxDQUFDO1FBYzFCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWUsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7U0FDbkI7UUFDRCxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFDeEMsMkJBQTJCO1FBQzNCLDJDQUEyQztRQUMzQyx5Q0FBeUM7UUFFekMseUNBQXlDO1FBQ3pDLDBCQUEwQjtRQUUxQiwyQkFBMkI7UUFFM0Isd0JBQXdCO0lBQzFCLENBQUM7SUFDRDs7OztPQUlHO0lBQ0gsSUFBVyxlQUFlO1FBQ3hCLElBQUksSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRTtZQUMxQyxNQUFNLG1C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QUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU87U0FDUjtRQUNELE9BQU87UUFDUCxZQUFZLEVBQUUsQ0FBQztJQUNqQixDQUFDOzs7WUExUkYsVUFBVTs7OztZQVRGLFFBQVE7O0FBdVNqQixPQUFPLEVBQUUsY0FBYyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE5LTAzLTEyIDE0OjU5OjIyXHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiBhYWxpenp3ZWxsXHJcbiAqIEBMYXN0IE1vZGlmaWVkIHRpbWU6IDIwMTktMDYtMTUgMTc6MjY6MDdcclxuICovXHJcblxyXG5pbXBvcnQgeyBJbmplY3RvciwgSW5qZWN0YWJsZSwgSW5qZWN0RmxhZ3MsIE9wdGlvbmFsLCBDaGFuZ2VEZXRlY3RvclJlZiwgT25EZXN0cm95LCBFbGVtZW50UmVmLCBSZW5kZXJlciwgUmVuZGVyZXIyLCBSZW5kZXJlckZhY3RvcnkyLCBDb21wb25lbnRSZWYsIE9uSW5pdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuL2ZyYW1lX2NvbnRleHQnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWwgfSBmcm9tICcuLi92aWV3LW1vZGVsL2luZGV4JztcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uLCBEZWNsYXJhdGlvbiB9IGZyb20gJy4uL2V2ZW50LW1lY2hhbmlzbS9pbmRleCc7XHJcbmltcG9ydCB7IEV2ZW50UGlwZSB9IGZyb20gJy4uL2V2ZW50LWJ1cy1uZXcvaW5kZXgnO1xyXG5pbXBvcnQgeyBDb21wb25lbnRUeXBlLCBJRGlzcG9zYWJsZSB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBGUkFNRV9DT01QT05FTlRfSU5JVF9IQU5ETEVSX1RPS0VOLCBvbkZyYW1lQ29tcG9uZW50SW5pdCB9IGZyb20gJy4vdG9rZW5zJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5hYnN0cmFjdCBjbGFzcyBGcmFtZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBJRGlzcG9zYWJsZSB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWPmOabtOajgOa1i+WZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgY2Q6IENoYW5nZURldGVjdG9yUmVmO1xyXG5cclxuICAvKipcclxuICAgKiDmoYbmnrZJRFxyXG4gICAqL1xyXG4gIHB1YmxpYyBpZDogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDmoYbmnrbkuIrkuIvmlodcclxuICAgKi9cclxuICBwdWJsaWMgY29udGV4dDogRnJhbWVDb250ZXh0O1xyXG5cclxuICAvKipcclxuICAgKiDop4blm77mqKHlnotcclxuICAgKi9cclxuICBwdWJsaWMgdmlld01vZGVsOiBWaWV3TW9kZWw7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuoumYheS6i+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgLyoqXHJcbiAgICog5YWs5byA5LqL5Lu2XHJcbiAgICovXHJcbiAgcHVibGljIGRlY2xhcmF0aW9uOiBEZWNsYXJhdGlvbjtcclxuXHJcbiAgLyoqXHJcbiAgICog6K+l57uE5Lu26K6i6ZiF55qERXZlbnRQaXBlc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZXZlbnRQaXBlczogSURpc3Bvc2FibGVbXTtcclxuXHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplZCA9IGZhbHNlO1xyXG4gIC8qKlxyXG4gICAqIOe7hOS7tumUgOavgea1gVxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZXN0b3J5U2lnbmFsOiBTdWJqZWN0PGFueT47XHJcbiAgLyoqXHJcbiAgICog57uE5Lu257G75Z6LXHJcbiAgICovXHJcbiAgcHVibGljIGNvbXBvbmVudFR5cGU6IENvbXBvbmVudFR5cGU7XHJcbiAgLyoqXHJcbiAgICog5qGG5p625p6E6YCg5Ye95pWwXHJcbiAgICogQHBhcmFtIGluamVjdG9yIOazqOWFpeWZqFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIHRoaXMuY29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEZyYW1lQ29udGV4dD4oRnJhbWVDb250ZXh0LCBudWxsKTtcclxuICAgIGlmICh0aGlzLmNvbnRleHQpIHtcclxuICAgICAgdGhpcy5pbml0aWFsaXplKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmRlc3RvcnlTaWduYWwgPSBuZXcgU3ViamVjdDxhbnk+KCk7XHJcbiAgICAvLyB0aGlzLmNvbnRleHQuaW5pdCh0aGlzKTtcclxuICAgIC8vIHRoaXMudmlld01vZGVsID0gdGhpcy5jb250ZXh0LnZpZXdNb2RlbDtcclxuICAgIC8vIHRoaXMuY2QgPSB0aGlzLmdldENoYW5nZURldGVjdG9yUmVmKCk7XHJcblxyXG4gICAgLy8gLy8g5b+F6aG75YWI5omn6KGMY29udGV4dOeahOWIneWni+WMlu+8jOeEtuWQjuWGjeWIneWni+WMllN1YnNjcmlwdGlvblxyXG4gICAgLy8gdGhpcy5pbml0UHVibGljRXZlbnQoKTtcclxuXHJcbiAgICAvLyB0aGlzLmluaXRTdWJzY3JpcHRpb24oKTtcclxuXHJcbiAgICAvLyB0aGlzLnJlc3RDb21wb25lbnQoKTtcclxuICB9XHJcbiAgLyoqXHJcbiAgICog5piv5ZCm5Li66KGo5qC857uE5Lu2XHJcbiAgICogQGRlc2NyaXB0aW9uIOi/lOWbnnRydWUvZmFsc2Xml7blj6/ku6Xkv6Hku7vvvIzkvYblpoLmnpzov5Tlm57nmoTmmK91bmRlZmluZWTliJnkuI3lupTkv6Hku7tcclxuICAgKiBAd2FybmluZyDor6XlsZ7mgKfkvp3otZbkuobnlJ/miJDku6PnoIHvvIzlpoLmnpzpnZ7moIflh4bnmoTnlJ/miJDlnovlt6XnqIvkuZ/kvJrlr7zoh7TliKTmlq3lpLHotKXjgIJcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGlzR3JpZENvbXBvbmVudCgpIHtcclxuICAgIGlmICh0aGlzLmNvbnRleHQgJiYgdGhpcy5jb250ZXh0LnZpZXdNb2RlbCkge1xyXG4gICAgICBjb25zdCBkYXRhR3JpZENvbHVtbnNOYW1lID0gdGhpcy5jb250ZXh0LnZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zTmFtZSddIHx8IG51bGw7XHJcbiAgICAgIHJldHVybiBkYXRhR3JpZENvbHVtbnNOYW1lID8gdHJ1ZSA6IGZhbHNlO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcbiAgZGlzcG9zZShvcHRpb25zPzogYW55KSB7XHJcbiAgICBpZiAodGhpcy5ldmVudFBpcGVzKSB7XHJcbiAgICAgIHRoaXMuZXZlbnRQaXBlcy5mb3JFYWNoKChldmVudFBpcGU6IElEaXNwb3NhYmxlKSA9PiB7XHJcbiAgICAgICAgKGV2ZW50UGlwZSBhcyBFdmVudFBpcGUpLmRpc3Bvc2VCeUNhbGxlcih0aGlzKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmNkID0gbnVsbDtcclxuICAgIC8vIHRoaXMudmlld01vZGVsID0gbnVsbDtcclxuICAgIHRoaXMuY29udGV4dC5kaXNwb3NlKCk7XHJcbiAgICBpZiAodGhpcy5kZXN0b3J5U2lnbmFsKSB7XHJcbiAgICAgIHRoaXMuZGVzdG9yeVNpZ25hbC5uZXh0KCk7XHJcbiAgICAgIHRoaXMuZGVzdG9yeVNpZ25hbC5jb21wbGV0ZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmluaXRpYWxpemUoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdGlhbGl6ZSgpIHtcclxuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xyXG4gICAgICB0aGlzLmNvbnRleHQuaW5pdCh0aGlzKTtcclxuICAgICAgdGhpcy52aWV3TW9kZWwgPSB0aGlzLmNvbnRleHQudmlld01vZGVsO1xyXG4gICAgICB0aGlzLmNkID0gdGhpcy5nZXRDaGFuZ2VEZXRlY3RvclJlZigpO1xyXG5cclxuICAgICAgLy8g5b+F6aG75YWI5omn6KGMY29udGV4dOeahOWIneWni+WMlu+8jOeEtuWQjuWGjeWIneWni+WMllN1YnNjcmlwdGlvblxyXG4gICAgICB0aGlzLmluaXRQdWJsaWNFdmVudCgpO1xyXG5cclxuICAgICAgdGhpcy5pbml0U3Vic2NyaXB0aW9uKCk7XHJcblxyXG4gICAgICB0aGlzLnJlc3RDb21wb25lbnQoKTtcclxuXHJcbiAgICAgIHRoaXMub25GcmFtZUNvbXBvbmVudEluaXQoKTtcclxuICAgICAgdGhpcy5pbml0aWFsaXplZCA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaJp+ihjOe7hOS7tuWIneWni+WMllxyXG4gICAqL1xyXG4gIHByaXZhdGUgb25GcmFtZUNvbXBvbmVudEluaXQoKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbXBvbmVudEluaXRIYW5kbGVycyA9IHRoaXMuaW5qZWN0b3IuZ2V0PG9uRnJhbWVDb21wb25lbnRJbml0W10+KEZSQU1FX0NPTVBPTkVOVF9JTklUX0hBTkRMRVJfVE9LRU4sIG51bGwpO1xyXG4gICAgaWYgKGZyYW1lQ29tcG9uZW50SW5pdEhhbmRsZXJzICYmIEFycmF5LmlzQXJyYXkoZnJhbWVDb21wb25lbnRJbml0SGFuZGxlcnMpICYmIGZyYW1lQ29tcG9uZW50SW5pdEhhbmRsZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZnJhbWVDb21wb25lbnRJbml0SGFuZGxlcnMuZm9yRWFjaCgoaGFuZGxlcjogb25GcmFtZUNvbXBvbmVudEluaXQpID0+IHtcclxuICAgICAgICBoYW5kbGVyLm9uQ29tcG9uZW50SW5pdCh0aGlzLmNvbnRleHQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Y+Y5pu05qOA5rWL5Zmo5a6e5L6LXHJcbiAgICogQHRvZG/vvJrlupTor6XpgJrov4fms6jlhaXojrflj5bvvIzkvYbms6jlhaXkvJrlvJXotbfooajljZXnvJbor5HjgIJcclxuICAgKi9cclxuICBwcml2YXRlIGdldENoYW5nZURldGVjdG9yUmVmKCkge1xyXG5cclxuICAgIC8vIGNvbnN0IGNkID0gdGhpcy5nZXQ8Q2hhbmdlRGV0ZWN0b3JSZWY+KENoYW5nZURldGVjdG9yUmVmLCBudWxsLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XHJcbiAgICBjb25zdCBjZCA9IHRoaXMuaW5qZWN0b3IuZ2V0KENoYW5nZURldGVjdG9yUmVmLCBudWxsKTtcclxuICAgIHJldHVybiBjZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuW9k+WJjee7hOS7tuiEseemu+WPmOabtOajgOa1i+agkVxyXG4gICAqL1xyXG4gIHB1YmxpYyBkZXRhY2goKSB7XHJcbiAgICBpZiAodGhpcy5pc0NkVmFsaWQoKSA9PT0gZmFsc2UpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jZC5kZXRhY2goKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuW9k+WJjee7hOS7tumHjeaWsOWKoOWFpeWPmOabtOajgOa1i+agkVxyXG4gICAqL1xyXG4gIHB1YmxpYyByZWF0dGFjaCgpIHtcclxuICAgIGlmICh0aGlzLmlzQ2RWYWxpZCgpID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmNkLnJlYXR0YWNoKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlr7nlvZPliY3nu4Tku7bov5vooYzkuIDmrKHlj5jmm7Tmo4Dmn6VcclxuICAgKi9cclxuICBwdWJsaWMgZGV0ZWN0Q2hhbmdlcygpIHtcclxuICAgIGlmICh0aGlzLmlzQ2RWYWxpZCgpID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLmNkLmRldGVjdENoYW5nZXMoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOajgOa1i0NoYW5nZURldGVjdGlvbuaYr+WQpuacieaViFxyXG4gICAqIEB0b2RvOiBDYW4ndCBiZSBkZXBlbmQgb24gdGhlIGRlc3Ryb3llZCBwcm9wZXJ0eSwgZGVzdHJveWVkLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgaXNDZFZhbGlkKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuY2QgJiYgdGhpcy5jZFsnZGVzdHJveWVkJ10gPT09IGZhbHNlIHx8IGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6YeN572u57uE5Lu254q25oCBXHJcbiAgICogQHRvZG/vvJpBcHBDb250ZXh05piv5YWo5bGA55qE77yMXHJcbiAgICovXHJcbiAgcHVibGljIHJlc3RDb21wb25lbnQoKSB7XHJcblxyXG4gICAgaWYgKHRoaXMuY29udGV4dCAhPT0gdGhpcy5jb250ZXh0LnJvb3QpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDHjgIHlpoLmnpxBcHBDb250ZXh05LiN5pivcm9vdOW5tuS4lOeItkFwcENvbnRleHTkuZ/kuI3mmK9yb2905LiN5riF55CGO1xyXG4gICAgLy8gMuOAgeihqOWNlU1vZHVsZemHjOazqOWFpeS6hkZBUlJJU19ERVZLSVRfQVBQX1BST1ZJREVSU+mHjOmdouacieS4gOS4quWGl+S9meeahEFwcENvbnRleHTms6jlhaVcclxuICAgIC8vICAgIOWvvOiHtOaJgOaciUFwcENvbnRleHTnmoTmoLnmmK/or6XlhpfkvZnnmoRBcHBDb250ZXh077yM5omA5Lul6KaB5qOA5rWLcGFyZW50LnBhcmVudOOAglxyXG4gICAgLy8g5Y+q5riF55CG5qC557uE5Lu255qEc2Vzc2lvblxyXG4gICAgaWYgKHRoaXMuY29udGV4dC5hcHBDb250ZXh0LnBhcmVudCAhPT0gbnVsbCAmJiB0aGlzLmNvbnRleHQuYXBwQ29udGV4dC5wYXJlbnQucGFyZW50ICE9PSBudWxsKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSZXBvc2l0b3J56KKr5rOo5YaM5Yiw5YWo5bGA5LqG77yM5qih5Z2X5L6d6LWW5rOo5YWl5Lit55qE5a+56LGh77yM5rKh5pyJ6YeN572u5pe25py677yM5Li05pe25Zyo5qC557uE5Lu25Lit6L+b6KGM5rOo6ZSA44CCXHJcbiAgICAvLyBAdG9kb++8muW6lOivpea4heeQhuWFqOmDqHJlcG9zaXRvcnnvvIznm67liY3nvLrlsJHlhajlsYDnrqHnkIbmiYDmnIlSZXBvc2l0b3J555qE5Zyw5pa544CCXHJcbiAgICB0aGlzLmNvbnRleHQucmVwb3NpdG9yeS5yZXNldCgpO1xyXG4gICAgLy8g6YeN572u57uE5Lu257uR5a6a5pWw5o2uXHJcbiAgICB0aGlzLmNvbnRleHQuYmluZGluZ0RhdGEucmVzZXQoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyW5LqL5Lu26K6i6ZiFXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbml0U3Vic2NyaXB0aW9uKCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLmdldFN1YnNjcmlwdGlvbigpO1xyXG4gICAgaWYgKCF0aGlzLnN1YnNjcmlwdGlvbikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5ldmVudFBpcGVzID0gdGhpcy5zdWJzY3JpcHRpb24uaW5pdCh0aGlzKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDojrflj5Zjb21wb25lbnTlr7nlupTnmoTorqLpmIVcclxuICAgKiBAcmV0dXJucyBcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0U3Vic2NyaXB0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5qZWN0b3IuZ2V0PFN1YnNjcmlwdGlvbj4oU3Vic2NyaXB0aW9uLCBudWxsKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdFB1YmxpY0V2ZW50KCkge1xyXG5cclxuICAgIHRoaXMuZGVjbGFyYXRpb24gPSB0aGlzLmdldERlY2xhcmF0aW9uKCk7XHJcbiAgICBpZiAoIXRoaXMuZGVjbGFyYXRpb24pIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZGVjbGFyYXRpb24uaW5pdCh0aGlzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW9k+WJjWNvbXBvbmVudOWvueW6lOeahGRlY2xhcmF0aW9uXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHVibGljIGdldERlY2xhcmF0aW9uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaW5qZWN0b3IuZ2V0PERlY2xhcmF0aW9uPihEZWNsYXJhdGlvbiwgbnVsbCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuovku7bop6blj5HlmajvvIzop6blj5Hkuovku7blj5HluINcclxuICAgKiBAcGFyYW0gZXZlbnROYW1lIOW+heWPkeW4g+S6i+S7tlxyXG4gICAqL1xyXG4gIHB1YmxpYyB0cmlnZ2VyKGV2ZW50TmFtZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSB0aGlzLmNvbnRleHQuY29tbWFuZEJ1cy5leGVjdXRpbmdDb21tYW5kQ291bnQkLnN1YnNjcmliZSgoZXhlY3V0aW5nQ29tbWFuZENvdW50OiBudW1iZXIpID0+IHtcclxuICAgICAgaWYgKGV4ZWN1dGluZ0NvbW1hbmRDb3VudCAhPT0gMCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLmlubmVyVHJpZ2dlcihldmVudE5hbWUpO1xyXG5cclxuICAgICAgLy8gQHRvZG9cclxuICAgICAgLy8gc3Vic2NyaXB0aW9u5a2Y5Zyo5pyqdW5kZWZpbmXnmoTmg4XlhrXvvIzlvoXov5vkuIDmraXmjpLmn6XjgIJcclxuICAgICAgaWYgKHN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgIHN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbikge1xyXG4gICAgICAgICAgICBzdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9LCAwKTtcclxuICAgICAgfVxyXG5cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YaF6YOo6Kem5Y+R5Y+Y5pu05qOA5rWLXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpbm5lclRyaWdnZXIoZXZlbnROYW1lOiBzdHJpbmcpIHtcclxuXHJcbiAgICAvLyDmoLnmja7kuovku7blkI3vvIzmn6Xmib7lr7nlupTnmoTkuovku7blpITnkIblmahcclxuICAgIGNvbnN0IGV2ZW50SGFuZGxlcjogYW55ID0gdGhpcy5kZWNsYXJhdGlvbiAmJiB0aGlzLmRlY2xhcmF0aW9uW2V2ZW50TmFtZV07XHJcbiAgICBpZiAoIWV2ZW50SGFuZGxlcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICAvLyDmiafooYzkuovku7ZcclxuICAgIGV2ZW50SGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEZyYW1lQ29tcG9uZW50IH07XHJcbiJdfQ==