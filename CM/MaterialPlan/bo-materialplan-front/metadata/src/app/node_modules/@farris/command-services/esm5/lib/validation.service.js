import * as tslib_1 from "tslib";
// tslint:disable: max-line-length
import { Injectable, Optional } from '@angular/core';
import { Repository, FrameContext, PARENT_CLASS, ChangeType, DataPropGroup } from '@farris/devkit';
import { tap, switchMap } from 'rxjs/operators';
import { EMPTY, Subject } from 'rxjs';
import { zip } from 'rxjs/observable/zip';
import { empty } from 'rxjs/observable/empty';
import { of } from 'rxjs/observable/of';
import { VerifyDetailService } from '@farris/ui-verify-detail';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
/**
 * 表单验证服务
 * @scope FrameComponent
 */
var ValidationService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ValidationService(repository, frameContext, notifyService, languageService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.validationResults = new Subject();
        this.validationAllResult = new Subject();
        if (!this.languageService) {
            this.languageService = new LanguageService();
        }
    }
    /**
     * 验证表单内的所有表单
     */
    ValidationService.prototype.validate = function () {
        var _this = this;
        this.repository.getList().subscribe(function (result) {
            var e_1, _a;
            try {
                for (var result_1 = tslib_1.__values(result), result_1_1 = result_1.next(); !result_1_1.done; result_1_1 = result_1.next()) {
                    var entity = result_1_1.value;
                    entity.validate().subscribe(function (result) {
                        if (!result.isValid) {
                            alert(result.message);
                            _this.validationResults.next(result);
                        }
                    });
                }
            }
            catch (e_1_1) { e_1 = { error: e_1_1 }; }
            finally {
                try {
                    if (result_1_1 && !result_1_1.done && (_a = result_1.return)) _a.call(result_1);
                }
                finally { if (e_1) throw e_1.error; }
            }
        });
        return this.validationResults;
    };
    /**
     * 校验当前行
     */
    ValidationService.prototype.validateCurrentRow = function () {
        var _this = this;
        var entityTypeInfo = this.repository.entityTypeInfo;
        // 组合表单只校验当前按钮所在的表单
        var primaryValue = this.frameContext.bindingData.list.currentId;
        if (!primaryValue) {
            return of(true);
        }
        // 首先校验实体不能为空规则
        var entity = this.repository.entityCollection.getEntityById(primaryValue);
        if (!entity) {
            return of(true);
        }
        var isEntityValid = this.validateEntityAllowEmptyRule(entity, entityTypeInfo);
        if (!isEntityValid) {
            return EMPTY;
        }
        var entities = [entity];
        var namespace = this.frameContext.namespace;
        var frameContexts = [];
        // 修复使用相同be创建的vo的组合表单校验时多个表单校验规则被合并的问题
        // TODO: 目前未考虑组合表单统一保存的场景，后续支持组合表单统一保存时再修改
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var isModal = this.isInDialog();
        var hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var toValidate = false;
        var formErrors = [];
        frameContexts.forEach(function (frameContext) {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        rootViewModel.verifyInformations = [];
        var formValid = true;
        var entityValid = true;
        var formValidationRules = new Map();
        frameContexts.forEach(function (formContext) {
            var bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                var currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach(function (rules, path) {
                    if (formValidationRules.has(path)) {
                        rules.forEach(function (rule) { return formValidationRules.get(path).push(rule); });
                    }
                    else {
                        formValidationRules.set(path, tslib_1.__spread(rules));
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 验证所有实体
        var observableList = entities.map(function (entity) {
            var index = _this.frameContext.bindingData.list.getIndexById(entity.primaryValue);
            return entity.validate(undefined, undefined, formValidationRules, null, _this.frameContext);
        });
        var result$ = zip.apply(void 0, tslib_1.__spread(observableList)).pipe(tap(function (resultList) {
            frameContexts.forEach(function (formContext) {
                if (!formContext.form.enableValidate) {
                    return;
                }
                var handleErrors = function (errors) {
                    errors.forEach(function (validationError) {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        var errMsgObj = {};
                        var id = '';
                        var findId = function (target) {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        var parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        var bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(function (key) {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        var paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id: id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                var isValidList = resultList.map(function (result) { return result.isValid; });
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(function (x) { return x; }).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        var bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        var form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach(function (result) {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap(function (resultList) {
            var isValidated = true;
            var errors = [];
            resultList.forEach(function (result) {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push.apply(errors, tslib_1.__spread(result.errors));
            });
            if (errors.length > 0) {
                _this.collectValidationErrors(rootViewModel, errors, _this.frameContext.namespace);
            }
            // rootViewModel.verifycationChanged.next(rootViewModel.verifyInformations);
            var verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; });
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && !formValid) {
                // 实体校验通过但表单校验不通过，此时实体和表单存在校验规则不一致的情况
                console.warn('实体和控件校验规则不一致，会导致命令执行中断！');
            }
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    };
    /**
     * 调用表单和实体上的验证规则, 通过后调用回调cb
     */
    ValidationService.prototype.validateAll = function () {
        var _this = this;
        // 组合表单只校验当前按钮所在的表单
        var entities = this.repository.entityCollection.getAllEntities();
        var namespace = this.frameContext.namespace;
        var frameContexts = [];
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var toValidate = false;
        var formErrors = [];
        frameContexts.forEach(function (frameContext) {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        var isModal = this.isInDialog();
        var hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var formValid = true;
        var entityValid = true;
        var formValidationRules = new Map();
        frameContexts.forEach(function (formContext) {
            var bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                var currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach(function (rules, path) {
                    if (formValidationRules.has(path)) {
                        rules.forEach(function (rule) { return formValidationRules.get(path).push(rule); });
                    }
                    else {
                        formValidationRules.set(path, tslib_1.__spread(rules));
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 触发所有实体的validate事件
        var isMultiEntityValiate = entities.length > 0;
        // 验证所有实体
        var observableList = entities.map(function (entity, index) {
            return entity.validate(undefined, undefined, formValidationRules, isMultiEntityValiate ? index : null, _this.frameContext);
        });
        var result$ = zip.apply(void 0, tslib_1.__spread(observableList)).pipe(tap(function (resultList) {
            frameContexts.forEach(function (formContext) {
                if (!formContext.form.enableValidate) {
                    return;
                }
                var handleErrors = function (errors) {
                    errors.forEach(function (validationError) {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        var errMsgObj = {};
                        var id = '';
                        var findId = function (target) {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        var parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        var bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(function (key) {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        var paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id: id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                var isValidList = resultList.map(function (result) { return result.isValid; });
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(function (x) { return x; }).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        var bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        var form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach(function (result) {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap(function (resultList) {
            var isValidated = true;
            var errors = [];
            resultList.forEach(function (result) {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push.apply(errors, tslib_1.__spread(result.errors));
            });
            if (errors.length > 0) {
                _this.collectValidationErrors(rootViewModel, errors, _this.frameContext.namespace);
            }
            var verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; });
            }
            // 因为校验累加的缘故，导致之前的校验信息一直存在，只能通过校验结果来确定是否还有错误信息
            if (isValidated && formValid) {
                verifyInformations = rootViewModel.verifyInformations = [];
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    };
    /**
     * 校验实体是否满足不能为空的规则
     * @param entity 主实体
     */
    ValidationService.prototype.validateEntityAllowEmptyRule = function (entity, entityTypeInfo) {
        var _this = this;
        // 确认实体各个层级中是否存在不能为空的规则
        var paths = this.getNotAllowEmptyBindingPaths(entityTypeInfo);
        if (!paths || paths.length < 1) {
            return true;
        }
        // 找到所有不合法的bindingPaths
        var invalidPaths = paths.filter(function (path) {
            var bindingPaths = path.split('/').filter(function (p) { return p; });
            var bindingList = _this.frameContext.bindingData.getValue(bindingPaths);
            if (!bindingList || bindingList.length < 1) {
                return true;
            }
            return false;
        });
        if (invalidPaths.length > 0) {
            var tableNames_1 = [];
            invalidPaths.forEach(function (path) {
                var viewModelName = _this.getViewModelNameByBindingPaths(path.split('/'));
                tableNames_1.push(viewModelName);
            });
            if (this.notifyService) {
                this.notifyService.error(tableNames_1.join('，') + " " + this.languageService.tableCanNotEmpty, { hideTitle: true });
            }
            return false;
        }
        return true;
    };
    /**
     *
     * @param bindingPaths path不能为空或/，不支持主表
     */
    ValidationService.prototype.getViewModelNameByBindingPaths = function (bindingPaths) {
        var namespace = this.frameContext.namespace;
        var frameContexts = null;
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        var bindingPath = bindingPaths.filter(function (p) { return p; }).join('/');
        var frameContext = frameContexts.find(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).join('/') === bindingPath; });
        var viewModelName = frameContext && frameContext.form && frameContext.form.formGroupName || '';
        return viewModelName;
    };
    ValidationService.prototype.getNotAllowEmptyBindingPaths = function (entityTypeInfo) {
        if (!entityTypeInfo) {
            return undefined;
        }
        var paths = [];
        this.deepFirstTraversalEntityTypeInfo(entityTypeInfo, paths);
        return paths;
    };
    ValidationService.prototype.deepFirstTraversalEntityTypeInfo = function (entityTypeInfo, result, previousValue) {
        var _this = this;
        if (result === void 0) { result = []; }
        if (previousValue === void 0) { previousValue = []; }
        var list = entityTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach(function (propInfo) {
                var typeInfo = propInfo.typeInfo;
                if (typeInfo && typeInfo.entityInfo && typeInfo.entityInfo.allowEmpty === false) {
                    previousValue.push(typeInfo.entityInfo.nodeCode);
                    _this.deepFirstTraversalEntityTypeInfo(typeInfo, result, previousValue);
                }
            });
        }
        // 没有下级了，此时应该清空游标，将收集到的路径放到结果集中
        if (previousValue && previousValue.length > 0) {
            var paths = previousValue.join('/');
            result.push(paths);
        }
        previousValue.splice(0, previousValue.length);
    };
    ValidationService.prototype.collectValidationErrors = function (rootViewModel, errors, namespace, filter) {
        var _this = this;
        if (filter === void 0) { filter = true; }
        if (filter) {
            rootViewModel.verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace !== namespace; });
        }
        errors.forEach(function (validationError) {
            if (validationError.children && validationError.children.length) {
                _this.collectValidationErrors(rootViewModel, validationError.children, namespace, false);
            }
            var id = '';
            var findId = function (target) {
                if (target && target.data && target.data.id) {
                    id = target.data.id;
                    return;
                }
                else if (target[PARENT_CLASS]) {
                    findId(target[PARENT_CLASS]);
                }
            };
            findId(validationError.target);
            if (validationError.constraints) {
                var validationResultTypes = Object.keys(validationError.constraints);
                if (validationResultTypes.length) {
                    var offset = rootViewModel.verifyInformations.filter(function (item) { return item.namespace === namespace; }).length;
                    var index = rootViewModel.verifyInformations.findIndex(function (item) { return item.namespace === namespace; });
                    index = index === -1 ? 0 : index + offset;
                    rootViewModel.verifyInformations.splice(index, 0, {
                        id: id,
                        namespace: namespace,
                        targetField: validationError.field,
                        index: validationError.index,
                        title: validationError.propertyName,
                        msg: validationError.constraints[validationResultTypes[0]],
                        frameContext: validationError.frameContext,
                        fullPath: validationError.fullPath,
                        type: validationResultTypes[0] === 'required' ? 'empty' : 'error'
                    });
                }
            }
        });
    };
    /**
     * 重置校验信息（仅当前表单）
     */
    ValidationService.prototype.resetValidation = function () {
        var isDialog = this.isInDialog();
        var rootViewModel = this.frameContext.root.viewModel;
        if (isDialog) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        var verifyInformations = rootViewModel.verifyInformations;
        if (verifyInformations.length) {
            var namespace_1 = this.frameContext.namespace;
            if (namespace_1 !== null) {
                verifyInformations = rootViewModel.verifyInformations.filter(function (item) { return item.namespace !== namespace_1; });
            }
            rootViewModel.verifyInformations = verifyInformations;
            //rootViewModel.verifyInformations.splice(0, rootViewModel.verifyInformations.length);
        }
        if (rootViewModel && rootViewModel.verifycationChanged) {
            rootViewModel.verifycationChanged.next(verifyInformations);
        }
        return of(null);
    };
    /**
     * 是否在弹窗内部
     */
    ValidationService.prototype.isInDialog = function () {
        return this.frameContext && this.frameContext.getVirtualRootFrameContext() && this.frameContext.getVirtualRootFrameContext().frameComponent && this.frameContext.getVirtualRootFrameContext().frameComponent['isDialogRootComponent'] || false;
    };
    /**
     * 拥有独自的校验提示服务
     */
    ValidationService.prototype.hasOwnVerifyDetailService = function () {
        return this.frameContext.injector.get(VerifyDetailService, null) !== this.frameContext.root.appContext.injector.get(VerifyDetailService, null);
        ;
    };
    ValidationService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ValidationService.ctorParameters = function () { return [
        { type: Repository },
        { type: FrameContext },
        { type: FormNotifyService, decorators: [{ type: Optional }] },
        { type: LanguageService, decorators: [{ type: Optional }] }
    ]; };
    return ValidationService;
}());
export { ValidationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3ZhbGlkYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsa0NBQWtDO0FBQ2xDLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxVQUFVLEVBQVUsWUFBWSxFQUFFLFlBQVksRUFBRSxVQUFVLEVBQTRFLGFBQWEsRUFBNkIsTUFBTSxnQkFBZ0IsQ0FBQztBQUNoTixPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxLQUFLLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDOUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3hDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVwRDs7O0dBR0c7QUFFSDtJQUtFOztPQUVHO0lBQ0gsMkJBQ1UsVUFBMkIsRUFDM0IsWUFBMEIsRUFDZCxhQUFnQyxFQUNoQyxlQUFnQztRQUg1QyxlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUNkLGtCQUFhLEdBQWIsYUFBYSxDQUFtQjtRQUNoQyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFUOUMsc0JBQWlCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQUN2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OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFJlcG9zaXRvcnksIEVudGl0eSwgRnJhbWVDb250ZXh0LCBQQVJFTlRfQ0xBU1MsIENoYW5nZVR5cGUsIFZhbGlkYXRpb25SZXN1bHQsIFZhbGlkYXRpb25FcnJvciwgVmFsaWRhdGVSdWxlLCBWaWV3TW9kZWwsIERhdGFUeXBlSW5mbywgRGF0YVByb3BHcm91cCwgRGF0YVByb3BJbmZvLCBCaW5kaW5nTGlzdCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IHRhcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHppcCB9IGZyb20gJ3J4anMvb2JzZXJ2YWJsZS96aXAnO1xuaW1wb3J0IHsgZW1wdHkgfSBmcm9tICdyeGpzL29ic2VydmFibGUvZW1wdHknO1xuaW1wb3J0IHsgb2YgfSBmcm9tICdyeGpzL29ic2VydmFibGUvb2YnO1xuaW1wb3J0IHsgVmVyaWZ5RGV0YWlsU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktdmVyaWZ5LWRldGFpbCc7XG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4vZm9ybS1ub3RpZnkuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XG5cbi8qKlxuICog6KGo5Y2V6aqM6K+B5pyN5YqhXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcbiAqL1xuXG5ASW5qZWN0YWJsZSgpXG5jbGFzcyBWYWxpZGF0aW9uU2VydmljZSB7XG5cbiAgcHJpdmF0ZSB2YWxpZGF0aW9uUmVzdWx0cyA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgcHJpdmF0ZSB2YWxpZGF0aW9uQWxsUmVzdWx0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuICAvKipcbiAgICog5p6E6YCg5Ye95pWwXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZVxuICApIHtcbiAgICBpZiAoIXRoaXMubGFuZ3VhZ2VTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IG5ldyBMYW5ndWFnZVNlcnZpY2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6aqM6K+B6KGo5Y2V5YaF55qE5omA5pyJ6KGo5Y2VXG4gICAqL1xuICBwdWJsaWMgdmFsaWRhdGUoKSB7XG4gICAgdGhpcy5yZXBvc2l0b3J5LmdldExpc3QoKS5zdWJzY3JpYmUoXG4gICAgICAocmVzdWx0OiBFbnRpdHlbXSkgPT4ge1xuICAgICAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiByZXN1bHQpIHtcbiAgICAgICAgICBlbnRpdHkudmFsaWRhdGUoKS5zdWJzY3JpYmUoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgaWYgKCFyZXN1bHQuaXNWYWxpZCkge1xuICAgICAgICAgICAgICBhbGVydChyZXN1bHQubWVzc2FnZSk7XG4gICAgICAgICAgICAgIHRoaXMudmFsaWRhdGlvblJlc3VsdHMubmV4dChyZXN1bHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy52YWxpZGF0aW9uUmVzdWx0cztcbiAgfVxuICAvKipcbiAgICog5qCh6aqM5b2T5YmN6KGMXG4gICAqL1xuICBwdWJsaWMgdmFsaWRhdGVDdXJyZW50Um93KCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgZW50aXR5VHlwZUluZm8gPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XG4gICAgLy8g57uE5ZCI6KGo5Y2V5Y+q5qCh6aqM5b2T5YmN5oyJ6ZKu5omA5Zyo55qE6KGo5Y2VXG4gICAgY29uc3QgcHJpbWFyeVZhbHVlID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XG4gICAgaWYgKCFwcmltYXJ5VmFsdWUpIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG4gICAgLy8g6aaW5YWI5qCh6aqM5a6e5L2T5LiN6IO95Li656m66KeE5YiZXG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChwcmltYXJ5VmFsdWUpO1xuICAgIGlmICghZW50aXR5KSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuICAgIGNvbnN0IGlzRW50aXR5VmFsaWQgPSB0aGlzLnZhbGlkYXRlRW50aXR5QWxsb3dFbXB0eVJ1bGUoZW50aXR5LCBlbnRpdHlUeXBlSW5mbyk7XG4gICAgaWYgKCFpc0VudGl0eVZhbGlkKSB7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICAgIGNvbnN0IGVudGl0aWVzOiBFbnRpdHlbXSA9IFtlbnRpdHldO1xuICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcbiAgICBsZXQgZnJhbWVDb250ZXh0cyA9IFtdO1xuICAgIC8vIOS/ruWkjeS9v+eUqOebuOWQjGJl5Yib5bu655qEdm/nmoTnu4TlkIjooajljZXmoKHpqozml7blpJrkuKrooajljZXmoKHpqozop4TliJnooqvlkIjlubbnmoTpl67pophcbiAgICAvLyBUT0RPOiDnm67liY3mnKrogIPomZHnu4TlkIjooajljZXnu5/kuIDkv53lrZjnmoTlnLrmma/vvIzlkI7nu63mlK/mjIHnu4TlkIjooajljZXnu5/kuIDkv53lrZjml7blho3kv67mlLlcbiAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XG4gICAgICAvLyDlrZjlnKjlkb3lkI3nqbrpl7TvvIzor7TmmI7ooajljZXovoPmlrDvvIzlj6/ku6Xkvp3otZbor6XnibnmgKdcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0c0J5TmFtZXNwYWNlKG5hbWVzcGFjZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOihqOWNlei+g+iAge+8jOiOt+WPluaJgOacieeahOS4iuS4i+aWh++8jOWcqOagoemqjOmYtuautei/h+a7pOinhOWImVxuICAgICAgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XG4gICAgfVxuXG4gICAgY29uc3QgaXNNb2RhbCA9IHRoaXMuaXNJbkRpYWxvZygpO1xuICAgIGNvbnN0IGhhc093blZlcmlmeURldGFpbFNlcnZpY2UgPSB0aGlzLmhhc093blZlcmlmeURldGFpbFNlcnZpY2UoKTtcbiAgICBsZXQgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LnJvb3Qudmlld01vZGVsO1xuICAgIGlmIChpc01vZGFsICYmIGhhc093blZlcmlmeURldGFpbFNlcnZpY2UpIHtcbiAgICAgIHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLnZpZXdNb2RlbDtcbiAgICB9XG5cbiAgICBsZXQgdG9WYWxpZGF0ZSA9IGZhbHNlO1xuICAgIGNvbnN0IGZvcm1FcnJvcnMgPSBbXTtcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICBpZiAoZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcbiAgICAgICAgdG9WYWxpZGF0ZSA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKCF0b1ZhbGlkYXRlIHx8IGVudGl0aWVzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG4gICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSBbXTtcbiAgICBsZXQgZm9ybVZhbGlkID0gdHJ1ZTtcbiAgICBsZXQgZW50aXR5VmFsaWQgPSB0cnVlO1xuICAgIGNvbnN0IGZvcm1WYWxpZGF0aW9uUnVsZXMgPSBuZXcgTWFwPHN0cmluZywgVmFsaWRhdGVSdWxlW10+KCk7XG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0T2JqZWN0KCk7XG4gICAgICAvLyDpgJrnn6XmiYDmnIliaW5kaW5nRGF0YSxcbiAgICAgIGJpbmRpbmdPYmplY3QgJiYgYmluZGluZ09iamVjdC5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcbiAgICAgIGlmIChmb3JtQ29udGV4dC5mb3JtICYmIGZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcbiAgICAgICAgLy8g6I635Y+W5b2T5YmN6KGo5Y2V5LiK55qE5omA5pyJ6aqM6K+B6KeE5YiZXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGb3JtVmFsaWRhdGlvblJ1bGVzID0gZm9ybUNvbnRleHQuZm9ybS5nZXRWYWxpZGF0aW9uUnVsZXMoKTtcbiAgICAgICAgY3VycmVudEZvcm1WYWxpZGF0aW9uUnVsZXMuZm9yRWFjaCgocnVsZXMsIHBhdGgpID0+IHtcbiAgICAgICAgICBpZiAoZm9ybVZhbGlkYXRpb25SdWxlcy5oYXMocGF0aCkpIHtcbiAgICAgICAgICAgIHJ1bGVzLmZvckVhY2gocnVsZSA9PiBmb3JtVmFsaWRhdGlvblJ1bGVzLmdldChwYXRoKS5wdXNoKHJ1bGUpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9ybVZhbGlkYXRpb25SdWxlcy5zZXQocGF0aCwgWy4uLnJ1bGVzXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZm9ybUNvbnRleHQuZm9ybS5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcbiAgICAgICAgLy8g6YCQ5Liq6LCD55So6KGo5Y2V55qE6aqM6K+B77yM6aqM6K+B5YmN56uv6KGo5Y2V6KeE5YiZXG4gICAgICAgIGlmICghZm9ybUNvbnRleHQuZm9ybS5pc0Zvcm1WYWxpZCgpKSB7XG4gICAgICAgICAgZm9ybUVycm9ycy5wdXNoKGZvcm1Db250ZXh0LmZvcm0pO1xuICAgICAgICAgIGZvcm1WYWxpZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyDpqozor4HmiYDmnInlrp7kvZNcbiAgICBjb25zdCBvYnNlcnZhYmxlTGlzdCA9IGVudGl0aWVzLm1hcCgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5nZXRJbmRleEJ5SWQoZW50aXR5LnByaW1hcnlWYWx1ZSk7XG4gICAgICByZXR1cm4gZW50aXR5LnZhbGlkYXRlKHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBmb3JtVmFsaWRhdGlvblJ1bGVzLCBudWxsLCB0aGlzLmZyYW1lQ29udGV4dCk7XG4gICAgfSk7XG4gICAgY29uc3QgcmVzdWx0JCA9IHppcCguLi5vYnNlcnZhYmxlTGlzdCkucGlwZShcbiAgICAgIHRhcCgocmVzdWx0TGlzdCkgPT4ge1xuICAgICAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZvcm1Db250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcbiAgICAgICAgICBpZiAoIWZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgaGFuZGxlRXJyb3JzID0gKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pID0+IHtcbiAgICAgICAgICAgIGVycm9ycy5mb3JFYWNoKCh2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvcikgPT4ge1xuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuICYmIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnModmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBlcnJNc2dPYmogPSB7fTtcbiAgICAgICAgICAgICAgbGV0IGlkID0gJyc7XG4gICAgICAgICAgICAgIGNvbnN0IGZpbmRJZCA9ICh0YXJnZXQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmRhdGEgJiYgdGFyZ2V0LmRhdGEuaWQpIHtcbiAgICAgICAgICAgICAgICAgIGlkID0gdGFyZ2V0LmRhdGEuaWQ7XG4gICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRbUEFSRU5UX0NMQVNTXSkge1xuICAgICAgICAgICAgICAgICAgZmluZElkKHRhcmdldFtQQVJFTlRfQ0xBU1NdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIGZpbmRJZCh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KTtcblxuICAgICAgICAgICAgICAvLyDlrp7kvZPpqozor4Hlh7rplJnvvIzpnIDopoHlsIbplJnor6/lsZXnpLrliLDnlYzpnaLkuIpcbiAgICAgICAgICAgICAgLy8g5a6e5L2T5LiN5LiA5a6a5piv5b2T5YmN6KGMXG4gICAgICAgICAgICAgIGxldCBwYXJlbnRQYXRoRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBwYXRoOiBbXSxcbiAgICAgICAgICAgICAgICBpc1VkdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBmYWxzZVxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLnRhcmdldCkge1xuICAgICAgICAgICAgICAgIHBhcmVudFBhdGhEYXRhID0gdmFsaWRhdGlvbkVycm9yLnRhcmdldC5nZXRQYXRocygpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gJy8nICsgcGFyZW50UGF0aERhdGEucGF0aC5qb2luKCcvJyk7XG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpIHtcbiAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgICAgICAgIGVyck1zZ09ialtrZXldID0ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNba2V5XVxuICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAvLyAgIHJvb3RWaWV3TW9kZWxbJ3ZlcmlmeUluZm9ybWF0aW9ucyddLnB1c2goe1xuICAgICAgICAgICAgICAgICAgLy8gICAgIGlkOiBpZCxcbiAgICAgICAgICAgICAgICAgIC8vICAgICB0aXRsZToga2V5LFxuICAgICAgICAgICAgICAgICAgLy8gICAgIG1zZzogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW2tleV0sXG4gICAgICAgICAgICAgICAgICAvLyAgICAgdHlwZTogJ3dhcm4nXG4gICAgICAgICAgICAgICAgICAvLyAgIH0pXG4gICAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY29uc3QgcGF0aHMgPSBwYXJlbnRQYXRoRGF0YS5wYXRoLmNvbmNhdCh2YWxpZGF0aW9uRXJyb3IucHJvcGVydHkpO1xuXG4gICAgICAgICAgICAgIC8vaWYgKHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGgpIHtcbiAgICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcbiAgICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcbiAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcbiAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICBwYXRoOiBwYXRocyxcbiAgICAgICAgICAgICAgICBpc1VkdDogcGFyZW50UGF0aERhdGEuaXNVZHQsXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBwYXJlbnRQYXRoRGF0YS5pc0dyaWQsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHZhbGlkYXRpb25FcnJvci52YWx1ZSxcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVyck1zZ09ialxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgLy99XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIC8vIOWxleW8gOmqjOivgee7k+aenFxuICAgICAgICAgIGNvbnN0IGlzVmFsaWRMaXN0ID0gcmVzdWx0TGlzdC5tYXAoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4gcmVzdWx0LmlzVmFsaWQpO1xuICAgICAgICAgIC8vIOS/neWtmOWJjeWFiOiwg+eUqOWunuS9k+S4iueahOmqjOivgeinhOWIme+8jOWFqOmDqOmAmui/h+S5i+WQjuaJjeS/neWtmFxuICAgICAgICAgIC8vIOWunuS9k+mqjOivgemAmui/h1xuICAgICAgICAgIGlmIChpc1ZhbGlkTGlzdC5maWx0ZXIoeCA9PiB4KS5sZW5ndGggPT09IG9ic2VydmFibGVMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcbiAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XG4gICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxuICAgICAgICAgICAgICBwYXRoOiBbXVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyDpqozor4HmiJDlip/lkI7pmpDol4/ovpPlhaXml7bnmoTpqozor4FcbiAgICAgICAgICAgIGlmIChmb3JtVmFsaWQpIHtcbiAgICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmdldE9iamVjdCgpO1xuICAgICAgICAgICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmFsc2UpO1xuICAgICAgICAgICAgICBjb25zdCBmb3JtID0gZm9ybUNvbnRleHQuZm9ybTtcbiAgICAgICAgICAgICAgaWYgKGZvcm0pIHtcbiAgICAgICAgICAgICAgICBmb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyDlrp7kvZPpqozor4HmnInplJnor69cbiAgICAgICAgICAgIGVudGl0eVZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzdWx0LmlzVmFsaWQpIHtcbiAgICAgICAgICAgICAgICAvLyDmuIXpmaTpqozor4HpgJrov4fnmoTplJnor69cbiAgICAgICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xuICAgICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXG4gICAgICAgICAgICAgICAgICBwYXRoOiBbXVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGhhbmRsZUVycm9ycyhyZXN1bHQuZXJyb3JzKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pLFxuICAgICAgc3dpdGNoTWFwKChyZXN1bHRMaXN0KSA9PiB7XG4gICAgICAgIGxldCBpc1ZhbGlkYXRlZCA9IHRydWU7XG4gICAgICAgIGNvbnN0IGVycm9ycyA9IFtdO1xuICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xuICAgICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcbiAgICAgICAgICAgIGlzVmFsaWRhdGVkID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVycm9ycy5wdXNoKC4uLnJlc3VsdC5lcnJvcnMpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhpcy5jb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsLCBlcnJvcnMsIHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8gcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQocm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMpO1xuICAgICAgICBsZXQgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnM7XG4gICAgICAgIGlmIChpc01vZGFsICYmIGhhc093blZlcmlmeURldGFpbFNlcnZpY2UpIHtcbiAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKTtcbiAgICAgICAgfVxuICAgICAgICByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xuICAgICAgICBpZiAoaXNWYWxpZGF0ZWQgJiYgIWZvcm1WYWxpZCkge1xuICAgICAgICAgIC8vIOWunuS9k+agoemqjOmAmui/h+S9huihqOWNleagoemqjOS4jemAmui/h++8jOatpOaXtuWunuS9k+WSjOihqOWNleWtmOWcqOagoemqjOinhOWImeS4jeS4gOiHtOeahOaDheWGtVxuICAgICAgICAgIGNvbnNvbGUud2Fybign5a6e5L2T5ZKM5o6n5Lu25qCh6aqM6KeE5YiZ5LiN5LiA6Ie077yM5Lya5a+86Ie05ZG95Luk5omn6KGM5Lit5pat77yBJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGlzVmFsaWRhdGVkICYmIGZvcm1WYWxpZCkge1xuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICAgIHJldHVybiByZXN1bHQkO1xuICB9XG4gIC8qKlxuICAgKiDosIPnlKjooajljZXlkozlrp7kvZPkuIrnmoTpqozor4Hop4TliJksIOmAmui/h+WQjuiwg+eUqOWbnuiwg2NiXG4gICAqL1xuICB2YWxpZGF0ZUFsbCgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIC8vIOe7hOWQiOihqOWNleWPquagoemqjOW9k+WJjeaMiemSruaJgOWcqOeahOihqOWNlVxuICAgIGNvbnN0IGVudGl0aWVzOiBFbnRpdHlbXSA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEFsbEVudGl0aWVzKCk7XG4gICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlO1xuICAgIGxldCBmcmFtZUNvbnRleHRzID0gW107XG4gICAgaWYgKG5hbWVzcGFjZSAhPT0gbnVsbCkge1xuICAgICAgLy8g5a2Y5Zyo5ZG95ZCN56m66Ze077yM6K+05piO6KGo5Y2V6L6D5paw77yM5Y+v5Lul5L6d6LWW6K+l54m55oCnXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDooajljZXovoPogIHvvIzojrflj5bmiYDmnInnmoTkuIrkuIvmlofvvIzlnKjmoKHpqozpmLbmrrXov4fmu6Top4TliJlcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xuICAgIH1cblxuICAgIGxldCB0b1ZhbGlkYXRlID0gZmFsc2U7XG4gICAgY29uc3QgZm9ybUVycm9ycyA9IFtdO1xuICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcbiAgICAgIGlmIChmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xuICAgICAgICB0b1ZhbGlkYXRlID0gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoIXRvVmFsaWRhdGUgfHwgZW50aXRpZXMubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cbiAgICBjb25zdCBpc01vZGFsID0gdGhpcy5pc0luRGlhbG9nKCk7XG4gICAgY29uc3QgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSA9IHRoaXMuaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSgpO1xuICAgIGxldCByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWw7XG4gICAgaWYgKGlzTW9kYWwgJiYgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSkge1xuICAgICAgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkudmlld01vZGVsO1xuICAgIH1cblxuICAgIGxldCBmb3JtVmFsaWQgPSB0cnVlO1xuICAgIGxldCBlbnRpdHlWYWxpZCA9IHRydWU7XG4gICAgY29uc3QgZm9ybVZhbGlkYXRpb25SdWxlcyA9IG5ldyBNYXA8c3RyaW5nLCBWYWxpZGF0ZVJ1bGVbXT4oKTtcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZvcm1Db250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcbiAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcbiAgICAgIC8vIOmAmuefpeaJgOaciWJpbmRpbmdEYXRhLFxuICAgICAgYmluZGluZ09iamVjdCAmJiBiaW5kaW5nT2JqZWN0LnNldFNob3dWYWxpZGF0aW9uTXNnKHRydWUpO1xuICAgICAgaWYgKGZvcm1Db250ZXh0LmZvcm0gJiYgZm9ybUNvbnRleHQuZm9ybS5lbmFibGVWYWxpZGF0ZSkge1xuICAgICAgICAvLyDojrflj5blvZPliY3ooajljZXkuIrnmoTmiYDmnInpqozor4Hop4TliJlcbiAgICAgICAgY29uc3QgY3VycmVudEZvcm1WYWxpZGF0aW9uUnVsZXMgPSBmb3JtQ29udGV4dC5mb3JtLmdldFZhbGlkYXRpb25SdWxlcygpO1xuICAgICAgICBjdXJyZW50Rm9ybVZhbGlkYXRpb25SdWxlcy5mb3JFYWNoKChydWxlcywgcGF0aCkgPT4ge1xuICAgICAgICAgIGlmIChmb3JtVmFsaWRhdGlvblJ1bGVzLmhhcyhwYXRoKSkge1xuICAgICAgICAgICAgcnVsZXMuZm9yRWFjaChydWxlID0+IGZvcm1WYWxpZGF0aW9uUnVsZXMuZ2V0KHBhdGgpLnB1c2gocnVsZSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmb3JtVmFsaWRhdGlvblJ1bGVzLnNldChwYXRoLCBbLi4ucnVsZXNdKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBmb3JtQ29udGV4dC5mb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKHRydWUpO1xuICAgICAgICAvLyDpgJDkuKrosIPnlKjooajljZXnmoTpqozor4HvvIzpqozor4HliY3nq6/ooajljZXop4TliJlcbiAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmlzRm9ybVZhbGlkKCkpIHtcbiAgICAgICAgICBmb3JtRXJyb3JzLnB1c2goZm9ybUNvbnRleHQuZm9ybSk7XG4gICAgICAgICAgZm9ybVZhbGlkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICAvLyDop6blj5HmiYDmnInlrp7kvZPnmoR2YWxpZGF0ZeS6i+S7tlxuICAgIGNvbnN0IGlzTXVsdGlFbnRpdHlWYWxpYXRlID0gZW50aXRpZXMubGVuZ3RoID4gMDtcblxuICAgIC8vIOmqjOivgeaJgOacieWunuS9k1xuICAgIGNvbnN0IG9ic2VydmFibGVMaXN0ID0gZW50aXRpZXMubWFwKChlbnRpdHk6IEVudGl0eSwgaW5kZXg6IG51bWJlcikgPT5cbiAgICAgIGVudGl0eS52YWxpZGF0ZSh1bmRlZmluZWQsIHVuZGVmaW5lZCwgZm9ybVZhbGlkYXRpb25SdWxlcywgaXNNdWx0aUVudGl0eVZhbGlhdGUgPyBpbmRleCA6IG51bGwsIHRoaXMuZnJhbWVDb250ZXh0KSk7XG4gICAgY29uc3QgcmVzdWx0JCA9IHppcCguLi5vYnNlcnZhYmxlTGlzdCkucGlwZShcbiAgICAgIHRhcCgocmVzdWx0TGlzdCkgPT4ge1xuICAgICAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZvcm1Db250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcbiAgICAgICAgICBpZiAoIWZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgaGFuZGxlRXJyb3JzID0gKGVycm9yczogVmFsaWRhdGlvbkVycm9yW10pID0+IHtcbiAgICAgICAgICAgIGVycm9ycy5mb3JFYWNoKCh2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvcikgPT4ge1xuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuICYmIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnModmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBlcnJNc2dPYmogPSB7fTtcbiAgICAgICAgICAgICAgbGV0IGlkID0gJyc7XG4gICAgICAgICAgICAgIGNvbnN0IGZpbmRJZCA9ICh0YXJnZXQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmRhdGEgJiYgdGFyZ2V0LmRhdGEuaWQpIHtcbiAgICAgICAgICAgICAgICAgIGlkID0gdGFyZ2V0LmRhdGEuaWQ7XG4gICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRbUEFSRU5UX0NMQVNTXSkge1xuICAgICAgICAgICAgICAgICAgZmluZElkKHRhcmdldFtQQVJFTlRfQ0xBU1NdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgIGZpbmRJZCh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KTtcblxuICAgICAgICAgICAgICAvLyDlrp7kvZPpqozor4Hlh7rplJnvvIzpnIDopoHlsIbplJnor6/lsZXnpLrliLDnlYzpnaLkuIpcbiAgICAgICAgICAgICAgLy8g5a6e5L2T5LiN5LiA5a6a5piv5b2T5YmN6KGMXG4gICAgICAgICAgICAgIGxldCBwYXJlbnRQYXRoRGF0YSA9IHtcbiAgICAgICAgICAgICAgICBwYXRoOiBbXSxcbiAgICAgICAgICAgICAgICBpc1VkdDogZmFsc2UsXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBmYWxzZVxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLnRhcmdldCkge1xuICAgICAgICAgICAgICAgIHBhcmVudFBhdGhEYXRhID0gdmFsaWRhdGlvbkVycm9yLnRhcmdldC5nZXRQYXRocygpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gJy8nICsgcGFyZW50UGF0aERhdGEucGF0aC5qb2luKCcvJyk7XG4gICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpIHtcbiAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgICAgICAgIGVyck1zZ09ialtrZXldID0ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNba2V5XVxuICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgIC8vIGlmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAvLyAgIHJvb3RWaWV3TW9kZWxbJ3ZlcmlmeUluZm9ybWF0aW9ucyddLnB1c2goe1xuICAgICAgICAgICAgICAgICAgLy8gICAgIGlkOiBpZCxcbiAgICAgICAgICAgICAgICAgIC8vICAgICB0aXRsZToga2V5LFxuICAgICAgICAgICAgICAgICAgLy8gICAgIG1zZzogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW2tleV0sXG4gICAgICAgICAgICAgICAgICAvLyAgICAgdHlwZTogJ3dhcm4nXG4gICAgICAgICAgICAgICAgICAvLyAgIH0pXG4gICAgICAgICAgICAgICAgICAvLyB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY29uc3QgcGF0aHMgPSBwYXJlbnRQYXRoRGF0YS5wYXRoLmNvbmNhdCh2YWxpZGF0aW9uRXJyb3IucHJvcGVydHkpO1xuXG4gICAgICAgICAgICAgIC8vaWYgKHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gYmluZGluZ1BhdGgpIHtcbiAgICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcbiAgICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcbiAgICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcbiAgICAgICAgICAgICAgICBpZCxcbiAgICAgICAgICAgICAgICBwYXRoOiBwYXRocyxcbiAgICAgICAgICAgICAgICBpc1VkdDogcGFyZW50UGF0aERhdGEuaXNVZHQsXG4gICAgICAgICAgICAgICAgaXNHcmlkOiBwYXJlbnRQYXRoRGF0YS5pc0dyaWQsXG4gICAgICAgICAgICAgICAgdmFsdWU6IHZhbGlkYXRpb25FcnJvci52YWx1ZSxcbiAgICAgICAgICAgICAgICBlcnJvcnM6IGVyck1zZ09ialxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgLy99XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIC8vIOWxleW8gOmqjOivgee7k+aenFxuICAgICAgICAgIGNvbnN0IGlzVmFsaWRMaXN0ID0gcmVzdWx0TGlzdC5tYXAoKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4gcmVzdWx0LmlzVmFsaWQpO1xuICAgICAgICAgIC8vIOS/neWtmOWJjeWFiOiwg+eUqOWunuS9k+S4iueahOmqjOivgeinhOWIme+8jOWFqOmDqOmAmui/h+S5i+WQjuaJjeS/neWtmFxuICAgICAgICAgIC8vIOWunuS9k+mqjOivgemAmui/h1xuICAgICAgICAgIGlmIChpc1ZhbGlkTGlzdC5maWx0ZXIoeCA9PiB4KS5sZW5ndGggPT09IG9ic2VydmFibGVMaXN0Lmxlbmd0aCkge1xuICAgICAgICAgICAgLy8g5bCG6ZSZ6K+v5L+h5oGv5pu05paw5YiwZm9ybUNvbnRyb2zkuIpcbiAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XG4gICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxuICAgICAgICAgICAgICBwYXRoOiBbXVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAvLyDpqozor4HmiJDlip/lkI7pmpDol4/ovpPlhaXml7bnmoTpqozor4FcbiAgICAgICAgICAgIGlmIChmb3JtVmFsaWQpIHtcbiAgICAgICAgICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmdldE9iamVjdCgpO1xuICAgICAgICAgICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmFsc2UpO1xuICAgICAgICAgICAgICBjb25zdCBmb3JtID0gZm9ybUNvbnRleHQuZm9ybTtcbiAgICAgICAgICAgICAgaWYgKGZvcm0pIHtcbiAgICAgICAgICAgICAgICBmb3JtLnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyDlrp7kvZPpqozor4HmnInplJnor69cbiAgICAgICAgICAgIGVudGl0eVZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzdWx0LmlzVmFsaWQpIHtcbiAgICAgICAgICAgICAgICAvLyDmuIXpmaTpqozor4HpgJrov4fnmoTplJnor69cbiAgICAgICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xuICAgICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXG4gICAgICAgICAgICAgICAgICBwYXRoOiBbXVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGhhbmRsZUVycm9ycyhyZXN1bHQuZXJyb3JzKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pLFxuICAgICAgc3dpdGNoTWFwKChyZXN1bHRMaXN0KSA9PiB7XG4gICAgICAgIGxldCBpc1ZhbGlkYXRlZCA9IHRydWU7XG4gICAgICAgIGNvbnN0IGVycm9ycyA9IFtdO1xuICAgICAgICByZXN1bHRMaXN0LmZvckVhY2goKHJlc3VsdDogVmFsaWRhdGlvblJlc3VsdCkgPT4ge1xuICAgICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcbiAgICAgICAgICAgIGlzVmFsaWRhdGVkID0gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGVycm9ycy5wdXNoKC4uLnJlc3VsdC5lcnJvcnMpO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdGhpcy5jb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsLCBlcnJvcnMsIHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZSk7XG4gICAgICAgIH1cbiAgICAgICAgbGV0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zO1xuICAgICAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5Zug5Li65qCh6aqM57Sv5Yqg55qE57yY5pWF77yM5a+86Ie05LmL5YmN55qE5qCh6aqM5L+h5oGv5LiA55u05a2Y5Zyo77yM5Y+q6IO96YCa6L+H5qCh6aqM57uT5p6c5p2l56Gu5a6a5piv5ZCm6L+Y5pyJ6ZSZ6K+v5L+h5oGvXG4gICAgICAgIGlmIChpc1ZhbGlkYXRlZCAmJiBmb3JtVmFsaWQpIHtcbiAgICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucyA9IFtdO1xuICAgICAgICB9XG4gICAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHZlcmlmeUluZm9ybWF0aW9ucyk7XG4gICAgICAgIGlmIChpc1ZhbGlkYXRlZCAmJiBmb3JtVmFsaWQpIHtcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gcmVzdWx0JDtcbiAgfVxuICAvKipcbiAgICog5qCh6aqM5a6e5L2T5piv5ZCm5ruh6Laz5LiN6IO95Li656m655qE6KeE5YiZXG4gICAqIEBwYXJhbSBlbnRpdHkg5Li75a6e5L2TXG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlRW50aXR5QWxsb3dFbXB0eVJ1bGUoZW50aXR5OiBFbnRpdHksIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pIHtcbiAgICAvLyDnoa7orqTlrp7kvZPlkITkuKrlsYLnuqfkuK3mmK/lkKblrZjlnKjkuI3og73kuLrnqbrnmoTop4TliJlcbiAgICBjb25zdCBwYXRocyA9IHRoaXMuZ2V0Tm90QWxsb3dFbXB0eUJpbmRpbmdQYXRocyhlbnRpdHlUeXBlSW5mbyk7XG4gICAgaWYgKCFwYXRocyB8fCBwYXRocy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgLy8g5om+5Yiw5omA5pyJ5LiN5ZCI5rOV55qEYmluZGluZ1BhdGhzXG4gICAgY29uc3QgaW52YWxpZFBhdGhzID0gcGF0aHMuZmlsdGVyKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgIGlmICghYmluZGluZ0xpc3QgfHwgYmluZGluZ0xpc3QubGVuZ3RoIDwgMSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9KTtcbiAgICBpZiAoaW52YWxpZFBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHRhYmxlTmFtZXMgPSBbXTtcbiAgICAgIGludmFsaWRQYXRocy5mb3JFYWNoKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgY29uc3Qgdmlld01vZGVsTmFtZSA9IHRoaXMuZ2V0Vmlld01vZGVsTmFtZUJ5QmluZGluZ1BhdGhzKHBhdGguc3BsaXQoJy8nKSk7XG4gICAgICAgIHRhYmxlTmFtZXMucHVzaCh2aWV3TW9kZWxOYW1lKTtcbiAgICAgIH0pO1xuICAgICAgaWYgKHRoaXMubm90aWZ5U2VydmljZSkge1xuICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2UuZXJyb3IoYCR7dGFibGVOYW1lcy5qb2luKCfvvIwnKX0gJHt0aGlzLmxhbmd1YWdlU2VydmljZS50YWJsZUNhbk5vdEVtcHR5fWAsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aHMgcGF0aOS4jeiDveS4uuepuuaIli/vvIzkuI3mlK/mjIHkuLvooahcbiAgICovXG4gIHByaXZhdGUgZ2V0Vmlld01vZGVsTmFtZUJ5QmluZGluZ1BhdGhzKGJpbmRpbmdQYXRoczogc3RyaW5nW10pIHtcbiAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XG4gICAgbGV0IGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdID0gbnVsbDtcbiAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XG4gICAgICAvLyDlrZjlnKjlkb3lkI3nqbrpl7TvvIzor7TmmI7ooajljZXovoPmlrDvvIzlj6/ku6Xkvp3otZbor6XnibnmgKdcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0c0J5TmFtZXNwYWNlKG5hbWVzcGFjZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIOihqOWNlei+g+iAge+8jOiOt+WPluaJgOacieeahOS4iuS4i+aWh++8jOWcqOagoemqjOmYtuautei/h+a7pOinhOWImVxuICAgICAgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XG4gICAgfVxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGhzLmZpbHRlcihwID0+IHApLmpvaW4oJy8nKTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHRzLmZpbmQoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5qb2luKCcvJykgPT09IGJpbmRpbmdQYXRoKTtcbiAgICBjb25zdCB2aWV3TW9kZWxOYW1lID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLmZvcm1Hcm91cE5hbWUgfHwgJyc7XG4gICAgcmV0dXJuIHZpZXdNb2RlbE5hbWU7XG4gIH1cbiAgcHJpdmF0ZSBnZXROb3RBbGxvd0VtcHR5QmluZGluZ1BhdGhzKGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCFlbnRpdHlUeXBlSW5mbykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgY29uc3QgcGF0aHMgPSBbXTtcbiAgICB0aGlzLmRlZXBGaXJzdFRyYXZlcnNhbEVudGl0eVR5cGVJbmZvKGVudGl0eVR5cGVJbmZvLCBwYXRocyk7XG4gICAgcmV0dXJuIHBhdGhzO1xuICB9XG4gIHByaXZhdGUgZGVlcEZpcnN0VHJhdmVyc2FsRW50aXR5VHlwZUluZm8oZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbywgcmVzdWx0OiBzdHJpbmdbXSA9IFtdLCBwcmV2aW91c1ZhbHVlOiBzdHJpbmdbXSA9IFtdKSB7XG4gICAgY29uc3QgbGlzdCA9IGVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvc0J5R3JvdXAoRGF0YVByb3BHcm91cC5MaXN0KTtcbiAgICBpZiAobGlzdCAmJiBsaXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgIGxpc3QuZm9yRWFjaCgocHJvcEluZm86IERhdGFQcm9wSW5mbykgPT4ge1xuICAgICAgICBjb25zdCB0eXBlSW5mbyA9IHByb3BJbmZvLnR5cGVJbmZvO1xuICAgICAgICBpZiAodHlwZUluZm8gJiYgdHlwZUluZm8uZW50aXR5SW5mbyAmJiB0eXBlSW5mby5lbnRpdHlJbmZvLmFsbG93RW1wdHkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgcHJldmlvdXNWYWx1ZS5wdXNoKHR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUpO1xuICAgICAgICAgIHRoaXMuZGVlcEZpcnN0VHJhdmVyc2FsRW50aXR5VHlwZUluZm8odHlwZUluZm8sIHJlc3VsdCwgcHJldmlvdXNWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyDmsqHmnInkuIvnuqfkuobvvIzmraTml7blupTor6XmuIXnqbrmuLjmoIfvvIzlsIbmlLbpm4bliLDnmoTot6/lvoTmlL7liLDnu5Pmnpzpm4bkuK1cbiAgICBpZiAocHJldmlvdXNWYWx1ZSAmJiBwcmV2aW91c1ZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHBhdGhzID0gcHJldmlvdXNWYWx1ZS5qb2luKCcvJyk7XG4gICAgICByZXN1bHQucHVzaChwYXRocyk7XG4gICAgfVxuICAgIHByZXZpb3VzVmFsdWUuc3BsaWNlKDAsIHByZXZpb3VzVmFsdWUubGVuZ3RoKTtcbiAgfVxuICBjb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsOiBWaWV3TW9kZWwsIGVycm9yczogVmFsaWRhdGlvbkVycm9yW10sIG5hbWVzcGFjZTogc3RyaW5nLCBmaWx0ZXI6IGJvb2xlYW4gPSB0cnVlKSB7XG4gICAgaWYgKGZpbHRlcikge1xuICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSAhPT0gbmFtZXNwYWNlKTtcbiAgICB9XG4gICAgZXJyb3JzLmZvckVhY2goKHZhbGlkYXRpb25FcnJvcjogVmFsaWRhdGlvbkVycm9yKSA9PiB7XG4gICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuICYmIHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbi5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5jb2xsZWN0VmFsaWRhdGlvbkVycm9ycyhyb290Vmlld01vZGVsLCB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4sIG5hbWVzcGFjZSwgZmFsc2UpO1xuICAgICAgfVxuICAgICAgbGV0IGlkID0gJyc7XG4gICAgICBjb25zdCBmaW5kSWQgPSAodGFyZ2V0OiBhbnkpID0+IHtcbiAgICAgICAgaWYgKHRhcmdldCAmJiB0YXJnZXQuZGF0YSAmJiB0YXJnZXQuZGF0YS5pZCkge1xuICAgICAgICAgIGlkID0gdGFyZ2V0LmRhdGEuaWQ7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9IGVsc2UgaWYgKHRhcmdldFtQQVJFTlRfQ0xBU1NdKSB7XG4gICAgICAgICAgZmluZElkKHRhcmdldFtQQVJFTlRfQ0xBU1NdKTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIGZpbmRJZCh2YWxpZGF0aW9uRXJyb3IudGFyZ2V0KTtcbiAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHMpIHtcbiAgICAgICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdFR5cGVzID0gT2JqZWN0LmtleXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKTtcbiAgICAgICAgaWYgKHZhbGlkYXRpb25SZXN1bHRUeXBlcy5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCBvZmZzZXQgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSA9PT0gbmFtZXNwYWNlKS5sZW5ndGg7XG4gICAgICAgICAgbGV0IGluZGV4ID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmluZEluZGV4KGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSk7XG4gICAgICAgICAgaW5kZXggPSBpbmRleCA9PT0gLTEgPyAwIDogaW5kZXggKyBvZmZzZXQ7XG4gICAgICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuc3BsaWNlKGluZGV4LCAwLCB7XG4gICAgICAgICAgICBpZDogaWQsXG4gICAgICAgICAgICBuYW1lc3BhY2UsXG4gICAgICAgICAgICB0YXJnZXRGaWVsZDogdmFsaWRhdGlvbkVycm9yLmZpZWxkLFxuICAgICAgICAgICAgaW5kZXg6IHZhbGlkYXRpb25FcnJvci5pbmRleCxcbiAgICAgICAgICAgIHRpdGxlOiB2YWxpZGF0aW9uRXJyb3IucHJvcGVydHlOYW1lLFxuICAgICAgICAgICAgbXNnOiB2YWxpZGF0aW9uRXJyb3IuY29uc3RyYWludHNbdmFsaWRhdGlvblJlc3VsdFR5cGVzWzBdXSxcbiAgICAgICAgICAgIGZyYW1lQ29udGV4dDogdmFsaWRhdGlvbkVycm9yLmZyYW1lQ29udGV4dCxcbiAgICAgICAgICAgIGZ1bGxQYXRoOiB2YWxpZGF0aW9uRXJyb3IuZnVsbFBhdGgsXG4gICAgICAgICAgICB0eXBlOiB2YWxpZGF0aW9uUmVzdWx0VHlwZXNbMF0gPT09ICdyZXF1aXJlZCcgPyAnZW1wdHknIDogJ2Vycm9yJ1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbiAgLyoqXG4gICAqIOmHjee9ruagoemqjOS/oeaBr++8iOS7heW9k+WJjeihqOWNle+8iVxuICAgKi9cbiAgcHVibGljIHJlc2V0VmFsaWRhdGlvbigpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGlzRGlhbG9nID0gdGhpcy5pc0luRGlhbG9nKCk7XG4gICAgbGV0IHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5yb290LnZpZXdNb2RlbDtcbiAgICBpZiAoaXNEaWFsb2cpIHtcbiAgICAgIHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLnZpZXdNb2RlbDtcbiAgICB9XG4gICAgbGV0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zO1xuICAgIGlmICh2ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoKSB7XG4gICAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XG4gICAgICBpZiAobmFtZXNwYWNlICE9PSBudWxsKSB7XG4gICAgICAgIHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0ubmFtZXNwYWNlICE9PSBuYW1lc3BhY2UpO1xuICAgICAgfVxuICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSB2ZXJpZnlJbmZvcm1hdGlvbnM7XG4gICAgICAvL3Jvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLnNwbGljZSgwLCByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5sZW5ndGgpO1xuICAgIH1cbiAgICBpZiAocm9vdFZpZXdNb2RlbCAmJiByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQpIHtcbiAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHZlcmlmeUluZm9ybWF0aW9ucyk7XG4gICAgfVxuICAgIHJldHVybiBvZihudWxsKTtcbiAgfVxuICAvKipcbiAgICog5piv5ZCm5Zyo5by556qX5YaF6YOoXG4gICAqL1xuICBwcml2YXRlIGlzSW5EaWFsb2coKSB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkgJiYgdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5mcmFtZUNvbXBvbmVudCAmJiB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmZyYW1lQ29tcG9uZW50Wydpc0RpYWxvZ1Jvb3RDb21wb25lbnQnXSB8fCBmYWxzZTtcbiAgfVxuICAvKipcbiAgICog5oul5pyJ54us6Ieq55qE5qCh6aqM5o+Q56S65pyN5YqhXG4gICAqL1xuICBwcml2YXRlIGhhc093blZlcmlmeURldGFpbFNlcnZpY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxWZXJpZnlEZXRhaWxTZXJ2aWNlPihWZXJpZnlEZXRhaWxTZXJ2aWNlLCBudWxsKSAhPT0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC5hcHBDb250ZXh0LmluamVjdG9yLmdldDxWZXJpZnlEZXRhaWxTZXJ2aWNlPihWZXJpZnlEZXRhaWxTZXJ2aWNlLCBudWxsKTs7XG4gIH1cbn1cblxuZXhwb3J0IHsgVmFsaWRhdGlvblNlcnZpY2UgfTtcbiJdfQ==