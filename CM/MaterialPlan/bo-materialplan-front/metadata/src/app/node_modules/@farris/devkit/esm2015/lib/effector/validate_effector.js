import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext } from '../frame/frame_context';
import { MESSAGE_SERVICE_TOKEN, NOTIFY_SERVICE_TOKEN, ComponentType } from '../core/index';
import { NAMESPACE } from '../frame/tokens';
export class ValidateEffector {
    constructor(injector, messageService, notifyService, namespace, frameContext) {
        this.injector = injector;
        this.messageService = messageService;
        this.notifyService = notifyService;
        this.namespace = namespace;
        this.frameContext = frameContext;
        this.ns = namespace;
    }
    effect(path, value, options) {
        // 校验不通过时返回false
        const domInfo = this.getDomInfoByEntityPath(path);
        if (!domInfo) {
            return;
        }
        const frameContext = domInfo.frameContext;
        const rootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        // const rootViewModel = rootFrameContext.viewModel;
        const expressionId = options.expressionId;
        const domPropertyName = domInfo.domPropertyName;
        if (expressionId) {
            // 增加校验规则
            frameContext.form.addFieldValidateRule(domPropertyName, options.message, expressionId, "validate" /* Validate */);
        }
        if (value === false && options.message) {
            // 更新form错误信息
            // 不是grid，则认为是卡片
            if (!domInfo.isGridComponent) {
                const message = options.message.replace(/\$property/g, domInfo.propertyName);
                const formErrors = this.buildFormErrors(domPropertyName, message);
                // // 只增加校验规则，不立即显示校验信息，否则页面加载后在非编辑态就会显示校验信息
                frameContext.form.updateFormErrors(formErrors);
            }
            else {
                // if (expressionId) {
                //   // 增加校验规则
                //   frameContext.form.addFieldValidateRule(domPropertyName, options.message, expressionId, RuleType.Validate);
                // }
            }
            // 不进行汇总展示
            // const verifyInformations = this.buildVerifyInformations(domInfo.id, frameContext, domInfo.domPropertyName, options.message);
            // 增加到汇总消息
            // rootViewModel.verifycationChanged.next(verifyInformations);
            // 更新汇总错误信息
        }
        else if (value === true) {
            // 移除错误消息
            // const verifyInformations = this.removeValidateVerifyInformations(domInfo.id, this.frameContext);
            // rootViewModel.verifycationChanged.next(verifyInformations);
            const currentErrors = frameContext.form.getFormControlErrors(domPropertyName) || null;
            if (currentErrors) {
                if (currentErrors.hasOwnProperty('validate')) {
                    // require合法，移除require校验提示
                    delete currentErrors.validate;
                }
                frameContext.form.updateFormErrors({ [domPropertyName]: { errors: currentErrors } });
            }
            else {
                const formErrors = this.buildFormErrors(domPropertyName, null);
                frameContext.form.updateFormErrors(formErrors);
            }
        }
    }
    /**
     * 通过实体路径获取对应的dom信息
     * @param entityPath
     * @returns
     */
    getDomInfoByEntityPath(entityPath) {
        let result = null;
        if (!entityPath) {
            return result;
        }
        entityPath = entityPath.split('/').filter(p => p).join('.');
        const frameContexts = this.frameContext && this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || null;
        if (frameContexts && frameContexts.length > 0) {
            for (const frameContext of frameContexts) {
                if (result) {
                    break;
                }
                const isValidFrameContext = frameContext && frameContext.form && frameContext.form.ngFormControls && Object.keys(frameContext.form.ngFormControls).length > 0;
                if (frameContext && frameContext.form && frameContext.form.ngFormControls && Object.keys(frameContext.form.ngFormControls).length > 0) {
                    const keys = Object.keys(frameContext.form.ngFormControls);
                    for (const propertyName of keys) {
                        const ngFormControl = frameContext.form.ngFormControls[propertyName];
                        let bindingPath = frameContext.viewModel.bindingPath || '/';
                        const bindingPaths = bindingPath.split('/').filter(p => p);
                        let bindings = ngFormControl.binding.split('.');
                        bindings = bindingPaths.concat(bindings);
                        if (entityPath === bindings.join('.')) {
                            // 判断对应的组件是什么类型
                            const dgColumnNames = frameContext.viewModel['dataGridColumnsName'] || null;
                            const dgColumnInfo = frameContext.viewModel[dgColumnNames] || null;
                            if (dgColumnInfo && Array.isArray(dgColumnInfo) && dgColumnInfo.length > 0) {
                                const isEditableGrid = dgColumnInfo.find((array) => {
                                    const readonlyGroup = array.every((column) => !(column.hasOwnProperty('editor') && column.editor));
                                    if (!readonlyGroup) {
                                        return true;
                                    }
                                    else {
                                        return false;
                                    }
                                });
                                if (!isEditableGrid) {
                                    continue;
                                }
                            }
                            // 如果是farris树，则跳过
                            const isFarrisTreeTableComponent = frameContext && frameContext.frameComponent && frameContext.frameComponent.componentType === ComponentType.farrisTreeTalbeComponent;
                            if (isFarrisTreeTableComponent) {
                                continue;
                            }
                            let isGridComponent = false;
                            if (dgColumnNames) {
                                isGridComponent = true;
                            }
                            result = {
                                domPropertyName: propertyName,
                                propertyName: ngFormControl.name || ngFormControl.defaultI18nValue,
                                frameContext,
                                id: ngFormControl.id,
                                isGridComponent
                            };
                            break;
                        }
                    }
                }
            }
        }
        return result;
    }
    getVerifyInformations(frameContext) {
        const rootFrameContext = frameContext && frameContext.getVirtualRootFrameContext();
        const rootViewModel = rootFrameContext.viewModel;
        const verifyInformations = rootViewModel.verifyInformations;
        return verifyInformations;
    }
    buildFormErrors(domPropertyName, message) {
        if (message) {
            message = message.replace(/\$property/g, 'domPropertyName');
            return {
                [domPropertyName]: {
                    errors: {
                        'validate': {
                            name: message
                        }
                    }
                }
            };
        }
        else {
            return {
                [domPropertyName]: {
                    errors: {}
                }
            };
        }
    }
    buildVerifyInformations(id, frameContext, domPropertyName, message) {
        const verifyInformations = this.getVerifyInformations(frameContext);
        const index = verifyInformations.findIndex((item) => {
            return item.id === id;
        });
        if (index !== -1) {
            verifyInformations.splice(index, 1);
        }
        verifyInformations.push({
            id: id,
            namespace: frameContext.namespace,
            targetField: domPropertyName,
            index: verifyInformations.length + 1,
            title: frameContext.form.formGroupName,
            msg: message,
            type: 'error'
        });
        return verifyInformations;
    }
    removeValidateVerifyInformations(id, frameContext) {
        const verifyInformations = this.getVerifyInformations(frameContext);
        const index = verifyInformations.findIndex((item) => {
            return item.id === id;
        });
        if (index !== -1) {
            verifyInformations.splice(index, 1);
        }
        return verifyInformations;
    }
}
ValidateEffector.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ValidateEffector.ctorParameters = () => [
    { type: Injector },
    { type: undefined, decorators: [{ type: Inject, args: [MESSAGE_SERVICE_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NOTIFY_SERVICE_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] },
    { type: FrameContext }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGVfZWZmZWN0b3IuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2RldmtpdC8iLCJzb3VyY2VzIjpbImxpYi9lZmZlY3Rvci92YWxpZGF0ZV9lZmZlY3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFN0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxvQkFBb0IsRUFBbUMsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzVILE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUc1QyxNQUFNLE9BQU8sZ0JBQWdCO0lBRTNCLFlBQ1UsUUFBa0IsRUFDYSxjQUErQixFQUNoQyxhQUE2QixFQUN4QyxTQUFTLEVBQzVCLFlBQTBCO1FBSjFCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDYSxtQkFBYyxHQUFkLGNBQWMsQ0FBaUI7UUFDaEMsa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQ3hDLGNBQVMsR0FBVCxTQUFTLENBQUE7UUFDNUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFFbEMsSUFBSSxDQUFDLEVBQUUsR0FBRyxTQUFTLENBQUM7SUFDdEIsQ0FBQztJQUNNLE1BQU0sQ0FBQyxJQUFZLEVBQUUsS0FBVSxFQUFFLE9BQWlDO1FBQ3ZFLGdCQUFnQjtRQUNoQixNQUFNLE9BQU8sR0FBUSxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU87U0FDUjtRQUNELE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDMUMsTUFBTSxnQkFBZ0IsR0FBRyxZQUFZLElBQUksWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUM7UUFDbkYsb0RBQW9EO1FBQ3BE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QVMsRUFBRSxZQUFZLENBQUMsU0FBUztZQUNqQyxXQUFXLEVBQUUsZUFBZTtZQUM1QixLQUFLLEVBQUUsa0JBQWtCLENBQUMsTUFBTSxHQUFHLENBQUM7WUFDcEMsS0FBSyxFQUFFLFlBQVksQ0FBQyxJQUFJLENBQUMsYUFBYTtZQUN0QyxHQUFHLEVBQUUsT0FBTztZQUNaLElBQUksRUFBRSxPQUFPO1NBQ2QsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBQ08sZ0NBQWdDLENBQUMsRUFBVSxFQUFFLFlBQTBCO1FBQzdFLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sS0FBSyxHQUFHLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFO1lBQ3ZELE9BQU8sSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUE7UUFDdkIsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsRUFBRTtZQUNoQixrQkFBa0IsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ3JDO1FBQ0QsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDOzs7WUF6TEYsVUFBVTs7OztZQVJrQixRQUFROzRDQWFoQyxNQUFNLFNBQUMscUJBQXFCOzRDQUM1QixNQUFNLFNBQUMsb0JBQW9COzRDQUMzQixNQUFNLFNBQUMsU0FBUztZQWJaLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0IH0gZnJvbSAnLi4vZnJhbWUvZnJhbWVfY29udGV4dCc7XHJcbmltcG9ydCB7IE1FU1NBR0VfU0VSVklDRV9UT0tFTiwgTk9USUZZX1NFUlZJQ0VfVE9LRU4sIElNZXNzYWdlU2VydmljZSwgSU5vdGlmeVNlcnZpY2UsIENvbXBvbmVudFR5cGUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcclxuaW1wb3J0IHsgTmdGb3JtQ29udHJvbCB9IGZyb20gJy4uL2Zvcm0vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IFJ1bGVUeXBlIH0gZnJvbSAnLi4vZm9ybS9pbmRleCc7XHJcbmltcG9ydCB7IE5BTUVTUEFDRSB9IGZyb20gJy4uL2ZyYW1lL3Rva2Vucyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBWYWxpZGF0ZUVmZmVjdG9yIGltcGxlbWVudHMgRXhwcmVzc2lvbi5FZmZlY3RvciB7XHJcbiAgcHVibGljIG5zOiBzdHJpbmc7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIEBJbmplY3QoTUVTU0FHRV9TRVJWSUNFX1RPS0VOKSBwcml2YXRlIG1lc3NhZ2VTZXJ2aWNlOiBJTWVzc2FnZVNlcnZpY2UsXHJcbiAgICBASW5qZWN0KE5PVElGWV9TRVJWSUNFX1RPS0VOKSBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IElOb3RpZnlTZXJ2aWNlLFxyXG4gICAgQEluamVjdChOQU1FU1BBQ0UpIHByaXZhdGUgbmFtZXNwYWNlLFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dFxyXG4gICkge1xyXG4gICAgdGhpcy5ucyA9IG5hbWVzcGFjZTtcclxuICB9XHJcbiAgcHVibGljIGVmZmVjdChwYXRoOiBzdHJpbmcsIHZhbHVlOiBhbnksIG9wdGlvbnM6IEV4cHJlc3Npb24uRWZmZWN0T3B0aW9ucykge1xyXG4gICAgLy8g5qCh6aqM5LiN6YCa6L+H5pe26L+U5ZueZmFsc2VcclxuICAgIGNvbnN0IGRvbUluZm86IGFueSA9IHRoaXMuZ2V0RG9tSW5mb0J5RW50aXR5UGF0aChwYXRoKTtcclxuICAgIGlmICghZG9tSW5mbykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBkb21JbmZvLmZyYW1lQ29udGV4dDtcclxuICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICAvLyBjb25zdCByb290Vmlld01vZGVsID0gcm9vdEZyYW1lQ29udGV4dC52aWV3TW9kZWw7XHJcbiAgICBjb25zdCBleHByZXNzaW9uSWQgPSBvcHRpb25zLmV4cHJlc3Npb25JZDtcclxuICAgIGNvbnN0IGRvbVByb3BlcnR5TmFtZSA9IGRvbUluZm8uZG9tUHJvcGVydHlOYW1lO1xyXG4gICAgaWYgKGV4cHJlc3Npb25JZCkge1xyXG4gICAgICAvLyDlop7liqDmoKHpqozop4TliJlcclxuICAgICAgZnJhbWVDb250ZXh0LmZvcm0uYWRkRmllbGRWYWxpZGF0ZVJ1bGUoZG9tUHJvcGVydHlOYW1lLCBvcHRpb25zLm1lc3NhZ2UsIGV4cHJlc3Npb25JZCwgUnVsZVR5cGUuVmFsaWRhdGUpO1xyXG4gICAgfVxyXG4gICAgaWYgKHZhbHVlID09PSBmYWxzZSAmJiBvcHRpb25zLm1lc3NhZ2UpIHtcclxuICAgICAgLy8g5pu05pawZm9ybemUmeivr+S/oeaBr1xyXG4gICAgICAvLyDkuI3mmK9ncmlk77yM5YiZ6K6k5Li65piv5Y2h54mHXHJcbiAgICAgIGlmICghZG9tSW5mby5pc0dyaWRDb21wb25lbnQpIHtcclxuICAgICAgICBjb25zdCBtZXNzYWdlID0gb3B0aW9ucy5tZXNzYWdlLnJlcGxhY2UoL1xcJHByb3BlcnR5L2csIGRvbUluZm8ucHJvcGVydHlOYW1lKVxyXG4gICAgICAgIGNvbnN0IGZvcm1FcnJvcnMgPSB0aGlzLmJ1aWxkRm9ybUVycm9ycyhkb21Qcm9wZXJ0eU5hbWUsIG1lc3NhZ2UpO1xyXG4gICAgICAgIC8vIC8vIOWPquWinuWKoOagoemqjOinhOWIme+8jOS4jeeri+WNs+aYvuekuuagoemqjOS/oeaBr++8jOWQpuWImemhtemdouWKoOi9veWQjuWcqOmdnue8lui+keaAgeWwseS8muaYvuekuuagoemqjOS/oeaBr1xyXG4gICAgICAgIGZyYW1lQ29udGV4dC5mb3JtLnVwZGF0ZUZvcm1FcnJvcnMoZm9ybUVycm9ycyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gaWYgKGV4cHJlc3Npb25JZCkge1xyXG4gICAgICAgIC8vICAgLy8g5aKe5Yqg5qCh6aqM6KeE5YiZXHJcbiAgICAgICAgLy8gICBmcmFtZUNvbnRleHQuZm9ybS5hZGRGaWVsZFZhbGlkYXRlUnVsZShkb21Qcm9wZXJ0eU5hbWUsIG9wdGlvbnMubWVzc2FnZSwgZXhwcmVzc2lvbklkLCBSdWxlVHlwZS5WYWxpZGF0ZSk7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIOS4jei/m+ihjOaxh+aAu+WxleekulxyXG4gICAgICAvLyBjb25zdCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSB0aGlzLmJ1aWxkVmVyaWZ5SW5mb3JtYXRpb25zKGRvbUluZm8uaWQsIGZyYW1lQ29udGV4dCwgZG9tSW5mby5kb21Qcm9wZXJ0eU5hbWUsIG9wdGlvbnMubWVzc2FnZSk7XHJcbiAgICAgIC8vIOWinuWKoOWIsOaxh+aAu+a2iOaBr1xyXG4gICAgICAvLyByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xyXG4gICAgICAvLyDmm7TmlrDmsYfmgLvplJnor6/kv6Hmga9cclxuICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IHRydWUpIHtcclxuICAgICAgLy8g56e76Zmk6ZSZ6K+v5raI5oGvXHJcbiAgICAgIC8vIGNvbnN0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHRoaXMucmVtb3ZlVmFsaWRhdGVWZXJpZnlJbmZvcm1hdGlvbnMoZG9tSW5mby5pZCwgdGhpcy5mcmFtZUNvbnRleHQpO1xyXG4gICAgICAvLyByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xyXG4gICAgICBjb25zdCBjdXJyZW50RXJyb3JzID0gZnJhbWVDb250ZXh0LmZvcm0uZ2V0Rm9ybUNvbnRyb2xFcnJvcnMoZG9tUHJvcGVydHlOYW1lKSB8fCBudWxsO1xyXG4gICAgICBpZiAoY3VycmVudEVycm9ycykge1xyXG4gICAgICAgIGlmIChjdXJyZW50RXJyb3JzLmhhc093blByb3BlcnR5KCd2YWxpZGF0ZScpKSB7XHJcbiAgICAgICAgICAvLyByZXF1aXJl5ZCI5rOV77yM56e76ZmkcmVxdWlyZeagoemqjOaPkOekulxyXG4gICAgICAgICAgZGVsZXRlIGN1cnJlbnRFcnJvcnMudmFsaWRhdGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGZyYW1lQ29udGV4dC5mb3JtLnVwZGF0ZUZvcm1FcnJvcnMoeyBbZG9tUHJvcGVydHlOYW1lXTogeyBlcnJvcnM6IGN1cnJlbnRFcnJvcnMgfSB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBmb3JtRXJyb3JzID0gdGhpcy5idWlsZEZvcm1FcnJvcnMoZG9tUHJvcGVydHlOYW1lLCBudWxsKTtcclxuICAgICAgICBmcmFtZUNvbnRleHQuZm9ybS51cGRhdGVGb3JtRXJyb3JzKGZvcm1FcnJvcnMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOmAmui/h+WunuS9k+i3r+W+hOiOt+WPluWvueW6lOeahGRvbeS/oeaBr1xyXG4gICAqIEBwYXJhbSBlbnRpdHlQYXRoIFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RG9tSW5mb0J5RW50aXR5UGF0aChlbnRpdHlQYXRoOiBzdHJpbmcpOiB7IGRvbVByb3BlcnR5TmFtZTogc3RyaW5nLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgaWQ6IHN0cmluZywgaXNHcmlkQ29tcG9uZW50OiBib29sZWFuIH0ge1xyXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICBpZiAoIWVudGl0eVBhdGgpIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIGVudGl0eVBhdGggPSBlbnRpdHlQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLicpO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UodGhpcy5uYW1lc3BhY2UpIHx8IG51bGw7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0cyAmJiBmcmFtZUNvbnRleHRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgZm9yIChjb25zdCBmcmFtZUNvbnRleHQgb2YgZnJhbWVDb250ZXh0cykge1xyXG4gICAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaXNWYWxpZEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scyAmJiBPYmplY3Qua2V5cyhmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scykubGVuZ3RoID4gMFxyXG4gICAgICAgIGlmIChmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMgJiYgT2JqZWN0LmtleXMoZnJhbWVDb250ZXh0LmZvcm0ubmdGb3JtQ29udHJvbHMpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9scyk7XHJcbiAgICAgICAgICBmb3IgKGNvbnN0IHByb3BlcnR5TmFtZSBvZiBrZXlzKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2w6IE5nRm9ybUNvbnRyb2wgPSBmcmFtZUNvbnRleHQuZm9ybS5uZ0Zvcm1Db250cm9sc1twcm9wZXJ0eU5hbWVdO1xyXG4gICAgICAgICAgICBsZXQgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoIHx8ICcvJztcclxuICAgICAgICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgICAgICAgICAgbGV0IGJpbmRpbmdzID0gbmdGb3JtQ29udHJvbC5iaW5kaW5nLnNwbGl0KCcuJyk7XHJcbiAgICAgICAgICAgIGJpbmRpbmdzID0gYmluZGluZ1BhdGhzLmNvbmNhdChiaW5kaW5ncyk7XHJcbiAgICAgICAgICAgIGlmIChlbnRpdHlQYXRoID09PSBiaW5kaW5ncy5qb2luKCcuJykpIHtcclxuICAgICAgICAgICAgICAvLyDliKTmlq3lr7nlupTnmoTnu4Tku7bmmK/ku4DkuYjnsbvlnotcclxuICAgICAgICAgICAgICBjb25zdCBkZ0NvbHVtbk5hbWVzID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zTmFtZSddIHx8IG51bGw7XHJcbiAgICAgICAgICAgICAgY29uc3QgZGdDb2x1bW5JbmZvOiBBcnJheTxBcnJheTxhbnk+PiA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbZGdDb2x1bW5OYW1lc10gfHwgbnVsbDtcclxuICAgICAgICAgICAgICBpZiAoZGdDb2x1bW5JbmZvICYmIEFycmF5LmlzQXJyYXkoZGdDb2x1bW5JbmZvKSAmJiBkZ0NvbHVtbkluZm8ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaXNFZGl0YWJsZUdyaWQgPSBkZ0NvbHVtbkluZm8uZmluZCgoYXJyYXk6IEFycmF5PGFueT4pID0+IHtcclxuICAgICAgICAgICAgICAgICAgY29uc3QgcmVhZG9ubHlHcm91cCA9IGFycmF5LmV2ZXJ5KChjb2x1bW46IGFueSkgPT4gIShjb2x1bW4uaGFzT3duUHJvcGVydHkoJ2VkaXRvcicpICYmIGNvbHVtbi5lZGl0b3IpKTtcclxuICAgICAgICAgICAgICAgICAgaWYgKCFyZWFkb25seUdyb3VwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIGlmICghaXNFZGl0YWJsZUdyaWQpIHtcclxuICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgIC8vIOWmguaenOaYr2ZhcnJpc+agke+8jOWImei3s+i/h1xyXG4gICAgICAgICAgICAgIGNvbnN0IGlzRmFycmlzVHJlZVRhYmxlQ29tcG9uZW50ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudCAmJiBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQuY29tcG9uZW50VHlwZSA9PT0gQ29tcG9uZW50VHlwZS5mYXJyaXNUcmVlVGFsYmVDb21wb25lbnQ7XHJcbiAgICAgICAgICAgICAgaWYgKGlzRmFycmlzVHJlZVRhYmxlQ29tcG9uZW50KSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgbGV0IGlzR3JpZENvbXBvbmVudCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgIGlmIChkZ0NvbHVtbk5hbWVzKSB7XHJcbiAgICAgICAgICAgICAgICBpc0dyaWRDb21wb25lbnQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICByZXN1bHQgPSB7XHJcbiAgICAgICAgICAgICAgICBkb21Qcm9wZXJ0eU5hbWU6IHByb3BlcnR5TmFtZSxcclxuICAgICAgICAgICAgICAgIHByb3BlcnR5TmFtZTogbmdGb3JtQ29udHJvbC5uYW1lIHx8IG5nRm9ybUNvbnRyb2wuZGVmYXVsdEkxOG5WYWx1ZSxcclxuICAgICAgICAgICAgICAgIGZyYW1lQ29udGV4dCxcclxuICAgICAgICAgICAgICAgIGlkOiBuZ0Zvcm1Db250cm9sLmlkLFxyXG4gICAgICAgICAgICAgICAgaXNHcmlkQ29tcG9uZW50XHJcbiAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRWZXJpZnlJbmZvcm1hdGlvbnMoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XHJcbiAgICBjb25zdCByb290Vmlld01vZGVsID0gcm9vdEZyYW1lQ29udGV4dC52aWV3TW9kZWw7XHJcbiAgICBjb25zdCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucztcclxuICAgIHJldHVybiB2ZXJpZnlJbmZvcm1hdGlvbnM7XHJcbiAgfVxyXG4gIHByaXZhdGUgYnVpbGRGb3JtRXJyb3JzKGRvbVByb3BlcnR5TmFtZTogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcpIHtcclxuICAgIGlmIChtZXNzYWdlKSB7XHJcbiAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLnJlcGxhY2UoL1xcJHByb3BlcnR5L2csICdkb21Qcm9wZXJ0eU5hbWUnKTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBbZG9tUHJvcGVydHlOYW1lXToge1xyXG4gICAgICAgICAgZXJyb3JzOiB7XHJcbiAgICAgICAgICAgICd2YWxpZGF0ZSc6IHtcclxuICAgICAgICAgICAgICBuYW1lOiBtZXNzYWdlXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIFtkb21Qcm9wZXJ0eU5hbWVdOiB7XHJcbiAgICAgICAgICBlcnJvcnM6IHt9XHJcbiAgICAgICAgfVxyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGJ1aWxkVmVyaWZ5SW5mb3JtYXRpb25zKGlkOiBzdHJpbmcsIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBkb21Qcm9wZXJ0eU5hbWU6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSB0aGlzLmdldFZlcmlmeUluZm9ybWF0aW9ucyhmcmFtZUNvbnRleHQpO1xyXG4gICAgY29uc3QgaW5kZXggPSB2ZXJpZnlJbmZvcm1hdGlvbnMuZmluZEluZGV4KChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgcmV0dXJuIGl0ZW0uaWQgPT09IGlkXHJcbiAgICB9KTtcclxuICAgIGlmIChpbmRleCAhPT0gLTEpIHtcclxuICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zLnNwbGljZShpbmRleCwgMSk7XHJcbiAgICB9XHJcbiAgICB2ZXJpZnlJbmZvcm1hdGlvbnMucHVzaCh7XHJcbiAgICAgIGlkOiBpZCxcclxuICAgICAgbmFtZXNwYWNlOiBmcmFtZUNvbnRleHQubmFtZXNwYWNlLFxyXG4gICAgICB0YXJnZXRGaWVsZDogZG9tUHJvcGVydHlOYW1lLFxyXG4gICAgICBpbmRleDogdmVyaWZ5SW5mb3JtYXRpb25zLmxlbmd0aCArIDEsXHJcbiAgICAgIHRpdGxlOiBmcmFtZUNvbnRleHQuZm9ybS5mb3JtR3JvdXBOYW1lLFxyXG4gICAgICBtc2c6IG1lc3NhZ2UsXHJcbiAgICAgIHR5cGU6ICdlcnJvcidcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9ucztcclxuICB9XHJcbiAgcHJpdmF0ZSByZW1vdmVWYWxpZGF0ZVZlcmlmeUluZm9ybWF0aW9ucyhpZDogc3RyaW5nLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkge1xyXG4gICAgY29uc3QgdmVyaWZ5SW5mb3JtYXRpb25zID0gdGhpcy5nZXRWZXJpZnlJbmZvcm1hdGlvbnMoZnJhbWVDb250ZXh0KTtcclxuICAgIGNvbnN0IGluZGV4ID0gdmVyaWZ5SW5mb3JtYXRpb25zLmZpbmRJbmRleCgoaXRlbTogYW55KSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtLmlkID09PSBpZFxyXG4gICAgfSk7XHJcbiAgICBpZiAoaW5kZXggIT09IC0xKSB7XHJcbiAgICAgIHZlcmlmeUluZm9ybWF0aW9ucy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHZlcmlmeUluZm9ybWF0aW9ucztcclxuICB9XHJcbn0iXX0=