!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@farris/ui-notify"),require("@gsp-svc/file-viewer"),require("@gsp-svc/formdoc-upload"),require("@farris/extend-file-upload"),require("rxjs"),require("rxjs/operators"),require("@angular/common")):"function"==typeof define&&define.amd?define("@farris/extend-fileupload-adapt-unifile",["exports","@angular/core","@farris/ui-notify","@gsp-svc/file-viewer","@gsp-svc/formdoc-upload","@farris/extend-file-upload","rxjs","rxjs/operators","@angular/common"],t):t(((e=e||self).farris=e.farris||{},e.farris["extend-fileupload-adapt-unifile"]={}),e.ng.core,e.uiNotify,e.fileViewer,e.formdocUpload,e.extendFileUpload,e.rxjs,e.rxjs.operators,e.ng.common)}(this,(function(e,t,i,n,r,o,a,l,s){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var p=function(e,t){return(p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};var f=function(){return(f=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function d(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var n,r,o=i.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}return a}var u=new t.InjectionToken("MFFileUploadAdaptUnifileConfig"),c=function(){function e(e){this.config={rootId:"",formId:"",mode:0},e&&Object.assign(this.config,e)}return e.prototype.getConfig=function(){return this.config},e.prototype.setConfig=function(e,t){this.config[e]=t},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Optional},{type:t.Inject,args:[u]}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(u,8))},token:e,providedIn:"root"}),e}();var g=function(){function e(e,t,n){this.fileviewSer=e,this.configSer=t,this.downloadSer=n,this.previewExtendServerConfig=null,this.notifySer=null,this.extendData=this.configSer.getConfig(),this.notifySer=this.fileviewSer.injector.get(i.NotifyService,null)}return e.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.previewExtendServerConfig&&this.previewExtendServerConfig.hasOwnProperty(e)?this.previewExtendServerConfig[e]:this.extendData.hasOwnProperty(e)?this.extendData[e]:null},e.prototype.previewFile=function(e,t){return this.previewFileList([e],t)},e.prototype.previewFileList=function(e,t){var i=this.getFinallyConfig("rootId",t),n=[];e.forEach((function(e){n.push(e.extend.metadataId)}));var r=this.getFinallyConfig("options",t);return r?this.fileviewSer.viewerFileList(n,i,r):this.fileviewSer.viewerFileList(n,i)},e.prototype.downloadFile=function(e,t){if(!e.id)throw new Error("请设置要下载的附件");window.open(this.getImgSrc(e,t))},e.prototype.multiDownloadFiles=function(e,t){if(1==e.length)this.downloadFile(e[0],t);else{var i=this.getFinallyConfig("rootId",t),n=[];e.forEach((function(e){n.push(e.extend.metadataId)}));var r=this.downloadSer.getMultipleDownloadUrl(JSON.stringify(n),i);window.open(r)}},e.prototype.multiDownloadFilesWidthName=function(e,t,i){if(void 0===t&&(t=""),1==e.length)this.downloadFile(e[0],i);else{var n=this.getFinallyConfig("rootId",i),r=[];e.forEach((function(e){r.push(e.extend.metadataId)}));var o=this.downloadSer.getMultipleDownloadUrlWithName(JSON.stringify(r),n,t);window.open(o)}},e.prototype.getImgSrc=function(e,t){if(!e.id)throw new Error("请设置要下载的附件");var i="",n=e.extend.metadataId,r=this.getFinallyConfig("rootId",t);return this.downloadSer?r&&(i=this.downloadSer.getDownloadUrl(n,r)):r&&(console.warn("因为安全问题，附件下载提供安全校验机制，附件下载功能需要重新编译"),i="/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid="+n+"&rootid="+r),i},e.prototype.setPreviwExtendServerConfig=function(e){this.previewExtendServerConfig=e},e.prototype.getPreviewExtendServerConfig=function(){return this.previewExtendServerConfig},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:n.FileViewerService},{type:c},{type:r.DownloadService,decorators:[{type:t.Optional}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(n.FileViewerService),t.inject(c),t.inject(r.DownloadService,8))},token:e,providedIn:"root"}),e}();var h=function(){function e(e){this.previewSer=e,this.viewDisabled=!1,this.extendServerConfig=null}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.viewDisabled&&this.previewSer.previewFile(this.fileInfo,this.extendServerConfig)},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptPreviewFile]"}]}],e.ctorParameters=function(){return[{type:g}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptPreviewFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],viewDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var v=function(){function e(e){this.previewSer=e,this.zipName="",this.downloadDisabled=!1,this.extendServerConfig=null,this.enableMulti=!1}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.downloadDisabled&&(this.enableMulti&&this.fileInfo instanceof Array?this.previewSer.multiDownloadFilesWidthName(this.fileInfo,this.zipName,this.extendServerConfig):this.previewSer.downloadFile(this.fileInfo,this.extendServerConfig))},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptDownloadFile]"}]}],e.ctorParameters=function(){return[{type:g}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptDownloadFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],zipName:[{type:t.Input}],downloadDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}],enableMulti:[{type:t.Input}]},e}();var m=function(){function e(e,t){this.adpSer=e,this.elementRef=t,this.cls=!0,this.enableThumbnail=!1,this.clsPrefix="ffilepreview--filetype",this.supportImgSuffix="jpeg,jpg,gif,png,bmp",this.iconWidth=38,this.maxThumbnailWidth="100%",this.maxThumbnailHeight="100%",this.extendServerConfig=null}return e.prototype.ngOnInit=function(){},e.prototype.imgSrc=function(){return this.adpSer.getImgSrc(this.fileInfo,this.extendServerConfig)},e.prototype.isImage=function(){if(!this.fileInfo)return!1;var e=this.fileInfo.name;if(!e)return!1;var t=e.lastIndexOf("."),i="";return t>-1&&(i=e.substring(t+1).toLocaleLowerCase()),!!i&&this.supportImgSuffix.split(",").findIndex((function(e){return e==i}))>-1},e.prototype.getFileTypeClassName=function(){var e=this.clsPrefix;if(!this.fileInfo||!this.fileInfo.name)return e+"-any";var t=this.fileInfo.name,i=t.lastIndexOf("."),n="";switch(i>-1&&(n=t.substring(i+1).toLocaleLowerCase()),n){case"pdf":e+="-pdf";break;case"jpeg":case"jpg":case"gif":case"png":case"bmp":e+="-img";break;case"ppt":e+="-ppt";break;case"doc":case"docx":e+="-doc";break;case"xls":case"xlsx":e+="-xls";break;case"txt":e+="-txt";break;case"zip":e+="-zip";break;default:e+="-any"}return e},e.decorators=[{type:t.Component,args:[{selector:"ffilepreview-adapt-seeimg",template:'<div class="ffilepreview-seeimg--wrapper" [ngClass]="{\'ffilepreview-seeimg--thumbnail\':enableThumbnail}">\r\n  <ng-container *ngIf="enableThumbnail&&isImage();else notImage">\r\n    <img class="ffilepreview-seeimg--img" [src]="imgSrc()" [ngStyle]="{\'maxWidth\':maxThumbnailWidth,\'maxHeight\':maxThumbnailHeight}"/>\r\n  </ng-container>\r\n</div>\r\n<ng-template #notImage>\r\n  <span class="ffilepreview--filetype-icon" [ngClass]="getFileTypeClassName()" [ngStyle]="{\'width\':iconWidth+\'px\',\'height\':iconWidth+\'px\'}"></span>\r\n</ng-template>',styles:[":host{height:100%;width:100%;position:relative}.ffilepreview-seeimg--thumbnail{top:0;bottom:0;position:absolute;right:0;left:0;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center}.ffilepreview-seeimg--wrapper:hover{opacity:.8}.ffilepreview-seeimg--img{max-width:100%;max-height:100%;border-radius:4px}"]}]}],e.ctorParameters=function(){return[{type:g},{type:t.ElementRef}]},e.propDecorators={cls:[{type:t.HostBinding,args:["class.ffilepreview-adapt-seeimg"]}],enableThumbnail:[{type:t.Input}],clsPrefix:[{type:t.Input}],supportImgSuffix:[{type:t.Input}],fileInfo:[{type:t.Input}],iconWidth:[{type:t.Input}],maxThumbnailWidth:[{type:t.Input}],maxThumbnailHeight:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var y=function(e){function i(t,i){var n=e.call(this)||this;return n.uploadSer=t,n.configSer=i,n.bufferSize=1048576,n.uploadedChunk={},n.fileTotalChunk={},n.extendData=n.configSer.getConfig(),n}return function(e,t){function i(){this.constructor=e}p(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}(i,e),i.prototype.uuid=function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()},i.prototype.remove=function(e,t,i){return this.innerRemoveList(e,t,i)},i.prototype.innerRemoveList=function(e,t,i){var n=this;return void 0===i&&(i=null),new a.Observable((function(t){var o=new r.GspFormRemoveListEntity,a=[];e.forEach((function(e){e.response&&a.push(e.response.metadataId)})),o.mode=n.getFinallyConfig("mode",i);var l=n.getFinallyConfig("rootId",i);o.metadataIdList=[].concat(a),n.uploadSer.removeList(a,l).subscribe((function(i){t.next({type:"removed",files:e})}),(function(e){t.error(e),t.complete()}),(function(){t.complete()}))}))},i.prototype.upload=function(e,t,i){return"sliceUpload"==t.type?this.uploadBigFile(e,t,i):this.innerUploadList(e,t,i)},i.prototype.innerUploadList=function(e,t,i){var n=this;return new a.Observable((function(l){var s=new r.GspFormUploadListEntity;s.formId=n.getFinallyConfig("formId",i),s.mode=n.getFinallyConfig("mode",i);var p=n.getFinallyConfig("rootId",i);s.docInfoList=[];var f=[];e.forEach((function(e){var i=new a.Observable((function(i){var n=new FileReader;n.readAsBinaryString(e.nativeFile),n.onload=function(r){var o={fileName:"",fileContent:""};o.fileName=e.name,o.fileContent=btoa(n.result.toString()),t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(o.extProperty=t.data.extProperty),s.docInfoList.push(o),i.next(),i.complete()}}));f.push(i)})),a.forkJoin(f).subscribe((function(t){n.uploadSer.uploadList(s,p).subscribe((function(t){if(t.error)return l.error(n.errorInfoFormat(t.error,e)),void l.complete();t.forEach((function(t){var i=n.findFileIndexByFileName(e,t.fileName);i>-1&&(e[i].response=t,e[i].progress.status=o.UploadStatus.Done)})),l.next({type:"done",files:e})}),(function(t){l.error(n.errorInfoFormat(t,e)),l.complete()}),(function(){l.complete()}))}))}))},i.prototype.multipartUpload=function(e,t,i){var n=this;return new a.Observable((function(a){var l=n.uuid(),s=e.name,p=Math.ceil(e.size/n.bufferSize);n.fileTotalChunk[l]=p;var f=0;n.uploadedChunk[l]=0;for(var d=function(){var d=new r.GspFormUploadEntity;d.mode=r.OperatingModes.Temp,d.formId=n.getFinallyConfig("formId",i),d.rootId=n.getFinallyConfig("rootId",i);var u=new r.GspFormDocInfo;u.fileName=s,u.metadataId=l,u.total=p,t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(u.extProperty=t.data.extProperty);var c=Math.min((f+1)*n.bufferSize,e.size),g=e.nativeFile.slice(f*n.bufferSize,c),h=new FileReader;h.readAsBinaryString(g);var v=f;h.onload=function(){u.fileContent=btoa(h.result.toString()),u.index=v,d.docInfo=u;var t=d;n.uploadSer.uploadFile(t).subscribe((function(t){if(t&&t.error)return a.error(n.errorInfoFormat(t.error,[e])),void a.complete();if(n.uploadedChunk[l]++,n.uploadedChunk[u.metadataId]==n.fileTotalChunk[u.metadataId])e.progress={status:o.UploadStatus.Done,data:{percentage:100}},e.response=u,delete n.uploadedChunk[l],delete n.fileTotalChunk[l],a.next({type:"done",files:[e]}),a.complete();else{var i=Number.parseInt((n.uploadedChunk[l]/n.fileTotalChunk[l]*100).toFixed(0));e.progress={status:o.UploadStatus.Uploading,data:{percentage:i}},a.next({type:"uploading",files:[e]})}}),(function(t){delete n.uploadedChunk[l],delete n.fileTotalChunk[l],a.error(n.errorInfoFormat(t,[e])),a.complete()}))},f+=1};f<p;)d()}))},i.prototype.formatFileSize=function(e){return e<102400?(e/1024).toFixed(1)+"K":e<1048576?(e/1024).toFixed(0)+"K":e<104857600?(e/1024/1024).toFixed(1)+"M":e<1073741824?(e/1024/1024).toFixed(0)+"M":(e/1024/1024/1024).toFixed(1)+"G"},i.prototype.getMultipartDisplayName=function(e){return e.length<=10?e:e.substring(0,2)+"…"+e.substring(e.lastIndexOf(".")-2)},i.prototype.errorInfoFormat=function(e,t){var i=t.map((function(e){return{id:e.id,name:e.name}}));return e?Object.assign(e,{files:i},{message:e.Message||e.extensionMessage||"上传失败",type:"error"}):Object.assign({files:i},{message:"上传失败",type:"error"})},i.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.extendData[e]},i.prototype.findFileIndexByFileName=function(e,t){return e.findIndex((function(e){return e.name==t}))},i.prototype.uploadBigFile=function(e,t,i){var n=this,r=new a.Subject,l=e.map((function(e){var r=n._getBigFileChunks(e,t,i);return f({},e,r)})).map((function(e){return n.uploadChunks(e,r)}));return a.concat.apply(void 0,function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(d(arguments[t]));return e}(l)).subscribe((function(e){e.progress={status:o.UploadStatus.Done,data:{percentage:100}},e.response=JSON.parse(e.chunks[0].get("docInfo")),r.next({type:"done",files:[e]})}),(function(t){r.error(n.errorInfoFormat(t,e)),r.complete()}),(function(){r.complete()})),r.asObservable()},i.prototype.uploadFileChunk=function(e){return this.uploadSer.http.http.post("/api/runtime/dfs/v1.0/formdoc/slice",e.chunks[e.total]).pipe(l.switchMap((function(){return a.of(e)})),l.catchError((function(e){return a.of(e)})))},i.prototype.uploadChunks=function(e,t){var i,n=this;return(i=e,a.of(i)).pipe(l.expand((function(i){return--e.total>-1?function(e){return n.uploadFileChunk(e).pipe(l.delay(100),l.map((function(e){return e.progress={status:o.UploadStatus.Uploading,data:{percentage:(e.total/e.chunks.length*100).toFixed(0)}},t.next({type:"uploading",files:[e]}),e})))}(e):a.EMPTY})),l.last(),l.switchMap((function(t){return function(e){return a.of(e)}(e)})))},i.prototype._getBigFileChunks=function(e,t,i){for(var n=this.uuid(),o=Math.ceil(e.size/this.bufferSize*(t.chunkSize||1)),a=0,l={chunks:[],total:o};a<o;){var s=new r.GspFormUploadEntity;s.mode=r.OperatingModes.Temp,s.formId=this.getFinallyConfig("formId",i),s.rootId=this.getFinallyConfig("rootId",i);var p=new r.GspFormDocInfo;p.fileName=e.name,p.metadataId=n,p.total=o;var f=Math.min((a+1)*this.bufferSize,e.size),d=e.nativeFile.slice(a*this.bufferSize,f);p.size=e.size,p.index=a,p.fileContent="",t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(p.extProperty=t.data.extProperty),s.docInfo=p;var u=new FormData;u.append("uploadInfo",JSON.stringify(s)),u.append("docInfo",JSON.stringify(p)),u.append("file",d),l.chunks.push(u),a+=1}return l},i.previous=0,i.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],i.ctorParameters=function(){return[{type:r.UploadService},{type:c}]},i.ngInjectableDef=t.defineInjectable({factory:function(){return new i(t.inject(r.UploadService),t.inject(c))},token:i,providedIn:"root"}),i}(o.UploadServerService);var w=function(){function e(e){this.previewSer=e,this._extendServeConfig=null}return e.prototype.filePreviewEventHandler=function(e){var t=Object.assign(this.extendServerConfig||{});t.options=Object.assign(t.options||{},{showDownload:!!e.showDownload}),void 0===t.options.showHeader&&(t.options.showHeader=!0),void 0===t.options.showFileList&&(t.options.showFileList=!0);var i=e.name.substr(e.name.lastIndexOf(".")+1).toLowerCase();if(["doc","docx","xls","xlsx","ppt","pptx","jpg","jpeg","png","gif","bmp","pdf","txt"].includes(i))this.previewSer.previewFile(e,t);else{this.previewSer.notifySer?this.previewSer.notifySer.warning("此文件不支持预览"):alert("此文件不支持预览")}},e.prototype.fileDownloadEventHandler=function(e){e&&e.fileInfos.length>0&&(e.fileInfos.length>1?this.previewSer.multiDownloadFilesWidthName(e.fileInfos,e.name,this.extendServerConfig):this.previewSer.downloadFile(e.fileInfos[0],this.extendServerConfig))},Object.defineProperty(e.prototype,"extendServerConfig",{get:function(){return this._extendServeConfig},set:function(e){this._extendServeConfig=e,this.previewSer.setPreviwExtendServerConfig(e)},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Directive,args:[{selector:"[fFilePreviewAdaptUnifile]",providers:[g]}]}],e.ctorParameters=function(){return[{type:g}]},e.propDecorators={filePreviewEventHandler:[{type:t.HostListener,args:["filePreviewEvent",["$event"]]}],fileDownloadEventHandler:[{type:t.HostListener,args:["fileDownloadEvent",["$event"]]}],extendServerConfig:[{type:t.Input}]},e}();var x=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:u,useValue:t},c,g,n.FileViewerService]}},e.decorators=[{type:t.NgModule,args:[{declarations:[w,m,v,h],imports:[s.CommonModule,r.UploadDialogMoudle,n.FileListModule,o.FFileUploadModule.forRoot(null,y)],exports:[o.FFileUploadModule,w,m,v,h],providers:[c,g,n.FileViewerService]}]}],e}();e.FFileAdaptDownloadFileDirective=v,e.FFileAdaptPreviewFileDirective=h,e.FFilePreviewAdaptUnifileDirective=w,e.FFileUploadAdaptUnifileConfigService=c,e.FFileUploadAdaptUnifileConfigToken=u,e.FfilepreviewAdaptSeeimgComponent=m,e.FfilepreviewAdaptUnifileService=g,e.FfileuploadAdaptUnifileModule=x,e.FfileuploadAdaptUnifileService=y,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=farris-extend-fileupload-adapt-unifile.umd.min.js.map