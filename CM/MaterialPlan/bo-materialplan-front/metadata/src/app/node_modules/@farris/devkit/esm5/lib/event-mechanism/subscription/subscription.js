import { Injectable } from '@angular/core';
import { MetadataUtil } from '../../metadata/index';
import { NG_SUBSCRIPTION } from './subscription_decorator';
var Subscription = /** @class */ (function () {
    function Subscription() {
    }
    /**
     * 初始化
     */
    Subscription.prototype.init = function (frameComponent) {
        if (!frameComponent) {
            return;
        }
        return this.bindSubscription(frameComponent, null);
    };
    /**
     *  根据订阅列表进行初始化
     * @param frameComponent
     * @param ngEvents 订阅列表
     * @returns eventPipes
     */
    Subscription.prototype.initWithSubscriptions = function (frameComponent, ngEvents) {
        if (!frameComponent) {
            return;
        }
        return this.bindSubscription(frameComponent, ngEvents);
    };
    Subscription.prototype.bindSubscription = function (frameComponent, ngEvents) {
        var _this = this;
        var context = frameComponent.context;
        if (!context) {
            return;
        }
        var ngEventHandlerProps = ngEvents ? ngEvents : this.getNgEvents(frameComponent);
        if (!ngEventHandlerProps) {
            return;
        }
        var eventPipes = [];
        Object.keys(ngEventHandlerProps).forEach(function (propertyName) {
            var ngImportEvent = ngEventHandlerProps[propertyName];
            // 获取待订阅方法详情，尝试执行订阅
            var targetContext = context;
            var receiver = frameComponent;
            var emitter = ngImportEvent.token;
            var tokenValue = ngImportEvent.token;
            var eventName = ngImportEvent.name;
            var paramMapCollection = ngImportEvent.paramMapCollection;
            var eventPipe = targetContext.eventBus.on(emitter, tokenValue, eventName, receiver, function (eventArgs) {
                _this.subscriptionHandler(eventArgs, paramMapCollection, targetContext);
                var eventHandler = frameComponent[eventName];
                if (!eventHandler) {
                    return;
                }
                try {
                    eventHandler(receiver, eventArgs);
                }
                catch (_a) {
                    throw new Error('Error invoking method ' + eventName);
                }
            });
            eventPipes.push(eventPipe);
        });
        return eventPipes;
    };
    /**
     * 获取组件订阅列表
     * @param frameComponent 表单component
     * @returns 组件订阅列表信息
     */
    Subscription.prototype.getNgEvents = function (frameComponent) {
        return MetadataUtil.getPropsMetadatasByName(frameComponent.constructor, NG_SUBSCRIPTION);
    };
    Subscription.prototype.subscriptionHandler = function (param, paramMapCollection, currentFrameContext) {
        if (!param || !paramMapCollection || paramMapCollection.length <= 0 || !currentFrameContext) {
            return;
        }
        this.paramMap2UiState(param, paramMapCollection, currentFrameContext);
    };
    /**
     * 设置paramMap后，将param映射到UISTATE上
     */
    Subscription.prototype.paramMap2UiState = function (param, paramMapCollection, currentFrameContext) {
        for (var i = 0; i < paramMapCollection.length; i++) {
            var from = paramMapCollection[i].from;
            var frameId = paramMapCollection[i].frameId;
            var to = paramMapCollection[i].to;
            if (!from || !frameId || !to) {
                continue;
            }
            var destContext = this.getFrameContext(frameId, currentFrameContext);
            if (destContext == null) {
                continue;
            }
            this.setUiStateProperty(to, param[from], destContext.uiState);
            // this.setUiStateProperty(to, param[from], currentFrameContext.uiState);
        }
    };
    Subscription.prototype.getFrameContext = function (targetFrameContextId, currentContext) {
        var destContext = null;
        try {
            destContext = currentContext.appContext.getFrameContext(targetFrameContextId);
        }
        catch (_a) {
            throw new Error('Error in Getting FrameContext');
        }
        return destContext;
    };
    Subscription.prototype.setUiStateProperty = function (propertyName, propertyValue, uiState) {
        try {
            uiState.setPropertyValue(propertyName, propertyValue);
        }
        catch (_a) {
            throw new Error("Error in Setting Property Value of the current UISTATE" + uiState);
        }
    };
    Subscription.decorators = [
        { type: Injectable }
    ];
    return Subscription;
}());
export { Subscription };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Vic2NyaXB0aW9uLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtbWVjaGFuaXNtL3N1YnNjcmlwdGlvbi9zdWJzY3JpcHRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFHcEQsT0FBTyxFQUFFLGVBQWUsRUFBNEIsTUFBTSwwQkFBMEIsQ0FBQztBQUdyRjtJQUFBO0lBeUlBLENBQUM7SUF0SUM7O09BRUc7SUFDSSwyQkFBSSxHQUFYLFVBQVksY0FBOEI7UUFDeEMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUNuQixPQUFPO1NBQ1I7UUFFRCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUdEOzs7OztPQUtHO0lBQ0ksNENBQXFCLEdBQTVCLFVBQTZCLGNBQThCLEVBQUUsUUFFNUQ7UUFDQyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLE9BQU87U0FDUjtRQUVELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRU8sdUNBQWdCLEdBQXhCLFVBQXlCLGNBQThCLEVBQUUsUUFFeEQ7UUFGRCxpQkErQ0M7UUE1Q0MsSUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLE9BQU8sQ0FBQztRQUN2QyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ1osT0FBTztTQUNSO1FBRUQsSUFBTSxtQkFBbUIsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNuRixJQUFJLENBQUMsbUJBQW1CLEVBQUU7WUFDeEIsT0FBTztTQUNSO1FB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QyxJQUFJLENBQUMsRUFBRSxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDOUQseUVBQXlFO1NBQzFFO0lBQ0gsQ0FBQztJQUVPLHNDQUFlLEdBQXZCLFVBQXdCLG9CQUE0QixFQUFFLGNBQTRCO1FBQ2hGLElBQUksV0FBVyxHQUFpQixJQUFJLENBQUM7UUFDckMsSUFBSTtZQUNGLFdBQVcsR0FBRyxjQUFjLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1NBQy9FO1FBQUMsV0FBTTtZQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztTQUNsRDtRQUNELE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7SUFFTyx5Q0FBa0IsR0FBMUIsVUFBMkIsWUFBb0IsRUFBRSxhQUFxQixFQUFFLE9BQWdCO1FBQ3RGLElBQUk7WUFDRixPQUFPLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxFQUFFLGFBQWEsQ0FBQyxDQUFDO1NBQ3ZEO1FBQUMsV0FBTTtZQUNOLE1BQU0sSUFBSSxLQUFLLENBQUMsd0RBQXdELEdBQUcsT0FBTyxDQUFDLENBQUM7U0FDckY7SUFDSCxDQUFDOztnQkF2SUYsVUFBVTs7SUF5SVgsbUJBQUM7Q0FBQSxBQXpJRCxJQXlJQztBQUVELE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uLy4uL21ldGFkYXRhL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBGcmFtZUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2ZyYW1lL2luZGV4JztcclxuaW1wb3J0IHsgVUlTdGF0ZSB9IGZyb20gJy4uLy4uL3VpLXN0YXRlL2luZGV4JztcclxuaW1wb3J0IHsgTkdfU1VCU0NSSVBUSU9OLCBOZ1N1YnNjcmlwdGlvbiwgUGFyYW1NYXAgfSBmcm9tICcuL3N1YnNjcmlwdGlvbl9kZWNvcmF0b3InO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSB9IGZyb20gJy4uLy4uL2NvcmUvaW5kZXgnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBTdWJzY3JpcHRpb24ge1xyXG5cclxuICAvKipcclxuICAgKiDliJ3lp4vljJZcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdChmcmFtZUNvbXBvbmVudDogRnJhbWVDb21wb25lbnQpOiBJRGlzcG9zYWJsZVtdIHtcclxuICAgIGlmICghZnJhbWVDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmJpbmRTdWJzY3JpcHRpb24oZnJhbWVDb21wb25lbnQsIG51bGwpO1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqICDmoLnmja7orqLpmIXliJfooajov5vooYzliJ3lp4vljJZcclxuICAgKiBAcGFyYW0gZnJhbWVDb21wb25lbnQgXHJcbiAgICogQHBhcmFtIG5nRXZlbnRzIOiuoumYheWIl+ihqFxyXG4gICAqIEByZXR1cm5zIGV2ZW50UGlwZXNcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdFdpdGhTdWJzY3JpcHRpb25zKGZyYW1lQ29tcG9uZW50OiBGcmFtZUNvbXBvbmVudCwgbmdFdmVudHM6IHtcclxuICAgIFtwcm9wTmFtZTogc3RyaW5nXTogYW55O1xyXG4gIH0pOiBJRGlzcG9zYWJsZVtdIHtcclxuICAgIGlmICghZnJhbWVDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB0aGlzLmJpbmRTdWJzY3JpcHRpb24oZnJhbWVDb21wb25lbnQsIG5nRXZlbnRzKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYmluZFN1YnNjcmlwdGlvbihmcmFtZUNvbXBvbmVudDogRnJhbWVDb21wb25lbnQsIG5nRXZlbnRzOiB7XHJcbiAgICBbcHJvcE5hbWU6IHN0cmluZ106IGFueTtcclxuICB9KSB7XHJcbiAgICBjb25zdCBjb250ZXh0ID0gZnJhbWVDb21wb25lbnQuY29udGV4dDtcclxuICAgIGlmICghY29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbmdFdmVudEhhbmRsZXJQcm9wcyA9IG5nRXZlbnRzID8gbmdFdmVudHMgOiB0aGlzLmdldE5nRXZlbnRzKGZyYW1lQ29tcG9uZW50KTtcclxuICAgIGlmICghbmdFdmVudEhhbmRsZXJQcm9wcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZXZlbnRQaXBlczogSURpc3Bvc2FibGVbXSA9IFtdO1xyXG4gICAgT2JqZWN0LmtleXMobmdFdmVudEhhbmRsZXJQcm9wcykuZm9yRWFjaCgocHJvcGVydHlOYW1lOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgbmdJbXBvcnRFdmVudDogTmdTdWJzY3JpcHRpb24gPSBuZ0V2ZW50SGFuZGxlclByb3BzW3Byb3BlcnR5TmFtZV07XHJcblxyXG4gICAgICAvLyDojrflj5blvoXorqLpmIXmlrnms5Xor6bmg4XvvIzlsJ3or5XmiafooYzorqLpmIVcclxuICAgICAgY29uc3QgdGFyZ2V0Q29udGV4dCA9IGNvbnRleHQ7XHJcblxyXG4gICAgICBjb25zdCByZWNlaXZlciA9IGZyYW1lQ29tcG9uZW50O1xyXG4gICAgICBjb25zdCBlbWl0dGVyID0gbmdJbXBvcnRFdmVudC50b2tlbjtcclxuICAgICAgY29uc3QgdG9rZW5WYWx1ZSA9IG5nSW1wb3J0RXZlbnQudG9rZW47XHJcbiAgICAgIGNvbnN0IGV2ZW50TmFtZSA9IG5nSW1wb3J0RXZlbnQubmFtZTtcclxuXHJcbiAgICAgIGNvbnN0IHBhcmFtTWFwQ29sbGVjdGlvbiA9IG5nSW1wb3J0RXZlbnQucGFyYW1NYXBDb2xsZWN0aW9uO1xyXG4gICAgICBjb25zdCBldmVudFBpcGUgPSB0YXJnZXRDb250ZXh0LmV2ZW50QnVzLm9uKGVtaXR0ZXIsIHRva2VuVmFsdWUsIGV2ZW50TmFtZSwgcmVjZWl2ZXIsXHJcbiAgICAgICAgKGV2ZW50QXJncykgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb25IYW5kbGVyKGV2ZW50QXJncywgcGFyYW1NYXBDb2xsZWN0aW9uLCB0YXJnZXRDb250ZXh0KTtcclxuXHJcbiAgICAgICAgICBjb25zdCBldmVudEhhbmRsZXI6IEZ1bmN0aW9uID0gZnJhbWVDb21wb25lbnRbZXZlbnROYW1lXTtcclxuICAgICAgICAgIGlmICghZXZlbnRIYW5kbGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBldmVudEhhbmRsZXIocmVjZWl2ZXIsIGV2ZW50QXJncyk7XHJcbiAgICAgICAgICB9IGNhdGNoIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBpbnZva2luZyBtZXRob2QgJyArIGV2ZW50TmFtZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG5cclxuICAgICAgZXZlbnRQaXBlcy5wdXNoKGV2ZW50UGlwZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZXZlbnRQaXBlcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlue7hOS7tuiuoumYheWIl+ihqFxyXG4gICAqIEBwYXJhbSBmcmFtZUNvbXBvbmVudCDooajljZVjb21wb25lbnRcclxuICAgKiBAcmV0dXJucyDnu4Tku7borqLpmIXliJfooajkv6Hmga9cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0TmdFdmVudHMoZnJhbWVDb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50KSB7XHJcbiAgICByZXR1cm4gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKGZyYW1lQ29tcG9uZW50LmNvbnN0cnVjdG9yLCBOR19TVUJTQ1JJUFRJT04pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25IYW5kbGVyKHBhcmFtOiBhbnksIHBhcmFtTWFwQ29sbGVjdGlvbjogUGFyYW1NYXBbXSwgY3VycmVudEZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XHJcblxyXG4gICAgaWYgKCFwYXJhbSB8fCAhcGFyYW1NYXBDb2xsZWN0aW9uIHx8IHBhcmFtTWFwQ29sbGVjdGlvbi5sZW5ndGggPD0gMCB8fCAhY3VycmVudEZyYW1lQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5wYXJhbU1hcDJVaVN0YXRlKHBhcmFtLCBwYXJhbU1hcENvbGxlY3Rpb24sIGN1cnJlbnRGcmFtZUNvbnRleHQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572ucGFyYW1NYXDlkI7vvIzlsIZwYXJhbeaYoOWwhOWIsFVJU1RBVEXkuIpcclxuICAgKi9cclxuICBwcml2YXRlIHBhcmFtTWFwMlVpU3RhdGUocGFyYW06IGFueSwgcGFyYW1NYXBDb2xsZWN0aW9uOiBQYXJhbU1hcFtdLCBjdXJyZW50RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGFyYW1NYXBDb2xsZWN0aW9uLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIGNvbnN0IGZyb20gPSBwYXJhbU1hcENvbGxlY3Rpb25baV0uZnJvbTtcclxuICAgICAgY29uc3QgZnJhbWVJZCA9IHBhcmFtTWFwQ29sbGVjdGlvbltpXS5mcmFtZUlkO1xyXG4gICAgICBjb25zdCB0byA9IHBhcmFtTWFwQ29sbGVjdGlvbltpXS50bztcclxuXHJcbiAgICAgIGlmICghZnJvbSB8fCAhZnJhbWVJZCB8fCAhdG8pIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBkZXN0Q29udGV4dDogRnJhbWVDb250ZXh0ID0gdGhpcy5nZXRGcmFtZUNvbnRleHQoZnJhbWVJZCwgY3VycmVudEZyYW1lQ29udGV4dCk7XHJcbiAgICAgIGlmIChkZXN0Q29udGV4dCA9PSBudWxsKSB7XHJcbiAgICAgICAgY29udGludWU7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5zZXRVaVN0YXRlUHJvcGVydHkodG8sIHBhcmFtW2Zyb21dLCBkZXN0Q29udGV4dC51aVN0YXRlKTtcclxuICAgICAgLy8gdGhpcy5zZXRVaVN0YXRlUHJvcGVydHkodG8sIHBhcmFtW2Zyb21dLCBjdXJyZW50RnJhbWVDb250ZXh0LnVpU3RhdGUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGcmFtZUNvbnRleHQodGFyZ2V0RnJhbWVDb250ZXh0SWQ6IHN0cmluZywgY3VycmVudENvbnRleHQ6IEZyYW1lQ29udGV4dCk6IEZyYW1lQ29udGV4dCB7XHJcbiAgICBsZXQgZGVzdENvbnRleHQ6IEZyYW1lQ29udGV4dCA9IG51bGw7XHJcbiAgICB0cnkge1xyXG4gICAgICBkZXN0Q29udGV4dCA9IGN1cnJlbnRDb250ZXh0LmFwcENvbnRleHQuZ2V0RnJhbWVDb250ZXh0KHRhcmdldEZyYW1lQ29udGV4dElkKTtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yIGluIEdldHRpbmcgRnJhbWVDb250ZXh0Jyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGVzdENvbnRleHQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFVpU3RhdGVQcm9wZXJ0eShwcm9wZXJ0eU5hbWU6IHN0cmluZywgcHJvcGVydHlWYWx1ZTogc3RyaW5nLCB1aVN0YXRlOiBVSVN0YXRlKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICB1aVN0YXRlLnNldFByb3BlcnR5VmFsdWUocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlKTtcclxuICAgIH0gY2F0Y2gge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciBpbiBTZXR0aW5nIFByb3BlcnR5IFZhbHVlIG9mIHRoZSBjdXJyZW50IFVJU1RBVEVcIiArIHVpU3RhdGUpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IFN1YnNjcmlwdGlvbiB9O1xyXG4iXX0=