/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, ComponentFactoryResolver } from '@angular/core';
import { FileUploadComponent } from './upload/file-upload/file-upload.component';
import { BsModalService } from '@farris/ui-modal';
import { of } from 'rxjs';
var UploadDialogService = /** @class */ (function () {
    function UploadDialogService(modalService, componentFactoryResolver, injector) {
        this.modalService = modalService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.injector = injector;
        this.fileInfoList = [];
    }
    /**
     * @param {?} formId
     * @param {?} rootId
     * @return {?}
     */
    UploadDialogService.prototype.showDialog = /**
     * @param {?} formId
     * @param {?} rootId
     * @return {?}
     */
    function (formId, rootId) {
        var _this = this;
        /** @type {?} */
        var flag = 0;
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        function (resolve) {
            /** @type {?} */
            var viewerFactory = _this.componentFactoryResolver.resolveComponentFactory(FileUploadComponent);
            /** @type {?} */
            var viewerRef = viewerFactory.create(_this.injector);
            viewerRef.instance.rootId = rootId;
            viewerRef.instance.formId = formId;
            _this.dlg = _this.modalService.show(viewerRef, {
                title: '上传文件',
                width: 950, height: 570,
                buttons: [
                    {
                        text: '保存', cls: 'k-button k-button-icontext k-primary', handle: (/**
                         * @return {?}
                         */
                        function () {
                            _this.dlg.content.upload().subscribe((/**
                             * @param {?} res
                             * @return {?}
                             */
                            function (res) {
                                if (res) {
                                    resolve(res);
                                    flag = 1;
                                    _this.dlg.close();
                                }
                            }));
                        })
                    },
                    {
                        text: '关闭', cls: 'k-button k-button-icontext', handle: (/**
                         * @return {?}
                         */
                        function () {
                            _this.dlg.close();
                        })
                    }
                ],
                showButtons: true,
                showMaxButton: false,
                beforeClose: (/**
                 * @return {?}
                 */
                function () {
                    if (flag == 0)
                        _this.dlg.content.cancel();
                    return of(true);
                })
            });
        }));
    };
    /**
     * @param {?} formId
     * @param {?} rootId
     * @param {?=} oldIdList
     * @return {?}
     */
    UploadDialogService.prototype.uploadFile = /**
     * @param {?} formId
     * @param {?} rootId
     * @param {?=} oldIdList
     * @return {?}
     */
    function (formId, rootId, oldIdList) {
        if (oldIdList === void 0) { oldIdList = []; }
        return this.uploadFileWithLimit(formId, rootId, null, oldIdList);
    };
    /**
     * @param {?} formId
     * @param {?} rootId
     * @param {?} limit
     * @param {?=} oldIdList
     * @return {?}
     */
    UploadDialogService.prototype.uploadFileWithLimit = /**
     * @param {?} formId
     * @param {?} rootId
     * @param {?} limit
     * @param {?=} oldIdList
     * @return {?}
     */
    function (formId, rootId, limit, oldIdList) {
        var _this = this;
        if (oldIdList === void 0) { oldIdList = []; }
        /** @type {?} */
        var flag = 0;
        return new Promise((/**
         * @param {?} resolve
         * @return {?}
         */
        function (resolve) {
            /** @type {?} */
            var uploadFactory = _this.componentFactoryResolver.resolveComponentFactory(FileUploadComponent);
            /** @type {?} */
            var uploadRef = uploadFactory.create(_this.injector);
            if (limit != null) {
                uploadRef.instance.fileCount = limit.fileCount;
                if (limit.fileType != null && limit.fileType != "")
                    uploadRef.instance.fileType = limit.fileType;
            }
            uploadRef.instance.rootId = rootId;
            uploadRef.instance.formId = formId;
            uploadRef.instance.oldIdList = oldIdList;
            _this.dlg = _this.modalService.show(uploadRef, {
                title: '上传文件',
                width: 950, height: 570,
                buttons: [
                    {
                        text: '保存', cls: 'k-button k-button-icontext k-primary', handle: (/**
                         * @return {?}
                         */
                        function () {
                            _this.dlg.content.upload().subscribe((/**
                             * @param {?} res
                             * @return {?}
                             */
                            function (res) {
                                if (res) {
                                    resolve(res);
                                    flag = 1;
                                    _this.dlg.close();
                                }
                            }));
                        })
                    },
                    {
                        text: '关闭', cls: 'k-button k-button-icontext', handle: (/**
                         * @return {?}
                         */
                        function () {
                            _this.dlg.close();
                        })
                    }
                ],
                showButtons: true,
                showMaxButton: false,
                beforeClose: (/**
                 * @return {?}
                 */
                function () {
                    if (flag == 0)
                        _this.dlg.content.cancel();
                    return of(true);
                })
            });
        }));
    };
    UploadDialogService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    UploadDialogService.ctorParameters = function () { return [
        { type: BsModalService },
        { type: ComponentFactoryResolver },
        { type: Injector }
    ]; };
    return UploadDialogService;
}());
export { UploadDialogService };
if (false) {
    /** @type {?} */
    UploadDialogService.prototype.dlg;
    /** @type {?} */
    UploadDialogService.prototype.fileInfoList;
    /**
     * @type {?}
     * @private
     */
    UploadDialogService.prototype.modalService;
    /**
     * @type {?}
     * @private
     */
    UploadDialogService.prototype.componentFactoryResolver;
    /**
     * @type {?}
     * @private
     */
    UploadDialogService.prototype.injector;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBsb2FkZGlhbG9nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXN2Yy9mb3JtZG9jLXVwbG9hZC8iLCJzb3VyY2VzIjpbImxpYi91cGxvYWRkaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDakYsT0FBTyxFQUFFLGNBQWMsRUFBYyxNQUFNLGtCQUFrQixDQUFDO0FBRTlELE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFJdEM7SUFFSSw2QkFBb0IsWUFBNEIsRUFBVSx3QkFBa0QsRUFBVSxRQUFrQjtRQUFwSCxpQkFBWSxHQUFaLFlBQVksQ0FBZ0I7UUFBVSw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUl4SSxpQkFBWSxHQUFxQixFQUFFLENBQUM7SUFKd0csQ0FBQzs7Ozs7O0lBTTdJLHdDQUFVOzs7OztJQUFWLFVBQVcsTUFBYyxFQUFFLE1BQWM7UUFBekMsaUJBMENDOztZQXpDTyxJQUFJLEdBQUcsQ0FBQztRQUNaLE9BQU8sSUFBSSxPQUFPOzs7O1FBQUMsVUFBQSxPQUFPOztnQkFDbEIsYUFBYSxHQUFHLEtBQUksQ0FBQyx3QkFBd0IsQ0FBQyx1QkFBdUIsQ0FBQyxtQkFBbUIsQ0FBQzs7Z0JBQzFGLFNBQVMsR0FBRyxhQUFhLENBQUMsTUFBTSxDQUFDLEtBQUksQ0FBQyxRQUFRLENBQUM7WUFFbkQsU0FBUyxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1lBQ25DLFNBQVMsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztZQUVuQyxLQUFJLENBQUMsR0FBRyxHQUFHLEtBQUksQ0FBQyxZQUFZLENBQUMs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QyxFQUFFLE1BQU07Ozt3QkFBRTs0QkFDN0QsS0FBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsU0FBUzs7Ozs0QkFDL0IsVUFBQSxHQUFHO2dDQUNDLElBQUksR0FBRyxFQUFFO29DQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztvQ0FDYixJQUFJLEdBQUcsQ0FBQyxDQUFDO29DQUNULEtBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7aUNBQ3BCOzRCQUNMLENBQUMsRUFDSixDQUFDO3dCQUNOLENBQUMsQ0FBQTtxQkFDSjtvQkFDRDt3QkFDSSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSw0QkFBNEIsRUFBRSxNQUFNOzs7d0JBQUU7NEJBQ25ELEtBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7d0JBQ3JCLENBQUMsQ0FBQTtxQkFDSjtpQkFDSjtnQkFFRCxXQUFXLEVBQUUsSUFBSTtnQkFDakIsYUFBYSxFQUFFLEtBQUs7Z0JBQ3BCLFdBQVc7OztnQkFBRTtvQkFDVCxJQUFJLElBQUksSUFBSSxDQUFDO3dCQUNULEtBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO29CQUM5QixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDcEIsQ0FBQyxDQUFBO2FBQ0osQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxFQUFDLENBQUE7SUFDTixDQUFDOztnQkExR0osVUFBVTs7OztnQkFORixjQUFjO2dCQUZRLHdCQUF3QjtnQkFBbEMsUUFBUTs7SUFtSDdCLDBCQUFDO0NBQUEsQUEzR0QsSUEyR0M7U0ExR1ksbUJBQW1COzs7SUFHNUIsa0NBQWdCOztJQUVoQiwyQ0FBb0M7Ozs7O0lBSnhCLDJDQUFvQzs7Ozs7SUFBRSx1REFBMEQ7Ozs7O0lBQUUsdUNBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBGaWxlVXBsb2FkQ29tcG9uZW50IH0gZnJvbSAnLi91cGxvYWQvZmlsZS11cGxvYWQvZmlsZS11cGxvYWQuY29tcG9uZW50JztcclxuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UsIEJzTW9kYWxSZWYgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgVXBsb2FkRmlsZUluZm8gfSBmcm9tICcuL3VwbG9hZC9lbnRpdHkvdXBsb2FkZmlsZWluZm8nO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBVcGxvYWRMaW1pdCB9IGZyb20gJy4vdXBsb2FkL2VudGl0eS91cGxvYWRsaW1pdCc7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgVXBsb2FkRGlhbG9nU2VydmljZSB7XHJcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsIHByaXZhdGUgY29tcG9uZW50RmFjdG9yeVJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yKSB7IH1cclxuXHJcbiAgICBkbGc6IEJzTW9kYWxSZWY7XHJcblxyXG4gICAgZmlsZUluZm9MaXN0OiBVcGxvYWRGaWxlSW5mb1tdID0gW107XHJcblxyXG4gICAgc2hvd0RpYWxvZyhmb3JtSWQ6IHN0cmluZywgcm9vdElkOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgZmxhZyA9IDA7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG4gICAgICAgICAgICB2YXIgdmlld2VyRmFjdG9yeSA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KEZpbGVVcGxvYWRDb21wb25lbnQpO1xyXG4gICAgICAgICAgICB2YXIgdmlld2VyUmVmID0gdmlld2VyRmFjdG9yeS5jcmVhdGUodGhpcy5pbmplY3Rvcik7XHJcblxyXG4gICAgICAgICAgICB2aWV3ZXJSZWYuaW5zdGFuY2Uucm9vdElkID0gcm9vdElkO1xyXG4gICAgICAgICAgICB2aWV3ZXJSZWYuaW5zdGFuY2UuZm9ybUlkID0gZm9ybUlkO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kbGcgPSB0aGlzLm1vZGFsU2VydmljZS5zaG93KHZpZXdlclJlZiwge1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6ICfkuIrkvKDmlofku7YnLFxyXG4gICAgICAgICAgICAgICAgd2lkdGg6IDk1MCwgaGVpZ2h0OiA1NzAsXHJcbiAgICAgICAgICAgICAgICBidXR0b25zOiBbXHJcbiAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAn5L+d5a2YJywgY2xzOiAnay1idXR0b24gay1idXR0b24taWNvbnRleHQgay1wcmltYXJ5JywgaGFuZGxlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRsZy5jb250ZW50LnVwbG9hZCgpLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFnID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGxnLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6ICflhbPpl60nLCBjbHM6ICdrLWJ1dHRvbiBrLWJ1dHRvbi1pY29udGV4dCcsIGhhbmRsZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcblxyXG4gICAgICAgICAgICAgICAgc2hvd0J1dHRvbnM6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93TWF4QnV0dG9uOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGJlZm9yZUNsb3NlOiAoKTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWcgPT0gMClcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY29udGVudC5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgdXBsb2FkRmlsZShmb3JtSWQ6IHN0cmluZywgcm9vdElkOiBzdHJpbmcsb2xkSWRMaXN0OiBzdHJpbmdbXT1bXSkgeyBcclxuICAgICAgICByZXR1cm4gdGhpcy51cGxvYWRGaWxlV2l0aExpbWl0KGZvcm1JZCwgcm9vdElkLCBudWxsLCBvbGRJZExpc3QpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICB1cGxvYWRGaWxlV2l0aExpbWl0KGZvcm1JZDogc3RyaW5nLCByb290SWQ6IHN0cmluZywgbGltaXQ6IFVwbG9hZExpbWl0LCBvbGRJZExpc3Q6IHN0cmluZ1tdPVtdKSB7XHJcbiAgICAgICAgbGV0IGZsYWcgPSAwO1xyXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcclxuICAgICAgICAgICAgdmFyIHVwbG9hZEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShGaWxlVXBsb2FkQ29tcG9uZW50KTtcclxuICAgICAgICAgICAgdmFyIHVwbG9hZFJlZiA9IHVwbG9hZEZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWN0b3IpO1xyXG4gICAgICAgICAgICBpZiAobGltaXQgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLmZpbGVDb3VudCA9IGxpbWl0LmZpbGVDb3VudDtcclxuICAgICAgICAgICAgICAgIGlmIChsaW1pdC5maWxlVHlwZSAhPSBudWxsICYmIGxpbWl0LmZpbGVUeXBlICE9IFwiXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLmZpbGVUeXBlID0gbGltaXQuZmlsZVR5cGVcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLnJvb3RJZCA9IHJvb3RJZDtcclxuICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLmZvcm1JZCA9IGZvcm1JZDtcclxuICAgICAgICAgICAgdXBsb2FkUmVmLmluc3RhbmNlLm9sZElkTGlzdD1vbGRJZExpc3Q7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRsZyA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3codXBsb2FkUmVmLCB7XHJcbiAgICAgICAgICAgICAgICB0aXRsZTogJ+S4iuS8oOaWh+S7ticsXHJcbiAgICAgICAgICAgICAgICB3aWR0aDogOTUwLCBoZWlnaHQ6IDU3MCxcclxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IFtcclxuICAgICAgICAgICAgICAgICAgICB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiAn5L+d5a2YJywgY2xzOiAnay1idXR0b24gay1idXR0b24taWNvbnRleHQgay1wcmltYXJ5JywgaGFuZGxlOiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRsZy5jb250ZW50LnVwbG9hZCgpLnN1YnNjcmliZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXMgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbGFnID0gMTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGxnLmNsb3NlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6ICflhbPpl60nLCBjbHM6ICdrLWJ1dHRvbiBrLWJ1dHRvbi1pY29udGV4dCcsIGhhbmRsZTogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY2xvc2UoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIF0sXHJcblxyXG4gICAgICAgICAgICAgICAgc2hvd0J1dHRvbnM6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBzaG93TWF4QnV0dG9uOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgIGJlZm9yZUNsb3NlOiAoKTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZsYWcgPT0gMClcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kbGcuY29udGVudC5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcbn0iXX0=