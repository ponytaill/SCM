/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, ComponentFactoryResolver } from '@angular/core';
import { MessagerService } from '@farris/ui-messager';
import { BsModalService } from '@farris/ui-modal';
import { UIFlowchartComponent } from './task-flowchart/task-flowchart.component';
import { translate } from './services/i18n/index';
import { UiFlowchartService } from './services/ui-flowchart.service';
import { FrameworkService } from '@gsp-sys/rtf-common';
import { of } from 'rxjs';
import { HttpService } from '@ecp-caf/caf-common';
var WFFlowchartService = /** @class */ (function () {
    function WFFlowchartService(msgService, injector, resolver, modalService) {
        this.msgService = msgService;
        this.injector = injector;
        this.resolver = resolver;
        this.modalService = modalService;
        this.flowchartService = this.injector.get(UiFlowchartService);
        this.frameworkService = this.injector.get(FrameworkService);
    }
    /**
     * @param {?} payload
     * @return {?}
     */
    WFFlowchartService.prototype.viewProcess = /**
     * @param {?} payload
     * @return {?}
     */
    function (payload) {
        if (!payload || !payload.dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noDataId'));
            return;
        }
        if (!payload || !payload.bizDefKey) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noBizDefKey'));
            return;
        }
        /** @type {?} */
        var parameters = new Map();
        parameters.set('dataId', payload.dataId);
        parameters.set('bizDefKey', payload.bizDefKey);
        if (payload.startMode) {
            parameters.set('startMode', payload.startMode);
        }
        if (payload.startUserId) {
            parameters.set('startUserId', payload.startUserId);
        }
        parameters.set('withTitle', true);
        /** @type {?} */
        var options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: payload.dataId,
            isNewTab: true,
            queryStringParams: parameters
        };
        this.frameworkService.openMenu(options);
    };
    /**
     * 查看流程（tab页中打开）
     * @param procInstId 流程实例ID
     */
    /**
     * 查看流程（tab页中打开）
     * @param {?} procInstId 流程实例ID
     * @return {?}
     */
    WFFlowchartService.prototype.viewFlowChart = /**
     * 查看流程（tab页中打开）
     * @param {?} procInstId 流程实例ID
     * @return {?}
     */
    function (procInstId) {
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        /** @type {?} */
        var parameters = new Map();
        parameters.set('processId', procInstId);
        parameters.set('withTitle', true);
        /** @type {?} */
        var options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.frameworkService.openMenu(options);
    };
    /**
     * @param {?} dataId
     * @return {?}
     */
    WFFlowchartService.prototype.viewFlowChartByDataId = /**
     * @param {?} dataId
     * @return {?}
     */
    function (dataId) {
        if (!dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.dataIdIsNull'));
            return;
        }
        /** @type {?} */
        var parameters = new Map();
        parameters.set('dataId', dataId);
        parameters.set('withTitle', true);
        /** @type {?} */
        var options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.frameworkService.openMenu(options);
    };
    /**
     * 查看流程（弹框中打开）
     * @param procInstId 流程实例ID
     */
    /**
     * 查看流程（弹框中打开）
     * @param {?} procInstId 流程实例ID
     * @param {?=} mode
     * @return {?}
     */
    WFFlowchartService.prototype.viewFlowChartByDialog = /**
     * 查看流程（弹框中打开）
     * @param {?} procInstId 流程实例ID
     * @param {?=} mode
     * @return {?}
     */
    function (procInstId, mode) {
        var _this = this;
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        /** @type {?} */
        var func;
        if (UIFlowchartComponent.func) {
            func = UIFlowchartComponent.func;
        }
        /** @type {?} */
        var modalConfig = {
            title: this.getI18nValue('static.flowchart.title'),
            width: 1200,
            height: 530,
            showButtons: false,
            beforeClose: function (modalRef) {
                if (UIFlowchartComponent.func) {
                    window.removeEventListener('message', UIFlowchartComponent.func, false);
                }
                if (func) {
                    window.addEventListener('message', func, false);
                    UIFlowchartComponent.func = func;
                }
                return of(true);
            }
        };
        /** @type {?} */
        var compFactory = this.resolver.resolveComponentFactory(UIFlowchartComponent);
        /** @type {?} */
        var inj = Injector.create({
            providers: [
                {
                    provide: UiFlowchartService, useFactory: function (httpSvc) {
                        return new UiFlowchartService(httpSvc);
                    },
                    deps: [
                        HttpService
                    ]
                }
            ], parent: this.injector
        });
        /** @type {?} */
        var compRef = compFactory.create(inj);
        compRef.instance.ProcInstId = procInstId;
        if (mode) {
            compRef.instance.mode = mode;
        }
        compRef.instance.fill();
        this.flowchartService.getProcessInstanceById(procInstId).subscribe(function (re) {
            modalConfig.title = re.name + '-v' + re.version + '.0';
            /** @type {?} */
            var dialog = _this.modalService.show(compRef, modalConfig);
        });
    };
    /**
     * @private
     * @param {?} name
     * @return {?}
     */
    WFFlowchartService.prototype.getI18nValue = /**
     * @private
     * @param {?} name
     * @return {?}
     */
    function (name) {
        if (!name) {
            return '';
        }
        /** @type {?} */
        var defaultLang = localStorage.getItem('languageCode');
        /** @type {?} */
        var langData = defaultLang ? translate[defaultLang] : translate['zh-CHS'];
        /** @type {?} */
        var resultVal = '';
        if (name.indexOf('.') === -1) {
            resultVal = langData[name];
        }
        else {
            resultVal = name.split('.').reduce(function (obj, key) {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }, langData);
        }
        return resultVal;
    };
    WFFlowchartService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    WFFlowchartService.ctorParameters = function () { return [
        { type: MessagerService },
        { type: Injector },
        { type: ComponentFactoryResolver },
        { type: BsModalService }
    ]; };
    return WFFlowchartService;
}());
export { WFFlowchartService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.flowchartService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.frameworkService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.msgService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.resolver;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.modalService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2YtZmxvd2NoYXJ0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXdmL3VpLWZsb3djaGFydC8iLCJzb3VyY2VzIjpbImxpYi93Zi1mbG93Y2hhcnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBZ0IsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDakYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3JFLE9BQU8sRUFBYyxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBSWxEO0lBTUksNEJBQ1ksVUFBMkIsRUFDM0IsUUFBa0IsRUFDbEIsUUFBa0MsRUFDbEMsWUFBNEI7UUFINUIsZUFBVSxHQUFWLFVBQVUsQ0FBaUI7UUFDM0IsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixhQUFRLEdBQVIsUUFBUSxDQUEwQjtRQUNsQyxpQkFBWSxHQUFaLFlBQVksQ0FBZ0I7UUFFcEMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDaEUsQ0FBQzs7Ozs7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Ozs7O0lBRU8seUNBQVk7Ozs7O0lBQXBCLFVBQXFCLElBQVk7UUFDN0IsSUFBSSxDQUFDLElBQUksRUFBRTtZQUFFLE9BQU8sRUFBRSxDQUFDO1NBQUU7O1lBQ3JCLFdBQVcsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQzs7WUFDbEQsUUFBUSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDOztZQUNyRSxTQUFTLEdBQUcsRUFBRTtRQUNsQixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDMUIsU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QjthQUFNO1lBQ0gsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUMsR0FBRyxFQUFFLEdBQUc7Z0JBQ3hDLElBQUksR0FBRyxFQUFFO29CQUNMLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNuQjtxQkFBTTtvQkFDSCxPQUFPLElBQUksQ0FBQztpQkFDZjtZQUNMLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNoQjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7O2dCQWpLSixVQUFVOzs7O2dCQVhGLGVBQWU7Z0JBREgsUUFBUTtnQkFBRSx3QkFBd0I7Z0JBRWhDLGNBQWM7O0lBNEtyQyx5QkFBQztDQUFBLEFBbEtELElBa0tDO1NBaktZLGtCQUFrQjs7Ozs7O0lBRTNCLDhDQUE2Qzs7Ozs7SUFDN0MsOENBQTJDOzs7OztJQUd2Qyx3Q0FBbUM7Ozs7O0lBQ25DLHNDQUEwQjs7Ozs7SUFDMUIsc0NBQTBDOzs7OztJQUMxQywwQ0FBb0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE1lc3NhZ2VyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktbWVzc2FnZXInO1xyXG5pbXBvcnQgeyBNb2RhbE9wdGlvbnMsIEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tb2RhbCc7XHJcbmltcG9ydCB7IFVJRmxvd2NoYXJ0Q29tcG9uZW50IH0gZnJvbSAnLi90YXNrLWZsb3djaGFydC90YXNrLWZsb3djaGFydC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyB0cmFuc2xhdGUgfSBmcm9tICcuL3NlcnZpY2VzL2kxOG4vaW5kZXgnO1xyXG5pbXBvcnQgeyBVaUZsb3djaGFydFNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzL3VpLWZsb3djaGFydC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXBwT3B0aW9ucywgRnJhbWV3b3JrU2VydmljZSB9IGZyb20gJ0Bnc3Atc3lzL3J0Zi1jb21tb24nO1xyXG5pbXBvcnQgeyBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBIdHRwU2VydmljZSB9IGZyb20gJ0BlY3AtY2FmL2NhZi1jb21tb24nO1xyXG5pbXBvcnQgeyBGb3JlY2FzdFByb2Nlc3NQYXlsb2FkIH0gZnJvbSAnLi9lbnRpdHkvZm9yZWNhc3QtcHJvY2Vzcy1wYXlsb2FkJztcclxuXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBXRkZsb3djaGFydFNlcnZpY2Uge1xyXG5cclxuICAgIHByaXZhdGUgZmxvd2NoYXJ0U2VydmljZTogVWlGbG93Y2hhcnRTZXJ2aWNlO1xyXG4gICAgcHJpdmF0ZSBmcmFtZXdvcmtTZXJ2aWNlOiBGcmFtZXdvcmtTZXJ2aWNlO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgbXNnU2VydmljZTogTWVzc2FnZXJTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgICAgIHByaXZhdGUgcmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICAgICAgICBwcml2YXRlIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXHJcbiAgICApIHtcclxuICAgICAgICB0aGlzLmZsb3djaGFydFNlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldChVaUZsb3djaGFydFNlcnZpY2UpO1xyXG4gICAgICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEZyYW1ld29ya1NlcnZpY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHZpZXdQcm9jZXNzKHBheWxvYWQ6IEZvcmVjYXN0UHJvY2Vzc1BheWxvYWQpIHtcclxuICAgICAgICBpZiAoIXBheWxvYWQgfHwgIXBheWxvYWQuZGF0YUlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0Lm5vRGF0YUlkJykpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghcGF5bG9hZCB8fCAhcGF5bG9hZC5iaXpEZWZLZXkpIHtcclxuICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5nZXRJMThuVmFsdWUoJ3N0YXRpYy5mbG93Y2hhcnQubm9CaXpEZWZLZXknKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFyYW1ldGVycyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ2RhdGFJZCcsIHBheWxvYWQuZGF0YUlkKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgnYml6RGVmS2V5JywgcGF5bG9hZC5iaXpEZWZLZXkpO1xyXG4gICAgICAgIGlmIChwYXlsb2FkLnN0YXJ0TW9kZSkge1xyXG4gICAgICAgICAgICBwYXJhbWV0ZXJzLnNldCgnc3RhcnRNb2RlJywgcGF5bG9hZC5zdGFydE1vZGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGF5bG9hZC5zdGFydFVzZXJJZCkge1xyXG4gICAgICAgICAgICBwYXJhbWV0ZXJzLnNldCgnc3RhcnRVc2VySWQnLCBwYXlsb2FkLnN0YXJ0VXNlcklkKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ3dpdGhUaXRsZScsIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6ICdtZW51JyxcclxuICAgICAgICAgICAgZnVuY0lkOiAnV0ZWaWV3Rmxvd0NoYXJ0JyxcclxuICAgICAgICAgICAgYXBwSWQ6ICcnLFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogJycsXHJcbiAgICAgICAgICAgIHRhYklkOiBwYXlsb2FkLmRhdGFJZCxcclxuICAgICAgICAgICAgaXNOZXdUYWI6IHRydWUsXHJcbiAgICAgICAgICAgIHF1ZXJ5U3RyaW5nUGFyYW1zOiBwYXJhbWV0ZXJzXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmZyYW1ld29ya1NlcnZpY2Uub3Blbk1lbnUob3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDmn6XnnIvmtYHnqIvvvIh0YWLpobXkuK3miZPlvIDvvIlcclxuICAgICAqIEBwYXJhbSBwcm9jSW5zdElkIOa1geeoi+WunuS+i0lEXHJcbiAgICAgKi9cclxuICAgIHZpZXdGbG93Q2hhcnQocHJvY0luc3RJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFwcm9jSW5zdElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0LnByb2Nlc3NOb3RGb3VuZCcpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJhbWV0ZXJzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgncHJvY2Vzc0lkJywgcHJvY0luc3RJZCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ3dpdGhUaXRsZScsIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6ICdtZW51JyxcclxuICAgICAgICAgICAgZnVuY0lkOiAnV0ZWaWV3Rmxvd0NoYXJ0JyxcclxuICAgICAgICAgICAgYXBwSWQ6ICcnLFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogJycsXHJcbiAgICAgICAgICAgIHRhYklkOiBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpLFxyXG4gICAgICAgICAgICBpc05ld1RhYjogdHJ1ZSxcclxuICAgICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHBhcmFtZXRlcnNcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZS5vcGVuTWVudShvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICB2aWV3Rmxvd0NoYXJ0QnlEYXRhSWQoZGF0YUlkOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoIWRhdGFJZCkge1xyXG4gICAgICAgICAgICB0aGlzLm1zZ1NlcnZpY2Uud2FybmluZyh0aGlzLmdldEkxOG5WYWx1ZSgnc3RhdGljLmZsb3djaGFydC5kYXRhSWRJc051bGwnKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcGFyYW1ldGVycyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ2RhdGFJZCcsIGRhdGFJZCk7XHJcbiAgICAgICAgcGFyYW1ldGVycy5zZXQoJ3dpdGhUaXRsZScsIHRydWUpO1xyXG4gICAgICAgIGNvbnN0IG9wdGlvbnM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6ICdtZW51JyxcclxuICAgICAgICAgICAgZnVuY0lkOiAnV0ZWaWV3Rmxvd0NoYXJ0JyxcclxuICAgICAgICAgICAgYXBwSWQ6ICcnLFxyXG4gICAgICAgICAgICBhcHBFbnRyYW5jZTogJycsXHJcbiAgICAgICAgICAgIHRhYklkOiBuZXcgRGF0ZSgpLmdldFRpbWUoKS50b1N0cmluZygpLFxyXG4gICAgICAgICAgICBpc05ld1RhYjogdHJ1ZSxcclxuICAgICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHBhcmFtZXRlcnNcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZS5vcGVuTWVudShvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOafpeeci+a1geeoi++8iOW8ueahhuS4reaJk+W8gO+8iVxyXG4gICAgICogQHBhcmFtIHByb2NJbnN0SWQg5rWB56iL5a6e5L6LSURcclxuICAgICAqL1xyXG4gICAgdmlld0Zsb3dDaGFydEJ5RGlhbG9nKHByb2NJbnN0SWQ6IHN0cmluZywgbW9kZT86IHN0cmluZykge1xyXG4gICAgICAgIGlmICghcHJvY0luc3RJZCkge1xyXG4gICAgICAgICAgICB0aGlzLm1zZ1NlcnZpY2Uud2FybmluZyh0aGlzLmdldEkxOG5WYWx1ZSgnc3RhdGljLmZsb3djaGFydC5wcm9jZXNzTm90Rm91bmQnKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgbGV0IGZ1bmM7XHJcbiAgICAgICAgaWYgKFVJRmxvd2NoYXJ0Q29tcG9uZW50LmZ1bmMpIHtcclxuICAgICAgICAgICAgZnVuYyA9IFVJRmxvd2NoYXJ0Q29tcG9uZW50LmZ1bmM7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IG1vZGFsQ29uZmlnOiBNb2RhbE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIHRpdGxlOiB0aGlzLmdldEkxOG5WYWx1ZSgnc3RhdGljLmZsb3djaGFydC50aXRsZScpLFxyXG4gICAgICAgICAgICB3aWR0aDogMTIwMCxcclxuICAgICAgICAgICAgaGVpZ2h0OiA1MzAsXHJcbiAgICAgICAgICAgIHNob3dCdXR0b25zOiBmYWxzZSxcclxuICAgICAgICAgICAgYmVmb3JlQ2xvc2U6IChtb2RhbFJlZjogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoVUlGbG93Y2hhcnRDb21wb25lbnQuZnVuYykge1xyXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgVUlGbG93Y2hhcnRDb21wb25lbnQuZnVuYywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKGZ1bmMpIHtcclxuICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmMsIGZhbHNlKTtcclxuICAgICAgICAgICAgICAgICAgICBVSUZsb3djaGFydENvbXBvbmVudC5mdW5jID0gZnVuYztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgY29uc3QgY29tcEZhY3RvcnkgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KFVJRmxvd2NoYXJ0Q29tcG9uZW50KTtcclxuICAgICAgICBjb25zdCBpbmogPSBJbmplY3Rvci5jcmVhdGUoe1xyXG4gICAgICAgICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBwcm92aWRlOiBVaUZsb3djaGFydFNlcnZpY2UsIHVzZUZhY3Rvcnk6IChodHRwU3ZjKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgVWlGbG93Y2hhcnRTZXJ2aWNlKGh0dHBTdmMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZGVwczogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBIdHRwU2VydmljZVxyXG4gICAgICAgICAgICAgICAgICAgIF1cclxuICAgICAgICAgICAgICAgIH1dLCBwYXJlbnQ6IHRoaXMuaW5qZWN0b3JcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBjb21wUmVmID0gY29tcEZhY3RvcnkuY3JlYXRlKGluaik7XHJcbiAgICAgICAgY29tcFJlZi5pbnN0YW5jZS5Qcm9jSW5zdElkID0gcHJvY0luc3RJZDtcclxuICAgICAgICBpZiAobW9kZSkge1xyXG4gICAgICAgICAgICBjb21wUmVmLmluc3RhbmNlLm1vZGUgPSBtb2RlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb21wUmVmLmluc3RhbmNlLmZpbGwoKTtcclxuICAgICAgICB0aGlzLmZsb3djaGFydFNlcnZpY2UuZ2V0UHJvY2Vzc0luc3RhbmNlQnlJZChwcm9jSW5zdElkKS5zdWJzY3JpYmUocmUgPT4ge1xyXG4gICAgICAgICAgICBtb2RhbENvbmZpZy50aXRsZSA9IHJlLm5hbWUgKyAnLXYnICsgcmUudmVyc2lvbiArICcuMCc7XHJcbiAgICAgICAgICAgIGNvbnN0IGRpYWxvZyA9IHRoaXMubW9kYWxTZXJ2aWNlLnNob3coY29tcFJlZiwgbW9kYWxDb25maWcpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRJMThuVmFsdWUobmFtZTogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFuYW1lKSB7IHJldHVybiAnJzsgfVxyXG4gICAgICAgIHZhciBkZWZhdWx0TGFuZyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYW5ndWFnZUNvZGUnKTtcclxuICAgICAgICB2YXIgbGFuZ0RhdGEgPSBkZWZhdWx0TGFuZyA/IHRyYW5zbGF0ZVtkZWZhdWx0TGFuZ10gOiB0cmFuc2xhdGVbJ3poLUNIUyddO1xyXG4gICAgICAgIGxldCByZXN1bHRWYWwgPSAnJztcclxuICAgICAgICBpZiAobmFtZS5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFZhbCA9IGxhbmdEYXRhW25hbWVdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFZhbCA9IG5hbWUuc3BsaXQoJy4nKS5yZWR1Y2UoKG9iaiwga2V5KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAob2JqKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9ialtrZXldO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSwgbGFuZ0RhdGEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0VmFsO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==