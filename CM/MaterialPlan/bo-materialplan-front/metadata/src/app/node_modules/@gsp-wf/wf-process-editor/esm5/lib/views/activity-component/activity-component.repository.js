/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { ActivityComponentUIState } from './activity-component.uistate';
import { HttpService } from '@ecp-caf/caf-common';
import { BizComponentEntity, OwnerType } from '../../domain/entities/biz-component.entity';
import { ProcessDesignerUIState } from '../../app/process-designer.uistate';
import { Subject } from 'rxjs';
import { ProcessDeUtil } from '../../domain/process-de-util';
var ActivityComponentRepository = /** @class */ (function () {
    function ActivityComponentRepository(uistate, util, http, designerState) {
        this.uistate = uistate;
        this.util = util;
        this.http = http;
        this.designerState = designerState;
        this.defaultProcessComponentIds = ['5863c8a8-e0a7-4137-a8b2-4c05e42b3b73', 'be781ba1-a88b-4bb8-9c88-2e2a27a9226e'];
        this.subject = new Subject();
    }
    /**
     * @param {?} flowFormId
     * @param {?} bizActId
     * @return {?}
     */
    ActivityComponentRepository.prototype.loadComponents = /**
     * @param {?} flowFormId
     * @param {?} bizActId
     * @return {?}
     */
    function (flowFormId, bizActId) {
        var _this = this;
        /** @type {?} */
        var url = this.util.getBizComponentsWebApi();
        if (bizActId) {
            url += "/query?param=" + encodeURIComponent("{\"flowFormKey\":\"" + flowFormId + "\",\"owner\":\"" + bizActId + "\",\"ownerType\":\"Activity\"}");
        }
        else {
            this.uistate.allComponents = [];
            return;
        }
        this.http.get(url).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        function (data) {
            _this.uistate.allComponents = data.filter((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.ownerType === OwnerType.Activity; }));
        }));
    };
    /**
     * @param {?} id
     * @return {?}
     */
    ActivityComponentRepository.prototype.removeComponent = /**
     * @param {?} id
     * @return {?}
     */
    function (id) {
        if (id) {
            /** @type {?} */
            var index = this.uistate.components.findIndex((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.id === id; }));
            if (index > -1) {
                this.uistate.components.splice(index, 1);
                if (this.uistate.components.length > 0) {
                    this.subject.next(this.uistate.components[0]);
                }
                else {
                    this.uistate.curComponent = null;
                }
            }
        }
    };
    /**
     * @param {?} cpt
     * @return {?}
     */
    ActivityComponentRepository.prototype.addComponent = /**
     * @param {?} cpt
     * @return {?}
     */
    function (cpt) {
        if (cpt) {
            /** @type {?} */
            var component = new BizComponentEntity(cpt.name, cpt.id, cpt.operations[0].code);
            component.id = ProcessDeUtil.GenerateElementId();
            component.actualParameters = this.bindParas(cpt);
            this.uistate.components.push(component);
            this.subject.next(component);
        }
    };
    /**
     * @private
     * @param {?} component
     * @return {?}
     */
    ActivityComponentRepository.prototype.bindParas = /**
     * @private
     * @param {?} component
     * @return {?}
     */
    function (component) {
        /** @type {?} */
        var parameters = [];
        if (component.operations[0].parameters && component.operations[0].parameters.length > 0) {
            if (this.defaultProcessComponentIds.indexOf(component.id) > -1) {
                parameters = this.assignParameterValue(component.operations[0].parameters);
            }
            else {
                parameters = component.operations[0].parameters.map((/**
                 * @param {?} p
                 * @return {?}
                 */
                function (p) { return ({ code: p.code, name: p.name, value: '' }); }));
            }
        }
        return parameters;
    };
    /**
     * @private
     * @param {?} params
     * @return {?}
     */
    ActivityComponentRepository.prototype.assignParameterValue = /**
     * @private
     * @param {?} params
     * @return {?}
     */
    function (params) {
        var _this = this;
        return params.map((/**
         * @param {?} p
         * @return {?}
         */
        function (p) {
            if (p.code.indexOf('beId') > -1) {
                /** @type {?} */
                var v = _this.designerState.formalParameterContext.filter((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c.key.indexOf('metadataId') > -1; }))[0].key;
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"" + v + "\\\")\"}" };
            }
            else if (p.code.indexOf('nodeId') > -1) {
                /** @type {?} */
                var v = _this.designerState.formalParameterContext.filter((/**
                 * @param {?} c
                 * @return {?}
                 */
                function (c) { return c.key.indexOf('schemaId') > -1; }))[0].key;
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"" + v + "\\\")\"}" };
            }
            else if (p.code.indexOf('dataId') > -1) {
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"dataId\\\")\"}" };
            }
            else if (p.code.indexOf('procInstId') > -1) {
                return { code: p.code, name: p.name, value: "{\"expr\":\"DefaultFunction.GetContextParameter(\\\"procInstId\\\")\"}" };
            }
            else {
                return { code: p.code, name: p.name, value: '' };
            }
        }));
    };
    /**
     * @param {?} arr
     * @param {?} i1
     * @param {?} i2
     * @return {?}
     */
    ActivityComponentRepository.prototype.swapArray = /**
     * @param {?} arr
     * @param {?} i1
     * @param {?} i2
     * @return {?}
     */
    function (arr, i1, i2) {
        arr[i1] = arr.splice(i2, 1, arr[i1])[0];
        return arr;
    };
    ActivityComponentRepository.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ActivityComponentRepository.ctorParameters = function () { return [
        { type: ActivityComponentUIState },
        { type: ProcessDeUtil },
        { type: HttpService },
        { type: ProcessDesignerUIState }
    ]; };
    return ActivityComponentRepository;
}());
export { ActivityComponentRepository };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.defaultProcessComponentIds;
    /** @type {?} */
    ActivityComponentRepository.prototype.subject;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.uistate;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.util;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.designerState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aXZpdHktY29tcG9uZW50LnJlcG9zaXRvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXdmL3dmLXByb2Nlc3MtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL3ZpZXdzL2FjdGl2aXR5LWNvbXBvbmVudC9hY3Rpdml0eS1jb21wb25lbnQucmVwb3NpdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFbEQsT0FBTyxFQUFFLGtCQUFrQixFQUFxQixTQUFTLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUk5RyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUM1RSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUM3RDtJQU1JLHFDQUNZLE9BQWlDLEVBQ2pDLElBQW1CLEVBQ25CLElBQWlCLEVBQ2pCLGFBQXFDO1FBSHJDLFlBQU8sR0FBUCxPQUFPLENBQTBCO1FBQ2pDLFNBQUksR0FBSixJQUFJLENBQWU7UUFDbkIsU0FBSSxHQUFKLElBQUksQ0FBYTtRQUNqQixrQkFBYSxHQUFiLGFBQWEsQ0FBd0I7UUFQekMsK0JBQTBCLEdBQUcsQ0FBQyxzQ0FBc0MsRUFBRSxzQ0FBc0MsQ0FBQyxDQUFDO1FBRXRILFlBQU8sR0FBZ0MsSUFBSSxPQUFPLEVBQXNCLENBQUM7SUFNckUsQ0FBQzs7Ozs7O0lBRUwsb0RBQWM7Ozs7O0lBQWQsVUFBZSxVQUFrQixFQUFFLFFBQWdCO1FBQW5ELGlCQVdDOztZQVZPLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1FBQzVDLElB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U0FsRlksMkJBQTJCOzs7Ozs7SUFDcEMsaUVBQXNIOztJQUV0SCw4Q0FBeUU7Ozs7O0lBRXJFLDhDQUF5Qzs7Ozs7SUFDekMsMkNBQTJCOzs7OztJQUMzQiwyQ0FBeUI7Ozs7O0lBQ3pCLG9EQUE2QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQWN0aXZpdHlDb21wb25lbnRVSVN0YXRlIH0gZnJvbSAnLi9hY3Rpdml0eS1jb21wb25lbnQudWlzdGF0ZSc7XHJcbmltcG9ydCB7IEh0dHBTZXJ2aWNlIH0gZnJvbSAnQGVjcC1jYWYvY2FmLWNvbW1vbic7XHJcbmltcG9ydCB7IG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgQml6Q29tcG9uZW50RW50aXR5LCBDb21wb25lbnRMb2NhdGlvbiwgT3duZXJUeXBlIH0gZnJvbSAnLi4vLi4vZG9tYWluL2VudGl0aWVzL2Jpei1jb21wb25lbnQuZW50aXR5JztcclxuaW1wb3J0IHsgR3NwQ29tcG9uZW50IH0gZnJvbSAnQGdzcC1jbXAvY29tbW9uLWNvbXBvbmVudCc7XHJcbmltcG9ydCB7IEFjdHVhbFBhcmFtZXRlciB9IGZyb20gJy4uLy4uL2RvbWFpbi9lbnRpdGllcy9hY3R1YWwtcGFyYW1ldGVyJztcclxuaW1wb3J0IHsgUGFyYW1ldGVyIH0gZnJvbSAnQGVjcC1jYWYvY29tbW9uLXN0cnVjdHVyZSc7XHJcbmltcG9ydCB7IFByb2Nlc3NEZXNpZ25lclVJU3RhdGUgfSBmcm9tICcuLi8uLi9hcHAvcHJvY2Vzcy1kZXNpZ25lci51aXN0YXRlJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBQcm9jZXNzRGVVdGlsIH0gZnJvbSAnLi4vLi4vZG9tYWluL3Byb2Nlc3MtZGUtdXRpbCc7XHJcbkBJbmplY3RhYmxlKClcclxuXHJcbmV4cG9ydCBjbGFzcyBBY3Rpdml0eUNvbXBvbmVudFJlcG9zaXRvcnkge1xyXG4gICAgcHJpdmF0ZSBkZWZhdWx0UHJvY2Vzc0NvbXBvbmVudElkcyA9IFsnNTg2M2M4YTgtZTBhNy00MTM3LWE4YjItNGMwNWU0MmIzYjczJywgJ2JlNzgxYmExLWE4OGItNGJiOC05Yzg4LTJlMmEyN2E5MjI2ZSddO1xyXG5cclxuICAgIHN1YmplY3Q6IFN1YmplY3Q8Qml6Q29tcG9uZW50RW50aXR5PiA9IG5ldyBTdWJqZWN0PEJpekNvbXBvbmVudEVudGl0eT4oKTtcclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHByaXZhdGUgdWlzdGF0ZTogQWN0aXZpdHlDb21wb25lbnRVSVN0YXRlLFxyXG4gICAgICAgIHByaXZhdGUgdXRpbDogUHJvY2Vzc0RlVXRpbCxcclxuICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgZGVzaWduZXJTdGF0ZTogUHJvY2Vzc0Rlc2lnbmVyVUlTdGF0ZVxyXG4gICAgKSB7IH1cclxuXHJcbiAgICBsb2FkQ29tcG9uZW50cyhmbG93Rm9ybUlkOiBzdHJpbmcsIGJpekFjdElkOiBzdHJpbmcpIHtcclxuICAgICAgICBsZXQgdXJsID0gdGhpcy51dGlsLmdldEJpekNvbXBvbmVudHNXZWJBcGkoKTtcclxuICAgICAgICBpZiAoYml6QWN0SWQpIHtcclxuICAgICAgICAgICAgdXJsICs9IGAvcXVlcnk/cGFyYW09YCArIGVuY29kZVVSSUNvbXBvbmVudChge1wiZmxvd0Zvcm1LZXlcIjpcIiR7Zmxvd0Zvcm1JZH1cIixcIm93bmVyXCI6XCIke2JpekFjdElkfVwiLFwib3duZXJUeXBlXCI6XCJBY3Rpdml0eVwifWApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudWlzdGF0ZS5hbGxDb21wb25lbnRzID0gW107XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5odHRwLmdldCh1cmwpLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMudWlzdGF0ZS5hbGxDb21wb25lbnRzID0gZGF0YS5maWx0ZXIoKGM6IEJpekNvbXBvbmVudEVudGl0eSkgPT4gYy5vd25lclR5cGUgPT09IE93bmVyVHlwZS5BY3Rpdml0eSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICByZW1vdmVDb21wb25lbnQoaWQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmIChpZCkge1xyXG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IHRoaXMudWlzdGF0ZS5jb21wb25lbnRzLmZpbmRJbmRleChjID0+IGMuaWQgPT09IGlkKTtcclxuICAgICAgICAgICAgaWYgKGluZGV4ID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudWlzdGF0ZS5jb21wb25lbnRzLnNwbGljZShpbmRleCwgMSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMudWlzdGF0ZS5jb21wb25lbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnN1YmplY3QubmV4dCh0aGlzLnVpc3RhdGUuY29tcG9uZW50c1swXSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudWlzdGF0ZS5jdXJDb21wb25lbnQgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgYWRkQ29tcG9uZW50KGNwdDogR3NwQ29tcG9uZW50KSB7XHJcbiAgICAgICAgaWYgKGNwdCkge1xyXG4gICAgICAgICAgICBjb25zdCBjb21wb25lbnQgPSBuZXcgQml6Q29tcG9uZW50RW50aXR5KGNwdC5uYW1lLCBjcHQuaWQsIGNwdC5vcGVyYXRpb25zWzBdLmNvZGUpO1xyXG4gICAgICAgICAgICBjb21wb25lbnQuaWQgPSBQcm9jZXNzRGVVdGlsLkdlbmVyYXRlRWxlbWVudElkKCk7XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC5hY3R1YWxQYXJhbWV0ZXJzID0gdGhpcy5iaW5kUGFyYXMoY3B0KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMudWlzdGF0ZS5jb21wb25lbnRzLnB1c2goY29tcG9uZW50KTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KGNvbXBvbmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBiaW5kUGFyYXMoY29tcG9uZW50OiBHc3BDb21wb25lbnQpOiBBY3R1YWxQYXJhbWV0ZXJbXSB7XHJcbiAgICAgICAgbGV0IHBhcmFtZXRlcnMgPSBbXTtcclxuXHJcbiAgICAgICAgaWYgKGNvbXBvbmVudC5vcGVyYXRpb25zWzBdLnBhcmFtZXRlcnMgJiYgY29tcG9uZW50Lm9wZXJhdGlvbnNbMF0ucGFyYW1ldGVycy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRlZmF1bHRQcm9jZXNzQ29tcG9uZW50SWRzLmluZGV4T2YoY29tcG9uZW50LmlkKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzID0gdGhpcy5hc3NpZ25QYXJhbWV0ZXJWYWx1ZShjb21wb25lbnQub3BlcmF0aW9uc1swXS5wYXJhbWV0ZXJzKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMgPSBjb21wb25lbnQub3BlcmF0aW9uc1swXS5wYXJhbWV0ZXJzLm1hcChwID0+ICh7IGNvZGU6IHAuY29kZSwgbmFtZTogcC5uYW1lLCB2YWx1ZTogJycgfSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBwYXJhbWV0ZXJzO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBhc3NpZ25QYXJhbWV0ZXJWYWx1ZShwYXJhbXM6IFBhcmFtZXRlcltdKTogQWN0dWFsUGFyYW1ldGVyW10ge1xyXG4gICAgICAgIHJldHVybiBwYXJhbXMubWFwKHAgPT4ge1xyXG4gICAgICAgICAgICBpZiAocC5jb2RlLmluZGV4T2YoJ2JlSWQnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2ID0gdGhpcy5kZXNpZ25lclN0YXRlLmZvcm1hbFBhcmFtZXRlckNvbnRleHQuZmlsdGVyKGMgPT4gYy5rZXkuaW5kZXhPZignbWV0YWRhdGFJZCcpID4gLTEpWzBdLmtleTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGNvZGU6IHAuY29kZSwgbmFtZTogcC5uYW1lLCB2YWx1ZTogYHtcImV4cHJcIjpcIkRlZmF1bHRGdW5jdGlvbi5HZXRDb250ZXh0UGFyYW1ldGVyKFxcXFxcIiR7dn1cXFxcXCIpXCJ9YCB9O1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHAuY29kZS5pbmRleE9mKCdub2RlSWQnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2ID0gdGhpcy5kZXNpZ25lclN0YXRlLmZvcm1hbFBhcmFtZXRlckNvbnRleHQuZmlsdGVyKGMgPT4gYy5rZXkuaW5kZXhPZignc2NoZW1hSWQnKSA+IC0xKVswXS5rZXk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjb2RlOiBwLmNvZGUsIG5hbWU6IHAubmFtZSwgdmFsdWU6IGB7XCJleHByXCI6XCJEZWZhdWx0RnVuY3Rpb24uR2V0Q29udGV4dFBhcmFtZXRlcihcXFxcXCIke3Z9XFxcXFwiKVwifWAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChwLmNvZGUuaW5kZXhPZignZGF0YUlkJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY29kZTogcC5jb2RlLCBuYW1lOiBwLm5hbWUsIHZhbHVlOiBge1wiZXhwclwiOlwiRGVmYXVsdEZ1bmN0aW9uLkdldENvbnRleHRQYXJhbWV0ZXIoXFxcXFwiZGF0YUlkXFxcXFwiKVwifWAgfTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChwLmNvZGUuaW5kZXhPZigncHJvY0luc3RJZCcpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGNvZGU6IHAuY29kZSwgbmFtZTogcC5uYW1lLCB2YWx1ZTogYHtcImV4cHJcIjpcIkRlZmF1bHRGdW5jdGlvbi5HZXRDb250ZXh0UGFyYW1ldGVyKFxcXFxcInByb2NJbnN0SWRcXFxcXCIpXCJ9YCB9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY29kZTogcC5jb2RlLCBuYW1lOiBwLm5hbWUsIHZhbHVlOiAnJyB9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgc3dhcEFycmF5KGFycjogQXJyYXk8YW55PiwgaTE6IG51bWJlciwgaTI6IG51bWJlcik6IEFycmF5PGFueT4ge1xyXG4gICAgICAgIGFycltpMV0gPSBhcnIuc3BsaWNlKGkyLCAxLCBhcnJbaTFdKVswXTtcclxuICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==