/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { ActivityComponentUIState } from './activity-component.uistate';
import { HttpService } from '@ecp-caf/caf-common';
import { BizComponentEntity, OwnerType } from '../../domain/entities/biz-component.entity';
import { ProcessDesignerUIState } from '../../app/process-designer.uistate';
import { Subject } from 'rxjs';
import { ProcessDeUtil } from '../../domain/process-de-util';
export class ActivityComponentRepository {
    /**
     * @param {?} uistate
     * @param {?} util
     * @param {?} http
     * @param {?} designerState
     */
    constructor(uistate, util, http, designerState) {
        this.uistate = uistate;
        this.util = util;
        this.http = http;
        this.designerState = designerState;
        this.defaultProcessComponentIds = ['5863c8a8-e0a7-4137-a8b2-4c05e42b3b73', 'be781ba1-a88b-4bb8-9c88-2e2a27a9226e'];
        this.subject = new Subject();
    }
    /**
     * @param {?} flowFormId
     * @param {?} bizActId
     * @return {?}
     */
    loadComponents(flowFormId, bizActId) {
        /** @type {?} */
        let url = this.util.getBizComponentsWebApi();
        if (bizActId) {
            url += `/query?param=` + encodeURIComponent(`{"flowFormKey":"${flowFormId}","owner":"${bizActId}","ownerType":"Activity"}`);
        }
        else {
            this.uistate.allComponents = [];
            return;
        }
        this.http.get(url).subscribe((/**
         * @param {?} data
         * @return {?}
         */
        (data) => {
            this.uistate.allComponents = data.filter((/**
             * @param {?} c
             * @return {?}
             */
            (c) => c.ownerType === OwnerType.Activity));
        }));
    }
    /**
     * @param {?} id
     * @return {?}
     */
    removeComponent(id) {
        if (id) {
            /** @type {?} */
            const index = this.uistate.components.findIndex((/**
             * @param {?} c
             * @return {?}
             */
            c => c.id === id));
            if (index > -1) {
                this.uistate.components.splice(index, 1);
                if (this.uistate.components.length > 0) {
                    this.subject.next(this.uistate.components[0]);
                }
                else {
                    this.uistate.curComponent = null;
                }
            }
        }
    }
    /**
     * @param {?} cpt
     * @return {?}
     */
    addComponent(cpt) {
        if (cpt) {
            /** @type {?} */
            const component = new BizComponentEntity(cpt.name, cpt.id, cpt.operations[0].code);
            component.id = ProcessDeUtil.GenerateElementId();
            component.actualParameters = this.bindParas(cpt);
            this.uistate.components.push(component);
            this.subject.next(component);
        }
    }
    /**
     * @private
     * @param {?} component
     * @return {?}
     */
    bindParas(component) {
        /** @type {?} */
        let parameters = [];
        if (component.operations[0].parameters && component.operations[0].parameters.length > 0) {
            if (this.defaultProcessComponentIds.indexOf(component.id) > -1) {
                parameters = this.assignParameterValue(component.operations[0].parameters);
            }
            else {
                parameters = component.operations[0].parameters.map((/**
                 * @param {?} p
                 * @return {?}
                 */
                p => ({ code: p.code, name: p.name, value: '' })));
            }
        }
        return parameters;
    }
    /**
     * @private
     * @param {?} params
     * @return {?}
     */
    assignParameterValue(params) {
        return params.map((/**
         * @param {?} p
         * @return {?}
         */
        p => {
            if (p.code.indexOf('beId') > -1) {
                /** @type {?} */
                const v = this.designerState.formalParameterContext.filter((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => c.key.indexOf('metadataId') > -1))[0].key;
                return { code: p.code, name: p.name, value: `{"expr":"DefaultFunction.GetContextParameter(\\"${v}\\")"}` };
            }
            else if (p.code.indexOf('nodeId') > -1) {
                /** @type {?} */
                const v = this.designerState.formalParameterContext.filter((/**
                 * @param {?} c
                 * @return {?}
                 */
                c => c.key.indexOf('schemaId') > -1))[0].key;
                return { code: p.code, name: p.name, value: `{"expr":"DefaultFunction.GetContextParameter(\\"${v}\\")"}` };
            }
            else if (p.code.indexOf('dataId') > -1) {
                return { code: p.code, name: p.name, value: `{"expr":"DefaultFunction.GetContextParameter(\\"dataId\\")"}` };
            }
            else if (p.code.indexOf('procInstId') > -1) {
                return { code: p.code, name: p.name, value: `{"expr":"DefaultFunction.GetContextParameter(\\"procInstId\\")"}` };
            }
            else {
                return { code: p.code, name: p.name, value: '' };
            }
        }));
    }
    /**
     * @param {?} arr
     * @param {?} i1
     * @param {?} i2
     * @return {?}
     */
    swapArray(arr, i1, i2) {
        arr[i1] = arr.splice(i2, 1, arr[i1])[0];
        return arr;
    }
}
ActivityComponentRepository.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ActivityComponentRepository.ctorParameters = () => [
    { type: ActivityComponentUIState },
    { type: ProcessDeUtil },
    { type: HttpService },
    { type: ProcessDesignerUIState }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.defaultProcessComponentIds;
    /** @type {?} */
    ActivityComponentRepository.prototype.subject;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.uistate;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.util;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.http;
    /**
     * @type {?}
     * @private
     */
    ActivityComponentRepository.prototype.designerState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWN0aXZpdHktY29tcG9uZW50LnJlcG9zaXRvcnkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXdmL3dmLXByb2Nlc3MtZWRpdG9yLyIsInNvdXJjZXMiOlsibGliL3ZpZXdzL2FjdGl2aXR5LWNvbXBvbmVudC9hY3Rpdml0eS1jb21wb25lbnQucmVwb3NpdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN4RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFbEQsT0FBTyxFQUFFLGtCQUFrQixFQUFxQixTQUFTLEVBQUUsTUFBTSw0Q0FBNEMsQ0FBQztBQUk5RyxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUM1RSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUc3RCxNQUFNLE9BQU8sMkJBQTJCOzs7Ozs7O0lBSXBDLFlBQ1ksT0FBaUMsRUFDakMsSUFBbUIsRUFDbkIsSUFBaUIsRUFDakIsYUFBcUM7UUFIckMsWUFBTyxHQUFQLE9BQU8sQ0FBMEI7UUFDakMsU0FBSSxHQUFKLElBQUksQ0FBZTtRQUNuQixTQUFJLEdBQUosSUFBSSxDQUFhO1FBQ2pCLGtCQUFhLEdBQWIsYUFBYSxDQUF3QjtRQVB6QywrQkFBMEIsR0FBRyxDQUFDLHNDQUFzQyxFQUFFLHNDQUFzQyxDQUFDLENBQUM7UUFFdEgsWUFBTyxHQUFnQyxJQUFJLE9BQU8sRUFBc0IsQ0FBQztJQU1yRSxDQUFDOzs7Ozs7SUFFTCxjQUFjLENBQUMsVUFBa0IsRUFBRSxRQUFnQjs7WUFDM0MsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEVBQUU7UUFDNUMs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YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBY3Rpdml0eUNvbXBvbmVudFVJU3RhdGUgfSBmcm9tICcuL2FjdGl2aXR5LWNvbXBvbmVudC51aXN0YXRlJztcclxuaW1wb3J0IHsgSHR0cFNlcnZpY2UgfSBmcm9tICdAZWNwLWNhZi9jYWYtY29tbW9uJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBCaXpDb21wb25lbnRFbnRpdHksIENvbXBvbmVudExvY2F0aW9uLCBPd25lclR5cGUgfSBmcm9tICcuLi8uLi9kb21haW4vZW50aXRpZXMvYml6LWNvbXBvbmVudC5lbnRpdHknO1xyXG5pbXBvcnQgeyBHc3BDb21wb25lbnQgfSBmcm9tICdAZ3NwLWNtcC9jb21tb24tY29tcG9uZW50JztcclxuaW1wb3J0IHsgQWN0dWFsUGFyYW1ldGVyIH0gZnJvbSAnLi4vLi4vZG9tYWluL2VudGl0aWVzL2FjdHVhbC1wYXJhbWV0ZXInO1xyXG5pbXBvcnQgeyBQYXJhbWV0ZXIgfSBmcm9tICdAZWNwLWNhZi9jb21tb24tc3RydWN0dXJlJztcclxuaW1wb3J0IHsgUHJvY2Vzc0Rlc2lnbmVyVUlTdGF0ZSB9IGZyb20gJy4uLy4uL2FwcC9wcm9jZXNzLWRlc2lnbmVyLnVpc3RhdGUnO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFByb2Nlc3NEZVV0aWwgfSBmcm9tICcuLi8uLi9kb21haW4vcHJvY2Vzcy1kZS11dGlsJztcclxuQEluamVjdGFibGUoKVxyXG5cclxuZXhwb3J0IGNsYXNzIEFjdGl2aXR5Q29tcG9uZW50UmVwb3NpdG9yeSB7XHJcbiAgICBwcml2YXRlIGRlZmF1bHRQcm9jZXNzQ29tcG9uZW50SWRzID0gWyc1ODYzYzhhOC1lMGE3LTQxMzctYThiMi00YzA1ZTQyYjNiNzMnLCAnYmU3ODFiYTEtYTg4Yi00YmI4LTljODgtMmUyYTI3YTkyMjZlJ107XHJcblxyXG4gICAgc3ViamVjdDogU3ViamVjdDxCaXpDb21wb25lbnRFbnRpdHk+ID0gbmV3IFN1YmplY3Q8Qml6Q29tcG9uZW50RW50aXR5PigpO1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSB1aXN0YXRlOiBBY3Rpdml0eUNvbXBvbmVudFVJU3RhdGUsXHJcbiAgICAgICAgcHJpdmF0ZSB1dGlsOiBQcm9jZXNzRGVVdGlsLFxyXG4gICAgICAgIHByaXZhdGUgaHR0cDogSHR0cFNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBkZXNpZ25lclN0YXRlOiBQcm9jZXNzRGVzaWduZXJVSVN0YXRlXHJcbiAgICApIHsgfVxyXG5cclxuICAgIGxvYWRDb21wb25lbnRzKGZsb3dGb3JtSWQ6IHN0cmluZywgYml6QWN0SWQ6IHN0cmluZykge1xyXG4gICAgICAgIGxldCB1cmwgPSB0aGlzLnV0aWwuZ2V0Qml6Q29tcG9uZW50c1dlYkFwaSgpO1xyXG4gICAgICAgIGlmIChiaXpBY3RJZCkge1xyXG4gICAgICAgICAgICB1cmwgKz0gYC9xdWVyeT9wYXJhbT1gICsgZW5jb2RlVVJJQ29tcG9uZW50KGB7XCJmbG93Rm9ybUtleVwiOlwiJHtmbG93Rm9ybUlkfVwiLFwib3duZXJcIjpcIiR7Yml6QWN0SWR9XCIsXCJvd25lclR5cGVcIjpcIkFjdGl2aXR5XCJ9YCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy51aXN0YXRlLmFsbENvbXBvbmVudHMgPSBbXTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmh0dHAuZ2V0KHVybCkuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgdGhpcy51aXN0YXRlLmFsbENvbXBvbmVudHMgPSBkYXRhLmZpbHRlcigoYzogQml6Q29tcG9uZW50RW50aXR5KSA9PiBjLm93bmVyVHlwZSA9PT0gT3duZXJUeXBlLkFjdGl2aXR5KTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIHJlbW92ZUNvbXBvbmVudChpZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy51aXN0YXRlLmNvbXBvbmVudHMuZmluZEluZGV4KGMgPT4gYy5pZCA9PT0gaWQpO1xyXG4gICAgICAgICAgICBpZiAoaW5kZXggPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy51aXN0YXRlLmNvbXBvbmVudHMuc3BsaWNlKGluZGV4LCAxKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy51aXN0YXRlLmNvbXBvbmVudHMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc3ViamVjdC5uZXh0KHRoaXMudWlzdGF0ZS5jb21wb25lbnRzWzBdKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51aXN0YXRlLmN1ckNvbXBvbmVudCA9IG51bGw7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBhZGRDb21wb25lbnQoY3B0OiBHc3BDb21wb25lbnQpIHtcclxuICAgICAgICBpZiAoY3B0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbXBvbmVudCA9IG5ldyBCaXpDb21wb25lbnRFbnRpdHkoY3B0Lm5hbWUsIGNwdC5pZCwgY3B0Lm9wZXJhdGlvbnNbMF0uY29kZSk7XHJcbiAgICAgICAgICAgIGNvbXBvbmVudC5pZCA9IFByb2Nlc3NEZVV0aWwuR2VuZXJhdGVFbGVtZW50SWQoKTtcclxuICAgICAgICAgICAgY29tcG9uZW50LmFjdHVhbFBhcmFtZXRlcnMgPSB0aGlzLmJpbmRQYXJhcyhjcHQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy51aXN0YXRlLmNvbXBvbmVudHMucHVzaChjb21wb25lbnQpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zdWJqZWN0Lm5leHQoY29tcG9uZW50KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGJpbmRQYXJhcyhjb21wb25lbnQ6IEdzcENvbXBvbmVudCk6IEFjdHVhbFBhcmFtZXRlcltdIHtcclxuICAgICAgICBsZXQgcGFyYW1ldGVycyA9IFtdO1xyXG5cclxuICAgICAgICBpZiAoY29tcG9uZW50Lm9wZXJhdGlvbnNbMF0ucGFyYW1ldGVycyAmJiBjb21wb25lbnQub3BlcmF0aW9uc1swXS5wYXJhbWV0ZXJzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGVmYXVsdFByb2Nlc3NDb21wb25lbnRJZHMuaW5kZXhPZihjb21wb25lbnQuaWQpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIHBhcmFtZXRlcnMgPSB0aGlzLmFzc2lnblBhcmFtZXRlclZhbHVlKGNvbXBvbmVudC5vcGVyYXRpb25zWzBdLnBhcmFtZXRlcnMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVycyA9IGNvbXBvbmVudC5vcGVyYXRpb25zWzBdLnBhcmFtZXRlcnMubWFwKHAgPT4gKHsgY29kZTogcC5jb2RlLCBuYW1lOiBwLm5hbWUsIHZhbHVlOiAnJyB9KSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHBhcmFtZXRlcnM7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGFzc2lnblBhcmFtZXRlclZhbHVlKHBhcmFtczogUGFyYW1ldGVyW10pOiBBY3R1YWxQYXJhbWV0ZXJbXSB7XHJcbiAgICAgICAgcmV0dXJuIHBhcmFtcy5tYXAocCA9PiB7XHJcbiAgICAgICAgICAgIGlmIChwLmNvZGUuaW5kZXhPZignYmVJZCcpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHYgPSB0aGlzLmRlc2lnbmVyU3RhdGUuZm9ybWFsUGFyYW1ldGVyQ29udGV4dC5maWx0ZXIoYyA9PiBjLmtleS5pbmRleE9mKCdtZXRhZGF0YUlkJykgPiAtMSlbMF0ua2V5O1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY29kZTogcC5jb2RlLCBuYW1lOiBwLm5hbWUsIHZhbHVlOiBge1wiZXhwclwiOlwiRGVmYXVsdEZ1bmN0aW9uLkdldENvbnRleHRQYXJhbWV0ZXIoXFxcXFwiJHt2fVxcXFxcIilcIn1gIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5jb2RlLmluZGV4T2YoJ25vZGVJZCcpID4gLTEpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHYgPSB0aGlzLmRlc2lnbmVyU3RhdGUuZm9ybWFsUGFyYW1ldGVyQ29udGV4dC5maWx0ZXIoYyA9PiBjLmtleS5pbmRleE9mKCdzY2hlbWFJZCcpID4gLTEpWzBdLmtleTtcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGNvZGU6IHAuY29kZSwgbmFtZTogcC5uYW1lLCB2YWx1ZTogYHtcImV4cHJcIjpcIkRlZmF1bHRGdW5jdGlvbi5HZXRDb250ZXh0UGFyYW1ldGVyKFxcXFxcIiR7dn1cXFxcXCIpXCJ9YCB9O1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHAuY29kZS5pbmRleE9mKCdkYXRhSWQnKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjb2RlOiBwLmNvZGUsIG5hbWU6IHAubmFtZSwgdmFsdWU6IGB7XCJleHByXCI6XCJEZWZhdWx0RnVuY3Rpb24uR2V0Q29udGV4dFBhcmFtZXRlcihcXFxcXCJkYXRhSWRcXFxcXCIpXCJ9YCB9O1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHAuY29kZS5pbmRleE9mKCdwcm9jSW5zdElkJykgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgY29kZTogcC5jb2RlLCBuYW1lOiBwLm5hbWUsIHZhbHVlOiBge1wiZXhwclwiOlwiRGVmYXVsdEZ1bmN0aW9uLkdldENvbnRleHRQYXJhbWV0ZXIoXFxcXFwicHJvY0luc3RJZFxcXFxcIilcIn1gIH07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBjb2RlOiBwLmNvZGUsIG5hbWU6IHAubmFtZSwgdmFsdWU6ICcnIH07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzd2FwQXJyYXkoYXJyOiBBcnJheTxhbnk+LCBpMTogbnVtYmVyLCBpMjogbnVtYmVyKTogQXJyYXk8YW55PiB7XHJcbiAgICAgICAgYXJyW2kxXSA9IGFyci5zcGxpY2UoaTIsIDEsIGFycltpMV0pWzBdO1xyXG4gICAgICAgIHJldHVybiBhcnI7XHJcbiAgICB9XHJcbn1cclxuIl19