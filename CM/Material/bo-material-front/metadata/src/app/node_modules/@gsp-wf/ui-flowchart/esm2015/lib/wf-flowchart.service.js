/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Injector, ComponentFactoryResolver } from '@angular/core';
import { MessagerService } from '@farris/ui-messager';
import { BsModalService } from '@farris/ui-modal';
import { UIFlowchartComponent } from './task-flowchart/task-flowchart.component';
import { translate } from './services/i18n/index';
import { UiFlowchartService } from './services/ui-flowchart.service';
import { FrameworkService } from '@gsp-sys/rtf-common';
import { of } from 'rxjs';
import { HttpService } from '@ecp-caf/caf-common';
export class WFFlowchartService {
    /**
     * @param {?} msgService
     * @param {?} injector
     * @param {?} resolver
     * @param {?} modalService
     */
    constructor(msgService, injector, resolver, modalService) {
        this.msgService = msgService;
        this.injector = injector;
        this.resolver = resolver;
        this.modalService = modalService;
        this.flowchartService = this.injector.get(UiFlowchartService);
        this.frameworkService = this.injector.get(FrameworkService);
    }
    /**
     * @param {?} payload
     * @return {?}
     */
    viewProcess(payload) {
        if (!payload || !payload.dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noDataId'));
            return;
        }
        if (!payload || !payload.bizDefKey) {
            this.msgService.warning(this.getI18nValue('static.flowchart.noBizDefKey'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('dataId', payload.dataId);
        parameters.set('bizDefKey', payload.bizDefKey);
        if (payload.startMode) {
            parameters.set('startMode', payload.startMode);
        }
        if (payload.startUserId) {
            parameters.set('startUserId', payload.startUserId);
        }
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: payload.dataId,
            isNewTab: true,
            queryStringParams: parameters
        };
        this.frameworkService.openMenu(options);
    }
    /**
     * 查看流程（tab页中打开）
     * @param {?} procInstId 流程实例ID
     * @return {?}
     */
    viewFlowChart(procInstId) {
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('processId', procInstId);
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.frameworkService.openMenu(options);
    }
    /**
     * @param {?} dataId
     * @return {?}
     */
    viewFlowChartByDataId(dataId) {
        if (!dataId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.dataIdIsNull'));
            return;
        }
        /** @type {?} */
        const parameters = new Map();
        parameters.set('dataId', dataId);
        parameters.set('withTitle', true);
        /** @type {?} */
        const options = {
            appType: 'menu',
            funcId: 'WFViewFlowChart',
            appId: '',
            appEntrance: '',
            tabId: new Date().getTime().toString(),
            isNewTab: true,
            queryStringParams: parameters
        };
        this.frameworkService.openMenu(options);
    }
    /**
     * 查看流程（弹框中打开）
     * @param {?} procInstId 流程实例ID
     * @param {?=} mode
     * @return {?}
     */
    viewFlowChartByDialog(procInstId, mode) {
        if (!procInstId) {
            this.msgService.warning(this.getI18nValue('static.flowchart.processNotFound'));
            return;
        }
        /** @type {?} */
        let func;
        if (UIFlowchartComponent.func) {
            func = UIFlowchartComponent.func;
        }
        /** @type {?} */
        const modalConfig = {
            title: this.getI18nValue('static.flowchart.title'),
            width: 1200,
            height: 530,
            showButtons: false,
            beforeClose: (modalRef) => {
                if (UIFlowchartComponent.func) {
                    window.removeEventListener('message', UIFlowchartComponent.func, false);
                }
                if (func) {
                    window.addEventListener('message', func, false);
                    UIFlowchartComponent.func = func;
                }
                return of(true);
            }
        };
        /** @type {?} */
        const compFactory = this.resolver.resolveComponentFactory(UIFlowchartComponent);
        /** @type {?} */
        const inj = Injector.create({
            providers: [
                {
                    provide: UiFlowchartService, useFactory: (httpSvc) => {
                        return new UiFlowchartService(httpSvc);
                    },
                    deps: [
                        HttpService
                    ]
                }
            ], parent: this.injector
        });
        /** @type {?} */
        const compRef = compFactory.create(inj);
        compRef.instance.ProcInstId = procInstId;
        if (mode) {
            compRef.instance.mode = mode;
        }
        compRef.instance.fill();
        this.flowchartService.getProcessInstanceById(procInstId).subscribe(re => {
            modalConfig.title = re.name + '-v' + re.version + '.0';
            /** @type {?} */
            const dialog = this.modalService.show(compRef, modalConfig);
        });
    }
    /**
     * @private
     * @param {?} name
     * @return {?}
     */
    getI18nValue(name) {
        if (!name) {
            return '';
        }
        /** @type {?} */
        var defaultLang = localStorage.getItem('languageCode');
        /** @type {?} */
        var langData = defaultLang ? translate[defaultLang] : translate['zh-CHS'];
        /** @type {?} */
        let resultVal = '';
        if (name.indexOf('.') === -1) {
            resultVal = langData[name];
        }
        else {
            resultVal = name.split('.').reduce((obj, key) => {
                if (obj) {
                    return obj[key];
                }
                else {
                    return null;
                }
            }, langData);
        }
        return resultVal;
    }
}
WFFlowchartService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
WFFlowchartService.ctorParameters = () => [
    { type: MessagerService },
    { type: Injector },
    { type: ComponentFactoryResolver },
    { type: BsModalService }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.flowchartService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.frameworkService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.msgService;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.resolver;
    /**
     * @type {?}
     * @private
     */
    WFFlowchartService.prototype.modalService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2YtZmxvd2NoYXJ0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZ3NwLXdmL3VpLWZsb3djaGFydC8iLCJzb3VyY2VzIjpbImxpYi93Zi1mbG93Y2hhcnQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBZ0IsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDaEUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDakYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3JFLE9BQU8sRUFBYyxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUIsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBS2xELE1BQU0sT0FBTyxrQkFBa0I7Ozs7Ozs7SUFLM0IsWUFDWSxVQUEyQixFQUMzQixRQUFrQixFQUNsQixRQUFrQyxFQUNsQyxZQUE0QjtRQUg1QixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLGFBQVEsR0FBUixRQUFRLENBQTBCO1FBQ2xDLGlCQUFZLEdBQVosWUFBWSxDQUFnQjtRQUVwQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENB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SUFBSSxDQUFDLElBQUksRUFBRTtZQUFFLE9BQU8sRUFBRSxDQUFDO1NBQUU7O1lBQ3JCLFdBQVcsR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQzs7WUFDbEQsUUFBUSxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDOztZQUNyRSxTQUFTLEdBQUcsRUFBRTtRQUNsQixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDMUIsU0FBUyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QjthQUFNO1lBQ0gsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFO2dCQUM1QyxJQUFJLEdBQUcsRUFBRTtvQkFDTCxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDbkI7cUJBQU07b0JBQ0gsT0FBTyxJQUFJLENBQUM7aUJBQ2Y7WUFDTCxDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDaEI7UUFDRCxPQUFPLFNBQVMsQ0FBQztJQUNyQixDQUFDOzs7WUFqS0osVUFBVTs7OztZQVhGLGVBQWU7WUFESCxRQUFRO1lBQUUsd0JBQXdCO1lBRWhDLGNBQWM7Ozs7Ozs7SUFhakMsOENBQTZDOzs7OztJQUM3Qyw4Q0FBMkM7Ozs7O0lBR3ZDLHdDQUFtQzs7Ozs7SUFDbkMsc0NBQTBCOzs7OztJQUMxQixzQ0FBMEM7Ozs7O0lBQzFDLDBDQUFvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1tZXNzYWdlcic7XHJcbmltcG9ydCB7IE1vZGFsT3B0aW9ucywgQnNNb2RhbFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLW1vZGFsJztcclxuaW1wb3J0IHsgVUlGbG93Y2hhcnRDb21wb25lbnQgfSBmcm9tICcuL3Rhc2stZmxvd2NoYXJ0L3Rhc2stZmxvd2NoYXJ0LmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IHRyYW5zbGF0ZSB9IGZyb20gJy4vc2VydmljZXMvaTE4bi9pbmRleCc7XHJcbmltcG9ydCB7IFVpRmxvd2NoYXJ0U2VydmljZSB9IGZyb20gJy4vc2VydmljZXMvdWktZmxvd2NoYXJ0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBBcHBPcHRpb25zLCBGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XHJcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IEh0dHBTZXJ2aWNlIH0gZnJvbSAnQGVjcC1jYWYvY2FmLWNvbW1vbic7XHJcbmltcG9ydCB7IEZvcmVjYXN0UHJvY2Vzc1BheWxvYWQgfSBmcm9tICcuL2VudGl0eS9mb3JlY2FzdC1wcm9jZXNzLXBheWxvYWQnO1xyXG5cclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFdGRmxvd2NoYXJ0U2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBmbG93Y2hhcnRTZXJ2aWNlOiBVaUZsb3djaGFydFNlcnZpY2U7XHJcbiAgICBwcml2YXRlIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2U7XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBNZXNzYWdlclNlcnZpY2UsXHJcbiAgICAgICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXHJcbiAgICAgICAgcHJpdmF0ZSByZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxyXG4gICAgICAgIHByaXZhdGUgbW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZSxcclxuICAgICkge1xyXG4gICAgICAgIHRoaXMuZmxvd2NoYXJ0U2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFVpRmxvd2NoYXJ0U2VydmljZSk7XHJcbiAgICAgICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQoRnJhbWV3b3JrU2VydmljZSk7XHJcbiAgICB9XHJcblxyXG4gICAgdmlld1Byb2Nlc3MocGF5bG9hZDogRm9yZWNhc3RQcm9jZXNzUGF5bG9hZCkge1xyXG4gICAgICAgIGlmICghcGF5bG9hZCB8fCAhcGF5bG9hZC5kYXRhSWQpIHtcclxuICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5nZXRJMThuVmFsdWUoJ3N0YXRpYy5mbG93Y2hhcnQubm9EYXRhSWQnKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCFwYXlsb2FkIHx8ICFwYXlsb2FkLmJpekRlZktleSkge1xyXG4gICAgICAgICAgICB0aGlzLm1zZ1NlcnZpY2Uud2FybmluZyh0aGlzLmdldEkxOG5WYWx1ZSgnc3RhdGljLmZsb3djaGFydC5ub0JpekRlZktleScpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJhbWV0ZXJzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgnZGF0YUlkJywgcGF5bG9hZC5kYXRhSWQpO1xyXG4gICAgICAgIHBhcmFtZXRlcnMuc2V0KCdiaXpEZWZLZXknLCBwYXlsb2FkLmJpekRlZktleSk7XHJcbiAgICAgICAgaWYgKHBheWxvYWQuc3RhcnRNb2RlKSB7XHJcbiAgICAgICAgICAgIHBhcmFtZXRlcnMuc2V0KCdzdGFydE1vZGUnLCBwYXlsb2FkLnN0YXJ0TW9kZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwYXlsb2FkLnN0YXJ0VXNlcklkKSB7XHJcbiAgICAgICAgICAgIHBhcmFtZXRlcnMuc2V0KCdzdGFydFVzZXJJZCcsIHBheWxvYWQuc3RhcnRVc2VySWQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgnd2l0aFRpdGxlJywgdHJ1ZSk7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uczogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgYXBwVHlwZTogJ21lbnUnLFxyXG4gICAgICAgICAgICBmdW5jSWQ6ICdXRlZpZXdGbG93Q2hhcnQnLFxyXG4gICAgICAgICAgICBhcHBJZDogJycsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlOiAnJyxcclxuICAgICAgICAgICAgdGFiSWQ6IHBheWxvYWQuZGF0YUlkLFxyXG4gICAgICAgICAgICBpc05ld1RhYjogdHJ1ZSxcclxuICAgICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IHBhcmFtZXRlcnNcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZS5vcGVuTWVudShvcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOafpeeci+a1geeoi++8iHRhYumhteS4reaJk+W8gO+8iVxyXG4gICAgICogQHBhcmFtIHByb2NJbnN0SWQg5rWB56iL5a6e5L6LSURcclxuICAgICAqL1xyXG4gICAgdmlld0Zsb3dDaGFydChwcm9jSW5zdElkOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoIXByb2NJbnN0SWQpIHtcclxuICAgICAgICAgICAgdGhpcy5tc2dTZXJ2aWNlLndhcm5pbmcodGhpcy5nZXRJMThuVmFsdWUoJ3N0YXRpYy5mbG93Y2hhcnQucHJvY2Vzc05vdEZvdW5kJykpO1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBhcmFtZXRlcnMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgICAgIHBhcmFtZXRlcnMuc2V0KCdwcm9jZXNzSWQnLCBwcm9jSW5zdElkKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgnd2l0aFRpdGxlJywgdHJ1ZSk7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uczogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgYXBwVHlwZTogJ21lbnUnLFxyXG4gICAgICAgICAgICBmdW5jSWQ6ICdXRlZpZXdGbG93Q2hhcnQnLFxyXG4gICAgICAgICAgICBhcHBJZDogJycsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlOiAnJyxcclxuICAgICAgICAgICAgdGFiSWQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLnRvU3RyaW5nKCksXHJcbiAgICAgICAgICAgIGlzTmV3VGFiOiB0cnVlLFxyXG4gICAgICAgICAgICBxdWVyeVN0cmluZ1BhcmFtczogcGFyYW1ldGVyc1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLm9wZW5NZW51KG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIHZpZXdGbG93Q2hhcnRCeURhdGFJZChkYXRhSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghZGF0YUlkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0LmRhdGFJZElzTnVsbCcpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBwYXJhbWV0ZXJzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgnZGF0YUlkJywgZGF0YUlkKTtcclxuICAgICAgICBwYXJhbWV0ZXJzLnNldCgnd2l0aFRpdGxlJywgdHJ1ZSk7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9uczogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgYXBwVHlwZTogJ21lbnUnLFxyXG4gICAgICAgICAgICBmdW5jSWQ6ICdXRlZpZXdGbG93Q2hhcnQnLFxyXG4gICAgICAgICAgICBhcHBJZDogJycsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlOiAnJyxcclxuICAgICAgICAgICAgdGFiSWQ6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLnRvU3RyaW5nKCksXHJcbiAgICAgICAgICAgIGlzTmV3VGFiOiB0cnVlLFxyXG4gICAgICAgICAgICBxdWVyeVN0cmluZ1BhcmFtczogcGFyYW1ldGVyc1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLm9wZW5NZW51KG9wdGlvbnMpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICog5p+l55yL5rWB56iL77yI5by55qGG5Lit5omT5byA77yJXHJcbiAgICAgKiBAcGFyYW0gcHJvY0luc3RJZCDmtYHnqIvlrp7kvotJRFxyXG4gICAgICovXHJcbiAgICB2aWV3Rmxvd0NoYXJ0QnlEaWFsb2cocHJvY0luc3RJZDogc3RyaW5nLCBtb2RlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFwcm9jSW5zdElkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXNnU2VydmljZS53YXJuaW5nKHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0LnByb2Nlc3NOb3RGb3VuZCcpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgZnVuYztcclxuICAgICAgICBpZiAoVUlGbG93Y2hhcnRDb21wb25lbnQuZnVuYykge1xyXG4gICAgICAgICAgICBmdW5jID0gVUlGbG93Y2hhcnRDb21wb25lbnQuZnVuYztcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbW9kYWxDb25maWc6IE1vZGFsT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgdGl0bGU6IHRoaXMuZ2V0STE4blZhbHVlKCdzdGF0aWMuZmxvd2NoYXJ0LnRpdGxlJyksXHJcbiAgICAgICAgICAgIHdpZHRoOiAxMjAwLFxyXG4gICAgICAgICAgICBoZWlnaHQ6IDUzMCxcclxuICAgICAgICAgICAgc2hvd0J1dHRvbnM6IGZhbHNlLFxyXG4gICAgICAgICAgICBiZWZvcmVDbG9zZTogKG1vZGFsUmVmOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChVSUZsb3djaGFydENvbXBvbmVudC5mdW5jKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBVSUZsb3djaGFydENvbXBvbmVudC5mdW5jLCBmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAoZnVuYykge1xyXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuYywgZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIFVJRmxvd2NoYXJ0Q29tcG9uZW50LmZ1bmMgPSBmdW5jO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgICAgICBjb25zdCBjb21wRmFjdG9yeSA9IHRoaXMucmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoVUlGbG93Y2hhcnRDb21wb25lbnQpO1xyXG4gICAgICAgIGNvbnN0IGluaiA9IEluamVjdG9yLmNyZWF0ZSh7XHJcbiAgICAgICAgICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgIHByb3ZpZGU6IFVpRmxvd2NoYXJ0U2VydmljZSwgdXNlRmFjdG9yeTogKGh0dHBTdmMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBVaUZsb3djaGFydFNlcnZpY2UoaHR0cFN2Yyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBkZXBzOiBbXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIEh0dHBTZXJ2aWNlXHJcbiAgICAgICAgICAgICAgICAgICAgXVxyXG4gICAgICAgICAgICAgICAgfV0sIHBhcmVudDogdGhpcy5pbmplY3RvclxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNvbnN0IGNvbXBSZWYgPSBjb21wRmFjdG9yeS5jcmVhdGUoaW5qKTtcclxuICAgICAgICBjb21wUmVmLmluc3RhbmNlLlByb2NJbnN0SWQgPSBwcm9jSW5zdElkO1xyXG4gICAgICAgIGlmIChtb2RlKSB7XHJcbiAgICAgICAgICAgIGNvbXBSZWYuaW5zdGFuY2UubW9kZSA9IG1vZGU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbXBSZWYuaW5zdGFuY2UuZmlsbCgpO1xyXG4gICAgICAgIHRoaXMuZmxvd2NoYXJ0U2VydmljZS5nZXRQcm9jZXNzSW5zdGFuY2VCeUlkKHByb2NJbnN0SWQpLnN1YnNjcmliZShyZSA9PiB7XHJcbiAgICAgICAgICAgIG1vZGFsQ29uZmlnLnRpdGxlID0gcmUubmFtZSArICctdicgKyByZS52ZXJzaW9uICsgJy4wJztcclxuICAgICAgICAgICAgY29uc3QgZGlhbG9nID0gdGhpcy5tb2RhbFNlcnZpY2Uuc2hvdyhjb21wUmVmLCBtb2RhbENvbmZpZyk7XHJcbiAgICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldEkxOG5WYWx1ZShuYW1lOiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAoIW5hbWUpIHsgcmV0dXJuICcnOyB9XHJcbiAgICAgICAgdmFyIGRlZmF1bHRMYW5nID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ2xhbmd1YWdlQ29kZScpO1xyXG4gICAgICAgIHZhciBsYW5nRGF0YSA9IGRlZmF1bHRMYW5nID8gdHJhbnNsYXRlW2RlZmF1bHRMYW5nXSA6IHRyYW5zbGF0ZVsnemgtQ0hTJ107XHJcbiAgICAgICAgbGV0IHJlc3VsdFZhbCA9ICcnO1xyXG4gICAgICAgIGlmIChuYW1lLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcclxuICAgICAgICAgICAgcmVzdWx0VmFsID0gbGFuZ0RhdGFbbmFtZV07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0VmFsID0gbmFtZS5zcGxpdCgnLicpLnJlZHVjZSgob2JqLCBrZXkpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChvYmopIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqW2tleV07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9LCBsYW5nRGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXN1bHRWYWw7XHJcbiAgICB9XHJcbn1cclxuIl19