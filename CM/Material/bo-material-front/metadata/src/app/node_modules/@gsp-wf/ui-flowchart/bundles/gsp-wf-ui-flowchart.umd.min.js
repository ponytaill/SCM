!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs/operators"),require("@angular/platform-browser"),require("@farris/ui-modal"),require("rxjs"),require("@gsp-sys/rtf-common"),require("@angular/common"),require("@ecp-caf/caf-common"),require("@farris/ui-messager"),require("@farris/ui-dialog"),require("@angular/core"),require("@farris/ui-layout"),require("@farris/ui-section"),require("@gsp-wf/wf-approval-logs"),require("@farris/ui-combo-list"),require("@angular/forms"),require("@farris/ui-dropdown"),require("@farris/ui-datagrid"),require("@farris/ui-notify")):"function"==typeof define&&define.amd?define("@gsp-wf/ui-flowchart",["exports","rxjs/operators","@angular/platform-browser","@farris/ui-modal","rxjs","@gsp-sys/rtf-common","@angular/common","@ecp-caf/caf-common","@farris/ui-messager","@farris/ui-dialog","@angular/core","@farris/ui-layout","@farris/ui-section","@gsp-wf/wf-approval-logs","@farris/ui-combo-list","@angular/forms","@farris/ui-dropdown","@farris/ui-datagrid","@farris/ui-notify"],e):e((t["gsp-wf"]=t["gsp-wf"]||{},t["gsp-wf"]["ui-flowchart"]={}),t.rxjs.operators,t.ng.platformBrowser,t.uiModal,t.rxjs,t.rtfCommon,t.ng.common,t.cafCommon,t.uiMessager,t.uiDialog,t.ng.core,t.uiLayout,t.uiSection,t.wfApprovalLogs,t.uiComboList,t.ng.forms,t.uiDropdown,t.uiDatagrid,t.uiNotify)}(this,function(t,e,r,s,c,i,o,p,a,n,l,d,u,f,h,I,m,g,v){"use strict";var w={"zh-CHS":{"static":{approvalLogs:{title:"审批记录",approvalOpinion:"审批意见",startTime:"接收时间",endTime:"处理时间",todo:"待办理",done:"已办理",toAssign:"未指派"},flowchart:{title:"查看流程",processNotFound:"流程实例ID为空",dataIdIsNull:"单据内码为空",flowChart:"流程图",complete:"隐藏计算路线",simulation:"显示计算路线",sequenceColor:"分支线颜色说明",completed:"已运行",calculate:"计算路线","default":"默认",suspend:"计算中断",noProcess:"未找到符合条件的流程定义！",list:"流程列表",noDataId:"单据内码为空",noBizDefKey:"流程分类ID为空"}}},en:{"static":{approvalLogs:{title:"Approval Logs",approvalOpinion:"Approval opinion",startTime:"StartTime",endTime:"EndTime",todo:"Todo",done:"Done",toAssign:"To Assign"},flowchart:{title:"Flow Chart",processNotFound:"process instance id is null",flowChart:"Flow Chart",complete:"Hide Calculated Route",simulation:"Show Calculated Route",sequenceColor:"Description Of Sequence Color",completed:"Completed",calculate:"Calculate Route","default":"Default",suspend:"Calculate Suspend",noProcess:"Process definition not found!",list:"Process List",noDataId:"form id is null",noBizDefKey:"process category id is null"}}},"zh-CHT":{"static":{approvalLogs:{title:"審批記錄",approvalOpinion:"審批意見",startTime:"接收時間",endTime:"處理時間",todo:"待辦理",done:"已辦理",toAssign:"未指派"},flowchart:{title:"查看流程",processNotFound:"流程實例ID為空",dataIdIsNull:"單據內碼為空",flowChart:"流程圖",complete:"隱藏計算路線",simulation:"顯示計算路線",sequenceColor:"分支線顏色說明",completed:"已運行",calculate:"計算路線","default":"默認",suspend:"計算中斷",noProcess:"未找到符合條件的流程定義！",list:"流程列表",noDataId:"單據內碼為空",noBizDefKey:"流程分類ID為空"}}}},y=(b.prototype.getForecastProcessListByPayload=function(t){return this.httpSvc.post("/api/runtime/wf/v1.0/processInstances/startProcess-simulation",t).pipe(e.map(function(t){return t.procDefs}))},b.prototype.getRuntimeProcInstsByDataId=function(t){if(t){var e="/api/runtime/wf/v1.0/processInstances/runtimeProcInstList?dataId="+t;return this.httpSvc.get(e)}return c.from(new Array)},b.prototype.getHistoricProcInstsByDataId=function(t){if(t){var e="/api/runtime/wf/v1.0/processInstances/historicProcInstList?dataId="+t;return this.httpSvc.get(e)}return c.from(new Array)},b.prototype.getProcInstanceById=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t;return this.httpSvc.get(e)},b.prototype.getBpmnModelbyProcInstId=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t+"/bpmnModel";return this.httpSvc.get(e)},b.prototype.getBpmnModelbyProcDefId=function(t){var e="/api/runtime/wf/v1.0/procDefs/"+t+"/bpmnModel";return this.httpSvc.get(e)},b.prototype.getSubProcessInstance=function(t,e){if(t){var r="/api/runtime/wf/v1.0/processInstances/subProcInst?superActInstId="+t+"&superProcInstId="+e;return this.httpSvc.get(r)}},b.prototype.getForecastProcessByProcInstId=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t+"/forecastProcess";return this.httpSvc.get(e)},b.prototype.getForecastProcessByPayload=function(t){return this.httpSvc.post("/api/runtime/wf/v1.0/processInstances/forecastProcess",t)},b.prototype.getCompleteProcessInfoByProcInstId=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t+"/flowChartInfo";return this.httpSvc.get(e)},b.prototype.getAllActiInstsbyProcInstId=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t+"/activityInstanceSlims";return this.httpSvc.get(e)},b.prototype.getTransitionInstanceSlimsByProcInstId=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t+"/transitionInstanceSlims";return this.httpSvc.get(e)},b.prototype.getFormInfoByProcInstId=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t+"/formInfo";return this.httpSvc.get(e)},b.prototype.getFormInfoByActInstId=function(t,e){var r="/api/runtime/wf/v1.0/processInstances/"+t+"/formInfo";return e&&(r+="?actInstId="+e),this.httpSvc.get(r)},b.prototype.getWorkItemLogs=function(t,e){var r=e?"/api/runtime/wf/v1.0/processInstances/"+t+"/logs?activityDefinitionId="+e:"/api/runtime/wf/v1.0/processInstances/"+t+"/logs";return this.httpSvc.get(r)},b.prototype.getI18nValue=function(t){if(!t)return"";var e=localStorage.getItem("languageCode"),r=e?w[e]:w["zh-CHS"];return-1===t.indexOf(".")?r[t]:t.split(".").reduce(function(t,e){return t?t[e]:null},r)},b.prototype.getProcessInstanceById=function(t){var e="/api/runtime/wf/v1.0/processInstances/"+t;return this.httpSvc.get(e)},b.prototype.getProcInstIdByDataId=function(t){var e="/api/runtime/wf/v1.0/processInstances/procInstId?bizInstId="+t;return this.httpSvc.get(e)},b.prototype.retryAifCreation=function(t,e,r){return this.httpSvc.post("/api/runtime/wf/v1.0/aifactivityinstance/retry",e)},b.decorators=[{type:l.Injectable}],b.ctorParameters=function(){return[{type:p.HttpService}]},b);function b(t){this.httpSvc=t}var S=(P.prototype.viewProcess=function(t){if(t&&t.dataId)if(t&&t.bizDefKey){var e=new Map;e.set("dataId",t.dataId),e.set("bizDefKey",t.bizDefKey),t.startMode&&e.set("startMode",t.startMode),t.startUserId&&e.set("startUserId",t.startUserId),e.set("withTitle",!0);var r={appType:"menu",funcId:"WFViewFlowChart",appId:"",appEntrance:"",tabId:t.dataId,isNewTab:!0,queryStringParams:e};this.frameworkService.openMenu(r)}else this.msgService.warning(this.getI18nValue("static.flowchart.noBizDefKey"));else this.msgService.warning(this.getI18nValue("static.flowchart.noDataId"))},P.prototype.viewFlowChart=function(t){if(t){var e=new Map;e.set("processId",t),e.set("withTitle",!0);var r={appType:"menu",funcId:"WFViewFlowChart",appId:"",appEntrance:"",tabId:(new Date).getTime().toString(),isNewTab:!0,queryStringParams:e};this.frameworkService.openMenu(r)}else this.msgService.warning(this.getI18nValue("static.flowchart.processNotFound"))},P.prototype.viewFlowChartByDataId=function(t){if(t){var e=new Map;e.set("dataId",t),e.set("withTitle",!0);var r={appType:"menu",funcId:"WFViewFlowChart",appId:"",appEntrance:"",tabId:(new Date).getTime().toString(),isNewTab:!0,queryStringParams:e};this.frameworkService.openMenu(r)}else this.msgService.warning(this.getI18nValue("static.flowchart.dataIdIsNull"))},P.prototype.viewFlowChartByDialog=function(t,e){var r=this;if(t){var s;F.func&&(s=F.func);var o={title:this.getI18nValue("static.flowchart.title"),width:1200,height:530,showButtons:!1,beforeClose:function(t){return F.func&&window.removeEventListener("message",F.func,!1),s&&(window.addEventListener("message",s,!1),F.func=s),c.of(!0)}},n=this.resolver.resolveComponentFactory(F),i=l.Injector.create({providers:[{provide:y,useFactory:function(t){return new y(t)},deps:[p.HttpService]}],parent:this.injector}),a=n.create(i);a.instance.ProcInstId=t,e&&(a.instance.mode=e),a.instance.fill(),this.flowchartService.getProcessInstanceById(t).subscribe(function(t){o.title=t.name+"-v"+t.version+".0",r.modalService.show(a,o)})}else this.msgService.warning(this.getI18nValue("static.flowchart.processNotFound"))},P.prototype.getI18nValue=function(t){if(!t)return"";var e=localStorage.getItem("languageCode"),r=e?w[e]:w["zh-CHS"];return-1===t.indexOf(".")?r[t]:t.split(".").reduce(function(t,e){return t?t[e]:null},r)},P.decorators=[{type:l.Injectable}],P.ctorParameters=function(){return[{type:a.MessagerService},{type:l.Injector},{type:l.ComponentFactoryResolver},{type:s.BsModalService}]},P);function P(t,e,r,s){this.msgService=t,this.injector=e,this.resolver=r,this.modalService=s,this.flowchartService=this.injector.get(y),this.frameworkService=this.injector.get(i.FrameworkService)}var F=(Object.defineProperty(C.prototype,"mode",{get:function(){return this._mode},set:function(t){this._mode=t,"simulation"===this._mode?(this.ifForecast="true",this.modeButton=this.service.getI18nValue("static.flowchart.complete")):"complete"===this._mode&&(this.modeButton=this.service.getI18nValue("static.flowchart.simulation"))},enumerable:!0,configurable:!0}),Object.defineProperty(C.prototype,"ProcInstId",{set:function(t){t&&(this.procInstId=t)},enumerable:!0,configurable:!0}),Object.defineProperty(C.prototype,"DataId",{set:function(t){t&&(this.dataId=t)},enumerable:!0,configurable:!0}),C.prototype.ngOnInit=function(){},C.prototype.addMessageListener=function(){window.addEventListener("message",this.eventHandler,!1),C.func=this.eventHandler},C.prototype.viewFlowChart=function(){"viewFlowChart"===this.theme?this.viewFlowChartByProcInstId():this.processForecast()},C.prototype.viewParent=function(t){},C.prototype.viewChild=function(t,e){var r=this;this.service.getSubProcessInstance(t,e).subscribe(function(t){if(!r.chartService)throw Error("请升级查看流程公共包实现联查子流程图功能");r.chartService.viewFlowChartByDialog(t.id,r.mode)})},C.prototype.modeSwitch=function(){var e=this;"complete"===this.mode?(this.mode="simulation",this.ifForecast="true",this.modeButton=this.service.getI18nValue("static.flowchart.complete"),this.service.getForecastProcessByProcInstId(this.procInstId).subscribe(function(t){e.actInstList=t.activityInstanceSlims,e.transInsList=t.transitionInstanceSlims,e.postMessage("modeSwitch",{mode:"simulation",actiInstList:t.activityInstanceSlims,transInsList:t.transitionInstanceSlims})})):(this.mode="complete",this.ifForecast="false",this.modeButton=this.service.getI18nValue("static.flowchart.simulation"),this.service.getCompleteProcessInfoByProcInstId(this.procInstId).subscribe(function(t){e.actInstList=t.activityInstanceSlims,e.transInsList=t.transitionInstanceSlims,e.postMessage("modeSwitch",{mode:"complete",actiInstList:t.activityInstanceSlims,transInsList:t.transitionInstanceSlims})}))},C.prototype.viewLogs=function(t){this.type=t.type,this.actDefId=t.actiDefId},C.prototype.viewFlowChartByProcInstId=function(){var e=this;this.content="",this.procInstId&&("complete"===this.mode?c.forkJoin(this.service.getProcInstanceById(this.procInstId),this.service.getBpmnModelbyProcInstId(this.procInstId),this.service.getCompleteProcessInfoByProcInstId(this.procInstId)).subscribe(function(t){e.processInstance=t[0],e.content=JSON.stringify(t[1]),e.actInstList=t[2].activityInstanceSlims,e.transInsList=t[2].transitionInstanceSlims,e.loadFlowChart()}):c.forkJoin(this.service.getProcInstanceById(this.procInstId),this.service.getBpmnModelbyProcInstId(this.procInstId),this.service.getForecastProcessByProcInstId(this.procInstId)).subscribe(function(t){e.processInstance=t[0],e.content=JSON.stringify(t[1]),e.actInstList=t[2].activityInstanceSlims,e.transInsList=t[2].transitionInstanceSlims,e.loadFlowChart()}))},C.prototype.processForecast=function(){var e=this;this.content="",this.mode="simulation",this.processForecastPayload.processDefinitionId&&this.processForecastPayload.dataId&&c.forkJoin(this.service.getBpmnModelbyProcDefId(this.processForecastPayload.processDefinitionId),this.service.getForecastProcessByPayload(this.processForecastPayload)).subscribe(function(t){e.content=JSON.stringify(t[0]),e.actInstList=t[1].activityInstanceSlims,e.transInsList=t[1].transitionInstanceSlims,e.loadFlowChart()})},C.prototype.viewForm=function(o,n,i){var a=this;o&&this.service.getFormInfoByActInstId(o,n).subscribe(function(t){var e=t;if(e&&e.appId){var r={appType:"menu",funcId:e.appId,appId:"",appEntrance:"",tabId:i,isNewTab:!0},s=new Map;if(s.set("procInstId",o),s.set("actInstId",n),e.parameters.forEach(function(t){return s.set(t.code,t.value)}),r.queryStringParams=s,!a.frameworkSvc)throw Error("框架服务不存在！无法联查！");a.frameworkSvc.openMenu(r)}else a.message&&a.message.info("找不到单据，请联系管理员查看原因！")})},C.prototype.retryAifCreation=function(t,e,r){var s=this;t&&this.service.retryAifCreation(t,e,r).subscribe(function(t){s.viewFlowChart()},function(t){throw setTimeout(function(){s.message.error(null==t.error?t.message:t.error.Message||t.error.message||t.message)},300),t})},C.prototype.loadFlowChart=function(){this.content&&this.postMessage("load",{processInstance:this.processInstance,content:this.content,actiInstList:this.actInstList,transInsList:this.transInsList,mode:this.mode})},C.prototype.postMessage=function(t,e){var r={action:t,data:e};this.iframe.nativeElement.contentWindow.postMessage(r,this.fcHtml)},C.prototype.fill=function(){this.cls="d-flex flex-fill h-100 f-utils-absolute-all"},C.func=null,C.decorators=[{type:l.Component,args:[{selector:"wf-flowchart",template:'<layout [direction]="\'h\'" [fill]="true">\r\n    <layout-panel region="west" [showBorder]="false" [minWidth]="400" style="width: 70%;">\r\n        <farris-section [mainTitle]="\'static.flowchart.flowChart\' | translate" [enableMaximize]="false"\r\n            [enableAccordion]="false" [fill]="true" style="height: 100%;" class="px-0 pb-0">\r\n            <ng-template farrisSectionToolbar>   \r\n                <button *ngIf="theme===\'viewFlowChart\'" class="btn btn-secondary mr-2" (click)="modeSwitch()">{{modeButton}}</button>\r\n                <div class="btn-group" fDropdown>\r\n                    <button class="btn btn-secondary dropdown-toggle" fDropdownToggle type="button">\r\n                        {{\'static.flowchart.sequenceColor\' | translate}}\r\n                    </button>\r\n                    <div class="dropdown-menu" fDropdownMenu>\r\n                        <table class="mx-2">\r\n                            <tbody>\r\n                                <tr>\r\n                                    <td style="width:25px;"><span\r\n                                            style="background:#595959;color:#fff;border-radius:0;display: block;width:15px;height:15px;"></span>\r\n                                    </td>\r\n                        \r\n                                    <td style="width:60px;">{{\'static.flowchart.completed\' | translate}}</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style="width:25px;"><span\r\n                                            style="background:#f59c24;color:#fff;border-radius:0;display: block;width:15px;height:15px;"></span>\r\n                                    </td>\r\n                                    <td style="width:60px;">{{\'static.flowchart.calculate\' | translate}}</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style="width:25px;"><span\r\n                                            style="background:#59A1FF;color:#fff;border-radius:0;display: block;width:15px;height:15px;"></span>\r\n                                    </td>\r\n                                    <td style="width:60px;">{{\'static.flowchart.default\' | translate}}</td>\r\n                                </tr>\r\n                                <tr>\r\n                                    <td style="width:25px;"><span\r\n                                            style="background:#FF4040;color:#fff;border-radius:0;display: block;width:15px;height:15px;"></span>\r\n                                    </td>\r\n                                    <td style="width:60px;">{{\'static.flowchart.suspend\' | translate}}</td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </div>\r\n                </div>\r\n\r\n            </ng-template>\r\n            <div *ngIf="dataId || procInstId || processForecastPayload" style="height: 100%;">\r\n                <iframe #iframe class="flowChart" [src]="srcUrl" frameborder="0">\r\n                </iframe>\r\n            </div>\r\n        </farris-section>\r\n    </layout-panel>\r\n    <layout-panel region="center" [showBorder]="false" [minWidth]="300" style="overflow: auto; width: 30%;">\r\n        <farris-section [enableMaximize]="false" [enableAccordion]="false" [showHeader]="false" class="px-0">\r\n            <wf-approval-logs\r\n                [ProcInstId]="procInstId"\r\n                [DataId]="dataId" \r\n                [IfForecast]="ifForecast"\r\n                [ActivityDefinitionId]="actDefId" \r\n                [Type]="type"\r\n                [processForecastPayload] = "processForecastPayload"\r\n                [ShowHeader]="true"\r\n                [ShowViewProcess]="false"\r\n            >\r\n            </wf-approval-logs>\r\n        </farris-section>\r\n    </layout-panel>\r\n</layout>\r\n\r\n',styles:["::ng-deep .chartModal .ant-modal{height:100%}::ng-deep .chartModal .ant-modal-content{height:100%}::ng-deep .chartModal .ant-modal-body{height:90%}.flowChart{height:100%;min-height:400px;width:100%}"]}]}],C.ctorParameters=function(){return[{type:r.DomSanitizer},{type:y},{type:l.ChangeDetectorRef},{type:l.Injector},{type:S,decorators:[{type:l.Optional}]}]},C.propDecorators={cls:[{type:l.HostBinding,args:["class"]}],iframe:[{type:l.ViewChild,args:["iframe"]}],modalHide:[{type:l.Output}],theme:[{type:l.Input}],processForecastPayload:[{type:l.Input}],mode:[{type:l.Input}],ProcInstId:[{type:l.Input}],DataId:[{type:l.Input}]},C);function C(t,e,r,s,o){var n=this;this.sanitizer=t,this.service=e,this.changeDetector=r,this.injector=s,this.chartService=o,this.cls="d-flex flex-fill h-100",this.modalHide=new l.EventEmitter,this.fcHtml=window.document.location.origin+"/platform/runtime/wf/web/designer/flowchart.html",this.theme="viewFlowChart",this._mode="complete",this.modeButton=this.service.getI18nValue("static.flowchart.simulation"),this.typeList=[{value:"complete",text:this.service.getI18nValue("static.flowchart.complete")},{value:"simulation",text:this.service.getI18nValue("static.flowchart.simulation")}],this.eventHandler=function(t){var e=t.origin,r=t.data;if(-1<n.fcHtml.search(e))switch(r.action){case"load":n.viewFlowChart();break;case"viewLogs":n.viewLogs(r.data);break;case"viewParent":n.viewParent(r.data.superProcInstId);break;case"viewChild":n.viewChild(r.data.superActInstId,r.data.superProcInstId);break;case"viewForm":n.viewForm(r.data.procInstId,r.data.actInstId,r.data.bizInstId);break;case"retryAifCreation":n.retryAifCreation(r.data.procInstId,r.data.actInstId,r.data.bizInstId)}},this.message=this.injector.get(a.MessagerService),this.frameworkSvc=this.injector.get(i.FrameworkService),this.srcUrl=this.sanitizer.bypassSecurityTrustResourceUrl(this.fcHtml),C.func&&window.removeEventListener("message",C.func,!1),this.addMessageListener()}var D=(M.prototype.transform=function(t,e){void 0===e&&(e="");var r=this.service.getI18nValue(t);return r||e},M.decorators=[{type:l.Pipe,args:[{name:"translate"}]}],M.ctorParameters=function(){return[{type:y}]},M);function M(t){this.service=t}var B=(L.decorators=[{type:l.NgModule,args:[{declarations:[F,D],imports:[d.LayoutModule,o.CommonModule,n.FarrisDialogModule,a.MessagerModule.forRoot({width:500}),u.FarrisSectionModule,f.WfApprovalLogsModule,h.ComboListModule,I.ReactiveFormsModule,I.FormsModule,m.FDropdownDirectiveTypeModule,g.DatagridModule,v.NotifyModule],exports:[F],providers:[p.HttpService,y,S],entryComponents:[F]}]}],L);function L(){}function x(){}t.UiFlowchartService=y,t.UIFlowchartComponent=F,t.UiFlowchartModule=B,t.WFFlowchartService=S,t.TranslatePipe=D,t.ForecastProcessPayload=x,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=gsp-wf-ui-flowchart.umd.min.js.map