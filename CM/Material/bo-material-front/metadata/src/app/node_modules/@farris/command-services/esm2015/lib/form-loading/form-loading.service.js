import { Injectable, Optional } from '@angular/core';
import { LoadingService } from '@farris/ui-loading';
import { HideEventService } from './hide-event.service';
import { AppContext } from '@farris/devkit';
// tslint:disable: no-string-literal
/**
 * 加载提示Helper
 * 1、包装@farris/ui的LoadingService；
 * 2、提供针对表单的快捷方法；
 */
class FormLoadingService {
    /**
     * 强制显示，不能隐藏
     */
    /**
     * 构造函数
     * 注入@farris/ui的LoadingService
     */
    constructor(loadingService, hideEventService, applicationContext) {
        this.loadingService = loadingService;
        this.hideEventService = hideEventService;
        this.applicationContext = applicationContext;
        /**
         * 延迟loading定时器
         */
        this.loadingTimerIds = [];
        if (hideEventService) {
            this.hideEventService.hideEvent.subscribe(result => {
                this.hide();
            });
        }
    }
    setSuspend(flag) {
        FormLoadingService.isSuspend = flag;
    }
    /**
     * 显示加载中
     */
    show(configOrMessage) {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        if (this.loadingCmp) {
            this.loadingCmp.close();
            this.loadingCmp = null;
        }
        this.registerService();
        const loadingConfig = this.buildLoadingConfig(configOrMessage);
        this.loadingCmp = this.loadingService.show(loadingConfig);
        return this.loadingCmp;
    }
    /**
     * 延迟显示Loading
     */
    showLoadingWithDelay(delayTime, configOrMessage) {
        // this.show(configOrMessage);
        const timerId = setTimeout(() => {
            this.show(configOrMessage);
        }, delayTime);
        this.loadingTimerIds.push(timerId);
        this.registerService();
        return timerId;
    }
    /**
     * 隐藏延迟的Loading
     */
    hideDelayLoading(timerIdToClear) {
        this.clearLoadingTimer(timerIdToClear);
        this.hide();
    }
    /**
     * 构造LoadingConfig
     * @param configOrMessage 配置对象或消息字符串
     */
    buildLoadingConfig(configOrMessage) {
        let loadingConfig;
        if (!!configOrMessage) {
            if (typeof configOrMessage === 'object') {
                loadingConfig = configOrMessage;
            }
            else {
                loadingConfig = { 'message': configOrMessage };
            }
        }
        else {
            loadingConfig = {};
        }
        if (!loadingConfig.hasOwnProperty('delay')) {
            loadingConfig.delay = 0;
        }
        return loadingConfig;
    }
    /**
     * 关闭所有loading
     */
    clearAll() {
        FormLoadingService.isSuspend = false;
        window.setTimeout(() => {
            this.loadingService.clearAll();
        }, 350);
        this.loadingCmp = null;
        this.clearAllLoadingTimers();
        this.destroy();
    }
    /**
     * 清空Loading定时器
     */
    clearLoadingTimer(timerIdToClear) {
        clearTimeout(timerIdToClear);
        this.loadingTimerIds = this.loadingTimerIds.filter((timerId) => {
            return timerId !== timerIdToClear;
        });
    }
    /**
     * 清空所有Loading定时器
     */
    clearAllLoadingTimers() {
        this.loadingTimerIds.forEach((timerId) => {
            this.clearLoadingTimer(timerId);
        });
    }
    /**
     * 隐藏加载中
     */
    hide() {
        if (!this.loadingCmp) {
            this.destroy();
            return;
        }
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        this.loadingCmp.close();
        this.loadingCmp = null;
        this.destroy();
    }
    /**
     * 销毁loadingService
     */
    destroy() {
        if (FormLoadingService.isSuspend === true) {
            return;
        }
        const services = window['DEVKIT_LOADING_SERVICE'] || [];
        if (services && Array.isArray(services) && services.length > 0) {
            services.forEach((service) => {
                if (service) {
                    service.clearAllLoadingTimers();
                    if (service.loadingCmp) {
                        service.loadingCmp.close();
                        service.loadingCmp = null;
                    }
                }
            });
        }
        window['DEVKIT_LOADING_SERVICE'] = [];
    }
    /**
     * 注册所有的LoadingService实例
     */
    registerService() {
        const services = window['DEVKIT_LOADING_SERVICE'] || [];
        services.push(this);
        window['DEVKIT_LOADING_SERVICE'] = services;
    }
}
FormLoadingService.isSuspend = false;
FormLoadingService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FormLoadingService.ctorParameters = () => [
    { type: LoadingService },
    { type: HideEventService, decorators: [{ type: Optional }] },
    { type: AppContext, decorators: [{ type: Optional }] }
];
export { FormLoadingService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1sb2FkaW5nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVksUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxjQUFjLEVBQW1DLE1BQU0sb0JBQW9CLENBQUM7QUFDckYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxFQUFFLFVBQVUsRUFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxvQ0FBb0M7QUFDcEM7Ozs7R0FJRztBQUNILE1BQ00sa0JBQWtCO0lBWXRCOztPQUVHO0lBRUg7OztPQUdHO0lBQ0gsWUFDVSxjQUE4QixFQUNsQixnQkFBa0MsRUFDbEMsa0JBQThCO1FBRjFDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUNsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBWTtRQWhCcEQ7O1dBRUc7UUFDSyxvQkFBZSxHQUFVLEVBQUUsQ0FBQztRQWVsQyxJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUN2QyxNQUFNLENBQUMsRUFBRTtnQkFDUCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDZCxDQUFDLENBQ0YsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUNNLFVBQVUsQ0FBQyxJQUFhO1FBQzdCLGtCQUFrQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDdEMsQ0FBQztJQUNEOztPQUVHO0lBQ0ksSUFBSSxDQUFDLGVBQXFCO1FBQy9CLElBQUksa0JBQWtCLENBQUMsU0FBUyxLQUFLLElBQUksRUFBRTtZQUN6QyxPQUFP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SUFDOUMsQ0FBQzs7QUExS2MsNEJBQVMsR0FBRyxLQUFLLENBQUM7O1lBRmxDLFVBQVU7Ozs7WUFURixjQUFjO1lBQ2QsZ0JBQWdCLHVCQStCcEIsUUFBUTtZQTlCSixVQUFVLHVCQStCZCxRQUFROztBQXdKYixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIFNraXBTZWxmLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTG9hZGluZ1NlcnZpY2UsIExvYWRpbmdDb25maWcsIExvYWRpbmdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxvYWRpbmcnO1xuaW1wb3J0IHsgSGlkZUV2ZW50U2VydmljZSB9IGZyb20gJy4vaGlkZS1ldmVudC5zZXJ2aWNlJztcbmltcG9ydCB7IEFwcENvbnRleHQsIEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0Jztcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbFxuLyoqXG4gKiDliqDovb3mj5DnpLpIZWxwZXJcbiAqIDHjgIHljIXoo4VAZmFycmlzL3Vp55qETG9hZGluZ1NlcnZpY2XvvJtcbiAqIDLjgIHmj5Dkvpvpkojlr7nooajljZXnmoTlv6vmjbfmlrnms5XvvJtcbiAqL1xuQEluamVjdGFibGUoKVxuY2xhc3MgRm9ybUxvYWRpbmdTZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzdGF0aWMgaXNTdXNwZW5kID0gZmFsc2U7XG4gIC8qKlxuICAgKiDliqDovb3kuK3nu4Tku7blrp7kvotcbiAgICovXG4gIHByaXZhdGUgbG9hZGluZ0NtcDogTG9hZGluZ0NvbXBvbmVudDtcblxuICAvKipcbiAgICog5bu26L+fbG9hZGluZ+WumuaXtuWZqFxuICAgKi9cbiAgcHJpdmF0ZSBsb2FkaW5nVGltZXJJZHM6IGFueVtdID0gW107XG5cbiAgLyoqXG4gICAqIOW8uuWItuaYvuekuu+8jOS4jeiDvemakOiXj1xuICAgKi9cblxuICAvKipcbiAgICog5p6E6YCg5Ye95pWwXG4gICAqIOazqOWFpUBmYXJyaXMvdWnnmoRMb2FkaW5nU2VydmljZVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogTG9hZGluZ1NlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBoaWRlRXZlbnRTZXJ2aWNlOiBIaWRlRXZlbnRTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgYXBwbGljYXRpb25Db250ZXh0OiBBcHBDb250ZXh0LFxuICApIHtcbiAgICBpZiAoaGlkZUV2ZW50U2VydmljZSkge1xuICAgICAgdGhpcy5oaWRlRXZlbnRTZXJ2aWNlLmhpZGVFdmVudC5zdWJzY3JpYmUoXG4gICAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgICAgdGhpcy5oaWRlKCk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBzZXRTdXNwZW5kKGZsYWc6IGJvb2xlYW4pIHtcbiAgICBGb3JtTG9hZGluZ1NlcnZpY2UuaXNTdXNwZW5kID0gZmxhZztcbiAgfVxuICAvKipcbiAgICog5pi+56S65Yqg6L295LitXG4gICAqL1xuICBwdWJsaWMgc2hvdyhjb25maWdPck1lc3NhZ2U/OiBhbnkpOiBMb2FkaW5nQ29tcG9uZW50IHtcbiAgICBpZiAoRm9ybUxvYWRpbmdTZXJ2aWNlLmlzU3VzcGVuZCA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAodGhpcy5sb2FkaW5nQ21wKSB7XG4gICAgICB0aGlzLmxvYWRpbmdDbXAuY2xvc2UoKTtcbiAgICAgIHRoaXMubG9hZGluZ0NtcCA9IG51bGw7XG4gICAgfVxuICAgIHRoaXMucmVnaXN0ZXJTZXJ2aWNlKCk7XG4gICAgY29uc3QgbG9hZGluZ0NvbmZpZyA9IHRoaXMuYnVpbGRMb2FkaW5nQ29uZmlnKGNvbmZpZ09yTWVzc2FnZSk7XG4gICAgdGhpcy5sb2FkaW5nQ21wID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KGxvYWRpbmdDb25maWcpO1xuICAgIHJldHVybiB0aGlzLmxvYWRpbmdDbXA7XG4gIH1cblxuICAvKipcbiAgICog5bu26L+f5pi+56S6TG9hZGluZ1xuICAgKi9cbiAgcHVibGljIHNob3dMb2FkaW5nV2l0aERlbGF5KGRlbGF5VGltZTogbnVtYmVyLCBjb25maWdPck1lc3NhZ2U/OiBhbnkpOiBhbnkge1xuICAgIC8vIHRoaXMuc2hvdyhjb25maWdPck1lc3NhZ2UpO1xuICAgIGNvbnN0IHRpbWVySWQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuc2hvdyhjb25maWdPck1lc3NhZ2UpO1xuICAgIH0sIGRlbGF5VGltZSk7XG4gICAgdGhpcy5sb2FkaW5nVGltZXJJZHMucHVzaCh0aW1lcklkKTtcbiAgICB0aGlzLnJlZ2lzdGVyU2VydmljZSgpO1xuICAgIHJldHVybiB0aW1lcklkO1xuICB9XG5cbiAgLyoqXG4gICAqIOmakOiXj+W7tui/n+eahExvYWRpbmdcbiAgICovXG4gIHB1YmxpYyBoaWRlRGVsYXlMb2FkaW5nKHRpbWVySWRUb0NsZWFyOiBhbnkpIHtcbiAgICB0aGlzLmNsZWFyTG9hZGluZ1RpbWVyKHRpbWVySWRUb0NsZWFyKTtcbiAgICB0aGlzLmhpZGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmnoTpgKBMb2FkaW5nQ29uZmlnXG4gICAqIEBwYXJhbSBjb25maWdPck1lc3NhZ2Ug6YWN572u5a+56LGh5oiW5raI5oGv5a2X56ym5LiyXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkTG9hZGluZ0NvbmZpZyhjb25maWdPck1lc3NhZ2U6IGFueSk6IExvYWRpbmdDb25maWcge1xuICAgIGxldCBsb2FkaW5nQ29uZmlnOiBMb2FkaW5nQ29uZmlnO1xuICAgIGlmICghIWNvbmZpZ09yTWVzc2FnZSkge1xuICAgICAgaWYgKHR5cGVvZiBjb25maWdPck1lc3NhZ2UgPT09ICdvYmplY3QnKSB7XG4gICAgICAgIGxvYWRpbmdDb25maWcgPSBjb25maWdPck1lc3NhZ2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2FkaW5nQ29uZmlnID0geyAnbWVzc2FnZSc6IGNvbmZpZ09yTWVzc2FnZSB9O1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsb2FkaW5nQ29uZmlnID0ge307XG4gICAgfVxuICAgIGlmICghbG9hZGluZ0NvbmZpZy5oYXNPd25Qcm9wZXJ0eSgnZGVsYXknKSkge1xuICAgICAgbG9hZGluZ0NvbmZpZy5kZWxheSA9IDA7XG4gICAgfVxuICAgIHJldHVybiBsb2FkaW5nQ29uZmlnO1xuICB9XG5cbiAgLyoqXG4gICAqIOWFs+mXreaJgOaciWxvYWRpbmdcbiAgICovXG4gIHB1YmxpYyBjbGVhckFsbCgpIHtcbiAgICBGb3JtTG9hZGluZ1NlcnZpY2UuaXNTdXNwZW5kID0gZmFsc2U7XG4gICAgd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5jbGVhckFsbCgpO1xuICAgIH0sIDM1MCk7XG4gICAgdGhpcy5sb2FkaW5nQ21wID0gbnVsbDtcbiAgICB0aGlzLmNsZWFyQWxsTG9hZGluZ1RpbWVycygpO1xuICAgIHRoaXMuZGVzdHJveSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIOa4heepukxvYWRpbmflrprml7blmahcbiAgICovXG4gIHByaXZhdGUgY2xlYXJMb2FkaW5nVGltZXIodGltZXJJZFRvQ2xlYXI6IGFueSkge1xuICAgIGNsZWFyVGltZW91dCh0aW1lcklkVG9DbGVhcik7XG4gICAgdGhpcy5sb2FkaW5nVGltZXJJZHMgPSB0aGlzLmxvYWRpbmdUaW1lcklkcy5maWx0ZXIoKHRpbWVySWQ6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIHRpbWVySWQgIT09IHRpbWVySWRUb0NsZWFyO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIOa4heepuuaJgOaciUxvYWRpbmflrprml7blmahcbiAgICovXG4gIHByaXZhdGUgY2xlYXJBbGxMb2FkaW5nVGltZXJzKCkge1xuICAgIHRoaXMubG9hZGluZ1RpbWVySWRzLmZvckVhY2goKHRpbWVySWQ6IGFueSkgPT4ge1xuICAgICAgdGhpcy5jbGVhckxvYWRpbmdUaW1lcih0aW1lcklkKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiDpmpDol4/liqDovb3kuK1cbiAgICovXG4gIHB1YmxpYyBoaWRlKCkge1xuICAgIGlmICghdGhpcy5sb2FkaW5nQ21wKSB7XG4gICAgICB0aGlzLmRlc3Ryb3koKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKEZvcm1Mb2FkaW5nU2VydmljZS5pc1N1c3BlbmQgPT09IHRydWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5sb2FkaW5nQ21wLmNsb3NlKCk7XG4gICAgdGhpcy5sb2FkaW5nQ21wID0gbnVsbDtcbiAgICB0aGlzLmRlc3Ryb3koKTtcbiAgfVxuICAvKipcbiAgICog6ZSA5q+BbG9hZGluZ1NlcnZpY2VcbiAgICovXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIGlmIChGb3JtTG9hZGluZ1NlcnZpY2UuaXNTdXNwZW5kID09PSB0cnVlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IHNlcnZpY2VzOiBhbnlbXSA9IHdpbmRvd1snREVWS0lUX0xPQURJTkdfU0VSVklDRSddIHx8IFtdO1xuICAgIGlmIChzZXJ2aWNlcyAmJiBBcnJheS5pc0FycmF5KHNlcnZpY2VzKSAmJiBzZXJ2aWNlcy5sZW5ndGggPiAwKSB7XG4gICAgICBzZXJ2aWNlcy5mb3JFYWNoKChzZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2UpID0+IHtcbiAgICAgICAgaWYgKHNlcnZpY2UpIHtcbiAgICAgICAgICBzZXJ2aWNlLmNsZWFyQWxsTG9hZGluZ1RpbWVycygpO1xuICAgICAgICAgIGlmIChzZXJ2aWNlLmxvYWRpbmdDbXApIHtcbiAgICAgICAgICAgIHNlcnZpY2UubG9hZGluZ0NtcC5jbG9zZSgpO1xuICAgICAgICAgICAgc2VydmljZS5sb2FkaW5nQ21wID0gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgd2luZG93WydERVZLSVRfTE9BRElOR19TRVJWSUNFJ10gPSBbXTtcbiAgfVxuXG4gIC8qKlxuICAgKiDms6jlhozmiYDmnInnmoRMb2FkaW5nU2VydmljZeWunuS+i1xuICAgKi9cbiAgcHJpdmF0ZSByZWdpc3RlclNlcnZpY2UoKSB7XG4gICAgY29uc3Qgc2VydmljZXM6IGFueVtdID0gd2luZG93WydERVZLSVRfTE9BRElOR19TRVJWSUNFJ10gfHwgW107XG4gICAgc2VydmljZXMucHVzaCh0aGlzKTtcbiAgICB3aW5kb3dbJ0RFVktJVF9MT0FESU5HX1NFUlZJQ0UnXSA9IHNlcnZpY2VzO1xuICB9XG59XG5cblxuZXhwb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH07XG4iXX0=