import { Injectable, Injector } from "@angular/core";
import { AppContext, FrameContext, Repository } from "@farris/devkit";
import { BindingPathService } from "./binding-path.service";
import { FormControlService } from './form-control.service';
var FrameContextService = /** @class */ (function () {
    function FrameContextService(injector, appContext, frameContext, repository, bindingPathService, formControlService) {
        this.injector = injector;
        this.appContext = appContext;
        this.frameContext = frameContext;
        this.repository = repository;
        this.bindingPathService = bindingPathService;
        this.formControlService = formControlService;
    }
    /**
       * 通过BE表名获取对应的frameContext
       * @param tableName
       * @returns
       */
    FrameContextService.prototype.getFrameContextsByTableName = function (tableName) {
        if (!tableName) {
            throw new Error('tableName 不能为空。');
        }
        var dataTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!dataTypeInfo) {
            return null;
        }
        var bindingPaths = [];
        this.bindingPathService.getBindingPathsByTableName(dataTypeInfo, tableName, bindingPaths);
        var frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        if (!frameContexts || frameContexts.length === 0) {
            return null;
        }
        return frameContexts.filter(function (frameContext) { return frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).join('/') === bindingPaths.join('/'); });
    };
    /**
     * 根据字段完整路径获取所在的上下文
     * @param propertyPath
     * @param separtor
     * @returns
     */
    FrameContextService.prototype.getFrameContextsByPropertyPath = function (propertyPath, separtor) {
        if (separtor === void 0) { separtor = '/'; }
        if (!propertyPath) {
            throw new Error('propertyPath 不能为空。');
        }
        var frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter(function (frameContext) {
            var formControls = frameContext && frameContext.form && frameContext.form.ngFormControls || {};
            var bindingPath = frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath || '';
            if (formControls && Object.keys(formControls).length > 0) {
                var key = Object.keys(formControls).find(function (key) {
                    var formControl = formControls[key];
                    if (!formControl || !formControl.binding) {
                        return false;
                    }
                    var bindings = formControl.binding.split('.').filter(function (p) { return p; });
                    var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                    var fullPath = bindingPaths.concat(bindings);
                    return propertyPath.split(separtor).filter(function (p) { return p; }).join('/') === fullPath.join('/');
                });
                return key ? true : false;
            }
            return false;
        });
    };
    /**
     * 通过BE字段名获取字段的bindingPath
     * @param bindingPaths 绑定路径
     * @param columnName BE字段名
     * @returns
     */
    FrameContextService.prototype.getFrameContextsByColumnName = function (bindingPaths, columnName) {
        var _this = this;
        if (!bindingPaths) {
            throw new Error('bindingPath 不能为空。');
        }
        if (!columnName) {
            throw new Error('columnName 不能为空。');
        }
        bindingPaths = bindingPaths.filter(function (p) { return p; });
        var entityTypeInfo = this.repository && this.repository.entityTypeInfo || null;
        if (!entityTypeInfo) {
            return null;
        }
        var dataTypeInfo = entityTypeInfo.getTypeInfoByPath(bindingPaths);
        var dataPropInfos = dataTypeInfo && dataTypeInfo.getPropInfos() || [];
        var columnPropInfo = dataPropInfos.find(function (dataPropInfo) { return dataPropInfo.metadataInfo && (dataPropInfo.metadataInfo.originalDataField === columnName || dataPropInfo.metadataInfo.dataField === columnName); });
        if (!columnPropInfo || !columnPropInfo.metadataInfo) {
            return null;
        }
        var frameContexts = this.appContext.frameContextManager.getFrameContexts();
        return frameContexts.filter(function (frameContext) {
            var ngFormControls = _this.formControlService.getFormControlsByFrameContext(frameContext);
            if (!ngFormControls || Object.keys(ngFormControls).length < 1) {
                return false;
            }
            var currentBindingPaths = _this.bindingPathService.getBindingPathsByFrameContext(frameContext) || [];
            var isValidFrameContext = currentBindingPaths.join('/') === bindingPaths.join('/');
            if (!isValidFrameContext) {
                return false;
            }
            var ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(function (item) { return item.binding === columnPropInfo.metadataInfo.path; });
            return ngFormControl ? true : false;
        });
    };
    /**
     * 通过绑定路径获取对应的组件上下文数组
     * @param bindingPath bindingPath字符串
     * @param namespace ns,默认为''
     */
    FrameContextService.prototype.getFrameContextsByBindingPath = function (bindingPath, namespace) {
        if (namespace === void 0) { namespace = ''; }
        if (Array.isArray(bindingPath)) {
            bindingPath = bindingPath.join('/');
        }
        var frameContexts = this.appContext && this.appContext.frameContextManager.getFrameContexts() || [];
        return frameContexts.filter(function (frameContext) { return frameContext && frameContext.namespace === namespace && frameContext.viewModel.bindingPath === bindingPath; });
    };
    FrameContextService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FrameContextService.ctorParameters = function () { return [
        { type: Injector },
        { type: AppContext },
        { type: FrameContext },
        { type: Repository },
        { type: BindingPathService },
        { type: FormControlService }
    ]; };
    return FrameContextService;
}());
export { FrameContextService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnJhbWUtY29udGV4dC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2ZyYW1lLWNvbnRleHQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsVUFBVSxFQUF3QixZQUFZLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFNUQ7SUFFRSw2QkFDVSxRQUFrQixFQUNsQixVQUFzQixFQUN0QixZQUEwQixFQUMxQixVQUE4QixFQUM5QixrQkFBc0MsRUFDdEMsa0JBQXNDO1FBTHRDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUN0QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUM5Qix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7SUFDMUMsQ0FBQztJQUNQOzs7O1NBSUs7SUFDRSx5REFBMkIsR0FBbEMsVUFBbUMsU0FBaUI7UUFDbEQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQztTQUNwQztRQUNELElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDO1FBQy9FLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELElBQU0sWUFBWSxHQUFHLEVB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QUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQzlCLFdBQVcsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3JDO1FBQ0QsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLGdCQUFnQixFQUFFLElBQUksRUFBRSxDQUFDO1FBQ3RHLE9BQU8sYUFBYSxDQUFDLE1BQU0sQ0FBQyxVQUFDLFlBQTBCLElBQUssT0FBQSxZQUFZLElBQUksWUFBWSxDQUFDLFNBQVMsS0FBSyxTQUFTLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEtBQUssV0FBVyxFQUExRyxDQUEwRyxDQUFDLENBQUM7SUFDMUssQ0FBQzs7Z0JBaEhGLFVBQVU7Ozs7Z0JBTFUsUUFBUTtnQkFDcEIsVUFBVTtnQkFBd0IsWUFBWTtnQkFBRSxVQUFVO2dCQUMxRCxrQkFBa0I7Z0JBQ2xCLGtCQUFrQjs7SUFtSDNCLDBCQUFDO0NBQUEsQUFqSEQsSUFpSEM7U0FoSFksbUJBQW1CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQXBwQ29udGV4dCwgRGF0YVByb3BJbmZvLCBFbnRpdHksIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xuaW1wb3J0IHsgQmluZGluZ1BhdGhTZXJ2aWNlIH0gZnJvbSBcIi4vYmluZGluZy1wYXRoLnNlcnZpY2VcIjtcbmltcG9ydCB7IEZvcm1Db250cm9sU2VydmljZSB9IGZyb20gJy4vZm9ybS1jb250cm9sLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRnJhbWVDb250ZXh0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBcbiAgICBwcml2YXRlIGFwcENvbnRleHQ6IEFwcENvbnRleHQsIFxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxFbnRpdHk+LFxuICAgIHByaXZhdGUgYmluZGluZ1BhdGhTZXJ2aWNlOiBCaW5kaW5nUGF0aFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmb3JtQ29udHJvbFNlcnZpY2U6IEZvcm1Db250cm9sU2VydmljZVxuICAgICkgeyB9XG4gIC8qKlxuICAgICAqIOmAmui/h0JF6KGo5ZCN6I635Y+W5a+55bqU55qEZnJhbWVDb250ZXh0XG4gICAgICogQHBhcmFtIHRhYmxlTmFtZSBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKi9cbiAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeVRhYmxlTmFtZSh0YWJsZU5hbWU6IHN0cmluZyk6IG51bGwgfCBGcmFtZUNvbnRleHRbXSB7XG4gICAgaWYgKCF0YWJsZU5hbWUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigndGFibGVOYW1lIOS4jeiDveS4uuepuuOAgicpO1xuICAgIH1cbiAgICBjb25zdCBkYXRhVHlwZUluZm8gPSB0aGlzLnJlcG9zaXRvcnkgJiYgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvIHx8IG51bGw7XG4gICAgaWYgKCFkYXRhVHlwZUluZm8pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBbXTtcbiAgICB0aGlzLmJpbmRpbmdQYXRoU2VydmljZS5nZXRCaW5kaW5nUGF0aHNCeVRhYmxlTmFtZShkYXRhVHlwZUluZm8sIHRhYmxlTmFtZSwgYmluZGluZ1BhdGhzKTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0ICYmIHRoaXMuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKSB8fCBbXTtcbiAgICBpZiAoIWZyYW1lQ29udGV4dHMgfHwgZnJhbWVDb250ZXh0cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLycpID09PSBiaW5kaW5nUGF0aHMuam9pbignLycpKTtcbiAgfVxuICAvKipcbiAgICog5qC55o2u5a2X5q615a6M5pW06Lev5b6E6I635Y+W5omA5Zyo55qE5LiK5LiL5paHXG4gICAqIEBwYXJhbSBwcm9wZXJ0eVBhdGggXG4gICAqIEBwYXJhbSBzZXBhcnRvciBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0RnJhbWVDb250ZXh0c0J5UHJvcGVydHlQYXRoKHByb3BlcnR5UGF0aDogc3RyaW5nLCBzZXBhcnRvcjogc3RyaW5nID0gJy8nKTogRnJhbWVDb250ZXh0W10ge1xuICAgIGlmICghcHJvcGVydHlQYXRoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb3BlcnR5UGF0aCDkuI3og73kuLrnqbrjgIInKTtcbiAgICB9XG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuYXBwQ29udGV4dCAmJiB0aGlzLmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCkgfHwgW107XG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgY29uc3QgZm9ybUNvbnRyb2xzID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLm5nRm9ybUNvbnRyb2xzIHx8IHt9O1xuICAgICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoIHx8ICcnO1xuICAgICAgaWYgKGZvcm1Db250cm9scyAmJiBPYmplY3Qua2V5cyhmb3JtQ29udHJvbHMpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3Qga2V5ID0gT2JqZWN0LmtleXMoZm9ybUNvbnRyb2xzKS5maW5kKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgICAgIGNvbnN0IGZvcm1Db250cm9sID0gZm9ybUNvbnRyb2xzW2tleV07XG4gICAgICAgICAgaWYgKCFmb3JtQ29udHJvbCB8fCAhZm9ybUNvbnRyb2wuYmluZGluZykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBiaW5kaW5ncyA9IGZvcm1Db250cm9sLmJpbmRpbmcuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gYmluZGluZ1BhdGhzLmNvbmNhdChiaW5kaW5ncyk7XG4gICAgICAgICAgcmV0dXJuIHByb3BlcnR5UGF0aC5zcGxpdChzZXBhcnRvcikuZmlsdGVyKHAgPT4gcCkuam9pbignLycpID09PSBmdWxsUGF0aC5qb2luKCcvJyk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4ga2V5ID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDpgJrov4dCReWtl+auteWQjeiOt+WPluWtl+auteeahGJpbmRpbmdQYXRoXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aHMg57uR5a6a6Lev5b6EXG4gICAqIEBwYXJhbSBjb2x1bW5OYW1lIEJF5a2X5q615ZCNXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGdldEZyYW1lQ29udGV4dHNCeUNvbHVtbk5hbWUoYmluZGluZ1BhdGhzOiBzdHJpbmdbXSwgY29sdW1uTmFtZTogc3RyaW5nKTogRnJhbWVDb250ZXh0W10gfCBudWxsIHtcbiAgICBpZiAoIWJpbmRpbmdQYXRocykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdiaW5kaW5nUGF0aCDkuI3og73kuLrnqbrjgIInKTtcbiAgICB9XG4gICAgaWYgKCFjb2x1bW5OYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2NvbHVtbk5hbWUg5LiN6IO95Li656m644CCJyk7XG4gICAgfVxuICAgIGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRocy5maWx0ZXIocCA9PiBwKTtcbiAgICBjb25zdCBlbnRpdHlUeXBlSW5mbyA9IHRoaXMucmVwb3NpdG9yeSAmJiB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8gfHwgbnVsbDtcbiAgICBpZiAoIWVudGl0eVR5cGVJbmZvKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgZGF0YVR5cGVJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0VHlwZUluZm9CeVBhdGgoYmluZGluZ1BhdGhzKTtcbiAgICBjb25zdCBkYXRhUHJvcEluZm9zID0gZGF0YVR5cGVJbmZvICYmIGRhdGFUeXBlSW5mby5nZXRQcm9wSW5mb3MoKSB8fCBbXTtcbiAgICBjb25zdCBjb2x1bW5Qcm9wSW5mbyA9IGRhdGFQcm9wSW5mb3MuZmluZCgoZGF0YVByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IGRhdGFQcm9wSW5mby5tZXRhZGF0YUluZm8gJiYgKGRhdGFQcm9wSW5mby5tZXRhZGF0YUluZm8ub3JpZ2luYWxEYXRhRmllbGQgPT09IGNvbHVtbk5hbWUgfHwgZGF0YVByb3BJbmZvLm1ldGFkYXRhSW5mby5kYXRhRmllbGQgPT09IGNvbHVtbk5hbWUpKTtcbiAgICBpZiAoIWNvbHVtblByb3BJbmZvIHx8ICFjb2x1bW5Qcm9wSW5mby5tZXRhZGF0YUluZm8pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xuICAgIHJldHVybiBmcmFtZUNvbnRleHRzLmZpbHRlcigoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IHtcbiAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2xzID0gdGhpcy5mb3JtQ29udHJvbFNlcnZpY2UuZ2V0Rm9ybUNvbnRyb2xzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0KTtcbiAgICAgIGlmICghbmdGb3JtQ29udHJvbHMgfHwgT2JqZWN0LmtleXMobmdGb3JtQ29udHJvbHMpLmxlbmd0aCA8IDEpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgY29uc3QgY3VycmVudEJpbmRpbmdQYXRocyA9IHRoaXMuYmluZGluZ1BhdGhTZXJ2aWNlLmdldEJpbmRpbmdQYXRoc0J5RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dCkgfHwgW107XG4gICAgICBjb25zdCBpc1ZhbGlkRnJhbWVDb250ZXh0ID0gY3VycmVudEJpbmRpbmdQYXRocy5qb2luKCcvJykgPT09IGJpbmRpbmdQYXRocy5qb2luKCcvJyk7XG4gICAgICBpZiAoIWlzVmFsaWRGcmFtZUNvbnRleHQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgY29uc3QgbmdGb3JtQ29udHJvbCA9IE9iamVjdC52YWx1ZXMoZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLm5nRm9ybUNvbnRyb2xzKS5maW5kKGl0ZW0gPT4gaXRlbS5iaW5kaW5nID09PSBjb2x1bW5Qcm9wSW5mby5tZXRhZGF0YUluZm8ucGF0aCk7XG4gICAgICByZXR1cm4gbmdGb3JtQ29udHJvbCA/IHRydWUgOiBmYWxzZTtcbiAgICB9KTtcbiAgfVxuICBcbiAgLyoqXG4gICAqIOmAmui/h+e7keWumui3r+W+hOiOt+WPluWvueW6lOeahOe7hOS7tuS4iuS4i+aWh+aVsOe7hFxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGggYmluZGluZ1BhdGjlrZfnrKbkuLJcbiAgICogQHBhcmFtIG5hbWVzcGFjZSBucyzpu5jorqTkuLonJ1xuICAgKi9cbiAgIHB1YmxpYyBnZXRGcmFtZUNvbnRleHRzQnlCaW5kaW5nUGF0aChiaW5kaW5nUGF0aDogc3RyaW5nIHwgc3RyaW5nW10sIG5hbWVzcGFjZTogc3RyaW5nID0gJycpOiBGcmFtZUNvbnRleHRbXSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoYmluZGluZ1BhdGgpKSB7XG4gICAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoLmpvaW4oJy8nKTtcbiAgICB9XG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IHRoaXMuYXBwQ29udGV4dCAmJiB0aGlzLmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCkgfHwgW107XG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCk7XG4gIH1cbn0iXX0=