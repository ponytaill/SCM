/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { LocaleService } from '@farris/ui-locale';
import { Injectable, ApplicationRef, ComponentFactoryResolver, Injector, ElementRef } from '@angular/core';
import { LOADING_DEFAULT_CONFIG, loaddingDefaultConfig } from './loading.config';
import { LoadingComponent } from './loading.component';
import { max } from 'lodash-es';
export class LoadingService {
    /**
     * @param {?} appRef
     * @param {?} cfr
     * @param {?} injecotr
     */
    constructor(appRef, cfr, injecotr) {
        this.appRef = appRef;
        this.cfr = cfr;
        this.injecotr = injecotr;
        this.currentLoadingInstanceID = null;
        this.loadingInstances = {};
        this.localeSer = this.injecotr.get(LocaleService);
    }
    /**
     * @param {?=} config
     * @return {?}
     */
    show(config) {
        this.config = this.injecotr.get(LOADING_DEFAULT_CONFIG) || {};
        this.config = Object.assign(loaddingDefaultConfig, this.config);
        /** @type {?} */
        let _loadingCmpRef;
        /** @type {?} */
        const loadingFactory = this.cfr.resolveComponentFactory(LoadingComponent);
        _loadingCmpRef = loadingFactory.create(this.injecotr);
        if (config) {
            this.config = Object.assign({}, this.config, config);
        }
        /** @type {?} */
        const languageCode = localStorage.getItem('languageCode');
        // if (languageCode === 'en') {
        //     this.config.message = 'Loading...';
        // }
        if (this.localeSer) {
            if (!this.config.message || this.config.message === '正在加载中，请稍候...') {
                this.config.message = this.localeSer.getValue('loading.message');
            }
        }
        /** @type {?} */
        const container = this.config.container;
        if (container === 'body') {
            document.querySelector((/** @type {?} */ (container))).appendChild(_loadingCmpRef.location.nativeElement);
        }
        else {
            if (container instanceof ElementRef) {
                container.nativeElement.appendChild(_loadingCmpRef.location.nativeElement);
            }
            else {
                if (container instanceof Element) {
                    container.appendChild(_loadingCmpRef.location.nativeElement);
                }
            }
        }
        _loadingCmpRef.instance.delay = this.config.delay;
        _loadingCmpRef.instance.isActive = true;
        Object.assign(_loadingCmpRef.instance, this.config);
        _loadingCmpRef.instance.closed.subscribe((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            if (!state) {
                delete this.loadingInstances[_loadingCmpRef.instance.id];
                this.currentLoadingInstanceID = this.getMaxLoadingID();
                this.clearDom(_loadingCmpRef);
            }
        }));
        _loadingCmpRef.changeDetectorRef.markForCheck();
        _loadingCmpRef.changeDetectorRef.detectChanges();
        /** @type {?} */
        const loadingID = this.createInsId();
        _loadingCmpRef.instance.id = loadingID;
        this.loadingInstances[loadingID] = _loadingCmpRef;
        this.currentLoadingInstanceID = loadingID;
        return _loadingCmpRef.instance;
    }
    /**
     * @param {?=} loadingId
     * @return {?}
     */
    close(loadingId) {
        /** @type {?} */
        const id = loadingId || this.currentLoadingInstanceID;
        /** @type {?} */
        const loadingRef = this.loadingInstances[id];
        if (loadingRef) {
            loadingRef.instance.close();
        }
    }
    /**
     * @return {?}
     */
    clearAll() {
        /** @type {?} */
        const keys = Object.keys(this.loadingInstances);
        if (keys.length) {
            keys.forEach((/**
             * @param {?} id
             * @return {?}
             */
            id => {
                this.clearDom(this.loadingInstances[id]);
            }));
        }
        else {
            /** @type {?} */
            const loadings = document.querySelectorAll('farris-loading');
            if (loadings.length) {
                loadings.forEach((/**
                 * @param {?} el
                 * @return {?}
                 */
                el => el.remove()));
            }
            this.loadingInstances = {};
        }
    }
    /**
     * @private
     * @param {?} _loadingCmpRef
     * @return {?}
     */
    clearDom(_loadingCmpRef) {
        if (_loadingCmpRef && _loadingCmpRef.location) {
            /** @type {?} */
            const loadingEl = _loadingCmpRef.location.nativeElement;
            if (loadingEl.parentNode) {
                loadingEl.parentNode.removeChild(loadingEl);
            }
            _loadingCmpRef.destroy();
        }
        _loadingCmpRef = null;
    }
    /**
     * @private
     * @return {?}
     */
    createInsId() {
        return this.getMaxLoadingID() + 1;
    }
    /**
     * @private
     * @return {?}
     */
    getMaxLoadingID() {
        /** @type {?} */
        const ids = Object.keys(this.loadingInstances).map((/**
         * @param {?} k
         * @return {?}
         */
        k => parseInt(k, 10)));
        if (ids.length) {
            return max(ids);
        }
        return 0;
    }
}
LoadingService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
LoadingService.ctorParameters = () => [
    { type: ApplicationRef },
    { type: ComponentFactoryResolver },
    { type: Injector }
];
if (false) {
    /** @type {?} */
    LoadingService.prototype.config;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.currentLoadingInstanceID;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.loadingInstances;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.localeSer;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.appRef;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.cfr;
    /**
     * @type {?}
     * @private
     */
    LoadingService.prototype.injecotr;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZGluZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb2FkaW5nLyIsInNvdXJjZXMiOlsibGliL2xvYWRpbmcuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLHdCQUF3QixFQUFFLFFBQVEsRUFBZ0IsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pILE9BQU8sRUFBaUIsc0JBQXNCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNoRyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR2hDLE1BQU0sT0FBTyxjQUFjOzs7Ozs7SUFNdkIsWUFBb0IsTUFBc0IsRUFDdEIsR0FBNkIsRUFBVSxRQUFrQjtRQUR6RCxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixRQUFHLEdBQUgsR0FBRyxDQUEwQjtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFKckUsNkJBQXdCLEdBQUcsSUFBSSxDQUFDO1FBQ2hDLHFCQUFnQixHQUFzRCxFQUFFLENBQUM7UUFJakUsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNsRSxDQUFDOzs7OztJQUVELElBQUksQ0FBQyxNQUFzQjtRQUN2QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQzlELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7O1lBRTVELGNBQThDOztjQUM1QyxjQUFjLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQztRQUN6RSxjQUFjLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFdEQsSUFBSSxNQUFNLEVBQUU7WUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7U0FDeEQ7O2NBQ0ssWUFBWSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDO1FBQ3pELCtCQUErQjtRQUMvQiwwQ0FBMEM7UUFDMUMsSUFBSTtRQUNKLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEtBQUssY0FBYyxFQUFFO2dCQUNoRSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2FBQ3BFO1NBQ0o7O2NBRUssU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUztRQUN2QyxJQUFJLFNBQVMsS0FBSyxNQUFNLEVBQUU7WUFDdEIsUUFBUSxDQUFDLGFBQWEsQ0FBQyxtQkFBQSxTQUFTLEVBQVUsQ0FBQyxDQUFDLFdBQVcsQ0FBRSxjQUFjLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ25HO2FBQU07WUFDSCxJQUFJLFNBQVMsWUFBWSxVQUFVLEVBQUc7Z0JBQ2xDLFNBQVMsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUMvQixjQUFjLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FDeEMsQ0FBQzthQUNMO2lCQUFNO2dCQUNILElBQUksU0FBUyxZQUFZLE9BQU8sRUFBRTtvQkFDOUIsU0FBUyxDQUFDLFdBQVcsQ0FDakIsY0FBYyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQ3hDLENBQUM7aUJBQ0w7YUFDSjtTQUNKO1FBQ0QsY0FBYyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDbEQsY0FBYyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3hDLE1BQU0sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFcEQsY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUzs7OztRQUFDLEtBQUssQ0FBQyxFQUFFO1lBQzdDLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ1IsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDekQsSUFBSSxDQUFDLHdCQUF3QixHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztnQkFDdkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUNqQztRQUNMLENBQUMsRUFBQyxDQUFDO1FBRUgsY0FBYyxDQUFDLGlCQUFpQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2hELGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLEVBQUUsQ0FBQzs7Y0FFM0MsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUU7UUFDcEMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEdBQUcsU0FBUyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsR0FBSSxjQUFjLENBQUM7UUFDbkQsSUFBSSxDQUFDLHdCQUF3QixHQUFHLFNBQVMsQ0FBQztRQUUxQyxPQUFPLGNBQWMsQ0FBQyxRQUFRLENBQUM7SUFDbkMsQ0FBQzs7Ozs7SUFFRCxLQUFLLENBQUMsU0FBa0I7O2NBQ2QsRUFBRSxHQUFHLFNBQVMsSUFBSSxJQUFJLENBQUMsd0JBQXdCOztjQUMvQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztRQUM1QyxJQUFJLFVBQVUsRUFBRTtZQUNaLFVBQVUsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDL0I7SUFDTCxDQUFDOzs7O0lBRUQsUUFBUTs7Y0FDRSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDL0MsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ2IsSUFBSSxDQUFDLE9BQU87Ozs7WUFBQyxFQUFFLENBQUMsRUFBRTtnQkFDZCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzdDLENBQUMsRUFBQyxDQUFDO1NBQ047YUFBTTs7a0JBQ0csUUFBUSxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQztZQUM1RCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEVBQUU7Z0JBQ2pCLFFBQVEsQ0FBQyxPQUFPOzs7O2dCQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7YUFDekM7WUFFRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1NBQzlCO0lBQ0wsQ0FBQzs7Ozs7O0lBRU8sUUFBUSxDQUFDLGNBQThDO1FBQzNELElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxRQUFRLEVBQUU7O2tCQUNyQyxTQUFTLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQyxhQUFhO1lBRXZELElBQUksU0FBUyxDQUFDLFVBQVUsRUFBRTtnQkFDdEIsU0FBUyxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDL0M7WUFFRCxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDNUI7UUFFRCxjQUFjLEdBQUcsSUFBSSxDQUFDO0lBQzFCLENBQUM7Ozs7O0lBRU8sV0FBVztRQUNmLE9BQU8sSUFBSSxDQUFDLGVBQWUsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN0QyxDQUFDOzs7OztJQUVPLGVBQWU7O2NBQ2IsR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsR0FBRzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBQztRQUN4RSxJQUFJLEdBQUcsQ0FBQyxNQUFNLEVBQUU7WUFDWixPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNuQjtRQUVELE9BQU8sQ0FBQyxDQUFDO0lBQ2IsQ0FBQzs7O1lBekhKLFVBQVU7Ozs7WUFMVSxjQUFjO1lBQUUsd0JBQXdCO1lBQUUsUUFBUTs7OztJQU9uRSxnQ0FBc0I7Ozs7O0lBRXRCLGtEQUF3Qzs7Ozs7SUFDeEMsMENBQWlGOzs7OztJQUNqRixtQ0FBaUM7Ozs7O0lBQ3JCLGdDQUE4Qjs7Ozs7SUFDOUIsNkJBQXFDOzs7OztJQUFFLGtDQUEwQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2FsZVNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWxvY2FsZSc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEFwcGxpY2F0aW9uUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIEluamVjdG9yLCBDb21wb25lbnRSZWYsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTG9hZGluZ0NvbmZpZywgTE9BRElOR19ERUZBVUxUX0NPTkZJRywgbG9hZGRpbmdEZWZhdWx0Q29uZmlnIH0gZnJvbSAnLi9sb2FkaW5nLmNvbmZpZyc7XHJcbmltcG9ydCB7IExvYWRpbmdDb21wb25lbnQgfSBmcm9tICcuL2xvYWRpbmcuY29tcG9uZW50JztcclxuaW1wb3J0IHsgbWF4IH0gZnJvbSAnbG9kYXNoLWVzJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIExvYWRpbmdTZXJ2aWNlIHtcclxuICAgIGNvbmZpZzogTG9hZGluZ0NvbmZpZztcclxuXHJcbiAgICBwcml2YXRlIGN1cnJlbnRMb2FkaW5nSW5zdGFuY2VJRCA9IG51bGw7XHJcbiAgICBwcml2YXRlIGxvYWRpbmdJbnN0YW5jZXM6IHsgW2tleTogbnVtYmVyXTogQ29tcG9uZW50UmVmPExvYWRpbmdDb21wb25lbnQ+IH0gPSB7fTtcclxuICAgIHByaXZhdGUgbG9jYWxlU2VyOiBMb2NhbGVTZXJ2aWNlO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmLFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBjZnI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgcHJpdmF0ZSBpbmplY290cjogSW5qZWN0b3IpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmxvY2FsZVNlciA9IHRoaXMuaW5qZWNvdHIuZ2V0KExvY2FsZVNlcnZpY2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHNob3coY29uZmlnPzogTG9hZGluZ0NvbmZpZyk6IExvYWRpbmdDb21wb25lbnQge1xyXG4gICAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5pbmplY290ci5nZXQoTE9BRElOR19ERUZBVUxUX0NPTkZJRykgfHwge307XHJcbiAgICAgICAgdGhpcy5jb25maWcgPSBPYmplY3QuYXNzaWduKGxvYWRkaW5nRGVmYXVsdENvbmZpZywgdGhpcy5jb25maWcpO1xyXG5cclxuICAgICAgICBsZXQgX2xvYWRpbmdDbXBSZWY6IENvbXBvbmVudFJlZjxMb2FkaW5nQ29tcG9uZW50PjtcclxuICAgICAgICBjb25zdCBsb2FkaW5nRmFjdG9yeSA9IHRoaXMuY2ZyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KExvYWRpbmdDb21wb25lbnQpO1xyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmID0gbG9hZGluZ0ZhY3RvcnkuY3JlYXRlKHRoaXMuaW5qZWNvdHIpO1xyXG5cclxuICAgICAgICBpZiAoY29uZmlnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5jb25maWcsIGNvbmZpZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGxhbmd1YWdlQ29kZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdsYW5ndWFnZUNvZGUnKTtcclxuICAgICAgICAvLyBpZiAobGFuZ3VhZ2VDb2RlID09PSAnZW4nKSB7XHJcbiAgICAgICAgLy8gICAgIHRoaXMuY29uZmlnLm1lc3NhZ2UgPSAnTG9hZGluZy4uLic7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIGlmICh0aGlzLmxvY2FsZVNlcikge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29uZmlnLm1lc3NhZ2UgfHwgdGhpcy5jb25maWcubWVzc2FnZSA9PT0gJ+ato+WcqOWKoOi9veS4re+8jOivt+eojeWAmS4uLicpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLm1lc3NhZ2UgPSB0aGlzLmxvY2FsZVNlci5nZXRWYWx1ZSgnbG9hZGluZy5tZXNzYWdlJyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY29uZmlnLmNvbnRhaW5lcjtcclxuICAgICAgICBpZiAoY29udGFpbmVyID09PSAnYm9keScpIHtcclxuICAgICAgICAgICAgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcihjb250YWluZXIgYXMgc3RyaW5nKS5hcHBlbmRDaGlsZCggX2xvYWRpbmdDbXBSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lciBpbnN0YW5jZW9mIEVsZW1lbnRSZWYgKSB7XHJcbiAgICAgICAgICAgICAgICBjb250YWluZXIubmF0aXZlRWxlbWVudC5hcHBlbmRDaGlsZChcclxuICAgICAgICAgICAgICAgICAgICBfbG9hZGluZ0NtcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50XHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGNvbnRhaW5lciBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb250YWluZXIuYXBwZW5kQ2hpbGQoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIF9sb2FkaW5nQ21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnRcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmLmluc3RhbmNlLmRlbGF5ID0gdGhpcy5jb25maWcuZGVsYXk7XHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYuaW5zdGFuY2UuaXNBY3RpdmUgPSB0cnVlO1xyXG4gICAgICAgIE9iamVjdC5hc3NpZ24oX2xvYWRpbmdDbXBSZWYuaW5zdGFuY2UsIHRoaXMuY29uZmlnKTtcclxuXHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYuaW5zdGFuY2UuY2xvc2VkLnN1YnNjcmliZShzdGF0ZSA9PiB7XHJcbiAgICAgICAgICAgIGlmICghc3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLmxvYWRpbmdJbnN0YW5jZXNbX2xvYWRpbmdDbXBSZWYuaW5zdGFuY2UuaWRdO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50TG9hZGluZ0luc3RhbmNlSUQgPSB0aGlzLmdldE1heExvYWRpbmdJRCgpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhckRvbShfbG9hZGluZ0NtcFJlZik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYuY2hhbmdlRGV0ZWN0b3JSZWYubWFya0ZvckNoZWNrKCk7XHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYuY2hhbmdlRGV0ZWN0b3JSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG5cclxuICAgICAgICBjb25zdCBsb2FkaW5nSUQgPSB0aGlzLmNyZWF0ZUluc0lkKCk7XHJcbiAgICAgICAgX2xvYWRpbmdDbXBSZWYuaW5zdGFuY2UuaWQgPSBsb2FkaW5nSUQ7XHJcbiAgICAgICAgdGhpcy5sb2FkaW5nSW5zdGFuY2VzW2xvYWRpbmdJRF0gPSAgX2xvYWRpbmdDbXBSZWY7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50TG9hZGluZ0luc3RhbmNlSUQgPSBsb2FkaW5nSUQ7XHJcblxyXG4gICAgICAgIHJldHVybiBfbG9hZGluZ0NtcFJlZi5pbnN0YW5jZTtcclxuICAgIH1cclxuXHJcbiAgICBjbG9zZShsb2FkaW5nSWQ/OiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCBpZCA9IGxvYWRpbmdJZCB8fCB0aGlzLmN1cnJlbnRMb2FkaW5nSW5zdGFuY2VJRDtcclxuICAgICAgICBjb25zdCBsb2FkaW5nUmVmID0gdGhpcy5sb2FkaW5nSW5zdGFuY2VzW2lkXTtcclxuICAgICAgICBpZiAobG9hZGluZ1JlZikge1xyXG4gICAgICAgICAgICBsb2FkaW5nUmVmLmluc3RhbmNlLmNsb3NlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNsZWFyQWxsKCkge1xyXG4gICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyh0aGlzLmxvYWRpbmdJbnN0YW5jZXMpO1xyXG4gICAgICAgIGlmIChrZXlzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBrZXlzLmZvckVhY2goaWQgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhckRvbSh0aGlzLmxvYWRpbmdJbnN0YW5jZXNbaWRdKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgbG9hZGluZ3MgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdmYXJyaXMtbG9hZGluZycpO1xyXG4gICAgICAgICAgICBpZiAobG9hZGluZ3MubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBsb2FkaW5ncy5mb3JFYWNoKCBlbCA9PiBlbC5yZW1vdmUoKSApO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmxvYWRpbmdJbnN0YW5jZXMgPSB7fTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbGVhckRvbShfbG9hZGluZ0NtcFJlZjogQ29tcG9uZW50UmVmPExvYWRpbmdDb21wb25lbnQ+KSB7XHJcbiAgICAgICAgaWYgKF9sb2FkaW5nQ21wUmVmICYmIF9sb2FkaW5nQ21wUmVmLmxvY2F0aW9uKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxvYWRpbmdFbCA9IF9sb2FkaW5nQ21wUmVmLmxvY2F0aW9uLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgICAgICAgICBpZiAobG9hZGluZ0VsLnBhcmVudE5vZGUpIHtcclxuICAgICAgICAgICAgICAgIGxvYWRpbmdFbC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKGxvYWRpbmdFbCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIF9sb2FkaW5nQ21wUmVmLmRlc3Ryb3koKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIF9sb2FkaW5nQ21wUmVmID0gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNyZWF0ZUluc0lkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmdldE1heExvYWRpbmdJRCgpICsgMTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldE1heExvYWRpbmdJRCgpIHtcclxuICAgICAgICBjb25zdCBpZHMgPSBPYmplY3Qua2V5cyh0aGlzLmxvYWRpbmdJbnN0YW5jZXMpLm1hcChrID0+IHBhcnNlSW50KGssIDEwKSk7XHJcbiAgICAgICAgaWYgKGlkcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIG1heChpZHMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIDA7XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==