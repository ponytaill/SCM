import { Directive, Input, Injector, Optional } from '@angular/core';
import { FrameContext, ChangeType } from '@farris/devkit';
import { FFilePreviewComponent, UploadAndPreviewComponent } from '@farris/extend-file-upload';
/**
 * 树表格绑定指令
 */
class FarrisFilePreviewBindingDirective {
    /**
     * 构造函数
     */
    constructor(previewComponent, frameContext, uploadAndPreviewComponent, injector) {
        this.previewComponent = previewComponent;
        this.frameContext = frameContext;
        this.uploadAndPreviewComponent = uploadAndPreviewComponent;
        this.injector = injector;
    }
    /**
     * 绑定数据
     */
    get bindingData() {
        return this.frameContext.bindingData;
    }
    /**
     * 绑定数据列表
     */
    get bindingList() {
        return this.bindingData.getList();
    }
    /**
     * 指令初始化
     */
    ngOnInit() {
        this.bindData();
        this.uploadAndPreviewComponent.orderField = 'fileSortOrder';
        this.bindingData.changes.subscribe((change) => {
            if (change.type === ChangeType.Load
                || change.type === ChangeType.Append
                || change.type === ChangeType.Remove) {
                this.bindData();
            }
        });
    }
    /**
     * 指令输入变更
     */
    ngOnChanges(changes) {
    }
    /**
     * 绑定数据
     */
    bindData() {
        const fileInfos = this.getFileInfos();
        if (this.componentRef) {
            this.componentRef.fileInfos = fileInfos;
        }
    }
    /**
     * 获取附件信息列表
     */
    getFileInfos() {
        const listData = this.bindingList.toJSON();
        const idKey = this.bindingList.primaryKey;
        const fileInfos = [];
        listData.forEach((itemData) => {
            const id = this.getValueByPath(itemData, idKey);
            const fileId = this.getValueByPath(itemData, this.fileIdKey);
            const fileName = this.getValueByPath(itemData, this.fileNameKey);
            const fileSize = this.getValueByPath(itemData, this.fileSizeKey);
            const fileCreateTime = this.getValueByPath(itemData, this.fileCreateTimeKey);
            const fileInfo = {
                id: fileId,
                name: fileName,
                size: fileSize,
                createTime: fileCreateTime,
                originalData: itemData,
                extend: {
                    metadataId: fileId
                }
            };
            if (this.extendFileInfo && Array.isArray(this.extendFileInfo) && this.extendFileInfo.length > 0) {
                this.extendFileInfo.forEach(item => {
                    fileInfo[item.key] = this.getValueByPath(itemData, item.path);
                });
            }
            if (this.fileSortOrderKey) {
                const fileSortOrder = this.getValueByPath(itemData, this.fileSortOrderKey);
                fileInfo.fileSortOrder = fileSortOrder;
            }
            fileInfos.push(fileInfo);
        });
        return fileInfos;
    }
    /**
     * 根据字段路径获取值
     */
    getValueByPath(data, path) {
        const keys = path.split('.');
        let currentValue = data;
        keys.forEach((key) => {
            currentValue = currentValue && currentValue[key];
        });
        return currentValue;
    }
    getUdtPaths() {
        const paths = this.fileIdKey.split('.');
        paths.pop();
        return paths;
    }
    get fileSizeKey() {
        const basePaths = this.getUdtPaths();
        return basePaths.concat(['fileSize']).join('.');
    }
    get fileCreateTimeKey() {
        const basePaths = this.getUdtPaths();
        return basePaths.concat(['fileCreateTime']).join('.');
    }
    get componentRef() {
        return this.previewComponent || this.uploadAndPreviewComponent || null;
    }
}
FarrisFilePreviewBindingDirective.decorators = [
    { type: Directive, args: [{
                selector: '[farrisFilePreviewBinding]'
            },] }
];
/** @nocollapse */
FarrisFilePreviewBindingDirective.ctorParameters = () => [
    { type: FFilePreviewComponent, decorators: [{ type: Optional }] },
    { type: FrameContext },
    { type: UploadAndPreviewComponent, decorators: [{ type: Optional }] },
    { type: Injector, decorators: [{ type: Optional }] }
];
FarrisFilePreviewBindingDirective.propDecorators = {
    extendFileInfo: [{ type: Input, args: ['extendFileInfo',] }],
    fileIdKey: [{ type: Input, args: ['farrisFileIdKey',] }],
    fileSortOrderKey: [{ type: Input, args: ['farrisFileSortOrderKey',] }],
    fileNameKey: [{ type: Input, args: ['farrisFileNameKey',] }]
};
export { FarrisFilePreviewBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWZpbGUtcHJldmlldy1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2ZpbGUtcHJldmlldy9mYXJyaXMtZmlsZS1wcmV2aWV3LWJpbmRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQW9DLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZHLE9BQU8sRUFBNEIsWUFBWSxFQUFVLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVGLE9BQU8sRUFBYyxxQkFBcUIsRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFHOztHQUVHO0FBQ0gsTUFHTSxpQ0FBaUM7SUFrQ3JDOztPQUVHO0lBQ0gsWUFDc0IsZ0JBQXVDLEVBQ25ELFlBQTBCLEVBQ2QseUJBQW9ELEVBQ3BELFFBQWtCO1FBSGxCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBdUI7UUFDbkQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDZCw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELGFBQVEsR0FBUixRQUFRLENBQVU7SUFFeEMsQ0FBQztJQXZCRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDcEMsQ0FBQztJQWFEOztPQUVHO0lBQ0gsUUFBUTtRQUNOLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMseUJBQXlCLENBQUMsVUFBVSxHQUFHLGVBQWUsQ0FBQztRQUM1RCxJQUFJLENBQUMsV0FBVyxD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Ozs2QkF2Q1YsS0FBSyxTQUFDLGdCQUFnQjt3QkFLdEIsS0FBSyxTQUFDLGlCQUFpQjsrQkFLdkIsS0FBSyxTQUFDLHdCQUF3QjswQkFLOUIsS0FBSyxTQUFDLG1CQUFtQjs7QUFrSTVCLE9BQU8sRUFBRSxpQ0FBaUMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgSW5wdXQsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QsIEZyYW1lQ29udGV4dCwgQ2hhbmdlLCBDaGFuZ2VUeXBlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBVcGxvYWRGaWxlLCBGRmlsZVByZXZpZXdDb21wb25lbnQsIFVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL2V4dGVuZC1maWxlLXVwbG9hZCc7XHJcblxyXG4vKipcclxuICog5qCR6KGo5qC857uR5a6a5oyH5LukXHJcbiAqL1xyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tmYXJyaXNGaWxlUHJldmlld0JpbmRpbmddJ1xyXG59KVxyXG5jbGFzcyBGYXJyaXNGaWxlUHJldmlld0JpbmRpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcyB7XHJcblxyXG4gIEBJbnB1dCgnZXh0ZW5kRmlsZUluZm8nKVxyXG4gIHB1YmxpYyBleHRlbmRGaWxlSW5mbzogeyBrZXk6IHN0cmluZywgcGF0aDogYW55IH1bXTtcclxuICAvKipcclxuICAgKiDmlofku7ZpZOWtl+autei3r+W+hFxyXG4gICAqL1xyXG4gIEBJbnB1dCgnZmFycmlzRmlsZUlkS2V5JylcclxuICBwdWJsaWMgZmlsZUlkS2V5OiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICog5o6S5bqP5a2X5q61XHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXNGaWxlU29ydE9yZGVyS2V5JylcclxuICBwdWJsaWMgZmlsZVNvcnRPcmRlcktleTogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIOaWh+S7tm5hbWXlrZfmrrXot6/lvoRcclxuICAgKi9cclxuICBASW5wdXQoJ2ZhcnJpc0ZpbGVOYW1lS2V5JylcclxuICBwdWJsaWMgZmlsZU5hbWVLZXk6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0RhdGEoKTogQmluZGluZ0RhdGEge1xyXG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2u5YiX6KGoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xyXG4gICAgcmV0dXJuIHRoaXMuYmluZGluZ0RhdGEuZ2V0TGlzdCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHByZXZpZXdDb21wb25lbnQ6IEZGaWxlUHJldmlld0NvbXBvbmVudCxcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIHVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQ6IFVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvclxyXG4gICkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5oyH5Luk5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgICB0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQub3JkZXJGaWVsZCA9ICdmaWxlU29ydE9yZGVyJztcclxuICAgIHRoaXMuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUoKGNoYW5nZTogQ2hhbmdlKSA9PiB7XHJcbiAgICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkXHJcbiAgICAgICAgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuQXBwZW5kXHJcbiAgICAgICAgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuUmVtb3ZlXHJcbiAgICAgICkge1xyXG4gICAgICAgIHRoaXMuYmluZERhdGEoKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmjIfku6TovpPlhaXlj5jmm7RcclxuICAgKi9cclxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a5pWw5o2uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBiaW5kRGF0YSgpIHtcclxuICAgIGNvbnN0IGZpbGVJbmZvcyA9IHRoaXMuZ2V0RmlsZUluZm9zKCk7XHJcbiAgICBpZiAodGhpcy5jb21wb25lbnRSZWYpIHtcclxuICAgICAgdGhpcy5jb21wb25lbnRSZWYuZmlsZUluZm9zID0gZmlsZUluZm9zO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W6ZmE5Lu25L+h5oGv5YiX6KGoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRGaWxlSW5mb3MoKTogVXBsb2FkRmlsZVtdIHtcclxuICAgIGNvbnN0IGxpc3REYXRhID0gdGhpcy5iaW5kaW5nTGlzdC50b0pTT04oKTtcclxuICAgIGNvbnN0IGlkS2V5ID0gdGhpcy5iaW5kaW5nTGlzdC5wcmltYXJ5S2V5O1xyXG4gICAgY29uc3QgZmlsZUluZm9zOiBVcGxvYWRGaWxlW10gPSBbXTtcclxuXHJcbiAgICBsaXN0RGF0YS5mb3JFYWNoKChpdGVtRGF0YTogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IGlkID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgaWRLZXkpO1xyXG4gICAgICBjb25zdCBmaWxlSWQgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCB0aGlzLmZpbGVJZEtleSk7XHJcbiAgICAgIGNvbnN0IGZpbGVOYW1lID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgdGhpcy5maWxlTmFtZUtleSk7XHJcbiAgICAgIGNvbnN0IGZpbGVTaXplID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgdGhpcy5maWxlU2l6ZUtleSk7XHJcbiAgICAgIGNvbnN0IGZpbGVDcmVhdGVUaW1lID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgdGhpcy5maWxlQ3JlYXRlVGltZUtleSk7XHJcblxyXG4gICAgICBjb25zdCBmaWxlSW5mbzogYW55ID0ge1xyXG4gICAgICAgIGlkOiBmaWxlSWQsXHJcbiAgICAgICAgbmFtZTogZmlsZU5hbWUsXHJcbiAgICAgICAgc2l6ZTogZmlsZVNpemUsXHJcbiAgICAgICAgY3JlYXRlVGltZTogZmlsZUNyZWF0ZVRpbWUsXHJcbiAgICAgICAgb3JpZ2luYWxEYXRhOiBpdGVtRGF0YSxcclxuICAgICAgICBleHRlbmQ6IHtcclxuICAgICAgICAgIG1ldGFkYXRhSWQ6IGZpbGVJZFxyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgICAgaWYgKHRoaXMuZXh0ZW5kRmlsZUluZm8gJiYgQXJyYXkuaXNBcnJheSh0aGlzLmV4dGVuZEZpbGVJbmZvKSAmJiB0aGlzLmV4dGVuZEZpbGVJbmZvLmxlbmd0aCA+IDApIHtcclxuICAgICAgICB0aGlzLmV4dGVuZEZpbGVJbmZvLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICBmaWxlSW5mb1tpdGVtLmtleV0gPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW1EYXRhLCBpdGVtLnBhdGgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICAgIGlmICh0aGlzLmZpbGVTb3J0T3JkZXJLZXkpIHtcclxuICAgICAgICBjb25zdCBmaWxlU29ydE9yZGVyID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgdGhpcy5maWxlU29ydE9yZGVyS2V5KTtcclxuICAgICAgICBmaWxlSW5mby5maWxlU29ydE9yZGVyID0gZmlsZVNvcnRPcmRlcjtcclxuICAgICAgfVxyXG4gICAgICBmaWxlSW5mb3MucHVzaChmaWxlSW5mbyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gZmlsZUluZm9zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2u5a2X5q616Lev5b6E6I635Y+W5YC8XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRWYWx1ZUJ5UGF0aChkYXRhOiBhbnksIHBhdGg6IHN0cmluZyk6IGFueSB7XHJcbiAgICBjb25zdCBrZXlzID0gcGF0aC5zcGxpdCgnLicpO1xyXG4gICAgbGV0IGN1cnJlbnRWYWx1ZSA9IGRhdGE7XHJcbiAgICBrZXlzLmZvckVhY2goKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGN1cnJlbnRWYWx1ZSA9IGN1cnJlbnRWYWx1ZSAmJiBjdXJyZW50VmFsdWVba2V5XTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGN1cnJlbnRWYWx1ZTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRVZHRQYXRocygpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwYXRocyA9IHRoaXMuZmlsZUlkS2V5LnNwbGl0KCcuJyk7XHJcbiAgICBwYXRocy5wb3AoKTtcclxuICAgIHJldHVybiBwYXRocztcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgZmlsZVNpemVLZXkoKSB7XHJcbiAgICBjb25zdCBiYXNlUGF0aHMgPSB0aGlzLmdldFVkdFBhdGhzKCk7XHJcbiAgICByZXR1cm4gYmFzZVBhdGhzLmNvbmNhdChbJ2ZpbGVTaXplJ10pLmpvaW4oJy4nKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgZmlsZUNyZWF0ZVRpbWVLZXkoKSB7XHJcbiAgICBjb25zdCBiYXNlUGF0aHMgPSB0aGlzLmdldFVkdFBhdGhzKCk7XHJcbiAgICByZXR1cm4gYmFzZVBhdGhzLmNvbmNhdChbJ2ZpbGVDcmVhdGVUaW1lJ10pLmpvaW4oJy4nKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXQgY29tcG9uZW50UmVmKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucHJldmlld0NvbXBvbmVudCB8fCB0aGlzLnVwbG9hZEFuZFByZXZpZXdDb21wb25lbnQgfHwgbnVsbDtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCB7IEZhcnJpc0ZpbGVQcmV2aWV3QmluZGluZ0RpcmVjdGl2ZSB9O1xyXG4iXX0=