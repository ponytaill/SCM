/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, Input, ElementRef, Renderer2, ViewContainerRef, ComponentFactoryResolver, } from "@angular/core";
import { OverLayHiddenService } from "@farris/ui-common";
import { TooltipComponent } from "./tooltip-component/tooltip.component";
export class FarrisTooltipDirective {
    /**
     * @param {?} el
     * @param {?} render
     * @param {?} viewContainerRef
     * @param {?} resolver
     */
    constructor(el, render, viewContainerRef, resolver) {
        this.el = el;
        this.render = render;
        this.viewContainerRef = viewContainerRef;
        this.resolver = resolver;
        this.tooltipEnable = true;
        /* 提示文本 */
        this.text = "";
        // 提示框样式
        this.tipCls = "";
        // 提示框宽度
        this.tipWidth = "";
        /* 位置 */
        this.placement = "top";
        this.triggerMode = "hover";
        this.showTip = true;
        this.delay = 0;
        // 是否绑定了事件
        this.hasBindEvent = false;
        this.delayTimer = null;
        /* 生成提示组件 */
        this.componentFactory = this.resolver.resolveComponentFactory(TooltipComponent);
        this.overLayService = new OverLayHiddenService();
    }
    // 5月7日追加这种写法，控制禁用、启用
    // 原来的时候value是空字符串
    /**
     * @param {?} value
     * @return {?}
     */
    set enableTooltip(value) {
        if (typeof value == "string" && value == "") {
            this.enableOrDisable(true);
        }
        else {
            this.enableOrDisable(value);
        }
    }
    /**
     * @return {?}
     */
    get enableTooltip() {
        return this.tooltipEnable;
    }
    /* 触发方式 */
    /**
     * @param {?} value
     * @return {?}
     */
    set trigger(value) {
        if (value) {
            if (value !== this.triggerMode) {
                this.triggerMode = value;
                this.unbindEvent();
                this.bindEvent();
            }
        }
    }
    /**
     * @return {?}
     */
    get trigger() {
        return this.triggerMode;
    }
    /* 禁用---跟其他控件的属性容易冲突，逐渐废弃。
         * 比如按钮可以设置禁用不触发点击，但想给出点击提示，这样就冲突了
         */
    /**
     * @param {?} value
     * @return {?}
     */
    set disable(value) {
        this.enableOrDisable(!value);
    }
    /**
     * @return {?}
     */
    get disable() {
        return !this.tooltipEnable;
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        this.bindEvent();
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() { }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.unbindEvent();
        this.removeTooltip();
        this.overLayService.destory(this.el.nativeElement);
        this.overLayService = null;
    }
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    enableOrDisable(value) {
        this.tooltipEnable = value;
        if (this.tooltipEnable) {
            this.bindEvent();
        }
        else {
            this.unbindEvent();
        }
    }
    /**
     * @return {?}
     */
    bindEvent() {
        if (!this.tooltipEnable) {
            return;
        }
        // 是否已绑定事件
        if (this.hasBindEvent) {
            return;
        }
        if (this.trigger === "click") {
            // 鼠标点击
            this.clickEvent = this.render.listen(this.el.nativeElement, "click", (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                this.appendTooltip();
                this.clickOutEvent = this.render.listen(document, "click", (/**
                 * @return {?}
                 */
                () => {
                    this.removeTooltip();
                    this.clickOutEvent();
                }));
            }));
        }
        else if (this.trigger === "focus") {
            // 聚焦
            // @Todo 需要把input等组件和普通组件分开
            this.focusDownEvent = this.render.listen(this.el.nativeElement, "mousedown", (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.preventDefault();
                this.appendTooltip();
            }));
            this.focusUpEvent = this.render.listen(this.el.nativeElement, "mouseup", (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                this.removeTooltip();
            }));
        }
        else {
            // 鼠标移动上去
            this.mouseenterEvent = this.render.listen(this.el.nativeElement, "mouseenter", (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                if (this.delay) {
                    if (this.delayTimer) {
                        clearTimeout(this.delayTimer);
                    }
                    this.delayTimer = setTimeout((/**
                     * @return {?}
                     */
                    () => {
                        this.appendTooltip();
                        clearTimeout(this.delayTimer);
                    }), this.delay);
                }
                else {
                    this.appendTooltip();
                }
            }));
            this.mouseleaveEvent = this.render.listen(this.el.nativeElement, "mouseleave", (/**
             * @param {?} e
             * @return {?}
             */
            (e) => {
                e.stopPropagation();
                if (this.delayTimer) {
                    clearTimeout(this.delayTimer);
                }
                this.removeTooltip();
            }));
        }
        this.hasBindEvent = true;
    }
    /* 解绑事件 */
    /**
     * @return {?}
     */
    unbindEvent() {
        // 鼠标移上去
        if (this.mouseenterEvent) {
            this.mouseenterEvent();
        }
        if (this.mouseleaveEvent) {
            this.mouseleaveEvent();
        }
        if (this.clickEvent) {
            this.clickEvent();
        }
        if (this.clickOutEvent) {
            this.clickOutEvent();
        }
        if (this.focusDownEvent) {
            this.focusDownEvent();
        }
        if (this.focusUpEvent) {
            this.focusUpEvent();
        }
        this.hasBindEvent = false;
    }
    /* body  移除tooltip */
    /**
     * @return {?}
     */
    removeTooltip() {
        if (this.tooltip) {
            this.render.removeChild(document.body, this.tooltip.el.nativeElement);
            this._componentRef.changeDetectorRef.markForCheck();
            this._componentRef.changeDetectorRef.detectChanges();
            this._componentRef.destroy();
            this.viewContainerRef.clear();
            this.tooltip = null;
            this._componentRef = null;
            this.overLayService.destory(this.el.nativeElement);
        }
    }
    /**
     * @private
     * @return {?}
     */
    appendTooltip() {
        if (!this.showTip)
            return;
        this.generateTooltip();
        this.updateViewProps(this.placement, this.content, this.el.nativeElement.getBoundingClientRect(), this.getReferencePosition());
        this.overLayService.registerMouseEvent(this.el.nativeElement, (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            this.removeTooltip();
        }));
    }
    /* 更新tooltip组件属性 */
    /**
     * @private
     * @param {?} placement
     * @param {?} content
     * @param {?} hostBoundingClientRect
     * @param {?} referenceBoundingRect
     * @return {?}
     */
    updateViewProps(placement, content, hostBoundingClientRect, referenceBoundingRect) {
        this.tooltip.placement = placement;
        this.tooltip.content = content;
        this.tooltip.hostBoundingClientRect = hostBoundingClientRect;
        this.tooltip.tipCls = this.tipCls;
        this.tooltip.tipWidth = this.tipWidth;
        this.tooltip.referenceBoundingRect = referenceBoundingRect;
        this._componentRef.changeDetectorRef.markForCheck();
        this._componentRef.changeDetectorRef.detectChanges();
    }
    /* 构造tooltip结构 */
    /**
     * @private
     * @return {?}
     */
    generateTooltip() {
        this._componentRef = this.viewContainerRef.createComponent(this.componentFactory);
        this.tooltip = this._componentRef.instance;
        // 父元素中移除  添加到body中
        this.render.removeChild(this.render.parentNode(this.el.nativeElement), this.tooltip.el.nativeElement);
        this.render.appendChild(document.body, this.tooltip.el.nativeElement);
    }
    /**
     * 确认参照的边界
     * @private
     * @return {?}
     */
    getReferencePosition() {
        /** @type {?} */
        let rRight = document.documentElement.clientWidth;
        /** @type {?} */
        let rBottom = document.documentElement.clientHeight;
        /** @type {?} */
        let rTop = 0;
        /** @type {?} */
        let rLeft = 0;
        // 横向参照
        if (this.rectifyReferenceH) {
            /** @type {?} */
            let rectifyReferenceHEl = this.getRectifyReferenceElement(this.rectifyReferenceH);
            rRight = rectifyReferenceHEl.getBoundingClientRect().right;
            rLeft = rectifyReferenceHEl.getBoundingClientRect().left;
        }
        // 纵向参照
        if (this.rectifyReferenceV) {
            /** @type {?} */
            let rectifyReferenceVEl = this.getRectifyReferenceElement(this.rectifyReferenceV);
            rBottom = rectifyReferenceVEl.getBoundingClientRect().bottom;
            rTop = rectifyReferenceVEl.getBoundingClientRect().top;
        }
        return { top: rTop, left: rLeft, right: rRight, bottom: rBottom };
    }
    /**
     * 获取纠正元素
     * @private
     * @param {?} referenceEl
     * @return {?}
     */
    getRectifyReferenceElement(referenceEl) {
        if (referenceEl instanceof ElementRef) {
            return referenceEl.nativeElement;
        }
        else if (typeof referenceEl == "string") {
            return document.querySelector((/** @type {?} */ (referenceEl)));
        }
        return referenceEl;
    }
}
FarrisTooltipDirective.decorators = [
    { type: Directive, args: [{
                selector: "[farrisTooltip]",
            },] }
];
/** @nocollapse */
FarrisTooltipDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: ViewContainerRef },
    { type: ComponentFactoryResolver }
];
FarrisTooltipDirective.propDecorators = {
    enableTooltip: [{ type: Input, args: ["farrisTooltip",] }],
    text: [{ type: Input }],
    tipCls: [{ type: Input }],
    tipWidth: [{ type: Input }],
    placement: [{ type: Input }],
    trigger: [{ type: Input }],
    disable: [{ type: Input }],
    showTip: [{ type: Input }],
    rectifyReferenceH: [{ type: Input }],
    rectifyReferenceV: [{ type: Input }],
    delay: [{ type: Input }],
    content: [{ type: Input }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.tooltipEnable;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype._componentRef;
    /** @type {?} */
    FarrisTooltipDirective.prototype.text;
    /** @type {?} */
    FarrisTooltipDirective.prototype.tipCls;
    /** @type {?} */
    FarrisTooltipDirective.prototype.tipWidth;
    /** @type {?} */
    FarrisTooltipDirective.prototype.placement;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.triggerMode;
    /** @type {?} */
    FarrisTooltipDirective.prototype.showTip;
    /** @type {?} */
    FarrisTooltipDirective.prototype.rectifyReferenceH;
    /** @type {?} */
    FarrisTooltipDirective.prototype.rectifyReferenceV;
    /** @type {?} */
    FarrisTooltipDirective.prototype.delay;
    /** @type {?} */
    FarrisTooltipDirective.prototype.content;
    /** @type {?} */
    FarrisTooltipDirective.prototype.mouseenterEvent;
    /** @type {?} */
    FarrisTooltipDirective.prototype.mouseleaveEvent;
    /** @type {?} */
    FarrisTooltipDirective.prototype.clickEvent;
    /** @type {?} */
    FarrisTooltipDirective.prototype.clickOutEvent;
    /** @type {?} */
    FarrisTooltipDirective.prototype.focusDownEvent;
    /** @type {?} */
    FarrisTooltipDirective.prototype.focusUpEvent;
    /** @type {?} */
    FarrisTooltipDirective.prototype.docBody;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.hasBindEvent;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.delayTimer;
    /** @type {?} */
    FarrisTooltipDirective.prototype.componentFactory;
    /** @type {?} */
    FarrisTooltipDirective.prototype.tooltipRef;
    /** @type {?} */
    FarrisTooltipDirective.prototype.tooltip;
    /** @type {?} */
    FarrisTooltipDirective.prototype.overLayService;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.viewContainerRef;
    /**
     * @type {?}
     * @private
     */
    FarrisTooltipDirective.prototype.resolver;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbHRpcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLXRvb2x0aXAvIiwic291cmNlcyI6WyJsaWIvdG9vbHRpcC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFFSCxTQUFTLEVBQ1QsS0FBSyxFQUNMLFVBQVUsRUFFVixTQUFTLEVBSVQsZ0JBQWdCLEVBQ2hCLHdCQUF3QixHQUczQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUl6RSxNQUFNLE9BQU8sc0JBQXNCOzs7Ozs7O0lBb0YvQixZQUNZLEVBQWMsRUFDZCxNQUFpQixFQUNqQixnQkFBa0MsRUFDbEMsUUFBa0M7UUFIbEMsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDakIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxhQUFRLEdBQVIsUUFBUSxDQUEwQjtRQXJGdEMsa0JBQWEsR0FBWSxJQUFJLENBQUM7O1FBZ0I3QixTQUFJLEdBQUcsRUFBRSxDQUFDOztRQUVWLFdBQU0sR0FBRyxFQUFFLENBQUM7O1FBRVosYUFBUSxHQUFHLEVBQUUsQ0FBQzs7UUFFZCxjQUFTLEdBQUcsS0FBSyxDQUFDO1FBRW5CLGdCQUFXLEdBQUcsT0FBTyxDQUFDO1FBMkJyQixZQUFPLEdBQVksSUFBSSxDQUFDO1FBTXhCLFVBQUssR0FBRyxDQUFDLENBQUM7O1FBYVgsaUJBQVksR0FBRyxLQUFLLENBQUM7UUFFckIsZUFBVSxHQUFHLElBQUksQ0FBQzs7UUFHMUIscUJBQWdCLEdBQ1osSUFBSSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBV3hELElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxvQkFBb0Is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QUlULGdCQUFnQjtZQUNoQix3QkFBd0I7Ozs0QkFnQnZCLEtBQUssU0FBQyxlQUFlO21CQVlyQixLQUFLO3FCQUVMLEtBQUs7dUJBRUwsS0FBSzt3QkFFTCxLQUFLO3NCQUlMLEtBQUs7c0JBaUJMLEtBQUs7c0JBUUwsS0FBSztnQ0FFTCxLQUFLO2dDQUVMLEtBQUs7b0JBRUwsS0FBSztzQkFHTCxLQUFLOzs7Ozs7O0lBNUROLCtDQUFzQzs7Ozs7SUFDdEMsK0NBQXNEOztJQWV0RCxzQ0FBbUI7O0lBRW5CLHdDQUFxQjs7SUFFckIsMENBQXVCOztJQUV2QiwyQ0FBMkI7Ozs7O0lBRTNCLDZDQUE4Qjs7SUEyQjlCLHlDQUFpQzs7SUFFakMsbURBQTBEOztJQUUxRCxtREFBMEQ7O0lBRTFELHVDQUFtQjs7SUFHbkIseUNBQTRDOztJQUU1QyxpREFBcUI7O0lBQ3JCLGlEQUFxQjs7SUFDckIsNENBQWdCOztJQUNoQiwrQ0FBbUI7O0lBQ25CLGdEQUFvQjs7SUFDcEIsOENBQWtCOztJQUNsQix5Q0FBYTs7Ozs7SUFFYiw4Q0FBNkI7Ozs7O0lBRTdCLDRDQUEwQjs7SUFHMUIsa0RBQzREOztJQUU1RCw0Q0FBZ0I7O0lBQ2hCLHlDQUEwQjs7SUFDMUIsZ0RBQXFDOzs7OztJQUVqQyxvQ0FBc0I7Ozs7O0lBQ3RCLHdDQUF5Qjs7Ozs7SUFDekIsa0RBQTBDOzs7OztJQUMxQywwQ0FBMEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gICAgT25Jbml0LFxyXG4gICAgRGlyZWN0aXZlLFxyXG4gICAgSW5wdXQsXHJcbiAgICBFbGVtZW50UmVmLFxyXG4gICAgQWZ0ZXJWaWV3SW5pdCxcclxuICAgIFJlbmRlcmVyMixcclxuICAgIE9uRGVzdHJveSxcclxuICAgIFRlbXBsYXRlUmVmLFxyXG4gICAgQ29tcG9uZW50RmFjdG9yeSxcclxuICAgIFZpZXdDb250YWluZXJSZWYsXHJcbiAgICBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICBOZ1pvbmUsXHJcbiAgICBDb21wb25lbnRSZWYsXHJcbn0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgT3ZlckxheUhpZGRlblNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1jb21tb25cIjtcclxuaW1wb3J0IHsgVG9vbHRpcENvbXBvbmVudCB9IGZyb20gXCIuL3Rvb2x0aXAtY29tcG9uZW50L3Rvb2x0aXAuY29tcG9uZW50XCI7XHJcbkBEaXJlY3RpdmUoe1xyXG4gICAgc2VsZWN0b3I6IFwiW2ZhcnJpc1Rvb2x0aXBdXCIsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBGYXJyaXNUb29sdGlwRGlyZWN0aXZlXHJcbiAgICBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95XHJcbntcclxuICAgIHByaXZhdGUgdG9vbHRpcEVuYWJsZTogYm9vbGVhbiA9IHRydWU7XHJcbiAgICBwcml2YXRlIF9jb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjxUb29sdGlwQ29tcG9uZW50PjtcclxuICAgIC8vIDXmnIg35pel6L+95Yqg6L+Z56eN5YaZ5rOV77yM5o6n5Yi256aB55So44CB5ZCv55SoXHJcbiAgICAvLyDljp/mnaXnmoTml7blgJl2YWx1ZeaYr+epuuWtl+espuS4slxyXG4gICAgQElucHV0KFwiZmFycmlzVG9vbHRpcFwiKVxyXG4gICAgc2V0IGVuYWJsZVRvb2x0aXAodmFsdWU6IGFueSkge1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT0gXCJzdHJpbmdcIiAmJiB2YWx1ZSA9PSBcIlwiKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlT3JEaXNhYmxlKHRydWUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuZW5hYmxlT3JEaXNhYmxlKHZhbHVlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXQgZW5hYmxlVG9vbHRpcCgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50b29sdGlwRW5hYmxlO1xyXG4gICAgfVxyXG4gICAgLyog5o+Q56S65paH5pysICovXHJcbiAgICBASW5wdXQoKSB0ZXh0ID0gXCJcIjtcclxuICAgIC8vIOaPkOekuuahhuagt+W8j1xyXG4gICAgQElucHV0KCkgdGlwQ2xzID0gXCJcIjtcclxuICAgIC8vIOaPkOekuuahhuWuveW6plxyXG4gICAgQElucHV0KCkgdGlwV2lkdGggPSBcIlwiO1xyXG4gICAgLyog5L2N572uICovXHJcbiAgICBASW5wdXQoKSBwbGFjZW1lbnQgPSBcInRvcFwiO1xyXG5cclxuICAgIHByaXZhdGUgdHJpZ2dlck1vZGUgPSBcImhvdmVyXCI7XHJcbiAgICAvKiDop6blj5HmlrnlvI8gKi9cclxuICAgIEBJbnB1dCgpXHJcbiAgICBzZXQgdHJpZ2dlcih2YWx1ZSkge1xyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMudHJpZ2dlck1vZGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudHJpZ2dlck1vZGUgPSB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMudW5iaW5kRXZlbnQoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuYmluZEV2ZW50KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXQgdHJpZ2dlcigpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy50cmlnZ2VyTW9kZTtcclxuICAgIH1cclxuXHJcbiAgICAvKiDnpoHnlKgtLS3ot5/lhbbku5bmjqfku7bnmoTlsZ7mgKflrrnmmJPlhrLnqoHvvIzpgJDmuJDlup/lvIPjgIJcclxuICAgICAqIOavlOWmguaMiemSruWPr+S7peiuvue9ruemgeeUqOS4jeinpuWPkeeCueWHu++8jOS9huaDs+e7meWHuueCueWHu+aPkOekuu+8jOi/meagt+WwseWGsueqgeS6hlxyXG4gICAgICovXHJcbiAgICBASW5wdXQoKVxyXG4gICAgc2V0IGRpc2FibGUodmFsdWUpIHtcclxuICAgICAgICB0aGlzLmVuYWJsZU9yRGlzYWJsZSghdmFsdWUpO1xyXG4gICAgfVxyXG4gICAgZ2V0IGRpc2FibGUoKSB7XHJcbiAgICAgICAgcmV0dXJuICF0aGlzLnRvb2x0aXBFbmFibGU7XHJcbiAgICB9XHJcblxyXG4gICAgQElucHV0KCkgc2hvd1RpcDogYm9vbGVhbiA9IHRydWU7XHJcbiAgICAvLyDmqKrlkJHnuqDmraPnmoTlj4LnhadcclxuICAgIEBJbnB1dCgpIHJlY3RpZnlSZWZlcmVuY2VIOiBFbGVtZW50IHwgRWxlbWVudFJlZiB8IHN0cmluZztcclxuICAgIC8vIOe6teWQkee6oOato+eahOWPgueFp1xyXG4gICAgQElucHV0KCkgcmVjdGlmeVJlZmVyZW5jZVY6IEVsZW1lbnQgfCBFbGVtZW50UmVmIHwgc3RyaW5nO1xyXG5cclxuICAgIEBJbnB1dCgpIGRlbGF5ID0gMDtcclxuXHJcbiAgICAvKiDlhoXlrrnmqKHmnb8gKi9cclxuICAgIEBJbnB1dCgpIGNvbnRlbnQ6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT47XHJcblxyXG4gICAgbW91c2VlbnRlckV2ZW50OiBhbnk7XHJcbiAgICBtb3VzZWxlYXZlRXZlbnQ6IGFueTtcclxuICAgIGNsaWNrRXZlbnQ6IGFueTtcclxuICAgIGNsaWNrT3V0RXZlbnQ6IGFueTtcclxuICAgIGZvY3VzRG93bkV2ZW50OiBhbnk7XHJcbiAgICBmb2N1c1VwRXZlbnQ6IGFueTtcclxuICAgIGRvY0JvZHk6IGFueTtcclxuICAgIC8vIOaYr+WQpue7keWumuS6huS6i+S7tlxyXG4gICAgcHJpdmF0ZSBoYXNCaW5kRXZlbnQgPSBmYWxzZTtcclxuXHJcbiAgICBwcml2YXRlIGRlbGF5VGltZXIgPSBudWxsO1xyXG5cclxuICAgIC8qIOeUn+aIkOaPkOekuue7hOS7tiAqL1xyXG4gICAgY29tcG9uZW50RmFjdG9yeTogQ29tcG9uZW50RmFjdG9yeTxUb29sdGlwQ29tcG9uZW50PiA9XHJcbiAgICAgICAgdGhpcy5yZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShUb29sdGlwQ29tcG9uZW50KTtcclxuXHJcbiAgICB0b29sdGlwUmVmOiBhbnk7XHJcbiAgICB0b29sdGlwOiBUb29sdGlwQ29tcG9uZW50O1xyXG4gICAgb3ZlckxheVNlcnZpY2U6IE92ZXJMYXlIaWRkZW5TZXJ2aWNlO1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBlbDogRWxlbWVudFJlZixcclxuICAgICAgICBwcml2YXRlIHJlbmRlcjogUmVuZGVyZXIyLFxyXG4gICAgICAgIHByaXZhdGUgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcclxuICAgICAgICBwcml2YXRlIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXJcclxuICAgICkge1xyXG4gICAgICAgIHRoaXMub3ZlckxheVNlcnZpY2UgPSBuZXcgT3ZlckxheUhpZGRlblNlcnZpY2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpIHtcclxuICAgICAgICB0aGlzLmJpbmRFdmVudCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHt9XHJcblxyXG4gICAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICAgICAgdGhpcy51bmJpbmRFdmVudCgpO1xyXG4gICAgICAgIHRoaXMucmVtb3ZlVG9vbHRpcCgpO1xyXG5cclxuICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlLmRlc3RvcnkodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlID0gbnVsbDtcclxuICAgIH1cclxuICAgIHByaXZhdGUgZW5hYmxlT3JEaXNhYmxlKHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy50b29sdGlwRW5hYmxlID0gdmFsdWU7XHJcbiAgICAgICAgaWYgKHRoaXMudG9vbHRpcEVuYWJsZSkge1xyXG4gICAgICAgICAgICB0aGlzLmJpbmRFdmVudCgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudW5iaW5kRXZlbnQoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgYmluZEV2ZW50KCkge1xyXG4gICAgICAgIGlmICghdGhpcy50b29sdGlwRW5hYmxlKSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgLy8g5piv5ZCm5bey57uR5a6a5LqL5Lu2XHJcbiAgICAgICAgaWYgKHRoaXMuaGFzQmluZEV2ZW50KSB7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMudHJpZ2dlciA9PT0gXCJjbGlja1wiKSB7XHJcbiAgICAgICAgICAgIC8vIOm8oOagh+eCueWHu1xyXG4gICAgICAgICAgICB0aGlzLmNsaWNrRXZlbnQgPSB0aGlzLnJlbmRlci5saXN0ZW4oXHJcbiAgICAgICAgICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsXHJcbiAgICAgICAgICAgICAgICBcImNsaWNrXCIsXHJcbiAgICAgICAgICAgICAgICAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRUb29sdGlwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGlja091dEV2ZW50ID0gdGhpcy5yZW5kZXIubGlzdGVuKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJjbGlja1wiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZVRvb2x0aXAoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xpY2tPdXRFdmVudCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHJpZ2dlciA9PT0gXCJmb2N1c1wiKSB7XHJcbiAgICAgICAgICAgIC8vIOiBmueEplxyXG4gICAgICAgICAgICAvLyBAVG9kbyDpnIDopoHmioppbnB1dOetiee7hOS7tuWSjOaZrumAmue7hOS7tuWIhuW8gFxyXG4gICAgICAgICAgICB0aGlzLmZvY3VzRG93bkV2ZW50ID0gdGhpcy5yZW5kZXIubGlzdGVuKFxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LFxyXG4gICAgICAgICAgICAgICAgXCJtb3VzZWRvd25cIixcclxuICAgICAgICAgICAgICAgIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwZW5kVG9vbHRpcCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLmZvY3VzVXBFdmVudCA9IHRoaXMucmVuZGVyLmxpc3RlbihcclxuICAgICAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgICAgIFwibW91c2V1cFwiLFxyXG4gICAgICAgICAgICAgICAgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlVG9vbHRpcCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOm8oOagh+enu+WKqOS4iuWOu1xyXG4gICAgICAgICAgICB0aGlzLm1vdXNlZW50ZXJFdmVudCA9IHRoaXMucmVuZGVyLmxpc3RlbihcclxuICAgICAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgICAgIFwibW91c2VlbnRlclwiLFxyXG4gICAgICAgICAgICAgICAgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlbGF5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlbGF5VGltZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLmRlbGF5VGltZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGVsYXlUaW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRUb29sdGlwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kZWxheVRpbWVyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcy5kZWxheSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHBlbmRUb29sdGlwKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLm1vdXNlbGVhdmVFdmVudCA9IHRoaXMucmVuZGVyLmxpc3RlbihcclxuICAgICAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgICAgIFwibW91c2VsZWF2ZVwiLFxyXG4gICAgICAgICAgICAgICAgKGU6IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlbGF5VGltZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZGVsYXlUaW1lcik7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlVG9vbHRpcCgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmhhc0JpbmRFdmVudCA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgLyog6Kej57uR5LqL5Lu2ICovXHJcbiAgICB1bmJpbmRFdmVudCgpIHtcclxuICAgICAgICAvLyDpvKDmoIfnp7vkuIrljrtcclxuICAgICAgICBpZiAodGhpcy5tb3VzZWVudGVyRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5tb3VzZWVudGVyRXZlbnQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMubW91c2VsZWF2ZUV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMubW91c2VsZWF2ZUV2ZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmNsaWNrRXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGlja0V2ZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmNsaWNrT3V0RXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGlja091dEV2ZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmZvY3VzRG93bkV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9jdXNEb3duRXZlbnQoKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMuZm9jdXNVcEV2ZW50KSB7XHJcbiAgICAgICAgICAgIHRoaXMuZm9jdXNVcEV2ZW50KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuaGFzQmluZEV2ZW50ID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyogYm9keSAg56e76ZmkdG9vbHRpcCAqL1xyXG4gICAgcmVtb3ZlVG9vbHRpcCgpIHtcclxuICAgICAgICBpZiAodGhpcy50b29sdGlwKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnJlbW92ZUNoaWxkKFxyXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keSxcclxuICAgICAgICAgICAgICAgIHRoaXMudG9vbHRpcC5lbC5uYXRpdmVFbGVtZW50XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbXBvbmVudFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcclxuICAgICAgICAgICAgdGhpcy5fY29tcG9uZW50UmVmLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgdGhpcy5fY29tcG9uZW50UmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgdGhpcy52aWV3Q29udGFpbmVyUmVmLmNsZWFyKCk7XHJcbiAgICAgICAgICAgIHRoaXMudG9vbHRpcCA9IG51bGw7XHJcbiAgICAgICAgICAgIHRoaXMuX2NvbXBvbmVudFJlZiA9IG51bGw7XHJcblxyXG4gICAgICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlLmRlc3RvcnkodGhpcy5lbC5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBhcHBlbmRUb29sdGlwKCkge1xyXG4gICAgICAgIGlmICghdGhpcy5zaG93VGlwKSByZXR1cm47XHJcbiAgICAgICAgdGhpcy5nZW5lcmF0ZVRvb2x0aXAoKTtcclxuICAgICAgICB0aGlzLnVwZGF0ZVZpZXdQcm9wcyhcclxuICAgICAgICAgICAgdGhpcy5wbGFjZW1lbnQsXHJcbiAgICAgICAgICAgIHRoaXMuY29udGVudCxcclxuICAgICAgICAgICAgdGhpcy5lbC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLFxyXG4gICAgICAgICAgICB0aGlzLmdldFJlZmVyZW5jZVBvc2l0aW9uKClcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB0aGlzLm92ZXJMYXlTZXJ2aWNlLnJlZ2lzdGVyTW91c2VFdmVudCh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsIChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlVG9vbHRpcCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qIOabtOaWsHRvb2x0aXDnu4Tku7blsZ7mgKcgKi9cclxuICAgIHByaXZhdGUgdXBkYXRlVmlld1Byb3BzKFxyXG4gICAgICAgIHBsYWNlbWVudDogc3RyaW5nLFxyXG4gICAgICAgIGNvbnRlbnQ6IHN0cmluZyB8IFRlbXBsYXRlUmVmPGFueT4sXHJcbiAgICAgICAgaG9zdEJvdW5kaW5nQ2xpZW50UmVjdDogb2JqZWN0LFxyXG4gICAgICAgIHJlZmVyZW5jZUJvdW5kaW5nUmVjdFxyXG4gICAgKSB7XHJcbiAgICAgICAgdGhpcy50b29sdGlwLnBsYWNlbWVudCA9IHBsYWNlbWVudDtcclxuICAgICAgICB0aGlzLnRvb2x0aXAuY29udGVudCA9IGNvbnRlbnQ7XHJcbiAgICAgICAgdGhpcy50b29sdGlwLmhvc3RCb3VuZGluZ0NsaWVudFJlY3QgPSBob3N0Qm91bmRpbmdDbGllbnRSZWN0O1xyXG4gICAgICAgIHRoaXMudG9vbHRpcC50aXBDbHMgPSB0aGlzLnRpcENscztcclxuICAgICAgICB0aGlzLnRvb2x0aXAudGlwV2lkdGggPSB0aGlzLnRpcFdpZHRoO1xyXG4gICAgICAgIHRoaXMudG9vbHRpcC5yZWZlcmVuY2VCb3VuZGluZ1JlY3QgPSByZWZlcmVuY2VCb3VuZGluZ1JlY3Q7XHJcbiAgICAgICAgdGhpcy5fY29tcG9uZW50UmVmLmNoYW5nZURldGVjdG9yUmVmLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgICAgIHRoaXMuX2NvbXBvbmVudFJlZi5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyog5p6E6YCgdG9vbHRpcOe7k+aehCAqL1xyXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZVRvb2x0aXAoKSB7XHJcbiAgICAgICAgdGhpcy5fY29tcG9uZW50UmVmID0gdGhpcy52aWV3Q29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChcclxuICAgICAgICAgICAgdGhpcy5jb21wb25lbnRGYWN0b3J5XHJcbiAgICAgICAgKTtcclxuICAgICAgICB0aGlzLnRvb2x0aXAgPSB0aGlzLl9jb21wb25lbnRSZWYuaW5zdGFuY2U7XHJcbiAgICAgICAgLy8g54i25YWD57Sg5Lit56e76ZmkICDmt7vliqDliLBib2R55LitXHJcbiAgICAgICAgdGhpcy5yZW5kZXIucmVtb3ZlQ2hpbGQoXHJcbiAgICAgICAgICAgIHRoaXMucmVuZGVyLnBhcmVudE5vZGUodGhpcy5lbC5uYXRpdmVFbGVtZW50KSxcclxuICAgICAgICAgICAgdGhpcy50b29sdGlwLmVsLm5hdGl2ZUVsZW1lbnRcclxuICAgICAgICApO1xyXG4gICAgICAgIHRoaXMucmVuZGVyLmFwcGVuZENoaWxkKGRvY3VtZW50LmJvZHksIHRoaXMudG9vbHRpcC5lbC5uYXRpdmVFbGVtZW50KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOehruiupOWPgueFp+eahOi+ueeVjFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGdldFJlZmVyZW5jZVBvc2l0aW9uKCkge1xyXG4gICAgICAgIGxldCByUmlnaHQgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGg7XHJcbiAgICAgICAgbGV0IHJCb3R0b20gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0O1xyXG4gICAgICAgIGxldCByVG9wID0gMDtcclxuICAgICAgICBsZXQgckxlZnQgPSAwO1xyXG4gICAgICAgIC8vIOaoquWQkeWPgueFp1xyXG4gICAgICAgIGlmICh0aGlzLnJlY3RpZnlSZWZlcmVuY2VIKSB7XHJcbiAgICAgICAgICAgIGxldCByZWN0aWZ5UmVmZXJlbmNlSEVsID0gdGhpcy5nZXRSZWN0aWZ5UmVmZXJlbmNlRWxlbWVudChcclxuICAgICAgICAgICAgICAgIHRoaXMucmVjdGlmeVJlZmVyZW5jZUhcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgclJpZ2h0ID0gcmVjdGlmeVJlZmVyZW5jZUhFbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5yaWdodDtcclxuICAgICAgICAgICAgckxlZnQgPSByZWN0aWZ5UmVmZXJlbmNlSEVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIOe6teWQkeWPgueFp1xyXG4gICAgICAgIGlmICh0aGlzLnJlY3RpZnlSZWZlcmVuY2VWKSB7XHJcbiAgICAgICAgICAgIGxldCByZWN0aWZ5UmVmZXJlbmNlVkVsID0gdGhpcy5nZXRSZWN0aWZ5UmVmZXJlbmNlRWxlbWVudChcclxuICAgICAgICAgICAgICAgIHRoaXMucmVjdGlmeVJlZmVyZW5jZVZcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgckJvdHRvbSA9IHJlY3RpZnlSZWZlcmVuY2VWRWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkuYm90dG9tO1xyXG4gICAgICAgICAgICByVG9wID0gcmVjdGlmeVJlZmVyZW5jZVZFbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS50b3A7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB7IHRvcDogclRvcCwgbGVmdDogckxlZnQsIHJpZ2h0OiByUmlnaHQsIGJvdHRvbTogckJvdHRvbSB9O1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDojrflj5bnuqDmraPlhYPntKBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBnZXRSZWN0aWZ5UmVmZXJlbmNlRWxlbWVudChyZWZlcmVuY2VFbCkge1xyXG4gICAgICAgIGlmIChyZWZlcmVuY2VFbCBpbnN0YW5jZW9mIEVsZW1lbnRSZWYpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJlZmVyZW5jZUVsLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVmZXJlbmNlRWwgPT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICByZXR1cm4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihyZWZlcmVuY2VFbCBhcyBzdHJpbmcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVmZXJlbmNlRWw7XHJcbiAgICB9XHJcbn1cclxuIl19