/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { BehaviorSubject } from 'rxjs';
import { map } from 'rxjs/operators';
/**
 * @template T
 */
export class BaseDataFacadeService {
    /**
     * @param {?} _initState
     */
    constructor(_initState) {
        this._initState = _initState;
        this._state = this._initState;
        this.store = new BehaviorSubject(this._state);
        this.state$ = this.store.asObservable();
        this.data$ = this.state$.pipe(map((/**
         * @param {?} state
         * @return {?}
         */
        (state) => state.data)));
    }
    /**
     * @private
     * @param {?} data
     * @return {?}
     */
    initData(data) {
        return data.map((/**
         * @param {?} d
         * @return {?}
         */
        d => {
            /** @type {?} */
            const _id = d[this._state.idField];
            /** @type {?} */
            const disable = (/**
             * @return {?}
             */
            () => {
                return this.disableExpress ? this.disableExpress(d) : false;
            });
            return {
                id: _id,
                data: d,
                disabled: disable(),
            };
        }));
    }
    /**
     * @protected
     * @param {?} state
     * @return {?}
     */
    updateState(state) {
        /** @type {?} */
        const newState = Object.assign({}, this._state, state);
        this.store.next(this._state = newState);
    }
    /**
     * @param {?} state
     * @return {?}
     */
    initState(state) {
        this.updateState(state);
    }
    /**
     * @param {?} id
     * @return {?}
     */
    isSelect(id) {
        if (this._state.selections && this._state.selections.length) {
            return this._state.selections.find((/**
             * @param {?} item
             * @return {?}
             */
            item => !!item ? item[this._state.idField] == id : false)) !== undefined;
        }
        return false;
    }
    /**
     * @param {?} data
     * @param {?=} selectValues
     * @param {?=} separator
     * @return {?}
     */
    loadData(data, selectValues = '', separator = ',') {
        if (data) {
            /** @type {?} */
            const _data = this.initData(data);
            this.updateState(Object.assign({}, this._state, { data: _data }));
            if (selectValues) {
                this.setSelections(selectValues, separator);
            }
            else {
                this._state.selections = [];
            }
        }
        else {
            this.updateState({ data: [], selections: [] });
        }
    }
    /**
     * @return {?}
     */
    getSelections() {
        return this._state.selections;
    }
    /**
     * @param {?} selectValues
     * @param {?=} separator
     * @return {?}
     */
    setSelections(selectValues, separator = ',') {
        if (selectValues) {
            /** @type {?} */
            let selectedItems = [];
            if (this._state.multiSelect) {
                selectedItems = selectValues.split(separator).map((/**
                 * @param {?} val
                 * @return {?}
                 */
                val => {
                    return this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d.data[this._state.valueField] + '' == val));
                })).map((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    return n ? n.data : '';
                })).filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n));
            }
            else {
                selectedItems = [this._state.data.find((/**
                     * @param {?} d
                     * @return {?}
                     */
                    d => d.data[this._state.valueField] + '' == selectValues))];
            }
            this.updateState({ selections: selectedItems });
        }
    }
    /**
     * @return {?}
     */
    selectAll() {
        this.updateState({ selections: this._state.data.map((/**
             * @param {?} n
             * @return {?}
             */
            n => n.data)) });
    }
    /**
     * @return {?}
     */
    unSelectAll() {
        this.clearSelections();
    }
    /**
     * @param {?} data
     * @param {?=} index
     * @return {?}
     */
    selectItem(data, index) {
        /** @type {?} */
        const idfield = this._state.idField;
        /** @type {?} */
        let selections = this.getSelections();
        /** @type {?} */
        const id = data[idfield];
        if (!this._state.multiSelect) {
            if (!this.isSelect(id)) {
                selections = [data];
            }
        }
        else {
            if (!this.isSelect(id)) {
                selections.push(data);
            }
        }
        /** @type {?} */
        const items = this.cloneArray(selections);
        this.updateState({ selections: items });
    }
    /**
     * @param {?} data
     * @return {?}
     */
    unSelectItem(data) {
        /** @type {?} */
        const idfield = this._state.idField;
        /** @type {?} */
        let selections = this.getSelections();
        /** @type {?} */
        const id = data[idfield];
        if (!this._state.multiSelect) {
            selections = [];
        }
        else {
            selections = selections.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => n[idfield] != id));
        }
        /** @type {?} */
        const items = this.cloneArray(selections);
        this.updateState({ selections: items });
    }
    /**
     * @return {?}
     */
    clearSelections() {
        this.updateState({ selections: [] });
    }
    /**
     * @private
     * @param {?} arr
     * @return {?}
     */
    cloneArray(arr) {
        if (arr && arr.length) {
            return arr.map((/**
             * @param {?} n
             * @return {?}
             */
            n => n));
        }
        return arr;
    }
}
if (false) {
    /**
     * @type {?}
     * @protected
     */
    BaseDataFacadeService.prototype._state;
    /** @type {?} */
    BaseDataFacadeService.prototype.disableExpress;
    /** @type {?} */
    BaseDataFacadeService.prototype.store;
    /** @type {?} */
    BaseDataFacadeService.prototype.state$;
    /** @type {?} */
    BaseDataFacadeService.prototype.data$;
    /**
     * @type {?}
     * @private
     */
    BaseDataFacadeService.prototype._initState;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1kYXRhLmZhY2FkZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vIiwic291cmNlcyI6WyJsaWIvc2VydmljZS9iYXNlLWRhdGEuZmFjYWRlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBRXJDLE1BQU0sT0FBTyxxQkFBcUI7Ozs7SUFTOUIsWUFBb0IsVUFBYTtRQUFiLGVBQVUsR0FBVixVQUFVLENBQUc7UUFSdkIsV0FBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUM7UUFHMUIsVUFBSyxHQUFJLElBQUksZUFBZSxDQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3QyxXQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU1QyxVQUFLLEdBQW9CLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUc7Ozs7UUFBQyxDQUFDLEtBQVEsRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksRUFBQyxDQUFDLENBQUM7SUFHekUsQ0FBQzs7Ozs7O0lBRU8sUUFBUSxDQUFDLElBQVM7UUFDdEIsT0FBTyxJQUFJLENBQUMsR0FBRzs7OztRQUFDLENBQUMsQ0FBQyxFQUFFOztrQkFDVixHQUFHLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDOztrQkFDNUIsT0FBTzs7O1lBQUcsR0FBRyxFQUFFO2dCQUNqQixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUNoRSxDQUFDLENBQUE7WUFDRCxPQUFPO2dCQUNILEVBQUUsRUFBRSxHQUFHO2dC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LENBQUMsQ0FBQztJQUMxQyxDQUFDOzs7OztJQUVELFlBQVksQ0FBQyxJQUFTOztjQUNaLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU87O1lBQy9CLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFOztjQUMvQixFQUFFLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUN4QixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUU7WUFDMUIsVUFBVSxHQUFHLEVBQUUsQ0FBQztTQUNuQjthQUFNO1lBQ0gsVUFBVSxHQUFHLFVBQVUsQ0FBQyxNQUFNOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxFQUFDLENBQUU7U0FDMUQ7O2NBRUssS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBQyxVQUFVLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztJQUMxQyxDQUFDOzs7O0lBRUQsZUFBZTtRQUNYLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBQyxVQUFVLEVBQUUsRUFBRSxFQUFDLENBQUMsQ0FBQztJQUN2QyxDQUFDOzs7Ozs7SUFFTyxVQUFVLENBQUMsR0FBVTtRQUN6QixJQUFJLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFO1lBQ25CLE9BQU8sR0FBRyxDQUFDLEdBQUc7Ozs7WUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBQyxDQUFDO1NBQzNCO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDZixDQUFDO0NBQ0o7Ozs7OztJQWxJRyx1Q0FBbUM7O0lBQ25DLCtDQUFrQzs7SUFFbEMsc0NBQXNEOztJQUN0RCx1Q0FBNEM7O0lBRTVDLHNDQUF5RTs7Ozs7SUFFN0QsMkNBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmFycmlzRGF0YVN0YXRlIH0gZnJvbSAnLi9mYXJyaXMtZGF0YWl0ZW0nO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuZXhwb3J0IGNsYXNzIEJhc2VEYXRhRmFjYWRlU2VydmljZTxUIGV4dGVuZHMgRmFycmlzRGF0YVN0YXRlPiB7XHJcbiAgICBwcm90ZWN0ZWQgX3N0YXRlID0gdGhpcy5faW5pdFN0YXRlO1xyXG4gICAgZGlzYWJsZUV4cHJlc3M6IChpdGVtKSA9PiBib29sZWFuO1xyXG5cclxuICAgIHJlYWRvbmx5IHN0b3JlICA9IG5ldyBCZWhhdmlvclN1YmplY3Q8VD4odGhpcy5fc3RhdGUpO1xyXG4gICAgcmVhZG9ubHkgc3RhdGUkID0gdGhpcy5zdG9yZS5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICBkYXRhJDogT2JzZXJ2YWJsZTxhbnk+ID0gdGhpcy5zdGF0ZSQucGlwZShtYXAoKHN0YXRlOiBUKSA9PiBzdGF0ZS5kYXRhKSk7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfaW5pdFN0YXRlOiBUKSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpbml0RGF0YShkYXRhOiBhbnkpIHtcclxuICAgICAgICByZXR1cm4gZGF0YS5tYXAoZCA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IF9pZCA9IGRbdGhpcy5fc3RhdGUuaWRGaWVsZF07XHJcbiAgICAgICAgICAgIGNvbnN0IGRpc2FibGUgPSAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kaXNhYmxlRXhwcmVzcyA/IHRoaXMuZGlzYWJsZUV4cHJlc3MoZCkgOiBmYWxzZTtcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgIGlkOiBfaWQsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiBkLFxyXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6IGRpc2FibGUoKSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgdXBkYXRlU3RhdGUoc3RhdGU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IG5ld1N0YXRlID0gey4uLnRoaXMuX3N0YXRlLCAuLi5zdGF0ZX07XHJcbiAgICAgICAgdGhpcy5zdG9yZS5uZXh0KHRoaXMuX3N0YXRlID0gbmV3U3RhdGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRTdGF0ZShzdGF0ZTogYW55KSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZShzdGF0ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaXNTZWxlY3QoaWQ6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zICYmIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zdGF0ZS5zZWxlY3Rpb25zLmZpbmQoaXRlbSA9PiAhIWl0ZW0gPyBpdGVtW3RoaXMuX3N0YXRlLmlkRmllbGRdID09IGlkIDogZmFsc2UpICE9PSB1bmRlZmluZWQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgbG9hZERhdGEoZGF0YTogYW55LCBzZWxlY3RWYWx1ZXM6IHN0cmluZyA9ICcnLCBzZXBhcmF0b3IgPSAnLCcpIHtcclxuICAgICAgICBpZiAoZGF0YSkge1xyXG4gICAgICAgICAgICBjb25zdCBfZGF0YSA9IHRoaXMuaW5pdERhdGEoZGF0YSk7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoey4uLnRoaXMuX3N0YXRlLCBkYXRhOiBfZGF0YX0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKHNlbGVjdFZhbHVlcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXRTZWxlY3Rpb25zKHNlbGVjdFZhbHVlcywgc2VwYXJhdG9yKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnMgPSBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoeyBkYXRhOiBbXSwgc2VsZWN0aW9uczogW10gfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldFNlbGVjdGlvbnMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLnNlbGVjdGlvbnM7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0U2VsZWN0aW9ucyhzZWxlY3RWYWx1ZXM6IHN0cmluZywgc2VwYXJhdG9yID0gJywnKSB7XHJcbiAgICAgICAgaWYgKHNlbGVjdFZhbHVlcykge1xyXG4gICAgICAgICAgICBsZXQgc2VsZWN0ZWRJdGVtcyA9IFtdO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fc3RhdGUubXVsdGlTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbXMgPSBzZWxlY3RWYWx1ZXMuc3BsaXQoc2VwYXJhdG9yKS5tYXAoIHZhbCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3N0YXRlLmRhdGEuZmluZChkID0+IGQuZGF0YVt0aGlzLl9zdGF0ZS52YWx1ZUZpZWxkXSArICcnID09IHZhbCk7XHJcbiAgICAgICAgICAgICAgICB9KS5tYXAoIG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuID8gbi5kYXRhIDogJyc7XHJcbiAgICAgICAgICAgICAgICB9KS5maWx0ZXIobiA9PiBuKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbXMgPSBbdGhpcy5fc3RhdGUuZGF0YS5maW5kKGQgPT4gZC5kYXRhW3RoaXMuX3N0YXRlLnZhbHVlRmllbGRdICsgJycgPT0gc2VsZWN0VmFsdWVzKV07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7c2VsZWN0aW9uczogc2VsZWN0ZWRJdGVtcyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0QWxsKCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IHRoaXMuX3N0YXRlLmRhdGEubWFwKG4gPT4gbi5kYXRhKSB9KTtcclxuICAgIH1cclxuXHJcbiAgICB1blNlbGVjdEFsbCgpIHtcclxuICAgICAgICB0aGlzLmNsZWFyU2VsZWN0aW9ucygpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdEl0ZW0oZGF0YTogYW55LCBpbmRleD86IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IGlkZmllbGQgPSB0aGlzLl9zdGF0ZS5pZEZpZWxkO1xyXG4gICAgICAgIGxldCBzZWxlY3Rpb25zID0gdGhpcy5nZXRTZWxlY3Rpb25zKCk7XHJcblxyXG4gICAgICAgIGNvbnN0IGlkID0gZGF0YVtpZGZpZWxkXTtcclxuICAgICAgICBpZiAoIXRoaXMuX3N0YXRlLm11bHRpU2VsZWN0KSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1NlbGVjdChpZCkpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbnMgPSBbIGRhdGEgXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICghdGhpcy5pc1NlbGVjdChpZCkpIHtcclxuICAgICAgICAgICAgICAgIHNlbGVjdGlvbnMucHVzaChkYXRhKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaXRlbXMgPSB0aGlzLmNsb25lQXJyYXkoc2VsZWN0aW9ucyk7XHJcblxyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IGl0ZW1zfSk7XHJcbiAgICB9XHJcblxyXG4gICAgdW5TZWxlY3RJdGVtKGRhdGE6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IGlkZmllbGQgPSB0aGlzLl9zdGF0ZS5pZEZpZWxkO1xyXG4gICAgICAgIGxldCBzZWxlY3Rpb25zID0gdGhpcy5nZXRTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgY29uc3QgaWQgPSBkYXRhW2lkZmllbGRdO1xyXG4gICAgICAgIGlmICghdGhpcy5fc3RhdGUubXVsdGlTZWxlY3QpIHtcclxuICAgICAgICAgICAgc2VsZWN0aW9ucyA9IFtdO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHNlbGVjdGlvbnMgPSBzZWxlY3Rpb25zLmZpbHRlcihuID0+IG5baWRmaWVsZF0gIT0gaWQpIDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGl0ZW1zID0gdGhpcy5jbG9uZUFycmF5KHNlbGVjdGlvbnMpO1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IGl0ZW1zfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJTZWxlY3Rpb25zKCkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe3NlbGVjdGlvbnM6IFtdfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbG9uZUFycmF5KGFycjogYW55W10pIHtcclxuICAgICAgICBpZiAoYXJyICYmIGFyci5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGFyci5tYXAoIG4gPT4gbik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gYXJyO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==