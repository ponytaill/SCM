import { Directive, Input, Injector, Optional } from '@angular/core';
import { FrameContext, ChangeType } from '@farris/devkit';
import { FFilePreviewComponent, UploadAndPreviewComponent } from '@farris/extend-file-upload';
/**
 * 树表格绑定指令
 */
var FarrisFilePreviewBindingDirective = /** @class */ (function () {
    /**
     * 构造函数
     */
    function FarrisFilePreviewBindingDirective(previewComponent, frameContext, uploadAndPreviewComponent, injector) {
        this.previewComponent = previewComponent;
        this.frameContext = frameContext;
        this.uploadAndPreviewComponent = uploadAndPreviewComponent;
        this.injector = injector;
    }
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "bindingData", {
        /**
         * 绑定数据
         */
        get: function () {
            return this.frameContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "bindingList", {
        /**
         * 绑定数据列表
         */
        get: function () {
            return this.bindingData.getList();
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 指令初始化
     */
    FarrisFilePreviewBindingDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.bindData();
        this.uploadAndPreviewComponent.orderField = 'fileSortOrder';
        this.bindingData.changes.subscribe(function (change) {
            if (change.type === ChangeType.Load
                || change.type === ChangeType.Append
                || change.type === ChangeType.Remove) {
                _this.bindData();
            }
        });
    };
    /**
     * 指令输入变更
     */
    FarrisFilePreviewBindingDirective.prototype.ngOnChanges = function (changes) {
    };
    /**
     * 绑定数据
     */
    FarrisFilePreviewBindingDirective.prototype.bindData = function () {
        var fileInfos = this.getFileInfos();
        if (this.componentRef) {
            this.componentRef.fileInfos = fileInfos;
        }
    };
    /**
     * 获取附件信息列表
     */
    FarrisFilePreviewBindingDirective.prototype.getFileInfos = function () {
        var _this = this;
        var listData = this.bindingList.toJSON();
        var idKey = this.bindingList.primaryKey;
        var fileInfos = [];
        listData.forEach(function (itemData) {
            var id = _this.getValueByPath(itemData, idKey);
            var fileId = _this.getValueByPath(itemData, _this.fileIdKey);
            var fileName = _this.getValueByPath(itemData, _this.fileNameKey);
            var fileSize = _this.getValueByPath(itemData, _this.fileSizeKey);
            var fileCreateTime = _this.getValueByPath(itemData, _this.fileCreateTimeKey);
            var fileInfo = {
                id: fileId,
                name: fileName,
                size: fileSize,
                createTime: fileCreateTime,
                originalData: itemData,
                extend: {
                    metadataId: fileId
                }
            };
            if (_this.extendFileInfo && Array.isArray(_this.extendFileInfo) && _this.extendFileInfo.length > 0) {
                _this.extendFileInfo.forEach(function (item) {
                    fileInfo[item.key] = _this.getValueByPath(itemData, item.path);
                });
            }
            if (_this.fileSortOrderKey) {
                var fileSortOrder = _this.getValueByPath(itemData, _this.fileSortOrderKey);
                fileInfo.fileSortOrder = fileSortOrder;
            }
            fileInfos.push(fileInfo);
        });
        return fileInfos;
    };
    /**
     * 根据字段路径获取值
     */
    FarrisFilePreviewBindingDirective.prototype.getValueByPath = function (data, path) {
        var keys = path.split('.');
        var currentValue = data;
        keys.forEach(function (key) {
            currentValue = currentValue && currentValue[key];
        });
        return currentValue;
    };
    FarrisFilePreviewBindingDirective.prototype.getUdtPaths = function () {
        var paths = this.fileIdKey.split('.');
        paths.pop();
        return paths;
    };
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "fileSizeKey", {
        get: function () {
            var basePaths = this.getUdtPaths();
            return basePaths.concat(['fileSize']).join('.');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "fileCreateTimeKey", {
        get: function () {
            var basePaths = this.getUdtPaths();
            return basePaths.concat(['fileCreateTime']).join('.');
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(FarrisFilePreviewBindingDirective.prototype, "componentRef", {
        get: function () {
            return this.previewComponent || this.uploadAndPreviewComponent || null;
        },
        enumerable: true,
        configurable: true
    });
    FarrisFilePreviewBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[farrisFilePreviewBinding]'
                },] }
    ];
    /** @nocollapse */
    FarrisFilePreviewBindingDirective.ctorParameters = function () { return [
        { type: FFilePreviewComponent, decorators: [{ type: Optional }] },
        { type: FrameContext },
        { type: UploadAndPreviewComponent, decorators: [{ type: Optional }] },
        { type: Injector, decorators: [{ type: Optional }] }
    ]; };
    FarrisFilePreviewBindingDirective.propDecorators = {
        extendFileInfo: [{ type: Input, args: ['extendFileInfo',] }],
        fileIdKey: [{ type: Input, args: ['farrisFileIdKey',] }],
        fileSortOrderKey: [{ type: Input, args: ['farrisFileSortOrderKey',] }],
        fileNameKey: [{ type: Input, args: ['farrisFileNameKey',] }]
    };
    return FarrisFilePreviewBindingDirective;
}());
export { FarrisFilePreviewBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWZpbGUtcHJldmlldy1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL2ZpbGUtcHJldmlldy9mYXJyaXMtZmlsZS1wcmV2aWV3LWJpbmRpbmcuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQW9DLEtBQUssRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3ZHLE9BQU8sRUFBNEIsWUFBWSxFQUFVLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVGLE9BQU8sRUFBYyxxQkFBcUIsRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRTFHOztHQUVHO0FBQ0g7SUFxQ0U7O09BRUc7SUFDSCwyQ0FDc0IsZ0JBQXVDLEVBQ25ELFlBQTBCLEVBQ2QseUJBQW9ELEVBQ3BELFFBQWtCO1FBSGxCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBdUI7UUFDbkQsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDZCw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELGFBQVEsR0FBUixRQUFRLENBQVU7SUFFeEMsQ0FBQztJQXBCRCxzQkFBWSwwREFBVztRQUh2Qjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUtELHNCQUFZLDBEQUFXO1FBSHZCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDcEMsQ0FBQzs7O09BQUE7SUFhRDs7T0FFRztJQUNILG9EQUFRLEdBQVI7UUFBQSxpQkFXQztRQVZDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQixJQUFJLENBQUMseUJBQXlCLENBQUMsVUFBVSxHQUFH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QVBvQixxQkFBcUIsdUJBOENyQyxRQUFRO2dCQS9Dc0IsWUFBWTtnQkFDSCx5QkFBeUIsdUJBZ0RoRSxRQUFRO2dCQWxEZ0QsUUFBUSx1QkFtRGhFLFFBQVE7OztpQ0F2Q1YsS0FBSyxTQUFDLGdCQUFnQjs0QkFLdEIsS0FBSyxTQUFDLGlCQUFpQjttQ0FLdkIsS0FBSyxTQUFDLHdCQUF3Qjs4QkFLOUIsS0FBSyxTQUFDLG1CQUFtQjs7SUFnSTVCLHdDQUFDO0NBQUEsQUFwSkQsSUFvSkM7QUFFRCxPQUFPLEVBQUUsaUNBQWlDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgT25Jbml0LCBPbkNoYW5nZXMsIFNpbXBsZUNoYW5nZXMsIElucHV0LCBJbmplY3RvciwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBGcmFtZUNvbnRleHQsIENoYW5nZSwgQ2hhbmdlVHlwZSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcclxuaW1wb3J0IHsgVXBsb2FkRmlsZSwgRkZpbGVQcmV2aWV3Q29tcG9uZW50LCBVcGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy9leHRlbmQtZmlsZS11cGxvYWQnO1xyXG5cclxuLyoqXHJcbiAqIOagkeihqOagvOe7keWumuaMh+S7pFxyXG4gKi9cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbZmFycmlzRmlsZVByZXZpZXdCaW5kaW5nXSdcclxufSlcclxuY2xhc3MgRmFycmlzRmlsZVByZXZpZXdCaW5kaW5nRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xyXG5cclxuICBASW5wdXQoJ2V4dGVuZEZpbGVJbmZvJylcclxuICBwdWJsaWMgZXh0ZW5kRmlsZUluZm86IHsga2V5OiBzdHJpbmcsIHBhdGg6IGFueSB9W107XHJcbiAgLyoqXHJcbiAgICog5paH5Lu2aWTlrZfmrrXot6/lvoRcclxuICAgKi9cclxuICBASW5wdXQoJ2ZhcnJpc0ZpbGVJZEtleScpXHJcbiAgcHVibGljIGZpbGVJZEtleTogc3RyaW5nO1xyXG4gIC8qKlxyXG4gICAqIOaOkuW6j+Wtl+autVxyXG4gICAqL1xyXG4gIEBJbnB1dCgnZmFycmlzRmlsZVNvcnRPcmRlcktleScpXHJcbiAgcHVibGljIGZpbGVTb3J0T3JkZXJLZXk6IHN0cmluZztcclxuICAvKipcclxuICAgKiDmlofku7ZuYW1l5a2X5q616Lev5b6EXHJcbiAgICovXHJcbiAgQElucHV0KCdmYXJyaXNGaWxlTmFtZUtleScpXHJcbiAgcHVibGljIGZpbGVOYW1lS2V5OiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGJpbmRpbmdEYXRhKCk6IEJpbmRpbmdEYXRhIHtcclxuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNruWIl+ihqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0IGJpbmRpbmdMaXN0KCk6IEJpbmRpbmdMaXN0IHtcclxuICAgIHJldHVybiB0aGlzLmJpbmRpbmdEYXRhLmdldExpc3QoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBwcmV2aWV3Q29tcG9uZW50OiBGRmlsZVByZXZpZXdDb21wb25lbnQsXHJcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSB1cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50OiBVcGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50LFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3JcclxuICApIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaMh+S7pOWIneWni+WMllxyXG4gICAqL1xyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5iaW5kRGF0YSgpO1xyXG4gICAgdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50Lm9yZGVyRmllbGQgPSAnZmlsZVNvcnRPcmRlcic7XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhLmNoYW5nZXMuc3Vic2NyaWJlKChjaGFuZ2U6IENoYW5nZSkgPT4ge1xyXG4gICAgICBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZFxyXG4gICAgICAgIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkFwcGVuZFxyXG4gICAgICAgIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZVxyXG4gICAgICApIHtcclxuICAgICAgICB0aGlzLmJpbmREYXRhKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5oyH5Luk6L6T5YWl5Y+Y5pu0XHJcbiAgICovXHJcbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumuaVsOaNrlxyXG4gICAqL1xyXG4gIHByaXZhdGUgYmluZERhdGEoKSB7XHJcbiAgICBjb25zdCBmaWxlSW5mb3MgPSB0aGlzLmdldEZpbGVJbmZvcygpO1xyXG4gICAgaWYgKHRoaXMuY29tcG9uZW50UmVmKSB7XHJcbiAgICAgIHRoaXMuY29tcG9uZW50UmVmLmZpbGVJbmZvcyA9IGZpbGVJbmZvcztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlumZhOS7tuS/oeaBr+WIl+ihqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RmlsZUluZm9zKCk6IFVwbG9hZEZpbGVbXSB7XHJcbiAgICBjb25zdCBsaXN0RGF0YSA9IHRoaXMuYmluZGluZ0xpc3QudG9KU09OKCk7XHJcbiAgICBjb25zdCBpZEtleSA9IHRoaXMuYmluZGluZ0xpc3QucHJpbWFyeUtleTtcclxuICAgIGNvbnN0IGZpbGVJbmZvczogVXBsb2FkRmlsZVtdID0gW107XHJcblxyXG4gICAgbGlzdERhdGEuZm9yRWFjaCgoaXRlbURhdGE6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCBpZCA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIGlkS2V5KTtcclxuICAgICAgY29uc3QgZmlsZUlkID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgdGhpcy5maWxlSWRLZXkpO1xyXG4gICAgICBjb25zdCBmaWxlTmFtZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZU5hbWVLZXkpO1xyXG4gICAgICBjb25zdCBmaWxlU2l6ZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZVNpemVLZXkpO1xyXG4gICAgICBjb25zdCBmaWxlQ3JlYXRlVGltZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZUNyZWF0ZVRpbWVLZXkpO1xyXG5cclxuICAgICAgY29uc3QgZmlsZUluZm86IGFueSA9IHtcclxuICAgICAgICBpZDogZmlsZUlkLFxyXG4gICAgICAgIG5hbWU6IGZpbGVOYW1lLFxyXG4gICAgICAgIHNpemU6IGZpbGVTaXplLFxyXG4gICAgICAgIGNyZWF0ZVRpbWU6IGZpbGVDcmVhdGVUaW1lLFxyXG4gICAgICAgIG9yaWdpbmFsRGF0YTogaXRlbURhdGEsXHJcbiAgICAgICAgZXh0ZW5kOiB7XHJcbiAgICAgICAgICBtZXRhZGF0YUlkOiBmaWxlSWRcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICAgIGlmICh0aGlzLmV4dGVuZEZpbGVJbmZvICYmIEFycmF5LmlzQXJyYXkodGhpcy5leHRlbmRGaWxlSW5mbykgJiYgdGhpcy5leHRlbmRGaWxlSW5mby5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5leHRlbmRGaWxlSW5mby5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgZmlsZUluZm9baXRlbS5rZXldID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChpdGVtRGF0YSwgaXRlbS5wYXRoKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5maWxlU29ydE9yZGVyS2V5KSB7XHJcbiAgICAgICAgY29uc3QgZmlsZVNvcnRPcmRlciA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbURhdGEsIHRoaXMuZmlsZVNvcnRPcmRlcktleSk7XHJcbiAgICAgICAgZmlsZUluZm8uZmlsZVNvcnRPcmRlciA9IGZpbGVTb3J0T3JkZXI7XHJcbiAgICAgIH1cclxuICAgICAgZmlsZUluZm9zLnB1c2goZmlsZUluZm8pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGZpbGVJbmZvcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNruWtl+autei3r+W+hOiOt+WPluWAvFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VmFsdWVCeVBhdGgoZGF0YTogYW55LCBwYXRoOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgY29uc3Qga2V5cyA9IHBhdGguc3BsaXQoJy4nKTtcclxuICAgIGxldCBjdXJyZW50VmFsdWUgPSBkYXRhO1xyXG4gICAga2V5cy5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICBjdXJyZW50VmFsdWUgPSBjdXJyZW50VmFsdWUgJiYgY3VycmVudFZhbHVlW2tleV07XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjdXJyZW50VmFsdWU7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0VWR0UGF0aHMoKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgcGF0aHMgPSB0aGlzLmZpbGVJZEtleS5zcGxpdCgnLicpO1xyXG4gICAgcGF0aHMucG9wKCk7XHJcbiAgICByZXR1cm4gcGF0aHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGZpbGVTaXplS2V5KCkge1xyXG4gICAgY29uc3QgYmFzZVBhdGhzID0gdGhpcy5nZXRVZHRQYXRocygpO1xyXG4gICAgcmV0dXJuIGJhc2VQYXRocy5jb25jYXQoWydmaWxlU2l6ZSddKS5qb2luKCcuJyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGZpbGVDcmVhdGVUaW1lS2V5KCkge1xyXG4gICAgY29uc3QgYmFzZVBhdGhzID0gdGhpcy5nZXRVZHRQYXRocygpO1xyXG4gICAgcmV0dXJuIGJhc2VQYXRocy5jb25jYXQoWydmaWxlQ3JlYXRlVGltZSddKS5qb2luKCcuJyk7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0IGNvbXBvbmVudFJlZigpIHtcclxuICAgIHJldHVybiB0aGlzLnByZXZpZXdDb21wb25lbnQgfHwgdGhpcy51cGxvYWRBbmRQcmV2aWV3Q29tcG9uZW50IHx8IG51bGw7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBGYXJyaXNGaWxlUHJldmlld0JpbmRpbmdEaXJlY3RpdmUgfTtcclxuIl19