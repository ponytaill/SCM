import { Injectable } from "@angular/core";
import { Service } from "./service";
import { DatagridComponent } from '@farris/ui-datagrid';
export class DataGridService extends Service {
    /**
     * 清空所有勾选行
     * @description 取消勾选当前表单所有勾选行
     */
    clearChecks() {
        // const params = this.eventParam;
        // if (params && Array.isArray(params)) {
        // const param = params[0];
        // if (param instanceof QueryCondition) {
        const gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach((gridComponent) => {
                let clearSelections = true;
                if (gridComponent.hasOwnProperty('clearSelectionsWhenDataIsEmpty')) {
                    clearSelections = gridComponent['clearSelectionsWhenDataIsEmpty'];
                }
                if (clearSelections) {
                    gridComponent.clearCheckeds(true);
                }
            });
        }
        // }
        // }
    }
    /**
     * 取消勾选删除的行
     * @param ids ids
     * @returns
     * @description 取消勾选当前绑定路径下指定数据，清空下级表格中所有勾选行，仅供删除场景使用
     */
    uncheckDeletedRows(ids) {
        if (typeof ids === 'string') {
            if (ids.indexOf(',') !== -1) {
                ids = ids.split(',').filter(p => p);
            }
            else {
                ids = [ids];
            }
        }
        if (!ids || ids.length < 1) {
            return;
        }
        // 获取bindingPath及ns
        const frameContext = this.context.frameContext;
        if (!frameContext) {
            return;
        }
        const appContext = frameContext.appContext;
        const ns = frameContext.namespace;
        const bindingPath = frameContext.viewModel && frameContext.viewModel.bindingPath;
        if (!appContext) {
            return;
        }
        // 根据bindingPath获取所有可能的frameContext
        const frameContexts = appContext.frameContextManager.getFrameContextsByNamespace(ns);
        const frameContextsInCurrentBindingPath = frameContexts.filter(frameContext => frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath === bindingPath);
        // 获取这些frame中所有的表格组件map
        const gridInCurrentFrame = this.getGridComponentByFrameContexts(frameContextsInCurrentBindingPath);
        if (!gridInCurrentFrame) {
            return;
        }
        // 一个bindingPath下应该只有一个grid
        const grid = gridInCurrentFrame.pop();
        // 清空命令所在的frame下表格的指定勾选
        if (grid) {
            grid.unCheckRows(ids, true);
        }
        // 清空下级表格的所有勾选行数据
        const childrenFrameContexts = frameContexts.filter(frameContext => frameContext.viewModel.bindingPath !== bindingPath && frameContext.viewModel.bindingPath.startsWith(bindingPath));
        const childrenGridComponents = this.getGridComponentByFrameContexts(childrenFrameContexts);
        // 清空命令所在frame
        if (childrenGridComponents && childrenGridComponents.length > 0) {
            childrenGridComponents.forEach((gridComponent) => {
                // 清空所有勾选
                gridComponent.checkedRows = [];
            });
        }
    }
    /**
     * 取消勾选行
     * @param ids ids
     * @returns
     */
    uncheckRows(ids) {
        if (typeof ids === 'string') {
            ids = [ids];
        }
        if (!ids || ids.length < 1) {
            return;
        }
        const gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach((gridComponent) => {
                gridComponent.unCheckRows(ids, true);
            });
        }
    }
    /**
     * 根据命令上下文获取当前命令所在组件的表格实例
     * @param commandContext 命令上下文
     * @returns
     */
    getFormGridComponents(commandContext) {
        let grids = [];
        const frameContext = commandContext && commandContext.frameContext;
        const appContext = frameContext && frameContext.appContext || null;
        if (appContext) {
            const componentRefs = appContext.componentRefs;
            const collect = Array.from(componentRefs.values()); // [Map<string,any>,Map<string,any>]
            collect.forEach((item) => {
                const components = Array.from(item.values());
                const bindingPath = frameContext;
                const gridComponents = components.filter((component) => component instanceof DatagridComponent);
                grids = grids.concat(gridComponents);
            });
        }
        return grids;
    }
    getGridComponentByFrameContexts(frameContexts) {
        return frameContexts.reduce((result, frameContext) => {
            const appContext = frameContext.appContext;
            const frameId = frameContext.frameId;
            // 获取当前组件下所有的组件实例
            const componentsRef = appContext.componentRefs.get(frameId);
            const grids = componentsRef && Array.from(componentsRef.values()).filter(component => component instanceof DatagridComponent);
            if (grids && grids.length > 0) {
                result = result.concat(grids);
            }
            return result;
        }, []);
    }
}
DataGridService.decorators = [
    { type: Injectable }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1ncmlkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1ncmlkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBSXhELE1BQU0sT0FBTyxlQUFnQixTQUFRLE9BQU87SUFDMUM7OztPQUdHO0lBQ0ksV0FBVztRQUNoQixrQ0FBa0M7UUFDbEMseUNBQXlDO1FBQ3pDLDJCQUEyQjtRQUMzQix5Q0FBeUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoRSxJQUFJLGNBQWMsSUFBSSxjQUFjLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsYUFBZ0MsRUFBRSxFQUFFO2dCQUMxRCxJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUM7Z0JBQzNCLElBQUksYUFBYSxDQUFDLGNBQWMsQ0FBQyxnQ0FBZ0MsQ0FBQyxFQUFFO29CQUNsRSxlQUFlLEdBQUcsYUFBYSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7aUJBQ25FO2dCQUNELElBQUksZUFBZSxFQUFFO29CQUNuQixhQUFhLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUNuQztZQUNILENBQUMsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxJQUFJO1FBQ0osSUFBSTtJQUNOLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNJLGtCQUFrQixDQUFDLEdBQVE7UUFDaEMsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLEVBQUU7WUFDM0IsSUFBSSxHQUFHLENBQUMs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QUFHLFlBQVksQ0FBQyxVQUFVLENBQUM7WUFDM0MsTUFBTSxPQUFPLEdBQUcsWUFBWSxDQUFDLE9BQU8sQ0FBQztZQUNyQyxpQkFBaUI7WUFDakIsTUFBTSxhQUFhLEdBQUcsVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDNUQsTUFBTSxLQUFLLEdBQUcsYUFBYSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsU0FBUyxZQUFZLGlCQUFpQixDQUFDLENBQUM7WUFDOUgsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBQzdCLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQy9CO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ1QsQ0FBQzs7O1lBbklGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlXCI7XG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xuaW1wb3J0IHsgUXVlcnlDb25kaXRpb24gfSBmcm9tICdAZmFycmlzL2NvbXBvbmVudC1xdWVyeWNvbmRpdGlvbic7XG5pbXBvcnQgeyBDb21tYW5kQ29udGV4dCwgRnJhbWVDb250ZXh0IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGF0YUdyaWRTZXJ2aWNlIGV4dGVuZHMgU2VydmljZSB7XG4gIC8qKlxuICAgKiDmuIXnqbrmiYDmnInli77pgInooYxcbiAgICogQGRlc2NyaXB0aW9uIOWPlua2iOWLvumAieW9k+WJjeihqOWNleaJgOacieWLvumAieihjFxuICAgKi9cbiAgcHVibGljIGNsZWFyQ2hlY2tzKCkge1xuICAgIC8vIGNvbnN0IHBhcmFtcyA9IHRoaXMuZXZlbnRQYXJhbTtcbiAgICAvLyBpZiAocGFyYW1zICYmIEFycmF5LmlzQXJyYXkocGFyYW1zKSkge1xuICAgIC8vIGNvbnN0IHBhcmFtID0gcGFyYW1zWzBdO1xuICAgIC8vIGlmIChwYXJhbSBpbnN0YW5jZW9mIFF1ZXJ5Q29uZGl0aW9uKSB7XG4gICAgY29uc3QgZ3JpZENvbXBvbmVudHMgPSB0aGlzLmdldEZvcm1HcmlkQ29tcG9uZW50cyh0aGlzLmNvbnRleHQpO1xuICAgIGlmIChncmlkQ29tcG9uZW50cyAmJiBncmlkQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICBncmlkQ29tcG9uZW50cy5mb3JFYWNoKChncmlkQ29tcG9uZW50OiBEYXRhZ3JpZENvbXBvbmVudCkgPT4ge1xuICAgICAgICBsZXQgY2xlYXJTZWxlY3Rpb25zID0gdHJ1ZTtcbiAgICAgICAgaWYgKGdyaWRDb21wb25lbnQuaGFzT3duUHJvcGVydHkoJ2NsZWFyU2VsZWN0aW9uc1doZW5EYXRhSXNFbXB0eScpKSB7XG4gICAgICAgICAgY2xlYXJTZWxlY3Rpb25zID0gZ3JpZENvbXBvbmVudFsnY2xlYXJTZWxlY3Rpb25zV2hlbkRhdGFJc0VtcHR5J107XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNsZWFyU2VsZWN0aW9ucykge1xuICAgICAgICAgIGdyaWRDb21wb25lbnQuY2xlYXJDaGVja2Vkcyh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIH1cbiAgICAvLyB9XG4gIH1cbiAgLyoqXG4gICAqIOWPlua2iOWLvumAieWIoOmZpOeahOihjFxuICAgKiBAcGFyYW0gaWRzIGlkc1xuICAgKiBAcmV0dXJucyBcbiAgICogQGRlc2NyaXB0aW9uIOWPlua2iOWLvumAieW9k+WJjee7keWumui3r+W+hOS4i+aMh+WumuaVsOaNru+8jOa4heepuuS4i+e6p+ihqOagvOS4reaJgOacieWLvumAieihjO+8jOS7heS+m+WIoOmZpOWcuuaZr+S9v+eUqFxuICAgKi9cbiAgcHVibGljIHVuY2hlY2tEZWxldGVkUm93cyhpZHM6IGFueSkge1xuICAgIGlmICh0eXBlb2YgaWRzID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKGlkcy5pbmRleE9mKCcsJykgIT09IC0xKSB7XG4gICAgICAgIGlkcyA9IGlkcy5zcGxpdCgnLCcpLmZpbHRlcihwID0+IHApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWRzID0gW2lkc107XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIOiOt+WPlmJpbmRpbmdQYXRo5Y+KbnNcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmNvbnRleHQuZnJhbWVDb250ZXh0O1xuICAgIGlmICghZnJhbWVDb250ZXh0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGFwcENvbnRleHQgPSBmcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcbiAgICBjb25zdCBucyA9IGZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XG4gICAgaWYgKCFhcHBDb250ZXh0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIOagueaNrmJpbmRpbmdQYXRo6I635Y+W5omA5pyJ5Y+v6IO955qEZnJhbWVDb250ZXh0XG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobnMpO1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dHNJbkN1cnJlbnRCaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKGZyYW1lQ29udGV4dCA9PiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCk7XG4gICAgLy8g6I635Y+W6L+Z5LqbZnJhbWXkuK3miYDmnInnmoTooajmoLznu4Tku7ZtYXBcbiAgICBjb25zdCBncmlkSW5DdXJyZW50RnJhbWUgPSB0aGlzLmdldEdyaWRDb21wb25lbnRCeUZyYW1lQ29udGV4dHMoZnJhbWVDb250ZXh0c0luQ3VycmVudEJpbmRpbmdQYXRoKTtcbiAgICBpZiAoIWdyaWRJbkN1cnJlbnRGcmFtZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyDkuIDkuKpiaW5kaW5nUGF0aOS4i+W6lOivpeWPquacieS4gOS4qmdyaWRcbiAgICBjb25zdCBncmlkOiBEYXRhZ3JpZENvbXBvbmVudCA9IGdyaWRJbkN1cnJlbnRGcmFtZS5wb3AoKTtcbiAgICAvLyDmuIXnqbrlkb3ku6TmiYDlnKjnmoRmcmFtZeS4i+ihqOagvOeahOaMh+WumuWLvumAiVxuICAgIGlmKGdyaWQpe1xuICAgICAgZ3JpZC51bkNoZWNrUm93cyhpZHMsIHRydWUpO1xuICAgIH1cbiAgICAvLyDmuIXnqbrkuIvnuqfooajmoLznmoTmiYDmnInli77pgInooYzmlbDmja5cbiAgICBjb25zdCBjaGlsZHJlbkZyYW1lQ29udGV4dHMgPSBmcmFtZUNvbnRleHRzLmZpbHRlcihmcmFtZUNvbnRleHQgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCAhPT0gYmluZGluZ1BhdGggJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zdGFydHNXaXRoKGJpbmRpbmdQYXRoKSk7XG4gICAgY29uc3QgY2hpbGRyZW5HcmlkQ29tcG9uZW50cyA9IHRoaXMuZ2V0R3JpZENvbXBvbmVudEJ5RnJhbWVDb250ZXh0cyhjaGlsZHJlbkZyYW1lQ29udGV4dHMpO1xuICAgIC8vIOa4heepuuWRveS7pOaJgOWcqGZyYW1lXG4gICAgaWYgKGNoaWxkcmVuR3JpZENvbXBvbmVudHMgJiYgY2hpbGRyZW5HcmlkQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICBjaGlsZHJlbkdyaWRDb21wb25lbnRzLmZvckVhY2goKGdyaWRDb21wb25lbnQ6IERhdGFncmlkQ29tcG9uZW50KSA9PiB7XG4gICAgICAgIC8vIOa4heepuuaJgOacieWLvumAiVxuICAgICAgICBncmlkQ29tcG9uZW50LmNoZWNrZWRSb3dzID0gW107XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOWPlua2iOWLvumAieihjFxuICAgKiBAcGFyYW0gaWRzIGlkc1xuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyB1bmNoZWNrUm93cyhpZHM6IGFueSkge1xuICAgIGlmICh0eXBlb2YgaWRzID09PSAnc3RyaW5nJykge1xuICAgICAgaWRzID0gW2lkc107XG4gICAgfVxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGdyaWRDb21wb25lbnRzID0gdGhpcy5nZXRGb3JtR3JpZENvbXBvbmVudHModGhpcy5jb250ZXh0KTtcbiAgICBpZiAoZ3JpZENvbXBvbmVudHMgJiYgZ3JpZENvbXBvbmVudHMubGVuZ3RoID4gMCkge1xuICAgICAgZ3JpZENvbXBvbmVudHMuZm9yRWFjaCgoZ3JpZENvbXBvbmVudDogRGF0YWdyaWRDb21wb25lbnQpID0+IHtcbiAgICAgICAgZ3JpZENvbXBvbmVudC51bkNoZWNrUm93cyhpZHMsIHRydWUpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDmoLnmja7lkb3ku6TkuIrkuIvmlofojrflj5blvZPliY3lkb3ku6TmiYDlnKjnu4Tku7bnmoTooajmoLzlrp7kvotcbiAgICogQHBhcmFtIGNvbW1hbmRDb250ZXh0IOWRveS7pOS4iuS4i+aWh1xuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByaXZhdGUgZ2V0Rm9ybUdyaWRDb21wb25lbnRzKGNvbW1hbmRDb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xuICAgIGxldCBncmlkcyA9IFtdO1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGNvbW1hbmRDb250ZXh0ICYmIGNvbW1hbmRDb250ZXh0LmZyYW1lQ29udGV4dDtcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5hcHBDb250ZXh0IHx8IG51bGw7XG4gICAgaWYgKGFwcENvbnRleHQpIHtcbiAgICAgIGNvbnN0IGNvbXBvbmVudFJlZnM6IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIGFueT4+ID0gYXBwQ29udGV4dC5jb21wb25lbnRSZWZzO1xuICAgICAgY29uc3QgY29sbGVjdCA9IEFycmF5LmZyb20oY29tcG9uZW50UmVmcy52YWx1ZXMoKSk7Ly8gW01hcDxzdHJpbmcsYW55PixNYXA8c3RyaW5nLGFueT5dXG4gICAgICBjb2xsZWN0LmZvckVhY2goKGl0ZW06IE1hcDxzdHJpbmcsIGFueT4pID0+IHtcbiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IEFycmF5LmZyb20oaXRlbS52YWx1ZXMoKSk7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0XG4gICAgICAgIGNvbnN0IGdyaWRDb21wb25lbnRzID0gY29tcG9uZW50cy5maWx0ZXIoKGNvbXBvbmVudDogYW55KSA9PiBjb21wb25lbnQgaW5zdGFuY2VvZiBEYXRhZ3JpZENvbXBvbmVudCk7XG4gICAgICAgIGdyaWRzID0gZ3JpZHMuY29uY2F0KGdyaWRDb21wb25lbnRzKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZ3JpZHM7XG4gIH1cbiAgcHJpdmF0ZSBnZXRHcmlkQ29tcG9uZW50QnlGcmFtZUNvbnRleHRzKGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdKSB7XG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMucmVkdWNlKChyZXN1bHQsIGZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IGZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xuICAgICAgY29uc3QgZnJhbWVJZCA9IGZyYW1lQ29udGV4dC5mcmFtZUlkO1xuICAgICAgLy8g6I635Y+W5b2T5YmN57uE5Lu25LiL5omA5pyJ55qE57uE5Lu25a6e5L6LXG4gICAgICBjb25zdCBjb21wb25lbnRzUmVmID0gYXBwQ29udGV4dC5jb21wb25lbnRSZWZzLmdldChmcmFtZUlkKTtcbiAgICAgIGNvbnN0IGdyaWRzID0gY29tcG9uZW50c1JlZiAmJiBBcnJheS5mcm9tKGNvbXBvbmVudHNSZWYudmFsdWVzKCkpLmZpbHRlcihjb21wb25lbnQgPT4gY29tcG9uZW50IGluc3RhbmNlb2YgRGF0YWdyaWRDb21wb25lbnQpO1xuICAgICAgaWYgKGdyaWRzICYmIGdyaWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChncmlkcyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIFtdKTtcbiAgfVxufSJdfQ==