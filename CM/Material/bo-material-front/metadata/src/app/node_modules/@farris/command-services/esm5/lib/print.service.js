import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { CloudprintService, OutputType, FileType, PrintType } from '@gsp-svc/cloudprint';
import { FormNotifyService } from './form-notify.service';
// tslint:disable: unified-signatures
// tslint:disable: max-line-length
/**
 * 打印服务
 * @Scope FrameComponent
 */
var PrintService = /** @class */ (function () {
    /**
     * 构造函数
     */
    function PrintService(msgService, languageService, printService, formNotifyService) {
        this.msgService = msgService;
        this.languageService = languageService;
        this.printService = printService;
        this.formNotifyService = formNotifyService;
    }
    /**
     * 打印单据
     * @param beMetaId BE元数据标识
     * @param bizBillId 业务单据标识
     */
    PrintService.prototype.printSingle = function (beMetaId, bizBillId) {
        if (!bizBillId) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        return this.printArray(beMetaId, [bizBillId]);
    };
    /**
     * 打印单据（通过id或ids）
     * @param beMetaId be元数据Id
     * @param ids 单据id或ids
     */
    PrintService.prototype.printByIds = function (beMetaId, ids) {
        if (!ids) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        var dataIds = ids.split(',').filter(function (item) { return item; });
        return this.printArray(beMetaId, dataIds);
    };
    /**
     * 打印单据（带维度）
     * @param beMetaId be元数据Id
     * @param ids 单据id或ids
     * @param dim1 维度1值
     * @param dim2 维度2值
     * @param billCategoryId 单据类型Id
     */
    PrintService.prototype.printByIdsWithDimension = function (beMetaId, ids, dim1, dim2, billCategoryId) {
        if (!ids) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        var dataIds = ids.split(',').filter(function (item) { return item; });
        return this.printArray(beMetaId, dataIds, dim1, dim2, billCategoryId);
    };
    /**
     * 打印多个单据
     * @param beMetaId BE元数据标识
     * @param dataIds 业务单据标识数组
     * @param dim1 维度1
     * @param dim2 维度2
     * @param billCategoryId 业务单据类型Id
     */
    PrintService.prototype.printArray = function (beMetaId, dataIds, dim1, dim2, billCategoryId) {
        if (!dataIds || dataIds.length === 0) {
            // this.msgService.error(this.languageService.unallowEmptyBizBillId);
            this.showWarning(this.languageService.unallowEmptyBizBillId);
            return EMPTY;
        }
        var sourceOptions = this.buildSourceOptions({
            dataIds: dataIds,
            sourceId: beMetaId
        });
        var outputOptions = this.buildOutputOptions();
        if (typeof dim1 !== 'undefined') {
            sourceOptions.FirstDimensionVal = dim1;
        }
        if (typeof dim2 !== 'undefined') {
            sourceOptions.SecondDimensionVal = dim2;
        }
        if (typeof billCategoryId !== 'undefined') {
            sourceOptions.billCategoryId = billCategoryId;
        }
        return this.printService.outputBEData(sourceOptions, outputOptions, 'tab');
    };
    /**
     * 按照BE取数方式批量打印单据
     * @param beMetaId BE元数据标识
     * @param filterCondition 过滤条件
     * @param sortCondition 排序条件
     * @param includeChildData 包含子表数据
     */
    PrintService.prototype.printMulti = function (beMetaId, filterCondition, sortCondition, includeChildData) {
        if (includeChildData === void 0) { includeChildData = true; }
        var entryFilter = { 'isUsePagination': false, 'filterConditions': [], 'sortConditions': [], 'pagination': null };
        if (filterCondition) {
            // 统一纠正最后一个过滤条件的Relation
            var filters = JSON.parse(filterCondition);
            if (filters && filters.length > 0) {
                filters[filters.length - 1].Relation = 0;
            }
            entryFilter.filterConditions = filters;
        }
        if (sortCondition) {
            entryFilter.sortConditions = JSON.parse(sortCondition);
        }
        // sfo:SourceFilterOptions
        var sourceFilterOptions = this.buildSourceFilterOptions({ sourceId: beMetaId, entryFilter: entryFilter, includeChildData: includeChildData });
        var outputOptions = this.buildOutputOptions();
        return this.printService.outputBEDataWithFilter(sourceFilterOptions, outputOptions, 'tab');
    };
    /**
     * 按照BE取数方式批量打印单据(带维度)
     * @param beMetaId BE元数据标识
     * @param filterCondition 过滤条件
     * @param sortCondition 排序条件
     * @param dim1 维度1value
     * @param dim2 维度2value
     * @param billCategoryId 业务单据类型Id
     * @param includeChildData 包含子表数据
     */
    PrintService.prototype.printMultiWithDimension = function (beMetaId, filterCondition, sortCondition, dim1, dim2, billCategoryId, includeChildData) {
        if (includeChildData === void 0) { includeChildData = true; }
        var entryFilter = { 'isUsePagination': false, 'filterConditions': [], 'sortConditions': [], 'pagination': null };
        if (filterCondition) {
            // 统一纠正最后一个过滤条件的Relation
            var filters = JSON.parse(filterCondition);
            if (filters && filters.length > 0) {
                filters[filters.length - 1].Relation = 0;
            }
            entryFilter.filterConditions = filters;
        }
        if (sortCondition) {
            entryFilter.sortConditions = JSON.parse(sortCondition);
        }
        var sfo = this.buildSourceFilterOptions({ sourceId: beMetaId, entryFilter: entryFilter, includeChildData: includeChildData });
        if (typeof dim1 !== 'undefined') {
            sfo.FirstDimensionVal = dim1;
        }
        if (typeof dim2 !== 'undefined') {
            sfo.SecondDimensionVal = dim2;
        }
        if (typeof billCategoryId !== 'undefined') {
            sfo.billCategoryId = billCategoryId;
        }
        var outputOptions = this.buildOutputOptions();
        return this.printService.outputBEDataWithFilter(sfo, outputOptions, 'tab');
    };
    /**
     * 构造SourceOptions
     * @param options options
     */
    PrintService.prototype.buildSourceOptions = function (options) {
        var so = {
            DataIds: options && options.dataIds || undefined,
            SourceId: options && options.sourceId || undefined,
            FirstDimensionVal: options && options.dim1 || undefined,
            SecondDimensionVal: options && options.dim2 || undefined,
            RetrieveParam: options && options.retrieveParam || undefined,
            FormatId: options && options.formatId || undefined,
            billCategoryId: options && options.billCategoryId || undefined,
            ServiceUnit: options && options.serviceUnit || undefined,
            currentPage: options && options.currentPage || undefined,
            pageRowCount: options && options.pageRowCount || undefined,
            queryType: options && options.queryType || undefined,
            queryServiceId: options && options.queryServiceId || undefined,
            queryParam: options && options.queryParam || undefined
        };
        return so;
    };
    /**
     * 构造OutputOptions
     * @param options options
     */
    PrintService.prototype.buildOutputOptions = function (options) {
        var oo = {
            OutputType: options && options.outputType || OutputType.PRINT,
            FileType: options && options.fileType || FileType.Html5,
            Path: options && options.path || undefined,
            DeviceId: options && options.deviceId || undefined,
            printJob: options && options.printJob || undefined,
            printerName: options && options.printerName || undefined,
            printSetting: options && options.printSetting || undefined,
            printType: options && options.printType || PrintType.Form
        };
        return oo;
    };
    /**
     * 构造SourceFilterOptions
     * @param options options
     */
    PrintService.prototype.buildSourceFilterOptions = function (options) {
        var entryFilter = { 'isUsePagination': false, 'filterConditions': [], 'sortConditions': [], 'pagination': null };
        var sfo = {
            SourceId: options.sourceId,
            EntityFilter: options && options.entryFilter || entryFilter,
            FirstDimensionVal: options && options.dim1 || undefined,
            SecondDimensionVal: options && options.dim2 || undefined,
            FormatId: options && options.formatId || undefined,
            ServiceUnit: options && options.serviceUnit || undefined,
            billCategoryId: options && options.billCategoryId || undefined,
            currentPage: options && options.currentPage || undefined,
            pageRowCount: options && options.pageRowCount || undefined,
            queryParam: options && options.queryParam || undefined,
            queryServiceId: options && options.queryServiceId || undefined,
            queryType: options && options.queryType || undefined,
            includeChildData: options && options.hasOwnProperty('includeChildData') ? options.includeChildData : true
        };
        return sfo;
    };
    /**
     * 展示错误消息
     * @param message 错误消息
     */
    PrintService.prototype.showWarning = function (message) {
        if (this.notifyService) {
            this.notifyService.warning(message, { hideTitle: true });
        }
        else if (this.msgService) {
            this.msgService.error(message);
        }
    };
    Object.defineProperty(PrintService.prototype, "notifyService", {
        get: function () {
            if (this.formNotifyService) {
                return this.formNotifyService;
            }
            else if (this.injector) {
                return this.injector.get(FormNotifyService, null);
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PrintService.prototype, "commandContext", {
        get: function () {
            return this['context'] || null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PrintService.prototype, "frameContext", {
        get: function () {
            return this.commandContext && this.commandContext.frameContext || null;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PrintService.prototype, "injector", {
        get: function () {
            return this.frameContext && this.frameContext.injector || null;
        },
        enumerable: true,
        configurable: true
    });
    PrintService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PrintService.ctorParameters = function () { return [
        { type: FormMessageService },
        { type: LanguageService },
        { type: CloudprintService },
        { type: FormNotifyService, decorators: [{ type: Optional }] }
    ]; };
    return PrintService;
}());
export { PrintService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnQuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9wcmludC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQVksUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBR3BELE9BQU8sRUFBRSxpQkFBaUIsRUFBZ0MsVUFBVSxFQUFFLFFBQVEsRUFBdUIsU0FBUyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUksT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQscUNBQXFDO0FBQ3JDLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSDtJQU9FOztPQUVHO0lBQ0gsc0JBQ1UsVUFBOEIsRUFDOUIsZUFBZ0MsRUFDaEMsWUFBK0IsRUFDbkIsaUJBQW9DO1FBSGhELGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxpQkFBWSxHQUFaLFlBQVksQ0FBbUI7UUFDbkIsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtJQUUxRCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLGtDQUFXLEdBQWxCLFVBQW1CLFFBQWdCLEVBQUUsU0FBaUI7UUFDcEQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLHFFQUFxRTtZQUNyRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMscUJBQXFCLENBQUMsQ0FBQztZQUM3RCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxD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QUNFLE9BQU8sSUFBSSxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUM7UUFDekUsQ0FBQzs7O09BQUE7SUFDRCxzQkFBWSxrQ0FBUTthQUFwQjtZQUNFLE9BQU8sSUFBSSxDQUFDLFlBQVksSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUM7UUFDakUsQ0FBQzs7O09BQUE7O2dCQXZQRixVQUFVOzs7O2dCQVpGLGtCQUFrQjtnQkFDbEIsZUFBZTtnQkFHZixpQkFBaUI7Z0JBQ2pCLGlCQUFpQix1QkFxQnJCLFFBQVE7O0lBME9iLG1CQUFDO0NBQUEsQUF4UEQsSUF3UEM7QUFFRCxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEVNUFRZIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XG5pbXBvcnQgeyBDb21tYW5kQ29udGV4dCwgRW50aXR5LCBGcmFtZUNvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBDbG91ZHByaW50U2VydmljZSwgT3V0cHV0T3B0aW9ucywgU291cmNlT3B0aW9ucywgT3V0cHV0VHlwZSwgRmlsZVR5cGUsIFNvdXJjZUZpbHRlck9wdGlvbnMsIFByaW50VHlwZSB9IGZyb20gJ0Bnc3Atc3ZjL2Nsb3VkcHJpbnQnO1xuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xuLy8gdHNsaW50OmRpc2FibGU6IHVuaWZpZWQtc2lnbmF0dXJlc1xuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxuLyoqXG4gKiDmiZPljbDmnI3liqFcbiAqIEBTY29wZSBGcmFtZUNvbXBvbmVudFxuICovXG5ASW5qZWN0YWJsZSgpXG5jbGFzcyBQcmludFNlcnZpY2Uge1xuICAvKipcbiAgICog5a6e5L2T5LuT5bqTXG4gICAqL1xuICBwcml2YXRlIHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PjtcblxuICAvKipcbiAgICog5p6E6YCg5Ye95pWwXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG1zZ1NlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZSxcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgcHJpbnRTZXJ2aWNlOiBDbG91ZHByaW50U2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGZvcm1Ob3RpZnlTZXJ2aWNlOiBGb3JtTm90aWZ5U2VydmljZSxcbiAgKSB7XG4gIH1cblxuICAvKipcbiAgICog5omT5Y2w5Y2V5o2uXG4gICAqIEBwYXJhbSBiZU1ldGFJZCBCReWFg+aVsOaNruagh+ivhlxuICAgKiBAcGFyYW0gYml6QmlsbElkIOS4muWKoeWNleaNruagh+ivhlxuICAgKi9cbiAgcHVibGljIHByaW50U2luZ2xlKGJlTWV0YUlkOiBzdHJpbmcsIGJpekJpbGxJZDogc3RyaW5nKSB7XG4gICAgaWYgKCFiaXpCaWxsSWQpIHtcbiAgICAgIC8vIHRoaXMubXNnU2VydmljZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgdGhpcy5zaG93V2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcmludEFycmF5KGJlTWV0YUlkLCBbYml6QmlsbElkXSk7XG4gIH1cbiAgLyoqXG4gICAqIOaJk+WNsOWNleaNru+8iOmAmui/h2lk5oiWaWRz77yJXG4gICAqIEBwYXJhbSBiZU1ldGFJZCBiZeWFg+aVsOaNrklkXG4gICAqIEBwYXJhbSBpZHMg5Y2V5o2uaWTmiJZpZHNcbiAgICovXG4gIHB1YmxpYyBwcmludEJ5SWRzKGJlTWV0YUlkOiBzdHJpbmcsIGlkczogc3RyaW5nKSB7XG4gICAgaWYgKCFpZHMpIHtcbiAgICAgIC8vIHRoaXMubXNnU2VydmljZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgdGhpcy5zaG93V2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBkYXRhSWRzOiBBcnJheTxzdHJpbmc+ID0gaWRzLnNwbGl0KCcsJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XG4gICAgcmV0dXJuIHRoaXMucHJpbnRBcnJheShiZU1ldGFJZCwgZGF0YUlkcyk7XG4gIH1cbiAgLyoqXG4gICAqIOaJk+WNsOWNleaNru+8iOW4pue7tOW6pu+8iVxuICAgKiBAcGFyYW0gYmVNZXRhSWQgYmXlhYPmlbDmja5JZFxuICAgKiBAcGFyYW0gaWRzIOWNleaNrmlk5oiWaWRzXG4gICAqIEBwYXJhbSBkaW0xIOe7tOW6pjHlgLxcbiAgICogQHBhcmFtIGRpbTIg57u05bqmMuWAvFxuICAgKiBAcGFyYW0gYmlsbENhdGVnb3J5SWQg5Y2V5o2u57G75Z6LSWRcbiAgICovXG4gIHB1YmxpYyBwcmludEJ5SWRzV2l0aERpbWVuc2lvbihiZU1ldGFJZDogc3RyaW5nLCBpZHM6IHN0cmluZywgZGltMTogc3RyaW5nLCBkaW0yOiBzdHJpbmcsIGJpbGxDYXRlZ29yeUlkPzogc3RyaW5nKSB7XG4gICAgaWYgKCFpZHMpIHtcbiAgICAgIC8vIHRoaXMubXNnU2VydmljZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgdGhpcy5zaG93V2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBkYXRhSWRzOiBBcnJheTxzdHJpbmc+ID0gaWRzLnNwbGl0KCcsJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XG4gICAgcmV0dXJuIHRoaXMucHJpbnRBcnJheShiZU1ldGFJZCwgZGF0YUlkcywgZGltMSwgZGltMiwgYmlsbENhdGVnb3J5SWQpO1xuICB9XG4gIC8qKlxuICAgKiDmiZPljbDlpJrkuKrljZXmja5cbiAgICogQHBhcmFtIGJlTWV0YUlkIEJF5YWD5pWw5o2u5qCH6K+GXG4gICAqIEBwYXJhbSBkYXRhSWRzIOS4muWKoeWNleaNruagh+ivhuaVsOe7hFxuICAgKiBAcGFyYW0gZGltMSDnu7TluqYxXG4gICAqIEBwYXJhbSBkaW0yIOe7tOW6pjJcbiAgICogQHBhcmFtIGJpbGxDYXRlZ29yeUlkIOS4muWKoeWNleaNruexu+Wei0lkXG4gICAqL1xuICBwdWJsaWMgcHJpbnRBcnJheShiZU1ldGFJZDogc3RyaW5nLCBkYXRhSWRzOiBzdHJpbmdbXSwgZGltMT86IGFueSwgZGltMj86IGFueSwgYmlsbENhdGVnb3J5SWQ/OiBzdHJpbmcpIHtcbiAgICBpZiAoIWRhdGFJZHMgfHwgZGF0YUlkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIC8vIHRoaXMubXNnU2VydmljZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgdGhpcy5zaG93V2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS51bmFsbG93RW1wdHlCaXpCaWxsSWQpO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBzb3VyY2VPcHRpb25zOiBTb3VyY2VPcHRpb25zID0gdGhpcy5idWlsZFNvdXJjZU9wdGlvbnMoe1xuICAgICAgZGF0YUlkczogZGF0YUlkcyxcbiAgICAgIHNvdXJjZUlkOiBiZU1ldGFJZFxuICAgIH0pO1xuXG4gICAgY29uc3Qgb3V0cHV0T3B0aW9uczogT3V0cHV0T3B0aW9ucyA9IHRoaXMuYnVpbGRPdXRwdXRPcHRpb25zKCk7XG5cbiAgICBpZiAodHlwZW9mIGRpbTEgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBzb3VyY2VPcHRpb25zLkZpcnN0RGltZW5zaW9uVmFsID0gZGltMTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBkaW0yICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgc291cmNlT3B0aW9ucy5TZWNvbmREaW1lbnNpb25WYWwgPSBkaW0yO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGJpbGxDYXRlZ29yeUlkICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgc291cmNlT3B0aW9ucy5iaWxsQ2F0ZWdvcnlJZCA9IGJpbGxDYXRlZ29yeUlkO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5wcmludFNlcnZpY2Uub3V0cHV0QkVEYXRhKHNvdXJjZU9wdGlvbnMsIG91dHB1dE9wdGlvbnMsICd0YWInKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmjInnhadCReWPluaVsOaWueW8j+aJuemHj+aJk+WNsOWNleaNrlxuICAgKiBAcGFyYW0gYmVNZXRhSWQgQkXlhYPmlbDmja7moIfor4ZcbiAgICogQHBhcmFtIGZpbHRlckNvbmRpdGlvbiDov4fmu6TmnaHku7ZcbiAgICogQHBhcmFtIHNvcnRDb25kaXRpb24g5o6S5bqP5p2h5Lu2XG4gICAqIEBwYXJhbSBpbmNsdWRlQ2hpbGREYXRhIOWMheWQq+WtkOihqOaVsOaNrlxuICAgKi9cbiAgcHVibGljIHByaW50TXVsdGkoYmVNZXRhSWQ6IHN0cmluZywgZmlsdGVyQ29uZGl0aW9uOiBzdHJpbmcsIHNvcnRDb25kaXRpb246IHN0cmluZywgaW5jbHVkZUNoaWxkRGF0YTogYm9vbGVhbiA9IHRydWUpIHtcbiAgICBjb25zdCBlbnRyeUZpbHRlciA9IHsgJ2lzVXNlUGFnaW5hdGlvbic6IGZhbHNlLCAnZmlsdGVyQ29uZGl0aW9ucyc6IFtdLCAnc29ydENvbmRpdGlvbnMnOiBbXSwgJ3BhZ2luYXRpb24nOiBudWxsIH07XG4gICAgaWYgKGZpbHRlckNvbmRpdGlvbikge1xuICAgICAgLy8g57uf5LiA57qg5q2j5pyA5ZCO5LiA5Liq6L+H5ruk5p2h5Lu255qEUmVsYXRpb25cbiAgICAgIGNvbnN0IGZpbHRlcnMgPSBKU09OLnBhcnNlKGZpbHRlckNvbmRpdGlvbik7XG4gICAgICBpZiAoZmlsdGVycyAmJiBmaWx0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgZmlsdGVyc1tmaWx0ZXJzLmxlbmd0aCAtIDFdLlJlbGF0aW9uID0gMDtcbiAgICAgIH1cbiAgICAgIGVudHJ5RmlsdGVyLmZpbHRlckNvbmRpdGlvbnMgPSBmaWx0ZXJzO1xuICAgIH1cblxuICAgIGlmIChzb3J0Q29uZGl0aW9uKSB7XG4gICAgICBlbnRyeUZpbHRlci5zb3J0Q29uZGl0aW9ucyA9IEpTT04ucGFyc2Uoc29ydENvbmRpdGlvbik7XG4gICAgfVxuICAgIC8vIHNmbzpTb3VyY2VGaWx0ZXJPcHRpb25zXG4gICAgY29uc3Qgc291cmNlRmlsdGVyT3B0aW9uczogU291cmNlRmlsdGVyT3B0aW9ucyA9IHRoaXMuYnVpbGRTb3VyY2VGaWx0ZXJPcHRpb25zKHsgc291cmNlSWQ6IGJlTWV0YUlkLCBlbnRyeUZpbHRlciwgaW5jbHVkZUNoaWxkRGF0YSB9KTtcbiAgICBjb25zdCBvdXRwdXRPcHRpb25zOiBPdXRwdXRPcHRpb25zID0gdGhpcy5idWlsZE91dHB1dE9wdGlvbnMoKTtcbiAgICByZXR1cm4gdGhpcy5wcmludFNlcnZpY2Uub3V0cHV0QkVEYXRhV2l0aEZpbHRlcihzb3VyY2VGaWx0ZXJPcHRpb25zLCBvdXRwdXRPcHRpb25zLCAndGFiJyk7XG4gIH1cbiAgLyoqXG4gICAqIOaMieeFp0JF5Y+W5pWw5pa55byP5om56YeP5omT5Y2w5Y2V5o2uKOW4pue7tOW6pilcbiAgICogQHBhcmFtIGJlTWV0YUlkIEJF5YWD5pWw5o2u5qCH6K+GXG4gICAqIEBwYXJhbSBmaWx0ZXJDb25kaXRpb24g6L+H5ruk5p2h5Lu2XG4gICAqIEBwYXJhbSBzb3J0Q29uZGl0aW9uIOaOkuW6j+adoeS7tlxuICAgKiBAcGFyYW0gZGltMSDnu7TluqYxdmFsdWVcbiAgICogQHBhcmFtIGRpbTIg57u05bqmMnZhbHVlXG4gICAqIEBwYXJhbSBiaWxsQ2F0ZWdvcnlJZCDkuJrliqHljZXmja7nsbvlnotJZFxuICAgKiBAcGFyYW0gaW5jbHVkZUNoaWxkRGF0YSDljIXlkKvlrZDooajmlbDmja5cbiAgICovXG4gIHB1YmxpYyBwcmludE11bHRpV2l0aERpbWVuc2lvbihiZU1ldGFJZDogc3RyaW5nLCBmaWx0ZXJDb25kaXRpb246IHN0cmluZywgc29ydENvbmRpdGlvbjogc3RyaW5nLCBkaW0xOiBzdHJpbmcsIGRpbTI6IHN0cmluZywgYmlsbENhdGVnb3J5SWQ/OiBzdHJpbmcsIGluY2x1ZGVDaGlsZERhdGE6IGJvb2xlYW4gPSB0cnVlKSB7XG4gICAgY29uc3QgZW50cnlGaWx0ZXIgPSB7ICdpc1VzZVBhZ2luYXRpb24nOiBmYWxzZSwgJ2ZpbHRlckNvbmRpdGlvbnMnOiBbXSwgJ3NvcnRDb25kaXRpb25zJzogW10sICdwYWdpbmF0aW9uJzogbnVsbCB9O1xuICAgIGlmIChmaWx0ZXJDb25kaXRpb24pIHtcbiAgICAgIC8vIOe7n+S4gOe6oOato+acgOWQjuS4gOS4qui/h+a7pOadoeS7tueahFJlbGF0aW9uXG4gICAgICBjb25zdCBmaWx0ZXJzID0gSlNPTi5wYXJzZShmaWx0ZXJDb25kaXRpb24pO1xuICAgICAgaWYgKGZpbHRlcnMgJiYgZmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZpbHRlcnNbZmlsdGVycy5sZW5ndGggLSAxXS5SZWxhdGlvbiA9IDA7XG4gICAgICB9XG4gICAgICBlbnRyeUZpbHRlci5maWx0ZXJDb25kaXRpb25zID0gZmlsdGVycztcbiAgICB9XG5cbiAgICBpZiAoc29ydENvbmRpdGlvbikge1xuICAgICAgZW50cnlGaWx0ZXIuc29ydENvbmRpdGlvbnMgPSBKU09OLnBhcnNlKHNvcnRDb25kaXRpb24pO1xuICAgIH1cbiAgICBjb25zdCBzZm86IFNvdXJjZUZpbHRlck9wdGlvbnMgPSB0aGlzLmJ1aWxkU291cmNlRmlsdGVyT3B0aW9ucyh7IHNvdXJjZUlkOiBiZU1ldGFJZCwgZW50cnlGaWx0ZXIsIGluY2x1ZGVDaGlsZERhdGEgfSk7XG4gICAgaWYgKHR5cGVvZiBkaW0xICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgc2ZvLkZpcnN0RGltZW5zaW9uVmFsID0gZGltMTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBkaW0yICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgc2ZvLlNlY29uZERpbWVuc2lvblZhbCA9IGRpbTI7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYmlsbENhdGVnb3J5SWQgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBzZm8uYmlsbENhdGVnb3J5SWQgPSBiaWxsQ2F0ZWdvcnlJZDtcbiAgICB9XG4gICAgY29uc3Qgb3V0cHV0T3B0aW9uczogT3V0cHV0T3B0aW9ucyA9IHRoaXMuYnVpbGRPdXRwdXRPcHRpb25zKCk7XG4gICAgcmV0dXJuIHRoaXMucHJpbnRTZXJ2aWNlLm91dHB1dEJFRGF0YVdpdGhGaWx0ZXIoc2ZvLCBvdXRwdXRPcHRpb25zLCAndGFiJyk7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoFNvdXJjZU9wdGlvbnNcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFNvdXJjZU9wdGlvbnMob3B0aW9uczogeyBkYXRhSWRzOiBzdHJpbmdbXSwgc291cmNlSWQ6IHN0cmluZywgW3Byb3A6IHN0cmluZ106IGFueSB9KTogU291cmNlT3B0aW9ucyB7XG4gICAgY29uc3Qgc286IFNvdXJjZU9wdGlvbnMgPSB7XG4gICAgICBEYXRhSWRzOiBvcHRpb25zICYmIG9wdGlvbnMuZGF0YUlkcyB8fCB1bmRlZmluZWQsXG4gICAgICBTb3VyY2VJZDogb3B0aW9ucyAmJiBvcHRpb25zLnNvdXJjZUlkIHx8IHVuZGVmaW5lZCxcbiAgICAgIEZpcnN0RGltZW5zaW9uVmFsOiBvcHRpb25zICYmIG9wdGlvbnMuZGltMSB8fCB1bmRlZmluZWQsXG4gICAgICBTZWNvbmREaW1lbnNpb25WYWw6IG9wdGlvbnMgJiYgb3B0aW9ucy5kaW0yIHx8IHVuZGVmaW5lZCxcbiAgICAgIFJldHJpZXZlUGFyYW06IG9wdGlvbnMgJiYgb3B0aW9ucy5yZXRyaWV2ZVBhcmFtIHx8IHVuZGVmaW5lZCxcbiAgICAgIEZvcm1hdElkOiBvcHRpb25zICYmIG9wdGlvbnMuZm9ybWF0SWQgfHwgdW5kZWZpbmVkLFxuICAgICAgYmlsbENhdGVnb3J5SWQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5iaWxsQ2F0ZWdvcnlJZCB8fCB1bmRlZmluZWQsXG4gICAgICBTZXJ2aWNlVW5pdDogb3B0aW9ucyAmJiBvcHRpb25zLnNlcnZpY2VVbml0IHx8IHVuZGVmaW5lZCxcbiAgICAgIGN1cnJlbnRQYWdlOiBvcHRpb25zICYmIG9wdGlvbnMuY3VycmVudFBhZ2UgfHwgdW5kZWZpbmVkLFxuICAgICAgcGFnZVJvd0NvdW50OiBvcHRpb25zICYmIG9wdGlvbnMucGFnZVJvd0NvdW50IHx8IHVuZGVmaW5lZCxcbiAgICAgIHF1ZXJ5VHlwZTogb3B0aW9ucyAmJiBvcHRpb25zLnF1ZXJ5VHlwZSB8fCB1bmRlZmluZWQsXG4gICAgICBxdWVyeVNlcnZpY2VJZDogb3B0aW9ucyAmJiBvcHRpb25zLnF1ZXJ5U2VydmljZUlkIHx8IHVuZGVmaW5lZCxcbiAgICAgIHF1ZXJ5UGFyYW06IG9wdGlvbnMgJiYgb3B0aW9ucy5xdWVyeVBhcmFtIHx8IHVuZGVmaW5lZFxuICAgIH07XG4gICAgcmV0dXJuIHNvO1xuICB9XG4gIC8qKlxuICAgKiDmnoTpgKBPdXRwdXRPcHRpb25zXG4gICAqIEBwYXJhbSBvcHRpb25zIG9wdGlvbnNcbiAgICovXG4gIHByaXZhdGUgYnVpbGRPdXRwdXRPcHRpb25zKG9wdGlvbnM/OiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IE91dHB1dE9wdGlvbnMge1xuICAgIGNvbnN0IG9vOiBPdXRwdXRPcHRpb25zID0ge1xuICAgICAgT3V0cHV0VHlwZTogb3B0aW9ucyAmJiBvcHRpb25zLm91dHB1dFR5cGUgfHwgT3V0cHV0VHlwZS5QUklOVCxcbiAgICAgIEZpbGVUeXBlOiBvcHRpb25zICYmIG9wdGlvbnMuZmlsZVR5cGUgfHwgRmlsZVR5cGUuSHRtbDUsXG4gICAgICBQYXRoOiBvcHRpb25zICYmIG9wdGlvbnMucGF0aCB8fCB1bmRlZmluZWQsXG4gICAgICBEZXZpY2VJZDogb3B0aW9ucyAmJiBvcHRpb25zLmRldmljZUlkIHx8IHVuZGVmaW5lZCxcbiAgICAgIHByaW50Sm9iOiBvcHRpb25zICYmIG9wdGlvbnMucHJpbnRKb2IgfHwgdW5kZWZpbmVkLFxuICAgICAgcHJpbnRlck5hbWU6IG9wdGlvbnMgJiYgb3B0aW9ucy5wcmludGVyTmFtZSB8fCB1bmRlZmluZWQsXG4gICAgICBwcmludFNldHRpbmc6IG9wdGlvbnMgJiYgb3B0aW9ucy5wcmludFNldHRpbmcgfHwgdW5kZWZpbmVkLFxuICAgICAgcHJpbnRUeXBlOiBvcHRpb25zICYmIG9wdGlvbnMucHJpbnRUeXBlIHx8IFByaW50VHlwZS5Gb3JtXG4gICAgfTtcbiAgICByZXR1cm4gb287XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoFNvdXJjZUZpbHRlck9wdGlvbnNcbiAgICogQHBhcmFtIG9wdGlvbnMgb3B0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFNvdXJjZUZpbHRlck9wdGlvbnMob3B0aW9uczogeyBzb3VyY2VJZDogc3RyaW5nLCBbcHJvcDogc3RyaW5nXTogYW55IH0pOiBTb3VyY2VGaWx0ZXJPcHRpb25zIHtcbiAgICBjb25zdCBlbnRyeUZpbHRlciA9IHsgJ2lzVXNlUGFnaW5hdGlvbic6IGZhbHNlLCAnZmlsdGVyQ29uZGl0aW9ucyc6IFtdLCAnc29ydENvbmRpdGlvbnMnOiBbXSwgJ3BhZ2luYXRpb24nOiBudWxsIH07XG4gICAgY29uc3Qgc2ZvOiBTb3VyY2VGaWx0ZXJPcHRpb25zICYgeyBbcHJvcDogc3RyaW5nXTogYW55IH0gPSB7XG4gICAgICBTb3VyY2VJZDogb3B0aW9ucy5zb3VyY2VJZCxcbiAgICAgIEVudGl0eUZpbHRlcjogb3B0aW9ucyAmJiBvcHRpb25zLmVudHJ5RmlsdGVyIHx8IGVudHJ5RmlsdGVyLFxuICAgICAgRmlyc3REaW1lbnNpb25WYWw6IG9wdGlvbnMgJiYgb3B0aW9ucy5kaW0xIHx8IHVuZGVmaW5lZCxcbiAgICAgIFNlY29uZERpbWVuc2lvblZhbDogb3B0aW9ucyAmJiBvcHRpb25zLmRpbTIgfHwgdW5kZWZpbmVkLFxuICAgICAgRm9ybWF0SWQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5mb3JtYXRJZCB8fCB1bmRlZmluZWQsXG4gICAgICBTZXJ2aWNlVW5pdDogb3B0aW9ucyAmJiBvcHRpb25zLnNlcnZpY2VVbml0IHx8IHVuZGVmaW5lZCxcbiAgICAgIGJpbGxDYXRlZ29yeUlkOiBvcHRpb25zICYmIG9wdGlvbnMuYmlsbENhdGVnb3J5SWQgfHwgdW5kZWZpbmVkLFxuICAgICAgY3VycmVudFBhZ2U6IG9wdGlvbnMgJiYgb3B0aW9ucy5jdXJyZW50UGFnZSB8fCB1bmRlZmluZWQsXG4gICAgICBwYWdlUm93Q291bnQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5wYWdlUm93Q291bnQgfHwgdW5kZWZpbmVkLFxuICAgICAgcXVlcnlQYXJhbTogb3B0aW9ucyAmJiBvcHRpb25zLnF1ZXJ5UGFyYW0gfHwgdW5kZWZpbmVkLFxuICAgICAgcXVlcnlTZXJ2aWNlSWQ6IG9wdGlvbnMgJiYgb3B0aW9ucy5xdWVyeVNlcnZpY2VJZCB8fCB1bmRlZmluZWQsXG4gICAgICBxdWVyeVR5cGU6IG9wdGlvbnMgJiYgb3B0aW9ucy5xdWVyeVR5cGUgfHwgdW5kZWZpbmVkLFxuICAgICAgaW5jbHVkZUNoaWxkRGF0YTogb3B0aW9ucyAmJiBvcHRpb25zLmhhc093blByb3BlcnR5KCdpbmNsdWRlQ2hpbGREYXRhJykgPyBvcHRpb25zLmluY2x1ZGVDaGlsZERhdGEgOiB0cnVlXG4gICAgfTtcbiAgICByZXR1cm4gc2ZvO1xuICB9XG4gIC8qKlxuICAgKiDlsZXnpLrplJnor6/mtojmga9cbiAgICogQHBhcmFtIG1lc3NhZ2Ug6ZSZ6K+v5raI5oGvXG4gICAqL1xuICBwcml2YXRlIHNob3dXYXJuaW5nKG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGlmICh0aGlzLm5vdGlmeVNlcnZpY2UpIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKG1lc3NhZ2UsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgIH0gZWxzZSBpZiAodGhpcy5tc2dTZXJ2aWNlKSB7XG4gICAgICB0aGlzLm1zZ1NlcnZpY2UuZXJyb3IobWVzc2FnZSk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgZ2V0IG5vdGlmeVNlcnZpY2UoKTogRm9ybU5vdGlmeVNlcnZpY2UgfCBudWxsIHtcbiAgICBpZiAodGhpcy5mb3JtTm90aWZ5U2VydmljZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2U7XG4gICAgfSBlbHNlIGlmICh0aGlzLmluamVjdG9yKSB7XG4gICAgICByZXR1cm4gdGhpcy5pbmplY3Rvci5nZXQ8Rm9ybU5vdGlmeVNlcnZpY2U+KEZvcm1Ob3RpZnlTZXJ2aWNlLCBudWxsKTtcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcHJpdmF0ZSBnZXQgY29tbWFuZENvbnRleHQoKTogQ29tbWFuZENvbnRleHQgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpc1snY29udGV4dCddIHx8IG51bGw7XG4gIH1cbiAgcHJpdmF0ZSBnZXQgZnJhbWVDb250ZXh0KCk6IEZyYW1lQ29udGV4dCB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLmNvbW1hbmRDb250ZXh0ICYmIHRoaXMuY29tbWFuZENvbnRleHQuZnJhbWVDb250ZXh0IHx8IG51bGw7XG4gIH1cbiAgcHJpdmF0ZSBnZXQgaW5qZWN0b3IoKTogSW5qZWN0b3IgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IgfHwgbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgeyBQcmludFNlcnZpY2UgfTtcbiJdfQ==