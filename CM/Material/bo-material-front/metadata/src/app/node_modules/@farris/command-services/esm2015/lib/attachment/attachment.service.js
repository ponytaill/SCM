import { Injectable, InjectFlags, Optional } from '@angular/core';
import { from, of, empty, EMPTY } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { UploadDialogService, UploadLimit, DownloadService, FileState } from '@gsp-svc/formdoc-upload';
import { FileViewerService } from '@gsp-svc/file-viewer';
import { FrameContext, BindingPathConverter, DataPathCreator } from '@farris/devkit';
import { FormNotifyService } from '../form-notify.service';
import { AttachmentUtil } from './attachment.util';
import { AttachmentDataService } from './attachment-data.service';
import { LanguageService } from '../languag.service';
import { EntityService } from '../entity-services/index';
// tslint:disable: max-line-length
/**
 * 附件服务
 */
class AttachmentService {
    /**
     * 构造函数
     */
    constructor(frameContext, attachDataService, notifyService, uploadDialogService, downloadService) {
        this.frameContext = frameContext;
        this.attachDataService = attachDataService;
        this.notifyService = notifyService;
        this.uploadDialogService = uploadDialogService;
        this.downloadService = downloadService;
        /**
         * 默认根目录
         */
        this.defaultRootDirId = '';
        this.setLanguageService();
        this.fileViewerService = this.frameContext.injector.get(FileViewerService, null, InjectFlags.Optional);
        this.entityService = this.frameContext.injector.get(EntityService, null, InjectFlags.Optional);
        if (!this.downloadService && typeof DownloadService !== 'undefined') {
            this.downloadService = this.frameContext.injector.get(DownloadService, null);
        }
    }
    /**
     * 默认父路径
     */
    get defaultParentDirName() {
        return this.frameContext.bindingData.list.currentId;
    }
    /**
     * 绑定数据
     */
    get bindingData() {
        return this.frameContext.bindingData;
    }
    /**
     * 设置语言服务
     */
    setLanguageService() {
        const injector = this.frameContext.injector;
        this.languageService = injector.get(LanguageService, null, InjectFlags.Optional);
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
    }
    /**
     * 上传单个文件
     * @param attachmentIdPath 附件内码字段的路径，形如/attachInfo/attachmentId；
     * @param attachmentNamePath 附件名称字段的路径
     */
    uploadAndUpdateRow(attachmentInfoFieldPath, rootDirId, parentDirName, fileType, id) {
        const rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        const formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        const uploadLimit = new UploadLimit();
        uploadLimit.fileCount = 1;
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        // 获取老的附件id数组
        const attachmentIdList = [];
        let currentItem = null;
        if (id) {
            // 修正当前行
            const bindingList = this.frameContext.bindingData.getList();
            if (bindingList.currentId !== id) {
                bindingList.setCurrentId(id, true, true);
            }
            // 如果指定了id则获取指定id的行
            currentItem = this.getSpecialRow(attachmentInfoFieldPath, id);
        }
        else {
            // 没有指定则使用当前行，可能存在当前行和事件行不一致的情况，此时应该在命令中传递id参数
            currentItem = this.getCurrentRow(attachmentInfoFieldPath);
        }
        if (currentItem && currentItem.primaryKeyValue) {
            const attachmentIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, [currentItem.primaryKeyValue]);
            if (attachmentIds && attachmentIds.length > 0) {
                attachmentIdList.push.apply(attachmentIdList, attachmentIds);
            }
        }
        const dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit, attachmentIdList));
        const result$ = dialog$.pipe(switchMap((fileInfos) => {
            if (!fileInfos || fileInfos.length === 0) {
                this.notifyService.warning(this.languageService.plsUploadFirst, { hideTitle: true });
                return empty();
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter((fileInfo) => {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            // 是否上传判断
            const attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            const firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
            return this.attachDataService.updateRow(attachmentInfoFieldPath, firstAttachmentInfo);
        }));
        return result$;
    }
    /**
     * 上传单个文件（支持多列）
     * @param attachmentInfoFieldPath 附件内码字段的路径，形如/attachInfo/attachmentId；
     * @param rootDirId 附件存储根目录
     * @param parentDirName 附件存储目录
     * @param fileType 文件类型，like .txt,.docx
     */
    uploadAndUpdateRowWithPropertyName(attachmentInfoFieldPath, rootDirId, parentDirName, fileType, id) {
        const rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        const formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        const uploadLimit = new UploadLimit();
        uploadLimit.fileCount = 1;
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        // 获取老的附件id数组
        const attachmentIdList = [];
        let currentItem = null;
        if (id) {
            // 修正当前行
            const bindingList = this.frameContext.bindingData.getList();
            if (bindingList.currentId !== id) {
                bindingList.setCurrentId(id, true, true);
            }
            // 如果指定了id则获取指定id的行
            currentItem = this.getSpecialRow(attachmentInfoFieldPath, id);
        }
        else {
            // 没有指定则使用当前行，可能存在当前行和事件行不一致的情况，此时应该在命令中传递id参数
            currentItem = this.getCurrentRow(attachmentInfoFieldPath);
        }
        if (currentItem && currentItem.primaryKeyValue) {
            const attachmentIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, [currentItem.primaryKeyValue]);
            if (attachmentIds && attachmentIds.length > 0) {
                attachmentIdList.push.apply(attachmentIdList, attachmentIds);
            }
        }
        const dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit, attachmentIdList));
        const result$ = dialog$.pipe(switchMap((fileInfos) => {
            if (!fileInfos || fileInfos.length === 0) {
                this.notifyService.warning(this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter((fileInfo) => {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            // 是否上传判断
            const attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            const firstAttachmentInfo = AttachmentUtil.getFirstAttachmentInfo(attachmentInfos);
            return this.attachDataService.updateRowWithPropertyName(attachmentInfoFieldPath, firstAttachmentInfo);
        }));
        return result$;
    }
    /**
     * 上传多个文件
     */
    uploadAndBatchAddRows(attachmentInfoFieldPath, rootDirId, parentDirName, fileType) {
        const rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        const formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        const uploadLimit = new UploadLimit();
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        const dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit));
        const result$ = dialog$.pipe(switchMap((fileInfos) => {
            if (!fileInfos || fileInfos.length === 0) {
                this.notifyService.warning(this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter((fileInfo) => {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            const attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            return this.attachDataService.updateRows(attachmentInfoFieldPath, attachmentInfos);
        }));
        return result$;
    }
    /**
     * 上传多个文件
     */
    uploadAndBatchAddRowsWithPropertyName(attachmentInfoFieldPath, rootDirId, parentDirName, fileType) {
        const rootId = rootDirId ? rootDirId : this.defaultRootDirId;
        const formId = parentDirName ? parentDirName : this.defaultParentDirName;
        if (!rootId || !formId) {
            throw new Error('rootDirId和parentDirName不能为空，请填写');
        }
        const uploadLimit = new UploadLimit();
        if (fileType) {
            uploadLimit.fileType = fileType;
        }
        const dialog$ = from(this.uploadDialogService.uploadFileWithLimit(formId, rootId, uploadLimit));
        const result$ = dialog$.pipe(switchMap((fileInfos) => {
            if (!fileInfos || fileInfos.length === 0) {
                this.notifyService.warning(this.languageService.plsUploadFirst, { hideTitle: true });
                return EMPTY;
            }
            // 过滤出state为新增的附件
            fileInfos = fileInfos.filter((fileInfo) => {
                if (fileInfo.hasOwnProperty('state')) {
                    return fileInfo.state === FileState.New;
                }
                return true;
            });
            if (fileInfos.length === 0) {
                return of(true);
            }
            const attachmentInfos = AttachmentUtil.convertToAttachmentInfos(fileInfos);
            return this.attachDataService.updateRowsWithPropertyName(attachmentInfoFieldPath, attachmentInfos);
        }));
        return result$;
    }
    /**
     * 下载附件（根据附件id）
     */
    download(attachId, rootId) {
        if (!attachId) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        rootId = rootId || 'default-root';
        const url = this.getDownloadUrl([attachId], rootId);
        // let url = '';
        // if (rootId) {
        //   url = `/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=${attachId}&rootid=${rootId}`;
        // } else {
        //   url = `/api/runtime/dfs/v1.0/formdoc/download/${attachId}`;
        // }
        window.open(url);
        return of(true);
    }
    /**
     * 批量下载附件（根据附件id数组）
     */
    batchDownload(attachIds, rootId) {
        if (!attachIds || attachIds.length === 0) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        // 只选择一个附件时按单个附件下载处理
        if (attachIds.length === 1) {
            return this.download(attachIds[0], rootId);
        }
        // const attachIdsString = JSON.stringify(attachIds);
        // const url = `/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist=${attachIdsString}&rootid=${rootId}`;
        const url = this.getDownloadUrl(attachIds, rootId);
        window.open(url);
        return of(true);
    }
    /**
     * 获取下载路径
     * @param metadataidlist 附件id数组
     * @param rootId rootId
     */
    getDownloadUrl(metadataidlist, rootId) {
        rootId = rootId || 'default-root';
        if (this.downloadService) {
            if (metadataidlist.length === 1) {
                return this.downloadService.getDownloadUrl(metadataidlist[0], rootId);
            }
            else {
                const attachIdsString = JSON.stringify(metadataidlist);
                return this.downloadService.getMultipleDownloadUrl(attachIdsString, rootId);
            }
        }
        else {
            console.warn('因安全问题，附件下载提供安全校验机制，附件下载功能需重新编译。');
            if (metadataidlist.length === 1) {
                return `/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid=${metadataidlist[0]}&rootid=${rootId}`;
            }
            else {
                const attachIdsString = JSON.stringify(metadataidlist);
                return `/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist=${attachIdsString}&rootid=${rootId}`;
            }
        }
    }
    /**
     * 下载（根据数据id）
     */
    downloadByDataId(dataId, attachmentInfoFieldPath, rootId) {
        if (!dataId) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        const dataIds = [dataId];
        const attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds);
        if (attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        const attachId = attachIds[0];
        return this.download(attachId);
    }
    /**
     * 批量下载附件
     */
    batchDownloadByDataIds(dataIds, attachmentInfoFieldPath, rootId) {
        if (typeof dataIds === 'string' && dataIds && dataIds.length > 0) {
            dataIds = dataIds.split(',').filter(p => p);
        }
        if (!dataIds || Array.isArray(dataIds) === false || dataIds.length === 0) {
            this.notifyService.warning(this.languageService.plsSelectDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        const ids = [].concat(dataIds);
        const attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, ids);
        if (attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noDownloadAtt, { hideTitle: true });
            return EMPTY;
        }
        return this.batchDownload(attachIds, rootId);
    }
    /**
     * 根据附件UDT字段的路径预览附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param rootDirId 跟目录id
     * @param ids 附件id
     */
    previewByAttachmentInfoFieldPath(attachmentInfoFieldPath, rootDirId, ids) {
        if (!attachmentInfoFieldPath || !rootDirId) {
            throw new Error('attachmentInfoFieldPath和rootDirId不能为空，请填写');
        }
        let attachIds = [];
        let dataIds = [];
        if (ids && ids.length > 0) {
            if (typeof (ids) === 'string') {
                dataIds.push(ids);
            }
            else {
                dataIds = ids;
            }
            attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds);
        }
        else {
            attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        }
        if (attachIds && attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        return this.previewByAttachmentIds(attachIds, rootDirId);
    }
    /**
     * 根据附件UDT字段的路径预览当前行的附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param rootDirId 根目录id
     */
    previewByAttachmentInfoFieldPathWithIndex(attachmentInfoFieldPath, rootDirId) {
        if (!attachmentInfoFieldPath || !rootDirId) {
            throw new Error('attachmentInfoFieldPath和rootDirId不能为空，请填写');
        }
        const currentRow = this.getCurrentRow(attachmentInfoFieldPath);
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        const attachmentFieldName = parentBindingPathArray.pop();
        if (!currentRow[attachmentFieldName] || !currentRow[attachmentFieldName]['attachmentId']) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        const attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        if (attachIds && attachIds.length === 0) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        const attachmentId = this.getCurrentAttachmentId(attachmentInfoFieldPath);
        if (!attachmentId) {
            throw new Error('要预览的附件id不存在，请确认');
        }
        else {
            return this.previewFileListWithIndex(attachIds, rootDirId, attachmentId);
        }
    }
    /**
     * 根据目录预览附件
     * @param subDirName 父目录名称
     * @param rootDirId 根目录id
     */
    previewBySubDirName(subDirName, rootDirId) {
        if (!subDirName || !rootDirId) {
            throw new Error('subDirName和rootDirId不能为空，请填写');
        }
        const viewer$ = from(this.fileViewerService.viewerFormFile(subDirName, rootDirId));
        return viewer$;
    }
    /**
     * 根据目录预览指定索引的附件
     * @param attachmentInfoFieldPath 附件UDT字段path
     * @param subDirName 子目录名称
     * @param rootDirId 根目录id
     */
    previewBySubDirNameWithIndex(attachmentInfoFieldPath, subDirName, rootDirId) {
        if (!subDirName || !rootDirId) {
            throw new Error('subDirName和rootDirId不能为空，请填写');
        }
        // const attachIds = this.getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, null);
        const attachmentId = this.getCurrentAttachmentId(attachmentInfoFieldPath);
        if (!attachmentId) {
            this.notifyService.warning(this.languageService.noAttachment, { hideTitle: true });
            return EMPTY;
        }
        const viewer$ = from(this.fileViewerService.viewerFormFileWithIndex(subDirName, rootDirId, attachmentId));
        return viewer$;
    }
    /**
     * 根据附件id数组预览附件
     * @param attachmentIds 附件id数组
     * @param rootDirId 根目录id
     */
    previewByAttachmentIds(attachmentIds, rootDirId) {
        const viewer$ = from(this.fileViewerService.viewerFileList(attachmentIds, rootDirId));
        return viewer$;
    }
    /**
     * 根据附件id数组预览指定索引的附件
     * @param attachmentIds 附件id数组
     * @param rootDirId 根目录id
     * @param attachmentId 附件Id
     */
    previewFileListWithIndex(attachmentIds, rootDirId, attachmentId) {
        const viewer$ = from(this.fileViewerService.viewerFileListWithIndex(attachmentIds, rootDirId, attachmentId));
        return viewer$;
    }
    /**
     * 生成版本号
     * @param versions 历史版本号
     * @description 默认编码规则v1.0 v2.0 ...
     */
    genVersion(versions) {
        if (!versions) {
            versions = [];
        }
        const mainCode = versions.length + 1;
        return `V${mainCode}.0`;
    }
    /**
     * 更新附件版本信息
     * @param versionField 附件版本字段
     * @param historyField 是否历史版本字段
     * @param attachmentFieldPath 附件udt字段路径
     */
    updateAttachmentVersion(versionField, historyField, attachmentFieldPath) {
        /**
         * 遍历所有附件行
         * 找到所有没有附件版本的行
         * 遍历这些行
         * 通过文件名去查找同名的且有附件版本号的行
         * 这些行历史版本字段置为true
         * 无版本号的行，版本= 上行数 + 1
         *
         */
        const bindingPaths = attachmentFieldPath.split('/').filter(p => p);
        // 弹出附件udt字段
        const attachmentField = bindingPaths.pop();
        // 获取到所有的附件
        const attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        const befRepository = this.frameContext.repository;
        const entityManager = befRepository.entityManager;
        const dataPath = DataPathCreator.createByShortPathFromRoot(bindingPaths, entityManager, this.frameContext.bindingData);
        const paths = dataPath.toArray().map((path) => {
            if (path.startsWith('PropName:')) {
                return path.split(':')[1];
            }
            else {
                return path;
            }
        });
        if (attachmentBindingList) {
            const attachments = attachmentBindingList.toJSON();
            // 只处理有附件的情况
            if (attachments) {
                const versionLessRows = attachments.filter(item => !item[versionField]);
                versionLessRows.forEach(item => {
                    const fileName = item[attachmentField]['fileName'];
                    const versionedRows = attachments.filter(row => row[attachmentField]['fileName'] === fileName && row[versionField]);
                    paths.pop();
                    paths.push(`DataId:${item[attachmentBindingList.primaryKey]}`);
                    let entity = this.frameContext.repository.entityCollection.getEntityByPath(paths);
                    const version = this.genVersion(versionedRows);
                    entity[versionField] = version;
                    entity[historyField] = false;
                    // 处理历史记录
                    versionedRows.forEach(row => {
                        paths.pop();
                        paths.push(`DataId:${row[attachmentBindingList.primaryKey]}`);
                        entity = this.frameContext.repository.entityCollection.getEntityByPath(paths);
                        entity[historyField] = true;
                    });
                });
            }
        }
    }
    isAttachmentCanDelete(historyField, attachmentFieldPath) {
        const bindingPaths = attachmentFieldPath.split('/').filter(p => p);
        // 弹出附件udt字段
        bindingPaths.pop();
        const attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        const bindingObject = attachmentBindingList.currentItem;
        if (bindingObject[historyField] === true) {
            this.notifyService.warning(this.languageService.historyAttachment, { hideTitle: true });
            return EMPTY;
        }
    }
    updateAttachmentHistory(versionField, historyField, attachmentFieldPath) {
        const bindingPaths = attachmentFieldPath.split('/').filter(p => p);
        // 弹出附件udt字段
        const attachmentField = bindingPaths.pop();
        // 获取到所有的附件
        const attachmentBindingList = this.frameContext.bindingData.getValue(bindingPaths);
        // const befRepository = this.frameContext.repository as BefRepository<any>;
        // const entityManager = befRepository.entityManager;
        if (attachmentBindingList) {
            const attachments = attachmentBindingList.toJSON();
            const versionedRows = attachments.filter(item => item[versionField]);
            const fileNameMap = new Map();
            const befRepository = this.frameContext.repository;
            const entityManager = befRepository.entityManager;
            const dataPath = DataPathCreator.createByShortPathFromRoot(bindingPaths, entityManager, this.frameContext.bindingData);
            const paths = dataPath.toArray().map((path) => {
                if (path.startsWith('PropName:')) {
                    return path.split(':')[1];
                }
                else {
                    return path;
                }
            });
            versionedRows.forEach(item => {
                const fileName = item[attachmentField]['fileName'];
                if (fileNameMap.has(fileName)) {
                    fileNameMap.get(fileName).push(item);
                }
                else {
                    fileNameMap.set(fileName, [item]);
                }
            });
            Array.from(fileNameMap.values()).forEach((array) => {
                array.sort((x, y) => {
                    const xVersion = parseInt(x[versionField].replace(/[a-zA-Z\.]/g, ''));
                    const yVersion = parseInt(y[versionField].replace(/[a-zA-Z\.]/g, ''));
                    return yVersion - xVersion;
                });
                const row = array[0];
                paths.pop();
                paths.push(`DataId:${row[attachmentBindingList.primaryKey]}`);
                const entity = this.frameContext.repository.entityCollection.getEntityByPath(paths);
                entity[historyField] = false;
            });
        }
    }
    /**
     * 获取当前视图模型当前行的附件id
     * @param attachmentInfoFieldPath 附件udt字段
     */
    getCurrentAttachmentId(attachmentInfoFieldPath) {
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        const attachmentFieldName = parentBindingPathArray.pop();
        const bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        const currentItem = bindingList.currentItem;
        if (currentItem && currentItem.primaryKeyValue) {
            return currentItem[attachmentFieldName] && currentItem[attachmentFieldName]['attachmentId'] || null;
        }
        else {
            return null;
        }
    }
    /**
     * 获取当前行
     * @param attachmentInfoFieldPath udt字段
     */
    getCurrentRow(attachmentInfoFieldPath) {
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        const bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        const currentItem = bindingList && bindingList.currentItem;
        return currentItem;
    }
    /**
     * 获取指定附件信息表的指定行
     * @param attachmentInfoFieldPath
     * @param primaryValue
     * @returns
     */
    getSpecialRow(attachmentInfoFieldPath, primaryValue) {
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        const bindingList = this.frameContext.bindingData.getValue(parentBindingPathArray);
        const currentItem = bindingList && bindingList.findById(primaryValue);
        return currentItem;
    }
    /**
     * 获取dataIds对应Entity上的附件id数组
     */
    getAttachmentIdsByPathAndDataIds(attachmentInfoFieldPath, dataIds) {
        // 解析路径
        const parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        const attachmentFieldName = parentBindingPathArray.pop();
        // 获取附件所在实体的数据列表，不传递dataIds参数，则返回全部
        const entityListData = this.entityService.getEntityListData(parentBindingPathArray);
        let filteredEntityListData = [];
        if (dataIds && Array.isArray(dataIds) === true) {
            filteredEntityListData = entityListData.filter((entityData) => {
                return dataIds.indexOf(entityData.id) > -1;
            });
        }
        else {
            filteredEntityListData = entityListData;
        }
        // 转换为附件Id数组
        const attachmentIds = [];
        filteredEntityListData.forEach((entityData) => {
            if (entityData[attachmentFieldName]) {
                const attachmentId = entityData[attachmentFieldName]['attachmentId'];
                if (attachmentId) {
                    attachmentIds.push(attachmentId);
                }
            }
        });
        return attachmentIds;
    }
}
AttachmentService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
AttachmentService.ctorParameters = () => [
    { type: FrameContext },
    { type: AttachmentDataService },
    { type: FormNotifyService },
    { type: UploadDialogService },
    { type: DownloadService, decorators: [{ type: Optional }] }
];
export { AttachmentService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2F0dGFjaG1lbnQvYXR0YWNobWVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNsRSxPQUFPLEVBQWMsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzFELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsbUJBQW1CLEVBQWtCLFdBQVcsRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDdkgsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQsT0FBTyxFQUFFLFlBQVksRUFBZSxvQkFBb0IsRUFBNkIsZUFBZSxFQUFzQixNQUFNLGdCQUFnQixDQUFDO0FBQ2pKLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUNsRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBR3pELGtDQUFrQztBQUNsQzs7R0FFRztBQUNILE1BQ00saUJBQWlCO0lBb0NyQjs7T0FFRztJQUNILFlBQ1UsWUFBMEIsRUFDMUIsaUJBQXdDLEVBQ3hDLGFBQWdDLEVBQ2hDLG1CQUF3QyxFQUM1QixlQUFnQztRQUo1QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixz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QUUsRUFBRTtnQkFDakUsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUM3QyxDQUFDLENBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCxzQkFBc0IsR0FBRyxjQUFjLENBQUM7U0FDekM7UUFFRCxZQUFZO1FBQ1osTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBQ3pCLHNCQUFzQixDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQWUsRUFBRSxFQUFFO1lBQ2pELElBQUksVUFBVSxDQUFDLG1CQUFtQixDQUFDLEVBQUU7Z0JBQ25DLE1BQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDO2dCQUNyRSxJQUFJLFlBQVksRUFBRTtvQkFDaEIsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztpQkFDbEM7YUFDRjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxhQUFhLENBQUM7SUFDdkIsQ0FBQzs7O1lBbHFCRixVQUFVOzs7O1lBWkYsWUFBWTtZQUdaLHFCQUFxQjtZQUZyQixpQkFBaUI7WUFIakIsbUJBQW1CO1lBQStCLGVBQWUsdUJBMkRyRSxRQUFROztBQXduQmIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RGbGFncywgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGZyb20sIG9mLCBlbXB0eSwgRU1QVFkgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFVwbG9hZERpYWxvZ1NlcnZpY2UsIFVwbG9hZEZpbGVJbmZvLCBVcGxvYWRMaW1pdCwgRG93bmxvYWRTZXJ2aWNlLCBGaWxlU3RhdGUgfSBmcm9tICdAZ3NwLXN2Yy9mb3JtZG9jLXVwbG9hZCc7XG5pbXBvcnQgeyBGaWxlVmlld2VyU2VydmljZSB9IGZyb20gJ0Bnc3Atc3ZjL2ZpbGUtdmlld2VyJztcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgQmluZGluZ0RhdGEsIEJpbmRpbmdQYXRoQ29udmVydGVyLCBCaW5kaW5nTGlzdCwgRGF0YVBhdGhVdGlsLCBEYXRhUGF0aENyZWF0b3IsIEVudGl0eUxpc3QsIEVudGl0eSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1ub3RpZnkuc2VydmljZSc7XG5pbXBvcnQgeyBBdHRhY2htZW50VXRpbCB9IGZyb20gJy4vYXR0YWNobWVudC51dGlsJztcbmltcG9ydCB7IEF0dGFjaG1lbnREYXRhU2VydmljZSB9IGZyb20gJy4vYXR0YWNobWVudC1kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vbGFuZ3VhZy5zZXJ2aWNlJztcbmltcG9ydCB7IEVudGl0eVNlcnZpY2UgfSBmcm9tICcuLi9lbnRpdHktc2VydmljZXMvaW5kZXgnO1xuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcblxuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxuLyoqXG4gKiDpmYTku7bmnI3liqFcbiAqL1xuQEluamVjdGFibGUoKVxuY2xhc3MgQXR0YWNobWVudFNlcnZpY2Uge1xuXG4gIC8qKlxuICAgKiDpu5jorqTmoLnnm67lvZVcbiAgICovXG4gIHByaXZhdGUgZGVmYXVsdFJvb3REaXJJZCA9ICcnO1xuXG4gIC8qKlxuICAgKiDpu5jorqTniLbot6/lvoRcbiAgICovXG4gIHByaXZhdGUgZ2V0IGRlZmF1bHRQYXJlbnREaXJOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICB9XG5cbiAgLyoqXG4gICAqIOe7keWumuaVsOaNrlxuICAgKi9cbiAgcHJpdmF0ZSBnZXQgYmluZGluZ0RhdGEoKTogQmluZGluZ0RhdGEge1xuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlpJror63mnI3liqFcbiAgICovXG4gIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2U7XG5cbiAgLyoqXG4gICAqIOmZhOS7tumihOiniOacjeWKoVxuICAgKi9cbiAgcHJpdmF0ZSBmaWxlVmlld2VyU2VydmljZTogRmlsZVZpZXdlclNlcnZpY2U7XG5cbiAgLyoqXG4gICAqIOWunuS9k+acjeWKoVxuICAgKi9cbiAgcHJpdmF0ZSBlbnRpdHlTZXJ2aWNlOiBFbnRpdHlTZXJ2aWNlO1xuXG4gIC8qKlxuICAgKiDmnoTpgKDlh73mlbBcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXG4gICAgcHJpdmF0ZSBhdHRhY2hEYXRhU2VydmljZTogQXR0YWNobWVudERhdGFTZXJ2aWNlLFxuICAgIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSB1cGxvYWREaWFsb2dTZXJ2aWNlOiBVcGxvYWREaWFsb2dTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgZG93bmxvYWRTZXJ2aWNlOiBEb3dubG9hZFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5zZXRMYW5ndWFnZVNlcnZpY2UoKTtcbiAgICB0aGlzLmZpbGVWaWV3ZXJTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PEZpbGVWaWV3ZXJTZXJ2aWNlPihGaWxlVmlld2VyU2VydmljZSwgbnVsbCwgSW5qZWN0RmxhZ3MuT3B0aW9uYWwpO1xuICAgIHRoaXMuZW50aXR5U2VydmljZSA9IHRoaXMuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxFbnRpdHlTZXJ2aWNlPihFbnRpdHlTZXJ2aWNlLCBudWxsLCBJbmplY3RGbGFncy5PcHRpb25hbCk7XG4gICAgaWYgKCF0aGlzLmRvd25sb2FkU2VydmljZSAmJiB0eXBlb2YgRG93bmxvYWRTZXJ2aWNlICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5kb3dubG9hZFNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8RG93bmxvYWRTZXJ2aWNlPihEb3dubG9hZFNlcnZpY2UsIG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDorr7nva7or63oqIDmnI3liqFcbiAgICovXG4gIHByaXZhdGUgc2V0TGFuZ3VhZ2VTZXJ2aWNlKCkge1xuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3I7XG4gICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBpbmplY3Rvci5nZXQ8TGFuZ3VhZ2VTZXJ2aWNlPihMYW5ndWFnZVNlcnZpY2UsIG51bGwsIEluamVjdEZsYWdzLk9wdGlvbmFsKTtcbiAgICBpZiAoIXRoaXMubGFuZ3VhZ2VTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDkuIrkvKDljZXkuKrmlofku7ZcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJZFBhdGgg6ZmE5Lu25YaF56CB5a2X5q6155qE6Lev5b6E77yM5b2i5aaCL2F0dGFjaEluZm8vYXR0YWNobWVudElk77ybXG4gICAqIEBwYXJhbSBhdHRhY2htZW50TmFtZVBhdGgg6ZmE5Lu25ZCN56ew5a2X5q6155qE6Lev5b6EXG4gICAqL1xuICBwdWJsaWMgdXBsb2FkQW5kVXBkYXRlUm93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZD86IHN0cmluZywgcGFyZW50RGlyTmFtZT86IHN0cmluZywgZmlsZVR5cGU/OiBzdHJpbmcsIGlkPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByb290SWQgPSByb290RGlySWQgPyByb290RGlySWQgOiB0aGlzLmRlZmF1bHRSb290RGlySWQ7XG4gICAgY29uc3QgZm9ybUlkID0gcGFyZW50RGlyTmFtZSA/IHBhcmVudERpck5hbWUgOiB0aGlzLmRlZmF1bHRQYXJlbnREaXJOYW1lO1xuICAgIGlmICghcm9vdElkIHx8ICFmb3JtSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcigncm9vdERpcklk5ZKMcGFyZW50RGlyTmFtZeS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xuICAgIH1cblxuICAgIGNvbnN0IHVwbG9hZExpbWl0OiBVcGxvYWRMaW1pdCA9IG5ldyBVcGxvYWRMaW1pdCgpO1xuICAgIHVwbG9hZExpbWl0LmZpbGVDb3VudCA9IDE7XG4gICAgaWYgKGZpbGVUeXBlKSB7XG4gICAgICB1cGxvYWRMaW1pdC5maWxlVHlwZSA9IGZpbGVUeXBlO1xuICAgIH1cbiAgICAvLyDojrflj5bogIHnmoTpmYTku7ZpZOaVsOe7hFxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZExpc3QgPSBbXTtcbiAgICBsZXQgY3VycmVudEl0ZW0gPSBudWxsO1xuICAgIGlmIChpZCkge1xuICAgICAgLy8g5L+u5q2j5b2T5YmN6KGMXG4gICAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRMaXN0KCk7XG4gICAgICBpZiAoYmluZGluZ0xpc3QuY3VycmVudElkICE9PSBpZCkge1xuICAgICAgICBiaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQsIHRydWUsIHRydWUpO1xuICAgICAgfVxuICAgICAgLy8g5aaC5p6c5oyH5a6a5LqGaWTliJnojrflj5bmjIflrpppZOeahOihjFxuICAgICAgY3VycmVudEl0ZW0gPSB0aGlzLmdldFNwZWNpYWxSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8g5rKh5pyJ5oyH5a6a5YiZ5L2/55So5b2T5YmN6KGM77yM5Y+v6IO95a2Y5Zyo5b2T5YmN6KGM5ZKM5LqL5Lu26KGM5LiN5LiA6Ie055qE5oOF5Ya177yM5q2k5pe25bqU6K+l5Zyo5ZG95Luk5Lit5Lyg6YCSaWTlj4LmlbBcbiAgICAgIGN1cnJlbnRJdGVtID0gdGhpcy5nZXRDdXJyZW50Um93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRJdGVtICYmIGN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSkge1xuICAgICAgY29uc3QgYXR0YWNobWVudElkcyA9IHRoaXMuZ2V0QXR0YWNobWVudElkc0J5UGF0aEFuZERhdGFJZHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIFtjdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWVdKTtcbiAgICAgIGlmIChhdHRhY2htZW50SWRzICYmIGF0dGFjaG1lbnRJZHMubGVuZ3RoID4gMCkge1xuICAgICAgICBhdHRhY2htZW50SWRMaXN0LnB1c2guYXBwbHkoYXR0YWNobWVudElkTGlzdCwgYXR0YWNobWVudElkcyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgZGlhbG9nJCA9IGZyb20odGhpcy51cGxvYWREaWFsb2dTZXJ2aWNlLnVwbG9hZEZpbGVXaXRoTGltaXQoZm9ybUlkLCByb290SWQsIHVwbG9hZExpbWl0LCBhdHRhY2htZW50SWRMaXN0KSk7XG4gICAgY29uc3QgcmVzdWx0JCA9IGRpYWxvZyQucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoZmlsZUluZm9zOiBVcGxvYWRGaWxlSW5mb1tdKSA9PiB7XG4gICAgICAgIGlmICghZmlsZUluZm9zIHx8IGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNVcGxvYWRGaXJzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g6L+H5ruk5Ye6c3RhdGXkuLrmlrDlop7nmoTpmYTku7ZcbiAgICAgICAgZmlsZUluZm9zID0gZmlsZUluZm9zLmZpbHRlcigoZmlsZUluZm86IFVwbG9hZEZpbGVJbmZvKSA9PiB7XG4gICAgICAgICAgaWYgKGZpbGVJbmZvLmhhc093blByb3BlcnR5KCdzdGF0ZScpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmlsZUluZm8uc3RhdGUgPT09IEZpbGVTdGF0ZS5OZXc7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g5piv5ZCm5LiK5Lyg5Yik5patXG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnRJbmZvcyA9IEF0dGFjaG1lbnRVdGlsLmNvbnZlcnRUb0F0dGFjaG1lbnRJbmZvcyhmaWxlSW5mb3MpO1xuICAgICAgICBjb25zdCBmaXJzdEF0dGFjaG1lbnRJbmZvID0gQXR0YWNobWVudFV0aWwuZ2V0Rmlyc3RBdHRhY2htZW50SW5mbyhhdHRhY2htZW50SW5mb3MpO1xuICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hEYXRhU2VydmljZS51cGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGZpcnN0QXR0YWNobWVudEluZm8pO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHJlc3VsdCQ7XG4gIH1cbiAgLyoqXG4gICAqIOS4iuS8oOWNleS4quaWh+S7tu+8iOaUr+aMgeWkmuWIl++8iVxuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm9GaWVsZFBhdGgg6ZmE5Lu25YaF56CB5a2X5q6155qE6Lev5b6E77yM5b2i5aaCL2F0dGFjaEluZm8vYXR0YWNobWVudElk77ybXG4gICAqIEBwYXJhbSByb290RGlySWQg6ZmE5Lu25a2Y5YKo5qC555uu5b2VXG4gICAqIEBwYXJhbSBwYXJlbnREaXJOYW1lIOmZhOS7tuWtmOWCqOebruW9lVxuICAgKiBAcGFyYW0gZmlsZVR5cGUg5paH5Lu257G75Z6L77yMbGlrZSAudHh0LC5kb2N4XG4gICAqL1xuICBwdWJsaWMgdXBsb2FkQW5kVXBkYXRlUm93V2l0aFByb3BlcnR5TmFtZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCByb290RGlySWQ/OiBzdHJpbmcsIHBhcmVudERpck5hbWU/OiBzdHJpbmcsIGZpbGVUeXBlPzogc3RyaW5nLCBpZD86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgcm9vdElkID0gcm9vdERpcklkID8gcm9vdERpcklkIDogdGhpcy5kZWZhdWx0Um9vdERpcklkO1xuICAgIGNvbnN0IGZvcm1JZCA9IHBhcmVudERpck5hbWUgPyBwYXJlbnREaXJOYW1lIDogdGhpcy5kZWZhdWx0UGFyZW50RGlyTmFtZTtcbiAgICBpZiAoIXJvb3RJZCB8fCAhZm9ybUlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jvb3REaXJJZOWSjHBhcmVudERpck5hbWXkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGxvYWRMaW1pdDogVXBsb2FkTGltaXQgPSBuZXcgVXBsb2FkTGltaXQoKTtcbiAgICB1cGxvYWRMaW1pdC5maWxlQ291bnQgPSAxO1xuICAgIGlmIChmaWxlVHlwZSkge1xuICAgICAgdXBsb2FkTGltaXQuZmlsZVR5cGUgPSBmaWxlVHlwZTtcbiAgICB9XG5cbiAgICAvLyDojrflj5bogIHnmoTpmYTku7ZpZOaVsOe7hFxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZExpc3QgPSBbXTtcbiAgICBsZXQgY3VycmVudEl0ZW0gPSBudWxsO1xuICAgIGlmIChpZCkge1xuICAgICAgLy8g5L+u5q2j5b2T5YmN6KGMXG4gICAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRMaXN0KCk7XG4gICAgICBpZiAoYmluZGluZ0xpc3QuY3VycmVudElkICE9PSBpZCkge1xuICAgICAgICBiaW5kaW5nTGlzdC5zZXRDdXJyZW50SWQoaWQsIHRydWUsIHRydWUpO1xuICAgICAgfVxuICAgICAgLy8g5aaC5p6c5oyH5a6a5LqGaWTliJnojrflj5bmjIflrpppZOeahOihjFxuICAgICAgY3VycmVudEl0ZW0gPSB0aGlzLmdldFNwZWNpYWxSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8g5rKh5pyJ5oyH5a6a5YiZ5L2/55So5b2T5YmN6KGM77yM5Y+v6IO95a2Y5Zyo5b2T5YmN6KGM5ZKM5LqL5Lu26KGM5LiN5LiA6Ie055qE5oOF5Ya177yM5q2k5pe25bqU6K+l5Zyo5ZG95Luk5Lit5Lyg6YCSaWTlj4LmlbBcbiAgICAgIGN1cnJlbnRJdGVtID0gdGhpcy5nZXRDdXJyZW50Um93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICB9XG4gICAgaWYgKGN1cnJlbnRJdGVtICYmIGN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZSkge1xuICAgICAgY29uc3QgYXR0YWNobWVudElkcyA9IHRoaXMuZ2V0QXR0YWNobWVudElkc0J5UGF0aEFuZERhdGFJZHMoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIFtjdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWVdKTtcbiAgICAgIGlmIChhdHRhY2htZW50SWRzICYmIGF0dGFjaG1lbnRJZHMubGVuZ3RoID4gMCkge1xuICAgICAgICBhdHRhY2htZW50SWRMaXN0LnB1c2guYXBwbHkoYXR0YWNobWVudElkTGlzdCwgYXR0YWNobWVudElkcyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgZGlhbG9nJCA9IGZyb20odGhpcy51cGxvYWREaWFsb2dTZXJ2aWNlLnVwbG9hZEZpbGVXaXRoTGltaXQoZm9ybUlkLCByb290SWQsIHVwbG9hZExpbWl0LCBhdHRhY2htZW50SWRMaXN0KSk7XG4gICAgY29uc3QgcmVzdWx0JCA9IGRpYWxvZyQucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoZmlsZUluZm9zOiBVcGxvYWRGaWxlSW5mb1tdKSA9PiB7XG4gICAgICAgIGlmICghZmlsZUluZm9zIHx8IGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNVcGxvYWRGaXJzdCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICB9XG4gICAgICAgIC8vIOi/h+a7pOWHunN0YXRl5Li65paw5aKe55qE6ZmE5Lu2XG4gICAgICAgIGZpbGVJbmZvcyA9IGZpbGVJbmZvcy5maWx0ZXIoKGZpbGVJbmZvOiBVcGxvYWRGaWxlSW5mbykgPT4ge1xuICAgICAgICAgIGlmIChmaWxlSW5mby5oYXNPd25Qcm9wZXJ0eSgnc3RhdGUnKSkge1xuICAgICAgICAgICAgcmV0dXJuIGZpbGVJbmZvLnN0YXRlID09PSBGaWxlU3RhdGUuTmV3O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChmaWxlSW5mb3MubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIC8vIOaYr+WQpuS4iuS8oOWIpOaWrVxuICAgICAgICBjb25zdCBhdHRhY2htZW50SW5mb3MgPSBBdHRhY2htZW50VXRpbC5jb252ZXJ0VG9BdHRhY2htZW50SW5mb3MoZmlsZUluZm9zKTtcbiAgICAgICAgY29uc3QgZmlyc3RBdHRhY2htZW50SW5mbyA9IEF0dGFjaG1lbnRVdGlsLmdldEZpcnN0QXR0YWNobWVudEluZm8oYXR0YWNobWVudEluZm9zKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoRGF0YVNlcnZpY2UudXBkYXRlUm93V2l0aFByb3BlcnR5TmFtZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgZmlyc3RBdHRhY2htZW50SW5mbyk7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gcmVzdWx0JDtcbiAgfVxuICAvKipcbiAgICog5LiK5Lyg5aSa5Liq5paH5Lu2XG4gICAqL1xuICBwdWJsaWMgdXBsb2FkQW5kQmF0Y2hBZGRSb3dzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIHJvb3REaXJJZD86IHN0cmluZywgcGFyZW50RGlyTmFtZT86IHN0cmluZywgZmlsZVR5cGU/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJvb3RJZCA9IHJvb3REaXJJZCA/IHJvb3REaXJJZCA6IHRoaXMuZGVmYXVsdFJvb3REaXJJZDtcbiAgICBjb25zdCBmb3JtSWQgPSBwYXJlbnREaXJOYW1lID8gcGFyZW50RGlyTmFtZSA6IHRoaXMuZGVmYXVsdFBhcmVudERpck5hbWU7XG4gICAgaWYgKCFyb290SWQgfHwgIWZvcm1JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdyb290RGlySWTlkoxwYXJlbnREaXJOYW1l5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XG4gICAgfVxuXG4gICAgY29uc3QgdXBsb2FkTGltaXQ6IFVwbG9hZExpbWl0ID0gbmV3IFVwbG9hZExpbWl0KCk7XG4gICAgaWYgKGZpbGVUeXBlKSB7XG4gICAgICB1cGxvYWRMaW1pdC5maWxlVHlwZSA9IGZpbGVUeXBlO1xuICAgIH1cbiAgICBjb25zdCBkaWFsb2ckID0gZnJvbSh0aGlzLnVwbG9hZERpYWxvZ1NlcnZpY2UudXBsb2FkRmlsZVdpdGhMaW1pdChmb3JtSWQsIHJvb3RJZCwgdXBsb2FkTGltaXQpKTtcbiAgICBjb25zdCByZXN1bHQkID0gZGlhbG9nJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKChmaWxlSW5mb3M6IFVwbG9hZEZpbGVJbmZvW10pID0+IHtcbiAgICAgICAgaWYgKCFmaWxlSW5mb3MgfHwgZmlsZUluZm9zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1VwbG9hZEZpcnN0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g6L+H5ruk5Ye6c3RhdGXkuLrmlrDlop7nmoTpmYTku7ZcbiAgICAgICAgZmlsZUluZm9zID0gZmlsZUluZm9zLmZpbHRlcigoZmlsZUluZm86IFVwbG9hZEZpbGVJbmZvKSA9PiB7XG4gICAgICAgICAgaWYgKGZpbGVJbmZvLmhhc093blByb3BlcnR5KCdzdGF0ZScpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmlsZUluZm8uc3RhdGUgPT09IEZpbGVTdGF0ZS5OZXc7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XG4gICAgICAgIHJldHVybiB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvd3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvcyk7XG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIHJlc3VsdCQ7XG4gIH1cbiAgLyoqXG4gICAqIOS4iuS8oOWkmuS4quaWh+S7tlxuICAgKi9cbiAgcHVibGljIHVwbG9hZEFuZEJhdGNoQWRkUm93c1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkPzogc3RyaW5nLCBwYXJlbnREaXJOYW1lPzogc3RyaW5nLCBmaWxlVHlwZT86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgcm9vdElkID0gcm9vdERpcklkID8gcm9vdERpcklkIDogdGhpcy5kZWZhdWx0Um9vdERpcklkO1xuICAgIGNvbnN0IGZvcm1JZCA9IHBhcmVudERpck5hbWUgPyBwYXJlbnREaXJOYW1lIDogdGhpcy5kZWZhdWx0UGFyZW50RGlyTmFtZTtcbiAgICBpZiAoIXJvb3RJZCB8fCAhZm9ybUlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jvb3REaXJJZOWSjHBhcmVudERpck5hbWXkuI3og73kuLrnqbrvvIzor7floavlhpknKTtcbiAgICB9XG4gICAgY29uc3QgdXBsb2FkTGltaXQ6IFVwbG9hZExpbWl0ID0gbmV3IFVwbG9hZExpbWl0KCk7XG4gICAgaWYgKGZpbGVUeXBlKSB7XG4gICAgICB1cGxvYWRMaW1pdC5maWxlVHlwZSA9IGZpbGVUeXBlO1xuICAgIH1cbiAgICBjb25zdCBkaWFsb2ckID0gZnJvbSh0aGlzLnVwbG9hZERpYWxvZ1NlcnZpY2UudXBsb2FkRmlsZVdpdGhMaW1pdChmb3JtSWQsIHJvb3RJZCwgdXBsb2FkTGltaXQpKTtcbiAgICBjb25zdCByZXN1bHQkID0gZGlhbG9nJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKChmaWxlSW5mb3M6IFVwbG9hZEZpbGVJbmZvW10pID0+IHtcbiAgICAgICAgaWYgKCFmaWxlSW5mb3MgfHwgZmlsZUluZm9zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1VwbG9hZEZpcnN0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH1cbiAgICAgICAgLy8g6L+H5ruk5Ye6c3RhdGXkuLrmlrDlop7nmoTpmYTku7ZcbiAgICAgICAgZmlsZUluZm9zID0gZmlsZUluZm9zLmZpbHRlcigoZmlsZUluZm86IFVwbG9hZEZpbGVJbmZvKSA9PiB7XG4gICAgICAgICAgaWYgKGZpbGVJbmZvLmhhc093blByb3BlcnR5KCdzdGF0ZScpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmlsZUluZm8uc3RhdGUgPT09IEZpbGVTdGF0ZS5OZXc7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KTtcbiAgICAgICAgaWYgKGZpbGVJbmZvcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYXR0YWNobWVudEluZm9zID0gQXR0YWNobWVudFV0aWwuY29udmVydFRvQXR0YWNobWVudEluZm9zKGZpbGVJbmZvcyk7XG4gICAgICAgIHJldHVybiB0aGlzLmF0dGFjaERhdGFTZXJ2aWNlLnVwZGF0ZVJvd3NXaXRoUHJvcGVydHlOYW1lKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xuICAgICAgfSlcbiAgICApO1xuICAgIHJldHVybiByZXN1bHQkO1xuICB9XG4gIC8qKlxuICAgKiDkuIvovb3pmYTku7bvvIjmoLnmja7pmYTku7ZpZO+8iVxuICAgKi9cbiAgcHVibGljIGRvd25sb2FkKGF0dGFjaElkOiBzdHJpbmcsIHJvb3RJZD86IHN0cmluZyk6IGFueSB7XG4gICAgaWYgKCFhdHRhY2hJZCkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzU2VsZWN0RG93bmxvYWRBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICByb290SWQgPSByb290SWQgfHwgJ2RlZmF1bHQtcm9vdCc7XG4gICAgY29uc3QgdXJsID0gdGhpcy5nZXREb3dubG9hZFVybChbYXR0YWNoSWRdLCByb290SWQpO1xuICAgIC8vIGxldCB1cmwgPSAnJztcbiAgICAvLyBpZiAocm9vdElkKSB7XG4gICAgLy8gICB1cmwgPSBgL2FwaS9ydW50aW1lL2Rmcy92MS4wL2Zvcm1kb2MvZmlsZWNvbnRlbnQ/bWV0YWRhdGFpZD0ke2F0dGFjaElkfSZyb290aWQ9JHtyb290SWR9YDtcbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgdXJsID0gYC9hcGkvcnVudGltZS9kZnMvdjEuMC9mb3JtZG9jL2Rvd25sb2FkLyR7YXR0YWNoSWR9YDtcbiAgICAvLyB9XG4gICAgd2luZG93Lm9wZW4odXJsKTtcbiAgICByZXR1cm4gb2YodHJ1ZSk7XG4gIH1cbiAgLyoqXG4gICAqIOaJuemHj+S4i+i9vemZhOS7tu+8iOagueaNrumZhOS7tmlk5pWw57uE77yJXG4gICAqL1xuICBwdWJsaWMgYmF0Y2hEb3dubG9hZChhdHRhY2hJZHM6IHN0cmluZ1tdLCByb290SWQ6IHN0cmluZyk6IGFueSB7XG4gICAgaWYgKCFhdHRhY2hJZHMgfHwgYXR0YWNoSWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzU2VsZWN0RG93bmxvYWRBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICAvLyDlj6rpgInmi6nkuIDkuKrpmYTku7bml7bmjInljZXkuKrpmYTku7bkuIvovb3lpITnkIZcbiAgICBpZiAoYXR0YWNoSWRzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWQoYXR0YWNoSWRzWzBdLCByb290SWQpO1xuICAgIH1cbiAgICAvLyBjb25zdCBhdHRhY2hJZHNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShhdHRhY2hJZHMpO1xuICAgIC8vIGNvbnN0IHVybCA9IGAvYXBpL3J1bnRpbWUvZGZzL3YxLjAvZm9ybWRvYy9tdWx0aXBsZS9kb3dubG9hZD9tZXRhZGF0YWlkbGlzdD0ke2F0dGFjaElkc1N0cmluZ30mcm9vdGlkPSR7cm9vdElkfWA7XG4gICAgY29uc3QgdXJsID0gdGhpcy5nZXREb3dubG9hZFVybChhdHRhY2hJZHMsIHJvb3RJZCk7XG4gICAgd2luZG93Lm9wZW4odXJsKTtcbiAgICByZXR1cm4gb2YodHJ1ZSk7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluS4i+i9vei3r+W+hFxuICAgKiBAcGFyYW0gbWV0YWRhdGFpZGxpc3Qg6ZmE5Lu2aWTmlbDnu4RcbiAgICogQHBhcmFtIHJvb3RJZCByb290SWRcbiAgICovXG4gIHByaXZhdGUgZ2V0RG93bmxvYWRVcmwobWV0YWRhdGFpZGxpc3Q6IEFycmF5PHN0cmluZz4sIHJvb3RJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByb290SWQgPSByb290SWQgfHwgJ2RlZmF1bHQtcm9vdCc7XG4gICAgaWYgKHRoaXMuZG93bmxvYWRTZXJ2aWNlKSB7XG4gICAgICBpZiAobWV0YWRhdGFpZGxpc3QubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmRvd25sb2FkU2VydmljZS5nZXREb3dubG9hZFVybChtZXRhZGF0YWlkbGlzdFswXSwgcm9vdElkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGF0dGFjaElkc1N0cmluZyA9IEpTT04uc3RyaW5naWZ5KG1ldGFkYXRhaWRsaXN0KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG93bmxvYWRTZXJ2aWNlLmdldE11bHRpcGxlRG93bmxvYWRVcmwoYXR0YWNoSWRzU3RyaW5nLCByb290SWQpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLndhcm4oJ+WboOWuieWFqOmXrumimO+8jOmZhOS7tuS4i+i9veaPkOS+m+WuieWFqOagoemqjOacuuWItu+8jOmZhOS7tuS4i+i9veWKn+iDvemcgOmHjeaWsOe8luivkeOAgicpO1xuICAgICAgaWYgKG1ldGFkYXRhaWRsaXN0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gYC9hcGkvcnVudGltZS9kZnMvdjEuMC9mb3JtZG9jL2ZpbGVjb250ZW50P21ldGFkYXRhaWQ9JHttZXRhZGF0YWlkbGlzdFswXX0mcm9vdGlkPSR7cm9vdElkfWA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBhdHRhY2hJZHNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShtZXRhZGF0YWlkbGlzdCk7XG4gICAgICAgIHJldHVybiBgL2FwaS9ydW50aW1lL2Rmcy92MS4wL2Zvcm1kb2MvbXVsdGlwbGUvZG93bmxvYWQ/bWV0YWRhdGFpZGxpc3Q9JHthdHRhY2hJZHNTdHJpbmd9JnJvb3RpZD0ke3Jvb3RJZH1gO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICAvKipcbiAgICog5LiL6L2977yI5qC55o2u5pWw5o2uaWTvvIlcbiAgICovXG4gIHB1YmxpYyBkb3dubG9hZEJ5RGF0YUlkKGRhdGFJZDogc3RyaW5nLCBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCByb290SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKCFkYXRhSWQpIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdERvd25sb2FkQXR0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG5cbiAgICBjb25zdCBkYXRhSWRzID0gW2RhdGFJZF07XG4gICAgY29uc3QgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgZGF0YUlkcyk7XG4gICAgaWYgKGF0dGFjaElkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vRG93bmxvYWRBdHQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cblxuICAgIGNvbnN0IGF0dGFjaElkID0gYXR0YWNoSWRzWzBdO1xuICAgIHJldHVybiB0aGlzLmRvd25sb2FkKGF0dGFjaElkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmibnph4/kuIvovb3pmYTku7ZcbiAgICovXG4gIHB1YmxpYyBiYXRjaERvd25sb2FkQnlEYXRhSWRzKGRhdGFJZHM6IHN0cmluZ1tdIHwgc3RyaW5nLCBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCByb290SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKHR5cGVvZiBkYXRhSWRzID09PSAnc3RyaW5nJyAmJiBkYXRhSWRzICYmIGRhdGFJZHMubGVuZ3RoID4gMCkge1xuICAgICAgZGF0YUlkcyA9IGRhdGFJZHMuc3BsaXQoJywnKS5maWx0ZXIocCA9PiBwKTtcbiAgICB9XG4gICAgaWYgKCFkYXRhSWRzIHx8IEFycmF5LmlzQXJyYXkoZGF0YUlkcykgPT09IGZhbHNlIHx8IGRhdGFJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNTZWxlY3REb3dubG9hZEF0dCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICAgIGNvbnN0IGlkcyA9IFtdLmNvbmNhdChkYXRhSWRzKTtcbiAgICBjb25zdCBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBpZHMpO1xuICAgIGlmIChhdHRhY2hJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub0Rvd25sb2FkQXR0LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5iYXRjaERvd25sb2FkKGF0dGFjaElkcywgcm9vdElkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmoLnmja7pmYTku7ZVRFTlrZfmrrXnmoTot6/lvoTpooTop4jpmYTku7ZcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tlVEVOWtl+autXBhdGhcbiAgICogQHBhcmFtIHJvb3REaXJJZCDot5/nm67lvZVpZFxuICAgKiBAcGFyYW0gaWRzIOmZhOS7tmlkXG4gICAqL1xuICBwdWJsaWMgcHJldmlld0J5QXR0YWNobWVudEluZm9GaWVsZFBhdGgoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkOiBzdHJpbmcsIGlkcz86IGFueSkge1xuICAgIGlmICghYXR0YWNobWVudEluZm9GaWVsZFBhdGggfHwgIXJvb3REaXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdhdHRhY2htZW50SW5mb0ZpZWxkUGF0aOWSjHJvb3REaXJJZOS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xuICAgIH1cbiAgICBsZXQgYXR0YWNoSWRzID0gW107XG4gICAgbGV0IGRhdGFJZHMgPSBbXTtcbiAgICBpZiAoaWRzICYmIGlkcy5sZW5ndGggPiAwKSB7XG4gICAgICBpZiAodHlwZW9mIChpZHMpID09PSAnc3RyaW5nJykge1xuICAgICAgICBkYXRhSWRzLnB1c2goaWRzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGFJZHMgPSBpZHM7XG4gICAgICB9XG4gICAgICBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBkYXRhSWRzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXR0YWNoSWRzID0gdGhpcy5nZXRBdHRhY2htZW50SWRzQnlQYXRoQW5kRGF0YUlkcyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgbnVsbCk7XG4gICAgfVxuICAgIGlmIChhdHRhY2hJZHMgJiYgYXR0YWNoSWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2Uubm9BdHRhY2htZW50LCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucHJldmlld0J5QXR0YWNobWVudElkcyhhdHRhY2hJZHMsIHJvb3REaXJJZCk7XG4gIH1cbiAgLyoqXG4gICAqIOagueaNrumZhOS7tlVEVOWtl+auteeahOi3r+W+hOmihOiniOW9k+WJjeihjOeahOmZhOS7tlxuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm9GaWVsZFBhdGgg6ZmE5Lu2VURU5a2X5q61cGF0aFxuICAgKiBAcGFyYW0gcm9vdERpcklkIOagueebruW9lWlkXG4gICAqL1xuICBwdWJsaWMgcHJldmlld0J5QXR0YWNobWVudEluZm9GaWVsZFBhdGhXaXRoSW5kZXgoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgcm9vdERpcklkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICghYXR0YWNobWVudEluZm9GaWVsZFBhdGggfHwgIXJvb3REaXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdhdHRhY2htZW50SW5mb0ZpZWxkUGF0aOWSjHJvb3REaXJJZOS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xuICAgIH1cbiAgICBjb25zdCBjdXJyZW50Um93ID0gdGhpcy5nZXRDdXJyZW50Um93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGROYW1lID0gcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcbiAgICBpZiAoIWN1cnJlbnRSb3dbYXR0YWNobWVudEZpZWxkTmFtZV0gfHwgIWN1cnJlbnRSb3dbYXR0YWNobWVudEZpZWxkTmFtZV1bJ2F0dGFjaG1lbnRJZCddKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub0F0dGFjaG1lbnQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBudWxsKTtcbiAgICBpZiAoYXR0YWNoSWRzICYmIGF0dGFjaElkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRoaXMubm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm5vQXR0YWNobWVudCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IHRoaXMuZ2V0Q3VycmVudEF0dGFjaG1lbnRJZChhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgaWYgKCFhdHRhY2htZW50SWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcign6KaB6aKE6KeI55qE6ZmE5Lu2aWTkuI3lrZjlnKjvvIzor7fnoa7orqQnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMucHJldmlld0ZpbGVMaXN0V2l0aEluZGV4KGF0dGFjaElkcywgcm9vdERpcklkLCBhdHRhY2htZW50SWQpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog5qC55o2u55uu5b2V6aKE6KeI6ZmE5Lu2XG4gICAqIEBwYXJhbSBzdWJEaXJOYW1lIOeItuebruW9leWQjeensFxuICAgKiBAcGFyYW0gcm9vdERpcklkIOagueebruW9lWlkXG4gICAqL1xuICBwdWJsaWMgcHJldmlld0J5U3ViRGlyTmFtZShzdWJEaXJOYW1lOiBzdHJpbmcsIHJvb3REaXJJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAoIXN1YkRpck5hbWUgfHwgIXJvb3REaXJJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzdWJEaXJOYW1l5ZKMcm9vdERpcklk5LiN6IO95Li656m677yM6K+35aGr5YaZJyk7XG4gICAgfVxuICAgIGNvbnN0IHZpZXdlciQgPSBmcm9tKHRoaXMuZmlsZVZpZXdlclNlcnZpY2Uudmlld2VyRm9ybUZpbGUoc3ViRGlyTmFtZSwgcm9vdERpcklkKSk7XG4gICAgcmV0dXJuIHZpZXdlciQ7XG4gIH1cbiAgLyoqXG4gICAqIOagueaNruebruW9lemihOiniOaMh+Wumue0ouW8leeahOmZhOS7tlxuICAgKiBAcGFyYW0gYXR0YWNobWVudEluZm9GaWVsZFBhdGgg6ZmE5Lu2VURU5a2X5q61cGF0aFxuICAgKiBAcGFyYW0gc3ViRGlyTmFtZSDlrZDnm67lvZXlkI3np7BcbiAgICogQHBhcmFtIHJvb3REaXJJZCDmoLnnm67lvZVpZFxuICAgKi9cbiAgcHVibGljIHByZXZpZXdCeVN1YkRpck5hbWVXaXRoSW5kZXgoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgc3ViRGlyTmFtZTogc3RyaW5nLCByb290RGlySWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKCFzdWJEaXJOYW1lIHx8ICFyb290RGlySWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignc3ViRGlyTmFtZeWSjHJvb3REaXJJZOS4jeiDveS4uuepuu+8jOivt+Whq+WGmScpO1xuICAgIH1cbiAgICAvLyBjb25zdCBhdHRhY2hJZHMgPSB0aGlzLmdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBudWxsKTtcbiAgICBjb25zdCBhdHRhY2htZW50SWQgPSB0aGlzLmdldEN1cnJlbnRBdHRhY2htZW50SWQoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xuICAgIGlmICghYXR0YWNobWVudElkKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5ub0F0dGFjaG1lbnQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCB2aWV3ZXIkID0gZnJvbSh0aGlzLmZpbGVWaWV3ZXJTZXJ2aWNlLnZpZXdlckZvcm1GaWxlV2l0aEluZGV4KHN1YkRpck5hbWUsIHJvb3REaXJJZCwgYXR0YWNobWVudElkKSk7XG4gICAgcmV0dXJuIHZpZXdlciQ7XG4gIH1cbiAgLyoqXG4gICAqIOagueaNrumZhOS7tmlk5pWw57uE6aKE6KeI6ZmE5Lu2XG4gICAqIEBwYXJhbSBhdHRhY2htZW50SWRzIOmZhOS7tmlk5pWw57uEXG4gICAqIEBwYXJhbSByb290RGlySWQg5qC555uu5b2VaWRcbiAgICovXG4gIHB1YmxpYyBwcmV2aWV3QnlBdHRhY2htZW50SWRzKGF0dGFjaG1lbnRJZHM6IHN0cmluZ1tdLCByb290RGlySWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3Qgdmlld2VyJCA9IGZyb20odGhpcy5maWxlVmlld2VyU2VydmljZS52aWV3ZXJGaWxlTGlzdChhdHRhY2htZW50SWRzLCByb290RGlySWQpKTtcbiAgICByZXR1cm4gdmlld2VyJDtcbiAgfVxuICAvKipcbiAgICog5qC55o2u6ZmE5Lu2aWTmlbDnu4TpooTop4jmjIflrprntKLlvJXnmoTpmYTku7ZcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJZHMg6ZmE5Lu2aWTmlbDnu4RcbiAgICogQHBhcmFtIHJvb3REaXJJZCDmoLnnm67lvZVpZFxuICAgKiBAcGFyYW0gYXR0YWNobWVudElkIOmZhOS7tklkXG4gICAqL1xuICBwdWJsaWMgcHJldmlld0ZpbGVMaXN0V2l0aEluZGV4KGF0dGFjaG1lbnRJZHM6IHN0cmluZ1tdLCByb290RGlySWQ6IHN0cmluZywgYXR0YWNobWVudElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB2aWV3ZXIkID0gZnJvbSh0aGlzLmZpbGVWaWV3ZXJTZXJ2aWNlLnZpZXdlckZpbGVMaXN0V2l0aEluZGV4KGF0dGFjaG1lbnRJZHMsIHJvb3REaXJJZCwgYXR0YWNobWVudElkKSk7XG4gICAgcmV0dXJuIHZpZXdlciQ7XG4gIH1cbiAgLyoqXG4gICAqIOeUn+aIkOeJiOacrOWPt1xuICAgKiBAcGFyYW0gdmVyc2lvbnMg5Y6G5Y+y54mI5pys5Y+3XG4gICAqIEBkZXNjcmlwdGlvbiDpu5jorqTnvJbnoIHop4TliJl2MS4wIHYyLjAgLi4uXG4gICAqL1xuICBwdWJsaWMgZ2VuVmVyc2lvbih2ZXJzaW9uczogc3RyaW5nW10pIHtcbiAgICBpZiAoIXZlcnNpb25zKSB7XG4gICAgICB2ZXJzaW9ucyA9IFtdO1xuICAgIH1cbiAgICBjb25zdCBtYWluQ29kZSA9IHZlcnNpb25zLmxlbmd0aCArIDE7XG4gICAgcmV0dXJuIGBWJHttYWluQ29kZX0uMGA7XG4gIH1cbiAgLyoqXG4gICAqIOabtOaWsOmZhOS7tueJiOacrOS/oeaBr1xuICAgKiBAcGFyYW0gdmVyc2lvbkZpZWxkIOmZhOS7tueJiOacrOWtl+autVxuICAgKiBAcGFyYW0gaGlzdG9yeUZpZWxkIOaYr+WQpuWOhuWPsueJiOacrOWtl+autVxuICAgKiBAcGFyYW0gYXR0YWNobWVudEZpZWxkUGF0aCDpmYTku7Z1ZHTlrZfmrrXot6/lvoRcbiAgICovXG4gIHB1YmxpYyB1cGRhdGVBdHRhY2htZW50VmVyc2lvbih2ZXJzaW9uRmllbGQ6IHN0cmluZywgaGlzdG9yeUZpZWxkOiBzdHJpbmcsIGF0dGFjaG1lbnRGaWVsZFBhdGg6IHN0cmluZykge1xuICAgIC8qKlxuICAgICAqIOmBjeWOhuaJgOaciemZhOS7tuihjFxuICAgICAqIOaJvuWIsOaJgOacieayoeaciemZhOS7tueJiOacrOeahOihjFxuICAgICAqIOmBjeWOhui/meS6m+ihjFxuICAgICAqIOmAmui/h+aWh+S7tuWQjeWOu+afpeaJvuWQjOWQjeeahOS4lOaciemZhOS7tueJiOacrOWPt+eahOihjCBcbiAgICAgKiDov5nkupvooYzljoblj7LniYjmnKzlrZfmrrXnva7kuLp0cnVlXG4gICAgICog5peg54mI5pys5Y+355qE6KGM77yM54mI5pysPSDkuIrooYzmlbAgKyAxXG4gICAgICogXG4gICAgICovXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYXR0YWNobWVudEZpZWxkUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIC8vIOW8ueWHuumZhOS7tnVkdOWtl+autVxuICAgIGNvbnN0IGF0dGFjaG1lbnRGaWVsZCA9IGJpbmRpbmdQYXRocy5wb3AoKTtcbiAgICAvLyDojrflj5bliLDmiYDmnInnmoTpmYTku7ZcbiAgICBjb25zdCBhdHRhY2htZW50QmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICBjb25zdCBlbnRpdHlNYW5hZ2VyID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyO1xuICAgIGNvbnN0IGRhdGFQYXRoID0gRGF0YVBhdGhDcmVhdG9yLmNyZWF0ZUJ5U2hvcnRQYXRoRnJvbVJvb3QoYmluZGluZ1BhdGhzLCBlbnRpdHlNYW5hZ2VyLCB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YSk7XG4gICAgY29uc3QgcGF0aHMgPSBkYXRhUGF0aC50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmIChwYXRoLnN0YXJ0c1dpdGgoJ1Byb3BOYW1lOicpKSB7XG4gICAgICAgIHJldHVybiBwYXRoLnNwbGl0KCc6JylbMV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gcGF0aDtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoYXR0YWNobWVudEJpbmRpbmdMaXN0KSB7XG4gICAgICBjb25zdCBhdHRhY2htZW50cyA9IGF0dGFjaG1lbnRCaW5kaW5nTGlzdC50b0pTT04oKTtcbiAgICAgIC8vIOWPquWkhOeQhuaciemZhOS7tueahOaDheWGtVxuICAgICAgaWYgKGF0dGFjaG1lbnRzKSB7XG4gICAgICAgIGNvbnN0IHZlcnNpb25MZXNzUm93cyA9IGF0dGFjaG1lbnRzLmZpbHRlcihpdGVtID0+ICFpdGVtW3ZlcnNpb25GaWVsZF0pO1xuICAgICAgICB2ZXJzaW9uTGVzc1Jvd3MuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9IGl0ZW1bYXR0YWNobWVudEZpZWxkXVsnZmlsZU5hbWUnXTtcbiAgICAgICAgICBjb25zdCB2ZXJzaW9uZWRSb3dzID0gYXR0YWNobWVudHMuZmlsdGVyKHJvdyA9PiByb3dbYXR0YWNobWVudEZpZWxkXVsnZmlsZU5hbWUnXSA9PT0gZmlsZU5hbWUgJiYgcm93W3ZlcnNpb25GaWVsZF0pO1xuICAgICAgICAgIHBhdGhzLnBvcCgpO1xuICAgICAgICAgIHBhdGhzLnB1c2goYERhdGFJZDoke2l0ZW1bYXR0YWNobWVudEJpbmRpbmdMaXN0LnByaW1hcnlLZXldfWApO1xuICAgICAgICAgIGxldCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlQYXRoKHBhdGhzKTtcbiAgICAgICAgICBjb25zdCB2ZXJzaW9uID0gdGhpcy5nZW5WZXJzaW9uKHZlcnNpb25lZFJvd3MpO1xuICAgICAgICAgIGVudGl0eVt2ZXJzaW9uRmllbGRdID0gdmVyc2lvbjtcbiAgICAgICAgICBlbnRpdHlbaGlzdG9yeUZpZWxkXSA9IGZhbHNlO1xuICAgICAgICAgIC8vIOWkhOeQhuWOhuWPsuiusOW9lVxuICAgICAgICAgIHZlcnNpb25lZFJvd3MuZm9yRWFjaChyb3cgPT4ge1xuICAgICAgICAgICAgcGF0aHMucG9wKCk7XG4gICAgICAgICAgICBwYXRocy5wdXNoKGBEYXRhSWQ6JHtyb3dbYXR0YWNobWVudEJpbmRpbmdMaXN0LnByaW1hcnlLZXldfWApO1xuICAgICAgICAgICAgZW50aXR5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5UGF0aChwYXRocyk7XG4gICAgICAgICAgICBlbnRpdHlbaGlzdG9yeUZpZWxkXSA9IHRydWU7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBwdWJsaWMgaXNBdHRhY2htZW50Q2FuRGVsZXRlKGhpc3RvcnlGaWVsZDogc3RyaW5nLCBhdHRhY2htZW50RmllbGRQYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBhdHRhY2htZW50RmllbGRQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgLy8g5by55Ye66ZmE5Lu2dWR05a2X5q61XG4gICAgYmluZGluZ1BhdGhzLnBvcCgpO1xuICAgIGNvbnN0IGF0dGFjaG1lbnRCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IGF0dGFjaG1lbnRCaW5kaW5nTGlzdC5jdXJyZW50SXRlbTtcbiAgICBpZiAoYmluZGluZ09iamVjdFtoaXN0b3J5RmllbGRdID09PSB0cnVlKSB7XG4gICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5oaXN0b3J5QXR0YWNobWVudCwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyB1cGRhdGVBdHRhY2htZW50SGlzdG9yeSh2ZXJzaW9uRmllbGQ6IHN0cmluZywgaGlzdG9yeUZpZWxkOiBzdHJpbmcsIGF0dGFjaG1lbnRGaWVsZFBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGF0dGFjaG1lbnRGaWVsZFBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAvLyDlvLnlh7rpmYTku7Z1ZHTlrZfmrrVcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGQgPSBiaW5kaW5nUGF0aHMucG9wKCk7XG4gICAgLy8g6I635Y+W5Yiw5omA5pyJ55qE6ZmE5Lu2XG4gICAgY29uc3QgYXR0YWNobWVudEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAvLyBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XG4gICAgLy8gY29uc3QgZW50aXR5TWFuYWdlciA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlcjtcbiAgICBpZiAoYXR0YWNobWVudEJpbmRpbmdMaXN0KSB7XG4gICAgICBjb25zdCBhdHRhY2htZW50cyA9IGF0dGFjaG1lbnRCaW5kaW5nTGlzdC50b0pTT04oKTtcbiAgICAgIGNvbnN0IHZlcnNpb25lZFJvd3MgPSBhdHRhY2htZW50cy5maWx0ZXIoaXRlbSA9PiBpdGVtW3ZlcnNpb25GaWVsZF0pO1xuICAgICAgY29uc3QgZmlsZU5hbWVNYXAgPSBuZXcgTWFwPHN0cmluZywgQXJyYXk8YW55Pj4oKTtcbiAgICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICAgIGNvbnN0IGVudGl0eU1hbmFnZXIgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXI7XG4gICAgICBjb25zdCBkYXRhUGF0aCA9IERhdGFQYXRoQ3JlYXRvci5jcmVhdGVCeVNob3J0UGF0aEZyb21Sb290KGJpbmRpbmdQYXRocywgZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpO1xuICAgICAgY29uc3QgcGF0aHMgPSBkYXRhUGF0aC50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKHBhdGguc3RhcnRzV2l0aCgnUHJvcE5hbWU6JykpIHtcbiAgICAgICAgICByZXR1cm4gcGF0aC5zcGxpdCgnOicpWzFdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBwYXRoO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHZlcnNpb25lZFJvd3MuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgY29uc3QgZmlsZU5hbWUgPSBpdGVtW2F0dGFjaG1lbnRGaWVsZF1bJ2ZpbGVOYW1lJ107XG4gICAgICAgIGlmIChmaWxlTmFtZU1hcC5oYXMoZmlsZU5hbWUpKSB7XG4gICAgICAgICAgZmlsZU5hbWVNYXAuZ2V0KGZpbGVOYW1lKS5wdXNoKGl0ZW0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZpbGVOYW1lTWFwLnNldChmaWxlTmFtZSwgW2l0ZW1dKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBBcnJheS5mcm9tKGZpbGVOYW1lTWFwLnZhbHVlcygpKS5mb3JFYWNoKChhcnJheTogQXJyYXk8YW55PikgPT4ge1xuICAgICAgICBhcnJheS5zb3J0KCh4LCB5KSA9PiB7XG4gICAgICAgICAgY29uc3QgeFZlcnNpb24gPSBwYXJzZUludCh4W3ZlcnNpb25GaWVsZF0ucmVwbGFjZSgvW2EtekEtWlxcLl0vZywgJycpKTtcbiAgICAgICAgICBjb25zdCB5VmVyc2lvbiA9IHBhcnNlSW50KHlbdmVyc2lvbkZpZWxkXS5yZXBsYWNlKC9bYS16QS1aXFwuXS9nLCAnJykpO1xuICAgICAgICAgIHJldHVybiB5VmVyc2lvbiAtIHhWZXJzaW9uO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3Qgcm93ID0gYXJyYXlbMF07XG4gICAgICAgIHBhdGhzLnBvcCgpO1xuICAgICAgICBwYXRocy5wdXNoKGBEYXRhSWQ6JHtyb3dbYXR0YWNobWVudEJpbmRpbmdMaXN0LnByaW1hcnlLZXldfWApO1xuICAgICAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlQYXRoKHBhdGhzKTtcbiAgICAgICAgZW50aXR5W2hpc3RvcnlGaWVsZF0gPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6I635Y+W5b2T5YmN6KeG5Zu+5qih5Z6L5b2T5YmN6KGM55qE6ZmE5Lu2aWRcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIOmZhOS7tnVkdOWtl+autVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRDdXJyZW50QXR0YWNobWVudElkKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBjb25zdCBhdHRhY2htZW50RmllbGROYW1lID0gcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcbiAgICBjb25zdCBiaW5kaW5nTGlzdDogQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXJlbnRCaW5kaW5nUGF0aEFycmF5KSBhcyBCaW5kaW5nTGlzdDtcbiAgICBjb25zdCBjdXJyZW50SXRlbSA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xuICAgIGlmIChjdXJyZW50SXRlbSAmJiBjdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUpIHtcbiAgICAgIHJldHVybiBjdXJyZW50SXRlbVthdHRhY2htZW50RmllbGROYW1lXSAmJiBjdXJyZW50SXRlbVthdHRhY2htZW50RmllbGROYW1lXVsnYXR0YWNobWVudElkJ10gfHwgbnVsbDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDojrflj5blvZPliY3ooYxcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIHVkdOWtl+autVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRDdXJyZW50Um93KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xuICAgIGNvbnN0IGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhcmVudEJpbmRpbmdQYXRoQXJyYXkpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGNvbnN0IGN1cnJlbnRJdGVtID0gYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QuY3VycmVudEl0ZW07XG4gICAgcmV0dXJuIGN1cnJlbnRJdGVtO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bmjIflrprpmYTku7bkv6Hmga/ooajnmoTmjIflrprooYxcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoIFxuICAgKiBAcGFyYW0gcHJpbWFyeVZhbHVlIFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByaXZhdGUgZ2V0U3BlY2lhbFJvdyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBwcmltYXJ5VmFsdWU6IHN0cmluZykge1xuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xuICAgIHBhcmVudEJpbmRpbmdQYXRoQXJyYXkucG9wKCk7XG4gICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGFyZW50QmluZGluZ1BhdGhBcnJheSkgYXMgQmluZGluZ0xpc3Q7XG4gICAgY29uc3QgY3VycmVudEl0ZW0gPSBiaW5kaW5nTGlzdCAmJiBiaW5kaW5nTGlzdC5maW5kQnlJZChwcmltYXJ5VmFsdWUpO1xuICAgIHJldHVybiBjdXJyZW50SXRlbTtcbiAgfVxuICAvKipcbiAgICog6I635Y+WZGF0YUlkc+WvueW6lEVudGl0eeS4iueahOmZhOS7tmlk5pWw57uEXG4gICAqL1xuICBwcml2YXRlIGdldEF0dGFjaG1lbnRJZHNCeVBhdGhBbmREYXRhSWRzKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGRhdGFJZHM/OiBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcblxuICAgIC8vIOino+aekOi3r+W+hFxuICAgIGNvbnN0IHBhcmVudEJpbmRpbmdQYXRoQXJyYXkgPSBCaW5kaW5nUGF0aENvbnZlcnRlci50b0JpbmRpbmdQYXRoQXJyYXkoYXR0YWNobWVudEluZm9GaWVsZFBhdGgpO1xuICAgIGNvbnN0IGF0dGFjaG1lbnRGaWVsZE5hbWUgPSBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xuXG4gICAgLy8g6I635Y+W6ZmE5Lu25omA5Zyo5a6e5L2T55qE5pWw5o2u5YiX6KGo77yM5LiN5Lyg6YCSZGF0YUlkc+WPguaVsO+8jOWImei/lOWbnuWFqOmDqFxuICAgIGNvbnN0IGVudGl0eUxpc3REYXRhID0gdGhpcy5lbnRpdHlTZXJ2aWNlLmdldEVudGl0eUxpc3REYXRhKHBhcmVudEJpbmRpbmdQYXRoQXJyYXkpO1xuICAgIGxldCBmaWx0ZXJlZEVudGl0eUxpc3REYXRhID0gW107XG4gICAgaWYgKGRhdGFJZHMgJiYgQXJyYXkuaXNBcnJheShkYXRhSWRzKSA9PT0gdHJ1ZSkge1xuICAgICAgZmlsdGVyZWRFbnRpdHlMaXN0RGF0YSA9IGVudGl0eUxpc3REYXRhLmZpbHRlcigoZW50aXR5RGF0YTogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiBkYXRhSWRzLmluZGV4T2YoZW50aXR5RGF0YS5pZCkgPiAtMTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBmaWx0ZXJlZEVudGl0eUxpc3REYXRhID0gZW50aXR5TGlzdERhdGE7XG4gICAgfVxuXG4gICAgLy8g6L2s5o2i5Li66ZmE5Lu2SWTmlbDnu4RcbiAgICBjb25zdCBhdHRhY2htZW50SWRzID0gW107XG4gICAgZmlsdGVyZWRFbnRpdHlMaXN0RGF0YS5mb3JFYWNoKChlbnRpdHlEYXRhOiBhbnkpID0+IHtcbiAgICAgIGlmIChlbnRpdHlEYXRhW2F0dGFjaG1lbnRGaWVsZE5hbWVdKSB7XG4gICAgICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IGVudGl0eURhdGFbYXR0YWNobWVudEZpZWxkTmFtZV1bJ2F0dGFjaG1lbnRJZCddO1xuICAgICAgICBpZiAoYXR0YWNobWVudElkKSB7XG4gICAgICAgICAgYXR0YWNobWVudElkcy5wdXNoKGF0dGFjaG1lbnRJZCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBhdHRhY2htZW50SWRzO1xuICB9XG59XG5cbmV4cG9ydCB7IEF0dGFjaG1lbnRTZXJ2aWNlIH07XG4iXX0=