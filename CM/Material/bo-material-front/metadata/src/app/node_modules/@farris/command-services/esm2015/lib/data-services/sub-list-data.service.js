import { Injectable, Optional } from '@angular/core';
import { empty, of, EMPTY } from 'rxjs';
import { tap, switchMap, concatMap } from 'rxjs/operators';
import { Repository, ViewModel } from '@farris/devkit';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { FormNotifyService } from '../form-notify.service';
import { LanguageService } from '../languag.service';
import { FormMessageService } from '../form-message.service';
import { FormErrorService } from '../error/form-error.service';
/**
 * 子列表取数服务
 */
class SubListDataService {
    /**
     * 构造函数
     */
    constructor(msgService, repository, loadingService, viewModel, languageService, formNotifyService, formErrorService) {
        this.msgService = msgService;
        this.repository = repository;
        this.loadingService = loadingService;
        this.viewModel = viewModel;
        this.languageService = languageService;
        this.formNotifyService = formNotifyService;
        this.formErrorService = formErrorService;
        if (!languageService) {
            this.languageService = LanguageService.getInstance();
        }
        this.viewModel = viewModel;
    }
    /**
     * 新增
     */
    add() {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'add' });
        }
        const path = this.getPath();
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const append$ = this.repository.appendByPath(path);
        return append$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, error => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.addFailed, error);
        }));
    }
    /**
     * 在指定位置插入
     * @param position 位置
     */
    insert(position = -1) {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'insert' });
        }
        const path = this.getPath();
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const append$ = this.repository.insertByPath(path, position);
        return append$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, error => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.addFailed, error);
        }));
    }
    /**
     * 删除子表数据
     */
    remove(id, successMsg) {
        const msg = successMsg ? successMsg : '';
        return this.innerRemove(id, false, msg);
    }
    /**
     * 删除子表数据（不确认）
     */
    removeWithoutConfirm(id) {
        return this.innerRemove(id, true, '');
    }
    /**
     * 批量删除子表
     * @param ids ids
     * @param successMsg 自定义提示信息
     */
    removeChildrenByIds(ids, successMsg) {
        if (!ids) {
            this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
            return EMPTY;
        }
        const action$ = this.msgService.confirm(this.languageService.confirmDeletion);
        return action$.pipe(concatMap(result => {
            if (!result) {
                return EMPTY;
            }
            const path = this.getPath();
            const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
            const remove$ = this.repository.batchRemoveByPath(path, ids);
            return remove$.pipe(tap(() => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, error => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                this.formErrorService.exception(this.languageService.deleteFailed, error);
            }));
        }));
    }
    /**
     * 删除
     */
    innerRemove(id, isConfirm, successMsg) {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'remove' });
        }
        if (!id) {
            this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
            return empty();
        }
        let action$;
        if (isConfirm === false) {
            action$ = this.msgService.question(this.languageService.confirmDeletion);
        }
        else {
            action$ = of(true);
        }
        return action$.pipe(concatMap(result => {
            if (!result) {
                return empty();
            }
            const path = this.getPath();
            const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
            const remove$ = this.repository.removeByPath(path, id);
            return remove$.pipe(tap(() => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, error => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                this.formErrorService.exception(this.languageService.deleteFailed, error);
            }));
        }));
    }
    /**
     * 删除并保存
     * @param id id
     * @param successMsg 自定义提示信息
     */
    removeAndSave(id, successMsg) {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'removeAndSave' });
        }
        if (!id) {
            this.formNotifyService.warning(this.languageService.plsSelectDeleteData, { hideTitle: true });
            return empty();
        }
        const action$ = this.msgService.confirm(this.languageService.confirmDeletion);
        return action$.pipe(concatMap(result => {
            if (!result) {
                return empty();
            }
            // 删除子表数据
            const path = this.getPath();
            const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
            const remove$ = this.repository.removeByPath(path, id);
            return remove$.pipe(
            // 执行主表保存
            switchMap(() => {
                const fid = this.viewModel.bindingData.list.currentId;
                return this.repository.applyChangesById(fid);
            }), 
            // 隐藏加载中
            tap(() => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, error => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                this.formErrorService.exception(this.languageService.deleteFailed, error);
            }));
        }));
    }
    /**
     * 上移或下移数据
     * @param direction 方向，up | down
     * @param field 排序字段
     * @param targets 要移动的数据
     * @description
     * 使用该方法时排序字段必须有值，否则无法排序
     */
    move(direction, field, targets) {
        if (!targets) {
            return;
        }
        if (typeof targets === 'string') {
            targets = targets.split(',').filter(p => p);
        }
        const bindingPath = this.viewModel && this.viewModel.bindingPath || null;
        if (!bindingPath) {
            return;
        }
        const bindingList = this.viewModel.bindingData.getList();
        if (!bindingList || bindingList.length < 1) {
            return;
        }
        targets.forEach((target) => {
            const index = bindingList.getIndexById(target);
            if (index === -1) {
                return;
            }
            const item = bindingList.findById(target);
            const position = item.getValue(field);
            const base = direction === 'up' ? -1 : 1;
            // 待交换的行信息
            const exchangeRowIndex = index + base;
            if (exchangeRowIndex < 0 || exchangeRowIndex > bindingList.length) {
                // 第一行无法上移，最后一行无法下移
                return;
            }
            const exchangeRowId = bindingList.getIdByIndex(exchangeRowIndex);
            const exchangeRow = bindingList.findById(exchangeRowId);
            const exchangeRowPosition = exchangeRow[field];
            // 移动行和交换行都没有排序
            if (this.isNullOrEmpty(position) && this.isNullOrEmpty(exchangeRowPosition)) {
                return;
            }
            bindingList.swapById(target, exchangeRowId);
            exchangeRow.setValue(field, position, true, true);
            item.setValue(field, exchangeRowPosition, true, true);
        });
    }
    isNullOrEmpty(value) {
        return value === '' || value === null || value === undefined;
    }
    /**
     * 获取完整路径
     * @todo：强识别到从表这一级
     * fixed by justin: 根据bindingPath，如果是从从表，需要获取主表数据id和从表数据id
     */
    getPath() {
        const bindingPath = this.viewModel.bindingPath;
        const rid = this.viewModel.bindingData.list.currentId; // root表数据id
        let path = '/' + rid;
        const subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (let index = 1; index < subPaths.length - 1; index++) {
                const subPath = subPaths[index];
                const subData = this.viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    this.formNotifyService.warning(this.languageService['plsSelectDetailFormData'], { hideTitle: true });
                    throw Error(`获取子表完整路径出错，找不到${subData}对应的子表，或对应子表没有当前行。`);
                }
                path += `/${subPath}/${subData.currentId}`;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    }
    /**
     * 获取根组件appContext
     */
    get messagePipe() {
        if (this.viewModel && this.viewModel.frameContext) {
            const appContext = this.viewModel.frameContext.getFormAppContext() || null;
            if (appContext) {
                return appContext.messagePipe || null;
            }
        }
        return null;
    }
}
SubListDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SubListDataService.ctorParameters = () => [
    { type: FormMessageService },
    { type: Repository },
    { type: FormLoadingService },
    { type: ViewModel },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: FormNotifyService },
    { type: FormErrorService }
];
export { SubListDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViLWxpc3QtZGF0YS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2RhdGEtc2VydmljZXMvc3ViLWxpc3QtZGF0YS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBYyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNwRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzRCxPQUFPLEVBQWUsVUFBVSxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUUvRDs7R0FFRztBQUNILE1BQ00sa0JBQWtCO0lBRXRCOztPQUVHO0lBQ0gsWUFDVSxVQUE4QixFQUM5QixVQUEyQixFQUMzQixjQUFrQyxFQUNsQyxTQUFvQixFQUNSLGVBQWdDLEVBQzVDLGlCQUFvQyxFQUNwQyxnQkFBa0M7UUFObEMsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFDOUIsZUFBVSxHQUFWLFVBQVUsQ0FBaUI7UUFDM0IsbUJBQWMsR0FBZCxjQUFjLENBQW9CO1FBQ2xDLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFDUixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDNUMsc0JBQWlC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LEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ3JHLE1BQU0sS0FBSyxDQUFDLGlCQUFpQixPQUFPLG1CQUFtQixDQUFDLENBQUM7aUJBQzFEO2dCQUNELElBQUksSUFBSSxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7YUFDNUM7U0FDRjtRQUNELElBQUksSUFBSSxHQUFHLEdBQUcsUUFBUSxDQUFDLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFFNUMsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBQ0Q7O09BRUc7SUFDSCxJQUFZLFdBQVc7UUFDckIsSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFO1lBQ2pELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLGlCQUFpQixFQUFFLElBQUksSUFBSSxDQUFDO1lBQzNFLElBQUksVUFBVSxFQUFFO2dCQUNkLE9BQU8sVUFBVSxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUM7YUFDdkM7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7O1lBcFRGLFVBQVU7Ozs7WUFORixrQkFBa0I7WUFKTCxVQUFVO1lBQ3ZCLGtCQUFrQjtZQURPLFNBQVM7WUFHbEMsZUFBZSx1QkFrQm5CLFFBQVE7WUFuQkosaUJBQWlCO1lBR2pCLGdCQUFnQjs7QUEyVHpCLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGVtcHR5LCBvZiwgRU1QVFkgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCwgc3dpdGNoTWFwLCBjb25jYXRNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBCaW5kaW5nTGlzdCwgUmVwb3NpdG9yeSwgVmlld01vZGVsIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1ub3RpZnkuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi9sYW5ndWFnLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1tZXNzYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUVycm9yU2VydmljZSB9IGZyb20gJy4uL2Vycm9yL2Zvcm0tZXJyb3Iuc2VydmljZSc7XG5cbi8qKlxuICog5a2Q5YiX6KGo5Y+W5pWw5pyN5YqhXG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIFN1Ykxpc3REYXRhU2VydmljZSB7XG5cbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLFxuICAgIHByaXZhdGUgdmlld01vZGVsOiBWaWV3TW9kZWwsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcbiAgICBwcml2YXRlIGZvcm1Ob3RpZnlTZXJ2aWNlOiBGb3JtTm90aWZ5U2VydmljZSxcbiAgICBwcml2YXRlIGZvcm1FcnJvclNlcnZpY2U6IEZvcm1FcnJvclNlcnZpY2VcbiAgKSB7XG4gICAgaWYgKCFsYW5ndWFnZVNlcnZpY2UpIHtcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gTGFuZ3VhZ2VTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgfVxuICAgIHRoaXMudmlld01vZGVsID0gdmlld01vZGVsO1xuICB9XG5cbiAgLyoqXG4gICAqIOaWsOWinlxuICAgKi9cbiAgYWRkKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKHRoaXMubWVzc2FnZVBpcGUpIHtcbiAgICAgIHRoaXMubWVzc2FnZVBpcGUubmV4dCh7IG1lc3NhZ2VUeXBlOiAnYWRkJyB9KTtcbiAgICB9XG4gICAgY29uc3QgcGF0aCA9IHRoaXMuZ2V0UGF0aCgpO1xuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSg1MDApO1xuICAgIGNvbnN0IGFwcGVuZCQgPSB0aGlzLnJlcG9zaXRvcnkuYXBwZW5kQnlQYXRoKHBhdGgpO1xuICAgIHJldHVybiBhcHBlbmQkLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5hZGRGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOWcqOaMh+WumuS9jee9ruaPkuWFpVxuICAgKiBAcGFyYW0gcG9zaXRpb24g5L2N572uXG4gICAqL1xuICBwdWJsaWMgaW5zZXJ0KHBvc2l0aW9uOiAxIHwgLTEgPSAtMSkge1xuICAgIGlmICh0aGlzLm1lc3NhZ2VQaXBlKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VQaXBlLm5leHQoeyBtZXNzYWdlVHlwZTogJ2luc2VydCcgfSk7XG4gICAgfVxuICAgIGNvbnN0IHBhdGggPSB0aGlzLmdldFBhdGgoKTtcbiAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcbiAgICBjb25zdCBhcHBlbmQkID0gdGhpcy5yZXBvc2l0b3J5Lmluc2VydEJ5UGF0aChwYXRoLCBwb3NpdGlvbik7XG4gICAgcmV0dXJuIGFwcGVuZCQucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICB9LFxuICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFkZEZhaWxlZCwgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5Yig6Zmk5a2Q6KGo5pWw5o2uXG4gICAqL1xuICByZW1vdmUoaWQ6IHN0cmluZywgc3VjY2Vzc01zZz86IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgbXNnID0gc3VjY2Vzc01zZyA/IHN1Y2Nlc3NNc2cgOiAnJztcbiAgICByZXR1cm4gdGhpcy5pbm5lclJlbW92ZShpZCwgZmFsc2UsIG1zZyk7XG4gIH1cblxuICAvKipcbiAgICog5Yig6Zmk5a2Q6KGo5pWw5o2u77yI5LiN56Gu6K6k77yJXG4gICAqL1xuICByZW1vdmVXaXRob3V0Q29uZmlybShpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5pbm5lclJlbW92ZShpZCwgdHJ1ZSwgJycpO1xuICB9XG5cbiAgLyoqXG4gICAqIOaJuemHj+WIoOmZpOWtkOihqFxuICAgKiBAcGFyYW0gaWRzIGlkc1xuICAgKiBAcGFyYW0gc3VjY2Vzc01zZyDoh6rlrprkuYnmj5DnpLrkv6Hmga9cbiAgICovXG4gIHJlbW92ZUNoaWxkcmVuQnlJZHMoaWRzOiBzdHJpbmcsIHN1Y2Nlc3NNc2c/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICghaWRzKSB7XG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ3Bsc1NlbGVjdERlbGV0ZURhdGEnXSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICAgIGNvbnN0IGFjdGlvbiQgPSB0aGlzLm1zZ1NlcnZpY2UuY29uZmlybSh0aGlzLmxhbmd1YWdlU2VydmljZS5jb25maXJtRGVsZXRpb24pO1xuICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXG4gICAgICBjb25jYXRNYXAocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuZ2V0UGF0aCgpO1xuICAgICAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcbiAgICAgICAgY29uc3QgcmVtb3ZlJCA9IHRoaXMucmVwb3NpdG9yeS5iYXRjaFJlbW92ZUJ5UGF0aChwYXRoLCBpZHMpO1xuICAgICAgICByZXR1cm4gcmVtb3ZlJC5waXBlKFxuICAgICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgICAgaWYgKHN1Y2Nlc3NNc2cgJiYgc3VjY2Vzc01zZy50cmltKCkpIHtcbiAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHN1Y2Nlc3NNc2csIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlRmFpbGVkLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIoOmZpFxuICAgKi9cbiAgaW5uZXJSZW1vdmUoaWQ6IHN0cmluZywgaXNDb25maXJtOiBib29sZWFuLCBzdWNjZXNzTXNnOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICh0aGlzLm1lc3NhZ2VQaXBlKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VQaXBlLm5leHQoeyBtZXNzYWdlVHlwZTogJ3JlbW92ZScgfSk7XG4gICAgfVxuICAgIGlmICghaWQpIHtcbiAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZVsncGxzU2VsZWN0RGVsZXRlRGF0YSddLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgIH1cblxuICAgIGxldCBhY3Rpb24kOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICAgIGlmIChpc0NvbmZpcm0gPT09IGZhbHNlKSB7XG4gICAgICBhY3Rpb24kID0gdGhpcy5tc2dTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNvbmZpcm1EZWxldGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGFjdGlvbiQgPSBvZih0cnVlKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYWN0aW9uJC5waXBlKFxuICAgICAgY29uY2F0TWFwKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuZ2V0UGF0aCgpO1xuICAgICAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcbiAgICAgICAgY29uc3QgcmVtb3ZlJCA9IHRoaXMucmVwb3NpdG9yeS5yZW1vdmVCeVBhdGgocGF0aCwgaWQpO1xuICAgICAgICByZXR1cm4gcmVtb3ZlJC5waXBlKFxuICAgICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgICAgaWYgKHN1Y2Nlc3NNc2cgJiYgc3VjY2Vzc01zZy50cmltKCkpIHtcbiAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHN1Y2Nlc3NNc2csIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlRmFpbGVkLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIoOmZpOW5tuS/neWtmFxuICAgKiBAcGFyYW0gaWQgaWRcbiAgICogQHBhcmFtIHN1Y2Nlc3NNc2cg6Ieq5a6a5LmJ5o+Q56S65L+h5oGvXG4gICAqL1xuICByZW1vdmVBbmRTYXZlKGlkOiBzdHJpbmcsIHN1Y2Nlc3NNc2c/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICh0aGlzLm1lc3NhZ2VQaXBlKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VQaXBlLm5leHQoeyBtZXNzYWdlVHlwZTogJ3JlbW92ZUFuZFNhdmUnIH0pO1xuICAgIH1cbiAgICBpZiAoIWlkKSB7XG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGxzU2VsZWN0RGVsZXRlRGF0YSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICB9XG4gICAgY29uc3QgYWN0aW9uJCA9IHRoaXMubXNnU2VydmljZS5jb25maXJtKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNvbmZpcm1EZWxldGlvbik7XG4gICAgcmV0dXJuIGFjdGlvbiQucGlwZShcbiAgICAgIGNvbmNhdE1hcChyZXN1bHQgPT4ge1xuICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8g5Yig6Zmk5a2Q6KGo5pWw5o2uXG4gICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmdldFBhdGgoKTtcbiAgICAgICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XG4gICAgICAgIGNvbnN0IHJlbW92ZSQgPSB0aGlzLnJlcG9zaXRvcnkucmVtb3ZlQnlQYXRoKHBhdGgsIGlkKTtcblxuICAgICAgICByZXR1cm4gcmVtb3ZlJC5waXBlKFxuXG4gICAgICAgICAgLy8g5omn6KGM5Li76KGo5L+d5a2YXG4gICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpZCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkIGFzIHN0cmluZztcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnkuYXBwbHlDaGFuZ2VzQnlJZChmaWQpO1xuICAgICAgICAgIH0pLFxuXG4gICAgICAgICAgLy8g6ZqQ6JeP5Yqg6L295LitXG4gICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgICBpZiAoc3VjY2Vzc01zZyAmJiBzdWNjZXNzTXNnLnRyaW0oKSkge1xuICAgICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3Moc3VjY2Vzc01zZywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOS4iuenu+aIluS4i+enu+aVsOaNrlxuICAgKiBAcGFyYW0gZGlyZWN0aW9uIOaWueWQke+8jHVwIHwgZG93blxuICAgKiBAcGFyYW0gZmllbGQg5o6S5bqP5a2X5q61XG4gICAqIEBwYXJhbSB0YXJnZXRzIOimgeenu+WKqOeahOaVsOaNrlxuICAgKiBAZGVzY3JpcHRpb25cbiAgICog5L2/55So6K+l5pa55rOV5pe25o6S5bqP5a2X5q615b+F6aG75pyJ5YC877yM5ZCm5YiZ5peg5rOV5o6S5bqPXG4gICAqL1xuICBwdWJsaWMgbW92ZShkaXJlY3Rpb246IHN0cmluZyB8ICd1cCcgfCAnZG93bicsIGZpZWxkOiBzdHJpbmcsIHRhcmdldHM6IEFycmF5PGFueT4gfCBzdHJpbmcpIHtcbiAgICBpZiAoIXRhcmdldHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0YXJnZXRzID09PSAnc3RyaW5nJykge1xuICAgICAgdGFyZ2V0cyA9IHRhcmdldHMuc3BsaXQoJywnKS5maWx0ZXIocCA9PiBwKTtcbiAgICB9XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCBudWxsO1xuICAgIGlmICghYmluZGluZ1BhdGgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5nZXRMaXN0KCkgYXMgQmluZGluZ0xpc3Q7XG4gICAgaWYgKCFiaW5kaW5nTGlzdCB8fCBiaW5kaW5nTGlzdC5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRhcmdldHMuZm9yRWFjaCgodGFyZ2V0KSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IGJpbmRpbmdMaXN0LmdldEluZGV4QnlJZCh0YXJnZXQpO1xuICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBpdGVtID0gYmluZGluZ0xpc3QuZmluZEJ5SWQodGFyZ2V0KTtcbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gaXRlbS5nZXRWYWx1ZShmaWVsZCk7XG4gICAgICBjb25zdCBiYXNlID0gZGlyZWN0aW9uID09PSAndXAnICA/IC0xIDogMTtcbiAgICAgIC8vIOW+heS6pOaNoueahOihjOS/oeaBr1xuICAgICAgY29uc3QgZXhjaGFuZ2VSb3dJbmRleCA9IGluZGV4ICsgYmFzZTtcbiAgICAgIGlmIChleGNoYW5nZVJvd0luZGV4IDwgMCB8fCBleGNoYW5nZVJvd0luZGV4ID4gYmluZGluZ0xpc3QubGVuZ3RoKSB7XG4gICAgICAgIC8vIOesrOS4gOihjOaXoOazleS4iuenu++8jOacgOWQjuS4gOihjOaXoOazleS4i+enu1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBleGNoYW5nZVJvd0lkID0gYmluZGluZ0xpc3QuZ2V0SWRCeUluZGV4KGV4Y2hhbmdlUm93SW5kZXgpO1xuICAgICAgY29uc3QgZXhjaGFuZ2VSb3cgPSBiaW5kaW5nTGlzdC5maW5kQnlJZChleGNoYW5nZVJvd0lkKTtcbiAgICAgIGNvbnN0IGV4Y2hhbmdlUm93UG9zaXRpb24gPSBleGNoYW5nZVJvd1tmaWVsZF07XG4gICAgICAvLyDnp7vliqjooYzlkozkuqTmjaLooYzpg73msqHmnInmjpLluo9cbiAgICAgIGlmICh0aGlzLmlzTnVsbE9yRW1wdHkocG9zaXRpb24pICYmIHRoaXMuaXNOdWxsT3JFbXB0eShleGNoYW5nZVJvd1Bvc2l0aW9uKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBiaW5kaW5nTGlzdC5zd2FwQnlJZCh0YXJnZXQsIGV4Y2hhbmdlUm93SWQpO1xuICAgICAgZXhjaGFuZ2VSb3cuc2V0VmFsdWUoZmllbGQsIHBvc2l0aW9uLHRydWUsdHJ1ZSk7XG4gICAgICBpdGVtLnNldFZhbHVlKGZpZWxkLCBleGNoYW5nZVJvd1Bvc2l0aW9uLHRydWUsdHJ1ZSk7XG4gICAgfSk7XG5cbiAgfVxuICBwcml2YXRlIGlzTnVsbE9yRW1wdHkodmFsdWU6IGFueSkge1xuICAgIHJldHVybiB2YWx1ZSA9PT0gJycgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZDtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5a6M5pW06Lev5b6EXG4gICAqIEB0b2Rv77ya5by66K+G5Yir5Yiw5LuO6KGo6L+Z5LiA57qnXG4gICAqIGZpeGVkIGJ5IGp1c3Rpbjog5qC55o2uYmluZGluZ1BhdGjvvIzlpoLmnpzmmK/ku47ku47ooajvvIzpnIDopoHojrflj5bkuLvooajmlbDmja5pZOWSjOS7juihqOaVsOaNrmlkXG4gICAqL1xuICBwcml2YXRlIGdldFBhdGgoKTogc3RyaW5nIHtcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoO1xuICAgIGNvbnN0IHJpZCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkOyAvLyByb2906KGo5pWw5o2uaWRcbiAgICBsZXQgcGF0aCA9ICcvJyArIHJpZDtcblxuICAgIGNvbnN0IHN1YlBhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKTtcbiAgICBpZiAoc3ViUGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gZWc6YmluZGluZ1BhdGjlvaLlpoIvZWR1cy9ncmFkZXMsc3BsaXTlkI7mmK9bJycsICdlZHVzJywgJ2dyYWRlcyddXG4gICAgICAvLyDlm6DmraRpbmRleOS7jjHlvIDlp4tcbiAgICAgIGZvciAobGV0IGluZGV4ID0gMTsgaW5kZXggPCBzdWJQYXRocy5sZW5ndGggLSAxOyBpbmRleCsrKSB7XG4gICAgICAgIGNvbnN0IHN1YlBhdGggPSBzdWJQYXRoc1tpbmRleF07XG4gICAgICAgIGNvbnN0IHN1YkRhdGEgPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nRGF0YVtzdWJQYXRoXTtcbiAgICAgICAgaWYgKCFzdWJEYXRhIHx8ICFzdWJEYXRhLmN1cnJlbnRJZCkge1xuICAgICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZVsncGxzU2VsZWN0RGV0YWlsRm9ybURhdGEnXSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoYOiOt+WPluWtkOihqOWujOaVtOi3r+W+hOWHuumUme+8jOaJvuS4jeWIsCR7c3ViRGF0YX3lr7nlupTnmoTlrZDooajvvIzmiJblr7nlupTlrZDooajmsqHmnInlvZPliY3ooYzjgIJgKTtcbiAgICAgICAgfVxuICAgICAgICBwYXRoICs9IGAvJHtzdWJQYXRofS8ke3N1YkRhdGEuY3VycmVudElkfWA7XG4gICAgICB9XG4gICAgfVxuICAgIHBhdGggKz0gJy8nICsgc3ViUGF0aHNbc3ViUGF0aHMubGVuZ3RoIC0gMV07XG5cbiAgICByZXR1cm4gcGF0aDtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5qC557uE5Lu2YXBwQ29udGV4dFxuICAgKi9cbiAgcHJpdmF0ZSBnZXQgbWVzc2FnZVBpcGUoKSB7XG4gICAgaWYgKHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCkge1xuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpIHx8IG51bGw7XG4gICAgICBpZiAoYXBwQ29udGV4dCkge1xuICAgICAgICByZXR1cm4gYXBwQ29udGV4dC5tZXNzYWdlUGlwZSB8fCBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuZXhwb3J0IHsgU3ViTGlzdERhdGFTZXJ2aWNlIH07XG4iXX0=