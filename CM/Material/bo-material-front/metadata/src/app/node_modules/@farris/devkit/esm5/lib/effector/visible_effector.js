import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext, NAMESPACE } from '../frame/index';
import { Repository } from '../repository/index';
import { ExpressionUtil } from '../utils/expression_util';
var VisibleEffector = /** @class */ (function () {
    function VisibleEffector(injector, namespace, frameContext, repository) {
        this.injector = injector;
        this.namespace = namespace;
        this.frameContext = frameContext;
        this.repository = repository;
        this.ns = namespace;
    }
    VisibleEffector.prototype.effect = function (path, value, options) {
        // 由匿名函数接管，ignore
        var paths = path.split('/').filter(function (p) { return p; });
        var bindingPaths = this.getTablePaths(paths);
        var bindingPath = bindingPaths.join('/');
        // 主表显隐无需处理
        if (bindingPaths && bindingPaths.length > 0) {
            var isGridComponent = this.isGridComponent(bindingPath);
            if (isGridComponent) {
                var datagridComponent = this.getDatagridComponent(bindingPath);
                if (datagridComponent) {
                    // 更新列信息
                    // datagridComponent.columnsChanged();
                    var fieldPaths = this.getPropertyPaths(paths);
                    if (fieldPaths) {
                        var field = fieldPaths.join('.');
                        if (value) {
                            datagridComponent.showColumn(field);
                        }
                        else {
                            datagridComponent.hideColumn(field);
                        }
                    }
                }
            }
        }
        else {
            var datagridComponent = this.getDatagridComponent(bindingPath);
            if (datagridComponent) {
                datagridComponent.columnsChanged(false);
            }
        }
    };
    VisibleEffector.prototype.getTablePaths = function (paths) {
        var entityPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return entityPaths;
    };
    VisibleEffector.prototype.getDatagridComponent = function (bindingPath) {
        var _this = this;
        var frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || [];
        var matchedFrameContexts = frameContexts.filter(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).toString() === bindingPath.split('/').filter(function (p) { return p; }).toString(); });
        var result = null;
        if (matchedFrameContexts) {
            matchedFrameContexts.every(function (frameContext) {
                var frameId = frameContext.frameId;
                var componentsMap = _this.frameContext.appContext.componentManager.getComponentsByFrameId(frameId);
                if (!componentsMap) {
                    return true;
                }
                var datagridComponent = Array.from(componentsMap.values()).find(function (component) { return component && component['__component_type__'] === 'DatagridComponent'; });
                if (datagridComponent) {
                    result = datagridComponent;
                    return false;
                }
                else {
                    return true;
                }
            });
        }
        return result;
    };
    VisibleEffector.prototype.getPropertyPaths = function (paths) {
        var tablePaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return paths.slice(tablePaths.length);
    };
    VisibleEffector.prototype.isGridComponent = function (bindingPath) {
        var frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || [];
        var frameContext = frameContexts.find(function (frameContext) { return frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }).toString() === bindingPath.split('/').filter(function (p) { return p; }).toString(); });
        if (frameContext) {
            return !!frameContext.viewModel['dataGridColumnsName'];
        }
        else {
            return false;
        }
    };
    VisibleEffector.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    VisibleEffector.ctorParameters = function () { return [
        { type: Injector },
        { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] },
        { type: FrameContext },
        { type: Repository }
    ]; };
    return VisibleEffector;
}());
export { VisibleEffector };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlzaWJsZV9lZmZlY3Rvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VmZmVjdG9yL3Zpc2libGVfZWZmZWN0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdELE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUUxRDtJQUdFLHlCQUNVLFFBQWtCLEVBQ0MsU0FBUyxFQUM1QixZQUEwQixFQUMxQixVQUEyQjtRQUgzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ0MsY0FBUyxHQUFULFNBQVMsQ0FBQTtRQUM1QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUNuQyxJQUFJLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQztJQUN0QixDQUFDO0lBQ00sZ0NBQU0sR0FBYixVQUFjLElBQVksRUFBRSxLQUFVLEVBQUUsT0FBaUM7UUFDdkUsaUJBQWlCO1FBQ2pCLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDO1FBQzdDLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0MsSUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMzQyxXQUFXO1FBQ1gsSUFBSSxZQUFZLElBQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7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QyxTQUFTO2dCQVRaLFlBQVk7Z0JBQ1osVUFBVTs7SUFtRm5CLHNCQUFDO0NBQUEsQUFoRkQsSUFnRkM7U0EvRVksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIE5BTUVTUEFDRSB9IGZyb20gJy4uL2ZyYW1lL2luZGV4JztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSB9IGZyb20gJy4uL3JlcG9zaXRvcnkvaW5kZXgnO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uVXRpbCB9IGZyb20gJy4uL3V0aWxzL2V4cHJlc3Npb25fdXRpbCc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBWaXNpYmxlRWZmZWN0b3IgaW1wbGVtZW50cyBFeHByZXNzaW9uLkVmZmVjdG9yIHtcclxuICBwdWJsaWMgbnM6IHN0cmluZztcclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgQEluamVjdChOQU1FU1BBQ0UpIHByaXZhdGUgbmFtZXNwYWNlLFxyXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcclxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+KSB7XHJcbiAgICB0aGlzLm5zID0gbmFtZXNwYWNlO1xyXG4gIH1cclxuICBwdWJsaWMgZWZmZWN0KHBhdGg6IHN0cmluZywgdmFsdWU6IGFueSwgb3B0aW9uczogRXhwcmVzc2lvbi5FZmZlY3RPcHRpb25zKSB7XHJcbiAgICAvLyDnlLHljL/lkI3lh73mlbDmjqXnrqHvvIxpZ25vcmVcclxuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gdGhpcy5nZXRUYWJsZVBhdGhzKHBhdGhzKTtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gYmluZGluZ1BhdGhzLmpvaW4oJy8nKTtcclxuICAgIC8vIOS4u+ihqOaYvumakOaXoOmcgOWkhOeQhlxyXG4gICAgaWYgKGJpbmRpbmdQYXRocyAmJiBiaW5kaW5nUGF0aHMubGVuZ3RoID4gMCkge1xyXG4gICAgICBjb25zdCBpc0dyaWRDb21wb25lbnQgPSB0aGlzLmlzR3JpZENvbXBvbmVudChiaW5kaW5nUGF0aCk7XHJcbiAgICAgIGlmIChpc0dyaWRDb21wb25lbnQpIHtcclxuICAgICAgICBjb25zdCBkYXRhZ3JpZENvbXBvbmVudCA9IHRoaXMuZ2V0RGF0YWdyaWRDb21wb25lbnQoYmluZGluZ1BhdGgpO1xyXG4gICAgICAgIGlmIChkYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgICAgLy8g5pu05paw5YiX5L+h5oGvXHJcbiAgICAgICAgICAvLyBkYXRhZ3JpZENvbXBvbmVudC5jb2x1bW5zQ2hhbmdlZCgpO1xyXG4gICAgICAgICAgY29uc3QgZmllbGRQYXRocyA9IHRoaXMuZ2V0UHJvcGVydHlQYXRocyhwYXRocyk7XHJcbiAgICAgICAgICBpZiAoZmllbGRQYXRocykge1xyXG4gICAgICAgICAgICBjb25zdCBmaWVsZCA9IGZpZWxkUGF0aHMuam9pbignLicpO1xyXG4gICAgICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgICBkYXRhZ3JpZENvbXBvbmVudC5zaG93Q29sdW1uKGZpZWxkKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICBkYXRhZ3JpZENvbXBvbmVudC5oaWRlQ29sdW1uKGZpZWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgY29uc3QgZGF0YWdyaWRDb21wb25lbnQgPSB0aGlzLmdldERhdGFncmlkQ29tcG9uZW50KGJpbmRpbmdQYXRoKTtcclxuICAgICAgaWYgKGRhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgZGF0YWdyaWRDb21wb25lbnQuY29sdW1uc0NoYW5nZWQoZmFsc2UpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0VGFibGVQYXRocyhwYXRoczogc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBlbnRpdHlQYXRocyA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XHJcbiAgICByZXR1cm4gZW50aXR5UGF0aHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0RGF0YWdyaWRDb21wb25lbnQoYmluZGluZ1BhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0czogRnJhbWVDb250ZXh0W10gPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0c0J5TmFtZXNwYWNlKHRoaXMubmFtZXNwYWNlKSB8fCBbXTtcclxuICAgIGNvbnN0IG1hdGNoZWRGcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS50b1N0cmluZygpID09PSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnRvU3RyaW5nKCkpO1xyXG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XHJcbiAgICBpZiAobWF0Y2hlZEZyYW1lQ29udGV4dHMpIHtcclxuICAgICAgbWF0Y2hlZEZyYW1lQ29udGV4dHMuZXZlcnkoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZnJhbWVJZCA9IGZyYW1lQ29udGV4dC5mcmFtZUlkO1xyXG4gICAgICAgIGNvbnN0IGNvbXBvbmVudHNNYXAgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmNvbXBvbmVudE1hbmFnZXIuZ2V0Q29tcG9uZW50c0J5RnJhbWVJZChmcmFtZUlkKTtcclxuICAgICAgICBpZiAoIWNvbXBvbmVudHNNYXApIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBkYXRhZ3JpZENvbXBvbmVudCA9IEFycmF5LmZyb20oY29tcG9uZW50c01hcC52YWx1ZXMoKSkuZmluZCgoY29tcG9uZW50OiBhbnkpID0+IGNvbXBvbmVudCAmJiBjb21wb25lbnRbJ19fY29tcG9uZW50X3R5cGVfXyddID09PSAnRGF0YWdyaWRDb21wb25lbnQnKTtcclxuICAgICAgICBpZiAoZGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICAgIHJlc3VsdCA9IGRhdGFncmlkQ29tcG9uZW50O1xyXG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcbiAgcHJpdmF0ZSBnZXRQcm9wZXJ0eVBhdGhzKHBhdGhzOiBzdHJpbmdbXSkge1xyXG4gICAgY29uc3QgdGFibGVQYXRocyA9IEV4cHJlc3Npb25VdGlsLmdldEF2YWlsYWJsZUNoaWxkcmVuUGF0aHNGcm9tRW50aXR5UGF0aHMocGF0aHMsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XHJcbiAgICByZXR1cm4gcGF0aHMuc2xpY2UodGFibGVQYXRocy5sZW5ndGgpO1xyXG4gIH1cclxuICBwcml2YXRlIGlzR3JpZENvbXBvbmVudChiaW5kaW5nUGF0aDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzOiBGcmFtZUNvbnRleHRbXSA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UodGhpcy5uYW1lc3BhY2UpIHx8IFtdO1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0cy5maW5kKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSA9PT0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS50b1N0cmluZygpKTtcclxuICAgIGlmIChmcmFtZUNvbnRleHQpIHtcclxuICAgICAgcmV0dXJuICEhZnJhbWVDb250ZXh0LnZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zTmFtZSddO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxufSJdfQ==