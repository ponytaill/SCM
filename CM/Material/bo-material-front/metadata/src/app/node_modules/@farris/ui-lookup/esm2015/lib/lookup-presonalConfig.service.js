/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { IdService } from '@farris/ui-common';
import { Subject } from 'rxjs';
export class PersonalConfigService {
    /**
     * @param {?} idService
     */
    constructor(idService) {
        this.idService = idService;
        this.selectItemObser$ = new Subject();
        this.displayType = 'LIST';
        this.singleSelect = true;
        // 个性化配置KEY
        this._key = '';
        this._newKey = '';
        // 组件ID
        this.controlID = '';
    }
    /**
     * @return {?}
     */
    get personalConfigKey() {
        return this._key;
    }
    /**
     * @param {?} val
     * @return {?}
     */
    set personalConfigKey(val) {
        if (val) {
            this._key = this.buildKey(val);
            if (this.controlID) {
                this._newKey = this.buildKey(this.controlID + '_' + val);
            }
            else {
                this._newKey = this._key;
            }
        }
        else {
            this._newKey = this.buildKey(this.controlID);
        }
    }
    /**
     * @private
     * @param {?} str
     * @return {?}
     */
    buildKey(str) {
        /** @type {?} */
        let prefix = '';
        if (location.hash) {
            /** @type {?} */
            const pathArr = location.hash.split('?');
            prefix = pathArr ? pathArr[0] : '';
        }
        else {
            /** @type {?} */
            const pathArr = location.pathname.split('/');
            prefix = pathArr ? pathArr[pathArr.length - 1] : '';
        }
        return this.idService.encrypt(prefix + str);
    }
    /**
     * @param {?} obj
     * @return {?}
     */
    initPersonalConf(obj) {
        Object.assign(this, obj);
    }
    /**
     * @param {?=} key
     * @return {?}
     */
    getPersonalData(key) {
        if (key) {
            this._key = key;
        }
        if (this.personalConfigKey) {
            /** @type {?} */
            const conf = localStorage.getItem(this.personalConfigKey);
            if (conf && conf !== 'undefined' && conf !== 'null') {
                this.personalConf = conf ? JSON.parse(conf) : {};
                this._updatePersonalConfig(this.personalConf);
                if (this.controlID) {
                    if (this._key !== this._newKey) {
                        localStorage.removeItem(this._key);
                    }
                    this.savePersonalConfig(this.personalConf);
                }
                return this.personalConf;
            }
            else {
                return null;
            }
        }
        return null;
    }
    /**
     * @param {?=} localeId
     * @return {?}
     */
    getQuickSelected(localeId) {
        /** @type {?} */
        const d = this.getPersonalData();
        /** @type {?} */
        const qs = d ? d.quickSelected : null;
        if (localeId) {
            if (qs) {
                /** @type {?} */
                const items = qs[localeId];
                if (items && items.length) {
                    return items;
                }
            }
            return null;
        }
        return qs;
    }
    /**
     * @return {?}
     */
    getDialogSize() {
        /** @type {?} */
        const d = this.getPersonalData();
        return d ? d.size : null;
    }
    /**
     * @param {?} cfg
     * @return {?}
     */
    updatePersonalConfig(cfg) {
        /** @type {?} */
        const data = Object.assign(this.personalConf || {}, cfg);
        this.savePersonalConfig(data);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    savePersonalConfig(data) {
        if (this._newKey) {
            localStorage.setItem(this._newKey, JSON.stringify(data));
            this.personalConf = data;
            return true;
        }
        return false;
    }
    /**
     * @param {?=} tabName
     * @return {?}
     */
    getActiveTabIndex(tabName) {
        /** @type {?} */
        const d = this.getPersonalData();
        if (!tabName) {
            return d && d.tabIndex ? d.tabIndex : 'datalist';
        }
        return tabName;
    }
    /**
     * @param {?} selectedRow
     * @param {?} localeId
     * @return {?}
     */
    updateQueckSelected(selectedRow, localeId) {
        /** @type {?} */
        const quickItems = this.getQuickSelected(localeId);
        if (quickItems && quickItems.length) {
            /** @type {?} */
            const selectedIndex = [];
            quickItems.forEach((/**
             * @param {?} element
             * @param {?} index
             * @return {?}
             */
            (element, index) => {
                if (this.singleSelect) {
                    if (element && selectedRow && element[this.idField] === selectedRow[this.idField]) {
                        selectedIndex.push(index);
                    }
                }
                else {
                    if (selectedRow) {
                        selectedRow.forEach((/**
                         * @param {?} item
                         * @return {?}
                         */
                        item => {
                            if (element && element[this.idField] === item[this.idField]) {
                                selectedIndex.push(index);
                            }
                        }));
                    }
                }
            }));
            selectedIndex.forEach((/**
             * @param {?} index
             * @return {?}
             */
            index => {
                quickItems[index] = null;
            }));
            this.personalConf.quickSelected[localeId] =
                this.personalConf.quickSelected[localeId].filter((/**
                 * @param {?} v
                 * @return {?}
                 */
                v => v !== null));
            if (this.singleSelect) {
                this.personalConf.quickSelected[localeId].unshift(selectedRow);
            }
            else {
                if (selectedRow) {
                    selectedRow.forEach((/**
                     * @param {?} element
                     * @return {?}
                     */
                    element => {
                        this.personalConf.quickSelected[localeId].unshift(element);
                    }));
                }
            }
            this.personalConf.quickSelected[localeId].length =
                this.personalConf.quickSelected[localeId].length > 5 ?
                    5 : this.personalConf.quickSelected[localeId].length;
        }
        else {
            /** @type {?} */
            const _qs = this.personalConf.quickSelected || {};
            /** @type {?} */
            let newData;
            if (this.singleSelect) {
                newData = Object.assign(_qs, { [localeId]: [selectedRow] });
            }
            else {
                selectedRow.length = selectedRow.length > 5 ? 5 : selectedRow.length;
                newData = Object.assign(_qs, { [localeId]: selectedRow });
            }
            this.personalConf.quickSelected = newData;
        }
        this.savePersonalConfig(this.personalConf);
    }
    /**
     *  更新数据结构，现有个性化数据均转为 中文环境下数据；
     * @param {?} per
     * @return {?}
     */
    _updatePersonalConfig(per) {
        if (per) {
            /** @type {?} */
            let flag = false;
            // 更新收藏数据
            if (per.favorite && Array.isArray(per.favorite)) {
                per.favorite = { 'zh-CHS': [...per.favorite] };
                delete per.favorite;
                flag = true;
            }
            // 更新快捷录入数据
            if (per.selected) {
                if (Array.isArray(per.selected)) {
                    per.quickSelected = { 'zh-CHS': [...per.selected] };
                }
                delete per.selected;
                flag = true;
            }
            if (flag) {
                this.savePersonalConfig(per);
            }
        }
    }
}
PersonalConfigService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PersonalConfigService.ctorParameters = () => [
    { type: IdService }
];
if (false) {
    /** @type {?} */
    PersonalConfigService.prototype.personalConf;
    /** @type {?} */
    PersonalConfigService.prototype.selectItemObser$;
    /** @type {?} */
    PersonalConfigService.prototype.displayType;
    /** @type {?} */
    PersonalConfigService.prototype.singleSelect;
    /** @type {?} */
    PersonalConfigService.prototype.idField;
    /** @type {?} */
    PersonalConfigService.prototype.textField;
    /** @type {?} */
    PersonalConfigService.prototype.mapFields;
    /**
     * @type {?}
     * @private
     */
    PersonalConfigService.prototype._key;
    /** @type {?} */
    PersonalConfigService.prototype._newKey;
    /** @type {?} */
    PersonalConfigService.prototype.controlID;
    /**
     * @type {?}
     * @private
     */
    PersonalConfigService.prototype.idService;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLXByZXNvbmFsQ29uZmlnLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9sb29rdXAtcHJlc29uYWxDb25maWcuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUsvQixNQUFNLE9BQU8scUJBQXFCOzs7O0lBbUM5QixZQUFvQixTQUFvQjtRQUFwQixjQUFTLEdBQVQsU0FBUyxDQUFXO1FBL0J4QyxxQkFBZ0IsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBRWpDLGdCQUFXLEdBQUcsTUFBTSxDQUFDO1FBRXJCLGlCQUFZLEdBQUcsSUFBSSxDQUFDOztRQU1aLFNBQUksR0FBRyxFQUFFLENBQUM7UUFDbEIsWUFBTyxHQUFHLEVBQUUsQ0FBQzs7UUFrQmIsY0FBUyxHQUFHLEVBQUUsQ0FBQztJQUU0QixDQUFDOzs7O0lBbkI1QyxJQUFJLGlCQUFpQjtRQUNqQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQzs7Ozs7SUFDRCxJQUFJLGlCQUFpQixDQUFDLEdBQUc7UUFDckIsSUFBSSxHQUFHLEVBQUU7WUFDTCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDL0IsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUM7YUFDNUQ7aUJBQU07Z0JBQ0gsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFB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WUFDaEIsU0FBUztZQUNULElBQUksR0FBRyxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDN0MsR0FBRyxDQUFDLFFBQVEsR0FBRyxFQUFFLFFBQVEsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQy9DLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQztnQkFFcEIsSUFBSSxHQUFHLElBQUksQ0FBQzthQUNmO1lBQ0QsV0FBVztZQUNYLElBQUksR0FBRyxDQUFDLFFBQVEsRUFBRTtnQkFDZCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO29CQUM3QixHQUFHLENBQUMsYUFBYSxHQUFHLEVBQUUsUUFBUSxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztpQkFDdkQ7Z0JBQ0QsT0FBTyxHQUFHLENBQUMsUUFBUSxDQUFDO2dCQUNwQixJQUFJLEdBQUcsSUFBSSxDQUFDO2FBQ2Y7WUFFRCxJQUFJLElBQUksRUFBRTtnQkFDTixJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDaEM7U0FDSjtJQUNMLENBQUM7OztZQTlNSixVQUFVOzs7O1lBTEYsU0FBUzs7OztJQVFkLDZDQUE2Qjs7SUFFN0IsaURBQWlDOztJQUVqQyw0Q0FBcUI7O0lBRXJCLDZDQUFvQjs7SUFDcEIsd0NBQWdCOztJQUNoQiwwQ0FBa0I7O0lBQ2xCLDBDQUFlOzs7OztJQUdmLHFDQUFrQjs7SUFDbEIsd0NBQWE7O0lBa0JiLDBDQUFlOzs7OztJQUVILDBDQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSWRTZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24nO1xyXG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFBlcnNvbmFsQ29uZmlnIH0gZnJvbSAnLi9sb29rdXAtZ3JpZC1vcHRpb25zJztcclxuXHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBQZXJzb25hbENvbmZpZ1NlcnZpY2Uge1xyXG4gICAgLy8g5Liq5oCn5YyW6YWN572uXHJcbiAgICBwZXJzb25hbENvbmY6IFBlcnNvbmFsQ29uZmlnO1xyXG5cclxuICAgIHNlbGVjdEl0ZW1PYnNlciQgPSBuZXcgU3ViamVjdCgpO1xyXG5cclxuICAgIGRpc3BsYXlUeXBlID0gJ0xJU1QnO1xyXG5cclxuICAgIHNpbmdsZVNlbGVjdCA9IHRydWU7XHJcbiAgICBpZEZpZWxkOiBzdHJpbmc7XHJcbiAgICB0ZXh0RmllbGQ6IHN0cmluZztcclxuICAgIG1hcEZpZWxkczogYW55O1xyXG5cclxuICAgIC8vIOS4quaAp+WMlumFjee9rktFWVxyXG4gICAgcHJpdmF0ZSBfa2V5ID0gJyc7XHJcbiAgICBfbmV3S2V5ID0gJyc7XHJcbiAgICBnZXQgcGVyc29uYWxDb25maWdLZXkoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2tleTtcclxuICAgIH1cclxuICAgIHNldCBwZXJzb25hbENvbmZpZ0tleSh2YWwpIHtcclxuICAgICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2tleSA9IHRoaXMuYnVpbGRLZXkodmFsKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuY29udHJvbElEKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9uZXdLZXkgPSB0aGlzLmJ1aWxkS2V5KHRoaXMuY29udHJvbElEICsgJ18nICsgdmFsKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX25ld0tleSA9IHRoaXMuX2tleTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX25ld0tleSA9IHRoaXMuYnVpbGRLZXkodGhpcy5jb250cm9sSUQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyDnu4Tku7ZJRFxyXG4gICAgY29udHJvbElEID0gJyc7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpZFNlcnZpY2U6IElkU2VydmljZSkge31cclxuXHJcbiAgICBwcml2YXRlIGJ1aWxkS2V5KHN0cikge1xyXG4gICAgICAgIGxldCBwcmVmaXggPSAnJztcclxuICAgICAgICBpZiAobG9jYXRpb24uaGFzaCkge1xyXG4gICAgICAgICAgICBjb25zdCBwYXRoQXJyID0gbG9jYXRpb24uaGFzaC5zcGxpdCgnPycpO1xyXG4gICAgICAgICAgICBwcmVmaXggPSBwYXRoQXJyID8gcGF0aEFyclswXSA6ICcnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhBcnIgID0gbG9jYXRpb24ucGF0aG5hbWUuc3BsaXQoJy8nKTtcclxuICAgICAgICAgICAgcHJlZml4ID0gcGF0aEFyciA/IHBhdGhBcnJbcGF0aEFyci5sZW5ndGggLSAxXSA6ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5pZFNlcnZpY2UuZW5jcnlwdChwcmVmaXggKyBzdHIpO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXRQZXJzb25hbENvbmYob2JqKSB7XHJcbiAgICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBvYmopO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFBlcnNvbmFsRGF0YShrZXk/OiBzdHJpbmcpOiBQZXJzb25hbENvbmZpZyB7XHJcbiAgICAgICAgaWYgKGtleSkge1xyXG4gICAgICAgICAgICB0aGlzLl9rZXkgPSBrZXk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5wZXJzb25hbENvbmZpZ0tleSkge1xyXG4gICAgICAgICAgICBjb25zdCBjb25mID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5wZXJzb25hbENvbmZpZ0tleSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoY29uZiAmJiBjb25mICE9PSAndW5kZWZpbmVkJyAmJiBjb25mICE9PSAnbnVsbCcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMucGVyc29uYWxDb25mID0gY29uZiA/IEpTT04ucGFyc2UoY29uZikgOiB7fTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVBlcnNvbmFsQ29uZmlnKHRoaXMucGVyc29uYWxDb25mKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5jb250cm9sSUQpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fa2V5ICE9PSB0aGlzLl9uZXdLZXkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy5fa2V5KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlUGVyc29uYWxDb25maWcodGhpcy5wZXJzb25hbENvbmYpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnBlcnNvbmFsQ29uZjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBnZXRRdWlja1NlbGVjdGVkKGxvY2FsZUlkPzogc3RyaW5nKTogYW55IHtcclxuICAgICAgICBjb25zdCBkID0gdGhpcy5nZXRQZXJzb25hbERhdGEoKTtcclxuICAgICAgICBjb25zdCBxcyA9ICBkID8gZC5xdWlja1NlbGVjdGVkIDogbnVsbDtcclxuXHJcbiAgICAgICAgaWYgKGxvY2FsZUlkKSB7XHJcbiAgICAgICAgICAgIGlmIChxcykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbXMgPSBxc1tsb2NhbGVJZF07XHJcbiAgICAgICAgICAgICAgICBpZiAoaXRlbXMgJiYgaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGl0ZW1zO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RGlhbG9nU2l6ZSgpIHtcclxuICAgICAgICBjb25zdCBkID0gdGhpcy5nZXRQZXJzb25hbERhdGEoKTtcclxuICAgICAgICByZXR1cm4gZCA/IGQuc2l6ZSA6IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlUGVyc29uYWxDb25maWcoY2ZnOiBQYXJ0aWFsPFBlcnNvbmFsQ29uZmlnPikge1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSBPYmplY3QuYXNzaWduKHRoaXMucGVyc29uYWxDb25mIHx8IHt9LCBjZmcpO1xyXG4gICAgICAgIHRoaXMuc2F2ZVBlcnNvbmFsQ29uZmlnKGRhdGEpO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVQZXJzb25hbENvbmZpZyhkYXRhOiBQZXJzb25hbENvbmZpZykge1xyXG4gICAgICAgIGlmICh0aGlzLl9uZXdLZXkpIHtcclxuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5fbmV3S2V5LCBKU09OLnN0cmluZ2lmeShkYXRhKSk7XHJcbiAgICAgICAgICAgIHRoaXMucGVyc29uYWxDb25mID0gZGF0YTtcclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QWN0aXZlVGFiSW5kZXgodGFiTmFtZT86IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGQgPSB0aGlzLmdldFBlcnNvbmFsRGF0YSgpO1xyXG4gICAgICAgIGlmICghdGFiTmFtZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gZCAmJiBkLnRhYkluZGV4ID8gZC50YWJJbmRleCAgOiAnZGF0YWxpc3QnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGFiTmFtZTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVRdWVja1NlbGVjdGVkKHNlbGVjdGVkUm93OiBhbnksIGxvY2FsZUlkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBxdWlja0l0ZW1zID0gdGhpcy5nZXRRdWlja1NlbGVjdGVkKGxvY2FsZUlkKTtcclxuXHJcbiAgICAgICAgaWYgKHF1aWNrSXRlbXMgJiYgcXVpY2tJdGVtcy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRJbmRleCA9IFtdO1xyXG4gICAgICAgICAgICBxdWlja0l0ZW1zLmZvckVhY2goKGVsZW1lbnQsIGluZGV4KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaW5nbGVTZWxlY3QpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBzZWxlY3RlZFJvdyAmJiBlbGVtZW50W3RoaXMuaWRGaWVsZF0gPT09IHNlbGVjdGVkUm93W3RoaXMuaWRGaWVsZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJbmRleC5wdXNoKGluZGV4KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZFJvdy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgZWxlbWVudFt0aGlzLmlkRmllbGRdID09PSBpdGVtW3RoaXMuaWRGaWVsZF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZEluZGV4LnB1c2goaW5kZXgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgc2VsZWN0ZWRJbmRleC5mb3JFYWNoKGluZGV4ID0+IHtcclxuICAgICAgICAgICAgICAgIHF1aWNrSXRlbXNbaW5kZXhdID0gbnVsbDtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXSA9XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXS5maWx0ZXIodiA9PiB2ICE9PSBudWxsKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc2luZ2xlU2VsZWN0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXS51bnNoaWZ0KHNlbGVjdGVkUm93KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChzZWxlY3RlZFJvdykge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkUm93LmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGVyc29uYWxDb25mLnF1aWNrU2VsZWN0ZWRbbG9jYWxlSWRdLnVuc2hpZnQoZWxlbWVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5wZXJzb25hbENvbmYucXVpY2tTZWxlY3RlZFtsb2NhbGVJZF0ubGVuZ3RoID1cclxuICAgICAgICAgICAgICAgIHRoaXMucGVyc29uYWxDb25mLnF1aWNrU2VsZWN0ZWRbbG9jYWxlSWRdLmxlbmd0aCA+IDUgP1xyXG4gICAgICAgICAgICAgICAgICAgIDUgOiB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkW2xvY2FsZUlkXS5sZW5ndGg7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgX3FzID0gdGhpcy5wZXJzb25hbENvbmYucXVpY2tTZWxlY3RlZCB8fCB7fTtcclxuICAgICAgICAgICAgbGV0IG5ld0RhdGE7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICAgICAgbmV3RGF0YSA9IE9iamVjdC5hc3NpZ24oX3FzLCB7IFtsb2NhbGVJZF06IFtzZWxlY3RlZFJvd10gfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZFJvdy5sZW5ndGggPSBzZWxlY3RlZFJvdy5sZW5ndGggPiA1ID8gNSA6IHNlbGVjdGVkUm93Lmxlbmd0aDtcclxuICAgICAgICAgICAgICAgIG5ld0RhdGEgPSBPYmplY3QuYXNzaWduKF9xcywgeyBbbG9jYWxlSWRdOiBzZWxlY3RlZFJvdyB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLnBlcnNvbmFsQ29uZi5xdWlja1NlbGVjdGVkID0gbmV3RGF0YTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuc2F2ZVBlcnNvbmFsQ29uZmlnKHRoaXMucGVyc29uYWxDb25mKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqICDmm7TmlrDmlbDmja7nu5PmnoTvvIznjrDmnInkuKrmgKfljJbmlbDmja7lnYfovazkuLog5Lit5paH546v5aKD5LiL5pWw5o2u77ybXHJcbiAgICAgKi9cclxuICAgIF91cGRhdGVQZXJzb25hbENvbmZpZyhwZXI6IFBlcnNvbmFsQ29uZmlnKSB7XHJcbiAgICAgICAgaWYgKHBlcikge1xyXG4gICAgICAgICAgICBsZXQgZmxhZyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAvLyDmm7TmlrDmlLbol4/mlbDmja5cclxuICAgICAgICAgICAgaWYgKHBlci5mYXZvcml0ZSAmJiBBcnJheS5pc0FycmF5KHBlci5mYXZvcml0ZSkpIHtcclxuICAgICAgICAgICAgICAgIHBlci5mYXZvcml0ZSA9IHsgJ3poLUNIUyc6IFsuLi5wZXIuZmF2b3JpdGVdIH07XHJcbiAgICAgICAgICAgICAgICBkZWxldGUgcGVyLmZhdm9yaXRlO1xyXG5cclxuICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIOabtOaWsOW/q+aNt+W9leWFpeaVsOaNrlxyXG4gICAgICAgICAgICBpZiAocGVyLnNlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShwZXIuc2VsZWN0ZWQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGVyLnF1aWNrU2VsZWN0ZWQgPSB7ICd6aC1DSFMnOiBbLi4ucGVyLnNlbGVjdGVkXSB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgZGVsZXRlIHBlci5zZWxlY3RlZDtcclxuICAgICAgICAgICAgICAgIGZsYWcgPSB0cnVlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoZmxhZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zYXZlUGVyc29uYWxDb25maWcocGVyKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=