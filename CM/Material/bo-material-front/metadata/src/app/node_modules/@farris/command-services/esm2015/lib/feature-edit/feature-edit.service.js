import { Injectable, Injector } from "@angular/core";
import { FeatureEditorService } from '@farris/ui-feature-editor';
import { FormNotifyService } from "../form-notify.service";
import { map, switchMap, tap } from "rxjs/operators";
import { FormLoadingService } from "../form-loading/form-loading.service";
import { FeatureDataService } from './feature-data.service';
import { LanguageService } from '../languag.service';
import { of } from "rxjs";
export class FeatureEditService {
    constructor(injector, featureEditorService, featureDataService, loadingService, notifyService, languageService) {
        this.injector = injector;
        this.featureEditorService = featureEditorService;
        this.featureDataService = featureDataService;
        this.loadingService = loadingService;
        this.notifyService = notifyService;
        this.languageService = languageService;
    }
    edit(materialId, materialFeatureId, options) {
        if (!materialId) {
            throw new Error('[FeatureEditService]物料id不能为空！');
        }
        if (!options) {
            options = {};
        }
        if (typeof options === 'string' && options.startsWith('{') && options.endsWith('}')) {
            options = JSON.parse(options);
        }
        options.getHelpInfo = this.featureDataService.getHelpInfo;
        this.loadingService.show();
        return this.featureDataService.getFeaturesByMaterialId(materialId).pipe(tap((result) => {
            this.loadingService.hide();
            const returnValue = result || null;
            if (returnValue) {
                const featureInfo = JSON.parse(returnValue);
                const props = featureInfo.props || null;
                if (!props || props.length < 1) {
                    this.notifyService.warning(this.languageService.propsIsEmpty);
                    return;
                }
                this.featureEditorService.show(props, options);
            }
            else {
                this.notifyService.error(this.languageService.propsIsEmpty);
            }
        }));
    }
    buildFeatures(materialId, materialFeatureId) {
        const features$ = this.featureDataService.getFeaturesByMaterialId(materialId);
        return features$.pipe(switchMap(featureSet => {
            if (materialFeatureId) {
                const configedFeatures$ = this.featureDataService.getConfigedValueByFeatureId(materialFeatureId, materialFeatureId);
                return configedFeatures$.pipe(map(defaultConfigs => {
                    const featureTemplate = featureSet.props;
                    const features = this.mergeFeatures(featureTemplate, defaultConfigs);
                    return features;
                }));
            }
            else {
                return of(featureSet.props);
            }
        }));
    }
    mergeFeatures(featureTemplate, defaultConfigs) {
        return null;
    }
}
FeatureEditService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
FeatureEditService.ctorParameters = () => [
    { type: Injector },
    { type: FeatureEditorService },
    { type: FeatureDataService },
    { type: FormLoadingService },
    { type: FormNotifyService },
    { type: LanguageService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmVhdHVyZS1lZGl0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZmVhdHVyZS1lZGl0L2ZlYXR1cmUtZWRpdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRzFCLE1BQU0sT0FBTyxrQkFBa0I7SUFDN0IsWUFDVSxRQUFrQixFQUNsQixvQkFBMEMsRUFDMUMsa0JBQXNDLEVBQ3RDLGNBQWtDLEVBQ2xDLGFBQWdDLEVBQ2hDLGVBQWdDO1FBTGhDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLG1CQUFjLEdBQWQsY0FBYyxDQUFvQjtRQUNsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBbUI7UUFDaEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO0lBQ3RDLENBQUM7SUFFRSxJQUFJLENBQUMsVUFBa0IsRUFBRSxpQkFBMEIsRUFBRSxPQUFhO1FBQ3ZFLElBQUksQ0FBQyxVQUFVLEVB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fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRmVhdHVyZUVkaXRvclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWZlYXR1cmUtZWRpdG9yJztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSBcIi4uL2Zvcm0tbm90aWZ5LnNlcnZpY2VcIjtcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gXCIuLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2VcIjtcbmltcG9ydCB7IEZlYXR1cmVEYXRhU2VydmljZSB9IGZyb20gJy4vZmVhdHVyZS1kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vbGFuZ3VhZy5zZXJ2aWNlJztcbmltcG9ydCB7IG9mIH0gZnJvbSBcInJ4anNcIjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZlYXR1cmVFZGl0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByaXZhdGUgZmVhdHVyZUVkaXRvclNlcnZpY2U6IEZlYXR1cmVFZGl0b3JTZXJ2aWNlLFxuICAgIHByaXZhdGUgZmVhdHVyZURhdGFTZXJ2aWNlOiBGZWF0dXJlRGF0YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLFxuICAgIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcbiAgKSB7IH1cblxuICBwdWJsaWMgZWRpdChtYXRlcmlhbElkOiBzdHJpbmcsIG1hdGVyaWFsRmVhdHVyZUlkPzogc3RyaW5nLCBvcHRpb25zPzogYW55KSB7XG4gICAgaWYgKCFtYXRlcmlhbElkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tGZWF0dXJlRWRpdFNlcnZpY2Vd54mp5paZaWTkuI3og73kuLrnqbrvvIEnKTtcbiAgICB9XG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICBvcHRpb25zID0ge307XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgJiYgb3B0aW9ucy5zdGFydHNXaXRoKCd7JykgJiYgb3B0aW9ucy5lbmRzV2l0aCgnfScpKSB7XG4gICAgICBvcHRpb25zID0gSlNPTi5wYXJzZShvcHRpb25zKTtcbiAgICB9XG4gICAgb3B0aW9ucy5nZXRIZWxwSW5mbyA9IHRoaXMuZmVhdHVyZURhdGFTZXJ2aWNlLmdldEhlbHBJbmZvO1xuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgIHJldHVybiB0aGlzLmZlYXR1cmVEYXRhU2VydmljZS5nZXRGZWF0dXJlc0J5TWF0ZXJpYWxJZChtYXRlcmlhbElkKS5waXBlKFxuICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgICAgY29uc3QgcmV0dXJuVmFsdWUgPSByZXN1bHQgfHwgbnVsbDtcbiAgICAgICAgaWYgKHJldHVyblZhbHVlKSB7XG4gICAgICAgICAgY29uc3QgZmVhdHVyZUluZm8gPSBKU09OLnBhcnNlKHJldHVyblZhbHVlKTtcbiAgICAgICAgICBjb25zdCBwcm9wcyA9IGZlYXR1cmVJbmZvLnByb3BzIHx8IG51bGw7XG4gICAgICAgICAgaWYgKCFwcm9wcyB8fCBwcm9wcy5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wcm9wc0lzRW1wdHkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmZlYXR1cmVFZGl0b3JTZXJ2aWNlLnNob3cocHJvcHMsIG9wdGlvbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZS5wcm9wc0lzRW1wdHkpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgcHJpdmF0ZSBidWlsZEZlYXR1cmVzKG1hdGVyaWFsSWQ6IHN0cmluZywgbWF0ZXJpYWxGZWF0dXJlSWQ/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBmZWF0dXJlcyQgPSB0aGlzLmZlYXR1cmVEYXRhU2VydmljZS5nZXRGZWF0dXJlc0J5TWF0ZXJpYWxJZChtYXRlcmlhbElkKTtcbiAgICByZXR1cm4gZmVhdHVyZXMkLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoZmVhdHVyZVNldCA9PiB7XG4gICAgICAgIGlmIChtYXRlcmlhbEZlYXR1cmVJZCkge1xuICAgICAgICAgIGNvbnN0IGNvbmZpZ2VkRmVhdHVyZXMkID0gdGhpcy5mZWF0dXJlRGF0YVNlcnZpY2UuZ2V0Q29uZmlnZWRWYWx1ZUJ5RmVhdHVyZUlkKG1hdGVyaWFsRmVhdHVyZUlkLCBtYXRlcmlhbEZlYXR1cmVJZCk7XG4gICAgICAgICAgcmV0dXJuIGNvbmZpZ2VkRmVhdHVyZXMkLnBpcGUoXG4gICAgICAgICAgICBtYXAoZGVmYXVsdENvbmZpZ3MgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBmZWF0dXJlVGVtcGxhdGUgPSBmZWF0dXJlU2V0LnByb3BzO1xuICAgICAgICAgICAgICBjb25zdCBmZWF0dXJlcyA9IHRoaXMubWVyZ2VGZWF0dXJlcyhmZWF0dXJlVGVtcGxhdGUsIGRlZmF1bHRDb25maWdzKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGZlYXR1cmVzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBvZihmZWF0dXJlU2V0LnByb3BzKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuXG4gIH1cbiAgcHJpdmF0ZSBtZXJnZUZlYXR1cmVzKGZlYXR1cmVUZW1wbGF0ZTogYW55LCBkZWZhdWx0Q29uZmlnczogYW55KSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn0iXX0=