import { Injectable, Optional } from '@angular/core';
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { FarrisSidebarService } from '@farris/ui-sidebar';
import { FrameContext } from '@farris/devkit';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
/**
 * 侧边栏服务
 * @scope FrameComponent
 */
class SidebarService {
    constructor(frameContext, sidebarUIService, messageService, languageService) {
        this.frameContext = frameContext;
        this.sidebarUIService = sidebarUIService;
        this.messageService = messageService;
        this.languageService = languageService;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
    }
    get repository() {
        return this.frameContext.repository;
    }
    openSidebar() {
        this.sidebarUIService.sendIsOpen(true);
    }
    closeSidebar() {
        this.sidebarUIService.sendIsOpen(false);
    }
    /**
     * 关闭前先取消变更
     */
    confirmBeforeClosingSidebar() {
        // 检查是否有变更，没有变更直接关闭
        const ifChangesExist = this.repository.entityManager.checkAllEntityChanges();
        if (!ifChangesExist) {
            return of(true);
        }
        // 确认是否关闭
        const confirm$ = this.messageService.question(this.languageService['exitWithoutSave']);
        const result$ = confirm$.pipe(switchMap((confirmResult) => {
            if (confirmResult === false) {
                return of(false);
            }
            else {
                return of(true);
            }
        }));
        return result$;
    }
    /**
     * 继续关闭侧边栏
     */
    continueClosingSidebar() {
        return of(true);
    }
    /**
     * 阻止侧边栏关闭
     */
    stopClosingSidebar() {
        return of(false);
    }
}
SidebarService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
SidebarService.ctorParameters = () => [
    { type: FrameContext },
    { type: FarrisSidebarService },
    { type: FormMessageService },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
export { SidebarService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lkZWJhci1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3NpZGViYXItc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxRCxPQUFPLEVBQVUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBR3BEOzs7R0FHRztBQUNILE1BQ00sY0FBYztJQU1sQixZQUNVLFlBQTBCLEVBQzFCLGdCQUFzQyxFQUN0QyxjQUFrQyxFQUN0QixlQUFnQztRQUg1QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQXNCO1FBQ3RDLG1CQUFjLEdBQWQsY0FBYyxDQUFvQjtRQUN0QixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFFcEQsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDdEQ7SUFDSCxDQUFDO0lBYkQsSUFBWSxVQUFVO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFtQyxDQUFDO0lBQy9ELENBQUM7SUFhRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsWUFBWTtRQUNWLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsMkJBQTJCO1FBRXpCLG1CQUFtQjtRQUNuQixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzdFLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDbkIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakI7UUFFRCxTQUFTO1FBQ1QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7UUFDdkYsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FDM0IsU0FBUyxDQUFDLENBQUMsYUFBc0IsRUFBRSxFQUFFO1lBQ25DLElBQUksYUFBYSxLQUFLLEtBQUssRUFBRTtnQkFDM0IsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDbEI7aUJBQU07Z0JBQ0wsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakI7UUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFDO1FBRUYsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksc0JBQXNCO1FBQzNCLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7T0FFRztJQUNJLGtCQUFrQjtRQUN2QixPQUFPLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNuQixDQUFDOzs7WUFoRUYsVUFBVTs7OztZQVZNLFlBQVk7WUFEcEIsb0JBQW9CO1lBR3BCLGtCQUFrQjtZQUNsQixlQUFlLHVCQWtCbkIsUUFBUTs7QUF3RGIsT0FBTyxFQUFFLGNBQWMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBGYXJyaXNTaWRlYmFyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktc2lkZWJhcic7XG5pbXBvcnQgeyBFbnRpdHksIEZyYW1lQ29udGV4dCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tICdAZmFycmlzL2JlZic7XG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcblxuXG4vKipcbiAqIOS+p+i+ueagj+acjeWKoVxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIFNpZGViYXJTZXJ2aWNlIHtcblxuICBwcml2YXRlIGdldCByZXBvc2l0b3J5KCk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxFbnRpdHk+O1xuICB9XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcbiAgICBwcml2YXRlIHNpZGViYXJVSVNlcnZpY2U6IEZhcnJpc1NpZGViYXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICApIHtcbiAgICBpZiAoIXRoaXMubGFuZ3VhZ2VTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICAgIH1cbiAgfVxuXG4gIG9wZW5TaWRlYmFyKCkge1xuICAgIHRoaXMuc2lkZWJhclVJU2VydmljZS5zZW5kSXNPcGVuKHRydWUpO1xuICB9XG5cbiAgY2xvc2VTaWRlYmFyKCkge1xuICAgIHRoaXMuc2lkZWJhclVJU2VydmljZS5zZW5kSXNPcGVuKGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlhbPpl63liY3lhYjlj5bmtojlj5jmm7RcbiAgICovXG4gIGNvbmZpcm1CZWZvcmVDbG9zaW5nU2lkZWJhcigpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcblxuICAgIC8vIOajgOafpeaYr+WQpuacieWPmOabtO+8jOayoeacieWPmOabtOebtOaOpeWFs+mXrVxuICAgIGNvbnN0IGlmQ2hhbmdlc0V4aXN0ID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuY2hlY2tBbGxFbnRpdHlDaGFuZ2VzKCk7XG4gICAgaWYgKCFpZkNoYW5nZXNFeGlzdCkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cblxuICAgIC8vIOehruiupOaYr+WQpuWFs+mXrVxuICAgIGNvbnN0IGNvbmZpcm0kID0gdGhpcy5tZXNzYWdlU2VydmljZS5xdWVzdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZVsnZXhpdFdpdGhvdXRTYXZlJ10pO1xuICAgIGNvbnN0IHJlc3VsdCQgPSBjb25maXJtJC5waXBlKFxuICAgICAgc3dpdGNoTWFwKChjb25maXJtUmVzdWx0OiBib29sZWFuKSA9PiB7XG4gICAgICAgIGlmIChjb25maXJtUmVzdWx0ID09PSBmYWxzZSkge1xuICAgICAgICAgIHJldHVybiBvZihmYWxzZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gcmVzdWx0JDtcbiAgfVxuXG4gIC8qKlxuICAgKiDnu6fnu63lhbPpl63kvqfovrnmoI9cbiAgICovXG4gIHB1YmxpYyBjb250aW51ZUNsb3NpbmdTaWRlYmFyKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiBvZih0cnVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDpmLvmraLkvqfovrnmoI/lhbPpl61cbiAgICovXG4gIHB1YmxpYyBzdG9wQ2xvc2luZ1NpZGViYXIoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgfVxufVxuXG5leHBvcnQgeyBTaWRlYmFyU2VydmljZSB9O1xuIl19