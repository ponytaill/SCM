/**
 * 树数据的帮助类
 */
class ParentTreeNodeUtil {
    /**
     * 选中第一个根节点
     */
    selectFirstRootNode(bindingData, hierarchyInfoKey) {
        const treeNodesData = bindingData.list.toJSON();
        const firstRootNodeId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        this.selectedNode(bindingData, hierarchyInfoKey, firstRootNodeId);
    }
    selectNodeByBindingList(bindingList, hierarchyInfoKey, selectedNodeId) {
        const treeNodesData = bindingList.toJSON();
        // 如果要设置的节点不存在，则设置第1个根节点
        const selectedNodeData = this.getNodeDataById(treeNodesData, selectedNodeId);
        let currentId = selectedNodeId;
        if (!selectedNodeData) {
            currentId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        }
        setTimeout(() => {
            bindingList.setCurrentId(currentId, true, true);
        }, 0);
    }
    /**
     * 选中节点
     */
    selectedNode(bindingData, hierarchyInfoKey, selectedNodeId) {
        const treeNodesData = bindingData.list.toJSON();
        // 如果要设置的节点不存在，则设置第1个根节点
        const selectedNodeData = this.getNodeDataById(treeNodesData, selectedNodeId);
        let currentId = selectedNodeId;
        if (!selectedNodeData) {
            currentId = this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
        }
        if (bindingData.rowSelectedEventSuspend === true) {
            return;
        }
        setTimeout(() => {
            bindingData.list.currentId = null;
            bindingData.list.setCurrentId(currentId, true, true);
        }, 0);
    }
    /**
     * 检查是否有子节点
     */
    hasChildNodes(treeNodesData, hierarchyInfoKey, fid) {
        const fNodeData = this.getNodeDataById(treeNodesData, fid);
        // const fLayer = fNodeData[hierarchyInfoKey]['layer'];
        const fIsDetail = fNodeData[hierarchyInfoKey]['isDetail'];
        // 非明细节点，返回true
        if (fIsDetail === false) {
            return true;
        }
        return false;
        // const childNodesData = this.getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fid);
        // return childNodesData.length > 0;
    }
    /**
     * 获取根节点（多个根节点时获取第一个）
     * @return 找不到时返回null
     */
    getFirstNodeId(treeNodesData, hierarchyInfoKey) {
        let rootData = treeNodesData.find((itemData) => {
            const layer = itemData[hierarchyInfoKey]['layer'];
            return layer === 1;
        });
        if (!rootData) {
            const rootLayer = this.getRootLayer(treeNodesData, hierarchyInfoKey);
            rootData = treeNodesData.find((itemData) => {
                const layer = itemData[hierarchyInfoKey]['layer'];
                return layer === rootLayer;
            });
        }
        return rootData ? rootData['id'] : '';
    }
    getRootLayer(treeNodesData, hierarchyInfoKey) {
        let layer = null;
        if (treeNodesData && Array.isArray(treeNodesData)) {
            const layers = treeNodesData.map(item => {
                const layer = item[hierarchyInfoKey]['layer'];
                return layer;
            });
            const minLayer = Math.min.apply(Math, layers);
            if (!isNaN(minLayer)) {
                layer = minLayer;
            }
        }
        return layer;
    }
    /**
     * 获取下一个节点（删除后）
     */
    getNextNodeId(treeNodesData, hierarchyInfoKey, currentId) {
        // 当前节点信息
        const currentNodeData = treeNodesData.find((itemData) => {
            return itemData['id'] === currentId;
        });
        const currentLayer = currentNodeData[hierarchyInfoKey]['layer'];
        // 父节点信息
        const fLayer = currentLayer - 1;
        const fParentElement = currentNodeData[hierarchyInfoKey]['parentElement'];
        // 查找兄弟节点
        const siblingtreeNodesData = this.getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fParentElement);
        // 如果没有兄弟节点，向上查找
        if (siblingtreeNodesData.length === 1) {
            const parentData = treeNodesData.find((itemData) => {
                return itemData['id'] === fParentElement;
            });
            // 存在父节点，则设置父节点；
            // 不存在父节点，则设置第一个根节点。
            if (!parentData) {
                return this.getFirstNodeId(treeNodesData, hierarchyInfoKey);
            }
            return parentData['id'];
        }
        else {
            return this.getNextSiblingNodeId(siblingtreeNodesData, currentId);
        }
    }
    /**
     * 获取下个兄弟节点的id
     */
    getNextSiblingNodeId(siblingtreeNodesData, currentId) {
        if (siblingtreeNodesData.length <= 1) {
            return '';
        }
        const currentIndex = siblingtreeNodesData.findIndex((itemData) => {
            return itemData['id'] === currentId;
        });
        // 最后一行上移一行，其他下移一行
        let nextIndex = -1;
        if (currentIndex === siblingtreeNodesData.length - 1) {
            nextIndex = currentIndex - 1;
        }
        else {
            nextIndex = currentIndex + 1;
        }
        return siblingtreeNodesData[nextIndex]['id'];
    }
    /**
     * 获取下级节点的BindingObjects集合
     */
    getChildNodesData(treeNodesData, hierarchyInfoKey, fLayer, fParentElement) {
        const childtreeNodesData = treeNodesData.filter((itemData) => {
            const layer = itemData[hierarchyInfoKey]['layer'];
            const parentElement = itemData[hierarchyInfoKey]['parentElement'];
            return (layer === fLayer + 1) && fParentElement == parentElement;
        });
        return childtreeNodesData;
    }
    /**
     * 获取id获取节点数据
     */
    getNodeDataById(treeNodesData, id) {
        const nodeData = treeNodesData.find((itemData) => {
            return itemData['id'] === id;
        });
        return nodeData ? nodeData : null;
    }
}
export { ParentTreeNodeUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyZW50LXRyZWUudXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3RyZWUtdGFibGUvdXRpbC9wYXJlbnQtdHJlZS51dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBOztHQUVHO0FBQ0gsTUFBTSxrQkFBa0I7SUFFdEI7O09BRUc7SUFDSSxtQkFBbUIsQ0FBQyxXQUF3QixFQUFFLGdCQUF3QjtRQUUzRSxNQUFNLGFBQWEsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hELE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDcEUsQ0FBQztJQUNNLHVCQUF1QixDQUFDLFdBQXdCLEVBQUUsZ0JBQXdCLEVBQUUsY0FBc0I7UUFDdkcsTUFBTSxhQUFhLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzNDLHdCQUF3QjtRQUN4QixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzdFLElBQUksU0FBUyxHQUFHLGNBQWMsQ0FBQztRQUMvQixJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDckIsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxFQUFFLGdCQUFnQixDQUFDLENBQUM7U0FDbEU7UUFDRCxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2QsV0FBVyxDQUFDLFlBQVksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2xELENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7SUFDRDs7T0FFRztJQUNJLFlBQVks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LElBQUksYUFBYSxDQUFDO1FBQ25FLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxrQkFBa0IsQ0FBQztJQUM1QixDQUFDO0lBRUQ7O09BRUc7SUFDSSxlQUFlLENBQUMsYUFBb0IsRUFBRSxFQUFVO1FBQ3JELE1BQU0sUUFBUSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFhLEVBQUUsRUFBRTtZQUNwRCxPQUFPLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDcEMsQ0FBQztDQUNGO0FBRUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCaW5kaW5nRGF0YSwgQmluZGluZ0xpc3QgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5cbi8qKlxuICog5qCR5pWw5o2u55qE5biu5Yqp57G7XG4gKi9cbmNsYXNzIFBhcmVudFRyZWVOb2RlVXRpbCB7XG5cbiAgLyoqXG4gICAqIOmAieS4reesrOS4gOS4quagueiKgueCuVxuICAgKi9cbiAgcHVibGljIHNlbGVjdEZpcnN0Um9vdE5vZGUoYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcpIHtcblxuICAgIGNvbnN0IHRyZWVOb2Rlc0RhdGEgPSBiaW5kaW5nRGF0YS5saXN0LnRvSlNPTigpO1xuICAgIGNvbnN0IGZpcnN0Um9vdE5vZGVJZCA9IHRoaXMuZ2V0Rmlyc3ROb2RlSWQodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgdGhpcy5zZWxlY3RlZE5vZGUoYmluZGluZ0RhdGEsIGhpZXJhcmNoeUluZm9LZXksIGZpcnN0Um9vdE5vZGVJZCk7XG4gIH1cbiAgcHVibGljIHNlbGVjdE5vZGVCeUJpbmRpbmdMaXN0KGJpbmRpbmdMaXN0OiBCaW5kaW5nTGlzdCwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBzZWxlY3RlZE5vZGVJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgdHJlZU5vZGVzRGF0YSA9IGJpbmRpbmdMaXN0LnRvSlNPTigpO1xuICAgIC8vIOWmguaenOimgeiuvue9rueahOiKgueCueS4jeWtmOWcqO+8jOWImeiuvue9ruesrDHkuKrmoLnoioLngrlcbiAgICBjb25zdCBzZWxlY3RlZE5vZGVEYXRhID0gdGhpcy5nZXROb2RlRGF0YUJ5SWQodHJlZU5vZGVzRGF0YSwgc2VsZWN0ZWROb2RlSWQpO1xuICAgIGxldCBjdXJyZW50SWQgPSBzZWxlY3RlZE5vZGVJZDtcbiAgICBpZiAoIXNlbGVjdGVkTm9kZURhdGEpIHtcbiAgICAgIGN1cnJlbnRJZCA9IHRoaXMuZ2V0Rmlyc3ROb2RlSWQodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgfVxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgYmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGN1cnJlbnRJZCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgfSwgMCk7XG4gIH1cbiAgLyoqXG4gICAqIOmAieS4reiKgueCuVxuICAgKi9cbiAgcHVibGljIHNlbGVjdGVkTm9kZShiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEsIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgc2VsZWN0ZWROb2RlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IHRyZWVOb2Rlc0RhdGEgPSBiaW5kaW5nRGF0YS5saXN0LnRvSlNPTigpO1xuICAgIC8vIOWmguaenOimgeiuvue9rueahOiKgueCueS4jeWtmOWcqO+8jOWImeiuvue9ruesrDHkuKrmoLnoioLngrlcbiAgICBjb25zdCBzZWxlY3RlZE5vZGVEYXRhID0gdGhpcy5nZXROb2RlRGF0YUJ5SWQodHJlZU5vZGVzRGF0YSwgc2VsZWN0ZWROb2RlSWQpO1xuICAgIGxldCBjdXJyZW50SWQgPSBzZWxlY3RlZE5vZGVJZDtcbiAgICBpZiAoIXNlbGVjdGVkTm9kZURhdGEpIHtcbiAgICAgIGN1cnJlbnRJZCA9IHRoaXMuZ2V0Rmlyc3ROb2RlSWQodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgfVxuICAgIGlmIChiaW5kaW5nRGF0YS5yb3dTZWxlY3RlZEV2ZW50U3VzcGVuZCA9PT0gdHJ1ZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkID0gbnVsbDtcbiAgICAgIGJpbmRpbmdEYXRhLmxpc3Quc2V0Q3VycmVudElkKGN1cnJlbnRJZCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgfSwgMCk7XG4gIH1cblxuICAvKipcbiAgICog5qOA5p+l5piv5ZCm5pyJ5a2Q6IqC54K5XG4gICAqL1xuICBwdWJsaWMgaGFzQ2hpbGROb2Rlcyh0cmVlTm9kZXNEYXRhOiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBmaWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGZOb2RlRGF0YSA9IHRoaXMuZ2V0Tm9kZURhdGFCeUlkKHRyZWVOb2Rlc0RhdGEsIGZpZCk7XG4gICAgLy8gY29uc3QgZkxheWVyID0gZk5vZGVEYXRhW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xuICAgIGNvbnN0IGZJc0RldGFpbCA9IGZOb2RlRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsnaXNEZXRhaWwnXTtcblxuICAgIC8vIOmdnuaYjue7huiKgueCue+8jOi/lOWbnnRydWVcbiAgICBpZiAoZklzRGV0YWlsID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcblxuICAgIC8vIGNvbnN0IGNoaWxkTm9kZXNEYXRhID0gdGhpcy5nZXRDaGlsZE5vZGVzRGF0YSh0cmVlTm9kZXNEYXRhLCBoaWVyYXJjaHlJbmZvS2V5LCBmTGF5ZXIsIGZpZCk7XG4gICAgLy8gcmV0dXJuIGNoaWxkTm9kZXNEYXRhLmxlbmd0aCA+IDA7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5qC56IqC54K577yI5aSa5Liq5qC56IqC54K55pe26I635Y+W56ys5LiA5Liq77yJXG4gICAqIEByZXR1cm4g5om+5LiN5Yiw5pe26L+U5ZuebnVsbFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRGaXJzdE5vZGVJZCh0cmVlTm9kZXNEYXRhOiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBsZXQgcm9vdERhdGEgPSB0cmVlTm9kZXNEYXRhLmZpbmQoKGl0ZW1EYXRhOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IGxheWVyID0gaXRlbURhdGFbaGllcmFyY2h5SW5mb0tleV1bJ2xheWVyJ107XG4gICAgICByZXR1cm4gbGF5ZXIgPT09IDE7XG4gICAgfSk7XG4gICAgaWYgKCFyb290RGF0YSkge1xuICAgICAgY29uc3Qgcm9vdExheWVyID0gdGhpcy5nZXRSb290TGF5ZXIodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgICByb290RGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmluZCgoaXRlbURhdGE6IGFueSkgPT4ge1xuICAgICAgICBjb25zdCBsYXllciA9IGl0ZW1EYXRhW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xuICAgICAgICByZXR1cm4gbGF5ZXIgPT09IHJvb3RMYXllcjtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcm9vdERhdGEgPyByb290RGF0YVsnaWQnXSA6ICcnO1xuICB9XG4gIHByaXZhdGUgZ2V0Um9vdExheWVyKHRyZWVOb2Rlc0RhdGE6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcpIHtcbiAgICBsZXQgbGF5ZXIgPSBudWxsO1xuICAgIGlmICh0cmVlTm9kZXNEYXRhICYmIEFycmF5LmlzQXJyYXkodHJlZU5vZGVzRGF0YSkpIHtcbiAgICAgIGNvbnN0IGxheWVycyA9IHRyZWVOb2Rlc0RhdGEubWFwKGl0ZW0gPT4ge1xuICAgICAgICBjb25zdCBsYXllciA9IGl0ZW1baGllcmFyY2h5SW5mb0tleV1bJ2xheWVyJ107XG4gICAgICAgIHJldHVybiBsYXllcjtcbiAgICAgIH0pO1xuICAgICAgY29uc3QgbWluTGF5ZXIgPSBNYXRoLm1pbi5hcHBseShNYXRoLCBsYXllcnMpO1xuICAgICAgaWYgKCFpc05hTihtaW5MYXllcikpIHtcbiAgICAgICAgbGF5ZXIgPSBtaW5MYXllcjtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGxheWVyO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bkuIvkuIDkuKroioLngrnvvIjliKDpmaTlkI7vvIlcbiAgICovXG4gIHB1YmxpYyBnZXROZXh0Tm9kZUlkKHRyZWVOb2Rlc0RhdGE6IGFueVtdLCBoaWVyYXJjaHlJbmZvS2V5OiBzdHJpbmcsIGN1cnJlbnRJZDogc3RyaW5nKTogc3RyaW5nIHtcblxuICAgIC8vIOW9k+WJjeiKgueCueS/oeaBr1xuICAgIGNvbnN0IGN1cnJlbnROb2RlRGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmluZCgoaXRlbURhdGE6IGFueSkgPT4ge1xuICAgICAgcmV0dXJuIGl0ZW1EYXRhWydpZCddID09PSBjdXJyZW50SWQ7XG4gICAgfSk7XG4gICAgY29uc3QgY3VycmVudExheWVyID0gY3VycmVudE5vZGVEYXRhW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xuXG4gICAgLy8g54i26IqC54K55L+h5oGvXG4gICAgY29uc3QgZkxheWVyID0gY3VycmVudExheWVyIC0gMTtcbiAgICBjb25zdCBmUGFyZW50RWxlbWVudCA9IGN1cnJlbnROb2RlRGF0YVtoaWVyYXJjaHlJbmZvS2V5XVsncGFyZW50RWxlbWVudCddO1xuXG4gICAgLy8g5p+l5om+5YWE5byf6IqC54K5XG4gICAgY29uc3Qgc2libGluZ3RyZWVOb2Rlc0RhdGEgPSB0aGlzLmdldENoaWxkTm9kZXNEYXRhKHRyZWVOb2Rlc0RhdGEsIGhpZXJhcmNoeUluZm9LZXksIGZMYXllciwgZlBhcmVudEVsZW1lbnQpO1xuXG4gICAgLy8g5aaC5p6c5rKh5pyJ5YWE5byf6IqC54K577yM5ZCR5LiK5p+l5om+XG4gICAgaWYgKHNpYmxpbmd0cmVlTm9kZXNEYXRhLmxlbmd0aCA9PT0gMSkge1xuICAgICAgY29uc3QgcGFyZW50RGF0YSA9IHRyZWVOb2Rlc0RhdGEuZmluZCgoaXRlbURhdGE6IGFueSkgPT4ge1xuICAgICAgICByZXR1cm4gaXRlbURhdGFbJ2lkJ10gPT09IGZQYXJlbnRFbGVtZW50O1xuICAgICAgfSk7XG5cbiAgICAgIC8vIOWtmOWcqOeItuiKgueCue+8jOWImeiuvue9rueItuiKgueCue+8m1xuICAgICAgLy8g5LiN5a2Y5Zyo54i26IqC54K577yM5YiZ6K6+572u56ys5LiA5Liq5qC56IqC54K544CCXG4gICAgICBpZiAoIXBhcmVudERhdGEpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Rmlyc3ROb2RlSWQodHJlZU5vZGVzRGF0YSwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcGFyZW50RGF0YVsnaWQnXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0TmV4dFNpYmxpbmdOb2RlSWQoc2libGluZ3RyZWVOb2Rlc0RhdGEsIGN1cnJlbnRJZCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluS4i+S4quWFhOW8n+iKgueCueeahGlkXG4gICAqL1xuICBwdWJsaWMgZ2V0TmV4dFNpYmxpbmdOb2RlSWQoc2libGluZ3RyZWVOb2Rlc0RhdGE6IGFueVtdLCBjdXJyZW50SWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHNpYmxpbmd0cmVlTm9kZXNEYXRhLmxlbmd0aCA8PSAxKSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgY29uc3QgY3VycmVudEluZGV4ID0gc2libGluZ3RyZWVOb2Rlc0RhdGEuZmluZEluZGV4KChpdGVtRGF0YTogYW55KSA9PiB7XG4gICAgICByZXR1cm4gaXRlbURhdGFbJ2lkJ10gPT09IGN1cnJlbnRJZDtcbiAgICB9KTtcblxuICAgIC8vIOacgOWQjuS4gOihjOS4iuenu+S4gOihjO+8jOWFtuS7luS4i+enu+S4gOihjFxuICAgIGxldCBuZXh0SW5kZXggPSAtMTtcbiAgICBpZiAoY3VycmVudEluZGV4ID09PSBzaWJsaW5ndHJlZU5vZGVzRGF0YS5sZW5ndGggLSAxKSB7XG4gICAgICBuZXh0SW5kZXggPSBjdXJyZW50SW5kZXggLSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICBuZXh0SW5kZXggPSBjdXJyZW50SW5kZXggKyAxO1xuICAgIH1cblxuICAgIHJldHVybiBzaWJsaW5ndHJlZU5vZGVzRGF0YVtuZXh0SW5kZXhdWydpZCddO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluS4i+e6p+iKgueCueeahEJpbmRpbmdPYmplY3Rz6ZuG5ZCIXG4gICAqL1xuICBwdWJsaWMgZ2V0Q2hpbGROb2Rlc0RhdGEodHJlZU5vZGVzRGF0YTogYW55W10sIGhpZXJhcmNoeUluZm9LZXk6IHN0cmluZywgZkxheWVyOiBudW1iZXIsIGZQYXJlbnRFbGVtZW50OiBzdHJpbmcpOiBhbnlbXSB7XG4gICAgY29uc3QgY2hpbGR0cmVlTm9kZXNEYXRhID0gdHJlZU5vZGVzRGF0YS5maWx0ZXIoKGl0ZW1EYXRhKSA9PiB7XG4gICAgICBjb25zdCBsYXllciA9IGl0ZW1EYXRhW2hpZXJhcmNoeUluZm9LZXldWydsYXllciddO1xuICAgICAgY29uc3QgcGFyZW50RWxlbWVudCA9IGl0ZW1EYXRhW2hpZXJhcmNoeUluZm9LZXldWydwYXJlbnRFbGVtZW50J107XG4gICAgICByZXR1cm4gKGxheWVyID09PSBmTGF5ZXIgKyAxKSAmJiBmUGFyZW50RWxlbWVudCA9PSBwYXJlbnRFbGVtZW50O1xuICAgIH0pO1xuICAgIHJldHVybiBjaGlsZHRyZWVOb2Rlc0RhdGE7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+WaWTojrflj5boioLngrnmlbDmja5cbiAgICovXG4gIHB1YmxpYyBnZXROb2RlRGF0YUJ5SWQodHJlZU5vZGVzRGF0YTogYW55W10sIGlkOiBzdHJpbmcpOiBhbnkge1xuICAgIGNvbnN0IG5vZGVEYXRhID0gdHJlZU5vZGVzRGF0YS5maW5kKChpdGVtRGF0YTogYW55KSA9PiB7XG4gICAgICByZXR1cm4gaXRlbURhdGFbJ2lkJ10gPT09IGlkO1xuICAgIH0pO1xuICAgIHJldHVybiBub2RlRGF0YSA/IG5vZGVEYXRhIDogbnVsbDtcbiAgfVxufVxuXG5leHBvcnQgeyBQYXJlbnRUcmVlTm9kZVV0aWwgfTtcbiJdfQ==