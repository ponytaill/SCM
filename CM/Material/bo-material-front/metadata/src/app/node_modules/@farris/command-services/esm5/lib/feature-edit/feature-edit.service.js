import { Injectable, Injector } from "@angular/core";
import { FeatureEditorService } from '@farris/ui-feature-editor';
import { FormNotifyService } from "../form-notify.service";
import { map, switchMap, tap } from "rxjs/operators";
import { FormLoadingService } from "../form-loading/form-loading.service";
import { FeatureDataService } from './feature-data.service';
import { LanguageService } from '../languag.service';
import { of } from "rxjs";
var FeatureEditService = /** @class */ (function () {
    function FeatureEditService(injector, featureEditorService, featureDataService, loadingService, notifyService, languageService) {
        this.injector = injector;
        this.featureEditorService = featureEditorService;
        this.featureDataService = featureDataService;
        this.loadingService = loadingService;
        this.notifyService = notifyService;
        this.languageService = languageService;
    }
    FeatureEditService.prototype.edit = function (materialId, materialFeatureId, options) {
        var _this = this;
        if (!materialId) {
            throw new Error('[FeatureEditService]物料id不能为空！');
        }
        if (!options) {
            options = {};
        }
        if (typeof options === 'string' && options.startsWith('{') && options.endsWith('}')) {
            options = JSON.parse(options);
        }
        options.getHelpInfo = this.featureDataService.getHelpInfo;
        this.loadingService.show();
        return this.featureDataService.getFeaturesByMaterialId(materialId).pipe(tap(function (result) {
            _this.loadingService.hide();
            var returnValue = result || null;
            if (returnValue) {
                var featureInfo = JSON.parse(returnValue);
                var props = featureInfo.props || null;
                if (!props || props.length < 1) {
                    _this.notifyService.warning(_this.languageService.propsIsEmpty);
                    return;
                }
                _this.featureEditorService.show(props, options);
            }
            else {
                _this.notifyService.error(_this.languageService.propsIsEmpty);
            }
        }));
    };
    FeatureEditService.prototype.buildFeatures = function (materialId, materialFeatureId) {
        var _this = this;
        var features$ = this.featureDataService.getFeaturesByMaterialId(materialId);
        return features$.pipe(switchMap(function (featureSet) {
            if (materialFeatureId) {
                var configedFeatures$ = _this.featureDataService.getConfigedValueByFeatureId(materialFeatureId, materialFeatureId);
                return configedFeatures$.pipe(map(function (defaultConfigs) {
                    var featureTemplate = featureSet.props;
                    var features = _this.mergeFeatures(featureTemplate, defaultConfigs);
                    return features;
                }));
            }
            else {
                return of(featureSet.props);
            }
        }));
    };
    FeatureEditService.prototype.mergeFeatures = function (featureTemplate, defaultConfigs) {
        return null;
    };
    FeatureEditService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    FeatureEditService.ctorParameters = function () { return [
        { type: Injector },
        { type: FeatureEditorService },
        { type: FeatureDataService },
        { type: FormLoadingService },
        { type: FormNotifyService },
        { type: LanguageService }
    ]; };
    return FeatureEditService;
}());
export { FeatureEditService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmVhdHVyZS1lZGl0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZmVhdHVyZS1lZGl0L2ZlYXR1cmUtZWRpdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRTFCO0lBRUUsNEJBQ1UsUUFBa0IsRUFDbEIsb0JBQTBDLEVBQzFDLGtCQUFzQyxFQUN0QyxjQUFrQyxFQUNsQyxhQUFnQyxFQUNoQyxlQUFnQztRQUxoQyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxtQkFBYyxHQUFkLGNBQWMsQ0FBb0I7UUFDbEMsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtJQUN0QyxDQUFDO0lBRUUsaUNBQUksR0FBWCxVQUFZLFVBQWtCLEVBQUUsaUJBQTBCLEVBQUUsT0FBYTtRQUF6RSxpQkE2QkM7UUE1QkMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztTQUNsRDtRQUNELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLEdBQUcsRUFBRSxDQUFDO1NBQ2Q7UUFDRCxJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDbkYsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDL0I7UUFDRCxPQUFPLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLENBQUM7UUFDMUQsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMzQixPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQ3JFLEdBQUcsQ0FBQyxVQUFDLE1BQVc7WUFDZCxLQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzNCLElBQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxJQUFJLENBQUM7WUFDbkMsSUFBSSxXQUFXLEVBQUU7Z0JBQ2YsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDNUMsSUFBTSxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQzlCLEtBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEtBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7b0JBQzlELE9BQU87aUJBQ1I7Z0JBQ0QsS0FBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7YUFDaEQ7aUJBQU07Z0JBQ0wsS0FBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsS0FBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUM3RDtRQUNILENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBQ08sMENBQWEsR0FBckIsVUFBc0IsVUFBa0IsRUFBRSxpQkFBMEI7UUFBcEUsaUJBbUJDO1FBbEJDLElBQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM5RSxPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQ25CLFNBQVMsQ0FBQyxVQUFBLFVBQVU7WUFDbEIsSUFBSSxpQkFBaUIsRUFBRTtnQkFDckIsSUFBTSxpQkFBaUIsR0FBRyxLQUFJLENBQUMsa0JBQWtCLENBQUMsMkJBQTJCLENBQUMsaUJBQWlCLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztnQkFDcEgsT0FBTyxpQkFBaUIsQ0FBQyxJQUFJLENBQzNCLEdBQUcsQ0FBQyxVQUFBLGNBQWM7b0JBQ2hCLElBQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUM7b0JBQ3pDLElBQU0sUUFBUSxHQUFHLEtBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxFQUFFLGNBQWMsQ0FBQyxDQUFDO29CQUNyRSxPQUFPLFFBQVEsQ0FBQztnQkFDbEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQzthQUNIO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUM3QjtRQUNILENBQUMsQ0FBQyxDQUNILENBQUM7SUFFSixDQUFDO0lBQ08sMENBQWEsR0FBckIsVUFBc0IsZUFBb0IsRUFBRSxjQUFtQjtRQUM3RCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7O2dCQS9ERixVQUFVOzs7O2dCQVRVLFFBQVE7Z0JBQ3BCLG9CQUFvQjtnQkFJcEIsa0JBQWtCO2dCQURsQixrQkFBa0I7Z0JBRmxCLGlCQUFpQjtnQkFJakIsZUFBZTs7SUFtRXhCLHlCQUFDO0NBQUEsQUFoRUQsSUFnRUM7U0EvRFksa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgRmVhdHVyZUVkaXRvclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWZlYXR1cmUtZWRpdG9yJztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSBcIi4uL2Zvcm0tbm90aWZ5LnNlcnZpY2VcIjtcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gXCIuLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2VcIjtcbmltcG9ydCB7IEZlYXR1cmVEYXRhU2VydmljZSB9IGZyb20gJy4vZmVhdHVyZS1kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vbGFuZ3VhZy5zZXJ2aWNlJztcbmltcG9ydCB7IG9mIH0gZnJvbSBcInJ4anNcIjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEZlYXR1cmVFZGl0U2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByaXZhdGUgZmVhdHVyZUVkaXRvclNlcnZpY2U6IEZlYXR1cmVFZGl0b3JTZXJ2aWNlLFxuICAgIHByaXZhdGUgZmVhdHVyZURhdGFTZXJ2aWNlOiBGZWF0dXJlRGF0YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLFxuICAgIHByaXZhdGUgbm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcbiAgKSB7IH1cblxuICBwdWJsaWMgZWRpdChtYXRlcmlhbElkOiBzdHJpbmcsIG1hdGVyaWFsRmVhdHVyZUlkPzogc3RyaW5nLCBvcHRpb25zPzogYW55KSB7XG4gICAgaWYgKCFtYXRlcmlhbElkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tGZWF0dXJlRWRpdFNlcnZpY2Vd54mp5paZaWTkuI3og73kuLrnqbrvvIEnKTtcbiAgICB9XG4gICAgaWYgKCFvcHRpb25zKSB7XG4gICAgICBvcHRpb25zID0ge307XG4gICAgfVxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycgJiYgb3B0aW9ucy5zdGFydHNXaXRoKCd7JykgJiYgb3B0aW9ucy5lbmRzV2l0aCgnfScpKSB7XG4gICAgICBvcHRpb25zID0gSlNPTi5wYXJzZShvcHRpb25zKTtcbiAgICB9XG4gICAgb3B0aW9ucy5nZXRIZWxwSW5mbyA9IHRoaXMuZmVhdHVyZURhdGFTZXJ2aWNlLmdldEhlbHBJbmZvO1xuICAgIHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgIHJldHVybiB0aGlzLmZlYXR1cmVEYXRhU2VydmljZS5nZXRGZWF0dXJlc0J5TWF0ZXJpYWxJZChtYXRlcmlhbElkKS5waXBlKFxuICAgICAgdGFwKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgICAgY29uc3QgcmV0dXJuVmFsdWUgPSByZXN1bHQgfHwgbnVsbDtcbiAgICAgICAgaWYgKHJldHVyblZhbHVlKSB7XG4gICAgICAgICAgY29uc3QgZmVhdHVyZUluZm8gPSBKU09OLnBhcnNlKHJldHVyblZhbHVlKTtcbiAgICAgICAgICBjb25zdCBwcm9wcyA9IGZlYXR1cmVJbmZvLnByb3BzIHx8IG51bGw7XG4gICAgICAgICAgaWYgKCFwcm9wcyB8fCBwcm9wcy5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wcm9wc0lzRW1wdHkpO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLmZlYXR1cmVFZGl0b3JTZXJ2aWNlLnNob3cocHJvcHMsIG9wdGlvbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubm90aWZ5U2VydmljZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZS5wcm9wc0lzRW1wdHkpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgcHJpdmF0ZSBidWlsZEZlYXR1cmVzKG1hdGVyaWFsSWQ6IHN0cmluZywgbWF0ZXJpYWxGZWF0dXJlSWQ/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBmZWF0dXJlcyQgPSB0aGlzLmZlYXR1cmVEYXRhU2VydmljZS5nZXRGZWF0dXJlc0J5TWF0ZXJpYWxJZChtYXRlcmlhbElkKTtcbiAgICByZXR1cm4gZmVhdHVyZXMkLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoZmVhdHVyZVNldCA9PiB7XG4gICAgICAgIGlmIChtYXRlcmlhbEZlYXR1cmVJZCkge1xuICAgICAgICAgIGNvbnN0IGNvbmZpZ2VkRmVhdHVyZXMkID0gdGhpcy5mZWF0dXJlRGF0YVNlcnZpY2UuZ2V0Q29uZmlnZWRWYWx1ZUJ5RmVhdHVyZUlkKG1hdGVyaWFsRmVhdHVyZUlkLCBtYXRlcmlhbEZlYXR1cmVJZCk7XG4gICAgICAgICAgcmV0dXJuIGNvbmZpZ2VkRmVhdHVyZXMkLnBpcGUoXG4gICAgICAgICAgICBtYXAoZGVmYXVsdENvbmZpZ3MgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBmZWF0dXJlVGVtcGxhdGUgPSBmZWF0dXJlU2V0LnByb3BzO1xuICAgICAgICAgICAgICBjb25zdCBmZWF0dXJlcyA9IHRoaXMubWVyZ2VGZWF0dXJlcyhmZWF0dXJlVGVtcGxhdGUsIGRlZmF1bHRDb25maWdzKTtcbiAgICAgICAgICAgICAgcmV0dXJuIGZlYXR1cmVzO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBvZihmZWF0dXJlU2V0LnByb3BzKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuXG4gIH1cbiAgcHJpdmF0ZSBtZXJnZUZlYXR1cmVzKGZlYXR1cmVUZW1wbGF0ZTogYW55LCBkZWZhdWx0Q29uZmlnczogYW55KSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn0iXX0=