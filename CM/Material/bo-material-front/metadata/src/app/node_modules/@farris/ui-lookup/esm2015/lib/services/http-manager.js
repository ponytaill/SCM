/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
import { FavoriteAction, LookupGridDisplayType } from '../lookup-displaytype';
import { of } from 'rxjs';
import { map, switchMap, tap } from 'rxjs/operators';
// 帮助默认个性化数据
/** @type {?} */
const DefaultUserConfig = {
    tabIndex: 'datalist',
    favorite: null,
    size: null
};
export class LookupHttpManager {
    /**
     * @param {?} ins
     */
    constructor(ins) {
        this.ins = ins;
        // 每次帮助打开后，更新此值，做为个性化数据的初始值；
        // 关闭窗口时，与此进行对比。如果一样，则不保存；
        this._originalPersonalConfig = DefaultUserConfig;
    }
    /**
     * @private
     * @return {?}
     */
    disablePagination() {
        return {
            pageIndex: 1,
            pageSize: 500
        };
    }
    /**
     * 构造查询参数
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    buildQueryParams(event, type = 'all') {
        /** @type {?} */
        const params = {};
        if (this.ins.condition) {
            params.condition = cloneDeep(this.ins.condition);
        }
        /** @type {?} */
        const searchParam = { category: type };
        if (type !== 'fav') {
            if (this.ins.isDoublleList() && this.ins.navigationFilter && type !== 'all') {
                if (this.ins.navigationFilter.idValue && type !== 'textchange') {
                    params.relationFilter = [...this.ins.navigationFilter.idValue];
                }
            }
        }
        if (event) {
            if (type === 'fav' || type === 'selected') {
                event.pageInfo = this.disablePagination();
            }
            if (event.pageInfo) {
                params.pageIndex = event.pageInfo.pageIndex;
                params.pageSize = event.pageInfo.pageSize;
            }
            if (event.search) {
                /** @type {?} */
                let sfield = event.search.field;
                if (sfield && sfield === '*') {
                    sfield = '*';
                }
                if (event.search.value) {
                    event.search.value = event.search.value.trim();
                }
                searchParam.searchField = sfield;
                searchParam.searchValue = event.search.value;
                searchParam.searchType = event.search.type || 'like';
                if (event.search.value === '' && searchParam.category === 'search') {
                    searchParam.category = 'all';
                }
            }
            if (event.sortName) {
                searchParam.sortName = event.sortName;
            }
            if (event.sortOrder) {
                searchParam.sortOrder = event.sortOrder;
            }
        }
        if (type === 'fav' && event.favoriteIds) {
            searchParam.favoriteIds = event.favoriteIds;
        }
        if (this.ins.isTree() || this.ins.displayType === LookupGridDisplayType.NavTreeList) {
            params.enableFullTree = this.ins.enableFullTree;
        }
        // 查询时不构造完整树
        if (type === 'textchange') {
            params.enableFullTree = false;
        }
        if (type === 'selected') {
            searchParam.category = 'fav';
            params.enableFullTree = false;
            searchParam.favoriteIds = event.favoriteIds;
        }
        params.searchValue = JSON.stringify(searchParam);
        params.loadTreeDataType = this.ins.loadTreeDataType;
        params.customData = this.ins.customData;
        if (this.ins.helpId) {
            params.helpId = this.ins.helpId;
        }
        if (event.selectedInfo) {
            params.selectedInfo = event.selectedInfo;
        }
        return params;
    }
    /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    getData(event, type = 'all') {
        /** @type {?} */
        const uri = this.ins.gridOptions.uri;
        if (this.ins.isDoublleList() && this.ins.navigationFilter && this.ins.navigationFilter.idValue && type !== 'fav') {
            type = 'list';
        }
        /** @type {?} */
        const params = this.buildQueryParams(event, type);
        if (uri || this.ins.beUri) {
            if (this.ins.beUri && this.ins.columns && this.ins.columns.length) {
                /** @type {?} */
                const allSearchFields = this.ins.columns.map((/**
                 * @param {?} col
                 * @return {?}
                 */
                col => col.searchField)).filter((/**
                 * @param {?} f
                 * @return {?}
                 */
                f => f));
                if (!params.condition) {
                    params.condition = {};
                }
                if (!this.ins.isTree() && this.ins.pagination) {
                    const { pageSize = this.ins.pageSize || 20, pageIndex } = Object.assign({}, params);
                    params.condition.pagination = { pageSize, pageIndex };
                }
                else {
                    params.condition.pagination = { isUsePagination: false };
                }
                /** @type {?} */
                const searchParam = JSON.parse(params.searchValue);
                if (searchParam.searchValue) {
                    params.condition = this.ins.lookupUtils.mergeCondition(params.condition, allSearchFields, {
                        field: searchParam.searchField,
                        value: searchParam.searchValue
                    });
                }
            }
            /** @type {?} */
            const _uri = this.ins.beUri || uri;
            if (this.ins.http) {
                this.ins.http.context = this.ins.context;
            }
            if (this.ins._searchResult) {
                return of(this.ins._searchResult);
            }
            if (type !== 'allChildren') {
                return this.ins.http.getData(_uri, params);
            }
            else {
                /** @type {?} */
                const params1 = {
                    searchValue: JSON.stringify({ category: type }),
                    parentsIds: event.parentsIds,
                    customData: params.customData,
                    helpId: params.helpId
                };
                return this.ins.http.getData(_uri, params1);
            }
        }
        else {
            return of(false);
        }
    }
    // getFavoriteData(params) {
    //     return this.getData(params, 'fav');
    // }
    /**
     * @param {?} selIds
     * @return {?}
     */
    getSelecedItems(selIds) {
        return this.getData({ favoriteIds: selIds }, 'selected');
    }
    /**
     * @return {?}
     */
    getPersonalConfig() {
        /** @type {?} */
        const defaultConf = cloneDeep(DefaultUserConfig);
        /** @type {?} */
        const key = this.ins.personalConfigService._newKey;
        /** @type {?} */
        let _conf = this.ins.personalConfigService.getPersonalData(key);
        if (!_conf || !Object.keys(_conf).length) {
            _conf = defaultConf;
        }
        /** @type {?} */
        const req = of(_conf);
        if (this.ins.favoriteDataFrom === 'locale' || this.ins.isTabChanged) {
            return req;
        }
        if (this.ins.http && this.ins.http['getUserSettings']) {
            return this.ins.http['getUserSettings'](key).pipe(map((/**
             * @param {?} ucs
             * @return {?}
             */
            (ucs) => {
                if (ucs) {
                    return ucs.textValue ? JSON.parse(ucs.textValue) : defaultConf;
                }
                return defaultConf;
            })));
        }
        else {
            return req;
        }
    }
    /**
     * @param {?=} event
     * @param {?=} type
     * @return {?}
     */
    lookupRequest(event, type = 'all') {
        if (!this.ins.usePersionalConf) {
            return this.getData(event, type);
        }
        /** @type {?} */
        const req = this.getPersonalConfig();
        return req.pipe(tap((/**
         * @param {?} c
         * @return {?}
         */
        (c) => {
            this.ins.personalConf = c;
            this.ins.personalConfigService.savePersonalConfig(c);
            if (!this.ins.isTabChanged) {
                this._originalPersonalConfig = cloneDeep(c);
            }
        })), switchMap((/**
         * @param {?} c
         * @return {?}
         */
        (c) => {
            const { tabIndex, favorite, size } = c;
            if (!this.ins.isTabChanged) {
                this.ins.activeTab = tabIndex || 'datalist';
            }
            if (size) {
                this.ins.dialogWidth = size.width;
                this.ins.dialogHeight = size.height;
                this.ins.dialog.reSize({ width: size.width, height: size.height });
            }
            if (this.ins.activeTab === 'datalist') {
                return this.getData(event, type);
            }
            else if (this.ins.activeTab === 'favorite') {
                /** @type {?} */
                const favIds = favorite ? favorite[this.ins.localService.localeId] : [];
                if ((!favIds || !favIds.length) && !this.ins.isTabChanged) {
                    return this.getData(event, 'all').pipe(map((/**
                     * @param {?} r
                     * @return {?}
                     */
                    r => {
                        if (r && !r.items) {
                            r.items = [];
                        }
                        r.activeTab = 'datalist';
                        return r;
                    })));
                }
                // const _fids = favIds.filter(n => n);
                event.favoriteIds = favIds;
                return this.getData(event, 'fav').pipe(switchMap((/**
                 * @param {?} r
                 * @return {?}
                 */
                r => {
                    if (r && !r.items) {
                        r.items = [];
                    }
                    if (!r.items.length) {
                        return this.getData(event, 'all').pipe(map((/**
                         * @param {?} a
                         * @return {?}
                         */
                        a => {
                            if (a && !a.items) {
                                a.items = [];
                            }
                            a.activeTab = 'datalist';
                            return a;
                        })));
                    }
                    else {
                        return of(r);
                    }
                })));
            }
            else if (this.ins.activeTab === 'selected') {
                /** @type {?} */
                const selIds = this.ins.displayValue ? this.ins.displayValue.split(',') : [];
                /** @type {?} */
                const _sids = selIds.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n));
                return this.getSelecedItems(_sids);
            }
        })));
    }
    // 保存个性化数据
    /**
     * @param {?} action
     * @return {?}
     */
    submitFavoriteData(action) {
        // 如果数据与默认的数据一至则不保存。
        if (JSON.stringify(this.ins.personalConf) === JSON.stringify(this._originalPersonalConfig)) {
            return;
        }
        /** @type {?} */
        let msg = '';
        if (action === FavoriteAction.add) {
            msg = this.ins.addFavoriteSuccess;
        }
        else if (action === FavoriteAction.delete) {
            msg = this.ins.delFavoriteSuccess;
        }
        this.ins.personalConfigService.savePersonalConfig(this.ins.personalConf || {});
        if (this.ins.favoriteDataFrom !== 'locale') {
            this._originalPersonalConfig = cloneDeep(this.ins.personalConf);
            /** @type {?} */
            const configData = {
                configkey1: this.ins.personalConfigService.personalConfigKey,
                configkey2: '',
                configkey3: '',
                textvalue: JSON.stringify(this.ins.personalConf)
            };
            if (this.ins.http && this.ins.http['saveUserSettings']) {
                this.ins.savingFaoriteData = true;
                this.ins.showLoading();
                return this.ins.http['saveUserSettings'](configData).subscribe((/**
                 * @param {?} r
                 * @return {?}
                 */
                (r) => {
                    this.ins.savingFaoriteData = false;
                    this.ins.closeLoading();
                    if (msg) {
                        this.ins.notifyService.success(msg);
                    }
                }));
            }
            else {
                if (msg) {
                    this.ins.notifyService.success(msg);
                }
            }
        }
        else {
            if (msg) {
                this.ins.notifyService.success(msg);
            }
        }
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype._originalPersonalConfig;
    /**
     * @type {?}
     * @private
     */
    LookupHttpManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC1tYW5hZ2VyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1sb29rdXAvIiwic291cmNlcyI6WyJsaWIvc2VydmljZXMvaHR0cC1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFHQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxjQUFjLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5RSxPQUFPLEVBQWMsRUFBRSxFQUFZLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBZ0IsTUFBTSxnQkFBZ0IsQ0FBQzs7O01BRzdELGlCQUFpQixHQUFHO0lBQ3RCLFFBQVEsRUFBRSxVQUFVO0lBQ3BCLFFBQVEsRUFBRSxJQUFJO0lBQ2QsSUFBSSxFQUFFLElBQUk7Q0FDYjtBQUNELE1BQU0sT0FBTyxpQkFBaUI7Ozs7SUFLMUIsWUFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7OztRQUZwQyw0QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztJQUVKLENBQUM7Ozs7O0lBRXpDLGlCQUFpQjtRQUNyQixPQUFPO1lBQ0gsU0FBUyxFQUFFLENBQUM7WUFDWixRQUFRLEVBQUUsR0FBRztTQUNoQixDQUFDO0lBQ04sQ0FBQzs7Ozs7OztJQUdELGdCQUFnQixDQUFDLEtBQVcsRUFBRSxPQUF1QixLQUFLOztjQUNoRCxNQUFNLEdBQWlCLEVBQUU7UUFFL0IsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRTtZQUNwQixNQUFNLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ3BEOztjQUVLLFdBQVcsR0FBZ0IsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFO1FBRW5ELElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtZQUNoQixJ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Q0FBQztxQkFDdkM7Z0JBQ0wsQ0FBQyxFQUFDLENBQUM7YUFDTjtpQkFBTTtnQkFDSCxJQUFJLEdBQUcsRUFBRTtvQkFDTCxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3ZDO2FBQ0o7U0FDSjthQUFNO1lBQ0gsSUFBSSxHQUFHLEVBQUU7Z0JBQ0wsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZDO1NBQ0o7SUFDTCxDQUFDO0NBRUo7Ozs7OztJQWxVRyxvREFBb0Q7Ozs7O0lBRXhDLGdDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlbW90ZVBhcmFtcywgU2VhcmNoUGFyYW0sIFVzZXJGYXZvcml0ZURhdGEgfSBmcm9tICcuLi9odHRwL1JlbW90ZVBhcmFtcyc7XHJcbmltcG9ydCB7IExPQURfREFUQV9UWVBFIH0gZnJvbSAnLi4vbG9va3VwLWdyaWQtb3B0aW9ucyc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBGYXZvcml0ZUFjdGlvbiwgTG9va3VwR3JpZERpc3BsYXlUeXBlIH0gZnJvbSAnLi4vbG9va3VwLWRpc3BsYXl0eXBlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGZvcmtKb2luIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwLCB0YXAsIGRlYm91bmNlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbi8vIOW4ruWKqem7mOiupOS4quaAp+WMluaVsOaNrlxyXG5jb25zdCBEZWZhdWx0VXNlckNvbmZpZyA9IHtcclxuICAgIHRhYkluZGV4OiAnZGF0YWxpc3QnLFxyXG4gICAgZmF2b3JpdGU6IG51bGwsXHJcbiAgICBzaXplOiBudWxsXHJcbn07XHJcbmV4cG9ydCBjbGFzcyBMb29rdXBIdHRwTWFuYWdlciB7XHJcbiAgICAvLyDmr4/mrKHluK7liqnmiZPlvIDlkI7vvIzmm7TmlrDmraTlgLzvvIzlgZrkuLrkuKrmgKfljJbmlbDmja7nmoTliJ3lp4vlgLzvvJtcclxuICAgIC8vIOWFs+mXreeql+WPo+aXtu+8jOS4juatpOi/m+ihjOWvueavlOOAguWmguaenOS4gOagt++8jOWImeS4jeS/neWtmO+8m1xyXG4gICAgcHJpdmF0ZSBfb3JpZ2luYWxQZXJzb25hbENvbmZpZyA9IERlZmF1bHRVc2VyQ29uZmlnO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7IH1cclxuXHJcbiAgICBwcml2YXRlIGRpc2FibGVQYWdpbmF0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHBhZ2VJbmRleDogMSxcclxuICAgICAgICAgICAgcGFnZVNpemU6IDUwMFxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgLyoqIOaehOmAoOafpeivouWPguaVsCAqL1xyXG4gICAgYnVpbGRRdWVyeVBhcmFtcyhldmVudD86IGFueSwgdHlwZTogTE9BRF9EQVRBX1RZUEUgPSAnYWxsJykge1xyXG4gICAgICAgIGNvbnN0IHBhcmFtczogUmVtb3RlUGFyYW1zID0ge307XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5jb25kaXRpb24pIHtcclxuICAgICAgICAgICAgcGFyYW1zLmNvbmRpdGlvbiA9IGNsb25lRGVlcCh0aGlzLmlucy5jb25kaXRpb24pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3Qgc2VhcmNoUGFyYW06IFNlYXJjaFBhcmFtID0geyBjYXRlZ29yeTogdHlwZSB9O1xyXG5cclxuICAgICAgICBpZiAodHlwZSAhPT0gJ2ZhdicpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmlzRG91YmxsZUxpc3QoKSAmJiB0aGlzLmlucy5uYXZpZ2F0aW9uRmlsdGVyICYmIHR5cGUgIT09ICdhbGwnKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlci5pZFZhbHVlICYmIHR5cGUgIT09ICd0ZXh0Y2hhbmdlJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5yZWxhdGlvbkZpbHRlciA9IFsuLi50aGlzLmlucy5uYXZpZ2F0aW9uRmlsdGVyLmlkVmFsdWVdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChldmVudCkge1xyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGUgPT09ICdmYXYnIHx8IHR5cGUgPT09ICdzZWxlY3RlZCcpIHtcclxuICAgICAgICAgICAgICAgIGV2ZW50LnBhZ2VJbmZvID0gdGhpcy5kaXNhYmxlUGFnaW5hdGlvbigpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LnBhZ2VJbmZvKSB7XHJcbiAgICAgICAgICAgICAgICBwYXJhbXMucGFnZUluZGV4ID0gZXZlbnQucGFnZUluZm8ucGFnZUluZGV4O1xyXG4gICAgICAgICAgICAgICAgcGFyYW1zLnBhZ2VTaXplID0gZXZlbnQucGFnZUluZm8ucGFnZVNpemU7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmIChldmVudC5zZWFyY2gpIHtcclxuICAgICAgICAgICAgICAgIGxldCBzZmllbGQgPSBldmVudC5zZWFyY2guZmllbGQ7XHJcbiAgICAgICAgICAgICAgICBpZiAoc2ZpZWxkICYmIHNmaWVsZCA9PT0gJyonKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2ZpZWxkID0gJyonO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChldmVudC5zZWFyY2gudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5zZWFyY2gudmFsdWUgPSBldmVudC5zZWFyY2gudmFsdWUudHJpbSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtLnNlYXJjaEZpZWxkID0gc2ZpZWxkO1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoUGFyYW0uc2VhcmNoVmFsdWUgPSBldmVudC5zZWFyY2gudmFsdWU7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zZWFyY2hUeXBlID0gIGV2ZW50LnNlYXJjaC50eXBlIHx8ICdsaWtlJztcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQuc2VhcmNoLnZhbHVlID09PSAnJyAmJiAgc2VhcmNoUGFyYW0uY2F0ZWdvcnkgPT09ICdzZWFyY2gnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoUGFyYW0uY2F0ZWdvcnkgPSAnYWxsJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKGV2ZW50LnNvcnROYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBzZWFyY2hQYXJhbS5zb3J0TmFtZSA9IGV2ZW50LnNvcnROYW1lO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChldmVudC5zb3J0T3JkZXIpIHtcclxuICAgICAgICAgICAgICAgIHNlYXJjaFBhcmFtLnNvcnRPcmRlciA9IGV2ZW50LnNvcnRPcmRlcjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGUgPT09ICdmYXYnICYmIGV2ZW50LmZhdm9yaXRlSWRzKSB7XHJcbiAgICAgICAgICAgIHNlYXJjaFBhcmFtLmZhdm9yaXRlSWRzID0gZXZlbnQuZmF2b3JpdGVJZHM7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5pbnMuaXNUcmVlKCkgfHwgdGhpcy5pbnMuZGlzcGxheVR5cGUgPT09IExvb2t1cEdyaWREaXNwbGF5VHlwZS5OYXZUcmVlTGlzdCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSB0aGlzLmlucy5lbmFibGVGdWxsVHJlZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIOafpeivouaXtuS4jeaehOmAoOWujOaVtOagkVxyXG4gICAgICAgIGlmICh0eXBlID09PSAndGV4dGNoYW5nZScpIHtcclxuICAgICAgICAgICAgcGFyYW1zLmVuYWJsZUZ1bGxUcmVlID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZSA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICBzZWFyY2hQYXJhbS5jYXRlZ29yeSA9ICdmYXYnO1xyXG4gICAgICAgICAgICBwYXJhbXMuZW5hYmxlRnVsbFRyZWUgPSBmYWxzZTtcclxuICAgICAgICAgICAgc2VhcmNoUGFyYW0uZmF2b3JpdGVJZHMgPSBldmVudC5mYXZvcml0ZUlkcztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHBhcmFtcy5zZWFyY2hWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHNlYXJjaFBhcmFtKTtcclxuICAgICAgICBwYXJhbXMubG9hZFRyZWVEYXRhVHlwZSA9IHRoaXMuaW5zLmxvYWRUcmVlRGF0YVR5cGU7XHJcblxyXG4gICAgICAgIHBhcmFtcy5jdXN0b21EYXRhID0gdGhpcy5pbnMuY3VzdG9tRGF0YTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmhlbHBJZCkge1xyXG4gICAgICAgICAgICBwYXJhbXMuaGVscElkID0gdGhpcy5pbnMuaGVscElkO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGV2ZW50LnNlbGVjdGVkSW5mbykge1xyXG4gICAgICAgICAgICBwYXJhbXMuc2VsZWN0ZWRJbmZvID0gZXZlbnQuc2VsZWN0ZWRJbmZvO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIHJldHVybiBwYXJhbXM7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGdldERhdGEoZXZlbnQ/OiBhbnksIHR5cGU6IExPQURfREFUQV9UWVBFID0gJ2FsbCcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGNvbnN0IHVyaSA9IHRoaXMuaW5zLmdyaWRPcHRpb25zLnVyaTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmlzRG91YmxsZUxpc3QoKSAmJiAgdGhpcy5pbnMubmF2aWdhdGlvbkZpbHRlciAmJiB0aGlzLmlucy5uYXZpZ2F0aW9uRmlsdGVyLmlkVmFsdWUgJiYgdHlwZSAhPT0gJ2ZhdicpIHtcclxuICAgICAgICAgICAgdHlwZSA9ICdsaXN0JztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuYnVpbGRRdWVyeVBhcmFtcyhldmVudCwgdHlwZSk7XHJcblxyXG4gICAgICAgIGlmICh1cmkgfHwgdGhpcy5pbnMuYmVVcmkpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmJlVXJpICYmIHRoaXMuaW5zLmNvbHVtbnMgJiYgdGhpcy5pbnMuY29sdW1ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFsbFNlYXJjaEZpZWxkcyA9IHRoaXMuaW5zLmNvbHVtbnMubWFwKGNvbCA9PiBjb2wuc2VhcmNoRmllbGQpLmZpbHRlcihmID0+IGYpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFwYXJhbXMuY29uZGl0aW9uKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmNvbmRpdGlvbiA9IHt9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnMuaXNUcmVlKCkgJiYgdGhpcy5pbnMucGFnaW5hdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgcGFnZVNpemUgPSB0aGlzLmlucy5wYWdlU2l6ZSB8fCAyMCwgcGFnZUluZGV4IH0gPSB7IC4uLnBhcmFtcyB9O1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcy5jb25kaXRpb24ucGFnaW5hdGlvbiA9IHsgcGFnZVNpemUsIHBhZ2VJbmRleCB9O1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbXMuY29uZGl0aW9uLnBhZ2luYXRpb24gPSB7IGlzVXNlUGFnaW5hdGlvbjogZmFsc2UgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaFBhcmFtID0gSlNPTi5wYXJzZShwYXJhbXMuc2VhcmNoVmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKHNlYXJjaFBhcmFtLnNlYXJjaFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGFyYW1zLmNvbmRpdGlvbiA9IHRoaXMuaW5zLmxvb2t1cFV0aWxzLm1lcmdlQ29uZGl0aW9uKHBhcmFtcy5jb25kaXRpb24sIGFsbFNlYXJjaEZpZWxkcywge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWVsZDogc2VhcmNoUGFyYW0uc2VhcmNoRmllbGQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzZWFyY2hQYXJhbS5zZWFyY2hWYWx1ZVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBjb25zdCBfdXJpID0gdGhpcy5pbnMuYmVVcmkgfHwgdXJpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmh0dHApIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLmh0dHAuY29udGV4dCA9IHRoaXMuaW5zLmNvbnRleHQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLl9zZWFyY2hSZXN1bHQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBvZih0aGlzLmlucy5fc2VhcmNoUmVzdWx0KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGUgIT09ICdhbGxDaGlsZHJlbicpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmlucy5odHRwLmdldERhdGEoX3VyaSwgcGFyYW1zKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmFtczEgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VhcmNoVmFsdWU6IEpTT04uc3RyaW5naWZ5KHsgY2F0ZWdvcnk6IHR5cGUgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgcGFyZW50c0lkczogZXZlbnQucGFyZW50c0lkcyxcclxuICAgICAgICAgICAgICAgICAgICBjdXN0b21EYXRhOiBwYXJhbXMuY3VzdG9tRGF0YSxcclxuICAgICAgICAgICAgICAgICAgICBoZWxwSWQ6IHBhcmFtcy5oZWxwSWRcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnMuaHR0cC5nZXREYXRhKF91cmksIHBhcmFtczEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZ2V0RmF2b3JpdGVEYXRhKHBhcmFtcykge1xyXG4gICAgLy8gICAgIHJldHVybiB0aGlzLmdldERhdGEocGFyYW1zLCAnZmF2Jyk7XHJcbiAgICAvLyB9XHJcblxyXG4gICAgZ2V0U2VsZWNlZEl0ZW1zKHNlbElkczogYW55W10pIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5nZXREYXRhKHsgZmF2b3JpdGVJZHM6IHNlbElkcyB9LCAnc2VsZWN0ZWQnKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRQZXJzb25hbENvbmZpZygpIHtcclxuICAgICAgICBjb25zdCBkZWZhdWx0Q29uZiA9IGNsb25lRGVlcChEZWZhdWx0VXNlckNvbmZpZyk7XHJcbiAgICAgICAgY29uc3Qga2V5ID0gdGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLl9uZXdLZXk7XHJcbiAgICAgICAgbGV0IF9jb25mID0gdGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLmdldFBlcnNvbmFsRGF0YShrZXkpO1xyXG5cclxuICAgICAgICBpZiAoIV9jb25mIHx8ICFPYmplY3Qua2V5cyhfY29uZikubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIF9jb25mID0gZGVmYXVsdENvbmY7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHJlcSA9IG9mKF9jb25mKTtcclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmZhdm9yaXRlRGF0YUZyb20gPT09ICdsb2NhbGUnIHx8IHRoaXMuaW5zLmlzVGFiQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gcmVxO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLmh0dHAgJiYgdGhpcy5pbnMuaHR0cFsnZ2V0VXNlclNldHRpbmdzJ10pIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmh0dHBbJ2dldFVzZXJTZXR0aW5ncyddKGtleSkucGlwZShcclxuICAgICAgICAgICAgICAgIG1hcCgodWNzOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodWNzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1Y3MudGV4dFZhbHVlID8gSlNPTi5wYXJzZSh1Y3MudGV4dFZhbHVlKSA6IGRlZmF1bHRDb25mO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGVmYXVsdENvbmY7XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXE7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxvb2t1cFJlcXVlc3QoZXZlbnQ/OiBhbnksIHR5cGU6IExPQURfREFUQV9UWVBFID0gJ2FsbCcpIHtcclxuICAgICAgICBpZiAoIXRoaXMuaW5zLnVzZVBlcnNpb25hbENvbmYpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YShldmVudCwgdHlwZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCByZXEgPSB0aGlzLmdldFBlcnNvbmFsQ29uZmlnKCk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXEucGlwZShcclxuICAgICAgICAgICAgdGFwKChjOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zLnBlcnNvbmFsQ29uZiA9IGM7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2Uuc2F2ZVBlcnNvbmFsQ29uZmlnKGMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlucy5pc1RhYkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9vcmlnaW5hbFBlcnNvbmFsQ29uZmlnID0gY2xvbmVEZWVwKGMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgc3dpdGNoTWFwKChjOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHsgdGFiSW5kZXgsIGZhdm9yaXRlLCBzaXplIH0gPSBjO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pbnMuaXNUYWJDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuYWN0aXZlVGFiID0gdGFiSW5kZXggfHwgJ2RhdGFsaXN0JztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoc2l6ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmRpYWxvZ1dpZHRoID0gc2l6ZS53aWR0aDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2dIZWlnaHQgPSBzaXplLmhlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5kaWFsb2cucmVTaXplKHsgd2lkdGg6IHNpemUud2lkdGgsIGhlaWdodDogc2l6ZS5oZWlnaHQgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmFjdGl2ZVRhYiA9PT0gJ2RhdGFsaXN0Jykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsIHR5cGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlucy5hY3RpdmVUYWIgPT09ICdmYXZvcml0ZScpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmYXZJZHMgPSBmYXZvcml0ZSA/IGZhdm9yaXRlW3RoaXMuaW5zLmxvY2FsU2VydmljZS5sb2NhbGVJZF0gOiBbXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoKCFmYXZJZHMgfHwgIWZhdklkcy5sZW5ndGgpICYmICF0aGlzLmlucy5pc1RhYkNoYW5nZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YShldmVudCwgJ2FsbCcpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXAociA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHIgJiYgIXIuaXRlbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgci5pdGVtcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgci5hY3RpdmVUYWIgPSAnZGF0YWxpc3QnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnN0IF9maWRzID0gZmF2SWRzLmZpbHRlcihuID0+IG4pO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LmZhdm9yaXRlSWRzID0gZmF2SWRzO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldERhdGEoZXZlbnQsICdmYXYnKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAociA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAociAmJiAhci5pdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIuaXRlbXMgPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXIuaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0YShldmVudCwgJ2FsbCcpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcChhID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhICYmICFhLml0ZW1zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5pdGVtcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYS5hY3RpdmVUYWIgPSAnZGF0YWxpc3QnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKHIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaW5zLmFjdGl2ZVRhYiA9PT0gJ3NlbGVjdGVkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlbElkcyA9IHRoaXMuaW5zLmRpc3BsYXlWYWx1ZSA/IHRoaXMuaW5zLmRpc3BsYXlWYWx1ZS5zcGxpdCgnLCcpIDogW107XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgX3NpZHMgPSBzZWxJZHMuZmlsdGVyKG4gPT4gbik7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0U2VsZWNlZEl0ZW1zKF9zaWRzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOS/neWtmOS4quaAp+WMluaVsOaNrlxyXG4gICAgc3VibWl0RmF2b3JpdGVEYXRhKGFjdGlvbjogYW55IHwgRmF2b3JpdGVBY3Rpb24pIHtcclxuICAgICAgICAvLyDlpoLmnpzmlbDmja7kuI7pu5jorqTnmoTmlbDmja7kuIDoh7PliJnkuI3kv53lrZjjgIJcclxuICAgICAgICBpZiAoSlNPTi5zdHJpbmdpZnkodGhpcy5pbnMucGVyc29uYWxDb25mKSA9PT0gSlNPTi5zdHJpbmdpZnkodGhpcy5fb3JpZ2luYWxQZXJzb25hbENvbmZpZykpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgbGV0IG1zZyA9ICcnO1xyXG4gICAgICAgIGlmIChhY3Rpb24gPT09IEZhdm9yaXRlQWN0aW9uLmFkZCkge1xyXG4gICAgICAgICAgICBtc2cgPSB0aGlzLmlucy5hZGRGYXZvcml0ZVN1Y2Nlc3M7XHJcbiAgICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09IEZhdm9yaXRlQWN0aW9uLmRlbGV0ZSkge1xyXG4gICAgICAgICAgICBtc2cgPSB0aGlzLmlucy5kZWxGYXZvcml0ZVN1Y2Nlc3M7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmlucy5wZXJzb25hbENvbmZpZ1NlcnZpY2Uuc2F2ZVBlcnNvbmFsQ29uZmlnKHRoaXMuaW5zLnBlcnNvbmFsQ29uZiB8fCB7fSk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmlucy5mYXZvcml0ZURhdGFGcm9tICE9PSAnbG9jYWxlJykge1xyXG4gICAgICAgICAgICB0aGlzLl9vcmlnaW5hbFBlcnNvbmFsQ29uZmlnID0gY2xvbmVEZWVwKHRoaXMuaW5zLnBlcnNvbmFsQ29uZik7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBjb25maWdEYXRhOiBVc2VyRmF2b3JpdGVEYXRhID0ge1xyXG4gICAgICAgICAgICAgICAgY29uZmlna2V5MTogdGhpcy5pbnMucGVyc29uYWxDb25maWdTZXJ2aWNlLnBlcnNvbmFsQ29uZmlnS2V5LFxyXG4gICAgICAgICAgICAgICAgY29uZmlna2V5MjogJycsXHJcbiAgICAgICAgICAgICAgICBjb25maWdrZXkzOiAnJyxcclxuICAgICAgICAgICAgICAgIHRleHR2YWx1ZTogSlNPTi5zdHJpbmdpZnkodGhpcy5pbnMucGVyc29uYWxDb25mKVxyXG4gICAgICAgICAgICB9O1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuaW5zLmh0dHAgJiYgdGhpcy5pbnMuaHR0cFsnc2F2ZVVzZXJTZXR0aW5ncyddKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5zYXZpbmdGYW9yaXRlRGF0YSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5zaG93TG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5zLmh0dHBbJ3NhdmVVc2VyU2V0dGluZ3MnXShjb25maWdEYXRhKS5zdWJzY3JpYmUoKHIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmlucy5zYXZpbmdGYW9yaXRlRGF0YSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaW5zLmNsb3NlTG9hZGluZygpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtc2cpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMubm90aWZ5U2VydmljZS5zdWNjZXNzKG1zZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobXNnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMubm90aWZ5U2VydmljZS5zdWNjZXNzKG1zZyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAobXNnKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmlucy5ub3RpZnlTZXJ2aWNlLnN1Y2Nlc3MobXNnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbn1cclxuIl19