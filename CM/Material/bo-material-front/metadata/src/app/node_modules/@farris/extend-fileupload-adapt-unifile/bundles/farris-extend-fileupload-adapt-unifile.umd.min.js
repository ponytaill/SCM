!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@gsp-svc/file-viewer"),require("@gsp-svc/formdoc-upload"),require("@farris/extend-file-upload"),require("rxjs"),require("rxjs/operators"),require("@angular/common")):"function"==typeof define&&define.amd?define("@farris/extend-fileupload-adapt-unifile",["exports","@angular/core","@gsp-svc/file-viewer","@gsp-svc/formdoc-upload","@farris/extend-file-upload","rxjs","rxjs/operators","@angular/common"],t):t(((e=e||self).farris=e.farris||{},e.farris["extend-fileupload-adapt-unifile"]={}),e.ng.core,e.fileViewer,e.formdocUpload,e.extendFileUpload,e.rxjs,e.rxjs.operators,e.ng.common)}(this,(function(e,t,n,r,i,o,a,l){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */var s=function(e,t){return(s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};var p=function(){return(p=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)};function f(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}var d=new t.InjectionToken("MFFileUploadAdaptUnifileConfig"),u=function(){function e(e){this.config={rootId:"",formId:"",mode:0},e&&Object.assign(this.config,e)}return e.prototype.getConfig=function(){return this.config},e.prototype.setConfig=function(e,t){this.config[e]=t},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:void 0,decorators:[{type:t.Optional},{type:t.Inject,args:[d]}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(d,8))},token:e,providedIn:"root"}),e}();var c=function(){function e(e,t,n){this.fileviewSer=e,this.configSer=t,this.downloadSer=n,this.previewExtendServerConfig=null,this.extendData=this.configSer.getConfig()}return e.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.previewExtendServerConfig&&this.previewExtendServerConfig.hasOwnProperty(e)?this.previewExtendServerConfig[e]:this.extendData.hasOwnProperty(e)?this.extendData[e]:null},e.prototype.previewFile=function(e,t){return this.previewFileList([e],t)},e.prototype.previewFileList=function(e,t){var n=this.getFinallyConfig("rootId",t),r=[];e.forEach((function(e){r.push(e.extend.metadataId)}));var i=this.getFinallyConfig("options",t);return i?this.fileviewSer.viewerFileList(r,n,i):this.fileviewSer.viewerFileList(r,n)},e.prototype.downloadFile=function(e,t){if(!e.id)throw new Error("请设置要下载的附件");window.open(this.getImgSrc(e,t))},e.prototype.multiDownloadFiles=function(e,t){if(1==e.length)this.downloadFile(e[0],t);else{var n=this.getFinallyConfig("rootId",t),r=[];e.forEach((function(e){r.push(e.extend.metadataId)}));var i=this.downloadSer.getMultipleDownloadUrl(JSON.stringify(r),n);window.open(i)}},e.prototype.multiDownloadFilesWidthName=function(e,t,n){if(void 0===t&&(t=""),1==e.length)this.downloadFile(e[0],n);else{var r=this.getFinallyConfig("rootId",n),i=[];e.forEach((function(e){i.push(e.extend.metadataId)}));var o=this.downloadSer.getMultipleDownloadUrlWithName(JSON.stringify(i),r,t);window.open(o)}},e.prototype.getImgSrc=function(e,t){if(!e.id)throw new Error("请设置要下载的附件");var n="",r=e.extend.metadataId,i=this.getFinallyConfig("rootId",t);return this.downloadSer?i&&(n=this.downloadSer.getDownloadUrl(r,i)):i&&(console.warn("因为安全问题，附件下载提供安全校验机制，附件下载功能需要重新编译"),n="/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid="+r+"&rootid="+i),n},e.prototype.setPreviwExtendServerConfig=function(e){this.previewExtendServerConfig=e},e.prototype.getPreviewExtendServerConfig=function(){return this.previewExtendServerConfig},e.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],e.ctorParameters=function(){return[{type:n.FileViewerService},{type:u},{type:r.DownloadService,decorators:[{type:t.Optional}]}]},e.ngInjectableDef=t.defineInjectable({factory:function(){return new e(t.inject(n.FileViewerService),t.inject(u),t.inject(r.DownloadService,8))},token:e,providedIn:"root"}),e}();var g=function(){function e(e){this.previewSer=e,this.viewDisabled=!1,this.extendServerConfig=null}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.viewDisabled&&this.previewSer.previewFile(this.fileInfo,this.extendServerConfig)},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptPreviewFile]"}]}],e.ctorParameters=function(){return[{type:c}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptPreviewFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],viewDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var h=function(){function e(e){this.previewSer=e,this.zipName="",this.downloadDisabled=!1,this.extendServerConfig=null,this.enableMulti=!1}return e.prototype.filePreviewEventHandler=function(){this.fileInfo&&!this.downloadDisabled&&(this.enableMulti&&this.fileInfo instanceof Array?this.previewSer.multiDownloadFilesWidthName(this.fileInfo,this.zipName,this.extendServerConfig):this.previewSer.downloadFile(this.fileInfo,this.extendServerConfig))},e.decorators=[{type:t.Directive,args:[{selector:"[fFileAdaptDownloadFile]"}]}],e.ctorParameters=function(){return[{type:c}]},e.propDecorators={fileInfo:[{type:t.Input,args:["fFileAdaptDownloadFile"]}],filePreviewEventHandler:[{type:t.HostListener,args:["click",["$event"]]}],zipName:[{type:t.Input}],downloadDisabled:[{type:t.Input}],extendServerConfig:[{type:t.Input}],enableMulti:[{type:t.Input}]},e}();var v=function(){function e(e,t){this.adpSer=e,this.elementRef=t,this.cls=!0,this.enableThumbnail=!1,this.clsPrefix="ffilepreview--filetype",this.supportImgSuffix="jpeg,jpg,gif,png,bmp",this.iconWidth=38,this.maxThumbnailWidth="100%",this.maxThumbnailHeight="100%",this.extendServerConfig=null}return e.prototype.ngOnInit=function(){},e.prototype.imgSrc=function(){return this.adpSer.getImgSrc(this.fileInfo,this.extendServerConfig)},e.prototype.isImage=function(){if(!this.fileInfo)return!1;var e=this.fileInfo.name;if(!e)return!1;var t=e.lastIndexOf("."),n="";return t>-1&&(n=e.substring(t+1).toLocaleLowerCase()),!!n&&this.supportImgSuffix.split(",").findIndex((function(e){return e==n}))>-1},e.prototype.getFileTypeClassName=function(){var e=this.clsPrefix;if(!this.fileInfo||!this.fileInfo.name)return e+"-any";var t=this.fileInfo.name,n=t.lastIndexOf("."),r="";switch(n>-1&&(r=t.substring(n+1).toLocaleLowerCase()),r){case"pdf":e+="-pdf";break;case"jpeg":case"jpg":case"gif":case"png":case"bmp":e+="-img";break;case"ppt":e+="-ppt";break;case"doc":case"docx":e+="-doc";break;case"xls":case"xlsx":e+="-xls";break;case"txt":e+="-txt";break;case"zip":e+="-zip";break;default:e+="-any"}return e},e.decorators=[{type:t.Component,args:[{selector:"ffilepreview-adapt-seeimg",template:'<div class="ffilepreview-seeimg--wrapper" [ngClass]="{\'ffilepreview-seeimg--thumbnail\':enableThumbnail}">\r\n  <ng-container *ngIf="enableThumbnail&&isImage();else notImage">\r\n    <img class="ffilepreview-seeimg--img" [src]="imgSrc()" [ngStyle]="{\'maxWidth\':maxThumbnailWidth,\'maxHeight\':maxThumbnailHeight}"/>\r\n  </ng-container>\r\n</div>\r\n<ng-template #notImage>\r\n  <span class="ffilepreview--filetype-icon" [ngClass]="getFileTypeClassName()" [ngStyle]="{\'width\':iconWidth+\'px\',\'height\':iconWidth+\'px\'}"></span>\r\n</ng-template>',styles:[":host{height:100%;width:100%;position:relative}.ffilepreview-seeimg--thumbnail{top:0;bottom:0;position:absolute;right:0;left:0;display:-webkit-box;display:flex;-webkit-box-align:center;align-items:center;-webkit-box-pack:center;justify-content:center}.ffilepreview-seeimg--wrapper:hover{opacity:.8}.ffilepreview-seeimg--img{max-width:100%;max-height:100%;border-radius:4px}"]}]}],e.ctorParameters=function(){return[{type:c},{type:t.ElementRef}]},e.propDecorators={cls:[{type:t.HostBinding,args:["class.ffilepreview-adapt-seeimg"]}],enableThumbnail:[{type:t.Input}],clsPrefix:[{type:t.Input}],supportImgSuffix:[{type:t.Input}],fileInfo:[{type:t.Input}],iconWidth:[{type:t.Input}],maxThumbnailWidth:[{type:t.Input}],maxThumbnailHeight:[{type:t.Input}],extendServerConfig:[{type:t.Input}]},e}();var m=function(e){function n(t,n){var r=e.call(this)||this;return r.uploadSer=t,r.configSer=n,r.bufferSize=1048576,r.uploadedChunk={},r.fileTotalChunk={},r.extendData=r.configSer.getConfig(),r}return function(e,t){function n(){this.constructor=e}s(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(n,e),n.prototype.uuid=function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+e()+e()+e()+e()+e()+e()},n.prototype.remove=function(e,t,n){return this.innerRemoveList(e,t,n)},n.prototype.innerRemoveList=function(e,t,n){var i=this;return void 0===n&&(n=null),new o.Observable((function(t){var o=new r.GspFormRemoveListEntity,a=[];e.forEach((function(e){e.response&&a.push(e.response.metadataId)})),o.mode=i.getFinallyConfig("mode",n);var l=i.getFinallyConfig("rootId",n);o.metadataIdList=[].concat(a),i.uploadSer.removeList(a,l).subscribe((function(n){t.next({type:"removed",files:e})}),(function(e){t.error(e),t.complete()}),(function(){t.complete()}))}))},n.prototype.upload=function(e,t,n){return"sliceUpload"==t.type?this.uploadBigFile(e,t,n):this.innerUploadList(e,t,n)},n.prototype.innerUploadList=function(e,t,n){var a=this;return new o.Observable((function(l){var s=new r.GspFormUploadListEntity;s.formId=a.getFinallyConfig("formId",n),s.mode=a.getFinallyConfig("mode",n);var p=a.getFinallyConfig("rootId",n);s.docInfoList=[];var f=[];e.forEach((function(e){var n=new o.Observable((function(n){var r=new FileReader;r.readAsBinaryString(e.nativeFile),r.onload=function(i){var o={fileName:"",fileContent:""};o.fileName=e.name,o.fileContent=btoa(r.result.toString()),t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(o.extProperty=t.data.extProperty),s.docInfoList.push(o),n.next(),n.complete()}}));f.push(n)})),o.forkJoin(f).subscribe((function(t){a.uploadSer.uploadList(s,p).subscribe((function(t){if(t.error)return l.error(a.errorInfoFormat(t.error,e)),void l.complete();t.forEach((function(t){var n=a.findFileIndexByFileName(e,t.fileName);n>-1&&(e[n].response=t,e[n].progress.status=i.UploadStatus.Done)})),l.next({type:"done",files:e})}),(function(t){l.error(a.errorInfoFormat(t,e)),l.complete()}),(function(){l.complete()}))}))}))},n.prototype.multipartUpload=function(e,t,n){var a=this;return new o.Observable((function(o){var l=a.uuid(),s=e.name,p=Math.ceil(e.size/a.bufferSize);a.fileTotalChunk[l]=p;var f=0;a.uploadedChunk[l]=0;for(var d=function(){var d=new r.GspFormUploadEntity;d.mode=r.OperatingModes.Temp,d.formId=a.getFinallyConfig("formId",n),d.rootId=a.getFinallyConfig("rootId",n);var u=new r.GspFormDocInfo;u.fileName=s,u.metadataId=l,u.total=p,t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(u.extProperty=t.data.extProperty);var c=Math.min((f+1)*a.bufferSize,e.size),g=e.nativeFile.slice(f*a.bufferSize,c),h=new FileReader;h.readAsBinaryString(g);var v=f;h.onload=function(){u.fileContent=btoa(h.result.toString()),u.index=v,d.docInfo=u;var t=d;a.uploadSer.uploadFile(t).subscribe((function(t){if(t&&t.error)return o.error(a.errorInfoFormat(t.error,[e])),void o.complete();if(a.uploadedChunk[l]++,a.uploadedChunk[u.metadataId]==a.fileTotalChunk[u.metadataId])e.progress={status:i.UploadStatus.Done,data:{percentage:100}},e.response=u,delete a.uploadedChunk[l],delete a.fileTotalChunk[l],o.next({type:"done",files:[e]}),o.complete();else{var n=Number.parseInt((a.uploadedChunk[l]/a.fileTotalChunk[l]*100).toFixed(0));e.progress={status:i.UploadStatus.Uploading,data:{percentage:n}},o.next({type:"uploading",files:[e]})}}),(function(t){delete a.uploadedChunk[l],delete a.fileTotalChunk[l],o.error(a.errorInfoFormat(t,[e])),o.complete()}))},f+=1};f<p;)d()}))},n.prototype.formatFileSize=function(e){return e<102400?(e/1024).toFixed(1)+"K":e<1048576?(e/1024).toFixed(0)+"K":e<104857600?(e/1024/1024).toFixed(1)+"M":e<1073741824?(e/1024/1024).toFixed(0)+"M":(e/1024/1024/1024).toFixed(1)+"G"},n.prototype.getMultipartDisplayName=function(e){return e.length<=10?e:e.substring(0,2)+"…"+e.substring(e.lastIndexOf(".")-2)},n.prototype.errorInfoFormat=function(e,t){var n=t.map((function(e){return{id:e.id,name:e.name}}));return e?Object.assign(e,{files:n},{message:e.Message||e.extensionMessage||"上传失败",type:"error"}):Object.assign({files:n},{message:"上传失败",type:"error"})},n.prototype.getFinallyConfig=function(e,t){return t&&t.hasOwnProperty(e)?t[e]:this.extendData[e]},n.prototype.findFileIndexByFileName=function(e,t){return e.findIndex((function(e){return e.name==t}))},n.prototype.uploadBigFile=function(e,t,n){var r=this,a=new o.Subject,l=e.map((function(e){var i=r._getBigFileChunks(e,t,n);return p({},e,i)})).map((function(e){return r.uploadChunks(e,a)}));return o.concat.apply(void 0,function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(f(arguments[t]));return e}(l)).subscribe((function(e){e.progress={status:i.UploadStatus.Done,data:{percentage:100}},e.response=JSON.parse(e.chunks[0].get("docInfo")),a.next({type:"done",files:[e]})}),(function(t){a.error(r.errorInfoFormat(t,e)),a.complete()}),(function(){a.complete()})),a.asObservable()},n.prototype.uploadFileChunk=function(e){return this.uploadSer.http.http.post("/api/runtime/dfs/v1.0/formdoc/slice",e.chunks[e.total]).pipe(a.switchMap((function(){return o.of(e)})),a.catchError((function(e){return o.of(e)})))},n.prototype.uploadChunks=function(e,t){var n,r=this;return(n=e,o.of(n)).pipe(a.expand((function(n){return--e.total>-1?function(e){return r.uploadFileChunk(e).pipe(a.delay(100),a.map((function(e){return e.progress={status:i.UploadStatus.Uploading,data:{percentage:(e.total/e.chunks.length*100).toFixed(0)}},t.next({type:"uploading",files:[e]}),e})))}(e):o.EMPTY})),a.last(),a.switchMap((function(t){return function(e){return o.of(e)}(e)})))},n.prototype._getBigFileChunks=function(e,t,n){for(var i=this.uuid(),o=Math.ceil(e.size/this.bufferSize*(t.chunkSize||1)),a=0,l={chunks:[],total:o};a<o;){var s=new r.GspFormUploadEntity;s.mode=r.OperatingModes.Temp,s.formId=this.getFinallyConfig("formId",n),s.rootId=this.getFinallyConfig("rootId",n);var p=new r.GspFormDocInfo;p.fileName=e.name,p.metadataId=i,p.total=o;var f=Math.min((a+1)*this.bufferSize,e.size),d=e.nativeFile.slice(a*this.bufferSize,f);p.size=e.size,p.index=a,p.fileContent="",t.hasOwnProperty("data")&&t.data&&t.data.hasOwnProperty("extProperty")&&(p.extProperty=t.data.extProperty),s.docInfo=p;var u=new FormData;u.append("uploadInfo",JSON.stringify(s)),u.append("docInfo",JSON.stringify(p)),u.append("file",d),l.chunks.push(u),a+=1}return l},n.previous=0,n.decorators=[{type:t.Injectable,args:[{providedIn:"root"}]}],n.ctorParameters=function(){return[{type:r.UploadService},{type:u}]},n.ngInjectableDef=t.defineInjectable({factory:function(){return new n(t.inject(r.UploadService),t.inject(u))},token:n,providedIn:"root"}),n}(i.UploadServerService);var y=function(){function e(e){this.previewSer=e,this._extendServeConfig=null}return e.prototype.filePreviewEventHandler=function(e){var t=Object.assign(this.extendServerConfig||{},{options:{showDownload:!!e.showDownload,showHeader:!0,showFileList:!0}});this.previewSer.previewFile(e,t)},e.prototype.fileDownloadEventHandler=function(e){e&&e.fileInfos.length>0&&(e.fileInfos.length>1?this.previewSer.multiDownloadFilesWidthName(e.fileInfos,e.name,this.extendServerConfig):this.previewSer.downloadFile(e.fileInfos[0],this.extendServerConfig))},Object.defineProperty(e.prototype,"extendServerConfig",{get:function(){return this._extendServeConfig},set:function(e){this._extendServeConfig=e,this.previewSer.setPreviwExtendServerConfig(e)},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Directive,args:[{selector:"[fFilePreviewAdaptUnifile]",providers:[c]}]}],e.ctorParameters=function(){return[{type:c}]},e.propDecorators={filePreviewEventHandler:[{type:t.HostListener,args:["filePreviewEvent",["$event"]]}],fileDownloadEventHandler:[{type:t.HostListener,args:["fileDownloadEvent",["$event"]]}],extendServerConfig:[{type:t.Input}]},e}();var w=function(){function e(){}return e.forRoot=function(t){return{ngModule:e,providers:[{provide:d,useValue:t},u,c,n.FileViewerService]}},e.decorators=[{type:t.NgModule,args:[{declarations:[y,v,h,g],imports:[l.CommonModule,r.UploadDialogMoudle,n.FileListModule,i.FFileUploadModule.forRoot(null,m)],exports:[i.FFileUploadModule,y,v,h,g],providers:[u,c,n.FileViewerService]}]}],e}();e.FFileAdaptDownloadFileDirective=h,e.FFileAdaptPreviewFileDirective=g,e.FFilePreviewAdaptUnifileDirective=y,e.FFileUploadAdaptUnifileConfigService=u,e.FFileUploadAdaptUnifileConfigToken=d,e.FfilepreviewAdaptSeeimgComponent=v,e.FfilepreviewAdaptUnifileService=c,e.FfileuploadAdaptUnifileModule=w,e.FfileuploadAdaptUnifileService=m,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=farris-extend-fileupload-adapt-unifile.umd.min.js.map