import { Directive, Input, HostListener, Self, Host, Optional, Output, EventEmitter, KeyValueDiffers } from '@angular/core';
import { ComboBoxComponent } from '@progress/kendo-angular-dropdowns';
import { LookupGridComponent } from '@farris/ui-lookup';
import { ComboListComponent } from '@farris/ui-combo-list';
import { ComboLookupComponent } from '@farris/ui-combo-lookup';
var UIStateBindingDirective = /** @class */ (function () {
    function UIStateBindingDirective(hostComboComponent, hostHelpComponent, differs, hostComboListComponent, hostComboLookupComponent) {
        this.hostComboComponent = hostComboComponent;
        this.hostHelpComponent = hostHelpComponent;
        this.differs = differs;
        this.hostComboListComponent = hostComboListComponent;
        this.hostComboLookupComponent = hostComboLookupComponent;
        this.differ = null;
        this.UIStateBindingChange = new EventEmitter();
    }
    Object.defineProperty(UIStateBindingDirective.prototype, "bindingObject", {
        get: function () {
            return this._bindingObject;
        },
        set: function (value) {
            this._bindingObject = value;
            if (!this.differ && value && this.differs && typeof (value) === 'object') {
                this.differ = this.differs.find(value).create();
            }
        },
        enumerable: true,
        configurable: true
    });
    UIStateBindingDirective.prototype.onValueChange = function (val) {
        // host is combobox
        if (this.hostComboComponent && this.bindingObject) {
            if (val) {
                this.bindingObject.key = val.value;
                this.bindingObject.value = val.name;
            }
            else {
                this.bindingObject.key = null;
                this.bindingObject.value = null;
            }
        }
    };
    UIStateBindingDirective.prototype.ngOnInit = function () {
        if (this.hostComboComponent) {
            this.hostComboComponent.valuePrimitive = false;
        }
        else if (this.hostHelpComponent) {
            this.bindObjectToHostLookup();
        }
        else if (this.hostComboListComponent) {
            this.bindObjectToHostComboList();
        }
        else if (this.hostComboLookupComponent) {
            this.bindObjectToHostComboLookup();
        }
    };
    UIStateBindingDirective.prototype.ngDoCheck = function () {
        if (this.differ && typeof (this.bindingObject) === 'object') {
            var changes = this.differ && this.differ.diff(this.bindingObject);
            if (changes) {
                this.bindingChanges();
            }
        }
        else { // 兼容未重新编译工程，differ不存在从情况
            this.bindingChanges();
        }
    };
    UIStateBindingDirective.prototype.bindingChanges = function () {
        var text = this.bindingObject ? this.bindingObject.value : null;
        var key = this.bindingObject ? this.bindingObject.key : null;
        if (this.hostComboComponent) {
            this.hostComboComponent.text = text;
            var vField_1 = this.hostComboComponent.valueField;
            var item = this.hostComboComponent.data.find(function (n) { return n[vField_1] === key; });
            this.hostComboComponent.writeValue(item);
        }
        else if (this.hostHelpComponent) {
            this.hostHelpComponent.writeValue(text);
            this.hostHelpComponent.displayValue = key;
        }
        else if (this.hostComboListComponent) {
            this.hostComboListComponent.writeValue(key);
        }
        else if (this.hostComboLookupComponent) {
            this.hostComboLookupComponent.selectedValues = key;
            this.hostComboLookupComponent.writeValue(text);
        }
    };
    UIStateBindingDirective.prototype.ngOnChanges = function (changes) {
        if (changes.bindingObject && !this.differ) {
            this.bindingChanges();
        }
    };
    // 弹出帮助
    UIStateBindingDirective.prototype.bindObjectToHostLookup = function () {
        var _this = this;
        if (!this.hostHelpComponent) {
            return;
        }
        this.hostHelpComponent.selectedData.subscribe(function (data) { return _this.updateHelpBindingObject(data); });
        this.hostHelpComponent.clear.subscribe(function () {
            // this.bindingObject = {key: null, value: null};
            _this.updateHelpBindingObject(null);
        });
        if (this.hostHelpComponent.nosearch) {
            this.hostHelpComponent.valueChanged.subscribe(function (txt) {
                var _a;
                var idField = _this.hostHelpComponent.idField;
                var textField = _this.hostHelpComponent.textField;
                _this.updateHelpBindingObject((_a = {},
                    _a[idField] = txt,
                    _a[textField] = txt,
                    _a));
            });
        }
    };
    // 下拉列表
    UIStateBindingDirective.prototype.bindObjectToHostComboList = function () {
        var _this = this;
        if (!this.hostComboListComponent) {
            return;
        }
        this.hostComboListComponent.valueChange.subscribe(function (data) { return _this.updateHelpBindingObject(data.selections); });
        this.hostComboListComponent.clear.subscribe(function () {
            _this.updateHelpBindingObject(null);
        });
    };
    // 下拉帮助
    UIStateBindingDirective.prototype.bindObjectToHostComboLookup = function () {
        var _this = this;
        if (!this.hostComboLookupComponent) {
            return;
        }
        if (this.hostComboLookupComponent.multiSelect) {
            this.hostComboLookupComponent.valueChange.subscribe(function (data) { return _this.updateHelpBindingObject(data.selections); });
        }
        else {
            // this.hostComboLookupComponent.selectChange.subscribe((data: any) => this.updateHelpBindingObject(data));
            this.hostComboLookupComponent.selectChange.subscribe(function (e) {
                var data = e;
                if (e.data) {
                    data = e.data;
                }
                _this.updateHelpBindingObject(data);
            });
        }
        this.hostComboLookupComponent.clear.subscribe(function () {
            _this.updateHelpBindingObject(null);
        });
    };
    // 更新UISTATE
    UIStateBindingDirective.prototype.updateHelpBindingObject = function (data) {
        var idField, textField;
        if (this.hostHelpComponent) {
            idField = this.hostHelpComponent.idField;
            textField = this.hostHelpComponent.textField;
        }
        if (this.hostComboListComponent) {
            idField = this.hostComboListComponent.idField;
            textField = this.hostComboListComponent.textField;
        }
        if (this.hostComboLookupComponent) {
            idField = this.hostComboLookupComponent.idField;
            textField = this.hostComboLookupComponent.textField;
        }
        this.emitUiStateBinding(data, idField, textField);
    };
    UIStateBindingDirective.prototype.emitUiStateBinding = function (data, idField, textField) {
        var newObject = { key: null, value: null };
        if (data) {
            // const idField = this.hostHelpComponent.idField;
            // const textField = this.hostHelpComponent.textField;
            if (Array.isArray(data)) {
                newObject.key = data.map(function (d) { return d[idField]; }).join(',');
                newObject.value = data.map(function (d) {
                    if (textField.indexOf('.') > -1) {
                        return textField.split('.').reduce(function (r, c) {
                            return r[c];
                        }, d);
                    }
                    else {
                        return d[textField];
                    }
                }).join(',');
            }
            else {
                if (idField) {
                    newObject.key = data[idField];
                }
                if (textField) {
                    if (textField.indexOf('.') > -1) {
                        newObject.value = textField.split('.').reduce(function (r, c) {
                            return r[c];
                        }, data);
                    }
                    else {
                        newObject.value = data[textField];
                    }
                }
            }
        }
        this.UIStateBindingChange.emit(newObject);
    };
    UIStateBindingDirective.decorators = [
        { type: Directive, args: [{
                    selector: '[UIStateBinding]'
                },] }
    ];
    /** @nocollapse */
    UIStateBindingDirective.ctorParameters = function () { return [
        { type: ComboBoxComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
        { type: LookupGridComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
        { type: KeyValueDiffers, decorators: [{ type: Optional }] },
        { type: ComboListComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] },
        { type: ComboLookupComponent, decorators: [{ type: Host }, { type: Self }, { type: Optional }] }
    ]; };
    UIStateBindingDirective.propDecorators = {
        bindingObject: [{ type: Input, args: ['UIStateBinding',] }],
        UIStateBindingChange: [{ type: Output }],
        onValueChange: [{ type: HostListener, args: ['valueChange', ['$event'],] }]
    };
    return UIStateBindingDirective;
}());
export { UIStateBindingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWlzdGF0ZS1iaW5kaW5nLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMva2VuZG8tYmluZGluZy8iLCJzb3VyY2VzIjpbImxpYi9kaXJlY3RpdmVzL3Vpc3RhdGUtYmluZGluZy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsWUFBWSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQXFELGVBQWUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2TCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUUvRDtJQWlDRSxpQ0FDc0Msa0JBQXFDLEVBQ3JDLGlCQUFzQyxFQUN0RCxPQUF3QixFQUNSLHNCQUEwQyxFQUMxQyx3QkFBOEM7UUFKOUMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFtQjtRQUNyQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQXFCO1FBQ3RELFlBQU8sR0FBUCxPQUFPLENBQWlCO1FBQ1IsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUFvQjtRQUMxQyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQXNCO1FBakM1RSxXQUFNLEdBQTZCLElBQUksQ0FBQztRQVl0Qyx5QkFBb0IsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQXNCeEUsQ0FBQztJQWhDTCxzQkFDSSxrREFBYTthQU1qQjtZQUNFLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQztRQUM3QixDQUFDO2FBVEQsVUFDa0IsS0FBVTtZQUMxQixJQUFJLENBQUMsY0FBYyxHQUFHLEtBQUssQ0FB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Q0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDOzRCQUNqRCxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDZCxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7cUJBQ1Y7eUJBQU07d0JBQ0wsU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7cUJBQ25DO2lCQUNGO2FBQ0Y7U0FDRjtRQUNELElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDNUMsQ0FBQzs7Z0JBN01GLFNBQVMsU0FBQztvQkFDVCxRQUFRLEVBQUUsa0JBQWtCO2lCQUM3Qjs7OztnQkFQUSxpQkFBaUIsdUJBdUNyQixJQUFJLFlBQUksSUFBSSxZQUFJLFFBQVE7Z0JBdENwQixtQkFBbUIsdUJBdUN2QixJQUFJLFlBQUksSUFBSSxZQUFJLFFBQVE7Z0JBekNtSCxlQUFlLHVCQTBDMUosUUFBUTtnQkF2Q0osa0JBQWtCLHVCQXdDdEIsSUFBSSxZQUFJLElBQUksWUFBSSxRQUFRO2dCQXZDcEIsb0JBQW9CLHVCQXdDeEIsSUFBSSxZQUFJLElBQUksWUFBSSxRQUFROzs7Z0NBL0IxQixLQUFLLFNBQUMsZ0JBQWdCO3VDQVV0QixNQUFNO2dDQUVOLFlBQVksU0FBQyxhQUFhLEVBQUUsQ0FBQyxRQUFRLENBQUM7O0lBNEx6Qyw4QkFBQztDQUFBLEFBL01ELElBK01DO1NBNU1ZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpcmVjdGl2ZSwgSW5wdXQsIE9uSW5pdCwgSG9zdExpc3RlbmVyLCBTZWxmLCBIb3N0LCBPcHRpb25hbCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgRG9DaGVjaywgS2V5VmFsdWVEaWZmZXIsIEtleVZhbHVlRGlmZmVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb21ib0JveENvbXBvbmVudCB9IGZyb20gJ0Bwcm9ncmVzcy9rZW5kby1hbmd1bGFyLWRyb3Bkb3ducyc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxvb2t1cCc7XHJcbmltcG9ydCB7IENvbWJvTGlzdENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktY29tYm8tbGlzdCc7XHJcbmltcG9ydCB7IENvbWJvTG9va3VwQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1jb21iby1sb29rdXAnO1xyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgc2VsZWN0b3I6ICdbVUlTdGF0ZUJpbmRpbmddJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgVUlTdGF0ZUJpbmRpbmdEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgRG9DaGVjayB7XHJcbiAgcHJpdmF0ZSBfYmluZGluZ09iamVjdDogYW55O1xyXG4gIHByaXZhdGUgZGlmZmVyOiBLZXlWYWx1ZURpZmZlcjxhbnksIGFueT4gPSBudWxsO1xyXG5cclxuICBASW5wdXQoJ1VJU3RhdGVCaW5kaW5nJylcclxuICBzZXQgYmluZGluZ09iamVjdCh2YWx1ZTogYW55KSB7XHJcbiAgICB0aGlzLl9iaW5kaW5nT2JqZWN0ID0gdmFsdWU7XHJcbiAgICBpZiAoIXRoaXMuZGlmZmVyICYmIHZhbHVlICYmIHRoaXMuZGlmZmVycyAmJiB0eXBlb2YgKHZhbHVlKSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgdGhpcy5kaWZmZXIgPSB0aGlzLmRpZmZlcnMuZmluZCh2YWx1ZSkuY3JlYXRlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIGdldCBiaW5kaW5nT2JqZWN0KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2JpbmRpbmdPYmplY3Q7XHJcbiAgfVxyXG4gIEBPdXRwdXQoKSBVSVN0YXRlQmluZGluZ0NoYW5nZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgQEhvc3RMaXN0ZW5lcigndmFsdWVDaGFuZ2UnLCBbJyRldmVudCddKVxyXG4gIG9uVmFsdWVDaGFuZ2UodmFsOiBhbnkpIHtcclxuICAgIC8vIGhvc3QgaXMgY29tYm9ib3hcclxuICAgIGlmICh0aGlzLmhvc3RDb21ib0NvbXBvbmVudCAmJiB0aGlzLmJpbmRpbmdPYmplY3QpIHtcclxuICAgICAgaWYgKHZhbCkge1xyXG4gICAgICAgIHRoaXMuYmluZGluZ09iamVjdC5rZXkgPSB2YWwudmFsdWU7XHJcbiAgICAgICAgdGhpcy5iaW5kaW5nT2JqZWN0LnZhbHVlID0gdmFsLm5hbWU7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5iaW5kaW5nT2JqZWN0LmtleSA9IG51bGw7XHJcbiAgICAgICAgdGhpcy5iaW5kaW5nT2JqZWN0LnZhbHVlID0gbnVsbDtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBASG9zdCgpIEBTZWxmKCkgQE9wdGlvbmFsKCkgcHJpdmF0ZSBob3N0Q29tYm9Db21wb25lbnQ6IENvbWJvQm94Q29tcG9uZW50LFxyXG4gICAgQEhvc3QoKSBAU2VsZigpIEBPcHRpb25hbCgpIHByaXZhdGUgaG9zdEhlbHBDb21wb25lbnQ6IExvb2t1cEdyaWRDb21wb25lbnQsXHJcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGRpZmZlcnM6IEtleVZhbHVlRGlmZmVycyxcclxuICAgIEBIb3N0KCkgQFNlbGYoKSBAT3B0aW9uYWwoKSBwcml2YXRlIGhvc3RDb21ib0xpc3RDb21wb25lbnQ6IENvbWJvTGlzdENvbXBvbmVudCxcclxuICAgIEBIb3N0KCkgQFNlbGYoKSBAT3B0aW9uYWwoKSBwcml2YXRlIGhvc3RDb21ib0xvb2t1cENvbXBvbmVudDogQ29tYm9Mb29rdXBDb21wb25lbnRcclxuICApIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuXHJcbiAgICBpZiAodGhpcy5ob3N0Q29tYm9Db21wb25lbnQpIHtcclxuICAgICAgdGhpcy5ob3N0Q29tYm9Db21wb25lbnQudmFsdWVQcmltaXRpdmUgPSBmYWxzZTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0SGVscENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmJpbmRPYmplY3RUb0hvc3RMb29rdXAoKTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuYmluZE9iamVjdFRvSG9zdENvbWJvTGlzdCgpO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmJpbmRPYmplY3RUb0hvc3RDb21ib0xvb2t1cCgpO1xyXG4gICAgfVxyXG5cclxuICB9XHJcbiAgbmdEb0NoZWNrKCkge1xyXG4gICAgaWYgKHRoaXMuZGlmZmVyICYmIHR5cGVvZiAodGhpcy5iaW5kaW5nT2JqZWN0KSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuZGlmZmVyICYmIHRoaXMuZGlmZmVyLmRpZmYodGhpcy5iaW5kaW5nT2JqZWN0KTtcclxuICAgICAgaWYgKGNoYW5nZXMpIHtcclxuICAgICAgICB0aGlzLmJpbmRpbmdDaGFuZ2VzKCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7IC8vIOWFvOWuueacqumHjeaWsOe8luivkeW3peeoi++8jGRpZmZlcuS4jeWtmOWcqOS7juaDheWGtVxyXG4gICAgICB0aGlzLmJpbmRpbmdDaGFuZ2VzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGJpbmRpbmdDaGFuZ2VzKCkge1xyXG4gICAgY29uc3QgdGV4dCA9IHRoaXMuYmluZGluZ09iamVjdCA/IHRoaXMuYmluZGluZ09iamVjdC52YWx1ZSA6IG51bGw7XHJcbiAgICBjb25zdCBrZXkgPSB0aGlzLmJpbmRpbmdPYmplY3QgPyB0aGlzLmJpbmRpbmdPYmplY3Qua2V5IDogbnVsbDtcclxuICAgIGlmICh0aGlzLmhvc3RDb21ib0NvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0NvbXBvbmVudC50ZXh0ID0gdGV4dDtcclxuICAgICAgY29uc3QgdkZpZWxkID0gdGhpcy5ob3N0Q29tYm9Db21wb25lbnQudmFsdWVGaWVsZDtcclxuICAgICAgY29uc3QgaXRlbSA9IHRoaXMuaG9zdENvbWJvQ29tcG9uZW50LmRhdGEuZmluZChuID0+IG5bdkZpZWxkXSA9PT0ga2V5KTtcclxuICAgICAgdGhpcy5ob3N0Q29tYm9Db21wb25lbnQud3JpdGVWYWx1ZShpdGVtKTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0SGVscENvbXBvbmVudCkge1xyXG4gICAgICB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LndyaXRlVmFsdWUodGV4dCk7XHJcbiAgICAgIHRoaXMuaG9zdEhlbHBDb21wb25lbnQuZGlzcGxheVZhbHVlID0ga2V5O1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmhvc3RDb21ib0xpc3RDb21wb25lbnQpIHtcclxuICAgICAgdGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50LndyaXRlVmFsdWUoa2V5KTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQpIHtcclxuICAgICAgdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQuc2VsZWN0ZWRWYWx1ZXMgPSBrZXk7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LndyaXRlVmFsdWUodGV4dCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIGlmIChjaGFuZ2VzLmJpbmRpbmdPYmplY3QgJiYgIXRoaXMuZGlmZmVyKSB7XHJcbiAgICAgIHRoaXMuYmluZGluZ0NoYW5nZXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIOW8ueWHuuW4ruWKqVxyXG4gIHByaXZhdGUgYmluZE9iamVjdFRvSG9zdExvb2t1cCgpIHtcclxuICAgIGlmICghdGhpcy5ob3N0SGVscENvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5ob3N0SGVscENvbXBvbmVudC5zZWxlY3RlZERhdGEuc3Vic2NyaWJlKChkYXRhOiBhbnkpID0+IHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QoZGF0YSkpO1xyXG5cclxuICAgIHRoaXMuaG9zdEhlbHBDb21wb25lbnQuY2xlYXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgLy8gdGhpcy5iaW5kaW5nT2JqZWN0ID0ge2tleTogbnVsbCwgdmFsdWU6IG51bGx9O1xyXG4gICAgICB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KG51bGwpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHRoaXMuaG9zdEhlbHBDb21wb25lbnQubm9zZWFyY2gpIHtcclxuICAgICAgdGhpcy5ob3N0SGVscENvbXBvbmVudC52YWx1ZUNoYW5nZWQuc3Vic2NyaWJlKCh0eHQ6IGFueSkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGlkRmllbGQgPSB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LmlkRmllbGQ7XHJcbiAgICAgICAgY29uc3QgdGV4dEZpZWxkID0gdGhpcy5ob3N0SGVscENvbXBvbmVudC50ZXh0RmllbGQ7XHJcbiAgICAgICAgdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdCh7XHJcbiAgICAgICAgICBbaWRGaWVsZF06IHR4dCxcclxuICAgICAgICAgIFt0ZXh0RmllbGRdOiB0eHRcclxuICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyDkuIvmi4nliJfooahcclxuICBwcml2YXRlIGJpbmRPYmplY3RUb0hvc3RDb21ib0xpc3QoKSB7XHJcbiAgICBpZiAoIXRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5ob3N0Q29tYm9MaXN0Q29tcG9uZW50LnZhbHVlQ2hhbmdlLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGEuc2VsZWN0aW9ucykpO1xyXG5cclxuICAgIHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudC5jbGVhci5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KG51bGwpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyDkuIvmi4nluK7liqlcclxuICBwcml2YXRlIGJpbmRPYmplY3RUb0hvc3RDb21ib0xvb2t1cCgpIHtcclxuICAgIGlmICghdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC5tdWx0aVNlbGVjdCkge1xyXG4gICAgICB0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudC52YWx1ZUNoYW5nZS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4gdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdChkYXRhLnNlbGVjdGlvbnMpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnNlbGVjdENoYW5nZS5zdWJzY3JpYmUoKGRhdGE6IGFueSkgPT4gdGhpcy51cGRhdGVIZWxwQmluZGluZ09iamVjdChkYXRhKSk7XHJcbiAgICAgIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LnNlbGVjdENoYW5nZS5zdWJzY3JpYmUoKGU6IGFueSkgPT4ge1xyXG4gICAgICAgIGxldCBkYXRhID0gZTtcclxuICAgICAgICBpZihlLmRhdGEpIHtcclxuICAgICAgICAgIGRhdGEgPSBlLmRhdGE7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QoZGF0YSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaG9zdENvbWJvTG9va3VwQ29tcG9uZW50LmNsZWFyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlSGVscEJpbmRpbmdPYmplY3QobnVsbCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8vIOabtOaWsFVJU1RBVEVcclxuICBwcml2YXRlIHVwZGF0ZUhlbHBCaW5kaW5nT2JqZWN0KGRhdGE6IGFueSkge1xyXG4gICAgbGV0IGlkRmllbGQsIHRleHRGaWVsZDtcclxuICAgIGlmICh0aGlzLmhvc3RIZWxwQ29tcG9uZW50KSB7XHJcbiAgICAgIGlkRmllbGQgPSB0aGlzLmhvc3RIZWxwQ29tcG9uZW50LmlkRmllbGQ7XHJcbiAgICAgIHRleHRGaWVsZCA9IHRoaXMuaG9zdEhlbHBDb21wb25lbnQudGV4dEZpZWxkO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmhvc3RDb21ib0xpc3RDb21wb25lbnQpIHtcclxuICAgICAgaWRGaWVsZCA9IHRoaXMuaG9zdENvbWJvTGlzdENvbXBvbmVudC5pZEZpZWxkO1xyXG4gICAgICB0ZXh0RmllbGQgPSB0aGlzLmhvc3RDb21ib0xpc3RDb21wb25lbnQudGV4dEZpZWxkO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmhvc3RDb21ib0xvb2t1cENvbXBvbmVudCkge1xyXG4gICAgICBpZEZpZWxkID0gdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQuaWRGaWVsZDtcclxuICAgICAgdGV4dEZpZWxkID0gdGhpcy5ob3N0Q29tYm9Mb29rdXBDb21wb25lbnQudGV4dEZpZWxkO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZW1pdFVpU3RhdGVCaW5kaW5nKGRhdGEsIGlkRmllbGQsIHRleHRGaWVsZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGVtaXRVaVN0YXRlQmluZGluZyhkYXRhLCBpZEZpZWxkLCB0ZXh0RmllbGQpIHtcclxuICAgIGNvbnN0IG5ld09iamVjdCA9IHsga2V5OiBudWxsLCB2YWx1ZTogbnVsbCB9O1xyXG4gICAgaWYgKGRhdGEpIHtcclxuICAgICAgLy8gY29uc3QgaWRGaWVsZCA9IHRoaXMuaG9zdEhlbHBDb21wb25lbnQuaWRGaWVsZDtcclxuICAgICAgLy8gY29uc3QgdGV4dEZpZWxkID0gdGhpcy5ob3N0SGVscENvbXBvbmVudC50ZXh0RmllbGQ7XHJcbiAgICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGEpKSB7XHJcbiAgICAgICAgbmV3T2JqZWN0LmtleSA9IGRhdGEubWFwKGQgPT4gZFtpZEZpZWxkXSkuam9pbignLCcpO1xyXG4gICAgICAgIG5ld09iamVjdC52YWx1ZSA9IGRhdGEubWFwKGQgPT4ge1xyXG4gICAgICAgICAgaWYgKHRleHRGaWVsZC5pbmRleE9mKCcuJykgPiAtMSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGV4dEZpZWxkLnNwbGl0KCcuJykucmVkdWNlKChyLCBjKSA9PiB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIHJbY107XHJcbiAgICAgICAgICAgIH0sIGQpO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIGRbdGV4dEZpZWxkXTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KS5qb2luKCcsJylcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBpZiAoaWRGaWVsZCkge1xyXG4gICAgICAgICAgbmV3T2JqZWN0LmtleSA9IGRhdGFbaWRGaWVsZF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGV4dEZpZWxkKSB7XHJcbiAgICAgICAgICBpZiAodGV4dEZpZWxkLmluZGV4T2YoJy4nKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIG5ld09iamVjdC52YWx1ZSA9IHRleHRGaWVsZC5zcGxpdCgnLicpLnJlZHVjZSgociwgYykgPT4ge1xyXG4gICAgICAgICAgICAgIHJldHVybiByW2NdO1xyXG4gICAgICAgICAgICB9LCBkYXRhKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIG5ld09iamVjdC52YWx1ZSA9IGRhdGFbdGV4dEZpZWxkXTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHRoaXMuVUlTdGF0ZUJpbmRpbmdDaGFuZ2UuZW1pdChuZXdPYmplY3QpO1xyXG4gIH1cclxuXHJcbn1cclxuIl19