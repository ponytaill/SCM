import { Injectable, Injector } from "@angular/core";
import { AppContextManager, FrameContext } from "@farris/devkit";
import { from, of } from "rxjs";
import { BefRepositoryUtil } from '@farris/bef';
import { concatMap, throwIfEmpty } from "rxjs/operators";
import { ValidationService } from "../validation.service";
import { WorkFlowMessage } from "./work-flow-message";
import { WorkFlowMessageService } from "./work-flow-message.service";
export class WorkFlowMessageHandler {
    constructor(injector, frameContext, workFlowMessageService, workFlowMessage) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.workFlowMessageService = workFlowMessageService;
        this.workFlowMessage = workFlowMessage;
    }
    onComponentInit(frameContext) {
        const eventId = this.workFlowMessage.addEventListener(this.handle.bind(this));
        const frameContextDestroySignal = this.frameContext.destorySignal;
        if (frameContextDestroySignal) {
            frameContextDestroySignal.subscribe(() => {
                this.workFlowMessage.removeEventListener(eventId);
            });
        }
        const appContextDestroySignal = this.frameContext.appContext.destorySignal;
        if (appContextDestroySignal) {
            appContextDestroySignal.subscribe(() => {
                this.workFlowMessage.workFlowMessageService.destroy();
            });
        }
    }
    handle(message) {
        const source = message.sender;
        const data = message.data;
        const commandName = data && data.command || null;
        let resultTask = null;
        if (!commandName) {
            return;
        }
        if (commandName == 'wf-required-verification') {
            // 工作流的必填校验
            // 如此获取的是当前组件的校验服务，应该按namespace来区分，不同的namespace需要分别执行校验
            const formFrameContexts = this.getFormFrameContexts();
            resultTask = from(formFrameContexts).pipe(concatMap((frameContext) => {
                var validation = frameContext.injector.get(ValidationService, null);
                if (validation) {
                    return validation.validateAll();
                }
                return of(true);
            }));
        }
        else {
            var command = this.frameContext.viewModel[commandName];
            if (command) {
                resultTask = command(data.arguments);
            }
        }
        if (resultTask) {
            const message = this.buildMessage(true, source, this.isChanged);
            resultTask.pipe(throwIfEmpty()).subscribe((result) => {
                // 向来源方回传消息
                this.workFlowMessageService.send(message);
            }, () => {
                message.data.result = false;
                this.workFlowMessageService.send(message);
            });
        }
    }
    buildMessage(result, target, dataChanged, type = 'message') {
        const message = {
            data: {
                result,
                dataChanged
            },
            type: type,
            target: target,
        };
        return message;
    }
    getFormFrameContexts() {
        const appContextManager = this.injector.get(AppContextManager, null);
        const formFrameContexts = [];
        if (appContextManager) {
            const appContexts = appContextManager.getAppContexts();
            if (appContexts && appContexts.length > 0) {
                appContexts.forEach((appContext) => {
                    const frameContexts = appContext.frameContextManager.getFrameContexts();
                    frameContexts.reduce((contexts, frameContext) => {
                        const namespace = frameContext.namespace;
                        const index = contexts.findIndex((frame) => frame.namespace === namespace);
                        if (index === -1) {
                            const root = frameContext.getVirtualRootFrameContext();
                            contexts.push(root);
                        }
                        return contexts;
                    }, formFrameContexts);
                });
            }
        }
        return formFrameContexts;
    }
    /**
     * 是否有未保存的变更
     */
    get isChanged() {
        const befRepository = this.frameContext.repository;
        return BefRepositoryUtil.isExistUnsaveData(befRepository);
    }
}
WorkFlowMessageHandler.decorators = [
    { type: Injectable }
];
/** @nocollapse */
WorkFlowMessageHandler.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: WorkFlowMessageService },
    { type: WorkFlowMessage }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29yay1mbG93LW1lc3NhZ2UuaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi93b3JrLWZsb3cvd29yay1mbG93LW1lc3NhZ2UuaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQWMsaUJBQWlCLEVBQUUsWUFBWSxFQUF3QixNQUFNLGdCQUFnQixDQUFDO0FBQ25HLE9BQU8sRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDL0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUUxRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFHckUsTUFBTSxPQUFPLHNCQUFzQjtJQUNqQyxZQUFvQixRQUFrQixFQUFVLFlBQTBCLEVBQVUsc0JBQThDLEVBQVUsZUFBZ0M7UUFBeEosYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQVUsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUF3QjtRQUFVLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtJQUU1SyxDQUFDO0lBQ00sZUFBZSxDQUFDLFlBQTBCO1FBQy9DLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUM5RSxNQUFNLHlCQUF5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QUFPLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQzVELENBQUM7OztZQWpHRixVQUFVOzs7O1lBVlUsUUFBUTtZQUNXLFlBQVk7WUFPM0Msc0JBQXNCO1lBRHRCLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBBcHBDb250ZXh0LCBBcHBDb250ZXh0TWFuYWdlciwgRnJhbWVDb250ZXh0LCBvbkZyYW1lQ29tcG9uZW50SW5pdCB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSwgQmVmUmVwb3NpdG9yeVV0aWwgfSBmcm9tICdAZmFycmlzL2JlZic7XG5pbXBvcnQgeyBjb25jYXRNYXAsIHRocm93SWZFbXB0eSB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgVmFsaWRhdGlvblNlcnZpY2UgfSBmcm9tIFwiLi4vdmFsaWRhdGlvbi5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBXb3JrRmxvdyB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgeyBXb3JrRmxvd01lc3NhZ2UgfSBmcm9tIFwiLi93b3JrLWZsb3ctbWVzc2FnZVwiO1xuaW1wb3J0IHsgV29ya0Zsb3dNZXNzYWdlU2VydmljZSB9IGZyb20gXCIuL3dvcmstZmxvdy1tZXNzYWdlLnNlcnZpY2VcIjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFdvcmtGbG93TWVzc2FnZUhhbmRsZXIgaW1wbGVtZW50cyBvbkZyYW1lQ29tcG9uZW50SW5pdCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwcml2YXRlIHdvcmtGbG93TWVzc2FnZVNlcnZpY2U6IFdvcmtGbG93TWVzc2FnZVNlcnZpY2UsIHByaXZhdGUgd29ya0Zsb3dNZXNzYWdlOiBXb3JrRmxvd01lc3NhZ2UpIHtcblxuICB9XG4gIHB1YmxpYyBvbkNvbXBvbmVudEluaXQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcbiAgICBjb25zdCBldmVudElkID0gdGhpcy53b3JrRmxvd01lc3NhZ2UuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmhhbmRsZS5iaW5kKHRoaXMpKTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHREZXN0cm95U2lnbmFsID0gdGhpcy5mcmFtZUNvbnRleHQuZGVzdG9yeVNpZ25hbDtcbiAgICBpZiAoZnJhbWVDb250ZXh0RGVzdHJveVNpZ25hbCkge1xuICAgICAgZnJhbWVDb250ZXh0RGVzdHJveVNpZ25hbC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLndvcmtGbG93TWVzc2FnZS5yZW1vdmVFdmVudExpc3RlbmVyKGV2ZW50SWQpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGNvbnN0IGFwcENvbnRleHREZXN0cm95U2lnbmFsID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5kZXN0b3J5U2lnbmFsO1xuICAgIGlmIChhcHBDb250ZXh0RGVzdHJveVNpZ25hbCkge1xuICAgICAgYXBwQ29udGV4dERlc3Ryb3lTaWduYWwuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdGhpcy53b3JrRmxvd01lc3NhZ2Uud29ya0Zsb3dNZXNzYWdlU2VydmljZS5kZXN0cm95KCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcHVibGljIGhhbmRsZShtZXNzYWdlOiBXb3JrRmxvdy5JTWVzc2FnZSk6IHZvaWQge1xuICAgIGNvbnN0IHNvdXJjZSA9IG1lc3NhZ2Uuc2VuZGVyIGFzIFdpbmRvdztcbiAgICBjb25zdCBkYXRhID0gbWVzc2FnZS5kYXRhIGFzIFdvcmtGbG93LklNZXNzYWdlQm9keTtcbiAgICBjb25zdCBjb21tYW5kTmFtZSA9IGRhdGEgJiYgZGF0YS5jb21tYW5kIHx8IG51bGw7XG4gICAgbGV0IHJlc3VsdFRhc2s6IE9ic2VydmFibGU8YW55PiA9IG51bGw7XG4gICAgaWYgKCFjb21tYW5kTmFtZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoY29tbWFuZE5hbWUgPT0gJ3dmLXJlcXVpcmVkLXZlcmlmaWNhdGlvbicpIHtcbiAgICAgIC8vIOW3peS9nOa1geeahOW/heWhq+agoemqjFxuICAgICAgLy8g5aaC5q2k6I635Y+W55qE5piv5b2T5YmN57uE5Lu255qE5qCh6aqM5pyN5Yqh77yM5bqU6K+l5oyJbmFtZXNwYWNl5p2l5Yy65YiG77yM5LiN5ZCM55qEbmFtZXNwYWNl6ZyA6KaB5YiG5Yir5omn6KGM5qCh6aqMXG4gICAgICBjb25zdCBmb3JtRnJhbWVDb250ZXh0cyA9IHRoaXMuZ2V0Rm9ybUZyYW1lQ29udGV4dHMoKTtcbiAgICAgIHJlc3VsdFRhc2sgPSBmcm9tKGZvcm1GcmFtZUNvbnRleHRzKS5waXBlKFxuICAgICAgICBjb25jYXRNYXAoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICAgICAgdmFyIHZhbGlkYXRpb24gPSBmcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PFZhbGlkYXRpb25TZXJ2aWNlPihWYWxpZGF0aW9uU2VydmljZSwgbnVsbCk7XG4gICAgICAgICAgaWYgKHZhbGlkYXRpb24pIHtcbiAgICAgICAgICAgIHJldHVybiB2YWxpZGF0aW9uLnZhbGlkYXRlQWxsKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBjb21tYW5kID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsW2NvbW1hbmROYW1lXTtcbiAgICAgIGlmIChjb21tYW5kKSB7XG4gICAgICAgIHJlc3VsdFRhc2sgPSBjb21tYW5kKGRhdGEuYXJndW1lbnRzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKHJlc3VsdFRhc2spIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2U6IFdvcmtGbG93LklNZXNzYWdlID0gdGhpcy5idWlsZE1lc3NhZ2UodHJ1ZSwgc291cmNlLCB0aGlzLmlzQ2hhbmdlZCk7XG4gICAgICByZXN1bHRUYXNrLnBpcGUodGhyb3dJZkVtcHR5KCkpLnN1YnNjcmliZSgocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIOWQkeadpea6kOaWueWbnuS8oOa2iOaBr1xuICAgICAgICB0aGlzLndvcmtGbG93TWVzc2FnZVNlcnZpY2Uuc2VuZChtZXNzYWdlKTtcbiAgICAgIH0sICgpID0+IHtcbiAgICAgICAgbWVzc2FnZS5kYXRhLnJlc3VsdCA9IGZhbHNlO1xuICAgICAgICB0aGlzLndvcmtGbG93TWVzc2FnZVNlcnZpY2Uuc2VuZChtZXNzYWdlKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGJ1aWxkTWVzc2FnZShyZXN1bHQ6IGJvb2xlYW4sIHRhcmdldDogYW55LCBkYXRhQ2hhbmdlZDogYm9vbGVhbiwgdHlwZTogc3RyaW5nID0gJ21lc3NhZ2UnKSB7XG4gICAgY29uc3QgbWVzc2FnZTogV29ya0Zsb3cuSU1lc3NhZ2UgPSB7XG4gICAgICBkYXRhOiB7XG4gICAgICAgIHJlc3VsdCxcbiAgICAgICAgZGF0YUNoYW5nZWRcbiAgICAgIH0sXG4gICAgICB0eXBlOiB0eXBlLFxuICAgICAgdGFyZ2V0OiB0YXJnZXQsXG4gICAgfTtcbiAgICByZXR1cm4gbWVzc2FnZTtcbiAgfVxuICBwcml2YXRlIGdldEZvcm1GcmFtZUNvbnRleHRzKCk6IEZyYW1lQ29udGV4dFtdIHtcbiAgICBjb25zdCBhcHBDb250ZXh0TWFuYWdlciA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHRNYW5hZ2VyPihBcHBDb250ZXh0TWFuYWdlciwgbnVsbCk7XG4gICAgY29uc3QgZm9ybUZyYW1lQ29udGV4dHMgPSBbXTtcbiAgICBpZiAoYXBwQ29udGV4dE1hbmFnZXIpIHtcbiAgICAgIGNvbnN0IGFwcENvbnRleHRzOiBBcHBDb250ZXh0W10gPSBhcHBDb250ZXh0TWFuYWdlci5nZXRBcHBDb250ZXh0cygpO1xuICAgICAgaWYgKGFwcENvbnRleHRzICYmIGFwcENvbnRleHRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgYXBwQ29udGV4dHMuZm9yRWFjaCgoYXBwQ29udGV4dDogQXBwQ29udGV4dCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKTtcbiAgICAgICAgICBmcmFtZUNvbnRleHRzLnJlZHVjZSgoY29udGV4dHM6IEZyYW1lQ29udGV4dFtdLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gY29udGV4dHMuZmluZEluZGV4KChmcmFtZTogRnJhbWVDb250ZXh0KSA9PiBmcmFtZS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICAgIGNvbnN0IHJvb3QgPSBmcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcbiAgICAgICAgICAgICAgY29udGV4dHMucHVzaChyb290KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBjb250ZXh0cztcbiAgICAgICAgICB9LCBmb3JtRnJhbWVDb250ZXh0cyk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZm9ybUZyYW1lQ29udGV4dHM7XG4gIH1cbiAgLyoqXG4gICAqIOaYr+WQpuacieacquS/neWtmOeahOWPmOabtFxuICAgKi9cbiAgcHJpdmF0ZSBnZXQgaXNDaGFuZ2VkKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICByZXR1cm4gQmVmUmVwb3NpdG9yeVV0aWwuaXNFeGlzdFVuc2F2ZURhdGEoYmVmUmVwb3NpdG9yeSk7XG4gIH1cbn0iXX0=