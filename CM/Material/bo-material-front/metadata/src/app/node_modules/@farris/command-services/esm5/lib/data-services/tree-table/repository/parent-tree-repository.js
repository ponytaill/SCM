import { HttpHeaders } from '@angular/common/http';
import { of } from 'rxjs';
import { map, tap } from 'rxjs/operators';
import { FieldMetadataUtil } from '@farris/devkit';
/**
 * 父子树仓库
 */
var ParentTreeRepository = /** @class */ (function () {
    function ParentTreeRepository() {
    }
    /**
     * 添加兄弟节点
     */
    ParentTreeRepository.prototype.addSibling = function (repository, id) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSiblingUri = baseUri + "/service/parenthierarchycreatesibling";
        var body = {
            dataID: id,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加兄弟节点
     */
    ParentTreeRepository.prototype.addChild = function (repository, parentId) {
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addChildUri = baseUri + "/service/parenthierarchycreatechildlayer";
        var body = {
            dataID: parentId,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var entity = repository.buildEntity(responseInfo.returnValue);
            repository.entityCollection.addEntity(entity);
            return entity;
        }));
    };
    /**
     * 添加子表兄弟节点
     */
    ParentTreeRepository.prototype.addSubSibling = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubSiblingUri = baseUri + "/service/childnodeparenthierarchycreatesibling";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubSiblingUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var path = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(path, responseInfo.returnValue);
            return entity;
        }));
    };
    /**
     * 添加子表子节点
     */
    ParentTreeRepository.prototype.addSubChild = function (repository, nodes, ids) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var addSubChildUri = baseUri + "/service/childnodeparenthierarchycreatechildlayer";
        var body = {
            nodes: nodes,
            ids: ids,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            headers: new HttpHeaders({ 'Content-Type': 'application/json' }),
            body: body
        };
        return restService.invoke(addSubChildUri, 'PUT', null, options).pipe(map(function (responseInfo) {
            var paths = _this.getPaths(nodes, ids);
            var entity = repository.entityManager.appendEntityByPath(paths, responseInfo.returnValue);
            return entity;
        }));
    };
    ParentTreeRepository.prototype.getPaths = function (nodes, ids) {
        var paths = '';
        if (nodes && nodes.length > 0 && ids && ids.length > 0) {
            for (var i = 0; i < ids.length; i++) {
                if (nodes[i]) {
                    paths = paths + ("/" + ids[i]);
                    paths = paths + ("/" + nodes[i] + "s");
                }
            }
        }
        return paths;
    };
    /**
     * 加载父节点
     */
    // tslint:disable-next-line: max-line-length
    ParentTreeRepository.prototype.loadByParentId = function (repository, hierarchyInfoKey, parentId, filters, sorts, frozenCurrentRow, pagination, frameContext, reload) {
        var _this = this;
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        if (reload === void 0) { reload = false; }
        var localEntities = this.getChildren(repository, hierarchyInfoKey, parentId);
        if (localEntities && localEntities.length > 0 && !reload) {
            return of(localEntities);
        }
        var restService = repository.restService;
        var parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var originalHierarchyInfoKey = this.getOriginalHierarchyInfoKey(repository, hierarchyInfoKey);
        var filtersWithParent = this.buildFiltersWithParent(originalHierarchyInfoKey, parentHierarchyInfo, filters);
        var isUsePagination = pagination && pagination.pageSize > 0 || false;
        // 组织EntityFilter
        var entityFilter = {
            FilterConditions: filtersWithParent,
            SortConditions: sorts,
            IsUsePagination: isUsePagination,
            Pagination: { PageIndex: pagination && pagination.pageIndex || 0, PageSize: pagination && pagination.pageSize || 0, PageCount: 0, TotalCount: 0 }
        };
        var requestInfo = restService.buildRequestInfo();
        return restService.extendQuery(entityFilter, requestInfo).pipe(map(function (responseInfo) {
            var paginationInfo = _this.getPaginationInfo(responseInfo);
            if (parentId) {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.params.set("_NODE_" + parentId + "_PAGINATION_INFO_", paginationInfo);
                }
            }
            else {
                if (paginationInfo && paginationInfo.pageSize !== 0 && frameContext) {
                    frameContext.repository.entityCollection.updatePaginationInfoByPath('/', paginationInfo);
                }
            }
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities);
            }
            else {
                repository.entityCollection.addEntities(entities);
            }
            return entities;
        }));
    };
    // tslint:disable-next-line: max-line-length
    ParentTreeRepository.prototype.loadFullTree = function (repository, hierarchyInfoKey, parentId, propertyName, fullTreeType, loadType, filters, context) {
        var _this = this;
        var restService = repository.restService;
        var baseUri = restService.baseUri;
        var queryUrl = baseUri + "/service/parentidfulltreequery";
        var parentHierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, parentId);
        var entityFilter = this.buildEntityFilter(filters, null, 0, 0);
        var body = {
            dataId: parentId || '',
            isUsePagination: false,
            virtualPropertyName: propertyName,
            pagination: {},
            fullTreeType: fullTreeType,
            loadType: loadType,
            filter: entityFilter,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        return restService.invoke(queryUrl, 'PUT', null, options).pipe(tap(function (responseInfo) {
            // 保存展开的节点
            if (responseInfo.returnValue && responseInfo.returnValue.selectedRowId && context && context.frameContext) {
                var frameContext = context.frameContext;
                var virtualRootFrameContext = frameContext && frameContext.getVirtualRootFrameContext() || null;
                if (virtualRootFrameContext) {
                    var list = responseInfo.returnValue.result;
                    var selectedRowId_1 = responseInfo.returnValue.selectedRowId;
                    // 从顶层开始计算所有需要展开的节点
                    var leafNodeInfo = list.find(function (item) { return item[repository.primaryKey] === selectedRowId_1; });
                    var hierarchyInfo = leafNodeInfo[hierarchyInfoKey];
                    var ids = _this.getAllParentIds(hierarchyInfo, list, hierarchyInfoKey, repository);
                    virtualRootFrameContext.params.set('_DEVKIT_expandRowIds', ids.join(','));
                    virtualRootFrameContext.params.set('_DEVKIT_selectedRowId', selectedRowId_1);
                    virtualRootFrameContext.uiState.setPropertyValue('__DEVKIT__selectedRow', selectedRowId_1);
                }
            }
        }), map(function (responseInfo) {
            var frozenCurrentRow = context && context.frozenCurrentRow || false;
            // 先清空下级实体
            _this.clearDescendantEntities(repository, hierarchyInfoKey, parentHierarchyInfo, frozenCurrentRow);
            // 追加下级实体
            var listData = responseInfo.returnValue.result;
            var entities = repository.buildEntities(listData);
            if (frozenCurrentRow) {
                repository.entityCollection.addData(entities);
            }
            else {
                repository.entityCollection.addEntities(entities);
            }
            return entities;
        }));
    };
    /**
     * 插入对父节点的过滤
     */
    ParentTreeRepository.prototype.buildFiltersWithParent = function (originalHierarchyInfoKey, parentHierarchyInfo, filterArray) {
        var relationType = filterArray && filterArray.length >= 1 ? 1 : 0;
        var parentLayer = parentHierarchyInfo ? parentHierarchyInfo['layer'] : 0;
        var parentElement = parentHierarchyInfo ? parentHierarchyInfo['id'] : '';
        var parentFilterArray = [
            {
                "FilterField": originalHierarchyInfoKey + ".Layer",
                "Value": parentLayer + 1,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": 1,
                "Expresstype": 0,
                "Compare": 0
            }
        ];
        if (parentElement) {
            parentFilterArray.push({
                "FilterField": originalHierarchyInfoKey + ".ParentElement",
                "Value": parentElement,
                "Lbracket": null,
                "Rbracket": null,
                "Relation": relationType,
                "Expresstype": 0,
                "Compare": 0
            });
        }
        else {
            parentFilterArray[0].Relation = relationType;
        }
        return parentFilterArray.concat(filterArray);
    };
    ParentTreeRepository.prototype.buildEntityFilter = function (filter, sort, pageSize, pageIndex) {
        // @todo：临时兼容老代码，降低改动带来的风险
        if (!filter && !sort && !pageSize && !pageIndex) {
            return null;
        }
        if (!filter) {
            filter = [];
        }
        if (!sort) {
            sort = [];
        }
        // 纠正最后一个过滤条件的Relation
        if (filter && filter.length > 0) {
            filter[filter.length - 1].Relation = 0;
        }
        var entityFilter = {
            FilterConditions: filter,
            SortConditions: sort,
            IsUsePagination: pageSize === 0 ? false : true,
            Pagination: {
                PageIndex: pageIndex,
                PageSize: pageSize,
                PageCount: 0,
                TotalCount: 0
            }
        };
        return entityFilter;
    };
    /**
     * 清空后代实体
     * @description parentHierarchyInfo中layer为要清空后代节点的layer，但里面的parentElement不是父级的id，而是要清空后代节点的id
     */
    ParentTreeRepository.prototype.clearDescendantEntities = function (repository, hierarchyInfokey, parentHierarchyInfo, frozenCurrentRow) {
        if (frozenCurrentRow === void 0) { frozenCurrentRow = false; }
        // 清空根节点
        if (!parentHierarchyInfo) {
            repository.entityCollection.clear();
            return;
        }
        var nodes = this.getChildNodes(repository, hierarchyInfokey, parentHierarchyInfo);
        if (frozenCurrentRow) {
            repository.entityCollection.removeEntities(function (entity) {
                var id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
        else {
            repository.entityCollection.removeData(function (entity) {
                var id = entity[entity.primaryKey];
                return nodes.includes(id);
            });
        }
    };
    /**
     * 获取某个节点的所有子节点
     * @param repository repository
     * @param hierarchyInfokey hierarchyInfokey
     * @param parentHierarchyInfo parentHierarchyInfo
     */
    ParentTreeRepository.prototype.getChildNodes = function (repository, hierarchyInfokey, parentHierarchyInfo) {
        var _this = this;
        var fparentElement = parentHierarchyInfo.id;
        var flayer = parentHierarchyInfo.layer;
        var nodes = [];
        repository.entityCollection.getAllEntities().forEach(function (entity) {
            var hierarchyInfo = entity[hierarchyInfokey];
            var parentElement = hierarchyInfo.parentElement;
            var layer = hierarchyInfo.layer;
            var result = layer >= (flayer + 1) && parentElement === fparentElement;
            if (result) {
                var id = entity[entity.primaryKey];
                nodes.push(id);
                var childHierarchyInfo = _this.getHierarchyInfoById(repository, hierarchyInfokey, id);
                var childs = _this.getChildNodes(repository, hierarchyInfokey, childHierarchyInfo);
                if (childs && childs.length > 0) {
                    nodes = nodes.concat(childs);
                }
            }
        });
        return nodes;
    };
    /**
     * 获取实体的分级信息
     */
    ParentTreeRepository.prototype.getHierarchyInfoById = function (repository, hierarchyInfokey, id) {
        if (!id) {
            return null;
        }
        var entity = repository.entityCollection.getEntityById(id);
        var hierarchyInfoEntity = entity[hierarchyInfokey];
        var result = hierarchyInfoEntity.toJSON();
        result['id'] = id;
        return result;
    };
    ParentTreeRepository.prototype.getHierarchyInfo = function (entity, hierarchyInfokey) {
        return entity[hierarchyInfokey];
    };
    /**
     * 获取分级码的原始的字段名
     */
    ParentTreeRepository.prototype.getOriginalHierarchyInfoKey = function (repository, hierarchyInfokey) {
        var ngObjects = FieldMetadataUtil.getNgObjects(repository.entityType);
        var hierarchyInfoNgObject = ngObjects[hierarchyInfokey];
        return hierarchyInfoNgObject.originalDataField;
    };
    ParentTreeRepository.prototype.getPaginationInfo = function (responseInfo) {
        return responseInfo && responseInfo.returnValue && responseInfo.returnValue.pagination || null;
    };
    ParentTreeRepository.prototype.findParent = function (hierarchyInfo, list, hierarchyInfoKey) {
        return list.find(function (item) {
            var currentHierarchyInfo = item[hierarchyInfoKey];
            return currentHierarchyInfo.layer === hierarchyInfo.layer - 1 && hierarchyInfo.parentElement === currentHierarchyInfo.parentElement;
        });
    };
    ParentTreeRepository.prototype.getAllParentIds = function (hierarchyInfo, list, hierarchyInfoKey, repository) {
        var item = this.findParent(hierarchyInfo, list, hierarchyInfoKey);
        var ids = [];
        while (item) {
            ids.push(item[repository.primaryKey]);
            item = this.findParent(item[hierarchyInfoKey], list, hierarchyInfoKey);
        }
        return ids;
    };
    /**
     * 查找节点下所有子级（第一级）
     * @param repository repository
     * @param hierarchyInfoKey 分级码字段
     * @param id id
     * @returns
     */
    ParentTreeRepository.prototype.getChildren = function (repository, hierarchyInfoKey, id) {
        var _this = this;
        var hierarchyInfo = this.getHierarchyInfoById(repository, hierarchyInfoKey, id);
        if (!hierarchyInfo) {
            return null;
        }
        var layer = hierarchyInfo.layer;
        var parentElement = hierarchyInfo.parentElement;
        var entities = repository.entityCollection.getEntities(function (entity) {
            var hierarchyInfo = _this.getHierarchyInfo(entity, hierarchyInfoKey);
            var matched = hierarchyInfo.layer === layer + 1 && (hierarchyInfo.parentElement === parentElement || !parentElement && !hierarchyInfo.parentElement);
            if (matched) {
                return entity;
            }
            else {
                return null;
            }
        });
        return entities;
    };
    return ParentTreeRepository;
}());
export { ParentTreeRepository };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyZW50LXRyZWUtcmVwb3NpdG9yeS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9kYXRhLXNlcnZpY2VzL3RyZWUtdGFibGUvcmVwb3NpdG9yeS9wYXJlbnQtdHJlZS1yZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNuRCxPQUFPLEVBQUUsRUFBRSxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUMsT0FBTyxFQUFVLGlCQUFpQixFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBR3JGOztHQUVHO0FBQ0g7SUFBQTtJQWtaQSxDQUFDO0lBaFpDOztPQUVHO0lBQ0kseUNBQVUsR0FBakIsVUFBa0IsVUFBaUMsRUFBRSxFQUFVO1FBQzdELElBQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDM0MsSUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFNLGFBQWEsR0FBTSxPQUFPLDBDQUF1QyxDQUFDO1FBQ3hFLElBQU0sSUFBSSxHQUFHO1lBQ1gsTUFBTSxFQUFFLEVBQUU7WUFDVixXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1NBQzVDLENBQUM7UUFDRixJQUFNLE9BQU8sR0FBRztZQUNkLE9BQU8sRUFBRSxJQUFJLFdBQVcsQ0FBQyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDO1lBQ2hFLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQztRQUNGLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ2pFLEdBQUcsQ0FBQyxVQUFDLFlBQTBCO1lBQzdCLElB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QUM7U0FDYjtRQUNELElBQU0sS0FBSyxHQUFHLGFBQWEsQ0FBQyxLQUFLLENBQUM7UUFDbEMsSUFBTSxhQUFhLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQztRQUNsRCxJQUFNLFFBQVEsR0FBYSxVQUFVLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFVBQUMsTUFBYztZQUNoRixJQUFNLGFBQWEsR0FBRyxLQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFDdEUsSUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLEtBQUssS0FBSyxLQUFLLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsS0FBSyxhQUFhLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDdkosSUFBSSxPQUFPLEVBQUU7Z0JBQ1gsT0FBTyxNQUFNLENBQUM7YUFDZjtpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQzthQUNiO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBQ0gsMkJBQUM7QUFBRCxDQUFDLEFBbFpELElBa1pDO0FBRUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IG9mLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEVudGl0eSwgRmllbGRNZXRhZGF0YVV0aWwsIEZyYW1lQ29udGV4dCwgUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IFJlc3BvbnNlSW5mbywgQmVmUmVwb3NpdG9yeSB9IGZyb20gJ0BmYXJyaXMvYmVmJztcblxuLyoqXG4gKiDniLblrZDmoJHku5PlupNcbiAqL1xuY2xhc3MgUGFyZW50VHJlZVJlcG9zaXRvcnkge1xuXG4gIC8qKlxuICAgKiDmt7vliqDlhYTlvJ/oioLngrlcbiAgICovXG4gIHB1YmxpYyBhZGRTaWJsaW5nKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8RW50aXR5PiB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IGFkZFNpYmxpbmdVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhcmVudGhpZXJhcmNoeWNyZWF0ZXNpYmxpbmdgO1xuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBkYXRhSUQ6IGlkLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXG4gICAgICBib2R5OiBib2R5XG4gICAgfTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFNpYmxpbmdVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXR5KHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSk7XG4gICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmt7vliqDlhYTlvJ/oioLngrlcbiAgICovXG4gIHB1YmxpYyBhZGRDaGlsZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIHBhcmVudElkOiBzdHJpbmcpIHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgYWRkQ2hpbGRVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhcmVudGhpZXJhcmNoeWNyZWF0ZWNoaWxkbGF5ZXJgO1xuXG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIGRhdGFJRDogcGFyZW50SWQsXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgaGVhZGVyczogbmV3IEh0dHBIZWFkZXJzKHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9KSxcbiAgICAgIGJvZHk6IGJvZHlcbiAgICB9O1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UoYWRkQ2hpbGRVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXR5KHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSk7XG4gICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmt7vliqDlrZDooajlhYTlvJ/oioLngrlcbiAgICovXG4gIHB1YmxpYyBhZGRTdWJTaWJsaW5nKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5Piwgbm9kZXM6IEFycmF5PHN0cmluZz4sIGlkczogQXJyYXk8c3RyaW5nPik6IE9ic2VydmFibGU8RW50aXR5PiB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSByZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IGFkZFN1YlNpYmxpbmdVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2NoaWxkbm9kZXBhcmVudGhpZXJhcmNoeWNyZWF0ZXNpYmxpbmdgO1xuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBub2Rlczogbm9kZXMsXG4gICAgICBpZHM6IGlkcyxcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBoZWFkZXJzOiBuZXcgSHR0cEhlYWRlcnMoeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0pLFxuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShhZGRTdWJTaWJsaW5nVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgbGV0IHBhdGggPSB0aGlzLmdldFBhdGhzKG5vZGVzLCBpZHMpO1xuICAgICAgICBjb25zdCBlbnRpdHkgPSByZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuYXBwZW5kRW50aXR5QnlQYXRoKHBhdGgsIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSlcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmt7vliqDlrZDooajlrZDoioLngrlcbiAgICovXG4gIHB1YmxpYyBhZGRTdWJDaGlsZChyZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PEVudGl0eT4sIG5vZGVzOiBBcnJheTxzdHJpbmc+LCBpZHM6IEFycmF5PHN0cmluZz4pIHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgYWRkU3ViQ2hpbGRVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2NoaWxkbm9kZXBhcmVudGhpZXJhcmNoeWNyZWF0ZWNoaWxkbGF5ZXJgO1xuXG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIG5vZGVzOiBub2RlcyxcbiAgICAgIGlkczogaWRzLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSksXG4gICAgICBib2R5OiBib2R5XG4gICAgfTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKGFkZFN1YkNoaWxkVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgbGV0IHBhdGhzID0gdGhpcy5nZXRQYXRocyhub2RlcywgaWRzKTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gcmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmFwcGVuZEVudGl0eUJ5UGF0aChwYXRocywgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlKTtcbiAgICAgICAgcmV0dXJuIGVudGl0eTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGF0aHMobm9kZXM6IHN0cmluZ1tdLCBpZHM6IHN0cmluZ1tdKSB7XG4gICAgbGV0IHBhdGhzID0gJyc7XG4gICAgaWYgKG5vZGVzICYmIG5vZGVzLmxlbmd0aCA+IDAgJiYgaWRzICYmIGlkcy5sZW5ndGggPiAwKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAobm9kZXNbaV0pIHtcbiAgICAgICAgICBwYXRocyA9IHBhdGhzICsgYC8ke2lkc1tpXX1gO1xuICAgICAgICAgIHBhdGhzID0gcGF0aHMgKyBgLyR7bm9kZXNbaV19c2A7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHBhdGhzO1xuICB9XG5cbiAgLyoqXG4gICAqIOWKoOi9veeItuiKgueCuVxuICAgKi9cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcbiAgcHVibGljIGxvYWRCeVBhcmVudElkKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBmaWx0ZXJzOiBhbnlbXSwgc29ydHM6IGFueVtdLCBmcm96ZW5DdXJyZW50Um93OiBib29sZWFuID0gZmFsc2UsIHBhZ2luYXRpb24/OiB7IHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VJbmRleDogbnVtYmVyIH0sIGZyYW1lQ29udGV4dD86IEZyYW1lQ29udGV4dCwgcmVsb2FkOiBib29sZWFuID0gZmFsc2UpOiBPYnNlcnZhYmxlPEVudGl0eVtdPiB7XG4gICAgY29uc3QgbG9jYWxFbnRpdGllcyA9IHRoaXMuZ2V0Q2hpbGRyZW4ocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xuICAgIGlmIChsb2NhbEVudGl0aWVzICYmIGxvY2FsRW50aXRpZXMubGVuZ3RoID4gMCAmJiAhcmVsb2FkKSB7XG4gICAgICByZXR1cm4gb2YobG9jYWxFbnRpdGllcyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gcmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCBwYXJlbnRIaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRJZCk7XG4gICAgY29uc3Qgb3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5ID0gdGhpcy5nZXRPcmlnaW5hbEhpZXJhcmNoeUluZm9LZXkocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgY29uc3QgZmlsdGVyc1dpdGhQYXJlbnQgPSB0aGlzLmJ1aWxkRmlsdGVyc1dpdGhQYXJlbnQob3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvLCBmaWx0ZXJzKTtcbiAgICBjb25zdCBpc1VzZVBhZ2luYXRpb24gPSBwYWdpbmF0aW9uICYmIHBhZ2luYXRpb24ucGFnZVNpemUgPiAwIHx8IGZhbHNlO1xuICAgIC8vIOe7hOe7h0VudGl0eUZpbHRlclxuICAgIGNvbnN0IGVudGl0eUZpbHRlciA9IHtcbiAgICAgIEZpbHRlckNvbmRpdGlvbnM6IGZpbHRlcnNXaXRoUGFyZW50LFxuICAgICAgU29ydENvbmRpdGlvbnM6IHNvcnRzLFxuICAgICAgSXNVc2VQYWdpbmF0aW9uOiBpc1VzZVBhZ2luYXRpb24sXG4gICAgICBQYWdpbmF0aW9uOiB7IFBhZ2VJbmRleDogcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VJbmRleCB8fCAwLCBQYWdlU2l6ZTogcGFnaW5hdGlvbiAmJiBwYWdpbmF0aW9uLnBhZ2VTaXplIHx8IDAsIFBhZ2VDb3VudDogMCwgVG90YWxDb3VudDogMCB9XG4gICAgfTtcbiAgICBjb25zdCByZXF1ZXN0SW5mbyA9IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuZXh0ZW5kUXVlcnkoZW50aXR5RmlsdGVyLCByZXF1ZXN0SW5mbykucGlwZShcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgY29uc3QgcGFnaW5hdGlvbkluZm8gPSB0aGlzLmdldFBhZ2luYXRpb25JbmZvKHJlc3BvbnNlSW5mbyk7XG4gICAgICAgIGlmIChwYXJlbnRJZCkge1xuICAgICAgICAgIGlmIChwYWdpbmF0aW9uSW5mbyAmJiBwYWdpbmF0aW9uSW5mby5wYWdlU2l6ZSAhPT0gMCAmJiBmcmFtZUNvbnRleHQpIHtcbiAgICAgICAgICAgIGZyYW1lQ29udGV4dC5wYXJhbXMuc2V0KGBfTk9ERV8ke3BhcmVudElkfV9QQUdJTkFUSU9OX0lORk9fYCwgcGFnaW5hdGlvbkluZm8pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBpZiAocGFnaW5hdGlvbkluZm8gJiYgcGFnaW5hdGlvbkluZm8ucGFnZVNpemUgIT09IDAgJiYgZnJhbWVDb250ZXh0KSB7XG4gICAgICAgICAgICBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLnVwZGF0ZVBhZ2luYXRpb25JbmZvQnlQYXRoKCcvJywgcGFnaW5hdGlvbkluZm8pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyDlhYjmuIXnqbrkuIvnuqflrp7kvZNcbiAgICAgICAgdGhpcy5jbGVhckRlc2NlbmRhbnRFbnRpdGllcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZvS2V5LCBwYXJlbnRIaWVyYXJjaHlJbmZvLCBmcm96ZW5DdXJyZW50Um93KTtcbiAgICAgICAgLy8g6L+95Yqg5LiL57qn5a6e5L2TXG4gICAgICAgIGNvbnN0IGxpc3REYXRhID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlLnJlc3VsdDtcbiAgICAgICAgY29uc3QgZW50aXRpZXMgPSByZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xuICAgICAgICBpZiAoZnJvemVuQ3VycmVudFJvdykge1xuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGREYXRhKGVudGl0aWVzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXRpZXMoZW50aXRpZXMpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbnRpdGllcztcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxuICBwdWJsaWMgbG9hZEZ1bGxUcmVlKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRJZDogc3RyaW5nLCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgZnVsbFRyZWVUeXBlOiBzdHJpbmcsIGxvYWRUeXBlOiBzdHJpbmcsIGZpbHRlcnM/OiBhbnlbXSwgY29udGV4dD86IGFueSk6IE9ic2VydmFibGU8RW50aXR5W10+IHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgcXVlcnlVcmwgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3BhcmVudGlkZnVsbHRyZWVxdWVyeWA7XG4gICAgY29uc3QgcGFyZW50SGllcmFyY2h5SW5mbyA9IHRoaXMuZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeSwgaGllcmFyY2h5SW5mb0tleSwgcGFyZW50SWQpO1xuICAgIGNvbnN0IGVudGl0eUZpbHRlciA9IHRoaXMuYnVpbGRFbnRpdHlGaWx0ZXIoZmlsdGVycywgbnVsbCwgMCwgMCk7XG5cbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgZGF0YUlkOiBwYXJlbnRJZCB8fCAnJyxcbiAgICAgIGlzVXNlUGFnaW5hdGlvbjogZmFsc2UsXG4gICAgICB2aXJ0dWFsUHJvcGVydHlOYW1lOiBwcm9wZXJ0eU5hbWUsXG4gICAgICBwYWdpbmF0aW9uOiB7fSxcbiAgICAgIGZ1bGxUcmVlVHlwZSxcbiAgICAgIGxvYWRUeXBlLFxuICAgICAgZmlsdGVyOiBlbnRpdHlGaWx0ZXIsXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZShxdWVyeVVybCwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXG4gICAgICB0YXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgIC8vIOS/neWtmOWxleW8gOeahOiKgueCuVxuICAgICAgICBpZiAocmVzcG9uc2VJbmZvLnJldHVyblZhbHVlICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5zZWxlY3RlZFJvd0lkICYmIGNvbnRleHQgJiYgY29udGV4dC5mcmFtZUNvbnRleHQpIHtcbiAgICAgICAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBjb250ZXh0LmZyYW1lQ29udGV4dCBhcyBGcmFtZUNvbnRleHQ7XG4gICAgICAgICAgY29uc3QgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkgfHwgbnVsbDtcbiAgICAgICAgICBpZiAodmlydHVhbFJvb3RGcmFtZUNvbnRleHQpIHtcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucmVzdWx0IGFzIGFueVtdO1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWRSb3dJZCA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5zZWxlY3RlZFJvd0lkO1xuICAgICAgICAgICAgLy8g5LuO6aG25bGC5byA5aeL6K6h566X5omA5pyJ6ZyA6KaB5bGV5byA55qE6IqC54K5XG4gICAgICAgICAgICBjb25zdCBsZWFmTm9kZUluZm8gPSBsaXN0LmZpbmQoaXRlbSA9PiBpdGVtW3JlcG9zaXRvcnkucHJpbWFyeUtleV0gPT09IHNlbGVjdGVkUm93SWQpO1xuICAgICAgICAgICAgY29uc3QgaGllcmFyY2h5SW5mbyA9IGxlYWZOb2RlSW5mb1toaWVyYXJjaHlJbmZvS2V5XSBhcyB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXJlbnRFbGVtZW50OiBzdHJpbmcgfTtcbiAgICAgICAgICAgIGNvbnN0IGlkcyA9IHRoaXMuZ2V0QWxsUGFyZW50SWRzKGhpZXJhcmNoeUluZm8sIGxpc3QsIGhpZXJhcmNoeUluZm9LZXksIHJlcG9zaXRvcnkpO1xuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQucGFyYW1zLnNldCgnX0RFVktJVF9leHBhbmRSb3dJZHMnLCBpZHMuam9pbignLCcpKTtcbiAgICAgICAgICAgIHZpcnR1YWxSb290RnJhbWVDb250ZXh0LnBhcmFtcy5zZXQoJ19ERVZLSVRfc2VsZWN0ZWRSb3dJZCcsIHNlbGVjdGVkUm93SWQpO1xuICAgICAgICAgICAgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQudWlTdGF0ZS5zZXRQcm9wZXJ0eVZhbHVlKCdfX0RFVktJVF9fc2VsZWN0ZWRSb3cnLCBzZWxlY3RlZFJvd0lkKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICBjb25zdCBmcm96ZW5DdXJyZW50Um93ID0gY29udGV4dCAmJiBjb250ZXh0LmZyb3plbkN1cnJlbnRSb3cgfHwgZmFsc2U7XG4gICAgICAgIC8vIOWFiOa4heepuuS4i+e6p+WunuS9k1xuICAgICAgICB0aGlzLmNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIHBhcmVudEhpZXJhcmNoeUluZm8sIGZyb3plbkN1cnJlbnRSb3cpO1xuICAgICAgICAvLyDov73liqDkuIvnuqflrp7kvZNcbiAgICAgICAgY29uc3QgbGlzdERhdGEgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWUucmVzdWx0O1xuICAgICAgICBjb25zdCBlbnRpdGllcyA9IHJlcG9zaXRvcnkuYnVpbGRFbnRpdGllcyhsaXN0RGF0YSk7XG4gICAgICAgIGlmIChmcm96ZW5DdXJyZW50Um93KSB7XG4gICAgICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZERhdGEoZW50aXRpZXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGVudGl0aWVzO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmj5LlhaXlr7nniLboioLngrnnmoTov4fmu6RcbiAgICovXG4gIHB1YmxpYyBidWlsZEZpbHRlcnNXaXRoUGFyZW50KG9yaWdpbmFsSGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBwYXJlbnRIaWVyYXJjaHlJbmZvOiBhbnksIGZpbHRlckFycmF5OiBhbnlbXSk6IGFueSB7XG4gICAgY29uc3QgcmVsYXRpb25UeXBlID0gZmlsdGVyQXJyYXkgJiYgZmlsdGVyQXJyYXkubGVuZ3RoID49IDEgPyAxIDogMDtcbiAgICBjb25zdCBwYXJlbnRMYXllciA9IHBhcmVudEhpZXJhcmNoeUluZm8gPyBwYXJlbnRIaWVyYXJjaHlJbmZvWydsYXllciddIDogMDtcbiAgICBjb25zdCBwYXJlbnRFbGVtZW50ID0gcGFyZW50SGllcmFyY2h5SW5mbyA/IHBhcmVudEhpZXJhcmNoeUluZm9bJ2lkJ10gOiAnJztcblxuICAgIGNvbnN0IHBhcmVudEZpbHRlckFycmF5ID0gW1xuICAgICAge1xuICAgICAgICBcIkZpbHRlckZpZWxkXCI6IGAke29yaWdpbmFsSGllcmFyY2h5SW5mb0tleX0uTGF5ZXJgLFxuICAgICAgICBcIlZhbHVlXCI6IHBhcmVudExheWVyICsgMSxcbiAgICAgICAgXCJMYnJhY2tldFwiOiBudWxsLFxuICAgICAgICBcIlJicmFja2V0XCI6IG51bGwsXG4gICAgICAgIFwiUmVsYXRpb25cIjogMSxcbiAgICAgICAgXCJFeHByZXNzdHlwZVwiOiAwLFxuICAgICAgICBcIkNvbXBhcmVcIjogMFxuICAgICAgfVxuICAgIF07XG4gICAgaWYgKHBhcmVudEVsZW1lbnQpIHtcbiAgICAgIHBhcmVudEZpbHRlckFycmF5LnB1c2goXG4gICAgICAgIHtcbiAgICAgICAgICBcIkZpbHRlckZpZWxkXCI6IGAke29yaWdpbmFsSGllcmFyY2h5SW5mb0tleX0uUGFyZW50RWxlbWVudGAsXG4gICAgICAgICAgXCJWYWx1ZVwiOiBwYXJlbnRFbGVtZW50LFxuICAgICAgICAgIFwiTGJyYWNrZXRcIjogbnVsbCxcbiAgICAgICAgICBcIlJicmFja2V0XCI6IG51bGwsXG4gICAgICAgICAgXCJSZWxhdGlvblwiOiByZWxhdGlvblR5cGUsXG4gICAgICAgICAgXCJFeHByZXNzdHlwZVwiOiAwLFxuICAgICAgICAgIFwiQ29tcGFyZVwiOiAwXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmVudEZpbHRlckFycmF5WzBdLlJlbGF0aW9uID0gcmVsYXRpb25UeXBlO1xuICAgIH1cbiAgICByZXR1cm4gcGFyZW50RmlsdGVyQXJyYXkuY29uY2F0KGZpbHRlckFycmF5KTtcbiAgfVxuICBwdWJsaWMgYnVpbGRFbnRpdHlGaWx0ZXIoZmlsdGVyOiBhbnlbXSwgc29ydDogYW55W10sIHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VJbmRleDogbnVtYmVyKSB7XG5cbiAgICAvLyBAdG9kb++8muS4tOaXtuWFvOWuueiAgeS7o+egge+8jOmZjeS9juaUueWKqOW4puadpeeahOmjjumZqVxuICAgIGlmICghZmlsdGVyICYmICFzb3J0ICYmICFwYWdlU2l6ZSAmJiAhcGFnZUluZGV4KSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgaWYgKCFmaWx0ZXIpIHtcbiAgICAgIGZpbHRlciA9IFtdO1xuICAgIH1cbiAgICBpZiAoIXNvcnQpIHtcbiAgICAgIHNvcnQgPSBbXTtcbiAgICB9XG4gICAgLy8g57qg5q2j5pyA5ZCO5LiA5Liq6L+H5ruk5p2h5Lu255qEUmVsYXRpb25cbiAgICBpZiAoZmlsdGVyICYmIGZpbHRlci5sZW5ndGggPiAwKSB7XG4gICAgICBmaWx0ZXJbZmlsdGVyLmxlbmd0aCAtIDFdLlJlbGF0aW9uID0gMDtcbiAgICB9XG4gICAgY29uc3QgZW50aXR5RmlsdGVyID0ge1xuICAgICAgRmlsdGVyQ29uZGl0aW9uczogZmlsdGVyLFxuICAgICAgU29ydENvbmRpdGlvbnM6IHNvcnQsXG4gICAgICBJc1VzZVBhZ2luYXRpb246IHBhZ2VTaXplID09PSAwID8gZmFsc2UgOiB0cnVlLFxuICAgICAgUGFnaW5hdGlvbjoge1xuICAgICAgICBQYWdlSW5kZXg6IHBhZ2VJbmRleCxcbiAgICAgICAgUGFnZVNpemU6IHBhZ2VTaXplLFxuICAgICAgICBQYWdlQ291bnQ6IDAsXG4gICAgICAgIFRvdGFsQ291bnQ6IDBcbiAgICAgIH1cbiAgICB9O1xuICAgIHJldHVybiBlbnRpdHlGaWx0ZXI7XG4gIH1cbiAgLyoqXG4gICAqIOa4heepuuWQjuS7o+WunuS9k1xuICAgKiBAZGVzY3JpcHRpb24gcGFyZW50SGllcmFyY2h5SW5mb+S4rWxheWVy5Li66KaB5riF56m65ZCO5Luj6IqC54K555qEbGF5ZXLvvIzkvYbph4zpnaLnmoRwYXJlbnRFbGVtZW505LiN5piv54i257qn55qEaWTvvIzogIzmmK/opoHmuIXnqbrlkI7ku6PoioLngrnnmoRpZFxuICAgKi9cbiAgcHVibGljIGNsZWFyRGVzY2VuZGFudEVudGl0aWVzKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nLCBwYXJlbnRIaWVyYXJjaHlJbmZvOiBhbnksIGZyb3plbkN1cnJlbnRSb3c6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xuICAgIC8vIOa4heepuuagueiKgueCuVxuICAgIGlmICghcGFyZW50SGllcmFyY2h5SW5mbykge1xuICAgICAgcmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmNsZWFyKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG5vZGVzID0gdGhpcy5nZXRDaGlsZE5vZGVzKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9rZXksIHBhcmVudEhpZXJhcmNoeUluZm8pO1xuICAgIGlmIChmcm96ZW5DdXJyZW50Um93KSB7XG4gICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24ucmVtb3ZlRW50aXRpZXMoKGVudGl0eTogRW50aXR5KSA9PiB7XG4gICAgICAgIGNvbnN0IGlkID0gZW50aXR5W2VudGl0eS5wcmltYXJ5S2V5XTtcbiAgICAgICAgcmV0dXJuIG5vZGVzLmluY2x1ZGVzKGlkKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24ucmVtb3ZlRGF0YSgoZW50aXR5OiBFbnRpdHkpID0+IHtcbiAgICAgICAgY29uc3QgaWQgPSBlbnRpdHlbZW50aXR5LnByaW1hcnlLZXldO1xuICAgICAgICByZXR1cm4gbm9kZXMuaW5jbHVkZXMoaWQpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluafkOS4quiKgueCueeahOaJgOacieWtkOiKgueCuVxuICAgKiBAcGFyYW0gcmVwb3NpdG9yeSByZXBvc2l0b3J5XG4gICAqIEBwYXJhbSBoaWVyYXJjaHlJbmZva2V5IGhpZXJhcmNoeUluZm9rZXlcbiAgICogQHBhcmFtIHBhcmVudEhpZXJhcmNoeUluZm8gcGFyZW50SGllcmFyY2h5SW5mb1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRDaGlsZE5vZGVzKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nLCBwYXJlbnRIaWVyYXJjaHlJbmZvOiBhbnkpIHtcbiAgICBjb25zdCBmcGFyZW50RWxlbWVudCA9IHBhcmVudEhpZXJhcmNoeUluZm8uaWQ7XG4gICAgY29uc3QgZmxheWVyID0gcGFyZW50SGllcmFyY2h5SW5mby5sYXllcjtcbiAgICBsZXQgbm9kZXMgPSBbXTtcbiAgICByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0QWxsRW50aXRpZXMoKS5mb3JFYWNoKGVudGl0eSA9PiB7XG4gICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gZW50aXR5W2hpZXJhcmNoeUluZm9rZXldO1xuICAgICAgY29uc3QgcGFyZW50RWxlbWVudCA9IGhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudDtcbiAgICAgIGNvbnN0IGxheWVyID0gaGllcmFyY2h5SW5mby5sYXllcjtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGxheWVyID49IChmbGF5ZXIgKyAxKSAmJiBwYXJlbnRFbGVtZW50ID09PSBmcGFyZW50RWxlbWVudDtcbiAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgY29uc3QgaWQgPSBlbnRpdHlbZW50aXR5LnByaW1hcnlLZXldO1xuICAgICAgICBub2Rlcy5wdXNoKGlkKTtcbiAgICAgICAgY29uc3QgY2hpbGRIaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvQnlJZChyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZva2V5LCBpZCk7XG4gICAgICAgIGNvbnN0IGNoaWxkcyA9IHRoaXMuZ2V0Q2hpbGROb2RlcyhyZXBvc2l0b3J5LCBoaWVyYXJjaHlJbmZva2V5LCBjaGlsZEhpZXJhcmNoeUluZm8pO1xuICAgICAgICBpZiAoY2hpbGRzICYmIGNoaWxkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgbm9kZXMgPSBub2Rlcy5jb25jYXQoY2hpbGRzKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBub2RlcztcbiAgfVxuICAvKipcbiAgICog6I635Y+W5a6e5L2T55qE5YiG57qn5L+h5oGvXG4gICAqL1xuICBwdWJsaWMgZ2V0SGllcmFyY2h5SW5mb0J5SWQocmVwb3NpdG9yeTogQmVmUmVwb3NpdG9yeTxFbnRpdHk+LCBoaWVyYXJjaHlJbmZva2V5OiBzdHJpbmcsIGlkOiBzdHJpbmcpOiBhbnkge1xuICAgIGlmICghaWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBlbnRpdHk6IEVudGl0eSA9IHJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKTtcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvRW50aXR5OiBFbnRpdHkgPSBlbnRpdHlbaGllcmFyY2h5SW5mb2tleV07XG4gICAgY29uc3QgcmVzdWx0ID0gaGllcmFyY2h5SW5mb0VudGl0eS50b0pTT04oKTtcbiAgICByZXN1bHRbJ2lkJ10gPSBpZDtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHB1YmxpYyBnZXRIaWVyYXJjaHlJbmZvKGVudGl0eTogRW50aXR5LCBoaWVyYXJjaHlJbmZva2V5OiBzdHJpbmcpOiB7IHBhcmVudEVsZW1lbnQ6IHN0cmluZywgbGF5ZXI6IG51bWJlciwgaXNEZXRhaWw6IGJvb2xlYW4gfSB7XG4gICAgcmV0dXJuIGVudGl0eVtoaWVyYXJjaHlJbmZva2V5XTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5YiG57qn56CB55qE5Y6f5aeL55qE5a2X5q615ZCNXG4gICAqL1xuICBwdWJsaWMgZ2V0T3JpZ2luYWxIaWVyYXJjaHlJbmZvS2V5KHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb2tleTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBjb25zdCBuZ09iamVjdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMocmVwb3NpdG9yeS5lbnRpdHlUeXBlKTtcbiAgICBjb25zdCBoaWVyYXJjaHlJbmZvTmdPYmplY3QgPSBuZ09iamVjdHNbaGllcmFyY2h5SW5mb2tleV07XG4gICAgcmV0dXJuIGhpZXJhcmNoeUluZm9OZ09iamVjdC5vcmlnaW5hbERhdGFGaWVsZCBhcyBzdHJpbmc7XG4gIH1cbiAgcHJpdmF0ZSBnZXRQYWdpbmF0aW9uSW5mbyhyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykge1xuICAgIHJldHVybiByZXNwb25zZUluZm8gJiYgcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZS5wYWdpbmF0aW9uIHx8IG51bGw7XG4gIH1cbiAgcHJpdmF0ZSBmaW5kUGFyZW50KGhpZXJhcmNoeUluZm86IHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhcmVudEVsZW1lbnQ6IHN0cmluZyB9LCBsaXN0OiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGxpc3QuZmluZChpdGVtID0+IHtcbiAgICAgIGNvbnN0IGN1cnJlbnRIaWVyYXJjaHlJbmZvID0gaXRlbVtoaWVyYXJjaHlJbmZvS2V5XSBhcyB7IGlzRGV0YWlsOiBib29sZWFuLCBsYXllcjogbnVtYmVyLCBwYXJlbnRFbGVtZW50OiBzdHJpbmcgfTtcbiAgICAgIHJldHVybiBjdXJyZW50SGllcmFyY2h5SW5mby5sYXllciA9PT0gaGllcmFyY2h5SW5mby5sYXllciAtIDEgJiYgaGllcmFyY2h5SW5mby5wYXJlbnRFbGVtZW50ID09PSBjdXJyZW50SGllcmFyY2h5SW5mby5wYXJlbnRFbGVtZW50O1xuICAgIH0pO1xuICB9XG4gIHByaXZhdGUgZ2V0QWxsUGFyZW50SWRzKGhpZXJhcmNoeUluZm86IHsgaXNEZXRhaWw6IGJvb2xlYW4sIGxheWVyOiBudW1iZXIsIHBhcmVudEVsZW1lbnQ6IHN0cmluZyB9LCBsaXN0OiBhbnlbXSwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4pIHtcbiAgICBsZXQgaXRlbSA9IHRoaXMuZmluZFBhcmVudChoaWVyYXJjaHlJbmZvLCBsaXN0LCBoaWVyYXJjaHlJbmZvS2V5KTtcbiAgICBjb25zdCBpZHMgPSBbXTtcbiAgICB3aGlsZSAoaXRlbSkge1xuICAgICAgaWRzLnB1c2goaXRlbVtyZXBvc2l0b3J5LnByaW1hcnlLZXldKTtcbiAgICAgIGl0ZW0gPSB0aGlzLmZpbmRQYXJlbnQoaXRlbVtoaWVyYXJjaHlJbmZvS2V5XSwgbGlzdCwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgfVxuICAgIHJldHVybiBpZHM7XG4gIH1cbiAgLyoqXG4gICAqIOafpeaJvuiKgueCueS4i+aJgOacieWtkOe6p++8iOesrOS4gOe6p++8iVxuICAgKiBAcGFyYW0gcmVwb3NpdG9yeSByZXBvc2l0b3J5XG4gICAqIEBwYXJhbSBoaWVyYXJjaHlJbmZvS2V5IOWIhue6p+eggeWtl+autVxuICAgKiBAcGFyYW0gaWQgaWRcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcml2YXRlIGdldENoaWxkcmVuKHJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8RW50aXR5PiwgaGllcmFyY2h5SW5mb0tleTogc3RyaW5nLCBpZDogc3RyaW5nKTogRW50aXR5W10ge1xuICAgIGNvbnN0IGhpZXJhcmNoeUluZm8gPSB0aGlzLmdldEhpZXJhcmNoeUluZm9CeUlkKHJlcG9zaXRvcnksIGhpZXJhcmNoeUluZm9LZXksIGlkKTtcbiAgICBpZiAoIWhpZXJhcmNoeUluZm8pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBsYXllciA9IGhpZXJhcmNoeUluZm8ubGF5ZXI7XG4gICAgY29uc3QgcGFyZW50RWxlbWVudCA9IGhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudDtcbiAgICBjb25zdCBlbnRpdGllczogRW50aXR5W10gPSByZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXRpZXMoKGVudGl0eTogRW50aXR5KSA9PiB7XG4gICAgICBjb25zdCBoaWVyYXJjaHlJbmZvID0gdGhpcy5nZXRIaWVyYXJjaHlJbmZvKGVudGl0eSwgaGllcmFyY2h5SW5mb0tleSk7XG4gICAgICBjb25zdCBtYXRjaGVkID0gaGllcmFyY2h5SW5mby5sYXllciA9PT0gbGF5ZXIgKyAxICYmIChoaWVyYXJjaHlJbmZvLnBhcmVudEVsZW1lbnQgPT09IHBhcmVudEVsZW1lbnQgfHwgIXBhcmVudEVsZW1lbnQgJiYgIWhpZXJhcmNoeUluZm8ucGFyZW50RWxlbWVudCk7XG4gICAgICBpZiAobWF0Y2hlZCkge1xuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGVudGl0aWVzO1xuICB9XG59XG5cbmV4cG9ydCB7IFBhcmVudFRyZWVSZXBvc2l0b3J5IH07XG4iXX0=