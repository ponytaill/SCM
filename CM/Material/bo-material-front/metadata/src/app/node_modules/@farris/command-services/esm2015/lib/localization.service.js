import { Inject, Injectable, Injector } from "@angular/core";
import { BigNumber } from 'bignumber.js';
import moment from 'moment';
import { UserSettingsToken } from "@farris/devkit";
export class LocalizationService {
    constructor(injector, userSettings) {
        this.injector = injector;
        this.userSettings = userSettings;
    }
    /**
     * 用户配置格式
     */
    get formats() {
        const { dateFormat = null, timeFormat = null } = this.userSettings || {};
        let dateTimeFormat = null;
        if (dateFormat && timeFormat) {
            dateTimeFormat = `${dateFormat} ${timeFormat}`;
        }
        const date = {
            dateFormat,
            timeFormat,
            dateTimeFormat
        };
        const { negativeSign = null, numberDecimalDigits = null, numberDecimalSeparator = null, numberGroupSeparator = null } = this.numberFormat || {};
        const number = {
            negativeSign,
            numberDecimalDigits,
            numberDecimalSeparator,
            numberGroupSeparator
        };
        return { date, number };
    }
    /**
     * 根据数据类型本地化数据
     * @param value value
     * @param dataType 数据类型
     * @returns string
     */
    localize(value, dataType) {
        if (dataType && value) {
            dataType = dataType.toLowerCase();
            if (dataType === 'date') {
                return this.transformDate(value);
            }
            else if (dataType === 'datetime') {
                return this.transformDateTime(value);
            }
            else if (dataType === 'number') {
                return this.transformNumber(value);
            }
            else {
                return value;
            }
        }
        else {
            return value;
        }
    }
    /**
     * 根据国际化类型获取格式化字符串
     * @param localizationType 国际化类型
     * @returns
     */
    getFormat(localizationType) {
        if (localizationType) {
            localizationType = localizationType.toLowerCase();
        }
        if (localizationType === 'date') {
            return this.formats.date.dateFormat;
        }
        else if (localizationType === 'datetime') {
            return this.formats.date.dateTimeFormat;
        }
        else {
            return '';
        }
    }
    /**
     * 转换日期
     * @param value value
     */
    transformDate(value) {
        let dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        if (!dateFormat || !value) {
            return value;
        }
        const date = moment(value);
        const isValid = date.isValid();
        if (!isValid) {
            return value;
        }
        dateFormat = this.parseDateFormat(dateFormat);
        return date.format(dateFormat);
    }
    /**
     * 转换日期时间
     * @param value value
     * todo: 目前无法定义日期时间格式
     */
    transformDateTime(value) {
        let dateFormat = this.userSettings && this.userSettings.dateFormat || 'YYYY-MM-DD';
        let timeFormat = this.userSettings && this.userSettings.timeFormat || 'HH:mm:ss';
        if (!dateFormat || !timeFormat) {
            return value;
        }
        const dateTime = moment(value);
        const isValid = dateTime.isValid();
        if (!isValid) {
            return value;
        }
        if (dateFormat) {
            dateFormat = this.parseDateFormat(dateFormat);
        }
        if (timeFormat) {
            timeFormat = this.parseTimeFormat(timeFormat);
        }
        const dateTimeFormat = dateFormat + ' ' + timeFormat;
        return dateTime.format(dateTimeFormat);
    }
    /**
     * 转换数字
     * @param value value
     */
    transformNumber(value) {
        if (value === null || value === undefined || value === '') {
            return '';
        }
        const bigNumber = new BigNumber(value);
        // 如果不是数字，不做任何处理
        if (!BigNumber.isBigNumber(bigNumber)) {
            return value;
        }
        const isNegative = bigNumber.isNegative();
        const format = this.buildNumberFormat();
        const { negativeSign = null, numberDecimalDigits = null } = this.numberFormat || {};
        if (isNegative) {
            if (negativeSign !== null) {
                format.prefix = negativeSign;
                return bigNumber.absoluteValue().toFormat(numberDecimalDigits, null, format);
            }
        }
        return bigNumber.toFormat(numberDecimalDigits, null, format);
    }
    /**
     * 转换日期格式规则为moment的format规则
     * @param format format
     */
    parseDateFormat(format) {
        return format.replace(/y/g, 'Y').replace(/d/g, 'D');
    }
    /**
     * 转换时间格式规则为moment的format规则
     * @param format format
     */
    parseTimeFormat(format) {
        return format.replace(/M/g, 'm');
    }
    /**
     * 构造bignumber数字格式化选项
     */
    buildNumberFormat() {
        if (this.numberFormat) {
            const { numberDecimalSeparator = null, numberGroupSeparator = null } = this.numberFormat;
            const format = {
                groupSize: 3,
            };
            if (numberDecimalSeparator !== null) {
                format.decimalSeparator = numberDecimalSeparator;
            }
            if (numberGroupSeparator !== null) {
                format.groupSeparator = numberGroupSeparator;
            }
            return format;
        }
    }
    get numberFormat() {
        return this.userSettings && this.userSettings.numberFormat || null;
    }
}
LocalizationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
LocalizationService.ctorParameters = () => [
    { type: Injector },
    { type: undefined, decorators: [{ type: Inject, args: [UserSettingsToken,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9jYWxpemF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbG9jYWxpemF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDekMsT0FBTyxNQUFNLE1BQU0sUUFBUSxDQUFDO0FBQzVCLE9BQU8sRUFBOEIsaUJBQWlCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUcvRSxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLFlBQW9CLFFBQWtCLEVBQXFDLFlBQTBCO1FBQWpGLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBcUMsaUJBQVksR0FBWixZQUFZLENBQWM7SUFBSSxDQUFDO0lBRTFHOztPQUVHO0lBQ0gsSUFBVyxPQUFPO1FBQ2hCLE1BQU0sRUFBRSxVQUFVLEdBQUcsSUFBSSxFQUFFLFVBQVUsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQztRQUN6RSxJQUFJLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDMUIsSUFBSSxVQUFVLElBQUksVUFBVSxFQUFFO1lBQzVCLGNBQWMsR0FBRyxHQUFHLFVBQVUsSUFBSSxVQUFVLEVBQUUsQ0FBQztTQUNoRDtRQUNELE1BQU0sSUFBSSxHQUFHO1lBQ1gsVUFBVTtZQUNWLFVBQVU7WUFDVixjQUFjO1NBQ2YsQ0FBQztRQUNGLE1BQU0sRUFBRSxZQUFZLEdBQUcsSUFBSSxFQUFFLG1CQUFtQixHQUFHLElBQUksRUFBRSxzQkFBc0IsR0FBRyxJQUFJLEVBQUUsb0JBQW9CLEdBQUcsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDaEosTUFBTSxNQUFNLEdBQUc7WUFDYixZQUFZO1lBQ1osbUJBQW1CO1lBQ25CLHNCQUFzQjtZQUN0QixvQkFBb0I7U0FDckIsQ0FBQztRQUNGLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ksUUFBUSxDQUFDLEtBQVUsRUFBRSxRQUFnQjtRQUMxQyxJQUFJLFFBQVEsSUFBSSxLQUFLLEVBQUU7WUFDckIsUUFBUSxHQUFHLFFBQVEsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNsQyxJQUFJLFFBQVEsS0FBSyxNQUFNLEVBQUU7Z0JBQ3ZCLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNsQztpQkFBTSxJQUFJLFFBQVEsS0FBSyxVQUFVLEVBQUU7Z0JBQ2xDLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3RDO2lCQUFNLElBQUksUUFBUSxLQUFLLFFBQVEsRUFBRTtnQkFDaEMsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3BDO2lCQUFNO2dCQUNMLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7U0FDRjthQUFNO1lBQ0wsT0FBTyxLQUFLLENBQUM7U0FDZDtJQUNILENBQUM7SUFDRDs7OztPQUlHO0lBQ0ksU0FBUyxDQUFDLGdCQUF3QjtRQUN2QyxJQUFJLGdCQUFnQixFQUFFO1lBQ3BCLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ25EO1FBQ0QsSUFBSSxnQkFBZ0IsS0FBSyxNQUFNLEVBQUU7WUFDL0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7U0FDckM7YUFBTSxJQUFJLGdCQUFnQixLQUFLLFVBQVUsRUFBRTtZQUMxQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQztTQUN6QzthQUFNO1lBQ0wsT0FBTyxFQUFFLENBQUM7U0FDWDtJQUNILENBQUM7SUFDRDs7O09BR0c7SUFDSyxhQUFhLENBQUMsS0FBVTtRQUM5QixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxJQUFJLFlBQVksQ0FBQztRQUNuRixJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ3pCLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDM0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQy9CLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssaUJBQWlCLENBQUMsS0FBVTtRQUNsQyxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxJQUFJLFlBQVksQ0FBQztRQUNuRixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxJQUFJLFVBQVUsQ0FBQztRQUNqRixJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsVUFBVSxFQUFFO1lBQzlCLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0IsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ25DLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxVQUFVLEVBQUU7WUFDZCxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUMvQztRQUNELElBQUksVUFBVSxFQUFFO1lBQ2QsVUFBVSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDL0M7UUFDRCxNQUFNLGNBQWMsR0FBRyxVQUFVLEdBQUcsR0FBRyxHQUFHLFVBQVUsQ0FBQztRQUNyRCxPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUNEOzs7T0FHRztJQUNLLGVBQWUsQ0FBQyxLQUFLO1FBQzNCLElBQUksS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssS0FBSyxFQUFFLEVBQUU7WUFDekQsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUNELE1BQU0sU0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZDLGdCQUFnQjtRQUNoQixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUNyQyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsTUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQzFDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1FBQ3hDLE1BQU0sRUFBRSxZQUFZLEdBQUcsSUFBSSxFQUFFLG1CQUFtQixHQUFHLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLElBQUksRUFBRSxDQUFDO1FBQ3BGLElBQUksVUFBVSxFQUFFO1lBQ2QsSUFBSSxZQUFZLEtBQUssSUFBSSxFQUFFO2dCQUN6QixNQUFNLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQztnQkFDN0IsT0FBTyxTQUFTLENBQUMsYUFBYSxFQUFFLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQzthQUM5RTtTQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBQ0Q7OztPQUdHO0lBQ0ssZUFBZSxDQUFDLE1BQWM7UUFDcEMsT0FBTyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFDRDs7O09BR0c7SUFDSyxlQUFlLENBQUMsTUFBYztRQUNwQyxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFDRDs7T0FFRztJQUNLLGlCQUFpQjtRQUN2QixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsTUFBTSxFQUFFLHNCQUFzQixHQUFHLElBQUksRUFBRSxvQkFBb0IsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO1lBQ3pGLE1BQU0sTUFBTSxHQUFRO2dCQUNsQixTQUFTLEVBQUUsQ0FBQzthQUNiLENBQUM7WUFDRixJQUFJLHNCQUFzQixLQUFLLElBQUksRUFBRTtnQkFDbkMsTUFBTSxDQUFDLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDO2FBQ2xEO1lBQ0QsSUFBSSxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7Z0JBQ2pDLE1BQU0sQ0FBQyxjQUFjLEdBQUcsb0JBQW9CLENBQUM7YUFDOUM7WUFDRCxPQUFPLE1BQU0sQ0FBQztTQUNmO0lBQ0gsQ0FBQztJQUNELElBQVksWUFBWTtRQUN0QixPQUFPLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDO0lBQ3JFLENBQUM7OztZQXRLRixVQUFVOzs7O1lBTGtCLFFBQVE7NENBT00sTUFBTSxTQUFDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgQmlnTnVtYmVyIH0gZnJvbSAnYmlnbnVtYmVyLmpzJztcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IE51bWJlckZvcm1hdCwgVXNlclNldHRpbmdzLCBVc2VyU2V0dGluZ3NUb2tlbiB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTG9jYWxpemF0aW9uU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBASW5qZWN0KFVzZXJTZXR0aW5nc1Rva2VuKSBwcml2YXRlIHVzZXJTZXR0aW5nczogVXNlclNldHRpbmdzKSB7IH1cblxuICAvKipcbiAgICog55So5oi36YWN572u5qC85byPXG4gICAqL1xuICBwdWJsaWMgZ2V0IGZvcm1hdHMoKTogeyBkYXRlOiB7IGRhdGVGb3JtYXQ6IHN0cmluZywgdGltZUZvcm1hdDogc3RyaW5nLCBkYXRlVGltZUZvcm1hdDogc3RyaW5nIH0sIG51bWJlcjogeyBuZWdhdGl2ZVNpZ246IHN0cmluZywgbnVtYmVyRGVjaW1hbERpZ2l0czogbnVtYmVyLCBudW1iZXJEZWNpbWFsU2VwYXJhdG9yOiBzdHJpbmcsIG51bWJlckdyb3VwU2VwYXJhdG9yOiBzdHJpbmcgfSwgW3Byb3A6IHN0cmluZ106IGFueSB9IHtcbiAgICBjb25zdCB7IGRhdGVGb3JtYXQgPSBudWxsLCB0aW1lRm9ybWF0ID0gbnVsbCB9ID0gdGhpcy51c2VyU2V0dGluZ3MgfHwge307XG4gICAgbGV0IGRhdGVUaW1lRm9ybWF0ID0gbnVsbDtcbiAgICBpZiAoZGF0ZUZvcm1hdCAmJiB0aW1lRm9ybWF0KSB7XG4gICAgICBkYXRlVGltZUZvcm1hdCA9IGAke2RhdGVGb3JtYXR9ICR7dGltZUZvcm1hdH1gO1xuICAgIH1cbiAgICBjb25zdCBkYXRlID0ge1xuICAgICAgZGF0ZUZvcm1hdCxcbiAgICAgIHRpbWVGb3JtYXQsXG4gICAgICBkYXRlVGltZUZvcm1hdFxuICAgIH07XG4gICAgY29uc3QgeyBuZWdhdGl2ZVNpZ24gPSBudWxsLCBudW1iZXJEZWNpbWFsRGlnaXRzID0gbnVsbCwgbnVtYmVyRGVjaW1hbFNlcGFyYXRvciA9IG51bGwsIG51bWJlckdyb3VwU2VwYXJhdG9yID0gbnVsbCB9ID0gdGhpcy5udW1iZXJGb3JtYXQgfHwge307XG4gICAgY29uc3QgbnVtYmVyID0ge1xuICAgICAgbmVnYXRpdmVTaWduLFxuICAgICAgbnVtYmVyRGVjaW1hbERpZ2l0cyxcbiAgICAgIG51bWJlckRlY2ltYWxTZXBhcmF0b3IsXG4gICAgICBudW1iZXJHcm91cFNlcGFyYXRvclxuICAgIH07XG4gICAgcmV0dXJuIHsgZGF0ZSwgbnVtYmVyIH07XG4gIH1cbiAgLyoqXG4gICAqIOagueaNruaVsOaNruexu+Wei+acrOWcsOWMluaVsOaNrlxuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcbiAgICogQHBhcmFtIGRhdGFUeXBlIOaVsOaNruexu+Wei1xuICAgKiBAcmV0dXJucyBzdHJpbmdcbiAgICovXG4gIHB1YmxpYyBsb2NhbGl6ZSh2YWx1ZTogYW55LCBkYXRhVHlwZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoZGF0YVR5cGUgJiYgdmFsdWUpIHtcbiAgICAgIGRhdGFUeXBlID0gZGF0YVR5cGUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGlmIChkYXRhVHlwZSA9PT0gJ2RhdGUnKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnRyYW5zZm9ybURhdGUodmFsdWUpO1xuICAgICAgfSBlbHNlIGlmIChkYXRhVHlwZSA9PT0gJ2RhdGV0aW1lJykge1xuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm1EYXRlVGltZSh2YWx1ZSk7XG4gICAgICB9IGVsc2UgaWYgKGRhdGFUeXBlID09PSAnbnVtYmVyJykge1xuICAgICAgICByZXR1cm4gdGhpcy50cmFuc2Zvcm1OdW1iZXIodmFsdWUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDmoLnmja7lm73pmYXljJbnsbvlnovojrflj5bmoLzlvI/ljJblrZfnrKbkuLJcbiAgICogQHBhcmFtIGxvY2FsaXphdGlvblR5cGUg5Zu96ZmF5YyW57G75Z6LXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGdldEZvcm1hdChsb2NhbGl6YXRpb25UeXBlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmIChsb2NhbGl6YXRpb25UeXBlKSB7XG4gICAgICBsb2NhbGl6YXRpb25UeXBlID0gbG9jYWxpemF0aW9uVHlwZS50b0xvd2VyQ2FzZSgpO1xuICAgIH1cbiAgICBpZiAobG9jYWxpemF0aW9uVHlwZSA9PT0gJ2RhdGUnKSB7XG4gICAgICByZXR1cm4gdGhpcy5mb3JtYXRzLmRhdGUuZGF0ZUZvcm1hdDtcbiAgICB9IGVsc2UgaWYgKGxvY2FsaXphdGlvblR5cGUgPT09ICdkYXRldGltZScpIHtcbiAgICAgIHJldHVybiB0aGlzLmZvcm1hdHMuZGF0ZS5kYXRlVGltZUZvcm1hdDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6L2s5o2i5pel5pyfXG4gICAqIEBwYXJhbSB2YWx1ZSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSB0cmFuc2Zvcm1EYXRlKHZhbHVlOiBhbnkpIHtcbiAgICBsZXQgZGF0ZUZvcm1hdCA9IHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLmRhdGVGb3JtYXQgfHwgJ1lZWVktTU0tREQnO1xuICAgIGlmICghZGF0ZUZvcm1hdCB8fCAhdmFsdWUpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgY29uc3QgZGF0ZSA9IG1vbWVudCh2YWx1ZSk7XG4gICAgY29uc3QgaXNWYWxpZCA9IGRhdGUuaXNWYWxpZCgpO1xuICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBkYXRlRm9ybWF0ID0gdGhpcy5wYXJzZURhdGVGb3JtYXQoZGF0ZUZvcm1hdCk7XG4gICAgcmV0dXJuIGRhdGUuZm9ybWF0KGRhdGVGb3JtYXQpO1xuICB9XG4gIC8qKlxuICAgKiDovazmjaLml6XmnJ/ml7bpl7RcbiAgICogQHBhcmFtIHZhbHVlIHZhbHVlXG4gICAqIHRvZG86IOebruWJjeaXoOazleWumuS5ieaXpeacn+aXtumXtOagvOW8j1xuICAgKi9cbiAgcHJpdmF0ZSB0cmFuc2Zvcm1EYXRlVGltZSh2YWx1ZTogYW55KSB7XG4gICAgbGV0IGRhdGVGb3JtYXQgPSB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy5kYXRlRm9ybWF0IHx8ICdZWVlZLU1NLUREJztcbiAgICBsZXQgdGltZUZvcm1hdCA9IHRoaXMudXNlclNldHRpbmdzICYmIHRoaXMudXNlclNldHRpbmdzLnRpbWVGb3JtYXQgfHwgJ0hIOm1tOnNzJztcbiAgICBpZiAoIWRhdGVGb3JtYXQgfHwgIXRpbWVGb3JtYXQpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG4gICAgY29uc3QgZGF0ZVRpbWUgPSBtb21lbnQodmFsdWUpO1xuICAgIGNvbnN0IGlzVmFsaWQgPSBkYXRlVGltZS5pc1ZhbGlkKCk7XG4gICAgaWYgKCFpc1ZhbGlkKSB7XG4gICAgICByZXR1cm4gdmFsdWU7XG4gICAgfVxuICAgIGlmIChkYXRlRm9ybWF0KSB7XG4gICAgICBkYXRlRm9ybWF0ID0gdGhpcy5wYXJzZURhdGVGb3JtYXQoZGF0ZUZvcm1hdCk7XG4gICAgfVxuICAgIGlmICh0aW1lRm9ybWF0KSB7XG4gICAgICB0aW1lRm9ybWF0ID0gdGhpcy5wYXJzZVRpbWVGb3JtYXQodGltZUZvcm1hdCk7XG4gICAgfVxuICAgIGNvbnN0IGRhdGVUaW1lRm9ybWF0ID0gZGF0ZUZvcm1hdCArICcgJyArIHRpbWVGb3JtYXQ7XG4gICAgcmV0dXJuIGRhdGVUaW1lLmZvcm1hdChkYXRlVGltZUZvcm1hdCk7XG4gIH1cbiAgLyoqXG4gICAqIOi9rOaNouaVsOWtl1xuICAgKiBAcGFyYW0gdmFsdWUgdmFsdWVcbiAgICovXG4gIHByaXZhdGUgdHJhbnNmb3JtTnVtYmVyKHZhbHVlKTogc3RyaW5nIHtcbiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gJycpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gICAgY29uc3QgYmlnTnVtYmVyID0gbmV3IEJpZ051bWJlcih2YWx1ZSk7XG4gICAgLy8g5aaC5p6c5LiN5piv5pWw5a2X77yM5LiN5YGa5Lu75L2V5aSE55CGXG4gICAgaWYgKCFCaWdOdW1iZXIuaXNCaWdOdW1iZXIoYmlnTnVtYmVyKSkge1xuICAgICAgcmV0dXJuIHZhbHVlO1xuICAgIH1cbiAgICBjb25zdCBpc05lZ2F0aXZlID0gYmlnTnVtYmVyLmlzTmVnYXRpdmUoKTtcbiAgICBjb25zdCBmb3JtYXQgPSB0aGlzLmJ1aWxkTnVtYmVyRm9ybWF0KCk7XG4gICAgY29uc3QgeyBuZWdhdGl2ZVNpZ24gPSBudWxsLCBudW1iZXJEZWNpbWFsRGlnaXRzID0gbnVsbCB9ID0gdGhpcy5udW1iZXJGb3JtYXQgfHwge307XG4gICAgaWYgKGlzTmVnYXRpdmUpIHtcbiAgICAgIGlmIChuZWdhdGl2ZVNpZ24gIT09IG51bGwpIHtcbiAgICAgICAgZm9ybWF0LnByZWZpeCA9IG5lZ2F0aXZlU2lnbjtcbiAgICAgICAgcmV0dXJuIGJpZ051bWJlci5hYnNvbHV0ZVZhbHVlKCkudG9Gb3JtYXQobnVtYmVyRGVjaW1hbERpZ2l0cywgbnVsbCwgZm9ybWF0KTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGJpZ051bWJlci50b0Zvcm1hdChudW1iZXJEZWNpbWFsRGlnaXRzLCBudWxsLCBmb3JtYXQpO1xuICB9XG4gIC8qKlxuICAgKiDovazmjaLml6XmnJ/moLzlvI/op4TliJnkuLptb21lbnTnmoRmb3JtYXTop4TliJlcbiAgICogQHBhcmFtIGZvcm1hdCBmb3JtYXRcbiAgICovXG4gIHByaXZhdGUgcGFyc2VEYXRlRm9ybWF0KGZvcm1hdDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZvcm1hdC5yZXBsYWNlKC95L2csICdZJykucmVwbGFjZSgvZC9nLCAnRCcpO1xuICB9XG4gIC8qKlxuICAgKiDovazmjaLml7bpl7TmoLzlvI/op4TliJnkuLptb21lbnTnmoRmb3JtYXTop4TliJlcbiAgICogQHBhcmFtIGZvcm1hdCBmb3JtYXRcbiAgICovXG4gIHByaXZhdGUgcGFyc2VUaW1lRm9ybWF0KGZvcm1hdDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIGZvcm1hdC5yZXBsYWNlKC9NL2csICdtJyk7XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoGJpZ251bWJlcuaVsOWtl+agvOW8j+WMlumAiemhuVxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZE51bWJlckZvcm1hdCgpIHtcbiAgICBpZiAodGhpcy5udW1iZXJGb3JtYXQpIHtcbiAgICAgIGNvbnN0IHsgbnVtYmVyRGVjaW1hbFNlcGFyYXRvciA9IG51bGwsIG51bWJlckdyb3VwU2VwYXJhdG9yID0gbnVsbCB9ID0gdGhpcy5udW1iZXJGb3JtYXQ7XG4gICAgICBjb25zdCBmb3JtYXQ6IGFueSA9IHtcbiAgICAgICAgZ3JvdXBTaXplOiAzLFxuICAgICAgfTtcbiAgICAgIGlmIChudW1iZXJEZWNpbWFsU2VwYXJhdG9yICE9PSBudWxsKSB7XG4gICAgICAgIGZvcm1hdC5kZWNpbWFsU2VwYXJhdG9yID0gbnVtYmVyRGVjaW1hbFNlcGFyYXRvcjtcbiAgICAgIH1cbiAgICAgIGlmIChudW1iZXJHcm91cFNlcGFyYXRvciAhPT0gbnVsbCkge1xuICAgICAgICBmb3JtYXQuZ3JvdXBTZXBhcmF0b3IgPSBudW1iZXJHcm91cFNlcGFyYXRvcjtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmb3JtYXQ7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgZ2V0IG51bWJlckZvcm1hdCgpOiBOdW1iZXJGb3JtYXQge1xuICAgIHJldHVybiB0aGlzLnVzZXJTZXR0aW5ncyAmJiB0aGlzLnVzZXJTZXR0aW5ncy5udW1iZXJGb3JtYXQgfHwgbnVsbDtcbiAgfVxufSJdfQ==