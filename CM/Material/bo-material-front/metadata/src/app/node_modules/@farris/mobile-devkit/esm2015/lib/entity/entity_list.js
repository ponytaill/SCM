import { Subject } from 'rxjs';
import { ChangeSet } from '../changeset/change_set';
import { ModifyType } from '../changeset/types';
import { Entity } from './entity';
import { EntityFactory } from './entity_creator';
import { PARENT_CLASS, PARENT_PATH } from './types';
/**
 * 实体集合列表
 */
export class EntityList {
    // #endregion
    /**
     * @param data JSON数据集合
     * @param type 集合中的实体类型
     */
    constructor(data, type) {
        /**
         * 已废弃：请勿使用
         */
        this.listChanged = new Subject();
        /**
         * 已废弃：请勿使用
         */
        this.changeSet = new ChangeSet();
        // #endregion
        // #region 公有属性
        /**
         * 集合改变时触发(新增、行记录修改、删除)
         * @event
         */
        this.onListChanged = this.listChanged.asObservable();
        this.clear();
        if (data) {
            // this.loadEntities(data);
            data.forEach(item => {
                this.initEntity(EntityFactory(type, item));
            });
        }
    }
    /**
     * 获取项集合
     */
    get items() {
        return this.rawData;
    }
    /**
     * 列表变更集
     */
    get changes() {
        return this.changeSet.changes;
    }
    /**
     * 迭代器
     */
    *[Symbol.iterator]() {
        yield* this.items;
    }
    // #region 公有方法
    /** 加载实体列表 */
    loadEntities(entities) {
        this.clear();
        entities.forEach(entity => {
            this.initEntity(entity);
        });
        // 发送Load变更
        const changeItem = {
            path: [],
            value: entities,
            preValue: undefined,
            type: ModifyType.Load
        };
        this.setChanges(changeItem);
    }
    /**
     * 清空
     */
    clear() {
        this.rawData = [];
    }
    /**
     * 添加实体对象到集合中，并返回新加的对象
     * @param entity 实体对象
     */
    appendNew(entity) {
        const newEntity = this.initEntity(entity);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
        return newEntity;
    }
    /**
     * 追加实体
     */
    appendEntity(entity) {
        const newEntity = this.initEntity(entity);
        // 新增变更
        const changeItem = {
            path: [],
            value: [newEntity],
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    }
    /**
     * 批量追加实体
     */
    appendEntities(entities) {
        const newEntites = entities.map((entity) => {
            return this.initEntity(entity);
        });
        const changeItem = {
            path: [],
            value: newEntites,
            preValue: undefined,
            type: ModifyType.Add
        };
        this.setChanges(changeItem);
    }
    /**
     * 删除指定主键ID 的实体对象，返回布尔，true 删除成功，false 删除失败
     * @param primaryId 主键ID
     */
    remove(primaryId) {
        const total = this.count();
        const indexToRemove = this.rawData.findIndex((entity) => {
            return entity.primaryValue === primaryId;
        });
        if (indexToRemove === -1) {
            return false;
        }
        const entityToRemove = this.rawData[indexToRemove];
        this.rawData.splice(indexToRemove, 1);
        // 删除变更
        const changeItem = {
            path: [],
            value: { [entityToRemove.primaryProperty.dataField]: primaryId },
            preValue: undefined,
            type: ModifyType.Remove
        };
        this.updateIndex(total);
        this.setChanges(changeItem);
        return true;
    }
    /**
     * 从集合中获取指定ID值的实体对象
     * @param id 主键值
     */
    get(id) {
        return this.items.find(item => {
            return item.primaryValue === id;
        });
    }
    /**
     * 将变更记录添加到集合变更集中
     * @param value 变更记录
     */
    setChanges(modinfo) {
        // 向app层发送的变更
        this.listChanged.next(modinfo);
        // 构造向changeSet中添加的chagne
        const change = Object.assign({}, modinfo);
        if (modinfo.type === ModifyType.Add && modinfo.value[0] instanceof Entity) {
            change.value = [modinfo.value[0].data];
        }
        this.changeSet.append(change);
    }
    /** 集合总记录数 */
    count() {
        return this.items.length;
    }
    /**
     * 获取实体对象的索引值
     */
    indexOf(entity) {
        return this.items.indexOf(entity);
    }
    /**
     * 计算集合中某个属性的总和
     * @param propertyName 属性名称
     */
    sum(propertyName) {
        if (this.count() === 0) {
            return 0;
        }
        return this.items.reduce((val, curr) => {
            return val + curr[propertyName];
        }, 0);
    }
    /**
     * 已废弃：请使用toJSON方法代替
     * @deprecated
     */
    toJson() {
        return this.rawData;
    }
    /**
     * 转换为JSON格式
     */
    toJSON() {
        const result = [];
        this.items.forEach((entity) => {
            result.push(entity.toJSON());
        });
        return result;
    }
    toArray() {
        return this.items;
    }
    // #endregion
    // #region 私有方法
    /**
     * 实体初始化
     * @param entity 实体
     */
    initEntity(entity) {
        entity[PARENT_CLASS] = this;
        entity[PARENT_PATH] = this[PARENT_PATH];
        entity.onValueChanged.subscribe((v) => {
            const path = v.path;
            const value = v.value;
            const preValue = v.preValue;
            const operator = v.type;
            const subChanges = { path, value, preValue, type: operator };
            this.setChanges(subChanges);
        });
        // TODO: 添加数据验证逻辑代码
        const newLength = this.rawData.push(entity);
        this[newLength - 1] = entity;
        return entity;
    }
    /**
     * 更新索引
     * @param total 总记录数
     */
    updateIndex(total) {
        for (let i = 0; i < total; i++) {
            delete this[i];
        }
        this.rawData.forEach((entity, index) => {
            this[index] = entity;
        });
    }
    /**
     * 获取属性名称
     */
    getPropertyName() {
        const path = this[PARENT_PATH];
        if (path && path.length) {
            const name = path[path.length - 1];
            return name;
        }
        return undefined;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X2xpc3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2VudGl0eV9saXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3BELE9BQU8sRUFBZ0IsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDOUQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQWEsTUFBTSxTQUFTLENBQUM7QUFLL0Q7O0dBRUc7QUFDSCxNQUFNLE9BQU8sVUFBVTtJQXVEckIsYUFBYTtJQUdiOzs7T0FHRztJQUNILFlBQVksSUFBWSxFQUFFLElBQWdCO1FBckQxQzs7V0FFRztRQUNLLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQWdCLENBQUM7UUFFbEQ7O1dBRUc7UUFDSyxjQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUNwQyxhQUFhO1FBR2IsZUFBZTtRQUVmOzs7V0FHRztRQUNJLGtCQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQW9DckQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsSUFBSSxJQUFJLEVBQUU7WUFDUiwyQkFBMkI7WUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDbEIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDN0MsQ0FBQyxDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7SUF6Q0Q7O09BRUc7SUFDSCxJQUFXLEtB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QUFHLE1BQU0sQ0FBQztRQUN2QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNLLGVBQWU7UUFDckIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQy9CLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDdkIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDbkMsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7Q0FJRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgQ2hhbmdlU2V0IH0gZnJvbSAnLi4vY2hhbmdlc2V0L2NoYW5nZV9zZXQnO1xyXG5pbXBvcnQgeyBNb2RpZmljYXRpb24sIE1vZGlmeVR5cGUgfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuL2VudGl0eSc7XHJcbmltcG9ydCB7IEVudGl0eUZhY3RvcnkgfSBmcm9tICcuL2VudGl0eV9jcmVhdG9yJztcclxuaW1wb3J0IHsgUEFSRU5UX0NMQVNTLCBQQVJFTlRfUEFUSCwgQ2xhc3NUeXBlIH0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElMaXN0PFQ+IHtcclxuICBbaW5kZXg6IG51bWJlcl06IFQ7XHJcbn1cclxuLyoqXHJcbiAqIOWunuS9k+mbhuWQiOWIl+ihqFxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEVudGl0eUxpc3Q8VCBleHRlbmRzIEVudGl0eT4gaW1wbGVtZW50cyBJTGlzdDxUPiwgSXRlcmFibGU8VD4ge1xyXG5cclxuICAvLyAjcmVnaW9uIOengeacieWxnuaAp1xyXG5cclxuICAvKipcclxuICAgKiDlt7Llup/lvIPvvJror7fli7/kvb/nlKhcclxuICAgKi9cclxuICBwcml2YXRlIHJhd0RhdGE6IFRbXTtcclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBsaXN0Q2hhbmdlZCA9IG5ldyBTdWJqZWN0PE1vZGlmaWNhdGlvbj4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35Yu/5L2/55SoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjaGFuZ2VTZXQgPSBuZXcgQ2hhbmdlU2V0KCk7XHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDlhazmnInlsZ7mgKdcclxuXHJcbiAgLyoqXHJcbiAgICog6ZuG5ZCI5pS55Y+Y5pe26Kem5Y+RKOaWsOWinuOAgeihjOiusOW9leS/ruaUueOAgeWIoOmZpClcclxuICAgKiBAZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgb25MaXN0Q2hhbmdlZCA9IHRoaXMubGlzdENoYW5nZWQuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlumhuembhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgaXRlbXMoKTogVFtdIHtcclxuICAgIHJldHVybiB0aGlzLnJhd0RhdGE7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJfooajlj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IGNoYW5nZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGFuZ2VTZXQuY2hhbmdlcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluaMh+Wumue0ouW8leWkhOeahOWAvFxyXG4gICAqL1xyXG4gIFtpbmRleDogbnVtYmVyXTogVDtcclxuXHJcbiAgLyoqXHJcbiAgICog6L+t5Luj5ZmoXHJcbiAgICovXHJcbiAgKltTeW1ib2wuaXRlcmF0b3JdKCk6IEl0ZXJhdG9yPFQ+IHtcclxuICAgIHlpZWxkKiB0aGlzLml0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogQHBhcmFtIGRhdGEgSlNPTuaVsOaNrumbhuWQiFxyXG4gICAqIEBwYXJhbSB0eXBlIOmbhuWQiOS4reeahOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGRhdGE/OiBhbnlbXSwgdHlwZT86IENsYXNzVHlwZSkge1xyXG4gICAgdGhpcy5jbGVhcigpO1xyXG4gICAgaWYgKGRhdGEpIHtcclxuICAgICAgLy8gdGhpcy5sb2FkRW50aXRpZXMoZGF0YSk7XHJcbiAgICAgIGRhdGEuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICB0aGlzLmluaXRFbnRpdHkoRW50aXR5RmFjdG9yeSh0eXBlLCBpdGVtKSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5YWs5pyJ5pa55rOVXHJcblxyXG4gIC8qKiDliqDovb3lrp7kvZPliJfooaggKi9cclxuICBwdWJsaWMgbG9hZEVudGl0aWVzKGVudGl0aWVzOiBUW10pIHtcclxuICAgIHRoaXMuY2xlYXIoKTtcclxuXHJcbiAgICBlbnRpdGllcy5mb3JFYWNoKGVudGl0eSA9PiB7XHJcbiAgICAgIHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8g5Y+R6YCBTG9hZOWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiBlbnRpdGllcyxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5Mb2FkXHJcbiAgICB9O1xyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDmuIXnqbpcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXIoKSB7XHJcbiAgICB0aGlzLnJhd0RhdGEgPSBbXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWunuS9k+WvueixoeWIsOmbhuWQiOS4re+8jOW5tui/lOWbnuaWsOWKoOeahOWvueixoVxyXG4gICAqIEBwYXJhbSBlbnRpdHkg5a6e5L2T5a+56LGhXHJcbiAgICovXHJcbiAgcHVibGljIGFwcGVuZE5ldyhlbnRpdHk6IFQpOiBUIHtcclxuICAgIGNvbnN0IG5ld0VudGl0eSA9IHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xyXG5cclxuICAgIC8vIOaWsOWinuWPmOabtFxyXG4gICAgY29uc3QgY2hhbmdlSXRlbSA9IHtcclxuICAgICAgcGF0aDogW10sXHJcbiAgICAgIHZhbHVlOiBbbmV3RW50aXR5XSxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5BZGRcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZUl0ZW0pO1xyXG4gICAgcmV0dXJuIG5ld0VudGl0eTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi/veWKoOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmRFbnRpdHkoZW50aXR5OiBUKTogdm9pZCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdHkgPSB0aGlzLmluaXRFbnRpdHkoZW50aXR5KTtcclxuXHJcbiAgICAvLyDmlrDlop7lj5jmm7RcclxuICAgIGNvbnN0IGNoYW5nZUl0ZW0gPSB7XHJcbiAgICAgIHBhdGg6IFtdLFxyXG4gICAgICB2YWx1ZTogW25ld0VudGl0eV0sXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJuemHj+i/veWKoOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBhcHBlbmRFbnRpdGllcyhlbnRpdGllczogVFtdKTogdm9pZCB7XHJcbiAgICBjb25zdCBuZXdFbnRpdGVzID0gZW50aXRpZXMubWFwKChlbnRpdHk6IFQpID0+IHtcclxuICAgICAgcmV0dXJuIHRoaXMuaW5pdEVudGl0eShlbnRpdHkpO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IG5ld0VudGl0ZXMsXHJcbiAgICAgIHByZVZhbHVlOiB1bmRlZmluZWQsXHJcbiAgICAgIHR5cGU6IE1vZGlmeVR5cGUuQWRkXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VJdGVtKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOaMh+WumuS4u+mUrklEIOeahOWunuS9k+Wvueixoe+8jOi/lOWbnuW4g+WwlO+8jHRydWUg5Yig6Zmk5oiQ5Yqf77yMZmFsc2Ug5Yig6Zmk5aSx6LSlXHJcbiAgICogQHBhcmFtIHByaW1hcnlJZCDkuLvplK5JRFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmUocHJpbWFyeUlkOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IHRvdGFsID0gdGhpcy5jb3VudCgpO1xyXG4gICAgY29uc3QgaW5kZXhUb1JlbW92ZSA9IHRoaXMucmF3RGF0YS5maW5kSW5kZXgoKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgIHJldHVybiBlbnRpdHkucHJpbWFyeVZhbHVlID09PSBwcmltYXJ5SWQ7XHJcbiAgICB9KTtcclxuICAgIGlmIChpbmRleFRvUmVtb3ZlID09PSAtMSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgICBjb25zdCBlbnRpdHlUb1JlbW92ZSA9IHRoaXMucmF3RGF0YVtpbmRleFRvUmVtb3ZlXTtcclxuICAgIHRoaXMucmF3RGF0YS5zcGxpY2UoaW5kZXhUb1JlbW92ZSwgMSk7XHJcblxyXG4gICAgLy8g5Yig6Zmk5Y+Y5pu0XHJcbiAgICBjb25zdCBjaGFuZ2VJdGVtID0ge1xyXG4gICAgICBwYXRoOiBbXSxcclxuICAgICAgdmFsdWU6IHsgW2VudGl0eVRvUmVtb3ZlLnByaW1hcnlQcm9wZXJ0eS5kYXRhRmllbGRdOiBwcmltYXJ5SWQgfSxcclxuICAgICAgcHJlVmFsdWU6IHVuZGVmaW5lZCxcclxuICAgICAgdHlwZTogTW9kaWZ5VHlwZS5SZW1vdmVcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy51cGRhdGVJbmRleCh0b3RhbCk7XHJcbiAgICB0aGlzLnNldENoYW5nZXMoY2hhbmdlSXRlbSk7XHJcblxyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku47pm4blkIjkuK3ojrflj5bmjIflrppJROWAvOeahOWunuS9k+WvueixoVxyXG4gICAqIEBwYXJhbSBpZCDkuLvplK7lgLxcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0KGlkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zLmZpbmQoaXRlbSA9PiB7XHJcbiAgICAgIHJldHVybiBpdGVtLnByaW1hcnlWYWx1ZSA9PT0gaWQ7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWwhuWPmOabtOiusOW9lea3u+WKoOWIsOmbhuWQiOWPmOabtOmbhuS4rVxyXG4gICAqIEBwYXJhbSB2YWx1ZSDlj5jmm7TorrDlvZVcclxuICAgKi9cclxuICBwdWJsaWMgc2V0Q2hhbmdlcyhtb2RpbmZvOiBNb2RpZmljYXRpb24pIHtcclxuICAgIC8vIOWQkWFwcOWxguWPkemAgeeahOWPmOabtFxyXG4gICAgdGhpcy5saXN0Q2hhbmdlZC5uZXh0KG1vZGluZm8pO1xyXG5cclxuICAgIC8vIOaehOmAoOWQkWNoYW5nZVNldOS4rea3u+WKoOeahGNoYWduZVxyXG4gICAgY29uc3QgY2hhbmdlID0gT2JqZWN0LmFzc2lnbih7fSwgbW9kaW5mbyk7XHJcbiAgICBpZiAobW9kaW5mby50eXBlID09PSBNb2RpZnlUeXBlLkFkZCAmJiBtb2RpbmZvLnZhbHVlWzBdIGluc3RhbmNlb2YgRW50aXR5KSB7XHJcbiAgICAgIGNoYW5nZS52YWx1ZSA9IFttb2RpbmZvLnZhbHVlWzBdLmRhdGFdO1xyXG4gICAgfVxyXG4gICAgdGhpcy5jaGFuZ2VTZXQuYXBwZW5kKGNoYW5nZSk7XHJcbiAgfVxyXG5cclxuICAvKiog6ZuG5ZCI5oC76K6w5b2V5pWwICovXHJcbiAgcHVibGljIGNvdW50KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuaXRlbXMubGVuZ3RoO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5a6e5L2T5a+56LGh55qE57Si5byV5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGluZGV4T2YoZW50aXR5OiBUKTogbnVtYmVyIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zLmluZGV4T2YoZW50aXR5KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiuoeeul+mbhuWQiOS4reafkOS4quWxnuaAp+eahOaAu+WSjFxyXG4gICAqIEBwYXJhbSBwcm9wZXJ0eU5hbWUg5bGe5oCn5ZCN56ewXHJcbiAgICovXHJcbiAgcHVibGljIHN1bShwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IG51bWJlciB7XHJcbiAgICBpZiAodGhpcy5jb3VudCgpID09PSAwKSB7XHJcbiAgICAgIHJldHVybiAwO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuaXRlbXMucmVkdWNlKCh2YWwsIGN1cnI6IFQpID0+IHtcclxuICAgICAgcmV0dXJuIHZhbCArIGN1cnJbcHJvcGVydHlOYW1lXTtcclxuICAgIH0sIDApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bey5bqf5byD77ya6K+35L2/55SodG9KU09O5pa55rOV5Luj5pu/XHJcbiAgICogQGRlcHJlY2F0ZWRcclxuICAgKi9cclxuICBwdWJsaWMgdG9Kc29uKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmF3RGF0YTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOi9rOaNouS4ukpTT07moLzlvI9cclxuICAgKi9cclxuICBwdWJsaWMgdG9KU09OKCk6IGFueVtdIHtcclxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xyXG4gICAgdGhpcy5pdGVtcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICByZXN1bHQucHVzaChlbnRpdHkudG9KU09OKCkpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHRvQXJyYXkoKTogVFtdIHtcclxuICAgIHJldHVybiB0aGlzLml0ZW1zO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDnp4HmnInmlrnms5VcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5Yid5aeL5YyWXHJcbiAgICogQHBhcmFtIGVudGl0eSDlrp7kvZNcclxuICAgKi9cclxuICBwcml2YXRlIGluaXRFbnRpdHkoZW50aXR5OiBUKTogVCB7XHJcbiAgICBlbnRpdHlbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XHJcbiAgICBlbnRpdHlbUEFSRU5UX1BBVEhdID0gdGhpc1tQQVJFTlRfUEFUSF07XHJcbiAgICBlbnRpdHkub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKCh2OiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgY29uc3QgcGF0aCA9IHYucGF0aDtcclxuICAgICAgY29uc3QgdmFsdWUgPSB2LnZhbHVlO1xyXG4gICAgICBjb25zdCBwcmVWYWx1ZSA9IHYucHJlVmFsdWU7XHJcbiAgICAgIGNvbnN0IG9wZXJhdG9yID0gdi50eXBlO1xyXG4gICAgICBjb25zdCBzdWJDaGFuZ2VzID0geyBwYXRoLCB2YWx1ZSwgcHJlVmFsdWUsIHR5cGU6IG9wZXJhdG9yIH07XHJcbiAgICAgIHRoaXMuc2V0Q2hhbmdlcyhzdWJDaGFuZ2VzKTtcclxuICAgIH0pO1xyXG4gICAgLy8gVE9ETzog5re75Yqg5pWw5o2u6aqM6K+B6YC76L6R5Luj56CBXHJcbiAgICBjb25zdCBuZXdMZW5ndGggPSB0aGlzLnJhd0RhdGEucHVzaChlbnRpdHkpO1xyXG4gICAgdGhpc1tuZXdMZW5ndGggLSAxXSA9IGVudGl0eTtcclxuXHJcbiAgICByZXR1cm4gZW50aXR5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pu05paw57Si5byVXHJcbiAgICogQHBhcmFtIHRvdGFsIOaAu+iusOW9leaVsFxyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlSW5kZXgodG90YWw6IG51bWJlcikge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKSB7XHJcbiAgICAgIGRlbGV0ZSB0aGlzW2ldO1xyXG4gICAgfVxyXG4gICAgdGhpcy5yYXdEYXRhLmZvckVhY2goKGVudGl0eSwgaW5kZXgpID0+IHtcclxuICAgICAgdGhpc1tpbmRleF0gPSBlbnRpdHk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWxnuaAp+WQjeensFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0UHJvcGVydHlOYW1lKCkge1xyXG4gICAgY29uc3QgcGF0aCA9IHRoaXNbUEFSRU5UX1BBVEhdO1xyXG4gICAgaWYgKHBhdGggJiYgcGF0aC5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgbmFtZSA9IHBhdGhbcGF0aC5sZW5ndGggLSAxXTtcclxuICAgICAgcmV0dXJuIG5hbWU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxufVxyXG4iXX0=