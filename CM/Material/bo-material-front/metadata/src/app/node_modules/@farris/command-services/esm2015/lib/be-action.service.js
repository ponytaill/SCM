import { Injectable, Optional } from '@angular/core';
import { HttpHeaders } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { Repository } from '@farris/devkit';
import { FormLoadingService } from './form-loading/form-loading.service';
import { FormMessageService } from './form-message.service';
import { FormNotifyService } from './form-notify.service';
import { FormErrorService } from './error/form-error.service';
import { LanguageService } from './languag.service';
// tslint:disable: no-string-literal
/**
 * 列表仓库服务
 * @scope FrameComponent
 */
class BeActionService {
    /**
     * 构造函数
     */
    constructor(repository, loadingService, msgService, notifyService, formErrorService, languageService) {
        this.repository = repository;
        this.loadingService = loadingService;
        this.msgService = msgService;
        this.notifyService = notifyService;
        this.formErrorService = formErrorService;
        this.languageService = languageService;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
    }
    /**
     * 执行自定义动作
     */
    invokeAction(actionUri, httpMethod, httpHeaders, queryParams, body) {
        return this.innerInvokeAction(actionUri, httpMethod, httpHeaders, queryParams, body, true);
    }
    /**
     * 已弃用：请使用invokeAction代替
     * @deprecated
     * @summary
     * 迁移时请注意：invokeAction中body请传递满足BodyWithRequestInfo接口的格式，形如：
     * { requestInfo: reqeustInfoInstance, key1: value1, key2: value2 }
     */
    executeAction(actionUri, httpMethod, httpHeaders, queryParams, body) {
        // 1、不确定body中是否有RequestInfo对象
        // 2、restService的reqeust会根据body中是否有key为ReqeustInfo（大写开头）的参数来确定；
        // 3、如果body中没有key为ReqeustInfo的参数，不直接返回ResponseInfo，而是进一步解析，返回其中的returnValue。
        return this.innerInvokeAction(actionUri, httpMethod, httpHeaders, queryParams, body, false);
    }
    /**
     * 构造查询字符串
     */
    buildQueryParams(queryParams) {
        if (typeof queryParams === 'string') {
            queryParams = JSON.parse(queryParams);
        }
        let queryParamsString = '';
        Object.keys(queryParams).forEach((key) => {
            queryParamsString += `${key}=${queryParams[key]}`;
        });
        return queryParamsString;
    }
    /**
     * 获取Rest服务
     */
    getRestService() {
        const befRepository = this.repository;
        return befRepository.restService;
    }
    /**
     * 调用自定义动作
     */
    innerInvokeAction(actionUri, httpMethod, httpHeaders, queryParams, body, hasRequestInfo) {
        const options = {};
        const restService = this.getRestService();
        const baseUri = restService.baseUri;
        // 构造url
        let fullActionUri = `${baseUri}/service/${actionUri}`;
        if (queryParams && queryParams !== '') {
            const queryParamsString = this.buildQueryParams(queryParams);
            fullActionUri += queryParamsString;
        }
        // body构造
        if (body && body !== '') {
            if (typeof body === 'string' && body.startsWith('{') && body.endsWith('}')) {
                body = JSON.parse(body);
            }
            options['body'] = body;
        }
        // http头构造
        if (httpHeaders && httpHeaders !== '') {
            httpHeaders = JSON.parse(httpHeaders);
            // 如果没有设置Content-Type，默认用json格式
            if (!httpHeaders['Content-Type']) {
                httpHeaders['Content-Type'] = 'application/json';
            }
            options['headers'] = new HttpHeaders(httpHeaders);
        }
        else {
            options['headers'] = new HttpHeaders({ 'Content-Type': 'application/json' });
        }
        // 执行服务器端请求
        this.loadingService.show();
        // invoke方法
        // 1、RequestInfo=>报错
        // 2、requestInfo=>ResponseInfo
        // request方法
        // 1、RequestInfo=>ResponseInfo
        // 2、requestInfo=>returnValue
        const methodName = hasRequestInfo ? 'invoke' : 'request';
        const result$ = restService[methodName](fullActionUri, httpMethod, null, options);
        return result$.pipe(tap(() => {
            this.loadingService.hide();
        }, (error) => {
            this.loadingService.hide();
            const errorMsg = fullActionUri + this.languageService['operationFailed'];
            this.formErrorService.exception(errorMsg, error);
        }));
    }
}
BeActionService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BeActionService.ctorParameters = () => [
    { type: Repository },
    { type: FormLoadingService },
    { type: FormMessageService },
    { type: FormNotifyService },
    { type: FormErrorService },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
export { BeActionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmUtYWN0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYmUtYWN0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFdBQVcsRUFBcUIsTUFBTSxzQkFBc0IsQ0FBQztBQUV0RSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzVDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzlELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxvQ0FBb0M7QUFFcEM7OztHQUdHO0FBQ0gsTUFDTSxlQUFlO0lBRW5COztPQUVHO0lBQ0gsWUFDVSxVQUEyQixFQUMzQixjQUFrQyxFQUNsQyxVQUE4QixFQUM5QixhQUFnQyxFQUNoQyxnQkFBa0MsRUFDdEIsZUFBZ0M7UUFMNUMsZUFBVSxHQUFWLFVBQVUsQ0FBaUI7UUFDM0IsbUJBQWMsR0FBZCxjQUFjLENBQW9CO1FBQ2xDLGVBQVUsR0FBVixVQUFVLENBQW9CO1FBQzlCLGtCQUFhLEdBQWIsYUFBYSxDQUFtQjtRQUNoQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ3RCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUVwRCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtZQUN6QixJQUFJ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QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwSGVhZGVycywgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSwgQmVmUmVzdFNlcnZpY2UsIFJlcXVlc3RJbmZvLCBSZXNwb25zZUluZm8gfSBmcm9tICdAZmFycmlzL2JlZic7XG5pbXBvcnQgeyBCb2R5V2l0aFJlcXVlc3RJbmZvIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBGb3JtTG9hZGluZ1NlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLW5vdGlmeS5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1FcnJvclNlcnZpY2UgfSBmcm9tICcuL2Vycm9yL2Zvcm0tZXJyb3Iuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWcuc2VydmljZSc7XG4vLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWxcblxuLyoqXG4gKiDliJfooajku5PlupPmnI3liqFcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxuICovXG5ASW5qZWN0YWJsZSgpXG5jbGFzcyBCZUFjdGlvblNlcnZpY2Uge1xuXG4gIC8qKlxuICAgKiDmnoTpgKDlh73mlbBcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxuICAgIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IEZvcm1Mb2FkaW5nU2VydmljZSxcbiAgICBwcml2YXRlIG1zZ1NlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZSxcbiAgICBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgZm9ybUVycm9yU2VydmljZTogRm9ybUVycm9yU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICApIHtcbiAgICBpZiAoIXRoaXMubGFuZ3VhZ2VTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmxhbmd1YWdlU2VydmljZSA9IExhbmd1YWdlU2VydmljZS5nZXRJbnN0YW5jZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmiafooYzoh6rlrprkuYnliqjkvZxcbiAgICovXG4gIHB1YmxpYyBpbnZva2VBY3Rpb24oXG4gICAgYWN0aW9uVXJpOiBzdHJpbmcsIGh0dHBNZXRob2Q6IHN0cmluZywgaHR0cEhlYWRlcnM/OiBhbnksIHF1ZXJ5UGFyYW1zPzogYW55LCBib2R5PzogQm9keVdpdGhSZXF1ZXN0SW5mb1xuICApOiBPYnNlcnZhYmxlPFJlc3BvbnNlSW5mbz4ge1xuICAgIHJldHVybiB0aGlzLmlubmVySW52b2tlQWN0aW9uKGFjdGlvblVyaSwgaHR0cE1ldGhvZCwgaHR0cEhlYWRlcnMsIHF1ZXJ5UGFyYW1zLCBib2R5LCB0cnVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlt7LlvIPnlKjvvJror7fkvb/nlKhpbnZva2VBY3Rpb27ku6Pmm79cbiAgICogQGRlcHJlY2F0ZWRcbiAgICogQHN1bW1hcnlcbiAgICog6L+B56e75pe26K+35rOo5oSP77yaaW52b2tlQWN0aW9u5LitYm9keeivt+S8oOmAkua7oei2s0JvZHlXaXRoUmVxdWVzdEluZm/mjqXlj6PnmoTmoLzlvI/vvIzlvaLlpoLvvJpcbiAgICogeyByZXF1ZXN0SW5mbzogcmVxZXVzdEluZm9JbnN0YW5jZSwga2V5MTogdmFsdWUxLCBrZXkyOiB2YWx1ZTIgfVxuICAgKi9cbiAgcHVibGljIGV4ZWN1dGVBY3Rpb24oXG4gICAgYWN0aW9uVXJpOiBzdHJpbmcsIGh0dHBNZXRob2Q6IHN0cmluZywgaHR0cEhlYWRlcnM/OiBhbnksIHF1ZXJ5UGFyYW1zPzogYW55LCBib2R5PzogYW55XG4gICk6IE9ic2VydmFibGU8YW55PiB7XG5cbiAgICAvLyAx44CB5LiN56Gu5a6aYm9keeS4reaYr+WQpuaciVJlcXVlc3RJbmZv5a+56LGhXG4gICAgLy8gMuOAgXJlc3RTZXJ2aWNl55qEcmVxZXVzdOS8muagueaNrmJvZHnkuK3mmK/lkKbmnIlrZXnkuLpSZXFldXN0SW5mb++8iOWkp+WGmeW8gOWktO+8ieeahOWPguaVsOadpeehruWumu+8m1xuICAgIC8vIDPjgIHlpoLmnpxib2R55Lit5rKh5pyJa2V55Li6UmVxZXVzdEluZm/nmoTlj4LmlbDvvIzkuI3nm7TmjqXov5Tlm55SZXNwb25zZUluZm/vvIzogIzmmK/ov5vkuIDmraXop6PmnpDvvIzov5Tlm57lhbbkuK3nmoRyZXR1cm5WYWx1ZeOAglxuICAgIHJldHVybiB0aGlzLmlubmVySW52b2tlQWN0aW9uKGFjdGlvblVyaSwgaHR0cE1ldGhvZCwgaHR0cEhlYWRlcnMsIHF1ZXJ5UGFyYW1zLCBib2R5LCBmYWxzZSk7XG4gIH1cblxuICAvKipcbiAgICog5p6E6YCg5p+l6K+i5a2X56ym5LiyXG4gICAqL1xuICBwdWJsaWMgYnVpbGRRdWVyeVBhcmFtcyhxdWVyeVBhcmFtczogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAodHlwZW9mIHF1ZXJ5UGFyYW1zID09PSAnc3RyaW5nJykge1xuICAgICAgcXVlcnlQYXJhbXMgPSBKU09OLnBhcnNlKHF1ZXJ5UGFyYW1zKTtcbiAgICB9XG5cbiAgICBsZXQgcXVlcnlQYXJhbXNTdHJpbmcgPSAnJztcbiAgICBPYmplY3Qua2V5cyhxdWVyeVBhcmFtcykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIHF1ZXJ5UGFyYW1zU3RyaW5nICs9IGAke2tleX09JHtxdWVyeVBhcmFtc1trZXldfWA7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gcXVlcnlQYXJhbXNTdHJpbmc7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+WUmVzdOacjeWKoVxuICAgKi9cbiAgcHVibGljIGdldFJlc3RTZXJ2aWNlKCk6IEJlZlJlc3RTZXJ2aWNlIHtcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICByZXR1cm4gYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIOiwg+eUqOiHquWumuS5ieWKqOS9nFxuICAgKi9cbiAgcHJpdmF0ZSBpbm5lckludm9rZUFjdGlvbihcbiAgICBhY3Rpb25Vcmk6IHN0cmluZywgaHR0cE1ldGhvZDogc3RyaW5nLCBodHRwSGVhZGVycz86IGFueSwgcXVlcnlQYXJhbXM/OiBhbnksIGJvZHk/OiBhbnksIGhhc1JlcXVlc3RJbmZvPzogYm9vbGVhblxuICApOiBPYnNlcnZhYmxlPGFueT4gIHtcbiAgICBjb25zdCBvcHRpb25zID0ge307XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLmdldFJlc3RTZXJ2aWNlKCk7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG5cbiAgICAvLyDmnoTpgKB1cmxcbiAgICBsZXQgZnVsbEFjdGlvblVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvJHthY3Rpb25Vcml9YDtcbiAgICBpZiAocXVlcnlQYXJhbXMgJiYgcXVlcnlQYXJhbXMgIT09ICcnKSB7XG4gICAgICBjb25zdCBxdWVyeVBhcmFtc1N0cmluZyA9IHRoaXMuYnVpbGRRdWVyeVBhcmFtcyhxdWVyeVBhcmFtcyk7XG4gICAgICBmdWxsQWN0aW9uVXJpICs9IHF1ZXJ5UGFyYW1zU3RyaW5nO1xuICAgIH1cblxuXG4gICAgLy8gYm9keeaehOmAoFxuICAgIGlmIChib2R5ICYmIGJvZHkgIT09ICcnKSB7XG4gICAgICBpZiAodHlwZW9mIGJvZHkgPT09ICdzdHJpbmcnICYmIGJvZHkuc3RhcnRzV2l0aCgneycpICYmIGJvZHkuZW5kc1dpdGgoJ30nKSkge1xuICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgIH1cbiAgICAgIG9wdGlvbnNbJ2JvZHknXSA9IGJvZHk7XG4gICAgfVxuXG4gICAgLy8gaHR0cOWktOaehOmAoFxuICAgIGlmIChodHRwSGVhZGVycyAmJiBodHRwSGVhZGVycyAhPT0gJycpIHtcbiAgICAgIGh0dHBIZWFkZXJzID0gSlNPTi5wYXJzZShodHRwSGVhZGVycyk7XG5cbiAgICAgIC8vIOWmguaenOayoeacieiuvue9rkNvbnRlbnQtVHlwZe+8jOm7mOiupOeUqGpzb27moLzlvI9cbiAgICAgIGlmICghaHR0cEhlYWRlcnNbJ0NvbnRlbnQtVHlwZSddKSB7XG4gICAgICAgIGh0dHBIZWFkZXJzWydDb250ZW50LVR5cGUnXSA9ICdhcHBsaWNhdGlvbi9qc29uJztcbiAgICAgIH1cbiAgICAgIG9wdGlvbnNbJ2hlYWRlcnMnXSA9IG5ldyBIdHRwSGVhZGVycyhodHRwSGVhZGVycyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdGlvbnNbJ2hlYWRlcnMnXSA9IG5ldyBIdHRwSGVhZGVycyh7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSk7XG4gICAgfVxuXG4gICAgLy8g5omn6KGM5pyN5Yqh5Zmo56uv6K+35rGCXG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XG5cbiAgICAvLyBpbnZva2Xmlrnms5VcbiAgICAvLyAx44CBUmVxdWVzdEluZm89PuaKpemUmVxuICAgIC8vIDLjgIFyZXF1ZXN0SW5mbz0+UmVzcG9uc2VJbmZvXG4gICAgLy8gcmVxdWVzdOaWueazlVxuICAgIC8vIDHjgIFSZXF1ZXN0SW5mbz0+UmVzcG9uc2VJbmZvXG4gICAgLy8gMuOAgXJlcXVlc3RJbmZvPT5yZXR1cm5WYWx1ZVxuICAgIGNvbnN0IG1ldGhvZE5hbWUgPSBoYXNSZXF1ZXN0SW5mbyA/ICdpbnZva2UnIDogJ3JlcXVlc3QnO1xuICAgIGNvbnN0IHJlc3VsdCQgPSByZXN0U2VydmljZVttZXRob2ROYW1lXShmdWxsQWN0aW9uVXJpLCBodHRwTWV0aG9kLCBudWxsLCBvcHRpb25zKTtcbiAgICByZXR1cm4gcmVzdWx0JC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XG4gICAgICAgIH0sXG4gICAgICAgIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XG4gICAgICAgICAgY29uc3QgZXJyb3JNc2cgPSBmdWxsQWN0aW9uVXJpICsgdGhpcy5sYW5ndWFnZVNlcnZpY2VbJ29wZXJhdGlvbkZhaWxlZCddO1xuICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24oZXJyb3JNc2csIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cblxuXG5leHBvcnQgeyBCZUFjdGlvblNlcnZpY2UgfTtcblxuXG4iXX0=