/**
 * @fileoverview added by tsickle
 * Generated from: lib/bef_lookup.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { switchMap, map, catchError } from 'rxjs/operators';
import { Repository, FrameContext } from '@farris/devkit';
/**
 * 帮助Rest取数服务
 */
export class BefLookupRestService {
    /**
     * 构造函数
     * @param {?} repository
     * @param {?} frameContext
     */
    constructor(repository, frameContext) {
        this.frameContext = frameContext;
        this.befRepository = (/** @type {?} */ (repository));
        this.registerDestroyEvent();
    }
    /**
     * @private
     * @return {?}
     */
    registerDestroyEvent() {
        if (this.frameContext && this.frameContext.destorySignal) {
            this.frameContext.destorySignal.subscribe((/**
             * @return {?}
             */
            () => {
                this.frameContext = null;
                this.befRepository = null;
            }));
        }
    }
    /**
     * @param {?} helpMetadataId
     * @param {?=} data
     * @return {?}
     */
    getData(helpMetadataId, data) {
        /** @type {?} */
        const tableName = helpMetadataId.split('.')[0];
        /** @type {?} */
        const labelId = helpMetadataId.split('.')[1];
        data = data || {};
        if (this.frameContext) {
            /** @type {?} */
            const primaryValue = this.frameContext.bindingData.list.currentId;
            data['currentForm'] = {
                id: primaryValue
            };
        }
        /** @type {?} */
        const enableExtendLoadMethod = this.ifEnableExtendLoadMethod(helpMetadataId);
        if (enableExtendLoadMethod === true) {
            return this.extendGetHelpData(labelId, tableName, data);
        }
        return this.getHelpData(labelId, tableName, data);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    saveUserSettings(data) {
        /** @type {?} */
        const url = '/api/runtime/bcc/v1.0/datagrid/settings';
        return this.befRepository.restService.invoke(url, 'POST', null, { body: data }, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * @param {?} key
     * @return {?}
     */
    getUserSettings(key) {
        /** @type {?} */
        const url = '/api/runtime/bcc/v1.0/datagrid/settings/' + key;
        return this.befRepository.restService.invoke(url, 'GET', null, null, false).pipe(catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * 是否启用扩展取数方法
     * @private
     * @param {?} helpMetadataId
     * @return {?}
     */
    ifEnableExtendLoadMethod(helpMetadataId) {
        // 优先使用context里的设置
        if (this.context && this.context.hasOwnProperty('enableExtendLoadMethod')) {
            return this.context.enableExtendLoadMethod;
        }
        // context没有设置时，继续使用通过指令设置的开关
        /** @type {?} */
        let enableExtendLoadMethod = false;
        if (this.frameContext) {
            /** @type {?} */
            const befApiUrl = this.frameContext.repository.apiUri;
            /** @type {?} */
            const enableKey = `${helpMetadataId}@${befApiUrl}`;
            enableExtendLoadMethod = this.frameContext.getParam(enableKey);
        }
        return enableExtendLoadMethod;
    }
    /**
     * 老的帮助取树
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    getHelpData(labelId, tableName, data) {
        /** @type {?} */
        const url = `${this.befRepository.restService.baseUri}/elementhelps/${labelId}`;
        /** @type {?} */
        const update$ = this.befRepository.updateDataAndVariableChanges();
        /** @type {?} */
        const result$ = update$.pipe(switchMap((/**
         * @return {?}
         */
        () => {
            // tslint:disable-next-line: max-line-length
            return this.befRepository.restService.invoke(url, 'GET', { nodeCode: tableName, queryParam: JSON.stringify(data) }, null, false).pipe(catchError((/**
             * @param {?} error
             * @return {?}
             */
            error => {
                /** @type {?} */
                const formAppContext = this.befRepository.appContext.getFormAppContext();
                this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
                return EMPTY;
            })));
        })));
        return result$;
    }
    /**
     * 扩展的帮助取数
     * @private
     * @param {?} labelId
     * @param {?} tableName
     * @param {?} data
     * @return {?}
     */
    extendGetHelpData(labelId, tableName, data) {
        /** @type {?} */
        const url = `${this.befRepository.restService.baseUri}/extension/elementhelps`;
        /** @type {?} */
        const body = {
            labelId: labelId,
            nodeCode: tableName,
            queryParam: data,
            requestInfo: this.befRepository.restService.buildRequestInfo()
        };
        /** @type {?} */
        const options = {
            body: body
        };
        /** @type {?} */
        const result$ = this.befRepository.restService.invoke(url, 'PUT', null, options, false, true, true);
        return result$.pipe(map((/**
         * @param {?} responseInfo
         * @return {?}
         */
        (responseInfo) => {
            return responseInfo && responseInfo.returnValue || null;
        })), catchError((/**
         * @param {?} error
         * @return {?}
         */
        error => {
            /** @type {?} */
            const formAppContext = this.befRepository.appContext.getFormAppContext();
            this.befRepository.restService.eventBus.post('Exception', '', 'onException', error, formAppContext);
            return EMPTY;
        })));
    }
    /**
     * @private
     * @param {?} data
     * @param {?=} layer
     * @param {?=} parentPathCode
     * @return {?}
     */
    convert2TreeDataWithPathCode(data, layer = 1, parentPathCode = '01') {
        /** @type {?} */
        let nodes = data.filter((/**
         * @param {?} d
         * @return {?}
         */
        d => d.layer === layer && d.pathcode === parentPathCode));
        if (layer > 1) {
            nodes = data.filter((/**
             * @param {?} d
             * @return {?}
             */
            d => d.layer === layer && d.pathcode.substr(0, (layer - 1) * 2) === parentPathCode));
        }
        if (nodes.length) {
            /** @type {?} */
            const treeNodes = nodes.map((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                return {
                    data: n,
                    children: []
                };
            }));
            treeNodes.forEach((/**
             * @param {?} tn
             * @return {?}
             */
            tn => {
                /** @type {?} */
                const _tns = this.convert2TreeDataWithPathCode(data, tn.data.layer + 1, tn.data.pathcode);
                tn.children.push(..._tns);
            }));
            return treeNodes;
        }
    }
}
BefLookupRestService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BefLookupRestService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.befRepository;
    /**
     * 帮助取数上下文
     * @type {?}
     */
    BefLookupRestService.prototype.context;
    /**
     * @type {?}
     * @private
     */
    BefLookupRestService.prototype.frameContext;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVmX2xvb2t1cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9iZWYvIiwic291cmNlcyI6WyJsaWIvYmVmX2xvb2t1cC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBTyxVQUFVLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBUTFELE1BQU0sT0FBTyxvQkFBb0I7Ozs7OztJQVkvQixZQUNFLFVBQTJCLEVBQ1AsWUFBMEI7UUFBMUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFFOUMsSUFBSSxDQUFDLGFBQWEsR0FBRyxtQkFBb0IsVUFBVSxFQUFBLENBQUM7UUFDcEQsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7SUFDOUIsQ0FBQzs7Ozs7SUFDTyxvQkFBb0I7UUFDMUIsSUFBSSxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxFQUFFO1lBQ3hELElBQUksQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLFNBQVM7OztZQUFDLEdBQUcsRUFBRTtnQkFDN0MsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Z0JBQ3pCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO1lBQzVCLENBQUMsRUFBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDOzs7Ozs7SUFFTSxPQUFPLENBQUMsY0FBc0IsRUFBRSxJQUFtQjs7Y0FDbEQsU0FBUyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDOztjQUN4QyxPQUFPLEdBQUcsY0FBYyxDQUFD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LElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLGNBQWMsRUFBQyxDQUFDO1NBQ3pHO1FBQ0QsSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFOztrQkFDVixTQUFTLEdBQUcsS0FBSyxDQUFDLEdBQUc7Ozs7WUFBQyxDQUFDLENBQUMsRUFBRTtnQkFDOUIsT0FBTztvQkFDTCxJQUFJLEVBQUUsQ0FBQztvQkFDUCxRQUFRLEVBQUUsRUFBRTtpQkFDYixDQUFDO1lBQ0osQ0FBQyxFQUFDO1lBRUYsU0FBUyxDQUFDLE9BQU87Ozs7WUFBQyxFQUFFLENBQUMsRUFBRTs7c0JBQ2YsSUFBSSxHQUFHLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDO2dCQUN6RixFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDO1lBQzVCLENBQUMsRUFBQyxDQUFDO1lBRUgsT0FBTyxTQUFTLENBQUM7U0FDbEI7SUFDSCxDQUFDOzs7WUE5SkYsVUFBVTs7OztZQVBGLFVBQVU7WUFBRSxZQUFZLHVCQXNCNUIsUUFBUTs7Ozs7OztJQVpYLDZDQUEwQzs7Ozs7SUFLMUMsdUNBQW9COzs7OztJQU9sQiw0Q0FBOEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFTVBUWSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAsIG1hcCwgdGFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBJTG9va3VwSHR0cFNlcnZpY2UsIFJlbW90ZVBhcmFtcywgTG9va3VwR3JpZFJlc3VsdCB9IGZyb20gJ0BmYXJyaXMvdWktbG9va3VwJztcclxuaW1wb3J0IHsgUmVwb3NpdG9yeSwgRnJhbWVDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xyXG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnLi9iZWZfcmVwb3NpdG9yeSc7XHJcbmltcG9ydCB7IFJlc3BvbnNlSW5mbyB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuLyoqXHJcbiAqIOW4ruWKqVJlc3Tlj5bmlbDmnI3liqFcclxuICovXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJlZkxvb2t1cFJlc3RTZXJ2aWNlIGltcGxlbWVudHMgSUxvb2t1cEh0dHBTZXJ2aWNlIHtcclxuXHJcbiAgcHJpdmF0ZSBiZWZSZXBvc2l0b3J5OiBCZWZSZXBvc2l0b3J5PGFueT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOW4ruWKqeWPluaVsOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb250ZXh0OiBhbnk7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxyXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dFxyXG4gICkge1xyXG4gICAgdGhpcy5iZWZSZXBvc2l0b3J5ID0gPEJlZlJlcG9zaXRvcnk8YW55Pj5yZXBvc2l0b3J5O1xyXG4gICAgdGhpcy5yZWdpc3RlckRlc3Ryb3lFdmVudCgpO1xyXG4gIH1cclxuICBwcml2YXRlIHJlZ2lzdGVyRGVzdHJveUV2ZW50KCkge1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmRlc3RvcnlTaWduYWwpIHtcclxuICAgICAgdGhpcy5mcmFtZUNvbnRleHQuZGVzdG9yeVNpZ25hbC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZnJhbWVDb250ZXh0ID0gbnVsbDtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkgPSBudWxsO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXREYXRhKGhlbHBNZXRhZGF0YUlkOiBzdHJpbmcsIGRhdGE/OiBSZW1vdGVQYXJhbXMpOiBPYnNlcnZhYmxlPExvb2t1cEdyaWRSZXN1bHQ+IHtcclxuICAgIGNvbnN0IHRhYmxlTmFtZSA9IGhlbHBNZXRhZGF0YUlkLnNwbGl0KCcuJylbMF07XHJcbiAgICBjb25zdCBsYWJlbElkID0gaGVscE1ldGFkYXRhSWQuc3BsaXQoJy4nKVsxXTtcclxuICAgIGRhdGEgPSBkYXRhIHx8IHt9O1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xyXG4gICAgICBkYXRhWydjdXJyZW50Rm9ybSddID0ge1xyXG4gICAgICAgIGlkOiBwcmltYXJ5VmFsdWVcclxuICAgICAgfTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVuYWJsZUV4dGVuZExvYWRNZXRob2QgPSB0aGlzLmlmRW5hYmxlRXh0ZW5kTG9hZE1ldGhvZChoZWxwTWV0YWRhdGFJZCk7XHJcbiAgICBpZiAoZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9PT0gdHJ1ZSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5leHRlbmRHZXRIZWxwRGF0YShsYWJlbElkLCB0YWJsZU5hbWUsIGRhdGEpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRoaXMuZ2V0SGVscERhdGEobGFiZWxJZCwgdGFibGVOYW1lLCBkYXRhKTtcclxuICB9XHJcbiAgcHVibGljIHNhdmVVc2VyU2V0dGluZ3MoZGF0YSkge1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9kYXRhZ3JpZC9zZXR0aW5ncyc7XHJcbiAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdQT1NUJywgbnVsbCwgeyBib2R5OiBkYXRhIH0sIGZhbHNlKS5waXBlKFxyXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcclxuICAgICAgICBjb25zdCBmb3JtQXBwQ29udGV4dCA9IHRoaXMuYmVmUmVwb3NpdG9yeS5hcHBDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCk7XHJcbiAgICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmV2ZW50QnVzLnBvc3QoJ0V4Y2VwdGlvbicsICcnLCAnb25FeGNlcHRpb24nLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xyXG4gICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0VXNlclNldHRpbmdzKGtleSkge1xyXG4gICAgY29uc3QgdXJsID0gJy9hcGkvcnVudGltZS9iY2MvdjEuMC9kYXRhZ3JpZC9zZXR0aW5ncy8nICsga2V5O1xyXG4gICAgcmV0dXJuIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5pbnZva2UodXJsLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpLnBpcGUoXHJcbiAgICAgIGNhdGNoRXJyb3IoZXJyb3IgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwcENvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgICAgICB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuZXZlbnRCdXMucG9zdCgnRXhjZXB0aW9uJywgJycsICdvbkV4Y2VwdGlvbicsIGVycm9yLCBmb3JtQXBwQ29udGV4dCk7XHJcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuWQr+eUqOaJqeWxleWPluaVsOaWueazlVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaWZFbmFibGVFeHRlbmRMb2FkTWV0aG9kKGhlbHBNZXRhZGF0YUlkOiBzdHJpbmcpIHtcclxuXHJcbiAgICAvLyDkvJjlhYjkvb/nlKhjb250ZXh06YeM55qE6K6+572uXHJcbiAgICBpZiAodGhpcy5jb250ZXh0ICYmIHRoaXMuY29udGV4dC5oYXNPd25Qcm9wZXJ0eSgnZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCcpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmNvbnRleHQuZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBjb250ZXh05rKh5pyJ6K6+572u5pe277yM57un57ut5L2/55So6YCa6L+H5oyH5Luk6K6+572u55qE5byA5YWzXHJcbiAgICBsZXQgZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9IGZhbHNlO1xyXG4gICAgaWYgKHRoaXMuZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIGNvbnN0IGJlZkFwaVVybCA9IHRoaXMuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuYXBpVXJpO1xyXG4gICAgICBjb25zdCBlbmFibGVLZXkgPSBgJHtoZWxwTWV0YWRhdGFJZH1AJHtiZWZBcGlVcmx9YDtcclxuICAgICAgZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZCA9IHRoaXMuZnJhbWVDb250ZXh0LmdldFBhcmFtKGVuYWJsZUtleSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZW5hYmxlRXh0ZW5kTG9hZE1ldGhvZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiAgeeahOW4ruWKqeWPluagkVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0SGVscERhdGEobGFiZWxJZDogc3RyaW5nLCB0YWJsZU5hbWU6IHN0cmluZywgZGF0YTogYW55KTogT2JzZXJ2YWJsZTxMb29rdXBHcmlkUmVzdWx0PiB7XHJcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuYmFzZVVyaX0vZWxlbWVudGhlbHBzLyR7bGFiZWxJZH1gO1xyXG4gICAgY29uc3QgdXBkYXRlJCA9IHRoaXMuYmVmUmVwb3NpdG9yeS51cGRhdGVEYXRhQW5kVmFyaWFibGVDaGFuZ2VzKCk7XHJcbiAgICBcclxuICAgIGNvbnN0IHJlc3VsdCQgPSB1cGRhdGUkLnBpcGUoXHJcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcclxuICAgICAgICByZXR1cm4gdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmludm9rZSh1cmwsICdHRVQnLCB7IG5vZGVDb2RlOiB0YWJsZU5hbWUsIHF1ZXJ5UGFyYW06IEpTT04uc3RyaW5naWZ5KGRhdGEpIH0sIG51bGwsIGZhbHNlKS5waXBlKFxyXG4gICAgICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gdGhpcy5iZWZSZXBvc2l0b3J5LmFwcENvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKTtcclxuICAgICAgICAgICAgdGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmV2ZW50QnVzLnBvc3QoJ0V4Y2VwdGlvbicsICcnLCAnb25FeGNlcHRpb24nLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xyXG4gICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gICAgcmV0dXJuIHJlc3VsdCQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmianlsZXnmoTluK7liqnlj5bmlbBcclxuICAgKi9cclxuICBwcml2YXRlIGV4dGVuZEdldEhlbHBEYXRhKGxhYmVsSWQ6IHN0cmluZywgdGFibGVOYW1lOiBzdHJpbmcsIGRhdGE6IGFueSk6IE9ic2VydmFibGU8TG9va3VwR3JpZFJlc3VsdD4ge1xyXG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy5iZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmJhc2VVcml9L2V4dGVuc2lvbi9lbGVtZW50aGVscHNgO1xyXG4gICAgY29uc3QgYm9keSA9IHtcclxuICAgICAgbGFiZWxJZDogbGFiZWxJZCxcclxuICAgICAgbm9kZUNvZGU6IHRhYmxlTmFtZSxcclxuICAgICAgcXVlcnlQYXJhbTogZGF0YSxcclxuICAgICAgcmVxdWVzdEluZm86IHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcclxuICAgIH07XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICBib2R5OiBib2R5XHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IHJlc3VsdCQgPSB0aGlzLmJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuaW52b2tlKHVybCwgJ1BVVCcsIG51bGwsIG9wdGlvbnMsIGZhbHNlLCB0cnVlLCB0cnVlKTtcclxuICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgIG1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcclxuICAgICAgICByZXR1cm4gcmVzcG9uc2VJbmZvICYmIHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSB8fCBudWxsO1xyXG4gICAgICB9KSxcclxuICAgICAgY2F0Y2hFcnJvcihlcnJvciA9PiB7XHJcbiAgICAgICAgY29uc3QgZm9ybUFwcENvbnRleHQgPSB0aGlzLmJlZlJlcG9zaXRvcnkuYXBwQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xyXG4gICAgICAgIHRoaXMuYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5ldmVudEJ1cy5wb3N0KCdFeGNlcHRpb24nLCAnJywgJ29uRXhjZXB0aW9uJywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcclxuICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgIH1cclxuICAgICAgKSxcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNvbnZlcnQyVHJlZURhdGFXaXRoUGF0aENvZGUoZGF0YTogYW55W10sIGxheWVyID0gMSwgcGFyZW50UGF0aENvZGUgPSAnMDEnKSB7XHJcbiAgICBsZXQgbm9kZXMgPSBkYXRhLmZpbHRlcihkID0+IGQubGF5ZXIgPT09IGxheWVyICYmIGQucGF0aGNvZGUgPT09IHBhcmVudFBhdGhDb2RlKTtcclxuICAgIGlmIChsYXllciA+IDEpIHtcclxuICAgICAgbm9kZXMgPSBkYXRhLmZpbHRlcihkID0+IGQubGF5ZXIgPT09IGxheWVyICYmIGQucGF0aGNvZGUuc3Vic3RyKDAsIChsYXllciAtIDEpICogMikgPT09IHBhcmVudFBhdGhDb2RlKTtcclxuICAgIH1cclxuICAgIGlmIChub2Rlcy5sZW5ndGgpIHtcclxuICAgICAgY29uc3QgdHJlZU5vZGVzID0gbm9kZXMubWFwKG4gPT4ge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICBkYXRhOiBuLFxyXG4gICAgICAgICAgY2hpbGRyZW46IFtdXHJcbiAgICAgICAgfTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0cmVlTm9kZXMuZm9yRWFjaCh0biA9PiB7XHJcbiAgICAgICAgY29uc3QgX3RucyA9IHRoaXMuY29udmVydDJUcmVlRGF0YVdpdGhQYXRoQ29kZShkYXRhLCB0bi5kYXRhLmxheWVyICsgMSwgdG4uZGF0YS5wYXRoY29kZSk7XHJcbiAgICAgICAgdG4uY2hpbGRyZW4ucHVzaCguLi5fdG5zKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICByZXR1cm4gdHJlZU5vZGVzO1xyXG4gICAgfVxyXG4gIH1cclxufSJdfQ==