import * as tslib_1 from "tslib";
import { Injectable, Optional } from '@angular/core';
import { of, empty, EMPTY } from 'rxjs';
import { tap, switchMap, concatMap } from 'rxjs/operators';
import { Repository, BindingData, ViewModel, EntityPathConverter } from '@farris/devkit';
import { BefRepositoryUtil } from '@farris/bef';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { FormNotifyService } from '../form-notify.service';
import { LanguageService } from '../languag.service';
import { FormMessageService } from '../form-message.service';
import { FormErrorService } from '../error/form-error.service';
import { CommandService } from '../command-service';
import { FilterConditionService } from '../filter-condition.service';
// tslint:disable: no-string-literal max-line-length
/**
 * 列表仓库服务
 */
var ListDataService = /** @class */ (function () {
    /**
     * 构造
     * @param msgService msgService
     * @param repository repository
     * @param bindingData bindingData
     * @param loadingService loadingService
     * @param languageService languageService
     * @param formNotifyService formNotifyService
     * @param formErrorService formErrorService
     * ! @param viewModel viewModel,vm是后期注入的，老表单获取不到，一定要做非空判断
     * @param filterConditionService filterConditionService
     */
    function ListDataService(msgService, repository, bindingData, loadingService, languageService, formNotifyService, formErrorService, viewModel, filterConditionService) {
        this.msgService = msgService;
        this.repository = repository;
        this.bindingData = bindingData;
        this.loadingService = loadingService;
        this.languageService = languageService;
        this.formNotifyService = formNotifyService;
        this.formErrorService = formErrorService;
        this.viewModel = viewModel;
        this.filterConditionService = filterConditionService;
        if (!languageService) {
            this.languageService = LanguageService.getInstance();
        }
        // if (!filterConditionService) {
        //   this.filterConditionService = new FilterConditionService();
        // }
    }
    /**
     * 加载
     */
    ListDataService.prototype.load = function (filter, sort) {
        var _this = this;
        // 参数处理
        filter = !filter ? '[]' : filter;
        sort = !sort ? '[]' : sort;
        // 合并过滤条件
        filter = this.mergeFilterConditions(filter);
        // 合并排序条件
        sort = this.mergeSortConditions(sort);
        var loadingTimerId = this.loadingService.showLoadingWithDelay(200);
        var query$ = this.repository.getEntities(JSON.parse(filter), JSON.parse(sort), null, null);
        return query$.pipe(tap(function () {
            // 触发远端合计事件
            _this.fireQueryEvent(filter);
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.formErrorService.exception(_this.languageService.loadFailed, error);
        }));
    };
    /**
     * 过滤数据
     * @param filter 过滤条件
     * @param sort 排序条件
     */
    ListDataService.prototype.filter = function (filter, sort) {
        var _this = this;
        // 参数处理
        filter = !filter ? '[]' : filter;
        sort = !sort ? '[]' : sort;
        // 合并过滤条件
        filter = this.mergeFilterConditions(filter);
        // 合并排序条件
        sort = this.mergeSortConditions(sort);
        var loadingTimerId = this.loadingService.showLoadingWithDelay(200);
        var query$ = this.repository.filter(JSON.parse(filter), JSON.parse(sort));
        return query$.pipe(tap(function () {
            // 触发远端合计事件
            _this.fireQueryEvent(filter);
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.formErrorService.exception(_this.languageService.loadFailed, error);
        }));
    };
    /**
     * 查询
     */
    ListDataService.prototype.query = function (filter, sort, pageSize, pageIndex) {
        var _this = this;
        // 参数处理
        filter = (filter === '') ? '[]' : filter;
        sort = (sort === '') ? '[]' : sort;
        // 合并过滤条件
        filter = this.mergeFilterConditions(filter);
        // 合并排序条件
        sort = this.mergeSortConditions(sort);
        // 执行取数
        var loadingTimerId = this.loadingService.showLoadingWithDelay(5);
        var query$ = this.repository.getEntities(JSON.parse(filter), JSON.parse(sort), pageSize, pageIndex);
        return query$.pipe(tap(function () {
            // 触发远端合计事件
            _this.fireQueryEvent(filter);
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.formErrorService.exception(_this.languageService.queryFailed, error);
        }));
    };
    ListDataService.prototype.queryChild = function (filter, sort) {
        var _this = this;
        // const isUpdateWithPaging = this.viewModel.frameContext.root.params.get('updateWithPaging') || false;
        // if (isUpdateWithPaging) {
        //   return of(null);
        // }
        // tslint:disable-next-line: max-line-length
        var fullPaths = EntityPathConverter.toEntityPathArray(this.viewModel.bindingPath, this.bindingData);
        var paths = fullPaths.slice(0, fullPaths.length - 1);
        // debug
        // tslint:disable-next-line: max-line-length
        var bindingPaths = this.viewModel.bindingPath.split('/').filter(function (item) { return item; });
        var bindingData = this.viewModel.bindingData;
        var nodeCode = bindingPaths[bindingPaths.length - 1];
        nodeCode = nodeCode.substr(0, nodeCode.length - 1);
        // 获取上级实体
        var parentPaths = bindingPaths.slice(0, bindingPaths.length - 1);
        var BindingList = bindingData.getValue(parentPaths);
        if (!BindingList) {
            return;
        }
        this.viewModel.frameContext.appContext.params.delete("retrieveing");
        var configPath = "/" + nodeCode;
        var config = this.repository.entityCollection.getPaginationConfigByPath(configPath);
        if (config) {
            var _a = config.pageIndex, pageIndex = _a === void 0 ? 1 : _a, _b = config.pageSize, pageSize = _b === void 0 ? 0 : _b;
            // pageSize = 0表示未分页
            if (pageSize !== 0) {
                this.viewModel.frameContext.appContext.params.set('queryChild', true);
                var request$ = this.repository.queryChild(paths, pageIndex, pageSize);
                return request$.pipe(tap(function () { }, function (error) {
                    _this.formErrorService.exception(_this.languageService.queryFailed, error);
                }));
            }
        }
    };
    /**
     * 获取分页信息
     * @param nodeCode nodeCode
     * @returns 分页信息，包括：分页大小、当前页码
     * @description 基本分页信息在分页信息中存储时key为nodeCode
     */
    /*private getPagingInfo(nodeCode: string) {
      const result: { pageIndex?: number, pageSize?: number } = {};
      const nodeCodePath = `/${nodeCode}`;
      const defaultPagingInfo = this.repository.entityCollection.getPaginationConfigByPath(nodeCodePath);
      const pageSize = defaultPagingInfo && defaultPagingInfo.pageSize || 0;
      const pageIndex = defaultPagingInfo && defaultPagingInfo.pageIndex || 1;
      result.pageIndex = pageIndex;
      result.pageSize = pageSize;
      return result;
    }*/
    /**
     * 追加一条新数据
     */
    ListDataService.prototype.append = function () {
        var _this = this;
        var loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'append' });
        }
        var append$ = this.repository.append();
        return append$.pipe(tap(function () {
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.formErrorService.exception(_this.languageService.appendFailed, error);
        }));
    };
    /**
     * 当前行前或后插入数据
     * @param position 1 | -1
     */
    ListDataService.prototype.insert = function (position) {
        var _this = this;
        if (position === void 0) { position = -1; }
        var loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'insert' });
        }
        var append$ = this.repository.insert(position);
        return append$.pipe(tap(function () {
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.formErrorService.exception(_this.languageService.appendFailed, error);
        }));
    };
    /**
     * 提交变更（批量编辑页面，行切换时提交增量）
     */
    ListDataService.prototype.updateChanges = function () {
        var update$ = this.repository.updateAllChanges();
        return update$;
    };
    /**
     * 批量保存
     * @param successMsg 自定义提示信息
     */
    ListDataService.prototype.save = function (successMsg) {
        var _this = this;
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'save' });
        }
        var loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        var save$ = this.repository.applyChanges();
        var result$ = save$.pipe(tap(function () {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            if (successMsg && successMsg.trim()) {
                _this.formNotifyService.success(successMsg, { hideTitle: true });
            }
            else {
                _this.formNotifyService.success(_this.languageService.saveSuccess, { hideTitle: true });
            }
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.formErrorService.exception(_this.languageService.multiSaveFailed, error);
        }));
        return result$;
    };
    /**
     * 删除
     * @param id 要删除的数据的id
     * @param ifSave 是否保存
     * @param successMsg 自定义提示信息
     * @param confirm 是否需要确认
     * @param breakable 是否可中断，ifSave为false时流会中断
     */
    ListDataService.prototype.remove = function (id, ifSave, successMsg, confirm, breakable) {
        var _this = this;
        if (confirm === void 0) { confirm = true; }
        if (breakable === void 0) { breakable = true; }
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'delete' });
        }
        if (!id) {
            this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
            return empty();
        }
        confirm = (confirm === false || confirm === 'false') ? false : true;
        breakable = (breakable === false || breakable === 'false') ? false : true;
        var action$ = confirm ? this.msgService.question(this.languageService.confirmDeletion) : of(true);
        return action$.pipe(concatMap(function (result) {
            if (!result) {
                return empty();
            }
            ifSave = (ifSave === false || ifSave === 'false') ? false : true;
            var loadingTimerId = _this.loadingService.showLoadingWithDelay(500);
            var remove$ = _this.repository.removeById(id, ifSave);
            if (!remove$) {
                return empty();
            }
            return remove$.pipe(tap(function () {
                _this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    _this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    _this.formNotifyService.success(_this.languageService.deleteSuccess, { hideTitle: true });
                }
            }, function (error) {
                _this.loadingService.hideDelayLoading(loadingTimerId);
                _this.formErrorService.exception(_this.languageService.deleteFailed, error);
            }), switchMap(function () {
                if (ifSave === true || !breakable) {
                    // return this.load();
                    return of([]);
                }
                else {
                    return empty();
                }
            }));
        }));
    };
    /**
     * 批量删除
     * @param ids ids
     * @param ifSave 是否保存
     * @param successMsg 自定义提示信息
     * @param deleteCurrentRowIfNoChecks 没有勾选时删除当前行
     */
    ListDataService.prototype.removeRows = function (ids, ifSave, successMsg, deleteCurrentRowIfNoChecks) {
        var _this = this;
        if (deleteCurrentRowIfNoChecks === void 0) { deleteCurrentRowIfNoChecks = false; }
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'removeRows' });
        }
        deleteCurrentRowIfNoChecks = (deleteCurrentRowIfNoChecks === 'true' || deleteCurrentRowIfNoChecks === true) ? true : false;
        if (!ids || ids.length === 0) {
            var currentId = this.bindingData.list.currentId;
            if (deleteCurrentRowIfNoChecks === true && currentId) {
                ids = [this.bindingData.list.currentId];
            }
            else {
                this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
                return empty();
            }
        }
        var action$ = this.msgService.confirm(this.languageService.confirmDeletion);
        return action$.pipe(concatMap(function (result) {
            if (!result) {
                return empty();
            }
            if (typeof ifSave === 'undefined') {
                ifSave = true;
            }
            if (typeof ifSave === 'string') {
                ifSave = ifSave.toLowerCase() === 'false' ? false : true;
            }
            ifSave = (ifSave === false) ? false : true;
            var loadingTimerId = _this.loadingService.showLoadingWithDelay(500);
            var remove$ = _this.repository.removeByIds(ids, ifSave);
            if (!remove$) {
                return empty();
            }
            return remove$.pipe(tap(function () {
                _this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    _this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    _this.formNotifyService.success(_this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, function (error) {
                _this.loadingService.hideDelayLoading(loadingTimerId);
                _this.formErrorService.exception(_this.languageService.deleteFailed, error);
            }), switchMap(function () {
                return of([]);
            }));
        }));
    };
    /**
     * 删除后的刷新
     */
    ListDataService.prototype.refreshAfterRemoving = function (loadCmdName, loadCmdFrameId) {
        if (this.viewModel && loadCmdName && loadCmdFrameId) {
            var commandService = this.viewModel.frameContext.injector.get(CommandService, null);
            return commandService.execute(loadCmdName, loadCmdFrameId);
        }
        return this.load();
    };
    /**
     * 刷新
     * @param loadCmdName 刷新命令
     * @param loadCmdFrameId 刷新命令所在的frameId
     */
    ListDataService.prototype.refresh = function (loadCmdName, loadCmdFrameId) {
        if (this.viewModel && loadCmdName && loadCmdFrameId) {
            var commandService = this.viewModel.frameContext.injector.get(CommandService, null);
            return commandService.execute(loadCmdName, loadCmdFrameId);
        }
        return this.load();
    };
    /**
     * 取消时检测未保存记录
     */
    ListDataService.prototype.cancel = function () {
        var _this = this;
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'cancel' });
        }
        // 没有变更时直接取消
        var befRepository = this.repository;
        var hasUnsavedData = BefRepositoryUtil.isExistUnsaveData(befRepository);
        if (hasUnsavedData === false) {
            return this._cancel();
        }
        var confirmResult$ = this.msgService.question(this.languageService['cancelWithoutSave']).pipe(switchMap(function (ifCancel) {
            if (ifCancel === false) {
                return EMPTY;
            }
            return _this._cancel();
        }));
        return confirmResult$;
    };
    /**
     * 还原变更集
     * @description 不带变更检测提示
     */
    ListDataService.prototype.revert = function () {
        return this._cancel();
    };
    /**
     * 取消（内部取消）
     */
    ListDataService.prototype._cancel = function () {
        var _this = this;
        var loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        var cancel$ = this.repository.cancelChanges();
        return cancel$.pipe(tap(function () {
            _this.loadingService.hideDelayLoading(loadingTimerId);
        }, function (error) {
            _this.loadingService.hideDelayLoading(loadingTimerId);
            _this.formErrorService.exception(_this.languageService.cancelFailed, error);
        }));
    };
    Object.defineProperty(ListDataService.prototype, "messagePipe", {
        /**
         * 获取根组件appContext
         */
        get: function () {
            if (this.viewModel && this.viewModel.frameContext) {
                var appContext = this.viewModel.frameContext.getFormAppContext() || null;
                if (appContext) {
                    return appContext.messagePipe || null;
                }
            }
            return null;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 触发查询事件
     * @param filters 过滤条件
     */
    ListDataService.prototype.fireQueryEvent = function (filters) {
        var messagePipe = this.messagePipe;
        // const frameId = this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.frameId || null;
        if (messagePipe) {
            messagePipe.next({ type: 'query' });
        }
    };
    /**
     * 合并过滤条件
     * @param filter 表单过滤条件
     */
    ListDataService.prototype.mergeFilterConditions = function (filter) {
        if (typeof filter === 'string') {
            filter = JSON.parse(filter) || [];
        }
        var filters = filter;
        var bindingPath = this.viewModel && this.viewModel.bindingPath || null;
        if (bindingPath) {
            var originalConditions = this.viewModel && this.viewModel.frameContext.repository.filterConditionManager.getFilters(bindingPath) || [];
            // this.filterConditionService.getFilters(bindingPath) || [];
            var conditions = Array.from(originalConditions);
            if (conditions && conditions.length > 0) {
                /*filters.forEach((item: any, index: number) => {
                  const field = item.FilterField || null;
                  if (field) {
                    const duplicateIndex = conditions.findIndex(condition => condition.FilterField === field);
                    if (duplicateIndex !== -1) {
                      filters[index] = conditions[duplicateIndex];
                      conditions.splice(duplicateIndex, 1);
                    }
                  }
                });*/
                // 修改命令上过滤条件的最后一个查询关系为and
                if (filters.length > 0) {
                    // 最后一个过滤条件
                    var lastFilter = filters[filters.length - 1];
                    if (lastFilter) {
                        if (lastFilter.hasOwnProperty('Relation')) {
                            delete lastFilter.Relation;
                        }
                        lastFilter.relation = 1;
                    }
                }
                // 合并新的过滤条件和原来命令上的过滤条件
                filters.push.apply(filters, tslib_1.__spread(conditions));
            }
        }
        return JSON.stringify(filters);
    };
    /**
     * 合并排序条件
     * @param sort 排序条件
     */
    ListDataService.prototype.mergeSortConditions = function (sort) {
        if (typeof sort === 'string') {
            sort = JSON.parse(sort) || [];
        }
        var sorts = sort;
        var bindingPath = this.viewModel && this.viewModel.bindingPath || null;
        if (bindingPath) {
            // 获取当前绑定路径的所有排序条件
            var originalConditions = this.viewModel && this.viewModel.frameContext.repository.sortConditionManager.getConditionsByBindingPath(bindingPath, function (direction) {
                if (direction === 'asc') {
                    return 0;
                }
                else {
                    return 1;
                }
            }) || [];
            var conditions = Array.from(originalConditions);
            // 如果当前绑定路径有排序条件，则忽略命令上预制的排序条件
            if (conditions && conditions.length > 0) {
                // 遍历已有的过滤条件，如果有重复的field，用后者的覆盖已有的
                /*sorts.forEach((item: any, index: number) => {
                  const field = item.SortField || null;
                  if (field) {
                    const duplicateIndex = conditions.findIndex(condition => condition.SortField === field);
                    if (duplicateIndex !== -1) {
                      sorts[index] = conditions[duplicateIndex];
                      conditions.splice(duplicateIndex, 1);
                    }
                  }
                });*/
                return JSON.stringify(conditions);
                // 将其余排序条件添加到排序数组
                // sorts.push(...conditions);
            }
        }
        return JSON.stringify(sorts);
    };
    ListDataService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ListDataService.ctorParameters = function () { return [
        { type: FormMessageService },
        { type: Repository },
        { type: BindingData },
        { type: FormLoadingService },
        { type: LanguageService, decorators: [{ type: Optional }] },
        { type: FormNotifyService },
        { type: FormErrorService },
        { type: ViewModel },
        { type: FilterConditionService }
    ]; };
    return ListDataService;
}());
export { ListDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy9saXN0LWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFjLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3BELE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBYyxNQUFNLGdCQUFnQixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFVLFNBQVMsRUFBZSxtQkFBbUIsRUFBaUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3SCxPQUFPLEVBQWlCLGlCQUFpQixFQUFtQixNQUFNLGFBQWEsQ0FBQztBQUNoRixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUMxRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMzRCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDckQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDN0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3JFLG9EQUFvRDtBQUVwRDs7R0FFRztBQUNIO0lBR0U7Ozs7Ozs7Ozs7O09BV0c7SUFDSCx5QkFDVSxVQUE4QixFQUM5QixVQUEyQixFQUMzQixXQUF3QixFQUN4QixjQUFrQyxFQUN0QixlQUFnQyxFQUM1QyxpQkFBb0Ms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QUFVLENBQUMsb0JBQW9CLENBQUMsMEJBQTBCLENBQUMsV0FBVyxFQUFFLFVBQUMsU0FBUztnQkFDekosSUFBSSxTQUFTLEtBQUssS0FBSyxFQUFFO29CQUN2QixPQUFPLENBQUMsQ0FBQztpQkFDVjtxQkFBTTtvQkFBRSxPQUFPLENBQUMsQ0FBQztpQkFBRTtZQUN0QixDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDVCxJQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDbEQsOEJBQThCO1lBQzlCLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUN2QyxrQ0FBa0M7Z0JBQ2xDOzs7Ozs7Ozs7cUJBU0s7Z0JBQ0wsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUNsQyxpQkFBaUI7Z0JBQ2pCLDZCQUE2QjthQUM5QjtTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9CLENBQUM7O2dCQTlpQkYsVUFBVTs7OztnQkFURixrQkFBa0I7Z0JBTGxCLFVBQVU7Z0JBQUUsV0FBVztnQkFFdkIsa0JBQWtCO2dCQUVsQixlQUFlLHVCQThCbkIsUUFBUTtnQkEvQkosaUJBQWlCO2dCQUdqQixnQkFBZ0I7Z0JBTmlCLFNBQVM7Z0JBUTFDLHNCQUFzQjs7SUFxakIvQixzQkFBQztDQUFBLEFBL2lCRCxJQStpQkM7QUFDRCxPQUFPLEVBQUUsZUFBZSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIGVtcHR5LCBFTVBUWSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwLCBzd2l0Y2hNYXAsIGNvbmNhdE1hcCwgY2F0Y2hFcnJvciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJlcG9zaXRvcnksIEJpbmRpbmdEYXRhLCBFbnRpdHksIFZpZXdNb2RlbCwgQmluZGluZ0xpc3QsIEVudGl0eVBhdGhDb252ZXJ0ZXIsIEJpbmRpbmdPYmplY3QgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5LCBCZWZSZXBvc2l0b3J5VXRpbCwgQmVmRGF0YVBhdGhVdGlsIH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1Ob3RpZnlTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1ub3RpZnkuc2VydmljZSc7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi9sYW5ndWFnLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybU1lc3NhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1tZXNzYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUVycm9yU2VydmljZSB9IGZyb20gJy4uL2Vycm9yL2Zvcm0tZXJyb3Iuc2VydmljZSc7XG5pbXBvcnQgeyBDb21tYW5kU2VydmljZSB9IGZyb20gJy4uL2NvbW1hbmQtc2VydmljZSc7XG5pbXBvcnQgeyBGaWx0ZXJDb25kaXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vZmlsdGVyLWNvbmRpdGlvbi5zZXJ2aWNlJztcbi8vIHRzbGludDpkaXNhYmxlOiBuby1zdHJpbmctbGl0ZXJhbCBtYXgtbGluZS1sZW5ndGhcblxuLyoqXG4gKiDliJfooajku5PlupPmnI3liqFcbiAqL1xuQEluamVjdGFibGUoKVxuY2xhc3MgTGlzdERhdGFTZXJ2aWNlIHtcblxuICAvKipcbiAgICog5p6E6YCgXG4gICAqIEBwYXJhbSBtc2dTZXJ2aWNlIG1zZ1NlcnZpY2VcbiAgICogQHBhcmFtIHJlcG9zaXRvcnkgcmVwb3NpdG9yeVxuICAgKiBAcGFyYW0gYmluZGluZ0RhdGEgYmluZGluZ0RhdGFcbiAgICogQHBhcmFtIGxvYWRpbmdTZXJ2aWNlIGxvYWRpbmdTZXJ2aWNlXG4gICAqIEBwYXJhbSBsYW5ndWFnZVNlcnZpY2UgbGFuZ3VhZ2VTZXJ2aWNlXG4gICAqIEBwYXJhbSBmb3JtTm90aWZ5U2VydmljZSBmb3JtTm90aWZ5U2VydmljZVxuICAgKiBAcGFyYW0gZm9ybUVycm9yU2VydmljZSBmb3JtRXJyb3JTZXJ2aWNlXG4gICAqICEgQHBhcmFtIHZpZXdNb2RlbCB2aWV3TW9kZWwsdm3mmK/lkI7mnJ/ms6jlhaXnmoTvvIzogIHooajljZXojrflj5bkuI3liLDvvIzkuIDlrpropoHlgZrpnZ7nqbrliKTmlq1cbiAgICogQHBhcmFtIGZpbHRlckNvbmRpdGlvblNlcnZpY2UgZmlsdGVyQ29uZGl0aW9uU2VydmljZVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXG4gICAgcHJpdmF0ZSBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEsXG4gICAgcHJpdmF0ZSBsb2FkaW5nU2VydmljZTogRm9ybUxvYWRpbmdTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmb3JtTm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmb3JtRXJyb3JTZXJ2aWNlOiBGb3JtRXJyb3JTZXJ2aWNlLFxuICAgIHByaXZhdGUgdmlld01vZGVsOiBWaWV3TW9kZWwsXG4gICAgcHJpdmF0ZSBmaWx0ZXJDb25kaXRpb25TZXJ2aWNlOiBGaWx0ZXJDb25kaXRpb25TZXJ2aWNlLFxuICApIHtcbiAgICBpZiAoIWxhbmd1YWdlU2VydmljZSkge1xuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICB9XG5cbiAgICAvLyBpZiAoIWZpbHRlckNvbmRpdGlvblNlcnZpY2UpIHtcbiAgICAvLyAgIHRoaXMuZmlsdGVyQ29uZGl0aW9uU2VydmljZSA9IG5ldyBGaWx0ZXJDb25kaXRpb25TZXJ2aWNlKCk7XG4gICAgLy8gfVxuICB9XG5cbiAgLyoqXG4gICAqIOWKoOi9vVxuICAgKi9cbiAgcHVibGljIGxvYWQoZmlsdGVyPzogc3RyaW5nLCBzb3J0Pzogc3RyaW5nKTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xuXG4gICAgLy8g5Y+C5pWw5aSE55CGXG4gICAgZmlsdGVyID0gIWZpbHRlciA/ICdbXScgOiBmaWx0ZXI7XG4gICAgc29ydCA9ICFzb3J0ID8gJ1tdJyA6IHNvcnQ7XG4gICAgLy8g5ZCI5bm26L+H5ruk5p2h5Lu2XG4gICAgZmlsdGVyID0gdGhpcy5tZXJnZUZpbHRlckNvbmRpdGlvbnMoZmlsdGVyKTtcbiAgICAvLyDlkIjlubbmjpLluo/mnaHku7ZcbiAgICBzb3J0ID0gdGhpcy5tZXJnZVNvcnRDb25kaXRpb25zKHNvcnQpO1xuXG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDIwMCk7XG4gICAgY29uc3QgcXVlcnkkID0gdGhpcy5yZXBvc2l0b3J5LmdldEVudGl0aWVzKEpTT04ucGFyc2UoZmlsdGVyKSwgSlNPTi5wYXJzZShzb3J0KSwgbnVsbCwgbnVsbCk7XG4gICAgcmV0dXJuIHF1ZXJ5JC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgLy8g6Kem5Y+R6L+c56uv5ZCI6K6h5LqL5Lu2XG4gICAgICAgICAgdGhpcy5maXJlUXVlcnlFdmVudChmaWx0ZXIpO1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgIH0sXG4gICAgICAgIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmxvYWRGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOi/h+a7pOaVsOaNrlxuICAgKiBAcGFyYW0gZmlsdGVyIOi/h+a7pOadoeS7tlxuICAgKiBAcGFyYW0gc29ydCDmjpLluo/mnaHku7ZcbiAgICovXG4gIHB1YmxpYyBmaWx0ZXIoZmlsdGVyPzogc3RyaW5nLCBzb3J0Pzogc3RyaW5nKTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xuICAgIC8vIOWPguaVsOWkhOeQhlxuICAgIGZpbHRlciA9ICFmaWx0ZXIgPyAnW10nIDogZmlsdGVyO1xuICAgIHNvcnQgPSAhc29ydCA/ICdbXScgOiBzb3J0O1xuICAgIC8vIOWQiOW5tui/h+a7pOadoeS7tlxuICAgIGZpbHRlciA9IHRoaXMubWVyZ2VGaWx0ZXJDb25kaXRpb25zKGZpbHRlcik7XG4gICAgLy8g5ZCI5bm25o6S5bqP5p2h5Lu2XG4gICAgc29ydCA9IHRoaXMubWVyZ2VTb3J0Q29uZGl0aW9ucyhzb3J0KTtcblxuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSgyMDApO1xuICAgIGNvbnN0IHF1ZXJ5JCA9IHRoaXMucmVwb3NpdG9yeS5maWx0ZXIoSlNPTi5wYXJzZShmaWx0ZXIpLCBKU09OLnBhcnNlKHNvcnQpKTtcbiAgICByZXR1cm4gcXVlcnkkLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgICgpID0+IHtcbiAgICAgICAgICAvLyDop6blj5Hov5znq6/lkIjorqHkuovku7ZcbiAgICAgICAgICB0aGlzLmZpcmVRdWVyeUV2ZW50KGZpbHRlcik7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgfSxcbiAgICAgICAgKGVycm9yOiBhbnkpID0+IHtcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UubG9hZEZhaWxlZCwgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5p+l6K+iXG4gICAqL1xuICBwdWJsaWMgcXVlcnkoZmlsdGVyOiBzdHJpbmcsIHNvcnQ6IHN0cmluZywgcGFnZVNpemU6IG51bWJlciwgcGFnZUluZGV4OiBudW1iZXIpOiBPYnNlcnZhYmxlPEVudGl0eVtdPiB7XG4gICAgLy8g5Y+C5pWw5aSE55CGXG4gICAgZmlsdGVyID0gKGZpbHRlciA9PT0gJycpID8gJ1tdJyA6IGZpbHRlcjtcbiAgICBzb3J0ID0gKHNvcnQgPT09ICcnKSA/ICdbXScgOiBzb3J0O1xuICAgIC8vIOWQiOW5tui/h+a7pOadoeS7tlxuICAgIGZpbHRlciA9IHRoaXMubWVyZ2VGaWx0ZXJDb25kaXRpb25zKGZpbHRlcik7XG4gICAgLy8g5ZCI5bm25o6S5bqP5p2h5Lu2XG4gICAgc29ydCA9IHRoaXMubWVyZ2VTb3J0Q29uZGl0aW9ucyhzb3J0KTtcbiAgICAvLyDmiafooYzlj5bmlbBcbiAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNSk7XG4gICAgY29uc3QgcXVlcnkkID0gdGhpcy5yZXBvc2l0b3J5LmdldEVudGl0aWVzKEpTT04ucGFyc2UoZmlsdGVyKSwgSlNPTi5wYXJzZShzb3J0KSwgcGFnZVNpemUsIHBhZ2VJbmRleCk7XG4gICAgcmV0dXJuIHF1ZXJ5JC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgLy8g6Kem5Y+R6L+c56uv5ZCI6K6h5LqL5Lu2XG4gICAgICAgICAgdGhpcy5maXJlUXVlcnlFdmVudChmaWx0ZXIpO1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgIH0sXG4gICAgICAgIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnF1ZXJ5RmFpbGVkLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIHF1ZXJ5Q2hpbGQoZmlsdGVyOiBzdHJpbmcsIHNvcnQ6IHN0cmluZykge1xuICAgIC8vIGNvbnN0IGlzVXBkYXRlV2l0aFBhZ2luZyA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yb290LnBhcmFtcy5nZXQoJ3VwZGF0ZVdpdGhQYWdpbmcnKSB8fCBmYWxzZTtcbiAgICAvLyBpZiAoaXNVcGRhdGVXaXRoUGFnaW5nKSB7XG4gICAgLy8gICByZXR1cm4gb2YobnVsbCk7XG4gICAgLy8gfVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXG4gICAgY29uc3QgZnVsbFBhdGhzID0gRW50aXR5UGF0aENvbnZlcnRlci50b0VudGl0eVBhdGhBcnJheSh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCwgdGhpcy5iaW5kaW5nRGF0YSk7XG4gICAgY29uc3QgcGF0aHMgPSBmdWxsUGF0aHMuc2xpY2UoMCwgZnVsbFBhdGhzLmxlbmd0aCAtIDEpO1xuICAgIC8vIGRlYnVnXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtbGluZS1sZW5ndGhcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihpdGVtID0+IGl0ZW0pO1xuICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGE7XG4gICAgbGV0IG5vZGVDb2RlID0gYmluZGluZ1BhdGhzW2JpbmRpbmdQYXRocy5sZW5ndGggLSAxXTtcbiAgICBub2RlQ29kZSA9IG5vZGVDb2RlLnN1YnN0cigwLCBub2RlQ29kZS5sZW5ndGggLSAxKTtcbiAgICAvLyDojrflj5bkuIrnuqflrp7kvZNcbiAgICBjb25zdCBwYXJlbnRQYXRocyA9IGJpbmRpbmdQYXRocy5zbGljZSgwLCBiaW5kaW5nUGF0aHMubGVuZ3RoIC0gMSk7XG4gICAgY29uc3QgQmluZGluZ0xpc3QgPSBiaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXJlbnRQYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgaWYgKCFCaW5kaW5nTGlzdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuZGVsZXRlKFwicmV0cmlldmVpbmdcIik7XG4gICAgY29uc3QgY29uZmlnUGF0aCA9IGAvJHtub2RlQ29kZX1gO1xuICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldFBhZ2luYXRpb25Db25maWdCeVBhdGgoY29uZmlnUGF0aCk7XG4gICAgaWYgKGNvbmZpZykge1xuICAgICAgY29uc3QgeyBwYWdlSW5kZXggPSAxLCBwYWdlU2l6ZSA9IDAgfSA9IGNvbmZpZztcbiAgICAgIC8vIHBhZ2VTaXplID0gMOihqOekuuacquWIhumhtVxuICAgICAgaWYgKHBhZ2VTaXplICE9PSAwKSB7XG4gICAgICAgIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LnBhcmFtcy5zZXQoJ3F1ZXJ5Q2hpbGQnLCB0cnVlKTtcbiAgICAgICAgY29uc3QgcmVxdWVzdCQgPSB0aGlzLnJlcG9zaXRvcnkucXVlcnlDaGlsZChwYXRocywgcGFnZUluZGV4LCBwYWdlU2l6ZSk7XG4gICAgICAgIHJldHVybiByZXF1ZXN0JC5waXBlKFxuICAgICAgICAgIHRhcCgoKSA9PiB7IH0sXG4gICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UucXVlcnlGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gIH1cblxuICAvKipcbiAgICog6I635Y+W5YiG6aG15L+h5oGvXG4gICAqIEBwYXJhbSBub2RlQ29kZSBub2RlQ29kZVxuICAgKiBAcmV0dXJucyDliIbpobXkv6Hmga/vvIzljIXmi6zvvJrliIbpobXlpKflsI/jgIHlvZPliY3pobXnoIFcbiAgICogQGRlc2NyaXB0aW9uIOWfuuacrOWIhumhteS/oeaBr+WcqOWIhumhteS/oeaBr+S4reWtmOWCqOaXtmtleeS4um5vZGVDb2RlXG4gICAqL1xuICAvKnByaXZhdGUgZ2V0UGFnaW5nSW5mbyhub2RlQ29kZTogc3RyaW5nKSB7XG4gICAgY29uc3QgcmVzdWx0OiB7IHBhZ2VJbmRleD86IG51bWJlciwgcGFnZVNpemU/OiBudW1iZXIgfSA9IHt9O1xuICAgIGNvbnN0IG5vZGVDb2RlUGF0aCA9IGAvJHtub2RlQ29kZX1gO1xuICAgIGNvbnN0IGRlZmF1bHRQYWdpbmdJbmZvID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0UGFnaW5hdGlvbkNvbmZpZ0J5UGF0aChub2RlQ29kZVBhdGgpO1xuICAgIGNvbnN0IHBhZ2VTaXplID0gZGVmYXVsdFBhZ2luZ0luZm8gJiYgZGVmYXVsdFBhZ2luZ0luZm8ucGFnZVNpemUgfHwgMDtcbiAgICBjb25zdCBwYWdlSW5kZXggPSBkZWZhdWx0UGFnaW5nSW5mbyAmJiBkZWZhdWx0UGFnaW5nSW5mby5wYWdlSW5kZXggfHwgMTtcbiAgICByZXN1bHQucGFnZUluZGV4ID0gcGFnZUluZGV4O1xuICAgIHJlc3VsdC5wYWdlU2l6ZSA9IHBhZ2VTaXplO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH0qL1xuICAvKipcbiAgICog6L+95Yqg5LiA5p2h5paw5pWw5o2uXG4gICAqL1xuICBwdWJsaWMgYXBwZW5kKCk6IE9ic2VydmFibGU8RW50aXR5PiB7XG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XG4gICAgaWYgKHRoaXMubWVzc2FnZVBpcGUpIHtcbiAgICAgIHRoaXMubWVzc2FnZVBpcGUubmV4dCh7IG1lc3NhZ2VUeXBlOiAnYXBwZW5kJyB9KTtcbiAgICB9XG4gICAgY29uc3QgYXBwZW5kJCA9IHRoaXMucmVwb3NpdG9yeS5hcHBlbmQoKTtcbiAgICByZXR1cm4gYXBwZW5kJC5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuYXBwZW5kRmFpbGVkLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDlvZPliY3ooYzliY3miJblkI7mj5LlhaXmlbDmja5cbiAgICogQHBhcmFtIHBvc2l0aW9uIDEgfCAtMVxuICAgKi9cbiAgcHVibGljIGluc2VydChwb3NpdGlvbjogMSB8IC0xID0gLTEpIHtcbiAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcbiAgICBpZiAodGhpcy5tZXNzYWdlUGlwZSkge1xuICAgICAgdGhpcy5tZXNzYWdlUGlwZS5uZXh0KHsgbWVzc2FnZVR5cGU6ICdpbnNlcnQnIH0pO1xuICAgIH1cbiAgICBjb25zdCBhcHBlbmQkID0gdGhpcy5yZXBvc2l0b3J5Lmluc2VydChwb3NpdGlvbik7XG4gICAgcmV0dXJuIGFwcGVuZCQucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICB9LFxuICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFwcGVuZEZhaWxlZCwgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmj5DkuqTlj5jmm7TvvIjmibnph4/nvJbovpHpobXpnaLvvIzooYzliIfmjaLml7bmj5DkuqTlop7ph4/vvIlcbiAgICovXG4gIHB1YmxpYyB1cGRhdGVDaGFuZ2VzKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHVwZGF0ZSQgPSB0aGlzLnJlcG9zaXRvcnkudXBkYXRlQWxsQ2hhbmdlcygpO1xuICAgIHJldHVybiB1cGRhdGUkO1xuICB9XG5cbiAgLyoqXG4gICAqIOaJuemHj+S/neWtmFxuICAgKiBAcGFyYW0gc3VjY2Vzc01zZyDoh6rlrprkuYnmj5DnpLrkv6Hmga9cbiAgICovXG4gIHB1YmxpYyBzYXZlKHN1Y2Nlc3NNc2c/OiBzdHJpbmcpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBpZiAodGhpcy5tZXNzYWdlUGlwZSkge1xuICAgICAgdGhpcy5tZXNzYWdlUGlwZS5uZXh0KHsgbWVzc2FnZVR5cGU6ICdzYXZlJyB9KTtcbiAgICB9XG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XG4gICAgY29uc3Qgc2F2ZSQgPSB0aGlzLnJlcG9zaXRvcnkuYXBwbHlDaGFuZ2VzKCk7XG4gICAgY29uc3QgcmVzdWx0JCA9IHNhdmUkLnBpcGUoXG4gICAgICB0YXAoXG4gICAgICAgICgpID0+IHtcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgIGlmIChzdWNjZXNzTXNnICYmIHN1Y2Nlc3NNc2cudHJpbSgpKSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3Moc3VjY2Vzc01zZywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxhbmd1YWdlU2VydmljZS5zYXZlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLm11bHRpU2F2ZUZhaWxlZCwgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcblxuICAgIHJldHVybiByZXN1bHQkO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIoOmZpFxuICAgKiBAcGFyYW0gaWQg6KaB5Yig6Zmk55qE5pWw5o2u55qEaWRcbiAgICogQHBhcmFtIGlmU2F2ZSDmmK/lkKbkv53lrZhcbiAgICogQHBhcmFtIHN1Y2Nlc3NNc2cg6Ieq5a6a5LmJ5o+Q56S65L+h5oGvXG4gICAqIEBwYXJhbSBjb25maXJtIOaYr+WQpumcgOimgeehruiupFxuICAgKiBAcGFyYW0gYnJlYWthYmxlIOaYr+WQpuWPr+S4reaWre+8jGlmU2F2ZeS4umZhbHNl5pe25rWB5Lya5Lit5patXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlKGlkOiBzdHJpbmcsIGlmU2F2ZT86IGJvb2xlYW4gfCBzdHJpbmcsIHN1Y2Nlc3NNc2c/OiBzdHJpbmcsIGNvbmZpcm06IGJvb2xlYW4gfCBzdHJpbmcgPSB0cnVlLCBicmVha2FibGU6IGJvb2xlYW4gfCBzdHJpbmcgPSB0cnVlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy5tZXNzYWdlUGlwZSkge1xuICAgICAgdGhpcy5tZXNzYWdlUGlwZS5uZXh0KHsgbWVzc2FnZVR5cGU6ICdkZWxldGUnIH0pO1xuICAgIH1cbiAgICBpZiAoIWlkKSB7XG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2VbJ3Bsc1NlbGVjdERlbGV0ZURhdGEnXSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICB9XG4gICAgY29uZmlybSA9IChjb25maXJtID09PSBmYWxzZSB8fCBjb25maXJtID09PSAnZmFsc2UnKSA/IGZhbHNlIDogdHJ1ZTtcbiAgICBicmVha2FibGUgPSAoYnJlYWthYmxlID09PSBmYWxzZSB8fCBicmVha2FibGUgPT09ICdmYWxzZScpID8gZmFsc2UgOiB0cnVlO1xuICAgIGNvbnN0IGFjdGlvbiQgPSBjb25maXJtID8gdGhpcy5tc2dTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNvbmZpcm1EZWxldGlvbikgOiBvZih0cnVlKTtcbiAgICByZXR1cm4gYWN0aW9uJC5waXBlKFxuICAgICAgY29uY2F0TWFwKHJlc3VsdCA9PiB7XG4gICAgICAgIGlmICghcmVzdWx0KSB7XG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgIH1cbiAgICAgICAgaWZTYXZlID0gKGlmU2F2ZSA9PT0gZmFsc2UgfHwgaWZTYXZlID09PSAnZmFsc2UnKSA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XG4gICAgICAgIGNvbnN0IHJlbW92ZSQgPSB0aGlzLnJlcG9zaXRvcnkucmVtb3ZlQnlJZChpZCwgaWZTYXZlKTtcbiAgICAgICAgaWYgKCFyZW1vdmUkKSB7XG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlbW92ZSQucGlwZShcbiAgICAgICAgICB0YXAoXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgICAgIGlmIChzdWNjZXNzTXNnICYmIHN1Y2Nlc3NNc2cudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHN1Y2Nlc3NNc2csIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVTdWNjZXNzLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICApLFxuICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgICAgICBpZiAoaWZTYXZlID09PSB0cnVlIHx8ICFicmVha2FibGUpIHtcbiAgICAgICAgICAgICAgLy8gcmV0dXJuIHRoaXMubG9hZCgpO1xuICAgICAgICAgICAgICByZXR1cm4gb2YoW10pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5om56YeP5Yig6ZmkXG4gICAqIEBwYXJhbSBpZHMgaWRzXG4gICAqIEBwYXJhbSBpZlNhdmUg5piv5ZCm5L+d5a2YXG4gICAqIEBwYXJhbSBzdWNjZXNzTXNnIOiHquWumuS5ieaPkOekuuS/oeaBr1xuICAgKiBAcGFyYW0gZGVsZXRlQ3VycmVudFJvd0lmTm9DaGVja3Mg5rKh5pyJ5Yu+6YCJ5pe25Yig6Zmk5b2T5YmN6KGMXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlUm93cyhpZHM6IHN0cmluZ1tdLCBpZlNhdmU/OiBib29sZWFuIHwgc3RyaW5nLCBzdWNjZXNzTXNnPzogc3RyaW5nLCBkZWxldGVDdXJyZW50Um93SWZOb0NoZWNrczogYm9vbGVhbiB8IHN0cmluZyA9IGZhbHNlKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy5tZXNzYWdlUGlwZSkge1xuICAgICAgdGhpcy5tZXNzYWdlUGlwZS5uZXh0KHsgbWVzc2FnZVR5cGU6ICdyZW1vdmVSb3dzJyB9KTtcbiAgICB9XG4gICAgZGVsZXRlQ3VycmVudFJvd0lmTm9DaGVja3MgPSAoZGVsZXRlQ3VycmVudFJvd0lmTm9DaGVja3MgPT09ICd0cnVlJyB8fCBkZWxldGVDdXJyZW50Um93SWZOb0NoZWNrcyA9PT0gdHJ1ZSkgPyB0cnVlIDogZmFsc2U7XG4gICAgaWYgKCFpZHMgfHwgaWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3QgY3VycmVudElkID0gdGhpcy5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcbiAgICAgIGlmIChkZWxldGVDdXJyZW50Um93SWZOb0NoZWNrcyA9PT0gdHJ1ZSAmJiBjdXJyZW50SWQpIHtcbiAgICAgICAgaWRzID0gW3RoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWRdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydwbHNTZWxlY3REZWxldGVEYXRhJ10sIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgYWN0aW9uJCA9IHRoaXMubXNnU2VydmljZS5jb25maXJtKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNvbmZpcm1EZWxldGlvbik7XG4gICAgcmV0dXJuIGFjdGlvbiQucGlwZShcbiAgICAgIGNvbmNhdE1hcChyZXN1bHQgPT4ge1xuICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgaWZTYXZlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgIGlmU2F2ZSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBpZlNhdmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgaWZTYXZlID0gaWZTYXZlLnRvTG93ZXJDYXNlKCkgPT09ICdmYWxzZScgPyBmYWxzZSA6IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWZTYXZlID0gKGlmU2F2ZSA9PT0gZmFsc2UpID8gZmFsc2UgOiB0cnVlO1xuICAgICAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcbiAgICAgICAgY29uc3QgcmVtb3ZlJCA9IHRoaXMucmVwb3NpdG9yeS5yZW1vdmVCeUlkcyhpZHMsIGlmU2F2ZSk7XG5cbiAgICAgICAgaWYgKCFyZW1vdmUkKSB7XG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVtb3ZlJC5waXBlKFxuICAgICAgICAgIHRhcChcbiAgICAgICAgICAgICgpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICAgICAgaWYgKHN1Y2Nlc3NNc2cgJiYgc3VjY2Vzc01zZy50cmltKCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3Moc3VjY2Vzc01zZywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIC8vIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVTdWNjZXNzLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlRmFpbGVkLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKSxcbiAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIoOmZpOWQjueahOWIt+aWsFxuICAgKi9cbiAgcHVibGljIHJlZnJlc2hBZnRlclJlbW92aW5nKGxvYWRDbWROYW1lOiBzdHJpbmcsIGxvYWRDbWRGcmFtZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICh0aGlzLnZpZXdNb2RlbCAmJiBsb2FkQ21kTmFtZSAmJiBsb2FkQ21kRnJhbWVJZCkge1xuICAgICAgY29uc3QgY29tbWFuZFNlcnZpY2UgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PENvbW1hbmRTZXJ2aWNlPihDb21tYW5kU2VydmljZSwgbnVsbCk7XG4gICAgICByZXR1cm4gY29tbWFuZFNlcnZpY2UuZXhlY3V0ZShsb2FkQ21kTmFtZSwgbG9hZENtZEZyYW1lSWQpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5sb2FkKCk7XG4gIH1cblxuICAvKipcbiAgICog5Yi35pawXG4gICAqIEBwYXJhbSBsb2FkQ21kTmFtZSDliLfmlrDlkb3ku6RcbiAgICogQHBhcmFtIGxvYWRDbWRGcmFtZUlkIOWIt+aWsOWRveS7pOaJgOWcqOeahGZyYW1lSWRcbiAgICovXG4gIHB1YmxpYyByZWZyZXNoKGxvYWRDbWROYW1lOiBzdHJpbmcsIGxvYWRDbWRGcmFtZUlkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICh0aGlzLnZpZXdNb2RlbCAmJiBsb2FkQ21kTmFtZSAmJiBsb2FkQ21kRnJhbWVJZCkge1xuICAgICAgY29uc3QgY29tbWFuZFNlcnZpY2UgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PENvbW1hbmRTZXJ2aWNlPihDb21tYW5kU2VydmljZSwgbnVsbCk7XG4gICAgICByZXR1cm4gY29tbWFuZFNlcnZpY2UuZXhlY3V0ZShsb2FkQ21kTmFtZSwgbG9hZENtZEZyYW1lSWQpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5sb2FkKCk7XG4gIH1cbiAgLyoqXG4gICAqIOWPlua2iOaXtuajgOa1i+acquS/neWtmOiusOW9lVxuICAgKi9cbiAgcHVibGljIGNhbmNlbCgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGlmICh0aGlzLm1lc3NhZ2VQaXBlKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VQaXBlLm5leHQoeyBtZXNzYWdlVHlwZTogJ2NhbmNlbCcgfSk7XG4gICAgfVxuICAgIC8vIOayoeacieWPmOabtOaXtuebtOaOpeWPlua2iFxuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xuICAgIGNvbnN0IGhhc1Vuc2F2ZWREYXRhID0gQmVmUmVwb3NpdG9yeVV0aWwuaXNFeGlzdFVuc2F2ZURhdGEoYmVmUmVwb3NpdG9yeSk7XG4gICAgaWYgKGhhc1Vuc2F2ZWREYXRhID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2NhbmNlbCgpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbmZpcm1SZXN1bHQkID0gdGhpcy5tc2dTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydjYW5jZWxXaXRob3V0U2F2ZSddKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChpZkNhbmNlbDogYm9vbGVhbikgPT4ge1xuICAgICAgICBpZiAoaWZDYW5jZWwgPT09IGZhbHNlKSB7XG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuX2NhbmNlbCgpO1xuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIGNvbmZpcm1SZXN1bHQkO1xuICB9XG4gIC8qKlxuICAgKiDov5jljp/lj5jmm7Tpm4ZcbiAgICogQGRlc2NyaXB0aW9uIOS4jeW4puWPmOabtOajgOa1i+aPkOekulxuICAgKi9cbiAgcHVibGljIHJldmVydCgpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLl9jYW5jZWwoKTtcbiAgfVxuICAvKipcbiAgICog5Y+W5raI77yI5YaF6YOo5Y+W5raI77yJXG4gICAqL1xuICBwcml2YXRlIF9jYW5jZWwoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoNTAwKTtcbiAgICBjb25zdCBjYW5jZWwkID0gdGhpcy5yZXBvc2l0b3J5LmNhbmNlbENoYW5nZXMoKTtcbiAgICByZXR1cm4gY2FuY2VsJC5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsRmFpbGVkLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bmoLnnu4Tku7ZhcHBDb250ZXh0XG4gICAqL1xuICBwcml2YXRlIGdldCBtZXNzYWdlUGlwZSgpIHtcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0KSB7XG4gICAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmdldEZvcm1BcHBDb250ZXh0KCkgfHwgbnVsbDtcbiAgICAgIGlmIChhcHBDb250ZXh0KSB7XG4gICAgICAgIHJldHVybiBhcHBDb250ZXh0Lm1lc3NhZ2VQaXBlIHx8IG51bGw7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG4gIC8qKlxuICAgKiDop6blj5Hmn6Xor6Lkuovku7ZcbiAgICogQHBhcmFtIGZpbHRlcnMg6L+H5ruk5p2h5Lu2XG4gICAqL1xuICBwcml2YXRlIGZpcmVRdWVyeUV2ZW50KGZpbHRlcnM6IGFueSkge1xuICAgIGNvbnN0IG1lc3NhZ2VQaXBlID0gdGhpcy5tZXNzYWdlUGlwZTtcbiAgICAvLyBjb25zdCBmcmFtZUlkID0gdGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0ICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5mcmFtZUlkIHx8IG51bGw7XG4gICAgaWYgKG1lc3NhZ2VQaXBlKSB7XG4gICAgICBtZXNzYWdlUGlwZS5uZXh0KHsgdHlwZTogJ3F1ZXJ5JyB9KTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOWQiOW5tui/h+a7pOadoeS7tlxuICAgKiBAcGFyYW0gZmlsdGVyIOihqOWNlei/h+a7pOadoeS7tlxuICAgKi9cbiAgcHJpdmF0ZSBtZXJnZUZpbHRlckNvbmRpdGlvbnMoZmlsdGVyOiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIGZpbHRlciA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGZpbHRlciA9IEpTT04ucGFyc2UoZmlsdGVyKSB8fCBbXTtcbiAgICB9XG4gICAgY29uc3QgZmlsdGVyczogQXJyYXk8YW55PiA9IGZpbHRlcjtcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoIHx8IG51bGw7XG4gICAgaWYgKGJpbmRpbmdQYXRoKSB7XG4gICAgICBjb25zdCBvcmlnaW5hbENvbmRpdGlvbnMgPSB0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5maWx0ZXJDb25kaXRpb25NYW5hZ2VyLmdldEZpbHRlcnMoYmluZGluZ1BhdGgpIHx8IFtdO1xuICAgICAgLy8gdGhpcy5maWx0ZXJDb25kaXRpb25TZXJ2aWNlLmdldEZpbHRlcnMoYmluZGluZ1BhdGgpIHx8IFtdO1xuICAgICAgY29uc3QgY29uZGl0aW9ucyA9IEFycmF5LmZyb20ob3JpZ2luYWxDb25kaXRpb25zKTtcbiAgICAgIGlmIChjb25kaXRpb25zICYmIGNvbmRpdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAvKmZpbHRlcnMuZm9yRWFjaCgoaXRlbTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgY29uc3QgZmllbGQgPSBpdGVtLkZpbHRlckZpZWxkIHx8IG51bGw7XG4gICAgICAgICAgaWYgKGZpZWxkKSB7XG4gICAgICAgICAgICBjb25zdCBkdXBsaWNhdGVJbmRleCA9IGNvbmRpdGlvbnMuZmluZEluZGV4KGNvbmRpdGlvbiA9PiBjb25kaXRpb24uRmlsdGVyRmllbGQgPT09IGZpZWxkKTtcbiAgICAgICAgICAgIGlmIChkdXBsaWNhdGVJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgZmlsdGVyc1tpbmRleF0gPSBjb25kaXRpb25zW2R1cGxpY2F0ZUluZGV4XTtcbiAgICAgICAgICAgICAgY29uZGl0aW9ucy5zcGxpY2UoZHVwbGljYXRlSW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7Ki9cbiAgICAgICAgLy8g5L+u5pS55ZG95Luk5LiK6L+H5ruk5p2h5Lu255qE5pyA5ZCO5LiA5Liq5p+l6K+i5YWz57O75Li6YW5kXG4gICAgICAgIGlmIChmaWx0ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAvLyDmnIDlkI7kuIDkuKrov4fmu6TmnaHku7ZcbiAgICAgICAgICBjb25zdCBsYXN0RmlsdGVyID0gZmlsdGVyc1tmaWx0ZXJzLmxlbmd0aCAtIDFdO1xuICAgICAgICAgIGlmIChsYXN0RmlsdGVyKSB7XG4gICAgICAgICAgICBpZiAobGFzdEZpbHRlci5oYXNPd25Qcm9wZXJ0eSgnUmVsYXRpb24nKSkge1xuICAgICAgICAgICAgICBkZWxldGUgbGFzdEZpbHRlci5SZWxhdGlvbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxhc3RGaWx0ZXIucmVsYXRpb24gPSAxO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyDlkIjlubbmlrDnmoTov4fmu6TmnaHku7blkozljp/mnaXlkb3ku6TkuIrnmoTov4fmu6TmnaHku7ZcbiAgICAgICAgZmlsdGVycy5wdXNoKC4uLmNvbmRpdGlvbnMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShmaWx0ZXJzKTtcbiAgfVxuICAvKipcbiAgICog5ZCI5bm25o6S5bqP5p2h5Lu2XG4gICAqIEBwYXJhbSBzb3J0IOaOkuW6j+adoeS7tlxuICAgKi9cbiAgcHJpdmF0ZSBtZXJnZVNvcnRDb25kaXRpb25zKHNvcnQ6IGFueSkge1xuICAgIGlmICh0eXBlb2Ygc29ydCA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHNvcnQgPSBKU09OLnBhcnNlKHNvcnQpIHx8IFtdO1xuICAgIH1cbiAgICBjb25zdCBzb3J0czogQXJyYXk8YW55PiA9IHNvcnQ7XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCBudWxsO1xuICAgIGlmIChiaW5kaW5nUGF0aCkge1xuICAgICAgLy8g6I635Y+W5b2T5YmN57uR5a6a6Lev5b6E55qE5omA5pyJ5o6S5bqP5p2h5Lu2XG4gICAgICBjb25zdCBvcmlnaW5hbENvbmRpdGlvbnMgPSB0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeS5zb3J0Q29uZGl0aW9uTWFuYWdlci5nZXRDb25kaXRpb25zQnlCaW5kaW5nUGF0aChiaW5kaW5nUGF0aCwgKGRpcmVjdGlvbikgPT4ge1xuICAgICAgICBpZiAoZGlyZWN0aW9uID09PSAnYXNjJykge1xuICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICB9IGVsc2UgeyByZXR1cm4gMTsgfVxuICAgICAgfSkgfHwgW107XG4gICAgICBjb25zdCBjb25kaXRpb25zID0gQXJyYXkuZnJvbShvcmlnaW5hbENvbmRpdGlvbnMpO1xuICAgICAgLy8g5aaC5p6c5b2T5YmN57uR5a6a6Lev5b6E5pyJ5o6S5bqP5p2h5Lu277yM5YiZ5b+955Wl5ZG95Luk5LiK6aKE5Yi255qE5o6S5bqP5p2h5Lu2XG4gICAgICBpZiAoY29uZGl0aW9ucyAmJiBjb25kaXRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgLy8g6YGN5Y6G5bey5pyJ55qE6L+H5ruk5p2h5Lu277yM5aaC5p6c5pyJ6YeN5aSN55qEZmllbGTvvIznlKjlkI7ogIXnmoTopobnm5blt7LmnInnmoRcbiAgICAgICAgLypzb3J0cy5mb3JFYWNoKChpdGVtOiBhbnksIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICBjb25zdCBmaWVsZCA9IGl0ZW0uU29ydEZpZWxkIHx8IG51bGw7XG4gICAgICAgICAgaWYgKGZpZWxkKSB7XG4gICAgICAgICAgICBjb25zdCBkdXBsaWNhdGVJbmRleCA9IGNvbmRpdGlvbnMuZmluZEluZGV4KGNvbmRpdGlvbiA9PiBjb25kaXRpb24uU29ydEZpZWxkID09PSBmaWVsZCk7XG4gICAgICAgICAgICBpZiAoZHVwbGljYXRlSW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgIHNvcnRzW2luZGV4XSA9IGNvbmRpdGlvbnNbZHVwbGljYXRlSW5kZXhdO1xuICAgICAgICAgICAgICBjb25kaXRpb25zLnNwbGljZShkdXBsaWNhdGVJbmRleCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KTsqL1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoY29uZGl0aW9ucyk7XG4gICAgICAgIC8vIOWwhuWFtuS9meaOkuW6j+adoeS7tua3u+WKoOWIsOaOkuW6j+aVsOe7hFxuICAgICAgICAvLyBzb3J0cy5wdXNoKC4uLmNvbmRpdGlvbnMpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoc29ydHMpO1xuICB9XG59XG5leHBvcnQgeyBMaXN0RGF0YVNlcnZpY2UgfTtcbiJdfQ==