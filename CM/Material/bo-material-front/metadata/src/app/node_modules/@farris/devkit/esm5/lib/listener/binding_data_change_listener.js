import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector } from '@angular/core';
import { BindingData, BindingList, ChangeType } from '../binding-data/index';
import { ChangeListener } from './change_listener';
import { Expression } from '../expression/index';
import { NAMESPACE } from '../frame/index';
import { Repository } from '../repository/index';
var EventType = Expression.EventType;
/**
 * 监听bindingList变更
 * @description 主要用于监听行切换等事件
 */
var BindingDataChangeListener = /** @class */ (function (_super) {
    tslib_1.__extends(BindingDataChangeListener, _super);
    function BindingDataChangeListener(injector, bindingData, namespace) {
        var _this = _super.call(this) || this;
        _this.injector = injector;
        _this.bindingData = bindingData;
        _this.namespace = namespace;
        _this.repository = null;
        _this.repository = _this.injector.get(Repository, null);
        _this.registerEvent();
        return _this;
    }
    /**
     * 注册值变化事件
     */
    BindingDataChangeListener.prototype.registerEvent = function () {
        var _this = this;
        if (this.bindingData && this.bindingData.changes && typeof this.bindingData.changes.subscribe === 'function') {
            this.bindingData.changes.subscribe(function (change) {
                if ((change.type === ChangeType.Append && change.isCloned !== true) || change.type === ChangeType.ValueChanged || change.type === ChangeType.Remove || change.type === ChangeType.Load || change.type === ChangeType.SelectionChanged) {
                    var eventType = null;
                    if (change.type === ChangeType.Append) {
                        eventType = EventType.Append;
                    }
                    else if (change.type === ChangeType.ValueChanged) {
                        eventType = EventType.ValueChanged;
                    }
                    else if (change.type === ChangeType.Remove) {
                        eventType = EventType.Remove;
                    }
                    else if (change.type === ChangeType.Load) {
                        // 主表新增
                        if (change.create === true) {
                            eventType = EventType.Append;
                        }
                        else {
                            eventType = EventType.Load;
                        }
                    }
                    else if (change.type === ChangeType.SelectionChanged) {
                        eventType = EventType.SelectionChanged;
                    }
                    var path = _this.buildEventPath(change);
                    var modification = {
                        ns: _this.namespace,
                        path: path,
                        type: eventType,
                        source: Expression.EventSource.BindingData,
                        value: change.value,
                        id: change.id
                    };
                    // console.log("BindingDataChangeListener", modification);
                    _this.subject.next(modification);
                }
            });
        }
    };
    BindingDataChangeListener.prototype.buildEventPath = function (change) {
        var path = change.path;
        var paths = [];
        // if (!path || path.length < 1) {
        //   return paths;
        // }
        var primaryValue = this.bindingData.list.currentItem.primaryKeyValue;
        if (primaryValue) {
            if (!(change.type === ChangeType.Load && change.path.length === 0)) {
                paths.push(this.bindingData.list.primaryKey + ":" + primaryValue);
            }
        }
        var currentPath = [];
        for (var index = 0; index < path.length; index++) {
            var propertyName = path[index];
            currentPath.push(propertyName);
            var item = this.bindingData.getValue(currentPath);
            paths.push(propertyName);
            if (item instanceof BindingList) {
                if (currentPath.length < path.length) {
                    var bindingList = item;
                    var currentId = bindingList.currentItem.primaryKeyValue;
                    if (index === path.length - 2 && change.id) {
                        currentId = change.id;
                    }
                    paths.push(this.bindingData.list.primaryKey + ":" + currentId);
                }
            }
        }
        return paths;
    };
    BindingDataChangeListener.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BindingDataChangeListener.ctorParameters = function () { return [
        { type: Injector },
        { type: BindingData },
        { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] }
    ]; };
    return BindingDataChangeListener;
}(ChangeListener));
export { BindingDataChangeListener };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19kYXRhX2NoYW5nZV9saXN0ZW5lci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2xpc3RlbmVyL2JpbmRpbmdfZGF0YV9jaGFuZ2VfbGlzdGVuZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUUsV0FBVyxFQUFFLFdBQVcsRUFBVSxVQUFVLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUNyRixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHakQsSUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztBQUN2Qzs7O0dBR0c7QUFDSDtJQUN3QyxxREFBYztJQUVwRCxtQ0FBb0IsUUFBa0IsRUFBVSxXQUF3QixFQUE2QixTQUFTO1FBQTlHLFlBQ0UsaUJBQU8sU0FHUjtRQUptQixjQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsaUJBQVcsR0FBWCxXQUFXLENBQWE7UUFBNkIsZUFBUyxHQUFULFNBQVMsQ0FBQTtRQUR0RyxnQkFBVSxHQUFvQixJQUFJLENBQUM7UUFHekMsS0FBSSxDQUFDLFVBQVUsR0FBRyxLQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEQsS0FBSSxDQUFDLGFBQWEsRUFBRSxDQUFDOztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSyxpREFBYSxHQUFyQjtRQUFBLGlCQW1DQztRQWxDQyxJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLElBQUksT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEtBQUssVUFBVSxFQUFFO1lBQzVHLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxVQUFDLE1BQWM7Z0JBQ2hELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLFFBQVEsS0FBSyxJQUFJLENBQUMsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxZQUFZLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxnQkFBZ0IsRUFBRTtvQkFDck8sSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO29CQUNyQixJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sRUFBRTt3QkFDckMsU0FBUyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUM7cUJBQzlCO3lCQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsWUFBWSxFQUFFO3dCQUNsRCxTQUFTLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQztxQkFDcEM7eUJBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxNQUFNLEVBQUU7d0JBQzVDLFNBQVMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO3FCQUM5Qjt5QkFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksRUFBRTt3QkFDMUMsT0FBTzt3QkFDUCxJQUFJLE1BQU0sQ0FBQyxNQUFNLEtBQUssSUFBSSxFQUFFOzRCQUMxQixTQUFTLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQzt5QkFDOUI7NkJBQU07NEJBQ0wsU0FBUyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7eUJBQzVCO3FCQUNGO3lCQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsZ0JBQWdCLEVBQUU7d0JBQ3RELFNBQVMsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUE7cUJBQ3ZDO29CQUNELElBQU0sSUFBSSxHQUFHLEtBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7b0JBQ3pDLElBQU0sWUFBWSxHQUFjO3dCQUM5QixFQUFFLEVBQUUsS0FBSSxDQUFDLFNBQVM7d0JBQ2xCLElBQUksRUFBRSxJQUFJO3dCQUNWLElBQUksRUFBRSxTQUFTO3dCQUNmLE1BQU0sRUFBRSxVQUFVLENBQUMsV0FBVyxDQUFDLFdBQVc7d0JBQzFDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSzt3QkFDbkIsRUFBRSxFQUFFLE1BQU0sQ0FBQyxFQUFFO3FCQUNkLENBQUM7b0JBQ0YsMERBQTBEO29CQUMxRCxLQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztpQkFDakM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVNLGtEQUFjLEdBQXJCLFVBQXNCLE1BQWM7UUFDbEMsSUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUN6QixJQUFNLEtBQUssR0FBRyxFQUFFLENBQUM7UUFDakIsa0NBQWtDO1FBQ2xDLGtCQUFrQjtRQUNsQixJQUFJO1FBQ0osSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQztRQUN2RSxJQUFJLFlBQVksRUFBRTtZQUNoQixJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLEVBQUU7Z0JBQ2xFLEtBQUssQ0FBQyxJQUFJLENBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxTQUFJLFlBQWMsQ0FBQyxDQUFDO2FBQ25FO1NBQ0Y7UUFDRCxJQUFNLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDdkIsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUU7WUFDaEQsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2pDLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDL0IsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDcEQsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUN6QixJQUFJLElBQUksWUFBWSxXQUFXLEVBQUU7Z0JBQy9CLElBQUksV0FBVyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNwQyxJQUFNLFdBQVcsR0FBRyxJQUFtQixDQUFDO29CQUN4QyxJQUFJLFNBQVMsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQztvQkFDeEQsSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLEVBQUUsRUFBRTt3QkFDMUMsU0FBUyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUM7cUJBQ3ZCO29CQUNELEtBQUssQ0FBQyxJQUFJLENBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxTQUFJLFNBQVcsQ0FBQyxDQUFDO2lCQUNoRTthQUNGO1NBQ0Y7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7O2dCQS9FRixVQUFVOzs7O2dCQWJrQixRQUFRO2dCQUM1QixXQUFXO2dEQWV5RCxNQUFNLFNBQUMsU0FBUzs7SUE2RTdGLGdDQUFDO0NBQUEsQUFoRkQsQ0FDd0MsY0FBYyxHQStFckQ7QUFDRCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEJpbmRpbmdMaXN0LCBDaGFuZ2UsIENoYW5nZVR5cGUgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBDaGFuZ2VMaXN0ZW5lciB9IGZyb20gJy4vY2hhbmdlX2xpc3RlbmVyJztcclxuaW1wb3J0IHsgRXhwcmVzc2lvbiB9IGZyb20gJy4uL2V4cHJlc3Npb24vaW5kZXgnO1xyXG5pbXBvcnQgeyBOQU1FU1BBQ0UgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L2luZGV4JztcclxuXHJcbnR5cGUgRXZlbnRBcmdzID0gRXhwcmVzc2lvbi5FdmVudEFyZ3M7XHJcbmNvbnN0IEV2ZW50VHlwZSA9IEV4cHJlc3Npb24uRXZlbnRUeXBlO1xyXG4vKipcclxuICog55uR5ZCsYmluZGluZ0xpc3Tlj5jmm7RcclxuICogQGRlc2NyaXB0aW9uIOS4u+imgeeUqOS6juebkeWQrOihjOWIh+aNouetieS6i+S7tlxyXG4gKi9cclxuQEluamVjdGFibGUoKVxyXG5jbGFzcyBCaW5kaW5nRGF0YUNoYW5nZUxpc3RlbmVyIGV4dGVuZHMgQ2hhbmdlTGlzdGVuZXIge1xyXG4gIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+ID0gbnVsbDtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGEsIEBJbmplY3QoTkFNRVNQQUNFKSBwcml2YXRlIG5hbWVzcGFjZSkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIHRoaXMucmVwb3NpdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJlcG9zaXRvcnksIG51bGwpO1xyXG4gICAgdGhpcy5yZWdpc3RlckV2ZW50KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDms6jlhozlgLzlj5jljJbkuovku7ZcclxuICAgKi9cclxuICBwcml2YXRlIHJlZ2lzdGVyRXZlbnQoKSB7XHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YSAmJiB0aGlzLmJpbmRpbmdEYXRhLmNoYW5nZXMgJiYgdHlwZW9mIHRoaXMuYmluZGluZ0RhdGEuY2hhbmdlcy5zdWJzY3JpYmUgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5jaGFuZ2VzLnN1YnNjcmliZSgoY2hhbmdlOiBDaGFuZ2UpID0+IHtcclxuICAgICAgICBpZiAoKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLkFwcGVuZCAmJiBjaGFuZ2UuaXNDbG9uZWQgIT09IHRydWUpIHx8IGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5SZW1vdmUgfHwgY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuTG9hZCB8fCBjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5TZWxlY3Rpb25DaGFuZ2VkKSB7XHJcbiAgICAgICAgICBsZXQgZXZlbnRUeXBlID0gbnVsbDtcclxuICAgICAgICAgIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5BcHBlbmQpIHtcclxuICAgICAgICAgICAgZXZlbnRUeXBlID0gRXZlbnRUeXBlLkFwcGVuZDtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5WYWx1ZUNoYW5nZWQ7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZS50eXBlID09PSBDaGFuZ2VUeXBlLlJlbW92ZSkge1xyXG4gICAgICAgICAgICBldmVudFR5cGUgPSBFdmVudFR5cGUuUmVtb3ZlO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkKSB7XHJcbiAgICAgICAgICAgIC8vIOS4u+ihqOaWsOWinlxyXG4gICAgICAgICAgICBpZiAoY2hhbmdlLmNyZWF0ZSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgIGV2ZW50VHlwZSA9IEV2ZW50VHlwZS5BcHBlbmQ7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgZXZlbnRUeXBlID0gRXZlbnRUeXBlLkxvYWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gZWxzZSBpZiAoY2hhbmdlLnR5cGUgPT09IENoYW5nZVR5cGUuU2VsZWN0aW9uQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICBldmVudFR5cGUgPSBFdmVudFR5cGUuU2VsZWN0aW9uQ2hhbmdlZFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuYnVpbGRFdmVudFBhdGgoY2hhbmdlKTtcclxuICAgICAgICAgIGNvbnN0IG1vZGlmaWNhdGlvbjogRXZlbnRBcmdzID0ge1xyXG4gICAgICAgICAgICBuczogdGhpcy5uYW1lc3BhY2UsXHJcbiAgICAgICAgICAgIHBhdGg6IHBhdGgsXHJcbiAgICAgICAgICAgIHR5cGU6IGV2ZW50VHlwZSxcclxuICAgICAgICAgICAgc291cmNlOiBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhLFxyXG4gICAgICAgICAgICB2YWx1ZTogY2hhbmdlLnZhbHVlLFxyXG4gICAgICAgICAgICBpZDogY2hhbmdlLmlkXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgLy8gY29uc29sZS5sb2coXCJCaW5kaW5nRGF0YUNoYW5nZUxpc3RlbmVyXCIsIG1vZGlmaWNhdGlvbik7XHJcbiAgICAgICAgICB0aGlzLnN1YmplY3QubmV4dChtb2RpZmljYXRpb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYnVpbGRFdmVudFBhdGgoY2hhbmdlOiBDaGFuZ2UpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwYXRoID0gY2hhbmdlLnBhdGg7XHJcbiAgICBjb25zdCBwYXRocyA9IFtdO1xyXG4gICAgLy8gaWYgKCFwYXRoIHx8IHBhdGgubGVuZ3RoIDwgMSkge1xyXG4gICAgLy8gICByZXR1cm4gcGF0aHM7XHJcbiAgICAvLyB9XHJcbiAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSB0aGlzLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudEl0ZW0ucHJpbWFyeUtleVZhbHVlO1xyXG4gICAgaWYgKHByaW1hcnlWYWx1ZSkge1xyXG4gICAgICBpZiAoIShjaGFuZ2UudHlwZSA9PT0gQ2hhbmdlVHlwZS5Mb2FkICYmIGNoYW5nZS5wYXRoLmxlbmd0aCA9PT0gMCkpIHtcclxuICAgICAgICBwYXRocy5wdXNoKGAke3RoaXMuYmluZGluZ0RhdGEubGlzdC5wcmltYXJ5S2V5fToke3ByaW1hcnlWYWx1ZX1gKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3QgY3VycmVudFBhdGggPSBbXTtcclxuICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBwYXRoLmxlbmd0aDsgaW5kZXgrKykge1xyXG4gICAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRoW2luZGV4XTtcclxuICAgICAgY3VycmVudFBhdGgucHVzaChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICBjb25zdCBpdGVtID0gdGhpcy5iaW5kaW5nRGF0YS5nZXRWYWx1ZShjdXJyZW50UGF0aCk7XHJcbiAgICAgIHBhdGhzLnB1c2gocHJvcGVydHlOYW1lKTtcclxuICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBCaW5kaW5nTGlzdCkge1xyXG4gICAgICAgIGlmIChjdXJyZW50UGF0aC5sZW5ndGggPCBwYXRoLmxlbmd0aCkge1xyXG4gICAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSBpdGVtIGFzIEJpbmRpbmdMaXN0O1xyXG4gICAgICAgICAgbGV0IGN1cnJlbnRJZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtLnByaW1hcnlLZXlWYWx1ZTtcclxuICAgICAgICAgIGlmIChpbmRleCA9PT0gcGF0aC5sZW5ndGggLSAyICYmIGNoYW5nZS5pZCkge1xyXG4gICAgICAgICAgICBjdXJyZW50SWQgPSBjaGFuZ2UuaWQ7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBwYXRocy5wdXNoKGAke3RoaXMuYmluZGluZ0RhdGEubGlzdC5wcmltYXJ5S2V5fToke2N1cnJlbnRJZH1gKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBwYXRocztcclxuICB9XHJcbn1cclxuZXhwb3J0IHsgQmluZGluZ0RhdGFDaGFuZ2VMaXN0ZW5lciB9O1xyXG4iXX0=