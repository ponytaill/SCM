import { Injectable, Optional } from '@angular/core';
import { of } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { BefRepositoryUtil } from '@farris/bef';
import { TAB_EVENT } from './types';
import { NavigationService } from './navigation.service';
import { FrameContext, UID } from '@farris/devkit';
import { FormMessageService } from './form-message.service';
import { LanguageService } from './languag.service';
import { CardDataService } from './data-services/card-data.service';
/**
 * 导航中间件服务
 * @scope FrameComponent
 */
// tslint:disable: no-string-literal
var NavigationMiddlewareService = /** @class */ (function () {
    function NavigationMiddlewareService(navigationService, frameContext, msgService, languageService, cardDataService) {
        this.navigationService = navigationService;
        this.frameContext = frameContext;
        this.msgService = msgService;
        this.languageService = languageService;
        this.cardDataService = cardDataService;
        this.repository = frameContext.repository;
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        if (this.frameContext) {
            this.appContext = this.frameContext.getFormAppContext() || null;
        }
    }
    /**
     * 关闭前处理
     */
    NavigationMiddlewareService.prototype.onClosing = function () {
        var _this = this;
        if (this.isInDialog()) {
            return;
        }
        this.navigationService.addEventListener(TAB_EVENT.onTabClosing, function (options) {
            if (_this.isChanged && !_this.appContext.opened) {
                // 如果需要用户确认就切换到当前tab
                if (options && options.beforeCloseHandle && typeof options.beforeCloseHandle === 'function') {
                    options.beforeCloseHandle({ selectedChange: true });
                }
                var conform = _this.msgService.question(_this.languageService['exitWithoutSave']);
                /*记录弹窗已打开*/
                _this.appContext.opened = true;
                return conform.pipe(switchMap(function (result) {
                    _this.appContext.opened = false;
                    if (result) {
                        /*记录用户关闭弹窗*/
                        if (!!_this.cardDataService) {
                            var revert$ = _this.cardDataService.revert(options);
                            return revert$.pipe(switchMap(function () { return of(result); }));
                        }
                    }
                    return of(result);
                }));
            }
            else if (_this.isChanged && _this.appContext.opened) {
                return of(false);
            }
            else {
                return of(true);
            }
        });
    };
    /**
     * 是否在是弹窗窗口内
     */
    NavigationMiddlewareService.prototype.isInDialog = function () {
        var frameContext = this.frameContext;
        var isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'] || false;
        while (frameContext.parent !== null && !isDialogRootComponent) {
            frameContext = frameContext.parent;
            isDialogRootComponent = frameContext.frameComponent['isDialogRootComponent'];
        }
        return isDialogRootComponent;
    };
    /**
     * 获取tabid,如果targetId存在则直接使用targetId
     * @description 将用户要查看的数据id转换为运行框架需要的tabId
     * @param params router参数
     * @param targetId 要编辑/查看的数据id
     */
    NavigationMiddlewareService.prototype.getTabId = function (params, targetId) {
        if (!!targetId) {
            return targetId;
        }
        var paramsObj = null;
        if (!!params && params.startsWith('{') && params.endsWith('}')) {
            paramsObj = JSON.parse(params);
        }
        var paramId = null;
        if (paramsObj && paramsObj.hasOwnProperty('id') && !!paramsObj.id) {
            paramId = paramsObj.id;
        }
        else {
            paramId = UID.create();
        }
        return paramId;
    };
    Object.defineProperty(NavigationMiddlewareService.prototype, "isChanged", {
        /**
         * 是否有未保存的变更
         */
        get: function () {
            var befRepository = this.repository;
            return BefRepositoryUtil.isExistUnsaveData(befRepository);
        },
        enumerable: true,
        configurable: true
    });
    NavigationMiddlewareService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    NavigationMiddlewareService.ctorParameters = function () { return [
        { type: NavigationService },
        { type: FrameContext },
        { type: FormMessageService },
        { type: LanguageService, decorators: [{ type: Optional }] },
        { type: CardDataService }
    ]; };
    return NavigationMiddlewareService;
}());
export { NavigationMiddlewareService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvbmF2aWdhdGlvbi1taWRkbGV3YXJlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDM0MsT0FBTyxFQUFpQixpQkFBaUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUMvRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQWMsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNwRTs7O0dBR0c7QUFDSCxvQ0FBb0M7QUFDcEM7SUFLRSxxQ0FDVSxpQkFBb0MsRUFDcEMsWUFBMEIsRUFDMUIsVUFBOEIsRUFDbEIsZUFBZ0MsRUFDNUMsZUFBZ0M7UUFKaEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFvQjtRQUNsQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDNUMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBRXhDLElBQUksQ0FBQyxVQUFVLEdBQUcsWUFBWSxDQUFDLFVB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O1FBQ0QsSUFBSSxTQUFTLEdBQVEsSUFBSSxDQUFDO1FBQzFCLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDOUQsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDaEM7UUFDRCxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxTQUFTLElBQUksU0FBUyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRTtZQUNqRSxPQUFPLEdBQUcsU0FBUyxDQUFDLEVBQUUsQ0FBQztTQUN4QjthQUFNO1lBQ0wsT0FBTyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztTQUN4QjtRQUNELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFJRCxzQkFBWSxrREFBUztRQUhyQjs7V0FFRzthQUNIO1lBQ0UsSUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQWdDLENBQUM7WUFDNUQsT0FBTyxpQkFBaUIsQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUM1RCxDQUFDOzs7T0FBQTs7Z0JBbEdGLFVBQVU7Ozs7Z0JBVkYsaUJBQWlCO2dCQUNqQixZQUFZO2dCQUNaLGtCQUFrQjtnQkFDbEIsZUFBZSx1QkFnQm5CLFFBQVE7Z0JBZkosZUFBZTs7SUF5R3hCLGtDQUFDO0NBQUEsQUFuR0QsSUFtR0M7U0FsR1ksMkJBQTJCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5LCBCZWZSZXBvc2l0b3J5VXRpbCB9IGZyb20gJ0BmYXJyaXMvYmVmJztcbmltcG9ydCB7IFRBQl9FVkVOVCB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgTmF2aWdhdGlvblNlcnZpY2UgfSBmcm9tICcuL25hdmlnYXRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnksIFVJRCB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IEZvcm1NZXNzYWdlU2VydmljZSB9IGZyb20gJy4vZm9ybS1tZXNzYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ2FyZERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9kYXRhLXNlcnZpY2VzL2NhcmQtZGF0YS5zZXJ2aWNlJztcbi8qKlxuICog5a+86Iiq5Lit6Ze05Lu25pyN5YqhXG4gKiBAc2NvcGUgRnJhbWVDb21wb25lbnRcbiAqL1xuLy8gdHNsaW50OmRpc2FibGU6IG5vLXN0cmluZy1saXRlcmFsXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTmF2aWdhdGlvbk1pZGRsZXdhcmVTZXJ2aWNlIHtcbiAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT47XG5cbiAgcHJpdmF0ZSBhcHBDb250ZXh0OiBhbnk7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbmF2aWdhdGlvblNlcnZpY2U6IE5hdmlnYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXG4gICAgcHJpdmF0ZSBtc2dTZXJ2aWNlOiBGb3JtTWVzc2FnZVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcbiAgICBwcml2YXRlIGNhcmREYXRhU2VydmljZTogQ2FyZERhdGFTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMucmVwb3NpdG9yeSA9IGZyYW1lQ29udGV4dC5yZXBvc2l0b3J5O1xuICAgIGlmICghdGhpcy5sYW5ndWFnZVNlcnZpY2UpIHtcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gTGFuZ3VhZ2VTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgfVxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCkge1xuICAgICAgdGhpcy5hcHBDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0Rm9ybUFwcENvbnRleHQoKSB8fCBudWxsO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog5YWz6Zet5YmN5aSE55CGXG4gICAqL1xuICBwdWJsaWMgb25DbG9zaW5nKCkge1xuICAgIGlmICh0aGlzLmlzSW5EaWFsb2coKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLm5hdmlnYXRpb25TZXJ2aWNlLmFkZEV2ZW50TGlzdGVuZXIoVEFCX0VWRU5ULm9uVGFiQ2xvc2luZywgKG9wdGlvbnMpID0+IHtcbiAgICAgIGlmICh0aGlzLmlzQ2hhbmdlZCAmJiAhdGhpcy5hcHBDb250ZXh0Lm9wZW5lZCkge1xuICAgICAgICAvLyDlpoLmnpzpnIDopoHnlKjmiLfnoa7orqTlsLHliIfmjaLliLDlvZPliY10YWJcbiAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5iZWZvcmVDbG9zZUhhbmRsZSAmJiB0eXBlb2Ygb3B0aW9ucy5iZWZvcmVDbG9zZUhhbmRsZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIG9wdGlvbnMuYmVmb3JlQ2xvc2VIYW5kbGUoeyBzZWxlY3RlZENoYW5nZTogdHJ1ZSB9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjb25mb3JtID0gdGhpcy5tc2dTZXJ2aWNlLnF1ZXN0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydleGl0V2l0aG91dFNhdmUnXSk7XG4gICAgICAgIC8q6K6w5b2V5by556qX5bey5omT5byAKi9cbiAgICAgICAgdGhpcy5hcHBDb250ZXh0Lm9wZW5lZCA9IHRydWU7XG4gICAgICAgIHJldHVybiBjb25mb3JtLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChyZXN1bHQ6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgICAgIHRoaXMuYXBwQ29udGV4dC5vcGVuZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgLyrorrDlvZXnlKjmiLflhbPpl63lvLnnqpcqL1xuICAgICAgICAgICAgICBpZiAoISF0aGlzLmNhcmREYXRhU2VydmljZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJldmVydCQgPSB0aGlzLmNhcmREYXRhU2VydmljZS5yZXZlcnQob3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJldmVydCQucGlwZShcbiAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiBvZihyZXN1bHQpKVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBvZihyZXN1bHQpO1xuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuaXNDaGFuZ2VkICYmIHRoaXMuYXBwQ29udGV4dC5vcGVuZWQpIHtcbiAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICAvKipcbiAgICog5piv5ZCm5Zyo5piv5by556qX56qX5Y+j5YaFXG4gICAqL1xuICBwcml2YXRlIGlzSW5EaWFsb2coKSB7XG4gICAgbGV0IGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0O1xuICAgIGxldCBpc0RpYWxvZ1Jvb3RDb21wb25lbnQgPSBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddIHx8IGZhbHNlO1xuICAgIHdoaWxlIChmcmFtZUNvbnRleHQucGFyZW50ICE9PSBudWxsICYmICFpc0RpYWxvZ1Jvb3RDb21wb25lbnQpIHtcbiAgICAgIGZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dC5wYXJlbnQ7XG4gICAgICBpc0RpYWxvZ1Jvb3RDb21wb25lbnQgPSBmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2lzRGlhbG9nUm9vdENvbXBvbmVudCddO1xuICAgIH1cbiAgICByZXR1cm4gaXNEaWFsb2dSb290Q29tcG9uZW50O1xuICB9XG4gIC8qKlxuICAgKiDojrflj5Z0YWJpZCzlpoLmnpx0YXJnZXRJZOWtmOWcqOWImeebtOaOpeS9v+eUqHRhcmdldElkXG4gICAqIEBkZXNjcmlwdGlvbiDlsIbnlKjmiLfopoHmn6XnnIvnmoTmlbDmja5pZOi9rOaNouS4uui/kOihjOahhuaetumcgOimgeeahHRhYklkXG4gICAqIEBwYXJhbSBwYXJhbXMgcm91dGVy5Y+C5pWwXG4gICAqIEBwYXJhbSB0YXJnZXRJZCDopoHnvJbovpEv5p+l55yL55qE5pWw5o2uaWRcbiAgICovXG4gIHB1YmxpYyBnZXRUYWJJZChwYXJhbXM6IHN0cmluZywgdGFyZ2V0SWQ6IHN0cmluZyk6IGFueSB7XG4gICAgaWYgKCEhdGFyZ2V0SWQpIHtcbiAgICAgIHJldHVybiB0YXJnZXRJZDtcbiAgICB9XG4gICAgbGV0IHBhcmFtc09iajogYW55ID0gbnVsbDtcbiAgICBpZiAoISFwYXJhbXMgJiYgcGFyYW1zLnN0YXJ0c1dpdGgoJ3snKSAmJiBwYXJhbXMuZW5kc1dpdGgoJ30nKSkge1xuICAgICAgcGFyYW1zT2JqID0gSlNPTi5wYXJzZShwYXJhbXMpO1xuICAgIH1cbiAgICBsZXQgcGFyYW1JZCA9IG51bGw7XG4gICAgaWYgKHBhcmFtc09iaiAmJiBwYXJhbXNPYmouaGFzT3duUHJvcGVydHkoJ2lkJykgJiYgISFwYXJhbXNPYmouaWQpIHtcbiAgICAgIHBhcmFtSWQgPSBwYXJhbXNPYmouaWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtSWQgPSBVSUQuY3JlYXRlKCk7XG4gICAgfVxuICAgIHJldHVybiBwYXJhbUlkO1xuICB9XG4gIC8qKlxuICAgKiDmmK/lkKbmnInmnKrkv53lrZjnmoTlj5jmm7RcbiAgICovXG4gIHByaXZhdGUgZ2V0IGlzQ2hhbmdlZCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICByZXR1cm4gQmVmUmVwb3NpdG9yeVV0aWwuaXNFeGlzdFVuc2F2ZURhdGEoYmVmUmVwb3NpdG9yeSk7XG4gIH1cbn1cbiJdfQ==