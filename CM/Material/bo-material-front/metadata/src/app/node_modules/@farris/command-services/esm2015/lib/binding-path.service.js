import { Injectable, Injector } from "@angular/core";
import { AppContext, Repository } from "@farris/devkit";
export class BindingPathService {
    constructor(injector, appContext, repository) {
        this.injector = injector;
        this.appContext = appContext;
        this.repository = repository;
    }
    /**
     * 获取组件上下文的绑定路径
     * @param frameContext 组件上下文
     * @returns
     */
    getBindingPathsByFrameContext(frameContext) {
        return frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath && frameContext.viewModel.bindingPath.split('/').filter(p => p) || null;
    }
    /**
     * 通过BE表名获取bindingPath
     * @param dataTypeInfo
     * @param tableName
     * @param paths
     * @param level
     * @returns
     */
    getBindingPathsByTableName(dataTypeInfo, tableName, paths = [], level = 0) {
        level++;
        if (dataTypeInfo.entityInfo && (dataTypeInfo.entityInfo.nodeCode === tableName || dataTypeInfo.entityInfo.originalCode === tableName)) {
            if (level !== 1) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
            }
            return paths;
        }
        const props = Array.from(dataTypeInfo.propInfoMap.values()).filter(p => p.typeInfo);
        if (props.length < 1) {
            paths = [];
            return paths;
        }
        if (dataTypeInfo.entityInfo) {
            if (level !== 1) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
            }
        }
        for (let idx = 0; idx < props.length; idx++) {
            const dataTypeInfo = props[idx].typeInfo;
            const path = this.getBindingPathsByTableName(dataTypeInfo, tableName, paths, level);
            if (!path || path.length < 1) {
                continue;
            }
            else {
                paths = paths.concat(path);
                return paths;
            }
        }
        return null;
    }
    /**
     * 获取属性路径中的绑定路径
     * @param paths paths
     * @param entityTypeInfo
     * @returns
     */
    getBindingPathsByPath(paths, entityTypeInfo) {
        let nodeCodes = [];
        if (typeof paths === 'string') {
            paths = paths.split('/').filter(p => p);
        }
        paths = paths.concat([]);
        while (paths.length > 0) {
            const dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    }
    /**
     * 获取属性路径信息
     * @param path 属性路径
     * @returns
     */
    getPathInfo(path) {
        const paths = path.split('/').filter(p => p);
        // 获取最大实体层级，其余为属性（简单属性、udt、关联、关联嵌套关联）
        const entityPath = this.getBindingPathsByPath(paths, this.repository.entityTypeInfo);
        const propertyName = paths.slice(entityPath.length).join('/');
        return { bindingPath: entityPath.join('/'), propertyName, bindingPaths: entityPath, propertyNames: propertyName.split('/').filter(p => p) };
    }
}
BindingPathService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BindingPathService.ctorParameters = () => [
    { type: Injector },
    { type: AppContext },
    { type: Repository }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZy1wYXRoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1wYXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBc0MsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHNUYsTUFBTSxPQUFPLGtCQUFrQjtJQUM3QixZQUFvQixRQUFrQixFQUFVLFVBQXNCLEVBQVUsVUFBOEI7UUFBMUYsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUFVLGVBQVUsR0FBVixVQUFVLENBQVk7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFvQjtJQUFJLENBQUM7SUFDbkg7Ozs7T0FJRztJQUNJLDZCQUE2QixDQUFDLFlBQTBCO1FBQzdELE9BQU8sWUFBWSxJQUFJLFlBQVksQ0FBQyxTQUFTLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztJQUM5SixDQUFDO0lBQ0Q7Ozs7Ozs7T0FPRztJQUNJLDBCQUEwQixDQUFDLFlBQTBCLEVBQUUsU0FBaUIsRUFBRSxRQUFrQixFQUFFLEVBQUUsUUFBZ0IsQ0FBQztRQUN0SCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksWUFBWSxDQUFDLFVBQVUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsUUFBUSxLQUFLLFNBQVMsSUFBSSxZQUFZLENBQUMsVUFBVSxDQUFDLFlBQVksS0FBSyxTQUFTLENBQUMsRUFBRTtZQUNySSxJQUFJLEtBQUssS0FBSyxDQUFDLEVBQUU7Z0JBQ2Ys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LEVBQUUsWUFBWSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzlJLENBQUM7OztZQW5GRixVQUFVOzs7O1lBSFUsUUFBUTtZQUNwQixVQUFVO1lBQXNDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBBcHBDb250ZXh0LCBEYXRhVHlwZUluZm8sIEVudGl0eSwgRnJhbWVDb250ZXh0LCBSZXBvc2l0b3J5IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCaW5kaW5nUGF0aFNlcnZpY2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBhcHBDb250ZXh0OiBBcHBDb250ZXh0LCBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW50aXR5PikgeyB9XG4gIC8qKlxuICAgKiDojrflj5bnu4Tku7bkuIrkuIvmlofnmoTnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIGZyYW1lQ29udGV4dCDnu4Tku7bkuIrkuIvmlodcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0QmluZGluZ1BhdGhzQnlGcmFtZUNvbnRleHQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApIHx8IG51bGw7XG4gIH1cbiAgLyoqXG4gICAqIOmAmui/h0JF6KGo5ZCN6I635Y+WYmluZGluZ1BhdGhcbiAgICogQHBhcmFtIGRhdGFUeXBlSW5mbyBcbiAgICogQHBhcmFtIHRhYmxlTmFtZSBcbiAgICogQHBhcmFtIHBhdGhzIFxuICAgKiBAcGFyYW0gbGV2ZWxcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgZ2V0QmluZGluZ1BhdGhzQnlUYWJsZU5hbWUoZGF0YVR5cGVJbmZvOiBEYXRhVHlwZUluZm8sIHRhYmxlTmFtZTogc3RyaW5nLCBwYXRoczogc3RyaW5nW10gPSBbXSwgbGV2ZWw6IG51bWJlciA9IDApOiBzdHJpbmdbXSB7XG4gICAgbGV2ZWwrKztcbiAgICBpZiAoZGF0YVR5cGVJbmZvLmVudGl0eUluZm8gJiYgKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlID09PSB0YWJsZU5hbWUgfHwgZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ub3JpZ2luYWxDb2RlID09PSB0YWJsZU5hbWUpKSB7XG4gICAgICBpZiAobGV2ZWwgIT09IDEpIHtcbiAgICAgICAgcGF0aHMucHVzaChkYXRhVHlwZUluZm8uZW50aXR5SW5mby5ub2RlQ29kZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcGF0aHM7XG4gICAgfVxuICAgIGNvbnN0IHByb3BzID0gQXJyYXkuZnJvbShkYXRhVHlwZUluZm8ucHJvcEluZm9NYXAudmFsdWVzKCkpLmZpbHRlcihwID0+IHAudHlwZUluZm8pO1xuICAgIGlmIChwcm9wcy5sZW5ndGggPCAxKSB7XG4gICAgICBwYXRocyA9IFtdO1xuICAgICAgcmV0dXJuIHBhdGhzO1xuICAgIH1cbiAgICBpZiAoZGF0YVR5cGVJbmZvLmVudGl0eUluZm8pIHtcbiAgICAgIGlmIChsZXZlbCAhPT0gMSkge1xuICAgICAgICBwYXRocy5wdXNoKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmb3IgKGxldCBpZHggPSAwOyBpZHggPCBwcm9wcy5sZW5ndGg7IGlkeCsrKSB7XG4gICAgICBjb25zdCBkYXRhVHlwZUluZm8gPSBwcm9wc1tpZHhdLnR5cGVJbmZvO1xuICAgICAgY29uc3QgcGF0aCA9IHRoaXMuZ2V0QmluZGluZ1BhdGhzQnlUYWJsZU5hbWUoZGF0YVR5cGVJbmZvLCB0YWJsZU5hbWUsIHBhdGhzLCBsZXZlbCk7XG4gICAgICBpZiAoIXBhdGggfHwgcGF0aC5sZW5ndGggPCAxKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcGF0aHMgPSBwYXRocy5jb25jYXQocGF0aCk7XG4gICAgICAgIHJldHVybiBwYXRocztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgLyoqXG4gICAqIOiOt+WPluWxnuaAp+i3r+W+hOS4reeahOe7keWumui3r+W+hFxuICAgKiBAcGFyYW0gcGF0aHMgcGF0aHNcbiAgICogQHBhcmFtIGVudGl0eVR5cGVJbmZvIFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRCaW5kaW5nUGF0aHNCeVBhdGgocGF0aHM6IHN0cmluZ1tdIHwgc3RyaW5nLCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10ge1xuICAgIGxldCBub2RlQ29kZXMgPSBbXTtcbiAgICBpZiAodHlwZW9mIHBhdGhzID09PSAnc3RyaW5nJykge1xuICAgICAgcGF0aHMgPSBwYXRocy5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIH1cbiAgICBwYXRocyA9IHBhdGhzLmNvbmNhdChbXSk7XG4gICAgd2hpbGUgKHBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGRhdGFQcm9wSW5mbyA9IGVudGl0eVR5cGVJbmZvLmdldFByb3BJbmZvQnlQYXRoKHBhdGhzKTtcbiAgICAgIGlmIChkYXRhUHJvcEluZm8uZ3JvdXAgPT09ICdMaXN0Jykge1xuICAgICAgICBub2RlQ29kZXMgPSBwYXRocztcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBwYXRocy5wb3AoKTtcbiAgICB9XG4gICAgcmV0dXJuIG5vZGVDb2RlcztcbiAgfVxuICAvKipcbiAgICog6I635Y+W5bGe5oCn6Lev5b6E5L+h5oGvXG4gICAqIEBwYXJhbSBwYXRoIOWxnuaAp+i3r+W+hFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRQYXRoSW5mbyhwYXRoOiBzdHJpbmcpOiB7IGJpbmRpbmdQYXRoOiBzdHJpbmcsIHByb3BlcnR5TmFtZTogc3RyaW5nLCBiaW5kaW5nUGF0aHM6IHN0cmluZ1tdLCBwcm9wZXJ0eU5hbWVzOiBzdHJpbmdbXSB9IHtcbiAgICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAvLyDojrflj5bmnIDlpKflrp7kvZPlsYLnuqfvvIzlhbbkvZnkuLrlsZ7mgKfvvIjnroDljZXlsZ7mgKfjgIF1ZHTjgIHlhbPogZTjgIHlhbPogZTltYzlpZflhbPogZTvvIlcbiAgICBjb25zdCBlbnRpdHlQYXRoID0gdGhpcy5nZXRCaW5kaW5nUGF0aHNCeVBhdGgocGF0aHMsIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mbyk7XG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gcGF0aHMuc2xpY2UoZW50aXR5UGF0aC5sZW5ndGgpLmpvaW4oJy8nKTtcbiAgICByZXR1cm4geyBiaW5kaW5nUGF0aDogZW50aXR5UGF0aC5qb2luKCcvJyksIHByb3BlcnR5TmFtZSwgYmluZGluZ1BhdGhzOiBlbnRpdHlQYXRoLCBwcm9wZXJ0eU5hbWVzOiBwcm9wZXJ0eU5hbWUuc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKSB9O1xuICB9XG59Il19