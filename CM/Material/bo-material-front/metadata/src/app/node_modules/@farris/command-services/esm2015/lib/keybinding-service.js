import { Injectable } from '@angular/core';
import * as Mousetrap from 'mousetrap';
/**
 * 快捷键服务
 * @scope FormModule
 */
export class KeybindingService {
    constructor() {
        this.keyMap = new Map();
        this.bindingProvider = Mousetrap.default;
        this.ready = true;
    }
    /**
     * 对视图模型设置的快捷键进行绑定处理
     * @param viewModel 视图模型
     */
    bind(viewModel) {
        viewModel.keybindingMap.forEach((keyBinding, method) => {
            this.register(keyBinding, () => {
                return viewModel[method]();
            });
        });
    }
    /**
     * 注册快捷键
     * @param binding 键盘绑定信息
     * @param handler 响应事件
     */
    register(binding, handler) {
        var combo = this._getCombo(binding);
        if (combo) {
            this.keyMap.set(combo, handler);
            if (binding.ctrlKey && binding.altKey && !binding.shiftKey) {
                // 实际发现，ctrl+alt组合，只能触发keyup事件
                this.bindingProvider.bind(combo, this._dispatch.bind(this), 'keyup');
            }
            else {
                this.bindingProvider.bind(combo, this._dispatch.bind(this));
            }
        }
    }
    /**
     * 取消快捷键注册
     * @param binding 键盘绑定信息
     */
    unregister(binding) {
        var combo = this._getCombo(binding);
        if (combo) {
            this.keyMap.delete(combo);
            this.bindingProvider.unbind(combo);
        }
    }
    _dispatch(e) {
        if (e.repeat)
            return false;
        if (this.ready) {
            var combo = this._getCombo(e);
            if (combo && this.keyMap.has(combo)) {
                this.ready = false;
                this.keyMap.get(combo)().subscribe(() => {
                    this.ready = true;
                }, (error) => {
                    this.ready = true;
                }, () => {
                    this.ready = true;
                });
            }
        }
        return false;
    }
    /**
     * 返回ctrl+shift+alt+a形式的组合字符串，全部为小写
     * @param keyInfo
     */
    _getCombo(keyInfo) {
        var key = keyInfo.key.toLowerCase();
        if (key.length != 1 || key.charCodeAt(0) < 97 /* a */ || key.charCodeAt(0) > 122 /* z */) {
            console.warn("快捷键字母形式为a-z");
            return null;
        }
        var combo = (keyInfo.ctrlKey ? 'ctrl+' : '')
            + (keyInfo.shiftKey ? 'shift+' : '')
            + (keyInfo.altKey ? 'alt+' : '')
            + (keyInfo.metaKey ? 'meta+' : '')
            + key;
        if (combo.length == 1) {
            console.warn("快捷键至少包含一个Modifier键");
            return null;
        }
        return combo;
    }
}
KeybindingService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
KeybindingService.ctorParameters = () => [];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5YmluZGluZy1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2tleWJpbmRpbmctc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sS0FBSyxTQUFTLE1BQU0sV0FBVyxDQUFDO0FBdUV2Qzs7O0dBR0c7QUFFSCxNQUFNLE9BQU8saUJBQWlCO0lBSzVCO1FBQ0UsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBaUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsZUFBZSxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDcEIsQ0FBQztJQUVEOzs7T0FHRztJQUNJLElBQUksQ0FBQyxTQUFvQjtRQUM5QixTQUFTLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFVBQVUsRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyRCxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUU7Z0JBQzdCLE9BQU8sU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDN0IsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRjs7OztPQUlHO0lBQ0ssUUFBUSxDQUFDLE9BQW1CLEVBQUUsT0FBOEI7UUFDakUsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNwQyxJQUFJLEtBQUssRUFBRTtZQUNULElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztZQUNoQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFR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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBLZXliaW5kaW5nLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCdcbmltcG9ydCAqIGFzIE1vdXNldHJhcCBmcm9tICdtb3VzZXRyYXAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuXG5jb25zdCBlbnVtIENoYXJDb2RlIHtcblxuICBEaWdpdDAgPSA0OCxcbiAgRGlnaXQxID0gNDksXG4gIERpZ2l0MiA9IDUwLFxuICBEaWdpdDMgPSA1MSxcbiAgRGlnaXQ0ID0gNTIsXG4gIERpZ2l0NSA9IDUzLFxuICBEaWdpdDYgPSA1NCxcbiAgRGlnaXQ3ID0gNTUsXG4gIERpZ2l0OCA9IDU2LFxuICBEaWdpdDkgPSA1NyxcblxuICBBID0gNjUsXG4gIEIgPSA2NixcbiAgQyA9IDY3LFxuICBEID0gNjgsXG4gIEUgPSA2OSxcbiAgRiA9IDcwLFxuICBHID0gNzEsXG4gIEggPSA3MixcbiAgSSA9IDczLFxuICBKID0gNzQsXG4gIEsgPSA3NSxcbiAgTCA9IDc2LFxuICBNID0gNzcsXG4gIE4gPSA3OCxcbiAgTyA9IDc5LFxuICBQID0gODAsXG4gIFEgPSA4MSxcbiAgUiA9IDgyLFxuICBTID0gODMsXG4gIFQgPSA4NCxcbiAgVSA9IDg1LFxuICBWID0gODYsXG4gIFcgPSA4NyxcbiAgWCA9IDg4LFxuICBZID0gODksXG4gIFogPSA5MCxcblxuICBhID0gOTcsXG4gIGIgPSA5OCxcbiAgYyA9IDk5LFxuICBkID0gMTAwLFxuICBlID0gMTAxLFxuICBmID0gMTAyLFxuICBnID0gMTAzLFxuICBoID0gMTA0LFxuICBpID0gMTA1LFxuICBqID0gMTA2LFxuICBrID0gMTA3LFxuICBsID0gMTA4LFxuICBtID0gMTA5LFxuICBuID0gMTEwLFxuICBvID0gMTExLFxuICBwID0gMTEyLFxuICBxID0gMTEzLFxuICByID0gMTE0LFxuICBzID0gMTE1LFxuICB0ID0gMTE2LFxuICB1ID0gMTE3LFxuICB2ID0gMTE4LFxuICB3ID0gMTE5LFxuICB4ID0gMTIwLFxuICB5ID0gMTIxLFxuICB6ID0gMTIyXG59XG5cbi8qKlxuICog5b+r5o236ZSu5pyN5YqhXG4gKiBAc2NvcGUgRm9ybU1vZHVsZVxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgS2V5YmluZGluZ1NlcnZpY2Uge1xuICBwcml2YXRlIGtleU1hcDogTWFwPFN0cmluZywgKCkgPT4gT2JzZXJ2YWJsZTxhbnk+PjtcbiAgcHJpdmF0ZSBiaW5kaW5nUHJvdmlkZXI6IE1vdXNldHJhcDtcbiAgcHJpdmF0ZSByZWFkeTogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmtleU1hcCA9IG5ldyBNYXA8U3RyaW5nLCAoKSA9PiBPYnNlcnZhYmxlPGFueT4+KCk7XG4gICAgdGhpcy5iaW5kaW5nUHJvdmlkZXIgPSBNb3VzZXRyYXAuZGVmYXVsdDtcbiAgICB0aGlzLnJlYWR5ID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiDlr7nop4blm77mqKHlnovorr7nva7nmoTlv6vmjbfplK7ov5vooYznu5HlrprlpITnkIZcbiAgICogQHBhcmFtIHZpZXdNb2RlbCDop4blm77mqKHlnotcbiAgICovXG4gIHB1YmxpYyBiaW5kKHZpZXdNb2RlbDogVmlld01vZGVsKSB7XG4gICAgdmlld01vZGVsLmtleWJpbmRpbmdNYXAuZm9yRWFjaCgoa2V5QmluZGluZywgbWV0aG9kKSA9PiB7XG4gICAgICB0aGlzLnJlZ2lzdGVyKGtleUJpbmRpbmcsICgpID0+IHtcbiAgICAgICAgcmV0dXJuIHZpZXdNb2RlbFttZXRob2RdKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG5cdC8qKlxuXHQgKiDms6jlhozlv6vmjbfplK5cblx0ICogQHBhcmFtIGJpbmRpbmcg6ZSu55uY57uR5a6a5L+h5oGvXG5cdCAqIEBwYXJhbSBoYW5kbGVyIOWTjeW6lOS6i+S7tlxuXHQgKi9cbiAgcHVibGljIHJlZ2lzdGVyKGJpbmRpbmc6IEtleWJpbmRpbmcsIGhhbmRsZXI6ICgpID0+IE9ic2VydmFibGU8YW55Pikge1xuICAgIHZhciBjb21ibyA9IHRoaXMuX2dldENvbWJvKGJpbmRpbmcpO1xuICAgIGlmIChjb21ibykge1xuICAgICAgdGhpcy5rZXlNYXAuc2V0KGNvbWJvLCBoYW5kbGVyKTtcbiAgICAgIGlmIChiaW5kaW5nLmN0cmxLZXkgJiYgYmluZGluZy5hbHRLZXkgJiYgIWJpbmRpbmcuc2hpZnRLZXkpIHtcbiAgICAgICAgLy8g5a6e6ZmF5Y+R546w77yMY3RybCthbHTnu4TlkIjvvIzlj6rog73op6blj5FrZXl1cOS6i+S7tlxuICAgICAgICB0aGlzLmJpbmRpbmdQcm92aWRlci5iaW5kKGNvbWJvLCB0aGlzLl9kaXNwYXRjaC5iaW5kKHRoaXMpLCAna2V5dXAnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYmluZGluZ1Byb3ZpZGVyLmJpbmQoY29tYm8sIHRoaXMuX2Rpc3BhdGNoLmJpbmQodGhpcykpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDlj5bmtojlv6vmjbfplK7ms6jlhoxcbiAgICogQHBhcmFtIGJpbmRpbmcg6ZSu55uY57uR5a6a5L+h5oGvIFxuICAgKi9cbiAgcHVibGljIHVucmVnaXN0ZXIoYmluZGluZzogS2V5YmluZGluZykge1xuICAgIHZhciBjb21ibyA9IHRoaXMuX2dldENvbWJvKGJpbmRpbmcpO1xuICAgIGlmIChjb21ibykge1xuICAgICAgdGhpcy5rZXlNYXAuZGVsZXRlKGNvbWJvKTtcbiAgICAgIHRoaXMuYmluZGluZ1Byb3ZpZGVyLnVuYmluZChjb21ibyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfZGlzcGF0Y2goZTogS2V5Ym9hcmRFdmVudCk6IGJvb2xlYW4ge1xuICAgIGlmIChlLnJlcGVhdCkgcmV0dXJuIGZhbHNlO1xuICAgIGlmICh0aGlzLnJlYWR5KSB7XG4gICAgICB2YXIgY29tYm8gPSB0aGlzLl9nZXRDb21ibyhlKTtcbiAgICAgIGlmIChjb21ibyAmJiB0aGlzLmtleU1hcC5oYXMoY29tYm8pKSB7XG4gICAgICAgIHRoaXMucmVhZHkgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5rZXlNYXAuZ2V0KGNvbWJvKSgpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgIHRoaXMucmVhZHkgPSB0cnVlO1xuICAgICAgICB9LCAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZWFkeSA9IHRydWU7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuXHQvKipcblx0ICog6L+U5ZueY3RybCtzaGlmdCthbHQrYeW9ouW8j+eahOe7hOWQiOWtl+espuS4su+8jOWFqOmDqOS4uuWwj+WGmVxuXHQgKiBAcGFyYW0ga2V5SW5mbyBcblx0ICovXG4gIHByaXZhdGUgX2dldENvbWJvKGtleUluZm86IEtleWJpbmRpbmcgfCBLZXlib2FyZEV2ZW50KTogU3RyaW5nIHwgbnVsbCB7XG4gICAgdmFyIGtleSA9IGtleUluZm8ua2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKGtleS5sZW5ndGggIT0gMSB8fCBrZXkuY2hhckNvZGVBdCgwKSA8IENoYXJDb2RlLmEgfHwga2V5LmNoYXJDb2RlQXQoMCkgPiBDaGFyQ29kZS56KSB7XG4gICAgICBjb25zb2xlLndhcm4oXCLlv6vmjbfplK7lrZfmr43lvaLlvI/kuLphLXpcIik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgdmFyIGNvbWJvID0gKGtleUluZm8uY3RybEtleSA/ICdjdHJsKycgOiAnJylcbiAgICAgICsgKGtleUluZm8uc2hpZnRLZXkgPyAnc2hpZnQrJyA6ICcnKVxuICAgICAgKyAoa2V5SW5mby5hbHRLZXkgPyAnYWx0KycgOiAnJylcbiAgICAgICsgKGtleUluZm8ubWV0YUtleSA/ICdtZXRhKycgOiAnJylcbiAgICAgICsga2V5O1xuXG4gICAgaWYgKGNvbWJvLmxlbmd0aCA9PSAxKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCLlv6vmjbfplK7oh7PlsJHljIXlkKvkuIDkuKpNb2RpZmllcumUrlwiKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBjb21ibztcbiAgfVxufSJdfQ==