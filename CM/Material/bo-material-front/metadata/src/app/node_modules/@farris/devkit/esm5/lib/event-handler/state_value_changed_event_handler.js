import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { EffectorManager } from "../effector/effector_manager";
import { Expression } from "../expression/index";
import { STATE_TEMPLATE } from "../resolver/index";
import { EventHandler } from "./event_handler";
var StateValueChangedEventHandler = /** @class */ (function (_super) {
    tslib_1.__extends(StateValueChangedEventHandler, _super);
    function StateValueChangedEventHandler() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 获取相关表达式
     * @param event event
     */
    StateValueChangedEventHandler.prototype.filter = function (event) {
        var _this = this;
        if (this.expressionObjects && this.expressionObjects.length > 0) {
            return this.expressionObjects.filter(function (expressionObject) {
                var deps = expressionObject.deps;
                if (!deps || deps.length < 1 || event.ns !== expressionObject.ns) {
                    return false;
                }
                var changePaths = _this.cleanEventPath(event.path);
                changePaths.splice(0, 0, STATE_TEMPLATE);
                var eventPath = changePaths.join('/');
                if (deps.includes(eventPath)) {
                    return true;
                }
                else {
                    return false;
                }
            });
        }
        return null;
    };
    /**
     * 发布事件
     * @param event event
     */
    StateValueChangedEventHandler.prototype.dispatch = function (event) {
        var _this = this;
        var expressions = this.filter(event);
        if (expressions && expressions.length > 0) {
            expressions.forEach(function (expressionObject) {
                // const entityContext = this.buildEntityContext(event, expressionObject);
                var context = _this.buildContext(expressionObject, event);
                var result = _this.perform(expressionObject, context);
                if (result === undefined && !_this.isValidateOrRequiredExpression(expressionObject)) {
                    return;
                }
                expressionObject.result = _this.convertBooleanTypeExpressionResult(expressionObject, result);
                ;
                if (expressionObject.id) {
                    _this.expressionResult.set(expressionObject.id, expressionObject.result);
                }
                _this.effect(event, expressionObject);
            });
        }
    };
    /**
     * 副作用
     * @param event event
     * @param expressionObject expressionObject
     */
    StateValueChangedEventHandler.prototype.effect = function (event, expressionObject) {
        var _this = this;
        var effector = this.effectorFactory.getEffector(expressionObject);
        var bindingType = expressionObject.bindingType;
        if (!effector) {
            return;
        }
        if (bindingType === Expression.ExpressionBindingType.State) {
            // 如果表达式作用于uistate
            effector.effect(expressionObject.path, expressionObject.result, { message: expressionObject.message });
        }
        else if (bindingType === Expression.ExpressionBindingType.Field) {
            // 表达式作用于实体属性
            var expressionPathInfo = this.getPathInfo(expressionObject.path);
            var bindingPaths = expressionPathInfo.paths;
            var entities = this.repository.entityCollection.getAllEntities();
            if (!entities || entities.length < 1 || expressionObject.type === Expression.ExpressionType.Visible) {
                effector.effect(expressionObject.path, expressionObject.result, { message: expressionObject.message });
            }
            else {
                this.effectRows(entities, bindingPaths, expressionPathInfo.propertyNames, function (currentRows, paths) {
                    _this.output(event, expressionObject, currentRows, effector, [paths]);
                });
            }
        }
    };
    StateValueChangedEventHandler.prototype.output = function (event, expressionObject, currentRows, effector, paths) {
        var context = this.buildContext(expressionObject, event, null, currentRows);
        var value = this.perform(expressionObject, context);
        if (value === undefined) {
            return;
        }
        expressionObject.result = value;
        if (expressionObject.id) {
            this.expressionResult.set(expressionObject.id, expressionObject.result);
        }
        EffectorManager.effect(effector, expressionObject, paths);
    };
    StateValueChangedEventHandler.prototype.effectRows = function (entities, bindingPaths, propertyNames, callback, currentRows, prevPaths, paths) {
        var _this = this;
        if (currentRows === void 0) { currentRows = []; }
        if (prevPaths === void 0) { prevPaths = []; }
        if (paths === void 0) { paths = []; }
        if (!bindingPaths || bindingPaths.length < 1) {
            entities.forEach(function (entity) {
                if (!entity || !entity.primaryValue) {
                    return;
                }
                var currentPaths = paths.concat([entity.primaryValue]).concat(propertyNames);
                var currentCurrentRows = currentRows.concat([{ bindingPath: prevPaths.join('/') || '/', primaryValue: entity.primaryValue }]);
                callback(currentCurrentRows, currentPaths);
            });
            currentRows.length = 0;
            paths.length = 0;
        }
        else {
            var flag_1 = false;
            var nextPrevPaths_1 = prevPaths;
            entities.forEach(function (entity) {
                var prop = bindingPaths[0];
                var entityList = entity[prop];
                if (!entityList || entityList.count() < 1) {
                    // 下级表没有数据
                    return;
                }
                currentRows.push({ bindingPath: prevPaths.join('/') || '/', primaryValue: entity.primaryValue });
                paths.push(entity.primaryValue);
                paths.push(prop);
                if (flag_1 === false) {
                    flag_1 = true;
                    nextPrevPaths_1.push(prop);
                }
                var nextBindingPaths = bindingPaths.slice(1);
                _this.effectRows(entityList.items, nextBindingPaths, propertyNames, callback, currentRows, nextPrevPaths_1, paths);
            });
        }
    };
    /**
     * 获取子表事件行
     * @param paths
     * @param event
     * @returns
     */
    StateValueChangedEventHandler.prototype.getCurrentRowByEvent = function (paths, event) {
        return this.getCurrentRowByPaths(paths);
    };
    StateValueChangedEventHandler.decorators = [
        { type: Injectable }
    ];
    return StateValueChangedEventHandler;
}(EventHandler));
export { StateValueChangedEventHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGVfdmFsdWVfY2hhbmdlZF9ldmVudF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZXZlbnQtaGFuZGxlci9zdGF0ZV92YWx1ZV9jaGFuZ2VkX2V2ZW50X2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRS9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNqRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRS9DO0lBQ21ELHlEQUFZO0lBRC9EOztJQW1JQSxDQUFDO0lBaElDOzs7T0FHRztJQUNJLDhDQUFNLEdBQWIsVUFBYyxLQUEyQjtRQUF6QyxpQkFrQkM7UUFqQkMsSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDL0QsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLFVBQUMsZ0JBQTZDO2dCQUNqRixJQUFNLElBQUksR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7Z0JBQ25DLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUUsS0FBSyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUU7b0JBQ2hFLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELElBQU0sV0FBVyxHQUFHLEtBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwRCxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEVB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QUFFO29CQUN6QyxVQUFVO29CQUNWLE9BQU87aUJBQ1I7Z0JBQ0QsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLFdBQVcsRUFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsRUFBRSxZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7Z0JBQ2pHLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUNoQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNqQixJQUFJLE1BQUksS0FBSyxLQUFLLEVBQUU7b0JBQ2xCLE1BQUksR0FBRyxJQUFJLENBQUM7b0JBQ1osZUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDMUI7Z0JBQ0QsSUFBTSxnQkFBZ0IsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMvQyxLQUFJLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsZUFBYSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2xILENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSw0REFBb0IsR0FBM0IsVUFBNEIsS0FBZSxFQUFFLEtBQTJCO1FBQ3RFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzFDLENBQUM7O2dCQWxJRixVQUFVOztJQW1JWCxvQ0FBQztDQUFBLEFBbklELENBQ21ELFlBQVksR0FrSTlEO1NBbElZLDZCQUE2QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBFZmZlY3Rvck1hbmFnZXIgfSBmcm9tIFwiLi4vZWZmZWN0b3IvZWZmZWN0b3JfbWFuYWdlclwiO1xyXG5pbXBvcnQgeyBFbnRpdHksIEVudGl0eUxpc3QgfSBmcm9tIFwiLi4vZW50aXR5L2luZGV4XCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tIFwiLi4vZXhwcmVzc2lvbi9pbmRleFwiO1xyXG5pbXBvcnQgeyBTVEFURV9URU1QTEFURSB9IGZyb20gXCIuLi9yZXNvbHZlci9pbmRleFwiO1xyXG5pbXBvcnQgeyBFdmVudEhhbmRsZXIgfSBmcm9tIFwiLi9ldmVudF9oYW5kbGVyXCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBTdGF0ZVZhbHVlQ2hhbmdlZEV2ZW50SGFuZGxlciBleHRlbmRzIEV2ZW50SGFuZGxlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluebuOWFs+ihqOi+vuW8j1xyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqL1xyXG4gIHB1YmxpYyBmaWx0ZXIoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICBpZiAodGhpcy5leHByZXNzaW9uT2JqZWN0cyAmJiB0aGlzLmV4cHJlc3Npb25PYmplY3RzLmxlbmd0aCA+IDApIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMuZmlsdGVyKChleHByZXNzaW9uT2JqZWN0OiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3QpID0+IHtcclxuICAgICAgICBjb25zdCBkZXBzID0gZXhwcmVzc2lvbk9iamVjdC5kZXBzO1xyXG4gICAgICAgIGlmICghZGVwcyB8fCBkZXBzLmxlbmd0aCA8IDEgfHwgZXZlbnQubnMgIT09IGV4cHJlc3Npb25PYmplY3QubnMpIHtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgY2hhbmdlUGF0aHMgPSB0aGlzLmNsZWFuRXZlbnRQYXRoKGV2ZW50LnBhdGgpO1xyXG4gICAgICAgIGNoYW5nZVBhdGhzLnNwbGljZSgwLCAwLCBTVEFURV9URU1QTEFURSk7XHJcbiAgICAgICAgY29uc3QgZXZlbnRQYXRoID0gY2hhbmdlUGF0aHMuam9pbignLycpO1xyXG4gICAgICAgIGlmIChkZXBzLmluY2x1ZGVzKGV2ZW50UGF0aCkpIHtcclxuICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj5HluIPkuovku7ZcclxuICAgKiBAcGFyYW0gZXZlbnQgZXZlbnRcclxuICAgKi9cclxuICBwdWJsaWMgZGlzcGF0Y2goZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSB7XHJcbiAgICBjb25zdCBleHByZXNzaW9ucyA9IHRoaXMuZmlsdGVyKGV2ZW50KTtcclxuICAgIGlmIChleHByZXNzaW9ucyAmJiBleHByZXNzaW9ucy5sZW5ndGggPiAwKSB7XHJcbiAgICAgIGV4cHJlc3Npb25zLmZvckVhY2goKGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCkgPT4ge1xyXG4gICAgICAgIC8vIGNvbnN0IGVudGl0eUNvbnRleHQgPSB0aGlzLmJ1aWxkRW50aXR5Q29udGV4dChldmVudCwgZXhwcmVzc2lvbk9iamVjdCk7XHJcbiAgICAgICAgY29uc3QgY29udGV4dCA9IHRoaXMuYnVpbGRDb250ZXh0KGV4cHJlc3Npb25PYmplY3QsIGV2ZW50KTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnBlcmZvcm0oZXhwcmVzc2lvbk9iamVjdCwgY29udGV4dCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkICYmICF0aGlzLmlzVmFsaWRhdGVPclJlcXVpcmVkRXhwcmVzc2lvbihleHByZXNzaW9uT2JqZWN0KSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCA9IHRoaXMuY29udmVydEJvb2xlYW5UeXBlRXhwcmVzc2lvblJlc3VsdChleHByZXNzaW9uT2JqZWN0LCByZXN1bHQpOztcclxuICAgICAgICBpZiAoZXhwcmVzc2lvbk9iamVjdC5pZCkge1xyXG4gICAgICAgICAgdGhpcy5leHByZXNzaW9uUmVzdWx0LnNldChleHByZXNzaW9uT2JqZWN0LmlkLCBleHByZXNzaW9uT2JqZWN0LnJlc3VsdCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuZWZmZWN0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0KTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWJr+S9nOeUqFxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uT2JqZWN0IGV4cHJlc3Npb25PYmplY3RcclxuICAgKi9cclxuICBwdWJsaWMgZWZmZWN0KGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncywgZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KTogdm9pZCB7XHJcbiAgICBjb25zdCBlZmZlY3RvciA9IHRoaXMuZWZmZWN0b3JGYWN0b3J5LmdldEVmZmVjdG9yKGV4cHJlc3Npb25PYmplY3QpO1xyXG4gICAgY29uc3QgYmluZGluZ1R5cGUgPSBleHByZXNzaW9uT2JqZWN0LmJpbmRpbmdUeXBlO1xyXG4gICAgaWYgKCFlZmZlY3Rvcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoYmluZGluZ1R5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvbkJpbmRpbmdUeXBlLlN0YXRlKSB7XHJcbiAgICAgIC8vIOWmguaenOihqOi+vuW8j+S9nOeUqOS6jnVpc3RhdGVcclxuICAgICAgZWZmZWN0b3IuZWZmZWN0KGV4cHJlc3Npb25PYmplY3QucGF0aCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQsIHsgbWVzc2FnZTogZXhwcmVzc2lvbk9iamVjdC5tZXNzYWdlIH0pO1xyXG4gICAgfSBlbHNlIGlmIChiaW5kaW5nVHlwZSA9PT0gRXhwcmVzc2lvbi5FeHByZXNzaW9uQmluZGluZ1R5cGUuRmllbGQpIHtcclxuICAgICAgLy8g6KGo6L6+5byP5L2c55So5LqO5a6e5L2T5bGe5oCnXHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb25QYXRoSW5mbyA9IHRoaXMuZ2V0UGF0aEluZm8oZXhwcmVzc2lvbk9iamVjdC5wYXRoKTtcclxuICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gZXhwcmVzc2lvblBhdGhJbmZvLnBhdGhzO1xyXG4gICAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEFsbEVudGl0aWVzKCk7XHJcbiAgICAgIGlmICghZW50aXRpZXMgfHwgZW50aXRpZXMubGVuZ3RoIDwgMSB8fCBleHByZXNzaW9uT2JqZWN0LnR5cGUgPT09IEV4cHJlc3Npb24uRXhwcmVzc2lvblR5cGUuVmlzaWJsZSkge1xyXG4gICAgICAgIGVmZmVjdG9yLmVmZmVjdChleHByZXNzaW9uT2JqZWN0LnBhdGgsIGV4cHJlc3Npb25PYmplY3QucmVzdWx0LCB7IG1lc3NhZ2U6IGV4cHJlc3Npb25PYmplY3QubWVzc2FnZSB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmVmZmVjdFJvd3MoZW50aXRpZXMsIGJpbmRpbmdQYXRocywgZXhwcmVzc2lvblBhdGhJbmZvLnByb3BlcnR5TmFtZXMsIChjdXJyZW50Um93czogRXhwcmVzc2lvbi5JQ3VycmVudFJvd1tdLCBwYXRoczogc3RyaW5nW10pID0+IHtcclxuICAgICAgICAgIHRoaXMub3V0cHV0KGV2ZW50LCBleHByZXNzaW9uT2JqZWN0LCBjdXJyZW50Um93cywgZWZmZWN0b3IsIFtwYXRoc10pXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIG91dHB1dChldmVudDogRXhwcmVzc2lvbi5FdmVudEFyZ3MsIGV4cHJlc3Npb25PYmplY3Q6IEV4cHJlc3Npb24uRXhwcmVzc2lvbk9iamVjdCwgY3VycmVudFJvd3M6IEV4cHJlc3Npb24uSUN1cnJlbnRSb3dbXSwgZWZmZWN0b3I6IEV4cHJlc3Npb24uRWZmZWN0b3IsIHBhdGhzOiBhbnlbXVtdKSB7XHJcbiAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5idWlsZENvbnRleHQoZXhwcmVzc2lvbk9iamVjdCwgZXZlbnQsIG51bGwsIGN1cnJlbnRSb3dzKTtcclxuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5wZXJmb3JtKGV4cHJlc3Npb25PYmplY3QsIGNvbnRleHQpO1xyXG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQgPSB2YWx1ZTtcclxuICAgIGlmIChleHByZXNzaW9uT2JqZWN0LmlkKSB7XHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvblJlc3VsdC5zZXQoZXhwcmVzc2lvbk9iamVjdC5pZCwgZXhwcmVzc2lvbk9iamVjdC5yZXN1bHQpO1xyXG4gICAgfVxyXG4gICAgRWZmZWN0b3JNYW5hZ2VyLmVmZmVjdChlZmZlY3RvciwgZXhwcmVzc2lvbk9iamVjdCwgcGF0aHMpO1xyXG4gIH1cclxuICBwcml2YXRlIGVmZmVjdFJvd3MoZW50aXRpZXM6IEVudGl0eVtdLCBiaW5kaW5nUGF0aHM6IHN0cmluZ1tdLCBwcm9wZXJ0eU5hbWVzOiBzdHJpbmdbXSwgY2FsbGJhY2s6IChjdXJyZW50Um93czogRXhwcmVzc2lvbi5JQ3VycmVudFJvd1tdLCBwYXRoczogc3RyaW5nW10pID0+IHZvaWQsIGN1cnJlbnRSb3dzOiBFeHByZXNzaW9uLklDdXJyZW50Um93W10gPSBbXSwgcHJldlBhdGhzOiBzdHJpbmdbXSA9IFtdLCBwYXRoczogc3RyaW5nW10gPSBbXSkge1xyXG4gICAgaWYgKCFiaW5kaW5nUGF0aHMgfHwgYmluZGluZ1BhdGhzLmxlbmd0aCA8IDEpIHtcclxuICAgICAgZW50aXRpZXMuZm9yRWFjaCgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgICBpZiAoIWVudGl0eSB8fCAhZW50aXR5LnByaW1hcnlWYWx1ZSkge1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjdXJyZW50UGF0aHMgPSBwYXRocy5jb25jYXQoW2VudGl0eS5wcmltYXJ5VmFsdWVdKS5jb25jYXQocHJvcGVydHlOYW1lcyk7XHJcbiAgICAgICAgY29uc3QgY3VycmVudEN1cnJlbnRSb3dzID0gY3VycmVudFJvd3MuY29uY2F0KFt7IGJpbmRpbmdQYXRoOiBwcmV2UGF0aHMuam9pbignLycpIHx8ICcvJywgcHJpbWFyeVZhbHVlOiBlbnRpdHkucHJpbWFyeVZhbHVlIH1dKTtcclxuICAgICAgICBjYWxsYmFjayhjdXJyZW50Q3VycmVudFJvd3MsIGN1cnJlbnRQYXRocyk7XHJcbiAgICAgIH0pO1xyXG4gICAgICBjdXJyZW50Um93cy5sZW5ndGggPSAwO1xyXG4gICAgICBwYXRocy5sZW5ndGggPSAwO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgbGV0IGZsYWcgPSBmYWxzZTtcclxuICAgICAgbGV0IG5leHRQcmV2UGF0aHMgPSBwcmV2UGF0aHM7XHJcbiAgICAgIGVudGl0aWVzLmZvckVhY2goKGVudGl0eTogRW50aXR5KSA9PiB7XHJcbiAgICAgICAgY29uc3QgcHJvcCA9IGJpbmRpbmdQYXRoc1swXTtcclxuICAgICAgICBjb25zdCBlbnRpdHlMaXN0ID0gZW50aXR5W3Byb3BdIGFzIEVudGl0eUxpc3Q8RW50aXR5PjtcclxuICAgICAgICBpZiAoIWVudGl0eUxpc3QgfHwgZW50aXR5TGlzdC5jb3VudCgpIDwgMSkge1xyXG4gICAgICAgICAgLy8g5LiL57qn6KGo5rKh5pyJ5pWw5o2uXHJcbiAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGN1cnJlbnRSb3dzLnB1c2goeyBiaW5kaW5nUGF0aDogcHJldlBhdGhzLmpvaW4oJy8nKSB8fCAnLycsIHByaW1hcnlWYWx1ZTogZW50aXR5LnByaW1hcnlWYWx1ZSB9KTtcclxuICAgICAgICBwYXRocy5wdXNoKGVudGl0eS5wcmltYXJ5VmFsdWUpO1xyXG4gICAgICAgIHBhdGhzLnB1c2gocHJvcCk7XHJcbiAgICAgICAgaWYgKGZsYWcgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICBmbGFnID0gdHJ1ZTtcclxuICAgICAgICAgIG5leHRQcmV2UGF0aHMucHVzaChwcm9wKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgbmV4dEJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRocy5zbGljZSgxKTtcclxuICAgICAgICB0aGlzLmVmZmVjdFJvd3MoZW50aXR5TGlzdC5pdGVtcywgbmV4dEJpbmRpbmdQYXRocywgcHJvcGVydHlOYW1lcywgY2FsbGJhY2ssIGN1cnJlbnRSb3dzLCBuZXh0UHJldlBhdGhzLCBwYXRocyk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuICAvKipcclxuICAgKiDojrflj5blrZDooajkuovku7booYxcclxuICAgKiBAcGFyYW0gcGF0aHMgXHJcbiAgICogQHBhcmFtIGV2ZW50IFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRDdXJyZW50Um93QnlFdmVudChwYXRoczogc3RyaW5nW10sIGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IHsgW3Byb3A6IHN0cmluZ106IGFueTsgfSB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50Um93QnlQYXRocyhwYXRocyk7XHJcbiAgfVxyXG59Il19