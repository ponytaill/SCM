import * as tslib_1 from "tslib";
import { Injectable } from "@angular/core";
import { Service } from "./service";
import { DatagridComponent } from '@farris/ui-datagrid';
var DataGridService = /** @class */ (function (_super) {
    tslib_1.__extends(DataGridService, _super);
    function DataGridService() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    /**
     * 清空所有勾选行
     * @description 取消勾选当前表单所有勾选行
     */
    DataGridService.prototype.clearChecks = function () {
        // const params = this.eventParam;
        // if (params && Array.isArray(params)) {
        // const param = params[0];
        // if (param instanceof QueryCondition) {
        var gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach(function (gridComponent) {
                var clearSelections = true;
                if (gridComponent.hasOwnProperty('clearSelectionsWhenDataIsEmpty')) {
                    clearSelections = gridComponent['clearSelectionsWhenDataIsEmpty'];
                }
                if (clearSelections) {
                    gridComponent.clearCheckeds(true);
                }
            });
        }
        // }
        // }
    };
    /**
     * 取消勾选删除的行
     * @param ids ids
     * @returns
     * @description 取消勾选当前绑定路径下指定数据，清空下级表格中所有勾选行，仅供删除场景使用
     */
    DataGridService.prototype.uncheckDeletedRows = function (ids) {
        if (typeof ids === 'string') {
            if (ids.indexOf(',') !== -1) {
                ids = ids.split(',').filter(function (p) { return p; });
            }
            else {
                ids = [ids];
            }
        }
        if (!ids || ids.length < 1) {
            return;
        }
        // 获取bindingPath及ns
        var frameContext = this.context.frameContext;
        if (!frameContext) {
            return;
        }
        var appContext = frameContext.appContext;
        var ns = frameContext.namespace;
        var bindingPath = frameContext.viewModel && frameContext.viewModel.bindingPath;
        if (!appContext) {
            return;
        }
        // 根据bindingPath获取所有可能的frameContext
        var frameContexts = appContext.frameContextManager.getFrameContextsByNamespace(ns);
        var frameContextsInCurrentBindingPath = frameContexts.filter(function (frameContext) { return frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath === bindingPath; });
        // 获取这些frame中所有的表格组件map
        var gridInCurrentFrame = this.getGridComponentByFrameContexts(frameContextsInCurrentBindingPath);
        if (!gridInCurrentFrame) {
            return;
        }
        // 一个bindingPath下应该只有一个grid
        var grid = gridInCurrentFrame.pop();
        // 清空命令所在的frame下表格的指定勾选
        if (grid) {
            grid.unCheckRows(ids, true);
        }
        // 清空下级表格的所有勾选行数据
        var childrenFrameContexts = frameContexts.filter(function (frameContext) { return frameContext.viewModel.bindingPath !== bindingPath && frameContext.viewModel.bindingPath.startsWith(bindingPath); });
        var childrenGridComponents = this.getGridComponentByFrameContexts(childrenFrameContexts);
        // 清空命令所在frame
        if (childrenGridComponents && childrenGridComponents.length > 0) {
            childrenGridComponents.forEach(function (gridComponent) {
                // 清空所有勾选
                gridComponent.checkedRows = [];
            });
        }
    };
    /**
     * 取消勾选行
     * @param ids ids
     * @returns
     */
    DataGridService.prototype.uncheckRows = function (ids) {
        if (typeof ids === 'string') {
            ids = [ids];
        }
        if (!ids || ids.length < 1) {
            return;
        }
        var gridComponents = this.getFormGridComponents(this.context);
        if (gridComponents && gridComponents.length > 0) {
            gridComponents.forEach(function (gridComponent) {
                gridComponent.unCheckRows(ids, true);
            });
        }
    };
    /**
     * 根据命令上下文获取当前命令所在组件的表格实例
     * @param commandContext 命令上下文
     * @returns
     */
    DataGridService.prototype.getFormGridComponents = function (commandContext) {
        var grids = [];
        var frameContext = commandContext && commandContext.frameContext;
        var appContext = frameContext && frameContext.appContext || null;
        if (appContext) {
            var componentRefs = appContext.componentRefs;
            var collect = Array.from(componentRefs.values()); // [Map<string,any>,Map<string,any>]
            collect.forEach(function (item) {
                var components = Array.from(item.values());
                var bindingPath = frameContext;
                var gridComponents = components.filter(function (component) { return component instanceof DatagridComponent; });
                grids = grids.concat(gridComponents);
            });
        }
        return grids;
    };
    DataGridService.prototype.getGridComponentByFrameContexts = function (frameContexts) {
        return frameContexts.reduce(function (result, frameContext) {
            var appContext = frameContext.appContext;
            var frameId = frameContext.frameId;
            // 获取当前组件下所有的组件实例
            var componentsRef = appContext.componentRefs.get(frameId);
            var grids = componentsRef && Array.from(componentsRef.values()).filter(function (component) { return component instanceof DatagridComponent; });
            if (grids && grids.length > 0) {
                result = result.concat(grids);
            }
            return result;
        }, []);
    };
    DataGridService.decorators = [
        { type: Injectable }
    ];
    return DataGridService;
}(Service));
export { DataGridService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1ncmlkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1ncmlkLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd4RDtJQUNxQywyQ0FBTztJQUQ1Qzs7SUFvSUEsQ0FBQztJQWxJQzs7O09BR0c7SUFDSSxxQ0FBVyxHQUFsQjtRQUNFLGtDQUFrQztRQUNsQyx5Q0FBeUM7UUFDekMsMkJBQTJCO1FBQzNCLHlDQUF5QztRQUN6QyxJQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2hFLElBQUksY0FBYyxJQUFJLGNBQWMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQy9DLGNBQWMsQ0FBQyxPQUFPLENBQUMsVUFBQyxhQUFnQztnQkFDdEQsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDO2dCQUMzQixJQUFJLGFBQWEsQ0FBQyxjQUFjLENBQUMsZ0NBQWdDLENBQUMsRUFBRTtvQkFDbEUsZUFBZSxHQUFHLGFBQWEsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO2lCQUNuRTtnQkFDRCxJQUFJLGVBQWUsRUFBRTtvQkFDbkIsYUFBYSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDbkM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsSUFBSTtRQUNKLElBQUk7SUFDTixDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSw0Q0FBa0IsR0FBekIsVUFBMEIsR0FBUTtRQUNoQyxJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsRUFBRTtZQUMzQixJQUFJLEdB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QUFNLEVBQUUsWUFBWTtZQUMvQyxJQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDO1lBQzNDLElBQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUM7WUFDckMsaUJBQWlCO1lBQ2pCLElBQU0sYUFBYSxHQUFHLFVBQVUsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQzVELElBQU0sS0FBSyxHQUFHLGFBQWEsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLFNBQVMsSUFBSSxPQUFBLFNBQVMsWUFBWSxpQkFBaUIsRUFBdEMsQ0FBc0MsQ0FBQyxDQUFDO1lBQzlILElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM3QixNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUMvQjtZQUNELE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUNULENBQUM7O2dCQW5JRixVQUFVOztJQW9JWCxzQkFBQztDQUFBLEFBcElELENBQ3FDLE9BQU8sR0FtSTNDO1NBbklZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IFNlcnZpY2UgfSBmcm9tIFwiLi9zZXJ2aWNlXCI7XG5pbXBvcnQgeyBEYXRhZ3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktZGF0YWdyaWQnO1xuaW1wb3J0IHsgUXVlcnlDb25kaXRpb24gfSBmcm9tICdAZmFycmlzL2NvbXBvbmVudC1xdWVyeWNvbmRpdGlvbic7XG5pbXBvcnQgeyBDb21tYW5kQ29udGV4dCwgRnJhbWVDb250ZXh0IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGF0YUdyaWRTZXJ2aWNlIGV4dGVuZHMgU2VydmljZSB7XG4gIC8qKlxuICAgKiDmuIXnqbrmiYDmnInli77pgInooYxcbiAgICogQGRlc2NyaXB0aW9uIOWPlua2iOWLvumAieW9k+WJjeihqOWNleaJgOacieWLvumAieihjFxuICAgKi9cbiAgcHVibGljIGNsZWFyQ2hlY2tzKCkge1xuICAgIC8vIGNvbnN0IHBhcmFtcyA9IHRoaXMuZXZlbnRQYXJhbTtcbiAgICAvLyBpZiAocGFyYW1zICYmIEFycmF5LmlzQXJyYXkocGFyYW1zKSkge1xuICAgIC8vIGNvbnN0IHBhcmFtID0gcGFyYW1zWzBdO1xuICAgIC8vIGlmIChwYXJhbSBpbnN0YW5jZW9mIFF1ZXJ5Q29uZGl0aW9uKSB7XG4gICAgY29uc3QgZ3JpZENvbXBvbmVudHMgPSB0aGlzLmdldEZvcm1HcmlkQ29tcG9uZW50cyh0aGlzLmNvbnRleHQpO1xuICAgIGlmIChncmlkQ29tcG9uZW50cyAmJiBncmlkQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICBncmlkQ29tcG9uZW50cy5mb3JFYWNoKChncmlkQ29tcG9uZW50OiBEYXRhZ3JpZENvbXBvbmVudCkgPT4ge1xuICAgICAgICBsZXQgY2xlYXJTZWxlY3Rpb25zID0gdHJ1ZTtcbiAgICAgICAgaWYgKGdyaWRDb21wb25lbnQuaGFzT3duUHJvcGVydHkoJ2NsZWFyU2VsZWN0aW9uc1doZW5EYXRhSXNFbXB0eScpKSB7XG4gICAgICAgICAgY2xlYXJTZWxlY3Rpb25zID0gZ3JpZENvbXBvbmVudFsnY2xlYXJTZWxlY3Rpb25zV2hlbkRhdGFJc0VtcHR5J107XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNsZWFyU2VsZWN0aW9ucykge1xuICAgICAgICAgIGdyaWRDb21wb25lbnQuY2xlYXJDaGVja2Vkcyh0cnVlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIC8vIH1cbiAgICAvLyB9XG4gIH1cbiAgLyoqXG4gICAqIOWPlua2iOWLvumAieWIoOmZpOeahOihjFxuICAgKiBAcGFyYW0gaWRzIGlkc1xuICAgKiBAcmV0dXJucyBcbiAgICogQGRlc2NyaXB0aW9uIOWPlua2iOWLvumAieW9k+WJjee7keWumui3r+W+hOS4i+aMh+WumuaVsOaNru+8jOa4heepuuS4i+e6p+ihqOagvOS4reaJgOacieWLvumAieihjO+8jOS7heS+m+WIoOmZpOWcuuaZr+S9v+eUqFxuICAgKi9cbiAgcHVibGljIHVuY2hlY2tEZWxldGVkUm93cyhpZHM6IGFueSkge1xuICAgIGlmICh0eXBlb2YgaWRzID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKGlkcy5pbmRleE9mKCcsJykgIT09IC0xKSB7XG4gICAgICAgIGlkcyA9IGlkcy5zcGxpdCgnLCcpLmZpbHRlcihwID0+IHApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWRzID0gW2lkc107XG4gICAgICB9XG4gICAgfVxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIOiOt+WPlmJpbmRpbmdQYXRo5Y+KbnNcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmNvbnRleHQuZnJhbWVDb250ZXh0O1xuICAgIGlmICghZnJhbWVDb250ZXh0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGFwcENvbnRleHQgPSBmcmFtZUNvbnRleHQuYXBwQ29udGV4dDtcbiAgICBjb25zdCBucyA9IGZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XG4gICAgaWYgKCFhcHBDb250ZXh0KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIOagueaNrmJpbmRpbmdQYXRo6I635Y+W5omA5pyJ5Y+v6IO955qEZnJhbWVDb250ZXh0XG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobnMpO1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dHNJbkN1cnJlbnRCaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKGZyYW1lQ29udGV4dCA9PiBmcmFtZUNvbnRleHQgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCk7XG4gICAgLy8g6I635Y+W6L+Z5LqbZnJhbWXkuK3miYDmnInnmoTooajmoLznu4Tku7ZtYXBcbiAgICBjb25zdCBncmlkSW5DdXJyZW50RnJhbWUgPSB0aGlzLmdldEdyaWRDb21wb25lbnRCeUZyYW1lQ29udGV4dHMoZnJhbWVDb250ZXh0c0luQ3VycmVudEJpbmRpbmdQYXRoKTtcbiAgICBpZiAoIWdyaWRJbkN1cnJlbnRGcmFtZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyDkuIDkuKpiaW5kaW5nUGF0aOS4i+W6lOivpeWPquacieS4gOS4qmdyaWRcbiAgICBjb25zdCBncmlkOiBEYXRhZ3JpZENvbXBvbmVudCA9IGdyaWRJbkN1cnJlbnRGcmFtZS5wb3AoKTtcbiAgICAvLyDmuIXnqbrlkb3ku6TmiYDlnKjnmoRmcmFtZeS4i+ihqOagvOeahOaMh+WumuWLvumAiVxuICAgIGlmKGdyaWQpe1xuICAgICAgZ3JpZC51bkNoZWNrUm93cyhpZHMsIHRydWUpO1xuICAgIH1cbiAgICAvLyDmuIXnqbrkuIvnuqfooajmoLznmoTmiYDmnInli77pgInooYzmlbDmja5cbiAgICBjb25zdCBjaGlsZHJlbkZyYW1lQ29udGV4dHMgPSBmcmFtZUNvbnRleHRzLmZpbHRlcihmcmFtZUNvbnRleHQgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCAhPT0gYmluZGluZ1BhdGggJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zdGFydHNXaXRoKGJpbmRpbmdQYXRoKSk7XG4gICAgY29uc3QgY2hpbGRyZW5HcmlkQ29tcG9uZW50cyA9IHRoaXMuZ2V0R3JpZENvbXBvbmVudEJ5RnJhbWVDb250ZXh0cyhjaGlsZHJlbkZyYW1lQ29udGV4dHMpO1xuICAgIC8vIOa4heepuuWRveS7pOaJgOWcqGZyYW1lXG4gICAgaWYgKGNoaWxkcmVuR3JpZENvbXBvbmVudHMgJiYgY2hpbGRyZW5HcmlkQ29tcG9uZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICBjaGlsZHJlbkdyaWRDb21wb25lbnRzLmZvckVhY2goKGdyaWRDb21wb25lbnQ6IERhdGFncmlkQ29tcG9uZW50KSA9PiB7XG4gICAgICAgIC8vIOa4heepuuaJgOacieWLvumAiVxuICAgICAgICBncmlkQ29tcG9uZW50LmNoZWNrZWRSb3dzID0gW107XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOWPlua2iOWLvumAieihjFxuICAgKiBAcGFyYW0gaWRzIGlkc1xuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyB1bmNoZWNrUm93cyhpZHM6IGFueSkge1xuICAgIGlmICh0eXBlb2YgaWRzID09PSAnc3RyaW5nJykge1xuICAgICAgaWRzID0gW2lkc107XG4gICAgfVxuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGdyaWRDb21wb25lbnRzID0gdGhpcy5nZXRGb3JtR3JpZENvbXBvbmVudHModGhpcy5jb250ZXh0KTtcbiAgICBpZiAoZ3JpZENvbXBvbmVudHMgJiYgZ3JpZENvbXBvbmVudHMubGVuZ3RoID4gMCkge1xuICAgICAgZ3JpZENvbXBvbmVudHMuZm9yRWFjaCgoZ3JpZENvbXBvbmVudDogRGF0YWdyaWRDb21wb25lbnQpID0+IHtcbiAgICAgICAgZ3JpZENvbXBvbmVudC51bkNoZWNrUm93cyhpZHMsIHRydWUpO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDmoLnmja7lkb3ku6TkuIrkuIvmlofojrflj5blvZPliY3lkb3ku6TmiYDlnKjnu4Tku7bnmoTooajmoLzlrp7kvotcbiAgICogQHBhcmFtIGNvbW1hbmRDb250ZXh0IOWRveS7pOS4iuS4i+aWh1xuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByaXZhdGUgZ2V0Rm9ybUdyaWRDb21wb25lbnRzKGNvbW1hbmRDb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xuICAgIGxldCBncmlkcyA9IFtdO1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGNvbW1hbmRDb250ZXh0ICYmIGNvbW1hbmRDb250ZXh0LmZyYW1lQ29udGV4dDtcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5hcHBDb250ZXh0IHx8IG51bGw7XG4gICAgaWYgKGFwcENvbnRleHQpIHtcbiAgICAgIGNvbnN0IGNvbXBvbmVudFJlZnM6IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIGFueT4+ID0gYXBwQ29udGV4dC5jb21wb25lbnRSZWZzO1xuICAgICAgY29uc3QgY29sbGVjdCA9IEFycmF5LmZyb20oY29tcG9uZW50UmVmcy52YWx1ZXMoKSk7Ly8gW01hcDxzdHJpbmcsYW55PixNYXA8c3RyaW5nLGFueT5dXG4gICAgICBjb2xsZWN0LmZvckVhY2goKGl0ZW06IE1hcDxzdHJpbmcsIGFueT4pID0+IHtcbiAgICAgICAgY29uc3QgY29tcG9uZW50cyA9IEFycmF5LmZyb20oaXRlbS52YWx1ZXMoKSk7XG4gICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0XG4gICAgICAgIGNvbnN0IGdyaWRDb21wb25lbnRzID0gY29tcG9uZW50cy5maWx0ZXIoKGNvbXBvbmVudDogYW55KSA9PiBjb21wb25lbnQgaW5zdGFuY2VvZiBEYXRhZ3JpZENvbXBvbmVudCk7XG4gICAgICAgIGdyaWRzID0gZ3JpZHMuY29uY2F0KGdyaWRDb21wb25lbnRzKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gZ3JpZHM7XG4gIH1cbiAgcHJpdmF0ZSBnZXRHcmlkQ29tcG9uZW50QnlGcmFtZUNvbnRleHRzKGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdKSB7XG4gICAgcmV0dXJuIGZyYW1lQ29udGV4dHMucmVkdWNlKChyZXN1bHQsIGZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IGZyYW1lQ29udGV4dC5hcHBDb250ZXh0O1xuICAgICAgY29uc3QgZnJhbWVJZCA9IGZyYW1lQ29udGV4dC5mcmFtZUlkO1xuICAgICAgLy8g6I635Y+W5b2T5YmN57uE5Lu25LiL5omA5pyJ55qE57uE5Lu25a6e5L6LXG4gICAgICBjb25zdCBjb21wb25lbnRzUmVmID0gYXBwQ29udGV4dC5jb21wb25lbnRSZWZzLmdldChmcmFtZUlkKTtcbiAgICAgIGNvbnN0IGdyaWRzID0gY29tcG9uZW50c1JlZiAmJiBBcnJheS5mcm9tKGNvbXBvbmVudHNSZWYudmFsdWVzKCkpLmZpbHRlcihjb21wb25lbnQgPT4gY29tcG9uZW50IGluc3RhbmNlb2YgRGF0YWdyaWRDb21wb25lbnQpO1xuICAgICAgaWYgKGdyaWRzICYmIGdyaWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdChncmlkcyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sIFtdKTtcbiAgfVxufSJdfQ==