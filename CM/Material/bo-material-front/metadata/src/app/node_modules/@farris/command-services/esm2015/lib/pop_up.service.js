import { Injectable, Injector } from "@angular/core";
import { EMPTY, of } from "rxjs";
import { switchMap, tap } from "rxjs/operators";
import { FrameContext, DataPathCreator, Repository } from "@farris/devkit";
import { LanguageService } from "./languag.service";
import { FormMessageService } from "./form-message.service";
export class PopUpService {
    constructor(injector, frameContext, repository, languageService, messageService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.repository = repository;
        this.languageService = languageService;
        this.messageService = messageService;
    }
    confirm() { }
    /**
     * 取消变更
     * @param frameId
     * @param id
     * @returns
     */
    cancel(frameId, id) {
        const frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
        if (!frameContext) {
            throw new Error(`[PopUpService]Invalid frameId ${frameId}`);
        }
        const primaryValue = this.frameContext.bindingData.list.currentId;
        const bindingPath = frameContext.viewModel.bindingPath;
        const bindingPaths = bindingPath.split('/').filter(p => p);
        if (!id) {
            const bindingList = this.frameContext.bindingData.getList();
            id = bindingList.currentId;
        }
        const befRepository = this.repository;
        const longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map((path) => path.split(':')[1]);
        const entityListPaths = Array.from(longPaths);
        //舍弃当前表当前行
        entityListPaths.pop();
        const dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityListPaths.length < 1) {
            // 主表
            const entity = this.repository.entityCollection.getEntityById(id);
            const originalData = entity['originalData'];
            entity.load(originalData, { loadChild: false });
        }
        else {
            const entityList = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
            if (entityList) {
                const originalData = entityList['originalData'];
                const item = originalData.find(item => item.id === id);
                if (item) {
                    // 已有数据，还原变更
                    const entity = befRepository.entityManager.getEntityByPath(longPaths);
                    if (entity.changes && entity.changes.length > 0) {
                        return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(tap((result) => {
                            if (result) {
                                entity.load(item, { loadChild: false });
                                entity.changes.splice(0, entity.changes.length);
                            }
                        }));
                    }
                    else {
                        // 没有修改，直接关闭
                        if (dialogRef) {
                            dialogRef.close();
                        }
                    }
                }
                else {
                    // 新增的数据，删除
                    const paths = this.buildPath(bindingPath, primaryValue);
                    return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(switchMap(result => {
                        if (result) {
                            return befRepository.removeEntityByPath(paths, id).pipe(tap(() => {
                                befRepository.entityManager.removeEntityByPath(paths, id);
                                if (entityList.count() === 0 && dialogRef) {
                                    dialogRef.close();
                                }
                            }));
                        }
                        else {
                            return EMPTY;
                        }
                    }));
                }
            }
        }
        return of([]);
    }
    /**
     * 同步当前行
     */
    updateCurrentRow(id) {
        const bindingPath = this.frameContext.viewModel.bindingPath;
        const bindingPaths = bindingPath.split('/').filter(p => p);
        // const frameId = this.frameContext.frameId;
        const root = this.frameContext.appContext.frameContextManager.getRootFrameContext();
        const primaryKeyValue = root.bindingData.list.currentId;
        this.frameContext.bindingData.list.setCurrentId(primaryKeyValue);
        if (bindingPaths.length > 0) {
            const paths = [];
            bindingPaths.forEach((path, index, array) => {
                paths.push(path);
                const bindingList = root.bindingData.getValue(paths);
                if (bindingList) {
                    const currentId = bindingList.currentId;
                    const modalBindingList = this.frameContext.bindingData.getValue(paths);
                    if (index === bindingPath.length - 1 && id) {
                        modalBindingList.setCurrentId(id);
                    }
                    else if (modalBindingList) {
                        modalBindingList.setCurrentId(currentId);
                    }
                }
            });
        }
    }
    closeCheck() {
        const frameContext = this.frameContext;
        const bindingPath = frameContext.viewModel.bindingPath;
        const bindingPaths = bindingPath.split('/').filter(p => p);
        const befRepository = this.repository;
        const longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map((path) => path.split(':')[1]);
        const entityListPaths = Array.from(longPaths);
        entityListPaths.pop();
        const entityList = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
        const dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityList.count() === 0 && dialogRef) {
            dialogRef.close();
        }
    }
    /**
     * 构造子表路径
     * @param bindingPath 绑定路径
     * @param id id
     */
    buildPath(bindingPath, id) {
        let path = '/' + id;
        const subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (let index = 1; index < subPaths.length - 1; index++) {
                const subPath = subPaths[index];
                const subData = this.frameContext.viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error(`获取子表完整路径出错，找不到${subData}对应的子表，或对应子表没有当前行。`);
                }
                path += `/${subPath}/${subData.currentId}`;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    }
}
PopUpService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
PopUpService.ctorParameters = () => [
    { type: Injector },
    { type: FrameContext },
    { type: Repository },
    { type: LanguageService },
    { type: FormMessageService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wX3VwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcG9wX3VwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQTZDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRzVELE1BQU0sT0FBTyxZQUFZO0lBQ3ZCLFlBQ1UsUUFBa0IsRUFDbEIsWUFBMEIsRUFDMUIsVUFBMkIsRUFDM0IsZUFBZ0MsRUFDaEMsY0FBa0M7UUFKbEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQW9CO0lBQ3hDLENBQUM7SUFDRSxPQUFPLEtBQUssQ0FBQztJQUNwQjs7Ozs7T0FLRztJQUNJLE1BQU0sQ0FBQyxPQUFlLEVBQUUsRUFBVztRQUN4QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuRyxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLE9B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QUU7WUFDdkIsNkRBQTZEO1lBQzdELGNBQWM7WUFDZCxLQUFLLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRSxLQUFLLEdBQUcsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ3hELE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNqRSxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRTtvQkFDbEMsTUFBTSxLQUFLLENBQUMsaUJBQWlCLE9BQU8sbUJBQW1CLENBQUMsQ0FBQztpQkFDMUQ7Z0JBQ0QsSUFBSSxJQUFJLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQzthQUM1QztTQUNGO1FBQ0QsSUFBSSxJQUFJLEdBQUcsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUU1QyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7OztZQXZKRixVQUFVOzs7O1lBUlUsUUFBUTtZQUlwQixZQUFZO1lBQW1CLFVBQVU7WUFDekMsZUFBZTtZQUNmLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEVNUFRZLCBvZiB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQgeyBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gXCJyeGpzL29wZXJhdG9yc1wiO1xuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSB9IGZyb20gXCJAZmFycmlzL2JlZlwiO1xuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBEYXRhUGF0aENyZWF0b3IsIFJlcG9zaXRvcnksIERhdGFQYXRoLCBFbnRpdHlMaXN0LCBCaW5kaW5nTGlzdCwgRW50aXR5IH0gZnJvbSBcIkBmYXJyaXMvZGV2a2l0XCI7XG5pbXBvcnQgeyBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tIFwiLi9sYW5ndWFnLnNlcnZpY2VcIjtcbmltcG9ydCB7IEZvcm1NZXNzYWdlU2VydmljZSB9IGZyb20gXCIuL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlXCI7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQb3BVcFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBtZXNzYWdlU2VydmljZTogRm9ybU1lc3NhZ2VTZXJ2aWNlXG4gICkgeyB9XG4gIHB1YmxpYyBjb25maXJtKCkgeyB9XG4gIC8qKlxuICAgKiDlj5bmtojlj5jmm7RcbiAgICogQHBhcmFtIGZyYW1lSWQgXG4gICAqIEBwYXJhbSBpZCBcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgY2FuY2VsKGZyYW1lSWQ6IHN0cmluZywgaWQ/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKTtcbiAgICBpZiAoIWZyYW1lQ29udGV4dCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBbUG9wVXBTZXJ2aWNlXUludmFsaWQgZnJhbWVJZCAke2ZyYW1lSWR9YCk7XG4gICAgfVxuICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIGlmICghaWQpIHtcbiAgICAgIGNvbnN0IGJpbmRpbmdMaXN0ID0gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0TGlzdCgpIGFzIEJpbmRpbmdMaXN0O1xuICAgICAgaWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XG4gICAgfVxuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xuICAgIGNvbnN0IGxvbmdQYXRocyA9IChEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpIGFzIERhdGFQYXRoKS50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHBhdGguc3BsaXQoJzonKVsxXSk7XG4gICAgY29uc3QgZW50aXR5TGlzdFBhdGhzID0gQXJyYXkuZnJvbShsb25nUGF0aHMpO1xuICAgIC8v6IiN5byD5b2T5YmN6KGo5b2T5YmN6KGMXG4gICAgZW50aXR5TGlzdFBhdGhzLnBvcCgpO1xuICAgIGNvbnN0IGRpYWxvZ1JlZiA9IHRoaXMuZnJhbWVDb250ZXh0LmZyYW1lQ29tcG9uZW50WydkaWFsb2dSZWYnXTtcbiAgICBpZiAoZW50aXR5TGlzdFBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAgIC8vIOS4u+ihqFxuICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChpZCkgYXMgRW50aXR5O1xuICAgICAgY29uc3Qgb3JpZ2luYWxEYXRhID0gZW50aXR5WydvcmlnaW5hbERhdGEnXTtcbiAgICAgIGVudGl0eS5sb2FkKG9yaWdpbmFsRGF0YSwgeyBsb2FkQ2hpbGQ6IGZhbHNlIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBlbnRpdHlMaXN0ID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmdldEVudGl0eU5vZGVCeVBhdGgoZW50aXR5TGlzdFBhdGhzKSBhcyBFbnRpdHlMaXN0PGFueT47XG4gICAgICBpZiAoZW50aXR5TGlzdCkge1xuICAgICAgICBjb25zdCBvcmlnaW5hbERhdGE6IGFueVtdID0gZW50aXR5TGlzdFsnb3JpZ2luYWxEYXRhJ107XG4gICAgICAgIGNvbnN0IGl0ZW0gPSBvcmlnaW5hbERhdGEuZmluZChpdGVtID0+IGl0ZW0uaWQgPT09IGlkKTtcbiAgICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgICAvLyDlt7LmnInmlbDmja7vvIzov5jljp/lj5jmm7RcbiAgICAgICAgICBjb25zdCBlbnRpdHk6IEVudGl0eSA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5nZXRFbnRpdHlCeVBhdGgobG9uZ1BhdGhzKSBhcyBFbnRpdHk7XG4gICAgICAgICAgaWYgKGVudGl0eS5jaGFuZ2VzICYmIGVudGl0eS5jaGFuZ2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmNvbmZpcm0odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsV2l0aG91dFNhdmUpLnBpcGUoXG4gICAgICAgICAgICAgIHRhcCgocmVzdWx0OiBib29sZWFuKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgZW50aXR5LmxvYWQoaXRlbSwgeyBsb2FkQ2hpbGQ6IGZhbHNlIH0pO1xuICAgICAgICAgICAgICAgICAgZW50aXR5LmNoYW5nZXMuc3BsaWNlKDAsIGVudGl0eS5jaGFuZ2VzLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8g5rKh5pyJ5L+u5pS577yM55u05o6l5YWz6ZetXG4gICAgICAgICAgICBpZiAoZGlhbG9nUmVmKSB7XG4gICAgICAgICAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyDmlrDlop7nmoTmlbDmja7vvIzliKDpmaRcbiAgICAgICAgICBjb25zdCBwYXRocyA9IHRoaXMuYnVpbGRQYXRoKGJpbmRpbmdQYXRoLCBwcmltYXJ5VmFsdWUpO1xuICAgICAgICAgIHJldHVybiB0aGlzLm1lc3NhZ2VTZXJ2aWNlLmNvbmZpcm0odGhpcy5sYW5ndWFnZVNlcnZpY2UuY2FuY2VsV2l0aG91dFNhdmUpLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBiZWZSZXBvc2l0b3J5LnJlbW92ZUVudGl0eUJ5UGF0aChwYXRocywgaWQpLnBpcGUoXG4gICAgICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIucmVtb3ZlRW50aXR5QnlQYXRoKHBhdGhzLCBpZCk7XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGVudGl0eUxpc3QuY291bnQoKSA9PT0gMCAmJiBkaWFsb2dSZWYpIHtcbiAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dSZWYuY2xvc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBvZihbXSk7XG4gIH1cbiAgLyoqXG4gICAqIOWQjOatpeW9k+WJjeihjFxuICAgKi9cbiAgcHVibGljIHVwZGF0ZUN1cnJlbnRSb3coaWQ/OiBzdHJpbmcpIHtcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIC8vIGNvbnN0IGZyYW1lSWQgPSB0aGlzLmZyYW1lQ29udGV4dC5mcmFtZUlkO1xuICAgIGNvbnN0IHJvb3QgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0Um9vdEZyYW1lQ29udGV4dCgpO1xuICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IHJvb3QuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XG4gICAgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5zZXRDdXJyZW50SWQocHJpbWFyeUtleVZhbHVlKTtcbiAgICBpZiAoYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHBhdGhzID0gW107XG4gICAgICBiaW5kaW5nUGF0aHMuZm9yRWFjaCgocGF0aDogc3RyaW5nLCBpbmRleDogbnVtYmVyLCBhcnJheSkgPT4ge1xuICAgICAgICBwYXRocy5wdXNoKHBhdGgpO1xuICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHJvb3QuYmluZGluZ0RhdGEuZ2V0VmFsdWUocGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgICAgICBpZiAoYmluZGluZ0xpc3QpIHtcbiAgICAgICAgICBjb25zdCBjdXJyZW50SWQgPSBiaW5kaW5nTGlzdC5jdXJyZW50SWQ7XG4gICAgICAgICAgY29uc3QgbW9kYWxCaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgICAgICBpZiAoaW5kZXggPT09IGJpbmRpbmdQYXRoLmxlbmd0aCAtIDEgJiYgaWQpIHtcbiAgICAgICAgICAgIG1vZGFsQmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGlkKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKG1vZGFsQmluZGluZ0xpc3QpIHtcbiAgICAgICAgICAgIG1vZGFsQmluZGluZ0xpc3Quc2V0Q3VycmVudElkKGN1cnJlbnRJZCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgcHVibGljIGNsb3NlQ2hlY2soKSB7XG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQ7XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoO1xuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgY29uc3QgYmVmUmVwb3NpdG9yeSA9IHRoaXMucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XG4gICAgY29uc3QgbG9uZ1BhdGhzID0gKERhdGFQYXRoQ3JlYXRvci5jcmVhdGVCeVNob3J0UGF0aEZyb21Sb290KGJpbmRpbmdQYXRocywgYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLCB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YSkgYXMgRGF0YVBhdGgpLnRvQXJyYXkoKS5tYXAoKHBhdGg6IHN0cmluZykgPT4gcGF0aC5zcGxpdCgnOicpWzFdKTtcbiAgICBjb25zdCBlbnRpdHlMaXN0UGF0aHMgPSBBcnJheS5mcm9tKGxvbmdQYXRocyk7XG4gICAgZW50aXR5TGlzdFBhdGhzLnBvcCgpO1xuICAgIGNvbnN0IGVudGl0eUxpc3QgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5Tm9kZUJ5UGF0aChlbnRpdHlMaXN0UGF0aHMpIGFzIEVudGl0eUxpc3Q8YW55PjtcbiAgICBjb25zdCBkaWFsb2dSZWYgPSB0aGlzLmZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnZGlhbG9nUmVmJ107XG4gICAgaWYgKGVudGl0eUxpc3QuY291bnQoKSA9PT0gMCAmJiBkaWFsb2dSZWYpIHtcbiAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog5p6E6YCg5a2Q6KGo6Lev5b6EXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCDnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIGlkIGlkXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkUGF0aChiaW5kaW5nUGF0aDogc3RyaW5nLCBpZDogYW55KSB7XG4gICAgbGV0IHBhdGggPSAnLycgKyBpZDtcbiAgICBjb25zdCBzdWJQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIGVnOmJpbmRpbmdQYXRo5b2i5aaCL2VkdXMvZ3JhZGVzLHNwbGl05ZCO5pivWycnLCAnZWR1cycsICdncmFkZXMnXVxuICAgICAgLy8g5Zug5q2kaW5kZXjku44x5byA5aeLXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDE7IGluZGV4IDwgc3ViUGF0aHMubGVuZ3RoIC0gMTsgaW5kZXgrKykge1xuICAgICAgICBjb25zdCBzdWJQYXRoID0gc3ViUGF0aHNbaW5kZXhdO1xuICAgICAgICBjb25zdCBzdWJEYXRhID0gdGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdEYXRhW3N1YlBhdGhdO1xuICAgICAgICBpZiAoIXN1YkRhdGEgfHwgIXN1YkRhdGEuY3VycmVudElkKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoYOiOt+WPluWtkOihqOWujOaVtOi3r+W+hOWHuumUme+8jOaJvuS4jeWIsCR7c3ViRGF0YX3lr7nlupTnmoTlrZDooajvvIzmiJblr7nlupTlrZDooajmsqHmnInlvZPliY3ooYzjgIJgKTtcbiAgICAgICAgfVxuICAgICAgICBwYXRoICs9IGAvJHtzdWJQYXRofS8ke3N1YkRhdGEuY3VycmVudElkfWA7XG4gICAgICB9XG4gICAgfVxuICAgIHBhdGggKz0gJy8nICsgc3ViUGF0aHNbc3ViUGF0aHMubGVuZ3RoIC0gMV07XG5cbiAgICByZXR1cm4gcGF0aDtcbiAgfVxufSJdfQ==