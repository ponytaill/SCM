/**
 * BindingObject相关定义
 * @author Witt<jiwt@inspur.com>
 */
import { Subject, of } from 'rxjs';
import { ChangeType, ViewChangeType } from './changes';
import { BindingPropertyType } from './binding_property';
import { PropertyUtil } from './property_util';
/**
 * BindingObject是Entity在绑定层的一个影射，它将Entity内的数据转换为不可变对象，并用于界面绑定。
 */
class BindingObject {
    /**
     * 构造函数
     * @param properties 属性集合
     */
    constructor(properties) {
        /**
         * 标识是否提交过
         */
        this.isShowValidationMsg = false;
        /**
         * 以{ [propertyName]: FormControl }的形式存放每条数据的control
         */
        this.controlMap = {};
        this.properties = properties;
        this.primaryKey = PropertyUtil.getPrimaryKey(properties);
        this.innerValues = new Map();
        this.changes = new Subject();
        this.viewChanges = new Subject();
    }
    /**
     * 主键值
     */
    get primaryKeyValue() {
        return this.primaryKey ? this.getValue(this.primaryKey) : '';
    }
    /**
     * 设置是否提交过
     */
    setShowValidationMsg(flag) {
        this.isShowValidationMsg = flag;
    }
    /**
     * 根据属性名获取属性值
     * @param   propertyName 属性名
     * @returns 属性值
     */
    getValue(propertyName) {
        return this.innerValues.get(propertyName);
    }
    /**
     * 设置属性值
     * @param propertyName        属性名
     * @param propertyValue       属性值
     * @param emitEventToView     是否通知View层去更新界面，默认为false
     * @param emitEventToEntity   是否通知Entity层去更新值，默认为false
     * @param errors              错误消息
     * @param invokeOnValueChange 值变化事件执行句柄
     */
    setValue(propertyName, propertyValue, emitEventToView = false, emitEventToEntity = false, errors, invokeOnValueChange) {
        const oldPropertyValue = this.getValue(propertyName);
        // 由于特定原因（@邵珠强），无法屏蔽oldPropertyValue === propertyValue
        if (oldPropertyValue === propertyValue) {
            return;
        }
        if (!invokeOnValueChange || oldPropertyValue === propertyValue) {
            // 设定缺省
            invokeOnValueChange = function (preValue, value, entityChanged) {
                return of(true);
            };
        }
        if (emitEventToEntity === true) {
            // BUG 322301，删除@2019.08.10; 如果无对应实体，则中止值传递; 这种情况发生在带从表的单据新增，从表响应Load变化的情况；
            // if(!this.innerValues.has(propertyName)) {
            //   return;
            // }
            // 执行实体值变化前事件
            invokeOnValueChange(oldPropertyValue, propertyValue, false).subscribe((result) => {
                if (result) {
                    // 如果成功，执行变化，并通知实体变化
                    this.innerValues = this.innerValues.set(propertyName, propertyValue);
                    const viewChange = {
                        type: ViewChangeType.ValueChanged,
                        path: [propertyName],
                        value: propertyValue,
                        errors: errors
                    };
                    this.viewChanges.next(viewChange);
                    // 如果需要通知视图，通知视图相应修改
                    if (emitEventToView === true) {
                        this.changes.next({
                            type: ChangeType.ValueChanged,
                            path: [propertyName],
                            value: propertyValue,
                            id: this.primaryKeyValue,
                            errors: errors
                        });
                    }
                    // 执行实体值变化后事件
                    invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();
                }
                else {
                    // 如果失败，不再通知实体变化
                    // 并执行界面回滚操作
                    this.changes.next({
                        type: ChangeType.ValueChanged,
                        path: [propertyName],
                        value: oldPropertyValue,
                        id: this.primaryKeyValue,
                        errors: errors
                    });
                }
            });
        }
        else {
            // `emitEventToEntity === false`, 则认定实体值已经发生变化，通知视图变化，并触发实体值变化后事件
            this.innerValues = this.innerValues.set(propertyName, propertyValue);
            if (emitEventToView === true) {
                this.changes.next({
                    type: ChangeType.ValueChanged,
                    path: [propertyName],
                    value: propertyValue,
                    id: this.primaryKeyValue,
                    errors: errors
                });
            }
            // 执行实体值变化后事件
            invokeOnValueChange(oldPropertyValue, propertyValue, true).subscribe();
        }
    }
    /**
     * 将BindingObject实例转换成JSON对象
     */
    toJSON(options) {
        const langCode = window.localStorage.getItem('languageCode') || 'zh-CHS';
        const result = {};
        this.properties.forEach((property) => {
            const propName = property.name;
            if (property.type === BindingPropertyType.List) {
                const list = this[propName];
                result[propName] = list.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Object) {
                const object = this[propName];
                result[propName] = object.toJSON(options);
            }
            else if (property.type === BindingPropertyType.Dynamic) {
                const object = this[propName];
                result[propName] = object.toJSON(options);
            }
            else {
                // 1、对于多语录入字段；
                // 2、传入ignoreMultiLangInput标志，则取当前语言的值给控件。
                if (options && options.ignoreMultiLangInput === true && property.enableMultiLangInput === true) {
                    const multiLangValueObj = this.getValue(propName);
                    if (multiLangValueObj) {
                        result[propName] = multiLangValueObj[langCode];
                    }
                    else {
                        result[propName] = multiLangValueObj;
                    }
                }
                else {
                    result[propName] = this.getValue(propName);
                }
            }
        });
        return result;
    }
}
export { BindingObject };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZ19vYmplY3QuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1kYXRhL2JpbmRpbmdfb2JqZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUVILE9BQU8sRUFBRSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9DLE9BQU8sRUFBVSxVQUFVLEVBQWMsY0FBYyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzNFLE9BQU8sRUFBbUIsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUUxRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFNL0M7O0dBRUc7QUFDSCxNQUFNLGFBQWE7SUF5RGpCOzs7T0FHRztJQUNILFlBQVksVUFBNkI7UUF0QnpDOztXQUVHO1FBQ0ksd0JBQW1CLEdBQUcsS0FBSyxDQUFDO1FBRW5DOztXQUVHO1FBQ0ksZUFBVSxHQUFRLEVBQUUsQ0FBQztRQWUxQixJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztRQUM3QixJQUFJLENBQUMsVUFBVSxHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFekQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBZSxDQUFDO1FBQzFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQVUsQ0FBQztRQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksT0FBTyxFQUFjLENBQUM7SUFDL0MsQ0FBQztJQXBDRDs7T0FFRztJQUNILElBQVcsZUFBZTtRQUN4QixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDL0QsQ0FBQztJQVlEOztPQUVHO0lBQ0ksb0JB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TUFBTSxHQUFrQixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzdDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzNDO2lCQUFNO2dCQUVMLGNBQWM7Z0JBQ2QsMENBQTBDO2dCQUMxQyxJQUFJLE9BQU8sSUFBSSxPQUFPLENBQUMsb0JBQW9CLEtBQUssSUFBSSxJQUFJLFFBQVEsQ0FBQyxvQkFBb0IsS0FBSyxJQUFJLEVBQUU7b0JBQzlGLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDbEQsSUFBSSxpQkFBaUIsRUFBRTt3QkFDckIsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO3FCQUNoRDt5QkFBTTt3QkFDTCxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsaUJBQWlCLENBQUM7cUJBQ3RDO2lCQUNGO3FCQUFNO29CQUNMLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUM1QzthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDO0NBQ0Y7QUFFRCxPQUFPLEVBQUUsYUFBYSxFQUF1QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEJpbmRpbmdPYmplY3Tnm7jlhbPlrprkuYlcclxuICogQGF1dGhvciBXaXR0PGppd3RAaW5zcHVyLmNvbT5cclxuICovXHJcblxyXG5pbXBvcnQgeyBTdWJqZWN0LCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgQ2hhbmdlLCBDaGFuZ2VUeXBlLCBWaWV3Q2hhbmdlLCBWaWV3Q2hhbmdlVHlwZSB9IGZyb20gJy4vY2hhbmdlcyc7XHJcbmltcG9ydCB7IEJpbmRpbmdQcm9wZXJ0eSwgQmluZGluZ1Byb3BlcnR5VHlwZSB9IGZyb20gJy4vYmluZGluZ19wcm9wZXJ0eSc7XHJcbmltcG9ydCB7IEJpbmRpbmdMaXN0IH0gZnJvbSAnLi9iaW5kaW5nX2xpc3QnO1xyXG5pbXBvcnQgeyBQcm9wZXJ0eVV0aWwgfSBmcm9tICcuL3Byb3BlcnR5X3V0aWwnO1xyXG5cclxuaW50ZXJmYWNlIEludm9rZU9uVmFsdWVDaGFuZ2Uge1xyXG4gIChwcmVWYWx1ZSwgdmFsdWUsIGVudGl0eUNoYW5nZWQ6IGJvb2xlYW4pOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xyXG59XHJcblxyXG4vKipcclxuICogQmluZGluZ09iamVjdOaYr0VudGl0eeWcqOe7keWumuWxgueahOS4gOS4quW9seWwhO+8jOWug+WwhkVudGl0eeWGheeahOaVsOaNrui9rOaNouS4uuS4jeWPr+WPmOWvueixoe+8jOW5tueUqOS6jueVjOmdoue7keWumuOAglxyXG4gKi9cclxuY2xhc3MgQmluZGluZ09iamVjdCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIGltbXV0YWJsZeWAvOWvueixoVxyXG4gICAqL1xyXG4gIHByaXZhdGUgaW5uZXJWYWx1ZXM6IE1hcDxzdHJpbmcsIGFueT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOeItuWvueixoeaIlueItuWIl+ihqFxyXG4gICAqL1xyXG4gIHB1YmxpYyBwYXJlbnQ6IEJpbmRpbmdMaXN0IHwgQmluZGluZ09iamVjdDtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T5byV6LW355qE5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHVibGljIGNoYW5nZXM6IFN1YmplY3Q8Q2hhbmdlPjtcclxuXHJcbiAgLyoqXHJcbiAgICog55WM6Z2i5bGC5byV6LW355qE5Y+Y5pu05rWBXHJcbiAgICovXHJcbiAgcHVibGljIHZpZXdDaGFuZ2VzOiBTdWJqZWN0PFZpZXdDaGFuZ2U+O1xyXG5cclxuICAvKipcclxuICAgKiAg5bGe5oCn6ZuG5ZCIXHJcbiAgICovXHJcbiAgcHVibGljIHByb3BlcnRpZXM6IEJpbmRpbmdQcm9wZXJ0eVtdO1xyXG5cclxuICAvKipcclxuICAgKiDkuLvplK7lkI1cclxuICAgKi9cclxuICBwdWJsaWMgcHJpbWFyeUtleTogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDkuLvplK7lgLxcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0IHByaW1hcnlLZXlWYWx1ZSgpIHtcclxuICAgIHJldHVybiB0aGlzLnByaW1hcnlLZXkgPyB0aGlzLmdldFZhbHVlKHRoaXMucHJpbWFyeUtleSkgOiAnJztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagh+ivhuaYr+WQpuaPkOS6pOi/h1xyXG4gICAqL1xyXG4gIHB1YmxpYyBpc1Nob3dWYWxpZGF0aW9uTXNnID0gZmFsc2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7pXsgW3Byb3BlcnR5TmFtZV06IEZvcm1Db250cm9sIH3nmoTlvaLlvI/lrZjmlL7mr4/mnaHmlbDmja7nmoRjb250cm9sXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRyb2xNYXA6IGFueSA9IHt9O1xyXG5cclxuICAvKipcclxuICAgKiDorr7nva7mmK/lkKbmj5DkuqTov4dcclxuICAgKi9cclxuICBwdWJsaWMgc2V0U2hvd1ZhbGlkYXRpb25Nc2coZmxhZzogYm9vbGVhbikge1xyXG4gICAgdGhpcy5pc1Nob3dWYWxpZGF0aW9uTXNnID0gZmxhZztcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKiBAcGFyYW0gcHJvcGVydGllcyDlsZ7mgKfpm4blkIhcclxuICAgKi9cclxuICBjb25zdHJ1Y3Rvcihwcm9wZXJ0aWVzOiBCaW5kaW5nUHJvcGVydHlbXSkge1xyXG4gICAgdGhpcy5wcm9wZXJ0aWVzID0gcHJvcGVydGllcztcclxuICAgIHRoaXMucHJpbWFyeUtleSA9IFByb3BlcnR5VXRpbC5nZXRQcmltYXJ5S2V5KHByb3BlcnRpZXMpO1xyXG5cclxuICAgIHRoaXMuaW5uZXJWYWx1ZXMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gICAgdGhpcy5jaGFuZ2VzID0gbmV3IFN1YmplY3Q8Q2hhbmdlPigpO1xyXG4gICAgdGhpcy52aWV3Q2hhbmdlcyA9IG5ldyBTdWJqZWN0PFZpZXdDaGFuZ2U+KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja7lsZ7mgKflkI3ojrflj5blsZ7mgKflgLxcclxuICAgKiBAcGFyYW0gICBwcm9wZXJ0eU5hbWUg5bGe5oCn5ZCNXHJcbiAgICogQHJldHVybnMg5bGe5oCn5YC8XHJcbiAgICovXHJcbiAgcHVibGljIGdldFZhbHVlKHByb3BlcnR5TmFtZTogc3RyaW5nKTogYW55IHtcclxuICAgIHJldHVybiB0aGlzLmlubmVyVmFsdWVzLmdldChwcm9wZXJ0eU5hbWUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6K6+572u5bGe5oCn5YC8XHJcbiAgICogQHBhcmFtIHByb3BlcnR5TmFtZSAgICAgICAg5bGe5oCn5ZCNXHJcbiAgICogQHBhcmFtIHByb3BlcnR5VmFsdWUgICAgICAg5bGe5oCn5YC8XHJcbiAgICogQHBhcmFtIGVtaXRFdmVudFRvVmlldyAgICAg5piv5ZCm6YCa55+lVmlld+WxguWOu+abtOaWsOeVjOmdou+8jOm7mOiupOS4umZhbHNlXHJcbiAgICogQHBhcmFtIGVtaXRFdmVudFRvRW50aXR5ICAg5piv5ZCm6YCa55+lRW50aXR55bGC5Y675pu05paw5YC877yM6buY6K6k5Li6ZmFsc2VcclxuICAgKiBAcGFyYW0gZXJyb3JzICAgICAgICAgICAgICDplJnor6/mtojmga9cclxuICAgKiBAcGFyYW0gaW52b2tlT25WYWx1ZUNoYW5nZSDlgLzlj5jljJbkuovku7bmiafooYzlj6Xmn4RcclxuICAgKi9cclxuICBwdWJsaWMgc2V0VmFsdWUoXHJcbiAgICBwcm9wZXJ0eU5hbWU6IHN0cmluZywgcHJvcGVydHlWYWx1ZTogYW55LFxyXG4gICAgZW1pdEV2ZW50VG9WaWV3OiBib29sZWFuID0gZmFsc2UsIGVtaXRFdmVudFRvRW50aXR5OiBib29sZWFuID0gZmFsc2UsXHJcbiAgICBlcnJvcnM/OiBhbnksIGludm9rZU9uVmFsdWVDaGFuZ2U/OiBJbnZva2VPblZhbHVlQ2hhbmdlXHJcbiAgKTogdm9pZCB7XHJcblxyXG4gICAgY29uc3Qgb2xkUHJvcGVydHlWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUocHJvcGVydHlOYW1lKTtcclxuXHJcbiAgICAvLyDnlLHkuo7nibnlrprljp/lm6DvvIhA6YK154+g5by677yJ77yM5peg5rOV5bGP6JS9b2xkUHJvcGVydHlWYWx1ZSA9PT0gcHJvcGVydHlWYWx1ZVxyXG4gICAgaWYgKG9sZFByb3BlcnR5VmFsdWUgPT09IHByb3BlcnR5VmFsdWUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghaW52b2tlT25WYWx1ZUNoYW5nZSB8fCBvbGRQcm9wZXJ0eVZhbHVlID09PSBwcm9wZXJ0eVZhbHVlKSB7XHJcbiAgICAgIC8vIOiuvuWumue8uuecgVxyXG4gICAgICBpbnZva2VPblZhbHVlQ2hhbmdlID0gZnVuY3Rpb24gKHByZVZhbHVlLCB2YWx1ZSwgZW50aXR5Q2hhbmdlZDogYm9vbGVhbikge1xyXG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZW1pdEV2ZW50VG9FbnRpdHkgPT09IHRydWUpIHtcclxuICAgICAgLy8gQlVHIDMyMjMwMe+8jOWIoOmZpEAyMDE5LjA4LjEwOyDlpoLmnpzml6Dlr7nlupTlrp7kvZPvvIzliJnkuK3mraLlgLzkvKDpgJI7IOi/meenjeaDheWGteWPkeeUn+WcqOW4puS7juihqOeahOWNleaNruaWsOWinu+8jOS7juihqOWTjeW6lExvYWTlj5jljJbnmoTmg4XlhrXvvJtcclxuICAgICAgLy8gaWYoIXRoaXMuaW5uZXJWYWx1ZXMuaGFzKHByb3BlcnR5TmFtZSkpIHtcclxuICAgICAgLy8gICByZXR1cm47XHJcbiAgICAgIC8vIH1cclxuICAgICAgLy8g5omn6KGM5a6e5L2T5YC85Y+Y5YyW5YmN5LqL5Lu2XHJcbiAgICAgIGludm9rZU9uVmFsdWVDaGFuZ2Uob2xkUHJvcGVydHlWYWx1ZSwgcHJvcGVydHlWYWx1ZSwgZmFsc2UpLnN1YnNjcmliZSgocmVzdWx0KSA9PiB7XHJcbiAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgLy8g5aaC5p6c5oiQ5Yqf77yM5omn6KGM5Y+Y5YyW77yM5bm26YCa55+l5a6e5L2T5Y+Y5YyWXHJcbiAgICAgICAgICB0aGlzLmlubmVyVmFsdWVzID0gdGhpcy5pbm5lclZhbHVlcy5zZXQocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlKTtcclxuICAgICAgICAgIGNvbnN0IHZpZXdDaGFuZ2UgPSB7XHJcbiAgICAgICAgICAgIHR5cGU6IFZpZXdDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCxcclxuICAgICAgICAgICAgcGF0aDogW3Byb3BlcnR5TmFtZV0sXHJcbiAgICAgICAgICAgIHZhbHVlOiBwcm9wZXJ0eVZhbHVlLFxyXG4gICAgICAgICAgICBlcnJvcnM6IGVycm9yc1xyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHRoaXMudmlld0NoYW5nZXMubmV4dCh2aWV3Q2hhbmdlKTtcclxuICAgICAgICAgIC8vIOWmguaenOmcgOimgemAmuefpeinhuWbvu+8jOmAmuefpeinhuWbvuebuOW6lOS/ruaUuVxyXG4gICAgICAgICAgaWYgKGVtaXRFdmVudFRvVmlldyA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICB0aGlzLmNoYW5nZXMubmV4dCh7XHJcbiAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5WYWx1ZUNoYW5nZWQsXHJcbiAgICAgICAgICAgICAgcGF0aDogW3Byb3BlcnR5TmFtZV0sXHJcbiAgICAgICAgICAgICAgdmFsdWU6IHByb3BlcnR5VmFsdWUsXHJcbiAgICAgICAgICAgICAgaWQ6IHRoaXMucHJpbWFyeUtleVZhbHVlLFxyXG4gICAgICAgICAgICAgIGVycm9yczogZXJyb3JzXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgLy8g5omn6KGM5a6e5L2T5YC85Y+Y5YyW5ZCO5LqL5Lu2XHJcbiAgICAgICAgICBpbnZva2VPblZhbHVlQ2hhbmdlKG9sZFByb3BlcnR5VmFsdWUsIHByb3BlcnR5VmFsdWUsIHRydWUpLnN1YnNjcmliZSgpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyDlpoLmnpzlpLHotKXvvIzkuI3lho3pgJrnn6Xlrp7kvZPlj5jljJZcclxuICAgICAgICAgIC8vIOW5tuaJp+ihjOeVjOmdouWbnua7muaTjeS9nFxyXG4gICAgICAgICAgdGhpcy5jaGFuZ2VzLm5leHQoe1xyXG4gICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlZhbHVlQ2hhbmdlZCxcclxuICAgICAgICAgICAgcGF0aDogW3Byb3BlcnR5TmFtZV0sXHJcbiAgICAgICAgICAgIHZhbHVlOiBvbGRQcm9wZXJ0eVZhbHVlLFxyXG4gICAgICAgICAgICBpZDogdGhpcy5wcmltYXJ5S2V5VmFsdWUsXHJcbiAgICAgICAgICAgIGVycm9yczogZXJyb3JzXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gYGVtaXRFdmVudFRvRW50aXR5ID09PSBmYWxzZWAsIOWImeiupOWumuWunuS9k+WAvOW3sue7j+WPkeeUn+WPmOWMlu+8jOmAmuefpeinhuWbvuWPmOWMlu+8jOW5tuinpuWPkeWunuS9k+WAvOWPmOWMluWQjuS6i+S7tlxyXG4gICAgICB0aGlzLmlubmVyVmFsdWVzID0gdGhpcy5pbm5lclZhbHVlcy5zZXQocHJvcGVydHlOYW1lLCBwcm9wZXJ0eVZhbHVlKTtcclxuICAgICAgaWYgKGVtaXRFdmVudFRvVmlldyA9PT0gdHJ1ZSkge1xyXG4gICAgICAgIHRoaXMuY2hhbmdlcy5uZXh0KHtcclxuICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVmFsdWVDaGFuZ2VkLFxyXG4gICAgICAgICAgcGF0aDogW3Byb3BlcnR5TmFtZV0sXHJcbiAgICAgICAgICB2YWx1ZTogcHJvcGVydHlWYWx1ZSxcclxuICAgICAgICAgIGlkOiB0aGlzLnByaW1hcnlLZXlWYWx1ZSxcclxuICAgICAgICAgIGVycm9yczogZXJyb3JzXHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgLy8g5omn6KGM5a6e5L2T5YC85Y+Y5YyW5ZCO5LqL5Lu2XHJcbiAgICAgIGludm9rZU9uVmFsdWVDaGFuZ2Uob2xkUHJvcGVydHlWYWx1ZSwgcHJvcGVydHlWYWx1ZSwgdHJ1ZSkuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIZCaW5kaW5nT2JqZWN05a6e5L6L6L2s5o2i5oiQSlNPTuWvueixoVxyXG4gICAqL1xyXG4gIHB1YmxpYyB0b0pTT04ob3B0aW9ucz86IGFueSk6IGFueSB7XHJcbiAgICBjb25zdCBsYW5nQ29kZSA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnbGFuZ3VhZ2VDb2RlJykgfHwgJ3poLUNIUyc7XHJcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcclxuICAgIHRoaXMucHJvcGVydGllcy5mb3JFYWNoKChwcm9wZXJ0eTogQmluZGluZ1Byb3BlcnR5KSA9PiB7XHJcbiAgICAgIGNvbnN0IHByb3BOYW1lID0gcHJvcGVydHkubmFtZTtcclxuICAgICAgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuTGlzdCkge1xyXG4gICAgICAgIGNvbnN0IGxpc3Q6IEJpbmRpbmdMaXN0ID0gdGhpc1twcm9wTmFtZV07XHJcbiAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IGxpc3QudG9KU09OKG9wdGlvbnMpO1xyXG4gICAgICB9IGVsc2UgaWYgKHByb3BlcnR5LnR5cGUgPT09IEJpbmRpbmdQcm9wZXJ0eVR5cGUuT2JqZWN0KSB7XHJcbiAgICAgICAgY29uc3Qgb2JqZWN0OiBCaW5kaW5nT2JqZWN0ID0gdGhpc1twcm9wTmFtZV07XHJcbiAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IG9iamVjdC50b0pTT04ob3B0aW9ucyk7XHJcbiAgICAgIH0gZWxzZSBpZiAocHJvcGVydHkudHlwZSA9PT0gQmluZGluZ1Byb3BlcnR5VHlwZS5EeW5hbWljKSB7XHJcbiAgICAgICAgY29uc3Qgb2JqZWN0OiBCaW5kaW5nT2JqZWN0ID0gdGhpc1twcm9wTmFtZV07XHJcbiAgICAgICAgcmVzdWx0W3Byb3BOYW1lXSA9IG9iamVjdC50b0pTT04ob3B0aW9ucyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgIC8vIDHjgIHlr7nkuo7lpJror63lvZXlhaXlrZfmrrXvvJtcclxuICAgICAgICAvLyAy44CB5Lyg5YWlaWdub3JlTXVsdGlMYW5nSW5wdXTmoIflv5fvvIzliJnlj5blvZPliY3or63oqIDnmoTlgLznu5nmjqfku7bjgIJcclxuICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmlnbm9yZU11bHRpTGFuZ0lucHV0ID09PSB0cnVlICYmIHByb3BlcnR5LmVuYWJsZU11bHRpTGFuZ0lucHV0ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICBjb25zdCBtdWx0aUxhbmdWYWx1ZU9iaiA9IHRoaXMuZ2V0VmFsdWUocHJvcE5hbWUpO1xyXG4gICAgICAgICAgaWYgKG11bHRpTGFuZ1ZhbHVlT2JqKSB7XHJcbiAgICAgICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSBtdWx0aUxhbmdWYWx1ZU9ialtsYW5nQ29kZV07XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXN1bHRbcHJvcE5hbWVdID0gbXVsdGlMYW5nVmFsdWVPYmo7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHJlc3VsdFtwcm9wTmFtZV0gPSB0aGlzLmdldFZhbHVlKHByb3BOYW1lKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgeyBCaW5kaW5nT2JqZWN0LCBJbnZva2VPblZhbHVlQ2hhbmdlIH07XHJcbiJdfQ==