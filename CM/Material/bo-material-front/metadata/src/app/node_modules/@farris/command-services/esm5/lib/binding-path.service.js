import { Injectable, Injector } from "@angular/core";
import { AppContext, Repository } from "@farris/devkit";
var BindingPathService = /** @class */ (function () {
    function BindingPathService(injector, appContext, repository) {
        this.injector = injector;
        this.appContext = appContext;
        this.repository = repository;
    }
    /**
     * 获取组件上下文的绑定路径
     * @param frameContext 组件上下文
     * @returns
     */
    BindingPathService.prototype.getBindingPathsByFrameContext = function (frameContext) {
        return frameContext && frameContext.viewModel && frameContext.viewModel.bindingPath && frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; }) || null;
    };
    /**
     * 通过BE表名获取bindingPath
     * @param dataTypeInfo
     * @param tableName
     * @param paths
     * @param level
     * @returns
     */
    BindingPathService.prototype.getBindingPathsByTableName = function (dataTypeInfo, tableName, paths, level) {
        if (paths === void 0) { paths = []; }
        if (level === void 0) { level = 0; }
        level++;
        if (dataTypeInfo.entityInfo && (dataTypeInfo.entityInfo.nodeCode === tableName || dataTypeInfo.entityInfo.originalCode === tableName)) {
            if (level !== 1) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
            }
            return paths;
        }
        var props = Array.from(dataTypeInfo.propInfoMap.values()).filter(function (p) { return p.typeInfo; });
        if (props.length < 1) {
            paths = [];
            return paths;
        }
        if (dataTypeInfo.entityInfo) {
            if (level !== 1) {
                paths.push(dataTypeInfo.entityInfo.nodeCode);
            }
        }
        for (var idx = 0; idx < props.length; idx++) {
            var dataTypeInfo_1 = props[idx].typeInfo;
            var path = this.getBindingPathsByTableName(dataTypeInfo_1, tableName, paths, level);
            if (!path || path.length < 1) {
                continue;
            }
            else {
                paths = paths.concat(path);
                return paths;
            }
        }
        return null;
    };
    /**
     * 获取属性路径中的绑定路径
     * @param paths paths
     * @param entityTypeInfo
     * @returns
     */
    BindingPathService.prototype.getBindingPathsByPath = function (paths, entityTypeInfo) {
        var nodeCodes = [];
        if (typeof paths === 'string') {
            paths = paths.split('/').filter(function (p) { return p; });
        }
        paths = paths.concat([]);
        while (paths.length > 0) {
            var dataPropInfo = entityTypeInfo.getPropInfoByPath(paths);
            if (dataPropInfo.group === 'List') {
                nodeCodes = paths;
                break;
            }
            paths.pop();
        }
        return nodeCodes;
    };
    /**
     * 获取属性路径信息
     * @param path 属性路径
     * @returns
     */
    BindingPathService.prototype.getPathInfo = function (path) {
        var paths = path.split('/').filter(function (p) { return p; });
        // 获取最大实体层级，其余为属性（简单属性、udt、关联、关联嵌套关联）
        var entityPath = this.getBindingPathsByPath(paths, this.repository.entityTypeInfo);
        var propertyName = paths.slice(entityPath.length).join('/');
        return { bindingPath: entityPath.join('/'), propertyName: propertyName, bindingPaths: entityPath, propertyNames: propertyName.split('/').filter(function (p) { return p; }) };
    };
    BindingPathService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BindingPathService.ctorParameters = function () { return [
        { type: Injector },
        { type: AppContext },
        { type: Repository }
    ]; };
    return BindingPathService;
}());
export { BindingPathService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmluZGluZy1wYXRoLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYmluZGluZy1wYXRoLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBc0MsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFNUY7SUFFRSw0QkFBb0IsUUFBa0IsRUFBVSxVQUFzQixFQUFVLFVBQThCO1FBQTFGLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQVUsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7SUFBSSxDQUFDO0lBQ25IOzs7O09BSUc7SUFDSSwwREFBNkIsR0FBcEMsVUFBcUMsWUFBMEI7UUFDN0QsT0FBTyxZQUFZLElBQUksWUFBWSxDQUFDLFNBQVMsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztJQUM5SixDQUFDO0lBQ0Q7Ozs7Ozs7T0FPRztJQUNJLHVEQUEwQixHQUFqQyxVQUFrQyxZQUEwQixFQUFFLFNBQWlCLEVBQUUsS0FBb0IsRUFBRSxLQUFpQjtRQUF2QyxzQkFBQSxFQUFBLFVBQW9CO1FBQUUsc0JBQUEsRUFBQSxTQUFpQjtRQUN0SCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksWUFBWSxDQUFDLFVBQVUsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsUUFBUSxLQUFLLFNBQVMsSUFBSSxZQUFZLENBQUMsVUFBVSxDQUFDLFlBQVksS0FBSyxTQUFTLENBQUMs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QU8sRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxZQUFZLGNBQUEsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzlJLENBQUM7O2dCQW5GRixVQUFVOzs7O2dCQUhVLFFBQVE7Z0JBQ3BCLFVBQVU7Z0JBQXNDLFVBQVU7O0lBc0ZuRSx5QkFBQztDQUFBLEFBcEZELElBb0ZDO1NBbkZZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEFwcENvbnRleHQsIERhdGFUeXBlSW5mbywgRW50aXR5LCBGcmFtZUNvbnRleHQsIFJlcG9zaXRvcnkgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJpbmRpbmdQYXRoU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLCBwcml2YXRlIGFwcENvbnRleHQ6IEFwcENvbnRleHQsIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxFbnRpdHk+KSB7IH1cbiAgLyoqXG4gICAqIOiOt+WPlue7hOS7tuS4iuS4i+aWh+eahOe7keWumui3r+W+hFxuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IOe7hOS7tuS4iuS4i+aWh1xuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRCaW5kaW5nUGF0aHNCeUZyYW1lQ29udGV4dChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkgfHwgbnVsbDtcbiAgfVxuICAvKipcbiAgICog6YCa6L+HQkXooajlkI3ojrflj5ZiaW5kaW5nUGF0aFxuICAgKiBAcGFyYW0gZGF0YVR5cGVJbmZvIFxuICAgKiBAcGFyYW0gdGFibGVOYW1lIFxuICAgKiBAcGFyYW0gcGF0aHMgXG4gICAqIEBwYXJhbSBsZXZlbFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHB1YmxpYyBnZXRCaW5kaW5nUGF0aHNCeVRhYmxlTmFtZShkYXRhVHlwZUluZm86IERhdGFUeXBlSW5mbywgdGFibGVOYW1lOiBzdHJpbmcsIHBhdGhzOiBzdHJpbmdbXSA9IFtdLCBsZXZlbDogbnVtYmVyID0gMCk6IHN0cmluZ1tdIHtcbiAgICBsZXZlbCsrO1xuICAgIGlmIChkYXRhVHlwZUluZm8uZW50aXR5SW5mbyAmJiAoZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUgPT09IHRhYmxlTmFtZSB8fCBkYXRhVHlwZUluZm8uZW50aXR5SW5mby5vcmlnaW5hbENvZGUgPT09IHRhYmxlTmFtZSkpIHtcbiAgICAgIGlmIChsZXZlbCAhPT0gMSkge1xuICAgICAgICBwYXRocy5wdXNoKGRhdGFUeXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBwYXRocztcbiAgICB9XG4gICAgY29uc3QgcHJvcHMgPSBBcnJheS5mcm9tKGRhdGFUeXBlSW5mby5wcm9wSW5mb01hcC52YWx1ZXMoKSkuZmlsdGVyKHAgPT4gcC50eXBlSW5mbyk7XG4gICAgaWYgKHByb3BzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHBhdGhzID0gW107XG4gICAgICByZXR1cm4gcGF0aHM7XG4gICAgfVxuICAgIGlmIChkYXRhVHlwZUluZm8uZW50aXR5SW5mbykge1xuICAgICAgaWYgKGxldmVsICE9PSAxKSB7XG4gICAgICAgIHBhdGhzLnB1c2goZGF0YVR5cGVJbmZvLmVudGl0eUluZm8ubm9kZUNvZGUpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAobGV0IGlkeCA9IDA7IGlkeCA8IHByb3BzLmxlbmd0aDsgaWR4KyspIHtcbiAgICAgIGNvbnN0IGRhdGFUeXBlSW5mbyA9IHByb3BzW2lkeF0udHlwZUluZm87XG4gICAgICBjb25zdCBwYXRoID0gdGhpcy5nZXRCaW5kaW5nUGF0aHNCeVRhYmxlTmFtZShkYXRhVHlwZUluZm8sIHRhYmxlTmFtZSwgcGF0aHMsIGxldmVsKTtcbiAgICAgIGlmICghcGF0aCB8fCBwYXRoLmxlbmd0aCA8IDEpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwYXRocyA9IHBhdGhzLmNvbmNhdChwYXRoKTtcbiAgICAgICAgcmV0dXJuIHBhdGhzO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5bGe5oCn6Lev5b6E5Lit55qE57uR5a6a6Lev5b6EXG4gICAqIEBwYXJhbSBwYXRocyBwYXRoc1xuICAgKiBAcGFyYW0gZW50aXR5VHlwZUluZm8gXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGdldEJpbmRpbmdQYXRoc0J5UGF0aChwYXRoczogc3RyaW5nW10gfCBzdHJpbmcsIGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8pOiBzdHJpbmdbXSB7XG4gICAgbGV0IG5vZGVDb2RlcyA9IFtdO1xuICAgIGlmICh0eXBlb2YgcGF0aHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICBwYXRocyA9IHBhdGhzLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgfVxuICAgIHBhdGhzID0gcGF0aHMuY29uY2F0KFtdKTtcbiAgICB3aGlsZSAocGF0aHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgZGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xuICAgICAgaWYgKGRhdGFQcm9wSW5mby5ncm91cCA9PT0gJ0xpc3QnKSB7XG4gICAgICAgIG5vZGVDb2RlcyA9IHBhdGhzO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIHBhdGhzLnBvcCgpO1xuICAgIH1cbiAgICByZXR1cm4gbm9kZUNvZGVzO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5blsZ7mgKfot6/lvoTkv6Hmga9cbiAgICogQHBhcmFtIHBhdGgg5bGe5oCn6Lev5b6EXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGdldFBhdGhJbmZvKHBhdGg6IHN0cmluZyk6IHsgYmluZGluZ1BhdGg6IHN0cmluZywgcHJvcGVydHlOYW1lOiBzdHJpbmcsIGJpbmRpbmdQYXRoczogc3RyaW5nW10sIHByb3BlcnR5TmFtZXM6IHN0cmluZ1tdIH0ge1xuICAgIGNvbnN0IHBhdGhzID0gcGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIC8vIOiOt+WPluacgOWkp+WunuS9k+Wxgue6p++8jOWFtuS9meS4uuWxnuaAp++8iOeugOWNleWxnuaAp+OAgXVkdOOAgeWFs+iBlOOAgeWFs+iBlOW1jOWll+WFs+iBlO+8iVxuICAgIGNvbnN0IGVudGl0eVBhdGggPSB0aGlzLmdldEJpbmRpbmdQYXRoc0J5UGF0aChwYXRocywgdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvKTtcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWUgPSBwYXRocy5zbGljZShlbnRpdHlQYXRoLmxlbmd0aCkuam9pbignLycpO1xuICAgIHJldHVybiB7IGJpbmRpbmdQYXRoOiBlbnRpdHlQYXRoLmpvaW4oJy8nKSwgcHJvcGVydHlOYW1lLCBiaW5kaW5nUGF0aHM6IGVudGl0eVBhdGgsIHByb3BlcnR5TmFtZXM6IHByb3BlcnR5TmFtZS5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApIH07XG4gIH1cbn0iXX0=