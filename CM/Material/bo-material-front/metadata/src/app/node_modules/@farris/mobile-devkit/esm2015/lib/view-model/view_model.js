import { MetadataUtil } from '../core/index';
import { Repository } from '../repository/index';
import { CommandBus } from '../command/index';
import { BindingData } from '../binding-data/index';
import { UIState } from '../ui-state/index';
import { StateMachine } from '../state-machine/index';
import { Form } from '../form/index';
import { ViewModelContext } from './view_model_context';
import { COMMAND_METHOD_META } from './decorators';
import { EMPTY, from, of } from 'rxjs';
import { concatMap, every, tap } from 'rxjs/operators';
class ViewModel {
    /**
     * 构造函数
     */
    constructor(injector, id) {
        this.injector = injector;
        this.id = id;
    }
    /**
     * 初始化
     */
    init() {
        this.initRepository();
        this.initContext();
        this.initBindingData();
        this.initUIState();
        this.intiStateMachine();
        this.initForm();
        this.initCommandBus();
        this.registerWithParent();
        this.initListeners();
        this.closeOldBeSession();
    }
    initRepository() {
        this.repository = this.injector.get(Repository);
    }
    initContext() {
        this.context = this.injector.get(ViewModelContext);
        this.context.init(this);
    }
    initBindingData() {
        this.bindingData = this.context.injector.get(BindingData);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory((paths) => {
                return (preValue, value, entityChanged, primaryValue) => {
                    const plainPath = '/' + paths.join('/');
                    let command;
                    if (entityChanged === false) {
                        command = this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        const change = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            changed: entityChanged
                        };
                        const commands = command.split(';').filter(p => p);
                        let valueChangeSuccess = true;
                        return from(commands).pipe(concatMap(item => {
                            if (!valueChangeSuccess) {
                                return EMPTY;
                            }
                            return this[item](change).pipe(tap((result) => {
                                valueChangeSuccess = result;
                            }));
                        }), every((result) => result));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        const repositoryName = this.repository.name;
        const bindingDataManager = this.context.appContext.bindingDataManager;
        const repositoryBindingData = bindingDataManager.getBindingDataByName(repositoryName);
        this.bindingData.initByBindingList(repositoryBindingData.list, this.context);
    }
    initUIState() {
        this.uiState = this.injector.get(UIState);
    }
    intiStateMachine() {
        this.stateMachine = this.injector.get(StateMachine, null);
        if (!this.stateMachine) {
            return;
        }
        this.stateMachine.init(this.context);
    }
    initForm() {
        this.form = this.injector.get(Form, null);
        this.form.init();
    }
    initCommandBus() {
        this.commandBus = this.injector.get(CommandBus);
        this.extendCommandMethods();
    }
    extendCommandMethods() {
        this.ngCommands = MetadataUtil.getPropsMetadatasByName(this.constructor, COMMAND_METHOD_META);
        this.keybindingMap = new Map();
        Object.keys(this.ngCommands).forEach((propName) => {
            const ngCommand = this.ngCommands[propName];
            Object.defineProperty(this, propName, {
                value: (eventParams) => {
                    const command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: eventParams || null
                    };
                    return this.commandBus.dispatch(command);
                }
            });
            if (ngCommand.keyBinding) {
                this.keybindingMap.set(propName, ngCommand.keyBinding);
            }
        });
    }
    registerWithParent() {
        const parentContext = this.context.parent;
        if (!parentContext || !parentContext.viewModel || !parentContext.viewModel['childViewModels']) {
            return;
        }
        const parentViewModel = parentContext.viewModel;
        const className = this.constructor.name;
        const propName = parentViewModel['childViewModels'][className];
        parentViewModel[propName] = this;
    }
    /**
     * 关闭老的BeSession
     */
    closeOldBeSession() {
        const allViewModelContexts = this.context.appContext.viewModelContextManager.getContexts();
        if (allViewModelContexts.length === 1 && allViewModelContexts[0] === this.context) {
            this.context.repository.reset();
        }
    }
    /**
   * 从Form获取监听器
   */
    initListeners() {
        const extractPath = (bindingBasePath, bindingPath) => {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter((item) => item.length > 0).join('/');
        };
        if (this.form) {
            const valueChangingListeners = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners).forEach((bindingPath) => {
                const plainPath = extractPath(this.bindingPath, bindingPath);
                this.entityValueChangingListeners[plainPath] = valueChangingListeners[bindingPath];
            });
            const valueChangedListeners = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners).forEach((bindingPath) => {
                const plainPath = extractPath(this.bindingPath, bindingPath);
                this.entityValueChangedListeners[plainPath] = valueChangedListeners[bindingPath];
            });
        }
    }
}
export { ViewModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld19tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi92aWV3LW1vZGVsL3ZpZXdfbW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUc3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFXLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxXQUFXLEVBQTBDLE1BQU0sdUJBQXVCLENBQUM7QUFDNUYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXhELE9BQU8sRUFBRSxtQkFBbUIsRUFBcUMsTUFBTSxjQUFjLENBQUM7QUFDdEYsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZELE1BQWUsU0FBUztJQXdFdEI7O09BRUc7SUFDSCxZQUFtQixRQUFrQixFQUFFLEVBQVU7UUFDL0MsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDSSxJQUFJO1FBQ1QsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsZUFBZSxFQUFF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QkFDMUQsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQzdELElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxTQUFTLENBQUMsR0FBRyxzQkFBc0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNyRixDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0scUJBQXFCLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyw4QkFBOEIsRUFBRSxDQUFDO1lBQ3pFLE1BQU0sQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtnQkFDekQsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQzdELElBQUksQ0FBQywyQkFBMkIsQ0FBQyxTQUFTLENBQUMsR0FBRyxxQkFBcUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNuRixDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztDQUVGO0FBRUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWV0YWRhdGFVdGlsIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcbmltcG9ydCB7IEluamVjdG9yIH0gZnJvbSAnLi4vY29yZS9pbmRleCc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4uL2VudGl0eS9pbmRleCc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L2luZGV4JztcclxuaW1wb3J0IHsgQ29tbWFuZCwgQ29tbWFuZEJ1cyB9IGZyb20gJy4uL2NvbW1hbmQvaW5kZXgnO1xyXG5pbXBvcnQgeyBCaW5kaW5nRGF0YSwgRW50aXR5VmFsdWVDaGFuZ2UsIEludm9rZU9uVmFsdWVDaGFuZ2UgfSBmcm9tICcuLi9iaW5kaW5nLWRhdGEvaW5kZXgnO1xyXG5pbXBvcnQgeyBVSVN0YXRlIH0gZnJvbSAnLi4vdWktc3RhdGUvaW5kZXgnO1xyXG5pbXBvcnQgeyBTdGF0ZU1hY2hpbmUgfSBmcm9tICcuLi9zdGF0ZS1tYWNoaW5lL2luZGV4JztcclxuaW1wb3J0IHsgRm9ybSB9IGZyb20gJy4uL2Zvcm0vaW5kZXgnO1xyXG5pbXBvcnQgeyBWaWV3TW9kZWxDb250ZXh0IH0gZnJvbSAnLi92aWV3X21vZGVsX2NvbnRleHQnO1xyXG5cclxuaW1wb3J0IHsgQ09NTUFORF9NRVRIT0RfTUVUQSwgQ29tbWFuZE1ldGhvZE1ldGFkYXRhLCBLZXliaW5kaW5nIH0gZnJvbSAnLi9kZWNvcmF0b3JzJztcclxuaW1wb3J0IHsgRU1QVFksIGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGNvbmNhdE1hcCwgZXZlcnksIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmFic3RyYWN0IGNsYXNzIFZpZXdNb2RlbCB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOWRveS7pOWFg+aVsOaNrumbhuWQiFxyXG4gICAqL1xyXG4gIHB1YmxpYyBuZ0NvbW1hbmRzOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogQ29tbWFuZE1ldGhvZE1ldGFkYXRhIH07XHJcblxyXG4gIC8qKlxyXG4gICAqIOWQjeensFxyXG4gICAqL1xyXG4gIHB1YmxpYyBpZDogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDms6jlhaXlmahcclxuICAgKi9cclxuICBwdWJsaWMgaW5qZWN0b3I6IEluamVjdG9yO1xyXG5cclxuICAvKipcclxuICAgKiDop4blm77mqKHlnovkuIrkuIvmlodcclxuICAgKi9cclxuICBwdWJsaWMgY29udGV4dDogVmlld01vZGVsQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog5pWw5o2u5LuT5bqTXHJcbiAgICovXHJcbiAgcHVibGljIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8RW50aXR5PjtcclxuXHJcbiAgLyoqXHJcbiAgICog57uR5a6a6Lev5b6EXHJcbiAgICovXHJcbiAgcHVibGljIGJpbmRpbmdQYXRoOiBzdHJpbmc7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaVsOaNrueKtuaAgVxyXG4gICAqL1xyXG4gIHB1YmxpYyBiaW5kaW5nRGF0YTogQmluZGluZ0RhdGE7XHJcblxyXG4gIC8qKlxyXG4gICAqIFVJ54q25oCBXHJcbiAgICovXHJcbiAgcHVibGljIHVpU3RhdGU6IFVJU3RhdGU7XHJcblxyXG4gIC8qKlxyXG4gICAqIOeKtuaAgeaculxyXG4gICAqL1xyXG4gIHB1YmxpYyBzdGF0ZU1hY2hpbmU6IFN0YXRlTWFjaGluZTtcclxuXHJcbiAgLyoqXHJcbiAgICog6KGo5Y2VXHJcbiAgICovXHJcbiAgcHVibGljIGZvcm06IEZvcm07XHJcblxyXG4gIC8qKlxyXG4gICAqIOWRveS7pOaAu+e6v1xyXG4gICAqL1xyXG4gIHB1YmxpYyBjb21tYW5kQnVzOiBDb21tYW5kQnVzO1xyXG5cclxuICAvKipcclxuICAgKiDlv6vmjbfplK7mmKDlsIRcclxuICAgKi9cclxuICBwdWJsaWMga2V5YmluZGluZ01hcDogTWFwPHN0cmluZywgS2V5YmluZGluZz47XHJcblxyXG4gIC8qKlxyXG4gICAqIOWAvOWPmOWMluWJjeebkeWQrOWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyczogTWFwPHN0cmluZywgc3RyaW5nPjtcclxuXHJcbiAgLyoqXHJcbiAgICog5YC85Y+Y5YyW5ZCO55uR5ZCs5ZmoXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBlbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIHN0cmluZz47XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihpbmplY3RvcjogSW5qZWN0b3IsIGlkOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuaW5qZWN0b3IgPSBpbmplY3RvcjtcclxuICAgIHRoaXMuaWQgPSBpZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIneWni+WMllxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbml0KCkge1xyXG4gICAgdGhpcy5pbml0UmVwb3NpdG9yeSgpO1xyXG4gICAgdGhpcy5pbml0Q29udGV4dCgpO1xyXG4gICAgdGhpcy5pbml0QmluZGluZ0RhdGEoKTtcclxuICAgIHRoaXMuaW5pdFVJU3RhdGUoKTtcclxuICAgIHRoaXMuaW50aVN0YXRlTWFjaGluZSgpO1xyXG4gICAgdGhpcy5pbml0Rm9ybSgpO1xyXG4gICAgdGhpcy5pbml0Q29tbWFuZEJ1cygpO1xyXG4gICAgdGhpcy5yZWdpc3RlcldpdGhQYXJlbnQoKTtcclxuICAgIHRoaXMuaW5pdExpc3RlbmVycygpO1xyXG4gICAgdGhpcy5jbG9zZU9sZEJlU2Vzc2lvbigpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0UmVwb3NpdG9yeSgpIHtcclxuICAgIHRoaXMucmVwb3NpdG9yeSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFJlcG9zaXRvcnkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0Q29udGV4dCgpIHtcclxuICAgIHRoaXMuY29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PFZpZXdNb2RlbENvbnRleHQ+KFZpZXdNb2RlbENvbnRleHQpO1xyXG4gICAgdGhpcy5jb250ZXh0LmluaXQodGhpcyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRCaW5kaW5nRGF0YSgpIHtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEgPSB0aGlzLmNvbnRleHQuaW5qZWN0b3IuZ2V0KEJpbmRpbmdEYXRhKTtcclxuICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVycyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVycyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICBpZiAodGhpcy5iaW5kaW5nRGF0YSkge1xyXG4gICAgICB0aGlzLmJpbmRpbmdEYXRhLnNldFZhbHVlQ2hhbmdlSW52b2tlckZhY3RvcnkoKHBhdGhzOiBzdHJpbmdbXSk6IEludm9rZU9uVmFsdWVDaGFuZ2UgPT4ge1xyXG4gICAgICAgIHJldHVybiAocHJlVmFsdWUsIHZhbHVlLCBlbnRpdHlDaGFuZ2VkOiBib29sZWFuLCBwcmltYXJ5VmFsdWU/OiBhbnkpOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0+IHtcclxuICAgICAgICAgIGNvbnN0IHBsYWluUGF0aCA9ICcvJyArIHBhdGhzLmpvaW4oJy8nKTtcclxuICAgICAgICAgIGxldCBjb21tYW5kOiBzdHJpbmc7XHJcbiAgICAgICAgICBpZiAoZW50aXR5Q2hhbmdlZCA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1twbGFpblBhdGhdO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzW3BsYWluUGF0aF07XHJcbiAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgaWYgKCEhY29tbWFuZCkge1xyXG4gICAgICAgICAgICBjb25zdCBjaGFuZ2U6IEVudGl0eVZhbHVlQ2hhbmdlID0ge1xyXG4gICAgICAgICAgICAgIHBhdGhzOiBwYXRocyxcclxuICAgICAgICAgICAgICBwcmVWYWx1ZTogcHJlVmFsdWUsXHJcbiAgICAgICAgICAgICAgdmFsdWU6IHZhbHVlLFxyXG4gICAgICAgICAgICAgIGNoYW5nZWQ6IGVudGl0eUNoYW5nZWRcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY29uc3QgY29tbWFuZHMgPSBjb21tYW5kLnNwbGl0KCc7JykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICAgIGxldCB2YWx1ZUNoYW5nZVN1Y2Nlc3MgPSB0cnVlO1xyXG4gICAgICAgICAgICByZXR1cm4gZnJvbShjb21tYW5kcykucGlwZShcclxuICAgICAgICAgICAgICBjb25jYXRNYXAoaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXZhbHVlQ2hhbmdlU3VjY2Vzcykge1xyXG4gICAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1tpdGVtXShjaGFuZ2UpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgIHRhcCgocmVzdWx0OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZUNoYW5nZVN1Y2Nlc3MgPSByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgIGV2ZXJ5KChyZXN1bHQ6IGFueSkgPT4gcmVzdWx0KVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCByZXBvc2l0b3J5TmFtZSA9IHRoaXMucmVwb3NpdG9yeS5uYW1lO1xyXG4gICAgY29uc3QgYmluZGluZ0RhdGFNYW5hZ2VyID0gdGhpcy5jb250ZXh0LmFwcENvbnRleHQuYmluZGluZ0RhdGFNYW5hZ2VyO1xyXG4gICAgY29uc3QgcmVwb3NpdG9yeUJpbmRpbmdEYXRhID0gYmluZGluZ0RhdGFNYW5hZ2VyLmdldEJpbmRpbmdEYXRhQnlOYW1lKHJlcG9zaXRvcnlOYW1lKTtcclxuICAgIHRoaXMuYmluZGluZ0RhdGEuaW5pdEJ5QmluZGluZ0xpc3QocmVwb3NpdG9yeUJpbmRpbmdEYXRhLmxpc3QsIHRoaXMuY29udGV4dCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRVSVN0YXRlKCkge1xyXG4gICAgdGhpcy51aVN0YXRlID0gdGhpcy5pbmplY3Rvci5nZXQoVUlTdGF0ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGludGlTdGF0ZU1hY2hpbmUoKSB7XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFN0YXRlTWFjaGluZSwgbnVsbCk7XHJcbiAgICBpZiAoIXRoaXMuc3RhdGVNYWNoaW5lKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuc3RhdGVNYWNoaW5lLmluaXQodGhpcy5jb250ZXh0KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdEZvcm0oKSB7XHJcbiAgICB0aGlzLmZvcm0gPSB0aGlzLmluamVjdG9yLmdldChGb3JtLCBudWxsKTtcclxuICAgIHRoaXMuZm9ybS5pbml0KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRDb21tYW5kQnVzKCkge1xyXG4gICAgdGhpcy5jb21tYW5kQnVzID0gdGhpcy5pbmplY3Rvci5nZXQoQ29tbWFuZEJ1cyk7XHJcbiAgICB0aGlzLmV4dGVuZENvbW1hbmRNZXRob2RzKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGV4dGVuZENvbW1hbmRNZXRob2RzKCkge1xyXG4gICAgdGhpcy5uZ0NvbW1hbmRzID0gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKHRoaXMuY29uc3RydWN0b3IsIENPTU1BTkRfTUVUSE9EX01FVEEpO1xyXG4gICAgdGhpcy5rZXliaW5kaW5nTWFwID0gbmV3IE1hcDxzdHJpbmcsIEtleWJpbmRpbmc+KCk7XHJcblxyXG4gICAgT2JqZWN0LmtleXModGhpcy5uZ0NvbW1hbmRzKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IG5nQ29tbWFuZDogQ29tbWFuZE1ldGhvZE1ldGFkYXRhID0gdGhpcy5uZ0NvbW1hbmRzW3Byb3BOYW1lXTtcclxuXHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wTmFtZSwge1xyXG4gICAgICAgIHZhbHVlOiAoZXZlbnRQYXJhbXM6IGFueSkgPT4ge1xyXG4gICAgICAgICAgY29uc3QgY29tbWFuZDogQ29tbWFuZCA9IHtcclxuICAgICAgICAgICAgbmFtZTogbmdDb21tYW5kLm5hbWUsXHJcbiAgICAgICAgICAgIHBhcmFtczogbmdDb21tYW5kLnBhcmFtcyxcclxuICAgICAgICAgICAgcGFyYW1EZXNjcmlwdGlvbnM6IG5nQ29tbWFuZC5wYXJhbURlc2NyaXB0aW9ucyxcclxuICAgICAgICAgICAgZXZlbnRQYXJhbTogZXZlbnRQYXJhbXMgfHwgbnVsbFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmNvbW1hbmRCdXMuZGlzcGF0Y2goY29tbWFuZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGlmIChuZ0NvbW1hbmQua2V5QmluZGluZykge1xyXG4gICAgICAgIHRoaXMua2V5YmluZGluZ01hcC5zZXQocHJvcE5hbWUsIG5nQ29tbWFuZC5rZXlCaW5kaW5nKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZ2lzdGVyV2l0aFBhcmVudCgpIHtcclxuICAgIGNvbnN0IHBhcmVudENvbnRleHQgPSB0aGlzLmNvbnRleHQucGFyZW50O1xyXG4gICAgaWYgKCFwYXJlbnRDb250ZXh0IHx8ICFwYXJlbnRDb250ZXh0LnZpZXdNb2RlbCB8fCAhcGFyZW50Q29udGV4dC52aWV3TW9kZWxbJ2NoaWxkVmlld01vZGVscyddKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBwYXJlbnRWaWV3TW9kZWwgPSBwYXJlbnRDb250ZXh0LnZpZXdNb2RlbDtcclxuICAgIGNvbnN0IGNsYXNzTmFtZSA9IHRoaXMuY29uc3RydWN0b3IubmFtZTtcclxuICAgIGNvbnN0IHByb3BOYW1lID0gcGFyZW50Vmlld01vZGVsWydjaGlsZFZpZXdNb2RlbHMnXVtjbGFzc05hbWVdO1xyXG4gICAgcGFyZW50Vmlld01vZGVsW3Byb3BOYW1lXSA9IHRoaXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlhbPpl63ogIHnmoRCZVNlc3Npb25cclxuICAgKi9cclxuICBwcml2YXRlIGNsb3NlT2xkQmVTZXNzaW9uKCkge1xyXG4gICAgY29uc3QgYWxsVmlld01vZGVsQ29udGV4dHMgPSB0aGlzLmNvbnRleHQuYXBwQ29udGV4dC52aWV3TW9kZWxDb250ZXh0TWFuYWdlci5nZXRDb250ZXh0cygpO1xyXG4gICAgaWYgKGFsbFZpZXdNb2RlbENvbnRleHRzLmxlbmd0aCA9PT0gMSAmJiBhbGxWaWV3TW9kZWxDb250ZXh0c1swXSA9PT0gdGhpcy5jb250ZXh0KSB7XHJcbiAgICAgIHRoaXMuY29udGV4dC5yZXBvc2l0b3J5LnJlc2V0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICog5LuORm9ybeiOt+WPluebkeWQrOWZqFxyXG4gKi9cclxuICBwcml2YXRlIGluaXRMaXN0ZW5lcnMoKSB7XHJcbiAgICBjb25zdCBleHRyYWN0UGF0aCA9IChiaW5kaW5nQmFzZVBhdGg6IHN0cmluZywgYmluZGluZ1BhdGg6IHN0cmluZyk6IHN0cmluZyA9PiB7XHJcbiAgICAgIHJldHVybiAnLycgKyBiaW5kaW5nQmFzZVBhdGguc3BsaXQoJy8nKS5jb25jYXQoYmluZGluZ1BhdGguc3BsaXQoJy4nKSkuZmlsdGVyKChpdGVtKSA9PiBpdGVtLmxlbmd0aCA+IDApLmpvaW4oJy8nKTtcclxuICAgIH07XHJcblxyXG4gICAgaWYgKHRoaXMuZm9ybSkge1xyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5naW5nTGlzdGVuZXJzID0gdGhpcy5mb3JtLmdldEVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMoKTtcclxuICAgICAgT2JqZWN0LmtleXModmFsdWVDaGFuZ2luZ0xpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcclxuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzW3BsYWluUGF0aF0gPSB2YWx1ZUNoYW5naW5nTGlzdGVuZXJzW2JpbmRpbmdQYXRoXTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5nZWRMaXN0ZW5lcnMgPSB0aGlzLmZvcm0uZ2V0RW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzKCk7XHJcbiAgICAgIE9iamVjdC5rZXlzKHZhbHVlQ2hhbmdlZExpc3RlbmVycykuZm9yRWFjaCgoYmluZGluZ1BhdGgpID0+IHtcclxuICAgICAgICBjb25zdCBwbGFpblBhdGggPSBleHRyYWN0UGF0aCh0aGlzLmJpbmRpbmdQYXRoLCBiaW5kaW5nUGF0aCk7XHJcbiAgICAgICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnNbcGxhaW5QYXRoXSA9IHZhbHVlQ2hhbmdlZExpc3RlbmVyc1tiaW5kaW5nUGF0aF07XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IFZpZXdNb2RlbCB9O1xyXG4iXX0=