/*
 * @Author: Witt
 * @Date: 2018-11-15 15:56:11
 * @Last Modified by: aalizzwell
 * @Last Modified time: 2019-07-09 16:23:04
 */
import { Injectable, Optional } from '@angular/core';
import { Router } from '@angular/router';
import { RouterParamService } from '@farris/devkit';
import { FrameworkService, AppService } from '@gsp-sys/rtf-common';
import { MenuStateService } from './menu-state.service';
import { Subject } from 'rxjs';
import { LanguageService } from './languag.service';
// tslint:disable: no-string-literal
/**
 * 路由服务
 * @scope FormModule
 */
class RouterService {
    constructor(router, routerParamService, frameworkService, appService, menuStateService, languageService) {
        this.router = router;
        this.routerParamService = routerParamService;
        this.frameworkService = frameworkService;
        this.appService = appService;
        this.menuStateService = menuStateService;
        this.languageService = languageService;
        /**
         * 上次切换的TabId
         */
        this.lastSwitchId = null;
        /**
         * 上次关闭的TabId
         */
        this.lastCloseId = null;
        // private menuStateService: MenuStateService = null;
        this.onClosed = null;
        if (!this.menuStateService) {
            this.menuStateService = new MenuStateService();
        }
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        this.onClosed = new Subject();
        this.registerEvent();
    }
    /**
     * 切换路由
     * @param url 菜单ID
     * @param params 路由参数
     */
    route(url, params) {
        url = this.router.createUrlTree([url]).toString();
        this.setParams(url, params);
        this.router.navigateByUrl(url);
    }
    /**
     * 注册运行框架事件
     */
    registerEvent() {
        const params = this.getParams(window.location.hash);
        const menuId = this.getAppId() || this.getFuncId();
        this.frameworkService.eventListner(this.frameworkService.FuncSwitch, e => {
            if (!e) {
                return;
            }
            const id = this.getOriginalId(e.id) || e.tabId;
            const menuState = this.menuStateService.getMenuState(id);
            if (!!id && menuId === id && !!menuState && menuState.length > 0) {
                this.formReload();
                this.lastSwitchId = id;
            }
        }, params);
        this.frameworkService.eventListner(this.frameworkService.FuncClosed, e => {
            if (!e) {
                return;
            }
            this.onClosed.next(e);
            const id = this.getOriginalId(e.id) || e.tabId;
            if (menuId === id) {
                return;
            }
            const menuState = this.menuStateService.getMenuState(menuId, id);
            // && id !== this.lastCloseId
            if (!!id && !!menuState && menuState.length > 0) {
                this.removeMenuState(id);
                this.formReload();
                this.lastCloseId = id;
            }
        }, params);
    }
    removeMenuState(tabId) {
        if (this['context']) {
            this.menuStateService.removeMenu(tabId);
        }
    }
    /**
     * 获取原始功能id
     * @param id id
     */
    getOriginalId(id) {
        if (!id) {
            return id;
        }
        if (id.indexOf('_') !== -1) {
            id = id.split('_')[0];
        }
        return id;
    }
    /**
     * 刷新组件数据
     */
    formReload() {
        try {
            this['context']['frameContext']['appContext']['refresh']();
        }
        catch (_a) { }
    }
    /**
     * 打开功能菜单
     * @param funcId 菜单内码
     * @param params 路由参数，形如： { key1: val1, key2: value2 }
     */
    openMenu(funcId, params, reload) {
        if (typeof reload === 'undefined' || typeof reload !== 'boolean') {
            reload = false;
        }
        const paramsMap = this.buildParamMap(params);
        const parentMenuId = this.getFuncId() || this.getAppId();
        this.menuStateService.addMenuState(parentMenuId, funcId);
        paramsMap.set('WEB_FORM_ROUTER_PARENT_ID', parentMenuId);
        this.frameworkService.openFuncWithParam(funcId, paramsMap, reload);
    }
    /**
     * 打开应用
     * @param appId 应用内码
     * @param appEntrance 应用入口
     * @param params 路由参数，形如： { key1: val1, key2: value2 }
     */
    openApp(appId, appEntrance, params, reload) {
        if (typeof reload === 'undefined' || typeof reload !== 'boolean') {
            reload = false;
        }
        const paramMap = this.buildParamMap(params);
        const parentMenuId = this.getAppId() || this.getFuncId();
        this.menuStateService.addMenuState(parentMenuId, appId);
        paramMap.set('WEB_FORM_ROUTER_PARENT_ID', parentMenuId);
        if (!!this.appService) {
            this.appService.openApp(appId, appEntrance, paramMap, reload);
        }
    }
    /**
     * 构造参数
     */
    buildParamMap(params) {
        if (typeof params === 'undefined' || params === null || (typeof params === 'string' && params.length < 1)) {
            params = {};
        }
        const paramMap = new Map();
        if (typeof params === 'object') {
            params = JSON.stringify(params);
        }
        params = window['encodeURIComponent'](params);
        paramMap.set('WEB_FORM_ROUTE_PARAMS', params);
        return paramMap;
    }
    /**
     * 关闭功能菜单
     */
    closeMenu() {
        const funcId = this.getFuncId();
        const appId = this.getAppId();
        const { isDialogComponent, rootComponent } = this.findDialog();
        if (isDialogComponent) {
            const modalRef = this.get(rootComponent, 'dialogRef');
            modalRef['close']();
            return;
        }
        if (funcId !== null && typeof funcId === 'string' && funcId.length > 0) {
            this.closeFunc(funcId);
        }
        else if (appId !== null && typeof appId === 'string' && appId.length > 0) {
            const appEntrance = this.getAppEntrance();
            this.closeApp(appId, appEntrance);
        }
        else {
            console.error(this.languageService['notSupportMenuType']);
        }
    }
    /**
     * 查找弹窗组件
     */
    findDialog() {
        let frameContext = this.get(this, 'context.frameContext');
        let isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        let parentFrameContext = this.get(frameContext, 'parent');
        while (parentFrameContext != null && !isDialogComponent) {
            frameContext = this.get(frameContext, 'parent');
            parentFrameContext = this.get(parentFrameContext, 'parent');
            isDialogComponent = this.get(frameContext, 'frameComponent.isDialogRootComponent', false);
        }
        const rootComponent = this.get(frameContext, 'frameComponent');
        return { isDialogComponent, rootComponent };
    }
    /**
     * loadsh get
     * @param object 对象
     * @param path 路径
     * @param defaultVal 默认值
     */
    get(object, path, defaultVal = null) {
        const PATH = Array.isArray(path)
            ? path
            : path.split('.').filter(i => i.length);
        if (!PATH.length) {
            return object === undefined ? defaultVal : object;
        }
        if (object === null || object === undefined || typeof (object[PATH[0]]) === 'undefined') {
            return defaultVal;
        }
        return this.get(object[PATH.shift()], PATH, defaultVal);
    }
    /**
     * 关闭菜单
     * @param funcId 菜单id
     */
    closeFunc(funcId) {
        if (!funcId) {
            funcId = this.getFuncId();
        }
        if (!!this.frameworkService) {
            this.frameworkService.closeFunc(funcId).subscribe();
        }
    }
    /**
     * 关闭app
     * @param appId 应用id
     */
    closeApp(appId, appEntrance) {
        if (!appId) {
            appId = this.getAppId();
        }
        if (typeof appEntrance === 'undefined') {
            appEntrance = this.getAppEntrance();
        }
        if (!!this.appService) {
            this.appService.closeApp(appId, appEntrance).subscribe();
        }
    }
    /**
     * 设置参数
     * @param params 路由参数
     */
    setParams(url, params) {
        let paramsObj;
        if (typeof params === 'string' && params !== '') {
            paramsObj = JSON.parse(params);
        }
        else {
            paramsObj = params || {};
        }
        // 设置路由参数
        this.routerParamService.setParams(url, paramsObj);
    }
    /**
     * 获取funcId
     */
    getFuncId() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('funcId')) {
            return params.funcId;
        }
        else {
            return null;
        }
    }
    /**
     * 获取appId
     */
    getAppId() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('appId')) {
            return params.appId;
        }
        else {
            return null;
        }
    }
    getParentMenuId() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('WEB_FORM_ROUTER_PARENT_ID')) {
            return params.WEB_FORM_ROUTER_PARENT_ID;
        }
        else {
            return null;
        }
    }
    /**
     * 获取应用入口
     */
    getAppEntrance() {
        const hash = window.location.hash;
        if (!hash) {
            return null;
        }
        const params = this.decodeURLParams(hash);
        if (params && params.hasOwnProperty('appEntrance')) {
            return params.appEntrance;
        }
        else {
            return null;
        }
    }
    /**
     * 解码参数
     * @param query search|hash
     */
    decodeURLParams(query) {
        if (typeof query === 'undefined') {
            query = window.location.hash || window.location.search;
        }
        const hashes = query.slice(query.indexOf('?') + 1).split('&');
        return hashes.reduce((params, hash) => {
            const split = hash.indexOf('=');
            const key = hash.slice(0, split);
            const val = hash.slice(split + 1);
            return Object.assign(params, { [key]: decodeURIComponent(val) });
        }, {});
    }
    getParams(queryString) {
        if (!queryString) {
            return {};
        }
        const hashes = queryString.slice(queryString.indexOf('?') + 1).split('&');
        return hashes.reduce((params, hash) => {
            const split = hash.indexOf('=');
            const key = hash.slice(0, split);
            const val = hash.slice(split + 1);
            return Object.assign(params, { [key]: decodeURIComponent(val) });
        }, {});
    }
}
RouterService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
RouterService.ctorParameters = () => [
    { type: Router },
    { type: RouterParamService },
    { type: FrameworkService },
    { type: AppService, decorators: [{ type: Optional }] },
    { type: MenuStateService, decorators: [{ type: Optional }] },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
export { RouterService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcm91dGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7O0dBS0c7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBELG9DQUFvQztBQUNwQzs7O0dBR0c7QUFDSCxNQUNNLGFBQWE7SUFXakIsWUFDVSxNQUFjLEVBQ2Qsa0JBQXNDLEVBQ3RDLGdCQUFrQyxFQUN0QixVQUFzQixFQUN0QixnQkFBa0MsRUFDbEMsZUFBZ0M7UUFMNUMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUN0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBaEJ0RDs7V0FFRztRQUNLLGlCQUFZLEdBQVcsSUFBSSxDQUFDO1FBQ3BDOztXQUVHO1FBQ0ssZ0JBQVcsR0FBVyxJQUFJLENBQUM7UUFDbkMscURBQXFEO1FBQzlDLGFBQVEsR0FBaUIsSUFBSSxDQUFDO1FBU25DLElB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LEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNuRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDVCxDQUFDOzs7WUEzVkYsVUFBVTs7OztZQVpGLE1BQU07WUFDTixrQkFBa0I7WUFDbEIsZ0JBQWdCO1lBQUUsVUFBVSx1QkEwQmhDLFFBQVE7WUF6QkosZ0JBQWdCLHVCQTBCcEIsUUFBUTtZQXhCSixlQUFlLHVCQXlCbkIsUUFBUTs7QUE0VWIsT0FBTyxFQUFFLGFBQWEsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBBdXRob3I6IFdpdHRcbiAqIEBEYXRlOiAyMDE4LTExLTE1IDE1OjU2OjExXG4gKiBATGFzdCBNb2RpZmllZCBieTogYWFsaXp6d2VsbFxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOS0wNy0wOSAxNjoyMzowNFxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgUm91dGVyUGFyYW1TZXJ2aWNlIH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuaW1wb3J0IHsgRnJhbWV3b3JrU2VydmljZSwgQXBwU2VydmljZSB9IGZyb20gJ0Bnc3Atc3lzL3J0Zi1jb21tb24nO1xuaW1wb3J0IHsgTWVudVN0YXRlU2VydmljZSB9IGZyb20gJy4vbWVudS1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IExhbmd1YWdlU2VydmljZSB9IGZyb20gJy4vbGFuZ3VhZy5zZXJ2aWNlJztcblxuLy8gdHNsaW50OmRpc2FibGU6IG5vLXN0cmluZy1saXRlcmFsXG4vKipcbiAqIOi3r+eUseacjeWKoVxuICogQHNjb3BlIEZvcm1Nb2R1bGVcbiAqL1xuQEluamVjdGFibGUoKVxuY2xhc3MgUm91dGVyU2VydmljZSB7XG4gIC8qKlxuICAgKiDkuIrmrKHliIfmjaLnmoRUYWJJZFxuICAgKi9cbiAgcHJpdmF0ZSBsYXN0U3dpdGNoSWQ6IHN0cmluZyA9IG51bGw7XG4gIC8qKlxuICAgKiDkuIrmrKHlhbPpl63nmoRUYWJJZFxuICAgKi9cbiAgcHJpdmF0ZSBsYXN0Q2xvc2VJZDogc3RyaW5nID0gbnVsbDtcbiAgLy8gcHJpdmF0ZSBtZW51U3RhdGVTZXJ2aWNlOiBNZW51U3RhdGVTZXJ2aWNlID0gbnVsbDtcbiAgcHVibGljIG9uQ2xvc2VkOiBTdWJqZWN0PGFueT4gPSBudWxsO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgcm91dGVyUGFyYW1TZXJ2aWNlOiBSb3V0ZXJQYXJhbVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmcmFtZXdvcmtTZXJ2aWNlOiBGcmFtZXdvcmtTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgYXBwU2VydmljZTogQXBwU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIG1lbnVTdGF0ZVNlcnZpY2U6IE1lbnVTdGF0ZVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZSxcbiAgKSB7XG4gICAgaWYgKCF0aGlzLm1lbnVTdGF0ZVNlcnZpY2UpIHtcbiAgICAgIHRoaXMubWVudVN0YXRlU2VydmljZSA9IG5ldyBNZW51U3RhdGVTZXJ2aWNlKCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5sYW5ndWFnZVNlcnZpY2UpIHtcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gTGFuZ3VhZ2VTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgfVxuICAgIHRoaXMub25DbG9zZWQgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gICAgdGhpcy5yZWdpc3RlckV2ZW50KCk7XG4gIH1cblxuICAvKipcbiAgICog5YiH5o2i6Lev55SxXG4gICAqIEBwYXJhbSB1cmwg6I+c5Y2VSURcbiAgICogQHBhcmFtIHBhcmFtcyDot6/nlLHlj4LmlbBcbiAgICovXG4gIHB1YmxpYyByb3V0ZSh1cmw6IHN0cmluZywgcGFyYW1zOiBhbnkpIHtcbiAgICB1cmwgPSB0aGlzLnJvdXRlci5jcmVhdGVVcmxUcmVlKFt1cmxdKS50b1N0cmluZygpO1xuICAgIHRoaXMuc2V0UGFyYW1zKHVybCwgcGFyYW1zKTtcbiAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHVybCk7XG4gIH1cbiAgLyoqXG4gICAqIOazqOWGjOi/kOihjOahhuaetuS6i+S7tlxuICAgKi9cbiAgcHVibGljIHJlZ2lzdGVyRXZlbnQoKSB7XG4gICAgY29uc3QgcGFyYW1zOiBhbnkgPSB0aGlzLmdldFBhcmFtcyh3aW5kb3cubG9jYXRpb24uaGFzaCk7XG4gICAgY29uc3QgbWVudUlkID0gdGhpcy5nZXRBcHBJZCgpIHx8IHRoaXMuZ2V0RnVuY0lkKCk7XG4gICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmV2ZW50TGlzdG5lcih0aGlzLmZyYW1ld29ya1NlcnZpY2UuRnVuY1N3aXRjaCwgZSA9PiB7XG4gICAgICBpZiAoIWUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgaWQgPSB0aGlzLmdldE9yaWdpbmFsSWQoZS5pZCkgfHwgZS50YWJJZDtcbiAgICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUoaWQpO1xuICAgICAgaWYgKCEhaWQgJiYgbWVudUlkID09PSBpZCAmJiAhIW1lbnVTdGF0ZSAmJiBtZW51U3RhdGUubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLmZvcm1SZWxvYWQoKTtcbiAgICAgICAgdGhpcy5sYXN0U3dpdGNoSWQgPSBpZDtcbiAgICAgIH1cbiAgICB9LCBwYXJhbXMpO1xuXG4gICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmV2ZW50TGlzdG5lcih0aGlzLmZyYW1ld29ya1NlcnZpY2UuRnVuY0Nsb3NlZCwgZSA9PiB7XG4gICAgICBpZiAoIWUpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5vbkNsb3NlZC5uZXh0KGUpO1xuICAgICAgY29uc3QgaWQgPSB0aGlzLmdldE9yaWdpbmFsSWQoZS5pZCkgfHwgZS50YWJJZDtcbiAgICAgIGlmIChtZW51SWQgPT09IGlkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1lbnVTdGF0ZSA9IHRoaXMubWVudVN0YXRlU2VydmljZS5nZXRNZW51U3RhdGUobWVudUlkLCBpZCk7XG4gICAgICAvLyAmJiBpZCAhPT0gdGhpcy5sYXN0Q2xvc2VJZFxuICAgICAgaWYgKCEhaWQgJiYgISFtZW51U3RhdGUgJiYgbWVudVN0YXRlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5yZW1vdmVNZW51U3RhdGUoaWQpO1xuICAgICAgICB0aGlzLmZvcm1SZWxvYWQoKTtcbiAgICAgICAgdGhpcy5sYXN0Q2xvc2VJZCA9IGlkO1xuICAgICAgfVxuICAgIH0sIHBhcmFtcyk7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZU1lbnVTdGF0ZSh0YWJJZDogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXNbJ2NvbnRleHQnXSkge1xuICAgICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLnJlbW92ZU1lbnUodGFiSWQpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6I635Y+W5Y6f5aeL5Yqf6IO9aWRcbiAgICogQHBhcmFtIGlkIGlkXG4gICAqL1xuICBwcml2YXRlIGdldE9yaWdpbmFsSWQoaWQ6IHN0cmluZykge1xuICAgIGlmICghaWQpIHtcbiAgICAgIHJldHVybiBpZDtcbiAgICB9XG4gICAgaWYgKGlkLmluZGV4T2YoJ18nKSAhPT0gLTEpIHtcbiAgICAgIGlkID0gaWQuc3BsaXQoJ18nKVswXTtcbiAgICB9XG4gICAgcmV0dXJuIGlkO1xuICB9XG4gIC8qKlxuICAgKiDliLfmlrDnu4Tku7bmlbDmja5cbiAgICovXG4gIHByaXZhdGUgZm9ybVJlbG9hZCgpIHtcbiAgICB0cnkge1xuICAgICAgdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXVsnYXBwQ29udGV4dCddWydyZWZyZXNoJ10oKTtcbiAgICB9IGNhdGNoeyB9XG4gIH1cbiAgLyoqXG4gICAqIOaJk+W8gOWKn+iDveiPnOWNlVxuICAgKiBAcGFyYW0gZnVuY0lkIOiPnOWNleWGheeggVxuICAgKiBAcGFyYW0gcGFyYW1zIOi3r+eUseWPguaVsO+8jOW9ouWmgu+8miB7IGtleTE6IHZhbDEsIGtleTI6IHZhbHVlMiB9XG4gICAqL1xuICBwdWJsaWMgb3Blbk1lbnUoZnVuY0lkOiBzdHJpbmcsIHBhcmFtczogYW55LCByZWxvYWQ/OiBib29sZWFuKSB7XG4gICAgaWYgKHR5cGVvZiByZWxvYWQgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiByZWxvYWQgIT09ICdib29sZWFuJykge1xuICAgICAgcmVsb2FkID0gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IHBhcmFtc01hcCA9IHRoaXMuYnVpbGRQYXJhbU1hcChwYXJhbXMpO1xuICAgIGNvbnN0IHBhcmVudE1lbnVJZCA9IHRoaXMuZ2V0RnVuY0lkKCkgfHwgdGhpcy5nZXRBcHBJZCgpO1xuICAgIHRoaXMubWVudVN0YXRlU2VydmljZS5hZGRNZW51U3RhdGUocGFyZW50TWVudUlkLCBmdW5jSWQpO1xuICAgIHBhcmFtc01hcC5zZXQoJ1dFQl9GT1JNX1JPVVRFUl9QQVJFTlRfSUQnLCBwYXJlbnRNZW51SWQpO1xuICAgIHRoaXMuZnJhbWV3b3JrU2VydmljZS5vcGVuRnVuY1dpdGhQYXJhbShmdW5jSWQsIHBhcmFtc01hcCwgcmVsb2FkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDmiZPlvIDlupTnlKhcbiAgICogQHBhcmFtIGFwcElkIOW6lOeUqOWGheeggVxuICAgKiBAcGFyYW0gYXBwRW50cmFuY2Ug5bqU55So5YWl5Y+jXG4gICAqIEBwYXJhbSBwYXJhbXMg6Lev55Sx5Y+C5pWw77yM5b2i5aaC77yaIHsga2V5MTogdmFsMSwga2V5MjogdmFsdWUyIH1cbiAgICovXG4gIHB1YmxpYyBvcGVuQXBwKGFwcElkOiBzdHJpbmcsIGFwcEVudHJhbmNlOiBzdHJpbmcsIHBhcmFtczogYW55LCByZWxvYWQ/OiBib29sZWFuKSB7XG4gICAgaWYgKHR5cGVvZiByZWxvYWQgPT09ICd1bmRlZmluZWQnIHx8IHR5cGVvZiByZWxvYWQgIT09ICdib29sZWFuJykge1xuICAgICAgcmVsb2FkID0gZmFsc2U7XG4gICAgfVxuICAgIGNvbnN0IHBhcmFtTWFwID0gdGhpcy5idWlsZFBhcmFtTWFwKHBhcmFtcyk7XG4gICAgY29uc3QgcGFyZW50TWVudUlkID0gdGhpcy5nZXRBcHBJZCgpIHx8IHRoaXMuZ2V0RnVuY0lkKCk7XG4gICAgdGhpcy5tZW51U3RhdGVTZXJ2aWNlLmFkZE1lbnVTdGF0ZShwYXJlbnRNZW51SWQsIGFwcElkKTtcbiAgICBwYXJhbU1hcC5zZXQoJ1dFQl9GT1JNX1JPVVRFUl9QQVJFTlRfSUQnLCBwYXJlbnRNZW51SWQpO1xuICAgIGlmICghIXRoaXMuYXBwU2VydmljZSkge1xuICAgICAgdGhpcy5hcHBTZXJ2aWNlLm9wZW5BcHAoYXBwSWQsIGFwcEVudHJhbmNlLCBwYXJhbU1hcCwgcmVsb2FkKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog5p6E6YCg5Y+C5pWwXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkUGFyYW1NYXAocGFyYW1zOiBhbnkpOiBNYXA8c3RyaW5nLCBzdHJpbmc+IHtcbiAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gJ3VuZGVmaW5lZCcgfHwgcGFyYW1zID09PSBudWxsIHx8ICh0eXBlb2YgcGFyYW1zID09PSAnc3RyaW5nJyAmJiBwYXJhbXMubGVuZ3RoIDwgMSkpIHtcbiAgICAgIHBhcmFtcyA9IHt9O1xuICAgIH1cbiAgICBjb25zdCBwYXJhbU1hcCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdvYmplY3QnKSB7XG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpO1xuICAgIH1cbiAgICBwYXJhbXMgPSB3aW5kb3dbJ2VuY29kZVVSSUNvbXBvbmVudCddKHBhcmFtcyk7XG4gICAgcGFyYW1NYXAuc2V0KCdXRUJfRk9STV9ST1VURV9QQVJBTVMnLCBwYXJhbXMpO1xuICAgIHJldHVybiBwYXJhbU1hcDtcbiAgfVxuXG4gIC8qKlxuICAgKiDlhbPpl63lip/og73oj5zljZVcbiAgICovXG4gIHB1YmxpYyBjbG9zZU1lbnUoKSB7XG4gICAgY29uc3QgZnVuY0lkOiBzdHJpbmcgfCBudWxsID0gdGhpcy5nZXRGdW5jSWQoKTtcbiAgICBjb25zdCBhcHBJZDogc3RyaW5nIHwgbnVsbCA9IHRoaXMuZ2V0QXBwSWQoKTtcbiAgICBjb25zdCB7IGlzRGlhbG9nQ29tcG9uZW50LCByb290Q29tcG9uZW50IH0gPSB0aGlzLmZpbmREaWFsb2coKTtcbiAgICBpZiAoaXNEaWFsb2dDb21wb25lbnQpIHtcbiAgICAgIGNvbnN0IG1vZGFsUmVmID0gdGhpcy5nZXQocm9vdENvbXBvbmVudCwgJ2RpYWxvZ1JlZicpO1xuICAgICAgbW9kYWxSZWZbJ2Nsb3NlJ10oKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoZnVuY0lkICE9PSBudWxsICYmIHR5cGVvZiBmdW5jSWQgPT09ICdzdHJpbmcnICYmIGZ1bmNJZC5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmNsb3NlRnVuYyhmdW5jSWQpO1xuICAgIH0gZWxzZSBpZiAoYXBwSWQgIT09IG51bGwgJiYgdHlwZW9mIGFwcElkID09PSAnc3RyaW5nJyAmJiBhcHBJZC5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBhcHBFbnRyYW5jZSA9IHRoaXMuZ2V0QXBwRW50cmFuY2UoKTtcbiAgICAgIHRoaXMuY2xvc2VBcHAoYXBwSWQsIGFwcEVudHJhbmNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcih0aGlzLmxhbmd1YWdlU2VydmljZVsnbm90U3VwcG9ydE1lbnVUeXBlJ10pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDmn6Xmib7lvLnnqpfnu4Tku7ZcbiAgICovXG4gIHByaXZhdGUgZmluZERpYWxvZygpIHtcbiAgICBsZXQgZnJhbWVDb250ZXh0ID0gdGhpcy5nZXQodGhpcywgJ2NvbnRleHQuZnJhbWVDb250ZXh0Jyk7XG4gICAgbGV0IGlzRGlhbG9nQ29tcG9uZW50ID0gdGhpcy5nZXQoZnJhbWVDb250ZXh0LCAnZnJhbWVDb21wb25lbnQuaXNEaWFsb2dSb290Q29tcG9uZW50JywgZmFsc2UpO1xuXG4gICAgbGV0IHBhcmVudEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ3BhcmVudCcpO1xuICAgIHdoaWxlIChwYXJlbnRGcmFtZUNvbnRleHQgIT0gbnVsbCAmJiAhaXNEaWFsb2dDb21wb25lbnQpIHtcbiAgICAgIGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ3BhcmVudCcpO1xuICAgICAgcGFyZW50RnJhbWVDb250ZXh0ID0gdGhpcy5nZXQocGFyZW50RnJhbWVDb250ZXh0LCAncGFyZW50Jyk7XG4gICAgICBpc0RpYWxvZ0NvbXBvbmVudCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ2ZyYW1lQ29tcG9uZW50LmlzRGlhbG9nUm9vdENvbXBvbmVudCcsIGZhbHNlKTtcbiAgICB9XG4gICAgY29uc3Qgcm9vdENvbXBvbmVudCA9IHRoaXMuZ2V0KGZyYW1lQ29udGV4dCwgJ2ZyYW1lQ29tcG9uZW50Jyk7XG4gICAgcmV0dXJuIHsgaXNEaWFsb2dDb21wb25lbnQsIHJvb3RDb21wb25lbnQgfTtcblxuICB9XG5cbiAgLyoqXG4gICAqIGxvYWRzaCBnZXRcbiAgICogQHBhcmFtIG9iamVjdCDlr7nosaFcbiAgICogQHBhcmFtIHBhdGgg6Lev5b6EXG4gICAqIEBwYXJhbSBkZWZhdWx0VmFsIOm7mOiupOWAvFxuICAgKi9cbiAgcHJpdmF0ZSBnZXQob2JqZWN0OiBhbnksIHBhdGg6IEFycmF5PHN0cmluZz4gfCBzdHJpbmcsIGRlZmF1bHRWYWw6IGFueSA9IG51bGwpIHtcbiAgICBjb25zdCBQQVRIID0gQXJyYXkuaXNBcnJheShwYXRoKVxuICAgICAgPyBwYXRoXG4gICAgICA6IHBhdGguc3BsaXQoJy4nKS5maWx0ZXIoaSA9PiBpLmxlbmd0aCk7XG4gICAgaWYgKCFQQVRILmxlbmd0aCkge1xuICAgICAgcmV0dXJuIG9iamVjdCA9PT0gdW5kZWZpbmVkID8gZGVmYXVsdFZhbCA6IG9iamVjdDtcbiAgICB9XG5cbiAgICBpZiAob2JqZWN0ID09PSBudWxsIHx8IG9iamVjdCA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiAob2JqZWN0W1BBVEhbMF1dKSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHJldHVybiBkZWZhdWx0VmFsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmdldChvYmplY3RbUEFUSC5zaGlmdCgpXSwgUEFUSCwgZGVmYXVsdFZhbCk7XG4gIH1cblxuICAvKipcbiAgICog5YWz6Zet6I+c5Y2VXG4gICAqIEBwYXJhbSBmdW5jSWQg6I+c5Y2VaWRcbiAgICovXG4gIHB1YmxpYyBjbG9zZUZ1bmMoZnVuY0lkPzogc3RyaW5nKSB7XG4gICAgaWYgKCFmdW5jSWQpIHtcbiAgICAgIGZ1bmNJZCA9IHRoaXMuZ2V0RnVuY0lkKCk7XG4gICAgfVxuICAgIGlmICghIXRoaXMuZnJhbWV3b3JrU2VydmljZSkge1xuICAgICAgdGhpcy5mcmFtZXdvcmtTZXJ2aWNlLmNsb3NlRnVuYyhmdW5jSWQpLnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDlhbPpl61hcHBcbiAgICogQHBhcmFtIGFwcElkIOW6lOeUqGlkXG4gICAqL1xuICBwdWJsaWMgY2xvc2VBcHAoYXBwSWQ/OiBzdHJpbmcsIGFwcEVudHJhbmNlPzogc3RyaW5nKSB7XG4gICAgaWYgKCFhcHBJZCkge1xuICAgICAgYXBwSWQgPSB0aGlzLmdldEFwcElkKCk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYXBwRW50cmFuY2UgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBhcHBFbnRyYW5jZSA9IHRoaXMuZ2V0QXBwRW50cmFuY2UoKTtcbiAgICB9XG4gICAgaWYgKCEhdGhpcy5hcHBTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmFwcFNlcnZpY2UuY2xvc2VBcHAoYXBwSWQsIGFwcEVudHJhbmNlKS5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6K6+572u5Y+C5pWwXG4gICAqIEBwYXJhbSBwYXJhbXMg6Lev55Sx5Y+C5pWwXG4gICAqL1xuICBwcml2YXRlIHNldFBhcmFtcyh1cmw6IHN0cmluZywgcGFyYW1zOiBzdHJpbmcgfCB7IFtrZXk6IHN0cmluZ106IGFueTsgfSkge1xuICAgIGxldCBwYXJhbXNPYmo7XG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdzdHJpbmcnICYmIHBhcmFtcyAhPT0gJycpIHtcbiAgICAgIHBhcmFtc09iaiA9IEpTT04ucGFyc2UocGFyYW1zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zT2JqID0gcGFyYW1zIHx8IHt9O1xuICAgIH1cblxuICAgIC8vIOiuvue9rui3r+eUseWPguaVsFxuICAgIHRoaXMucm91dGVyUGFyYW1TZXJ2aWNlLnNldFBhcmFtcyh1cmwsIHBhcmFtc09iaik7XG4gIH1cblxuICAvKipcbiAgICog6I635Y+WZnVuY0lkXG4gICAqL1xuICBwcml2YXRlIGdldEZ1bmNJZCgpIHtcbiAgICBjb25zdCBoYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XG4gICAgaWYgKCFoYXNoKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgcGFyYW1zID0gdGhpcy5kZWNvZGVVUkxQYXJhbXMoaGFzaCk7XG4gICAgaWYgKHBhcmFtcyAmJiBwYXJhbXMuaGFzT3duUHJvcGVydHkoJ2Z1bmNJZCcpKSB7XG4gICAgICByZXR1cm4gcGFyYW1zLmZ1bmNJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPlmFwcElkXG4gICAqL1xuICBwcml2YXRlIGdldEFwcElkKCkge1xuICAgIGNvbnN0IGhhc2ggPSB3aW5kb3cubG9jYXRpb24uaGFzaDtcbiAgICBpZiAoIWhhc2gpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLmRlY29kZVVSTFBhcmFtcyhoYXNoKTtcbiAgICBpZiAocGFyYW1zICYmIHBhcmFtcy5oYXNPd25Qcm9wZXJ0eSgnYXBwSWQnKSkge1xuICAgICAgcmV0dXJuIHBhcmFtcy5hcHBJZDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYXJlbnRNZW51SWQoKSB7XG4gICAgY29uc3QgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoO1xuICAgIGlmICghaGFzaCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZGVjb2RlVVJMUGFyYW1zKGhhc2gpO1xuICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLmhhc093blByb3BlcnR5KCdXRUJfRk9STV9ST1VURVJfUEFSRU5UX0lEJykpIHtcbiAgICAgIHJldHVybiBwYXJhbXMuV0VCX0ZPUk1fUk9VVEVSX1BBUkVOVF9JRDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDojrflj5blupTnlKjlhaXlj6NcbiAgICovXG4gIHByaXZhdGUgZ2V0QXBwRW50cmFuY2UoKSB7XG4gICAgY29uc3QgaGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoO1xuICAgIGlmICghaGFzaCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuZGVjb2RlVVJMUGFyYW1zKGhhc2gpO1xuICAgIGlmIChwYXJhbXMgJiYgcGFyYW1zLmhhc093blByb3BlcnR5KCdhcHBFbnRyYW5jZScpKSB7XG4gICAgICByZXR1cm4gcGFyYW1zLmFwcEVudHJhbmNlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOino+eggeWPguaVsFxuICAgKiBAcGFyYW0gcXVlcnkgc2VhcmNofGhhc2hcbiAgICovXG4gIHByaXZhdGUgZGVjb2RlVVJMUGFyYW1zKHF1ZXJ5OiBzdHJpbmcpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogYW55IH0ge1xuICAgIGlmICh0eXBlb2YgcXVlcnkgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBxdWVyeSA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoIHx8IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7XG4gICAgfVxuICAgIGNvbnN0IGhhc2hlcyA9IHF1ZXJ5LnNsaWNlKHF1ZXJ5LmluZGV4T2YoJz8nKSArIDEpLnNwbGl0KCcmJyk7XG4gICAgcmV0dXJuIGhhc2hlcy5yZWR1Y2UoKHBhcmFtcywgaGFzaCkgPT4ge1xuICAgICAgY29uc3Qgc3BsaXQgPSBoYXNoLmluZGV4T2YoJz0nKTtcbiAgICAgIGNvbnN0IGtleSA9IGhhc2guc2xpY2UoMCwgc3BsaXQpO1xuICAgICAgY29uc3QgdmFsID0gaGFzaC5zbGljZShzcGxpdCArIDEpO1xuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24ocGFyYW1zLCB7IFtrZXldOiBkZWNvZGVVUklDb21wb25lbnQodmFsKSB9KTtcbiAgICB9LCB7fSk7XG4gIH1cbiAgcHJpdmF0ZSBnZXRQYXJhbXMocXVlcnlTdHJpbmc6IHN0cmluZyk6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnkgfSB7XG4gICAgaWYgKCFxdWVyeVN0cmluZykge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgICBjb25zdCBoYXNoZXMgPSBxdWVyeVN0cmluZy5zbGljZShxdWVyeVN0cmluZy5pbmRleE9mKCc/JykgKyAxKS5zcGxpdCgnJicpO1xuICAgIHJldHVybiBoYXNoZXMucmVkdWNlKChwYXJhbXMsIGhhc2gpID0+IHtcbiAgICAgIGNvbnN0IHNwbGl0ID0gaGFzaC5pbmRleE9mKCc9Jyk7XG4gICAgICBjb25zdCBrZXkgPSBoYXNoLnNsaWNlKDAsIHNwbGl0KTtcbiAgICAgIGNvbnN0IHZhbCA9IGhhc2guc2xpY2Uoc3BsaXQgKyAxKTtcbiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHBhcmFtcywgeyBba2V5XTogZGVjb2RlVVJJQ29tcG9uZW50KHZhbCkgfSk7XG4gICAgfSwge30pO1xuICB9XG59XG5cbmV4cG9ydCB7IFJvdXRlclNlcnZpY2UgfTtcbiJdfQ==