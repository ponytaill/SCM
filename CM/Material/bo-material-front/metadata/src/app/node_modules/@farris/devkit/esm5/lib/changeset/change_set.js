/*
 * @Author: Lucus, Witt
 * @Date: 2018-10-30 15:53:59
 * @Last Modified by: Witt
 * @Last Modified time: 2018-11-08 17:25:08
 */
import { ModifyType } from './types';
function isEqual(value, other) {
    return JSON.stringify(value) === JSON.stringify(other);
}
/**
 * 实体数据变更集
 */
var ChangeSet = /** @class */ (function () {
    function ChangeSet() {
        /**
         * 变更集合
         */
        this.modifications = [];
    }
    Object.defineProperty(ChangeSet.prototype, "changes", {
        /**
         *  获取所有的变更记录
         */
        get: function () {
            return this.modifications;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 将变更集添加到集合中
     * ### 使用示例
     * ```
     * const changeSet = new ChangeSet();
     * const modify = new Modification('newValue', ModifyType.ValueChange, [1, 'title'], 'oldValue');
     * changeSet.append(modify)
     * ```
     * @param changeItem 变更数据
     */
    ChangeSet.prototype.append = function (modification) {
        switch (modification.type) {
            case ModifyType.ValueChange:
                this.appendValueChangeModification(modification);
                break;
            case ModifyType.Add:
            case ModifyType.Insert:
            case ModifyType.Clone:
                this.appendAddModification(modification);
                break;
            case ModifyType.Remove:
                this.appendRemoveModification(modification);
                break;
            case ModifyType.Load:
                break;
            default:
                break;
        }
    };
    /**
     * 添加值变化变更
     */
    ChangeSet.prototype.appendValueChangeModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findModifyItemsPath(modification.path);
        if (existedModification) {
            // 如果存在相同路径的ValueChange类型的变更集，则更新值；
            existedModification.value = value;
        }
        else {
            var existedAddModification = this.findNewAddItemsPath(modification.path);
            if (existedAddModification) {
                // @todo：
                // 1、此处逻辑有问题，value是个字符串，不能直接assign；
                // 2、之所以没有出现问题，是因为都是服务器端新增，新增后，客户端清空了所有变更。
                // 如果存在涵盖该ValueChange变更的Add变更，则更新Add变更对应的数据；
                existedAddModification.value = Object.assign({}, existedAddModification.value, value);
            }
            else {
                // 其他情况，新增一条ValueChange变更。
                this.modifications.push(modification);
            }
        }
    };
    /**
     * 添加新增变更
     */
    ChangeSet.prototype.appendAddModification = function (modification) {
        var value = modification.value;
        var existedModification = this.findNewAddItemsPath(modification.path);
        if (existedModification) {
            // 1、如果已经存在相同路径的Add变更，则合并Value。
            existedModification.value = existedModification.value.concat(value);
        }
        else {
            // 2、如果没有，则新增一条Add变更。
            this.modifications.push(modification);
        }
    };
    /**
     * 添加删除变更
     */
    ChangeSet.prototype.appendRemoveModification = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        // 1、存在相同path的新增变更，移除新增变更，不需要添加删除变更；
        // @todo：待重构（1、只考虑了主从情况，2、临时用多重循环实现）
        this.modifications.forEach(function (addModification) {
            // 只处理新增变更
            if (addModification.type !== ModifyType.Add && addModification.type !== ModifyType.Insert && addModification.type !== ModifyType.Clone) {
                return;
            }
            // @todo 只考虑主从结构，再深的层次暂不考虑
            if (isEqual(addModification.path, path) === false) {
                return;
            }
            // 遍历新增新增变更的value（value是个数组），移除相匹配的新增删除
            addModification.value = addModification.value.filter(function (addDataItem) {
                return addDataItem[primaryKey] !== primaryKeyValue;
            });
        });
        // 2、移除对应的修改变更
        var fullRemovePath = path.concat(primaryKey + ":" + primaryKeyValue);
        this.modifications = this.modifications.filter(function (valueModification) {
            if (valueModification.type !== ModifyType.ValueChange) {
                return true;
            }
            var valueChangePath = Array.from(valueModification.path);
            valueChangePath.pop();
            // 路径相同进行移除
            var isToRemove = isEqual(valueChangePath, fullRemovePath);
            return !isToRemove;
        });
        // 先删除下级删除变更，再插入
        // 主要针对从从表删除之后，又删除子表时，根实体上还存在从从表删除变更的场景
        this.removeDescendantRemoveModifications(modification);
        this.modifications.push(modification);
    };
    /**
     * 清空变更集合
     */
    ChangeSet.prototype.clear = function () {
        this.modifications = [];
    };
    /**
     * 根据path获取Add类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findNewAddItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && (value.type === ModifyType.Add || value.type === ModifyType.Insert || value.type === ModifyType.Clone);
        });
    };
    /**
     * 根据path获取ValueChange类型的变更记录
     * @param path 变更路径
     */
    ChangeSet.prototype.findModifyItemsPath = function (path) {
        return this.modifications.find(function (value, index) {
            return isEqual(path, value.path) && value.type === ModifyType.ValueChange;
        });
    };
    /**
     * 删除后代（包括自己）所有的删除变更
     * @todo：临时做一个最小化修改
     */
    ChangeSet.prototype.removeDescendantRemoveModifications = function (parentRemoveModification) {
        var _this = this;
        var parentPathWithId = this.createRemovePathWithId(parentRemoveModification);
        // 删除后代修改变更
        this.modifications = this.modifications.filter(function (modification) {
            if (modification.type !== ModifyType.Remove) {
                return true;
            }
            var descendantPathWithId = _this.createRemovePathWithId(modification);
            var isDescendant = _this.isDescendantPath(parentPathWithId, descendantPathWithId);
            return !isDescendant;
        });
    };
    /**
     * 获取删除路径的完整格式
     * @summary
     * 1、目前删除变更的路径标记到父集合；
     * 2、为了方便比较，将被删除的数据id加入到路径中
     */
    ChangeSet.prototype.createRemovePathWithId = function (modification) {
        var path = modification.path;
        var primaryKey = Object.keys(modification.value)[0];
        var primaryKeyValue = modification.value[primaryKey];
        var pathWithId = path.concat([primaryKey + ":" + primaryKeyValue]);
        return pathWithId;
    };
    /**
     * 判断是否是后代节点路径
     * @param parentPath 父节点路径
     * @param descendantPath 后代节点
     */
    ChangeSet.prototype.isDescendantPath = function (parentPath, descendantPath) {
        if (parentPath.length > descendantPath.length) {
            return false;
        }
        var isDescendantPath = true;
        parentPath.forEach(function (parentPathItem, parentPathItemIndex) {
            if (parentPathItem !== descendantPath[parentPathItemIndex]) {
                isDescendantPath = false;
                return;
            }
        });
        return isDescendantPath;
    };
    return ChangeSet;
}());
export { ChangeSet };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbmdlX3NldC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2NoYW5nZXNldC9jaGFuZ2Vfc2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFnQixVQUFVLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFbkQsU0FBUyxPQUFPLENBQUMsS0FBVSxFQUFFLEtBQVU7SUFDckMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDekQsQ0FBQztBQUVEOztHQUVHO0FBQ0g7SUFBQTtRQUVFOztXQUVHO1FBQ08sa0JBQWEsR0FBbUIsRUFBRSxDQUFDO0lBd04vQyxDQUFDO0lBbk5DLHNCQUFXLDhCQUFPO1FBSGxCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUM7UUFDNUIsQ0FBQzs7O09BQUE7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSSwwQkFBTSxHQUFiLFVBQWMsWUFBMEI7UUFDdEMsUUFBUSxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQ3pCLEtBQUssVUFBVSxDQUFDLFdBQVc7Z0JBQ3pCLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxZQUFZLENBQUMsQ0FBQztnQkFDakQsTUFBTTtZQUNSLEtBQUssVUFBVSxDQUFDLEdBQUcsQ0FBQztZQUNwQixLQUFLLFVBQVUsQ0FBQyxNQUFNLENBQUM7WUFDdkIsS0FBSyxVQUFVLENBQUMsS0FBSztnQkFDbkIsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUN6QyxNQUFNO1lBQ1IsS0FBSyxVQUFVLENBQUMsTUFBTTtnQkFDcEIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUM1QyxNQUFNO1lBQ1IsS0FBSyxVQUFVLENBQUMsSUFBSTtnQkFDbEIsTUFBTTtZQUNSO2dCQUNFLE1BQU07U0FDVDtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLGlEQUE2QixHQUFyQyxVQUFzQyxZQUEwQjtRQUM5RCxJQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBRWpDLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RSxJQUFJLG1CQUFtQixFQUFFO1lBRXZCLG1DQUFtQztZQUNuQyxtQkFBbUIsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1NBQ25DO2FBQU07WUFDTCxJQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0UsSUFBSSxzQkFBc0IsRUFBRTtnQkFFMUIsU0FBUztnQkFDVCxtQ0FBbUM7Z0JBQ25DLDBDQUEwQztnQkFDMUMsNENBQTRDO2dCQUM1QyxzQkFBc0IsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsc0JBQXNCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ3ZGO2lCQUFNO2dCQUVMLDBCQUEwQjtnQkFDMUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDdkM7U0FDRjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNLLHlDQUFxQixHQUE3QixVQUE4QixZQUEwQjtRQUN0RCxJQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO1FBRWpDLElBQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4RSxJQUFJLG1CQUFtQixFQUFFO1lBRXZCLCtCQUErQjtZQUMvQixtQkFBbUIsQ0FBQyxLQUFLLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUNyRTthQUFNO1lBRUwscUJBQXFCO1lBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssNENBQXdCLEdBQWhDLFVBQWlDLFlBQTBCO1FBRXpELElBQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDL0IsSUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEQsSUFBTSxlQUFlLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUV2RCxvQ0FBb0M7UUFDcEMsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQUMsZUFBNkI7WUFFdkQsVUFBVTtZQUNWLElBQUksZUFBZSxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsR0FBRyxJQUFJLGVBQWUsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sSUFBSSxlQUFlLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3RJLE9BQU87YUFDUjtZQUVELDBCQUEwQjtZQUMxQixJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLEtBQUssRUFBRTtnQkFDakQsT0FBTzthQUNSO1lBRUQsdUNBQXVDO1lBQ3ZDLGVBQWUsQ0FBQyxLQUFLLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQyxXQUFnQjtnQkFDcEUsT0FBTyxXQUFXLENBQUMsVUFBVSxDQUFDLEtBQUssZUFBZSxDQUFDO1lBQ3JELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxjQUFjO1FBQ2QsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBSSxVQUFVLFNBQUksZUFBaUIsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsVUFBQyxpQkFBK0I7WUFDN0UsSUFBSSxpQkFBaUIsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLFdBQVcsRUFBRTtnQkFDckQsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUNELElBQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0QsZUFBZSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBRXRCLFdBQVc7WUFDWCxJQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsZUFBZSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBQzVELE9BQU8sQ0FBQyxVQUFVLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7UUFFSCxnQkFBZ0I7UUFDaEIsdUNBQXVDO1FBQ3ZDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQ7O09BRUc7SUFDSSx5QkFBSyxHQUFaO1FBQ0UsSUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUdEOzs7T0FHRztJQUNLLHVDQUFtQixHQUEzQixVQUE0QixJQUFXO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsVUFBQyxLQUFLLEVBQUUsS0FBSztZQUMxQyxPQUFPLE9BQU8sQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3SSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSyx1Q0FBbUIsR0FBM0IsVUFBNEIsSUFBVztRQUNyQyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFVBQUMsS0FBSyxFQUFFLEtBQUs7WUFDMUMsT0FBTyxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDNUUsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssdURBQW1DLEdBQTNDLFVBQTRDLHdCQUFzQztRQUFsRixpQkFhQztRQVhDLElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLHdCQUF3QixDQUFDLENBQUM7UUFFL0UsV0FBVztRQUNYLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsVUFBQyxZQUEwQjtZQUN4RSxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLE1BQU0sRUFBRTtnQkFDM0MsT0FBTyxJQUFJLENBQUM7YUFDYjtZQUNELElBQU0sb0JBQW9CLEdBQUcsS0FBSSxDQUFDLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ3ZFLElBQU0sWUFBWSxHQUFHLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO1lBQ25GLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDdkIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSywwQ0FBc0IsR0FBOUIsVUFBK0IsWUFBMEI7UUFDdkQsSUFBTSxJQUFJLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztRQUMvQixJQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN0RCxJQUFNLGVBQWUsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3ZELElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBSSxVQUFVLFNBQUksZUFBaUIsQ0FBQyxDQUFDLENBQUM7UUFDckUsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxvQ0FBZ0IsR0FBeEIsVUFBeUIsVUFBb0IsRUFBRSxjQUF3QjtRQUNyRSxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDLE1BQU0sRUFBRTtZQUM3QyxPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDNUIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFDLGNBQXNCLEVBQUUsbUJBQTJCO1lBQ3JFLElBQUksY0FBYyxLQUFLLGNBQWMsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO2dCQUMxRCxnQkFBZ0IsR0FBRyxLQUFLLENBQUM7Z0JBQ3pCLE9BQU87YUFDUjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxnQkFBZ0IsQ0FBQztJQUMxQixDQUFDO0lBRUgsZ0JBQUM7QUFBRCxDQUFDLEFBN05ELElBNk5DO0FBRUQsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQEF1dGhvcjogTHVjdXMsIFdpdHRcclxuICogQERhdGU6IDIwMTgtMTAtMzAgMTU6NTM6NTlcclxuICogQExhc3QgTW9kaWZpZWQgYnk6IFdpdHRcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOC0xMS0wOCAxNzoyNTowOFxyXG4gKi9cclxuXHJcbmltcG9ydCB7IE1vZGlmaWNhdGlvbiwgTW9kaWZ5VHlwZSB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuZnVuY3Rpb24gaXNFcXVhbCh2YWx1ZTogYW55LCBvdGhlcjogYW55KSB7XHJcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHZhbHVlKSA9PT0gSlNPTi5zdHJpbmdpZnkob3RoZXIpO1xyXG59XHJcblxyXG4vKipcclxuICog5a6e5L2T5pWw5o2u5Y+Y5pu06ZuGXHJcbiAqL1xyXG5jbGFzcyBDaGFuZ2VTZXQge1xyXG5cclxuICAvKipcclxuICAgKiDlj5jmm7Tpm4blkIhcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgbW9kaWZpY2F0aW9uczogTW9kaWZpY2F0aW9uW10gPSBbXTtcclxuXHJcbiAgLyoqXHJcbiAgICogIOiOt+WPluaJgOacieeahOWPmOabtOiusOW9lVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgY2hhbmdlcygpOiBNb2RpZmljYXRpb25bXSB7XHJcbiAgICByZXR1cm4gdGhpcy5tb2RpZmljYXRpb25zO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5bCG5Y+Y5pu06ZuG5re75Yqg5Yiw6ZuG5ZCI5LitXHJcbiAgICogIyMjIOS9v+eUqOekuuS+i1xyXG4gICAqIGBgYFxyXG4gICAqIGNvbnN0IGNoYW5nZVNldCA9IG5ldyBDaGFuZ2VTZXQoKTtcclxuICAgKiBjb25zdCBtb2RpZnkgPSBuZXcgTW9kaWZpY2F0aW9uKCduZXdWYWx1ZScsIE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UsIFsxLCAndGl0bGUnXSwgJ29sZFZhbHVlJyk7XHJcbiAgICogY2hhbmdlU2V0LmFwcGVuZChtb2RpZnkpXHJcbiAgICogYGBgXHJcbiAgICogQHBhcmFtIGNoYW5nZUl0ZW0g5Y+Y5pu05pWw5o2uXHJcbiAgICovXHJcbiAgcHVibGljIGFwcGVuZChtb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikge1xyXG4gICAgc3dpdGNoIChtb2RpZmljYXRpb24udHlwZSkge1xyXG4gICAgICBjYXNlIE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2U6XHJcbiAgICAgICAgdGhpcy5hcHBlbmRWYWx1ZUNoYW5nZU1vZGlmaWNhdGlvbihtb2RpZmljYXRpb24pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlIE1vZGlmeVR5cGUuQWRkOlxyXG4gICAgICBjYXNlIE1vZGlmeVR5cGUuSW5zZXJ0OlxyXG4gICAgICBjYXNlIE1vZGlmeVR5cGUuQ2xvbmU6XHJcbiAgICAgICAgdGhpcy5hcHBlbmRBZGRNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBNb2RpZnlUeXBlLlJlbW92ZTpcclxuICAgICAgICB0aGlzLmFwcGVuZFJlbW92ZU1vZGlmaWNhdGlvbihtb2RpZmljYXRpb24pO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlIE1vZGlmeVR5cGUuTG9hZDpcclxuICAgICAgICBicmVhaztcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICBicmVhaztcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWAvOWPmOWMluWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwZW5kVmFsdWVDaGFuZ2VNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcclxuICAgIGNvbnN0IHZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xyXG5cclxuICAgIGNvbnN0IGV4aXN0ZWRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmRNb2RpZnlJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xyXG4gICAgaWYgKGV4aXN0ZWRNb2RpZmljYXRpb24pIHtcclxuXHJcbiAgICAgIC8vIOWmguaenOWtmOWcqOebuOWQjOi3r+W+hOeahFZhbHVlQ2hhbmdl57G75Z6L55qE5Y+Y5pu06ZuG77yM5YiZ5pu05paw5YC877ybXHJcbiAgICAgIGV4aXN0ZWRNb2RpZmljYXRpb24udmFsdWUgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGV4aXN0ZWRBZGRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmROZXdBZGRJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xyXG4gICAgICBpZiAoZXhpc3RlZEFkZE1vZGlmaWNhdGlvbikge1xyXG5cclxuICAgICAgICAvLyBAdG9kb++8mlxyXG4gICAgICAgIC8vIDHjgIHmraTlpITpgLvovpHmnInpl67popjvvIx2YWx1ZeaYr+S4quWtl+espuS4su+8jOS4jeiDveebtOaOpWFzc2lnbu+8m1xyXG4gICAgICAgIC8vIDLjgIHkuYvmiYDku6XmsqHmnInlh7rnjrDpl67popjvvIzmmK/lm6DkuLrpg73mmK/mnI3liqHlmajnq6/mlrDlop7vvIzmlrDlop7lkI7vvIzlrqLmiLfnq6/muIXnqbrkuobmiYDmnInlj5jmm7TjgIJcclxuICAgICAgICAvLyDlpoLmnpzlrZjlnKjmtrXnm5bor6VWYWx1ZUNoYW5nZeWPmOabtOeahEFkZOWPmOabtO+8jOWImeabtOaWsEFkZOWPmOabtOWvueW6lOeahOaVsOaNru+8m1xyXG4gICAgICAgIGV4aXN0ZWRBZGRNb2RpZmljYXRpb24udmFsdWUgPSBPYmplY3QuYXNzaWduKHt9LCBleGlzdGVkQWRkTW9kaWZpY2F0aW9uLnZhbHVlLCB2YWx1ZSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICAgIC8vIOWFtuS7luaDheWGte+8jOaWsOWinuS4gOadoVZhbHVlQ2hhbmdl5Y+Y5pu044CCXHJcbiAgICAgICAgdGhpcy5tb2RpZmljYXRpb25zLnB1c2gobW9kaWZpY2F0aW9uKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5paw5aKe5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhcHBlbmRBZGRNb2RpZmljYXRpb24obW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pIHtcclxuICAgIGNvbnN0IHZhbHVlID0gbW9kaWZpY2F0aW9uLnZhbHVlO1xyXG5cclxuICAgIGNvbnN0IGV4aXN0ZWRNb2RpZmljYXRpb24gPSB0aGlzLmZpbmROZXdBZGRJdGVtc1BhdGgobW9kaWZpY2F0aW9uLnBhdGgpO1xyXG4gICAgaWYgKGV4aXN0ZWRNb2RpZmljYXRpb24pIHtcclxuXHJcbiAgICAgIC8vIDHjgIHlpoLmnpzlt7Lnu4/lrZjlnKjnm7jlkIzot6/lvoTnmoRBZGTlj5jmm7TvvIzliJnlkIjlubZWYWx1ZeOAglxyXG4gICAgICBleGlzdGVkTW9kaWZpY2F0aW9uLnZhbHVlID0gZXhpc3RlZE1vZGlmaWNhdGlvbi52YWx1ZS5jb25jYXQodmFsdWUpO1xyXG4gICAgfSBlbHNlIHtcclxuXHJcbiAgICAgIC8vIDLjgIHlpoLmnpzmsqHmnInvvIzliJnmlrDlop7kuIDmnaFBZGTlj5jmm7TjgIJcclxuICAgICAgdGhpcy5tb2RpZmljYXRpb25zLnB1c2gobW9kaWZpY2F0aW9uKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOWIoOmZpOWPmOabtFxyXG4gICAqL1xyXG4gIHByaXZhdGUgYXBwZW5kUmVtb3ZlTW9kaWZpY2F0aW9uKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XHJcblxyXG4gICAgY29uc3QgcGF0aCA9IG1vZGlmaWNhdGlvbi5wYXRoO1xyXG4gICAgY29uc3QgcHJpbWFyeUtleSA9IE9iamVjdC5rZXlzKG1vZGlmaWNhdGlvbi52YWx1ZSlbMF07XHJcbiAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSBtb2RpZmljYXRpb24udmFsdWVbcHJpbWFyeUtleV07XHJcblxyXG4gICAgLy8gMeOAgeWtmOWcqOebuOWQjHBhdGjnmoTmlrDlop7lj5jmm7TvvIznp7vpmaTmlrDlop7lj5jmm7TvvIzkuI3pnIDopoHmt7vliqDliKDpmaTlj5jmm7TvvJtcclxuICAgIC8vIEB0b2Rv77ya5b6F6YeN5p6E77yIMeOAgeWPquiAg+iZkeS6huS4u+S7juaDheWGte+8jDLjgIHkuLTml7bnlKjlpJrph43lvqrnjq/lrp7njrDvvIlcclxuICAgIHRoaXMubW9kaWZpY2F0aW9ucy5mb3JFYWNoKChhZGRNb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbikgPT4ge1xyXG5cclxuICAgICAgLy8g5Y+q5aSE55CG5paw5aKe5Y+Y5pu0XHJcbiAgICAgIGlmIChhZGRNb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5BZGQgJiYgYWRkTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuSW5zZXJ0ICYmIGFkZE1vZGlmaWNhdGlvbi50eXBlICE9PSBNb2RpZnlUeXBlLkNsb25lKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBAdG9kbyDlj6rogIPomZHkuLvku47nu5PmnoTvvIzlho3mt7HnmoTlsYLmrKHmmoLkuI3ogIPomZFcclxuICAgICAgaWYgKGlzRXF1YWwoYWRkTW9kaWZpY2F0aW9uLnBhdGgsIHBhdGgpID09PSBmYWxzZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8g6YGN5Y6G5paw5aKe5paw5aKe5Y+Y5pu055qEdmFsdWXvvIh2YWx1ZeaYr+S4quaVsOe7hO+8ie+8jOenu+mZpOebuOWMuemFjeeahOaWsOWinuWIoOmZpFxyXG4gICAgICBhZGRNb2RpZmljYXRpb24udmFsdWUgPSBhZGRNb2RpZmljYXRpb24udmFsdWUuZmlsdGVyKChhZGREYXRhSXRlbTogYW55KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGFkZERhdGFJdGVtW3ByaW1hcnlLZXldICE9PSBwcmltYXJ5S2V5VmFsdWU7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgLy8gMuOAgeenu+mZpOWvueW6lOeahOS/ruaUueWPmOabtFxyXG4gICAgY29uc3QgZnVsbFJlbW92ZVBhdGggPSBwYXRoLmNvbmNhdChgJHtwcmltYXJ5S2V5fToke3ByaW1hcnlLZXlWYWx1ZX1gKTtcclxuICAgIHRoaXMubW9kaWZpY2F0aW9ucyA9IHRoaXMubW9kaWZpY2F0aW9ucy5maWx0ZXIoKHZhbHVlTW9kaWZpY2F0aW9uOiBNb2RpZmljYXRpb24pID0+IHtcclxuICAgICAgaWYgKHZhbHVlTW9kaWZpY2F0aW9uLnR5cGUgIT09IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2UpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB2YWx1ZUNoYW5nZVBhdGggPSBBcnJheS5mcm9tKHZhbHVlTW9kaWZpY2F0aW9uLnBhdGgpO1xyXG4gICAgICB2YWx1ZUNoYW5nZVBhdGgucG9wKCk7XHJcblxyXG4gICAgICAvLyDot6/lvoTnm7jlkIzov5vooYznp7vpmaRcclxuICAgICAgY29uc3QgaXNUb1JlbW92ZSA9IGlzRXF1YWwodmFsdWVDaGFuZ2VQYXRoLCBmdWxsUmVtb3ZlUGF0aCk7XHJcbiAgICAgIHJldHVybiAhaXNUb1JlbW92ZTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIOWFiOWIoOmZpOS4i+e6p+WIoOmZpOWPmOabtO+8jOWGjeaPkuWFpVxyXG4gICAgLy8g5Li76KaB6ZKI5a+55LuO5LuO6KGo5Yig6Zmk5LmL5ZCO77yM5Y+I5Yig6Zmk5a2Q6KGo5pe277yM5qC55a6e5L2T5LiK6L+Y5a2Y5Zyo5LuO5LuO6KGo5Yig6Zmk5Y+Y5pu055qE5Zy65pmvXHJcbiAgICB0aGlzLnJlbW92ZURlc2NlbmRhbnRSZW1vdmVNb2RpZmljYXRpb25zKG1vZGlmaWNhdGlvbik7XHJcbiAgICB0aGlzLm1vZGlmaWNhdGlvbnMucHVzaChtb2RpZmljYXRpb24pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF56m65Y+Y5pu06ZuG5ZCIXHJcbiAgICovXHJcbiAgcHVibGljIGNsZWFyKCkge1xyXG4gICAgdGhpcy5tb2RpZmljYXRpb25zID0gW107XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPlkFkZOexu+Wei+eahOWPmOabtOiusOW9lVxyXG4gICAqIEBwYXJhbSBwYXRoIOWPmOabtOi3r+W+hFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZmluZE5ld0FkZEl0ZW1zUGF0aChwYXRoOiBhbnlbXSkge1xyXG4gICAgcmV0dXJuIHRoaXMubW9kaWZpY2F0aW9ucy5maW5kKCh2YWx1ZSwgaW5kZXgpID0+IHtcclxuICAgICAgcmV0dXJuIGlzRXF1YWwocGF0aCwgdmFsdWUucGF0aCkgJiYgKHZhbHVlLnR5cGUgPT09IE1vZGlmeVR5cGUuQWRkIHx8IHZhbHVlLnR5cGUgPT09IE1vZGlmeVR5cGUuSW5zZXJ0IHx8IHZhbHVlLnR5cGUgPT09IE1vZGlmeVR5cGUuQ2xvbmUpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja5wYXRo6I635Y+WVmFsdWVDaGFuZ2XnsbvlnovnmoTlj5jmm7TorrDlvZVcclxuICAgKiBAcGFyYW0gcGF0aCDlj5jmm7Tot6/lvoRcclxuICAgKi9cclxuICBwcml2YXRlIGZpbmRNb2RpZnlJdGVtc1BhdGgocGF0aDogYW55W10pIHtcclxuICAgIHJldHVybiB0aGlzLm1vZGlmaWNhdGlvbnMuZmluZCgodmFsdWUsIGluZGV4KSA9PiB7XHJcbiAgICAgIHJldHVybiBpc0VxdWFsKHBhdGgsIHZhbHVlLnBhdGgpICYmIHZhbHVlLnR5cGUgPT09IE1vZGlmeVR5cGUuVmFsdWVDaGFuZ2U7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIoOmZpOWQjuS7o++8iOWMheaLrOiHquW3se+8ieaJgOacieeahOWIoOmZpOWPmOabtFxyXG4gICAqIEB0b2Rv77ya5Li05pe25YGa5LiA5Liq5pyA5bCP5YyW5L+u5pS5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSByZW1vdmVEZXNjZW5kYW50UmVtb3ZlTW9kaWZpY2F0aW9ucyhwYXJlbnRSZW1vdmVNb2RpZmljYXRpb246IE1vZGlmaWNhdGlvbik6IHZvaWQge1xyXG5cclxuICAgIGNvbnN0IHBhcmVudFBhdGhXaXRoSWQgPSB0aGlzLmNyZWF0ZVJlbW92ZVBhdGhXaXRoSWQocGFyZW50UmVtb3ZlTW9kaWZpY2F0aW9uKTtcclxuXHJcbiAgICAvLyDliKDpmaTlkI7ku6Pkv67mlLnlj5jmm7RcclxuICAgIHRoaXMubW9kaWZpY2F0aW9ucyA9IHRoaXMubW9kaWZpY2F0aW9ucy5maWx0ZXIoKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSA9PiB7XHJcbiAgICAgIGlmIChtb2RpZmljYXRpb24udHlwZSAhPT0gTW9kaWZ5VHlwZS5SZW1vdmUpIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCBkZXNjZW5kYW50UGF0aFdpdGhJZCA9IHRoaXMuY3JlYXRlUmVtb3ZlUGF0aFdpdGhJZChtb2RpZmljYXRpb24pO1xyXG4gICAgICBjb25zdCBpc0Rlc2NlbmRhbnQgPSB0aGlzLmlzRGVzY2VuZGFudFBhdGgocGFyZW50UGF0aFdpdGhJZCwgZGVzY2VuZGFudFBhdGhXaXRoSWQpO1xyXG4gICAgICByZXR1cm4gIWlzRGVzY2VuZGFudDtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5Yig6Zmk6Lev5b6E55qE5a6M5pW05qC85byPXHJcbiAgICogQHN1bW1hcnlcclxuICAgKiAx44CB55uu5YmN5Yig6Zmk5Y+Y5pu055qE6Lev5b6E5qCH6K6w5Yiw54i26ZuG5ZCI77ybXHJcbiAgICogMuOAgeS4uuS6huaWueS+v+avlOi+g++8jOWwhuiiq+WIoOmZpOeahOaVsOaNrmlk5Yqg5YWl5Yiw6Lev5b6E5LitXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVSZW1vdmVQYXRoV2l0aElkKG1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uKSB7XHJcbiAgICBjb25zdCBwYXRoID0gbW9kaWZpY2F0aW9uLnBhdGg7XHJcbiAgICBjb25zdCBwcmltYXJ5S2V5ID0gT2JqZWN0LmtleXMobW9kaWZpY2F0aW9uLnZhbHVlKVswXTtcclxuICAgIGNvbnN0IHByaW1hcnlLZXlWYWx1ZSA9IG1vZGlmaWNhdGlvbi52YWx1ZVtwcmltYXJ5S2V5XTtcclxuICAgIGNvbnN0IHBhdGhXaXRoSWQgPSBwYXRoLmNvbmNhdChbYCR7cHJpbWFyeUtleX06JHtwcmltYXJ5S2V5VmFsdWV9YF0pO1xyXG4gICAgcmV0dXJuIHBhdGhXaXRoSWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliKTmlq3mmK/lkKbmmK/lkI7ku6PoioLngrnot6/lvoRcclxuICAgKiBAcGFyYW0gcGFyZW50UGF0aCDniLboioLngrnot6/lvoRcclxuICAgKiBAcGFyYW0gZGVzY2VuZGFudFBhdGgg5ZCO5Luj6IqC54K5XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBpc0Rlc2NlbmRhbnRQYXRoKHBhcmVudFBhdGg6IHN0cmluZ1tdLCBkZXNjZW5kYW50UGF0aDogc3RyaW5nW10pIHtcclxuICAgIGlmIChwYXJlbnRQYXRoLmxlbmd0aCA+IGRlc2NlbmRhbnRQYXRoLmxlbmd0aCkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IGlzRGVzY2VuZGFudFBhdGggPSB0cnVlO1xyXG4gICAgcGFyZW50UGF0aC5mb3JFYWNoKChwYXJlbnRQYXRoSXRlbTogc3RyaW5nLCBwYXJlbnRQYXRoSXRlbUluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgaWYgKHBhcmVudFBhdGhJdGVtICE9PSBkZXNjZW5kYW50UGF0aFtwYXJlbnRQYXRoSXRlbUluZGV4XSkge1xyXG4gICAgICAgIGlzRGVzY2VuZGFudFBhdGggPSBmYWxzZTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBpc0Rlc2NlbmRhbnRQYXRoO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IENoYW5nZVNldCB9O1xyXG5cclxuIl19