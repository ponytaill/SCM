/**
 * 使用方法：
 * [comob-lookup-data-mapping]="{ id: 'user.userId', name: 'user.userName' }"
 * key 为帮助上的字段， value 为 表单中的字段名
 * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}
 * 多字段以逗号隔开
 *
 */
import * as tslib_1 from "tslib";
import { Directive, Optional, Self, Input } from '@angular/core';
import { BindingObject, ViewModel } from '@farris/devkit';
import { ComboLookupComponent } from '@farris/ui-combo-lookup';
import { DataMapping } from './data-mapping';
var ComboLookupDataMappingDirective = /** @class */ (function (_super) {
    tslib_1.__extends(ComboLookupDataMappingDirective, _super);
    function ComboLookupDataMappingDirective(vm, lookup) {
        var _this = _super.call(this) || this;
        _this.vm = vm;
        _this.lookup = lookup;
        _this.target = null;
        if (_this.lookup) {
            _this.lookup.useFormDataMapping = true;
        }
        return _this;
    }
    ComboLookupDataMappingDirective.prototype.ngOnInit = function () {
        var _this = this;
        // 值变化，亦通过该事件触发任意输入清空事件
        this.lookup.valueChange.subscribe(function (result) {
            if (!result['nosearch']) {
                // 值变化
                var data = result.selections && result.selections.length > 0 ? result.selections : null;
                _this.onValueChange(data);
            }
            else {
                // 任意输入清空映射字段
                _this.onClearMapping();
            }
        });
        // 清空事件
        this.lookup.clear.subscribe(function () {
            var _mapfields = _this.mapfields || _this.lookup.mapFields;
            _this.mappingData(null, _mapfields);
        });
    };
    ComboLookupDataMappingDirective.prototype.onClearMapping = function () {
        var _this = this;
        var mapfields = Object.assign({}, (this.mapfields || this.lookup.mapFields || {}));
        var lookupTextField = this.lookup.textField;
        var data = {};
        var controlName = this.lookup.ngControl && this.lookup.ngControl.name;
        if (controlName && this.vm) {
            var textFieldMapping = mapfields[lookupTextField];
            var ngFormControl = this.vm && this.vm.form && this.vm.form.ngFormControls && this.vm.form.ngFormControls[controlName];
            var binding_1 = ngFormControl && ngFormControl.binding;
            if (textFieldMapping && binding_1) {
                var targetField = textFieldMapping.split(',').filter(function (item) { return item !== binding_1; }).join(',');
                if (targetField) {
                    mapfields[lookupTextField] = targetField;
                }
                else {
                    delete mapfields[lookupTextField];
                }
            }
        }
        // this.setValue(data, lookupTextField.split('.'), value);
        Object.keys(mapfields).forEach(function (field) {
            _this.setValue(data, field.split('.'), '');
        });
        this.mappingData(data, mapfields, true);
    };
    ComboLookupDataMappingDirective.prototype.onValueChange = function (data) {
        var _mapfields = this.mapfields || this.lookup.mapFields;
        this.mappingData(data, _mapfields);
    };
    ComboLookupDataMappingDirective.decorators = [
        { type: Directive, args: [{ selector: '[combo-lookup-data-mapping]' },] }
    ];
    /** @nocollapse */
    ComboLookupDataMappingDirective.ctorParameters = function () { return [
        { type: ViewModel, decorators: [{ type: Optional }] },
        { type: ComboLookupComponent, decorators: [{ type: Optional }, { type: Self }] }
    ]; };
    ComboLookupDataMappingDirective.propDecorators = {
        mapfields: [{ type: Input, args: ['combo-lookup-data-mapping',] }],
        target: [{ type: Input, args: ['target',] }]
    };
    return ComboLookupDataMappingDirective;
}(DataMapping));
export { ComboLookupDataMappingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYm8tbG9va3VwLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9jb21iby1sb29rdXAtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQTs7Ozs7OztHQU9HOztBQUVILE9BQU8sRUFBRSxTQUFTLEVBQVUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekUsT0FBTyxFQUFFLGFBQWEsRUFBaUIsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFekUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzdDO0lBQ3FELDJEQUFXO0lBSzlELHlDQUErQixFQUFhLEVBQThCLE1BQTRCO1FBQXRHLFlBQ0UsaUJBQU8sU0FJUjtRQUw4QixRQUFFLEdBQUYsRUFBRSxDQUFXO1FBQThCLFlBQU0sR0FBTixNQUFNLENBQXNCO1FBRnJGLFlBQU0sR0FBa0IsSUFBSSxDQUFDO1FBSTVDLElBQUksS0FBSSxDQUFDLE1BQU0sRUFBRTtZQUNmLEtBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1NBQ3ZDOztJQUNILENBQUM7SUFFRCxrREFBUSxHQUFSO1FBQUEsaUJBaUJDO1FBaEJDLHVCQUF1QjtRQUN2QixJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsVUFBQyxNQUFvQjtZQUNyRCxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUN2QixNQUFNO2dCQUNOLElBQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxVQUFVLElBQUksTUFBTSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFD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dUJBWWpDLFFBQVE7Z0JBVmQsb0JBQW9CLHVCQVVvQixRQUFRLFlBQUksSUFBSTs7OzRCQUg5RCxLQUFLLFNBQUMsMkJBQTJCO3lCQUNqQyxLQUFLLFNBQUMsUUFBUTs7SUF1RGpCLHNDQUFDO0NBQUEsQUEzREQsQ0FDcUQsV0FBVyxHQTBEL0Q7U0ExRFksK0JBQStCIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbi8qKlxyXG4gKiDkvb/nlKjmlrnms5XvvJpcclxuICogW2NvbW9iLWxvb2t1cC1kYXRhLW1hcHBpbmddPVwieyBpZDogJ3VzZXIudXNlcklkJywgbmFtZTogJ3VzZXIudXNlck5hbWUnIH1cIlxyXG4gKiBrZXkg5Li65biu5Yqp5LiK55qE5a2X5q6177yMIHZhbHVlIOS4uiDooajljZXkuK3nmoTlrZfmrrXlkI1cclxuICog5biu5Yqp5LiK55qE5ZCM5LiA5Liq5a2X5q615Y+v5Lul5pig5bCE5Yiw6KGo5Y2V5Lit55qE5aSa5Liq5a2X5q615Lit77yMeyAuLi4gaWQ6ICd1c2VyLnVzZXJpZCwgdXNlci5hZGR1c2lkJ31cclxuICog5aSa5a2X5q615Lul6YCX5Y+36ZqU5byAXHJcbiAqXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgRGlyZWN0aXZlLCBPbkluaXQsIE9wdGlvbmFsLCBTZWxmLCBJbnB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBCaW5kaW5nT2JqZWN0LCBOZ0Zvcm1Db250cm9sLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IENvbWJvQ2hhbmdlcyB9IGZyb20gJ0BmYXJyaXMvdWktY29tYm8tbGlzdCc7XHJcbmltcG9ydCB7IENvbWJvTG9va3VwQ29tcG9uZW50IH0gZnJvbSAnQGZhcnJpcy91aS1jb21iby1sb29rdXAnO1xyXG5pbXBvcnQgeyBEYXRhTWFwcGluZyB9IGZyb20gJy4vZGF0YS1tYXBwaW5nJztcclxuXHJcblxyXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbY29tYm8tbG9va3VwLWRhdGEtbWFwcGluZ10nIH0pXHJcbmV4cG9ydCBjbGFzcyBDb21ib0xvb2t1cERhdGFNYXBwaW5nRGlyZWN0aXZlIGV4dGVuZHMgRGF0YU1hcHBpbmcgaW1wbGVtZW50cyBPbkluaXQge1xyXG5cclxuICBASW5wdXQoJ2NvbWJvLWxvb2t1cC1kYXRhLW1hcHBpbmcnKSBtYXBmaWVsZHM6IGFueTtcclxuICBASW5wdXQoJ3RhcmdldCcpIHRhcmdldDogQmluZGluZ09iamVjdCA9IG51bGw7XHJcblxyXG4gIGNvbnN0cnVjdG9yKEBPcHRpb25hbCgpIHB1YmxpYyB2bTogVmlld01vZGVsLCBAT3B0aW9uYWwoKSBAU2VsZigpIHByaXZhdGUgbG9va3VwOiBDb21ib0xvb2t1cENvbXBvbmVudCkge1xyXG4gICAgc3VwZXIoKTtcclxuICAgIGlmICh0aGlzLmxvb2t1cCkge1xyXG4gICAgICB0aGlzLmxvb2t1cC51c2VGb3JtRGF0YU1hcHBpbmcgPSB0cnVlO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKSB7XHJcbiAgICAvLyDlgLzlj5jljJbvvIzkuqbpgJrov4for6Xkuovku7bop6blj5Hku7vmhI/ovpPlhaXmuIXnqbrkuovku7ZcclxuICAgIHRoaXMubG9va3VwLnZhbHVlQ2hhbmdlLnN1YnNjcmliZSgocmVzdWx0OiBDb21ib0NoYW5nZXMpID0+IHtcclxuICAgICAgaWYgKCFyZXN1bHRbJ25vc2VhcmNoJ10pIHtcclxuICAgICAgICAvLyDlgLzlj5jljJZcclxuICAgICAgICBjb25zdCBkYXRhID0gcmVzdWx0LnNlbGVjdGlvbnMgJiYgcmVzdWx0LnNlbGVjdGlvbnMubGVuZ3RoID4gMCA/IHJlc3VsdC5zZWxlY3Rpb25zIDogbnVsbDtcclxuICAgICAgICB0aGlzLm9uVmFsdWVDaGFuZ2UoZGF0YSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8g5Lu75oSP6L6T5YWl5riF56m65pig5bCE5a2X5q61XHJcbiAgICAgICAgdGhpcy5vbkNsZWFyTWFwcGluZygpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIC8vIOa4heepuuS6i+S7tlxyXG4gICAgdGhpcy5sb29rdXAuY2xlYXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgY29uc3QgX21hcGZpZWxkcyA9IHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcztcclxuICAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBfbWFwZmllbGRzKTtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwcml2YXRlIG9uQ2xlYXJNYXBwaW5nKCkge1xyXG4gICAgY29uc3QgbWFwZmllbGRzID0gT2JqZWN0LmFzc2lnbih7fSwgKHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcyB8fCB7fSkpO1xyXG4gICAgY29uc3QgbG9va3VwVGV4dEZpZWxkID0gdGhpcy5sb29rdXAudGV4dEZpZWxkO1xyXG4gICAgY29uc3QgZGF0YSA9IHt9O1xyXG4gICAgY29uc3QgY29udHJvbE5hbWUgPSB0aGlzLmxvb2t1cC5uZ0NvbnRyb2wgJiYgdGhpcy5sb29rdXAubmdDb250cm9sLm5hbWU7XHJcbiAgICBpZiAoY29udHJvbE5hbWUgJiYgdGhpcy52bSkge1xyXG4gICAgICBjb25zdCB0ZXh0RmllbGRNYXBwaW5nID0gbWFwZmllbGRzW2xvb2t1cFRleHRGaWVsZF07XHJcbiAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2wgPSB0aGlzLnZtICYmIHRoaXMudm0uZm9ybSAmJiB0aGlzLnZtLmZvcm0ubmdGb3JtQ29udHJvbHMgJiYgdGhpcy52bS5mb3JtLm5nRm9ybUNvbnRyb2xzW2NvbnRyb2xOYW1lXSBhcyBOZ0Zvcm1Db250cm9sO1xyXG4gICAgICBjb25zdCBiaW5kaW5nID0gbmdGb3JtQ29udHJvbCAmJiBuZ0Zvcm1Db250cm9sLmJpbmRpbmc7XHJcbiAgICAgIGlmICh0ZXh0RmllbGRNYXBwaW5nICYmIGJpbmRpbmcpIHtcclxuICAgICAgICBjb25zdCB0YXJnZXRGaWVsZCA9IHRleHRGaWVsZE1hcHBpbmcuc3BsaXQoJywnKS5maWx0ZXIoaXRlbSA9PiBpdGVtICE9PSBiaW5kaW5nKS5qb2luKCcsJyk7XHJcbiAgICAgICAgaWYgKHRhcmdldEZpZWxkKSB7XHJcbiAgICAgICAgICBtYXBmaWVsZHNbbG9va3VwVGV4dEZpZWxkXSA9IHRhcmdldEZpZWxkO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBkZWxldGUgbWFwZmllbGRzW2xvb2t1cFRleHRGaWVsZF07XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyB0aGlzLnNldFZhbHVlKGRhdGEsIGxvb2t1cFRleHRGaWVsZC5zcGxpdCgnLicpLCB2YWx1ZSk7XHJcbiAgICBPYmplY3Qua2V5cyhtYXBmaWVsZHMpLmZvckVhY2goZmllbGQgPT4ge1xyXG4gICAgICB0aGlzLnNldFZhbHVlKGRhdGEsIGZpZWxkLnNwbGl0KCcuJyksICcnKTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5tYXBwaW5nRGF0YShkYXRhLCBtYXBmaWVsZHMsIHRydWUpO1xyXG4gIH1cclxuICBwcml2YXRlIG9uVmFsdWVDaGFuZ2UoZGF0YSkge1xyXG4gICAgY29uc3QgX21hcGZpZWxkcyA9IHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcztcclxuICAgIHRoaXMubWFwcGluZ0RhdGEoZGF0YSwgX21hcGZpZWxkcyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==