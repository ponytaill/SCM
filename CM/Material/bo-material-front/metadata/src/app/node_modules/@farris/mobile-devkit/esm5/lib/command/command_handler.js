import * as tslib_1 from "tslib";
import { Subject, BehaviorSubject } from 'rxjs';
import { concatMap, map, takeLast, take, throwIfEmpty } from 'rxjs/operators';
import { createInjectionToken } from '../core/index';
import { VariableParseService } from '../variable/index';
import { CommandContext } from './command_context';
import { TaskFlow } from './flow/index';
/**
 * 命令处理抽象类，所有具体的命令处理类必须继承它，并实现schedule方法。
 */
var CommandHandler = /** @class */ (function () {
    /**
     * 构造函数
     */
    function CommandHandler() {
    }
    /**
     * 初始化
     */
    CommandHandler.prototype.init = function (viewModelContext) {
        this.viewModelContext = viewModelContext;
        this.parseService = viewModelContext.injector.get(VariableParseService);
        this.taskFlow = new TaskFlow();
        this.schedule();
    };
    /**
     * 执行任务
     * @param command 要执行的命令
     * @return 最后一个任务的执行结果
     * @todo：按功能拆分小函数
     */
    CommandHandler.prototype.execute = function (command) {
        var _this = this;
        var lastTaskResult$ = new Subject();
        var taskFlow = this.taskFlow.clone();
        // setTimeout暂时不能去掉的原因：
        // 1、树表单加载数据，依赖TreeTableBinding里设置的全局变量，需要延后执行加载时机；
        // 2、关闭前命令需要延迟执行。
        setTimeout(function () {
            // 1、解析参数
            // 避免解析变量时修改了原始的command
            var _a = tslib_1.__assign({}, command).eventParam, eventParam = _a === void 0 ? null : _a;
            delete command.eventParam;
            var commandToExecute = JSON.parse(JSON.stringify(command));
            commandToExecute.params = _this.parseService.parse(commandToExecute.params, _this.viewModelContext);
            command.eventParam = eventParam;
            commandToExecute.eventParam = eventParam;
            // 2、串联任务流
            var initContext = new CommandContext(commandToExecute, _this.viewModelContext);
            initContext.eventParams = command.eventParam || null;
            var context$ = new BehaviorSubject(initContext);
            var currentTask = taskFlow.getNext('', initContext);
            var highOrder$ = context$.pipe(concatMap(function (context) {
                var result$ = currentTask.execute(context);
                return result$.pipe(take(1), map(function (result) {
                    // 写入执行结果
                    context.results[currentTask.name] = result;
                    context.latestResult = result;
                    currentTask = taskFlow.getNext(currentTask.name, context);
                    // 操作控制流
                    if (currentTask) {
                        context$.next(context);
                    }
                    else {
                        context$.complete();
                    }
                    // 将结果流转换为context流
                    return context;
                }), throwIfEmpty(function () {
                    context$.complete();
                }));
            }));
            // 3、执行合并后的任务流
            highOrder$.pipe(takeLast(1)).subscribe({
                next: function (context) {
                    lastTaskResult$.next(context.latestResult);
                },
                error: function (error) {
                    _this.displayError(error);
                    lastTaskResult$.error(error);
                },
                complete: function () {
                    lastTaskResult$.complete();
                },
            });
        }, 0);
        return lastTaskResult$;
    };
    /**
     * 显示错误信息
     */
    CommandHandler.prototype.displayError = function (error) {
        if (!error) {
            return;
        }
        if (!console || !console.error) {
            return;
        }
        console.error(error);
    };
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    CommandHandler.prototype.addTask = function (name, func) {
        this.taskFlow.addNode(name, func);
    };
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    CommandHandler.prototype.addLink = function (from, to, condition) {
        this.taskFlow.addLink(from, to, condition);
    };
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    CommandHandler.prototype.insertTask = function (target, name, func) {
        throw new Error('Not Implemented');
    };
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    CommandHandler.prototype.afterTask = function (target, name, func) {
        throw new Error('Not Implemented');
    };
    /**
     * 替换任务
     * @param  name 要替换的任务名称
     * @param  func 替换函数
     */
    CommandHandler.prototype.replaceTask = function (name, func) {
        throw new Error('Not Implement');
    };
    /**
     * 调用方法
     */
    CommandHandler.prototype.invoke = function (serviceInstance, method, args, context) {
        this.setContextToServiceInstance(serviceInstance, context);
        var parsedArgs = this.parseService.parse(args, context);
        return serviceInstance[method].apply(serviceInstance, tslib_1.__spread(parsedArgs));
    };
    /**
     * 为服务设置命令上下文
     * @todo
     * 通过这种方式存在很大问题：
     * 1、会覆盖掉已有的context，给开发人员造成困扰和调试成本；
     * 2、服务中依赖了一个没有声明的对象，不符合面向对象的原则。
     * 建议解决方案：
     * 1、将context修改为某个特殊属性名；
     * 2、先检测服务上有没有一个CommandContext类型的context属性，有的话再赋值，
     *    这就要求需要使用context的服务需要是实现一个IContext接口。
     */
    CommandHandler.prototype.setContextToServiceInstance = function (serviceInstance, context) {
        // 如果服务上已经存在context属性，并且该属性不是CommandContext类型，则不能覆盖
        var serviceContext = serviceInstance.context;
        if (serviceContext && (serviceContext instanceof CommandContext === false)) {
            return;
        }
        serviceInstance.context = context;
    };
    return CommandHandler;
}());
/**
 * 命令处理器注入Token
 */
var COMMAND_HANDLERS_TOKEN = createInjectionToken('@Farris/devkit COMMAND_HANDLERS_TOKEN');
export { CommandHandler, COMMAND_HANDLERS_TOKEN };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9tb2JpbGUtZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2NvbW1hbmQvY29tbWFuZF9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFXLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZGLE9BQU8sRUFBRSxvQkFBb0IsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUUvRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUd6RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFZLFFBQVEsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUdsRDs7R0FFRztBQUNIO0lBaUJFOztPQUVHO0lBQ0g7SUFDQSxDQUFDO0lBT0Q7O09BRUc7SUFDSSw2QkFBSSxHQUFYLFVBQVksZ0JBQWtDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUN6QyxJQUFJLENBQUMsWUFBWSxHQUFHLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUN4RSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksUUFBUSxFQUFFLENBQUM7UUFFL0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2xCLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNJLGdDQUFPLEdBQWQsVUFBZSxPQUFnQjtRQUEvQixpQkF5RUM7UUF4RUMsSUFBTSxlQUFlLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN0QyxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXZD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QUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDMUQsT0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLE9BQXZCLGVBQWUsbUJBQVksVUFBVSxHQUFFO0lBQ2hELENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0ssb0RBQTJCLEdBQW5DLFVBQW9DLGVBQW9CLEVBQUUsT0FBdUI7UUFFL0UsbURBQW1EO1FBQ25ELElBQU0sY0FBYyxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUM7UUFDL0MsSUFBSSxjQUFjLElBQUksQ0FBQyxjQUFjLFlBQVksY0FBYyxLQUFLLEtBQUssQ0FBQyxFQUFFO1lBQzFFLE9BQU87U0FDUjtRQUVELGVBQWUsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3BDLENBQUM7SUFDSCxxQkFBQztBQUFELENBQUMsQUFoTkQsSUFnTkM7QUFFRDs7R0FFRztBQUNILElBQU0sc0JBQXNCLEdBQUcsb0JBQW9CLENBQUMsdUNBQXVDLENBQUMsQ0FBQztBQUU3RixPQUFPLEVBQUUsY0FBYyxFQUFFLHNCQUFzQixFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY29uY2F0TWFwLCBtYXAsIHRha2VMYXN0LCB0YWtlLCB0aW1lb3V0LCB0aHJvd0lmRW1wdHkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBjcmVhdGVJbmplY3Rpb25Ub2tlbiwgSW5qZWN0b3IgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcclxuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4uL3ZpZXctbW9kZWwvaW5kZXgnO1xyXG5pbXBvcnQgeyBWYXJpYWJsZVBhcnNlU2VydmljZSB9IGZyb20gJy4uL3ZhcmlhYmxlL2luZGV4JztcclxuXHJcbmltcG9ydCB7IENvbW1hbmQsIENvbW1hbmRQYXJhbXMsIFBhcmFtRGVzY3JpcHRpb25zIH0gZnJvbSAnLi9jb21tYW5kJztcclxuaW1wb3J0IHsgQ29tbWFuZENvbnRleHQgfSBmcm9tICcuL2NvbW1hbmRfY29udGV4dCc7XHJcbmltcG9ydCB7IFRhc2tGdW5jLCBUYXNrRmxvdyB9IGZyb20gJy4vZmxvdy9pbmRleCc7XHJcblxyXG5cclxuLyoqXHJcbiAqIOWRveS7pOWkhOeQhuaKveixoeexu++8jOaJgOacieWFt+S9k+eahOWRveS7pOWkhOeQhuexu+W/hemhu+e7p+aJv+Wug++8jOW5tuWunueOsHNjaGVkdWxl5pa55rOV44CCXHJcbiAqL1xyXG5hYnN0cmFjdCBjbGFzcyBDb21tYW5kSGFuZGxlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOS7u+WKoea1geeoi+WbvlxyXG4gICAqL1xyXG4gIHByaXZhdGUgdGFza0Zsb3c6IFRhc2tGbG93O1xyXG5cclxuICAvKipcclxuICAgKiDkuIrkuIvmlodcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgdmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog5Y+Y6YeP6Kej5p6Q5pyN5YqhXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHBhcnNlU2VydmljZTogVmFyaWFibGVQYXJzZVNlcnZpY2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5omn6KGM5rWB56iLXHJcbiAgICovXHJcbiAgYWJzdHJhY3Qgc2NoZWR1bGUoKTtcclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgcHVibGljIGluaXQodmlld01vZGVsQ29udGV4dDogVmlld01vZGVsQ29udGV4dCkge1xyXG4gICAgdGhpcy52aWV3TW9kZWxDb250ZXh0ID0gdmlld01vZGVsQ29udGV4dDtcclxuICAgIHRoaXMucGFyc2VTZXJ2aWNlID0gdmlld01vZGVsQ29udGV4dC5pbmplY3Rvci5nZXQoVmFyaWFibGVQYXJzZVNlcnZpY2UpO1xyXG4gICAgdGhpcy50YXNrRmxvdyA9IG5ldyBUYXNrRmxvdygpO1xyXG5cclxuICAgIHRoaXMuc2NoZWR1bGUoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJp+ihjOS7u+WKoVxyXG4gICAqIEBwYXJhbSBjb21tYW5kIOimgeaJp+ihjOeahOWRveS7pFxyXG4gICAqIEByZXR1cm4g5pyA5ZCO5LiA5Liq5Lu75Yqh55qE5omn6KGM57uT5p6cXHJcbiAgICogQHRvZG/vvJrmjInlip/og73mi4bliIblsI/lh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgZXhlY3V0ZShjb21tYW5kOiBDb21tYW5kKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGxhc3RUYXNrUmVzdWx0JCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICBjb25zdCB0YXNrRmxvdyA9IHRoaXMudGFza0Zsb3cuY2xvbmUoKTtcclxuXHJcbiAgICAvLyBzZXRUaW1lb3V05pqC5pe25LiN6IO95Y675o6J55qE5Y6f5Zug77yaXHJcbiAgICAvLyAx44CB5qCR6KGo5Y2V5Yqg6L295pWw5o2u77yM5L6d6LWWVHJlZVRhYmxlQmluZGluZ+mHjOiuvue9rueahOWFqOWxgOWPmOmHj++8jOmcgOimgeW7tuWQjuaJp+ihjOWKoOi9veaXtuacuu+8m1xyXG4gICAgLy8gMuOAgeWFs+mXreWJjeWRveS7pOmcgOimgeW7tui/n+aJp+ihjOOAglxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcblxyXG4gICAgICAvLyAx44CB6Kej5p6Q5Y+C5pWwXHJcbiAgICAgIC8vIOmBv+WFjeino+aekOWPmOmHj+aXtuS/ruaUueS6huWOn+Wni+eahGNvbW1hbmRcclxuICAgICAgY29uc3QgeyBldmVudFBhcmFtID0gbnVsbCB9ID0ge1xyXG4gICAgICAgIC4uLmNvbW1hbmRcclxuICAgICAgfTtcclxuICAgICAgZGVsZXRlIGNvbW1hbmQuZXZlbnRQYXJhbTtcclxuICAgICAgY29uc3QgY29tbWFuZFRvRXhlY3V0ZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY29tbWFuZCkpO1xyXG4gICAgICBjb21tYW5kVG9FeGVjdXRlLnBhcmFtcyA9IHRoaXMucGFyc2VTZXJ2aWNlLnBhcnNlKGNvbW1hbmRUb0V4ZWN1dGUucGFyYW1zLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpO1xyXG4gICAgICBjb21tYW5kLmV2ZW50UGFyYW0gPSBldmVudFBhcmFtO1xyXG4gICAgICBjb21tYW5kVG9FeGVjdXRlLmV2ZW50UGFyYW0gPSBldmVudFBhcmFtO1xyXG5cclxuICAgICAgLy8gMuOAgeS4suiBlOS7u+WKoea1gVxyXG4gICAgICBjb25zdCBpbml0Q29udGV4dCA9IG5ldyBDb21tYW5kQ29udGV4dChjb21tYW5kVG9FeGVjdXRlLCB0aGlzLnZpZXdNb2RlbENvbnRleHQpO1xyXG4gICAgICBpbml0Q29udGV4dC5ldmVudFBhcmFtcyA9IGNvbW1hbmQuZXZlbnRQYXJhbSB8fCBudWxsO1xyXG4gICAgICBjb25zdCBjb250ZXh0JCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q29tbWFuZENvbnRleHQ+KGluaXRDb250ZXh0KTtcclxuICAgICAgbGV0IGN1cnJlbnRUYXNrID0gdGFza0Zsb3cuZ2V0TmV4dCgnJywgaW5pdENvbnRleHQpO1xyXG4gICAgICBjb25zdCBoaWdoT3JkZXIkID0gY29udGV4dCQucGlwZShcclxuICAgICAgICBjb25jYXRNYXAoKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICBjb25zdCByZXN1bHQkID0gY3VycmVudFRhc2suZXhlY3V0ZShjb250ZXh0KTtcclxuICAgICAgICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgICAgICAgIHRha2UoMSksXHJcbiAgICAgICAgICAgIG1hcCgocmVzdWx0OiBhbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgLy8g5YaZ5YWl5omn6KGM57uT5p6cXHJcbiAgICAgICAgICAgICAgY29udGV4dC5yZXN1bHRzW2N1cnJlbnRUYXNrLm5hbWVdID0gcmVzdWx0O1xyXG4gICAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0UmVzdWx0ID0gcmVzdWx0O1xyXG4gICAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gdGFza0Zsb3cuZ2V0TmV4dChjdXJyZW50VGFzay5uYW1lLCBjb250ZXh0KTtcclxuXHJcbiAgICAgICAgICAgICAgLy8g5pON5L2c5o6n5Yi25rWBXHJcbiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrKSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0JC5uZXh0KGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgLy8g5bCG57uT5p6c5rWB6L2s5o2i5Li6Y29udGV4dOa1gVxyXG4gICAgICAgICAgICAgIHJldHVybiBjb250ZXh0O1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgdGhyb3dJZkVtcHR5KCgpID0+IHtcclxuICAgICAgICAgICAgICBjb250ZXh0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gM+OAgeaJp+ihjOWQiOW5tuWQjueahOS7u+WKoea1gVxyXG4gICAgICBoaWdoT3JkZXIkLnBpcGUoXHJcbiAgICAgICAgdGFrZUxhc3QoMSlcclxuICAgICAgKS5zdWJzY3JpYmUoe1xyXG4gICAgICAgIG5leHQ6IChjb250ZXh0OiBDb21tYW5kQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgbGFzdFRhc2tSZXN1bHQkLm5leHQoY29udGV4dC5sYXRlc3RSZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyb3I6IChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmRpc3BsYXlFcnJvcihlcnJvcik7XHJcbiAgICAgICAgICBsYXN0VGFza1Jlc3VsdCQuZXJyb3IoZXJyb3IpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY29tcGxldGU6ICgpID0+IHtcclxuICAgICAgICAgIGxhc3RUYXNrUmVzdWx0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG5cclxuICAgIH0sIDApO1xyXG5cclxuICAgIHJldHVybiBsYXN0VGFza1Jlc3VsdCQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmmL7npLrplJnor6/kv6Hmga9cclxuICAgKi9cclxuICBwcml2YXRlIGRpc3BsYXlFcnJvcihlcnJvcjogYW55KSB7XHJcbiAgICBpZiAoIWVycm9yKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGlmICghY29uc29sZSB8fCAhY29uc29sZS5lcnJvcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOS7u+WKoe+8jOWPquacieWtkOexu+WPr+S7pea3u+WKoOS7u+WKoe+8jOWklumDqOS4jeiDveiuv+mXrlxyXG4gICAqIEBwYXJhbSBuYW1lICDku7vliqHlkI3np7BcclxuICAgKiBAcGFyYW0gZnVuYyDku7vliqHlh73mlbBcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYWRkVGFzayhuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XHJcbiAgICB0aGlzLnRhc2tGbG93LmFkZE5vZGUobmFtZSwgZnVuYyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDku7vliqHvvIzlj6rmnInlrZDnsbvlj6/ku6Xmt7vliqDku7vliqHvvIzlpJbpg6jkuI3og73orr/pl65cclxuICAgKiBAcGFyYW0gbmFtZSAg5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtIGZ1bmMg5Lu75Yqh5Ye95pWwXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGFkZExpbmsoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBjb25kaXRpb246IHN0cmluZyB8IGJvb2xlYW4pIHtcclxuICAgIHRoaXMudGFza0Zsb3cuYWRkTGluayhmcm9tLCB0bywgY29uZGl0aW9uKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaPkuWFpeS7u+WKoVxyXG4gICAqIEBwYXJhbSAgbmFtZSDopoHmianlsZXnmoTku7vliqHlkI3np7BcclxuICAgKiBAcGFyYW0gIGZ1bmMg5omp5bGV5Ye95pWwXHJcbiAgICovXHJcbiAgcHVibGljIGluc2VydFRhc2sodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmj5LlhaXku7vliqFcclxuICAgKiBAcGFyYW0gIG5hbWUg6KaB5omp5bGV55qE5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtICBmdW5jIOaJqeWxleWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZnRlclRhc2sodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmm7/mjaLku7vliqFcclxuICAgKiBAcGFyYW0gIG5hbWUg6KaB5pu/5o2i55qE5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtICBmdW5jIOabv+aNouWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXBsYWNlVGFzayhuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnQnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiwg+eUqOaWueazlVxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbnZva2Uoc2VydmljZUluc3RhbmNlOiBhbnksIG1ldGhvZDogc3RyaW5nLCBhcmdzOiBhbnlbXSwgY29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuICAgIHRoaXMuc2V0Q29udGV4dFRvU2VydmljZUluc3RhbmNlKHNlcnZpY2VJbnN0YW5jZSwgY29udGV4dCk7XHJcbiAgICBjb25zdCBwYXJzZWRBcmdzID0gdGhpcy5wYXJzZVNlcnZpY2UucGFyc2UoYXJncywgY29udGV4dCk7XHJcbiAgICByZXR1cm4gc2VydmljZUluc3RhbmNlW21ldGhvZF0oLi4ucGFyc2VkQXJncyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuLrmnI3liqHorr7nva7lkb3ku6TkuIrkuIvmlodcclxuICAgKiBAdG9kb1xyXG4gICAqIOmAmui/h+i/meenjeaWueW8j+WtmOWcqOW+iOWkp+mXrumimO+8mlxyXG4gICAqIDHjgIHkvJropobnm5bmjonlt7LmnInnmoRjb250ZXh077yM57uZ5byA5Y+R5Lq65ZGY6YCg5oiQ5Zuw5omw5ZKM6LCD6K+V5oiQ5pys77ybXHJcbiAgICogMuOAgeacjeWKoeS4reS+nei1luS6huS4gOS4quayoeacieWjsOaYjueahOWvueixoe+8jOS4jeespuWQiOmdouWQkeWvueixoeeahOWOn+WImeOAglxyXG4gICAqIOW7uuiuruino+WGs+aWueahiO+8mlxyXG4gICAqIDHjgIHlsIZjb250ZXh05L+u5pS55Li65p+Q5Liq54m55q6K5bGe5oCn5ZCN77ybXHJcbiAgICogMuOAgeWFiOajgOa1i+acjeWKoeS4iuacieayoeacieS4gOS4qkNvbW1hbmRDb250ZXh057G75Z6L55qEY29udGV4dOWxnuaAp++8jOacieeahOivneWGjei1i+WAvO+8jFxyXG4gICAqICAgIOi/meWwseimgeaxgumcgOimgeS9v+eUqGNvbnRleHTnmoTmnI3liqHpnIDopoHmmK/lrp7njrDkuIDkuKpJQ29udGV4dOaOpeWPo+OAglxyXG4gICAqL1xyXG4gIHByaXZhdGUgc2V0Q29udGV4dFRvU2VydmljZUluc3RhbmNlKHNlcnZpY2VJbnN0YW5jZTogYW55LCBjb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xyXG5cclxuICAgIC8vIOWmguaenOacjeWKoeS4iuW3sue7j+WtmOWcqGNvbnRleHTlsZ7mgKfvvIzlubbkuJTor6XlsZ7mgKfkuI3mmK9Db21tYW5kQ29udGV4dOexu+Wei++8jOWImeS4jeiDveimhuebllxyXG4gICAgY29uc3Qgc2VydmljZUNvbnRleHQgPSBzZXJ2aWNlSW5zdGFuY2UuY29udGV4dDtcclxuICAgIGlmIChzZXJ2aWNlQ29udGV4dCAmJiAoc2VydmljZUNvbnRleHQgaW5zdGFuY2VvZiBDb21tYW5kQ29udGV4dCA9PT0gZmFsc2UpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBzZXJ2aWNlSW5zdGFuY2UuY29udGV4dCA9IGNvbnRleHQ7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5ZG95Luk5aSE55CG5Zmo5rOo5YWlVG9rZW5cclxuICovXHJcbmNvbnN0IENPTU1BTkRfSEFORExFUlNfVE9LRU4gPSBjcmVhdGVJbmplY3Rpb25Ub2tlbignQEZhcnJpcy9kZXZraXQgQ09NTUFORF9IQU5ETEVSU19UT0tFTicpO1xyXG5cclxuZXhwb3J0IHsgQ29tbWFuZEhhbmRsZXIsIENPTU1BTkRfSEFORExFUlNfVE9LRU4gfTtcclxuIl19