import { Injectable, Injector } from "@angular/core";
import { ExpressionRegistry } from "./expression_registry";
import { ExpressionEventEmitter } from "./expression_event_emitter";
import { Expression } from './types';
import { ResolverRegistry, ResolveService } from "../resolver/index";
import { EventHandlerRegistry } from "../event-handler/index";
import { Core } from "../core/index";
export class ExpressionEngineImpl {
    constructor(injector, expressionRegistry, expressionEventEmitter, resolverRegistry, eventHandlerRegistry, resolveService) {
        this.injector = injector;
        this.expressionRegistry = expressionRegistry;
        this.expressionEventEmitter = expressionEventEmitter;
        this.resolverRegistry = resolverRegistry;
        this.eventHandlerRegistry = eventHandlerRegistry;
        this.resolveService = resolveService;
        this.expressionObjects = new Array();
        this.expressionRegistry.expressions.subscribe((exprs) => {
            if (exprs && exprs.length > 0) {
                this.expressionObjects = exprs;
                // 解析表达式依赖
                this.resolveDependency();
            }
            this.attachEvent();
        });
    }
    attachEvent() {
        this.expressionEventEmitter.attach().subscribe((events) => {
            if (!events || events.length < 1 || !this.expressionObjects || this.expressionObjects.length < 1) {
                return;
            }
            events.forEach((event) => {
                const handler = this.getEventHandler(event);
                if (handler) {
                    handler.handleEvent(event, this.expressionObjects);
                }
                else {
                    Core.warn(`没有对应的事件处理器,event=${event.type}`);
                }
            });
        });
    }
    /**
     * 解析表达式依赖
     * @returns
     */
    resolveDependency() {
        if (!this.resolverRegistry || !this.resolverRegistry.resolvers || this.resolverRegistry.resolvers.length < 1 || !this.expressionObjects || this.expressionObjects.length < 1 || !Array.isArray(this.expressionObjects)) {
            return;
        }
        this.expressionObjects.forEach((expressionObject) => {
            const expression = expressionObject.expression;
            const dependencies = this.resolveService.resolve(expression);
            expressionObject.deps = dependencies;
        });
    }
    /**
     * 获取表达式事件处理器
     * @param event event
     * @returns
     */
    getEventHandler(event) {
        if (event.type === Expression.EventType.ValueChanged) {
            // 实体值变化
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataValueChangeEventHandler;
            }
            else if (event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.entityValueChangedEventHandler;
            }
            else if (event.source === Expression.EventSource.State) {
                return this.eventHandlerRegistry.stateValueChangedEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Append) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryAddEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataAppendEntityEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Remove) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryRemoveEntityEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataRemoveObjectEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Update) {
            if (event.source === Expression.EventSource.Repository) {
                return this.eventHandlerRegistry.entityUpdateEventHandler;
            }
        }
        else if (event.type === Expression.EventType.Load) {
            if (event.source === Expression.EventSource.Repository || event.source === Expression.EventSource.Field) {
                return this.eventHandlerRegistry.repositoryLoadEventHandler;
            }
            else if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataLoadEventHandler;
            }
        }
        else if (event.type === Expression.EventType.SelectionChanged) {
            if (event.source === Expression.EventSource.BindingData) {
                return this.eventHandlerRegistry.bindingDataSelectionChangedHandler;
            }
        }
        return null;
    }
}
ExpressionEngineImpl.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ExpressionEngineImpl.ctorParameters = () => [
    { type: Injector },
    { type: ExpressionRegistry },
    { type: ExpressionEventEmitter },
    { type: ResolverRegistry },
    { type: EventHandlerRegistry },
    { type: ResolveService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbl9lbmdpbmVfaW1wbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2V4cHJlc3Npb24vZXhwcmVzc2lvbl9lbmdpbmVfaW1wbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMzRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNyRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3JDLE1BQU0sT0FBTyxvQkFBb0I7SUFFL0IsWUFDVSxRQUFrQixFQUNsQixrQkFBc0MsRUFDdEMsc0JBQThDLEVBQzlDLGdCQUFrQyxFQUNsQyxvQkFBMEMsRUFDMUMsY0FBOEI7UUFMOUIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQVBoQyxzQkFBaUIsR0FBdUMsSUFBSSxLQUFLLEVBQStCLENBQUM7UUFTdkcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxLQUFvQyxFQUFFLEVBQUU7WUFDckYsSUFBSSxLQUFLLElBQUks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QUssVUFBVSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3ZHLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLDBCQUEwQixDQUFDO2FBQzdEO2lCQUFNLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxVQUFVLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRTtnQkFDOUQsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsMkJBQTJCLENBQUM7YUFDOUQ7U0FDRjthQUFNLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxVQUFVLENBQUMsU0FBUyxDQUFDLGdCQUFnQixFQUFFO1lBQy9ELElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxVQUFVLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRTtnQkFDdkQsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsa0NBQWtDLENBQUM7YUFDckU7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7O1lBN0ZGLFVBQVU7Ozs7WUFSVSxRQUFRO1lBQ3BCLGtCQUFrQjtZQUNsQixzQkFBc0I7WUFFdEIsZ0JBQWdCO1lBQ2hCLG9CQUFvQjtZQURGLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XHJcbmltcG9ydCB7IEV4cHJlc3Npb25SZWdpc3RyeSB9IGZyb20gXCIuL2V4cHJlc3Npb25fcmVnaXN0cnlcIjtcclxuaW1wb3J0IHsgRXhwcmVzc2lvbkV2ZW50RW1pdHRlciB9IGZyb20gXCIuL2V4cHJlc3Npb25fZXZlbnRfZW1pdHRlclwiO1xyXG5pbXBvcnQgeyBFeHByZXNzaW9uIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IFJlc29sdmVyUmVnaXN0cnksIFJlc29sdmVTZXJ2aWNlIH0gZnJvbSBcIi4uL3Jlc29sdmVyL2luZGV4XCI7XHJcbmltcG9ydCB7IEV2ZW50SGFuZGxlclJlZ2lzdHJ5IH0gZnJvbSBcIi4uL2V2ZW50LWhhbmRsZXIvaW5kZXhcIjtcclxuaW1wb3J0IHsgQ29yZSB9IGZyb20gXCIuLi9jb3JlL2luZGV4XCI7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBFeHByZXNzaW9uRW5naW5lSW1wbCB7XHJcbiAgcHJpdmF0ZSBleHByZXNzaW9uT2JqZWN0czogQXJyYXk8RXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0PiA9IG5ldyBBcnJheTxFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3Q+KCk7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIHByaXZhdGUgZXhwcmVzc2lvblJlZ2lzdHJ5OiBFeHByZXNzaW9uUmVnaXN0cnksXHJcbiAgICBwcml2YXRlIGV4cHJlc3Npb25FdmVudEVtaXR0ZXI6IEV4cHJlc3Npb25FdmVudEVtaXR0ZXIsXHJcbiAgICBwcml2YXRlIHJlc29sdmVyUmVnaXN0cnk6IFJlc29sdmVyUmVnaXN0cnksXHJcbiAgICBwcml2YXRlIGV2ZW50SGFuZGxlclJlZ2lzdHJ5OiBFdmVudEhhbmRsZXJSZWdpc3RyeSxcclxuICAgIHByaXZhdGUgcmVzb2x2ZVNlcnZpY2U6IFJlc29sdmVTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICB0aGlzLmV4cHJlc3Npb25SZWdpc3RyeS5leHByZXNzaW9ucy5zdWJzY3JpYmUoKGV4cHJzOiBFeHByZXNzaW9uLkV4cHJlc3Npb25PYmplY3RbXSkgPT4ge1xyXG4gICAgICBpZiAoZXhwcnMgJiYgZXhwcnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMgPSBleHBycztcclxuICAgICAgICAvLyDop6PmnpDooajovr7lvI/kvp3otZZcclxuICAgICAgICB0aGlzLnJlc29sdmVEZXBlbmRlbmN5KCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5hdHRhY2hFdmVudCgpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGF0dGFjaEV2ZW50KCkge1xyXG4gICAgdGhpcy5leHByZXNzaW9uRXZlbnRFbWl0dGVyLmF0dGFjaCgpLnN1YnNjcmliZSgoZXZlbnRzOiBFeHByZXNzaW9uLkV2ZW50QXJnc1tdKSA9PiB7XHJcbiAgICAgIGlmICghZXZlbnRzIHx8IGV2ZW50cy5sZW5ndGggPCAxIHx8ICF0aGlzLmV4cHJlc3Npb25PYmplY3RzIHx8IHRoaXMuZXhwcmVzc2lvbk9iamVjdHMubGVuZ3RoIDwgMSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBldmVudHMuZm9yRWFjaCgoZXZlbnQ6IEV4cHJlc3Npb24uRXZlbnRBcmdzKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaGFuZGxlciA9IHRoaXMuZ2V0RXZlbnRIYW5kbGVyKGV2ZW50KTtcclxuICAgICAgICBpZiAoaGFuZGxlcikge1xyXG4gICAgICAgICAgaGFuZGxlci5oYW5kbGVFdmVudChldmVudCwgdGhpcy5leHByZXNzaW9uT2JqZWN0cyk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIENvcmUud2Fybihg5rKh5pyJ5a+55bqU55qE5LqL5Lu25aSE55CG5ZmoLGV2ZW50PSR7ZXZlbnQudHlwZX1gKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOino+aekOihqOi+vuW8j+S+nei1llxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgcmVzb2x2ZURlcGVuZGVuY3koKSB7XHJcbiAgICBpZiAoIXRoaXMucmVzb2x2ZXJSZWdpc3RyeSB8fCAhdGhpcy5yZXNvbHZlclJlZ2lzdHJ5LnJlc29sdmVycyB8fCB0aGlzLnJlc29sdmVyUmVnaXN0cnkucmVzb2x2ZXJzLmxlbmd0aCA8IDEgfHwgIXRoaXMuZXhwcmVzc2lvbk9iamVjdHMgfHwgdGhpcy5leHByZXNzaW9uT2JqZWN0cy5sZW5ndGggPCAxIHx8ICFBcnJheS5pc0FycmF5KHRoaXMuZXhwcmVzc2lvbk9iamVjdHMpKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIHRoaXMuZXhwcmVzc2lvbk9iamVjdHMuZm9yRWFjaCgoZXhwcmVzc2lvbk9iamVjdDogRXhwcmVzc2lvbi5FeHByZXNzaW9uT2JqZWN0KSA9PiB7XHJcbiAgICAgIGNvbnN0IGV4cHJlc3Npb24gPSBleHByZXNzaW9uT2JqZWN0LmV4cHJlc3Npb247XHJcbiAgICAgIGNvbnN0IGRlcGVuZGVuY2llcyA9IHRoaXMucmVzb2x2ZVNlcnZpY2UucmVzb2x2ZShleHByZXNzaW9uKTtcclxuICAgICAgZXhwcmVzc2lvbk9iamVjdC5kZXBzID0gZGVwZW5kZW5jaWVzO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluihqOi+vuW8j+S6i+S7tuWkhOeQhuWZqFxyXG4gICAqIEBwYXJhbSBldmVudCBldmVudFxyXG4gICAqIEByZXR1cm5zIFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RXZlbnRIYW5kbGVyKGV2ZW50OiBFeHByZXNzaW9uLkV2ZW50QXJncyk6IEV4cHJlc3Npb24uSUV2ZW50SGFuZGxlciB7XHJcbiAgICBpZiAoZXZlbnQudHlwZSA9PT0gRXhwcmVzc2lvbi5FdmVudFR5cGUuVmFsdWVDaGFuZ2VkKSB7XHJcbiAgICAgIC8vIOWunuS9k+WAvOWPmOWMllxyXG4gICAgICBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkJpbmRpbmdEYXRhKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuYmluZGluZ0RhdGFWYWx1ZUNoYW5nZUV2ZW50SGFuZGxlcjtcclxuICAgICAgfSBlbHNlIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuRmllbGQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5lbnRpdHlWYWx1ZUNoYW5nZWRFdmVudEhhbmRsZXI7XHJcbiAgICAgIH0gZWxzZSBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLlN0YXRlKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuc3RhdGVWYWx1ZUNoYW5nZWRFdmVudEhhbmRsZXI7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoZXZlbnQudHlwZSA9PT0gRXhwcmVzc2lvbi5FdmVudFR5cGUuQXBwZW5kKSB7XHJcbiAgICAgIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuUmVwb3NpdG9yeSB8fCBldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuRmllbGQpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5yZXBvc2l0b3J5QWRkRW50aXR5RXZlbnRIYW5kbGVyO1xyXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5CaW5kaW5nRGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmJpbmRpbmdEYXRhQXBwZW5kRW50aXR5RXZlbnRIYW5kbGVyO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09IEV4cHJlc3Npb24uRXZlbnRUeXBlLlJlbW92ZSkge1xyXG4gICAgICBpZiAoZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLlJlcG9zaXRvcnkgfHwgZXZlbnQuc291cmNlID09PSBFeHByZXNzaW9uLkV2ZW50U291cmNlLkZpZWxkKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkucmVwb3NpdG9yeVJlbW92ZUVudGl0eUV2ZW50SGFuZGxlcjtcclxuICAgICAgfSBlbHNlIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuQmluZGluZ0RhdGEpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5iaW5kaW5nRGF0YVJlbW92ZU9iamVjdEV2ZW50SGFuZGxlcjtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChldmVudC50eXBlID09PSBFeHByZXNzaW9uLkV2ZW50VHlwZS5VcGRhdGUpIHtcclxuICAgICAgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5SZXBvc2l0b3J5KSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRIYW5kbGVyUmVnaXN0cnkuZW50aXR5VXBkYXRlRXZlbnRIYW5kbGVyO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKGV2ZW50LnR5cGUgPT09IEV4cHJlc3Npb24uRXZlbnRUeXBlLkxvYWQpIHtcclxuICAgICAgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5SZXBvc2l0b3J5IHx8IGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5GaWVsZCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LnJlcG9zaXRvcnlMb2FkRXZlbnRIYW5kbGVyO1xyXG4gICAgICB9IGVsc2UgaWYgKGV2ZW50LnNvdXJjZSA9PT0gRXhwcmVzc2lvbi5FdmVudFNvdXJjZS5CaW5kaW5nRGF0YSkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmV2ZW50SGFuZGxlclJlZ2lzdHJ5LmJpbmRpbmdEYXRhTG9hZEV2ZW50SGFuZGxlcjtcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChldmVudC50eXBlID09PSBFeHByZXNzaW9uLkV2ZW50VHlwZS5TZWxlY3Rpb25DaGFuZ2VkKSB7XHJcbiAgICAgIGlmIChldmVudC5zb3VyY2UgPT09IEV4cHJlc3Npb24uRXZlbnRTb3VyY2UuQmluZGluZ0RhdGEpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5ldmVudEhhbmRsZXJSZWdpc3RyeS5iaW5kaW5nRGF0YVNlbGVjdGlvbkNoYW5nZWRIYW5kbGVyO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbnVsbDtcclxuICB9XHJcbiAgXHJcbn0iXX0=