import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext, NAMESPACE } from '../frame/index';
import { Repository } from '../repository/index';
import { ExpressionUtil } from '../utils/expression_util';
export class VisibleEffector {
    constructor(injector, namespace, frameContext, repository) {
        this.injector = injector;
        this.namespace = namespace;
        this.frameContext = frameContext;
        this.repository = repository;
        this.ns = namespace;
    }
    effect(path, value, options) {
        // 由匿名函数接管，ignore
        const paths = path.split('/').filter(p => p);
        const bindingPaths = this.getTablePaths(paths);
        const bindingPath = bindingPaths.join('/');
        // 主表显隐无需处理
        if (bindingPaths && bindingPaths.length > 0) {
            const isGridComponent = this.isGridComponent(bindingPath);
            if (isGridComponent) {
                const datagridComponent = this.getDatagridComponent(bindingPath);
                if (datagridComponent) {
                    // 更新列信息
                    // datagridComponent.columnsChanged();
                    const fieldPaths = this.getPropertyPaths(paths);
                    if (fieldPaths) {
                        const field = fieldPaths.join('.');
                        if (value) {
                            datagridComponent.showColumn(field);
                        }
                        else {
                            datagridComponent.hideColumn(field);
                        }
                    }
                }
            }
        }
        else {
            const datagridComponent = this.getDatagridComponent(bindingPath);
            if (datagridComponent) {
                datagridComponent.columnsChanged(false);
            }
        }
    }
    getTablePaths(paths) {
        const entityPaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return entityPaths;
    }
    getDatagridComponent(bindingPath) {
        const frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || [];
        const matchedFrameContexts = frameContexts.filter((frameContext) => frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(p => p).toString() === bindingPath.split('/').filter(p => p).toString());
        let result = null;
        if (matchedFrameContexts) {
            matchedFrameContexts.every((frameContext) => {
                const frameId = frameContext.frameId;
                const componentsMap = this.frameContext.appContext.componentManager.getComponentsByFrameId(frameId);
                if (!componentsMap) {
                    return true;
                }
                const datagridComponent = Array.from(componentsMap.values()).find((component) => component && component['__component_type__'] === 'DatagridComponent');
                if (datagridComponent) {
                    result = datagridComponent;
                    return false;
                }
                else {
                    return true;
                }
            });
        }
        return result;
    }
    getPropertyPaths(paths) {
        const tablePaths = ExpressionUtil.getAvailableChildrenPathsFromEntityPaths(paths, this.repository.entityTypeInfo);
        return paths.slice(tablePaths.length);
    }
    isGridComponent(bindingPath) {
        const frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(this.namespace) || [];
        const frameContext = frameContexts.find((frameContext) => frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(p => p).toString() === bindingPath.split('/').filter(p => p).toString());
        if (frameContext) {
            return !!frameContext.viewModel['dataGridColumnsName'];
        }
        else {
            return false;
        }
    }
}
VisibleEffector.decorators = [
    { type: Injectable }
];
/** @nocollapse */
VisibleEffector.ctorParameters = () => [
    { type: Injector },
    { type: undefined, decorators: [{ type: Inject, args: [NAMESPACE,] }] },
    { type: FrameContext },
    { type: Repository }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlzaWJsZV9lZmZlY3Rvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VmZmVjdG9yL3Zpc2libGVfZWZmZWN0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTdELE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekQsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUcxRCxNQUFNLE9BQU8sZUFBZTtJQUUxQixZQUNVLFFBQWtCLEVBQ0MsU0FBUyxFQUM1QixZQUEwQixFQUMxQixVQUEyQjtRQUgzQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ0MsY0FBUyxHQUFULFNBQVMsQ0FBQTtRQUM1QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUNuQyxJQUFJLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQztJQUN0QixDQUFDO0lBQ00sTUFBTSxDQUFDLElBQVksRUFBRSxLQUFVLEVBQUUsT0FBaUM7UUFDdkUsaUJBQWlCO1FBQ2pCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0MsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQyxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzNDLFdBQVc7UUFDWCxJQUFJLFlBQVksSUFBSSxZQUFZLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZ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Z3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEV4cHJlc3Npb24gfSBmcm9tICcuLi9leHByZXNzaW9uL2luZGV4JztcclxuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBOQU1FU1BBQ0UgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IFJlcG9zaXRvcnkgfSBmcm9tICcuLi9yZXBvc2l0b3J5L2luZGV4JztcclxuaW1wb3J0IHsgRXhwcmVzc2lvblV0aWwgfSBmcm9tICcuLi91dGlscy9leHByZXNzaW9uX3V0aWwnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgVmlzaWJsZUVmZmVjdG9yIGltcGxlbWVudHMgRXhwcmVzc2lvbi5FZmZlY3RvciB7XHJcbiAgcHVibGljIG5zOiBzdHJpbmc7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgIEBJbmplY3QoTkFNRVNQQUNFKSBwcml2YXRlIG5hbWVzcGFjZSxcclxuICAgIHByaXZhdGUgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsXHJcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55Pikge1xyXG4gICAgdGhpcy5ucyA9IG5hbWVzcGFjZTtcclxuICB9XHJcbiAgcHVibGljIGVmZmVjdChwYXRoOiBzdHJpbmcsIHZhbHVlOiBhbnksIG9wdGlvbnM6IEV4cHJlc3Npb24uRWZmZWN0T3B0aW9ucykge1xyXG4gICAgLy8g55Sx5Yy/5ZCN5Ye95pWw5o6l566h77yMaWdub3JlXHJcbiAgICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcclxuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IHRoaXMuZ2V0VGFibGVQYXRocyhwYXRocyk7XHJcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRocy5qb2luKCcvJyk7XHJcbiAgICAvLyDkuLvooajmmL7pmpDml6DpnIDlpITnkIZcclxuICAgIGlmIChiaW5kaW5nUGF0aHMgJiYgYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY29uc3QgaXNHcmlkQ29tcG9uZW50ID0gdGhpcy5pc0dyaWRDb21wb25lbnQoYmluZGluZ1BhdGgpO1xyXG4gICAgICBpZiAoaXNHcmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgY29uc3QgZGF0YWdyaWRDb21wb25lbnQgPSB0aGlzLmdldERhdGFncmlkQ29tcG9uZW50KGJpbmRpbmdQYXRoKTtcclxuICAgICAgICBpZiAoZGF0YWdyaWRDb21wb25lbnQpIHtcclxuICAgICAgICAgIC8vIOabtOaWsOWIl+S/oeaBr1xyXG4gICAgICAgICAgLy8gZGF0YWdyaWRDb21wb25lbnQuY29sdW1uc0NoYW5nZWQoKTtcclxuICAgICAgICAgIGNvbnN0IGZpZWxkUGF0aHMgPSB0aGlzLmdldFByb3BlcnR5UGF0aHMocGF0aHMpO1xyXG4gICAgICAgICAgaWYgKGZpZWxkUGF0aHMpIHtcclxuICAgICAgICAgICAgY29uc3QgZmllbGQgPSBmaWVsZFBhdGhzLmpvaW4oJy4nKTtcclxuICAgICAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgZGF0YWdyaWRDb21wb25lbnQuc2hvd0NvbHVtbihmaWVsZCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgZGF0YWdyaWRDb21wb25lbnQuaGlkZUNvbHVtbihmaWVsZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGRhdGFncmlkQ29tcG9uZW50ID0gdGhpcy5nZXREYXRhZ3JpZENvbXBvbmVudChiaW5kaW5nUGF0aCk7XHJcbiAgICAgIGlmIChkYXRhZ3JpZENvbXBvbmVudCkge1xyXG4gICAgICAgIGRhdGFncmlkQ29tcG9uZW50LmNvbHVtbnNDaGFuZ2VkKGZhbHNlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBwcml2YXRlIGdldFRhYmxlUGF0aHMocGF0aHM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgY29uc3QgZW50aXR5UGF0aHMgPSBFeHByZXNzaW9uVXRpbC5nZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKHBhdGhzLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xyXG4gICAgcmV0dXJuIGVudGl0eVBhdGhzO1xyXG4gIH1cclxuICBwcml2YXRlIGdldERhdGFncmlkQ29tcG9uZW50KGJpbmRpbmdQYXRoOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dHM6IEZyYW1lQ29udGV4dFtdID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZSh0aGlzLm5hbWVzcGFjZSkgfHwgW107XHJcbiAgICBjb25zdCBtYXRjaGVkRnJhbWVDb250ZXh0cyA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSA9PT0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS50b1N0cmluZygpKTtcclxuICAgIGxldCByZXN1bHQgPSBudWxsO1xyXG4gICAgaWYgKG1hdGNoZWRGcmFtZUNvbnRleHRzKSB7XHJcbiAgICAgIG1hdGNoZWRGcmFtZUNvbnRleHRzLmV2ZXJ5KChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZyYW1lSWQgPSBmcmFtZUNvbnRleHQuZnJhbWVJZDtcclxuICAgICAgICBjb25zdCBjb21wb25lbnRzTWFwID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5jb21wb25lbnRNYW5hZ2VyLmdldENvbXBvbmVudHNCeUZyYW1lSWQoZnJhbWVJZCk7XHJcbiAgICAgICAgaWYgKCFjb21wb25lbnRzTWFwKSB7XHJcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGF0YWdyaWRDb21wb25lbnQgPSBBcnJheS5mcm9tKGNvbXBvbmVudHNNYXAudmFsdWVzKCkpLmZpbmQoKGNvbXBvbmVudDogYW55KSA9PiBjb21wb25lbnQgJiYgY29tcG9uZW50WydfX2NvbXBvbmVudF90eXBlX18nXSA9PT0gJ0RhdGFncmlkQ29tcG9uZW50Jyk7XHJcbiAgICAgICAgaWYgKGRhdGFncmlkQ29tcG9uZW50KSB7XHJcbiAgICAgICAgICByZXN1bHQgPSBkYXRhZ3JpZENvbXBvbmVudDtcclxuICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0UHJvcGVydHlQYXRocyhwYXRoczogc3RyaW5nW10pIHtcclxuICAgIGNvbnN0IHRhYmxlUGF0aHMgPSBFeHByZXNzaW9uVXRpbC5nZXRBdmFpbGFibGVDaGlsZHJlblBhdGhzRnJvbUVudGl0eVBhdGhzKHBhdGhzLCB0aGlzLnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8pO1xyXG4gICAgcmV0dXJuIHBhdGhzLnNsaWNlKHRhYmxlUGF0aHMubGVuZ3RoKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBpc0dyaWRDb21wb25lbnQoYmluZGluZ1BhdGg6IHN0cmluZykge1xyXG4gICAgY29uc3QgZnJhbWVDb250ZXh0czogRnJhbWVDb250ZXh0W10gPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0c0J5TmFtZXNwYWNlKHRoaXMubmFtZXNwYWNlKSB8fCBbXTtcclxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dHMuZmluZCgoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpID0+IGZyYW1lQ29udGV4dC52aWV3TW9kZWwgJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApLnRvU3RyaW5nKCkgPT09IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkudG9TdHJpbmcoKSk7XHJcbiAgICBpZiAoZnJhbWVDb250ZXh0KSB7XHJcbiAgICAgIHJldHVybiAhIWZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcbn0iXX0=