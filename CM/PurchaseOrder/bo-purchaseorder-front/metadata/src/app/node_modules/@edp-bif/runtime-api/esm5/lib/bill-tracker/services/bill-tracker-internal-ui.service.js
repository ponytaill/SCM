/**
 * @fileoverview added by tsickle
 * Generated from: lib/bill-tracker/services/bill-tracker-internal-ui.service.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ComponentFactoryResolver, Inject, Injectable, Injector, LOCALE_ID } from "@angular/core";
import { JointQueryMode, JointQueryParameterType } from "@edp-bif/common-api";
import { MessagerService } from "@farris/ui-messager";
import { BsModalService } from "@farris/ui-modal";
import { AppType, FrameworkService, LoadingService } from "@gsp-sys/rtf-common";
import { BillTrackerConstant } from "../config/bill-tracker-constant";
import { BillTrackerLocalePipe } from "../pipe/bill-tracker-locale.pipe";
import { BillTrackerDataInfoService } from "./bill-tracker-data-info.service";
import { BillTrackerDataService } from "./bill-tracker-data.service";
var BillTrackerInternalUiService = /** @class */ (function () {
    function BillTrackerInternalUiService(framework, messager, loading, localeId, dataService, dataInfoService, modalService, cfr, injector, localePipe) {
        this.framework = framework;
        this.messager = messager;
        this.loading = loading;
        this.dataService = dataService;
        this.dataInfoService = dataInfoService;
        this.modalService = modalService;
        this.cfr = cfr;
        this.injector = injector;
        this.localePipe = localePipe;
    }
    /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @return {?}
     */
    BillTrackerInternalUiService.prototype.openBillDetail = /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @return {?}
     */
    function (billInfo, billDataInfo) {
        var _this = this;
        /** @type {?} */
        var jointQueryMode = billInfo.jointQueryMode;
        /** @type {?} */
        var jointQueryParameters = JSON.parse(billInfo.jointQueryParameters);
        /** @type {?} */
        var id = billDataInfo.dataId;
        if (this.dataService.hasDynamicParams(jointQueryParameters)) {
            /** @type {?} */
            var args = this.dataService.buildGetJointQueryParametersArgs(jointQueryParameters, billInfo, billDataInfo);
            this.dataService.getJointQueryParameters(args).subscribe((/**
             * @param {?} results
             * @return {?}
             */
            function (results) {
                if (jointQueryMode == JointQueryMode.APP) {
                    _this.openMenu(jointQueryParameters, id, results);
                }
                else if (jointQueryMode == JointQueryMode.URL) {
                    _this.openUrl(jointQueryParameters, id, results);
                }
            }));
        }
        else {
            if (jointQueryMode == JointQueryMode.APP) {
                this.openMenu(jointQueryParameters, id);
            }
            else if (jointQueryMode == JointQueryMode.URL) {
                this.openUrl(jointQueryParameters, id);
            }
        }
    };
    /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @param {?} fieldsWithValue
     * @return {?}
     */
    BillTrackerInternalUiService.prototype.openBillDetailWithFields = /**
     * @param {?} billInfo
     * @param {?} billDataInfo
     * @param {?} fieldsWithValue
     * @return {?}
     */
    function (billInfo, billDataInfo, fieldsWithValue) {
        var _this = this;
        /** @type {?} */
        var id = billDataInfo.dataId;
        /** @type {?} */
        var jointQueryMode = billInfo.jointQueryMode;
        /** @type {?} */
        var jointQueryParameters = JSON.parse(billInfo.jointQueryParameters);
        if (this.dataService.hasDynamicParams(jointQueryParameters)) {
            /** @type {?} */
            var args = this.dataService.buildGetJointQueryParametersArgs(jointQueryParameters, billInfo, billDataInfo);
            this.dataService.getJointQueryParameters(args).subscribe((/**
             * @param {?} results
             * @return {?}
             */
            function (results) {
                if (jointQueryMode == JointQueryMode.APP) {
                    _this.openMenu(jointQueryParameters, id, results);
                }
                else if (jointQueryMode == JointQueryMode.URL) {
                    _this.openUrl(jointQueryParameters, id, results);
                }
            }));
        }
        else {
            if (jointQueryMode == JointQueryMode.APP) {
                this.openMenu(jointQueryParameters, id);
            }
            else if (jointQueryMode == JointQueryMode.URL) {
                this.openUrl(jointQueryParameters, id);
            }
        }
    };
    /**
     * 直接打开菜单
     * @param jointQueryParameters
     * @param id
     */
    /**
     * 直接打开菜单
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    BillTrackerInternalUiService.prototype.openMenu = /**
     * 直接打开菜单
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    function (jointQueryParameters, id, jqpr) {
        /** @type {?} */
        var entityParams = {};
        entityParams["id"] = id;
        entityParams["action"] = "LoadAndView1";
        /** @type {?} */
        var map = new Map();
        map.set("id", id);
        map.set("action", "LoadAndView1");
        this.buildOpenMenuParams(jointQueryParameters, map, entityParams, jqpr);
        /** @type {?} */
        var WEB_FORM_ROUTE_PARAMS = encodeURIComponent(JSON.stringify(entityParams));
        map.set("WEB_FORM_ROUTE_PARAMS", WEB_FORM_ROUTE_PARAMS);
        /** @type {?} */
        var opts = {
            appType: AppType.Menu,
            funcId: jointQueryParameters.funcId,
            appEntrance: null,
            appId: null,
            tabId: id,
            entityParams: entityParams,
            queryStringParams: map,
        };
        this.framework.openMenu(opts);
    };
    /**
     * 借助单据查看容器打开url
     * @param jointQueryParameters
     * @param id
     */
    /**
     * 借助单据查看容器打开url
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    BillTrackerInternalUiService.prototype.openUrl = /**
     * 借助单据查看容器打开url
     * @param {?} jointQueryParameters
     * @param {?} id
     * @param {?=} jqpr
     * @return {?}
     */
    function (jointQueryParameters, id, jqpr) {
        // console.log("open default container for url");
        var _this = this;
        // console.log("open default container for url");
        /** @type {?} */
        var url = this.appendQueryParam(jointQueryParameters.url, "id", id);
        // 添加自定义参数
        if (Array.isArray(jointQueryParameters.params)) {
            jointQueryParameters.params.forEach((/**
             * @param {?} p
             * @return {?}
             */
            function (p) {
                /** @type {?} */
                var value = p.value;
                if (p.type == JointQueryParameterType.Field || p.type == JointQueryParameterType.Expression) {
                    /** @type {?} */
                    var r = jqpr.find((/**
                     * @param {?} it
                     * @return {?}
                     */
                    function (it) { return it.code == p.code; }));
                    value = r && r.value;
                }
                url = _this.appendQueryParam(url, p.code, value);
            }));
        }
        else {
            // 兼容key-value格式params
            Object.keys(jointQueryParameters.params).forEach((/**
             * @param {?} k
             * @return {?}
             */
            function (k) {
                url = _this.appendQueryParam(url, k, jointQueryParameters.params[k]);
            }));
        }
        /** @type {?} */
        var entityParams = jointQueryParameters.params || {};
        entityParams["id"] = id;
        entityParams["url"] = url;
        entityParams["action"] = "LoadAndView1";
        /** @type {?} */
        var map = new Map();
        map.set("url", url);
        map.set("id", id);
        map.set("action", "LoadAndView1");
        this.buildOpenMenuParams(jointQueryParameters, map, undefined, jqpr);
        /** @type {?} */
        var opts = {
            appType: AppType.Menu,
            funcId: BillTrackerConstant.BILL_VIEWER_FUNC_ID,
            appEntrance: null,
            appId: null,
            tabId: id,
            entityParams: entityParams,
            queryStringParams: map,
        };
        this.framework.openMenu(opts);
    };
    /**
     * @param {?} jointQueryParameters
     * @param {?} map
     * @param {?=} entityParams
     * @param {?=} jqpr
     * @return {?}
     */
    BillTrackerInternalUiService.prototype.buildOpenMenuParams = /**
     * @param {?} jointQueryParameters
     * @param {?} map
     * @param {?=} entityParams
     * @param {?=} jqpr
     * @return {?}
     */
    function (jointQueryParameters, map, entityParams, jqpr) {
        if (entityParams === void 0) { entityParams = {}; }
        // 添加自定义参数
        if (Array.isArray(jointQueryParameters.params)) {
            jointQueryParameters.params.forEach((/**
             * @param {?} p
             * @return {?}
             */
            function (p) {
                /** @type {?} */
                var value = p.value;
                if (p.type == JointQueryParameterType.Field || p.type == JointQueryParameterType.Expression) {
                    if (jqpr) {
                        /** @type {?} */
                        var r = jqpr.find((/**
                         * @param {?} it
                         * @return {?}
                         */
                        function (it) { return it.code == p.code; }));
                        value = r.value;
                    }
                }
                entityParams[p.code] = value;
                map.set(p.code, value);
            }));
        }
        else {
            // 兼容key-value格式params
            Object.keys(jointQueryParameters.params).forEach((/**
             * @param {?} k
             * @return {?}
             */
            function (k) {
                entityParams[k] = jointQueryParameters.params[k];
                map.set(k, jointQueryParameters.params[k]);
            }));
        }
    };
    /**
     * @param {?} url
     * @param {?} k
     * @param {?} v
     * @return {?}
     */
    BillTrackerInternalUiService.prototype.appendQueryParam = /**
     * @param {?} url
     * @param {?} k
     * @param {?} v
     * @return {?}
     */
    function (url, k, v) {
        if (url.indexOf(k) > -1) {
            /** @type {?} */
            var re1 = eval('/(\\?)(' + k + '=)([^&]*)/gi');
            url = url.replace(re1, '?' + k + '=' + v);
            /** @type {?} */
            var re2 = eval('/(&)(' + k + '=)([^&]*)/gi');
            url = url.replace(re2, '&' + k + '=' + v);
        }
        else {
            /** @type {?} */
            var paraStr = k + '=' + v;
            /** @type {?} */
            var idx = url.indexOf('?');
            if (idx < 0)
                url += '?';
            else if (idx >= 0 && idx != url.length - 1)
                url += '&';
            url = url + paraStr;
        }
        return url;
    };
    BillTrackerInternalUiService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BillTrackerInternalUiService.ctorParameters = function () { return [
        { type: FrameworkService },
        { type: MessagerService },
        { type: LoadingService },
        { type: String, decorators: [{ type: Inject, args: [LOCALE_ID,] }] },
        { type: BillTrackerDataService },
        { type: BillTrackerDataInfoService },
        { type: BsModalService },
        { type: ComponentFactoryResolver },
        { type: Injector },
        { type: BillTrackerLocalePipe }
    ]; };
    return BillTrackerInternalUiService;
}());
export { BillTrackerInternalUiService };
if (false) {
    /** @type {?} */
    BillTrackerInternalUiService.prototype.framework;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.messager;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.loading;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.dataService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.dataInfoService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.modalService;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.cfr;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.injector;
    /** @type {?} */
    BillTrackerInternalUiService.prototype.localePipe;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmlsbC10cmFja2VyLWludGVybmFsLXVpLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZWRwLWJpZi9ydW50aW1lLWFwaS8iLCJzb3VyY2VzIjpbImxpYi9iaWxsLXRyYWNrZXIvc2VydmljZXMvYmlsbC10cmFja2VyLWludGVybmFsLXVpLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRWxHLE9BQU8sRUFBRSxjQUFjLEVBQXdCLHVCQUF1QixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDcEcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNsRCxPQUFPLEVBQWMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBSTVGLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3pFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRXJFO0lBR0ksc0NBQ1csU0FBMkIsRUFDM0IsUUFBeUIsRUFDekIsT0FBdUIsRUFDWCxRQUFnQixFQUM1QixXQUFtQyxFQUNuQyxlQUEyQyxFQUMzQyxZQUE0QixFQUM1QixHQUE2QixFQUM3QixRQUFrQixFQUNsQixVQUFpQztRQVRqQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixhQUFRLEdBQVIsUUFBUSxDQUFpQjtRQUN6QixZQUFPLEdBQVAsT0FBTyxDQUFnQjtRQUV2QixnQkFBVyxHQUFY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Q3pCLGtEQUF3QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3RvciwgTE9DQUxFX0lEIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IHsgQmlsbERhdGFGaWVsZEJhc2UsIEJpbGxTY2hlbWFGaWVsZEJhc2UgfSBmcm9tIFwiQGVkcC1haWYvY29tbW9uLWFwaVwiO1xyXG5pbXBvcnQgeyBKb2ludFF1ZXJ5TW9kZSwgSm9pbnRRdWVyeVBhcmFtZXRlcnMsIEpvaW50UXVlcnlQYXJhbWV0ZXJUeXBlIH0gZnJvbSBcIkBlZHAtYmlmL2NvbW1vbi1hcGlcIjtcclxuaW1wb3J0IHsgTWVzc2FnZXJTZXJ2aWNlIH0gZnJvbSBcIkBmYXJyaXMvdWktbWVzc2FnZXJcIjtcclxuaW1wb3J0IHsgQnNNb2RhbFNlcnZpY2UgfSBmcm9tIFwiQGZhcnJpcy91aS1tb2RhbFwiO1xyXG5pbXBvcnQgeyBBcHBPcHRpb25zLCBBcHBUeXBlLCBGcmFtZXdvcmtTZXJ2aWNlLCBMb2FkaW5nU2VydmljZSB9IGZyb20gXCJAZ3NwLXN5cy9ydGYtY29tbW9uXCI7XHJcbmltcG9ydCB7IEJpbGxEYXRhSW5mbyB9IGZyb20gXCIuLi8uLi9lbnRpdHkvdHJhY2tpbmcvQmlsbERhdGFJbmZvXCI7XHJcbmltcG9ydCB7IEJpbGxJbmZvIH0gZnJvbSBcIi4uLy4uL2VudGl0eS90cmFja2luZy9CaWxsSW5mb1wiO1xyXG5pbXBvcnQgeyBKb2ludFF1ZXJ5UGFyYW1ldGVyUmVzdWx0IH0gZnJvbSBcIi4uLy4uL2VudGl0eS90cmFja2luZy9Kb2ludFF1ZXJ5UGFyYW1ldGVyUmVzdWx0XCI7XHJcbmltcG9ydCB7IEJpbGxUcmFja2VyQ29uc3RhbnQgfSBmcm9tIFwiLi4vY29uZmlnL2JpbGwtdHJhY2tlci1jb25zdGFudFwiO1xyXG5pbXBvcnQgeyBCaWxsVHJhY2tlckxvY2FsZVBpcGUgfSBmcm9tIFwiLi4vcGlwZS9iaWxsLXRyYWNrZXItbG9jYWxlLnBpcGVcIjtcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJEYXRhSW5mb1NlcnZpY2UgfSBmcm9tIFwiLi9iaWxsLXRyYWNrZXItZGF0YS1pbmZvLnNlcnZpY2VcIjtcclxuaW1wb3J0IHsgQmlsbFRyYWNrZXJEYXRhU2VydmljZSB9IGZyb20gXCIuL2JpbGwtdHJhY2tlci1kYXRhLnNlcnZpY2VcIjtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEJpbGxUcmFja2VySW50ZXJuYWxVaVNlcnZpY2Uge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKFxyXG4gICAgICAgIHB1YmxpYyBmcmFtZXdvcms6IEZyYW1ld29ya1NlcnZpY2UsXHJcbiAgICAgICAgcHVibGljIG1lc3NhZ2VyOiBNZXNzYWdlclNlcnZpY2UsXHJcbiAgICAgICAgcHVibGljIGxvYWRpbmc6IExvYWRpbmdTZXJ2aWNlLFxyXG4gICAgICAgIEBJbmplY3QoTE9DQUxFX0lEKSBsb2NhbGVJZDogc3RyaW5nLFxyXG4gICAgICAgIHB1YmxpYyBkYXRhU2VydmljZTogQmlsbFRyYWNrZXJEYXRhU2VydmljZSxcclxuICAgICAgICBwdWJsaWMgZGF0YUluZm9TZXJ2aWNlOiBCaWxsVHJhY2tlckRhdGFJbmZvU2VydmljZSxcclxuICAgICAgICBwdWJsaWMgbW9kYWxTZXJ2aWNlOiBCc01vZGFsU2VydmljZSxcclxuICAgICAgICBwdWJsaWMgY2ZyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHVibGljIGluamVjdG9yOiBJbmplY3RvcixcclxuICAgICAgICBwdWJsaWMgbG9jYWxlUGlwZTogQmlsbFRyYWNrZXJMb2NhbGVQaXBlLFxyXG4gICAgKSB7XHJcbiAgICB9XHJcblxyXG4gICAgb3BlbkJpbGxEZXRhaWwoYmlsbEluZm86IEJpbGxJbmZvLCBiaWxsRGF0YUluZm86IEJpbGxEYXRhSW5mbykge1xyXG4gICAgICAgIGNvbnN0IGpvaW50UXVlcnlNb2RlID0gYmlsbEluZm8uam9pbnRRdWVyeU1vZGU7XHJcbiAgICAgICAgY29uc3Qgam9pbnRRdWVyeVBhcmFtZXRlcnM6IEpvaW50UXVlcnlQYXJhbWV0ZXJzID0gSlNPTi5wYXJzZShiaWxsSW5mby5qb2ludFF1ZXJ5UGFyYW1ldGVycyk7XHJcbiAgICAgICAgY29uc3QgaWQgPSBiaWxsRGF0YUluZm8uZGF0YUlkO1xyXG5cclxuICAgICAgICBpZiAodGhpcy5kYXRhU2VydmljZS5oYXNEeW5hbWljUGFyYW1zKGpvaW50UXVlcnlQYXJhbWV0ZXJzKSkge1xyXG4gICAgICAgICAgICBjb25zdCBhcmdzID0gdGhpcy5kYXRhU2VydmljZS5idWlsZEdldEpvaW50UXVlcnlQYXJhbWV0ZXJzQXJncyhqb2ludFF1ZXJ5UGFyYW1ldGVycywgYmlsbEluZm8sIGJpbGxEYXRhSW5mbyk7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YVNlcnZpY2UuZ2V0Sm9pbnRRdWVyeVBhcmFtZXRlcnMoYXJncykuc3Vic2NyaWJlKFxyXG4gICAgICAgICAgICAgICAgKHJlc3VsdHMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuQVBQKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3Blbk1lbnUoam9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkLCByZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLlVSTCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5Vcmwoam9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkLCByZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLkFQUCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuTWVudShqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKGpvaW50UXVlcnlNb2RlID09IEpvaW50UXVlcnlNb2RlLlVSTCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuVXJsKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgb3BlbkJpbGxEZXRhaWxXaXRoRmllbGRzKGJpbGxJbmZvOiBCaWxsSW5mbywgYmlsbERhdGFJbmZvOiBCaWxsRGF0YUluZm8sIGZpZWxkc1dpdGhWYWx1ZTogQmlsbFNjaGVtYUZpZWxkQmFzZVtdKSB7XHJcbiAgICAgICAgY29uc3QgaWQgPSBiaWxsRGF0YUluZm8uZGF0YUlkO1xyXG4gICAgICAgIGNvbnN0IGpvaW50UXVlcnlNb2RlID0gYmlsbEluZm8uam9pbnRRdWVyeU1vZGU7XHJcbiAgICAgICAgY29uc3Qgam9pbnRRdWVyeVBhcmFtZXRlcnM6IEpvaW50UXVlcnlQYXJhbWV0ZXJzID0gSlNPTi5wYXJzZShiaWxsSW5mby5qb2ludFF1ZXJ5UGFyYW1ldGVycyk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmRhdGFTZXJ2aWNlLmhhc0R5bmFtaWNQYXJhbXMoam9pbnRRdWVyeVBhcmFtZXRlcnMpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGFyZ3MgPSB0aGlzLmRhdGFTZXJ2aWNlLmJ1aWxkR2V0Sm9pbnRRdWVyeVBhcmFtZXRlcnNBcmdzKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBiaWxsSW5mbywgYmlsbERhdGFJbmZvKTtcclxuICAgICAgICAgICAgdGhpcy5kYXRhU2VydmljZS5nZXRKb2ludFF1ZXJ5UGFyYW1ldGVycyhhcmdzKS5zdWJzY3JpYmUoXHJcbiAgICAgICAgICAgICAgICAocmVzdWx0cykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChqb2ludFF1ZXJ5TW9kZSA9PSBKb2ludFF1ZXJ5TW9kZS5BUFApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuTWVudShqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQsIHJlc3VsdHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuVVJMKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3BlblVybChqb2ludFF1ZXJ5UGFyYW1ldGVycywgaWQsIHJlc3VsdHMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuQVBQKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5NZW51KGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBpZCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoam9pbnRRdWVyeU1vZGUgPT0gSm9pbnRRdWVyeU1vZGUuVVJMKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5Vcmwoam9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOebtOaOpeaJk+W8gOiPnOWNlVxyXG4gICAgICogQHBhcmFtIGpvaW50UXVlcnlQYXJhbWV0ZXJzIFxyXG4gICAgICogQHBhcmFtIGlkIFxyXG4gICAgICovXHJcbiAgICBvcGVuTWVudShqb2ludFF1ZXJ5UGFyYW1ldGVyczogSm9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkOiBzdHJpbmcsIGpxcHI/OiBKb2ludFF1ZXJ5UGFyYW1ldGVyUmVzdWx0W10pIHtcclxuICAgICAgICBjb25zdCBlbnRpdHlQYXJhbXMgPSB7fTtcclxuICAgICAgICBlbnRpdHlQYXJhbXNbXCJpZFwiXSA9IGlkO1xyXG4gICAgICAgIGVudGl0eVBhcmFtc1tcImFjdGlvblwiXSA9IFwiTG9hZEFuZFZpZXcxXCI7XHJcblxyXG4gICAgICAgIGNvbnN0IG1hcCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICAgICAgbWFwLnNldChcImlkXCIsIGlkKTtcclxuICAgICAgICBtYXAuc2V0KFwiYWN0aW9uXCIsIFwiTG9hZEFuZFZpZXcxXCIpO1xyXG5cclxuICAgICAgICB0aGlzLmJ1aWxkT3Blbk1lbnVQYXJhbXMoam9pbnRRdWVyeVBhcmFtZXRlcnMsIG1hcCwgZW50aXR5UGFyYW1zLCBqcXByKTtcclxuXHJcbiAgICAgICAgY29uc3QgV0VCX0ZPUk1fUk9VVEVfUEFSQU1TID0gZW5jb2RlVVJJQ29tcG9uZW50KEpTT04uc3RyaW5naWZ5KGVudGl0eVBhcmFtcykpO1xyXG4gICAgICAgIG1hcC5zZXQoXCJXRUJfRk9STV9ST1VURV9QQVJBTVNcIiwgV0VCX0ZPUk1fUk9VVEVfUEFSQU1TKTtcclxuXHJcbiAgICAgICAgY29uc3Qgb3B0czogQXBwT3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgYXBwVHlwZTogQXBwVHlwZS5NZW51LFxyXG4gICAgICAgICAgICBmdW5jSWQ6IGpvaW50UXVlcnlQYXJhbWV0ZXJzLmZ1bmNJZCxcclxuICAgICAgICAgICAgYXBwRW50cmFuY2U6IG51bGwsXHJcbiAgICAgICAgICAgIGFwcElkOiBudWxsLFxyXG4gICAgICAgICAgICB0YWJJZDogaWQsXHJcbiAgICAgICAgICAgIGVudGl0eVBhcmFtczogZW50aXR5UGFyYW1zLFxyXG4gICAgICAgICAgICBxdWVyeVN0cmluZ1BhcmFtczogbWFwLFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5mcmFtZXdvcmsub3Blbk1lbnUob3B0cyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiDlgJ/liqnljZXmja7mn6XnnIvlrrnlmajmiZPlvIB1cmxcclxuICAgICAqIEBwYXJhbSBqb2ludFF1ZXJ5UGFyYW1ldGVycyBcclxuICAgICAqIEBwYXJhbSBpZCBcclxuICAgICAqL1xyXG4gICAgb3BlblVybChqb2ludFF1ZXJ5UGFyYW1ldGVyczogSm9pbnRRdWVyeVBhcmFtZXRlcnMsIGlkOiBzdHJpbmcsIGpxcHI/OiBKb2ludFF1ZXJ5UGFyYW1ldGVyUmVzdWx0W10pIHtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhcIm9wZW4gZGVmYXVsdCBjb250YWluZXIgZm9yIHVybFwiKTtcclxuXHJcbiAgICAgICAgbGV0IHVybCA9IHRoaXMuYXBwZW5kUXVlcnlQYXJhbShqb2ludFF1ZXJ5UGFyYW1ldGVycy51cmwsIFwiaWRcIiwgaWQpO1xyXG4gICAgICAgIC8vIOa3u+WKoOiHquWumuS5ieWPguaVsFxyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcykpIHtcclxuICAgICAgICAgICAgam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zLmZvckVhY2gocCA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgdmFsdWUgPSBwLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgaWYgKHAudHlwZSA9PSBKb2ludFF1ZXJ5UGFyYW1ldGVyVHlwZS5GaWVsZCB8fCBwLnR5cGUgPT0gSm9pbnRRdWVyeVBhcmFtZXRlclR5cGUuRXhwcmVzc2lvbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBqcXByLmZpbmQoaXQgPT4gaXQuY29kZSA9PSBwLmNvZGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gciAmJiByLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgdXJsID0gdGhpcy5hcHBlbmRRdWVyeVBhcmFtKHVybCwgcC5jb2RlLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOWFvOWuuWtleS12YWx1ZeagvOW8j3BhcmFtc1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXMpLmZvckVhY2goKGspID0+IHtcclxuICAgICAgICAgICAgICAgIHVybCA9IHRoaXMuYXBwZW5kUXVlcnlQYXJhbSh1cmwsIGssIGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtc1trXSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZW50aXR5UGFyYW1zID0gam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zIHx8IHt9O1xyXG4gICAgICAgIGVudGl0eVBhcmFtc1tcImlkXCJdID0gaWQ7XHJcbiAgICAgICAgZW50aXR5UGFyYW1zW1widXJsXCJdID0gdXJsO1xyXG4gICAgICAgIGVudGl0eVBhcmFtc1tcImFjdGlvblwiXSA9IFwiTG9hZEFuZFZpZXcxXCI7XHJcblxyXG4gICAgICAgIGNvbnN0IG1hcCA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XHJcbiAgICAgICAgbWFwLnNldChcInVybFwiLCB1cmwpO1xyXG4gICAgICAgIG1hcC5zZXQoXCJpZFwiLCBpZCk7XHJcbiAgICAgICAgbWFwLnNldChcImFjdGlvblwiLCBcIkxvYWRBbmRWaWV3MVwiKTtcclxuXHJcbiAgICAgICAgdGhpcy5idWlsZE9wZW5NZW51UGFyYW1zKGpvaW50UXVlcnlQYXJhbWV0ZXJzLCBtYXAsIHVuZGVmaW5lZCwganFwcik7XHJcblxyXG4gICAgICAgIGNvbnN0IG9wdHM6IEFwcE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGFwcFR5cGU6IEFwcFR5cGUuTWVudSxcclxuICAgICAgICAgICAgZnVuY0lkOiBCaWxsVHJhY2tlckNvbnN0YW50LkJJTExfVklFV0VSX0ZVTkNfSUQsXHJcbiAgICAgICAgICAgIGFwcEVudHJhbmNlOiBudWxsLFxyXG4gICAgICAgICAgICBhcHBJZDogbnVsbCxcclxuICAgICAgICAgICAgdGFiSWQ6IGlkLFxyXG4gICAgICAgICAgICBlbnRpdHlQYXJhbXM6IGVudGl0eVBhcmFtcyxcclxuICAgICAgICAgICAgcXVlcnlTdHJpbmdQYXJhbXM6IG1hcCxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuZnJhbWV3b3JrLm9wZW5NZW51KG9wdHMpO1xyXG4gICAgfVxyXG5cclxuICAgIGJ1aWxkT3Blbk1lbnVQYXJhbXMoam9pbnRRdWVyeVBhcmFtZXRlcnM6IEpvaW50UXVlcnlQYXJhbWV0ZXJzLCBtYXA6IE1hcDxzdHJpbmcsIHN0cmluZz4sIGVudGl0eVBhcmFtczogYW55ID0ge30sIGpxcHI/OiBKb2ludFF1ZXJ5UGFyYW1ldGVyUmVzdWx0W10pIHtcclxuICAgICAgICAvLyDmt7vliqDoh6rlrprkuYnlj4LmlbBcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXMpKSB7XHJcbiAgICAgICAgICAgIGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtcy5mb3JFYWNoKHAgPT4ge1xyXG4gICAgICAgICAgICAgICAgbGV0IHZhbHVlID0gcC52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChwLnR5cGUgPT0gSm9pbnRRdWVyeVBhcmFtZXRlclR5cGUuRmllbGQgfHwgcC50eXBlID09IEpvaW50UXVlcnlQYXJhbWV0ZXJUeXBlLkV4cHJlc3Npb24pIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoanFwcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0ganFwci5maW5kKGl0ID0+IGl0LmNvZGUgPT0gcC5jb2RlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSByLnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGVudGl0eVBhcmFtc1twLmNvZGVdID0gdmFsdWU7XHJcbiAgICAgICAgICAgICAgICBtYXAuc2V0KHAuY29kZSwgdmFsdWUpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIOWFvOWuuWtleS12YWx1ZeagvOW8j3BhcmFtc1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhqb2ludFF1ZXJ5UGFyYW1ldGVycy5wYXJhbXMpLmZvckVhY2goKGspID0+IHtcclxuICAgICAgICAgICAgICAgIGVudGl0eVBhcmFtc1trXSA9IGpvaW50UXVlcnlQYXJhbWV0ZXJzLnBhcmFtc1trXTtcclxuICAgICAgICAgICAgICAgIG1hcC5zZXQoaywgam9pbnRRdWVyeVBhcmFtZXRlcnMucGFyYW1zW2tdKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFwcGVuZFF1ZXJ5UGFyYW0odXJsOiBzdHJpbmcsIGs6IHN0cmluZywgdikge1xyXG4gICAgICAgIGlmICh1cmwuaW5kZXhPZihrKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIGxldCByZTEgPSBldmFsKCcvKFxcXFw/KSgnICsgayArICc9KShbXiZdKikvZ2knKTtcclxuICAgICAgICAgICAgdXJsID0gdXJsLnJlcGxhY2UocmUxLCAnPycgKyBrICsgJz0nICsgdik7XHJcbiAgICAgICAgICAgIGxldCByZTIgPSBldmFsKCcvKCYpKCcgKyBrICsgJz0pKFteJl0qKS9naScpO1xyXG4gICAgICAgICAgICB1cmwgPSB1cmwucmVwbGFjZShyZTIsICcmJyArIGsgKyAnPScgKyB2KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsZXQgcGFyYVN0ciA9IGsgKyAnPScgKyB2O1xyXG5cclxuICAgICAgICAgICAgbGV0IGlkeCA9IHVybC5pbmRleE9mKCc/Jyk7XHJcbiAgICAgICAgICAgIGlmIChpZHggPCAwKVxyXG4gICAgICAgICAgICAgICAgdXJsICs9ICc/JztcclxuICAgICAgICAgICAgZWxzZSBpZiAoaWR4ID49IDAgJiYgaWR4ICE9IHVybC5sZW5ndGggLSAxKVxyXG4gICAgICAgICAgICAgICAgdXJsICs9ICcmJztcclxuICAgICAgICAgICAgdXJsID0gdXJsICsgcGFyYVN0cjtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVybDtcclxuICAgIH1cclxufSJdfQ==