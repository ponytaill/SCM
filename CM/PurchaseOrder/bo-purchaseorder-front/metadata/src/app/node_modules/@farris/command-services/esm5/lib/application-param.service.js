import { take } from 'rxjs/operators';
import { Injectable, Optional } from '@angular/core';
import { ParamService } from './param.service';
import { RuntimeFrameworkService } from './rtf-service';
import { isObservable } from 'rxjs';
/**
 * 应用参数服务
 * @scope FormModule
 */
var ApplicationParamService = /** @class */ (function () {
    function ApplicationParamService(paramService, runtimeFrameworkService) {
        this.paramService = paramService;
        this.runtimeFrameworkService = runtimeFrameworkService;
        if (!this.runtimeFrameworkService) {
            this.runtimeFrameworkService = new RuntimeFrameworkService();
        }
    }
    /**
     * 解析参数
     */
    ApplicationParamService.prototype.parseParams = function (route, frameworkService, viewModel, callback) {
        var _this = this;
        var highOrderInvoke = this.highOrderInvoke(callback);
        if (!this.paramService) {
            route.queryParams.pipe(take(1)).subscribe(function (params) {
                _this.params = params;
                _this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
        else {
            this.paramService.parse().pipe(take(1)).subscribe(function (params) {
                _this.params = params;
                _this.setupParams(params, frameworkService, viewModel, highOrderInvoke);
            });
        }
    };
    /**
     * 设置参数
     */
    ApplicationParamService.prototype.setupParams = function (params, frameworkService, viewModel, callback) {
        var queryParams = this.getParams(params);
        if (!queryParams) {
            callback();
            return;
        }
        // 先设置参数，保证普通路由也能正常执行。
        this.setQueryParams(queryParams, viewModel);
        var funcId = this.getFuncId(queryParams);
        var appId = this.getAppId(queryParams);
        if (!funcId && !appId) {
            callback();
            return;
        }
        if (funcId) {
            this.setStaticParams(funcId, queryParams, frameworkService, viewModel, callback);
        }
        else {
            callback();
        }
    };
    /**
     * 设置查询参数
     */
    ApplicationParamService.prototype.setQueryParams = function (queryParams, viewModel) {
        var parsedQueryParams = {};
        // 设置表单参数
        // 首先判断是否为弹窗
        var isInDialog = this.isInDialog(viewModel);
        var uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        // 如果是弹窗，弹窗外的参数（无论表单参数或静态参数）不应该覆盖弹窗的参数。弹窗打开时传递的参数相当于局部变量，不应被覆盖
        Object.keys(queryParams).forEach(function (paramName) {
            if (!isInDialog) {
                parsedQueryParams[paramName] = queryParams[paramName];
            }
            else {
                if (!uiState.hasOwnProperty(paramName)) {
                    parsedQueryParams[paramName] = queryParams[paramName];
                }
            }
        });
        this.updateUIState(viewModel, parsedQueryParams);
    };
    /**
     * 设置静态参数
     */
    ApplicationParamService.prototype.setStaticParams = function (funcId, queryParams, frameworkService, viewModel, callback) {
        var _this = this;
        this.runtimeFrameworkService.getMenuParams(funcId, function (staicParams) {
            var staticParamsObj = _this.mapStaticParamsToObject(staicParams, queryParams, viewModel);
            if (!staticParamsObj) {
                callback();
                return;
            }
            _this.updateUIState(viewModel, staticParamsObj);
            callback();
        });
    };
    /**
     * 将staticParams转换为普通对象
     * @param staticParams，形如：[{'name': 'key1', 'value': 'val1'}, {'name': 'key2', 'value': 'val2'}]
     * @return 形如：{key1: val1, key2: value2 }
     */
    ApplicationParamService.prototype.mapStaticParamsToObject = function (staticParams, queryParams, viewModel) {
        if (!staticParams) {
            return;
        }
        var inDialog = this.isInDialog(viewModel);
        var uiState = viewModel && viewModel.uiState && viewModel.uiState.innerData || {};
        var result = {};
        staticParams.forEach(function (value, key, map) {
            if (!inDialog) {
                // 静态参数不能覆盖查询参数
                if (!queryParams.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
            else {
                if (!queryParams.hasOwnProperty(key) && !uiState.hasOwnProperty(key)) {
                    result[key] = value;
                }
            }
        });
        return result;
    };
    /**
     * 是否在弹窗内
     * @param viewModel viewmodel
     */
    ApplicationParamService.prototype.isInDialog = function (viewModel) {
        var isInDialog = false;
        if (viewModel && viewModel.uiState) {
            // tslint:disable-next-line: max-line-length
            if (viewModel.uiState.innerData && viewModel.uiState.innerData.hasOwnProperty('DEVKIT_DIALOG') || viewModel.uiState['DEVKIT_DIALOG']) {
                isInDialog = true;
            }
        }
        return isInDialog;
    };
    /**
     * 更新UIState
     */
    ApplicationParamService.prototype.updateUIState = function (viewModel, params) {
        var _this = this;
        if (!viewModel || !params) {
            return;
        }
        var uiState = viewModel.uiState;
        // 兼容使用string传递params对象的场景
        if (typeof params === 'string' && params !== '') {
            params = JSON.parse(params);
        }
        // 在UIState为参数创建属性
        Object.keys(params).forEach(function (propName) {
            uiState.setPropertyValue(propName, params[propName]);
            if (propName && propName === 'union_session') {
                var sessionInfo = params[propName];
                _this.setSessionInfo(viewModel, sessionInfo);
            }
        });
    };
    ApplicationParamService.prototype.setSessionInfo = function (viewModel, sessionInfo) {
        if (!viewModel || !sessionInfo) {
            return;
        }
        if (sessionInfo && typeof sessionInfo === 'string' && sessionInfo.startsWith('{') && sessionInfo.endsWith('}')) {
            sessionInfo = JSON.parse(sessionInfo);
        }
        var token = sessionInfo && sessionInfo.token || null;
        var sessionId = sessionInfo && sessionInfo.sessionId || null;
        if (token) {
            viewModel.frameContext.appContext.Token = token;
        }
        if (sessionId) {
            var befRepository = viewModel.frameContext.repository;
            if (befRepository) {
                befRepository.restService.sessionService.setBeSessionId(sessionId);
            }
        }
    };
    /**
     * 获取功能菜单id
     */
    ApplicationParamService.prototype.getFuncId = function (queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['funcId'];
    };
    /**
     * 获取应用id
     */
    ApplicationParamService.prototype.getAppId = function (queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['appId'];
    };
    ApplicationParamService.prototype.getTabId = function (queryParams) {
        if (!queryParams) {
            return;
        }
        return queryParams['tabId'];
    };
    /**
     * 获取url参数对象
     * @param queryParams url参数
     */
    ApplicationParamService.prototype.getParams = function (queryParams) {
        if (!queryParams) {
            return {};
        }
        var result = {};
        if (queryParams.hasOwnProperty('WEB_FORM_ROUTE_PARAMS')) {
            var webFormRouteParams = queryParams['WEB_FORM_ROUTE_PARAMS'];
            if (webFormRouteParams && webFormRouteParams.startsWith('{') && webFormRouteParams.endsWith('}')) {
                webFormRouteParams = decodeURI(encodeURI(webFormRouteParams).replace(/%0A/g, '\\n').replace(/%09/g, '\\t').replace(/%0D/g, '\\r'));
                result = JSON.parse(webFormRouteParams);
            }
            Object.keys(queryParams).forEach(function (prop) {
                if (prop !== 'WEB_FORM_ROUTE_PARAMS') {
                    result[prop] = queryParams[prop];
                }
            });
            return result;
        }
        return queryParams;
    };
    ApplicationParamService.prototype.highOrderInvoke = function (callback) {
        var _this = this;
        return function () {
            try {
                var queryParams = _this.getParams(_this.params);
                var tabId = _this.getTabId(queryParams);
                if (tabId) {
                    var controlEvent = _this.runtimeFrameworkService.getMenuSwitchControlEvent();
                    if (controlEvent && isObservable(controlEvent)) {
                        controlEvent.subscribe(function (event) {
                            if (event) {
                                event.next('ok');
                            }
                        });
                    }
                }
            }
            catch (e) {
                console.warn(e);
            }
            if (callback && typeof callback === 'function') {
                callback();
            }
        };
    };
    ApplicationParamService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    ApplicationParamService.ctorParameters = function () { return [
        { type: ParamService, decorators: [{ type: Optional }] },
        { type: RuntimeFrameworkService, decorators: [{ type: Optional }] }
    ]; };
    return ApplicationParamService;
}());
export { ApplicationParamService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tcGFyYW0uc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvY29tbWFuZC1zZXJ2aWNlcy8iLCJzb3VyY2VzIjpbImxpYi9hcHBsaWNhdGlvbi1wYXJhbS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUd0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXhELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFcEM7OztHQUdHO0FBRUg7SUFHRSxpQ0FDc0IsWUFBMEIsRUFDMUIsdUJBQWdEO1FBRGhELGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7UUFFcEUsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUNqQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSx1QkFBdUIsRUFBRSxDQUFDO1NBQzlEO0lBQ0gsQ0FBQztJQUNEOztPQUVHO0lBQ0ksNkNBQVcsR0FBbEIsVUFBbUIsS0FBcUIsRUFBRSxnQkFBa0MsRUFBRSxTQUFvQixFQUFFLFFBQW9CO1FBQXhILGlCQWFDO1FBWkMsSUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUN0QixLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQyxNQUFXO2dCQUNwRCxLQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztn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QUFRO1FBQWhDLGlCQW9CQztRQW5CQyxPQUFPO1lBQ0wsSUFBSTtnQkFDRixJQUFNLFdBQVcsR0FBRyxLQUFJLENBQUMsU0FBUyxDQUFDLEtBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDaEQsSUFBTSxLQUFLLEdBQUcsS0FBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDekMsSUFBSSxLQUFLLEVBQUU7b0JBQ1QsSUFBTSxZQUFZLEdBQUcsS0FBSSxDQUFDLHVCQUF1QixDQUFDLHlCQUF5QixFQUFFLENBQUM7b0JBQzlFLElBQUksWUFBWSxJQUFJLFlBQVksQ0FBQyxZQUFZLENBQUMsRUFBRTt3QkFDOUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxVQUFDLEtBQVU7NEJBQ2hDLElBQUksS0FBSyxFQUFFO2dDQUNULEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7NkJBQ2xCO3dCQUNILENBQUMsQ0FBQyxDQUFDO3FCQUNKO2lCQUNGO2FBQ0Y7WUFBQyxPQUFPLENBQUMsRUFBRTtnQkFBRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQUU7WUFDaEMsSUFBSSxRQUFRLElBQUksT0FBTyxRQUFRLEtBQUssVUFBVSxFQUFFO2dCQUM5QyxRQUFRLEVBQUUsQ0FBQzthQUNaO1FBQ0gsQ0FBQyxDQUFBO0lBQ0gsQ0FBQzs7Z0JBclBGLFVBQVU7Ozs7Z0JBVkYsWUFBWSx1QkFjaEIsUUFBUTtnQkFiSix1QkFBdUIsdUJBYzNCLFFBQVE7O0lBaVBiLDhCQUFDO0NBQUEsQUF0UEQsSUFzUEM7U0FyUFksdUJBQXVCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUsIFBhcmFtTWFwIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnQGdzcC1zeXMvcnRmLWNvbW1vbic7XG5pbXBvcnQgeyBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUGFyYW1TZXJ2aWNlIH0gZnJvbSAnLi9wYXJhbS5zZXJ2aWNlJztcbmltcG9ydCB7IFJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlIH0gZnJvbSAnLi9ydGYtc2VydmljZSc7XG5pbXBvcnQgeyBCZWZSZXBvc2l0b3J5IH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xuaW1wb3J0IHsgaXNPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5cbi8qKlxuICog5bqU55So5Y+C5pWw5pyN5YqhXG4gKiBAc2NvcGUgRm9ybU1vZHVsZVxuICovXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvblBhcmFtU2VydmljZSB7XG4gIHByaXZhdGUgcGFyYW1zOiBhbnk7XG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgcGFyYW1TZXJ2aWNlOiBQYXJhbVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBydW50aW1lRnJhbWV3b3JrU2VydmljZTogUnVudGltZUZyYW1ld29ya1NlcnZpY2UsXG4gICkge1xuICAgIGlmICghdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZSkge1xuICAgICAgdGhpcy5ydW50aW1lRnJhbWV3b3JrU2VydmljZSA9IG5ldyBSdW50aW1lRnJhbWV3b3JrU2VydmljZSgpO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog6Kej5p6Q5Y+C5pWwXG4gICAqL1xuICBwdWJsaWMgcGFyc2VQYXJhbXMocm91dGU6IEFjdGl2YXRlZFJvdXRlLCBmcmFtZXdvcmtTZXJ2aWNlOiBGcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWw6IFZpZXdNb2RlbCwgY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICBjb25zdCBoaWdoT3JkZXJJbnZva2UgPSB0aGlzLmhpZ2hPcmRlckludm9rZShjYWxsYmFjayk7XG4gICAgaWYgKCF0aGlzLnBhcmFtU2VydmljZSkge1xuICAgICAgcm91dGUucXVlcnlQYXJhbXMucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKHBhcmFtczogYW55KSA9PiB7XG4gICAgICAgIHRoaXMucGFyYW1zID0gcGFyYW1zO1xuICAgICAgICB0aGlzLnNldHVwUGFyYW1zKHBhcmFtcywgZnJhbWV3b3JrU2VydmljZSwgdmlld01vZGVsLCBoaWdoT3JkZXJJbnZva2UpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucGFyYW1TZXJ2aWNlLnBhcnNlKCkucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUocGFyYW1zID0+IHtcbiAgICAgICAgdGhpcy5wYXJhbXMgPSBwYXJhbXM7XG4gICAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1zLCBmcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWwsIGhpZ2hPcmRlckludm9rZSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICog6K6+572u5Y+C5pWwXG4gICAqL1xuICBwcml2YXRlIHNldHVwUGFyYW1zKHBhcmFtcywgZnJhbWV3b3JrU2VydmljZTogRnJhbWV3b3JrU2VydmljZSwgdmlld01vZGVsOiBWaWV3TW9kZWwsIGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XG4gICAgY29uc3QgcXVlcnlQYXJhbXMgPSB0aGlzLmdldFBhcmFtcyhwYXJhbXMpO1xuICAgIGlmICghcXVlcnlQYXJhbXMpIHtcbiAgICAgIGNhbGxiYWNrKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8g5YWI6K6+572u5Y+C5pWw77yM5L+d6K+B5pmu6YCa6Lev55Sx5Lmf6IO95q2j5bi45omn6KGM44CCXG4gICAgdGhpcy5zZXRRdWVyeVBhcmFtcyhxdWVyeVBhcmFtcywgdmlld01vZGVsKTtcblxuICAgIGNvbnN0IGZ1bmNJZCA9IHRoaXMuZ2V0RnVuY0lkKHF1ZXJ5UGFyYW1zKTtcbiAgICBjb25zdCBhcHBJZCA9IHRoaXMuZ2V0QXBwSWQocXVlcnlQYXJhbXMpO1xuICAgIGlmICghZnVuY0lkICYmICFhcHBJZCkge1xuICAgICAgY2FsbGJhY2soKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoZnVuY0lkKSB7XG4gICAgICB0aGlzLnNldFN0YXRpY1BhcmFtcyhmdW5jSWQsIHF1ZXJ5UGFyYW1zLCBmcmFtZXdvcmtTZXJ2aWNlLCB2aWV3TW9kZWwsIGNhbGxiYWNrKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2FsbGJhY2soKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOiuvue9ruafpeivouWPguaVsFxuICAgKi9cbiAgcHJpdmF0ZSBzZXRRdWVyeVBhcmFtcyhxdWVyeVBhcmFtczogYW55LCB2aWV3TW9kZWw6IFZpZXdNb2RlbCk6IGFueSB7XG4gICAgY29uc3QgcGFyc2VkUXVlcnlQYXJhbXMgPSB7fTtcbiAgICAvLyDorr7nva7ooajljZXlj4LmlbBcbiAgICAvLyDpppblhYjliKTmlq3mmK/lkKbkuLrlvLnnqpdcbiAgICBjb25zdCBpc0luRGlhbG9nID0gdGhpcy5pc0luRGlhbG9nKHZpZXdNb2RlbCk7XG4gICAgY29uc3QgdWlTdGF0ZSA9IHZpZXdNb2RlbCAmJiB2aWV3TW9kZWwudWlTdGF0ZSAmJiB2aWV3TW9kZWwudWlTdGF0ZS5pbm5lckRhdGEgfHwge307XG4gICAgLy8g5aaC5p6c5piv5by556qX77yM5by556qX5aSW55qE5Y+C5pWw77yI5peg6K666KGo5Y2V5Y+C5pWw5oiW6Z2Z5oCB5Y+C5pWw77yJ5LiN5bqU6K+l6KaG55uW5by556qX55qE5Y+C5pWw44CC5by556qX5omT5byA5pe25Lyg6YCS55qE5Y+C5pWw55u45b2T5LqO5bGA6YOo5Y+Y6YeP77yM5LiN5bqU6KKr6KaG55uWXG4gICAgT2JqZWN0LmtleXMocXVlcnlQYXJhbXMpLmZvckVhY2goKHBhcmFtTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICBpZiAoIWlzSW5EaWFsb2cpIHtcbiAgICAgICAgcGFyc2VkUXVlcnlQYXJhbXNbcGFyYW1OYW1lXSA9IHF1ZXJ5UGFyYW1zW3BhcmFtTmFtZV07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAoIXVpU3RhdGUuaGFzT3duUHJvcGVydHkocGFyYW1OYW1lKSkge1xuICAgICAgICAgIHBhcnNlZFF1ZXJ5UGFyYW1zW3BhcmFtTmFtZV0gPSBxdWVyeVBhcmFtc1twYXJhbU5hbWVdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy51cGRhdGVVSVN0YXRlKHZpZXdNb2RlbCwgcGFyc2VkUXVlcnlQYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIOiuvue9rumdmeaAgeWPguaVsFxuICAgKi9cbiAgcHJpdmF0ZSBzZXRTdGF0aWNQYXJhbXMoXG4gICAgZnVuY0lkOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBhbnksIGZyYW1ld29ya1NlcnZpY2U6IEZyYW1ld29ya1NlcnZpY2UsIHZpZXdNb2RlbDogVmlld01vZGVsLCBjYWxsYmFjazogKCkgPT4gdm9pZFxuICApIHtcbiAgICB0aGlzLnJ1bnRpbWVGcmFtZXdvcmtTZXJ2aWNlLmdldE1lbnVQYXJhbXMoZnVuY0lkLCAoc3RhaWNQYXJhbXMpID0+IHtcbiAgICAgIGNvbnN0IHN0YXRpY1BhcmFtc09iaiA9IHRoaXMubWFwU3RhdGljUGFyYW1zVG9PYmplY3Qoc3RhaWNQYXJhbXMsIHF1ZXJ5UGFyYW1zLCB2aWV3TW9kZWwpO1xuICAgICAgaWYgKCFzdGF0aWNQYXJhbXNPYmopIHtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy51cGRhdGVVSVN0YXRlKHZpZXdNb2RlbCwgc3RhdGljUGFyYW1zT2JqKTtcbiAgICAgIGNhbGxiYWNrKCk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog5bCGc3RhdGljUGFyYW1z6L2s5o2i5Li65pmu6YCa5a+56LGhXG4gICAqIEBwYXJhbSBzdGF0aWNQYXJhbXPvvIzlvaLlpoLvvJpbeyduYW1lJzogJ2tleTEnLCAndmFsdWUnOiAndmFsMSd9LCB7J25hbWUnOiAna2V5MicsICd2YWx1ZSc6ICd2YWwyJ31dXG4gICAqIEByZXR1cm4g5b2i5aaC77yae2tleTE6IHZhbDEsIGtleTI6IHZhbHVlMiB9XG4gICAqL1xuICBwcml2YXRlIG1hcFN0YXRpY1BhcmFtc1RvT2JqZWN0KHN0YXRpY1BhcmFtczogTWFwPGFueSwgYW55PiwgcXVlcnlQYXJhbXM6IGFueSwgdmlld01vZGVsPzogVmlld01vZGVsKTogYW55IHtcbiAgICBpZiAoIXN0YXRpY1BhcmFtcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpbkRpYWxvZyA9IHRoaXMuaXNJbkRpYWxvZyh2aWV3TW9kZWwpO1xuICAgIGNvbnN0IHVpU3RhdGUgPSB2aWV3TW9kZWwgJiYgdmlld01vZGVsLnVpU3RhdGUgJiYgdmlld01vZGVsLnVpU3RhdGUuaW5uZXJEYXRhIHx8IHt9O1xuICAgIGNvbnN0IHJlc3VsdCA9IHt9O1xuICAgIHN0YXRpY1BhcmFtcy5mb3JFYWNoKCh2YWx1ZSwga2V5LCBtYXApID0+IHtcbiAgICAgIGlmICghaW5EaWFsb2cpIHtcbiAgICAgICAgLy8g6Z2Z5oCB5Y+C5pWw5LiN6IO96KaG55uW5p+l6K+i5Y+C5pWwXG4gICAgICAgIGlmICghcXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghcXVlcnlQYXJhbXMuaGFzT3duUHJvcGVydHkoa2V5KSAmJiAhdWlTdGF0ZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cbiAgLyoqXG4gICAqIOaYr+WQpuWcqOW8ueeql+WGhVxuICAgKiBAcGFyYW0gdmlld01vZGVsIHZpZXdtb2RlbFxuICAgKi9cbiAgcHJpdmF0ZSBpc0luRGlhbG9nKHZpZXdNb2RlbDogVmlld01vZGVsKSB7XG4gICAgbGV0IGlzSW5EaWFsb2cgPSBmYWxzZTtcbiAgICBpZiAodmlld01vZGVsICYmIHZpZXdNb2RlbC51aVN0YXRlKSB7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxuICAgICAgaWYgKHZpZXdNb2RlbC51aVN0YXRlLmlubmVyRGF0YSAmJiB2aWV3TW9kZWwudWlTdGF0ZS5pbm5lckRhdGEuaGFzT3duUHJvcGVydHkoJ0RFVktJVF9ESUFMT0cnKSB8fCB2aWV3TW9kZWwudWlTdGF0ZVsnREVWS0lUX0RJQUxPRyddKSB7XG4gICAgICAgIGlzSW5EaWFsb2cgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gaXNJbkRpYWxvZztcbiAgfVxuICAvKipcbiAgICog5pu05pawVUlTdGF0ZVxuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVVSVN0YXRlKHZpZXdNb2RlbDogVmlld01vZGVsLCBwYXJhbXM6IGFueSkge1xuICAgIGlmICghdmlld01vZGVsIHx8ICFwYXJhbXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgdWlTdGF0ZSA9IHZpZXdNb2RlbC51aVN0YXRlO1xuXG4gICAgLy8g5YW85a655L2/55Soc3RyaW5n5Lyg6YCScGFyYW1z5a+56LGh55qE5Zy65pmvXG4gICAgaWYgKHR5cGVvZiBwYXJhbXMgPT09ICdzdHJpbmcnICYmIHBhcmFtcyAhPT0gJycpIHtcbiAgICAgIHBhcmFtcyA9IEpTT04ucGFyc2UocGFyYW1zKTtcbiAgICB9XG5cbiAgICAvLyDlnKhVSVN0YXRl5Li65Y+C5pWw5Yib5bu65bGe5oCnXG4gICAgT2JqZWN0LmtleXMocGFyYW1zKS5mb3JFYWNoKChwcm9wTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgICB1aVN0YXRlLnNldFByb3BlcnR5VmFsdWUocHJvcE5hbWUsIHBhcmFtc1twcm9wTmFtZV0pO1xuICAgICAgaWYgKHByb3BOYW1lICYmIHByb3BOYW1lID09PSAndW5pb25fc2Vzc2lvbicpIHtcbiAgICAgICAgbGV0IHNlc3Npb25JbmZvID0gcGFyYW1zW3Byb3BOYW1lXTtcbiAgICAgICAgdGhpcy5zZXRTZXNzaW9uSW5mbyh2aWV3TW9kZWwsIHNlc3Npb25JbmZvKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIHNldFNlc3Npb25JbmZvKHZpZXdNb2RlbDogVmlld01vZGVsLCBzZXNzaW9uSW5mbzogYW55KSB7XG4gICAgaWYgKCF2aWV3TW9kZWwgfHwgIXNlc3Npb25JbmZvKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmIChzZXNzaW9uSW5mbyAmJiB0eXBlb2Ygc2Vzc2lvbkluZm8gPT09ICdzdHJpbmcnICYmIHNlc3Npb25JbmZvLnN0YXJ0c1dpdGgoJ3snKSAmJiBzZXNzaW9uSW5mby5lbmRzV2l0aCgnfScpKSB7XG4gICAgICBzZXNzaW9uSW5mbyA9IEpTT04ucGFyc2Uoc2Vzc2lvbkluZm8pO1xuICAgIH1cbiAgICBjb25zdCB0b2tlbiA9IHNlc3Npb25JbmZvICYmIHNlc3Npb25JbmZvLnRva2VuIHx8IG51bGw7XG4gICAgY29uc3Qgc2Vzc2lvbklkID0gc2Vzc2lvbkluZm8gJiYgc2Vzc2lvbkluZm8uc2Vzc2lvbklkIHx8IG51bGw7XG4gICAgaWYgKHRva2VuKSB7XG4gICAgICB2aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuVG9rZW4gPSB0b2tlbjtcbiAgICB9XG4gICAgaWYgKHNlc3Npb25JZCkge1xuICAgICAgY29uc3QgYmVmUmVwb3NpdG9yeSA9IHZpZXdNb2RlbC5mcmFtZUNvbnRleHQucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XG4gICAgICBpZiAoYmVmUmVwb3NpdG9yeSkge1xuICAgICAgICBiZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLnNlc3Npb25TZXJ2aWNlLnNldEJlU2Vzc2lvbklkKHNlc3Npb25JZCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDojrflj5blip/og73oj5zljZVpZFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRGdW5jSWQocXVlcnlQYXJhbXM6IGFueSk6IGFueSB7XG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICByZXR1cm4gcXVlcnlQYXJhbXNbJ2Z1bmNJZCddO1xuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluW6lOeUqGlkXG4gICAqL1xuICBwcml2YXRlIGdldEFwcElkKHF1ZXJ5UGFyYW1zOiBhbnkpOiBhbnkge1xuICAgIGlmICghcXVlcnlQYXJhbXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIHF1ZXJ5UGFyYW1zWydhcHBJZCddO1xuICB9XG4gIHByaXZhdGUgZ2V0VGFiSWQocXVlcnlQYXJhbXM6IGFueSkge1xuICAgIGlmICghcXVlcnlQYXJhbXMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgcmV0dXJuIHF1ZXJ5UGFyYW1zWyd0YWJJZCddO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5Z1cmzlj4LmlbDlr7nosaFcbiAgICogQHBhcmFtIHF1ZXJ5UGFyYW1zIHVybOWPguaVsFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRQYXJhbXMocXVlcnlQYXJhbXM6IGFueSk6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBhbnkgfSB7XG4gICAgaWYgKCFxdWVyeVBhcmFtcykge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgICBsZXQgcmVzdWx0ID0ge307XG4gICAgaWYgKHF1ZXJ5UGFyYW1zLmhhc093blByb3BlcnR5KCdXRUJfRk9STV9ST1VURV9QQVJBTVMnKSkge1xuICAgICAgbGV0IHdlYkZvcm1Sb3V0ZVBhcmFtczogc3RyaW5nID0gcXVlcnlQYXJhbXNbJ1dFQl9GT1JNX1JPVVRFX1BBUkFNUyddO1xuICAgICAgaWYgKHdlYkZvcm1Sb3V0ZVBhcmFtcyAmJiB3ZWJGb3JtUm91dGVQYXJhbXMuc3RhcnRzV2l0aCgneycpICYmIHdlYkZvcm1Sb3V0ZVBhcmFtcy5lbmRzV2l0aCgnfScpKSB7XG4gICAgICAgIHdlYkZvcm1Sb3V0ZVBhcmFtcyA9IGRlY29kZVVSSShlbmNvZGVVUkkod2ViRm9ybVJvdXRlUGFyYW1zKS5yZXBsYWNlKC8lMEEvZywgJ1xcXFxuJykucmVwbGFjZSgvJTA5L2csICdcXFxcdCcpLnJlcGxhY2UoLyUwRC9nLCAnXFxcXHInKSk7XG4gICAgICAgIHJlc3VsdCA9IEpTT04ucGFyc2Uod2ViRm9ybVJvdXRlUGFyYW1zKTtcbiAgICAgIH1cbiAgICAgIE9iamVjdC5rZXlzKHF1ZXJ5UGFyYW1zKS5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICBpZiAocHJvcCAhPT0gJ1dFQl9GT1JNX1JPVVRFX1BBUkFNUycpIHtcbiAgICAgICAgICByZXN1bHRbcHJvcF0gPSBxdWVyeVBhcmFtc1twcm9wXTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbiAgICByZXR1cm4gcXVlcnlQYXJhbXM7XG4gIH1cbiAgcHJpdmF0ZSBoaWdoT3JkZXJJbnZva2UoY2FsbGJhY2spIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcXVlcnlQYXJhbXMgPSB0aGlzLmdldFBhcmFtcyh0aGlzLnBhcmFtcyk7XG4gICAgICAgIGNvbnN0IHRhYklkID0gdGhpcy5nZXRUYWJJZChxdWVyeVBhcmFtcyk7XG4gICAgICAgIGlmICh0YWJJZCkge1xuICAgICAgICAgIGNvbnN0IGNvbnRyb2xFdmVudCA9IHRoaXMucnVudGltZUZyYW1ld29ya1NlcnZpY2UuZ2V0TWVudVN3aXRjaENvbnRyb2xFdmVudCgpO1xuICAgICAgICAgIGlmIChjb250cm9sRXZlbnQgJiYgaXNPYnNlcnZhYmxlKGNvbnRyb2xFdmVudCkpIHtcbiAgICAgICAgICAgIGNvbnRyb2xFdmVudC5zdWJzY3JpYmUoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgaWYgKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgZXZlbnQubmV4dCgnb2snKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlKSB7IGNvbnNvbGUud2FybihlKTsgfVxuICAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBjYWxsYmFjayA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19