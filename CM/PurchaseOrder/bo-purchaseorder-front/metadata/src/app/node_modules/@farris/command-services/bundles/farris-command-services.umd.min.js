!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@farris/ui-loading"),require("@farris/ui-messager"),require("@farris/ui-notify"),require("@farris/ui-wizard"),require("@angular/router"),require("@farris/extend-page-modal"),require("lodash-es"),require("rxjs/observable/zip"),require("rxjs/observable/empty"),require("@farris/ui-verify-detail"),require("mousetrap"),require("rxjs/observable/of"),require("@gsp-wf/rtdevkit"),require("@gsp-wf/ui-flowchart"),require("@gsp-svc/cloudprint"),require("@gsp-svc/formdoc-upload"),require("@gsp-svc/file-viewer"),require("@farris/ui-modal"),require("@farris/ui-sidebar"),require("@gsp-sys/rtf-common"),require("@farris/component-querycondition"),require("@farris/bef"),require("@farris/ui-common/date"),require("@angular/common/http"),require("moment"),require("@farris/ui-datagrid"),require("@farris/ui-tooltip"),require("@farris/ui-feature-editor"),require("bignumber.js"),require("rxjs"),require("rxjs/operators"),require("@farris/ui-batch-edit-dialog"),require("@gsp-cmp/querysolution"),require("@farris/ui-list-filter"),require("@gsp-wf/wf-task-handler"),require("@angular/core"),require("@farris/devkit")):"function"==typeof define&&define.amd?define("@farris/command-services",["exports","@farris/ui-loading","@farris/ui-messager","@farris/ui-notify","@farris/ui-wizard","@angular/router","@farris/extend-page-modal","lodash-es","rxjs/observable/zip","rxjs/observable/empty","@farris/ui-verify-detail","mousetrap","rxjs/observable/of","@gsp-wf/rtdevkit","@gsp-wf/ui-flowchart","@gsp-svc/cloudprint","@gsp-svc/formdoc-upload","@gsp-svc/file-viewer","@farris/ui-modal","@farris/ui-sidebar","@gsp-sys/rtf-common","@farris/component-querycondition","@farris/bef","@farris/ui-common/date","@angular/common/http","moment","@farris/ui-datagrid","@farris/ui-tooltip","@farris/ui-feature-editor","bignumber.js","rxjs","rxjs/operators","@farris/ui-batch-edit-dialog","@gsp-cmp/querysolution","@farris/ui-list-filter","@gsp-wf/wf-task-handler","@angular/core","@farris/devkit"],t):t((e.farris=e.farris||{},e.farris["command-services"]={}),e.uiLoading,e.uiMessager,e.uiNotify,e.uiWizard,e.ng.router,e.extendPageModal,e.lodash,e.rxjs["observable/zip"],e.rxjs["observable/empty"],e.uiVerifyDetail,e.Mousetrap,e.rxjs["observable/of"],e.rtdevkit,e.uiFlowchart,e.cloudprint,e.formdocUpload,e.fileViewer,e.uiModal,e.uiSidebar,e.rtfCommon,e.componentQuerycondition,e.bef,e.date,e.ng.common.http,e.moment,e.uiDatagrid,e.uiTooltip,e.uiFeatureEditor,e.bignumber_js,e.rxjs,e.rxjs.operators,e.uiBatchEditDialog,e.querysolution,e.uiListFilter,e.wfTaskHandler,e.ng.core,e.devkit)}(this,function(e,t,r,i,n,a,C,s,g,v,o,c,y,u,l,p,f,d,h,m,S,b,I,w,x,E,P,F,D,M,T,R,O,N,A,j,B,L){"use strict";s=s&&s.hasOwnProperty("default")?s["default"]:s;var V="default"in c?c["default"]:c;E=E&&E.hasOwnProperty("default")?E["default"]:E;var _=(k.decorators=[{type:B.Injectable}],k);function k(){this.hideEvent=new T.Subject}var q=(U.prototype.setSuspend=function(e){U.isSuspend=e},U.prototype.show=function(e){if(!0!==U.isSuspend){this.loadingCmp&&(this.loadingCmp.close(),this.loadingCmp=null),this.registerService();var t=this.buildLoadingConfig(e);return this.loadingCmp=this.loadingService.show(t),this.loadingCmp}},U.prototype.showLoadingWithDelay=function(e,t){var r=this,i=setTimeout(function(){r.show(t)},e);return this.loadingTimerIds.push(i),this.registerService(),i},U.prototype.hideDelayLoading=function(e){this.clearLoadingTimer(e),this.hide()},U.prototype.buildLoadingConfig=function(e){var t;return(t=e?"object"==typeof e?e:{message:e}:{}).hasOwnProperty("delay")||(t.delay=0),t},U.prototype.clearAll=function(){var e=this;U.isSuspend=!1,window.setTimeout(function(){e.loadingService.clearAll()},350),this.loadingCmp=null,this.clearAllLoadingTimers(),this.destroy()},U.prototype.clearLoadingTimer=function(t){clearTimeout(t),this.loadingTimerIds=this.loadingTimerIds.filter(function(e){return e!==t})},U.prototype.clearAllLoadingTimers=function(){var t=this;this.loadingTimerIds.forEach(function(e){t.clearLoadingTimer(e)})},U.prototype.hide=function(){this.loadingCmp?!0!==U.isSuspend&&(this.loadingCmp.close(),this.loadingCmp=null,this.destroy()):this.destroy()},U.prototype.destroy=function(){if(!0!==U.isSuspend){var e=window.DEVKIT_LOADING_SERVICE||[];e&&Array.isArray(e)&&0<e.length&&e.forEach(function(e){e&&(e.clearAllLoadingTimers(),e.loadingCmp&&(e.loadingCmp.close(),e.loadingCmp=null))}),window.DEVKIT_LOADING_SERVICE=[]}},U.prototype.registerService=function(){var e=window.DEVKIT_LOADING_SERVICE||[];e.push(this),window.DEVKIT_LOADING_SERVICE=e},U.isSuspend=!1,U.decorators=[{type:B.Injectable}],U.ctorParameters=function(){return[{type:t.LoadingService},{type:_,decorators:[{type:B.Optional}]},{type:L.AppContext,decorators:[{type:B.Optional}]}]},U);function U(e,t,r){var i=this;this.loadingService=e,this.hideEventService=t,this.applicationContext=r,this.loadingTimerIds=[],t&&this.hideEventService.hideEvent.subscribe(function(e){i.hide()})}var H=function oo(){this.yes="Yes",this.no="No",this.unsaveNotifyTitle="Exist unsave record. Do save operation or not?",this.clientNotifyTitle="System Prompt In The Frontend",this.serverNotifyTitle="System Prompt In The Backend",this.cancelApproveSuccess="Cancel Approve Success",this.cancelApproveFailed="Cancel Approve Failed",this.unallowEmptyProcessInstanceName="Process Instance Name Can Not Be Empty",this.unallowEmptyBizBillId="Biz Bill Id Can Not Be Empty",this.unallowEmptyChildBizBillId="Child Biz Bill Id Can Not Be Empty",this.bizDefKeyRequired="Biz Def Key can't be empty.",this.procInsIdRequired="Process instance Id can't be empty.",this.addChildFailed="Add Child Failed",this.addSiblingFailed="Add Sibling Failed",this.addSubChildFailed="Add Sub Child Failed",this.addSubSiblingFailed="Add Sub Sibling Failed",this.deleteFailed="Delete Failed",this.multiSaveFailed="MultiSave Failed",this.appendFailed="Append Failed",this.queryFailed="Query Failed",this.cancelFailed="Cancel Failed",this.updateFailed="Update Failed",this.addFailed="Add Failed",this.loadFailed="Load Failed",this.saveSuccess="Successfully saved!",this.saveFailed="Save failed!",this.deleteSuccess="Successfully deleted!",this.deleteFaild="Failed to delete!",this.confirmDeletion="Confirm deletion?",this.submitSuccess="Submit successfully!",this.submitFaild="Submit failed!",this.notifyTitle="System prompt",this.httpError="HTTP request error! Please check the server error!",this.gridDataNotSave="The current page data is not saved. Turning the page will result in data loss. Do you want to continue turning the page?",this.exitWithoutSave="There is unsaved data. Do you want to continue closing?",this.notSupportMenuType="Not supported menu type!",this.cancelWithoutSave="Exist unsaved change,Confirm to cancel?",this.plsSelectDeleteData="Please select the data to delete!",this.errorHierarchyKey="Incorrect ierarchy key",this.plsSelectParentNode="Please select parent node!",this.deleteChildFirst="Please delete the child nodes first!",this.incorrectHierarchyConfig="Hierarchy config is incorrect!",this.operationFailed="The operation failed.",this.plsSelectEditData="Please select the data you want to edit!",this.plsSelectViewData="Please select the data you want to view!",this.plsUploadFirst="Please upload attachment first!",this.defaultDialogTitle="Dialog",this.changeToFirst="The first data.",this.changeToLast="The last data.",this.noProcessInstanceId="Please provide the process instance id.",this.noDataExist="Data does not exist to access the edit state!",this.noAttachment="There are no attachments to preview.",this.confirm="Confirm",this.cancel="Cancel",this.plsSelectCopyData="Please select the data you want to copy!",this.copyFieldsRequired="The copy fields can`t be empty!",this.pathIsRequired="The request url can`t be empty!",this.propsIsEmpty="The material has no props!",this.historyAttachment="The history attachment can`t be delete!",this.plsSelectDownloadAtt="Please select the attachment you want to download!",this.noDownloadAtt="There are no attachments to download!",this.plsCheckBatchEditRows="Please check the rows you want to edit!",this.plsSelectDetailFormData="Please select a detail form data first!",this.dataAndStateChanged="Are you sure you want to load the new data and switch to $1 state?",this.dataChanged="Are you sure you want to load the data and discards the current modification?",this.stateChanged="Are you sure you want to switch $1 state?",this.defaultStateName="init",this.copy="Copy detail message",this.copySuccess="Copy success",this.copyFailed="Copy failed",this.roger="Roger",this.appOrFuncIdRequired="No menu or application parameters are configured, please configure them in the designer.",this.tableCanNotEmpty="can not empty."},W=function ao(){this.yes="是",this.no="否",this.unsaveNotifyTitle="存在未保存记录。是否要保存？",this.clientNotifyTitle="前端异常提示",this.serverNotifyTitle="服务器端异常提示",this.cancelApproveSuccess="取消提交成功！",this.cancelApproveFailed="取消提交失败！",this.unallowEmptyProcessInstanceName="流程实例名称不能为空",this.unallowEmptyBizBillId="请选择一条数据",this.bizDefKeyRequired="入口单据不能为空",this.unallowEmptyChildBizBillId="从表业务单据编号不能为空！",this.procInsIdRequired="流程实例Id不能为空！",this.addChildFailed="新增子级失败",this.addSiblingFailed="新增同级失败",this.addSubChildFailed="新增从表子级失败",this.addSubSiblingFailed="新增从表同级失败",this.deleteFailed="删除失败",this.multiSaveFailed="批量保存失败",this.appendFailed="追加失败",this.queryFailed="查询失败",this.cancelFailed="取消失败",this.updateFailed="更新失败",this.addFailed="新增失败",this.loadFailed="加载失败",this.saveSuccess="保存成功！",this.saveFailed="保存失败！",this.deleteSuccess="删除成功！",this.deleteFaild="删除失败！",this.confirmDeletion="确认删除？",this.submitSuccess="提交审批成功！",this.submitFaild="提交审批失败！",this.notifyTitle="系统提示",this.httpError="HTTP请求错误！请检查Server端错误！",this.gridDataNotSave="当前页数据未保存，翻页将导致数据丢失，是否继续翻页？",this.exitWithoutSave="存在未保存的数据，是否继续关闭？",this.notSupportMenuType="关闭的既不是菜单也不是应用。",this.cancelWithoutSave="存在未保存的变更，确认取消？",this.plsSelectDeleteData="请选择要删除的数据！",this.errorHierarchyKey="错误的分级码",this.plsSelectParentNode="请选择父节点",this.deleteChildFirst="请先删除子节点",this.incorrectHierarchyConfig="分级码配置信息错误",this.operationFailed="操作执行失败。",this.plsSelectEditData="请选择要编辑的数据！",this.plsSelectViewData="请选择要查看的数据！",this.plsUploadFirst="请先上传附件！",this.defaultDialogTitle="弹窗",this.changeToFirst="已到达第一条数据",this.changeToLast="已到达最后一条数据",this.noProcessInstanceId="请指定流程实例标识。",this.noDataExist="要编辑的数据不存在，无法进入编辑状态！",this.noAttachment="没有可以预览的附件。",this.confirm="确定",this.cancel="取消",this.plsSelectCopyData="请选择要复制的数据！",this.copyFieldsRequired="要复制的字段不能为空！",this.pathIsRequired="请求路径不能为空！",this.propsIsEmpty="没有可以编辑的物料特征！",this.historyAttachment="历史版本附件禁止删除！",this.plsSelectDownloadAtt="请选择要下载的附件!",this.noDownloadAtt="找不到要下载的附件!",this.plsCheckBatchEditRows="请勾选要批量编辑的行！",this.plsSelectDetailFormData="请先选择一条从表数据！",this.dataAndStateChanged="确定要加载数据并切换到$1状态？",this.dataChanged="确定要加载数据并放弃当前修改？",this.stateChanged="确定要切换到$1状态？",this.defaultStateName="初始",this.copy="复制详细信息",this.copySuccess="复制成功",this.copyFailed="复制失败",this.roger="知道了",this.appOrFuncIdRequired="未配置菜单或应用参数，请在设计器中配置。",this.tableCanNotEmpty="不能为空。"},K=function so(){this.yes="是",this.no="否",this.unsaveNotifyTitle="存在未保存記錄。是否要保存？",this.clientNotifyTitle="前端異常提示",this.serverNotifyTitle="服務器端異常提示",this.cancelApproveSuccess="取消提交成功！",this.cancelApproveFailed="取消提交失敗！",this.unallowEmptyProcessInstanceName="流程實例名稱不能為空",this.unallowEmptyBizBillId="請選擇壹條數據",this.bizDefKeyRequired="入口單據不能為空",this.unallowEmptyChildBizBillId="從表業務單據編號不能為空！",this.procInsIdRequired="流程實例id不能為空！",this.addChildFailed="新增子級失敗",this.addSiblingFailed="新增同級失敗",this.addSubChildFailed="新增從表子級失敗",this.addSubSiblingFailed="新增從表同級失敗",this.deleteFailed="刪除失敗",this.multiSaveFailed="批量保存失敗",this.appendFailed="追加失敗",this.queryFailed="查詢失敗",this.cancelFailed="取消失敗",this.updateFailed="更新失敗",this.addFailed="新增失敗",this.loadFailed="加載失敗",this.saveSuccess="保存成功！",this.saveFailed="保存失敗！",this.deleteSuccess="刪除成功！",this.deleteFaild="刪除失敗！",this.confirmDeletion="確認刪除？",this.submitSuccess="提交審批成功！",this.submitFaild="提交審批失敗！",this.notifyTitle="系統提示",this.httpError="HTTP請求錯誤！請檢查Server端錯誤！",this.gridDataNotSave="當前頁數據未保存，翻頁將導致數據丟失，是否繼續翻頁？",this.exitWithoutSave="存在未保存的數據，是否繼續關閉？",this.notSupportMenuType="關閉的既不是菜單也不是應用。",this.cancelWithoutSave="存在未保存的變更，確認取消？",this.plsSelectDeleteData="請選擇要刪除的數據！",this.errorHierarchyKey="錯誤的分級碼",this.plsSelectParentNode="請選擇父節點",this.deleteChildFirst="請先刪除子節點",this.incorrectHierarchyConfig="分級碼配置信息錯誤",this.operationFailed="操作執行失敗。",this.plsSelectEditData="請選擇要編輯的數據！",this.plsSelectViewData="請選擇要查看的數據！",this.plsUploadFirst="請先上傳附件！",this.defaultDialogTitle="彈窗",this.changeToFirst="已到達第壹條數據",this.changeToLast="已到達最後壹條數據",this.noProcessInstanceId="請指定流程實例標識。",this.noDataExist="要編輯的數據不存在，無法進入編輯狀態！",this.noAttachment="沒有可以預覽的附件。",this.confirm="確定",this.cancel="取消",this.plsSelectCopyData="請選擇要復制的數據！",this.copyFieldsRequired="要復制的字段不能為空！",this.pathIsRequired="請求路径不能為空！",this.propsIsEmpty="沒有可以編輯的物料特征！",this.historyAttachment="曆史版本附件禁止刪除！",this.plsSelectDownloadAtt="請選擇要下載的附件!",this.noDownloadAtt="找不到要下載的附件！",this.plsCheckBatchEditRows="請勾選要批量編輯的行！",this.plsSelectDetailFormData="請先選擇一條從表數據！",this.dataAndStateChanged="確定要加載數據並切換到$1狀態？",this.dataChanged="確定要加載數據並放棄當前修改？",this.stateChanged="確定要切換到$1狀態？",this.defaultStateName="初始",this.copy="復制詳細信息",this.copySuccess="復制成功",this.copyFailed="復制失敗",this.roger="知道了",this.appOrFuncIdRequired="未配置菜單或應用參數，請在設計器中配置。",this.tableCanNotEmpty="不能為空。"},z=(J.create=function(e){if(!0===this.languageMessageMap.has(e))return this.languageMessageMap.get(e);var t;switch(e){case"zh-CHS":t=new W;break;case"en":t=new H;break;case"zh-CHT":t=new K;break;default:t=new W}return this.languageMessageMap.set(e,t),t},J.languageMessageMap=new Map,J);function J(){}var Y=(Object.defineProperty(G.prototype,"languageMessage",{get:function(){return z.create(this.language)},enumerable:!0,configurable:!0}),G.getInstance=function(){if(this.innerInstance)return this.innerInstance;var e=new G("zh-CHS");return G.innerInstance=e},G.prototype.extendProperties=function(){var t=this;Object.keys(this.languageMessage).forEach(function(e){Object.defineProperty(t,e,{get:function(){return t.languageMessage[e]}})})},G.innerInstance=null,G.decorators=[{type:B.Injectable}],G.ctorParameters=function(){return[{type:String,decorators:[{type:B.Optional},{type:B.Inject,args:[B.LOCALE_ID]}]}]},G);function G(e){this.language="zh-CHS",this.language=e||"zh-CHS",this.extendProperties(),G.innerInstance=this}var $=function(e,t){return($=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function Q(e,t){function r(){this.constructor=e}$(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var X=function(){return(X=Object.assign||function(e){for(var t,r=1,i=arguments.length;r<i;r++)for(var n in t=arguments[r])Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}).apply(this,arguments)};function Z(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function ee(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var i,n,o=r.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(i=o.next()).done;)a.push(i.value)}catch(s){n={error:s}}finally{try{i&&!i.done&&(r=o["return"])&&r.call(o)}finally{if(n)throw n.error}}return a}function te(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(ee(arguments[t]));return e}var re=(ie.copyToClipboard=function(e){var t=window;if(t.clipboardData&&t.clipboardData.setData)return t.clipboardData.setData("Text",e);if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var r=document.createElement("textarea");r.textContent=e,r.style.position="fixed",document.body.appendChild(r),r.select();try{return document.execCommand("copy")}catch(i){}finally{document.body.removeChild(r)}}return!1},ie);function ie(){}var ne=(oe.ctorParameters=function(){return[{type:r.MessagerService},{type:Y,decorators:[{type:B.Optional}]}]},oe);function oe(e,t){this.messagerService=e,this.languageService=t}var ae,se=(Q(ce,ae=ne),ce.prototype.handleException=function(e){e&&this.messagerService.info(e.Message)},ce.ctorParameters=function(){return[{type:r.MessagerService},{type:Y,decorators:[{type:B.Optional}]}]},ce);function ce(e,t){return ae.call(this,e,t)||this}var ue,le=(Q(pe,ue=ne),pe.prototype.handleException=function(e){e&&this.messagerService.warning(e.Message)},pe.ctorParameters=function(){return[{type:r.MessagerService},{type:Y,decorators:[{type:B.Optional}]}]},pe);function pe(e,t){return ue.call(this,e,t)||this}var de,fe=(Q(he,de=ne),he.prototype.handleException=function(e){e&&this.handleErrorLevel(e)},he.prototype.handleErrorLevel=function(e){var r,i=this,t=e.Message||"",n=e.date||new Date,o=E(n).format("YYYY-MM-DD HH:mm:ss"),a=e.Detail||e.Message+"\r\n发生时间："+o+"\r\n详细信息："+e.innerMessage||"",s=e.innerMessage||null,c={showMaxButton:!1,buttons:[{text:this.langService.roger,cls:"btn btn-primary btn-lg",handle:function(){r.close()}}],width:440,height:200,safeHtml:!1,exception:{date:o,message:s,copyButton:{text:this.langService.copy,onClick:function(e){var t=re.copyToClipboard(a)?i.langService.copySuccess:i.langService.copyFailed;r.content.showMiniNotify(t,1500)}}}};this.displayError(e),r=this.messagerService.show("exception",t,c)},he.prototype.displayError=function(e){e&&console&&console.error&&console.error(e)},he.ctorParameters=function(){return[{type:r.MessagerService},{type:Y,decorators:[{type:B.Optional}]}]},he);function he(e,t){var r=de.call(this,e,t)||this;return r.langService=null,r.langService=t,r.langService||(r.langService=new Y),r}var ge,ve=(Q(ye,ge=ne),ye.prototype.handleException=function(e){e&&this.messagerService.error(e.Message)},ye.ctorParameters=function(){return[{type:r.MessagerService},{type:Y,decorators:[{type:B.Optional}]}]},ye);function ye(e,t){return ge.call(this,e,t)||this}var me,Se,Ce=(be.getInstance=function(e,t){return this.exceptionFactory||(this.exceptionFactory=new be(e,t)),this.exceptionFactory},be.prototype.getExceptionHandleStrategy=function(e){var t;switch(e){case 0:t=new se(this.messagerService,this.languageService);break;case 1:t=new le(this.messagerService,this.languageService);break;case 2:t=new fe(this.messagerService,this.languageService);break;case 3:t=new ve(this.messagerService,this.languageService);break;default:t=new fe(this.messagerService,this.languageService)}return t},be.exceptionFactory=null,be.decorators=[{type:B.Injectable}],be.ctorParameters=function(){return[{type:r.MessagerService},{type:Y,decorators:[{type:B.Optional}]}]},be);function be(e,t){this.messagerService=e,this.languageService=t}(Se=me=me||{})[Se.Info=1]="Info",Se[Se.Success=2]="Success",Se[Se.Redirect=3]="Redirect",Se[Se.ClientError=4]="ClientError",Se[Se.ServerError=5]="ServerError";var Ie=(we.getHttpStatusType=function(e){if(!e)return null;var t=null;return e<100||600<e?t=null:100<=e&&e<200?t=me.Info:200<=e&&e<300?t=me.Success:300<=e&&e<400?t=me.Redirect:400<=e&&e<500?t=me.ClientError:500<=e&&e<600&&(t=me.ServerError),t},we);function we(){}var xe=(Ee.prototype.exception=function(e,t){t&&t.hasOwnProperty("expired")&&!0===t.expired||(t&&this.isHttpErrorResponse(t)?this.httpErrorHandler(t):this.commonErrorHandler(e))},Ee.prototype.httpErrorHandler=function(e){if(e)switch(Ie.getHttpStatusType(e.status)){case me.ClientError:if(401===e.status){this.msgService.http401Error(e);break}this.msgService.httpErrorInClient(e);break;case me.ServerError:this.msgService.httpErrorInServer(e);break;default:throw new Error("Get invalid status code when using httpErrorHandler method.")}},Ee.prototype.commonErrorHandler=function(e){e&&this.msgService.error(e)},Ee.prototype.isHttpErrorResponse=function(e){return!!e&&"object"==typeof e&&(!("HttpErrorResponse"!==e.name||!e.hasOwnProperty("status")||!e.hasOwnProperty("error"))||e instanceof x.HttpErrorResponse)},Ee.decorators=[{type:B.Injectable}],Ee.ctorParameters=function(){return[{type:Pe},{type:Y,decorators:[{type:B.Optional}]}]},Ee);function Ee(e,t){this.msgService=e,this.languageService=t}var Pe=(Fe.prototype.question=function(e){var t=this.confirmPromise(e);return T.from(t)},Fe.prototype.question2=function(i){var n=this,e=new Promise(function(e,t){var r=n.messagerService.question2(i,[{text:n.languageService.no,cls:"btn btn-secondary",handle:function(){e(!1),r.close()}},{text:n.languageService.yes,cls:"btn btn-primary",defaultFocus:!0,handle:function(){e(!0),r.close()}}])});return T.from(e)},Fe.prototype.prompt=function(e){return this.messagerService.prompt(e)},Fe.prototype.confirmPromise=function(r){var i=this;return new Promise(function(e,t){i.messagerService.question(r,function(){e(!0)},function(){e(!1)})})},Fe.prototype.confirm=function(e){return this.messagerService.confirm(e)},Fe.prototype.info=function(e){this.messagerService.info(e)},Fe.prototype.error=function(e){this.messagerService.error(e)},Fe.prototype.warning=function(e){this.messagerService.warning(e)},Fe.prototype.httpErrorInServer=function(e){var t=e.error;if("string"==typeof t)try{t=JSON.parse(t)}catch(r){}t&&null!=t.Level&&t.Level!=undefined?Ce.getInstance(this.messagerService,this.languageService).getExceptionHandleStrategy(t.Level).handleException(t):this.messagerService.error(e.message)},Fe.prototype.httpErrorInClient=function(e){if(e){var t=e.error&&e.error.error&&e.error.error.message||e.message&&e.message.replace(/http:\/\/[a-zA-Z0-9.:]{1,}/,"");this.messagerService.show("error",t,{showHeader:!1,width:400,height:200,safeHtml:!1})}},Fe.prototype.http401Error=function(t){var r="401ErrorShownFlag";if(t&&!window[r]){var e={en:{title:"Warning",sessionInvalid:"Your login has expired, please login again.",ok:"ok",cancel:"cancel"},"zh-CHS":{title:"提示",sessionInvalid:"用户登录信息已失效，是否重新登录?",ok:"确认",cancel:"取消"}};this.curLanguage=this.curLanguage||"zh-CHS";var i={title:e[this.curLanguage].title,initialState:{okText:e[this.curLanguage].ok,okHandle:function(){n.close(),window[r]=!1;var e=(t&&t.error||{}).redirect_uri||"/login.html";window.location.href="/logout.html#?logout-before-redirect=true&loginUri="+e},cancelText:e[this.curLanguage].cancel,cancelHandle:function(){n.close(),window[r]=!1}},showHeader:!0,width:420,height:180,fitContent:!1},n=this.messagerService.show("question",e[this.curLanguage].sessionInvalid,i);window[r]=!0,n&&n.dialog&&n.dialog.instance.closed&&n.dialog.instance.closed.subscribe(function(){window[r]=!1})}},Fe.decorators=[{type:B.Injectable}],Fe.ctorParameters=function(){return[{type:r.MessagerService},{type:Y,decorators:[{type:B.Optional}]},{type:String,decorators:[{type:B.Inject,args:[B.LOCALE_ID]}]}]},Fe);function Fe(e,t,r){this.messagerService=e,this.languageService=t,this.curLanguage=r,this.languageService=this.languageService||Y.getInstance()}var De=(Me.prototype["default"]=function(e){return this.notifyService["default"]({title:this.languageService.notifyTitle,msg:e,timeout:3e3})},Me.prototype.info=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};return t&&t.hideTitle&&delete r.title,this.notifyService.info(r)},Me.prototype.success=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};t&&t.hideTitle&&delete r.title,this.notifyService.success(r)},Me.prototype.warning=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};t&&t.hideTitle&&delete r.title,this.notifyService.warning(r)},Me.prototype.error=function(e,t){var r={title:this.languageService.notifyTitle,msg:e,timeout:3e3};t&&t.hideTitle&&delete r.title,this.notifyService.error(r)},Me.decorators=[{type:B.Injectable}],Me.ctorParameters=function(){return[{type:i.NotifyService},{type:Y,decorators:[{type:B.Optional}]}]},Me);function Me(e,t){this.notifyService=e,(this.languageService=t)||(this.languageService=Y.getInstance())}var Te=(Re.prototype.preStep=function(){var e=this.wizardSer.getCurrentPageId();this.wizardSer.updateWizardState(n.WizardEventType.Prev,e)},Re.prototype.nextStep=function(){var e=this.wizardSer.getCurrentPageId();this.wizardSer.updateWizardState(n.WizardEventType.Next,e)},Re.prototype.cancelWizard=function(){this.wizardSer.cancelWizard()},Re.prototype.finishWizard=function(){this.wizardSer.finishWizard()},Re.decorators=[{type:B.Injectable}],Re.ctorParameters=function(){return[{type:n.WizardService}]},Re);function Re(e){this.wizardSer=e}var Oe=(Ne.prototype.checkEmpty=function(e){return!!e},Ne.decorators=[{type:B.Injectable}],Ne.ctorParameters=function(){return[]},Ne);function Ne(){}var Ae=(je.prototype.checkBeforeEdit=function(e){return!0===this.ifSkipCheck(e)||!!e||(this.formNotifyService.warning(this.languageService.plsSelectEditData,{hideTitle:!0}),T.empty())},je.prototype.checkBeforeView=function(e){return!0===this.ifSkipCheck(e)||!!e||(this.formNotifyService.warning(this.languageService.plsSelectViewData,{hideTitle:!0}),T.empty())},je.prototype.ifSkipCheck=function(e){var t=this.context.command.params;return!1===t.hasOwnProperty("idToEdit")&&!1===t.hasOwnProperty("idToView")||""===e},je.decorators=[{type:B.Injectable}],je.ctorParameters=function(){return[{type:Pe},{type:De},{type:Y,decorators:[{type:B.Optional}]}]},je);function je(e,t,r){this.messageService=e,this.formNotifyService=t,this.languageService=r,this.languageService||(this.languageService=Y.getInstance())}var Be=(Le.prototype.trigger=function(e,t,r){this.eventBus.trigger(e,t,r)},Le.decorators=[{type:B.Injectable}],Le.ctorParameters=function(){return[{type:L.FrameEventBus}]},Le);function Le(e){this.eventBus=e}var Ve=(_e.prototype.getState=function(){var e=!!sessionStorage&&sessionStorage.getItem(this.COMMAND_SERVICE_LINK_STORAGE_KEY)||null;return e?JSON.parse(e):{}},_e.prototype.setState=function(e){sessionStorage&&sessionStorage.setItem(this.COMMAND_SERVICE_LINK_STORAGE_KEY,JSON.stringify(e))},_e.prototype.addMenuState=function(e,t,r){if(void 0===r&&(r=!0),t){var i=this.getState(),n=!!i&&i.hasOwnProperty(e),o={id:t,status:r};n?i[e].find(function(e){return e.id===t})||i[e].push(o):i[e]=[o],this.setState(i)}},_e.prototype.getMenuState=function(e,t){var r=this.getState();if(null===r)return null;if(!r.hasOwnProperty(e))return null;var i=r[e],n=i.filter(function(e){return!0===e.status});return void 0===t||t.length<1?n:i.filter(function(e){return e.status&&e.id===t})},_e.prototype.updateMenuState=function(r,i){var n=this.getState();null!==n&&(Object.keys(n).forEach(function(e){var t=n[e].find(function(e){return e.id===r});t&&(t.status=i)}),this.setState(n))},_e.prototype.removeMenu=function(e){this.removeParentMenu(e),this.removeChildMenu(e)},_e.prototype.removeParentMenu=function(t){var r=this.getState();if(null===r)return null;Object.keys(r).forEach(function(e){e===t&&r[t].length<1&&delete r[e]}),this.setState(r)},_e.prototype.removeChildMenu=function(i){var t=this.getState();null!==t&&(Object.keys(t).forEach(function(e){var r=t[e];r&&0<r.length&&r.forEach(function(e,t){e.id===i&&r.splice(t,1)})}),this.setState(t))},_e.decorators=[{type:B.Injectable}],_e);function _e(){this.COMMAND_SERVICE_LINK_STORAGE_KEY="COMMAND_SERVICE_LINK_STORAGE_KEY"}var ke=(qe.prototype.route=function(e,t){e=this.router.createUrlTree([e]).toString(),this.setParams(e,t),this.router.navigateByUrl(e)},qe.prototype.registerEvent=function(){var i=this,e=this.getParams(window.location.hash),n=this.getAppId()||this.getFuncId();this.frameworkService.eventListner(this.frameworkService.FuncSwitch,function(e){if(e){var t=i.getOriginalId(e.id)||e.tabId,r=i.menuStateService.getMenuState(t);t&&n===t&&r&&0<r.length&&(i.formReload(),i.lastSwitchId=t)}},e),this.frameworkService.eventListner(this.frameworkService.FuncClosed,function(e){if(e){i.onClosed.next(e);var t=i.getOriginalId(e.id)||e.tabId;if(n!==t){var r=i.menuStateService.getMenuState(n,t);t&&r&&0<r.length&&(i.removeMenuState(t),i.formReload(),i.lastCloseId=t)}}},e)},qe.prototype.removeMenuState=function(e){this.context&&this.menuStateService.removeMenu(e)},qe.prototype.getOriginalId=function(e){return e&&-1!==e.indexOf("_")&&(e=e.split("_")[0]),e},qe.prototype.formReload=function(){try{this.context.frameContext.appContext.refresh()}catch(e){}},qe.prototype.openMenu=function(e,t,r){void 0!==r&&"boolean"==typeof r||(r=!1);var i=this.buildParamMap(t),n=this.getFuncId()||this.getAppId();this.menuStateService.addMenuState(n,e),i.set("WEB_FORM_ROUTER_PARENT_ID",n),this.frameworkService.openFuncWithParam(e,i,r)},qe.prototype.openApp=function(e,t,r,i){void 0!==i&&"boolean"==typeof i||(i=!1);var n=this.buildParamMap(r),o=this.getAppId()||this.getFuncId();this.menuStateService.addMenuState(o,e),n.set("WEB_FORM_ROUTER_PARENT_ID",o),this.appService&&this.appService.openApp(e,t,n,i)},qe.prototype.buildParamMap=function(e){(null==e||"string"==typeof e&&e.length<1)&&(e={});var t=new Map;return"object"==typeof e&&(e=JSON.stringify(e)),e=window.encodeURIComponent(e),t.set("WEB_FORM_ROUTE_PARAMS",e),t},qe.prototype.closeMenu=function(){var e=this.getFuncId(),t=this.getAppId(),r=this.findDialog(),i=r.isDialogComponent,n=r.rootComponent;if(i)this.get(n,"dialogRef").close();else if(null!==e&&"string"==typeof e&&0<e.length)this.closeFunc(e);else if(null!==t&&"string"==typeof t&&0<t.length){var o=this.getAppEntrance();this.closeApp(t,o)}else console.error(this.languageService.notSupportMenuType)},qe.prototype.findDialog=function(){for(var e=this.get(this,"context.frameContext"),t=this.get(e,"frameComponent.isDialogRootComponent",!1),r=this.get(e,"parent");null!=r&&!t;)e=this.get(e,"parent"),r=this.get(r,"parent"),t=this.get(e,"frameComponent.isDialogRootComponent",!1);return{isDialogComponent:t,rootComponent:this.get(e,"frameComponent")}},qe.prototype.get=function(e,t,r){void 0===r&&(r=null);var i=Array.isArray(t)?t:t.split(".").filter(function(e){return e.length});return i.length?null===e||e===undefined||"undefined"==typeof e[i[0]]?r:this.get(e[i.shift()],i,r):e===undefined?r:e},qe.prototype.closeFunc=function(e){e=e||this.getFuncId(),this.frameworkService&&this.frameworkService.closeFunc(e).subscribe()},qe.prototype.closeApp=function(e,t){e=e||this.getAppId(),void 0===t&&(t=this.getAppEntrance()),this.appService&&this.appService.closeApp(e,t).subscribe()},qe.prototype.setParams=function(e,t){var r;r="string"==typeof t&&""!==t?JSON.parse(t):t||{},this.routerParamService.setParams(e,r)},qe.prototype.getFuncId=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("funcId")?t.funcId:null},qe.prototype.getAppId=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("appId")?t.appId:null},qe.prototype.getParentMenuId=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("WEB_FORM_ROUTER_PARENT_ID")?t.WEB_FORM_ROUTER_PARENT_ID:null},qe.prototype.getAppEntrance=function(){var e=window.location.hash;if(!e)return null;var t=this.decodeURLParams(e);return t&&t.hasOwnProperty("appEntrance")?t.appEntrance:null},qe.prototype.decodeURLParams=function(e){return void 0===e&&(e=window.location.hash||window.location.search),e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var r,i=t.indexOf("="),n=t.slice(0,i),o=t.slice(i+1);return Object.assign(e,((r={})[n]=decodeURIComponent(o),r))},{})},qe.prototype.getParams=function(e){return e?e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var r,i=t.indexOf("="),n=t.slice(0,i),o=t.slice(i+1);return Object.assign(e,((r={})[n]=decodeURIComponent(o),r))},{}):{}},qe.decorators=[{type:B.Injectable}],qe.ctorParameters=function(){return[{type:a.Router},{type:L.RouterParamService},{type:S.FrameworkService},{type:S.AppService,decorators:[{type:B.Optional}]},{type:Ve,decorators:[{type:B.Optional}]},{type:Y,decorators:[{type:B.Optional}]}]},qe);function qe(e,t,r,i,n,o){this.router=e,this.routerParamService=t,this.frameworkService=r,this.appService=i,this.menuStateService=n,this.languageService=o,this.lastSwitchId=null,this.lastCloseId=null,this.onClosed=null,this.menuStateService||(this.menuStateService=new Ve),this.languageService||(this.languageService=Y.getInstance()),this.onClosed=new T.Subject,this.registerEvent()}var Ue={onTabClosed:"FuncClosed",onTabClosing:"beforeFuncCloseEvent",onTabSwitched:"funcSwitchEvent"},He=(We.prototype.parse=function(e){return e?e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var r,i=t.indexOf("="),n=t.slice(0,i),o=t.slice(i+1);return Object.assign(e,((r={})[n]=decodeURIComponent(o),r))},{}):{}},We.decorators=[{type:B.Injectable}],We);function We(){}var Ke=(ze.prototype.getService=function(){for(var e=window;!e.gspframeworkService&&e!==window.top&&this.isSameOrigin(e);)e=e.parent;return e.gspframeworkService&&e.gspframeworkService.rtf||{}},ze.prototype.openMenu=function(e){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.openMenu&&this.rtfService.func.openMenu(e)},ze.prototype.openMenu$=function(e){return this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.openMenuByStream?this.rtfService.func.openMenuByStream(e):T.EMPTY},ze.prototype.getEntityParam=function(e,t,r){void 0===r&&(r=!0),this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.getEntityParam&&this.rtfService.func.getEntityParam(e,t,r)},ze.prototype.beforeCloseMenu=function(e){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.beforeClose&&this.rtfService.func.beforeClose(e)},ze.prototype.closeMenu=function(e){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.close&&this.rtfService.func.close(e)},ze.prototype.getMenuParams=function(e,t){this.rtfService&&this.rtfService.hasOwnProperty("func")&&"function"==typeof this.rtfService.func.getMenuParams&&this.rtfService.func.getMenuParams(e,t)},ze.prototype.addEventListener=function(e,t,r){this.rtfService&&this.rtfService.hasOwnProperty("frmEvent")&&"function"==typeof this.rtfService.frmEvent.eventListener&&this.rtfService.frmEvent.eventListener(e,t,r)},ze.prototype.getMenuSwitchControlEvent=function(){var r=new T.Subject,e=this.rtfService&&this.rtfService.frmEvent||null;if(e){var i=this.tabId,t=this.params;window.setTimeout(function(){e.eventListener(i,function(e){var t=e&&e.menuSwitchControl||null;t&&t.key===i?r.next(t.value):r.next(null)},t)},0)}return r},Object.defineProperty(ze.prototype,"params",{get:function(){return this.rtfService&&this.rtfService.hasOwnProperty("session")&&"function"==typeof this.rtfService.session.getCommonVariable?this.rtfService.session.getCommonVariable():null},enumerable:!0,configurable:!0}),Object.defineProperty(ze.prototype,"tabId",{get:function(){return this.params&&this.params.tabId||null},enumerable:!0,configurable:!0}),Object.defineProperty(ze.prototype,"formToken",{get:function(){return this.params&&this.params.formToken||null},enumerable:!0,configurable:!0}),Object.defineProperty(ze.prototype,"funcId",{get:function(){return this.params&&this.params.funcId||null},enumerable:!0,configurable:!0}),ze.prototype.subjectRegister=function(e,t,r){return this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.subjectRegister?this.rtfService.broadcast.subjectRegister(e,t,r):null},ze.prototype.subjectRemove=function(e){this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.subjectRemove&&this.rtfService.broadcast.subjectRemove(e)},ze.prototype.subjectNotify=function(e,t){this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.notify&&this.rtfService.broadcast.notify(e,t)},ze.prototype.subjectResponse=function(e,t,r){if(this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.response){var i=r;return(void 0===r||!r||r.length<1)&&(i=L.UID.create()),this.rtfService.broadcast.response(e,i,t),i}return null},ze.prototype.responseUnSubscribe=function(e,t){this.rtfService&&this.rtfService.hasOwnProperty("broadcast")&&"function"==typeof this.rtfService.broadcast.responseUnSubscribe&&this.rtfService.broadcast.responseUnSubscribe(e,t)},ze.prototype.isSameOrigin=function(e){var t=window.location.host;try{if(e&&e.location&&"undefined"!=typeof e.location.host)return e.location.host===t}catch(r){return!1}return!1},ze.decorators=[{type:B.Injectable}],ze.ctorParameters=function(){return[]},ze);function ze(){this.rtfService=this.getService()}var Je=(Object.defineProperty(Ye.prototype,"querystrings",{get:function(){var e=this.querystringService.parse(window.location.hash);return e&&(e.formToken=this.runtimeFrameworkService.formToken),e},enumerable:!0,configurable:!0}),Ye.prototype.registerEvent=function(){var t=this,e=this.querystrings;this.params=e,this.runtimeFrameworkService.addEventListener(Ue.onTabSwitched,function(e){return t.handleTabSwitchEvent(e)},e),this.runtimeFrameworkService.addEventListener(Ue.onTabClosed,function(e){return t.handleTabClosedEvent(e)},e),this.runtimeFrameworkService.addEventListener(Ue.onTabClosing,function(e){return t.handleTabClosingEvent(e)},e)},Ye.prototype.handleTabSwitchEvent=function(e){if(e){var t=e.tabId||e.id||null;if(t){var r=this.params,i=r.tabId||r.funcId||r.appId,n=this.menuStateService.getMenuState(t);i&&i===t&&n&&0<n.length&&this.formReload(),this.fireTabSwitchEvent(e)}}},Ye.prototype.fireTabSwitchEvent=function(i){!this.onTabSwitchListeners||this.onTabSwitchListeners.size<1||this.onTabSwitchListeners.forEach(function(e,t,r){"function"==typeof e&&e(i)})},Ye.prototype.handleTabClosingEvent=function(r){var i=this;if(r){var n=r.tabId||r.id||null,o=this.params,e=o.tabId||o.funcId||o.appId;n&&e&&e===n&&this.fireTabClosingEvent(r).subscribe(function(e){if(e){setTimeout(function(){return i.removeMenuState(n)},500);var t=window.formEventServices;t.has(n)&&(t["delete"](n),window.formEventServices=t),r&&r.hasOwnProperty("token")||(r=Object.assign({},r,{token:o.formToken})),i.frameContext&&i.frameContext.appContext&&i.frameContext.appContext.dispose(),i.runtimeFrameworkService.closeMenu(r)}})}},Ye.prototype.fireTabClosingEvent=function(t){if(!this.onClosingListeners||this.onClosingListeners.size<1)return T.of(!0);var e=this.onClosingListeners.values(),r=T.from(e),i=!1;return r.pipe(R.concatMap(function(e){return i?T.EMPTY:e(t).pipe(R.take(1),R.tap(function(e){return i=!e}),R.switchMap(function(e){return T.of(e)}))}),R.every(function(e){return e}))},Ye.prototype.handleTabClosedEvent=function(e){if(e){var t=this.params,r=t.tabId||t.funcId||t.appId,i=e.tabId||e.id||null;if(r!==i){var n=this.menuStateService.getMenuState(r,i);i&&n&&0<n.length&&(this.removeMenuState(i),this.formReload()),this.fireTabClosedEvent(e)}}},Ye.prototype.removeMenuState=function(e){this.context&&this.menuStateService.removeMenu(e)},Ye.prototype.fireTabClosedEvent=function(i){!this.onClosedListeners||this.onClosedListeners.size<1||this.onClosedListeners.forEach(function(e,t,r){"function"==typeof e&&e(i)})},Ye.prototype.addEventListener=function(e,t){var r=L.UID.create();return e===Ue.onTabClosed?(this.onClosedListeners.set(r,t),r):e===Ue.onTabClosing?(this.onClosingListeners.set(r,t),r):e===Ue.onTabSwitched?(this.onTabSwitchListeners.set(r,t),r):null},Ye.prototype.removeEventListener=function(e,t){return e===Ue.onTabClosed?this.onClosedListeners["delete"](t):e===Ue.onTabClosing&&this.onClosingListeners["delete"](t)},Ye.prototype.clearEventListener=function(e){e===Ue.onTabClosed?this.onClosedListeners.clear():e===Ue.onTabClosing&&this.onClosingListeners.clear()},Ye.prototype.formReload=function(){try{this.context.frameContext.appContext.refresh()}catch(e){}},Ye.decorators=[{type:B.Injectable}],Ye.ctorParameters=function(){return[{type:Ke},{type:Ve},{type:He}]},Ye);function Ye(e,t,r){this.runtimeFrameworkService=e,this.menuStateService=t,this.querystringService=r,this.onClosedListeners=new Map,this.onClosingListeners=new Map,this.onTabSwitchListeners=new Map}var Ge=new B.InjectionToken("表单弹出窗口或隐藏组件列表"),$e=(Qe.prototype.append=function(e,t){this.controls[e]=t},Qe.prototype.getControls=function(e){return this.controls[e]?this.controls[e]:(console.warn("未找到Key为"+e+"的组件！"),null)},Qe.decorators=[{type:B.Injectable}],Qe.ctorParameters=function(){return[{type:undefined,decorators:[{type:B.Optional},{type:B.Inject,args:[Ge]}]}]},Qe);function Qe(e){void 0===e&&(e={}),this.controls={},e=e||{},this.controls=X({},e)}var Xe="DEVKIT_APP_CONTEXT_MANAGER",Ze=(Object.defineProperty(et.prototype,"context",{set:function(e){this.navigationEventService.context=e,this.commandContext=e},enumerable:!0,configurable:!0}),Object.defineProperty(et.prototype,"formAppContext",{get:function(){if(this.frameContext){for(var e=this.frameContext.appContext;e&&e.parent&&e.parent.injector&&null!==e.parent.injector.get(L.FrameContext,null);)e=e.parent;return e}return null},enumerable:!0,configurable:!0}),Object.defineProperty(et.prototype,"querystrings",{get:function(){var e=window.location.hash,t=this.formAppContext&&this.formAppContext.ApplicationId;if(t){var r=window[Xe],i=r&&r.get(t);e=i&&i.hash||e}var n=this.querystringService.parse(e);return n&&(n.formToken=this.runtimeFrameworkService.formToken),n},enumerable:!0,configurable:!0}),Object.defineProperty(et.prototype,"formNotifyService",{get:function(){return this.injector&&this.injector.get(De,null)},enumerable:!0,configurable:!0}),et.prototype.registerDestroyEvent=function(r){var e=this;this.frameContext&&this.frameContext.destorySignal&&this.frameContext.destorySignal.subscribe(function(){e.navigationEventService=null}),this.frameContext&&this.frameContext.appContext&&this.frameContext.appContext.destorySignal&&this.frameContext.appContext.destorySignal.subscribe(function(){var e=window.formEventServices;e&&e["delete"](r);var t=window[Xe];t&&t["delete"](r)})},et.prototype.openMenu=function(e,t,r,i,n,o,a){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),T.EMPTY;o=o&&this.translate(o);var s=this.buildParamMap(r);!0===(a=this.convertToBoolean(a,!1))&&(s=this.buildParam(r));var c=this.buildParamMap(r),u=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,l={tabId:e,funcId:t,appType:S.AppType.Menu,queryStringParams:s,entityParams:c,appId:undefined,appEntrance:undefined,isReload:i,tabName:o||null};!0===(n=this.convertToBoolean(n,!0))&&this.menuStateService.addMenuState(u,e),this.runtimeFrameworkService.openMenu(l)},et.prototype.openMenu$=function(e,t,r,i,n,o,a){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),T.EMPTY;o=o&&this.translate(o);var s=this.buildParamMap(r);!0===(a=this.convertToBoolean(a,!1))&&(s=this.buildParam(r));var c=this.buildParamMap(r),u=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,l={tabId:e,funcId:t,appType:S.AppType.Menu,queryStringParams:s,entityParams:c,appId:undefined,appEntrance:undefined,isReload:i,tabName:o||null};return!0===(n=this.convertToBoolean(n,!0))&&this.menuStateService.addMenuState(u,e),this.runtimeFrameworkService.openMenu$(l)},et.prototype.openMenuWithDimension=function(e,t,r,i,n,o,a,s,c){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),T.EMPTY;a=a&&this.translate(a),s!==undefined&&null!==s||(s="");var u=this.buildParamMap(r);!0===(c=this.convertToBoolean(c,!1))&&(u=this.buildParam(r));var l=this.buildParamMap(r);u.set("dim1",n||"public"),u.set("dim2",o||"public"),u.set("metadataId",s),u.set("isRtc","1"),u.set("isRootMetadata","true");var p=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,d={tabId:e,funcId:t,appType:S.AppType.Menu,queryStringParams:u,entityParams:l,appId:undefined,appEntrance:undefined,isReload:!1,tabName:a||null};!0===(i=this.convertToBoolean(i,!0))&&this.menuStateService.addMenuState(p,e),this.runtimeFrameworkService.openMenu(d)},et.prototype.openApp=function(e,t,r,i,n,o,a,s){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),T.EMPTY;o=o&&this.translate(o);var c=this.buildParamMap(i);!0===(s=this.convertToBoolean(s,!1))&&(c=this.buildParam(i));var u=this.buildParamMap(i),l=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,p={tabId:e,appId:t,appEntrance:r,funcId:undefined,appType:S.AppType.App,queryStringParams:c,entityParams:u,isReload:n,tabName:o||null};!0===(a=this.convertToBoolean(a,!0))&&this.menuStateService.addMenuState(l,e),this.runtimeFrameworkService.openMenu(p)},et.prototype.openApp$=function(e,t,r,i,n,o,a,s){if(!t&&this.formNotifyService)return this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),T.EMPTY;o=o&&this.translate(o);var c=this.buildParamMap(i);!0===(s=this.convertToBoolean(s,!1))&&(c=this.buildParam(i));var u=this.buildParamMap(i),l=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId,p={tabId:e,appId:t,appEntrance:r,funcId:undefined,appType:S.AppType.App,queryStringParams:c,entityParams:u,isReload:n,tabName:o||null};return!0===(a=this.convertToBoolean(a,!0))&&this.menuStateService.addMenuState(l,e),this.runtimeFrameworkService.openMenu$(p)},et.prototype.close=function(){var e=this.querystrings,t=this.findDialog(),r=t.isDialogComponent,i=t.rootComponent;r?this.get(i,"dialogRef").close():(e.token=e.formToken,this.runtimeFrameworkService.beforeCloseMenu(e))},et.prototype.destory=function(){var e=this.querystrings;e.token=e.formToken,this.runtimeFrameworkService.closeMenu(e)},et.prototype.parseParams=function(e){(null==e||"string"==typeof e&&e.length<1)&&(e={});var t=new Map;return"object"==typeof e&&(e=JSON.stringify(e)),e=window.encodeURIComponent(e),t.set("WEB_FORM_ROUTE_PARAMS",e),t},et.prototype.addEventListener=function(e,t){return this.navigationEventService.addEventListener(e,t)},et.prototype.removeEventListener=function(e,t){return this.navigationEventService.removeEventListener(e,t)},et.prototype.clearEventListener=function(e){this.navigationEventService.clearEventListener(e)},et.prototype.open=function(e,t,r,i,n,o,a,s,c,u,l,p){var d=this.injector.get(C.FEPageModalService,null);if(!d)throw new Error("get FEPageModalService failed.");if(!e)throw new Error("[NavigationService]->open,mode参数不能为空！");if("modal"===e||"sidebar"===e){if(!t&&!r)throw new Error("弹窗及侧边栏模式时弹窗容器id和表单路径不能同时为空！");if(t&&r)throw new Error("弹窗及侧边栏模式时弹窗容器id和表单路径不能同时存在！");var f=this.getObjectTypeConfig(c),h=this.buildConfigs(i);"sidebar"===e&&(h.dialogType=e);var g=null;if(t){var v=this.injector.get($e,null);if(!v)return;var y=v.getControls(t),m=this.createComponentRef(y,f);g=d.show(m,h)}else r&&(g=d.showByUrl(r,h));if(g&&g.content){g.content.isDialogRootComponent=!0;var S=(g.content.dialogRef=g).dialog&&g.dialog.instance&&g.dialog.instance.el&&g.dialog.instance.el.nativeElement&&g.dialog.instance.el.nativeElement.querySelector(".f-page-header");S&&g.dialog.instance.draggbar&&((g.dialog.instance.draggbar.handle=S).style.cursor="move")}}else{if("tab"!==e)throw new Error("不支持的模式！");if(!n||!o||!a)throw this.formNotifyService&&this.formNotifyService.warning(this.languageService.appOrFuncIdRequired,{hideTitle:!0}),new Error("新标签模式时标签页id、标签类型、菜单或应用id均不能为空！");if("app"===o&&!s)throw new Error("以应用方式打开时入口应用不能为空！");"app"==o?this.openApp(n,a,s,c,!1,u,l,p):"menu"===o&&this.openMenu(n,a,c,!1,l,u,p)}},et.prototype.navigate=function(e,t){var r=this.injector&&this.injector.get(a.Router,null),i=this.injector&&this.injector.get(a.ActivatedRoute,null),n=s.merge({},this.querystrings,t&&t.queryParams||{});t&&t.hasOwnProperty("queryParams")&&delete t.queryParams;var o=s.merge({skipLocationChange:!1,relativeTo:i,queryParams:n},t||{});return r?r.navigate(e,o):null},et.prototype.buildParamMap=function(e,t){(null==e||"string"==typeof e&&e.length<1)&&(e={});var r=new Map;t&&0<Object.keys(t).length&&("object"!=typeof e&&(e=JSON.parse(e)),e=s.merge(e,t)),"object"==typeof e&&(e=JSON.stringify(e));var i=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId;return e=window.encodeURIComponent(e),r.set("WEB_FORM_ROUTE_PARAMS",e),r.set("WEB_FORM_ROUTER_PARENT_ID",i),r},et.prototype.buildParam=function(t,e){(null==t||"string"==typeof t&&t.length<1)&&(t={});var r=new Map;e&&0<Object.keys(e).length&&("object"!=typeof t&&(t=JSON.parse(t)),t=s.merge(t,e)),"object"!=typeof t&&(t=JSON.parse(t)),Object.keys(t).forEach(function(e){r.set(e,t[e])});var i=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId;return t=window.encodeURIComponent(t),r.set("WEB_FORM_ROUTE_PARAMS",t),r.set("WEB_FORM_ROUTER_PARENT_ID",i),r},et.prototype.findDialog=function(){for(var e=this.get(this,"commandContext.frameContext"),t=this.get(e,"frameComponent.isDialogRootComponent",!1),r=this.get(e,"parent");null!=r&&!t;)e=this.get(e,"parent"),r=this.get(r,"parent"),t=this.get(e,"frameComponent.isDialogRootComponent",!1);return{isDialogComponent:t,rootComponent:this.get(e,"frameComponent")}},et.prototype.get=function(e,t,r){void 0===r&&(r=null);var i=Array.isArray(t)?t:t.split(".").filter(function(e){return e.length});return i.length?null===e||e===undefined||"undefined"==typeof e[i[0]]?r:this.get(e[i.shift()],i,r):e===undefined?r:e},et.prototype.convertToBoolean=function(e,t){return void 0===t&&(t=!1),null==e&&(e=t),"string"==typeof e&&(e="true"===(e||String(t))),e},et.prototype.translate=function(e){var t=this.injector&&this.injector.get(L.TranslateToken,null)||null;return t&&e&&e.startsWith("{{")&&e.endsWith("}}")?(e=e.replace("{{","").replace("}}","").trim(),t.transform(e,null)):e},et.prototype.buildConfigs=function(e){var r=this,t=this.injector.get(Y,null),i={title:(t=t||Y.getInstance())&&t.defaultDialogTitle||"",width:800,height:500,showButtons:!1},n=this.getObjectTypeConfig(e),o=Object.assign(i,n),a=o.beforeClose,s=o.refresh||{},c=s&&s.commandName||null,u=s&&s.frameId||null,l=o.cancelChanges||!1;return o.beforeClose=function(t){return a&&"function"==typeof a?a(t).pipe(R.switchMap(function(e){return e&&l?r.cancelChanges(t).pipe(R.switchMap(function(){return r.refreshForm(c,u)})):T.of(e)})):l?r.cancelChanges(t).pipe(R.switchMap(function(){return r.refreshForm(c,u)})):T.of(!0)},o},et.prototype.getObjectTypeConfig=function(e){var t;if(void 0===e&&(e={}),"string"==typeof e)if(e.length)try{t=JSON.parse(e)}catch(r){throw new Error(e+"不是合法的json字符串")}else t={};else{if("object"!=typeof e)throw new Error("填写对象格式或json字符串");t=Object.assign({},e)}return t},et.prototype.cancelChanges=function(e){if(e&&e.modalRef&&e.modalRef.content){var t=e.modalRef.content;if(t&&t.context){var r=t.context.repository||null;if(r)return r.cancelChanges().pipe(R.switchMap(function(){return T.of(!0)}))}}return T.of(!0)},et.prototype.refreshForm=function(e,t){if(e&&t){var r=this.frameContext.appContext.frameContextManager.getFrameContextById(t);if(r)return r.viewModel[e]().pipe(R.map(function(){return!0}))}return T.of(!0)},et.prototype.createComponentRef=function(e,t){var r,i=this.getFrameContext(),n=this.getComponentFactoryResolver();if(i&&n){var o=n.resolveComponentFactory(e),a=B.ReflectiveInjector.resolveAndCreate([],i.injector);(r=o.create(a))&&r.instance&&r.instance.viewModel&&r.instance.viewModel.uiState&&("object"==typeof t&&Object.keys(t).length&&Object.keys(t).forEach(function(e){r.instance.viewModel.uiState.setPropertyValue(e,t[e])}),r.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0))}return r},et.prototype.getFrameContext=function(){return this.frameContext?this.frameContext:this.context&&this.context.frameContext?this.context.frameContext:null},et.prototype.getComponentFactoryResolver=function(){var e,t=this.getFrameContext();return t&&(e=t.injector.get(B.ComponentFactoryResolver)),e},et.decorators=[{type:B.Injectable}],et.ctorParameters=function(){return[{type:Ke},{type:Ve},{type:Je},{type:He},{type:L.FrameContext,decorators:[{type:B.Optional}]},{type:B.Injector,decorators:[{type:B.Optional}]},{type:Y,decorators:[{type:B.Optional}]}]},et);function et(e,t,r,i,n,o,a){this.runtimeFrameworkService=e,this.menuStateService=t,this.navigationEventService=r,this.querystringService=i,this.frameContext=n,this.injector=o,this.languageService=a;var s=this.formAppContext&&this.formAppContext.ApplicationId,c=this.querystrings.tabId||this.querystrings.funcId||this.querystrings.appId;if(s){var u=window[Xe]||new Map;u&&!u.has(s)&&(u.set(s,{hash:window.location.hash}),window[Xe]=u)}if(c){var l=window.formEventServices||new Map;s&&(c=s),l&&l.has(c)?this.navigationEventService=l.get(c):(this.navigationEventService.registerEvent(),l.set(c,this.navigationEventService),this.navigationEventService.frameContext=this.frameContext,window.formEventServices=l),this.registerDestroyEvent(c)}a||(this.languageService=new Y)}var tt="IS_ADD",rt="LAST_MODIFIED_ID",it=(nt.getLastModifiedId=function(e){var t=e.getVirtualRootFrameContext(),r=null;return t?(r=t.getParam(rt))||null:r},nt.setLastModifiedId=function(e,t){var r=e.getVirtualRootFrameContext();r&&r.setParam(rt,t)},nt.getAddState=function(e){var t=e.getVirtualRootFrameContext();if(t)return t.getParam(tt)},nt.setAddState=function(e,t){var r=e.getVirtualRootFrameContext();r&&r.setParam(tt,!0),this.setLastModifiedId(e,t)},nt.cancelAddState=function(e){var t=e.getVirtualRootFrameContext();t&&t.setParam(tt,!1)},nt.setEditState=function(e,t){var r=e.getVirtualRootFrameContext();r&&r.setParam(tt,!1),this.setLastModifiedId(e,t)},nt);function nt(){}var ot=(at.info=function(e,t){var r=window.location.hash,i=at.querystring(r).odocDisableNotification,n=void 0===i?"":i;n&&"true"===n.toLowerCase()||e.info(t,{hideTitle:!0})},at.success=function(e,t){var r=window.location.hash,i=at.querystring(r).odocDisableNotification,n=void 0===i?"":i;n&&"true"===n.toLowerCase()||e.success(t,{hideTitle:!0})},at.querystring=function(e){var t=new URLSearchParams(e),r={};return t.forEach(function(e,t){r[t]=e}),r},at);function at(){}var st=(Object.defineProperty(ct.prototype,"context",{get:function(){return this.innerContext},set:function(e){this.innerContext=e},enumerable:!0,configurable:!0}),ct.prototype.execute=function(e,t){if(e&&""!==e&&"undefined"!==e){var r=this.viewModel;return t&&(r=this.appContext.frameContextManager.getFrameContextById(t).viewModel),r[e]()}},ct.prototype.waitForBeSession=function(){return this.context.frameContext.repository.restService.sessionService.getBeSessionId().pipe(R.filter(function(e){return null!==e}),R.take(1))},ct.prototype.extractResult=function(e){return this.context.results[e]},ct.prototype.suspendFrameContextRowSelectedEvent=function(e){var t=this.viewModel.frameContext;e&&(t=this.viewModel.frameContext.appContext.frameContextManager.getFrameContextById(e)),t&&(t.bindingData.rowSelectedEventSuspend=!0)},ct.prototype.resumeFrameContextRowSelectedEvent=function(e){var t=this.viewModel.frameContext;e&&(t=this.viewModel.frameContext.appContext.frameContextManager.getFrameContextById(e)),t&&(t.bindingData.rowSelectedEventSuspend=!1)},ct.decorators=[{type:B.Injectable}],ct.ctorParameters=function(){return[{type:L.ViewModel},{type:L.AppContext}]},ct);function ct(e,t){this.viewModel=e,this.appContext=t}var ut=(lt.prototype.validate=function(){var a=this;return this.repository.getList().subscribe(function(e){var t,r;try{for(var i=Z(e),n=i.next();!n.done;n=i.next())n.value.validate().subscribe(function(e){e.isValid||(alert(e.message),a.validationResults.next(e))})}catch(o){t={error:o}}finally{try{n&&!n.done&&(r=i["return"])&&r.call(i)}finally{if(t)throw t.error}}}),this.validationResults},lt.prototype.validateCurrentRow=function(){var n=this,e=this.repository.entityTypeInfo,t=this.frameContext.bindingData.list.currentId;if(!t)return y.of(!0);var r=this.repository.entityCollection.getEntityById(t);if(!r)return y.of(!0);if(!this.validateEntityAllowEmptyRule(r,e))return T.EMPTY;var i=[r],o=this.frameContext.namespace,a=[];a=null!==o?this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(o):this.frameContext.appContext.frameContextManager.getFrameContexts();var s=this.isInDialog(),c=this.hasOwnVerifyDetailService(),u=this.frameContext.root.viewModel;s&&c&&(u=this.frameContext.getVirtualRootFrameContext().viewModel);var l=!1,p=[];if(a.forEach(function(e){e.form&&e.form.enableValidate&&(l=!0)}),!l||i.length<1)return y.of(!0);u.verifyInformations=[];var d=!0,f=new Map;a.forEach(function(e){var t=e.bindingData.getObject();t&&t.setShowValidationMsg(!0),e.form&&e.form.enableValidate&&(e.form.getValidationRules().forEach(function(e,t){f.has(t)?e.forEach(function(e){return f.get(t).push(e)}):f.set(t,te(e))}),e.form.setShowValidationMsg(!0),e.form.isFormValid()||(p.push(e.form),d=!1))});var h=i.map(function(e){return n.frameContext.bindingData.list.getIndexById(e.primaryValue),e.validate(undefined,undefined,f,null,n.frameContext)});return g.zip.apply(void 0,te(h)).pipe(R.tap(function(r){a.forEach(function(a){if(a.form.enableValidate){var s=function(e){e.forEach(function(t){t.children&&t.children.length&&s(t.children);var r={},i="",n=function(e){e&&e.data&&e.data.id?i=e.data.id:e[L.PARENT_CLASS]&&n(e[L.PARENT_CLASS])};n(t.target);var e={path:[],isUdt:!1,isGrid:!1};t.target&&(e=t.target.getPaths()),e.path.join("/"),t.constraints&&Object.keys(t.constraints).forEach(function(e){r[e]={name:t.constraints[e]}});var o=e.path.concat(t.property);a.bindingData.changes.next({type:L.ChangeType.UpdateErrors,id:i,path:o,isUdt:e.isUdt,isGrid:e.isGrid,value:t.value,errors:r})})};if(r.map(function(e){return e.isValid}).filter(function(e){return e}).length===h.length){if(a.bindingData.changes.next({type:L.ChangeType.UpdateErrors,path:[]}),d){var e=a.bindingData.getObject();e&&e.setShowValidationMsg(!1);var t=a.form;t&&t.setShowValidationMsg(!1)}}else r.forEach(function(e){e.isValid?a.bindingData.changes.next({type:L.ChangeType.UpdateErrors,path:[]}):s(e.errors)})}})}),R.switchMap(function(e){var t=!0,r=[];e.forEach(function(e){e.isValid||(t=!1),r.push.apply(r,te(e.errors))}),0<r.length&&n.collectValidationErrors(u,r,n.frameContext.namespace);var i=u.verifyInformations;return s&&c&&(i=u.verifyInformations.filter(function(e){return e.namespace===o})),u.verifycationChanged.next(i),t&&!d&&console.warn("实体和控件校验规则不一致，会导致命令执行中断！"),t&&d?y.of(!0):v.empty()}))},lt.prototype.validateAll=function(){var n=this,e=this.repository.entityCollection.getAllEntities(),o=this.frameContext.namespace,t=[];t=null!==o?this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(o):this.frameContext.appContext.frameContextManager.getFrameContexts();var r=!1,i=[];if(t.forEach(function(e){e.form&&e.form.enableValidate&&(r=!0)}),!r||e.length<1)return y.of(!0);var a=this.isInDialog(),s=this.hasOwnVerifyDetailService(),c=this.frameContext.root.viewModel;a&&s&&(c=this.frameContext.getVirtualRootFrameContext().viewModel);var u=!0,l=new Map;t.forEach(function(e){var t=e.bindingData.getObject();t&&t.setShowValidationMsg(!0),e.form&&e.form.enableValidate&&(e.form.getValidationRules().forEach(function(e,t){l.has(t)?e.forEach(function(e){return l.get(t).push(e)}):l.set(t,te(e))}),e.form.setShowValidationMsg(!0),e.form.isFormValid()||(i.push(e.form),u=!1))});var p=0<e.length,d=e.map(function(e,t){return e.validate(undefined,undefined,l,p?t:null,n.frameContext)});return g.zip.apply(void 0,te(d)).pipe(R.tap(function(r){t.forEach(function(a){if(a.form.enableValidate){var s=function(e){e.forEach(function(t){t.children&&t.children.length&&s(t.children);var r={},i="",n=function(e){e&&e.data&&e.data.id?i=e.data.id:e[L.PARENT_CLASS]&&n(e[L.PARENT_CLASS])};n(t.target);var e={path:[],isUdt:!1,isGrid:!1};t.target&&(e=t.target.getPaths()),e.path.join("/"),t.constraints&&Object.keys(t.constraints).forEach(function(e){r[e]={name:t.constraints[e]}});var o=e.path.concat(t.property);a.bindingData.changes.next({type:L.ChangeType.UpdateErrors,id:i,path:o,isUdt:e.isUdt,isGrid:e.isGrid,value:t.value,errors:r})})};if(r.map(function(e){return e.isValid}).filter(function(e){return e}).length===d.length){if(a.bindingData.changes.next({type:L.ChangeType.UpdateErrors,path:[]}),u){var e=a.bindingData.getObject();e&&e.setShowValidationMsg(!1);var t=a.form;t&&t.setShowValidationMsg(!1)}}else r.forEach(function(e){e.isValid?a.bindingData.changes.next({type:L.ChangeType.UpdateErrors,path:[]}):s(e.errors)})}})}),R.switchMap(function(e){var t=!0,r=[];e.forEach(function(e){e.isValid||(t=!1),r.push.apply(r,te(e.errors))}),0<r.length&&n.collectValidationErrors(c,r,n.frameContext.namespace);var i=c.verifyInformations;return a&&s&&(i=c.verifyInformations.filter(function(e){return e.namespace===o})),t&&u&&(i=c.verifyInformations=[]),c.verifycationChanged.next(i),t&&u?y.of(!0):v.empty()}))},lt.prototype.validateEntityAllowEmptyRule=function(e,t){var i=this,r=this.getNotAllowEmptyBindingPaths(t);if(!r||r.length<1)return!0;var n=r.filter(function(e){var t=e.split("/").filter(function(e){return e}),r=i.frameContext.bindingData.getValue(t);return!r||r.length<1});if(0<n.length){var o=[];return n.forEach(function(e){var t=i.getViewModelNameByBindingPaths(e.split("/"));o.push(t)}),this.notifyService&&this.notifyService.error(o.join("，")+" "+this.languageService.tableCanNotEmpty,{hideTitle:!0}),!1}return!0},lt.prototype.getViewModelNameByBindingPaths=function(e){var t=this.frameContext.namespace,r=null;r=null!==t?this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(t):this.frameContext.appContext.frameContextManager.getFrameContexts();var i=e.filter(function(e){return e}).join("/"),n=r.find(function(e){return e.viewModel&&e.viewModel.bindingPath.split("/").filter(function(e){return e}).join("/")===i});return n&&n.form&&n.form.formGroupName||""},lt.prototype.getNotAllowEmptyBindingPaths=function(e){if(!e)return undefined;var t=[];return this.deepFirstTraversalEntityTypeInfo(e,t),t},lt.prototype.deepFirstTraversalEntityTypeInfo=function(e,r,i){var n=this;void 0===r&&(r=[]),void 0===i&&(i=[]);var t=e.getPropInfosByGroup(L.DataPropGroup.List);if(t&&0<t.length&&t.forEach(function(e){var t=e.typeInfo;t&&t.entityInfo&&!1===t.entityInfo.allowEmpty&&(i.push(t.entityInfo.nodeCode),n.deepFirstTraversalEntityTypeInfo(t,r,i))}),i&&0<i.length){var o=i.join("/");r.push(o)}i.splice(0,i.length)},lt.prototype.collectValidationErrors=function(a,e,s,t){var c=this;void 0===t&&(t=!0),t&&(a.verifyInformations=a.verifyInformations.filter(function(e){return e.namespace!==s})),e.forEach(function(e){e.children&&e.children.length&&c.collectValidationErrors(a,e.children,s,!1);var t="",r=function(e){e&&e.data&&e.data.id?t=e.data.id:e[L.PARENT_CLASS]&&r(e[L.PARENT_CLASS])};if(r(e.target),e.constraints){var i=Object.keys(e.constraints);if(i.length){var n=a.verifyInformations.filter(function(e){return e.namespace===s}).length,o=a.verifyInformations.findIndex(function(e){return e.namespace===s});o=-1===o?0:o+n,a.verifyInformations.splice(o,0,{id:t,namespace:s,targetField:e.field,index:e.index,title:e.propertyName,msg:e.constraints[i[0]],frameContext:e.frameContext,fullPath:e.fullPath,type:"required"===i[0]?"empty":"error"})}}})},lt.prototype.resetValidation=function(){var e=this.isInDialog(),t=this.frameContext.root.viewModel;e&&(t=this.frameContext.getVirtualRootFrameContext().viewModel);var r=t.verifyInformations;if(r.length){var i=this.frameContext.namespace;null!==i&&(r=t.verifyInformations.filter(function(e){return e.namespace!==i})),t.verifyInformations=r}return t&&t.verifycationChanged&&t.verifycationChanged.next(r),y.of(null)},lt.prototype.isInDialog=function(){return this.frameContext&&this.frameContext.getVirtualRootFrameContext()&&this.frameContext.getVirtualRootFrameContext().frameComponent&&this.frameContext.getVirtualRootFrameContext().frameComponent.isDialogRootComponent||!1},lt.prototype.hasOwnVerifyDetailService=function(){return this.frameContext.injector.get(o.VerifyDetailService,null)!==this.frameContext.root.appContext.injector.get(o.VerifyDetailService,null)},lt.decorators=[{type:B.Injectable}],lt.ctorParameters=function(){return[{type:L.Repository},{type:L.FrameContext},{type:De,decorators:[{type:B.Optional}]},{type:Y,decorators:[{type:B.Optional}]}]},lt);function lt(e,t,r,i){this.repository=e,this.frameContext=t,this.notifyService=r,this.languageService=i,this.validationResults=new T.Subject,this.validationAllResult=new T.Subject,this.languageService||(this.languageService=new Y)}var pt=(dt.prototype.load=function(e){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.frameContext.appContext.params.set("retrieveing",!0),this.frameContext.appContext.params["delete"]("queryChild"),this.repository.getById(e).pipe(R.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.loadFailed,e)}))},dt.prototype.onLoading=function(g){var v=this,e=this.runtimeFrameworkService&&this.runtimeFrameworkService.tabId||null;if(e){var y=!0,t=this.frameContext.appContext.params.get(e)||!1;g=g||"transitionAction",t||(this.frameContext.appContext.params.set(e,!0),this.runtimeFrameworkService.getEntityParam(e,function(e){if(y)y=!1;else{var t=v.parseParams(e);if(t&&t.sync){var r=t.action,i=t.id,n=v.frameContext&&v.frameContext.viewModel&&v.frameContext.viewModel.metadatas&&v.frameContext.viewModel.metadatas[r],o=n.params&&n.params[g]||null,a=v.frameContext.bindingData.list.currentId,s=v.frameContext.stateMachine.context.state,c=null,u=void 0;if(o){var l=v.frameContext&&v.frameContext.stateMachine&&v.frameContext.stateMachine.metadatas&&v.frameContext.stateMachine.metadatas.actions&&v.frameContext.stateMachine.metadatas.actions[o];if(c=l&&l.transitTo||s,(u=v.frameContext&&v.frameContext.stateMachine&&v.frameContext.stateMachine.metadatas&&v.frameContext.stateMachine.metadatas&&v.frameContext.stateMachine.metadatas.states[c]&&v.frameContext.stateMachine.metadatas.states[c].name||v.languageService.defaultStateName)&&u.startsWith("{{")&&u.endsWith("}}")){var p=u.replace("{{","").replace("}}","");u=v.frameContext.translate.transform(p,null)}}else c=s;var d=a!==i,f=s!==c;if(d&&f){var h=v.languageService.dataAndStateChanged.replace(/\$1/g,u);v.showLoadingConfirm(h).pipe(R.switchMap(function(){return v.resetForm(r)})).subscribe()}else if(d)v.showLoadingConfirm(v.languageService.dataChanged).pipe(R.switchMap(function(){return v.resetForm(r)})).subscribe();else{if(!f)return T.of(!0);h=v.languageService.stateChanged.replace(/\$1/g,u),v.showLoadingConfirm(h).pipe(R.switchMap(function(){return v.resetForm(r)})).subscribe()}}}},!1))}},dt.prototype.add=function(){var t=this,e=this.bindingData.list.currentId,r=this.loadingService.showLoadingWithDelay(500);return this.repository.create().pipe(R.tap(function(){it.setEditState(t.frameContext,e),t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.addFailed,e)}))},dt.prototype.cascadeAdd=function(){var i=this,e=new T.Subject,t=this.frameContext.appContext.frameContextManager.getFrameContexts(),r=this.frameContext.getVirtualRootFrameContext().namespace,n=t.filter(function(e){return e.namespace===r})||[],o=[];if(n&&0<n.length){var a=n.filter(function(e){return e.viewModel.bindingPath&&"/"!==e.viewModel.bindingPath});if(a&&0<a.length){var s=a.map(function(e){return e.viewModel.bindingPath});s&&0<s.length&&(o=s.map(function(e){return e.split("/").filter(function(e){return e})}).sort(function(e,t){return e.length-t.length}))}}return this.loadingService.show(),this.repository.create().pipe(R.switchMap(function(e){var r=e.primaryValue;return o&&0<o.length?T.from(o).pipe(R.concatMap(function(e){var t=i.getPath(i.frameContext.viewModel,"/"+e.join("/"),r);return i.repository.appendByPath(t)})):T.of(e)})).pipe(R.last()).subscribe(function(){i.loadingService.hide(),e.next()},function(e){i.loadingService.hide(),i.formErrorService.exception(i.languageService.addFailed,e)}),e},dt.prototype.edit=function(e){var t=this;return this.update().pipe(R.tap(function(){var e=t.bindingData.list.currentId;it.setEditState(t.frameContext,e)}))},dt.prototype.update=function(e){var t=this;if(!(e=this.bindingData.list.currentId))return T.empty();var r=this.loadingService.showLoadingWithDelay(500),i=this.repository.updateById(e);return this.frameContext.appContext.params.set("retrieveing",!0),i.pipe(R.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.updateFailed,e)}))},dt.prototype.updateWithoutEmpty=function(){return this.bindingData.list.currentId?this.update():T.of(null)},dt.prototype.checkBeforeUpdate=function(){var e=this.frameContext.bindingData.list;return e&&e.currentId?T.of(!0):(this.formNotifyService.warning(this.languageService.noDataExist,{hideTitle:!0}),T.EMPTY)},dt.prototype.updateWithNotify=function(){return this.bindingData.list.currentId?this.update():(this.formNotifyService.warning(this.languageService.noDataExist,{hideTitle:!0}),T.EMPTY)},dt.prototype.loadPaged=function(e,t){var r=this;if(!this.bindingData.list.currentId)return T.EMPTY;var i=this.loadingService.showLoadingWithDelay(500);return T.of(null).pipe(R.tap(function(){r.loadingService.hideDelayLoading(i)},function(e){r.loadingService.hideDelayLoading(i),r.formErrorService.exception(r.languageService.updateFailed,e)}))},dt.prototype.save=function(i){var n=this,o=this.bindingData.list.currentId;if(!o)return T.of(!1);var a=this.loadingService.showLoadingWithDelay(500),e=this.repository.updateChangesById(o),t=this.repository.applyChangesById(o);return e.pipe(R.switchMap(function(e){return!1===e?T.of(!1):t}),R.tap(function(){if(it.setEditState(n.frameContext,o),n.loadingService.hideDelayLoading(a),i&&i.trim()){var e=!0;if(i.startsWith("{")&&i.endsWith("}"))try{var t=JSON.parse(i);t&&!1===t.showMessage&&(e=!1)}catch(r){}!1!==e&&n.formNotifyService.success(i,{hideTitle:!0})}else ot.success(n.formNotifyService,n.languageService.saveSuccess)},function(e){n.loadingService.hideDelayLoading(a),n.formErrorService.exception(n.languageService.saveFailed,e)}))},dt.prototype.cancel=function(){return this.cancelWithCheck()},dt.prototype.revert=function(e){return this.cancelWithoutCheck(e)},dt.prototype.cancelWithCheck=function(){var t=this;return I.BefRepositoryUtil.isExistUnsaveData(this.repository)?this.formMessageService.question(this.languageService.cancelWithoutSave).pipe(R.switchMap(function(e){return!1===e?T.EMPTY:t.cancelChanges()})):this.cancelChanges()},dt.prototype.cancelWithoutCheck=function(e){return this.cancelChanges(e)},dt.prototype.cancelChanges=function(e){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.repository.cancelChanges(e).pipe(R.tap(function(){it.setEditState(t.frameContext,""),t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.cancelFailed,e)}))},dt.prototype.reload=function(){var e;if(e=!0===it.getAddState(this.frameContext)?it.getLastModifiedId(this.frameContext):this.bindingData.list.currentId)return this.load(e);this.repository.entityCollection.loadEntities([])},dt.prototype.getPath=function(e,t,r){var i="/"+r,n=t.split("/");if(0<n.length)for(var o=1;o<n.length-1;o++){var a=n[o],s=e.bindingData[a];if(!s||!s.currentId)throw Error("获取子表完整路径出错，找不到"+s+"对应的子表，或对应子表没有当前行。");i+="/"+a+"/"+s.currentId}return i+="/"+n[n.length-1]},dt.prototype.resetForm=function(e){var t=this,r=this.frameContext.injector.get(ut,null);return this.frameContext.repository.cancelChanges().pipe(R.switchMap(function(){return t.commandService.execute(e).pipe(R.switchMap(function(){return r&&r.resetValidation()||T.of(null)}))}))},dt.prototype.parseParams=function(e){if(e&&"[object Map]"===Object.prototype.toString.call(e)){var t=e.get("WEB_FORM_ROUTE_PARAMS");if(t&&"string"==typeof t)return(t=decodeURIComponent(t)).startsWith("{")&&t.endsWith("}")&&(t=JSON.parse(t)),{action:t.action,id:t.idToView||t.idToEdit||t.id,sync:t.sync||!1}}return null},dt.prototype.showLoadingConfirm=function(e){return this.formMessageService.confirm(e).pipe(R.switchMap(function(e){return!0===e?T.of(!0):T.EMPTY}))},dt.decorators=[{type:B.Injectable}],dt.ctorParameters=function(){return[{type:Pe},{type:L.FrameContext},{type:q},{type:De},{type:Y,decorators:[{type:B.Optional}]},{type:xe},{type:Ke},{type:st}]},dt);function dt(e,t,r,i,n,o,a,s){this.formMessageService=e,this.frameContext=t,this.loadingService=r,this.formNotifyService=i,this.languageService=n,this.formErrorService=o,this.runtimeFrameworkService=a,this.commandService=s,n||(this.languageService=Y.getInstance()),this.repository=this.frameContext.repository,this.bindingData=this.frameContext.bindingData}var ft=(ht.prototype.onClosing=function(){var r=this;this.isInDialog()||this.navigationService.addEventListener(Ue.onTabClosing,function(t){if(!r.isChanged||r.appContext.opened)return r.isChanged&&r.appContext.opened?T.of(!1):T.of(!0);t&&t.beforeCloseHandle&&"function"==typeof t.beforeCloseHandle&&t.beforeCloseHandle({selectedChange:!0});var e=r.msgService.question(r.languageService.exitWithoutSave);return r.appContext.opened=!0,e.pipe(R.switchMap(function(e){return r.appContext.opened=!1,e&&r.cardDataService?r.cardDataService.revert(t).pipe(R.switchMap(function(){return T.of(e)})):T.of(e)}))})},ht.prototype.isInDialog=function(){for(var e=this.frameContext,t=e.frameComponent.isDialogRootComponent||!1;null!==e.parent&&!t;)t=(e=e.parent).frameComponent.isDialogRootComponent;return t},ht.prototype.getTabId=function(e,t){if(t)return t;var r=null;return e&&e.startsWith("{")&&e.endsWith("}")&&(r=JSON.parse(e)),r&&r.hasOwnProperty("id")&&r.id?r.id:L.UID.create()},Object.defineProperty(ht.prototype,"isChanged",{get:function(){var e=this.repository;return I.BefRepositoryUtil.isExistUnsaveData(e)},enumerable:!0,configurable:!0}),ht.decorators=[{type:B.Injectable}],ht.ctorParameters=function(){return[{type:Ze},{type:L.FrameContext},{type:Pe},{type:Y,decorators:[{type:B.Optional}]},{type:pt}]},ht);function ht(e,t,r,i,n){this.navigationService=e,this.frameContext=t,this.msgService=r,this.languageService=i,this.cardDataService=n,this.repository=t.repository,this.languageService||(this.languageService=Y.getInstance()),this.frameContext&&(this.appContext=this.frameContext.getFormAppContext()||null)}var gt=(vt.prototype.onPageChanging=function(){return this.isChanged?this.msgService.question(this.languageService.gridDataNotSave).pipe(R.switchMap(function(e){return e?T.of(!0):T.EMPTY})):T.of(!0)},vt.prototype.filter=function(e,t){var r=this.context&&this.context.eventParam||[];return"string"==typeof r&&(r=JSON.parse(r)),this.viewModel.frameContext.repository.entityCollection.pageIndex=1,this.viewModel.frameContext.repository.filterConditionManager.setConditions(this.viewModel.bindingPath,r),this.commandService.execute(e,t)},Object.defineProperty(vt.prototype,"isChanged",{get:function(){var e=this.repository;return I.BefRepositoryUtil.isExistUnsaveData(e)},enumerable:!0,configurable:!0}),vt.decorators=[{type:B.Injectable}],vt.ctorParameters=function(){return[{type:L.FrameContext},{type:Pe},{type:Y,decorators:[{type:B.Optional}]},{type:L.ViewModel},{type:st}]},vt);function vt(e,t,r,i,n){this.frameContext=e,this.msgService=t,this.languageService=r,this.viewModel=i,this.commandService=n,this.repository=this.frameContext.repository,this.languageService||(this.languageService=Y.getInstance())}var yt=(Object.defineProperty(mt.prototype,"params",{get:function(){var i=this,e=window.location.hash,n=this.querystringService.parse(e),t=n.tabId;if(!t)return T.of(n);var o=new T.Subject;return this.runtimeFrameworkService.addEventListener(t,function(e){var t={};(e instanceof Map||e&&"function"==typeof e.get&&"function"==typeof e.entries)&&(t=i.parseMapParams(e));var r={};r=e instanceof Map||e&&"function"==typeof e.get&&"function"==typeof e.entries?new Map(e):Object.assign({},e),setTimeout(function(){o.next(Object.assign({},r,t,n))},0)},n),o.asObservable()},enumerable:!0,configurable:!0}),mt.prototype.parseMapParams=function(e){var r={};return r.WEB_FORM_ROUTE_PARAMS=decodeURIComponent(e.get("WEB_FORM_ROUTE_PARAMS")),e.forEach(function(e,t){"WEB_FORM_ROUTE_PARAMS"!==t&&(r[t]=e)}),r},mt.prototype.get=function(t){return this.params.pipe(R.switchMap(function(e){return e&&e.hasOwnProperty(t)?T.of(e.param):T.of(undefined)}))},mt.prototype.parse=function(){return this.params.pipe(R.switchMap(function(e){return T.of(e)}))},mt.decorators=[{type:B.Injectable}],mt.ctorParameters=function(){return[{type:He},{type:Ke}]},mt);function mt(e,t){this.querystringService=e,this.runtimeFrameworkService=t}var St=(Ct.prototype.bind=function(r){var i=this;r.keybindingMap.forEach(function(e,t){i.register(e,function(){return r[t]()})})},Ct.prototype.register=function(e,t){var r=this._getCombo(e);r&&(this.keyMap.set(r,t),e.ctrlKey&&e.altKey&&!e.shiftKey?this.bindingProvider.bind(r,this._dispatch.bind(this),"keyup"):this.bindingProvider.bind(r,this._dispatch.bind(this)))},Ct.prototype.unregister=function(e){var t=this._getCombo(e);t&&(this.keyMap["delete"](t),this.bindingProvider.unbind(t))},Ct.prototype._dispatch=function(e){var t=this;if(e.repeat)return!1;if(this.ready){var r=this._getCombo(e);r&&this.keyMap.has(r)&&(this.ready=!1,this.keyMap.get(r)().subscribe(function(){t.ready=!0},function(e){t.ready=!0},function(){t.ready=!0}))}return!1},Ct.prototype._getCombo=function(e){var t=e.key.toLowerCase();if(1!=t.length||t.charCodeAt(0)<97||122<t.charCodeAt(0))return console.warn("快捷键字母形式为a-z"),null;var r=(e.ctrlKey?"ctrl+":"")+(e.shiftKey?"shift+":"")+(e.altKey?"alt+":"")+(e.metaKey?"meta+":"")+t;return 1==r.length?(console.warn("快捷键至少包含一个Modifier键"),null):r},Ct.decorators=[{type:B.Injectable}],Ct.ctorParameters=function(){return[]},Ct);function Ct(){this.keyMap=new Map,this.bindingProvider=V,this.ready=!0}var bt=(It.decorators=[{type:B.Injectable}],It);function It(){}var wt=(xt.prototype.getState=function(e,t){throw new Error("Not Implemented")},xt.prototype.setState=function(e,t,r){throw new Error("Not Implemented")},xt.decorators=[{type:B.Injectable}],xt.ctorParameters=function(){return[]},xt);function xt(){}var Et=(Pt.prototype.transit=function(e){if(e&&"function"==typeof this.stateMachine[e]){if(this.stateMachine[e](),this._currentFrameContext=this.context&&this.context.frameContext,this._initLoad&&(this.initFormState(),this._initLoad=!1),!this._currentFrameContext)return;var t=this.getCurrentRootFrameContext(this._currentFrameContext);t&&this.toggleFormState(e,t)}},Pt.prototype.getCurrentRootFrameContext=function(t){var r;return this.getAllRootFrameContext().forEach(function(e){t.namespace===e.namespace&&(r=e)}),r},Pt.prototype.getFrameContextManagerMap=function(){if(this.stateMachine&&this.stateMachine.frameContext){var e=this.stateMachine.frameContext.appContext;if(e)return e.frameContextManager.getFrameContextMap()}return null},Pt.prototype.getAllRootFrameContext=function(){var t=[],e=this.getFrameContextManagerMap();return e&&e.forEach(function(e){(""===e.namespace&&null===e.parent||null!==e.parent&&e.namespace!==e.parent.namespace)&&t.push(e)}),t},Pt.prototype.initFormState=function(){var r=this;this.getFrameContextManagerMap()&&this.getAllRootFrameContext().forEach(function(e){var t=e.injector.get(B.ElementRef,null)||null;t&&t.nativeElement&&(t.nativeElement.className.includes(r._clsDefaultName)||t.nativeElement.className.includes("f-form-state-create")||t.nativeElement.className.includes("f-form-state-edit")||r.addCssClass(t,r._clsDefaultName))})},Pt.prototype.toggleFormState=function(e,t){var r=this,i=t.injector.get(B.ElementRef,null)||null;i&&i.nativeElement&&e&&((e=e.toLowerCase())&&["create","edit"].includes(e)?("create"===e?this.addCssClass(i,"f-form-state-create"):"edit"===e&&this.addCssClass(i,"f-form-state-edit"),this.removeCssClass(i,this._clsDefaultName)):(["f-form-state-create","f-form-state-edit"].forEach(function(e){return r.removeCssClass(i,e)}),this.addCssClass(i,this._clsDefaultName)))},Pt.prototype.addCssClass=function(e,t){if(e&&t&&e.nativeElement){var r=e.nativeElement.className||"";r.includes(t)||(e.nativeElement.className=r+" "+t)}},Pt.prototype.removeCssClass=function(e,t){if(e&&t&&e.nativeElement){var r=e.nativeElement.className||"";r.includes(t)&&(e.nativeElement.className=r.split(" ").filter(function(e){return e&&e!==t}).join(" "))}},Pt.prototype.getFormRootComponent=function(){if(this.stateMachine&&this.stateMachine.frameContext){var e=this.stateMachine.frameContext;if(e){var t=e.getVirtualRootFrameContext();if(t){var r=t.injector;if("function"==typeof r.get)return r.get(B.ElementRef,null)}}}return null},Pt.decorators=[{type:B.Injectable}],Pt.ctorParameters=function(){return[{type:L.StateMachine}]},Pt);function Pt(e){var t=this;this.stateMachine=e,this._clsDefaultName="f-form-state-default",this._initLoad=!0,"init"===this.stateMachine.initialState.name&&window.setTimeout(function(){t.initFormState()},0)}var Ft=(Dt.prototype.setCurrentId=function(t,e){Array.from(this.appContext.getAllFrameContexts().values()).forEach(function(e){e.bindingData.list.setCurrentId(t,!0,!1)})},Dt.prototype.setCurrentRow=function(e,t){var r=this.bindingData;t&&(r=this.appContext.getFrameContext(t).bindingData),r.getList().setCurrentId(e)},Dt.decorators=[{type:B.Injectable}],Dt.ctorParameters=function(){return[{type:L.BindingData},{type:L.AppContext}]},Dt);function Dt(e,t){this.bindingData=e,this.appContext=t}var Mt=(Tt.prototype.parseParams=function(e,t,r,i){var n=this,o=this.highOrderInvoke(i);this.paramService?this.paramService.parse().pipe(R.take(1)).subscribe(function(e){n.params=e,n.setupParams(e,t,r,o)}):e.queryParams.pipe(R.take(1)).subscribe(function(e){n.params=e,n.setupParams(e,t,r,o)})},Tt.prototype.setupParams=function(e,t,r,i){var n=this.getParams(e);if(n){this.setQueryParams(n,r);var o=this.getFuncId(n),a=this.getAppId(n);(o||a)&&o?this.setStaticParams(o,n,t,r,i):i()}else i()},Tt.prototype.setQueryParams=function(t,e){var r={},i=this.isInDialog(e),n=e&&e.uiState&&e.uiState.innerData||{};Object.keys(t).forEach(function(e){i&&n.hasOwnProperty(e)||(r[e]=t[e])}),this.updateUIState(e,r)},Tt.prototype.setStaticParams=function(e,r,t,i,n){var o=this;this.runtimeFrameworkService.getMenuParams(e,function(e){var t=o.mapStaticParamsToObject(e,r,i);t&&o.updateUIState(i,t),n()})},Tt.prototype.mapStaticParamsToObject=function(e,i,t){if(e){var n=this.isInDialog(t),o=t&&t.uiState&&t.uiState.innerData||{},a={};return e.forEach(function(e,t,r){n?i.hasOwnProperty(t)||o.hasOwnProperty(t)||(a[t]=e):i.hasOwnProperty(t)||(a[t]=e)}),a}},Tt.prototype.isInDialog=function(e){var t=!1;return e&&e.uiState&&(e.uiState.innerData&&e.uiState.innerData.hasOwnProperty("DEVKIT_DIALOG")||e.uiState.DEVKIT_DIALOG)&&(t=!0),t},Tt.prototype.updateUIState=function(r,i){var n=this;if(r&&i){var o=r.uiState;"string"==typeof i&&""!==i&&(i=JSON.parse(i)),Object.keys(i).forEach(function(e){if(o.setPropertyValue(e,i[e]),e&&"union_session"===e){var t=i[e];n.setSessionInfo(r,t)}})}},Tt.prototype.setSessionInfo=function(e,t){if(e&&t){t&&"string"==typeof t&&t.startsWith("{")&&t.endsWith("}")&&(t=JSON.parse(t));var r=t&&t.token||null,i=t&&t.sessionId||null;if(r&&(e.frameContext.appContext.Token=r),i){var n=e.frameContext.repository;n&&n.restService.sessionService.setBeSessionId(i)}}},Tt.prototype.getFuncId=function(e){if(e)return e.funcId},Tt.prototype.getAppId=function(e){if(e)return e.appId},Tt.prototype.getTabId=function(e){if(e)return e.tabId},Tt.prototype.getParams=function(t){if(!t)return{};var r={};if(t.hasOwnProperty("WEB_FORM_ROUTE_PARAMS")){var e=t.WEB_FORM_ROUTE_PARAMS;return e&&e.startsWith("{")&&e.endsWith("}")&&(e=decodeURI(encodeURI(e).replace(/%0A/g,"\\n").replace(/%09/g,"\\t").replace(/%0D/g,"\\r")),r=JSON.parse(e)),Object.keys(t).forEach(function(e){"WEB_FORM_ROUTE_PARAMS"!==e&&(r[e]=t[e])}),r}return t},Tt.prototype.highOrderInvoke=function(i){var n=this;return function(){try{var e=n.getParams(n.params);if(n.getTabId(e)){var t=n.runtimeFrameworkService.getMenuSwitchControlEvent();t&&T.isObservable(t)&&t.subscribe(function(e){e&&e.next("ok")})}}catch(r){console.warn(r)}i&&"function"==typeof i&&i()}},Tt.decorators=[{type:B.Injectable}],Tt.ctorParameters=function(){return[{type:yt,decorators:[{type:B.Optional}]},{type:Ke,decorators:[{type:B.Optional}]}]},Tt);function Tt(e,t){this.paramService=e,this.runtimeFrameworkService=t,this.runtimeFrameworkService||(this.runtimeFrameworkService=new Ke)}var Rt=(Object.defineProperty(Ot.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Ot.prototype.getPropValue=function(e){return this.bindingData.getValue(e)},Ot.prototype.getEntityData=function(e){var t=this.bindingData.getValue(e);return(t instanceof L.BindingList==1?t.currentItem:t).toJSON()},Ot.prototype.getEntityListData=function(e){return this.bindingData.getValue(e).toJSON()},Ot.decorators=[{type:B.Injectable}],Ot.ctorParameters=function(){return[{type:L.FrameContext}]},Ot);function Ot(e){this.frameContext=e}var Nt=(Object.defineProperty(At.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),At.prototype.setPropValue=function(e,t){this.bindingData.setValue(e,t,!0,!0)},At.decorators=[{type:B.Injectable}],At.ctorParameters=function(){return[{type:L.FrameContext}]},At);function At(e){this.frameContext=e}var jt=(Object.defineProperty(Bt.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Bt.prototype.count=function(e){var t=this.splitPath(e);return this.traversingService.getEntityListData(t.listPath).length},Bt.prototype.sum=function(e){var i=this,n=this.splitPath(e);return this.traversingService.getEntityListData(n.listPath).reduce(function(e,t){var r=parseFloat(i.getPropValue(t,n.propPath));return e+=r=isNaN(r)?0:r},0)},Bt.prototype.avg=function(e){var t=this.count(e),r=this.sum(e);return 0!==t?r/t:0},Bt.prototype.max=function(e){var i=this,n=this.splitPath(e),t=this.traversingService.getEntityListData(n.listPath).reduce(function(e,t){var r=parseFloat(i.getPropValue(t,n.propPath));return!1===isNaN(r)&&(!e||e<r)&&(e=r),e},null);return t||0},Bt.prototype.min=function(e){var i=this,n=this.splitPath(e),t=this.traversingService.getEntityListData(n.listPath).reduce(function(e,t){var r=parseFloat(i.getPropValue(t,n.propPath));return!1===isNaN(r)&&(!e||r<e)&&(e=r),e},null);return t||0},Bt.prototype.getPropValue=function(e,t){var r=e;return t.forEach(function(e){r=r?r[e]:null}),r},Bt.prototype.splitPath=function(e){for(var t=e.concat([]),r=[],i=this.bindingData.getValue(t);i instanceof L.BindingList!=1;){var n=t.pop();if(!n)return;r.unshift(n),i=this.bindingData.getValue(t)}return{listPath:t,propPath:r}},Bt.decorators=[{type:B.Injectable}],Bt.ctorParameters=function(){return[{type:L.FrameContext}]},Bt);function Bt(e){this.frameContext=e,this.traversingService=this.frameContext.injector.get(Rt)}var Lt=(Object.defineProperty(Vt.prototype,"pageIndex",{get:function(){return this.bindingData.list.pageIndex},enumerable:!0,configurable:!0}),Object.defineProperty(Vt.prototype,"pageSize",{get:function(){return this.bindingData.list.pageSize},enumerable:!0,configurable:!0}),Vt.decorators=[{type:B.Injectable}],Vt.ctorParameters=function(){return[{type:L.BindingData}]},Vt);function Vt(e){this.bindingData=e}var _t=(kt.prototype.getPropValue=function(e){return this.traversingService.getPropValue(e)},kt.prototype.setPropValue=function(e,t){return this.manipulationService.setPropValue(e,t)},kt.prototype.getEntityData=function(e){return this.traversingService.getEntityData(e)},kt.prototype.getEntityListData=function(e){return this.traversingService.getEntityListData(e)},kt.prototype.count=function(e){return this.aggregationService.count(e)},kt.prototype.sum=function(e){return this.aggregationService.sum(e)},kt.prototype.avg=function(e){return this.aggregationService.avg(e)},kt.prototype.max=function(e){return this.aggregationService.max(e)},kt.prototype.min=function(e){return this.aggregationService.min(e)},kt.decorators=[{type:B.Injectable}],kt.ctorParameters=function(){return[{type:L.FrameContext}]},kt);function kt(e){this.frameContext=e;var t=this.frameContext.injector;this.traversingService=t.get(Rt),this.manipulationService=t.get(Nt),this.aggregationService=t.get(jt)}var qt=(Ut.prototype.getBindingPathsByFrameContext=function(e){return e&&e.viewModel&&e.viewModel.bindingPath&&e.viewModel.bindingPath.split("/").filter(function(e){return e})||null},Ut.prototype.getBindingPathsByTableName=function(e,t,r,i){if(void 0===r&&(r=[]),void 0===i&&(i=0),i++,e.entityInfo&&(e.entityInfo.nodeCode===t||e.entityInfo.originalCode===t))return 1!==i&&r.push(e.entityInfo.nodeCode),r;var n=Array.from(e.propInfoMap.values()).filter(function(e){return e.typeInfo});if(n.length<1)return r=[];e.entityInfo&&1!==i&&r.push(e.entityInfo.nodeCode);for(var o=0;o<n.length;o++){var a=n[o].typeInfo,s=this.getBindingPathsByTableName(a,t,r,i);if(s&&!(s.length<1))return r=r.concat(s)}return null},Ut.prototype.getBindingPathsByPath=function(e,t){var r=[];for("string"==typeof e&&(e=e.split("/").filter(function(e){return e})),e=e.concat([]);0<e.length;){if("List"===t.getPropInfoByPath(e).group){r=e;break}e.pop()}return r},Ut.prototype.getPathInfo=function(e){var t=e.split("/").filter(function(e){return e}),r=this.getBindingPathsByPath(t,this.repository.entityTypeInfo),i=t.slice(r.length).join("/");return{bindingPath:r.join("/"),propertyName:i,bindingPaths:r,propertyNames:i.split("/").filter(function(e){return e})}},Ut.decorators=[{type:B.Injectable}],Ut.ctorParameters=function(){return[{type:B.Injector},{type:L.AppContext},{type:L.Repository}]},Ut);function Ut(e,t,r){this.injector=e,this.appContext=t,this.repository=r}var Ht=(Wt.prototype.getFormControlsByFrameContext=function(e){return e&&e.form&&e.form.ngFormControls||null},Wt.prototype.getFormControlByBinding=function(e,t){var r=this.getFormControlsByFrameContext(e);return r?Object.values(r).find(function(e){return e&&e.binding===t}):null},Wt.prototype.getFormControlIndexByFullPath=function(i,e){var t=this.getFormControlsByFrameContext(i);if(!t)return null;var n=e.split("/").filter(function(e){return e});return Object.values(t).findIndex(function(e){if(!e)return!1;var t=i.viewModel.bindingPath.split("/").filter(function(e){return e}),r=e.binding.split(".").filter(function(e){return e});return t.concat(r).join("/")===n.join("/")})},Wt.prototype.getFormControlIndexByBinding=function(e,t){var r=this.getFormControlsByFrameContext(e);return r?Object.values(r).findIndex(function(e){return e&&e.binding===t}):null},Wt.decorators=[{type:B.Injectable}],Wt.ctorParameters=function(){return[]},Wt);function Wt(){}var Kt=(zt.prototype.getFrameContextsByTableName=function(e){if(!e)throw new Error("tableName 不能为空。");var t=this.repository&&this.repository.entityTypeInfo||null;if(!t)return null;var r=[];this.bindingPathService.getBindingPathsByTableName(t,e,r);var i=this.appContext&&this.appContext.frameContextManager.getFrameContexts()||[];return i&&0!==i.length?i.filter(function(e){return e&&e.viewModel&&e.viewModel.bindingPath.split("/").filter(function(e){return e}).join("/")===r.join("/")}):null},zt.prototype.getFrameContextsByPropertyPath=function(a,s){if(void 0===s&&(s="/"),!a)throw new Error("propertyPath 不能为空。");return(this.appContext&&this.appContext.frameContextManager.getFrameContexts()||[]).filter(function(e){var n=e&&e.form&&e.form.ngFormControls||{},o=e&&e.viewModel&&e.viewModel.bindingPath||"";return!!(n&&0<Object.keys(n).length)&&!!Object.keys(n).find(function(e){var t=n[e];if(!t||!t.binding)return!1;var r=t.binding.split(".").filter(function(e){return e}),i=o.split("/").filter(function(e){return e}).concat(r);return a.split(s).filter(function(e){return e}).join("/")===i.join("/")})})},zt.prototype.getFrameContextsByColumnName=function(r,t){var i=this;if(!r)throw new Error("bindingPath 不能为空。");if(!t)throw new Error("columnName 不能为空。");r=r.filter(function(e){return e});var e=this.repository&&this.repository.entityTypeInfo||null;if(!e)return null;var n=e.getTypeInfoByPath(r),o=(n&&n.getPropInfos()||[]).find(function(e){return e.metadataInfo&&(e.metadataInfo.originalDataField===t||e.metadataInfo.dataField===t)});return o&&o.metadataInfo?this.appContext.frameContextManager.getFrameContexts().filter(function(e){var t=i.formControlService.getFormControlsByFrameContext(e);return!(!t||Object.keys(t).length<1||(i.bindingPathService.getBindingPathsByFrameContext(e)||[]).join("/")!==r.join("/")||!Object.values(e.viewModel.form.ngFormControls).find(function(e){return e.binding===o.metadataInfo.path}))}):null},zt.prototype.getFrameContextsByBindingPath=function(t,r){return void 0===r&&(r=""),Array.isArray(t)&&(t=t.join("/")),(this.appContext&&this.appContext.frameContextManager.getFrameContexts()||[]).filter(function(e){return e&&e.namespace===r&&e.viewModel.bindingPath===t})},zt.decorators=[{type:B.Injectable}],zt.ctorParameters=function(){return[{type:B.Injector},{type:L.AppContext},{type:L.FrameContext},{type:L.Repository},{type:qt},{type:Ht}]},zt);function zt(e,t,r,i,n,o){this.injector=e,this.appContext=t,this.frameContext=r,this.repository=i,this.bindingPathService=n,this.formControlService=o}var Jt=(Yt.prototype.focusInvalidInput=function(e,t){if(e&&e.length){var r=null,i=this.selectFirstVerifyInformation(e,t);i&&(r=i.targetField)&&this.focusElement(r,t)&&(e.focused=!0)}},Yt.prototype.focusGridCell=function(e,t){if(e&&e.length&&1!=e.focused&&!0!==t.disabled){var r=null,i=null,n=this.selectFirstVerifyInformation(e);n&&(r=n.targetField,i=n.id,e.focused=!0,t.editCell(i,r))}},Yt.prototype.updateVerifyInformationsIndex=function(e,s){var c=this;return(e=e.filter(function(e){var t=c.getFrameContextsByPropertyPath(e.fullPath,"/");return!(!t||!t.filter(function(e){return e&&e.frameId===c.frameContext.frameId}))})).map(function(e){var t=-1;if(e){if(s&&e.targetField){var r=c.getInputElementById(e.targetField,s);t=r&&r.getAttribute("tabindex")||-1,t=Number(t)}var i=c.frameContext,n=i.index+1;if(e.tabIndex=t,e.domIndex=-1,e.frameIndex=-1,e.position=t,i){var o=e.fullPath&&c.getFieldIndex(i,e.fullPath)||0;if(0<o){var a=e.index||0;e.domIndex=o,e.frameIndex=i.index,e.position=0<t?t:1e3*n+1e3*a+o}}}return e})},Yt.prototype.isGridComponent=function(e){return e?!!e.viewModel.dataGridColumnsName:undefined},Yt.prototype.getColumnIndex=function(e,a){a=a.split("/").filter(function(e){return e}).join("/");var s=e.viewModel.bindingPath.split("/").filter(function(e){return e}),t=e.viewModel.dataGridColumnsName||null,c=e.index+1;if(!t)return undefined;var u=e.viewModel[t];if(!u||u.length<1)return undefined;u=u.reduce(function(e,t){return Array.isArray(t)?e.concat(t):e.concat([t])},[]);for(var l=-1,r=function(e){var t=u[e],r=t&&t.field&&t.field.split(".").filter(function(e){return e})||null;if(!r)return"continue";if(s.concat(r).join("/")===a){var i=t.fixed;if(i){var n=u.filter(function(e){return e.fixed===i}),o=p.getIndexFromColumns(n,a);l="left"===i?5e3*c+o:1e4*c+1e3+o}else l=1e4*c+e;return"break"}},p=this,i=0;i<u.length&&"break"!==r(i);i++);return l},Yt.prototype.getIndexFromColumns=function(e,r){var i=this.frameContext.viewModel.bindingPath.split("/").filter(function(e){return e});return e.findIndex(function(e){var t=e&&e.field&&e.field.split(".").filter(function(e){return e})||null;return!!t&&i.concat(t).join("/")===r})},Yt.prototype.selectFirstVerifyInformation=function(e,t){return(e=this.updateVerifyInformationsIndex(e,t)).sort(function(e,t){return Number(e.position)-Number(t.position)}),e&&0<e.length&&e[0]||null},Yt.prototype.getInputElementById=function(e,t){var r=t.nativeElement.ownerDocument.getElementById(e)||null;if(r&&"INPUT"!==r.tagName){var i=r.getElementsByTagName("input");i.length&&(r=i[0])}return r},Yt.prototype.getFrameContextsByPropertyPath=function(a,s){return void 0===s&&(s="/"),a?(this.frameContext&&this.frameContext.appContext.frameContextManager.getFrameContexts()||[]).filter(function(e){var n=e&&e.form&&e.form.ngFormControls||{},o=e&&e.viewModel&&e.viewModel.bindingPath||"";return!!(n&&0<Object.keys(n).length)&&!!Object.keys(n).find(function(e){var t=n[e];if(!t||!t.binding)return!1;var r=t.binding.split(".").filter(function(e){return e}),i=o.split("/").filter(function(e){return e}).concat(r);return a.split(s).filter(function(e){return e}).join("/")===i.join("/")})}):[]},Yt.prototype.getFormControlIndexByBindingPath=function(i,e){var t=this.getFormControlsByFrameContext(i);if(!t)return null;var n=e.split("/").filter(function(e){return e});return Object.values(t).findIndex(function(e){if(!e)return!1;var t=i.viewModel.bindingPath.split("/").filter(function(e){return e}),r=e.binding.split(".").filter(function(e){return e});return t.concat(r).join("/")===n.join("/")})},Yt.prototype.getFieldIndex=function(e,t){return this.isGridComponent(e)?this.getColumnIndex(e,t):this.getFormControlIndexByBindingPath(e,t)},Yt.prototype.getFormControlsByFrameContext=function(e){return e&&e.form&&e.form.ngFormControls||null},Yt.prototype.focusElement=function(e,t){var r=!1,i=t.nativeElement.ownerDocument.getElementById(e);if(i){var n=t.nativeElement.ownerDocument.querySelectorAll("#"+e);if(n&&1<n.length)return r;if("INPUT"!==i.tagName){var o=i.getElementsByTagName("input");o.length&&(i=o[0])}i.focus(),r=!0}return r},Yt.prototype.focus=function(e,t){if(e)if(null!==e.index){var r=this.getGridRef(t);r&&setTimeout(function(){r.editCell(e.id,e.targetField)},0)}else{var i=this.getComponentRef(t),n=e.targetField;this.focusById(n,i)}},Yt.prototype.focusById=function(e,t){var r=t&&t.nativeElement.ownerDocument||window.document;if(r){var i=r.getElementById(e);if("INPUT"!==i.tagName){var n=i.getElementsByTagName("input");if(n.length){var o=n[0];o&&"function"==typeof o.focus&&o.focus()}}else i.focus()}},Yt.prototype.getComponentRef=function(e){return this.frameContext&&this.frameContext.injector.get(B.ElementRef,null)||null},Yt.prototype.getGridRef=function(e){var n=this,t=e.namespace,r=e.viewModel.bindingPath,i=(this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(t)||[]).filter(function(e){return e.viewModel&&e.viewModel.bindingPath.split("/").filter(function(e){return e}).toString()===r.split("/").filter(function(e){return e}).toString()}),o=null;return i&&i.every(function(e){var t=e.frameId,r=n.frameContext.appContext.componentManager.getComponentsByFrameId(t);if(!r)return!0;var i=Array.from(r.values()).find(function(e){return e&&"DatagridComponent"===e.__component_type__});return!i||(o=i,!1)}),o},Yt.decorators=[{type:B.Injectable}],Yt.ctorParameters=function(){return[{type:L.Repository},{type:L.FrameContext},{type:Kt},{type:Ht}]},Yt);function Yt(e,t,r,i){this.repository=e,this.frameContext=t,this.frameContextService=r,this.formControlService=i}var Gt="iframePoster",$t="iframeReceiver",Qt="repository",Xt="tabId=",Zt=(er.prototype.init=function(){this.top.topMap=this.top.topMap||{},this.changeItem=this.changeItem.bind(this)},er.prototype.setBykey=function(e,t){this.top.topMap=this.top.topMap||{},this.top.topMap[this.tabId]=this.top.topMap[this.tabId]||{},this.top.topMap[this.tabId][e]=t},er.prototype.getByKey=function(e){return(this.top.topMap[this.tabId]||{})[e]},er.prototype.setIframePoster=function(){this.getByKey[Gt]||this.setBykey(Gt,this.itemChangePoster)},er.prototype.getIframePoster=function(){this.itemChangePoster=this.getByKey($t),this.setBykey($t,this.itemChangeReceiver)},er.prototype.changeItem=function(e,r,t){var i=this,n=this.frameContext.getVirtualRootFrameContext().frameComponent.isDialogRootComponent||!1;return this.tabId=n?window.location.hash.split(Xt)[1].slice(0,window.location.hash.split(Xt)[1].indexOf("&")):t,this.itemChangeReceiver=this.getByKey($t),T.Observable.create(function(t){i.getNextItemByCurrentId(r,e).subscribe(function(e){t.next(e)})})},er.prototype.setRepository=function(){window.location.hash.includes(Xt)&&(this.tabId=window.location.hash.split(Xt)[1].slice(0,window.location.hash.split(Xt)[1].indexOf("&")),this.setBykey(Qt,this.frameContext.repository),this.setIframePoster(),this.getIframePoster())},er.prototype.getNextItemByCurrentId=function(r,e){var t=this.getByKey(Qt),i=t.entityCollection.paginationInfo,n=i.pageSize,o=i.pageIndex,a=i.total,s=null,c=t.entityCollection.getAllEntities();if(c.find(function(e,t){e.id===r&&(s=t)}),null===s){if(c.length)switch(e){case"prev":return y.of(c[c.length-1].id);case"next":return this.notifyService.info(this.languageService.changeToLast,{hideTitle:!0}),y.of(null)}return y.of(null)}var u=s;switch(e){case"prev":return 0===s&&1!==o?t.getEntities([],[],n,o-1).pipe(R.switchMap(function(e){return u=n-1,y.of(e[u].id)})):(0===s&&1===o?this.notifyService.info(this.languageService.changeToFirst,{hideTitle:!0}):u=s-1,y.of(c[u].id));case"next":return s+1+1>c.length?(o-1)*n+s+1<a?t.getEntities([],[],n,o+1).pipe(R.switchMap(function(e){return y.of(e[0].id)})):(this.notifyService.info(this.languageService.changeToLast,{hideTitle:!0}),y.of(c[u].id)):(u=s+1,y.of(c[u].id))}},er.decorators=[{type:B.Injectable}],er.ctorParameters=function(){return[{type:L.Repository},{type:L.FrameContext},{type:De},{type:Y}]},er);function er(e,t,r,i){this.repository=e,this.frameContext=t,this.notifyService=r,this.languageService=i,this.top=top,this.itemChangePoster=new T.Subject,this.itemChangeReceiver=new T.Subject}var tr=(rr.prototype.load=function(e,t){var r=this;e=e||"[]",t=t||"[]",e=this.mergeFilterConditions(e),t=this.mergeSortConditions(t);var i=this.loadingService.showLoadingWithDelay(200);return this.repository.getEntities(JSON.parse(e),JSON.parse(t),null,null).pipe(R.tap(function(){r.fireQueryEvent(e),r.loadingService.hideDelayLoading(i)},function(e){r.loadingService.hideDelayLoading(i),r.formErrorService.exception(r.languageService.loadFailed,e)}))},rr.prototype.filter=function(e,t){var r=this;e=e||"[]",t=t||"[]",e=this.mergeFilterConditions(e),t=this.mergeSortConditions(t);var i=this.loadingService.showLoadingWithDelay(200);return this.repository.filter(JSON.parse(e),JSON.parse(t)).pipe(R.tap(function(){r.fireQueryEvent(e),r.loadingService.hideDelayLoading(i)},function(e){r.loadingService.hideDelayLoading(i),r.formErrorService.exception(r.languageService.loadFailed,e)}))},rr.prototype.query=function(e,t,r,i){var n=this;e=""===e?"[]":e,t=""===t?"[]":t,e=this.mergeFilterConditions(e),t=this.mergeSortConditions(t);var o=this.loadingService.showLoadingWithDelay(5);return this.repository.getEntities(JSON.parse(e),JSON.parse(t),r,i).pipe(R.tap(function(){n.fireQueryEvent(e),n.loadingService.hideDelayLoading(o)},function(e){n.loadingService.hideDelayLoading(o),n.formErrorService.exception(n.languageService.queryFailed,e)}))},rr.prototype.queryChild=function(e,t){var r=this,i=L.EntityPathConverter.toEntityPathArray(this.viewModel.bindingPath,this.bindingData),n=i.slice(0,i.length-1),o=this.viewModel.bindingPath.split("/").filter(function(e){return e}),a=this.viewModel.bindingData,s=o[o.length-1];s=s.substr(0,s.length-1);var c=o.slice(0,o.length-1);if(a.getValue(c)){this.viewModel.frameContext.appContext.params["delete"]("retrieveing");var u="/"+s,l=this.repository.entityCollection.getPaginationConfigByPath(u);if(l){var p=l.pageIndex,d=void 0===p?1:p,f=l.pageSize,h=void 0===f?0:f;if(0!==h)return this.viewModel.frameContext.appContext.params.set("queryChild",!0),this.repository.queryChild(n,d,h).pipe(R.tap(function(){},function(e){r.formErrorService.exception(r.languageService.queryFailed,e)}))}}},rr.prototype.append=function(){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.messagePipe&&this.messagePipe.next({messageType:"append"}),this.repository.append().pipe(R.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.appendFailed,e)}))},rr.prototype.insert=function(e){var t=this;void 0===e&&(e=-1);var r=this.loadingService.showLoadingWithDelay(500);return this.messagePipe&&this.messagePipe.next({messageType:"insert"}),this.repository.insert(e).pipe(R.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.appendFailed,e)}))},rr.prototype.updateChanges=function(){return this.repository.updateAllChanges()},rr.prototype.save=function(e){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"save"});var r=this.loadingService.showLoadingWithDelay(500);return this.repository.applyChanges().pipe(R.tap(function(){t.loadingService.hideDelayLoading(r),e&&e.trim()?t.formNotifyService.success(e,{hideTitle:!0}):t.formNotifyService.success(t.languageService.saveSuccess,{hideTitle:!0})},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.multiSaveFailed,e)}))},rr.prototype.remove=function(i,n,o,e,a){var s=this;return void 0===e&&(e=!0),void 0===a&&(a=!0),this.messagePipe&&this.messagePipe.next({messageType:"delete"}),i?(a=!1!==a&&"false"!==a,((e=!1!==e&&"false"!==e)?this.msgService.question(this.languageService.confirmDeletion):T.of(!0)).pipe(R.concatMap(function(e){if(!e)return T.empty();n=!1!==n&&"false"!==n;var t=s.loadingService.showLoadingWithDelay(500),r=s.repository.removeById(i,n);return r?r.pipe(R.tap(function(){s.loadingService.hideDelayLoading(t),o&&o.trim()?s.formNotifyService.success(o,{hideTitle:!0}):s.formNotifyService.success(s.languageService.deleteSuccess,{hideTitle:!0})},function(e){s.loadingService.hideDelayLoading(t),s.formErrorService.exception(s.languageService.deleteFailed,e)}),R.switchMap(function(){return!0!==n&&a?T.empty():T.of([])})):T.empty()}))):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.empty())},rr.prototype.removeRows=function(i,n,o,e){var a=this;if(void 0===e&&(e=!1),this.messagePipe&&this.messagePipe.next({messageType:"removeRows"}),e="true"===e||!0===e,!i||0===i.length){var t=this.bindingData.list.currentId;if(!0!==e||!t)return this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.empty();i=[this.bindingData.list.currentId]}return this.msgService.confirm(this.languageService.confirmDeletion).pipe(R.concatMap(function(e){if(!e)return T.empty();void 0===n&&(n=!0),"string"==typeof n&&(n="false"!==n.toLowerCase()),n=!1!==n;var t=a.loadingService.showLoadingWithDelay(500),r=a.repository.removeByIds(i,n);return r?r.pipe(R.tap(function(){a.loadingService.hideDelayLoading(t),o&&o.trim()?a.formNotifyService.success(o,{hideTitle:!0}):a.formNotifyService.success(a.languageService.deleteSuccess,{hideTitle:!0})},function(e){a.loadingService.hideDelayLoading(t),a.formErrorService.exception(a.languageService.deleteFailed,e)}),R.switchMap(function(){return T.of([])})):T.empty()}))},rr.prototype.refreshAfterRemoving=function(e,t){return this.viewModel&&e&&t?this.viewModel.frameContext.injector.get(st,null).execute(e,t):this.load()},rr.prototype.refresh=function(e,t){return this.viewModel&&e&&t?this.viewModel.frameContext.injector.get(st,null).execute(e,t):this.load()},rr.prototype.cancel=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"cancel"});var e=this.repository;return!1===I.BefRepositoryUtil.isExistUnsaveData(e)?this._cancel():this.msgService.question(this.languageService.cancelWithoutSave).pipe(R.switchMap(function(e){return!1===e?T.EMPTY:t._cancel()}))},rr.prototype.revert=function(){return this._cancel()},rr.prototype._cancel=function(){var t=this,r=this.loadingService.showLoadingWithDelay(500);return this.repository.cancelChanges().pipe(R.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.cancelFailed,e)}))},Object.defineProperty(rr.prototype,"messagePipe",{get:function(){if(this.viewModel&&this.viewModel.frameContext){var e=this.viewModel.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),rr.prototype.fireQueryEvent=function(e){var t=this.messagePipe;t&&t.next({type:"query"})},rr.prototype.mergeFilterConditions=function(e){"string"==typeof e&&(e=JSON.parse(e)||[]);var t=e,r=this.viewModel&&this.viewModel.bindingPath||null;if(r){var i=this.viewModel&&this.viewModel.frameContext.repository.filterConditionManager.getFilters(r)||[],n=Array.from(i);if(n&&0<n.length){if(0<t.length){var o=t[t.length-1];o&&(o.hasOwnProperty("Relation")&&delete o.Relation,o.relation=1)}t.push.apply(t,te(n))}}return JSON.stringify(t)},rr.prototype.mergeSortConditions=function(e){"string"==typeof e&&(e=JSON.parse(e)||[]);var t=e,r=this.viewModel&&this.viewModel.bindingPath||null;if(r){var i=this.viewModel&&this.viewModel.frameContext.repository.sortConditionManager.getConditionsByBindingPath(r,function(e){return"asc"===e?0:1})||[],n=Array.from(i);if(n&&0<n.length)return JSON.stringify(n)}return JSON.stringify(t)},rr.decorators=[{type:B.Injectable}],rr.ctorParameters=function(){return[{type:Pe},{type:L.Repository},{type:L.BindingData},{type:q},{type:Y,decorators:[{type:B.Optional}]},{type:De},{type:xe},{type:L.ViewModel},{type:bt}]},rr);function rr(e,t,r,i,n,o,a,s,c){this.msgService=e,this.repository=t,this.bindingData=r,this.loadingService=i,this.languageService=n,this.formNotifyService=o,this.formErrorService=a,this.viewModel=s,this.filterConditionService=c,n||(this.languageService=Y.getInstance())}var ir=(nr.prototype.add=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"add"});var e=this.getPath(),r=this.loadingService.showLoadingWithDelay(500);return this.repository.appendByPath(e).pipe(R.tap(function(){t.loadingService.hideDelayLoading(r)},function(e){t.loadingService.hideDelayLoading(r),t.formErrorService.exception(t.languageService.addFailed,e)}))},nr.prototype.insert=function(e){var t=this;void 0===e&&(e=-1),this.messagePipe&&this.messagePipe.next({messageType:"insert"});var r=this.getPath(),i=this.loadingService.showLoadingWithDelay(500);return this.repository.insertByPath(r,e).pipe(R.tap(function(){t.loadingService.hideDelayLoading(i)},function(e){t.loadingService.hideDelayLoading(i),t.formErrorService.exception(t.languageService.addFailed,e)}))},nr.prototype.remove=function(e,t){var r=t||"";return this.innerRemove(e,!1,r)},nr.prototype.removeWithoutConfirm=function(e){return this.innerRemove(e,!0,"")},nr.prototype.removeChildrenByIds=function(i,n){var o=this;return i?this.msgService.confirm(this.languageService.confirmDeletion).pipe(R.concatMap(function(e){if(!e)return T.EMPTY;var t=o.getPath(),r=o.loadingService.showLoadingWithDelay(500);return o.repository.batchRemoveByPath(t,i).pipe(R.tap(function(){o.loadingService.hideDelayLoading(r),n&&n.trim()?o.formNotifyService.success(n,{hideTitle:!0}):o.formNotifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.formErrorService.exception(o.languageService.deleteFailed,e)}))})):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.EMPTY)},nr.prototype.innerRemove=function(i,e,n){var o=this;return this.messagePipe&&this.messagePipe.next({messageType:"remove"}),i?(!1===e?this.msgService.question(this.languageService.confirmDeletion):T.of(!0)).pipe(R.concatMap(function(e){if(!e)return T.empty();var t=o.getPath(),r=o.loadingService.showLoadingWithDelay(500);return o.repository.removeByPath(t,i).pipe(R.tap(function(){o.loadingService.hideDelayLoading(r),n&&n.trim()?o.formNotifyService.success(n,{hideTitle:!0}):o.formNotifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.formErrorService.exception(o.languageService.deleteFailed,e)}))})):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.empty())},nr.prototype.removeAndSave=function(i,n){var o=this;return this.messagePipe&&this.messagePipe.next({messageType:"removeAndSave"}),i?this.msgService.confirm(this.languageService.confirmDeletion).pipe(R.concatMap(function(e){if(!e)return T.empty();var t=o.getPath(),r=o.loadingService.showLoadingWithDelay(500);return o.repository.removeByPath(t,i).pipe(R.switchMap(function(){var e=o.viewModel.bindingData.list.currentId;return o.repository.applyChangesById(e)}),R.tap(function(){o.loadingService.hideDelayLoading(r),n&&n.trim()?o.formNotifyService.success(n,{hideTitle:!0}):o.formNotifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.formErrorService.exception(o.languageService.deleteFailed,e)}))})):(this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.empty())},nr.prototype.move=function(c,u,e){var l=this;if(e&&("string"==typeof e&&(e=e.split(",").filter(function(e){return e})),this.viewModel&&this.viewModel.bindingPath)){var p=this.viewModel.bindingData.getList();!p||p.length<1||e.forEach(function(e){var t=p.getIndexById(e);if(-1!==t){var r=p.findById(e),i=r.getValue(u),n=t+("up"===c?-1:1);if(!(n<0||n>p.length)){var o=p.getIdByIndex(n),a=p.findById(o),s=a[u];l.isNullOrEmpty(i)&&l.isNullOrEmpty(s)||(p.swapById(e,o),a.setValue(u,i,!0,!0),r.setValue(u,s,!0,!0))}}})}},nr.prototype.isNullOrEmpty=function(e){return""===e||null===e||e===undefined},nr.prototype.getPath=function(){var e=this.viewModel.bindingPath,t="/"+this.viewModel.bindingData.list.currentId,r=e.split("/");if(0<r.length)for(var i=1;i<r.length-1;i++){var n=r[i],o=this.viewModel.bindingData[n];if(!o||!o.currentId)throw this.formNotifyService.warning(this.languageService.plsSelectDetailFormData,{hideTitle:!0}),Error("获取子表完整路径出错，找不到"+o+"对应的子表，或对应子表没有当前行。");t+="/"+n+"/"+o.currentId}return t+="/"+r[r.length-1]},Object.defineProperty(nr.prototype,"messagePipe",{get:function(){if(this.viewModel&&this.viewModel.frameContext){var e=this.viewModel.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),nr.decorators=[{type:B.Injectable}],nr.ctorParameters=function(){return[{type:Pe},{type:L.Repository},{type:q},{type:L.ViewModel},{type:Y,decorators:[{type:B.Optional}]},{type:De},{type:xe}]},nr);function nr(e,t,r,i,n,o,a){this.msgService=e,this.repository=t,this.loadingService=r,this.viewModel=i,this.languageService=n,this.formNotifyService=o,this.formErrorService=a,n||(this.languageService=Y.getInstance()),this.viewModel=i}var or=(Object.defineProperty(ar.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(ar.prototype,"restService",{get:function(){return this.repository.restService},enumerable:!0,configurable:!0}),Object.defineProperty(ar.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),ar);function ar(e){this.frameContext=e}var sr=(cr.prototype.selectFirstRootNode=function(e,t){var r=e.list.toJSON(),i=this.getFirstNodeId(r,t);this.selectedNode(e,t,i)},cr.prototype.selectNodeByBindingList=function(e,t,r){var i=e.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),setTimeout(function(){e.setCurrentId(o,!0,!0)},0)},cr.prototype.selectedNode=function(e,t,r){var i=e.list.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),!0!==e.rowSelectedEventSuspend&&setTimeout(function(){e.list.currentId=null,e.list.setCurrentId(o,!0,!0)},0)},cr.prototype.hasChildNodes=function(e,t,r){return!1===this.getNodeDataById(e,r)[t].isDetail},cr.prototype.getFirstNodeId=function(e,t){var r=e.find(function(e){return 1===e[t].layer});if(!r){var i=this.getRootLayer(e,t);r=e.find(function(e){return e[t].layer===i})}return r?r.id:""},cr.prototype.getRootLayer=function(e,t){var r=null;if(e&&Array.isArray(e)){var i=e.map(function(e){return e[t].layer}),n=Math.min.apply(Math,i);isNaN(n)||(r=n)}return r},cr.prototype.getNextNodeId=function(e,t,r){var i=e.find(function(e){return e.id===r}),n=i[t].layer-1,o=i[t].parentElement,a=this.getChildNodesData(e,t,n,o);if(1!==a.length)return this.getNextSiblingNodeId(a,r);var s=e.find(function(e){return e.id===o});return s?s.id:this.getFirstNodeId(e,t)},cr.prototype.getNextSiblingNodeId=function(e,t){if(e.length<=1)return"";var r=e.findIndex(function(e){return e.id===t});return e[r===e.length-1?r-1:r+1].id},cr.prototype.getChildNodesData=function(e,i,n,o){return e.filter(function(e){var t=e[i].layer,r=e[i].parentElement;return t===n+1&&o==r})},cr.prototype.getNodeDataById=function(e,t){var r=e.find(function(e){return e.id===t});return r||null},cr);function cr(){}var ur=(lr.prototype.selectFirstRootNode=function(e,t){var r=e.list.toJSON(),i=this.getFirstNodeId(r,t);this.selectedNode(e,t,i)},lr.prototype.selectNodeByBindingList=function(e,t,r){var i=e.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),setTimeout(function(){e.setCurrentId(o,!0,!0)},0)},lr.prototype.selectedNode=function(e,t,r){var i=e.list.toJSON(),n=this.getNodeDataById(i,r),o=r;n||(o=this.getFirstNodeId(i,t)),!0!==e.rowSelectedEventSuspend&&setTimeout(function(){e.list.currentId=null,e.list.setCurrentId(o,!0,!0)},0)},lr.prototype.hasChildNodes=function(e,t,r){return!1===this.getNodeDataById(e,r)[t].isDetail},lr.prototype.getFirstNodeId=function(e,t){var r=e.find(function(e){return 1===e[t].layer});if(!r){var i=this.getRootLayer(e,t);r=e.find(function(e){return e[t].layer===i})}return r?r.id:""},lr.prototype.getRootLayer=function(e,t){var r=null;if(e&&Array.isArray(e)){var i=e.map(function(e){return e[t].layer}),n=Math.min.apply(Math,i);isNaN(n)||(r=n)}return r},lr.prototype.getNextNodeId=function(e,t,r){var i=e.find(function(e){return e.id===r}),n=i[t].path,o=i[t].layer-1,a=n.substring(0,n.length-4),s=this.getChildNodesData(e,t,o,a);if(1!==s.length)return this.getNextSiblingNodeId(s,r);var c=e.find(function(e){return e[t].path===a});return c?c.id:this.getFirstNodeId(e,t)},lr.prototype.getNextSiblingNodeId=function(e,t){if(e.length<=1)return"";var r=e.findIndex(function(e){return e.id===t});return e[r===e.length-1?r-1:r+1].id},lr.prototype.getChildNodesData=function(e,i,n,o){return e.filter(function(e){var t=e[i].layer,r=e[i].path;return t===n+1&&r.startsWith(o)})},lr.prototype.getNodeDataById=function(e,t){var r=e.find(function(e){return e.id===t});return r||null},lr);function lr(){}var pr=(dr.getInstance=function(e){var t=null;switch(e){case"path":t=new ur;break;case"parent":t=new sr}return t},dr);function dr(){}var fr=(hr.prototype.addSibling=function(r,e){var t=r.restService,i=t.baseUri+"/service/parenthierarchycreatesibling",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(R.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},hr.prototype.addChild=function(r,e){var t=r.restService,i=t.baseUri+"/service/parenthierarchycreatechildlayer",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(R.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},hr.prototype.addSubSibling=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodeparenthierarchycreatesibling",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(R.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},hr.prototype.addSubChild=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodeparenthierarchycreatechildlayer",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(R.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},hr.prototype.getPaths=function(e,t){var r="";if(e&&0<e.length&&t&&0<t.length)for(var i=0;i<t.length;i++)e[i]&&(r=(r=r+"/"+t[i])+"/"+e[i]+"s");return r},hr.prototype.loadByParentId=function(n,o,a,e,t,s,r,c,i){var u=this;void 0===s&&(s=!1),void 0===i&&(i=!1);var l=this.getChildren(n,o,a);if(l&&0<l.length&&!i)return T.of(l);var p=n.restService,d=this.getHierarchyInfoById(n,o,a),f=this.getOriginalHierarchyInfoKey(n,o),h={FilterConditions:this.buildFiltersWithParent(f,d,e),SortConditions:t,IsUsePagination:r&&0<r.pageSize||!1,Pagination:{PageIndex:r&&r.pageIndex||0,PageSize:r&&r.pageSize||0,PageCount:0,TotalCount:0}},g=p.buildRequestInfo();return p.extendQuery(h,g).pipe(R.map(function(e){var t=u.getPaginationInfo(e);a?t&&0!==t.pageSize&&c&&c.params.set("_NODE_"+a+"_PAGINATION_INFO_",t):t&&0!==t.pageSize&&c&&c.repository.entityCollection.updatePaginationInfoByPath("/",t),u.clearDescendantEntities(n,o,d,s);var r=e.returnValue.result,i=n.buildEntities(r);return s?n.entityCollection.addData(i):n.entityCollection.addEntities(i),i}))},hr.prototype.loadFullTree=function(s,c,e,t,r,i,n,u){var l=this,o=s.restService,a=o.baseUri+"/service/parentidfulltreequery",p=this.getHierarchyInfoById(s,c,e),d={body:{dataId:e||"",isUsePagination:!1,virtualPropertyName:t,pagination:{},fullTreeType:r,loadType:i,filter:this.buildEntityFilter(n,null,0,0),requestInfo:o.buildRequestInfo()}};return o.invoke(a,"PUT",null,d).pipe(R.tap(function(e){if(e.returnValue&&e.returnValue.selectedRowId&&u&&u.frameContext){var t=u.frameContext,r=t&&t.getVirtualRootFrameContext()||null;if(r){var i=e.returnValue.result,n=e.returnValue.selectedRowId,o=i.find(function(e){return e[s.primaryKey]===n})[c],a=l.getAllParentIds(o,i,c,s);r.params.set("_DEVKIT_expandRowIds",a.join(",")),r.params.set("_DEVKIT_selectedRowId",n),r.uiState.setPropertyValue("__DEVKIT__selectedRow",n)}}}),R.map(function(e){var t=u&&u.frozenCurrentRow||!1;l.clearDescendantEntities(s,c,p,t);var r=e.returnValue.result,i=s.buildEntities(r);return t?s.entityCollection.addData(i):s.entityCollection.addEntities(i),i}))},hr.prototype.buildFiltersWithParent=function(e,t,r){var i=r&&1<=r.length?1:0,n=t?t.layer:0,o=t?t.id:"",a=[{FilterField:e+".Layer",Value:n+1,Lbracket:null,Rbracket:null,Relation:1,Expresstype:0,Compare:0}];return o?a.push({FilterField:e+".ParentElement",Value:o,Lbracket:null,Rbracket:null,Relation:i,Expresstype:0,Compare:0}):a[0].Relation=i,a.concat(r)},hr.prototype.buildEntityFilter=function(e,t,r,i){return e||t||r||i?(t=t||[],(e=e||[])&&0<e.length&&(e[e.length-1].Relation=0),{FilterConditions:e,SortConditions:t,IsUsePagination:0!==r,Pagination:{PageIndex:i,PageSize:r,PageCount:0,TotalCount:0}}):null},hr.prototype.clearDescendantEntities=function(e,t,r,i){if(void 0===i&&(i=!1),r){var n=this.getChildNodes(e,t,r);i?e.entityCollection.removeEntities(function(e){var t=e[e.primaryKey];return n.includes(t)}):e.entityCollection.removeData(function(e){var t=e[e.primaryKey];return n.includes(t)})}else e.entityCollection.clear()},hr.prototype.getChildNodes=function(s,c,e){var u=this,l=e.id,p=e.layer,d=[];return s.entityCollection.getAllEntities().forEach(function(e){var t=e[c],r=t.parentElement,i=t.layer;if(p+1<=i&&r===l){var n=e[e.primaryKey];d.push(n);var o=u.getHierarchyInfoById(s,c,n),a=u.getChildNodes(s,c,o);a&&0<a.length&&(d=d.concat(a))}}),d},hr.prototype.getHierarchyInfoById=function(e,t,r){if(!r)return null;var i=e.entityCollection.getEntityById(r)[t].toJSON();return i.id=r,i},hr.prototype.getHierarchyInfo=function(e,t){return e[t]},hr.prototype.getOriginalHierarchyInfoKey=function(e,t){return L.FieldMetadataUtil.getNgObjects(e.entityType)[t].originalDataField},hr.prototype.getPaginationInfo=function(e){return e&&e.returnValue&&e.returnValue.pagination||null},hr.prototype.findParent=function(r,e,i){return e.find(function(e){var t=e[i];return t.layer===r.layer-1&&r.parentElement===t.parentElement})},hr.prototype.getAllParentIds=function(e,t,r,i){for(var n=this.findParent(e,t,r),o=[];n;)o.push(n[i.primaryKey]),n=this.findParent(n[r],t,r);return o},hr.prototype.getChildren=function(e,r,t){var i=this,n=this.getHierarchyInfoById(e,r,t);if(!n)return null;var o=n.layer,a=n.parentElement;return e.entityCollection.getEntities(function(e){var t=i.getHierarchyInfo(e,r);return t.layer!==o+1||t.parentElement!==a&&(a||t.parentElement)?null:e})},hr);function hr(){}var gr=(vr.prototype.addSibling=function(r,e){var t=r.restService,i=t.baseUri+"/service/pathhierarchycreatesibling",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(R.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},vr.prototype.addChild=function(r,e){var t=r.restService,i=t.baseUri+"/service/pathhierarchycreatechildlayer",n={dataID:e,requestInfo:t.buildRequestInfo()},o={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:n};return t.invoke(i,"PUT",null,o).pipe(R.map(function(e){var t=r.buildEntity(e.returnValue);return r.entityCollection.addEntity(t),t}))},vr.prototype.addSubSibling=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodepathhierarchycreatesibling",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(R.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},vr.prototype.addSubChild=function(r,i,n){var o=this,e=r.restService,t=e.baseUri+"/service/childnodepathhierarchycreatechildlayer",a={nodes:i,ids:n,requestInfo:e.buildRequestInfo()},s={headers:new x.HttpHeaders({"Content-Type":"application/json"}),body:a};return e.invoke(t,"PUT",null,s).pipe(R.map(function(e){var t=o.getPaths(i,n);return r.entityManager.appendEntityByPath(t,e.returnValue)}))},vr.prototype.getPaths=function(e,t){var r="";if(e&&0<e.length&&t&&0<t.length)for(var i=0;i<t.length;i++)e[i]&&(r=(r=r+"/"+t[i])+"/"+e[i]+"s");return r},vr.prototype.loadByParentId=function(n,o,a,e,t,s,r,c,i){var u=this;void 0===s&&(s=!1),void 0===i&&(i=!1);var l=this.getChildren(n,o,a);if(l&&0<l.length&&!i)return T.of(l);var p=n.restService,d=this.getHierarchyInfoById(n,o,a),f=this.getOriginalHierarchyInfoKey(n,o),h={FilterConditions:this.buildFiltersWithParent(f,d,e),SortConditions:t,IsUsePagination:r&&0<r.pageSize||!1,Pagination:{PageIndex:r&&r.pageIndex||0,PageSize:r&&r.pageSize||0,PageCount:0,TotalCount:0}},g=p.buildRequestInfo();return p.extendQuery(h,g).pipe(R.map(function(e){var t=u.getPaginationInfo(e);a?t&&0!==t.pageSize&&c&&c.params.set("_NODE_"+a+"_PAGINATION_INFO_",t):t&&0!==t.pageSize&&c&&c.repository.entityCollection.updatePaginationInfoByPath("/",t),u.clearDescendantEntities(n,o,d,s);var r=e.returnValue.result,i=n.buildEntities(r);return s?n.entityCollection.addData(i):n.entityCollection.addEntities(i),i}))},vr.prototype.loadFullTree=function(s,c,e,t,r,i,n,u){var l=this,o=s.restService,a=o.baseUri+"/service/parentidfulltreequery",p=this.getHierarchyInfoById(s,c,e),d={body:{dataId:e||"",isUsePagination:!1,virtualPropertyName:t,pagination:{},fullTreeType:r,loadType:i,filter:this.buildEntityFilter(n,null,0,0),requestInfo:o.buildRequestInfo()}};return o.invoke(a,"PUT",null,d).pipe(R.tap(function(e){if(e.returnValue&&e.returnValue.selectedRowId&&u&&u.frameContext){var t=u.frameContext,r=t&&t.getVirtualRootFrameContext()||null;if(r){var i=e.returnValue.result,n=e.returnValue.selectedRowId,o=i.find(function(e){return e[s.primaryKey]===n})[c],a=l.getAllParentIds(o,i,c,s);r.params.set("_DEVKIT_expandRowIds",a.join(",")),r.params.set("_DEVKIT_selectedRowId",n),r.uiState.setPropertyValue("__DEVKIT__selectedRow",n)}}}),R.map(function(e){var t=u&&u.frozenCurrentRow||!1;l.clearDescendantEntities(s,c,p,t);var r=e.returnValue.result,i=s.buildEntities(r);return t?s.entityCollection.addData(i):s.entityCollection.addEntities(i),i}))},vr.prototype.buildFiltersWithParent=function(e,t,r){var i=r&&1<=r.length?1:0,n=[{FilterField:e+".Layer",Value:(t?t.layer:0)+1,Lbracket:null,Rbracket:null,Relation:1,Expresstype:0,Compare:0}],o=t?t.path:"";return o?n.push({FilterField:e+".Path",Value:o,Lbracket:null,Rbracket:null,Relation:i,Expresstype:0,Compare:7}):n[0].Relation=i,n.concat(r)},vr.prototype.buildEntityFilter=function(e,t,r,i){return e||t||r||i?(t=t||[],(e=e||[])&&0<e.length&&(e[e.length-1].Relation=0),{FilterConditions:e,SortConditions:t,IsUsePagination:0!==r,Pagination:{PageIndex:i,PageSize:r,PageCount:0,TotalCount:0}}):null},vr.prototype.clearDescendantEntities=function(e,n,t,r){if(void 0===r&&(r=!1),t){var o=t.path,a=t.layer;r?e.entityCollection.removeData(function(e){var t=e[n],r=t.path,i=t.layer;return a<i&&r.startsWith(o)}):e.entityCollection.removeEntities(function(e){var t=e[n],r=t.path,i=t.layer;return a<i&&r.startsWith(o)})}else e.entityCollection.clear()},vr.prototype.getHierarchyInfoById=function(e,t,r){return r?e.entityCollection.getEntityById(r)[t].toJSON():null},vr.prototype.getOriginalHierarchyInfoKey=function(e,t){return L.FieldMetadataUtil.getNgObjects(e.entityType)[t].originalDataField},vr.prototype.getPaginationInfo=function(e){return e&&e.returnValue&&e.returnValue.pagination||null},vr.prototype.findParent=function(r,e,i){return e.find(function(e){var t=e[i];return t.layer===r.layer-1&&r.path.startsWith(t.path)})},vr.prototype.getAllParentIds=function(e,t,r,i){for(var n=this.findParent(e,t,r),o=[];n;)o.push(n[i.primaryKey]),n=this.findParent(n[r],t,r);return o},vr.prototype.getHierarchyInfo=function(e,t){return e[t]},vr.prototype.getChildren=function(e,r,t){var i=this,n=this.getHierarchyInfoById(e,r,t);if(!n)return null;var o=n.layer,a=n.path;return e.entityCollection.getEntities(function(e){var t=i.getHierarchyInfo(e,r);return t.layer===o+1&&t.path.startsWith(a)?e:null})},vr);function vr(){}var yr=(mr.getInstance=function(e){var t=null;switch(e){case"path":t=new gr;break;case"parent":t=new fr}return t},mr);function mr(){}var Sr,Cr=(Q(br,Sr=or),Object.defineProperty(br.prototype,"hierarchyInfoKey",{get:function(){return this.virtualRootFrameContext.getParam("hierarchyInfoKey")},enumerable:!0,configurable:!0}),Object.defineProperty(br.prototype,"virtualRootFrameContext",{get:function(){return this.frameContext.getVirtualRootFrameContext()},enumerable:!0,configurable:!0}),br.prototype.load=function(e,t){var r=this,i=this.parseConditions(e),n=this.parseConditions(t),o=0===this.repository.entityCollection.count(),a=this.loadingService.showLoadingWithDelay(500);return this.repository.getEntities(i,n,null,null).pipe(R.tap(function(){if(1==o){var e=r.getHierarchyType(),t=pr.getInstance(e);null!==t&&t.selectFirstRootNode(r.bindingData,r.hierarchyInfoKey)}r.loadingService.hideDelayLoading(a)},function(e){r.loadingService.hideDelayLoading(a),r.errorService.exception(r.languageService.loadFailed,e)}))},br.prototype.loadByLevel=function(e,t,n){var o=this;this.setLoadByLevelState(e,t);var r=this.parseConditions(e),i=this.parseConditions(t),a=this.getIdToExpand(),s=0===this.repository.entityCollection.count();n===undefined&&(n=!1),"boolean"!=typeof n&&(n="true"===n);var c=this.getHierarchyType(),u=yr.getInstance(c);if(null===u)return T.empty();var l=this.loadingService.showLoadingWithDelay(500),p=this.buildPaginationInfo(a),d=this.frameContext.params.get("_RELOAD_CHILDREN_")||!1;return u.loadByParentId(this.repository,this.hierarchyInfoKey,a,r,i,n,p,this.frameContext,d).pipe(R.tap(function(e){if(o.frameContext.params["delete"]("_RELOAD_CHILDREN_"),1==s){var t=pr.getInstance(c);null!==t&&t.selectFirstRootNode(o.bindingData,o.hierarchyInfoKey)}var r=o.bindingData.list.currentItem.primaryKeyValue;if(n&&(e.find(function(e){return e.primaryValue===r})&&o.setCurrentId(r),!o.repository.entityCollection.getEntityById(r))){var i=e&&Array.isArray(e)&&0<e.length&&e[0].primaryValue||null;i&&o.setCurrentId(i)}o.loadingService.hideDelayLoading(l)},function(e){o.loadingService.hideDelayLoading(l),o.errorService.exception(o.languageService.loadFailed,e)}))},br.prototype.loadFullTree=function(e,t,r,i,o){var a=this;if("string"!=typeof t)throw new Error("ArgumentError: fullTreeType 不能为空且必须为字符串。");if("string"!=typeof r)throw new Error("ArgumentError: loadType 不能为空且必须为字符串。");o===undefined&&(o=!1),"boolean"!=typeof o&&(o="true"===o);var s=this.virtualRootFrameContext;s.params["delete"]("_DEVKIT_expandRowIds"),s.params["delete"]("_DEVKIT_selectedRowId"),s.uiState.setPropertyValue("__DEVKIT__selectedRow",null);var n=this.parseConditions(i),c=this.getIdToExpand(),u=0===this.repository.entityCollection.count(),l=this.getHierarchyType(),p=yr.getInstance(l);if(null===p)return T.EMPTY;var d=this.loadingService.showLoadingWithDelay(500),f={frameContext:this.frameContext,frozenCurrentRow:o};return p.loadFullTree(this.repository,this.hierarchyInfoKey,c,e,t,r,n,f).pipe(R.tap(function(e){var t=s.params.get("_DEVKIT_selectedRowId");if(1==u||!t){var r=pr.getInstance(l);null!==r&&r.selectFirstRootNode(a.bindingData,a.hierarchyInfoKey)}var i=a.bindingData.list.currentItem.primaryKeyValue;if(o&&(e.find(function(e){return e.primaryValue===i})&&a.setCurrentId(i),!a.repository.entityCollection.getEntityById(i)&&e&&0<e.length)){var n=e&&Array.isArray(e)&&0<e.length&&e[0].primaryValue||null;n&&a.setCurrentId(n)}a.loadingService.hideDelayLoading(d)},function(e){a.loadingService.hideDelayLoading(d),a.errorService.exception(a.languageService.loadFailed,e)}))},br.prototype.getIdToExpand=function(){var e=this.virtualRootFrameContext.getParam("TREE_LATEST_EXPANDED_ID")||[],t=e.pop();return this.virtualRootFrameContext.setParam("TREE_LATEST_EXPANDED_ID",e),t},br.prototype.setIdToExpand=function(e){var t=this.virtualRootFrameContext.getParam("TREE_LATEST_EXPANDED_ID")||[];t.push(e),this.virtualRootFrameContext.setParam("TREE_LATEST_EXPANDED_ID",t)},br.prototype.parseConditions=function(e){var t=e&&""!==e?e:"[]";return JSON.parse(t)},br.prototype.addSibling=function(e){var t=this;(e=e||this.bindingData.list.currentId)&&"undefined"!==e||(e="");var r=this.bindingData.list.currentId,i=this.getHierarchyType(),n=this.loadingService.showLoadingWithDelay(500),o=yr.getInstance(i);if(!o)throw new Error(this.languageService.errorHierarchyKey);return o.addSibling(this.repository,e).pipe(R.tap(function(){t.virtualRootFrameContext.setParam("IS_ADD",!0),t.virtualRootFrameContext.setParam("LAST_MODIFIED_ID",r),t.loadingService.hideDelayLoading(n)},function(e){t.loadingService.hideDelayLoading(n),t.errorService.exception(t.languageService.addSiblingFailed,e)}))},br.prototype.addChild=function(e){var t=this;if(!(e=e||this.bindingData.list.currentId))return this.notifyService.warning(this.languageService.plsSelectParentNode,{hideTitle:!0}),T.empty();var r=this.bindingData.list.currentId,i=this.getHierarchyType(),n=this.loadingService.showLoadingWithDelay(500);this.setIdToExpand(e);var o=this.reloadByLevel(),a=yr.getInstance(i);if(!a)throw new Error(this.languageService.errorHierarchyKey);var s=a.addChild(this.repository,e);return o.pipe(R.switchMap(function(){return s}),R.tap(function(){t.virtualRootFrameContext.setParam("IS_ADD",!0),t.virtualRootFrameContext.setParam("LAST_MODIFIED_ID",r),t.loadingService.hideDelayLoading(n)},function(e){t.loadingService.hideDelayLoading(n),t.errorService.exception(t.languageService.addChildFailed,e)}))},br.prototype.save=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"save"});var r=this.loadingService.showLoadingWithDelay(500);return this.repository.applyChanges().pipe(R.tap(function(){t.loadingService.hideDelayLoading(r),t.notifyService.success(t.languageService.saveSuccess,{hideTitle:!0})},function(e){t.loadingService.hideDelayLoading(r),t.errorService.exception(t.languageService.multiSaveFailed,e)}))},br.prototype.remove=function(i,n){var o=this;if(!(i=i||this.bindingData.list.currentId))return this.notifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.empty();var a=this.repository.entityCollection.toJSON(),e=this.getHierarchyType(),s=pr.getInstance(e);return null===s?T.empty():!0===s.hasChildNodes(a,this.hierarchyInfoKey,i)?(this.notifyService.warning(this.languageService.deleteChildFirst,{hideTitle:!0}),T.empty()):this.messageService.question(this.languageService.confirmDeletion).pipe(R.concatMap(function(e){if(!e)return T.empty();var t=s.getNextNodeId(a,o.hierarchyInfoKey,i),r=o.loadingService.showLoadingWithDelay(500);return o.frameContext.repository.removeById(i).pipe(R.tap(function(){s.selectedNode(o.bindingData,o.hierarchyInfoKey,t),o.loadingService.hideDelayLoading(r),n&&n.trim()?o.notifyService.success(n,{hideTitle:!0}):o.notifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(r),o.errorService.exception(o.languageService.deleteFailed,e)}))}))},br.prototype.cancel=function(){var t=this,e=this.repository;return I.BefRepositoryUtil.isExistUnsaveData(e)?this.messageService.question(this.languageService.cancelWithoutSave).pipe(R.switchMap(function(e){return!1===e?T.EMPTY:t._cancel()})):this._cancel()},br.prototype.buildPaginationInfo=function(e){var t={pageIndex:0,pageSize:0},r=this.frameContext.params.get("enableNodePagination");if(e){if(r){var i=this.frameContext.params.get("nodePageSize")||0,n=this.frameContext.params.get("_NODE_"+e+"_PAGE_INDEX_");n||(this.frameContext.params.set("_NODE_"+e+"_PAGE_INDEX_",1),n=1),t.pageIndex=n,t.pageSize=i}}else{var o=this.repository.entityCollection.pageSize||0,a=this.repository.entityCollection.pageIndex||0;0!==o&&(t.pageSize=o,t.pageIndex=a)}return t},br.prototype._cancel=function(){var i=this,t=this.loadingService.showLoadingWithDelay(500);return this.repository.cancelChanges().pipe(R.switchMap(function(){var e=i.virtualRootFrameContext.getParam("IS_ADD"),t=i.virtualRootFrameContext.getParam("LAST_MODIFIED_ID"),r=i.bindingData.list.currentId;return!0===e?(i.repository.entityCollection.removeEntityById(r),i.virtualRootFrameContext.setParam("IS_ADD",!1),t&&setTimeout(function(){i.bindingData.list.setCurrentId(t,!0,!0)},0),T.of(null)):i.repository.updateById(r)}),R.tap(function(){i.loadingService.hideDelayLoading(t)},function(e){i.loadingService.hideDelayLoading(t),i.errorService.exception(i.languageService.cancelFailed,e)}))},br.prototype.hasChildNodes=function(e,t){return!0===this.getTreeNodeUtil().hasChildNodes(t,this.hierarchyInfoKey,e)},br.prototype.getNextNodeIdAfterRemoving=function(e,t){return this.getTreeNodeUtil().getNextNodeId(t,this.hierarchyInfoKey,e)},br.prototype.setNextNodeAfterRemoving=function(e){this.getTreeNodeUtil().selectedNode(this.bindingData,this.hierarchyInfoKey,e)},br.prototype.setCurrentId=function(e){e=e||this.frameContext.getVirtualRootFrameContext().uiState.__DEVKIT__selectedRow||this.bindingData.list.currentItem.primaryKeyValue,this.frameContext.bindingData.list.setCurrentId(e,!0,!0,!0)},br.prototype.selectFirstRow=function(){var e=this.getHierarchyType(),t=pr.getInstance(e);null!==t&&t.selectFirstRootNode(this.bindingData,this.hierarchyInfoKey)},br.prototype.getTreeNodeUtil=function(){var e=this.getHierarchyType(),t=pr.getInstance(e);if(null===t)throw new Error("不支持"+e+"类型的分级");return t},br.prototype.setLoadByLevelState=function(e,t){this.virtualRootFrameContext.setParam("isLoadTreeByLevel",!0),this.virtualRootFrameContext.setParam("loadTreeByLevelFilter",e),this.virtualRootFrameContext.setParam("loadTreeByLevelSort",t)},br.prototype.reloadByLevel=function(){if(!0!==this.virtualRootFrameContext.getParam("isLoadTreeByLevel"))return T.of([]);var e=this.virtualRootFrameContext.getParam("loadTreeByLevelFilter"),t=this.virtualRootFrameContext.getParam("loadTreeByLevelSort");return this.loadByLevel(e,t)},br.prototype.getHierarchyType=function(){var e=L.FieldMetadataUtil.getNgObjects(this.repository.entityType)[this.hierarchyInfoKey],t="path";if(e.hasOwnProperty("hierarchyType")&&null!=e.hierarchyType&&(t=e.hierarchyType),null==t||t.length<1)throw new Error(this.languageService.incorrectHierarchyConfig);return t},Object.defineProperty(br.prototype,"messagePipe",{get:function(){if(this.frameContext){var e=this.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),br.decorators=[{type:B.Injectable}],br.ctorParameters=function(){return[{type:L.FrameContext},{type:Pe},{type:q},{type:De},{type:xe},{type:Y,decorators:[{type:B.Optional}]}]},br);function br(e,t,r,i,n,o){var a=Sr.call(this,e)||this;return a.messageService=t,a.loadingService=r,a.notifyService=i,a.errorService=n,(a.languageService=o)||(a.languageService=Y.getInstance()),a}var Ir=(wr.prototype.filter=function(e,t){var r=this.context&&this.context.eventParam&&this.context.eventParam.data||[];return"string"==typeof r&&(r=JSON.parse(r)),this.viewModel.frameContext.repository.entityCollection.pageIndex=1,this.viewModel.frameContext.repository.filterConditionManager.setConditions(this.viewModel.bindingPath,r),this.commandService.execute(e,t)},wr.decorators=[{type:B.Injectable}],wr.ctorParameters=function(){return[{type:L.ViewModel},{type:bt},{type:st}]},wr);function wr(e,t,r){this.viewModel=e,this.filterConditionService=t,this.commandService=r}var xr=(Er.prototype.edit=function(e){var t=this;if(!(e=e||this.bindingData.list.currentId))return T.EMPTY;var r=this.loadingService.showLoadingWithDelay(500);return this.repository.editEntityById(e).pipe(R.tap(function(){t.loadingService.hideDelayLoading(r),it.setEditState(t.frameContext,e)},function(e){t.loadingService.hideDelayLoading(r),t.errorService.exception(t.languageService.updateFailed,e)}))},Er.decorators=[{type:B.Injectable}],Er.ctorParameters=function(){return[{type:L.FrameContext}]},Er);function Er(e){this.frameContext=e,this.repository=this.frameContext.repository,this.bindingData=this.frameContext.bindingData,this.loadingService=this.frameContext.injector.get(q,null),this.languageService=this.frameContext.injector.get(Y,null),this.errorService=this.frameContext.injector.get(xe,null)}var Pr=(Fr.prototype.removeById=function(e,t,r,i){void 0===r&&(r=!0);var n=i||"";return this.innerRemoveById(e,t,r,n)},Fr.prototype.removeByIds=function(e){throw new Error("Not Implemented")},Fr.prototype.removeAndSaveById=function(e,t){var r=t||"";return this.innerRemoveById(e,!0,!0,r)},Fr.prototype.removeAndSaveByIdForTree=function(e,t){var r=this,i=t||"";if(!1===this.checkIdsToRemove([e]))return this.notifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.EMPTY;var n=this.befRepository.entityCollection.toJSON();if(!0===this.treeDataService.hasChildNodes(e,n))return this.messageService.warning(this.languageService.deleteChildFirst),T.EMPTY;var o=this.innerRemoveById(e,!0,!0,i),a=this.treeDataService.getNextNodeIdAfterRemoving(e,n);return o.pipe(R.tap(function(){r.treeDataService.setNextNodeAfterRemoving(a)}))},Fr.prototype.removeAndSaveByIds=function(){throw new Error("Not Implemented")},Fr.prototype.refreshAfterRemoving=function(e,t){if(this.frameContext&&e&&t)return this.frameContext.injector.get(st,null).execute(e,t)},Fr.prototype.innerRemoveById=function(e,r,i,n){var o=this;if(!1===this.checkIdsToRemove([e]))return this.notifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.EMPTY;var t=this.confirmToRemove(),a=i&&r?this.befRepository.removeEntityAndSaveById(e):this.befRepository.removeById(e,r);return t.pipe(R.concatMap(function(e){if(!1===e)return T.EMPTY;var t=o.loadingService.showLoadingWithDelay(500);return a.pipe(R.tap(function(){o.loadingService.hideDelayLoading(t),n&&n.trim()?o.notifyService.success(n,{hideTitle:!0}):o.notifyService.success(o.languageService.deleteSuccess,{hideTitle:!0})},function(e){o.loadingService.hideDelayLoading(t),o.errorService.exception(o.languageService.deleteFailed,e)}),R.switchMap(function(){return i&&r?T.of(null):T.EMPTY}))}))},Fr.prototype.checkIdsToRemove=function(e){return!!e&&0!==e.filter(function(e){return!!e}).length},Fr.prototype.confirmToRemove=function(){return this.messageService.question(this.languageService.confirmDeletion).pipe(R.concatMap(function(e){return!1===e?T.EMPTY:T.of(!0)}))},Fr.decorators=[{type:B.Injectable}],Fr.ctorParameters=function(){return[{type:L.FrameContext}]},Fr);function Fr(e){this.frameContext=e,this.notifyService=this.frameContext.injector.get(De,null),this.messageService=this.frameContext.injector.get(Pe,null),this.errorService=this.frameContext.injector.get(xe,null),this.loadingService=this.frameContext.injector.get(q,null),this.languageService=this.frameContext.injector.get(Y,null),this.commandService=this.frameContext.injector.get(st,null),this.listDataService=this.frameContext.injector.get(tr,null),this.treeDataService=this.frameContext.injector.get(Cr,null),this.befRepository=this.frameContext.repository}var Dr=(Mr.decorators=[{type:B.Injectable}],Mr.ctorParameters=function(){return[{type:L.FrameContext}]},Mr);function Mr(e){this.frameContext=e,this.notifyService=this.frameContext.injector.get(De,null),this.messageService=this.frameContext.injector.get(Pe,null),this.loadingService=this.frameContext.injector.get(q,null),this.languageService=this.frameContext.injector.get(Y,null),this.befRepository=this.frameContext.repository}var Tr,Rr=(Q(Or,Tr=or),Object.defineProperty(Or.prototype,"hierarchyInfoKey",{get:function(){return this.virtualRootFrameContext.getParam("hierarchyInfoKey")},enumerable:!0,configurable:!0}),Object.defineProperty(Or.prototype,"hierarchyInfoField",{get:function(){return this.hierarchyInfoKey.split("/").filter(function(e){return e}).pop()},enumerable:!0,configurable:!0}),Object.defineProperty(Or.prototype,"virtualRootFrameContext",{get:function(){return this.frameContext.getVirtualRootFrameContext()},enumerable:!0,configurable:!0}),Object.defineProperty(Or.prototype,"messagePipe",{get:function(){if(this.viewModel&&this.viewModel.frameContext){var e=this.viewModel.frameContext.getFormAppContext()||null;if(e)return e.messagePipe||null}return null},enumerable:!0,configurable:!0}),Or.prototype.addSubSibling=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"addSubSibling"});var e=this.getParams(),r=this.getHierarchyType(),i=this.loadingService.showLoadingWithDelay(500),n=yr.getInstance(r);if(!n)throw new Error(this.languageService.errorHierarchyKey);return n.addSubSibling(this.repository,e.nodeCodes,e.ids).pipe(R.tap(function(){t.loadingService.hideDelayLoading(i)},function(e){t.errorService.exception(t.languageService.addSubSiblingFailed,e)}))},Or.prototype.addSubChild=function(){var t=this;this.messagePipe&&this.messagePipe.next({messageType:"addSubChild"});var e=this.getParams(),r=this.getHierarchyType();if(!(this.frameContext&&this.frameContext.bindingData&&this.frameContext.bindingData.getList()).currentId)return this.formNotifyService.warning(this.languageService.plsSelectParentNode,{hideTitle:!0}),T.EMPTY;var i=this.loadingService.showLoadingWithDelay(500),n=yr.getInstance(r);if(!n)throw new Error(this.languageService.errorHierarchyKey);return n.addSubChild(this.repository,e.nodeCodes,e.ids).pipe(R.tap(function(){t.loadingService.hideDelayLoading(i)},function(e){t.loadingService.hideDelayLoading(i),t.errorService.exception(t.languageService.addSubChildFailed,e)}))},Or.prototype.remove=function(n,o){var a=this;if(!n)return this.formNotifyService.warning(this.languageService.plsSelectDeleteData,{hideTitle:!0}),T.EMPTY;var e=this.getHierarchyType(),s=this.frameContext.bindingData.getList().toJSON(),c=this.frameContext.bindingData.getList(),u=pr.getInstance(e);return null===u?T.EMPTY:!0===u.hasChildNodes(s,this.hierarchyInfoField,n)?(this.messageService.warning(this.languageService.deleteChildFirst),T.EMPTY):this.messageService.question(this.languageService.confirmDeletion).pipe(R.concatMap(function(e){if(!e)return T.EMPTY;var t=u.getNextNodeId(s,a.hierarchyInfoField,n),r=a.loadingService.show(),i=a.getPath();return a.frameContext.repository.removeByPath(i,n).pipe(R.tap(function(){u.selectNodeByBindingList(c,a.hierarchyInfoField,t),a.loadingService.hideDelayLoading(r),o&&o.trim()?a.formNotifyService.success(o,{hideTitle:!0}):a.formNotifyService.success(a.languageService.deleteSuccess,{hideTitle:!0})},function(e){a.loadingService.hideDelayLoading(r),a.errorService.exception(a.languageService.deleteFailed,e)}))}))},Or.prototype.getHierarchyType=function(){var e=this.repository.entityTypeInfo.getPropInfoByPath(this.hierarchyInfoKey.split("/")).metadataInfo.hierarchyType||null;if(null==e||e.length<1)throw new Error(this.languageService.incorrectHierarchyConfig);return e},Or.prototype.getParams=function(){var e=this.viewModel.bindingPath.substr(1).split("/"),t=[],r=[],i=this.viewModel.bindingData.list.currentId;t.push(i);var n=this.viewModel.bindingData;return 0<e.length&&e.map(function(e){(n=n[e])&&n.currentId&&t.push(n.currentId),e?r.push(e.substring(0,e.length-1)):r.push(e)}),{nodeCodes:r,ids:t}},Or.prototype.getPath=function(){var e=this.viewModel.bindingPath,t="/"+this.viewModel.bindingData.list.currentId,r=e.split("/").filter(function(e){return e});if(0<r.length)for(var i=this.viewModel.bindingData,n=1;n<r.length-1;n++){var o=r[n];if(!(i=i[o])||!i.currentId)throw Error("获取子表完整路径出错，找不到"+i+"对应的子表，或对应子表没有当前行。");t+="/"+o+"/"+i.currentId}return t+="/"+r[r.length-1]},Or.decorators=[{type:B.Injectable}],Or.ctorParameters=function(){return[{type:L.FrameContext},{type:L.ViewModel},{type:Pe},{type:q},{type:xe},{type:De},{type:Y,decorators:[{type:B.Optional}]}]},Or);function Or(e,t,r,i,n,o,a){var s=Tr.call(this,e)||this;return s.viewModel=t,s.messageService=r,s.loadingService=i,s.errorService=n,s.formNotifyService=o,(s.languageService=a)||(s.languageService=Y.getInstance()),s}var Nr=(Ar.prototype.invokeAction=function(e,t,r,i,n){return this.innerInvokeAction(e,t,r,i,n,!0)},Ar.prototype.executeAction=function(e,t,r,i,n){return this.innerInvokeAction(e,t,r,i,n,!1)},Ar.prototype.buildQueryParams=function(t){"string"==typeof t&&(t=JSON.parse(t));var r="";return Object.keys(t).forEach(function(e){r+=e+"="+t[e]}),r},Ar.prototype.getRestService=function(){return this.repository.restService},Ar.prototype.innerInvokeAction=function(e,t,r,i,n,o){var a=this,s={},c=this.getRestService(),u=c.baseUri+"/service/"+e;if(i&&""!==i){var l=this.buildQueryParams(i);u+=l}return n&&""!==n&&("string"==typeof n&&n.startsWith("{")&&n.endsWith("}")&&(n=JSON.parse(n)),s.body=n),r&&""!==r?((r=JSON.parse(r))["Content-Type"]||(r["Content-Type"]="application/json"),s.headers=new x.HttpHeaders(r)):s.headers=new x.HttpHeaders({"Content-Type":"application/json"}),this.loadingService.show(),c[o?"invoke":"request"](u,t,null,s).pipe(R.tap(function(){a.loadingService.hide()},function(e){a.loadingService.hide();var t=u+a.languageService.operationFailed;a.formErrorService.exception(t,e)}))},Ar.decorators=[{type:B.Injectable}],Ar.ctorParameters=function(){return[{type:L.Repository},{type:q},{type:Pe},{type:De},{type:xe},{type:Y,decorators:[{type:B.Optional}]}]},Ar);function Ar(e,t,r,i,n,o){this.repository=e,this.loadingService=t,this.msgService=r,this.notifyService=i,this.formErrorService=n,this.languageService=o,this.languageService||(this.languageService=Y.getInstance())}var jr=(Br.prototype.submitApproveWithInteraction=function(e){return this.submitApprove(e)},Br.prototype.submitApprove=function(i,e){var n=this;if(!i)return this.notifyService.info(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),T.empty();var t={requestInfo:this.beActionService.getRestService().buildRequestInfo(),bizInstID:i,interactionResult:e?{procDefId:e.processDefinitionId}:{}};return this.formLoadingService.show(),this.beActionService.invokeAction("submittoapprovevoaction","PUT",null,null,t).pipe(R.map(function(e){if(e&&e.returnValue&&e.returnValue.excutionResponse)return e.returnValue.excutionResponse}),R.switchMap(function(e){return e&&e.procInstId?n.repository?n.repository.updateById(i).pipe(R.tap(function(){n.formLoadingService.hide(),ot.success(n.notifyService,n.languageService.submitSuccess)}),R.map(function(){return e})):(n.formLoadingService.hide(),ot.success(n.notifyService,n.languageService.submitSuccess),T.of(e)):T.of(e)}),R.switchMap(function(r){return r.needInteraction?T.from(new Promise(function(t){n.submitter.excute(r,function(e){!r.procInstId&&e.processDefinitionId?n.submitApprove(i,e).subscribe(function(){t()}):t()})})):T.of(null)}),R.catchError(function(e){return n.formLoadingService.hide(),T.of(e)}))},Br.prototype.submitApproveWithBizDefKey=function(i,n,o,e){var a=this;if(!i)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),T.EMPTY;if(!n)return this.notifyService.warning(this.languageService.bizDefKeyRequired,{hideTitle:!0}),T.EMPTY;try{o&&"string"==typeof o&&(o=JSON.parse(o))}catch(r){throw new Error("ArgumentError:options not a valid json string.")}var t={requestInfo:this.beActionService.getRestService().buildRequestInfo(),approvePayload:{startProcessPayload:{bizDefKey:n,dataId:i,name:o&&o.name||"",variables:o&&o.variables||{}}}};return e&&(t.approvePayload.startProcessPayload.processDefinitionId=e.processDefinitionId,t.approvePayload.startProcessPayload.processDefinitionKey=e.processDefinitionKey),this.formLoadingService.show(),this.beActionService.invokeAction("submittoapprovewithpayload","PUT",null,null,t).pipe(R.map(function(e){if(e&&e.returnValue&&e.returnValue.excutionResponse)return e.returnValue.excutionResponse}),R.switchMap(function(e){return e&&e.procInstId?a.repository?a.repository.updateById(i).pipe(R.tap(function(){a.formLoadingService.hide(),ot.success(a.notifyService,a.languageService.submitSuccess)}),R.map(function(){return e})):(a.formLoadingService.hide(),ot.success(a.notifyService,a.languageService.submitSuccess),T.of(e)):T.of(e)}),R.switchMap(function(r){return r.needInteraction?T.from(new Promise(function(t){a.submitter.excute(r,function(e){!r.procInstId&&e.processDefinitionId?a.submitApproveWithBizDefKey(i,n,o,e).subscribe(function(){t()}):t()})})):T.of(null)}),R.catchError(function(e){return a.formLoadingService.hide(),T.of(e)}))},Br.prototype.submitApproveWithBizDefKeyUseControl=function(e,t,r,i){if(void 0===r&&(r={}),!e)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),T.EMPTY;if(!t)return this.notifyService.warning(this.languageService.bizDefKeyRequired,{hideTitle:!0}),T.EMPTY;r&&"object"==typeof r||(r={});var n=X({dataId:e,bizDefKey:t},r);if(i){if(i.startsWith("{")&&i.endsWith("}"))try{i=JSON.parse(i)}catch(o){i={}}n.variables=i}return this.wfTaskHandlerService&&this.wfTaskHandlerService.startProcess(n)},Br.prototype.childSubmitApproveWithBizDefKey=function(e,t,r,i,n){if(void 0===i&&(i={}),!e)return this.notifyService.warning(this.languageService.bizDefKeyRequired,{hideTitle:!0}),T.EMPTY;if(!t)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),T.EMPTY;if(!r)return this.notifyService.warning(this.languageService.unallowEmptyChildBizBillId,{hideTitle:!0}),T.EMPTY;i&&"object"==typeof i||(i={});var o=X({dataId:t+","+r,bizDefKey:e},i);if(n){if(n.startsWith("{")&&n.endsWith("}"))try{n=JSON.parse(n)}catch(a){n={}}o.variables=n}return this.wfTaskHandlerService&&this.wfTaskHandlerService.startProcess(o)},Br.prototype.cancelApprove=function(e){var t=this;if(!e)return this.notifyService.warning(this.languageService.unallowEmptyBizBillId,{hideTitle:!0}),T.empty();var r={requestInfo:this.beActionService.getRestService().buildRequestInfo(),bizInstID:e};return this.formLoadingService.show(),this.beActionService.executeAction("canceltosubmitvoaction","PUT",null,null,r).pipe(R.switchMap(function(){return t.repository?t.repository.updateById(e).pipe(R.tap(function(){t.formLoadingService.hide(),ot.success(t.notifyService,t.languageService.cancelApproveSuccess)})):(t.formLoadingService.hide(),ot.success(t.notifyService,t.languageService.cancelApproveSuccess),T.of())}),R.catchError(function(e){return t.formLoadingService.hide(),T.of(e)}))},Br.prototype.cancelSubmit=function(e){return e?this.wfTaskHandlerService&&this.wfTaskHandlerService.cancelSubmit({procInstId:e}):(this.notifyService.warning(this.languageService.procInsIdRequired,{hideTitle:!0}),T.EMPTY)},Br.prototype.viewProcess=function(e){if(this.flowchartService)return e?this.flowchartService.viewFlowChart(e):void this.notifyService.warning(this.languageService.noProcessInstanceId,{hideTitle:!0})},Br.prototype.switchPrefixLetter=function(e,t){var r,i;if("object"==typeof e&&e)if(Array.isArray(e))for(var n=0;n<e.length;n++)this.switchPrefixLetter(e[n],t);else try{for(var o=Z(Object.keys(e)),a=o.next();!a.done;a=o.next()){var s=a.value;e[(t?s.substring(0,1).toUpperCase():s.substring(0,1).toLowerCase())+s.substring(1)]=e[s],"object"==typeof e[s]&&this.switchPrefixLetter(e[s],t),delete e[s]}}catch(c){r={error:c}}finally{try{a&&!a.done&&(i=o["return"])&&i.call(o)}finally{if(r)throw r.error}}return e},Br.decorators=[{type:B.Injectable}],Br.ctorParameters=function(){return[{type:q},{type:Nr},{type:Pe},{type:De},{type:Y,decorators:[{type:B.Optional}]},{type:xe},{type:L.FrameContext},{type:u.WFSubmiteService,decorators:[{type:B.Optional}]},{type:l.WFFlowchartService,decorators:[{type:B.Optional}]},{type:j.WfTaskHandlerService,decorators:[{type:B.Optional}]}]},Br);function Br(e,t,r,i,n,o,a,s,c,u){this.formLoadingService=e,this.beActionService=t,this.msgService=r,this.notifyService=i,this.languageService=n,this.formErrorService=o,this.frameContext=a,this.submitter=s,this.flowchartService=c,this.wfTaskHandlerService=u,this.frameContext&&(this.repository=this.frameContext.repository,this.wfTaskHandlerService||(this.wfTaskHandlerService=this.frameContext.injector.get(j.WfTaskHandlerService,null)))}var Lr=(Vr.prototype.printSingle=function(e,t){return t?this.printArray(e,[t]):(this.showWarning(this.languageService.unallowEmptyBizBillId),T.EMPTY)},Vr.prototype.printByIds=function(e,t){if(!t)return this.showWarning(this.languageService.unallowEmptyBizBillId),T.EMPTY;var r=t.split(",").filter(function(e){return e});return this.printArray(e,r)},Vr.prototype.printByIdsWithDimension=function(e,t,r,i,n){if(!t)return this.showWarning(this.languageService.unallowEmptyBizBillId),T.EMPTY;var o=t.split(",").filter(function(e){return e});return this.printArray(e,o,r,i,n)},Vr.prototype.printArray=function(e,t,r,i,n){if(!t||0===t.length)return this.showWarning(this.languageService.unallowEmptyBizBillId),T.EMPTY;var o=this.buildSourceOptions({dataIds:t,sourceId:e}),a=this.buildOutputOptions();return void 0!==r&&(o.FirstDimensionVal=r),void 0!==i&&(o.SecondDimensionVal=i),void 0!==n&&(o.billCategoryId=n),this.printService.outputBEData(o,a,"tab")},Vr.prototype.printMulti=function(e,t,r,i){void 0===i&&(i=!0);var n={isUsePagination:!1,filterConditions:[],sortConditions:[],pagination:null};if(t){var o=JSON.parse(t);o&&0<o.length&&(o[o.length-1].Relation=0),n.filterConditions=o}r&&(n.sortConditions=JSON.parse(r));var a=this.buildSourceFilterOptions({sourceId:e,entryFilter:n,includeChildData:i}),s=this.buildOutputOptions();return this.printService.outputBEDataWithFilter(a,s,"tab")},Vr.prototype.printMultiWithDimension=function(e,t,r,i,n,o,a){void 0===a&&(a=!0);var s={isUsePagination:!1,filterConditions:[],sortConditions:[],pagination:null};if(t){var c=JSON.parse(t);c&&0<c.length&&(c[c.length-1].Relation=0),s.filterConditions=c}r&&(s.sortConditions=JSON.parse(r));var u=this.buildSourceFilterOptions({sourceId:e,entryFilter:s,includeChildData:a});void 0!==i&&(u.FirstDimensionVal=i),void 0!==n&&(u.SecondDimensionVal=n),void 0!==o&&(u.billCategoryId=o);var l=this.buildOutputOptions();return this.printService.outputBEDataWithFilter(u,l,"tab")},Vr.prototype.buildSourceOptions=function(e){return{DataIds:e&&e.dataIds||undefined,SourceId:e&&e.sourceId||undefined,FirstDimensionVal:e&&e.dim1||undefined,SecondDimensionVal:e&&e.dim2||undefined,RetrieveParam:e&&e.retrieveParam||undefined,FormatId:e&&e.formatId||undefined,billCategoryId:e&&e.billCategoryId||undefined,ServiceUnit:e&&e.serviceUnit||undefined,currentPage:e&&e.currentPage||undefined,pageRowCount:e&&e.pageRowCount||undefined,queryType:e&&e.queryType||undefined,queryServiceId:e&&e.queryServiceId||undefined,queryParam:e&&e.queryParam||undefined}},Vr.prototype.buildOutputOptions=function(e){return{OutputType:e&&e.outputType||p.OutputType.PRINT,FileType:e&&e.fileType||p.FileType.Html5,Path:e&&e.path||undefined,DeviceId:e&&e.deviceId||undefined,printJob:e&&e.printJob||undefined,printerName:e&&e.printerName||undefined,printSetting:e&&e.printSetting||undefined,printType:e&&e.printType||p.PrintType.Form}},Vr.prototype.buildSourceFilterOptions=function(e){return{SourceId:e.sourceId,EntityFilter:e&&e.entryFilter||{isUsePagination:!1,filterConditions:[],sortConditions:[],pagination:null},FirstDimensionVal:e&&e.dim1||undefined,SecondDimensionVal:e&&e.dim2||undefined,FormatId:e&&e.formatId||undefined,ServiceUnit:e&&e.serviceUnit||undefined,billCategoryId:e&&e.billCategoryId||undefined,currentPage:e&&e.currentPage||undefined,pageRowCount:e&&e.pageRowCount||undefined,queryParam:e&&e.queryParam||undefined,queryServiceId:e&&e.queryServiceId||undefined,queryType:e&&e.queryType||undefined,includeChildData:!e||!e.hasOwnProperty("includeChildData")||e.includeChildData}},Vr.prototype.showWarning=function(e){this.notifyService?this.notifyService.warning(e,{hideTitle:!0}):this.msgService&&this.msgService.error(e)},Object.defineProperty(Vr.prototype,"notifyService",{get:function(){return this.formNotifyService?this.formNotifyService:this.injector?this.injector.get(De,null):null},enumerable:!0,configurable:!0}),Object.defineProperty(Vr.prototype,"commandContext",{get:function(){return this.context||null},enumerable:!0,configurable:!0}),Object.defineProperty(Vr.prototype,"frameContext",{get:function(){return this.commandContext&&this.commandContext.frameContext||null},enumerable:!0,configurable:!0}),Object.defineProperty(Vr.prototype,"injector",{get:function(){return this.frameContext&&this.frameContext.injector||null},enumerable:!0,configurable:!0}),Vr.decorators=[{type:B.Injectable}],Vr.ctorParameters=function(){return[{type:Pe},{type:Y},{type:p.CloudprintService},{type:De,decorators:[{type:B.Optional}]}]},Vr);function Vr(e,t,r,i){this.msgService=e,this.languageService=t,this.printService=r,this.formNotifyService=i}var _r="fileSortOrder",kr=(qr.convertToAttachmentInfos=function(e){var t=this;return e?e.map(function(e){return t.convertToAttachmentInfo(e)}):[]},qr.convertToAttachmentInfo=function(e){return{attachmentId:e.metadataId,fileName:e.fileName}},qr.getFirstAttachmentInfo=function(e){if(e&&0!==e.length)return e[0]},qr.peekAttachmentIds=function(e){return(e=e||[]).map(function(e){return e.attachmentId})},qr);function qr(){}var Ur=(Object.defineProperty(Hr.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(Hr.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Hr.prototype.updateRow=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/updateattachment",o={body:{updateAttachInfo:this.createUpdateAttachInfo(e,t),requestInfo:i.buildRequestInfo()}};return this.loadingService.show(),i.invoke(n,"PUT",null,o).pipe(R.switchMap(function(e){return r.syncAttachmentInfosToClient()}),R.tap(function(){r.loadingService.hide()}))},Hr.prototype.updateRowWithPropertyName=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/updateattachmentwithproptyname",o={body:{updateAttachInfo:this.createUpdateAttachInfo(e,t),propertyName:e.split("/").filter(function(e){return e}).pop(),requestInfo:i.buildRequestInfo()}};return this.loadingService.show(),i.invoke(n,"PUT",null,o).pipe(R.switchMap(function(e){return r.syncAttachmentInfosToClient()}),R.tap(function(){r.loadingService.hide()}))},Hr.prototype.updateRows=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/batchuploadattachment",o=this.createBatchCreateAttachInfo(e,t),a=0===o.NodeCodes.length,s={body:{batchUploadInfo:o,requestInfo:i.buildRequestInfo()}};return i.invoke(n,"PUT",null,s).pipe(R.switchMap(function(e){return r.appendAttachmentInfosToClient(e.returnValue,a)}),R.tap(function(){r.loadingService.hide()}))},Hr.prototype.updateRowsWithConfigs=function(e,t,r){var i=this,n=this.repository.restService,o=n.baseUri+"/service/batchuploadattachment",a={body:{batchUploadInfo:this.createBatchCreateAttachInfo(e,t),requestInfo:n.buildRequestInfo()}};return n.invoke(o,"PUT",null,a).pipe(R.switchMap(function(e){return i.appendAttachmentInfos(e.returnValue,r)}),R.tap(function(){i.loadingService.hide()}))},Hr.prototype.updateRowsWithPropertyName=function(e,t){var r=this,i=this.repository.restService,n=i.baseUri+"/service/batchuploadattachmentwithproptyname",o=this.createBatchCreateAttachInfo(e,t),a=0===o.NodeCodes.length,s={body:{batchUploadInfo:o,propertyName:e.split("/").filter(function(e){return e}).pop(),requestInfo:i.buildRequestInfo()}};return i.invoke(n,"PUT",null,s).pipe(R.switchMap(function(e){return r.appendAttachmentInfosToClient(e.returnValue,a)}),R.tap(function(){r.loadingService.hide()}))},Hr.prototype.createUpdateAttachInfo=function(e,t){var r=t.attachmentId,i=L.BindingPathConverter.toBindingPathArray(e);return i.pop(),{NodeCodes:I.BefDataPathUtil.convertToObjectCodes(i,this.bindingData),HiretryIds:I.BefDataPathUtil.convertToDataIdsForUpdate(i,this.bindingData),AttachmentIds:[r],AttachmentId:r}},Hr.prototype.createBatchCreateAttachInfo=function(e,t){var r=kr.peekAttachmentIds(t),i=L.BindingPathConverter.toBindingPathArray(e);return i.pop(),{NodeCodes:I.BefDataPathUtil.convertToObjectCodes(i,this.bindingData),HiretryIds:I.BefDataPathUtil.convertToDataIdsForAdd(i,this.bindingData),AttachmentIds:r,AttachmentId:null}},Hr.prototype.syncAttachmentInfosToClient=function(){var e=this.bindingData.list.currentId;return this.repository.updateEntityById(e)},Hr.prototype.appendAttachmentInfosToClient=function(e,t){if(!0===t){var r=this.repository.buildEntities(e);return this.repository.entityCollection.addEntities(r),T.of(e)}var i=this.bindingData.list.currentId;return this.repository.updateEntityById(i).pipe(R.map(function(){return e}))},Hr.prototype.appendAttachmentInfos=function(e,t){var r=this.repository.buildEntities(e);return this.repository.entityCollection.addEntities(r),this.updateEntities(r,t),T.of(e)},Hr.prototype.updateEntities=function(e,t){var r=this;e.forEach(function(e){r.updateEntity(e,t)})},Hr.prototype.updateEntity=function(t,r){var i=this;Object.keys(r).forEach(function(e){i.setValueByPath(t,e,r[e])})},Hr.prototype.setValueByPath=function(e,t,r){if(e){var i=t.split(".");i.length<=1?e[t]=r:i.slice(0,-1).reduce(function(e,t){return e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t)||(e[t]={}),e[t]},e)[i[i.length-1]]=r}},Hr.decorators=[{type:B.Injectable}],Hr.ctorParameters=function(){return[{type:L.FrameContext},{type:q}]},Hr);function Hr(e,t){this.frameContext=e,this.loadingService=t}var Wr=(Object.defineProperty(Kr.prototype,"defaultParentDirName",{get:function(){return this.frameContext.bindingData.list.currentId},enumerable:!0,configurable:!0}),Object.defineProperty(Kr.prototype,"bindingData",{get:function(){return this.frameContext.bindingData},enumerable:!0,configurable:!0}),Kr.prototype.setLanguageService=function(){var e=this.frameContext.injector;this.languageService=e.get(Y,null,B.InjectFlags.Optional),this.languageService||(this.languageService=Y.getInstance())},Kr.prototype.uploadAndUpdateRow=function(i,e,t,r,n){var o=this,a=e||this.defaultRootDirId,s=t||this.defaultParentDirName;if(!a||!s)throw new Error("rootDirId和parentDirName不能为空，请填写");var c=new f.UploadLimit;c.fileCount=1,r&&(c.fileType=r);var u=[],l=null;if(n){var p=this.frameContext.bindingData.getList();p.currentId!==n&&p.setCurrentId(n,!0,!0),l=this.getSpecialRow(i,n)}else l=this.getCurrentRow(i);if(l&&l.primaryKeyValue){var d=this.getAttachmentIdsByPathAndDataIds(i,[l.primaryKeyValue]);d&&0<d.length&&u.push.apply(u,d)}return T.from(this.uploadDialogService.uploadFileWithLimit(s,a,c,u)).pipe(R.switchMap(function(e){if(!e||0===e.length)return o.notifyService.warning(o.languageService.plsUploadFirst,{hideTitle:!0}),T.empty();if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===f.FileState.New})).length)return T.of(!0);var t=kr.convertToAttachmentInfos(e),r=kr.getFirstAttachmentInfo(t);return o.attachDataService.updateRow(i,r)}))},Kr.prototype.uploadAndUpdateRowWithPropertyName=function(i,e,t,r,n){var o=this,a=e||this.defaultRootDirId,s=t||this.defaultParentDirName;if(!a||!s)throw new Error("rootDirId和parentDirName不能为空，请填写");var c=new f.UploadLimit;c.fileCount=1,r&&(c.fileType=r);var u=[],l=null;if(n){var p=this.frameContext.bindingData.getList();p.currentId!==n&&p.setCurrentId(n,!0,!0),l=this.getSpecialRow(i,n)}else l=this.getCurrentRow(i);if(l&&l.primaryKeyValue){var d=this.getAttachmentIdsByPathAndDataIds(i,[l.primaryKeyValue]);d&&0<d.length&&u.push.apply(u,d)}return T.from(this.uploadDialogService.uploadFileWithLimit(s,a,c,u)).pipe(R.switchMap(function(e){if(!e||0===e.length)return o.notifyService.warning(o.languageService.plsUploadFirst,{hideTitle:!0}),T.EMPTY;if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===f.FileState.New})).length)return T.of(!0);var t=kr.convertToAttachmentInfos(e),r=kr.getFirstAttachmentInfo(t);return o.attachDataService.updateRowWithPropertyName(i,r)}))},Kr.prototype.uploadAndBatchAddRows=function(r,e,t,i){var n=this,o=e||this.defaultRootDirId,a=t||this.defaultParentDirName;if(!o||!a)throw new Error("rootDirId和parentDirName不能为空，请填写");var s=new f.UploadLimit;return i&&(s.fileType=i),T.from(this.uploadDialogService.uploadFileWithLimit(a,o,s)).pipe(R.switchMap(function(e){if(!e||0===e.length)return n.notifyService.warning(n.languageService.plsUploadFirst,{hideTitle:!0}),T.EMPTY;if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===f.FileState.New})).length)return T.of(!0);var t=kr.convertToAttachmentInfos(e);return n.attachDataService.updateRows(r,t)}))},Kr.prototype.uploadAndBatchAddRowsWithPropertyName=function(r,e,t,i){var n=this,o=e||this.defaultRootDirId,a=t||this.defaultParentDirName;if(!o||!a)throw new Error("rootDirId和parentDirName不能为空，请填写");var s=new f.UploadLimit;return i&&(s.fileType=i),T.from(this.uploadDialogService.uploadFileWithLimit(a,o,s)).pipe(R.switchMap(function(e){if(!e||0===e.length)return n.notifyService.warning(n.languageService.plsUploadFirst,{hideTitle:!0}),T.EMPTY;if(0===(e=e.filter(function(e){return!e.hasOwnProperty("state")||e.state===f.FileState.New})).length)return T.of(!0);var t=kr.convertToAttachmentInfos(e);return n.attachDataService.updateRowsWithPropertyName(r,t)}))},Kr.prototype.download=function(e,t){if(!e)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),T.EMPTY;t=t||"default-root";var r=this.getDownloadUrl([e],t);return window.open(r),T.of(!0)},Kr.prototype.batchDownload=function(e,t){if(!e||0===e.length)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),T.EMPTY;if(1===e.length)return this.download(e[0],t);var r=this.getDownloadUrl(e,t);return window.open(r),T.of(!0)},Kr.prototype.getDownloadUrl=function(e,t){if(t=t||"default-root",this.downloadService){if(1===e.length)return this.downloadService.getDownloadUrl(e[0],t);var r=JSON.stringify(e);return this.downloadService.getMultipleDownloadUrl(r,t)}return console.warn("因安全问题，附件下载提供安全校验机制，附件下载功能需重新编译。"),1===e.length?"/api/runtime/dfs/v1.0/formdoc/filecontent?metadataid="+e[0]+"&rootid="+t:"/api/runtime/dfs/v1.0/formdoc/multiple/download?metadataidlist="+(r=JSON.stringify(e))+"&rootid="+t},Kr.prototype.downloadByDataId=function(e,t,r){if(!e)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),T.EMPTY;var i=[e],n=this.getAttachmentIdsByPathAndDataIds(t,i);if(0===n.length)return this.notifyService.warning(this.languageService.noDownloadAtt,{hideTitle:!0}),T.EMPTY;var o=n[0];return this.download(o)},Kr.prototype.batchDownloadByDataIds=function(e,t,r){if("string"==typeof e&&e&&0<e.length&&(e=e.split(",").filter(function(e){return e})),!e||!1===Array.isArray(e)||0===e.length)return this.notifyService.warning(this.languageService.plsSelectDownloadAtt,{hideTitle:!0}),T.EMPTY;var i=[].concat(e),n=this.getAttachmentIdsByPathAndDataIds(t,i);return 0===n.length?(this.notifyService.warning(this.languageService.noDownloadAtt,{hideTitle:!0}),T.EMPTY):this.batchDownload(n,r)},Kr.prototype.previewByAttachmentInfoFieldPath=function(e,t,r){if(!e||!t)throw new Error("attachmentInfoFieldPath和rootDirId不能为空，请填写");var i=[],n=[];return(i=r&&0<r.length?("string"==typeof r?n.push(r):n=r,this.getAttachmentIdsByPathAndDataIds(e,n)):this.getAttachmentIdsByPathAndDataIds(e,null))&&0===i.length?(this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),T.EMPTY):this.previewByAttachmentIds(i,t)},Kr.prototype.previewByAttachmentInfoFieldPathWithIndex=function(e,t){if(!e||!t)throw new Error("attachmentInfoFieldPath和rootDirId不能为空，请填写");var r=this.getCurrentRow(e),i=L.BindingPathConverter.toBindingPathArray(e).pop();if(!r[i]||!r[i].attachmentId)return this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),T.EMPTY;var n=this.getAttachmentIdsByPathAndDataIds(e,null);if(n&&0===n.length)return this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),T.EMPTY;var o=this.getCurrentAttachmentId(e);if(o)return this.previewFileListWithIndex(n,t,o);throw new Error("要预览的附件id不存在，请确认")},Kr.prototype.previewBySubDirName=function(e,t){if(!e||!t)throw new Error("subDirName和rootDirId不能为空，请填写");return T.from(this.fileViewerService.viewerFormFile(e,t))},Kr.prototype.previewBySubDirNameWithIndex=function(e,t,r){if(!t||!r)throw new Error("subDirName和rootDirId不能为空，请填写");var i=this.getCurrentAttachmentId(e);return i?T.from(this.fileViewerService.viewerFormFileWithIndex(t,r,i)):(this.notifyService.warning(this.languageService.noAttachment,{hideTitle:!0}),T.EMPTY)},Kr.prototype.previewByAttachmentIds=function(e,t){return T.from(this.fileViewerService.viewerFileList(e,t))},Kr.prototype.previewFileListWithIndex=function(e,t,r){return T.from(this.fileViewerService.viewerFileListWithIndex(e,t,r))},Kr.prototype.genVersion=function(e){return"V"+((e=e||[]).length+1)+".0"},Kr.prototype.updateAttachmentVersion=function(o,a,e){var s=this,t=e.split("/").filter(function(e){return e}),c=t.pop(),u=this.frameContext.bindingData.getValue(t),r=this.frameContext.repository.entityManager,l=L.DataPathCreator.createByShortPathFromRoot(t,r,this.frameContext.bindingData).toArray().map(function(e){return e.startsWith("PropName:")?e.split(":")[1]:e});if(u){var p=u.toJSON();p&&p.filter(function(e){return!e[o]}).forEach(function(e){var t=e[c].fileName,r=p.filter(function(e){return e[c].fileName===t&&e[o]});l.pop(),l.push("DataId:"+e[u.primaryKey]);var i=s.frameContext.repository.entityCollection.getEntityByPath(l),n=s.genVersion(r);i[o]=n,i[a]=!1,r.forEach(function(e){l.pop(),l.push("DataId:"+e[u.primaryKey]),(i=s.frameContext.repository.entityCollection.getEntityByPath(l))[a]=!0})})}},Kr.prototype.isAttachmentCanDelete=function(e,t){var r=t.split("/").filter(function(e){return e});if(r.pop(),!0===this.frameContext.bindingData.getValue(r).currentItem[e])return this.notifyService.warning(this.languageService.historyAttachment,{hideTitle:!0}),T.EMPTY},Kr.prototype.updateAttachmentHistory=function(i,r,e){var n=this,t=e.split("/").filter(function(e){return e}),o=t.pop(),a=this.frameContext.bindingData.getValue(t);if(a){var s=a.toJSON().filter(function(e){return e[i]}),c=new Map,u=this.frameContext.repository.entityManager,l=L.DataPathCreator.createByShortPathFromRoot(t,u,this.frameContext.bindingData).toArray().map(function(e){return e.startsWith("PropName:")?e.split(":")[1]:e});s.forEach(function(e){var t=e[o].fileName;c.has(t)?c.get(t).push(e):c.set(t,[e])}),Array.from(c.values()).forEach(function(e){e.sort(function(e,t){var r=parseInt(e[i].replace(/[a-zA-Z\.]/g,""));return parseInt(t[i].replace(/[a-zA-Z\.]/g,""))-r});var t=e[0];l.pop(),l.push("DataId:"+t[a.primaryKey]),n.frameContext.repository.entityCollection.getEntityByPath(l)[r]=!1})}},Kr.prototype.getCurrentAttachmentId=function(e){var t=L.BindingPathConverter.toBindingPathArray(e),r=t.pop(),i=this.frameContext.bindingData.getValue(t).currentItem;return i&&i.primaryKeyValue&&i[r]&&i[r].attachmentId||null},Kr.prototype.getCurrentRow=function(e){var t=L.BindingPathConverter.toBindingPathArray(e);t.pop();var r=this.frameContext.bindingData.getValue(t);return r&&r.currentItem},Kr.prototype.getSpecialRow=function(e,t){var r=L.BindingPathConverter.toBindingPathArray(e);r.pop();var i=this.frameContext.bindingData.getValue(r);return i&&i.findById(t)},Kr.prototype.getAttachmentIdsByPathAndDataIds=function(e,t){var r=L.BindingPathConverter.toBindingPathArray(e),i=r.pop(),n=this.entityService.getEntityListData(r),o=[];o=t&&!0===Array.isArray(t)?n.filter(function(e){return-1<t.indexOf(e.id)}):n;var a=[];return o.forEach(function(e){if(e[i]){var t=e[i].attachmentId;t&&a.push(t)}}),a},Kr.decorators=[{type:B.Injectable}],Kr.ctorParameters=function(){return[{type:L.FrameContext},{type:Ur},{type:De},{type:f.UploadDialogService},{type:f.DownloadService,decorators:[{type:B.Optional}]}]},Kr);function Kr(e,t,r,i,n){this.frameContext=e,this.attachDataService=t,this.notifyService=r,this.uploadDialogService=i,this.downloadService=n,this.defaultRootDirId="",this.setLanguageService(),this.fileViewerService=this.frameContext.injector.get(d.FileViewerService,null,B.InjectFlags.Optional),this.entityService=this.frameContext.injector.get(_t,null,B.InjectFlags.Optional),this.downloadService||"undefined"==typeof f.DownloadService||(this.downloadService=this.frameContext.injector.get(f.DownloadService,null))}var zr=(Jr.prototype.addFileRows=function(e){var t=this.getAttachmentInfosToAddFromContext();return 0===t.length&&this.notifyService.info("请先上传附件"),this.attachDataService.updateRows(e,t)},Jr.prototype.addFileRowsWithConfigs=function(e,t){var r=this.getAttachmentInfosToAddFromContext();0===r.length&&this.notifyService.info("请先上传附件"),this.attachmentInfos=this.attachmentInfos.concat(r),this.subject.next({fileInfoFieldPath:e,configs:t})},Jr.prototype.process=function(e,t){var r=this;if(this.attachmentInfos&&0<this.attachmentInfos.length){var i=this.attachmentInfos.concat([]),n=null;if("string"==typeof t&&(t=t.trim()),!t.startsWith("{")||!t.endsWith("}"))throw new Error("附件扩展信息配置不是合法的json字符串。");try{n=JSON.parse(t)}catch(o){throw new Error("附件扩展信息配置不是合法的json字符串。")}this.attachDataService.updateRowsWithConfigs(e,i,n).pipe(R.tap(function(){r.attachmentInfos=r.attachmentInfos.filter(function(t){return!i.find(function(e){return e.attachmentId===t.attachmentId})}),0<r.attachmentInfos.length&&r.process(e,t)})).subscribe()}},Jr.prototype.getAttachmentInfosToAddFromContext=function(){var e=this.getFileExtendsFromContext();return this.convertToAttachmentInfos(e)},Jr.prototype.convertToAttachmentInfos=function(e){if(!e)return[];var r=[];return e.forEach(function(e){var t={attachmentId:e.extend.metadataId,fileName:e.extend.fileName};r.push(t)}),r},Jr.prototype.removeFileRows=function(e){var r=this,t=this.getDataIdsToRemoveFromContext(e);0===t.length&&this.notifyService.info("请选择要删除的附件");var i=2<=e.split("/").filter(function(e){return e}).length,n=[];return i?(t.forEach(function(e){var t;t=r.subListDataService.removeWithoutConfirm(e),n.push(t)}),T.forkJoin(n)):this.listDataService.removeRows(t,!1,null,!1)},Jr.prototype.getDataIdsToRemoveFromContext=function(i){var n=this,e=this.getFileExtendsFromContext(),o=[];return e.forEach(function(e){var t=e.extend.metadataId,r=n.convertFileIdToDataId(t,i);o.push(r)}),o},Jr.prototype.convertFileIdToDataId=function(t,e){var r=L.BindingPathConverter.toBindingPathArray(e),i=r.pop(),n=r;return this.entityService.getEntityListData(n).find(function(e){if(e[i]&&e[i].attachmentId===t)return!0}).id},Jr.prototype.updateOrder=function(e,t){if(!e)throw new Error("附件udt字段路径参数不能为空");if(!t){var r=this.context;t=r&&r.eventParam&&r.eventParam.data}if(t&&Array.isArray(t)){var a=this.frameContext.bindingData.getList();if(a&&!(a.length<1)){var s=L.BindingPathConverter.toBindingPathArray(e).pop();if(!s)throw new Error("无法获取附件udt字段，请确认命令中附件udt字段路径配置正确，且视图模型中存在附件udt字段");var c=a.toJSON();t.forEach(function(t,e){var r=c.find(function(e){return e&&e[s]&&e[s].attachmentId===t}),i=r&&r.id;if(i){var n=a.findById(i);if(n){var o=n[s];o&&o.getValue(_r)!==e&&o.setValue(_r,e,!0,!0)}}})}}},Jr.prototype.getFileExtendsFromContext=function(){var e=this.context.eventParam;return e?!1===Array.isArray(e)?[e]:e.concat([]):[]},Jr.decorators=[{type:B.Injectable}],Jr.ctorParameters=function(){return[{type:L.FrameContext},{type:Ur},{type:_t},{type:ir},{type:De},{type:Y},{type:tr},{type:q,decorators:[{type:B.Optional}]}]},Jr);function Jr(e,t,r,i,n,o,a,s){var c=this;this.frameContext=e,this.attachDataService=t,this.entityService=r,this.subListDataService=i,this.notifyService=n,this.languageService=o,this.listDataService=a,this.formLoadingService=s,this.subject=new T.Subject,this.subject.pipe(R.debounceTime(500)).subscribe(function(e){c.process(e.fileInfoFieldPath,e.configs)}),this.attachmentInfos=[]}var Yr=(Gr.prototype.setLanguageService=function(){if(this.getFrameContext()){var e=this.frameContext.injector;this.languageService=e.get(Y,null,B.InjectFlags.Optional)}this.languageService||(this.languageService=Y.getInstance())},Gr.prototype.getFrameContext=function(){return this.frameContext?this.frameContext:this.context&&this.context.frameContext?this.context.frameContext:null},Gr.prototype.getComponentFactoryResolver=function(){var e,t=this.getFrameContext();return t&&(e=t.injector.get(B.ComponentFactoryResolver)),e},Gr.prototype.getObjectTypeConfig=function(e){var t;if("string"==typeof e)if(e.length)try{t=JSON.parse(e)}catch(r){throw new Error(e+"不是合法的json字符串")}else t={};else{if("object"!=typeof e)throw new Error("填写对象格式或json字符串");t=Object.assign({},e)}return t},Gr.prototype.createModalComponentRef=function(e,t,r){var i,n,o=this.getFrameContext(),a=this.getComponentFactoryResolver();if(o&&a){var s=a.resolveComponentFactory(t),c=B.ReflectiveInjector.resolveAndCreate(te(this._providers),o.injector);(i=s.create(c))&&i.instance&&i.instance.viewModel&&i.instance.viewModel.uiState&&("object"==typeof r&&Object.keys(r).length&&Object.keys(r).forEach(function(e){i.instance.viewModel.uiState.setPropertyValue(e,r[e])}),i.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0)),n=this.modalService.show(i,e)}else n=this.modalService.show(t,e);return n},Gr.prototype.openModal=function(e,t,r,i){var n=this;void 0===e&&(e={}),void 0===r&&(r={});var o,a=this.getObjectTypeConfig(e),s=this.getObjectTypeConfig(r),c=this.farrisFormService.getControls(t),u={title:this.languageService.defaultDialogTitle,width:760,height:450,showButtons:!1},l=(u=Object.assign(u,a)).beforeClose,p=u.cancelChanges||!1;if(u.beforeClose=function(t){return l&&"function"==typeof l?l(t).pipe(R.switchMap(function(e){return e&&p?n.cancelChanges(t):T.of(e)})):p?n.cancelChanges(t):T.of(!0)},!u.remote){if(!c)return void console.error("获取控件失败，modalId="+t);if("string"==typeof c)u.dialogType="iframe",o=this.modalService.show(c,u);else if("function"==typeof c)o=this.createModalComponentRef(u,c,s);else if("object"==typeof c){if(c.useIsolateJs){var d={injector:this.injector,uiState:s,modalService:this.modalService,dialogServiceInstance:this,eventBus:this.frameContext.getVirtualRootFrameContext().eventBus,componentCallback:this.componentModify,modalInstanceCallback:this.modalInstanceCallback};return c.modalInstance(u,d)}o=this.modalService.show(c,u)}return(this.modalRef=o)&&o.content&&(o.content.isDialogRootComponent=!0,o.content.dialogRef=o),o}this.createRemoteForm(u,s).subscribe(function(e){(n.modalRef=e)&&e.content&&(e.content.isDialogRootComponent=!0,e.content.dialogRef=e),i(e)})},Gr.prototype.componentModify=function(t,r){t&&t.instance&&t.instance.viewModel&&t.instance.viewModel.uiState&&(r.uistate&&"string"==typeof r.uistate&&(r.uistate=JSON.parse(r.uistate)),"object"==typeof r.uistate&&Object.keys(r.uistate).length&&Object.keys(r.uistate).forEach(function(e){t.instance.viewModel.uiState.setPropertyValue(e,r.uistate[e])}),t.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0))},Gr.prototype.modalInstanceCallback=function(e,t,r){if(r&&r.modalService){var i=r.modalService.show(e,t);return i&&i.content&&(i.content.isDialogRootComponent=!0,i.content.dialogRef=i),i}},Gr.prototype.openHelpModal=function(t,e,r){var i=this,n=this.context.eventParam||{},o=n.event||n,a=n.options||n.editor&&n.editor.options||{},s=n&&n.context,c=new T.Subject,u=a.modalId,l=void 0===u?null:u;"string"==typeof(r=r||"{}")&&0<r.length&&(r=JSON.parse(r));var p=r||{},d=p.remote,f=void 0!==d&&d,h=p.currentRow,g=void 0!==h&&h,v=p.areaResponse,y=void 0===v?undefined:v;if(y!==undefined&&a.areaResponse===undefined&&(a.areaResponse=y),f){var m=r.mapFields||{};a.remote=f+"?v="+(new Date).valueOf(),this.openModal(a,l,e,function(e){i.modals[l]={subject:c,frameId:t,mapFields:m,dialogRef:e,currentRow:g,event:o,context:s}})}else{var S=this.openModal(a,l,e),C=a.mapFields||{};this.modals[l]={subject:c,frameId:t,mapFields:C,dialogRef:S,currentRow:g,event:o,context:s}}return c},Gr.prototype.openCallbackableModal=function(t,e,r){var S=this;"string"==typeof(r=r||"{}")&&(r=JSON.parse(r));var i=this.context&&this.context.eventParam||{},C=i.options;C.showButtons=!0,C.buttons=[{text:this.languageService.confirm,cls:"btn btn-primary",handle:function(e){var t=(C||{}).modalId,r=void 0===t?null:t;if(r){var i=S.modals[r]||{},n=i.subject,o=void 0===n?null:n,a=i.dialogRef,s=void 0===a?null:a,c=i.frameId,u=void 0===c?null:c,l=i.handle,p=void 0===l?null:l,d=i.currentRow,f=void 0!==d&&d,h=s.content;if(!h)throw new Error("不支持的表单类型");var g=[];if(!0===f){var v=void 0;if(!(v=h.context?h.context.appContext.frameContextManager.getFrameContextById(u):h.appContext.frameContextManager.getFrameContextById(u)))throw new Error("无效的frameId："+u+"，请确认命令中frameId正确。");var y=v.bindingData.getList();g=[y&&y.currentItem&&y.currentItem.toJSON()]}else{var m=void 0;m=h.context?h.context.appContext.frameContextManager.getFrameContextById(u).uiState.rows||new Map:h.appContext.frameContextManager.getFrameContextById(u).uiState.rows||new Map,g=Array.from(m.values())}"function"==typeof p&&p(g),o&&o.next(),s.close(C)}}},{text:this.languageService.cancel,cls:"btn",handle:function(e){return S.cancel(C)}}];var n=new T.Subject,o=C.modalId,a=void 0===o?null:o,s=r.remote,c=void 0===s?null:s,u=r.currentRow,l=void 0!==u&&u,p=r.areaResponse,d=void 0===p?undefined:p,f=C.handle;if(d!==undefined&&C.areaResponse===undefined&&(C.areaResponse=d),c)C.remote=c+"?v="+(new Date).valueOf(),this.openModal(C,a,e,function(e){S.modals[a]={subject:n,frameId:t,dialogRef:e,handle:f,currentRow:l,event:i.event}});else{var h=this.openModal(C,a,e);this.modals[a]={subject:n,frameId:t,dialogRef:h,handle:f,currentRow:l,event:i.event}}return n},Gr.prototype.confirm=function(){var o=this,e=(this.context&&this.context.eventParam||{}||{}).modalId,t=void 0===e?null:e;if(t){var r=this.modals[t]||{},i=r.subject,n=void 0===i?null:i,a=r.dialogRef,s=void 0===a?null:a,c=r.mapFields,u=void 0===c?{}:c,l=r.frameId,p=void 0===l?null:l,d=r.currentRow,f=void 0!==d&&d,h=r.event,g=void 0===h?null:h,v=r.context,y=void 0===v?null:v,m=s.content;if(!m)throw new Error("不支持的表单类型");var S=[];if(!0===f){var C=m.context.appContext.frameContextManager.getFrameContextById(p);if(!C)throw new Error("无效的frameId："+p+"，请确认命令中frameId正确。");var b=C.bindingData.getList(),I=b&&b.currentItem&&b.currentItem.toJSON();I&&0<Object.keys(I).length&&(S=[I])}else{var w=m.context.appContext.frameContextManager.getFrameContextById(p).uiState.rows||new Map;S=Array.from(w.values())}undefined,g&&g.editor&&g.editor.column&&g.editor.column.field,S&&u&&Object.keys(u).forEach(function(e){var t=u[e],r=e.split(".").filter(function(e){return e})||[],i=S.map(function(e){return r.reduce(function(e,t){return e&&(e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t))?e[t]:""},e)}).join(",");if(t){var n=o.frameContext.viewModel.bindingPath.split("/").filter(function(e){return e});t.split(",").filter(function(e){return e}).forEach(function(e){if(y)o.setValueByPath(y,e,i);else{var t=e.split(".");o.frameContext.bindingData.setValue(n.concat(t),i,!0,!0)}})}}),n&&n.next(),s.close()}},Gr.prototype.cancel=function(e){var t=(e||this.context&&this.context.eventParam||{}||{}).modalId,r=void 0===t?null:t;if(r){var i=this.modals[r]||{},n=i.subject,o=void 0===n?null:n,a=i.dialogRef,s=void 0===a?null:a;o&&o.next(),s&&s.close()}},Gr.prototype.cancelChanges=function(e){if(e&&e.modalRef&&e.modalRef.content){var t=e.modalRef.content;if(t&&t.context){var r=t.context.repository||null;if(r)return r.cancelChanges().pipe(R.switchMap(function(){return T.of(!0)}))}}return T.of(!0)},Gr.prototype.closeModal=function(){this.modalRef&&this.modalRef.close()},Gr.prototype.createRemoteForm=function(o,a){var s=this,e=o.remote||!1,c=new T.Subject;if(e){var u=o.moduleName||null;System["import"](e).then(function(e){var t=e[u=u||Object.keys(e).pop()].create(s.injector),r=t._bootstrapComponents[0];if(!r)throw new Error("无法找到入口表单！");var i=t.componentFactoryResolver.resolveComponentFactory(r).create(s.injector);i&&i.instance&&i.instance.viewModel&&i.instance.viewModel.uiState&&("object"==typeof a&&Object.keys(a).length&&Object.keys(a).forEach(function(e){i.instance.viewModel.uiState.setPropertyValue(e,a[e])}),i.instance.viewModel.uiState.setPropertyValue("DEVKIT_DIALOG",!0));var n=s.modalService.show(i,o);c.next(n)})}return c},Gr.prototype.setValueByPath=function(e,t,r){if(e){var i=t.split(".");i.length<=1?e[t]=r:i.slice(0,-1).reduce(function(e,t){return e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t)||(e[t]={}),e[t]},e)[i[i.length-1]]=r}},Gr.decorators=[{type:B.Injectable}],Gr.ctorParameters=function(){return[{type:h.BsModalService},{type:$e},{type:B.ComponentFactoryResolver},{type:L.FrameContext},{type:B.Injector,decorators:[{type:B.Optional}]}]},Gr);function Gr(e,t,r,i,n){this.modalService=e,this.farrisFormService=t,this._componentFactoryResolver=r,this.frameContext=i,this.injector=n,this._providers=[],this.modals={},this.setLanguageService()}var $r=(Object.defineProperty(Qr.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),Qr.prototype.openSidebar=function(){this.sidebarUIService.sendIsOpen(!0)},Qr.prototype.closeSidebar=function(){this.sidebarUIService.sendIsOpen(!1)},Qr.prototype.confirmBeforeClosingSidebar=function(){return this.repository.entityManager.checkAllEntityChanges()?this.messageService.question(this.languageService.exitWithoutSave).pipe(R.switchMap(function(e){return!1===e?T.of(!1):T.of(!0)})):T.of(!0)},Qr.prototype.continueClosingSidebar=function(){return T.of(!0)},Qr.prototype.stopClosingSidebar=function(){return T.of(!1)},Qr.decorators=[{type:B.Injectable}],Qr.ctorParameters=function(){return[{type:L.FrameContext},{type:m.FarrisSidebarService},{type:Pe},{type:Y,decorators:[{type:B.Optional}]}]},Qr);function Qr(e,t,r,i){this.frameContext=e,this.sidebarUIService=t,this.messageService=r,this.languageService=i,this.languageService||(this.languageService=Y.getInstance())}var Xr=(Zr.prototype.stripFiltersWithSpecialValue=function(e,r){var i=this;if(!e||!r)return e;var t=JSON.parse(e).filter(function(e){var t=i.getFilterValue(e);return-1===r.indexOf(t)});return JSON.stringify(t)},Zr.prototype.getFilterValue=function(e){return e.Value||e.value},Zr.decorators=[{type:B.Injectable}],Zr);function Zr(){}new B.InjectionToken("表单弹出窗口或隐藏组件列表");var ei=(ti.prototype.appendControl=function(e,t){this.controls[e]=t},ti.prototype.getControl=function(e){return this.controls[e]?this.controls[e]:(console.warn("未找到Key为"+e+"的组件！"),null)},ti.prototype.clear=function(e){e?(this.controls[e]=null,delete this.controls[e]):this.controls={}},ti.decorators=[{type:B.Injectable}],ti);function ti(){this.controls={}}var ri=(ii.prototype.queryOperationAuthority=function(e){for(var t=new Map,r=0,i=0;i<e.length;i++)t.set(e[i],r%2==0),r++;var n=new T.Subject;return setTimeout(function(){n.next(t)},0),n},ii);function ii(){}var ni=(oi.prototype.setLabelMap=function(e){var r=this;for(var t in e)this.operationLabelMap.set(t,e[t]);this.operationLabelMap.forEach(function(e,t){r[t]=!1})},oi.prototype.initialize=function(e){var i=this;return this.operationLabelMap&&0<this.operationLabelMap.size?e.queryOperationAuthority(Array.from(this.operationLabelMap.values())).pipe(R.map(function(r){i.operationLabelMap.forEach(function(e,t){i.authOfLabel.set(t,!!r.has(e)&&r.get(e))})})):T.empty()},oi.prototype.hasOperation=function(e){return this.authOfLabel.has(e)&&this.authOfLabel.get(e)},oi);function oi(){this.operationLabelMap=new Map,this.authOfLabel=new Map}var ai=(si.prototype.setContext=function(e){this.appContext=e},si.prototype.handle=function(e){this.formErrorService&&this.formErrorService.exception(this.languageService.loadFailed,e)},si.decorators=[{type:B.Injectable}],si.ctorParameters=function(){return[{type:xe},{type:Y,decorators:[{type:B.Optional}]},{type:L.AppContext}]},si);function si(e,t,r){this.formErrorService=e,this.languageService=t,this.applicationContext=r,(this.appContext=null)==this.languageService&&(this.languageService=Y.getInstance())}var ci=[q,Pe,De,xe,Oe,Ae,Be,Xr,St,Y,yt,Ve,He,Ke,Je,Ze,ke,Mt,ut,Jt,Zt,wt,Et,Ft,st,Rt,Nt,jt,Lt,_t,tr,Cr,Rr,pt,ir,Nr,jr,Lr,Ur,Wr,ft,gt,$r,$e,Yr],ui=(Object.defineProperty(li.prototype,"timeZone",{get:function(){return this.timezone&&this.timezone.id||null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"timeZoneOffset",{get:function(){var e=this.timezone&&this.timezone.baseOffset;return null!==e&&e!==undefined?e:null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"defaultLanguage",{get:function(){return this.i18nSetting&&this.i18nSetting.defaultLanguage||null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"dateFormat",{get:function(){return this.i18nSetting&&this.i18nSetting.userDateFormat||null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"timeFormat",{get:function(){return this.i18nSetting&&this.i18nSetting.userTimeFormat||null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"dateTimeFormat",{get:function(){return(this.i18nSetting&&this.i18nSetting.userDateFormat||"yyyy-MM-dd")+" "+(this.i18nSetting&&this.i18nSetting.userTimeFormat||"HH:mm:ss")},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"addressFormat",{get:function(){return null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"numberFormat",{get:function(){if(this.i18nSetting&&this.i18nSetting.userNumberFormat){var e=this.i18nSetting.userNumberFormat;return{negativeSign:e.negativeSign||"-",numberDecimalDigits:e.numberDecimalDigits||2,numberDecimalSeparator:e.numberDecimalSeparator||".",numberGroupSeparator:e.numberGroupSeparator||","}}return null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"regionCode",{get:function(){return this.i18nSetting&&this.i18nSetting.userRegionCode||null},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"userSettings",{get:function(){return this.frmI18nSettingService&&this.frmI18nSettingService.getSetting()},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"timezone",{get:function(){return this.i18nSetting&&this.i18nSetting.timezone},enumerable:!0,configurable:!0}),Object.defineProperty(li.prototype,"i18nSetting",{get:function(){return this.userSettings&&this.userSettings.i18nSetting},enumerable:!0,configurable:!0}),li.decorators=[{type:B.Injectable}],li.ctorParameters=function(){return[{type:B.Injector},{type:S.FrmI18nSettingService,decorators:[{type:B.Optional}]}]},li);function li(e,t){this.injector=e,this.frmI18nSettingService=t}var pi=(di.prototype.listen=function(e){this.handler=this.messageHandler(e),window.addEventListener("message",this.handler)},di.prototype.destroy=function(){this.handler&&window.removeEventListener("message",this.handler)},di.prototype.send=function(e){if(e){var t=window;e.target&&(t=e.target||window,delete e.target),t&&t.postMessage(e,"*")}},di.decorators=[{type:B.Injectable}],di.ctorParameters=function(){return[]},di);function di(){this.messageHandler=function(r){return function(e){var t=e.data;t&&(t.sender=e.source),"function"==typeof r&&r(t)}}}var fi=(hi.prototype.setup=function(){var e=this;this.workFlowMessageService&&this.workFlowMessageService.listen(function(r){!e.listeners||e.listeners.size<1||e.listeners.forEach(function(e,t){"function"==typeof e&&e(r)})})},hi.prototype.addEventListener=function(e){var t=(new Date).valueOf().toString(16)+"-"+Math.ceil(100*Math.random());return this.listeners.set(t,e),t},hi.prototype.removeEventListener=function(e){!this.listeners||this.listeners.size<1||(this.listeners["delete"](e),e=null)},hi.decorators=[{type:B.Injectable}],hi.ctorParameters=function(){return[{type:B.Injector},{type:pi}]},hi);function hi(e,t){this.injector=e,this.workFlowMessageService=t,this.listeners=new Map}var gi=(vi.prototype.onComponentInit=function(e){var t=this,r=this.workFlowMessage.addEventListener(this.handle.bind(this)),i=this.frameContext.destorySignal;i&&i.subscribe(function(){t.workFlowMessage.removeEventListener(r)});var n=this.frameContext.appContext.destorySignal;n&&n.subscribe(function(){t.workFlowMessage.workFlowMessageService.destroy()})},vi.prototype.handle=function(e){var t=this,r=e.sender,i=e.data,n=i&&i.command||null,o=null;if(n){if("wf-required-verification"==n){var a=this.getFormFrameContexts();o=T.from(a).pipe(R.concatMap(function(e){var t=e.injector.get(ut,null);return t?t.validateAll():T.of(!0)}))}else{var s=this.frameContext.viewModel[n];s&&(o=s(i.arguments))}if(o){var c=this.buildMessage(!0,r,this.isChanged);o.pipe(R.throwIfEmpty()).subscribe(function(e){t.workFlowMessageService.send(c)},function(){c.data.result=!1,t.workFlowMessageService.send(c)})}}},vi.prototype.buildMessage=function(e,t,r,i){return void 0===i&&(i="message"),{data:{result:e,dataChanged:r},type:i,target:t}},vi.prototype.getFormFrameContexts=function(){var e=this.injector.get(L.AppContextManager,null),t=[];if(e){var r=e.getAppContexts();r&&0<r.length&&r.forEach(function(e){e.frameContextManager.getFrameContexts().reduce(function(e,t){var r=t.namespace;if(-1===e.findIndex(function(e){return e.namespace===r})){var i=t.getVirtualRootFrameContext();e.push(i)}return e},t)})}return t},Object.defineProperty(vi.prototype,"isChanged",{get:function(){var e=this.frameContext.repository;return I.BefRepositoryUtil.isExistUnsaveData(e)},enumerable:!0,configurable:!0}),vi.decorators=[{type:B.Injectable}],vi.ctorParameters=function(){return[{type:B.Injector},{type:L.FrameContext},{type:pi},{type:fi}]},vi);function vi(e,t,r,i){this.injector=e,this.frameContext=t,this.workFlowMessageService=r,this.workFlowMessage=i}var yi,mi,Si,Ci,bi,Ii,wi=[q,Pe,De,xe,Te,Oe,Ae,Be,ei,Xr,St,Y,yt,Ve,He,Ke,Je,Ze,ke,Mt,bt,{provide:L.UserSettingsToken,useClass:ui},pi,fi];(mi=yi=yi||{})[mi.Equal=0]="Equal",mi[mi.NotEqual=1]="NotEqual",mi[mi.Greater=2]="Greater",mi[mi.GreaterOrEqual=3]="GreaterOrEqual",mi[mi.Less=4]="Less",mi[mi.LessOrEqual=5]="LessOrEqual",mi[mi.Like=6]="Like",mi[mi.LikeStartWith=7]="LikeStartWith",mi[mi.LikeEndWith=8]="LikeEndWith",mi[mi.NotLike=9]="NotLike",mi[mi.NotLikeStartWith=10]="NotLikeStartWith",mi[mi.NotLikeEndWith=11]="NotLikeEndWith",mi[mi.Is=12]="Is",mi[mi.IsNot=13]="IsNot",mi[mi.In=14]="In",mi[mi.NotIn=15]="NotIn",(Ci=Si=Si||{})[Ci.Value=0]="Value",Ci[Ci.Express=1]="Express",(Ii=bi=bi||{})[Ii.Empty=0]="Empty",Ii[Ii.And=1]="And",Ii[Ii.Or=2]="Or";var xi=(Ei.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:yi.Like,Value:t.value,Relation:bi.And,Expresstype:Si.Value}]},Ei);function Ei(){}var Pi=(Fi.prototype.convert=function(e){var t=[],r=e.value;return r.startTime&&t.push({FilterField:e.fieldCode,Compare:yi.GreaterOrEqual,Value:r.startTime,Relation:bi.And,Expresstype:Si.Value}),r.endTime&&t.push({FilterField:e.fieldCode,Compare:yi.LessOrEqual,Value:r.endTime,Relation:bi.And,Expresstype:Si.Value}),t},Fi);function Fi(){}var Di=(Mi.prototype.convert=function(t){var e=t.value,r=[];return e.value.forEach(function(e){r.push({FilterField:t.fieldCode,Compare:yi.Equal,Value:e.value,Relation:bi.Or,Expresstype:Si.Value})}),r[0].Lbracket="(",r[r.length-1].Rbracket=")",r[r.length-1].Relation=bi.And,r},Mi);function Mi(){}var Ti=(Ri.prototype.convert=function(e){var t=[],r=e.value;return null!=r.startValue&&t.push({FilterField:e.fieldCode,Compare:yi.GreaterOrEqual,Value:r.startValue,Relation:bi.And,Expresstype:Si.Value}),null!=r.endValue&&t.push({FilterField:e.fieldCode,Compare:yi.LessOrEqual,Value:r.endValue,Relation:bi.And,Expresstype:Si.Value}),t},Ri);function Ri(){}var Oi=(Ni.prototype.convert=function(t){var e=t.value;if(0==e.value.length)return[];var r=[];return e.isInputText||null==e.valueField?(r.push({FilterField:t.fieldCode,Compare:yi.Like,Value:e.textValue,Relation:bi.And,Expresstype:Si.Value}),r):(e.getOriginalValue().split(",").forEach(function(e){e&&r.push({FilterField:t.fieldCode,Compare:yi.Equal,Value:e,Relation:bi.Or,Expresstype:Si.Value})}),0<r.length?(r[0].Lbracket="(",r[r.length-1].Rbracket=")",r[r.length-1].Relation=bi.And,r):[])},Ni);function Ni(){}var Ai=(ji.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:yi.Equal,Value:t.yearValue,Relation:bi.And,Expresstype:Si.Value}]},ji);function ji(){}var Bi=(Li.prototype.convert=function(t){var r=[],e=t.value;return 1==e.value.length?[{FilterField:t.fieldCode,Compare:yi.Equal,Value:e.value[0],Relation:bi.And,Expresstype:Si.Value}]:(e.value.forEach(function(e){r.push({FilterField:t.fieldCode,Compare:yi.Equal,Value:e,Relation:bi.Or,Expresstype:Si.Value})}),r[0].Lbracket="(",r[r.length-1].Rbracket=")",r[r.length-1].Relation=bi.And,r)},Li);function Li(){}var Vi=(_i.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:yi.Equal,Value:t.monthValue,Relation:bi.And,Expresstype:Si.Value}]},_i);function _i(){}var ki=(qi.prototype.convert=function(e){var t=[],r=e.value;return r.startTime&&t.push({FilterField:e.fieldCode,Compare:yi.GreaterOrEqual,Value:r.startTime,Relation:bi.And,Expresstype:Si.Value}),r.endTime&&t.push({FilterField:e.fieldCode,Compare:yi.LessOrEqual,Value:r.endTime,Relation:bi.And,Expresstype:Si.Value}),t},qi);function qi(){}var Ui=(Hi.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:yi.Equal,Value:t.datetimeValue,Relation:bi.And,Expresstype:Si.Value}]},Hi);function Hi(){}var Wi=(Ki.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:yi.Equal,Value:t.numValue,Relation:bi.And,Expresstype:Si.Value}]},Ki);function Ki(){}var zi=(Ji.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:yi.Equal,Value:t.dateValue,Relation:bi.And,Expresstype:Si.Value}]},Ji);function Ji(){}var Yi=(Gi.prototype.convert=function(t){var e=t.value;if(0!=e.value.length&&e.valueField){var r=[];return e.getOriginalValue().split(",").forEach(function(e){e&&r.push({FilterField:t.fieldCode,Compare:yi.Equal,Value:e,Relation:bi.Or,Expresstype:Si.Value})}),0<r.length?(r[0].Lbracket="(",r[r.length-1].Rbracket=")",r[r.length-1].Relation=bi.And,r):[]}return[]},Gi);function Gi(){}var $i=(Qi.prototype.convert=function(e){var t=e.value;return[{FilterField:e.fieldCode,Compare:yi.Equal,Value:t.value,Relation:bi.And,Expresstype:Si.Value}]},Qi);function Qi(){}var Xi=(Zi.prototype.convert=function(t){var e=t.value,r=[];return e.isInputText||null==e.textField?(r.push({FilterField:t.fieldCode,Compare:yi.Like,Value:e.textValue,Relation:bi.And,Expresstype:Si.Value}),r):(e.getOriginalValue().split(",").forEach(function(e){e&&r.push({FilterField:t.fieldCode,Compare:yi.Equal,Value:e,Relation:bi.Or,Expresstype:Si.Value})}),0<r.length?(r[0].Lbracket="(",r[r.length-1].Rbracket=")",r[r.length-1].Relation=bi.And,r):[])},Zi);function Zi(){}var en=(tn.getInstance=function(){return tn._instance||(tn._instance=new tn),tn._instance},tn.prototype.getHandler=function(e){return this.queryConditionHandlerMapping.get(e)},tn._instance=null,tn);function tn(){this.queryConditionHandlerMapping=new Map,this.queryConditionHandlerMapping.set(b.ControlType.Text,new xi),this.queryConditionHandlerMapping.set(b.ControlType.InputGroup,new Xi),this.queryConditionHandlerMapping.set(b.ControlType.DateRange,new Pi),this.queryConditionHandlerMapping.set(b.ControlType.DateTimeRange,new Pi),this.queryConditionHandlerMapping.set(b.ControlType.DropDownList,new Di),this.queryConditionHandlerMapping.set(b.ControlType.NumberRange,new Ti),this.queryConditionHandlerMapping.set(b.ControlType.SmartHelp,new Oi),this.queryConditionHandlerMapping.set(b.ControlType.SingleYear,new Ai),this.queryConditionHandlerMapping.set(b.ControlType.BoolCheck,new Bi),this.queryConditionHandlerMapping.set(b.ControlType.SingleMonth,new Vi),this.queryConditionHandlerMapping.set(b.ControlType.MonthRange,new ki),this.queryConditionHandlerMapping.set(b.ControlType.SingleDateTime,new Ui),this.queryConditionHandlerMapping.set(b.ControlType.SingleNumber,new Wi),this.queryConditionHandlerMapping.set(b.ControlType.SingleDate,new zi),this.queryConditionHandlerMapping.set(b.ControlType.ComboLookUp,new Yi),this.queryConditionHandlerMapping.set(b.ControlType.Radio,new $i)}var rn=(nn.prototype.getUserSessionId=function(){return this.frameworkSessionService.getUserSessionId()},nn.prototype.setFilterConditions=function(e){var t,r=[];e.forEach(function(e){e.value.isEmpty()||(t=en.getInstance().getHandler(e.control.getControlType()))&&r.push.apply(r,te(t.convert(e)))}),this.frameContext.uiState.filterConditionList=JSON.stringify(r),this.frameContext.uiState.originalFilterConditionList=JSON.stringify(r)},nn.prototype.setCurrentQueryConditions=function(e){this.frameContext.uiState.currentQueryConditions=e},nn.decorators=[{type:B.Injectable}],nn.ctorParameters=function(){return[{type:L.FrameContext},{type:I.FrameworkSessionService}]},nn);function nn(e,t){this.frameContext=e,this.frameworkSessionService=t}var on=(an.prototype.endEdit=function(){var e=this.frameContext&&this.frameContext.getFormAppContext();return T.of(null).pipe(R.tap(function(){e&&e.messagePipe.next({type:"endEdit"})}),R.delay(5))},an.decorators=[{type:B.Injectable}],an.ctorParameters=function(){return[{type:L.FrameContext}]},an);function an(e){this.frameContext=e}var sn=(cn.prototype.summary=function(e,t){var r=this.viewModel.frameContext.repository||null;if(r){var i=r.proxy;if(i&&"function"==typeof i[e])return i[e](t)}return T.of(null)},cn.decorators=[{type:B.Injectable}],cn.ctorParameters=function(){return[{type:L.ViewModel}]},cn);function cn(e){this.viewModel=e}var un=(ln.prototype.openBatchEditDialog=function(e){var r=this;if(!e)throw new Error("frameId is required.");if(this.batchEditDialogService){var t=[];if(this.viewModel){var i=this.viewModel.frameContext.root.appContext.frameContextManager.getFrameContextById(e).viewModel;i&&i.hasOwnProperty("dataGridColumnsName")?t=i[i.dataGridColumnsName]:i&&i.hasOwnProperty("dataGridColumns")&&(t=i.dataGridColumns);var n=i.uiState.ids||[];if(!n||n.length<1)return this.formNotifyService.warning(this.languageService.plsCheckBatchEditRows,{hideTitle:!0}),T.EMPTY;var o=this.batchEditDialogService.batchEdit(t,{rows:n.length,onConfirm:function(e){if(Array.isArray(n)&&0<n.length){var t=r.viewModel.frameContext.appContext;t.changeDetectionController.detach(),e.forEach(function(e){r.updateBindingData(e,n)}),t.changeDetectionController.reattach()}o.close()}})}}},ln.prototype.openHiddenHelp=function(e){if(!e)throw new Error("Argument error,helpId can`t be empty");var t=this.componentManagerService.getControl(e);if(!t)throw new Error("the component which id is "+e+" can't be found!");t.showDialog()},ln.prototype.clearHelpSelections=function(){var e=this.context&&this.context.eventParam&&this.context.eventParam.instance||null;e&&(e.displayValue="")},ln.prototype.checkCurrentRow=function(e,t,r){var i=this.context&&this.context.eventParam&&this.context.eventParam.instance||null;r=r||"id";var n=JSON.parse(t);if(i&&(e=e||this.viewModel.frameContext.frameId)){var o=this.getFrameContextById(e);if(o){var a=o.viewModel.bindingPath;if(a){var s=a.split("/").filter(function(e){return e}),c=o.bindingData.getValue(s).currentItem,u=n[r];if(u){var l=this.getValueByPath(c,u);i.displayValue=l}}}}},ln.prototype.batchAppend=function(e,t){var n=this,r=this.context&&this.context.eventParam||[];if(!t)throw new Error("mapFields can`t be empty.");if(r&&Array.isArray(r)&&0<r.length){var o=JSON.parse(t),i=this.injector.get(L.AppContext,null);if(i){var a=i.frameContextManager.getFrameContextById(e);if(!a)throw new Error("frameId is invalid!");a.viewModel.bindingPath}var s=[];return r.forEach(function(t){var i={};Object.keys(o).forEach(function(e){var r=n.getValueByPath(t,e);o[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});n.setValueByPath(i,t.join("."),r)})}),s.push(i)}),this.formLoadingService.show(),this.repository.batchAppend(s).pipe(R.tap(function(){return n.formLoadingService.hide()}),R.map(function(){return!0}))}return T.of(!0)},ln.prototype.batchAppendByPathBasedOnHelpSelections=function(e,t){var n=this,r=this.context&&this.context.eventParam||[];if(!t)throw new Error("mapFields can`t be empty.");if(r&&Array.isArray(r)&&0<r.length){var o=JSON.parse(t),i="/",a=this.injector.get(L.AppContext,null);if(a){var s=a.frameContextManager.getFrameContextById(e);if(!s)throw new Error("frameId is invalid!");i=s.viewModel.bindingPath||"/"}var c=[];r.forEach(function(t){var i={};Object.keys(o).forEach(function(e){var r=n.getValueByPath(t,e);o[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});n.setValueByPath(i,t.join("."),r)})}),c.push(i)}),this.formLoadingService.show();var u=this.buildPath(i,this.viewModel.bindingData.list.currentId);return this.repository.batchAppendByPath(u,c).pipe(R.tap(function(){return n.formLoadingService.hide()}),R.map(function(){return!0}))}return T.of(!0)},ln.prototype.batchAppendBasedOnRowHelpSelections=function(e,t){var f=this,h=this.context&&this.context.eventParam||[];if(!t)return T.of(!0);var g=JSON.parse(t);if(!g||!g.hasOwnProperty("id"))return T.of(!0);if(!(e=e||this.viewModel.frameContext.frameId))return T.of(!0);var v=this.getFrameContextById(e);return v&&setTimeout(function(){f.endEdit(v).subscribe(function(){if(h&&Array.isArray(h)&&0<h.length){var n=v.viewModel.bindingPath||"/",o=n.split("/").filter(function(e){return e}),e=[],t=v.bindingData.getValue(o),r=(t.currentItem,t.currentId),i=f.getEntityByPath(v,o,r),a=h[0];if(1===h.length)return f.mappingRow(a,g,i,n),T.of(!0);var s=g.id,c=f.getValueByPath(i,s);if(c&&-1!==h.findIndex(function(e){return e[t.primaryKey]===c})){if(c){var u=h.findIndex(function(e){return e[t.primaryKey]===c});f.mappingRow(h[u],g,i,n),h.splice(u,1)}}else f.mappingRow(a,g,i,n),h=h.slice(1);var l=t.toArray().filter(function(e){return!f.getValueByPath(e,g[t.primaryKey])});if(l&&0<l.length){var p=h;h=h.length>l.length?(p=h.slice(0,l.length),h.slice(l.length)):[],p.forEach(function(e,t){var r=l[t],i=f.getEntityByPath(v,o,r.primaryKeyValue);f.mappingRow(e,g,i,n)})}if(h.forEach(function(t){var i={};Object.keys(g).forEach(function(e){var r=f.getValueByPath(t,e);g[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});f.setValueByPath(i,t.join("."),r)})}),e.push(i)}),0<e.length){f.formLoadingService.show();var d=f.buildPath(n,f.viewModel.bindingData.list.currentId);f.repository.batchAppendByPath(d,e).pipe(R.tap(function(){return f.formLoadingService.hide()})).subscribe()}}})},100),T.of(!0)},ln.prototype.copy=function(e){var i=this;if(!e)return this.formNotifyService.warning(this.languageService.plsSelectCopyData,{hideTitle:!0}),T.EMPTY;var t=this.repository,r=t.restService.baseUri+"/service/copymainobjvoaction",n={body:{requestInfo:t.restService.buildRequestInfo(),dataID:e}};return this.formLoadingService.show(),t.proxy.request(r,"PUT",null,n).pipe(R.tap(function(){i.formLoadingService.hide()}),R.map(function(e){var t=e.returnValue,r=i.repository.buildEntity(t);return i.repository.entityCollection.addEntity(r),r}))},ln.prototype.clone=function(e,t){var n=this;if(!e)return this.formNotifyService.warning(this.languageService.plsSelectCopyData,{hideTitle:!0}),T.EMPTY;if(!t)return this.formNotifyService.warning(this.languageService.pathIsRequired,{hideTitle:!0}),T.EMPTY;t.startsWith("/")||(t="/"+t),t=t.toLowerCase();var o=this.viewModel.bindingPath,a=this.repository,r=""+a.restService.baseUri+t,i=a.restService.buildRequestInfo(),s=this.buildIds(o);s.push(e);var c={body:{requestInfo:i,dataID:s.join(",")}};return this.formLoadingService.show(),a.proxy.request(r,"PUT",null,c).pipe(R.tap(function(){n.formLoadingService.hide()}),R.map(function(e){var t=e.returnValue,r=null;if(0===o.split("/").filter(function(e){return e}).length)r=n.repository.buildEntity(t),n.repository.entityCollection.addEntity(r,!0);else{var i=n.buildPath(o,n.viewModel.bindingData.list.currentId);r=a.entityManager.appendEntityByPath(i,t,t,!0)}return r}))},ln.prototype.copyRow=function(e,t,r){var i=this;if(void 0===r&&(r=1),"number"!=typeof r&&(r=parseInt(r,10)),r<1)throw new Error("ArgumentError: repeat must >= 1");var n=this.viewModel.frameContext.appContext.frameContextManager.getFrameContextById(e),o=n.bindingData.list.currentId,a=n.viewModel.bindingPath||"/",s=null,c=null;if("/"===a)c=n.bindingData.list.currentItem;else{var u=a.split("/").filter(function(e){return e});c=n.bindingData.getValue(u).currentItem}if(s=c.toJSON(),!c.primaryKeyValue)return this.formNotifyService&&this.formNotifyService.warning(this.languageService.plsSelectCopyData,{hideTitle:!0}),T.EMPTY;var l=t.split(",").filter(function(e){return e}),p=new Array(r);return T.from(p).pipe(R.concatMap(function(){var e=null;if("/"!==a){var t=i.buildPath(a,o);e=i.repository.appendByPath(t)}else e=i.repository.append();return e.pipe(R.tap(function(e){s[e.primaryKey]=e.primaryValue,l.forEach(function(e){var t=e.split(".").filter(function(e){return e});1===t.length&&delete s[e],delete t.slice(0,-1).reduce(function(e,t,r){return e[t]},s)[t[t.length-1]]}),s=Object.assign({},e.toJSON(),s),e.load(s,{loadChild:!1})}),R.catchError(function(){return T.EMPTY}))}))},ln.prototype.afterIncrementalSelectHelpClose=function(e,t,r){var n=this,i=this.context&&this.context.eventParam||[];if(!r)throw new Error("associated field can`t be empty.");if(!t)throw new Error("mapFields can`t be empty.");var o=JSON.parse(t),a=r,s=this.viewModel.frameContext.root,c="/",u=this.injector.get(L.AppContext,null);if(u){var l=u.frameContextManager.getFrameContextById(e);if(!l)throw new Error("frameId is invalid!");c=l.viewModel.bindingPath||"/"}if((s.uiState.selections=i)&&Array.isArray(i)){var p=c.split("/").filter(function(e){return e}),d=this.viewModel.bindingData.getValue(p),f=d.toArray(),h=[];i.reduce(function(e,t){var r=t&&t[d.primaryKey]||null;return f.find(function(e){return e[a][a]===r})||e.push(t),e},h);var g=[];f.reduce(function(e,t){return-1===i.findIndex(function(e){return e[d.primaryKey]===t[a][a]})&&e.push(t.primaryKeyValue),e},g);var v=T.from(h).pipe(R.concatMap(function(t){var e=n.buildPath(c,n.viewModel.bindingData.list.currentId);return n.repository.appendByPath(e).pipe(R.tap(function(i){Object.keys(o).forEach(function(e){var r=n.getValueByPath(t,e);o[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});n.setValueByPath(i,t.join("."),r)})})}),R.catchError(function(){return T.EMPTY}))})),y=T.from(g).pipe(R.concatMap(function(e){var t=n.buildPath(c,n.viewModel.bindingData.list.currentId);return n.repository.removeByPath(t,e).pipe(R.tap(function(){n.repository.entityManager.removeEntityByPath(t,e)}),R.catchError(function(){return T.EMPTY}))}));return h.length<1&&g&&g.length<1?T.of(!0):T.concat(v,y).pipe(R.catchError(function(){return T.EMPTY}))}return T.of(!0)},ln.prototype.beforeMultiSelectHelpOpen=function(){return this.clearHelpSelections()},ln.prototype.afterMultiSelectHelpClose=function(e,t,r,i){var n=this.context&&this.context.eventParam||[];return n&&Array.isArray(n)&&(!n||n.length<1||this.onHelpClose.next({frameId:e,mapFields:t,data:n,commandFrameId:r,commandName:i})),T.of(!0)},ln.prototype.onHelpCloseHandler=function(e,t,r){var o=this;if(!t)throw new Error("mapFields can`t be empty.");var a=JSON.parse(t),i="/",n=this.injector.get(L.AppContext,null);if(n){var s=n.frameContextManager.getFrameContextById(e);if(!s)throw new Error("frameId is invalid!");i=s.viewModel.bindingPath||"/"}var c=this.viewModel.frameContext.root,u=this.repository,l=i.split("/").filter(function(e){return e});if((c.uiState.selections=r)&&Array.isArray(r)){var p=T.from(r).pipe(R.concatMap(function(n){var e=u.restService.buildRequestInfo();if(0<l.length){var r=o.buildPath(i,o.viewModel.bindingData.list.currentId);return u.restService.createByPath(r,e).pipe(R.tap(function(e){var t=e.returnValue,i=u.entityManager.appendEntityByPath(r,t,t);return Object.keys(a).forEach(function(e){var r=o.getValueByPath(n,e);a[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});o.setValueByPath(i,t.join("."),r)})}),i}))}return u.restService.create(null,e).pipe(R.tap(function(e){var t=e.returnValue,i=o.repository.buildEntity(t);return Object.keys(a).forEach(function(e){var r=o.getValueByPath(n,e);a[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});o.setValueByPath(i,t.join("."),r)})}),o.repository.entityCollection.addEntity(i),i}))}));return this.formLoadingService&&(this.suspendFrameContextEvent(e),this.formLoadingService.show(),this.formLoadingService.setSuspend(!0)),p.pipe(R.last()).pipe(R.switchMap(function(){var e=o.viewModel.bindingData.list.currentId;return e?u.updateChangesById(e):T.of(null)})).subscribe(function(){o.formLoadingService&&(o.resumeFrameContextEvent(e),o.formLoadingService.setSuspend(!1),o.formLoadingService.hide())},function(){o.formLoadingService&&(o.resumeFrameContextEvent(e),o.formLoadingService.setSuspend(!1),o.formLoadingService.hide())})}return T.of(null)},ln.prototype.suspendFrameContextEvent=function(e){var t=this.injector.get(L.AppContext,null);t&&(t.frameContextManager.getFrameContextById(e).suspend=!0)},ln.prototype.resumeFrameContextEvent=function(e){var t=this.injector.get(L.AppContext,null);if(t){var r=t.frameContextManager.getFrameContextById(e);r.suspend=!1,r.appContext.messagePipe.next("bindData")}},ln.prototype.setValueByPath=function(e,t,r){if(e){var i=t.split(".");i.length<=1?e[t]=r:i.slice(0,-1).reduce(function(e,t){return e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t)||(e[t]={}),e[t]},e)[i[i.length-1]]=r}},ln.prototype.getValueByPath=function(r,e){var t=e.split(".");if(!(t.length<1)){if(1===t.length)return r[e];var i=null;return t.forEach(function(e,t){i=0===t?r&&r[e]||null:i&&i[e]||null}),i}},ln.prototype.buildPath=function(e,t){var r="/"+t,i=e.split("/");if(0<i.length)for(var n=1;n<i.length-1;n++){var o=i[n],a=this.viewModel.bindingData[o];if(!a||!a.currentId)throw Error("获取子表完整路径出错，找不到"+a+"对应的子表，或对应子表没有当前行。");r+="/"+o+"/"+a.currentId}return r+="/"+i[i.length-1]},ln.prototype.buildIds=function(e){var r=this,t=e.split("/").filter(function(e){return e}),i=this.viewModel.bindingData.list.currentId,n=[],o=[];return 0<t.length&&(n.push(i),t.pop(),t.forEach(function(e){o.push(e);var t=r.viewModel.bindingData.getValue(o);t&&n.push(t.currentId)})),n},ln.prototype.updateBindingData=function(e,t){var r=e||{},i=r.controlType,n=void 0===i?null:i,o=r.value,a=void 0===o?null:o,s=r.options;if(n)if("lookup"===n||"combo-lookup"===n){var c=(void 0===s?{}:s).mapFields;this.updateLookupField(t,a,c)}else this.updateSimpleField(t,a,e)},ln.prototype.updateSimpleField=function(e,t,r){var i=this;if(r){var n=r.dataType,o=t;if("date"===n){var a=this.dateService.formatTo(t,"yyyy-MM-dd");o=a=a||"0001-01-01T00:00:00"}else"number"===n&&(o=Number(t)||0);var s=r.field;e.forEach(function(e){i.updateBindingList(e,s,o)})}},ln.prototype.updateLookupField=function(e,i,n){var o=this;if(n){var t=Object.keys(n),r=t.findIndex(function(e){return"id"===e});t.includes("id")&&0!==r&&(t.splice(r,1),t=te(["id"],t)),t.forEach(function(t){var r="";i&&(r=i instanceof Array?i.map(function(e){return o.getValue(t,e)}).join(","):o.getValue(t,i)),e.forEach(function(e){o.updateBindingList(e,n[t],r)})})}},ln.prototype.updateBindingList=function(e,t,r){if(this.viewModel&&t){var i=t.split(".").filter(function(e){return e}),n=this.bindingList.findById(e);if(i.length<2)n.setValue(t,r,!0,!0);else{var o=null,a=i.slice(0,i.length-1),s=i[i.length-1];a.forEach(function(e){o=o&&o[e]||n[e]}),o.setValue(s,r,!0,!0)}}},ln.prototype.getBindingPathArray=function(){var e=this.viewModel.bindingPath;return e?e.split("/").filter(function(e){return""!==e}):[]},ln.prototype.getValue=function(e,t){return-1===e.indexOf(".")?t[e]:e.split(".").reduce(function(e,t){return e[t]},t)},Object.defineProperty(ln.prototype,"bindingList",{get:function(){if("/"===this.viewModel.bindingPath||!this.viewModel.bindingPath)return this.viewModel.bindingData.list;var e=this.viewModel.bindingPath.substr(1),t=(e=e[0].toLowerCase()+e.substring(1,e.length)).split("/").filter(function(e){return""!==e});return this.viewModel.bindingData.getValue(t)},enumerable:!0,configurable:!0}),ln.prototype.mappingRow=function(t,i,n,e){var o=this;Object.keys(i).forEach(function(e){var r=o.getValueByPath(t,e);i[e].split(",").filter(function(e){return e}).forEach(function(e){var t=e.split(".").filter(function(e){return e});o.setValueByPath(n,t.join("."),r)})})},ln.prototype.getFrameContextById=function(e){if(!e)return null;var t=this.injector.get(L.AppContext,null),r=null;return t&&(r=t.frameContextManager.getFrameContextById(e)),r},ln.prototype.getEntityByPath=function(n,e,t){e=te(e);var r=n.bindingData.list.currentId,i=n.repository.entityCollection.getEntityById(r),o=[],a=e.pop(),s=e.reduce(function(e,t){if(o.push(t),e&&(e.hasOwnProperty(t)||e.__proto__.hasOwnProperty(t))){var r=e[t];if(r&&r instanceof L.EntityList){var i=n.bindingData.getValue(o).currentId;return r.get(i)}return r}return null},i);if(s instanceof L.Entity){var c=s[a];if(c)return c.get(t);throw new Error("无效的bindingPath.")}throw new Error("无效的bindingPath.")},ln.prototype.endEdit=function(e){var t=e&&e.getFormAppContext();return T.of(null).pipe(R.tap(function(){t&&t.messagePipe.next({type:"endEdit"})}),R.delay(5))},ln.decorators=[{type:B.Injectable}],ln.ctorParameters=function(){return[{type:B.Injector},{type:ei},{type:L.ViewModel},{type:L.Repository},{type:O.BatchEditDialogService},{type:w.DateTimeHelperService},{type:Y},{type:De}]},ln);function ln(e,t,r,i,n,o,a,s){var c=this;this.injector=e,this.componentManagerService=t,this.viewModel=r,this.repository=i,this.batchEditDialogService=n,this.dateService=o,this.languageService=a,this.formNotifyService=s,this.formLoadingService=this.injector.get(q,null),this.languageService||(this.languageService=Y.getInstance()),this.formNotifyService||(this.formNotifyService=this.injector.get(De,null)),this.onHelpClose=new T.Subject,this.onHelpClose.subscribe(function(e){var t=e||{},r=t.frameId,i=void 0===r?"":r,n=t.mapFields,o=void 0===n?"":n,a=t.data,s=void 0===a?[]:a;c.onHelpCloseHandler(i,o,s)})}var pn=(Object.defineProperty(dn.prototype,"repository",{get:function(){return this.frameContext.repository},enumerable:!0,configurable:!0}),Object.defineProperty(dn.prototype,"params",{get:function(){return this.context&&this.context.eventParam||{}},enumerable:!0,configurable:!0}),dn.prototype.addComment=function(e,t,r,i,n,o){var a=this;if(!(e=e||this.frameContext&&this.frameContext.bindingData.list.currentId||null))return T.EMPTY;var s=this.buildAddCommentParam(e,i,o,t,n,r),c=this.repository.restService,u=c.buildRequestInfo(),l={body:X({requestInfo:u},s)};return this.loadingService.show(),c.invoke("/api/runtime/comment/v1.0/bill-comment/comment","POST",null,l).pipe(R.tap(function(){a.loadingService.hide()}))},dn.prototype.queryComments=function(e,t,r,i){var n=this;if(!(e=e||this.frameContext&&this.frameContext.bindingData.list.currentId||null))return T.EMPTY;var o=this.repository.restService,a=this.buildQueryCommentsUrl(e,r,i,t);return this.loadingService.show(),o.invoke(a,"GET").pipe(R.tap(function(){n.loadingService.hide()}))},dn.prototype.queryAllOrgs=function(){var e=this,t=this.repository.restService;return this.loadingService.show(),t.invoke('/api/runtime/sys/v1.0/sysOrgs?param={"layer":"1"}',"GET").pipe(R.tap(function(){e.loadingService.hide()}))},dn.prototype.queryFrequentAtUsers=function(e,t){var r=this,i=this.repository.restService,n=this.buildQueryFrequentAtUsersUrl(e,t);return this.loadingService.show(),i.invoke(n,"GET").pipe(R.tap(function(){r.loadingService.hide()}))},dn.prototype.queryAtUsers=function(e,t,r){var i=this,n=this.repository.restService,o=this.buildQueryAtUsersUrl(e,t,r);return this.loadingService.show(),n.invoke(o,"GET").pipe(R.tap(function(){i.loadingService.hide()}))},dn.prototype.buildQueryCommentsUrl=function(e,t,r,i){return null==t&&(t=this.params.pageIndex||0),null==r&&(r=this.params.pageSize||10),this.repository.serverUri,"/api/runtime/comment/v1.0/bill-comment/comment/byBill?configId="+i+"&billId="+e+"&pageSize="+r+"&pageIndex="+t},dn.prototype.buildQueryAtUsersUrl=function(e,t,r){var i=[];return null==t&&(t=this.params.pageIndex||0),null==r&&(r=this.params.pageSize||1e3),e&&i.push("param="+e),i.push("pageSize="+r),i.push("pageIndex="+t),"/api/runtime/comment/v1.0/bill-comment/atUser?"+i.join("&")},dn.prototype.buildQueryFrequentAtUsersUrl=function(e,t){var r=[];return null==e&&(e=this.params.pageIndex||0),null==t&&(t=this.params.pageSize||6),r.push("pageSize="+t),r.push("pageIndex="+e),"/api/runtime/comment/v1.0/bill-comment/frequentAtUsers?"+r.join("&")},dn.prototype.buildAddCommentParam=function(e,t,r,i,n,o){return void 0===t&&(t=this.params.text),void 0===r&&(r=this.params.parentId),void 0===n&&(n=this.params.visibility),{bill:{billId:e,configId:o,summary:i},comment:{billId:e,configId:o,parentId:r||null,text:t,visibility:n}}},dn.decorators=[{type:B.Injectable}],dn.ctorParameters=function(){return[{type:B.Injector},{type:L.FrameContext},{type:q},{type:Ke}]},dn);function dn(e,t,r,i){this.injector=e,this.frameContext=t,this.loadingService=r,this.runtimeFrameworkService=i}var fn=(hn.prototype.setCurrentFilterConditions=function(e){this.frameContext.uiState.currentFilterConditions=e},hn.decorators=[{type:B.Injectable}],hn.ctorParameters=function(){return[{type:L.FrameContext}]},hn);function hn(e){this.frameContext=e}var gn=(vn.prototype.load=function(){this.modulePath.endsWith("/")&&(this.modulePath=this.modulePath.substring(0,this.modulePath.length-1));var e=this.modulePath+"/expressions/form.manifest.json?version="+(new Date).valueOf().toString(),t=vn.mainfests.get(this.modulePath);if(t)return t;var r=this.httpClient.get(e,{responseType:"json"}).pipe(R.share());return vn.mainfests.set(this.modulePath,r),r},vn.mainfests=new Map,vn.decorators=[{type:B.Injectable}],vn.ctorParameters=function(){return[{type:B.Injector},{type:undefined,decorators:[{type:B.Inject,args:[L.FORM_PATH_TOKEN]}]},{type:x.HttpClient}]},vn);function vn(e,t,r){this.injector=e,this.modulePath=t,this.httpClient=r}var yn=(mn.prototype.load=function(){var a=this;return this.modulePath.endsWith("/")&&(this.modulePath=this.modulePath.substring(0,this.modulePath.length-1)),this.formManifestService.load().pipe(R.switchMap(function(e){var t=e.expressions.find(function(e){return e.ns===a.frameContext.namespace});if(t){var r=a.modulePath+"/expressions/"+t.path+"?version="+(new Date).valueOf().toString(),i=a.modulePath+"/expressions/"+t.path,n=mn.mainfests.get(i);if(n)return n;var o=a.httpClient.get(r,{responseType:"json"}).pipe(R.share());return mn.mainfests.set(i,o),o}return T.of({})}))},mn.mainfests=new Map,mn.decorators=[{type:B.Injectable}],mn.ctorParameters=function(){return[{type:B.Injector},{type:L.FrameContext},{type:x.HttpClient},{type:undefined,decorators:[{type:B.Inject,args:[L.FORM_PATH_TOKEN]}]},{type:undefined,decorators:[{type:B.Inject,args:[L.FORM_MANIFEST_SERVICE_TOKEN]}]}]},mn);function mn(e,t,r,i,n){this.injector=e,this.frameContext=t,this.httpClient=r,this.modulePath=i,this.formManifestService=n}var Sn=(Object.defineProperty(Cn.prototype,"formats",{get:function(){var e=this.userSettings||{},t=e.dateFormat,r=void 0===t?null:t,i=e.timeFormat,n=void 0===i?null:i,o=null;r&&n&&(o=r+" "+n);var a={dateFormat:r,timeFormat:n,dateTimeFormat:o},s=this.numberFormat||{},c=s.negativeSign,u=s.numberDecimalDigits,l=s.numberDecimalSeparator,p=s.numberGroupSeparator;return{date:a,number:{negativeSign:void 0===c?null:c,numberDecimalDigits:void 0===u?null:u,numberDecimalSeparator:void 0===l?null:l,numberGroupSeparator:void 0===p?null:p}}},enumerable:!0,configurable:!0}),Cn.prototype.localize=function(e,t){return t&&e?"date"===(t=t.toLowerCase())?this.transformDate(e):"datetime"===t?this.transformDateTime(e):"number"===t?this.transformNumber(e):e:e},Cn.prototype.getFormat=function(e){return"date"===(e=e&&e.toLowerCase())?this.formats.date.dateFormat:"datetime"===e?this.formats.date.dateTimeFormat:""},Cn.prototype.transformDate=function(e){var t=this.userSettings&&this.userSettings.dateFormat||"YYYY-MM-DD";if(!t||!e)return e;var r=E(e);return r.isValid()?(t=this.parseDateFormat(t),r.format(t)):e},Cn.prototype.transformDateTime=function(e){var t=this.userSettings&&this.userSettings.dateFormat||"YYYY-MM-DD",r=this.userSettings&&this.userSettings.timeFormat||"HH:mm:ss";if(!t||!r)return e;var i=E(e);if(!i.isValid())return e;var n=(t=t&&this.parseDateFormat(t))+" "+(r=r&&this.parseTimeFormat(r));return i.format(n)},Cn.prototype.transformNumber=function(e){if(null===e||e===undefined||""===e)return"";var t=new M.BigNumber(e);if(!M.BigNumber.isBigNumber(t))return e;var r=t.isNegative(),i=this.buildNumberFormat(),n=this.numberFormat||{},o=n.negativeSign,a=void 0===o?null:o,s=n.numberDecimalDigits,c=void 0===s?null:s;return r&&null!==a?(i.prefix=a,t.absoluteValue().toFormat(c,null,i)):t.toFormat(c,null,i)},Cn.prototype.parseDateFormat=function(e){return e.replace(/y/g,"Y").replace(/d/g,"D")},Cn.prototype.parseTimeFormat=function(e){return e.replace(/M/g,"m")},Cn.prototype.buildNumberFormat=function(){if(this.numberFormat){var e=this.numberFormat,t=e.numberDecimalSeparator,r=void 0===t?null:t,i=e.numberGroupSeparator,n=void 0===i?null:i,o={groupSize:3};return null!==r&&(o.decimalSeparator=r),null!==n&&(o.groupSeparator=n),o}},Object.defineProperty(Cn.prototype,"numberFormat",{get:function(){return this.userSettings&&this.userSettings.numberFormat||null},enumerable:!0,configurable:!0}),Cn.decorators=[{type:B.Injectable}],Cn.ctorParameters=function(){return[{type:B.Injector},{type:undefined,decorators:[{type:B.Inject,args:[L.UserSettingsToken]}]}]},Cn);function Cn(e,t){this.injector=e,this.userSettings=t}var bn=(Object.defineProperty(In.prototype,"eventParam",{get:function(){return this.context&&this.context.eventParam||null},enumerable:!0,configurable:!0}),In);function In(){}var wn,xn=(Q(En,wn=bn),En.prototype.clearChecks=function(){var e=this.getFormGridComponents(this.context);e&&0<e.length&&e.forEach(function(e){var t=!0;e.hasOwnProperty("clearSelectionsWhenDataIsEmpty")&&(t=e.clearSelectionsWhenDataIsEmpty),t&&e.clearCheckeds(!0)})},En.prototype.uncheckDeletedRows=function(e){if("string"==typeof e&&(e=-1!==e.indexOf(",")?e.split(",").filter(function(e){return e}):[e]),e&&!(e.length<1)){var t=this.context.frameContext;if(t){var r=t.appContext,i=t.namespace,n=t.viewModel&&t.viewModel.bindingPath;if(r){var o=r.frameContextManager.getFrameContextsByNamespace(i),a=o.filter(function(e){return e&&e.viewModel&&e.viewModel.bindingPath===n}),s=this.getGridComponentByFrameContexts(a);if(s){var c=s.pop();c&&c.unCheckRows(e,!0);var u=o.filter(function(e){return e.viewModel.bindingPath!==n&&e.viewModel.bindingPath.startsWith(n)}),l=this.getGridComponentByFrameContexts(u);l&&0<l.length&&l.forEach(function(e){e.checkedRows=[]})}}}}},En.prototype.uncheckRows=function(t){if("string"==typeof t&&(t=[t]),t&&!(t.length<1)){var e=this.getFormGridComponents(this.context);e&&0<e.length&&e.forEach(function(e){e.unCheckRows(t,!0)})}},En.prototype.getFormGridComponents=function(e){var r=[],t=e&&e.frameContext,i=t&&t.appContext||null;if(i){var n=i.componentRefs;Array.from(n.values()).forEach(function(e){var t=Array.from(e.values()).filter(function(e){return e instanceof P.DatagridComponent});r=r.concat(t)})}return r},En.prototype.getGridComponentByFrameContexts=function(e){return e.reduce(function(e,t){var r=t.appContext,i=t.frameId,n=r.componentRefs.get(i),o=n&&Array.from(n.values()).filter(function(e){return e instanceof P.DatagridComponent});return o&&0<o.length&&(e=e.concat(o)),e},[])},En.decorators=[{type:B.Injectable}],En);function En(){return null!==wn&&wn.apply(this,arguments)||this}var Pn=(Fn.prototype.blink=function(e,t){if("string"==typeof e&&(e=e.split(",").filter(function(e){return e})),!Array.isArray(e)||e.length<1)return T.EMPTY;"string"==typeof t&&(t=t.trim()),t=t||600,t=parseInt(t),(isNaN(t)||t<=0)&&(t=600);var r=e.map(function(e){return{idOrEl:e}});this.attentionService.catchAttention(r,t)},Fn.decorators=[{type:B.Injectable}],Fn.ctorParameters=function(){return[{type:B.Injector},{type:L.FrameContext},{type:F.AttentionService}]},Fn);function Fn(e,t,r){this.injector=e,this.frameContext=t,this.attentionService=r}var Dn,Mn,Tn,Rn=(On.prototype.getFeaturesByMaterialId=function(e){var t={body:{materialID:e}};return this.repository.proxy.request("/api/scm/scmfnd/v1.0/scmcommoncmpservice/service/getmaterialprops","put",null,t)},On.prototype.getConfigedValueByFeatureId=function(e,t,r){void 0===r&&(r="Materials");var i={body:{objType:r,objID:e,configID:t}};return this.repository.proxy.request("/api/bf/df/v1.0/charactconfigservice/service/getcharactconfiginfo","put",null,i)},On.prototype.applyFeatures=function(e,t,r){void 0===r&&(r="Materials");var i={body:{objType:r,objID:e,charactValue:t}};return this.repository.proxy.request("/api/bf/df/v1.0/charactconfigservice/service/matchcharactconfigid","put",null,i)},On.prototype.getHelpInfo=function(e,t,r){var i={};r&&(r.pageIndex&&(i.pageIndex=JSON.stringify(r.pageIndex-0)),r.pageSize&&(i.pageSize=JSON.stringify(r.pageSize-0)),r.condition&&(i.condition=JSON.stringify(r.condition)),r.searchValue&&(i.search=r.searchValue));var n={body:{helpID:e,queryParam:JSON.stringify(i),filterStr:t}};return this.repository.proxy.request("/api/scm/scmfnd/v1.0/scmcommoncmpservice/service/gethelpdata","put",null,n)},On.decorators=[{type:B.Injectable}],On.ctorParameters=function(){return[{type:B.Injector},{type:L.Repository}]},On);function On(e,t){this.injector=e,this.repository=t}Mn=Dn=Dn||{},(Tn=Mn.InputType||(Mn.InputType={}))["enum"]="Enum",Tn.string="String",Tn.help="Help",Tn.number="Number",Tn.date="Date";var Nn=(An.prototype.getFeaturesByMaterialId=function(e){var o=this;return this.repository.getFeaturesByMaterialId(e).pipe(R.map(function(e){if(!e||!e.returnValue)return null;var t=JSON.parse(e.returnValue),r={propset:[],props:[]},i=t.propset||null,n=t.props||null;return i&&Array.isArray(i)&&(i.map(function(e){return e.name=o.translateName(e),e}),r.propset=i),n&&Array.isArray(n)&&0<n.length&&(n.map(function(e){return e.name=o.translateName(e),e.inputtype===Dn.InputType["enum"]&&e.enuminfo&&(e.data=JSON.parse(e.enuminfo)),e.isreadonly="1"===e.isreadonly,e.isrequired="1"===e.isrequired,e}),r.props=n),r}))},An.prototype.getConfigedValueByFeatureId=function(e,t,r){return void 0===r&&(r="Materials"),this.repository.getConfigedValueByFeatureId(e,t,r).pipe(R.map(function(e){return JSON.parse(e)}))},An.prototype.applyFeatures=function(e,t,r){return void 0===r&&(r="Materials"),this.repository.applyFeatures(e,t,r).pipe(R.map(function(e){return JSON.parse(e)}))},An.prototype.getHelpInfo=function(e,t,r){var i={};r&&(r.pageIndex&&(i.pageIndex=JSON.stringify(r.pageIndex-0)),r.pageSize&&(i.pageSize=JSON.stringify(r.pageSize-0)),r.condition&&(i.condition=JSON.stringify(r.condition)),r.searchValue&&(i.search=r.searchValue));var n={body:{helpID:e,queryParam:JSON.stringify(i),filterStr:t}};return null.proxy.request("/api/scm/scmfnd/v1.0/scmcommoncmpservice/service/gethelpdata","put",null,n).pipe(R.map(function(e){return JSON.parse(e)}))},An.prototype.translateName=function(e){if(!e)return null;var t=null;switch(this.localeId){case"en":t=e.name_en;break;case"zh-CHS":t=e.name_chs;break;case"zh-CHT":t=e.name_cht;break;default:t=e.name_chs}return t},An.decorators=[{type:B.Injectable}],An.ctorParameters=function(){return[{type:B.Injector},{type:Rn},{type:String,decorators:[{type:B.Optional},{type:B.Inject,args:[B.LOCALE_ID]}]}]},An);function An(e,t,r){this.injector=e,this.repository=t,this.localeId=r,this.localeId=this.localeId||"zh-CHS"}var jn=(Bn.prototype.edit=function(e,t,i){var n=this;if(!e)throw new Error("[FeatureEditService]物料id不能为空！");return"string"==typeof(i=i||{})&&i.startsWith("{")&&i.endsWith("}")&&(i=JSON.parse(i)),i.getHelpInfo=this.featureDataService.getHelpInfo,this.loadingService.show(),this.featureDataService.getFeaturesByMaterialId(e).pipe(R.tap(function(e){n.loadingService.hide();var t=e||null;if(t){var r=JSON.parse(t).props||null;if(!r||r.length<1)return void n.notifyService.warning(n.languageService.propsIsEmpty);n.featureEditorService.show(r,i)}else n.notifyService.error(n.languageService.propsIsEmpty)}))},Bn.prototype.buildFeatures=function(e,t){var i=this;return this.featureDataService.getFeaturesByMaterialId(e).pipe(R.switchMap(function(r){return t?i.featureDataService.getConfigedValueByFeatureId(t,t).pipe(R.map(function(e){var t=r.props;return i.mergeFeatures(t,e)})):T.of(r.props)}))},Bn.prototype.mergeFeatures=function(e,t){return null},Bn.decorators=[{type:B.Injectable}],Bn.ctorParameters=function(){return[{type:B.Injector},{type:D.FeatureEditorService},{type:Nn},{type:q},{type:De},{type:Y}]},Bn);function Bn(e,t,r,i,n,o){this.injector=e,this.featureEditorService=t,this.featureDataService=r,this.loadingService=i,this.notifyService=n,this.languageService=o}var Ln=(Vn.prototype.execute=function(e,t){var r,i=this.resolveService.resolve(e),n=L.ExpressionUtil.getGroupFunctionDependency(e,this.frameContext.repository.entityTypeInfo),o=this.buildEntityContext(i,n),a=this.buildStateContext(),s=X(((r={})[this.entityOriginalNodeCode]=o,r),a,{BigNumber:M.BigNumber,frameContext:this.frameContext,bindingData:this.frameContext.bindingData,repository:this.frameContext.repository},t);return this.expressionExecutor.eval(e,s)},Vn.prototype.executeAsync=function(e,t){var r=this.execute(e,t);return T.of(r)},Vn.prototype.buildEntityContext=function(e,i,t){var n=this,o=!1;e.forEach(function(t){var e=n.isEntityDependency(t),r=-1!==i.findIndex(function(e){return e===t});e&&r&&1==t.split("/").filter(function(e){return e}).length-1&&(o=!0)});var r=this.getEntity();if(o){var a=this.frameContext.repository.entityCollection.toJSON();r.__type__="List",r.__items__=a}return r},Vn.prototype.isEntityDependency=function(e){return e.startsWith(L.ENTITY_TEMPLATE)},Vn.prototype.getEntity=function(){var e=this.frameContext.repository.entityTypeInfo,o=this.frameContext.bindingData,t=[];L.ExpressionUtil.getChildrenEntityPaths(e,t);var a=this.frameContext.bindingData.list.currentItem.toJSON();return a.__type__="Entity",!t||t.length<1||t.forEach(function(e){var t=L.ExpressionUtil.getCurrentRowByPaths(e,o);if(t){var r=e.pop(),i=e.reduce(function(e,t){return e&&e[t]||null},a),n=X({__items__:te(i[r])},t,{__type__:"List"});i[r]=n}}),a},Object.defineProperty(Vn.prototype,"entityOriginalNodeCode",{get:function(){var e=this.injector.get(L.Repository);return e&&e.entityTypeInfo&&e.entityTypeInfo.entityInfo&&e.entityTypeInfo.entityInfo.originalCode||null},enumerable:!0,configurable:!0}),Vn.prototype.buildStateContext=function(){var e=this.frameContext.namespace,t=this.injector.get(L.AppContext,null).frameContextManager.getFrameContextsByNamespace(e),r={};if(t&&0<t.length){var i=t[0].getVirtualRootFrameContext();if(i){var n=i.viewModel.uiState;(Object.getOwnPropertyNames(n)||[]).forEach(function(e){null!==e.match(/^[a-zA-Z0-9_\$]+$/g)&&(r[e]=n[e])})}}return r},Vn.decorators=[{type:B.Injectable}],Vn.ctorParameters=function(){return[{type:B.Injector},{type:L.ResolveService},{type:L.FrameContext},{type:L.ExpressionExecutor}]},Vn);function Vn(e,t,r,i){this.injector=e,this.resolveService=t,this.frameContext=r,this.expressionExecutor=i}var _n=(kn.prototype.detectChanges=function(e){(e=!0===e||"true"===e)&&this.appRef?this.appRef.tick():this.cd&&this.cd.detectChanges()},kn.prototype.detectChangesAfter=function(e,t){var r=this;t=!0===t||"true"===t,isNaN(e)||(t&&this.appRef?window.setTimeout(function(){r.appRef.tick()},e):this.cd&&window.setTimeout(function(){r.cd.detectChanges()},e))},kn.decorators=[{type:B.Injectable}],kn.ctorParameters=function(){return[{type:B.Injector},{type:B.ChangeDetectorRef},{type:B.ApplicationRef}]},kn);function kn(e,t,r){this.injector=e,this.cd=t,this.appRef=r}var qn=(Un.prototype.confirm=function(){},Un.prototype.cancel=function(e,t){var r=this.frameContext.appContext.frameContextManager.getFrameContextById(e);if(!r)throw new Error("[PopUpService]Invalid frameId "+e);var i=this.frameContext.bindingData.list.currentId,n=r.viewModel.bindingPath,o=n.split("/").filter(function(e){return e});if(!t){var a=this.frameContext.bindingData.getList();t=a.currentId}var s=this.repository,c=L.DataPathCreator.createByShortPathFromRoot(o,s.entityManager,this.frameContext.bindingData).toArray().map(function(e){return e.split(":")[1]}),u=Array.from(c);u.pop();var l=this.frameContext.frameComponent.dialogRef;if(u.length<1){var p=this.repository.entityCollection.getEntityById(t),d=p.originalData;p.load(d,{loadChild:!1})}else{var f=s.entityManager.getEntityNodeByPath(u);if(f){var h=(d=f.originalData).find(function(e){return e.id===t});if(!h){var g=this.buildPath(n,i);return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(R.switchMap(function(e){return e?s.removeEntityByPath(g,t).pipe(R.tap(function(){s.entityManager.removeEntityByPath(g,t),0===f.count()&&l&&l.close()})):T.EMPTY}))}var v=s.entityManager.getEntityByPath(c);if(v.changes&&0<v.changes.length)return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(R.tap(function(e){e&&(v.load(h,{loadChild:!1}),v.changes.splice(0,v.changes.length))}));l&&l.close()}}return T.of([])},Un.prototype.updateCurrentRow=function(a){var s=this,c=this.frameContext.viewModel.bindingPath,e=c.split("/").filter(function(e){return e}),u=this.frameContext.appContext.frameContextManager.getRootFrameContext(),t=u.bindingData.list.currentId;if(this.frameContext.bindingData.list.setCurrentId(t),0<e.length){var l=[];e.forEach(function(e,t,r){l.push(e);var i=u.bindingData.getValue(l);if(i){var n=i.currentId,o=s.frameContext.bindingData.getValue(l);t===c.length-1&&a?o.setCurrentId(a):o&&o.setCurrentId(n)}})}},Un.prototype.closeCheck=function(){var e=this.frameContext.viewModel.bindingPath.split("/").filter(function(e){return e}),t=this.repository,r=L.DataPathCreator.createByShortPathFromRoot(e,t.entityManager,this.frameContext.bindingData).toArray().map(function(e){return e.split(":")[1]}),i=Array.from(r);i.pop();var n=t.entityManager.getEntityNodeByPath(i),o=this.frameContext.frameComponent.dialogRef;0===n.count()&&o&&o.close()},Un.prototype.buildPath=function(e,t){var r="/"+t,i=e.split("/");if(0<i.length)for(var n=1;n<i.length-1;n++){var o=i[n],a=this.frameContext.viewModel.bindingData[o];if(!a||!a.currentId)throw Error("获取子表完整路径出错，找不到"+a+"对应的子表，或对应子表没有当前行。");r+="/"+o+"/"+a.currentId}return r+="/"+i[i.length-1]},Un.decorators=[{type:B.Injectable}],Un.ctorParameters=function(){return[{type:B.Injector},{type:L.FrameContext},{type:L.Repository},{type:Y},{type:Pe}]},Un);function Un(e,t,r,i,n){this.injector=e,this.frameContext=t,this.repository=r,this.languageService=i,this.messageService=n}var Hn=(Wn.prototype.getIndex=function(t,r){return Array.isArray(t)?t.reduce(function(e,t){return e.concat(t)},[]).findIndex(function(e){return e.field===r}):"[object Object]"===Object.prototype.toString.call(t)?Object.keys(t).findIndex(function(e){return t[e].binding===r}):void 0},Wn.decorators=[{type:B.Injectable}],Wn.ctorParameters=function(){return[{type:B.Injector},{type:L.AppContext},{type:L.Repository}]},Wn);function Wn(e,t,r){this.injector=e,this.appContext=t,this.repository=r}var Kn=(zn.prototype.getGridColumns=function(e){var t=e&&e.viewModel&&e.viewModel.dataGridColumnsName||null;return t&&e.viewModel[t]||[]},zn.decorators=[{type:B.Injectable}],zn.ctorParameters=function(){return[]},zn);function zn(){}var Jn=(Yn.prototype.resetChildrenPagination=function(){var r=this.frameContext.repository.entityCollection.paginationInfo||{},i=this.frameContext.repository.entityTypeInfo.getPropNamesByGroup(L.DataPropGroup.List)||[];r&&0<Object.keys(r).length&&(Object.keys(r).forEach(function(t){var e=r[t];"[object Object]"===Object.prototype.toString.apply(e)&&(i.find(function(e){return e=e.slice(0,-1),t.startsWith(e+"_")})?delete r[t]:(r[t].pageIndex=1,delete r[t].total,delete r[t].pageCount))}),this.frameContext.repository.entityCollection.updatePaginationInfoByPath("/",r))},Yn.decorators=[{type:B.Injectable}],Yn.ctorParameters=function(){return[{type:B.Injector},{type:L.FrameContext}]},Yn);function Yn(e,t){this.injector=e,this.frameContext=t}var Gn=[ut,Jt,Zt,wt,Et,Ft,st,Rt,Nt,jt,Lt,_t,tr,Cr,Rr,pt,ir,Pr,Dr,xr,Ir,sn,Nr,jr,Lr,Ur,Wr,zr,ft,gt,$r,$e,Yr,Je,Ze,ke,ri,{provide:N.QUERYSOLUTION_HANDLER_TOKEN,useClass:rn},{provide:A.LISTFILTER_HANDLER_TOKEN,useClass:fn},on,O.BatchEditDialogService,un,pn,Sn,xn,Pn,D.FeatureEditorService,Nn,jn,Ln,qn,_n,Hn,Ht,qt,Kt,Kn,Jn,{provide:L.FORM_MANIFEST_SERVICE_TOKEN,useClass:gn},{provide:L.FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN,useClass:yn},{provide:L.MESSAGE_SERVICE_TOKEN,useClass:Pe},{provide:L.NOTIFY_SERVICE_TOKEN,useClass:De},{provide:L.FRAME_COMPONENT_INIT_HANDLER_TOKEN,useClass:gi,multi:!0}],$n=[{provide:"ValidationService",useClass:ut},{provide:"FocusInvalidService",useClass:Jt},{provide:"ChangeItemService",useClass:Zt},{provide:"UIStateService",useClass:wt},{provide:"StateMachineService",useClass:Et},{provide:"BindingDataService",useClass:Ft},{provide:"CommandService",useClass:st},{provide:"EntityTraversingService",useClass:Rt},{provide:"EntityManipulationService",useClass:Nt},{provide:"EntityAggregationService",useClass:jt},{provide:"EntityListService",useClass:Lt},{provide:"EntityService",useClass:_t},{provide:"ListDataService",useClass:tr},{provide:"TreeDataService",useClass:Cr},{provide:"SubTreeDataService",useClass:Rr},{provide:"CardDataService",useClass:pt},{provide:"SubListDataService",useClass:ir},{provide:"RemoveDataService",useClass:Pr},{provide:"SaveDataService",useClass:Dr},{provide:"EditDataService",useClass:xr},{provide:"FilterConditionDataService",useClass:Ir},{provide:"RemoteSummaryService",useClass:sn},{provide:"BeActionService",useClass:Nr},{provide:"ApproveService",useClass:jr},{provide:"PrintService",useClass:Lr},{provide:"AttachmentDataService",useClass:Ur},{provide:"AttachmentService",useClass:Wr},{provide:"FileService",useClass:zr},{provide:"NavigationMiddlewareService",useClass:ft},{provide:"GridMiddlewareService",useClass:gt},{provide:"SidebarService",useClass:$r},{provide:"FarrisFormService",useClass:$e},{provide:"DialogService",useClass:Yr},{provide:"NavigationEventService",useClass:Je},{provide:"NavigationService",useClass:Ze},{provide:"RouterService",useClass:ke},{provide:"AuthorityService",useClass:ri},{provide:N.QUERYSOLUTION_HANDLER_TOKEN,useClass:rn},{provide:A.LISTFILTER_HANDLER_TOKEN,useClass:fn},{provide:"EndEditService",useClass:on},{provide:"BatchEditDialogService",useClass:O.BatchEditDialogService},{provide:"BatchEditService",useClass:un},{provide:"DiscussionGroupService",useClass:pn},{provide:"LocalizationService",useClass:Sn},{provide:"DataGridService",useClass:xn},{provide:"FormAttentionService",useClass:Pn},{provide:L.FORM_MANIFEST_SERVICE_TOKEN,useClass:gn},{provide:L.FORM_EXPRESSION_MANIFEST_SERVICE_TOKEN,useClass:yn}],Qn=(Xn.decorators=[{type:B.NgModule,args:[{providers:wi,imports:[j.WfTaskHandlerModule],exports:[j.WfTaskHandlerModule]}]}],Xn.ctorParameters=function(){return[{type:fi}]},Xn);function Xn(e){this.workFlowMessage=e,this.workFlowMessage&&this.workFlowMessage.setup()}var Zn=(eo.prototype.sendMessage=function(e){return this.rtfService.subjectNotify(this.token,e),this},eo.prototype.listen=function(e){var t=this,r=L.UID.create();return this.rtfService.subjectResponse(this.token,e,r),function(){t.rtfService.responseUnSubscribe(t.token,r)}},eo.prototype.destory=function(){this.rtfService.subjectRemove(this.token)},eo);function eo(e,t){this.token=e,this.rtfService=t}var to=(ro.get=function(e){return new Zn(e,this.rtfService)},ro.create=function(e,t,r){var i=null;if(t){var n=this.querystringService.parse(window.location.hash);i={funcId:n.funcId,appId:n.appId,appEntrance:n.appEntrance}}var o=this.rtfService.subjectRegister(e,i,r);return o?new Zn(o,this.rtfService):null},ro.rtfService=new Ke,ro.querystringService=new He,ro);function ro(){}var io=(no.prototype.handle=function(e,t){var r=t&&t.isException||!1,i=t&&t.hasThrowError||!1,n=t&&t.eventBus||null,o=t&&t.error||null,a=t&&t.formAppContext||null,s=this.collect(e,r,i,n,o,a);s&&s.form&&0<s.form.length?s.form.forEach(function(e){e.frameContext.viewModel.form.updateFormErrors(e.message,!0,"backend")}):this.resetFormMessage(e.context.appContext,e.context.ns);var c=this.findTargetFrameContext(this.frameContext);s&&s.all&&0<s.all.length?c.viewModel.verifycationChanged.next(s.all):null!==s&&c.viewModel.verifycationChanged.next([])},no.prototype.collect=function(e,t,r,i,n,o){var a,s,y=this;void 0===t&&(t=!1),void 0===r&&(r=!1),void 0===i&&(i=null),void 0===n&&(n=null),void 0===o&&(o=null);var c=e&&e.bizMessages||null,p=e&&e.context.appContext,m=e.context.ns;if(!c||c.length<1)return null;var S={form:[],all:[]},C=!1,u=function(e){var t,r,h=e.message,i=e.location||null,a=i&&i.columns||null,n=i&&i.nodeCode||null,o=i&&i.rows,g=b.getBindingPath(p,m,n),v=g&&g.split("/").filter(function(e){return e});if(!i||!a||a.length<1||!n||!o||o.length<1)return"continue";var s=function(f){var e,t,r=function(d){var e=b.getFrameContextsByBindingPathAndColumnName(p,m,g,d);if(!e||e.length<1)return C=!0,"continue";e=e.filter(function(e){return!y.isDataGridComponent(e.frameComponent)||!y.isReadonlyDataGrid(e.frameComponent)}),b.isCurrentRow(p,m,g,f)&&e&&0<e.length&&e.forEach(function(i){var e=y.getFormControlByColumnName(i,d);e&&0<e.length&&e.forEach(function(e){var t=ee(e,2),r=t[0];t[1],y.mergeMessage(S.form,i,r,h)})}),e.forEach(function(e){var t=e.viewModel.form.formGroupName,r=y.getFormControlByColumnName(e,d);if(r&&0<r.length){var i=ee(r.find(function(e){var t=ee(e,2),r=t[0];return t[1],r&&0<r.length}),2),n=i[0],o=i[1],a=e.viewModel.bindingData.getValue(v),s=a.getIndexById(f),c=f+"_"+d+"_"+h;if(0<=s&&-1===S.all.findIndex(function(e){return e.id===c})){var u=a&&1<a.length?s+1:-1,l=y.buildItemTitle(t,o.name||o.defaultI18nValue||n,u),p={id:c,index:s,targetField:o.id,title:l,msg:h,namespace:m,bindingPath:g,type:"error"};S.all.push(p)}}})};try{for(var i=Z(a),n=i.next();!n.done;n=i.next())r(n.value)}catch(o){e={error:o}}finally{try{n&&!n.done&&(t=i["return"])&&t.call(i)}finally{if(e)throw e.error}}};try{for(var c=Z(o),u=c.next();!u.done;u=c.next())s(u.value)}catch(l){t={error:l}}finally{try{u&&!u.done&&(r=c["return"])&&r.call(c)}finally{if(t)throw t.error}}},b=this;try{for(var l=Z(c),d=l.next();!d.done;d=l.next())u(d.value)}catch(f){a={error:f}}finally{try{d&&!d.done&&(s=l["return"])&&s.call(l)}finally{if(a)throw a.error}}return C&&t&&!r&&i&&i.post("Exception","","onException",n,o),S},no.prototype.mergeMessage=function(e,t,r,i){var n,o,a=e.find(function(e){return e.frameContext.frameId===t.frameId});if(a){var s=a.message&&Object.keys(a.message).includes(r),c="backend-message-"+(Object.keys(a.message).length+1);s?a.message[r].errors[c]={name:i}:a.message[r]={errors:(n={},n[c]={name:i},n)}}else e.push({frameContext:t,message:(o={},o[r]={errors:{"backend-message-1":{name:i}}},o)})},no.prototype.buildItemTitle=function(e,t,r){var i={"zh-CHS":{viewModelName:"$viewModel",index:"第 $index 行",propertyName:"- $propertyName"},en:{viewModelName:"$viewModel",index:"row $index",propertyName:"- $propertyName"},"zh-CHT":{viewModelName:"$viewModel",index:"第 $index 行",propertyName:"- $propertyName"}},n=this.translate.getCurrentLanguage()||"zh-CHS",o=[];return e&&o.push(i[n].viewModelName.replace("$viewModel",e)),0<r&&o.push(i[n].index.replace("$index",r)),t&&o.push(i[n].propertyName.replace("$propertyName",t)),o.join(" ")},no.prototype.getBindingPath=function(e,t,r){return this.getFrameContext(e,t).repository.entityTypeInfo.getBindingPathByTableName(r)},no.prototype.getFrameContextsByBindingPathAndColumnName=function(e,o,a,s){var t=e.frameContextManager.getFrameContexts();return t&&0<t.length?t=t.filter(function(e){if(!(e.namespace===o&&e.viewModel.bindingPath===a&&e.viewModel.form&&e.viewModel.form.controls&&0<Object.keys(e.viewModel.form.controls).length))return!1;var t=a.split("/").filter(function(e){return e}),r=e.repository.entityTypeInfo.getTypeInfoByPath(t);if(r){var i=Array.from(r.propInfoMap.values()).find(function(e){return e.metadataInfo&&(e.metadataInfo.originalDataField===s||e.metadataInfo.dataField===s)});if(i){var n=i.name;return!!Object.values(e.viewModel.form.ngFormControls).find(function(e){return e.binding===n})||!!Object.keys(e.viewModel.form.ngFormControls).find(function(e){return e===n})}return!1}return!1}):null},no.prototype.isDataGridComponent=function(e){return!!e.context.viewModel.dataGridColumnsName},no.prototype.isReadonlyDataGrid=function(e){var t=e.context,r=t.viewModel.dataGridColumnsName||null;if(r)return t.viewModel[r].every(function(e){return e.every(function(e){return!e.editor})});throw new Error("传入的组件不是一个表格！")},no.prototype.isCurrentRow=function(e,t,r,i){var n=r.split("/").filter(function(e){return e});return this.getFrameContext(e,t).bindingData.getValue(n).currentItem.primaryKeyValue===i},no.prototype.getFrameContext=function(e,t){var r=e.frameContextManager.getFrameContexts();if(r&&0<r.length){var i=r.find(function(e){return e.namespace===t});if(i)return i.getVirtualRootFrameContext()}return null},no.prototype.getFormControlByColumnName=function(e,t){var r=e.viewModel.bindingPath.split("/").filter(function(e){return e}),i=e.repository.entityTypeInfo.getTypeInfoByPath(r),n=Array.from(i.propInfoMap.values()).find(function(e){return e.metadataInfo&&(e.metadataInfo.originalDataField===t||e.metadataInfo.dataField===t)});if(n){var o=n.name,a=Object.entries(e.viewModel.form.ngFormControls).filter(function(e){return e[1].binding===o||e[0]===o});if(a)return a}return null},no.prototype.resetFormMessage=function(e,t){e.frameContextManager.getFrameContexts().filter(function(e){return e.namespace===t}).forEach(function(e){return e&&e.viewModel&&e.viewModel.form&&e.viewModel.form.clearBackendError()})},no.prototype.findTargetFrameContext=function(e){var t=e.getVirtualRootFrameContext(),r=t.frameComponent;if(r&&r.isDialogRootComponent)return t;var i=t.parent;return i?this.findTargetFrameContext(i):t},no.decorators=[{type:B.Injectable}],no.ctorParameters=function(){return[{type:B.Injector},{type:L.FrameContext},{type:undefined,decorators:[{type:B.Inject,args:[L.TranslateToken]}]}]},no);function no(e,t,r){this.injector=e,this.frameContext=t,this.translate=r}e.ɵa=or,e.ɵc=fn,e.ɵb=rn,e.ɵd=bn,e.FormLoadingService=q,e.FormMessageService=Pe,e.HideEventService=_,e.FormNotifyService=De,e.FormErrorService=xe,e.FormWizardService=Te,e.CheckService=Oe,e.DataCheckService=Ae,e.EventService=Be,e.MenuStateService=Ve,e.RouterService=ke,e.LanguageService=Y,e.TAB_EVENT=Ue,e.TAB_QUERY_STRING={TabId:"tabId",AppType:"appType",AppId:"appId",AppEntrance:"appEntrance",FuncId:"funcId"},e.QuerystringService=He,e.RuntimeFrameworkService=Ke,e.NavigationEventService=Je,e.NavigationService=Ze,e.NavigationMiddlewareService=ft,e.GridMiddlewareService=gt,e.ParamService=yt,e.FilterConditionService=bt,e.FilterConditionDataService=Ir,e.UIStateService=wt,e.StateMachineService=Et,e.BindingDataService=Ft,e.CommandService=st,e.ValidationService=ut,e.FocusInvalidService=Jt,e.ApplicationParamService=Mt,e.ChangeItemService=Zt,e.EntityTraversingService=Rt,e.EntityManipulationService=Nt,e.EntityAggregationService=jt,e.EntityListService=Lt,e.EntityService=_t,e.ListDataService=tr,e.CardDataService=pt,e.SubListDataService=ir,e.TreeDataService=Cr,e.RemoveDataService=Pr,e.SaveDataService=Dr,e.EditDataService=xr,e.RemoteSummaryService=sn,e.SubTreeDataService=Rr,e.BeActionService=Nr,e.ApproveService=jr,e.PrintService=Lr,e.AttachmentDataService=Ur,e.AttachmentService=Wr,e.FileService=zr,e.DialogService=Yr,e.SidebarService=$r,e.FilterService=Xr,e.AuthorityService=ri,e.Authority=ni,e.FarrisFormService=$e,e.FARRIS_FORM_COMPONENTS=Ge,e.ExceptionHandler=ai,e.KeybindingService=St,e.FARRIS_COMMAND_SERVICE_PROVIDERS=ci,e.FARRIS_COMMAND_SERVICE_MODULE_PROVIDERS=wi,e.FARRIS_COMMAND_SERVICE_FRAME_PROVIDERS=Gn,e.DYNAMIC_FARRIS_COMMAND_SERVICE_PROVIDERS=$n,e.CommandServicesModule=Qn,e.ComponentManagerService=ei,e.MessagePipeService=to,e.MessagePipe=Zn,e.EndEditService=on,e.BatchEditService=un,e.DiscussionGroupService=pn,e.FormManifestService=gn,e.FormExpressionManifestService=yn,e.UserSettingsService=ui,e.LocalizationService=Sn,e.DataGridService=xn,e.BackEndMessageHandler=io,e.FormAttentionService=Pn,e.FormNotifyStrategyService=ot,e.FeatureDataService=Nn,e.FeatureEditService=jn,e.FeatureRepository=Rn,e.ExpressionService=Ln,e.PopUpService=qn,e.DirtyCheckingService=_n,e.WorkFlowMessage=fi,e.WorkFlowMessageService=pi,e.WorkFlowMessageHandler=gi,e.FormControlService=Ht,e.BindingPathService=qt,e.FrameContextService=Kt,e.ViewModelService=Kn,e.FormService=Hn,e.PaginationService=Jn,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=farris-command-services.umd.min.js.map