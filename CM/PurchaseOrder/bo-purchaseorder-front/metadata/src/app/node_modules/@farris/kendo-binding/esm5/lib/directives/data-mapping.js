import * as tslib_1 from "tslib";
import { isNumber } from 'lodash-es';
/**
 * 帮助映射基类
 */
var DataMapping = /** @class */ (function () {
    function DataMapping() {
    }
    /**
     *
     * @param helpData 清空时，值为null
     * @param mapFields 格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"}
     * @param asClear 类似清空
     */
    DataMapping.prototype.mappingData = function (helpData, mapFields, asClear) {
        if (asClear === void 0) { asClear = false; }
        if (!mapFields) {
            return;
        }
        // 关闭变更检测
        var appContext = this.vm.frameContext.appContext;
        appContext.changeDetectionController.detach();
        var helpFields = Object.keys(mapFields);
        var basePaths;
        // 映射到目标主键的源字段数组
        var primaryKeys;
        // 目标主键字段数组
        var primaryFields;
        basePaths = this.getBindingPathArray();
        var primaryInfo = this.getMapFieldsPrimaryKey(mapFields, basePaths);
        primaryKeys = primaryInfo && primaryInfo.map(function (item) { return item.primaryKey; }) || [];
        primaryFields = primaryInfo && primaryInfo.map(function (item) { return item.primaryField; }) || [];
        // 对映射中的key进行排序，使映射到目标主键的key排到前面
        helpFields = this.sortMapFieldKeys(helpFields, primaryKeys);
        if (!helpData || asClear) {
            helpFields.reverse();
        }
        this.mapping(helpFields, mapFields, helpData, primaryFields, basePaths, asClear);
        // 重新打开变更检测
        appContext.changeDetectionController.reattach();
    };
    DataMapping.prototype.mapping = function (sortedKeyFields, mapFields, helpData, targetPrimaryFields, basePaths, asClear) {
        var _this = this;
        if (asClear === void 0) { asClear = false; }
        sortedKeyFields.forEach(function (field) {
            var val = _this.getHelpValue(field, helpData);
            var mappings = mapFields[field].split(',');
            var headMappings = mappings.filter(function (p) { return targetPrimaryFields.includes(p); });
            var leftMappings = mappings.filter(function (p) { return !targetPrimaryFields.includes(p); });
            if (!helpData || asClear) {
                mappings = [].concat(leftMappings).concat(headMappings);
            }
            else {
                mappings = [].concat(headMappings).concat(leftMappings);
            }
            _this.updateTarget(mappings, basePaths, helpData, val);
        });
    };
    DataMapping.prototype.updateTarget = function (mappings, basePaths, helpData, value) {
        var _this = this;
        mappings.forEach(function (targetFieldPath) {
            _this.updateTargetValue(basePaths, targetFieldPath, value, helpData);
        });
    };
    DataMapping.prototype.updateTargetValue = function (basePaths, targetFieldPath, value, helpData) {
        if (this.target) {
            var paths = targetFieldPath.split('.');
            this.setValue(this.target, paths, value);
        }
        else {
            var paths = basePaths.concat(targetFieldPath.split('.'));
            if (!helpData) {
                this.vm.bindingData.clearValue(paths, true, true, { frameContext: this.vm.frameContext });
            }
            else {
                this.vm.bindingData.setValue(paths, value, true, true, null, { frameContext: this.vm.frameContext });
            }
        }
    };
    /**
     * 获取帮助字段对应的值
     * @param field 帮助字段
     * @param helpData 帮助数据
     * @returns
     */
    DataMapping.prototype.getHelpValue = function (field, helpData) {
        var _this = this;
        var value = '';
        if (helpData) {
            if (helpData instanceof Array) {
                value = helpData.map(function (item) {
                    return _this.getValue(field, item);
                }).join(',');
            }
            else {
                value = this.getValue(field, helpData);
            }
        }
        return value;
    };
    DataMapping.prototype.getValue = function (f, data) {
        var val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce(function (a, b) {
                return a[b];
            }, data);
        }
        return val;
    };
    DataMapping.prototype.setValue = function (target, paths, value) {
        if (target) {
            if (paths.length <= 1) {
                target[paths[0]] = value;
            }
            else {
                paths.slice(0, -1).reduce(function (prev, path) {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    };
    DataMapping.prototype.getBindingPathArray = function () {
        var path = this.vm.bindingPath;
        if (path) {
            return path.split('/').filter(function (n) { return n !== ''; });
        }
        return [];
    };
    DataMapping.prototype.isNumberValue = function (field, data) {
        var currentVal = this.getValue(field, data);
        return isNumber(currentVal);
    };
    /**
     *
     * @param mapFields  格式形如：{id: "assoField.assoField", code: "assoField.assoField_Code", name: "assoField.assoField_Name"} 或者 {id:'vid',code:'code',name:'name'}
     */
    DataMapping.prototype.getMapFieldsPrimaryKey = function (mapFields, bindingPaths) {
        if (!mapFields || Object.keys(mapFields).length < 1) {
            return null;
        }
        var results = [];
        // let primaryField = null;
        try {
            var entityTypeInfo_1 = this.vm.frameContext.repository.entityTypeInfo;
            Object.keys(mapFields).forEach(function (key) {
                var mapField = mapFields[key];
                if (mapField && typeof mapField === 'string') {
                    var mappings = mapField.split(',').filter(function (p) { return p; });
                    mappings.forEach(function (item) {
                        var paths = item.split('.');
                        if (bindingPaths && bindingPaths.length > 0) {
                            paths = bindingPaths.concat(paths);
                        }
                        var propInfo = entityTypeInfo_1.getPropInfoByPath(paths);
                        if (propInfo && propInfo.metadataInfo && propInfo.metadataInfo.primary === true) {
                            results.push({
                                primaryKey: key,
                                primaryField: item
                            });
                        }
                    });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
        return results;
    };
    DataMapping.prototype.sortMapFieldKeys = function (keys, primaryKeys) {
        if (!primaryKeys || primaryKeys.length < 1 || !keys || keys.length < 1) {
            return keys;
        }
        primaryKeys = tslib_1.__spread(new Set(primaryKeys));
        // 过滤出非主键映射字段
        keys = keys.filter(function (p) { return !primaryKeys.includes(p); });
        return [].concat(primaryKeys).concat(keys);
    };
    return DataMapping;
}());
export { DataMapping };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1tYXBwaW5nLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9rZW5kby1iaW5kaW5nLyIsInNvdXJjZXMiOlsibGliL2RpcmVjdGl2ZXMvZGF0YS1tYXBwaW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3JDOztHQUVHO0FBQ0g7SUFBQTtJQXlLQSxDQUFDO0lBdEtDOzs7OztPQUtHO0lBQ0gsaUNBQVcsR0FBWCxVQUFZLFFBQWEsRUFBRSxTQUFjLEVBQUUsT0FBd0I7UUFBeEIsd0JBQUEsRUFBQSxlQUF3QjtRQUNqRSxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ2QsT0FBTztTQUNSO1FBQ0QsU0FBUztRQUNULElBQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQztRQUNuRCxVQUFVLENBQUMseUJBQXlCLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDOUMsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN4QyxJQUFJLFNBQWdCLENBQUM7UUFDckIsZ0JBQWdCO1FBQ2hCLElBQUksV0FBcUIsQ0FBQztRQUMxQixXQUFXO1FBQ1gsSUFBSSxhQUF1QixDQUFDO1FBQzVCLFNBQVMsR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUN2QyxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3RFLFdBQVcsR0FBRyxXQUFXLElBQUksV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxVQUFVLEVBQWYsQ0FBZSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzVFLGFBQWEsR0FBRyxXQUFXLElBQUksV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUks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bmdPYmplY3QsIERhdGFQcm9wSW5mbywgRGF0YVR5cGVJbmZvLCBWaWV3TW9kZWwgfSBmcm9tIFwiQGZhcnJpcy9kZXZraXRcIjtcclxuaW1wb3J0IHsgaXNOdW1iZXIgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG4vKipcclxuICog5biu5Yqp5pig5bCE5Z+657G7XHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgRGF0YU1hcHBpbmcge1xyXG4gIHB1YmxpYyB2bTogVmlld01vZGVsOyBcclxuICBwdWJsaWMgdGFyZ2V0OiBCaW5kaW5nT2JqZWN0O1xyXG4gIC8qKlxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBoZWxwRGF0YSDmuIXnqbrml7bvvIzlgLzkuLpudWxsXHJcbiAgICogQHBhcmFtIG1hcEZpZWxkcyDmoLzlvI/lvaLlpoLvvJp7aWQ6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZFwiLCBjb2RlOiBcImFzc29GaWVsZC5hc3NvRmllbGRfQ29kZVwiLCBuYW1lOiBcImFzc29GaWVsZC5hc3NvRmllbGRfTmFtZVwifVxyXG4gICAqIEBwYXJhbSBhc0NsZWFyIOexu+S8vOa4heepulxyXG4gICAqL1xyXG4gIG1hcHBpbmdEYXRhKGhlbHBEYXRhOiBhbnksIG1hcEZpZWxkczogYW55LCBhc0NsZWFyOiBib29sZWFuID0gZmFsc2UpIHtcclxuICAgIGlmICghbWFwRmllbGRzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIC8vIOWFs+mXreWPmOabtOajgOa1i1xyXG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudm0uZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XHJcbiAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIuZGV0YWNoKCk7XHJcbiAgICBsZXQgaGVscEZpZWxkcyA9IE9iamVjdC5rZXlzKG1hcEZpZWxkcyk7XHJcbiAgICBsZXQgYmFzZVBhdGhzOiBhbnlbXTtcclxuICAgIC8vIOaYoOWwhOWIsOebruagh+S4u+mUrueahOa6kOWtl+auteaVsOe7hFxyXG4gICAgbGV0IHByaW1hcnlLZXlzOiBzdHJpbmdbXTtcclxuICAgIC8vIOebruagh+S4u+mUruWtl+auteaVsOe7hFxyXG4gICAgbGV0IHByaW1hcnlGaWVsZHM6IHN0cmluZ1tdO1xyXG4gICAgYmFzZVBhdGhzID0gdGhpcy5nZXRCaW5kaW5nUGF0aEFycmF5KCk7XHJcbiAgICBjb25zdCBwcmltYXJ5SW5mbyA9IHRoaXMuZ2V0TWFwRmllbGRzUHJpbWFyeUtleShtYXBGaWVsZHMsIGJhc2VQYXRocyk7XHJcbiAgICBwcmltYXJ5S2V5cyA9IHByaW1hcnlJbmZvICYmIHByaW1hcnlJbmZvLm1hcChpdGVtID0+IGl0ZW0ucHJpbWFyeUtleSkgfHwgW107XHJcbiAgICBwcmltYXJ5RmllbGRzID0gcHJpbWFyeUluZm8gJiYgcHJpbWFyeUluZm8ubWFwKGl0ZW0gPT4gaXRlbS5wcmltYXJ5RmllbGQpIHx8IFtdO1xyXG4gICAgLy8g5a+55pig5bCE5Lit55qEa2V56L+b6KGM5o6S5bqP77yM5L2/5pig5bCE5Yiw55uu5qCH5Li76ZSu55qEa2V55o6S5Yiw5YmN6Z2iXHJcbiAgICBoZWxwRmllbGRzID0gdGhpcy5zb3J0TWFwRmllbGRLZXlzKGhlbHBGaWVsZHMsIHByaW1hcnlLZXlzKTtcclxuICAgIGlmICghaGVscERhdGEgfHwgYXNDbGVhcikge1xyXG4gICAgICBoZWxwRmllbGRzLnJldmVyc2UoKTtcclxuICAgIH1cclxuICAgIHRoaXMubWFwcGluZyhoZWxwRmllbGRzLCBtYXBGaWVsZHMsIGhlbHBEYXRhLCBwcmltYXJ5RmllbGRzLCBiYXNlUGF0aHMsIGFzQ2xlYXIpO1xyXG4gICAgLy8g6YeN5paw5omT5byA5Y+Y5pu05qOA5rWLXHJcbiAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcclxuICB9XHJcbiAgcHJpdmF0ZSBtYXBwaW5nKHNvcnRlZEtleUZpZWxkczogc3RyaW5nW10sIG1hcEZpZWxkczogYW55LCBoZWxwRGF0YTogYW55LCB0YXJnZXRQcmltYXJ5RmllbGRzOiBzdHJpbmdbXSwgYmFzZVBhdGhzOiBzdHJpbmdbXSwgYXNDbGVhcjogYm9vbGVhbiA9IGZhbHNlKSB7XHJcbiAgICBzb3J0ZWRLZXlGaWVsZHMuZm9yRWFjaCgoZmllbGQ6IGFueSkgPT4ge1xyXG4gICAgICBjb25zdCB2YWwgPSB0aGlzLmdldEhlbHBWYWx1ZShmaWVsZCwgaGVscERhdGEpO1xyXG4gICAgICBsZXQgbWFwcGluZ3M6IGFueVtdID0gbWFwRmllbGRzW2ZpZWxkXS5zcGxpdCgnLCcpO1xyXG4gICAgICBjb25zdCBoZWFkTWFwcGluZ3MgPSBtYXBwaW5ncy5maWx0ZXIocCA9PiB0YXJnZXRQcmltYXJ5RmllbGRzLmluY2x1ZGVzKHApKTtcclxuICAgICAgY29uc3QgbGVmdE1hcHBpbmdzID0gbWFwcGluZ3MuZmlsdGVyKHAgPT4gIXRhcmdldFByaW1hcnlGaWVsZHMuaW5jbHVkZXMocCkpO1xyXG4gICAgICBpZiAoIWhlbHBEYXRhIHx8IGFzQ2xlYXIpIHtcclxuICAgICAgICBtYXBwaW5ncyA9IFtdLmNvbmNhdChsZWZ0TWFwcGluZ3MpLmNvbmNhdChoZWFkTWFwcGluZ3MpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1hcHBpbmdzID0gW10uY29uY2F0KGhlYWRNYXBwaW5ncykuY29uY2F0KGxlZnRNYXBwaW5ncyk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy51cGRhdGVUYXJnZXQobWFwcGluZ3MsIGJhc2VQYXRocywgaGVscERhdGEsIHZhbCk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSB1cGRhdGVUYXJnZXQobWFwcGluZ3M6IHN0cmluZ1tdLCBiYXNlUGF0aHM6IHN0cmluZ1tdLCBoZWxwRGF0YTogYW55LCB2YWx1ZTogYW55KSB7XHJcbiAgICBtYXBwaW5ncy5mb3JFYWNoKCh0YXJnZXRGaWVsZFBhdGg6IGFueSkgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZVRhcmdldFZhbHVlKGJhc2VQYXRocywgdGFyZ2V0RmllbGRQYXRoLCB2YWx1ZSwgaGVscERhdGEpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgdXBkYXRlVGFyZ2V0VmFsdWUoYmFzZVBhdGhzOiBzdHJpbmdbXSwgdGFyZ2V0RmllbGRQYXRoLCB2YWx1ZTogYW55LCBoZWxwRGF0YTogYW55KSB7XHJcbiAgICBpZiAodGhpcy50YXJnZXQpIHtcclxuICAgICAgY29uc3QgcGF0aHMgPSB0YXJnZXRGaWVsZFBhdGguc3BsaXQoJy4nKTtcclxuICAgICAgdGhpcy5zZXRWYWx1ZSh0aGlzLnRhcmdldCwgcGF0aHMsIHZhbHVlKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IHBhdGhzID0gYmFzZVBhdGhzLmNvbmNhdCh0YXJnZXRGaWVsZFBhdGguc3BsaXQoJy4nKSk7XHJcbiAgICAgIGlmICghaGVscERhdGEpIHtcclxuICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLmNsZWFyVmFsdWUocGF0aHMsIHRydWUsIHRydWUsIHsgZnJhbWVDb250ZXh0OiB0aGlzLnZtLmZyYW1lQ29udGV4dCB9KTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLnZtLmJpbmRpbmdEYXRhLnNldFZhbHVlKHBhdGhzLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSwgbnVsbCwgeyBmcmFtZUNvbnRleHQ6IHRoaXMudm0uZnJhbWVDb250ZXh0IH0pO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluW4ruWKqeWtl+auteWvueW6lOeahOWAvFxyXG4gICAqIEBwYXJhbSBmaWVsZCDluK7liqnlrZfmrrVcclxuICAgKiBAcGFyYW0gaGVscERhdGEg5biu5Yqp5pWw5o2uXHJcbiAgICogQHJldHVybnMgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRIZWxwVmFsdWUoZmllbGQ6IHN0cmluZywgaGVscERhdGE6IGFueSkge1xyXG4gICAgbGV0IHZhbHVlOiBhbnkgPSAnJztcclxuICAgIGlmIChoZWxwRGF0YSkge1xyXG4gICAgICBpZiAoaGVscERhdGEgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgIHZhbHVlID0gaGVscERhdGEubWFwKChpdGVtOiBhbnkpID0+IHtcclxuICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGZpZWxkLCBpdGVtKTtcclxuICAgICAgICB9KS5qb2luKCcsJyk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdmFsdWUgPSB0aGlzLmdldFZhbHVlKGZpZWxkLCBoZWxwRGF0YSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiB2YWx1ZTtcclxuICB9XHJcbiAgcHJvdGVjdGVkIGdldFZhbHVlKGY6IHN0cmluZywgZGF0YTogYW55KSB7XHJcbiAgICBsZXQgdmFsID0gJyc7XHJcbiAgICBpZiAoZi5pbmRleE9mKCcuJykgPT09IC0xKSB7XHJcbiAgICAgIHZhbCA9IGRhdGFbZl07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB2YWwgPSBmLnNwbGl0KCcuJykucmVkdWNlKChhLCBiKSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIGFbYl07XHJcbiAgICAgIH0sIGRhdGEpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB2YWw7XHJcbiAgfVxyXG4gIHByb3RlY3RlZCBzZXRWYWx1ZSh0YXJnZXQ6IG9iamVjdCwgcGF0aHM6IHN0cmluZ1tdLCB2YWx1ZTogYW55KSB7XHJcbiAgICBpZiAodGFyZ2V0KSB7XHJcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPD0gMSkge1xyXG4gICAgICAgIHRhcmdldFtwYXRoc1swXV0gPSB2YWx1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBwYXRocy5zbGljZSgwLCAtMSkucmVkdWNlKChwcmV2LCBwYXRoKSA9PiB7XHJcbiAgICAgICAgICBpZiAoIShwcmV2Lmhhc093blByb3BlcnR5KHBhdGgpIHx8IHByZXZbJ19fcHJvdG9fXyddLmhhc093blByb3BlcnR5KHBhdGgpKSkge1xyXG4gICAgICAgICAgICBwcmV2W3BhdGhdID0ge307XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gcHJldltwYXRoXTtcclxuICAgICAgICB9LCB0YXJnZXQpW3BhdGhzW3BhdGhzLmxlbmd0aCAtIDFdXSA9IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG4gIHByaXZhdGUgZ2V0QmluZGluZ1BhdGhBcnJheSgpOiBhbnlbXSB7XHJcbiAgICBjb25zdCBwYXRoID0gdGhpcy52bS5iaW5kaW5nUGF0aDtcclxuICAgIGlmIChwYXRoKSB7XHJcbiAgICAgIHJldHVybiBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKG4gPT4gbiAhPT0gJycpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFtdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc051bWJlclZhbHVlKGZpZWxkLCBkYXRhKSB7XHJcbiAgICBjb25zdCBjdXJyZW50VmFsID0gdGhpcy5nZXRWYWx1ZShmaWVsZCwgZGF0YSk7XHJcbiAgICByZXR1cm4gaXNOdW1iZXIoY3VycmVudFZhbCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIFxyXG4gICAqIEBwYXJhbSBtYXBGaWVsZHMgIOagvOW8j+W9ouWmgu+8mntpZDogXCJhc3NvRmllbGQuYXNzb0ZpZWxkXCIsIGNvZGU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9Db2RlXCIsIG5hbWU6IFwiYXNzb0ZpZWxkLmFzc29GaWVsZF9OYW1lXCJ9IOaIluiAhSB7aWQ6J3ZpZCcsY29kZTonY29kZScsbmFtZTonbmFtZSd9XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBnZXRNYXBGaWVsZHNQcmltYXJ5S2V5KG1hcEZpZWxkczogYW55LCBiaW5kaW5nUGF0aHM6IHN0cmluZ1tdKTogQXJyYXk8eyBwcmltYXJ5S2V5OiBzdHJpbmcsIHByaW1hcnlGaWVsZDogc3RyaW5nIH0+IHtcclxuICAgIGlmICghbWFwRmllbGRzIHx8IE9iamVjdC5rZXlzKG1hcEZpZWxkcykubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHJlc3VsdHMgPSBbXTtcclxuICAgIC8vIGxldCBwcmltYXJ5RmllbGQgPSBudWxsO1xyXG4gICAgdHJ5IHtcclxuICAgICAgY29uc3QgZW50aXR5VHlwZUluZm86IERhdGFUeXBlSW5mbyA9IHRoaXMudm0uZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm87XHJcbiAgICAgIE9iamVjdC5rZXlzKG1hcEZpZWxkcykuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICBjb25zdCBtYXBGaWVsZCA9IG1hcEZpZWxkc1trZXldO1xyXG4gICAgICAgIGlmIChtYXBGaWVsZCAmJiB0eXBlb2YgbWFwRmllbGQgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICBjb25zdCBtYXBwaW5ncyA9IG1hcEZpZWxkLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XHJcbiAgICAgICAgICBtYXBwaW5ncy5mb3JFYWNoKChpdGVtOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgbGV0IHBhdGhzID0gaXRlbS5zcGxpdCgnLicpO1xyXG4gICAgICAgICAgICBpZiAoYmluZGluZ1BhdGhzICYmIGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgcGF0aHMgPSBiaW5kaW5nUGF0aHMuY29uY2F0KHBhdGhzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBwcm9wSW5mbzogRGF0YVByb3BJbmZvID0gZW50aXR5VHlwZUluZm8uZ2V0UHJvcEluZm9CeVBhdGgocGF0aHMpO1xyXG4gICAgICAgICAgICBpZiAocHJvcEluZm8gJiYgcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIHByb3BJbmZvLm1ldGFkYXRhSW5mby5wcmltYXJ5ID09PSB0cnVlKSB7XHJcbiAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHByaW1hcnlLZXk6IGtleSxcclxuICAgICAgICAgICAgICAgIHByaW1hcnlGaWVsZDogaXRlbVxyXG4gICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdHM7XHJcbiAgfVxyXG4gIHByaXZhdGUgc29ydE1hcEZpZWxkS2V5cyhrZXlzOiBzdHJpbmdbXSwgcHJpbWFyeUtleXM6IHN0cmluZ1tdKTogc3RyaW5nW10ge1xyXG4gICAgaWYgKCFwcmltYXJ5S2V5cyB8fCBwcmltYXJ5S2V5cy5sZW5ndGggPCAxIHx8ICFrZXlzIHx8IGtleXMubGVuZ3RoIDwgMSkge1xyXG4gICAgICByZXR1cm4ga2V5cztcclxuICAgIH1cclxuICAgIHByaW1hcnlLZXlzID0gWy4uLm5ldyBTZXQocHJpbWFyeUtleXMpXTtcclxuICAgIC8vIOi/h+a7pOWHuumdnuS4u+mUruaYoOWwhOWtl+autVxyXG4gICAga2V5cyA9IGtleXMuZmlsdGVyKHAgPT4gIXByaW1hcnlLZXlzLmluY2x1ZGVzKHApKTtcclxuICAgIHJldHVybiBbXS5jb25jYXQocHJpbWFyeUtleXMpLmNvbmNhdChrZXlzKTtcclxuICB9XHJcbn0iXX0=