import { MetadataUtil } from '../../metadata/index';
import { NG_FIELD, NG_OBJECT, NG_Dynamic, NG_LIST } from './field_decorator';
// import { Cacheable, DefaultCacheProvider } from '../../cache';
/**
 * 属性注解器通用方法
 */
var FieldMetadataUtil = /** @class */ (function () {
    function FieldMetadataUtil() {
    }
    /**
     * 获取实体所有的简单属性元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    //@Cacheable({ key: ((context: any, args: any[]) => args[0]), provider: new DefaultCacheProvider() })
    FieldMetadataUtil.getNgFields = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_FIELD);
    };
    /**
     * 获取某个简单属性的元数据
     */
    FieldMetadataUtil.getNgField = function (target, propName) {
        var ngFields = this.getNgFields(target);
        var ngField = ngFields[propName];
        return ngField;
    };
    /**
     * 获取实体属性在原始数据中的属性名
     */
    FieldMetadataUtil.getDataField = function (target, propName) {
        var ngField = this.getNgField(target, propName);
        return ngField.dataField || propName;
    };
    /**
     * 获取标注为NgObject的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgObjectProperty}
     */
    //@Cacheable({ key: ((context: any, args: any[]) => args[0]), provider: new DefaultCacheProvider() })
    FieldMetadataUtil.getNgObjects = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_OBJECT);
    };
    FieldMetadataUtil.getNgDynamic = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_Dynamic);
    };
    /**
     * 获取标注为NgList的属性的元数据
     * @param target 实体类型
     * @returns 形如：{[propName: string]: NgListProperty}
     */
    //@Cacheable({ key: ((context: any, args: any[]) => args[0]), provider: new DefaultCacheProvider() })
    FieldMetadataUtil.getNgList = function (target) {
        return MetadataUtil.getPropsMetadatasByName(target, NG_LIST);
    };
    /**
     * 获取实体标注为主键的属性元数据
     * @param target 实体类型
     */
    //@Cacheable({ key: ((context: any, args: any[]) => args[0]), provider: new DefaultCacheProvider() })
    FieldMetadataUtil.getPrimaryFieldMetadata = function (target) {
        var ngFieldObj = FieldMetadataUtil.getNgFields(target);
        var primaryKey = Object.keys(ngFieldObj).find(function (prop) {
            return ngFieldObj[prop].primary;
        });
        if (primaryKey) {
            var propMeta = ngFieldObj[primaryKey];
            propMeta.property = primaryKey;
            if (!propMeta.dataField) {
                propMeta.dataField = primaryKey;
            }
            return propMeta;
        }
        return undefined;
    };
    /**
     * 获取主键名称，没有主键时返回空字符串
     */
    //@Cacheable({ key: ((context: any, args: any[]) => args[0]), provider: new DefaultCacheProvider() })
    FieldMetadataUtil.getPrimaryKey = function (entityType) {
        var primaryNgField = this.getPrimaryFieldMetadata(entityType);
        if (!primaryNgField) {
            return '';
        }
        return primaryNgField.property;
    };
    // static udtMap = {};
    /**
     * 获取NgField 的验证规则元数据
     * @param target 实体类Type
     */
    //@Cacheable({ key: ((context: any, args: any[]) => args[0]), provider: new DefaultCacheProvider() })
    FieldMetadataUtil.getValidationMetadata = function (target) {
        var fieldMetadatas = FieldMetadataUtil.getNgFields(target);
        // this.udtMap = Object.assign(this.udtMap || {}, FieldMetadataUtil.getNgObjects(target) || {});
        // let udtParentName = '';
        // Object.keys(this.udtMap).forEach(key => {
        //   // 当前实体是udt类型时
        //   if (this.udtMap[key].type.name === target.name) {
        //     // 找出当前udt实体的父级信息
        //     udtParentName = key;
        //   }
        // });
        var metadatas = {};
        // let primaryId = '';
        // let udtPrimaryId = '';
        // 不进行验证的属性名
        // const excludeIDs = [];
        // 排除udt的主键
        // Object.keys(fieldMetadatas).forEach(key => {
        //   if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
        //     primaryId = fieldMetadatas[key].dataField;
        //     udtPrimaryId = fieldMetadatas[key].dataField + '_ID';
        //     excludeIDs.push(fieldMetadatas[key].dataField);
        //   }
        // });
        Object.keys(fieldMetadatas).forEach(function (key) {
            if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
                return;
            }
            var validRules = fieldMetadatas[key].validRules;
            // if (excludeIDs.indexOf(key) > -1) {
            //   return;
            // }
            if (validRules && validRules.length) {
                validRules.map(function (rule) {
                    rule.property = key;
                    rule['targetName'] = target.name;
                });
                metadatas[key] = validRules;
            }
        });
        return metadatas;
    };
    //@Cacheable({ key: ((context: any, args: any[]) => args[0]), provider: new DefaultCacheProvider() })
    FieldMetadataUtil.getValidationMetadataWithPath = function (object) {
        var target = object.constructor;
        var fieldMetadatas = FieldMetadataUtil.getNgFields(target);
        var parentPaths = object.getPaths().path || [];
        var metadatas = {};
        Object.keys(fieldMetadatas).forEach(function (key) {
            if (fieldMetadatas[key].primary || fieldMetadatas[key].foreign) {
                return;
            }
            var validRules = fieldMetadatas[key].validRules;
            if (validRules && validRules.length) {
                var propertyPath = parentPaths.concat([]);
                propertyPath.push(key);
                var property_1 = propertyPath.join('.');
                validRules.map(function (rule) {
                    rule.property = key;
                    rule['targetName'] = target.name;
                    rule['path'] = property_1;
                });
                metadatas[key] = validRules;
            }
        });
        return metadatas;
    };
    return FieldMetadataUtil;
}());
export { FieldMetadataUtil };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRfbWV0YWRhdGFfdXRpbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9tZXRhZGF0YS9maWVsZF9tZXRhZGF0YV91dGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNwRCxPQUFPLEVBQ0wsUUFBUSxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUN6QyxNQUFNLG1CQUFtQixDQUFDO0FBRTNCLGlFQUFpRTtBQUVqRTs7R0FFRztBQUNIO0lBQUE7SUFtS0EsQ0FBQztJQWxLQzs7OztPQUlHO0lBQ0gscUdBQXFHO0lBQzlGLDZCQUFXLEdBQWxCLFVBQW1CLE1BQVc7UUFDNUIsT0FBTyxZQUFZLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRDs7T0FFRztJQUNJLDRCQUFVLEdBQWpCLFVBQWtCLE1BQVcsRUFBRSxRQUFnQjtRQUM3QyxJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFDLElBQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQW9CLENBQUM7UUFDdEQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksOEJBQVksR0FBbkIsVUFBb0IsTUFBVyxFQUFFLFFBQWdCO1FBQy9DLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sT0FBTyxDQUFDLFNBQVMsSUFBSSxRQUFRLENBQUM7SUFDdkMsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxxR0FBcUc7SUFDOUYsOEJBQVksR0FBbkIsVUFBb0IsTUFBVztRQUM3QixPQUFPLFlBQVksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVNLDhCQUFZLEdBQW5CLFVBQW9CLE1BQVc7UUFDN0IsT0FBTyxZQUFZLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gscUdBQXFHO0lBQzlGLDJCQUFTLEdBQWhCLFVBQWlCLE1BQVc7UUFDMUIsT0FBTyxZQUFZLENBQUMsdUJBQXVCLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFRDs7O09BR0c7SUFDSCxxR0FBcUc7SUFDOUYseUNBQXVCLEdBQTlCLFVBQStCLE1BQVc7UUFDeEMsSUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pELElBQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsSUFBWTtZQUMzRCxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUM7UUFDbEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLFVBQVUsRUFBRTtZQUNkLElBQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN4QyxRQUFRLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztZQUMvQixJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTtnQkFDdkIsUUFBUSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUM7YUFDakM7WUFFRCxPQUFPLFFBQVEsQ0FBQztTQUNqQjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFRDs7T0FFRztJQUNILHFHQUFxRztJQUM5RiwrQkFBYSxHQUFwQixVQUFxQixVQUFlO1FBQ2xDLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxPQUFPLGNBQWMsQ0FBQyxRQUFRLENBQUM7SUFDakMsQ0FBQztJQUVELHNCQUFzQjtJQUV0Qjs7O09BR0c7SUFDSCxxR0FBcUc7SUFDOUYsdUNBQXFCLEdBQTVCLFVBQTZCLE1BQVc7UUFDdEMsSUFBTSxjQUFjLEdBQUcsaUJBQWlCLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzdELGdHQUFnRztRQUNoRywwQkFBMEI7UUFDMUIsNENBQTRDO1FBQzVDLG1CQUFtQjtRQUNuQixzREFBc0Q7UUFDdEQsd0JBQXdCO1FBQ3hCLDJCQUEyQjtRQUMzQixNQUFNO1FBQ04sTUFBTTtRQUNOLElBQU0sU0FBUyxHQUFzQyxFQUFFLENBQUM7UUFDeEQsc0JBQXNCO1FBQ3RCLHlCQUF5QjtRQUN6QixZQUFZO1FBQ1oseUJBQXlCO1FBQ3pCLFdBQVc7UUFDWCwrQ0FBK0M7UUFDL0Msc0VBQXNFO1FBQ3RFLGlEQUFpRDtRQUNqRCw0REFBNEQ7UUFDNUQsc0RBQXNEO1FBQ3RELE1BQU07UUFDTixNQUFNO1FBQ04sTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHO1lBQ3JDLElBQUksY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sSUFBSSxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFO2dCQUM5RCxPQUFPO2FBQ1I7WUFDRCxJQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDO1lBQ2xELHNDQUFzQztZQUN0QyxZQUFZO1lBQ1osSUFBSTtZQUNKLElBQUksVUFBVSxJQUFJLFVBQVUsQ0FBQyxNQUFNLEVBQUU7Z0JBQ25DLFVBQVUsQ0FBQyxHQUFHLENBQUMsVUFBQSxJQUFJO29CQUNqQixJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQztvQkFDcEIsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7Z0JBQ25DLENBQUMsQ0FBQyxDQUFDO2dCQUNILFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUM7YUFDN0I7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFDRCxxR0FBcUc7SUFDOUYsK0NBQTZCLEdBQXBDLFVBQXFDLE1BQVc7UUFDOUMsSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztRQUNsQyxJQUFNLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDN0QsSUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUM7UUFDakQsSUFBTSxTQUFTLEdBQXNDLEVBQUUsQ0FBQztRQUV4RCxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFBLEdBQUc7WUFDckMsSUFBSSxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxJQUFJLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUU7Z0JBQzlELE9BQU87YUFDUjtZQUNELElBQU0sVUFBVSxHQUFHLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUM7WUFFbEQsSUFBSSxVQUFVLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtnQkFDbkMsSUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDNUMsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDdkIsSUFBTSxVQUFRLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDeEMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxVQUFBLElBQUk7b0JBQ2pCLElBQUksQ0FBQyxRQUFRLEdBQUcsR0FBRyxDQUFDO29CQUNwQixJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztvQkFDakMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLFVBQVEsQ0FBQztnQkFDMUIsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLFVBQVUsQ0FBQzthQUM3QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUNILHdCQUFDO0FBQUQsQ0FBQyxBQW5LRCxJQW1LQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uLy4uL21ldGFkYXRhL2luZGV4JztcclxuaW1wb3J0IHtcclxuICBOR19GSUVMRCwgTkdfT0JKRUNULCBOR19EeW5hbWljLCBOR19MSVNULCBOZ0ZpZWxkUHJvcGVydHksIE5nT2JqZWN0UHJvcGVydHksIE5nTGlzdFByb3BlcnR5XHJcbn0gZnJvbSAnLi9maWVsZF9kZWNvcmF0b3InO1xyXG5pbXBvcnQgeyBWYWxpZGF0ZVJ1bGUgfSBmcm9tICcuLi92YWxpZGF0b3IvdHlwZXMnO1xyXG4vLyBpbXBvcnQgeyBDYWNoZWFibGUsIERlZmF1bHRDYWNoZVByb3ZpZGVyIH0gZnJvbSAnLi4vLi4vY2FjaGUnO1xyXG5cclxuLyoqXHJcbiAqIOWxnuaAp+azqOino+WZqOmAmueUqOaWueazlVxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEZpZWxkTWV0YWRhdGFVdGlsIHtcclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPmiYDmnInnmoTnroDljZXlsZ7mgKflhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu+Wei1xyXG4gICAqIEByZXR1cm5zIOW9ouWmgu+8mntbcHJvcE5hbWU6IHN0cmluZ106IE5nT2JqZWN0UHJvcGVydHl9XHJcbiAgICovXHJcbiAgLy9AQ2FjaGVhYmxlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IGFyZ3NbMF0pLCBwcm92aWRlcjogbmV3IERlZmF1bHRDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBzdGF0aWMgZ2V0TmdGaWVsZHModGFyZ2V0OiBhbnkpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogTmdGaWVsZFByb3BlcnR5IH0ge1xyXG4gICAgcmV0dXJuIE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0YXJnZXQsIE5HX0ZJRUxEKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluafkOS4queugOWNleWxnuaAp+eahOWFg+aVsOaNrlxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXROZ0ZpZWxkKHRhcmdldDogYW55LCBwcm9wTmFtZTogc3RyaW5nKTogTmdGaWVsZFByb3BlcnR5IHtcclxuICAgIGNvbnN0IG5nRmllbGRzID0gdGhpcy5nZXROZ0ZpZWxkcyh0YXJnZXQpO1xyXG4gICAgY29uc3QgbmdGaWVsZCA9IG5nRmllbGRzW3Byb3BOYW1lXSBhcyBOZ0ZpZWxkUHJvcGVydHk7XHJcbiAgICByZXR1cm4gbmdGaWVsZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k+WxnuaAp+WcqOWOn+Wni+aVsOaNruS4reeahOWxnuaAp+WQjVxyXG4gICAqL1xyXG4gIHN0YXRpYyBnZXREYXRhRmllbGQodGFyZ2V0OiBhbnksIHByb3BOYW1lOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IG5nRmllbGQgPSB0aGlzLmdldE5nRmllbGQodGFyZ2V0LCBwcm9wTmFtZSk7XHJcbiAgICByZXR1cm4gbmdGaWVsZC5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5bmoIfms6jkuLpOZ09iamVjdOeahOWxnuaAp+eahOWFg+aVsOaNrlxyXG4gICAqIEBwYXJhbSB0YXJnZXQg5a6e5L2T57G75Z6LXHJcbiAgICogQHJldHVybnMg5b2i5aaC77yae1twcm9wTmFtZTogc3RyaW5nXTogTmdPYmplY3RQcm9wZXJ0eX1cclxuICAgKi9cclxuICAvL0BDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXROZ09iamVjdHModGFyZ2V0OiBhbnkpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogTmdPYmplY3RQcm9wZXJ0eSB9IHtcclxuICAgIHJldHVybiBNZXRhZGF0YVV0aWwuZ2V0UHJvcHNNZXRhZGF0YXNCeU5hbWUodGFyZ2V0LCBOR19PQkpFQ1QpO1xyXG4gIH1cclxuXHJcbiAgc3RhdGljIGdldE5nRHluYW1pYyh0YXJnZXQ6IGFueSk6IHsgW3Byb3BOYW1lOiBzdHJpbmddOiBOZ09iamVjdFByb3BlcnR5IH0ge1xyXG4gICAgcmV0dXJuIE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0YXJnZXQsIE5HX0R5bmFtaWMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+W5qCH5rOo5Li6TmdMaXN055qE5bGe5oCn55qE5YWD5pWw5o2uXHJcbiAgICogQHBhcmFtIHRhcmdldCDlrp7kvZPnsbvlnotcclxuICAgKiBAcmV0dXJucyDlvaLlpoLvvJp7W3Byb3BOYW1lOiBzdHJpbmddOiBOZ0xpc3RQcm9wZXJ0eX1cclxuICAgKi9cclxuICAvL0BDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXROZ0xpc3QodGFyZ2V0OiBhbnkpOiB7IFtwcm9wTmFtZTogc3RyaW5nXTogTmdMaXN0UHJvcGVydHkgfSB7XHJcbiAgICByZXR1cm4gTWV0YWRhdGFVdGlsLmdldFByb3BzTWV0YWRhdGFzQnlOYW1lKHRhcmdldCwgTkdfTElTVCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDojrflj5blrp7kvZPmoIfms6jkuLrkuLvplK7nmoTlsZ7mgKflhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu+Wei1xyXG4gICAqL1xyXG4gIC8vQENhY2hlYWJsZSh7IGtleTogKChjb250ZXh0OiBhbnksIGFyZ3M6IGFueVtdKSA9PiBhcmdzWzBdKSwgcHJvdmlkZXI6IG5ldyBEZWZhdWx0Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgc3RhdGljIGdldFByaW1hcnlGaWVsZE1ldGFkYXRhKHRhcmdldDogYW55KTogTmdGaWVsZFByb3BlcnR5IHwgdW5kZWZpbmVkIHtcclxuICAgIGNvbnN0IG5nRmllbGRPYmogPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyh0YXJnZXQpO1xyXG4gICAgY29uc3QgcHJpbWFyeUtleSA9IE9iamVjdC5rZXlzKG5nRmllbGRPYmopLmZpbmQoKHByb3A6IHN0cmluZykgPT4ge1xyXG4gICAgICByZXR1cm4gbmdGaWVsZE9ialtwcm9wXS5wcmltYXJ5O1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKHByaW1hcnlLZXkpIHtcclxuICAgICAgY29uc3QgcHJvcE1ldGEgPSBuZ0ZpZWxkT2JqW3ByaW1hcnlLZXldO1xyXG4gICAgICBwcm9wTWV0YS5wcm9wZXJ0eSA9IHByaW1hcnlLZXk7XHJcbiAgICAgIGlmICghcHJvcE1ldGEuZGF0YUZpZWxkKSB7XHJcbiAgICAgICAgcHJvcE1ldGEuZGF0YUZpZWxkID0gcHJpbWFyeUtleTtcclxuICAgICAgfVxyXG5cclxuICAgICAgcmV0dXJuIHByb3BNZXRhO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluS4u+mUruWQjeensO+8jOayoeacieS4u+mUruaXtui/lOWbnuepuuWtl+espuS4slxyXG4gICAqL1xyXG4gIC8vQENhY2hlYWJsZSh7IGtleTogKChjb250ZXh0OiBhbnksIGFyZ3M6IGFueVtdKSA9PiBhcmdzWzBdKSwgcHJvdmlkZXI6IG5ldyBEZWZhdWx0Q2FjaGVQcm92aWRlcigpIH0pXHJcbiAgc3RhdGljIGdldFByaW1hcnlLZXkoZW50aXR5VHlwZTogYW55KSB7XHJcbiAgICBjb25zdCBwcmltYXJ5TmdGaWVsZCA9IHRoaXMuZ2V0UHJpbWFyeUZpZWxkTWV0YWRhdGEoZW50aXR5VHlwZSk7XHJcbiAgICBpZiAoIXByaW1hcnlOZ0ZpZWxkKSB7XHJcbiAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuICAgIHJldHVybiBwcmltYXJ5TmdGaWVsZC5wcm9wZXJ0eTtcclxuICB9XHJcblxyXG4gIC8vIHN0YXRpYyB1ZHRNYXAgPSB7fTtcclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WTmdGaWVsZCDnmoTpqozor4Hop4TliJnlhYPmlbDmja5cclxuICAgKiBAcGFyYW0gdGFyZ2V0IOWunuS9k+exu1R5cGVcclxuICAgKi9cclxuICAvL0BDYWNoZWFibGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4gYXJnc1swXSksIHByb3ZpZGVyOiBuZXcgRGVmYXVsdENhY2hlUHJvdmlkZXIoKSB9KVxyXG4gIHN0YXRpYyBnZXRWYWxpZGF0aW9uTWV0YWRhdGEodGFyZ2V0OiBhbnkpOiB7IFtrZXk6IHN0cmluZ106IFZhbGlkYXRlUnVsZVtdIH0ge1xyXG4gICAgY29uc3QgZmllbGRNZXRhZGF0YXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyh0YXJnZXQpO1xyXG4gICAgLy8gdGhpcy51ZHRNYXAgPSBPYmplY3QuYXNzaWduKHRoaXMudWR0TWFwIHx8IHt9LCBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHModGFyZ2V0KSB8fCB7fSk7XHJcbiAgICAvLyBsZXQgdWR0UGFyZW50TmFtZSA9ICcnO1xyXG4gICAgLy8gT2JqZWN0LmtleXModGhpcy51ZHRNYXApLmZvckVhY2goa2V5ID0+IHtcclxuICAgIC8vICAgLy8g5b2T5YmN5a6e5L2T5pivdWR057G75Z6L5pe2XHJcbiAgICAvLyAgIGlmICh0aGlzLnVkdE1hcFtrZXldLnR5cGUubmFtZSA9PT0gdGFyZ2V0Lm5hbWUpIHtcclxuICAgIC8vICAgICAvLyDmib7lh7rlvZPliY11ZHTlrp7kvZPnmoTniLbnuqfkv6Hmga9cclxuICAgIC8vICAgICB1ZHRQYXJlbnROYW1lID0ga2V5O1xyXG4gICAgLy8gICB9XHJcbiAgICAvLyB9KTtcclxuICAgIGNvbnN0IG1ldGFkYXRhczogeyBba2V5OiBzdHJpbmddOiBWYWxpZGF0ZVJ1bGVbXSB9ID0ge307XHJcbiAgICAvLyBsZXQgcHJpbWFyeUlkID0gJyc7XHJcbiAgICAvLyBsZXQgdWR0UHJpbWFyeUlkID0gJyc7XHJcbiAgICAvLyDkuI3ov5vooYzpqozor4HnmoTlsZ7mgKflkI1cclxuICAgIC8vIGNvbnN0IGV4Y2x1ZGVJRHMgPSBbXTtcclxuICAgIC8vIOaOkumZpHVkdOeahOS4u+mUrlxyXG4gICAgLy8gT2JqZWN0LmtleXMoZmllbGRNZXRhZGF0YXMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgIC8vICAgaWYgKGZpZWxkTWV0YWRhdGFzW2tleV0ucHJpbWFyeSB8fCBmaWVsZE1ldGFkYXRhc1trZXldLmZvcmVpZ24pIHtcclxuICAgIC8vICAgICBwcmltYXJ5SWQgPSBmaWVsZE1ldGFkYXRhc1trZXldLmRhdGFGaWVsZDtcclxuICAgIC8vICAgICB1ZHRQcmltYXJ5SWQgPSBmaWVsZE1ldGFkYXRhc1trZXldLmRhdGFGaWVsZCArICdfSUQnO1xyXG4gICAgLy8gICAgIGV4Y2x1ZGVJRHMucHVzaChmaWVsZE1ldGFkYXRhc1trZXldLmRhdGFGaWVsZCk7XHJcbiAgICAvLyAgIH1cclxuICAgIC8vIH0pO1xyXG4gICAgT2JqZWN0LmtleXMoZmllbGRNZXRhZGF0YXMpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgaWYgKGZpZWxkTWV0YWRhdGFzW2tleV0ucHJpbWFyeSB8fCBmaWVsZE1ldGFkYXRhc1trZXldLmZvcmVpZ24pIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgICAgY29uc3QgdmFsaWRSdWxlcyA9IGZpZWxkTWV0YWRhdGFzW2tleV0udmFsaWRSdWxlcztcclxuICAgICAgLy8gaWYgKGV4Y2x1ZGVJRHMuaW5kZXhPZihrZXkpID4gLTEpIHtcclxuICAgICAgLy8gICByZXR1cm47XHJcbiAgICAgIC8vIH1cclxuICAgICAgaWYgKHZhbGlkUnVsZXMgJiYgdmFsaWRSdWxlcy5sZW5ndGgpIHtcclxuICAgICAgICB2YWxpZFJ1bGVzLm1hcChydWxlID0+IHtcclxuICAgICAgICAgIHJ1bGUucHJvcGVydHkgPSBrZXk7XHJcbiAgICAgICAgICBydWxlWyd0YXJnZXROYW1lJ10gPSB0YXJnZXQubmFtZTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBtZXRhZGF0YXNba2V5XSA9IHZhbGlkUnVsZXM7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIG1ldGFkYXRhcztcclxuICB9XHJcbiAgLy9AQ2FjaGVhYmxlKHsga2V5OiAoKGNvbnRleHQ6IGFueSwgYXJnczogYW55W10pID0+IGFyZ3NbMF0pLCBwcm92aWRlcjogbmV3IERlZmF1bHRDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBzdGF0aWMgZ2V0VmFsaWRhdGlvbk1ldGFkYXRhV2l0aFBhdGgob2JqZWN0OiBhbnkpOiB7IFtrZXk6IHN0cmluZ106IFZhbGlkYXRlUnVsZVtdIH0ge1xyXG4gICAgY29uc3QgdGFyZ2V0ID0gb2JqZWN0LmNvbnN0cnVjdG9yO1xyXG4gICAgY29uc3QgZmllbGRNZXRhZGF0YXMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyh0YXJnZXQpO1xyXG4gICAgY29uc3QgcGFyZW50UGF0aHMgPSBvYmplY3QuZ2V0UGF0aHMoKS5wYXRoIHx8IFtdO1xyXG4gICAgY29uc3QgbWV0YWRhdGFzOiB7IFtrZXk6IHN0cmluZ106IFZhbGlkYXRlUnVsZVtdIH0gPSB7fTtcclxuXHJcbiAgICBPYmplY3Qua2V5cyhmaWVsZE1ldGFkYXRhcykuZm9yRWFjaChrZXkgPT4ge1xyXG4gICAgICBpZiAoZmllbGRNZXRhZGF0YXNba2V5XS5wcmltYXJ5IHx8IGZpZWxkTWV0YWRhdGFzW2tleV0uZm9yZWlnbikge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG4gICAgICBjb25zdCB2YWxpZFJ1bGVzID0gZmllbGRNZXRhZGF0YXNba2V5XS52YWxpZFJ1bGVzO1xyXG5cclxuICAgICAgaWYgKHZhbGlkUnVsZXMgJiYgdmFsaWRSdWxlcy5sZW5ndGgpIHtcclxuICAgICAgICBjb25zdCBwcm9wZXJ0eVBhdGggPSBwYXJlbnRQYXRocy5jb25jYXQoW10pO1xyXG4gICAgICAgIHByb3BlcnR5UGF0aC5wdXNoKGtleSk7XHJcbiAgICAgICAgY29uc3QgcHJvcGVydHkgPSBwcm9wZXJ0eVBhdGguam9pbignLicpO1xyXG4gICAgICAgIHZhbGlkUnVsZXMubWFwKHJ1bGUgPT4ge1xyXG4gICAgICAgICAgcnVsZS5wcm9wZXJ0eSA9IGtleTtcclxuICAgICAgICAgIHJ1bGVbJ3RhcmdldE5hbWUnXSA9IHRhcmdldC5uYW1lO1xyXG4gICAgICAgICAgcnVsZVsncGF0aCddID0gcHJvcGVydHk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgbWV0YWRhdGFzW2tleV0gPSB2YWxpZFJ1bGVzO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBtZXRhZGF0YXM7XHJcbiAgfVxyXG59XHJcbiJdfQ==