import { Injectable, Injector } from "@angular/core";
import { EMPTY, of } from "rxjs";
import { switchMap, tap } from "rxjs/operators";
import { FrameContext, DataPathCreator, Repository } from "@farris/devkit";
import { LanguageService } from "./languag.service";
import { FormMessageService } from "./form-message.service";
var PopUpService = /** @class */ (function () {
    function PopUpService(injector, frameContext, repository, languageService, messageService) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.repository = repository;
        this.languageService = languageService;
        this.messageService = messageService;
    }
    PopUpService.prototype.confirm = function () { };
    /**
     * 取消变更
     * @param frameId
     * @param id
     * @returns
     */
    PopUpService.prototype.cancel = function (frameId, id) {
        var frameContext = this.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
        if (!frameContext) {
            throw new Error("[PopUpService]Invalid frameId " + frameId);
        }
        var primaryValue = this.frameContext.bindingData.list.currentId;
        var bindingPath = frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        if (!id) {
            var bindingList = this.frameContext.bindingData.getList();
            id = bindingList.currentId;
        }
        var befRepository = this.repository;
        var longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map(function (path) { return path.split(':')[1]; });
        var entityListPaths = Array.from(longPaths);
        //舍弃当前表当前行
        entityListPaths.pop();
        var dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityListPaths.length < 1) {
            // 主表
            var entity = this.repository.entityCollection.getEntityById(id);
            var originalData = entity['originalData'];
            entity.load(originalData, { loadChild: false });
        }
        else {
            var entityList_1 = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
            if (entityList_1) {
                var originalData = entityList_1['originalData'];
                var item_1 = originalData.find(function (item) { return item.id === id; });
                if (item_1) {
                    // 已有数据，还原变更
                    var entity_1 = befRepository.entityManager.getEntityByPath(longPaths);
                    if (entity_1.changes && entity_1.changes.length > 0) {
                        return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(tap(function (result) {
                            if (result) {
                                entity_1.load(item_1, { loadChild: false });
                                entity_1.changes.splice(0, entity_1.changes.length);
                            }
                        }));
                    }
                    else {
                        // 没有修改，直接关闭
                        if (dialogRef) {
                            dialogRef.close();
                        }
                    }
                }
                else {
                    // 新增的数据，删除
                    var paths_1 = this.buildPath(bindingPath, primaryValue);
                    return this.messageService.confirm(this.languageService.cancelWithoutSave).pipe(switchMap(function (result) {
                        if (result) {
                            return befRepository.removeEntityByPath(paths_1, id).pipe(tap(function () {
                                befRepository.entityManager.removeEntityByPath(paths_1, id);
                                if (entityList_1.count() === 0 && dialogRef) {
                                    dialogRef.close();
                                }
                            }));
                        }
                        else {
                            return EMPTY;
                        }
                    }));
                }
            }
        }
        return of([]);
    };
    /**
     * 同步当前行
     */
    PopUpService.prototype.updateCurrentRow = function (id) {
        var _this = this;
        var bindingPath = this.frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        // const frameId = this.frameContext.frameId;
        var root = this.frameContext.appContext.frameContextManager.getRootFrameContext();
        var primaryKeyValue = root.bindingData.list.currentId;
        this.frameContext.bindingData.list.setCurrentId(primaryKeyValue);
        if (bindingPaths.length > 0) {
            var paths_2 = [];
            bindingPaths.forEach(function (path, index, array) {
                paths_2.push(path);
                var bindingList = root.bindingData.getValue(paths_2);
                if (bindingList) {
                    var currentId = bindingList.currentId;
                    var modalBindingList = _this.frameContext.bindingData.getValue(paths_2);
                    if (index === bindingPath.length - 1 && id) {
                        modalBindingList.setCurrentId(id);
                    }
                    else if (modalBindingList) {
                        modalBindingList.setCurrentId(currentId);
                    }
                }
            });
        }
    };
    PopUpService.prototype.closeCheck = function () {
        var frameContext = this.frameContext;
        var bindingPath = frameContext.viewModel.bindingPath;
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        var befRepository = this.repository;
        var longPaths = DataPathCreator.createByShortPathFromRoot(bindingPaths, befRepository.entityManager, this.frameContext.bindingData).toArray().map(function (path) { return path.split(':')[1]; });
        var entityListPaths = Array.from(longPaths);
        entityListPaths.pop();
        var entityList = befRepository.entityManager.getEntityNodeByPath(entityListPaths);
        var dialogRef = this.frameContext.frameComponent['dialogRef'];
        if (entityList.count() === 0 && dialogRef) {
            dialogRef.close();
        }
    };
    /**
     * 构造子表路径
     * @param bindingPath 绑定路径
     * @param id id
     */
    PopUpService.prototype.buildPath = function (bindingPath, id) {
        var path = '/' + id;
        var subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (var index = 1; index < subPaths.length - 1; index++) {
                var subPath = subPaths[index];
                var subData = this.frameContext.viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error("\u83B7\u53D6\u5B50\u8868\u5B8C\u6574\u8DEF\u5F84\u51FA\u9519\uFF0C\u627E\u4E0D\u5230" + subData + "\u5BF9\u5E94\u7684\u5B50\u8868\uFF0C\u6216\u5BF9\u5E94\u5B50\u8868\u6CA1\u6709\u5F53\u524D\u884C\u3002");
                }
                path += "/" + subPath + "/" + subData.currentId;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    };
    PopUpService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    PopUpService.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: Repository },
        { type: LanguageService },
        { type: FormMessageService }
    ]; };
    return PopUpService;
}());
export { PopUpService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9wX3VwLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvcG9wX3VwLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVoRCxPQUFPLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxVQUFVLEVBQTZDLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEgsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTVEO0lBRUUsc0JBQ1UsUUFBa0IsRUFDbEIsWUFBMEIsRUFDMUIsVUFBMkIsRUFDM0IsZUFBZ0MsRUFDaEMsY0FBa0M7UUFKbEMsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUFpQjtRQUMzQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDaEMsbUJBQWMsR0FBZCxjQUFjLENBQW9CO0lBQ3hDLENBQUM7SUFDRSw4QkFBTyxHQUFkLGNBQW1CLENBQUM7SUFDcEI7Ozs7O09BS0c7SUFDSSw2QkFBTSxHQUFiLFVBQWMsT0FBZSxFQUFFLEVBQVc7UUFDeEMsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkcsSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNqQixNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFpQyxPQUFT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QUMsQ0FBQztRQUN4QyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZCLDZEQUE2RDtZQUM3RCxjQUFjO1lBQ2QsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUN4RCxJQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2hDLElBQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDakUsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUU7b0JBQ2xDLE1BQU0sS0FBSyxDQUFDLHlGQUFpQixPQUFPLDJHQUFtQixDQUFDLENBQUM7aUJBQzFEO2dCQUNELElBQUksSUFBSSxNQUFJLE9BQU8sU0FBSSxPQUFPLENBQUMsU0FBVyxDQUFDO2FBQzVDO1NBQ0Y7UUFDRCxJQUFJLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTVDLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQzs7Z0JBdkpGLFVBQVU7Ozs7Z0JBUlUsUUFBUTtnQkFJcEIsWUFBWTtnQkFBbUIsVUFBVTtnQkFDekMsZUFBZTtnQkFDZixrQkFBa0I7O0lBMEozQixtQkFBQztDQUFBLEFBeEpELElBd0pDO1NBdkpZLFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBFTVBUWSwgb2YgfSBmcm9tIFwicnhqc1wiO1xuaW1wb3J0IHsgc3dpdGNoTWFwLCB0YXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnkgfSBmcm9tIFwiQGZhcnJpcy9iZWZcIjtcbmltcG9ydCB7IEZyYW1lQ29udGV4dCwgRGF0YVBhdGhDcmVhdG9yLCBSZXBvc2l0b3J5LCBEYXRhUGF0aCwgRW50aXR5TGlzdCwgQmluZGluZ0xpc3QsIEVudGl0eSB9IGZyb20gXCJAZmFycmlzL2RldmtpdFwiO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSBcIi4vbGFuZ3VhZy5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBGb3JtTWVzc2FnZVNlcnZpY2UgfSBmcm9tIFwiLi9mb3JtLW1lc3NhZ2Uuc2VydmljZVwiO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgUG9wVXBTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcbiAgICBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgbWVzc2FnZVNlcnZpY2U6IEZvcm1NZXNzYWdlU2VydmljZVxuICApIHsgfVxuICBwdWJsaWMgY29uZmlybSgpIHsgfVxuICAvKipcbiAgICog5Y+W5raI5Y+Y5pu0XG4gICAqIEBwYXJhbSBmcmFtZUlkIFxuICAgKiBAcGFyYW0gaWQgXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGNhbmNlbChmcmFtZUlkOiBzdHJpbmcsIGlkPzogc3RyaW5nKSB7XG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCk7XG4gICAgaWYgKCFmcmFtZUNvbnRleHQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgW1BvcFVwU2VydmljZV1JbnZhbGlkIGZyYW1lSWQgJHtmcmFtZUlkfWApO1xuICAgIH1cbiAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZDtcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICBpZiAoIWlkKSB7XG4gICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldExpc3QoKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgIGlkID0gYmluZGluZ0xpc3QuY3VycmVudElkO1xuICAgIH1cbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICBjb25zdCBsb25nUGF0aHMgPSAoRGF0YVBhdGhDcmVhdG9yLmNyZWF0ZUJ5U2hvcnRQYXRoRnJvbVJvb3QoYmluZGluZ1BhdGhzLCBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIsIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhKSBhcyBEYXRhUGF0aCkudG9BcnJheSgpLm1hcCgocGF0aDogc3RyaW5nKSA9PiBwYXRoLnNwbGl0KCc6JylbMV0pO1xuICAgIGNvbnN0IGVudGl0eUxpc3RQYXRocyA9IEFycmF5LmZyb20obG9uZ1BhdGhzKTtcbiAgICAvL+iIjeW8g+W9k+WJjeihqOW9k+WJjeihjFxuICAgIGVudGl0eUxpc3RQYXRocy5wb3AoKTtcbiAgICBjb25zdCBkaWFsb2dSZWYgPSB0aGlzLmZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudFsnZGlhbG9nUmVmJ107XG4gICAgaWYgKGVudGl0eUxpc3RQYXRocy5sZW5ndGggPCAxKSB7XG4gICAgICAvLyDkuLvooahcbiAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQoaWQpIGFzIEVudGl0eTtcbiAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IGVudGl0eVsnb3JpZ2luYWxEYXRhJ107XG4gICAgICBlbnRpdHkubG9hZChvcmlnaW5hbERhdGEsIHsgbG9hZENoaWxkOiBmYWxzZSB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgZW50aXR5TGlzdCA9IGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5nZXRFbnRpdHlOb2RlQnlQYXRoKGVudGl0eUxpc3RQYXRocykgYXMgRW50aXR5TGlzdDxhbnk+O1xuICAgICAgaWYgKGVudGl0eUxpc3QpIHtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxEYXRhOiBhbnlbXSA9IGVudGl0eUxpc3RbJ29yaWdpbmFsRGF0YSddO1xuICAgICAgICBjb25zdCBpdGVtID0gb3JpZ2luYWxEYXRhLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBpZCk7XG4gICAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgICAgLy8g5bey5pyJ5pWw5o2u77yM6L+Y5Y6f5Y+Y5pu0XG4gICAgICAgICAgY29uc3QgZW50aXR5OiBFbnRpdHkgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuZ2V0RW50aXR5QnlQYXRoKGxvbmdQYXRocykgYXMgRW50aXR5O1xuICAgICAgICAgIGlmIChlbnRpdHkuY2hhbmdlcyAmJiBlbnRpdHkuY2hhbmdlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlU2VydmljZS5jb25maXJtKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNhbmNlbFdpdGhvdXRTYXZlKS5waXBlKFxuICAgICAgICAgICAgICB0YXAoKHJlc3VsdDogYm9vbGVhbikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgIGVudGl0eS5sb2FkKGl0ZW0sIHsgbG9hZENoaWxkOiBmYWxzZSB9KTtcbiAgICAgICAgICAgICAgICAgIGVudGl0eS5jaGFuZ2VzLnNwbGljZSgwLCBlbnRpdHkuY2hhbmdlcy5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIOayoeacieS/ruaUue+8jOebtOaOpeWFs+mXrVxuICAgICAgICAgICAgaWYgKGRpYWxvZ1JlZikge1xuICAgICAgICAgICAgICBkaWFsb2dSZWYuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8g5paw5aKe55qE5pWw5o2u77yM5Yig6ZmkXG4gICAgICAgICAgY29uc3QgcGF0aHMgPSB0aGlzLmJ1aWxkUGF0aChiaW5kaW5nUGF0aCwgcHJpbWFyeVZhbHVlKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5tZXNzYWdlU2VydmljZS5jb25maXJtKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNhbmNlbFdpdGhvdXRTYXZlKS5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gYmVmUmVwb3NpdG9yeS5yZW1vdmVFbnRpdHlCeVBhdGgocGF0aHMsIGlkKS5waXBlKFxuICAgICAgICAgICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLnJlbW92ZUVudGl0eUJ5UGF0aChwYXRocywgaWQpO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChlbnRpdHlMaXN0LmNvdW50KCkgPT09IDAgJiYgZGlhbG9nUmVmKSB7XG4gICAgICAgICAgICAgICAgICAgICAgZGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gb2YoW10pO1xuICB9XG4gIC8qKlxuICAgKiDlkIzmraXlvZPliY3ooYxcbiAgICovXG4gIHB1YmxpYyB1cGRhdGVDdXJyZW50Um93KGlkPzogc3RyaW5nKSB7XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAvLyBjb25zdCBmcmFtZUlkID0gdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVJZDtcbiAgICBjb25zdCByb290ID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldFJvb3RGcmFtZUNvbnRleHQoKTtcbiAgICBjb25zdCBwcmltYXJ5S2V5VmFsdWUgPSByb290LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICAgIHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3Quc2V0Q3VycmVudElkKHByaW1hcnlLZXlWYWx1ZSk7XG4gICAgaWYgKGJpbmRpbmdQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBwYXRocyA9IFtdO1xuICAgICAgYmluZGluZ1BhdGhzLmZvckVhY2goKHBhdGg6IHN0cmluZywgaW5kZXg6IG51bWJlciwgYXJyYXkpID0+IHtcbiAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSByb290LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgICAgaWYgKGJpbmRpbmdMaXN0KSB7XG4gICAgICAgICAgY29uc3QgY3VycmVudElkID0gYmluZGluZ0xpc3QuY3VycmVudElkO1xuICAgICAgICAgIGNvbnN0IG1vZGFsQmluZGluZ0xpc3QgPSB0aGlzLmZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgICAgICAgaWYgKGluZGV4ID09PSBiaW5kaW5nUGF0aC5sZW5ndGggLSAxICYmIGlkKSB7XG4gICAgICAgICAgICBtb2RhbEJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChpZCk7XG4gICAgICAgICAgfSBlbHNlIGlmIChtb2RhbEJpbmRpbmdMaXN0KSB7XG4gICAgICAgICAgICBtb2RhbEJpbmRpbmdMaXN0LnNldEN1cnJlbnRJZChjdXJyZW50SWQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBjbG9zZUNoZWNrKCkge1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZnJhbWVDb250ZXh0O1xuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xuICAgIGNvbnN0IGxvbmdQYXRocyA9IChEYXRhUGF0aENyZWF0b3IuY3JlYXRlQnlTaG9ydFBhdGhGcm9tUm9vdChiaW5kaW5nUGF0aHMsIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlciwgdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGEpIGFzIERhdGFQYXRoKS50b0FycmF5KCkubWFwKChwYXRoOiBzdHJpbmcpID0+IHBhdGguc3BsaXQoJzonKVsxXSk7XG4gICAgY29uc3QgZW50aXR5TGlzdFBhdGhzID0gQXJyYXkuZnJvbShsb25nUGF0aHMpO1xuICAgIGVudGl0eUxpc3RQYXRocy5wb3AoKTtcbiAgICBjb25zdCBlbnRpdHlMaXN0ID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmdldEVudGl0eU5vZGVCeVBhdGgoZW50aXR5TGlzdFBhdGhzKSBhcyBFbnRpdHlMaXN0PGFueT47XG4gICAgY29uc3QgZGlhbG9nUmVmID0gdGhpcy5mcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnRbJ2RpYWxvZ1JlZiddO1xuICAgIGlmIChlbnRpdHlMaXN0LmNvdW50KCkgPT09IDAgJiYgZGlhbG9nUmVmKSB7XG4gICAgICBkaWFsb2dSZWYuY2xvc2UoKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOaehOmAoOWtkOihqOi3r+W+hFxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGgg57uR5a6a6Lev5b6EXG4gICAqIEBwYXJhbSBpZCBpZFxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZFBhdGgoYmluZGluZ1BhdGg6IHN0cmluZywgaWQ6IGFueSkge1xuICAgIGxldCBwYXRoID0gJy8nICsgaWQ7XG4gICAgY29uc3Qgc3ViUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpO1xuICAgIGlmIChzdWJQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICAvLyBlZzpiaW5kaW5nUGF0aOW9ouWmgi9lZHVzL2dyYWRlcyxzcGxpdOWQjuaYr1snJywgJ2VkdXMnLCAnZ3JhZGVzJ11cbiAgICAgIC8vIOWboOatpGluZGV45LuOMeW8gOWni1xuICAgICAgZm9yIChsZXQgaW5kZXggPSAxOyBpbmRleCA8IHN1YlBhdGhzLmxlbmd0aCAtIDE7IGluZGV4KyspIHtcbiAgICAgICAgY29uc3Qgc3ViUGF0aCA9IHN1YlBhdGhzW2luZGV4XTtcbiAgICAgICAgY29uc3Qgc3ViRGF0YSA9IHRoaXMuZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nRGF0YVtzdWJQYXRoXTtcbiAgICAgICAgaWYgKCFzdWJEYXRhIHx8ICFzdWJEYXRhLmN1cnJlbnRJZCkge1xuICAgICAgICAgIHRocm93IEVycm9yKGDojrflj5blrZDooajlrozmlbTot6/lvoTlh7rplJnvvIzmib7kuI3liLAke3N1YkRhdGF95a+55bqU55qE5a2Q6KGo77yM5oiW5a+55bqU5a2Q6KGo5rKh5pyJ5b2T5YmN6KGM44CCYCk7XG4gICAgICAgIH1cbiAgICAgICAgcGF0aCArPSBgLyR7c3ViUGF0aH0vJHtzdWJEYXRhLmN1cnJlbnRJZH1gO1xuICAgICAgfVxuICAgIH1cbiAgICBwYXRoICs9ICcvJyArIHN1YlBhdGhzW3N1YlBhdGhzLmxlbmd0aCAtIDFdO1xuXG4gICAgcmV0dXJuIHBhdGg7XG4gIH1cbn0iXX0=