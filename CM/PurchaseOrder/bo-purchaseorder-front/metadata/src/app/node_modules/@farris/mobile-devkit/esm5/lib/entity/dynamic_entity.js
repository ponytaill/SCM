import * as tslib_1 from "tslib";
import { ModifyType } from '../changeset/types';
import { PARENT_PATH, PARENT_CLASS } from './types';
import { Entity } from './entity';
/**
 * 支持动态字段集合的动态实体
 */
var DynamicEntity = /** @class */ (function (_super) {
    tslib_1.__extends(DynamicEntity, _super);
    /**
     * @param data JSON数据
     */
    function DynamicEntity(data) {
        var _this = _super.call(this, data) || this;
        _this.loadDynamicData(data);
        return _this;
    }
    Object.defineProperty(DynamicEntity.prototype, "IsNested", {
        /**
         * 是否是嵌套的动态实体
         */
        get: function () {
            return this[PARENT_CLASS] instanceof DynamicEntity;
        },
        enumerable: true,
        configurable: true
    });
    DynamicEntity.prototype.loadDynamicData = function (dynamicData) {
        this.initializeDynamicField(dynamicData);
        // super.loadFields(dynamicData);
    };
    /**
     * 初始化动态数据
     * @param dynamicData 动态数据
     */
    DynamicEntity.prototype.initializeDynamicField = function (dynamicData) {
        var _this = this;
        // 遍历动态数据的key，创建动态实体属性。
        Object.keys(dynamicData).forEach(function (propertyName) {
            // 如果属性已经存在，先删除
            if (_this[propertyName]) {
                delete _this[propertyName];
            }
            var dataField = propertyName;
            if (dynamicData[propertyName] instanceof Object) {
                var path_1 = _this.createPath(propertyName);
                var dynamicEntity_1 = _this.createDynamicEntityFromJsonData(dynamicData[propertyName], path_1);
                Object.defineProperty(_this, propertyName, {
                    get: function () {
                        return dynamicEntity_1;
                    },
                    set: function (value) {
                        var modifyInfo = {
                            path: dynamicEntity_1[PARENT_PATH],
                            value: value.data,
                            preValue: this[propertyName].data,
                            type: ModifyType.ValueChange
                        };
                        dynamicEntity_1 = this.createDynamicEntityFromJsonData(value, path_1);
                        this.setChanges(modifyInfo);
                    },
                    configurable: true
                });
            }
            else {
                Object.defineProperty(_this, propertyName, {
                    // 定义返回数据方法。
                    get: function () {
                        // 从初始数据返回字段值。
                        return this.data[dataField];
                    },
                    set: function (value) {
                        // 值相同时不触发变更。
                        var oldValue = this.data[dataField];
                        if (oldValue === value) {
                            return;
                        }
                        // 更新元数据数据。
                        this.data[dataField] = value;
                        // 变更集
                        var changes = {
                            type: ModifyType.ValueChange,
                            path: this.createPath(propertyName),
                            value: value,
                            preValue: oldValue
                        };
                        if (this[PARENT_PATH]) {
                            changes.path = this[PARENT_PATH].concat(changes.path);
                        }
                        this.setChanges(changes);
                    },
                    configurable: true
                });
            }
        });
    };
    DynamicEntity.prototype.createDynamicEntityFromJsonData = function (value, parentPath) {
        var _this = this;
        var instance;
        if (value instanceof DynamicEntity) {
            instance = value;
        }
        else {
            instance = new DynamicEntity(value);
        }
        instance[PARENT_CLASS] = this;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(function (changes) {
            if (changes) {
                changes.path = (_this[PARENT_PATH] || []).concat(changes.path);
                _this.setChanges(changes);
            }
        });
        return instance;
    };
    /**
     * 将变更记录保存至变更集中
     * @param value 变更记录
     * @todo
     * 1、preValue的处理有问题，下级传递上来的变更这样可以，根DyanmicaEntity上的，data已经发生变化，prevalue和value是一样了；
     * 2、当value是下级冒泡上来的，需要根据value去更新当前层级的data，该逻辑不应该放在setChagnes，待修改。
     */
    DynamicEntity.prototype.setChanges = function (value) {
        var _a;
        var propertyName = value.path[value.path.length - 1];
        var preValue = Object.assign({}, this.data);
        this.newData = Object.assign(this.newData, (_a = {}, _a[propertyName] = value.value, _a));
        var parentPath = value.path;
        if (value.path.length > 2) {
            parentPath = value.path.slice(0, value.path.length - 2);
        }
        // 统一不使用构造函数（保持和其他位置对Modification的构造一致）
        // const parentModification = new Modification(this.data, value.type, parentPath, preValue);
        var parentModification = {
            path: parentPath,
            value: this.data,
            preValue: preValue,
            type: value.type
        };
        this.valueChanged.next(parentModification);
        this.changeSet.append(value);
    };
    /**
     * toJSON
     */
    DynamicEntity.prototype.toJSON = function () {
        return this.data;
    };
    return DynamicEntity;
}(Entity));
export { DynamicEntity };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19lbnRpdHkuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvZW50aXR5L2R5bmFtaWNfZW50aXR5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFnQixNQUFNLG9CQUFvQixDQUFDO0FBQzlELE9BQU8sRUFBRSxXQUFXLEVBQVcsWUFBWSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQzdELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFbEM7O0dBRUc7QUFDSDtJQUFtQyx5Q0FBTTtJQVN2Qzs7T0FFRztJQUNILHVCQUFZLElBQVM7UUFBckIsWUFDRSxrQkFBTSxJQUFJLENBQUMsU0FFWjtRQURDLEtBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7O0lBQzdCLENBQUM7SUFWRCxzQkFBVyxtQ0FBUTtRQUhuQjs7V0FFRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksYUFBYSxDQUFDO1FBQ3JELENBQUM7OztPQUFBO0lBVU0sdUNBQWUsR0FBdEIsVUFBdUIsV0FBZ0I7UUFDckMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pDLGlDQUFpQztJQUNuQyxDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssOENBQXNCLEdBQTlCLFVBQStCLFdBQWdCO1FBQS9DLGlCQTZEQztRQTVEQyx1QkFBdUI7UUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxZQUFZO1lBRTNDLGVBQWU7WUFDZixJQUFJLEtBQUksQ0FBQyxZQUFZLENBQUMsRUFBRTtnQkFDdEIsT0FBTyxLQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDM0I7WUFFRCxJQUFNLFNBQVMsR0FBRyxZQUFZLENBQUM7WUFDL0IsSUFBSSxXQUFXLENBQUMsWUFBWSxDQUFDLFlB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Q0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSSw4QkFBTSxHQUFiO1FBQ0UsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ25CLENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUEvSUQsQ0FBbUMsTUFBTSxHQStJeEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2RpZnlUeXBlLCBNb2RpZmljYXRpb24gfSBmcm9tICcuLi9jaGFuZ2VzZXQvdHlwZXMnO1xyXG5pbXBvcnQgeyBQQVJFTlRfUEFUSCwgRHluYW1pYywgUEFSRU5UX0NMQVNTIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IEVudGl0eSB9IGZyb20gJy4vZW50aXR5JztcclxuXHJcbi8qKlxyXG4gKiDmlK/mjIHliqjmgIHlrZfmrrXpm4blkIjnmoTliqjmgIHlrp7kvZNcclxuICovXHJcbmV4cG9ydCBjbGFzcyBEeW5hbWljRW50aXR5IGV4dGVuZHMgRW50aXR5IGltcGxlbWVudHMgRHluYW1pYyB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaYr+WQpuaYr+W1jOWll+eahOWKqOaAgeWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQgSXNOZXN0ZWQoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpc1tQQVJFTlRfQ0xBU1NdIGluc3RhbmNlb2YgRHluYW1pY0VudGl0eTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBwYXJhbSBkYXRhIEpTT07mlbDmja5cclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcihkYXRhOiBhbnkpIHtcclxuICAgIHN1cGVyKGRhdGEpO1xyXG4gICAgdGhpcy5sb2FkRHluYW1pY0RhdGEoZGF0YSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbG9hZER5bmFtaWNEYXRhKGR5bmFtaWNEYXRhOiBhbnkpIHtcclxuICAgIHRoaXMuaW5pdGlhbGl6ZUR5bmFtaWNGaWVsZChkeW5hbWljRGF0YSk7XHJcbiAgICAvLyBzdXBlci5sb2FkRmllbGRzKGR5bmFtaWNEYXRhKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWIneWni+WMluWKqOaAgeaVsOaNrlxyXG4gICAqIEBwYXJhbSBkeW5hbWljRGF0YSDliqjmgIHmlbDmja5cclxuICAgKi9cclxuICBwcml2YXRlIGluaXRpYWxpemVEeW5hbWljRmllbGQoZHluYW1pY0RhdGE6IGFueSk6IHZvaWQge1xyXG4gICAgLy8g6YGN5Y6G5Yqo5oCB5pWw5o2u55qEa2V577yM5Yib5bu65Yqo5oCB5a6e5L2T5bGe5oCn44CCXHJcbiAgICBPYmplY3Qua2V5cyhkeW5hbWljRGF0YSkuZm9yRWFjaChwcm9wZXJ0eU5hbWUgPT4ge1xyXG5cclxuICAgICAgLy8g5aaC5p6c5bGe5oCn5bey57uP5a2Y5Zyo77yM5YWI5Yig6ZmkXHJcbiAgICAgIGlmICh0aGlzW3Byb3BlcnR5TmFtZV0pIHtcclxuICAgICAgICBkZWxldGUgdGhpc1twcm9wZXJ0eU5hbWVdO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBkYXRhRmllbGQgPSBwcm9wZXJ0eU5hbWU7XHJcbiAgICAgIGlmIChkeW5hbWljRGF0YVtwcm9wZXJ0eU5hbWVdIGluc3RhbmNlb2YgT2JqZWN0KSB7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgIGxldCBkeW5hbWljRW50aXR5ID0gdGhpcy5jcmVhdGVEeW5hbWljRW50aXR5RnJvbUpzb25EYXRhKGR5bmFtaWNEYXRhW3Byb3BlcnR5TmFtZV0sIHBhdGgpO1xyXG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICAgIGdldDogZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBkeW5hbWljRW50aXR5O1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHtcclxuICAgICAgICAgICAgY29uc3QgbW9kaWZ5SW5mbyA9IHtcclxuICAgICAgICAgICAgICBwYXRoOiBkeW5hbWljRW50aXR5W1BBUkVOVF9QQVRIXSxcclxuICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUuZGF0YSxcclxuICAgICAgICAgICAgICBwcmVWYWx1ZTogdGhpc1twcm9wZXJ0eU5hbWVdLmRhdGEsXHJcbiAgICAgICAgICAgICAgdHlwZTogTW9kaWZ5VHlwZS5WYWx1ZUNoYW5nZVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBkeW5hbWljRW50aXR5ID0gdGhpcy5jcmVhdGVEeW5hbWljRW50aXR5RnJvbUpzb25EYXRhKHZhbHVlLCBwYXRoKTtcclxuICAgICAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKG1vZGlmeUluZm8pO1xyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICAgIC8vIOWumuS5iei/lOWbnuaVsOaNruaWueazleOAglxyXG4gICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgLy8g5LuO5Yid5aeL5pWw5o2u6L+U5Zue5a2X5q615YC844CCXHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGFbZGF0YUZpZWxkXTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIC8vIOWAvOebuOWQjOaXtuS4jeinpuWPkeWPmOabtOOAglxyXG4gICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXMuZGF0YVtkYXRhRmllbGRdO1xyXG4gICAgICAgICAgICBpZiAob2xkVmFsdWUgPT09IHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8vIOabtOaWsOWFg+aVsOaNruaVsOaNruOAglxyXG4gICAgICAgICAgICB0aGlzLmRhdGFbZGF0YUZpZWxkXSA9IHZhbHVlO1xyXG4gICAgICAgICAgICAvLyDlj5jmm7Tpm4ZcclxuICAgICAgICAgICAgY29uc3QgY2hhbmdlcyA9IHtcclxuICAgICAgICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlLFxyXG4gICAgICAgICAgICAgIHBhdGg6IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpLFxyXG4gICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcclxuICAgICAgICAgICAgICBwcmVWYWx1ZTogb2xkVmFsdWVcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzW1BBUkVOVF9QQVRIXSkge1xyXG4gICAgICAgICAgICAgIGNoYW5nZXMucGF0aCA9IHRoaXNbUEFSRU5UX1BBVEhdLmNvbmNhdChjaGFuZ2VzLnBhdGgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhjaGFuZ2VzKTtcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBjb25maWd1cmFibGU6IHRydWVcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNyZWF0ZUR5bmFtaWNFbnRpdHlGcm9tSnNvbkRhdGEodmFsdWU6IGFueSwgcGFyZW50UGF0aDogc3RyaW5nW10pIHtcclxuICAgIGxldCBpbnN0YW5jZTogRHluYW1pY0VudGl0eTtcclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIER5bmFtaWNFbnRpdHkpIHtcclxuICAgICAgaW5zdGFuY2UgPSB2YWx1ZTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGluc3RhbmNlID0gbmV3IER5bmFtaWNFbnRpdHkodmFsdWUpO1xyXG4gICAgfVxyXG4gICAgaW5zdGFuY2VbUEFSRU5UX0NMQVNTXSA9IHRoaXM7XHJcbiAgICBpbnN0YW5jZVtQQVJFTlRfUEFUSF0gPSBwYXJlbnRQYXRoO1xyXG4gICAgaW5zdGFuY2Uub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKGNoYW5nZXMgPT4ge1xyXG4gICAgICBpZiAoY2hhbmdlcykge1xyXG4gICAgICAgIGNoYW5nZXMucGF0aCA9ICh0aGlzW1BBUkVOVF9QQVRIXSB8fCBbXSkuY29uY2F0KGNoYW5nZXMucGF0aCk7XHJcbiAgICAgICAgdGhpcy5zZXRDaGFuZ2VzKGNoYW5nZXMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gaW5zdGFuY2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlsIblj5jmm7TorrDlvZXkv53lrZjoh7Plj5jmm7Tpm4bkuK1cclxuICAgKiBAcGFyYW0gdmFsdWUg5Y+Y5pu06K6w5b2VXHJcbiAgICogQHRvZG9cclxuICAgKiAx44CBcHJlVmFsdWXnmoTlpITnkIbmnInpl67popjvvIzkuIvnuqfkvKDpgJLkuIrmnaXnmoTlj5jmm7Tov5nmoLflj6/ku6XvvIzmoLlEeWFubWljYUVudGl0eeS4iueahO+8jGRhdGHlt7Lnu4/lj5HnlJ/lj5jljJbvvIxwcmV2YWx1ZeWSjHZhbHVl5piv5LiA5qC35LqG77ybXHJcbiAgICogMuOAgeW9k3ZhbHVl5piv5LiL57qn5YaS5rOh5LiK5p2l55qE77yM6ZyA6KaB5qC55o2udmFsdWXljrvmm7TmlrDlvZPliY3lsYLnuqfnmoRkYXRh77yM6K+l6YC76L6R5LiN5bqU6K+l5pS+5Zyoc2V0Q2hhZ25lc++8jOW+heS/ruaUueOAglxyXG4gICAqL1xyXG4gIHNldENoYW5nZXModmFsdWU6IE1vZGlmaWNhdGlvbik6IHZvaWQge1xyXG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gdmFsdWUucGF0aFt2YWx1ZS5wYXRoLmxlbmd0aCAtIDFdO1xyXG4gICAgY29uc3QgcHJlVmFsdWUgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmRhdGEpO1xyXG4gICAgdGhpcy5uZXdEYXRhID0gT2JqZWN0LmFzc2lnbih0aGlzLm5ld0RhdGEsIHsgW3Byb3BlcnR5TmFtZV06IHZhbHVlLnZhbHVlIH0pO1xyXG4gICAgbGV0IHBhcmVudFBhdGggPSB2YWx1ZS5wYXRoO1xyXG4gICAgaWYgKHZhbHVlLnBhdGgubGVuZ3RoID4gMikge1xyXG4gICAgICBwYXJlbnRQYXRoID0gdmFsdWUucGF0aC5zbGljZSgwLCB2YWx1ZS5wYXRoLmxlbmd0aCAtIDIpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIOe7n+S4gOS4jeS9v+eUqOaehOmAoOWHveaVsO+8iOS/neaMgeWSjOWFtuS7luS9jee9ruWvuU1vZGlmaWNhdGlvbueahOaehOmAoOS4gOiHtO+8iVxyXG4gICAgLy8gY29uc3QgcGFyZW50TW9kaWZpY2F0aW9uID0gbmV3IE1vZGlmaWNhdGlvbih0aGlzLmRhdGEsIHZhbHVlLnR5cGUsIHBhcmVudFBhdGgsIHByZVZhbHVlKTtcclxuICAgIGNvbnN0IHBhcmVudE1vZGlmaWNhdGlvbjogTW9kaWZpY2F0aW9uID0ge1xyXG4gICAgICBwYXRoOiBwYXJlbnRQYXRoLFxyXG4gICAgICB2YWx1ZTogdGhpcy5kYXRhLFxyXG4gICAgICBwcmVWYWx1ZTogcHJlVmFsdWUsXHJcbiAgICAgIHR5cGU6IHZhbHVlLnR5cGVcclxuICAgIH07XHJcblxyXG4gICAgdGhpcy52YWx1ZUNoYW5nZWQubmV4dChwYXJlbnRNb2RpZmljYXRpb24pO1xyXG4gICAgdGhpcy5jaGFuZ2VTZXQuYXBwZW5kKHZhbHVlKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHRvSlNPTlxyXG4gICAqL1xyXG4gIHB1YmxpYyB0b0pTT04oKSB7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhO1xyXG4gIH1cclxufVxyXG4iXX0=