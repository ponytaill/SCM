/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, Subject } from "rxjs";
/**
 * 保存方案API
 * @type {?}
 */
var SCHEME_WEBAPI = '/api/runtime/sys/v1.0/querysolution';
/**
 * 获取方案列表API
 * @type {?}
 */
var SCHEME_WEBAPI_QUERY = SCHEME_WEBAPI + "/belongId/";
/**
 * 方案列表管理- 设默认、删除 API
 * @type {?}
 */
var SCHEME_WEBAPI_UPDATE = SCHEME_WEBAPI + "/batch";
/**
 * 权限验证
 * @type {?}
 */
var SCHEME_WEBAPI_Auth = '/api/runtime/sys/v1.0/querysolution/componentType/Datagrid';
/** @type {?} */
var LANGUAGE_WEBAPI = '/api/runtime/sys/v1.0/loginInfo?infoType=supportedLanguage';
var DatagridSchemeService = /** @class */ (function () {
    function DatagridSchemeService() {
        this.restService = null;
        this.state = {};
        this.schemeList$ = new Subject();
    }
    /**
     * @param {?} d
     * @param {?} gridId
     * @return {?}
     */
    DatagridSchemeService.prototype.update = /**
     * @param {?} d
     * @param {?} gridId
     * @return {?}
     */
    function (d, gridId) {
        if (!this.state[gridId]) {
            this.state[gridId] = {};
        }
        this.state[gridId] = Object.assign(this.state[gridId], d);
    };
    /**
     * @param {?} httpSer
     * @return {?}
     */
    DatagridSchemeService.prototype.setRestService = /**
     * @param {?} httpSer
     * @return {?}
     */
    function (httpSer) {
        if (httpSer && httpSer['befRepository']) {
            this.restService = httpSer['befRepository']['restService'];
        }
    };
    /**
     * @private
     * @return {?}
     */
    DatagridSchemeService.prototype.getWebFormKey = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var webformHash = window.location.hash.split('?')[0];
        return webformHash.substring(webformHash.lastIndexOf('/') + 1);
    };
    /**
     * @param {?} gridId
     * @return {?}
     */
    DatagridSchemeService.prototype.getSchemeKey = /**
     * @param {?} gridId
     * @return {?}
     */
    function (gridId) {
        /** @type {?} */
        var formKey = this.getWebFormKey();
        return formKey + "_DatagridScheme_" + gridId;
    };
    /**
     * @param {?} gridID
     * @return {?}
     */
    DatagridSchemeService.prototype.getSchemeList = /**
     * @param {?} gridID
     * @return {?}
     */
    function (gridID) {
        /** @type {?} */
        var uri = SCHEME_WEBAPI_QUERY + this.getSchemeKey(gridID);
        if (this.restService) {
            return this.restService.invoke(uri, 'GET', null, null, false);
        }
    };
    /**
     * @param {?} scheme
     * @param {?} gridID
     * @param {?=} isUpdate
     * @return {?}
     */
    DatagridSchemeService.prototype.saveScheme = /**
     * @param {?} scheme
     * @param {?} gridID
     * @param {?=} isUpdate
     * @return {?}
     */
    function (scheme, gridID, isUpdate) {
        if (isUpdate === void 0) { isUpdate = false; }
        if (this.restService) {
            /** @type {?} */
            var httpMethod = isUpdate ? 'PUT' : 'POST';
            scheme.belongId = this.getSchemeKey(gridID);
            return this.restService.invoke(SCHEME_WEBAPI, httpMethod, null, { body: scheme }, false);
        }
    };
    /**
     * @param {?} param
     * @param {?} gridID
     * @return {?}
     */
    DatagridSchemeService.prototype.updateScheme = /**
     * @param {?} param
     * @param {?} gridID
     * @return {?}
     */
    function (param, gridID) {
        if (!param) {
            return of(false);
        }
        /** @type {?} */
        var belongId = this.getSchemeKey(gridID);
        param.belongId = belongId;
        if (param.belongId) {
            return this.restService.invoke(SCHEME_WEBAPI_UPDATE, 'PUT', null, { body: param }, false);
        }
    };
    /**
     * @param {?} gridId
     * @param {...?} statePro
     * @return {?}
     */
    DatagridSchemeService.prototype.getStateValue = /**
     * @param {?} gridId
     * @param {...?} statePro
     * @return {?}
     */
    function (gridId) {
        var statePro = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            statePro[_i - 1] = arguments[_i];
        }
        /** @type {?} */
        var dgState = this.state[gridId];
        if (dgState) {
            if (statePro && statePro.length) {
                return statePro.reduce((/**
                 * @param {?} r
                 * @param {?} c
                 * @return {?}
                 */
                function (r, c) {
                    return r[c];
                }), dgState);
            }
            return dgState;
        }
        return null;
    };
    /**
     * @private
     * @param {?} gridId
     * @param {?} propertyName
     * @param {?} value
     * @return {?}
     */
    DatagridSchemeService.prototype.updateStateValue = /**
     * @private
     * @param {?} gridId
     * @param {?} propertyName
     * @param {?} value
     * @return {?}
     */
    function (gridId, propertyName, value) {
        var _a;
        this.update((_a = {}, _a[propertyName] = value, _a), gridId);
    };
    /**
     * @param {?} gridId
     * @param {?} newSchemeList
     * @return {?}
     */
    DatagridSchemeService.prototype.setSchemeList = /**
     * @param {?} gridId
     * @param {?} newSchemeList
     * @return {?}
     */
    function (gridId, newSchemeList) {
        this.updateStateValue(gridId, 'list', newSchemeList);
        this.schemeList$.next(newSchemeList);
    };
    /**
     * @param {?} gridId
     * @param {?} schemeName
     * @return {?}
     */
    DatagridSchemeService.prototype.hasSchemeName = /**
     * @param {?} gridId
     * @param {?} schemeName
     * @return {?}
     */
    function (gridId, schemeName) {
        /** @type {?} */
        var schemeList = this.getStateValue(gridId, 'list');
        if (!schemeList || !schemeList.length) {
            return false;
        }
        if (typeof schemeName === 'string') {
            return !!schemeList.find((/**
             * @param {?} n
             * @return {?}
             */
            function (n) { return n.name === schemeName.trim(); }));
        }
        else {
            if (typeof schemeName === 'object') {
                /** @type {?} */
                var replayNames_1 = [];
                schemeList.forEach((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) {
                    /** @type {?} */
                    var currentNames = Object.values(n.name);
                    for (var k in schemeName) {
                        if (currentNames.includes(schemeName[k])) {
                            replayNames_1.push(k);
                        }
                    }
                }));
                return replayNames_1;
            }
        }
    };
    /**
     * @return {?}
     */
    DatagridSchemeService.prototype.checkAuthority = /**
     * @return {?}
     */
    function () {
        return this.restService.invoke(SCHEME_WEBAPI_Auth, 'GET', null, null, false);
    };
    /**
     * @return {?}
     */
    DatagridSchemeService.prototype.getLanguages = /**
     * @return {?}
     */
    function () {
        return this.restService.invoke(LANGUAGE_WEBAPI, 'GET', null, null, false);
    };
    return DatagridSchemeService;
}());
export { DatagridSchemeService };
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.state;
    /** @type {?} */
    DatagridSchemeService.prototype.schemeList$;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc2NoZW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLXNldHRpbmdzLyIsInNvdXJjZXMiOlsibGliL2RhdGFncmlkLXNjaGVtZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7Ozs7SUFLekMsYUFBYSxHQUFHLHFDQUFxQzs7Ozs7SUFFckQsbUJBQW1CLEdBQU0sYUFBYSxlQUFZOzs7OztJQUVsRCxvQkFBb0IsR0FBTSxhQUFhLFdBQVE7Ozs7O0lBRS9DLGtCQUFrQixHQUFHLDREQUE0RDs7SUFFakYsZUFBZSxHQUFHLDREQUE0RDtBQUdwRjtJQU1JO1FBTFEsZ0JBQVcsR0FBRyxJQUFJLENBQUM7UUFDbkIsVUFBSyxHQUFrQixFQUFFLENBQUM7UUFFbEMsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0lBRzVCLENBQUM7Ozs7OztJQUVELHNDQUFNOzs7OztJQUFOLFVBQU8sQ0FBYyxFQUFFLE1BQWM7UUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDM0I7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDOzs7OztJQUVELDhDQUFjOzs7O0lBQWQsVUFBZSxPQUFZO1FBQ3ZCLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUM5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TCxDQUFDOzs7O0lBRUQsOENBQWM7OztJQUFkO1FBQ0ksT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNqRixDQUFDOzs7O0lBRUQsNENBQVk7OztJQUFaO1FBQ0ksT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDOUUsQ0FBQztJQUNMLDRCQUFDO0FBQUQsQ0FBQyxBQWxIRCxJQWtIQzs7Ozs7OztJQWpIRyw0Q0FBMkI7Ozs7O0lBQzNCLHNDQUFrQzs7SUFFbEMsNENBQTRCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YmplY3QgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tIFwicnhqcy9vcGVyYXRvcnNcIjtcclxuaW1wb3J0IHsgQmF0Y2hTY2hlbWUsIERhdGFncmlkU2NoZW1lTW9kZWwsIERnU2NoZW1lU3RhdGUsIFNjaGVtZUF1dGhNb2RlbCwgU2NoZW1lU3RhdGUgfSBmcm9tIFwiLi9zZXR0aW5nLm1vZGVsXCI7XHJcblxyXG4vKiog5L+d5a2Y5pa55qGIQVBJICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUEkgPSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL3F1ZXJ5c29sdXRpb24nO1xyXG4vKiog6I635Y+W5pa55qGI5YiX6KGoQVBJICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUElfUVVFUlkgPSBgJHtTQ0hFTUVfV0VCQVBJfS9iZWxvbmdJZC9gO1xyXG4vKiog5pa55qGI5YiX6KGo566h55CGLSDorr7pu5jorqTjgIHliKDpmaQgQVBJICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUElfVVBEQVRFID0gYCR7U0NIRU1FX1dFQkFQSX0vYmF0Y2hgO1xyXG4vKiog5p2D6ZmQ6aqM6K+BICovXHJcbmNvbnN0IFNDSEVNRV9XRUJBUElfQXV0aCA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvcXVlcnlzb2x1dGlvbi9jb21wb25lbnRUeXBlL0RhdGFncmlkJztcclxuXHJcbmNvbnN0IExBTkdVQUdFX1dFQkFQSSA9ICcvYXBpL3J1bnRpbWUvc3lzL3YxLjAvbG9naW5JbmZvP2luZm9UeXBlPXN1cHBvcnRlZExhbmd1YWdlJztcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YWdyaWRTY2hlbWVTZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgcmVzdFNlcnZpY2UgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBzdGF0ZTogRGdTY2hlbWVTdGF0ZSA9IHt9O1xyXG5cclxuICAgIHNjaGVtZUxpc3QkID0gbmV3IFN1YmplY3QoKTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUoZDogU2NoZW1lU3RhdGUsIGdyaWRJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCF0aGlzLnN0YXRlW2dyaWRJZF0pIHtcclxuICAgICAgICAgICAgdGhpcy5zdGF0ZVtncmlkSWRdID0ge307XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuc3RhdGVbZ3JpZElkXSA9IE9iamVjdC5hc3NpZ24odGhpcy5zdGF0ZVtncmlkSWRdLCBkKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRSZXN0U2VydmljZShodHRwU2VyOiBhbnkpIHtcclxuICAgICAgICBpZiAoaHR0cFNlciAmJiBodHRwU2VyWydiZWZSZXBvc2l0b3J5J10pIHtcclxuICAgICAgICAgICAgdGhpcy5yZXN0U2VydmljZSA9IGh0dHBTZXJbJ2JlZlJlcG9zaXRvcnknXVsncmVzdFNlcnZpY2UnXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRXZWJGb3JtS2V5KCkge1xyXG4gICAgICAgIGNvbnN0IHdlYmZvcm1IYXNoID0gd2luZG93LmxvY2F0aW9uLmhhc2guc3BsaXQoJz8nKVswXTtcclxuICAgICAgICByZXR1cm4gd2ViZm9ybUhhc2guc3Vic3RyaW5nKHdlYmZvcm1IYXNoLmxhc3RJbmRleE9mKCcvJykgKyAxKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTY2hlbWVLZXkoZ3JpZElkOiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCBmb3JtS2V5ID0gdGhpcy5nZXRXZWJGb3JtS2V5KCk7XHJcbiAgICAgICAgcmV0dXJuIGAke2Zvcm1LZXl9X0RhdGFncmlkU2NoZW1lXyR7Z3JpZElkfWA7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2NoZW1lTGlzdChncmlkSUQ6IHN0cmluZyk6IE9ic2VydmFibGU8RGF0YWdyaWRTY2hlbWVNb2RlbFtdPiB7XHJcbiAgICAgICAgY29uc3QgdXJpID0gU0NIRU1FX1dFQkFQSV9RVUVSWSArIHRoaXMuZ2V0U2NoZW1lS2V5KGdyaWRJRCk7XHJcbiAgICAgICAgaWYgKHRoaXMucmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKHVyaSwgJ0dFVCcsIG51bGwsIG51bGwsIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2F2ZVNjaGVtZShzY2hlbWU6IERhdGFncmlkU2NoZW1lTW9kZWwsIGdyaWRJRDogc3RyaW5nLCBpc1VwZGF0ZSA9IGZhbHNlKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucmVzdFNlcnZpY2UpIHtcclxuICAgICAgICAgICAgY29uc3QgaHR0cE1ldGhvZCA9IGlzVXBkYXRlID8gJ1BVVCc6ICdQT1NUJztcclxuICAgICAgICAgICAgc2NoZW1lLmJlbG9uZ0lkID0gdGhpcy5nZXRTY2hlbWVLZXkoZ3JpZElEKTtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKFNDSEVNRV9XRUJBUEksIGh0dHBNZXRob2QsIG51bGwsIHsgYm9keTogc2NoZW1lfSwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGVTY2hlbWUocGFyYW06IEJhdGNoU2NoZW1lLCBncmlkSUQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgaWYgKCFwYXJhbSkge1xyXG4gICAgICAgICAgICByZXR1cm4gb2YoZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBiZWxvbmdJZCA9IHRoaXMuZ2V0U2NoZW1lS2V5KGdyaWRJRCk7XHJcbiAgICAgICAgcGFyYW0uYmVsb25nSWQgPSBiZWxvbmdJZFxyXG5cclxuICAgICAgICBpZiAocGFyYW0uYmVsb25nSWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKFNDSEVNRV9XRUJBUElfVVBEQVRFLCAnUFVUJywgbnVsbCwge2JvZHk6IHBhcmFtfSwgZmFsc2UpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZXRTdGF0ZVZhbHVlKGdyaWRJZCwgLi4uc3RhdGVQcm8pIHtcclxuICAgICAgICBjb25zdCBkZ1N0YXRlID0gdGhpcy5zdGF0ZVtncmlkSWRdO1xyXG4gICAgICAgIGlmIChkZ1N0YXRlKSB7XHJcbiAgICAgICAgICAgIGlmIChzdGF0ZVBybyAmJiBzdGF0ZVByby5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBzdGF0ZVByby5yZWR1Y2UoKHIsIGMpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcltjXTtcclxuICAgICAgICAgICAgICAgIH0sIGRnU3RhdGUpXHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBkZ1N0YXRlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHVwZGF0ZVN0YXRlVmFsdWUoZ3JpZElkLCBwcm9wZXJ0eU5hbWUsIHZhbHVlKSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGUoe1twcm9wZXJ0eU5hbWVdOiB2YWx1ZX0sIGdyaWRJZCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0U2NoZW1lTGlzdChncmlkSWQsIG5ld1NjaGVtZUxpc3QpIHtcclxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlVmFsdWUoZ3JpZElkLCAnbGlzdCcsIG5ld1NjaGVtZUxpc3QpO1xyXG4gICAgICAgIHRoaXMuc2NoZW1lTGlzdCQubmV4dChuZXdTY2hlbWVMaXN0KTtcclxuICAgIH1cclxuXHJcbiAgICBoYXNTY2hlbWVOYW1lKGdyaWRJZCwgc2NoZW1lTmFtZTogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgc2NoZW1lTGlzdCA9IHRoaXMuZ2V0U3RhdGVWYWx1ZShncmlkSWQsICdsaXN0Jyk7XHJcbiAgICAgICAgaWYgKCFzY2hlbWVMaXN0IHx8ICFzY2hlbWVMaXN0Lmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodHlwZW9mIHNjaGVtZU5hbWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAhIXNjaGVtZUxpc3QuZmluZChuID0+IG4ubmFtZSA9PT0gc2NoZW1lTmFtZS50cmltKCkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Ygc2NoZW1lTmFtZSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHJlcGxheU5hbWVzID0gW107XHJcbiAgICAgICAgICAgICAgICBzY2hlbWVMaXN0LmZvckVhY2gobiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVudE5hbWVzID0gT2JqZWN0LnZhbHVlcyhuLm5hbWUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGZvcihsZXQgayBpbiBzY2hlbWVOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50TmFtZXMuaW5jbHVkZXMoc2NoZW1lTmFtZVtrXSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxheU5hbWVzLnB1c2goayk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVwbGF5TmFtZXM7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2hlY2tBdXRob3JpdHkoKTogT2JzZXJ2YWJsZTxTY2hlbWVBdXRoTW9kZWw+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UoU0NIRU1FX1dFQkFQSV9BdXRoLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldExhbmd1YWdlcygpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZXN0U2VydmljZS5pbnZva2UoTEFOR1VBR0VfV0VCQVBJLCAnR0VUJywgbnVsbCwgbnVsbCwgZmFsc2UpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==