import { ModifyType } from "../changeset";
import { Entity } from "./entity";
import { DynamicFactory, EntityFactory } from "./entity_factory";
import { EntityList } from "./entity_list";
import { FieldMetadataUtil } from "./metadata";
import { PARENT_CLASS, PARENT_PATH } from "./types";
export class EntityTypeCreator {
    static create(constructor, data) {
        const entityType = this.getType(constructor);
        const entity = new entityType(data);
        entity.constructor = constructor;
        return entity;
    }
    // @Cache({ key: ((context: any, args: any[]) => { return args[0] }), provider: new MemoryCacheProvider() })
    static createType(constructor) {
        const entityType = class EntityType extends Entity {
            constructor(data) {
                super(data);
            }
        };
        const entityPrototype = entityType.prototype;
        this.extendProperties(constructor, entityPrototype);
        return entityType;
    }
    static extendProperties(constructor, entityPrototype) {
        const ngFields = FieldMetadataUtil.getNgFields(constructor);
        const ngObjects = FieldMetadataUtil.getNgObjects(constructor);
        const ngLists = FieldMetadataUtil.getNgList(constructor);
        const ngDynamic = FieldMetadataUtil.getNgDynamic(constructor);
        this.extendPlainProperty(entityPrototype, ngFields);
        this.extendListProperty(entityPrototype, ngLists);
        this.extendObjectProperty(entityPrototype, ngObjects);
        this.extendDynamicProperty(entityPrototype, ngDynamic);
    }
    static extendPlainProperty(entityPrototype, ngFields) {
        Object.keys(ngFields).forEach(function (propName) {
            const ngField = ngFields[propName];
            // const dataField = ngField.dataField || propName;
            Object.defineProperty(entityPrototype, propName, {
                get: function () {
                    const value = this.getPropValue(propName, ngField);
                    return value;
                },
                set: function (newPropValue) {
                    // 值相同时不触发变更。
                    const oldPropValue = this.getPropValue(propName, ngField);
                    if (this.isPropValueChanged(propName, ngField, newPropValue, oldPropValue) === false) {
                        return;
                    }
                    this.setPropValue(propName, ngField, newPropValue);
                    const changeSetValue = this.preparePropValue(propName, ngField, newPropValue);
                    this.emitValueChange(propName, ngField, newPropValue, oldPropValue, changeSetValue);
                }
            });
        });
    }
    static extendListProperty(entityPrototype, ngListMetadata) {
        Object.keys(ngListMetadata).forEach(function (propertyName) {
            const key = `__${propertyName}__`;
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    let entityList = this[key];
                    if (!entityList) {
                        const fieldMetadata = ngListMetadata[propertyName];
                        const path = this.createPath(propertyName);
                        const dataField = fieldMetadata.dataField || propertyName;
                        const val = this.data[dataField];
                        entityList = new EntityList();
                        entityList[PARENT_CLASS] = this;
                        entityList[PARENT_PATH] = path;
                        if (val) {
                            const entities = val.map(v => EntityFactory(fieldMetadata.type, v));
                            entityList.loadEntities(entities);
                        }
                        entityList.onListChanged.subscribe(value => {
                            if (value) {
                                if (entityList[PARENT_PATH][0] !== value.path[0]) {
                                    value.path = entityList[PARENT_PATH].concat(value.path);
                                }
                                this.setChanges(value);
                            }
                        });
                        this[key] = entityList;
                    }
                    return entityList;
                },
                set: function (value) {
                    this[key] = value;
                }
            });
        });
    }
    static extendObjectProperty(entityPrototype, ngObjectMetadata) {
        Object.keys(ngObjectMetadata).forEach(function (propertyName) {
            const fieldMetadata = ngObjectMetadata[propertyName];
            const key = `__${propertyName}__`;
            // 如果没有值用一个空对象代替
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    let childEntity = this[key];
                    const path = this.createPath(propertyName);
                    if (!childEntity) {
                        const dataField = fieldMetadata.dataField || propertyName;
                        // val不存在时，用空对象代替
                        const val = this.data[dataField] || {};
                        childEntity = EntityTypeCreator.buildEntity(path, val, this, fieldMetadata);
                        this[key] = childEntity;
                    }
                    return childEntity;
                },
                set: function (value) {
                    const path = this.createPath(propertyName);
                    const modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    const childEntity = EntityTypeCreator.buildEntity(path, value, this, fieldMetadata);
                    this[key] = childEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    }
    static extendDynamicProperty(entityPrototype, ngDynamicMetadata) {
        Object.keys(ngDynamicMetadata).forEach(function (propertyName) {
            const fieldMetadata = ngDynamicMetadata[propertyName];
            const key = `__${propertyName}__`;
            Object.defineProperty(entityPrototype, propertyName, {
                get: function () {
                    let dynamicEntity = this[key];
                    const path = this.createPath(propertyName);
                    if (!dynamicEntity) {
                        const dataField = fieldMetadata.dataField || propertyName;
                        const originalData = this.data[dataField] || {};
                        dynamicEntity = EntityTypeCreator.buildDynamic(path, originalData, this, fieldMetadata);
                        this[key] = dynamicEntity;
                    }
                    return dynamicEntity;
                },
                set: function (value) {
                    const path = this.createPath(propertyName);
                    const modifyInfo = {
                        path: path,
                        value: value.data,
                        preValue: this[propertyName].data,
                        type: ModifyType.ValueChange
                    };
                    let dynamicEntity = EntityTypeCreator.buildDynamic(path, value, this, fieldMetadata);
                    this[key] = dynamicEntity;
                    this.setChanges(modifyInfo);
                }
            });
        });
    }
    static getType(constructor) {
        if (this.buffer.has(constructor)) {
            return this.buffer.get(constructor);
        }
        const entityType = this.createType(constructor);
        this.buffer.set(constructor, entityType);
        return entityType;
    }
    static buildEntity(parentPath, value, parent, fieldMetadata) {
        let instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = EntityFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(changes => {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                parent.setChanges(changes);
            }
        });
        return instance;
    }
    static buildDynamic(parentPath, value, parent, fieldMetadata) {
        let instance;
        if (value instanceof fieldMetadata.type) {
            instance = value;
        }
        else {
            instance = DynamicFactory(fieldMetadata.type, value);
        }
        instance[PARENT_CLASS] = parent;
        instance[PARENT_PATH] = parentPath;
        instance.onValueChanged.subscribe(changes => {
            if (changes) {
                changes.path = (parent[PARENT_PATH] || []).concat(changes.path);
                parent.setChanges(changes);
            }
        });
        return instance;
    }
}
EntityTypeCreator.buffer = new Map();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X3R5cGVfY3JlYXRvci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvZGV2a2l0LyIsInNvdXJjZXMiOlsibGliL2VudGl0eS9lbnRpdHlfdHlwZV9jcmVhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDMUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNsQyxPQUFPLEVBQUUsY0FBYyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGlCQUFpQixFQUF3RSxNQUFNLFlBQVksQ0FBQztBQUNySCxPQUFPLEVBQWEsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUUvRCxNQUFNLE9BQU8saUJBQWlCO0lBRXJCLE1BQU0sQ0FBQyxNQUFNLENBQUMsV0FBcUIsRUFBRSxJQUFTO1FBQ25ELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDN0MsTUFBTSxNQUFNLEdBQUcsSUFBSSxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsTUFBTSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDakMsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNELDRHQUE0RztJQUNyRyxNQUFNLENBQUMsVUFBVSxDQUFDLFdBQXFCO1FBQzVDLE1BQU0sVUFBVSxHQUFHLE1BQU0sVUFBVyxTQUFRLE1BQU07WUFDaEQsWUFBWSxJQUFTO2dCQUNuQixLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDZCxDQUFDO1NBQ0YsQ0FBQztRQUNGLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7UUFDN0MsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxlQUFlLENB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R0FBRyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNoRSxNQUFNLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQzVCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDOztBQWpNYyx3QkFBTSxHQUFHLElBQUksR0FBRyxFQUFZLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNb2RpZnlUeXBlIH0gZnJvbSBcIi4uL2NoYW5nZXNldFwiO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tIFwiLi9lbnRpdHlcIjtcclxuaW1wb3J0IHsgRHluYW1pY0ZhY3RvcnksIEVudGl0eUZhY3RvcnkgfSBmcm9tIFwiLi9lbnRpdHlfZmFjdG9yeVwiO1xyXG5pbXBvcnQgeyBFbnRpdHlMaXN0IH0gZnJvbSBcIi4vZW50aXR5X2xpc3RcIjtcclxuaW1wb3J0IHsgRmllbGRNZXRhZGF0YVV0aWwsIE5nRHluYW1pY1Byb3BlcnR5LCBOZ0ZpZWxkUHJvcGVydHksIE5nTGlzdFByb3BlcnR5LCBOZ09iamVjdFByb3BlcnR5IH0gZnJvbSBcIi4vbWV0YWRhdGFcIjtcclxuaW1wb3J0IHsgQ2xhc3NUeXBlLCBQQVJFTlRfQ0xBU1MsIFBBUkVOVF9QQVRIIH0gZnJvbSBcIi4vdHlwZXNcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBFbnRpdHlUeXBlQ3JlYXRvciB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgYnVmZmVyID0gbmV3IE1hcDxhbnksIGFueT4oKTtcclxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZShjb25zdHJ1Y3RvcjogRnVuY3Rpb24sIGRhdGE6IGFueSk6IEVudGl0eSB7XHJcbiAgICBjb25zdCBlbnRpdHlUeXBlID0gdGhpcy5nZXRUeXBlKGNvbnN0cnVjdG9yKTtcclxuICAgIGNvbnN0IGVudGl0eSA9IG5ldyBlbnRpdHlUeXBlKGRhdGEpO1xyXG4gICAgZW50aXR5LmNvbnN0cnVjdG9yID0gY29uc3RydWN0b3I7XHJcbiAgICByZXR1cm4gZW50aXR5O1xyXG4gIH1cclxuICAvLyBAQ2FjaGUoeyBrZXk6ICgoY29udGV4dDogYW55LCBhcmdzOiBhbnlbXSkgPT4geyByZXR1cm4gYXJnc1swXSB9KSwgcHJvdmlkZXI6IG5ldyBNZW1vcnlDYWNoZVByb3ZpZGVyKCkgfSlcclxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZVR5cGUoY29uc3RydWN0b3I6IEZ1bmN0aW9uKTogQ2xhc3NUeXBlPEVudGl0eT4ge1xyXG4gICAgY29uc3QgZW50aXR5VHlwZSA9IGNsYXNzIEVudGl0eVR5cGUgZXh0ZW5kcyBFbnRpdHkge1xyXG4gICAgICBjb25zdHJ1Y3RvcihkYXRhOiBhbnkpIHtcclxuICAgICAgICBzdXBlcihkYXRhKTtcclxuICAgICAgfVxyXG4gICAgfTtcclxuICAgIGNvbnN0IGVudGl0eVByb3RvdHlwZSA9IGVudGl0eVR5cGUucHJvdG90eXBlO1xyXG4gICAgdGhpcy5leHRlbmRQcm9wZXJ0aWVzKGNvbnN0cnVjdG9yLCBlbnRpdHlQcm90b3R5cGUpO1xyXG4gICAgcmV0dXJuIGVudGl0eVR5cGU7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZFByb3BlcnRpZXMoY29uc3RydWN0b3I6IEZ1bmN0aW9uLCBlbnRpdHlQcm90b3R5cGU6IEVudGl0eSkge1xyXG4gICAgY29uc3QgbmdGaWVsZHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0ZpZWxkcyhjb25zdHJ1Y3Rvcik7XHJcbiAgICBjb25zdCBuZ09iamVjdHMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ09iamVjdHMoY29uc3RydWN0b3IpO1xyXG4gICAgY29uc3QgbmdMaXN0cyA9IEZpZWxkTWV0YWRhdGFVdGlsLmdldE5nTGlzdChjb25zdHJ1Y3Rvcik7XHJcbiAgICBjb25zdCBuZ0R5bmFtaWMgPSBGaWVsZE1ldGFkYXRhVXRpbC5nZXROZ0R5bmFtaWMoY29uc3RydWN0b3IpO1xyXG4gICAgdGhpcy5leHRlbmRQbGFpblByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgbmdGaWVsZHMpO1xyXG4gICAgdGhpcy5leHRlbmRMaXN0UHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBuZ0xpc3RzKTtcclxuICAgIHRoaXMuZXh0ZW5kT2JqZWN0UHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBuZ09iamVjdHMpO1xyXG4gICAgdGhpcy5leHRlbmREeW5hbWljUHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBuZ0R5bmFtaWMpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kUGxhaW5Qcm9wZXJ0eShlbnRpdHlQcm90b3R5cGU6IEVudGl0eSwgbmdGaWVsZHM6IHsgW2tleTogc3RyaW5nXTogTmdGaWVsZFByb3BlcnR5IH0pOiB2b2lkIHtcclxuICAgIE9iamVjdC5rZXlzKG5nRmllbGRzKS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wTmFtZSkge1xyXG4gICAgICBjb25zdCBuZ0ZpZWxkID0gbmdGaWVsZHNbcHJvcE5hbWVdIGFzIE5nRmllbGRQcm9wZXJ0eTtcclxuICAgICAgLy8gY29uc3QgZGF0YUZpZWxkID0gbmdGaWVsZC5kYXRhRmllbGQgfHwgcHJvcE5hbWU7XHJcbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGUsIHByb3BOYW1lLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0UHJvcFZhbHVlKHByb3BOYW1lLCBuZ0ZpZWxkKTtcclxuICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKG5ld1Byb3BWYWx1ZSkge1xyXG4gICAgICAgICAgLy8g5YC855u45ZCM5pe25LiN6Kem5Y+R5Y+Y5pu044CCXHJcbiAgICAgICAgICBjb25zdCBvbGRQcm9wVmFsdWUgPSB0aGlzLmdldFByb3BWYWx1ZShwcm9wTmFtZSwgbmdGaWVsZCk7XHJcbiAgICAgICAgICBpZiAodGhpcy5pc1Byb3BWYWx1ZUNoYW5nZWQocHJvcE5hbWUsIG5nRmllbGQsIG5ld1Byb3BWYWx1ZSwgb2xkUHJvcFZhbHVlKSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdGhpcy5zZXRQcm9wVmFsdWUocHJvcE5hbWUsIG5nRmllbGQsIG5ld1Byb3BWYWx1ZSk7XHJcbiAgICAgICAgICBjb25zdCBjaGFuZ2VTZXRWYWx1ZSA9IHRoaXMucHJlcGFyZVByb3BWYWx1ZShwcm9wTmFtZSwgbmdGaWVsZCwgbmV3UHJvcFZhbHVlKTtcclxuICAgICAgICAgIHRoaXMuZW1pdFZhbHVlQ2hhbmdlKHByb3BOYW1lLCBuZ0ZpZWxkLCBuZXdQcm9wVmFsdWUsIG9sZFByb3BWYWx1ZSwgY2hhbmdlU2V0VmFsdWUpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kTGlzdFByb3BlcnR5KGVudGl0eVByb3RvdHlwZTogRW50aXR5LCBuZ0xpc3RNZXRhZGF0YTogeyBba2V5OiBzdHJpbmddOiBOZ0xpc3RQcm9wZXJ0eSB9KTogdm9pZCB7XHJcbiAgICBPYmplY3Qua2V5cyhuZ0xpc3RNZXRhZGF0YSkuZm9yRWFjaChmdW5jdGlvbiAocHJvcGVydHlOYW1lKSB7XHJcbiAgICAgIGNvbnN0IGtleSA9IGBfXyR7cHJvcGVydHlOYW1lfV9fYDtcclxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICBsZXQgZW50aXR5TGlzdCA9IHRoaXNba2V5XTtcclxuICAgICAgICAgIGlmICghZW50aXR5TGlzdCkge1xyXG4gICAgICAgICAgICBjb25zdCBmaWVsZE1ldGFkYXRhID0gbmdMaXN0TWV0YWRhdGFbcHJvcGVydHlOYW1lXSBhcyBOZ0xpc3RQcm9wZXJ0eTtcclxuICAgICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuY3JlYXRlUGF0aChwcm9wZXJ0eU5hbWUpO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhRmllbGQgPSBmaWVsZE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wZXJ0eU5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZGF0YVtkYXRhRmllbGRdO1xyXG4gICAgICAgICAgICBlbnRpdHlMaXN0ID0gbmV3IEVudGl0eUxpc3Q8dHlwZW9mIGZpZWxkTWV0YWRhdGEudHlwZT4oKTtcclxuICAgICAgICAgICAgZW50aXR5TGlzdFtQQVJFTlRfQ0xBU1NdID0gdGhpcztcclxuICAgICAgICAgICAgZW50aXR5TGlzdFtQQVJFTlRfUEFUSF0gPSBwYXRoO1xyXG4gICAgICAgICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgICAgICAgY29uc3QgZW50aXRpZXMgPSB2YWwubWFwKHYgPT4gRW50aXR5RmFjdG9yeTx0eXBlb2YgZmllbGRNZXRhZGF0YS50eXBlPihmaWVsZE1ldGFkYXRhLnR5cGUsIHYpKTtcclxuICAgICAgICAgICAgICBlbnRpdHlMaXN0LmxvYWRFbnRpdGllcyhlbnRpdGllcyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZW50aXR5TGlzdC5vbkxpc3RDaGFuZ2VkLnN1YnNjcmliZSh2YWx1ZSA9PiB7XHJcbiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoZW50aXR5TGlzdFtQQVJFTlRfUEFUSF1bMF0gIT09IHZhbHVlLnBhdGhbMF0pIHtcclxuICAgICAgICAgICAgICAgICAgdmFsdWUucGF0aCA9IGVudGl0eUxpc3RbUEFSRU5UX1BBVEhdLmNvbmNhdCh2YWx1ZS5wYXRoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpc1trZXldID0gZW50aXR5TGlzdDtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiBlbnRpdHlMaXN0O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHtcclxuICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHJpdmF0ZSBzdGF0aWMgZXh0ZW5kT2JqZWN0UHJvcGVydHkoZW50aXR5UHJvdG90eXBlOiBFbnRpdHksIG5nT2JqZWN0TWV0YWRhdGE6IHsgW2tleTogc3RyaW5nXTogTmdPYmplY3RQcm9wZXJ0eSB9KSB7XHJcbiAgICBPYmplY3Qua2V5cyhuZ09iamVjdE1ldGFkYXRhKS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wZXJ0eU5hbWUpIHtcclxuICAgICAgY29uc3QgZmllbGRNZXRhZGF0YSA9IG5nT2JqZWN0TWV0YWRhdGFbcHJvcGVydHlOYW1lXSBhcyBOZ09iamVjdFByb3BlcnR5O1xyXG4gICAgICBjb25zdCBrZXkgPSBgX18ke3Byb3BlcnR5TmFtZX1fX2A7XHJcbiAgICAgIC8vIOWmguaenOayoeacieWAvOeUqOS4gOS4quepuuWvueixoeS7o+abv1xyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZW50aXR5UHJvdG90eXBlLCBwcm9wZXJ0eU5hbWUsIHtcclxuICAgICAgICBnZXQ6IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgIGxldCBjaGlsZEVudGl0eSA9IHRoaXNba2V5XTtcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGlmICghY2hpbGRFbnRpdHkpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0YUZpZWxkID0gZmllbGRNZXRhZGF0YS5kYXRhRmllbGQgfHwgcHJvcGVydHlOYW1lO1xyXG4gICAgICAgICAgICAvLyB2YWzkuI3lrZjlnKjml7bvvIznlKjnqbrlr7nosaHku6Pmm79cclxuICAgICAgICAgICAgY29uc3QgdmFsID0gdGhpcy5kYXRhW2RhdGFGaWVsZF0gfHwge307XHJcbiAgICAgICAgICAgIGNoaWxkRW50aXR5ID0gRW50aXR5VHlwZUNyZWF0b3IuYnVpbGRFbnRpdHkocGF0aCwgdmFsLCB0aGlzLCBmaWVsZE1ldGFkYXRhKTtcclxuICAgICAgICAgICAgdGhpc1trZXldID0gY2hpbGRFbnRpdHk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gY2hpbGRFbnRpdHk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZTogYW55KSB7XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBjb25zdCBtb2RpZnlJbmZvID0ge1xyXG4gICAgICAgICAgICBwYXRoOiBwYXRoLFxyXG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUuZGF0YSxcclxuICAgICAgICAgICAgcHJlVmFsdWU6IHRoaXNbcHJvcGVydHlOYW1lXS5kYXRhLFxyXG4gICAgICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgY29uc3QgY2hpbGRFbnRpdHkgPSBFbnRpdHlUeXBlQ3JlYXRvci5idWlsZEVudGl0eShwYXRoLCB2YWx1ZSwgdGhpcywgZmllbGRNZXRhZGF0YSk7XHJcbiAgICAgICAgICB0aGlzW2tleV0gPSBjaGlsZEVudGl0eTtcclxuICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhtb2RpZnlJbmZvKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGV4dGVuZER5bmFtaWNQcm9wZXJ0eShlbnRpdHlQcm90b3R5cGU6IEVudGl0eSwgbmdEeW5hbWljTWV0YWRhdGE6IHsgW2tleTogc3RyaW5nXTogTmdEeW5hbWljUHJvcGVydHkgfSkge1xyXG4gICAgT2JqZWN0LmtleXMobmdEeW5hbWljTWV0YWRhdGEpLmZvckVhY2goZnVuY3Rpb24gKHByb3BlcnR5TmFtZSkge1xyXG4gICAgICBjb25zdCBmaWVsZE1ldGFkYXRhID0gbmdEeW5hbWljTWV0YWRhdGFbcHJvcGVydHlOYW1lXSBhcyBOZ0R5bmFtaWNQcm9wZXJ0eTtcclxuICAgICAgY29uc3Qga2V5ID0gYF9fJHtwcm9wZXJ0eU5hbWV9X19gO1xyXG4gICAgICBcclxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVudGl0eVByb3RvdHlwZSwgcHJvcGVydHlOYW1lLCB7XHJcbiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICBsZXQgZHluYW1pY0VudGl0eSA9IHRoaXNba2V5XTtcclxuICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmNyZWF0ZVBhdGgocHJvcGVydHlOYW1lKTtcclxuICAgICAgICAgIGlmICghZHluYW1pY0VudGl0eSkge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhRmllbGQgPSBmaWVsZE1ldGFkYXRhLmRhdGFGaWVsZCB8fCBwcm9wZXJ0eU5hbWU7XHJcbiAgICAgICAgICAgIGNvbnN0IG9yaWdpbmFsRGF0YSA9IHRoaXMuZGF0YVtkYXRhRmllbGRdIHx8IHt9O1xyXG4gICAgICAgICAgICBkeW5hbWljRW50aXR5ID0gRW50aXR5VHlwZUNyZWF0b3IuYnVpbGREeW5hbWljKHBhdGgsIG9yaWdpbmFsRGF0YSwgdGhpcywgZmllbGRNZXRhZGF0YSk7XHJcbiAgICAgICAgICAgIHRoaXNba2V5XSA9IGR5bmFtaWNFbnRpdHk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICByZXR1cm4gZHluYW1pY0VudGl0eTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7XHJcbiAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5jcmVhdGVQYXRoKHByb3BlcnR5TmFtZSk7XHJcbiAgICAgICAgICBjb25zdCBtb2RpZnlJbmZvID0ge1xyXG4gICAgICAgICAgICBwYXRoOiBwYXRoLFxyXG4gICAgICAgICAgICB2YWx1ZTogdmFsdWUuZGF0YSxcclxuICAgICAgICAgICAgcHJlVmFsdWU6IHRoaXNbcHJvcGVydHlOYW1lXS5kYXRhLFxyXG4gICAgICAgICAgICB0eXBlOiBNb2RpZnlUeXBlLlZhbHVlQ2hhbmdlXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgbGV0IGR5bmFtaWNFbnRpdHkgPSBFbnRpdHlUeXBlQ3JlYXRvci5idWlsZER5bmFtaWMocGF0aCwgdmFsdWUsIHRoaXMsIGZpZWxkTWV0YWRhdGEpO1xyXG4gICAgICAgICAgdGhpc1trZXldID0gZHluYW1pY0VudGl0eTtcclxuICAgICAgICAgIHRoaXMuc2V0Q2hhbmdlcyhtb2RpZnlJbmZvKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHByaXZhdGUgc3RhdGljIGdldFR5cGUoY29uc3RydWN0b3I6IEZ1bmN0aW9uKSB7XHJcbiAgICBpZiAodGhpcy5idWZmZXIuaGFzKGNvbnN0cnVjdG9yKSkge1xyXG4gICAgICByZXR1cm4gdGhpcy5idWZmZXIuZ2V0KGNvbnN0cnVjdG9yKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGVudGl0eVR5cGUgPSB0aGlzLmNyZWF0ZVR5cGUoY29uc3RydWN0b3IpO1xyXG4gICAgdGhpcy5idWZmZXIuc2V0KGNvbnN0cnVjdG9yLCBlbnRpdHlUeXBlKTtcclxuICAgIHJldHVybiBlbnRpdHlUeXBlO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBidWlsZEVudGl0eShwYXJlbnRQYXRoOiBzdHJpbmdbXSwgdmFsdWU6IGFueSwgcGFyZW50OiBhbnksIGZpZWxkTWV0YWRhdGE6IE5nT2JqZWN0UHJvcGVydHkgfCBOZ0R5bmFtaWNQcm9wZXJ0eSkge1xyXG4gICAgbGV0IGluc3RhbmNlO1xyXG4gICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgZmllbGRNZXRhZGF0YS50eXBlKSB7XHJcbiAgICAgIGluc3RhbmNlID0gdmFsdWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpbnN0YW5jZSA9IEVudGl0eUZhY3RvcnkoZmllbGRNZXRhZGF0YS50eXBlLCB2YWx1ZSk7XHJcbiAgICB9XHJcbiAgICBpbnN0YW5jZVtQQVJFTlRfQ0xBU1NdID0gcGFyZW50O1xyXG4gICAgaW5zdGFuY2VbUEFSRU5UX1BBVEhdID0gcGFyZW50UGF0aDtcclxuICAgIGluc3RhbmNlLm9uVmFsdWVDaGFuZ2VkLnN1YnNjcmliZShjaGFuZ2VzID0+IHtcclxuICAgICAgaWYgKGNoYW5nZXMpIHtcclxuICAgICAgICBjaGFuZ2VzLnBhdGggPSAocGFyZW50W1BBUkVOVF9QQVRIXSB8fCBbXSkuY29uY2F0KGNoYW5nZXMucGF0aCk7XHJcbiAgICAgICAgcGFyZW50LnNldENoYW5nZXMoY2hhbmdlcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGluc3RhbmNlO1xyXG4gIH1cclxuICBwcml2YXRlIHN0YXRpYyBidWlsZER5bmFtaWMocGFyZW50UGF0aDogc3RyaW5nW10sIHZhbHVlOiBhbnksIHBhcmVudDogYW55LCBmaWVsZE1ldGFkYXRhOiBOZ09iamVjdFByb3BlcnR5IHwgTmdEeW5hbWljUHJvcGVydHkpIHtcclxuICAgIGxldCBpbnN0YW5jZTtcclxuICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIGZpZWxkTWV0YWRhdGEudHlwZSkge1xyXG4gICAgICBpbnN0YW5jZSA9IHZhbHVlO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaW5zdGFuY2UgPSBEeW5hbWljRmFjdG9yeShmaWVsZE1ldGFkYXRhLnR5cGUsIHZhbHVlKTtcclxuICAgIH1cclxuICAgIGluc3RhbmNlW1BBUkVOVF9DTEFTU10gPSBwYXJlbnQ7XHJcbiAgICBpbnN0YW5jZVtQQVJFTlRfUEFUSF0gPSBwYXJlbnRQYXRoO1xyXG4gICAgaW5zdGFuY2Uub25WYWx1ZUNoYW5nZWQuc3Vic2NyaWJlKGNoYW5nZXMgPT4ge1xyXG4gICAgICBpZiAoY2hhbmdlcykge1xyXG4gICAgICAgIGNoYW5nZXMucGF0aCA9IChwYXJlbnRbUEFSRU5UX1BBVEhdIHx8IFtdKS5jb25jYXQoY2hhbmdlcy5wYXRoKTtcclxuICAgICAgICBwYXJlbnQuc2V0Q2hhbmdlcyhjaGFuZ2VzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gaW5zdGFuY2U7XHJcbiAgfVxyXG59Il19