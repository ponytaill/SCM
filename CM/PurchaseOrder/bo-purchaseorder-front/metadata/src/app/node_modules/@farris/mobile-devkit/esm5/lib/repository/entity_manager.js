/*
 * @Author: Witt
 * @Date: 2019-03-07 17:24:38
 * @Last Modified by:   Witt
 * @Last Modified time: 2019-03-11 19:50:38
 */
import { createEntity, createEntities } from '../entity/index';
import { EntityCollection } from './entity_collection';
import { DataPathCreator, DataPathNodeType } from '../entity/index';
import { EntityUtil } from '../binding-data/entity_util';
/**
 * 实体管理类
 */
var EntityManager = /** @class */ (function () {
    /**
     * 构造函数
     */
    function EntityManager(entityCollection) {
        this.entityCollection = entityCollection;
        this.entityType = entityCollection.entityType;
    }
    // #region 创建实体相关方法
    /**
     * 创建实体
     */
    EntityManager.prototype.createEntity = function (entityData) {
        var entity = createEntity(this.entityType, entityData);
        return entity;
    };
    /**
     * 批量创建实体
     */
    EntityManager.prototype.createEntities = function (entityListData, entityType) {
        var entities = createEntities(this.entityType, entityListData);
        return entities;
    };
    // #endregion
    // #region 获取实体、实体数组相关方法
    /**
     * 获取path对应的实体
     */
    EntityManager.prototype.getEntityByPath = function (path) {
        var entity = this.getEntityNodeByPath(path);
        return entity;
    };
    /**
     * 获取path对应的实体
     */
    EntityManager.prototype.getEntitiesByPath = function (path) {
        var entityCollectionOrList = this.getEntityNodeByPath(path);
        var entities;
        if (entityCollectionOrList instanceof EntityCollection === true) {
            entities = entityCollectionOrList.toArray();
        }
        else {
            entities = entityCollectionOrList.toArray();
        }
        return entities;
    };
    /**
     * 获取实体节点
     * @param path 节点路径
     */
    EntityManager.prototype.getEntityNodeByPath = function (path) {
        var dataPath = DataPathCreator.createByLongPathFromRoot(path, this);
        var entityNode = this.entityCollection;
        var pathNode = dataPath.head.next;
        while (pathNode) {
            if (pathNode.type === DataPathNodeType.DataId) {
                if (entityNode instanceof EntityCollection === true) {
                    entityNode = entityNode.getEntityById(pathNode.value);
                }
                else {
                    entityNode = entityNode.get(pathNode.value);
                }
            }
            else {
                entityNode = entityNode[pathNode.value];
            }
            if (!entityNode) {
                throw new Error("\u627E\u4E0D\u5230" + pathNode.value + "\u5BF9\u5E94\u7684\u6570\u636E\u8282\u70B9");
            }
            pathNode = pathNode.next;
        }
        return entityNode;
    };
    // #endregion
    // #region 获取、设置属性值
    /**
     * 获取path对应的实体属性值
     */
    EntityManager.prototype.getPropValueByPath = function (path) {
        var propName = path.pop();
        var entity = this.getEntityByPath(path);
        return entity[propName];
    };
    /**
     * 设置path对应实体的属性值
     */
    EntityManager.prototype.setPropValueByPath = function (path, propValue) {
        var propName = path.pop();
        var entity = this.getEntityByPath(path);
        entity[propName] = propValue;
    };
    // #endregion
    // #region 插入实体
    /**
     * 在path对应实体前插入实体
     */
    EntityManager.prototype.insertEntityBeforeByPath = function (fpath) {
        throw new Error('Not Implemented');
    };
    /**
     * 在path对应实体前批量插入实体
     */
    EntityManager.prototype.insertEntitiesBeforeByPath = function () {
        throw new Error('Not Implemented');
    };
    /**
     * 在path对应实体前插入实体
     */
    EntityManager.prototype.insertEntityAfterByPath = function () {
        throw new Error('Not Implemented');
    };
    /**
     * 在path对应实体前批量插入实体
     */
    EntityManager.prototype.insertEntitiesAfterByPath = function () {
        throw new Error('Not Implemented');
    };
    // #endregion
    // #region 追加实体
    /**
     * 在path对应的实体集合中追加1个实体
     */
    // public appendEntityByPath(fpath: string[], entity: Entity): void {
    //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);
    //   if (entityCollectionOrList instanceof EntityCollection === true) {
    //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
    //     entityCollection.addEntity(entity);
    //   } else {
    //     const entityList = (entityCollectionOrList as EntityList<Entity>);
    //     entityList.appendEntity(entity);
    //   }
    // }
    /**
     * 根据path获取实体集合
     * @param fpath 路径
     * @param entityData 实体数据
     * @param initialData[可选] 默认值
     */
    EntityManager.prototype.appendEntityByPath = function (fpath, entityData, initialData) {
        var subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error("\u6839\u636Epath\u5220\u9664\u5B9E\u4F53\u6570\u636E\u51FA\u9519\u4E86\u3002\u4F20\u5165\u7684path[" + fpath + "]\u683C\u5F0F\u4E0D\u5BF9");
        }
        var childEntityList;
        var propInfo;
        var propName;
        for (var i = 2; i < subPaths.length; i = i + 2) {
            var fid = subPaths[i - 1];
            propName = subPaths[i];
            // todo: EntityCollection重构之后这里无需差异处理
            var parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            var entityType = propInfo ? propInfo.propEntityType : this.entityType;
            propInfo = EntityUtil.getPropInfo(entityType, propName);
            if (!childEntityList) {
                throw Error("fpath\u53C2\u6570\u9519\u8BEF\uFF0C\u65E0\u6CD5\u627E\u5230" + propName + "\u5BF9\u5E94\u7684\u5B50\u8868\u3002fpath\u4E3A\uFF1A" + fpath);
            }
        }
        // const propInfo = EntityUtil.getPropInfo(this.entityType, propName);
        var childEntity = createEntity(propInfo.propEntityType, entityData);
        // 在实体的实例上增加默认值属性，以便在createBindingObject时存放默认值
        if (initialData) {
            EntityUtil.appendInitialData(childEntity, initialData);
        }
        childEntityList.appendNew(childEntity);
        return childEntity;
    };
    /**
     * 在path对应的实体集合中追加多个实体
     */
    EntityManager.prototype.appendEntitiesByPath = function (fpath, entities) {
        var entityCollectionOrList = this.getEntityNodeByPath(fpath);
        if (entityCollectionOrList instanceof EntityCollection === true) {
            var entityCollection = entityCollectionOrList;
            entityCollection.addEntities(entities);
        }
        else {
            var entityList = entityCollectionOrList;
            entityList.appendEntities(entities);
        }
    };
    // #endregion
    // #region 删除实体
    /**
     * 从fapth对应的实体集合中删除id对应的实体
     */
    // public removeEntityByPath(fpath: string[], id: string): void {
    //   const entityCollectionOrList = this.getEntityNodeByPath(fpath);
    //   if (entityCollectionOrList instanceof EntityCollection === true) {
    //     const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
    //     entityCollection.removeEntityById(id);
    //   } else {
    //     const entityList = (entityCollectionOrList as EntityList<Entity>);
    //     entityList.remove(id);
    //   }
    // }
    /**
     * 根据path获取实体集合
     * @param fpath path
     */
    EntityManager.prototype.removeEntityByPath = function (fpath, id) {
        var subPaths = fpath.split('/');
        if (subPaths.length < 3) {
            throw Error("\u6839\u636Epath\u5220\u9664\u5B9E\u4F53\u6570\u636E\u51FA\u9519\u4E86\u3002\u4F20\u5165\u7684path[" + fpath + "]\u683C\u5F0F\u4E0D\u5BF9");
        }
        var childEntityList;
        for (var i = 2; i < subPaths.length; i = i + 2) {
            var fid = subPaths[i - 1];
            var propName = subPaths[i];
            var parentEntity = childEntityList ? childEntityList.get(fid) : this.entityCollection.getEntityById(fid);
            childEntityList = parentEntity[propName];
            if (!childEntityList) {
                throw Error("fpath\u53C2\u6570\u9519\u8BEF\uFF0C\u65E0\u6CD5\u627E\u5230" + propName + "\u5BF9\u5E94\u7684\u5B50\u8868\u3002fpath\u4E3A\uFF1A" + fpath);
            }
        }
        childEntityList.remove(id);
    };
    /**
     * 从fapth对应的实体集合中删除ids对应的实体
     */
    EntityManager.prototype.removeEntitiesByPath = function (fpath, ids) {
        // const entityCollectionOrList = this.getEntityNodeByPath(fpath);
        // if (entityCollectionOrList instanceof EntityCollection === true) {
        //   const entityCollection = entityCollectionOrList as EntityCollection<Entity>;
        //   entityCollection.removeEntitiesByIds(ids);
        // } else {
        //   const entityList = (entityCollectionOrList as EntityList<Entity>);
        //   entityList.remove(ids);
        // }
        throw new Error('Not Implemented');
    };
    // #endregion
    // #region 清空变更集相关方法
    /**
     * 清空所有实体的变更集
     */
    EntityManager.prototype.clearAllEntityChanges = function () {
        var entities = this.entityCollection.toArray();
        entities.forEach(function (entity) {
            entity.changes.splice(0, entity.changes.length);
        });
    };
    /**
     * 清空id指定的实体变更集
     */
    EntityManager.prototype.clearEntityChangesById = function (id) {
        var entity = this.entityCollection.getEntityById(id);
        if (!entity) {
            return;
        }
        entity.changes.splice(0, entity.changes.length);
    };
    /**
     * 清空ids数组中指定的实体的变更集
     */
    EntityManager.prototype.clearEntityChangesByIds = function (ids) {
        var _this = this;
        if (!ids || ids.length < 0) {
            return;
        }
        ids.forEach(function (id) {
            _this.clearEntityChangesById(id);
        });
    };
    // #endregion
    // #region 变更集检查相关方法
    /**
     * 检查所有的实体，是否有未提交的变更
     */
    EntityManager.prototype.checkAllEntityChanges = function () {
        var entities = this.entityCollection.toArray();
        var hasChanges = entities.some(function (entity) {
            if (entity.changes.length > 0) {
                return true;
            }
            else {
                return false;
            }
        });
        return hasChanges;
    };
    /**
     * 检查id对应的实体，是否有未提交的变更
     */
    EntityManager.prototype.checkEntityChangesById = function (id) {
        var entity = this.entityCollection.getEntityById(id);
        if (!entity) {
            return false;
        }
        return entity.changes.length > 0;
    };
    // #endregion
    // #region 不规范方法，待废弃
    /**
     * 待废弃
     * @deprecated
     */
    EntityManager.prototype.clearEntityChangesByArray = function (idArray) {
        this.clearEntityChangesByIds(idArray);
    };
    return EntityManager;
}());
export { EntityManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5X21hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvcmVwb3NpdG9yeS9lbnRpdHlfbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUdILE9BQU8sRUFBc0IsWUFBWSxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ25GLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBWSxlQUFlLEVBQUUsZ0JBQWdCLEVBQWdCLE1BQU0saUJBQWlCLENBQUM7QUFDNUYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBR3pEOztHQUVHO0FBQ0g7SUFZRTs7T0FFRztJQUNILHVCQUFZLGdCQUFxQztRQUMvQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUM7UUFDekMsSUFBSSxDQUFDLFVBQVUsR0FBRyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUM7SUFDaEQsQ0FBQztJQUdELG1CQUFtQjtJQUVuQjs7T0FFRztJQUNJLG9DQUFZLEdBQW5CLFVBQW9CLFVBQWU7UUFDakMsSUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFJLElBQUksQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDNUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ksc0NBQWMsR0FBckIsVUFBc0IsY0FBcUIsRUFBRSxVQUFlO1FBQzFELElBQU0sUUFBUSxHQUFRLGNBQWMsQ0FBSSxJQUFJLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3pFLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxhQUFhO0lBR2Isd0JBQXdCO0lBRXhCOztPQUVHO0lBQ0ksdUNBQWUsR0FBdEIsVUFBdUIsSUFBYztRQUNuQyxJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMs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O1FBQ2pELElBQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBQyxNQUFjO1lBQzlDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM3QixPQUFPLElBQUksQ0FBQzthQUNiO2lCQUFNO2dCQUNMLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sVUFBVSxDQUFDO0lBQ3BCLENBQUM7SUFFRDs7T0FFRztJQUNJLDhDQUFzQixHQUE3QixVQUE4QixFQUFVO1FBQ3RDLElBQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNYLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFDRCxPQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsYUFBYTtJQUdiLG9CQUFvQjtJQUVwQjs7O09BR0c7SUFDSSxpREFBeUIsR0FBaEMsVUFBaUMsT0FBaUI7UUFDaEQsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFJSCxvQkFBQztBQUFELENBQUMsQUExV0QsSUEwV0M7QUFFRCxPQUFPLEVBQUUsYUFBYSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiBXaXR0XHJcbiAqIEBEYXRlOiAyMDE5LTAzLTA3IDE3OjI0OjM4XHJcbiAqIEBMYXN0IE1vZGlmaWVkIGJ5OiAgIFdpdHRcclxuICogQExhc3QgTW9kaWZpZWQgdGltZTogMjAxOS0wMy0xMSAxOTo1MDozOFxyXG4gKi9cclxuXHJcbmltcG9ydCB7IFR5cGUgfSBmcm9tICcuLi9jb3JlL2luZGV4JztcclxuaW1wb3J0IHsgRW50aXR5LCBFbnRpdHlMaXN0LCBjcmVhdGVFbnRpdHksIGNyZWF0ZUVudGl0aWVzIH0gZnJvbSAnLi4vZW50aXR5L2luZGV4JztcclxuaW1wb3J0IHsgRW50aXR5Q29sbGVjdGlvbiB9IGZyb20gJy4vZW50aXR5X2NvbGxlY3Rpb24nO1xyXG5pbXBvcnQgeyBEYXRhUGF0aCwgRGF0YVBhdGhDcmVhdG9yLCBEYXRhUGF0aE5vZGVUeXBlLCBEYXRhVHlwZUluZm8gfSBmcm9tICcuLi9lbnRpdHkvaW5kZXgnO1xyXG5pbXBvcnQgeyBFbnRpdHlVdGlsIH0gZnJvbSAnLi4vYmluZGluZy1kYXRhL2VudGl0eV91dGlsJztcclxuXHJcblxyXG4vKipcclxuICog5a6e5L2T566h55CG57G7XHJcbiAqL1xyXG5jbGFzcyBFbnRpdHlNYW5hZ2VyPFQgZXh0ZW5kcyBFbnRpdHk+IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T57G75Z6LXHJcbiAgICovXHJcbiAgcHVibGljIGVudGl0eVR5cGU6IFR5cGU8RW50aXR5PjtcclxuXHJcbiAgLyoqXHJcbiAgICog5a6e5L2T6ZuG5ZCIXHJcbiAgICovXHJcbiAgcHVibGljIGVudGl0eUNvbGxlY3Rpb246IEVudGl0eUNvbGxlY3Rpb248RW50aXR5PjtcclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5Ye95pWwXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoZW50aXR5Q29sbGVjdGlvbjogRW50aXR5Q29sbGVjdGlvbjxUPikge1xyXG4gICAgdGhpcy5lbnRpdHlDb2xsZWN0aW9uID0gZW50aXR5Q29sbGVjdGlvbjtcclxuICAgIHRoaXMuZW50aXR5VHlwZSA9IGVudGl0eUNvbGxlY3Rpb24uZW50aXR5VHlwZTtcclxuICB9XHJcblxyXG5cclxuICAvLyAjcmVnaW9uIOWIm+W7uuWunuS9k+ebuOWFs+aWueazlVxyXG5cclxuICAvKipcclxuICAgKiDliJvlu7rlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgY3JlYXRlRW50aXR5KGVudGl0eURhdGE6IGFueSk6IFQge1xyXG4gICAgY29uc3QgZW50aXR5ID0gY3JlYXRlRW50aXR5PFQ+KHRoaXMuZW50aXR5VHlwZSwgZW50aXR5RGF0YSk7XHJcbiAgICByZXR1cm4gZW50aXR5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5om56YeP5Yib5bu65a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGNyZWF0ZUVudGl0aWVzKGVudGl0eUxpc3REYXRhOiBhbnlbXSwgZW50aXR5VHlwZTogYW55KTogVFtdIHtcclxuICAgIGNvbnN0IGVudGl0aWVzOiBUW10gPSBjcmVhdGVFbnRpdGllczxUPih0aGlzLmVudGl0eVR5cGUsIGVudGl0eUxpc3REYXRhKTtcclxuICAgIHJldHVybiBlbnRpdGllcztcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8vICNyZWdpb24g6I635Y+W5a6e5L2T44CB5a6e5L2T5pWw57uE55u45YWz5pa55rOVXHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlnBhdGjlr7nlupTnmoTlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0RW50aXR5QnlQYXRoKHBhdGg6IHN0cmluZ1tdKTogRW50aXR5IHtcclxuICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZ2V0RW50aXR5Tm9kZUJ5UGF0aChwYXRoKSBhcyBFbnRpdHk7XHJcbiAgICByZXR1cm4gZW50aXR5O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WcGF0aOWvueW6lOeahOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRFbnRpdGllc0J5UGF0aChwYXRoOiBzdHJpbmdbXSk6IEVudGl0eVtdIHtcclxuICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgocGF0aCkgYXMgRW50aXR5Q29sbGVjdGlvbjxFbnRpdHk+IHwgRW50aXR5TGlzdDxFbnRpdHk+O1xyXG4gICAgbGV0IGVudGl0aWVzOiBFbnRpdHlbXTtcclxuICAgIGlmIChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGluc3RhbmNlb2YgRW50aXR5Q29sbGVjdGlvbiA9PT0gdHJ1ZSkge1xyXG4gICAgICBlbnRpdGllcyA9IChlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PikudG9BcnJheSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZW50aXRpZXMgPSAoZW50aXR5Q29sbGVjdGlvbk9yTGlzdCBhcyBFbnRpdHlMaXN0PEVudGl0eT4pLnRvQXJyYXkoKTtcclxuICAgIH1cclxuICAgIHJldHVybiBlbnRpdGllcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPluWunuS9k+iKgueCuVxyXG4gICAqIEBwYXJhbSBwYXRoIOiKgueCuei3r+W+hFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0RW50aXR5Tm9kZUJ5UGF0aChwYXRoOiBzdHJpbmdbXSk6IEVudGl0eUNvbGxlY3Rpb248RW50aXR5PiB8IEVudGl0eUxpc3Q8RW50aXR5PiB8IEVudGl0eSB7XHJcbiAgICBjb25zdCBkYXRhUGF0aCA9IERhdGFQYXRoQ3JlYXRvci5jcmVhdGVCeUxvbmdQYXRoRnJvbVJvb3QocGF0aCwgdGhpcyk7XHJcbiAgICBsZXQgZW50aXR5Tm9kZTogYW55ID0gdGhpcy5lbnRpdHlDb2xsZWN0aW9uO1xyXG4gICAgbGV0IHBhdGhOb2RlID0gZGF0YVBhdGguaGVhZC5uZXh0O1xyXG4gICAgd2hpbGUgKHBhdGhOb2RlKSB7XHJcbiAgICAgIGlmIChwYXRoTm9kZS50eXBlID09PSBEYXRhUGF0aE5vZGVUeXBlLkRhdGFJZCkge1xyXG4gICAgICAgIGlmIChlbnRpdHlOb2RlIGluc3RhbmNlb2YgRW50aXR5Q29sbGVjdGlvbiA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgZW50aXR5Tm9kZSA9IChlbnRpdHlOb2RlIGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PikuZ2V0RW50aXR5QnlJZChwYXRoTm9kZS52YWx1ZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGVudGl0eU5vZGUgPSAoZW50aXR5Tm9kZSBhcyBFbnRpdHlMaXN0PEVudGl0eT4pLmdldChwYXRoTm9kZS52YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGVudGl0eU5vZGUgPSBlbnRpdHlOb2RlW3BhdGhOb2RlLnZhbHVlXTtcclxuICAgICAgfVxyXG4gICAgICBpZiAoIWVudGl0eU5vZGUpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOaJvuS4jeWIsCR7cGF0aE5vZGUudmFsdWV95a+55bqU55qE5pWw5o2u6IqC54K5YCk7XHJcbiAgICAgIH1cclxuICAgICAgcGF0aE5vZGUgPSBwYXRoTm9kZS5uZXh0O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVudGl0eU5vZGU7XHJcbiAgfVxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8vICNyZWdpb24g6I635Y+W44CB6K6+572u5bGe5oCn5YC8XHJcblxyXG4gIC8qKlxyXG4gICAqIOiOt+WPlnBhdGjlr7nlupTnmoTlrp7kvZPlsZ7mgKflgLxcclxuICAgKi9cclxuICBwdWJsaWMgZ2V0UHJvcFZhbHVlQnlQYXRoKHBhdGg6IHN0cmluZ1tdKTogYW55IHtcclxuICAgIGNvbnN0IHByb3BOYW1lID0gcGF0aC5wb3AoKTtcclxuICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZ2V0RW50aXR5QnlQYXRoKHBhdGgpO1xyXG4gICAgcmV0dXJuIGVudGl0eVtwcm9wTmFtZV07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDorr7nva5wYXRo5a+55bqU5a6e5L2T55qE5bGe5oCn5YC8XHJcbiAgICovXHJcbiAgcHVibGljIHNldFByb3BWYWx1ZUJ5UGF0aChwYXRoOiBzdHJpbmdbXSwgcHJvcFZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIGNvbnN0IHByb3BOYW1lID0gcGF0aC5wb3AoKTtcclxuICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZ2V0RW50aXR5QnlQYXRoKHBhdGgpO1xyXG4gICAgZW50aXR5W3Byb3BOYW1lXSA9IHByb3BWYWx1ZTtcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5o+S5YWl5a6e5L2TXHJcblxyXG4gIC8qKlxyXG4gICAqIOWcqHBhdGjlr7nlupTlrp7kvZPliY3mj5LlhaXlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgaW5zZXJ0RW50aXR5QmVmb3JlQnlQYXRoKGZwYXRoOiBzdHJpbmdbXSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50ZWQnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOWcqHBhdGjlr7nlupTlrp7kvZPliY3mibnph4/mj5LlhaXlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgaW5zZXJ0RW50aXRpZXNCZWZvcmVCeVBhdGgoKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5ZyocGF0aOWvueW6lOWunuS9k+WJjeaPkuWFpeWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyBpbnNlcnRFbnRpdHlBZnRlckJ5UGF0aCgpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDlnKhwYXRo5a+55bqU5a6e5L2T5YmN5om56YeP5o+S5YWl5a6e5L2TXHJcbiAgICovXHJcbiAgcHVibGljIGluc2VydEVudGl0aWVzQWZ0ZXJCeVBhdGgoKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDov73liqDlrp7kvZNcclxuXHJcbiAgLyoqXHJcbiAgICog5ZyocGF0aOWvueW6lOeahOWunuS9k+mbhuWQiOS4rei/veWKoDHkuKrlrp7kvZNcclxuICAgKi9cclxuICAvLyBwdWJsaWMgYXBwZW5kRW50aXR5QnlQYXRoKGZwYXRoOiBzdHJpbmdbXSwgZW50aXR5OiBFbnRpdHkpOiB2b2lkIHtcclxuICAvLyAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgoZnBhdGgpO1xyXG4gIC8vICAgaWYgKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgaW5zdGFuY2VvZiBFbnRpdHlDb2xsZWN0aW9uID09PSB0cnVlKSB7XHJcbiAgLy8gICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb24gPSBlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PjtcclxuICAvLyAgICAgZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5KTtcclxuICAvLyAgIH0gZWxzZSB7XHJcbiAgLy8gICAgIGNvbnN0IGVudGl0eUxpc3QgPSAoZW50aXR5Q29sbGVjdGlvbk9yTGlzdCBhcyBFbnRpdHlMaXN0PEVudGl0eT4pO1xyXG4gIC8vICAgICBlbnRpdHlMaXN0LmFwcGVuZEVudGl0eShlbnRpdHkpO1xyXG4gIC8vICAgfVxyXG4gIC8vIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2ucGF0aOiOt+WPluWunuS9k+mbhuWQiFxyXG4gICAqIEBwYXJhbSBmcGF0aCDot6/lvoRcclxuICAgKiBAcGFyYW0gZW50aXR5RGF0YSDlrp7kvZPmlbDmja5cclxuICAgKiBAcGFyYW0gaW5pdGlhbERhdGFb5Y+v6YCJXSDpu5jorqTlgLxcclxuICAgKi9cclxuICBwdWJsaWMgYXBwZW5kRW50aXR5QnlQYXRoKGZwYXRoOiBzdHJpbmcsIGVudGl0eURhdGE6IGFueSwgaW5pdGlhbERhdGE/OiBhbnkpOiBFbnRpdHkge1xyXG4gICAgY29uc3Qgc3ViUGF0aHMgPSBmcGF0aC5zcGxpdCgnLycpO1xyXG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA8IDMpIHtcclxuICAgICAgdGhyb3cgRXJyb3IoYOagueaNrnBhdGjliKDpmaTlrp7kvZPmlbDmja7lh7rplJnkuobjgILkvKDlhaXnmoRwYXRoWyR7ZnBhdGh9XeagvOW8j+S4jeWvuWApO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBjaGlsZEVudGl0eUxpc3Q6IEVudGl0eUxpc3Q8YW55PjtcclxuICAgIGxldCBwcm9wSW5mbzogeyBwcm9wVHlwZTogc3RyaW5nLCBwcm9wRW50aXR5VHlwZTogYW55IH07XHJcbiAgICBsZXQgcHJvcE5hbWU6IHN0cmluZztcclxuICAgIGZvciAobGV0IGkgPSAyOyBpIDwgc3ViUGF0aHMubGVuZ3RoOyBpID0gaSArIDIpIHtcclxuICAgICAgY29uc3QgZmlkID0gc3ViUGF0aHNbaSAtIDFdO1xyXG4gICAgICBwcm9wTmFtZSA9IHN1YlBhdGhzW2ldO1xyXG5cclxuICAgICAgLy8gdG9kbzogRW50aXR5Q29sbGVjdGlvbumHjeaehOS5i+WQjui/memHjOaXoOmcgOW3ruW8guWkhOeQhlxyXG4gICAgICBjb25zdCBwYXJlbnRFbnRpdHkgPSBjaGlsZEVudGl0eUxpc3QgPyBjaGlsZEVudGl0eUxpc3QuZ2V0KGZpZCkgOiB0aGlzLmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChmaWQpO1xyXG4gICAgICBjaGlsZEVudGl0eUxpc3QgPSBwYXJlbnRFbnRpdHlbcHJvcE5hbWVdO1xyXG4gICAgICBjb25zdCBlbnRpdHlUeXBlID0gcHJvcEluZm8gPyBwcm9wSW5mby5wcm9wRW50aXR5VHlwZSA6IHRoaXMuZW50aXR5VHlwZTtcclxuICAgICAgcHJvcEluZm8gPSBFbnRpdHlVdGlsLmdldFByb3BJbmZvKGVudGl0eVR5cGUsIHByb3BOYW1lKTtcclxuICAgICAgaWYgKCFjaGlsZEVudGl0eUxpc3QpIHtcclxuICAgICAgICB0aHJvdyBFcnJvcihgZnBhdGjlj4LmlbDplJnor6/vvIzml6Dms5Xmib7liLAke3Byb3BOYW1lfeWvueW6lOeahOWtkOihqOOAgmZwYXRo5Li677yaJHtmcGF0aH1gKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vIGNvbnN0IHByb3BJbmZvID0gRW50aXR5VXRpbC5nZXRQcm9wSW5mbyh0aGlzLmVudGl0eVR5cGUsIHByb3BOYW1lKTtcclxuICAgIGNvbnN0IGNoaWxkRW50aXR5ID0gY3JlYXRlRW50aXR5PEVudGl0eT4ocHJvcEluZm8ucHJvcEVudGl0eVR5cGUsIGVudGl0eURhdGEpO1xyXG4gICAgLy8g5Zyo5a6e5L2T55qE5a6e5L6L5LiK5aKe5Yqg6buY6K6k5YC85bGe5oCn77yM5Lul5L6/5ZyoY3JlYXRlQmluZGluZ09iamVjdOaXtuWtmOaUvum7mOiupOWAvFxyXG4gICAgaWYgKGluaXRpYWxEYXRhKSB7XHJcbiAgICAgIEVudGl0eVV0aWwuYXBwZW5kSW5pdGlhbERhdGEoY2hpbGRFbnRpdHksIGluaXRpYWxEYXRhKTtcclxuICAgIH1cclxuICAgIGNoaWxkRW50aXR5TGlzdC5hcHBlbmROZXcoY2hpbGRFbnRpdHkpO1xyXG4gICAgcmV0dXJuIGNoaWxkRW50aXR5O1xyXG4gIH1cclxuXHJcblxyXG4gIC8qKlxyXG4gICAqIOWcqHBhdGjlr7nlupTnmoTlrp7kvZPpm4blkIjkuK3ov73liqDlpJrkuKrlrp7kvZNcclxuICAgKi9cclxuICBwdWJsaWMgYXBwZW5kRW50aXRpZXNCeVBhdGgoZnBhdGg6IHN0cmluZ1tdLCBlbnRpdGllczogRW50aXR5W10pIHtcclxuICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgoZnBhdGgpO1xyXG4gICAgaWYgKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgaW5zdGFuY2VvZiBFbnRpdHlDb2xsZWN0aW9uID09PSB0cnVlKSB7XHJcbiAgICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb24gPSBlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PjtcclxuICAgICAgZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdGllcyhlbnRpdGllcyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBlbnRpdHlMaXN0ID0gKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgYXMgRW50aXR5TGlzdDxFbnRpdHk+KTtcclxuICAgICAgZW50aXR5TGlzdC5hcHBlbmRFbnRpdGllcyhlbnRpdGllcyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAjZW5kcmVnaW9uXHJcblxyXG5cclxuICAvLyAjcmVnaW9uIOWIoOmZpOWunuS9k1xyXG5cclxuICAvKipcclxuICAgKiDku45mYXB0aOWvueW6lOeahOWunuS9k+mbhuWQiOS4reWIoOmZpGlk5a+55bqU55qE5a6e5L2TXHJcbiAgICovXHJcbiAgLy8gcHVibGljIHJlbW92ZUVudGl0eUJ5UGF0aChmcGF0aDogc3RyaW5nW10sIGlkOiBzdHJpbmcpOiB2b2lkIHtcclxuICAvLyAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgoZnBhdGgpO1xyXG4gIC8vICAgaWYgKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgaW5zdGFuY2VvZiBFbnRpdHlDb2xsZWN0aW9uID09PSB0cnVlKSB7XHJcbiAgLy8gICAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb24gPSBlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PjtcclxuICAvLyAgICAgZW50aXR5Q29sbGVjdGlvbi5yZW1vdmVFbnRpdHlCeUlkKGlkKTtcclxuICAvLyAgIH0gZWxzZSB7XHJcbiAgLy8gICAgIGNvbnN0IGVudGl0eUxpc3QgPSAoZW50aXR5Q29sbGVjdGlvbk9yTGlzdCBhcyBFbnRpdHlMaXN0PEVudGl0eT4pO1xyXG4gIC8vICAgICBlbnRpdHlMaXN0LnJlbW92ZShpZCk7XHJcbiAgLy8gICB9XHJcbiAgLy8gfVxyXG5cclxuICAvKipcclxuICAgKiDmoLnmja5wYXRo6I635Y+W5a6e5L2T6ZuG5ZCIXHJcbiAgICogQHBhcmFtIGZwYXRoIHBhdGhcclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlRW50aXR5QnlQYXRoKGZwYXRoOiBzdHJpbmcsIGlkOiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHN1YlBhdGhzID0gZnBhdGguc3BsaXQoJy8nKTtcclxuICAgIGlmIChzdWJQYXRocy5sZW5ndGggPCAzKSB7XHJcbiAgICAgIHRocm93IEVycm9yKGDmoLnmja5wYXRo5Yig6Zmk5a6e5L2T5pWw5o2u5Ye66ZSZ5LqG44CC5Lyg5YWl55qEcGF0aFske2ZwYXRofV3moLzlvI/kuI3lr7lgKTtcclxuICAgIH1cclxuICAgIGxldCBjaGlsZEVudGl0eUxpc3Q6IEVudGl0eUxpc3Q8YW55PjtcclxuICAgIGZvciAobGV0IGkgPSAyOyBpIDwgc3ViUGF0aHMubGVuZ3RoOyBpID0gaSArIDIpIHtcclxuICAgICAgY29uc3QgZmlkID0gc3ViUGF0aHNbaSAtIDFdO1xyXG4gICAgICBjb25zdCBwcm9wTmFtZSA9IHN1YlBhdGhzW2ldO1xyXG4gICAgICBjb25zdCBwYXJlbnRFbnRpdHkgPSBjaGlsZEVudGl0eUxpc3QgPyBjaGlsZEVudGl0eUxpc3QuZ2V0KGZpZCkgOiB0aGlzLmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChmaWQpO1xyXG4gICAgICBjaGlsZEVudGl0eUxpc3QgPSBwYXJlbnRFbnRpdHlbcHJvcE5hbWVdO1xyXG4gICAgICBpZiAoIWNoaWxkRW50aXR5TGlzdCkge1xyXG4gICAgICAgIHRocm93IEVycm9yKGBmcGF0aOWPguaVsOmUmeivr++8jOaXoOazleaJvuWIsCR7cHJvcE5hbWV95a+55bqU55qE5a2Q6KGo44CCZnBhdGjkuLrvvJoke2ZwYXRofWApO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY2hpbGRFbnRpdHlMaXN0LnJlbW92ZShpZCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDku45mYXB0aOWvueW6lOeahOWunuS9k+mbhuWQiOS4reWIoOmZpGlkc+WvueW6lOeahOWunuS9k1xyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVFbnRpdGllc0J5UGF0aChmcGF0aDogc3RyaW5nW10sIGlkczogc3RyaW5nW10pOiB2b2lkIHtcclxuICAgIC8vIGNvbnN0IGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgPSB0aGlzLmdldEVudGl0eU5vZGVCeVBhdGgoZnBhdGgpO1xyXG4gICAgLy8gaWYgKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgaW5zdGFuY2VvZiBFbnRpdHlDb2xsZWN0aW9uID09PSB0cnVlKSB7XHJcbiAgICAvLyAgIGNvbnN0IGVudGl0eUNvbGxlY3Rpb24gPSBlbnRpdHlDb2xsZWN0aW9uT3JMaXN0IGFzIEVudGl0eUNvbGxlY3Rpb248RW50aXR5PjtcclxuICAgIC8vICAgZW50aXR5Q29sbGVjdGlvbi5yZW1vdmVFbnRpdGllc0J5SWRzKGlkcyk7XHJcbiAgICAvLyB9IGVsc2Uge1xyXG4gICAgLy8gICBjb25zdCBlbnRpdHlMaXN0ID0gKGVudGl0eUNvbGxlY3Rpb25Pckxpc3QgYXMgRW50aXR5TGlzdDxFbnRpdHk+KTtcclxuICAgIC8vICAgZW50aXR5TGlzdC5yZW1vdmUoaWRzKTtcclxuICAgIC8vIH1cclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcblxyXG4gIC8vICNyZWdpb24g5riF56m65Y+Y5pu06ZuG55u45YWz5pa55rOVXHJcblxyXG4gIC8qKlxyXG4gICAqIOa4heepuuaJgOacieWunuS9k+eahOWPmOabtOmbhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckFsbEVudGl0eUNoYW5nZXMoKSB7XHJcbiAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi50b0FycmF5KCk7XHJcbiAgICBlbnRpdGllcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xyXG4gICAgICBlbnRpdHkuY2hhbmdlcy5zcGxpY2UoMCwgZW50aXR5LmNoYW5nZXMubGVuZ3RoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5riF56m6aWTmjIflrprnmoTlrp7kvZPlj5jmm7Tpm4ZcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJFbnRpdHlDaGFuZ2VzQnlJZChpZDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBjb25zdCBlbnRpdHkgPSB0aGlzLmVudGl0eUNvbGxlY3Rpb24uZ2V0RW50aXR5QnlJZChpZCk7XHJcbiAgICBpZiAoIWVudGl0eSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBlbnRpdHkuY2hhbmdlcy5zcGxpY2UoMCwgZW50aXR5LmNoYW5nZXMubGVuZ3RoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa4heepumlkc+aVsOe7hOS4reaMh+WumueahOWunuS9k+eahOWPmOabtOmbhlxyXG4gICAqL1xyXG4gIHB1YmxpYyBjbGVhckVudGl0eUNoYW5nZXNCeUlkcyhpZHM6IHN0cmluZ1tdKTogdm9pZCB7XHJcbiAgICBpZiAoIWlkcyB8fCBpZHMubGVuZ3RoIDwgMCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWRzLmZvckVhY2goKGlkOiBzdHJpbmcpID0+IHtcclxuICAgICAgdGhpcy5jbGVhckVudGl0eUNoYW5nZXNCeUlkKGlkKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDlj5jmm7Tpm4bmo4Dmn6Xnm7jlhbPmlrnms5VcclxuXHJcbiAgLyoqXHJcbiAgICog5qOA5p+l5omA5pyJ55qE5a6e5L2T77yM5piv5ZCm5pyJ5pyq5o+Q5Lqk55qE5Y+Y5pu0XHJcbiAgICovXHJcbiAgcHVibGljIGNoZWNrQWxsRW50aXR5Q2hhbmdlcygpOiBib29sZWFuIHtcclxuXHJcbiAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi50b0FycmF5KCk7XHJcbiAgICBjb25zdCBoYXNDaGFuZ2VzID0gZW50aXRpZXMuc29tZSgoZW50aXR5OiBFbnRpdHkpID0+IHtcclxuICAgICAgaWYgKGVudGl0eS5jaGFuZ2VzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGhhc0NoYW5nZXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmo4Dmn6VpZOWvueW6lOeahOWunuS9k++8jOaYr+WQpuacieacquaPkOS6pOeahOWPmOabtFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjaGVja0VudGl0eUNoYW5nZXNCeUlkKGlkOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKTtcclxuICAgIGlmICghZW50aXR5KSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiBlbnRpdHkuY2hhbmdlcy5sZW5ndGggPiAwO1xyXG4gIH1cclxuXHJcbiAgLy8gI2VuZHJlZ2lvblxyXG5cclxuXHJcbiAgLy8gI3JlZ2lvbiDkuI3op4TojIPmlrnms5XvvIzlvoXlup/lvINcclxuXHJcbiAgLyoqXHJcbiAgICog5b6F5bqf5byDXHJcbiAgICogQGRlcHJlY2F0ZWRcclxuICAgKi9cclxuICBwdWJsaWMgY2xlYXJFbnRpdHlDaGFuZ2VzQnlBcnJheShpZEFycmF5OiBzdHJpbmdbXSk6IHZvaWQge1xyXG4gICAgdGhpcy5jbGVhckVudGl0eUNoYW5nZXNCeUlkcyhpZEFycmF5KTtcclxuICB9XHJcblxyXG4gIC8vICNlbmRyZWdpb25cclxuXHJcbn1cclxuXHJcbmV4cG9ydCB7IEVudGl0eU1hbmFnZXIgfTtcclxuIl19