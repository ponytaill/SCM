/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { of, Subject } from "rxjs";
/**
 * 保存方案API
 * @type {?}
 */
const SCHEME_WEBAPI = '/api/runtime/sys/v1.0/querysolution';
/**
 * 获取方案列表API
 * @type {?}
 */
const SCHEME_WEBAPI_QUERY = `${SCHEME_WEBAPI}/belongId/`;
/**
 * 方案列表管理- 设默认、删除 API
 * @type {?}
 */
const SCHEME_WEBAPI_UPDATE = `${SCHEME_WEBAPI}/batch`;
/**
 * 权限验证
 * @type {?}
 */
const SCHEME_WEBAPI_Auth = '/api/runtime/sys/v1.0/querysolution/componentType/Datagrid';
/** @type {?} */
const LANGUAGE_WEBAPI = '/api/runtime/sys/v1.0/loginInfo?infoType=supportedLanguage';
export class DatagridSchemeService {
    constructor() {
        this.restService = null;
        this.state = {};
        this.schemeList$ = new Subject();
    }
    /**
     * @param {?} d
     * @param {?} gridId
     * @return {?}
     */
    update(d, gridId) {
        if (!this.state[gridId]) {
            this.state[gridId] = {};
        }
        this.state[gridId] = Object.assign(this.state[gridId], d);
    }
    /**
     * @param {?} httpSer
     * @return {?}
     */
    setRestService(httpSer) {
        if (httpSer && httpSer['befRepository']) {
            this.restService = httpSer['befRepository']['restService'];
        }
    }
    /**
     * @private
     * @return {?}
     */
    getWebFormKey() {
        /** @type {?} */
        const webformHash = window.location.hash.split('?')[0];
        return webformHash.substring(webformHash.lastIndexOf('/') + 1);
    }
    /**
     * @param {?} gridId
     * @return {?}
     */
    getSchemeKey(gridId) {
        /** @type {?} */
        const formKey = this.getWebFormKey();
        return `${formKey}_DatagridScheme_${gridId}`;
    }
    /**
     * @param {?} gridID
     * @return {?}
     */
    getSchemeList(gridID) {
        /** @type {?} */
        const uri = SCHEME_WEBAPI_QUERY + this.getSchemeKey(gridID);
        if (this.restService) {
            return this.restService.invoke(uri, 'GET', null, null, false);
        }
    }
    /**
     * @param {?} scheme
     * @param {?} gridID
     * @param {?=} isUpdate
     * @return {?}
     */
    saveScheme(scheme, gridID, isUpdate = false) {
        if (this.restService) {
            /** @type {?} */
            const httpMethod = isUpdate ? 'PUT' : 'POST';
            scheme.belongId = this.getSchemeKey(gridID);
            return this.restService.invoke(SCHEME_WEBAPI, httpMethod, null, { body: scheme }, false);
        }
    }
    /**
     * @param {?} param
     * @param {?} gridID
     * @return {?}
     */
    updateScheme(param, gridID) {
        if (!param) {
            return of(false);
        }
        /** @type {?} */
        const belongId = this.getSchemeKey(gridID);
        param.belongId = belongId;
        if (param.belongId) {
            return this.restService.invoke(SCHEME_WEBAPI_UPDATE, 'PUT', null, { body: param }, false);
        }
    }
    /**
     * @param {?} gridId
     * @param {...?} statePro
     * @return {?}
     */
    getStateValue(gridId, ...statePro) {
        /** @type {?} */
        const dgState = this.state[gridId];
        if (dgState) {
            if (statePro && statePro.length) {
                return statePro.reduce((/**
                 * @param {?} r
                 * @param {?} c
                 * @return {?}
                 */
                (r, c) => {
                    return r[c];
                }), dgState);
            }
            return dgState;
        }
        return null;
    }
    /**
     * @private
     * @param {?} gridId
     * @param {?} propertyName
     * @param {?} value
     * @return {?}
     */
    updateStateValue(gridId, propertyName, value) {
        this.update({ [propertyName]: value }, gridId);
    }
    /**
     * @param {?} gridId
     * @param {?} newSchemeList
     * @return {?}
     */
    setSchemeList(gridId, newSchemeList) {
        this.updateStateValue(gridId, 'list', newSchemeList);
        this.schemeList$.next(newSchemeList);
    }
    /**
     * @param {?} gridId
     * @param {?} schemeName
     * @return {?}
     */
    hasSchemeName(gridId, schemeName) {
        /** @type {?} */
        const schemeList = this.getStateValue(gridId, 'list');
        if (!schemeList || !schemeList.length) {
            return false;
        }
        if (typeof schemeName === 'string') {
            return !!schemeList.find((/**
             * @param {?} n
             * @return {?}
             */
            n => n.name === schemeName.trim()));
        }
        else {
            if (typeof schemeName === 'object') {
                /** @type {?} */
                const replayNames = [];
                schemeList.forEach((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => {
                    /** @type {?} */
                    const currentNames = Object.values(n.name);
                    for (let k in schemeName) {
                        if (currentNames.includes(schemeName[k])) {
                            replayNames.push(k);
                        }
                    }
                }));
                return replayNames;
            }
        }
    }
    /**
     * @return {?}
     */
    checkAuthority() {
        return this.restService.invoke(SCHEME_WEBAPI_Auth, 'GET', null, null, false);
    }
    /**
     * @return {?}
     */
    getLanguages() {
        return this.restService.invoke(LANGUAGE_WEBAPI, 'GET', null, null, false);
    }
}
if (false) {
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.restService;
    /**
     * @type {?}
     * @private
     */
    DatagridSchemeService.prototype.state;
    /** @type {?} */
    DatagridSchemeService.prototype.schemeList$;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtc2NoZW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWRhdGFncmlkLXNldHRpbmdzLyIsInNvdXJjZXMiOlsibGliL2RhdGFncmlkLXNjaGVtZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxPQUFPLEVBQWMsRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7Ozs7TUFLekMsYUFBYSxHQUFHLHFDQUFxQzs7Ozs7TUFFckQsbUJBQW1CLEdBQUcsR0FBRyxhQUFhLFlBQVk7Ozs7O01BRWxELG9CQUFvQixHQUFHLEdBQUcsYUFBYSxRQUFROzs7OztNQUUvQyxrQkFBa0IsR0FBRyw0REFBNEQ7O01BRWpGLGVBQWUsR0FBRyw0REFBNEQ7QUFHcEYsTUFBTSxPQUFPLHFCQUFxQjtJQU05QjtRQUxRLGdCQUFXLEdBQUcsSUFBSSxDQUFDO1FBQ25CLFVBQUssR0FBa0IsRUFBRSxDQUFDO1FBRWxDLGdCQUFXLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztJQUc1QixDQUFDOzs7Ozs7SUFFRCxNQUFNLENBQUMsQ0FBYyxFQUFFLE1BQWM7UUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUM7U0FDM0I7UUFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDOzs7OztJQUVELGNBQWMsQ0FBQyxPQUFZO1FBQ3ZCLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxlQUFlLENBQUMsRUFBRTtZQUNyQyxJQUFJLENBQUMsV0FBVyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxhQUFhLENBQUMs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QyxDQUFDO0lBQ2pGLENBQUM7Ozs7SUFFRCxZQUFZO1FBQ1IsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDOUUsQ0FBQztDQUNKOzs7Ozs7SUFqSEcsNENBQTJCOzs7OztJQUMzQixzQ0FBa0M7O0lBRWxDLDRDQUE0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCB7IEJhdGNoU2NoZW1lLCBEYXRhZ3JpZFNjaGVtZU1vZGVsLCBEZ1NjaGVtZVN0YXRlLCBTY2hlbWVBdXRoTW9kZWwsIFNjaGVtZVN0YXRlIH0gZnJvbSBcIi4vc2V0dGluZy5tb2RlbFwiO1xyXG5cclxuLyoqIOS/neWtmOaWueahiEFQSSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJID0gJy9hcGkvcnVudGltZS9zeXMvdjEuMC9xdWVyeXNvbHV0aW9uJztcclxuLyoqIOiOt+WPluaWueahiOWIl+ihqEFQSSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJX1FVRVJZID0gYCR7U0NIRU1FX1dFQkFQSX0vYmVsb25nSWQvYDtcclxuLyoqIOaWueahiOWIl+ihqOeuoeeQhi0g6K6+6buY6K6k44CB5Yig6ZmkIEFQSSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJX1VQREFURSA9IGAke1NDSEVNRV9XRUJBUEl9L2JhdGNoYDtcclxuLyoqIOadg+mZkOmqjOivgSAqL1xyXG5jb25zdCBTQ0hFTUVfV0VCQVBJX0F1dGggPSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL3F1ZXJ5c29sdXRpb24vY29tcG9uZW50VHlwZS9EYXRhZ3JpZCc7XHJcblxyXG5jb25zdCBMQU5HVUFHRV9XRUJBUEkgPSAnL2FwaS9ydW50aW1lL3N5cy92MS4wL2xvZ2luSW5mbz9pbmZvVHlwZT1zdXBwb3J0ZWRMYW5ndWFnZSc7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIERhdGFncmlkU2NoZW1lU2VydmljZSB7XHJcbiAgICBwcml2YXRlIHJlc3RTZXJ2aWNlID0gbnVsbDtcclxuICAgIHByaXZhdGUgc3RhdGU6IERnU2NoZW1lU3RhdGUgPSB7fTtcclxuXHJcbiAgICBzY2hlbWVMaXN0JCA9IG5ldyBTdWJqZWN0KCk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlKGQ6IFNjaGVtZVN0YXRlLCBncmlkSWQ6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdGhpcy5zdGF0ZVtncmlkSWRdKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhdGVbZ3JpZElkXSA9IHt9O1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnN0YXRlW2dyaWRJZF0gPSBPYmplY3QuYXNzaWduKHRoaXMuc3RhdGVbZ3JpZElkXSwgZCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0UmVzdFNlcnZpY2UoaHR0cFNlcjogYW55KSB7XHJcbiAgICAgICAgaWYgKGh0dHBTZXIgJiYgaHR0cFNlclsnYmVmUmVwb3NpdG9yeSddKSB7XHJcbiAgICAgICAgICAgIHRoaXMucmVzdFNlcnZpY2UgPSBodHRwU2VyWydiZWZSZXBvc2l0b3J5J11bJ3Jlc3RTZXJ2aWNlJ107XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0V2ViRm9ybUtleSgpIHtcclxuICAgICAgICBjb25zdCB3ZWJmb3JtSGFzaCA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnNwbGl0KCc/JylbMF07XHJcbiAgICAgICAgcmV0dXJuIHdlYmZvcm1IYXNoLnN1YnN0cmluZyh3ZWJmb3JtSGFzaC5sYXN0SW5kZXhPZignLycpICsgMSk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2NoZW1lS2V5KGdyaWRJZDogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgZm9ybUtleSA9IHRoaXMuZ2V0V2ViRm9ybUtleSgpO1xyXG4gICAgICAgIHJldHVybiBgJHtmb3JtS2V5fV9EYXRhZ3JpZFNjaGVtZV8ke2dyaWRJZH1gO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNjaGVtZUxpc3QoZ3JpZElEOiBzdHJpbmcpOiBPYnNlcnZhYmxlPERhdGFncmlkU2NoZW1lTW9kZWxbXT4ge1xyXG4gICAgICAgIGNvbnN0IHVyaSA9IFNDSEVNRV9XRUJBUElfUVVFUlkgKyB0aGlzLmdldFNjaGVtZUtleShncmlkSUQpO1xyXG4gICAgICAgIGlmICh0aGlzLnJlc3RTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLmludm9rZSh1cmksICdHRVQnLCBudWxsLCBudWxsLCBmYWxzZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNhdmVTY2hlbWUoc2NoZW1lOiBEYXRhZ3JpZFNjaGVtZU1vZGVsLCBncmlkSUQ6IHN0cmluZywgaXNVcGRhdGUgPSBmYWxzZSkge1xyXG4gICAgICAgIGlmICh0aGlzLnJlc3RTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGh0dHBNZXRob2QgPSBpc1VwZGF0ZSA/ICdQVVQnOiAnUE9TVCc7XHJcbiAgICAgICAgICAgIHNjaGVtZS5iZWxvbmdJZCA9IHRoaXMuZ2V0U2NoZW1lS2V5KGdyaWRJRCk7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLmludm9rZShTQ0hFTUVfV0VCQVBJLCBodHRwTWV0aG9kLCBudWxsLCB7IGJvZHk6IHNjaGVtZX0sIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlU2NoZW1lKHBhcmFtOiBCYXRjaFNjaGVtZSwgZ3JpZElEOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgICAgIGlmICghcGFyYW0pIHtcclxuICAgICAgICAgICAgcmV0dXJuIG9mKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgYmVsb25nSWQgPSB0aGlzLmdldFNjaGVtZUtleShncmlkSUQpO1xyXG4gICAgICAgIHBhcmFtLmJlbG9uZ0lkID0gYmVsb25nSWRcclxuXHJcbiAgICAgICAgaWYgKHBhcmFtLmJlbG9uZ0lkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlc3RTZXJ2aWNlLmludm9rZShTQ0hFTUVfV0VCQVBJX1VQREFURSwgJ1BVVCcsIG51bGwsIHtib2R5OiBwYXJhbX0sIGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U3RhdGVWYWx1ZShncmlkSWQsIC4uLnN0YXRlUHJvKSB7XHJcbiAgICAgICAgY29uc3QgZGdTdGF0ZSA9IHRoaXMuc3RhdGVbZ3JpZElkXTtcclxuICAgICAgICBpZiAoZGdTdGF0ZSkge1xyXG4gICAgICAgICAgICBpZiAoc3RhdGVQcm8gJiYgc3RhdGVQcm8ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RhdGVQcm8ucmVkdWNlKChyLCBjKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJbY107XHJcbiAgICAgICAgICAgICAgICB9LCBkZ1N0YXRlKVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gZGdTdGF0ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSB1cGRhdGVTdGF0ZVZhbHVlKGdyaWRJZCwgcHJvcGVydHlOYW1lLCB2YWx1ZSkge1xyXG4gICAgICAgIHRoaXMudXBkYXRlKHtbcHJvcGVydHlOYW1lXTogdmFsdWV9LCBncmlkSWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFNjaGVtZUxpc3QoZ3JpZElkLCBuZXdTY2hlbWVMaXN0KSB7XHJcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZVZhbHVlKGdyaWRJZCwgJ2xpc3QnLCBuZXdTY2hlbWVMaXN0KTtcclxuICAgICAgICB0aGlzLnNjaGVtZUxpc3QkLm5leHQobmV3U2NoZW1lTGlzdCk7XHJcbiAgICB9XHJcblxyXG4gICAgaGFzU2NoZW1lTmFtZShncmlkSWQsIHNjaGVtZU5hbWU6IGFueSkge1xyXG4gICAgICAgIGNvbnN0IHNjaGVtZUxpc3QgPSB0aGlzLmdldFN0YXRlVmFsdWUoZ3JpZElkLCAnbGlzdCcpO1xyXG4gICAgICAgIGlmICghc2NoZW1lTGlzdCB8fCAhc2NoZW1lTGlzdC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiBzY2hlbWVOYW1lID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICByZXR1cm4gISFzY2hlbWVMaXN0LmZpbmQobiA9PiBuLm5hbWUgPT09IHNjaGVtZU5hbWUudHJpbSgpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHNjaGVtZU5hbWUgPT09ICdvYmplY3QnKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCByZXBsYXlOYW1lcyA9IFtdO1xyXG4gICAgICAgICAgICAgICAgc2NoZW1lTGlzdC5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1cnJlbnROYW1lcyA9IE9iamVjdC52YWx1ZXMobi5uYW1lKTtcclxuICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGsgaW4gc2NoZW1lTmFtZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5hbWVzLmluY2x1ZGVzKHNjaGVtZU5hbWVba10pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYXlOYW1lcy5wdXNoKGspO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlcGxheU5hbWVzO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNoZWNrQXV0aG9yaXR5KCk6IE9ic2VydmFibGU8U2NoZW1lQXV0aE1vZGVsPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKFNDSEVNRV9XRUJBUElfQXV0aCwgJ0dFVCcsIG51bGwsIG51bGwsIGZhbHNlKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRMYW5ndWFnZXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzdFNlcnZpY2UuaW52b2tlKExBTkdVQUdFX1dFQkFQSSwgJ0dFVCcsIG51bGwsIG51bGwsIGZhbHNlKTtcclxuICAgIH1cclxufVxyXG4iXX0=