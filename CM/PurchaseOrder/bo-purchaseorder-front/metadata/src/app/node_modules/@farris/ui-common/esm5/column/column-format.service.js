/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { Injectable } from '@angular/core';
import { NumberHelperService } from '@farris/ui-common/number';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { Compare, FilterRelation, CompareOperators, SortType } from '@farris/ui-common/types';
import * as i0 from "@angular/core";
import * as i1 from "@farris/ui-common/date";
import * as i2 from "@farris/ui-common/number";
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-01-02 14:12:47
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-18 13:59:34
 * @Company: Inspur
 * @Version: v0.0.1
 */
var ColumnFormatService = /** @class */ (function () {
    function ColumnFormatService(datehelper, numberhelper) {
        this.datehelper = datehelper;
        this.numberhelper = numberhelper;
    }
    /**
     * @param {?} value
     * @param {?=} data
     * @param {?=} formatter
     * @param {?=} context
     * @return {?}
     */
    ColumnFormatService.prototype.format = /**
     * @param {?} value
     * @param {?=} data
     * @param {?=} formatter
     * @param {?=} context
     * @return {?}
     */
    function (value, data, formatter, context) {
        if (formatter) {
            if (typeof (formatter) === 'function') {
                context = context || {};
                return formatter(value, data, tslib_1.__assign({ date: this.datehelper, number: this.numberhelper, format: this }, context));
            }
            else {
                if (formatter['type']) {
                    /** @type {?} */
                    var fmt = (/** @type {?} */ (formatter));
                    switch (fmt.type) {
                        case 'datetime':
                            if (fmt.options && fmt.options.format) {
                                return this.dateTimeFormat(value, fmt.options);
                            }
                            return value;
                        case 'number':
                            return this.numberFormat(value, fmt.options);
                        case 'enum':
                            return this.enumFormat(value, fmt.options);
                        case 'image':
                            return this.imageFormat(value, fmt.options);
                        case 'boolean':
                            return this.booleanFormat(value, fmt.options);
                        default:
                            return value;
                    }
                }
            }
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?} opts
     * @return {?}
     */
    ColumnFormatService.prototype.dateTimeFormat = /**
     * @private
     * @param {?} value
     * @param {?} opts
     * @return {?}
     */
    function (value, opts) {
        if (value) {
            /** @type {?} */
            var fmt = 'yyyy-MM-dd';
            if (typeof (opts) === 'string') {
                fmt = opts;
            }
            else if (typeof (opts) === 'object') {
                fmt = opts.format;
            }
            fmt = fmt.replace('YYYY', 'yyyy').replace('-DD', '-dd');
            if (typeof (opts) === 'object' && opts.dateRange) {
                /** @type {?} */
                var splitStr = opts.dateRangeDatesDelimiter || '~';
                var _a = tslib_1.__read(value.split(splitStr), 2), beginDate = _a[0], endDate = _a[1];
                beginDate = this.datehelper.formatTo(beginDate, fmt);
                endDate = this.datehelper.formatTo(endDate, fmt);
                return beginDate + splitStr + endDate;
            }
            return this.datehelper.formatTo(value, fmt);
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.numberFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        return this.numberhelper.formatNumber(value, opts);
        // if (value !== undefined && value !== '' && value !== NaN) {
        //     return this.numberhelper.formatMoney(value, opts);
        // }
        // return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.enumFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        if (value === undefined || value === null) {
            value = '';
        }
        if (opts && opts.data && opts.data.length) {
            /** @type {?} */
            var val = value.toString();
            /** @type {?} */
            var arr = [val];
            if (val.indexOf(',') > -1) { // 多选
                arr = val.split(',');
            }
            /** @type {?} */
            var str_1 = [];
            arr.forEach((/**
             * @param {?} v
             * @return {?}
             */
            function (v) {
                /** @type {?} */
                var n = opts.data.find((/**
                 * @param {?} item
                 * @return {?}
                 */
                function (item) { return item[opts.valueField].toString() == v; }));
                if (n) {
                    str_1.push(n[opts.textField]);
                }
            }));
            if (str_1.length) {
                return str_1.join(',');
            }
            return value;
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.imageFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        if (value) {
            if (opts) {
                /** @type {?} */
                var arrStr = ["<img src=\"" + value + "\" "];
                if (opts.width) {
                    arrStr.push("width=\"" + opts.width + "\"");
                }
                if (opts.height) {
                    arrStr.push("height=\"" + opts.height + "\"");
                }
                arrStr.push('>');
                return arrStr.join('');
            }
            else {
                return "<img src=\"" + value + "\">";
            }
        }
        return value;
    };
    /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    ColumnFormatService.prototype.booleanFormat = /**
     * @private
     * @param {?} value
     * @param {?=} opts
     * @return {?}
     */
    function (value, opts) {
        if (value !== undefined) {
            if (opts) {
                /** @type {?} */
                var val = value ? opts.trueText : opts.falseText;
                if (val === null || val === undefined) {
                    return value;
                }
                return val;
            }
            else {
                return value;
            }
        }
        return '';
    };
    /**
     * @private
     * @param {?} val
     * @return {?}
     */
    ColumnFormatService.prototype.convertCompare = /**
     * @private
     * @param {?} val
     * @return {?}
     */
    function (val) {
        /** @type {?} */
        var op = CompareOperators.find((/**
         * @param {?} item
         * @return {?}
         */
        function (item) { return item.value === val; }));
        if (op) {
            return op.label;
        }
    };
    /**
     * @param {?} sorts
     * @return {?}
     */
    ColumnFormatService.prototype.buildSortString = /**
     * @param {?} sorts
     * @return {?}
     */
    function (sorts) {
        if (sorts && sorts.length) {
            /** @type {?} */
            var str = sorts.map((/**
             * @param {?} s
             * @return {?}
             */
            function (s) {
                return s.sortField + " " + SortType[s.sortType].toString().toLowerCase() + ",";
            })).join(' ');
            if (str) {
                str = str.substr(0, str.length - 1);
            }
            return str;
        }
        return '';
    };
    /**
     * @param {?} conditions
     * @return {?}
     */
    ColumnFormatService.prototype.buildSqlWhere = /**
     * @param {?} conditions
     * @return {?}
     */
    function (conditions) {
        var _this = this;
        if (conditions && conditions.length) {
            /** @type {?} */
            var result_1 = [];
            /** @type {?} */
            var conditionList_1 = conditions.filter((/**
             * @param {?} c
             * @return {?}
             */
            function (c) { return c.filterField !== ''; }));
            conditionList_1.forEach((/**
             * @param {?} condition
             * @param {?} index
             * @return {?}
             */
            function (condition, index) {
                if (!condition.filterField) {
                    return;
                }
                result_1.push(condition.lbracket);
                result_1.push(condition.filterField);
                /** @type {?} */
                var opCode = parseInt(condition.compare.toString(), 10);
                /** @type {?} */
                var op = _this.convertCompare(opCode);
                result_1.push(' ' + op.replace(/\%/g, '').replace('...', ''));
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.NotLikeEndWith
                    || opCode === Compare.LikeEndWith) {
                    result_1.push('\'');
                    result_1.push('%');
                }
                else {
                    result_1.push(' ');
                    result_1.push('\'');
                }
                if (opCode === Compare.In || opCode === Compare.NotIn) {
                    result_1.push(condition.value.replace(/\r\n/g, ','));
                }
                else {
                    result_1.push(condition.value);
                }
                if (opCode === Compare.Like || opCode === Compare.NotLike
                    || opCode === Compare.LikeStartWith || opCode === Compare.NotLikeStartWith) {
                    result_1.push('%');
                }
                result_1.push('\'');
                result_1.push(condition.rbracket);
                result_1.push(' ');
                if (index !== conditionList_1.length - 1) {
                    result_1.push(condition.relation === FilterRelation.Empty ? '' :
                        FilterRelation[condition.relation].toString().toLowerCase());
                    result_1.push(' ');
                }
            }));
            return result_1.join('');
        }
        return '';
    };
    ColumnFormatService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */
    ColumnFormatService.ctorParameters = function () { return [
        { type: DateTimeHelperService },
        { type: NumberHelperService }
    ]; };
    /** @nocollapse */ ColumnFormatService.ngInjectableDef = i0.defineInjectable({ factory: function ColumnFormatService_Factory() { return new ColumnFormatService(i0.inject(i1.DateTimeHelperService), i0.inject(i2.NumberHelperService)); }, token: ColumnFormatService, providedIn: "root" });
    return ColumnFormatService;
}());
export { ColumnFormatService };
if (false) {
    /** @type {?} */
    ColumnFormatService.prototype.datehelper;
    /** @type {?} */
    ColumnFormatService.prototype.numberhelper;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1jb21tb24vY29sdW1uLyIsInNvdXJjZXMiOlsiY29sdW1uLWZvcm1hdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBc0IsTUFBTSxlQUFlLENBQUM7QUFDL0QsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDL0QsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFL0QsT0FBTyxFQUFtQixPQUFPLEVBQUUsY0FBYyxFQUFFLGdCQUFnQixFQUFpQixRQUFRLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQzs7Ozs7Ozs7Ozs7O0FBUzlIO0lBSUksNkJBQW1CLFVBQWlDLEVBQVMsWUFBaUM7UUFBM0UsZUFBVSxHQUFWLFVBQVUsQ0FBdUI7UUFBUyxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7SUFDOUYsQ0FBQzs7Ozs7Ozs7SUFFRCxvQ0FBTTs7Ozs7OztJQUFOLFVBQU8sS0FBVSxFQUFFLElBQVUsRUFBRSxTQUFlLEVBQUUsT0FBYTtRQUN6RCxJQUFJLFNBQVMsRUFBRTtZQUNYLElBQUksT0FBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLFVBQVUsRUFBRTtnQkFDbEMsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7Z0JBQ3hCLE9BQU8sU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLHFCQUFJLElBQUksRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE1BQU0sRUFBRSxJQUFJLElBQUssT0FBTyxFQUFHLENBQUM7YUFDakg7aUJBQU07Z0JBQ0gsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUU7O3dCQUNiLEdBQUcsR0FBRyxtQkFBQSxTQUFTLEVBQW1CO29CQUN4QyxRQUFRLEdBQUcsQ0FBQyxJQUFJLEVBQUU7d0JBQ2QsS0FBSyxVQUFVOzRCQUNYLElBQUksR0FBRyxDQUFDLE9BQU8sSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtnQ0FDbkMsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7NkJBQ2xEOzRCQUNELE9BQU8sS0FBSyxDQUFDO3dCQUNqQixLQUFLLFFBQVE7NEJBQ1QsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ2pELEtBQUssTUFBTTs0QkFDUCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQzt3QkFDL0MsS0FBSyxPQUFPOzRCQUNSLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUNoRCxLQUFLLFNBQVM7NEJBQ1YsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ2xEOzRCQUNJLE9BQU8sS0FBSyxDQUFDO3FCQUNwQjtpQkFDSjthQUNKO1NBQ0o7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDOzs7Ozs7O0lBRU8sNENBQWM7Ozs7OztJQUF0QixVQUF1QixLQUFVLEVBQUUsSUFBUztRQUN4QyxJQUFJLEtBQUssRUFBRTs7Z0JBQ0gsR0FBRyxHQUFHLFlBQVk7WUFDdEIsSUFBSSxPQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssUUFBUSxFQUFFO2dCQUMzQixHQUFHLEdBQUcsSUFBSSxDQUFDO2FBQ2Q7aUJBQU0sSUFBSSxPQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssUUFBUSxFQUFFO2dCQUNsQyxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQzthQUNyQjtZQUVELEdBQUcsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRXhELElBQUksT0FBTSxDQUFDLElBQUksQ0FBQyxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFOztvQkFFdkMsUUFBUSxHQUFHLElBQUksQ0FBQyx1QkFBdUIsSUFBSSxHQUFHO2dCQUVoRCxJQUFBLDZDQUE2QyxFQUE1QyxpQkFBUyxFQUFFLGVBQWlDO2dCQUNqRCxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUNyRCxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDO2dCQUVqRCxPQUFPLFNBQVMsR0FBRyxRQUFRLEdBQUksT0FBTyxDQUFDO2FBQzFDO1lBRUQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDL0M7UUFFRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDOzs7Ozs7O0lBRU8sMENBQVk7Ozs7OztJQUFwQixVQUFxQixLQUFVLEVBQUUsSUFBMEI7UUFDdkQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbkQsOERBQThEO1FBQzlELHlEQUF5RDtRQUN6RCxJQUFJO1FBQ0osZ0JBQWdCO0lBQ3BCLENBQUM7Ozs7Ozs7SUFFTyx3Q0FBVTs7Ozs7O0lBQWxCLFVBQW1CLEtBQVUsRUFBRSxJQUF3QjtRQUNuRCxJQUFJLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLElBQUksRUFBRztZQUN4QyxLQUFLLEdBQUcsRUFBRSxDQUFDO1NBQ2Q7UUFFRCxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFOztnQkFDakMsR0FBRyxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUU7O2dCQUN4QixHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFDZixJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRyxLQUFLO2dCQUMvQixHQUFHLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN4Qjs7Z0JBRUssS0FBRyxHQUFHLEVBQUU7WUFDZCxHQUFHLENBQUMsT0FBTzs7OztZQUFDLFVBQUEsQ0FBQzs7b0JBQ0gsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSTs7OztnQkFBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFyQyxDQUFxQyxFQUFDO2dCQUN2RSxJQUFJLENBQUMsRUFBRTtvQkFDSCxLQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztpQkFDL0I7WUFDTCxDQUFDLEVBQUMsQ0FBQztZQUVILElBQUksS0FBRyxDQUFDLE1BQU0sRUFBRTtnQkFDWixPQUFPLEtBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDeEI7WUFFRCxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7Ozs7SUFFTyx5Q0FBVzs7Ozs7O0lBQW5CLFVBQW9CLEtBQUssRUFBRSxJQUF5QjtRQUNoRCxJQUFJLEtBQUssRUFBRTtZQUNQLElBQUksSUFBSSxFQUFFOztvQkFDQSxNQUFNLEdBQUcsQ0FBRSxnQkFBYSxLQUFLLFFBQUksQ0FBQztnQkFDeEMsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO29CQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBVSxJQUFJLENBQUMsS0FBSyxPQUFHLENBQUMsQ0FBQztpQkFDeEM7Z0JBQ0QsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsY0FBVyxJQUFJLENBQUMsTUFBTSxPQUFHLENBQUMsQ0FBQztpQkFDMUM7Z0JBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQzFCO2lCQUFNO2dCQUNILE9BQU8sZ0JBQWEsS0FBSyxRQUFJLENBQUM7YUFDakM7U0FDSjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Ozs7Ozs7SUFFTywyQ0FBYTs7Ozs7O0lBQXJCLFVBQXNCLEtBQUssRUFBRSxJQUEyQjtRQUNwRCxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDckIsSUFBSSxJQUFJLEVBQUU7O29CQUNBLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTO2dCQUNsRCxJQUFJLEdBQUcsS0FBSyxJQUFJLElBQUksR0FBRyxLQUFLLFNBQVMsRUFBRTtvQkFDbkMsT0FBTyxLQUFLLENBQUM7aUJBQ2hCO2dCQUVELE9BQU8sR0FBRyxDQUFDO2FBQ2Q7aUJBQU07Z0JBQ0gsT0FBTyxLQUFLLENBQUM7YUFDaEI7U0FDSjtRQUNELE9BQU8sRUFBRSxDQUFDO0lBQ2QsQ0FBQzs7Ozs7O0lBR08sNENBQWM7Ozs7O0lBQXRCLFVBQXVCLEdBQVc7O1lBQ3hCLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJOzs7O1FBQUUsVUFBQyxJQUFTLElBQUssT0FBQSxJQUFJLENBQUMsS0FBSyxLQUFLLEdBQUcsRUFBbEIsQ0FBa0IsRUFBQztRQUNwRSxJQUFJLEVBQUUsRUFBRTtZQUNKLE9BQU8sRUFBRSxDQUFDLEtBQUssQ0FBQztTQUNuQjtJQUNMLENBQUM7Ozs7O0lBRUQsNkNBQWU7Ozs7SUFBZixVQUFnQixLQUFzQjtRQUNsQyxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFOztnQkFDbkIsR0FBRyxHQUFHLEtBQUssQ0FBQyxHQUFHOzs7O1lBQUMsVUFBQSxDQUFDO2dCQUNqQixPQUFVLENBQUMsQ0FBQyxTQUFTLFNBQUksUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLEVBQUUsTUFBRyxDQUFDO1lBQzlFLENBQUMsRUFBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7WUFFWixJQUFJLEdBQUcsRUFBRTtnQkFDTCxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQzthQUN2QztZQUVELE9BQU8sR0FBRyxDQUFDO1NBQ2Q7UUFFRCxPQUFPLEVBQUUsQ0FBQztJQUNkLENBQUM7Ozs7O0lBRUQsMkNBQWE7Ozs7SUFBYixVQUFjLFVBQTZCO1FBQTNDLGlCQWtEQztRQWpERyxJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxFQUFFOztnQkFDM0IsUUFBTSxHQUFHLEVBQUU7O2dCQUNYLGVBQWEsR0FBRyxVQUFVLENBQUMsTUFBTTs7OztZQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLFdBQVcsS0FBSyxFQUFFLEVBQXBCLENBQW9CLEVBQUM7WUFDbEUsZUFBYSxDQUFDLE9BQU87Ozs7O1lBQUMsVUFBQyxTQUFTLEVBQUUsS0FBSztnQkFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7b0JBQ3hCLE9BQU87aUJBQ1Y7Z0JBQ0QsUUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ2hDLFFBQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxDQUFDOztvQkFFN0IsTUFBTSxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQzs7b0JBQ25ELEVBQUUsR0FBRyxLQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQztnQkFDdEMsUUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUU1RCxJQUFJLE1BQU0sS0FBSyxPQUFPLENBQUMsSUFBSSxJQUFJLE1BQU0sS0FBSyxPQUFPLENBQUMsT0FBTzt1QkFDOUMsTUFBTSxLQUFLLE9BQU8sQ0FBQyxjQUFjO3VCQUNqQyxNQUFNLEtBQUssT0FBTyxDQUFDLFdBQVcsRUFBRTtvQkFDdkMsUUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDbEIsUUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztpQkFDcEI7cUJBQU07b0JBQ0gsUUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDakIsUUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDckI7Z0JBRUQsSUFBSSxNQUFNLEtBQUssT0FBTyxDQUFDLEVBQUUsSUFBSSxNQUFNLEtBQUssT0FBTyxDQUFDLEtBQUssRUFBRTtvQkFDbkQsUUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQztpQkFDdEQ7cUJBQU07b0JBQ0gsUUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ2hDO2dCQUVELElBQUksTUFBTSxLQUFLLE9BQU8sQ0FBQyxJQUFJLElBQUksTUFBTSxLQUFLLE9BQU8sQ0FBQyxPQUFPO3VCQUNsRCxNQUFNLEtBQUssT0FBTyxDQUFDLGFBQWEsSUFBSSxNQUFNLEtBQUssT0FBTyxDQUFDLGdCQUFnQixFQUFFO29CQUM1RSxRQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNwQjtnQkFDRCxRQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNsQixRQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDaEMsUUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFFakIsSUFBSSxLQUFLLEtBQUssZUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQ3BDLFFBQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsS0FBSyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQzt3QkFDOUIsY0FBYyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO29CQUM3RixRQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNwQjtZQUNMLENBQUMsRUFBQyxDQUFDO1lBRUgsT0FBTyxRQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQzFCO1FBRUQsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDOztnQkF0TkosVUFBVSxTQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQjs7OztnQkFiUSxxQkFBcUI7Z0JBRHJCLG1CQUFtQjs7OzhCQUQ1QjtDQW9PQyxBQXZORCxJQXVOQztTQXBOWSxtQkFBbUI7OztJQUNoQix5Q0FBd0M7O0lBQUUsMkNBQXdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE51bWJlckhlbHBlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9udW1iZXInO1xyXG5pbXBvcnQgeyBEYXRlVGltZUhlbHBlclNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi9kYXRlJztcclxuaW1wb3J0IHsgQ29sdW1uRm9ybWF0dGVyLCBOdW1iZXJGb3JtYXRPcHRpb25zLCBFbnVtRm9ybWF0T3B0aW9ucywgSW1hZ2VGb3JtYXRPcHRpb25zLCBCb29sZWFuRm9ybWF0T3B0aW9ucyB9IGZyb20gJy4vY29sdW1uLWZvcm1hdC5vcHRpb25zJztcclxuaW1wb3J0IHsgRmlsdGVyQ29uZGl0aW9uLCBDb21wYXJlLCBGaWx0ZXJSZWxhdGlvbiwgQ29tcGFyZU9wZXJhdG9ycywgU29ydENvbmRpdGlvbiwgU29ydFR5cGUgfSBmcm9tICdAZmFycmlzL3VpLWNvbW1vbi90eXBlcyc7XHJcbi8qXHJcbiAqIEBBdXRob3I6IOeWr+eLguengOaJjShMdWNhcyBIdWFuZylcclxuICogQERhdGU6IDIwMTktMDEtMDIgMTQ6MTI6NDdcclxuICogQExhc3RFZGl0b3JzOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBMYXN0RWRpdFRpbWU6IDIwMTktMTAtMTggMTM6NTk6MzRcclxuICogQENvbXBhbnk6IEluc3B1clxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIENvbHVtbkZvcm1hdFNlcnZpY2Uge1xyXG4gICAgY29uc3RydWN0b3IocHVibGljIGRhdGVoZWxwZXI6IERhdGVUaW1lSGVscGVyU2VydmljZSwgcHVibGljIG51bWJlcmhlbHBlcjogTnVtYmVySGVscGVyU2VydmljZSkge1xyXG4gICAgfVxyXG5cclxuICAgIGZvcm1hdCh2YWx1ZTogYW55LCBkYXRhPzogYW55LCBmb3JtYXR0ZXI/OiBhbnksIGNvbnRleHQ/OiBhbnkpIHtcclxuICAgICAgICBpZiAoZm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YoZm9ybWF0dGVyKSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICAgICAgICAgICAgY29udGV4dCA9IGNvbnRleHQgfHwge307XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZm9ybWF0dGVyKHZhbHVlLCBkYXRhLCB7IGRhdGU6IHRoaXMuZGF0ZWhlbHBlciwgbnVtYmVyOiB0aGlzLm51bWJlcmhlbHBlciwgZm9ybWF0OiB0aGlzLCAuLi5jb250ZXh0IH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZvcm1hdHRlclsndHlwZSddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm10ID0gZm9ybWF0dGVyIGFzIENvbHVtbkZvcm1hdHRlcjtcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGZtdC50eXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2RhdGV0aW1lJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbXQub3B0aW9ucyAmJiBmbXQub3B0aW9ucy5mb3JtYXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRlVGltZUZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubnVtYmVyRm9ybWF0KHZhbHVlLCBmbXQub3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ2VudW0nOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW51bUZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdpbWFnZSc6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbWFnZUZvcm1hdCh2YWx1ZSwgZm10Lm9wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjYXNlICdib29sZWFuJzpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmJvb2xlYW5Gb3JtYXQodmFsdWUsIGZtdC5vcHRpb25zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZGF0ZVRpbWVGb3JtYXQodmFsdWU6IGFueSwgb3B0czogYW55KSB7XHJcbiAgICAgICAgaWYgKHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGxldCBmbXQgPSAneXl5eS1NTS1kZCc7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2Yob3B0cykgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICBmbXQgPSBvcHRzO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZihvcHRzKSA9PT0gJ29iamVjdCcpIHtcclxuICAgICAgICAgICAgICAgIGZtdCA9IG9wdHMuZm9ybWF0O1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBmbXQgPSBmbXQucmVwbGFjZSgnWVlZWScsICd5eXl5JykucmVwbGFjZSgnLUREJywgJy1kZCcpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHR5cGVvZihvcHRzKSA9PT0gJ29iamVjdCcgJiYgb3B0cy5kYXRlUmFuZ2UpIHtcclxuXHJcbiAgICAgICAgICAgICAgICBjb25zdCBzcGxpdFN0ciA9IG9wdHMuZGF0ZVJhbmdlRGF0ZXNEZWxpbWl0ZXIgfHwgJ34nO1xyXG5cclxuICAgICAgICAgICAgICAgIGxldCBbYmVnaW5EYXRlLCBlbmREYXRlIF0gPSB2YWx1ZS5zcGxpdChzcGxpdFN0cik7XHJcbiAgICAgICAgICAgICAgICBiZWdpbkRhdGUgPSB0aGlzLmRhdGVoZWxwZXIuZm9ybWF0VG8oYmVnaW5EYXRlLCBmbXQpO1xyXG4gICAgICAgICAgICAgICAgZW5kRGF0ZSA9IHRoaXMuZGF0ZWhlbHBlci5mb3JtYXRUbyhlbmREYXRlLCBmbXQpO1xyXG5cclxuICAgICAgICAgICAgICAgIHJldHVybiBiZWdpbkRhdGUgKyBzcGxpdFN0ciArICBlbmREYXRlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRlaGVscGVyLmZvcm1hdFRvKHZhbHVlLCBmbXQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgbnVtYmVyRm9ybWF0KHZhbHVlOiBhbnksIG9wdHM/OiBOdW1iZXJGb3JtYXRPcHRpb25zKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMubnVtYmVyaGVscGVyLmZvcm1hdE51bWJlcih2YWx1ZSwgb3B0cyk7XHJcbiAgICAgICAgLy8gaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09ICcnICYmIHZhbHVlICE9PSBOYU4pIHtcclxuICAgICAgICAvLyAgICAgcmV0dXJuIHRoaXMubnVtYmVyaGVscGVyLmZvcm1hdE1vbmV5KHZhbHVlLCBvcHRzKTtcclxuICAgICAgICAvLyB9XHJcbiAgICAgICAgLy8gcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZW51bUZvcm1hdCh2YWx1ZTogYW55LCBvcHRzPzogRW51bUZvcm1hdE9wdGlvbnMpIHtcclxuICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCApIHtcclxuICAgICAgICAgICAgdmFsdWUgPSAnJztcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChvcHRzICYmIG9wdHMuZGF0YSAmJiBvcHRzLmRhdGEubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHZhbHVlLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgICAgIGxldCBhcnIgPSBbdmFsXTtcclxuICAgICAgICAgICAgaWYgKHZhbC5pbmRleE9mKCcsJykgPiAtMSkgeyAgLy8g5aSa6YCJXHJcbiAgICAgICAgICAgICAgICBhcnIgPSB2YWwuc3BsaXQoJywnKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgc3RyID0gW107XHJcbiAgICAgICAgICAgIGFyci5mb3JFYWNoKHYgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbiA9IG9wdHMuZGF0YS5maW5kKGl0ZW0gPT4gaXRlbVtvcHRzLnZhbHVlRmllbGRdLnRvU3RyaW5nKCkgPT0gdik7XHJcbiAgICAgICAgICAgICAgICBpZiAobikge1xyXG4gICAgICAgICAgICAgICAgICAgIHN0ci5wdXNoKG5bb3B0cy50ZXh0RmllbGRdKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBpZiAoc3RyLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHN0ci5qb2luKCcsJyk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW1hZ2VGb3JtYXQodmFsdWUsIG9wdHM/OiBJbWFnZUZvcm1hdE9wdGlvbnMpIHtcclxuICAgICAgICBpZiAodmFsdWUpIHtcclxuICAgICAgICAgICAgaWYgKG9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFyclN0ciA9IFsgYDxpbWcgc3JjPVwiJHt2YWx1ZX1cIiBgXTtcclxuICAgICAgICAgICAgICAgIGlmIChvcHRzLndpZHRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyU3RyLnB1c2goYHdpZHRoPVwiJHtvcHRzLndpZHRofVwiYCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpZiAob3B0cy5oZWlnaHQpIHtcclxuICAgICAgICAgICAgICAgICAgICBhcnJTdHIucHVzaChgaGVpZ2h0PVwiJHtvcHRzLmhlaWdodH1cImApO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGFyclN0ci5wdXNoKCc+Jyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYXJyU3RyLmpvaW4oJycpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGA8aW1nIHNyYz1cIiR7dmFsdWV9XCI+YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYm9vbGVhbkZvcm1hdCh2YWx1ZSwgb3B0cz86IEJvb2xlYW5Gb3JtYXRPcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgaWYgKG9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IHZhbHVlID8gb3B0cy50cnVlVGV4dCA6IG9wdHMuZmFsc2VUZXh0O1xyXG4gICAgICAgICAgICAgICAgaWYgKHZhbCA9PT0gbnVsbCB8fCB2YWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdmFsO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjb252ZXJ0Q29tcGFyZSh2YWw6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IG9wID0gQ29tcGFyZU9wZXJhdG9ycy5maW5kKCAoaXRlbTogYW55KSA9PiBpdGVtLnZhbHVlID09PSB2YWwpO1xyXG4gICAgICAgIGlmIChvcCkge1xyXG4gICAgICAgICAgICByZXR1cm4gb3AubGFiZWw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGJ1aWxkU29ydFN0cmluZyhzb3J0czogU29ydENvbmRpdGlvbltdKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoc29ydHMgJiYgc29ydHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGxldCBzdHIgPSBzb3J0cy5tYXAocyA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYCR7cy5zb3J0RmllbGR9ICR7U29ydFR5cGVbcy5zb3J0VHlwZV0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpfSxgO1xyXG4gICAgICAgICAgICB9KS5qb2luKCcgJyk7XHJcblxyXG4gICAgICAgICAgICBpZiAoc3RyKSB7XHJcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyKDAsIHN0ci5sZW5ndGggLSAxKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmV0dXJuIHN0cjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiAnJztcclxuICAgIH1cclxuXHJcbiAgICBidWlsZFNxbFdoZXJlKGNvbmRpdGlvbnM6IEZpbHRlckNvbmRpdGlvbltdKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoY29uZGl0aW9ucyAmJiBjb25kaXRpb25zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgICAgICAgICAgY29uc3QgY29uZGl0aW9uTGlzdCA9IGNvbmRpdGlvbnMuZmlsdGVyKGMgPT4gYy5maWx0ZXJGaWVsZCAhPT0gJycpO1xyXG4gICAgICAgICAgICBjb25kaXRpb25MaXN0LmZvckVhY2goKGNvbmRpdGlvbiwgaW5kZXgpID0+IHtcclxuICAgICAgICAgICAgICAgIGlmICghY29uZGl0aW9uLmZpbHRlckZpZWxkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLmxicmFja2V0KTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi5maWx0ZXJGaWVsZCk7XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3BDb2RlID0gcGFyc2VJbnQoY29uZGl0aW9uLmNvbXBhcmUudG9TdHJpbmcoKSwgMTApO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgb3AgPSB0aGlzLmNvbnZlcnRDb21wYXJlKG9wQ29kZSk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnICcgKyBvcC5yZXBsYWNlKC9cXCUvZywgJycpLnJlcGxhY2UoJy4uLicsICcnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKG9wQ29kZSA9PT0gQ29tcGFyZS5MaWtlIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RMaWtlXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RMaWtlRW5kV2l0aFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB8fCBvcENvZGUgPT09IENvbXBhcmUuTGlrZUVuZFdpdGgpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXFwnJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyUnKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyAnKTtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnXFwnJyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgaWYgKG9wQ29kZSA9PT0gQ29tcGFyZS5JbiB8fCBvcENvZGUgPT09IENvbXBhcmUuTm90SW4pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24udmFsdWUucmVwbGFjZSgvXFxyXFxuL2csICcsJykpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaChjb25kaXRpb24udmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmIChvcENvZGUgPT09IENvbXBhcmUuTGlrZSB8fCBvcENvZGUgPT09IENvbXBhcmUuTm90TGlrZVxyXG4gICAgICAgICAgICAgICAgICAgIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5MaWtlU3RhcnRXaXRoIHx8IG9wQ29kZSA9PT0gQ29tcGFyZS5Ob3RMaWtlU3RhcnRXaXRoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goJyUnKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKCdcXCcnKTtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbmRpdGlvbi5yYnJhY2tldCk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnICcpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChpbmRleCAhPT0gY29uZGl0aW9uTGlzdC5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0LnB1c2goY29uZGl0aW9uLnJlbGF0aW9uID09PSBGaWx0ZXJSZWxhdGlvbi5FbXB0eSA/ICcnIDpcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEZpbHRlclJlbGF0aW9uW2NvbmRpdGlvbi5yZWxhdGlvbl0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpKTtcclxuICAgICAgICAgICAgICAgICAgICByZXN1bHQucHVzaCgnICcpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQuam9pbignJyk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gJyc7XHJcbiAgICB9XHJcbn1cclxuIl19