import { Injectable, Optional } from '@angular/core';
import { of, empty, EMPTY } from 'rxjs';
import { tap, switchMap, concatMap } from 'rxjs/operators';
import { Repository, BindingData, ViewModel, EntityPathConverter } from '@farris/devkit';
import { BefRepositoryUtil } from '@farris/bef';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { FormNotifyService } from '../form-notify.service';
import { LanguageService } from '../languag.service';
import { FormMessageService } from '../form-message.service';
import { FormErrorService } from '../error/form-error.service';
import { CommandService } from '../command-service';
import { FilterConditionService } from '../filter-condition.service';
// tslint:disable: no-string-literal max-line-length
/**
 * 列表仓库服务
 */
class ListDataService {
    /**
     * 构造
     * @param msgService msgService
     * @param repository repository
     * @param bindingData bindingData
     * @param loadingService loadingService
     * @param languageService languageService
     * @param formNotifyService formNotifyService
     * @param formErrorService formErrorService
     * ! @param viewModel viewModel,vm是后期注入的，老表单获取不到，一定要做非空判断
     * @param filterConditionService filterConditionService
     */
    constructor(msgService, repository, bindingData, loadingService, languageService, formNotifyService, formErrorService, viewModel, filterConditionService) {
        this.msgService = msgService;
        this.repository = repository;
        this.bindingData = bindingData;
        this.loadingService = loadingService;
        this.languageService = languageService;
        this.formNotifyService = formNotifyService;
        this.formErrorService = formErrorService;
        this.viewModel = viewModel;
        this.filterConditionService = filterConditionService;
        if (!languageService) {
            this.languageService = LanguageService.getInstance();
        }
        // if (!filterConditionService) {
        //   this.filterConditionService = new FilterConditionService();
        // }
    }
    /**
     * 加载
     */
    load(filter, sort) {
        // 参数处理
        filter = !filter ? '[]' : filter;
        sort = !sort ? '[]' : sort;
        // 合并过滤条件
        filter = this.mergeFilterConditions(filter);
        // 合并排序条件
        sort = this.mergeSortConditions(sort);
        const loadingTimerId = this.loadingService.showLoadingWithDelay(200);
        const query$ = this.repository.getEntities(JSON.parse(filter), JSON.parse(sort), null, null);
        return query$.pipe(tap(() => {
            // 触发远端合计事件
            this.fireQueryEvent(filter);
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.loadFailed, error);
        }));
    }
    /**
     * 过滤数据
     * @param filter 过滤条件
     * @param sort 排序条件
     */
    filter(filter, sort) {
        // 参数处理
        filter = !filter ? '[]' : filter;
        sort = !sort ? '[]' : sort;
        // 合并过滤条件
        filter = this.mergeFilterConditions(filter);
        // 合并排序条件
        sort = this.mergeSortConditions(sort);
        const loadingTimerId = this.loadingService.showLoadingWithDelay(200);
        const query$ = this.repository.filter(JSON.parse(filter), JSON.parse(sort));
        return query$.pipe(tap(() => {
            // 触发远端合计事件
            this.fireQueryEvent(filter);
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.loadFailed, error);
        }));
    }
    /**
     * 查询
     */
    query(filter, sort, pageSize, pageIndex) {
        // 参数处理
        filter = (filter === '') ? '[]' : filter;
        sort = (sort === '') ? '[]' : sort;
        // 合并过滤条件
        filter = this.mergeFilterConditions(filter);
        // 合并排序条件
        sort = this.mergeSortConditions(sort);
        // 执行取数
        const loadingTimerId = this.loadingService.showLoadingWithDelay(5);
        const query$ = this.repository.getEntities(JSON.parse(filter), JSON.parse(sort), pageSize, pageIndex);
        return query$.pipe(tap(() => {
            // 触发远端合计事件
            this.fireQueryEvent(filter);
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, (error) => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.queryFailed, error);
        }));
    }
    queryChild(filter, sort) {
        // const isUpdateWithPaging = this.viewModel.frameContext.root.params.get('updateWithPaging') || false;
        // if (isUpdateWithPaging) {
        //   return of(null);
        // }
        // tslint:disable-next-line: max-line-length
        const fullPaths = EntityPathConverter.toEntityPathArray(this.viewModel.bindingPath, this.bindingData);
        const paths = fullPaths.slice(0, fullPaths.length - 1);
        // debug
        // tslint:disable-next-line: max-line-length
        const bindingPaths = this.viewModel.bindingPath.split('/').filter(item => item);
        const bindingData = this.viewModel.bindingData;
        let nodeCode = bindingPaths[bindingPaths.length - 1];
        nodeCode = nodeCode.substr(0, nodeCode.length - 1);
        // 获取上级实体
        const parentPaths = bindingPaths.slice(0, bindingPaths.length - 1);
        const BindingList = bindingData.getValue(parentPaths);
        if (!BindingList) {
            return;
        }
        this.viewModel.frameContext.appContext.params.delete("retrieveing");
        const configPath = `/${nodeCode}`;
        const config = this.repository.entityCollection.getPaginationConfigByPath(configPath);
        if (config) {
            const { pageIndex = 1, pageSize = 0 } = config;
            // pageSize = 0表示未分页
            if (pageSize !== 0) {
                this.viewModel.frameContext.appContext.params.set('queryChild', true);
                const request$ = this.repository.queryChild(paths, pageIndex, pageSize);
                return request$.pipe(tap(() => { }, error => {
                    this.formErrorService.exception(this.languageService.queryFailed, error);
                }));
            }
        }
    }
    /**
     * 获取分页信息
     * @param nodeCode nodeCode
     * @returns 分页信息，包括：分页大小、当前页码
     * @description 基本分页信息在分页信息中存储时key为nodeCode
     */
    /*private getPagingInfo(nodeCode: string) {
      const result: { pageIndex?: number, pageSize?: number } = {};
      const nodeCodePath = `/${nodeCode}`;
      const defaultPagingInfo = this.repository.entityCollection.getPaginationConfigByPath(nodeCodePath);
      const pageSize = defaultPagingInfo && defaultPagingInfo.pageSize || 0;
      const pageIndex = defaultPagingInfo && defaultPagingInfo.pageIndex || 1;
      result.pageIndex = pageIndex;
      result.pageSize = pageSize;
      return result;
    }*/
    /**
     * 追加一条新数据
     */
    append() {
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'append' });
        }
        const append$ = this.repository.append();
        return append$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, error => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.appendFailed, error);
        }));
    }
    /**
     * 当前行前或后插入数据
     * @param position 1 | -1
     */
    insert(position = -1) {
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'insert' });
        }
        const append$ = this.repository.insert(position);
        return append$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, error => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.appendFailed, error);
        }));
    }
    /**
     * 提交变更（批量编辑页面，行切换时提交增量）
     */
    updateChanges() {
        const update$ = this.repository.updateAllChanges();
        return update$;
    }
    /**
     * 批量保存
     * @param successMsg 自定义提示信息
     */
    save(successMsg) {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'save' });
        }
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const save$ = this.repository.applyChanges();
        const result$ = save$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            if (successMsg && successMsg.trim()) {
                this.formNotifyService.success(successMsg, { hideTitle: true });
            }
            else {
                this.formNotifyService.success(this.languageService.saveSuccess, { hideTitle: true });
            }
        }, error => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.multiSaveFailed, error);
        }));
        return result$;
    }
    /**
     * 删除
     * @param id 要删除的数据的id
     * @param ifSave 是否保存
     * @param successMsg 自定义提示信息
     * @param confirm 是否需要确认
     * @param breakable 是否可中断，ifSave为false时流会中断
     */
    remove(id, ifSave, successMsg, confirm = true, breakable = true) {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'delete' });
        }
        if (!id) {
            this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
            return empty();
        }
        confirm = (confirm === false || confirm === 'false') ? false : true;
        breakable = (breakable === false || breakable === 'false') ? false : true;
        const action$ = confirm ? this.msgService.question(this.languageService.confirmDeletion) : of(true);
        return action$.pipe(concatMap(result => {
            if (!result) {
                return empty();
            }
            ifSave = (ifSave === false || ifSave === 'false') ? false : true;
            const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
            const remove$ = this.repository.removeById(id, ifSave);
            if (!remove$) {
                return empty();
            }
            return remove$.pipe(tap(() => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
                }
            }, error => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                this.formErrorService.exception(this.languageService.deleteFailed, error);
            }), switchMap(() => {
                if (ifSave === true || !breakable) {
                    // return this.load();
                    return of([]);
                }
                else {
                    return empty();
                }
            }));
        }));
    }
    /**
     * 批量删除
     * @param ids ids
     * @param ifSave 是否保存
     * @param successMsg 自定义提示信息
     * @param deleteCurrentRowIfNoChecks 没有勾选时删除当前行
     */
    removeRows(ids, ifSave, successMsg, deleteCurrentRowIfNoChecks = false) {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'removeRows' });
        }
        deleteCurrentRowIfNoChecks = (deleteCurrentRowIfNoChecks === 'true' || deleteCurrentRowIfNoChecks === true) ? true : false;
        if (!ids || ids.length === 0) {
            const currentId = this.bindingData.list.currentId;
            if (deleteCurrentRowIfNoChecks === true && currentId) {
                ids = [this.bindingData.list.currentId];
            }
            else {
                this.formNotifyService.warning(this.languageService['plsSelectDeleteData'], { hideTitle: true });
                return empty();
            }
        }
        const action$ = this.msgService.confirm(this.languageService.confirmDeletion);
        return action$.pipe(concatMap(result => {
            if (!result) {
                return empty();
            }
            if (typeof ifSave === 'undefined') {
                ifSave = true;
            }
            if (typeof ifSave === 'string') {
                ifSave = ifSave.toLowerCase() === 'false' ? false : true;
            }
            ifSave = (ifSave === false) ? false : true;
            const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
            const remove$ = this.repository.removeByIds(ids, ifSave);
            if (!remove$) {
                return empty();
            }
            return remove$.pipe(tap(() => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                if (successMsg && successMsg.trim()) {
                    this.formNotifyService.success(successMsg, { hideTitle: true });
                }
                else {
                    this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
                }
                // this.formNotifyService.success(this.languageService.deleteSuccess, { hideTitle: true });
            }, error => {
                this.loadingService.hideDelayLoading(loadingTimerId);
                this.formErrorService.exception(this.languageService.deleteFailed, error);
            }), switchMap(() => {
                return of([]);
            }));
        }));
    }
    /**
     * 删除后的刷新
     */
    refreshAfterRemoving(loadCmdName, loadCmdFrameId) {
        if (this.viewModel && loadCmdName && loadCmdFrameId) {
            const commandService = this.viewModel.frameContext.injector.get(CommandService, null);
            return commandService.execute(loadCmdName, loadCmdFrameId);
        }
        return this.load();
    }
    /**
     * 刷新
     * @param loadCmdName 刷新命令
     * @param loadCmdFrameId 刷新命令所在的frameId
     */
    refresh(loadCmdName, loadCmdFrameId) {
        if (this.viewModel && loadCmdName && loadCmdFrameId) {
            const commandService = this.viewModel.frameContext.injector.get(CommandService, null);
            return commandService.execute(loadCmdName, loadCmdFrameId);
        }
        return this.load();
    }
    /**
     * 取消时检测未保存记录
     */
    cancel() {
        if (this.messagePipe) {
            this.messagePipe.next({ messageType: 'cancel' });
        }
        // 没有变更时直接取消
        const befRepository = this.repository;
        const hasUnsavedData = BefRepositoryUtil.isExistUnsaveData(befRepository);
        if (hasUnsavedData === false) {
            return this._cancel();
        }
        const confirmResult$ = this.msgService.question(this.languageService['cancelWithoutSave']).pipe(switchMap((ifCancel) => {
            if (ifCancel === false) {
                return EMPTY;
            }
            return this._cancel();
        }));
        return confirmResult$;
    }
    /**
     * 还原变更集
     * @description 不带变更检测提示
     */
    revert() {
        return this._cancel();
    }
    /**
     * 取消（内部取消）
     */
    _cancel() {
        const loadingTimerId = this.loadingService.showLoadingWithDelay(500);
        const cancel$ = this.repository.cancelChanges();
        return cancel$.pipe(tap(() => {
            this.loadingService.hideDelayLoading(loadingTimerId);
        }, error => {
            this.loadingService.hideDelayLoading(loadingTimerId);
            this.formErrorService.exception(this.languageService.cancelFailed, error);
        }));
    }
    /**
     * 获取根组件appContext
     */
    get messagePipe() {
        if (this.viewModel && this.viewModel.frameContext) {
            const appContext = this.viewModel.frameContext.getFormAppContext() || null;
            if (appContext) {
                return appContext.messagePipe || null;
            }
        }
        return null;
    }
    /**
     * 触发查询事件
     * @param filters 过滤条件
     */
    fireQueryEvent(filters) {
        const messagePipe = this.messagePipe;
        // const frameId = this.viewModel && this.viewModel.frameContext && this.viewModel.frameContext.frameId || null;
        if (messagePipe) {
            messagePipe.next({ type: 'query' });
        }
    }
    /**
     * 合并过滤条件
     * @param filter 表单过滤条件
     */
    mergeFilterConditions(filter) {
        if (typeof filter === 'string') {
            filter = JSON.parse(filter) || [];
        }
        const filters = filter;
        const bindingPath = this.viewModel && this.viewModel.bindingPath || null;
        if (bindingPath) {
            const originalConditions = this.viewModel && this.viewModel.frameContext.repository.filterConditionManager.getFilters(bindingPath) || [];
            // this.filterConditionService.getFilters(bindingPath) || [];
            const conditions = Array.from(originalConditions);
            if (conditions && conditions.length > 0) {
                /*filters.forEach((item: any, index: number) => {
                  const field = item.FilterField || null;
                  if (field) {
                    const duplicateIndex = conditions.findIndex(condition => condition.FilterField === field);
                    if (duplicateIndex !== -1) {
                      filters[index] = conditions[duplicateIndex];
                      conditions.splice(duplicateIndex, 1);
                    }
                  }
                });*/
                // 修改命令上过滤条件的最后一个查询关系为and
                if (filters.length > 0) {
                    // 最后一个过滤条件
                    const lastFilter = filters[filters.length - 1];
                    if (lastFilter) {
                        if (lastFilter.hasOwnProperty('Relation')) {
                            delete lastFilter.Relation;
                        }
                        lastFilter.relation = 1;
                    }
                }
                // 合并新的过滤条件和原来命令上的过滤条件
                filters.push(...conditions);
            }
        }
        return JSON.stringify(filters);
    }
    /**
     * 合并排序条件
     * @param sort 排序条件
     */
    mergeSortConditions(sort) {
        if (typeof sort === 'string') {
            sort = JSON.parse(sort) || [];
        }
        const sorts = sort;
        const bindingPath = this.viewModel && this.viewModel.bindingPath || null;
        if (bindingPath) {
            // 获取当前绑定路径的所有排序条件
            const originalConditions = this.viewModel && this.viewModel.frameContext.repository.sortConditionManager.getConditionsByBindingPath(bindingPath, (direction) => {
                if (direction === 'asc') {
                    return 0;
                }
                else {
                    return 1;
                }
            }) || [];
            const conditions = Array.from(originalConditions);
            // 如果当前绑定路径有排序条件，则忽略命令上预制的排序条件
            if (conditions && conditions.length > 0) {
                // 遍历已有的过滤条件，如果有重复的field，用后者的覆盖已有的
                /*sorts.forEach((item: any, index: number) => {
                  const field = item.SortField || null;
                  if (field) {
                    const duplicateIndex = conditions.findIndex(condition => condition.SortField === field);
                    if (duplicateIndex !== -1) {
                      sorts[index] = conditions[duplicateIndex];
                      conditions.splice(duplicateIndex, 1);
                    }
                  }
                });*/
                return JSON.stringify(conditions);
                // 将其余排序条件添加到排序数组
                // sorts.push(...conditions);
            }
        }
        return JSON.stringify(sorts);
    }
}
ListDataService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ListDataService.ctorParameters = () => [
    { type: FormMessageService },
    { type: Repository },
    { type: BindingData },
    { type: FormLoadingService },
    { type: LanguageService, decorators: [{ type: Optional }] },
    { type: FormNotifyService },
    { type: FormErrorService },
    { type: ViewModel },
    { type: FilterConditionService }
];
export { ListDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGlzdC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvZGF0YS1zZXJ2aWNlcy9saXN0LWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQWMsRUFBRSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFjLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkUsT0FBTyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQVUsU0FBUyxFQUFlLG1CQUFtQixFQUFpQixNQUFNLGdCQUFnQixDQUFDO0FBQzdILE9BQU8sRUFBaUIsaUJBQWlCLEVBQW1CLE1BQU0sYUFBYSxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQzFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzNELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNyRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDckUsb0RBQW9EO0FBRXBEOztHQUVHO0FBQ0gsTUFDTSxlQUFlO0lBRW5COzs7Ozs7Ozs7OztPQVdHO0lBQ0gsWUFDVSxVQUE4QixFQUM5QixVQUEyQixFQUMzQixXQUF3QixFQUN4QixjQUFrQyxFQUN0QixlQUFnQyxFQUM1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cUJBQU07b0JBQUUsT0FBTyxDQUFDLENBQUM7aUJBQUU7WUFDdEIsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1QsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ2xELDhCQUE4QjtZQUM5QixJQUFJLFVBQVUsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDdkMsa0NBQWtDO2dCQUNsQzs7Ozs7Ozs7O3FCQVNLO2dCQUNMLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztnQkFDbEMsaUJBQWlCO2dCQUNqQiw2QkFBNkI7YUFDOUI7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDOzs7WUE5aUJGLFVBQVU7Ozs7WUFURixrQkFBa0I7WUFMbEIsVUFBVTtZQUFFLFdBQVc7WUFFdkIsa0JBQWtCO1lBRWxCLGVBQWUsdUJBOEJuQixRQUFRO1lBL0JKLGlCQUFpQjtZQUdqQixnQkFBZ0I7WUFOaUIsU0FBUztZQVExQyxzQkFBc0I7O0FBc2pCL0IsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgT3B0aW9uYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCBlbXB0eSwgRU1QVFkgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHRhcCwgc3dpdGNoTWFwLCBjb25jYXRNYXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBCaW5kaW5nRGF0YSwgRW50aXR5LCBWaWV3TW9kZWwsIEJpbmRpbmdMaXN0LCBFbnRpdHlQYXRoQ29udmVydGVyLCBCaW5kaW5nT2JqZWN0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuaW1wb3J0IHsgQmVmUmVwb3NpdG9yeSwgQmVmUmVwb3NpdG9yeVV0aWwsIEJlZkRhdGFQYXRoVXRpbCB9IGZyb20gJ0BmYXJyaXMvYmVmJztcbmltcG9ydCB7IEZvcm1Mb2FkaW5nU2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbG9hZGluZy9mb3JtLWxvYWRpbmcuc2VydmljZSc7XG5pbXBvcnQgeyBGb3JtTm90aWZ5U2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vbGFuZ3VhZy5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1NZXNzYWdlU2VydmljZSB9IGZyb20gJy4uL2Zvcm0tbWVzc2FnZS5zZXJ2aWNlJztcbmltcG9ydCB7IEZvcm1FcnJvclNlcnZpY2UgfSBmcm9tICcuLi9lcnJvci9mb3JtLWVycm9yLnNlcnZpY2UnO1xuaW1wb3J0IHsgQ29tbWFuZFNlcnZpY2UgfSBmcm9tICcuLi9jb21tYW5kLXNlcnZpY2UnO1xuaW1wb3J0IHsgRmlsdGVyQ29uZGl0aW9uU2VydmljZSB9IGZyb20gJy4uL2ZpbHRlci1jb25kaXRpb24uc2VydmljZSc7XG4vLyB0c2xpbnQ6ZGlzYWJsZTogbm8tc3RyaW5nLWxpdGVyYWwgbWF4LWxpbmUtbGVuZ3RoXG5cbi8qKlxuICog5YiX6KGo5LuT5bqT5pyN5YqhXG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIExpc3REYXRhU2VydmljZSB7XG5cbiAgLyoqXG4gICAqIOaehOmAoFxuICAgKiBAcGFyYW0gbXNnU2VydmljZSBtc2dTZXJ2aWNlXG4gICAqIEBwYXJhbSByZXBvc2l0b3J5IHJlcG9zaXRvcnlcbiAgICogQHBhcmFtIGJpbmRpbmdEYXRhIGJpbmRpbmdEYXRhXG4gICAqIEBwYXJhbSBsb2FkaW5nU2VydmljZSBsb2FkaW5nU2VydmljZVxuICAgKiBAcGFyYW0gbGFuZ3VhZ2VTZXJ2aWNlIGxhbmd1YWdlU2VydmljZVxuICAgKiBAcGFyYW0gZm9ybU5vdGlmeVNlcnZpY2UgZm9ybU5vdGlmeVNlcnZpY2VcbiAgICogQHBhcmFtIGZvcm1FcnJvclNlcnZpY2UgZm9ybUVycm9yU2VydmljZVxuICAgKiAhIEBwYXJhbSB2aWV3TW9kZWwgdmlld01vZGVsLHZt5piv5ZCO5pyf5rOo5YWl55qE77yM6ICB6KGo5Y2V6I635Y+W5LiN5Yiw77yM5LiA5a6a6KaB5YGa6Z2e56m65Yik5patXG4gICAqIEBwYXJhbSBmaWx0ZXJDb25kaXRpb25TZXJ2aWNlIGZpbHRlckNvbmRpdGlvblNlcnZpY2VcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbXNnU2VydmljZTogRm9ybU1lc3NhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeTogUmVwb3NpdG9yeTxhbnk+LFxuICAgIHByaXZhdGUgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhLFxuICAgIHByaXZhdGUgbG9hZGluZ1NlcnZpY2U6IEZvcm1Mb2FkaW5nU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgZm9ybU5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgZm9ybUVycm9yU2VydmljZTogRm9ybUVycm9yU2VydmljZSxcbiAgICBwcml2YXRlIHZpZXdNb2RlbDogVmlld01vZGVsLFxuICAgIHByaXZhdGUgZmlsdGVyQ29uZGl0aW9uU2VydmljZTogRmlsdGVyQ29uZGl0aW9uU2VydmljZSxcbiAgKSB7XG4gICAgaWYgKCFsYW5ndWFnZVNlcnZpY2UpIHtcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlID0gTGFuZ3VhZ2VTZXJ2aWNlLmdldEluc3RhbmNlKCk7XG4gICAgfVxuXG4gICAgLy8gaWYgKCFmaWx0ZXJDb25kaXRpb25TZXJ2aWNlKSB7XG4gICAgLy8gICB0aGlzLmZpbHRlckNvbmRpdGlvblNlcnZpY2UgPSBuZXcgRmlsdGVyQ29uZGl0aW9uU2VydmljZSgpO1xuICAgIC8vIH1cbiAgfVxuXG4gIC8qKlxuICAgKiDliqDovb1cbiAgICovXG4gIHB1YmxpYyBsb2FkKGZpbHRlcj86IHN0cmluZywgc29ydD86IHN0cmluZyk6IE9ic2VydmFibGU8RW50aXR5W10+IHtcblxuICAgIC8vIOWPguaVsOWkhOeQhlxuICAgIGZpbHRlciA9ICFmaWx0ZXIgPyAnW10nIDogZmlsdGVyO1xuICAgIHNvcnQgPSAhc29ydCA/ICdbXScgOiBzb3J0O1xuICAgIC8vIOWQiOW5tui/h+a7pOadoeS7tlxuICAgIGZpbHRlciA9IHRoaXMubWVyZ2VGaWx0ZXJDb25kaXRpb25zKGZpbHRlcik7XG4gICAgLy8g5ZCI5bm25o6S5bqP5p2h5Lu2XG4gICAgc29ydCA9IHRoaXMubWVyZ2VTb3J0Q29uZGl0aW9ucyhzb3J0KTtcblxuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSgyMDApO1xuICAgIGNvbnN0IHF1ZXJ5JCA9IHRoaXMucmVwb3NpdG9yeS5nZXRFbnRpdGllcyhKU09OLnBhcnNlKGZpbHRlciksIEpTT04ucGFyc2Uoc29ydCksIG51bGwsIG51bGwpO1xuICAgIHJldHVybiBxdWVyeSQucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIC8vIOinpuWPkei/nOerr+WQiOiuoeS6i+S7tlxuICAgICAgICAgIHRoaXMuZmlyZVF1ZXJ5RXZlbnQoZmlsdGVyKTtcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICB9LFxuICAgICAgICAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5sb2FkRmFpbGVkLCBlcnJvcik7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDov4fmu6TmlbDmja5cbiAgICogQHBhcmFtIGZpbHRlciDov4fmu6TmnaHku7ZcbiAgICogQHBhcmFtIHNvcnQg5o6S5bqP5p2h5Lu2XG4gICAqL1xuICBwdWJsaWMgZmlsdGVyKGZpbHRlcj86IHN0cmluZywgc29ydD86IHN0cmluZyk6IE9ic2VydmFibGU8RW50aXR5W10+IHtcbiAgICAvLyDlj4LmlbDlpITnkIZcbiAgICBmaWx0ZXIgPSAhZmlsdGVyID8gJ1tdJyA6IGZpbHRlcjtcbiAgICBzb3J0ID0gIXNvcnQgPyAnW10nIDogc29ydDtcbiAgICAvLyDlkIjlubbov4fmu6TmnaHku7ZcbiAgICBmaWx0ZXIgPSB0aGlzLm1lcmdlRmlsdGVyQ29uZGl0aW9ucyhmaWx0ZXIpO1xuICAgIC8vIOWQiOW5tuaOkuW6j+adoeS7tlxuICAgIHNvcnQgPSB0aGlzLm1lcmdlU29ydENvbmRpdGlvbnMoc29ydCk7XG5cbiAgICBjb25zdCBsb2FkaW5nVGltZXJJZCA9IHRoaXMubG9hZGluZ1NlcnZpY2Uuc2hvd0xvYWRpbmdXaXRoRGVsYXkoMjAwKTtcbiAgICBjb25zdCBxdWVyeSQgPSB0aGlzLnJlcG9zaXRvcnkuZmlsdGVyKEpTT04ucGFyc2UoZmlsdGVyKSwgSlNPTi5wYXJzZShzb3J0KSk7XG4gICAgcmV0dXJuIHF1ZXJ5JC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgLy8g6Kem5Y+R6L+c56uv5ZCI6K6h5LqL5Lu2XG4gICAgICAgICAgdGhpcy5maXJlUXVlcnlFdmVudChmaWx0ZXIpO1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgIH0sXG4gICAgICAgIChlcnJvcjogYW55KSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmxvYWRGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOafpeivolxuICAgKi9cbiAgcHVibGljIHF1ZXJ5KGZpbHRlcjogc3RyaW5nLCBzb3J0OiBzdHJpbmcsIHBhZ2VTaXplOiBudW1iZXIsIHBhZ2VJbmRleDogbnVtYmVyKTogT2JzZXJ2YWJsZTxFbnRpdHlbXT4ge1xuICAgIC8vIOWPguaVsOWkhOeQhlxuICAgIGZpbHRlciA9IChmaWx0ZXIgPT09ICcnKSA/ICdbXScgOiBmaWx0ZXI7XG4gICAgc29ydCA9IChzb3J0ID09PSAnJykgPyAnW10nIDogc29ydDtcbiAgICAvLyDlkIjlubbov4fmu6TmnaHku7ZcbiAgICBmaWx0ZXIgPSB0aGlzLm1lcmdlRmlsdGVyQ29uZGl0aW9ucyhmaWx0ZXIpO1xuICAgIC8vIOWQiOW5tuaOkuW6j+adoeS7tlxuICAgIHNvcnQgPSB0aGlzLm1lcmdlU29ydENvbmRpdGlvbnMoc29ydCk7XG4gICAgLy8g5omn6KGM5Y+W5pWwXG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUpO1xuICAgIGNvbnN0IHF1ZXJ5JCA9IHRoaXMucmVwb3NpdG9yeS5nZXRFbnRpdGllcyhKU09OLnBhcnNlKGZpbHRlciksIEpTT04ucGFyc2Uoc29ydCksIHBhZ2VTaXplLCBwYWdlSW5kZXgpO1xuICAgIHJldHVybiBxdWVyeSQucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgIC8vIOinpuWPkei/nOerr+WQiOiuoeS6i+S7tlxuICAgICAgICAgIHRoaXMuZmlyZVF1ZXJ5RXZlbnQoZmlsdGVyKTtcbiAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICB9LFxuICAgICAgICAoZXJyb3I6IGFueSkgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5xdWVyeUZhaWxlZCwgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHB1YmxpYyBxdWVyeUNoaWxkKGZpbHRlcjogc3RyaW5nLCBzb3J0OiBzdHJpbmcpIHtcbiAgICAvLyBjb25zdCBpc1VwZGF0ZVdpdGhQYWdpbmcgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucm9vdC5wYXJhbXMuZ2V0KCd1cGRhdGVXaXRoUGFnaW5nJykgfHwgZmFsc2U7XG4gICAgLy8gaWYgKGlzVXBkYXRlV2l0aFBhZ2luZykge1xuICAgIC8vICAgcmV0dXJuIG9mKG51bGwpO1xuICAgIC8vIH1cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxuICAgIGNvbnN0IGZ1bGxQYXRocyA9IEVudGl0eVBhdGhDb252ZXJ0ZXIudG9FbnRpdHlQYXRoQXJyYXkodGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGgsIHRoaXMuYmluZGluZ0RhdGEpO1xuICAgIGNvbnN0IHBhdGhzID0gZnVsbFBhdGhzLnNsaWNlKDAsIGZ1bGxQYXRocy5sZW5ndGggLSAxKTtcbiAgICAvLyBkZWJ1Z1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbWF4LWxpbmUtbGVuZ3RoXG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIoaXRlbSA9PiBpdGVtKTtcbiAgICBjb25zdCBiaW5kaW5nRGF0YSA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhO1xuICAgIGxldCBub2RlQ29kZSA9IGJpbmRpbmdQYXRoc1tiaW5kaW5nUGF0aHMubGVuZ3RoIC0gMV07XG4gICAgbm9kZUNvZGUgPSBub2RlQ29kZS5zdWJzdHIoMCwgbm9kZUNvZGUubGVuZ3RoIC0gMSk7XG4gICAgLy8g6I635Y+W5LiK57qn5a6e5L2TXG4gICAgY29uc3QgcGFyZW50UGF0aHMgPSBiaW5kaW5nUGF0aHMuc2xpY2UoMCwgYmluZGluZ1BhdGhzLmxlbmd0aCAtIDEpO1xuICAgIGNvbnN0IEJpbmRpbmdMaXN0ID0gYmluZGluZ0RhdGEuZ2V0VmFsdWUocGFyZW50UGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgIGlmICghQmluZGluZ0xpc3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQucGFyYW1zLmRlbGV0ZShcInJldHJpZXZlaW5nXCIpO1xuICAgIGNvbnN0IGNvbmZpZ1BhdGggPSBgLyR7bm9kZUNvZGV9YDtcbiAgICBjb25zdCBjb25maWcgPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRQYWdpbmF0aW9uQ29uZmlnQnlQYXRoKGNvbmZpZ1BhdGgpO1xuICAgIGlmIChjb25maWcpIHtcbiAgICAgIGNvbnN0IHsgcGFnZUluZGV4ID0gMSwgcGFnZVNpemUgPSAwIH0gPSBjb25maWc7XG4gICAgICAvLyBwYWdlU2l6ZSA9IDDooajnpLrmnKrliIbpobVcbiAgICAgIGlmIChwYWdlU2l6ZSAhPT0gMCkge1xuICAgICAgICB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5wYXJhbXMuc2V0KCdxdWVyeUNoaWxkJywgdHJ1ZSk7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QkID0gdGhpcy5yZXBvc2l0b3J5LnF1ZXJ5Q2hpbGQocGF0aHMsIHBhZ2VJbmRleCwgcGFnZVNpemUpO1xuICAgICAgICByZXR1cm4gcmVxdWVzdCQucGlwZShcbiAgICAgICAgICB0YXAoKCkgPT4geyB9LFxuICAgICAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnF1ZXJ5RmFpbGVkLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICB9XG5cbiAgLyoqXG4gICAqIOiOt+WPluWIhumhteS/oeaBr1xuICAgKiBAcGFyYW0gbm9kZUNvZGUgbm9kZUNvZGVcbiAgICogQHJldHVybnMg5YiG6aG15L+h5oGv77yM5YyF5ous77ya5YiG6aG15aSn5bCP44CB5b2T5YmN6aG156CBXG4gICAqIEBkZXNjcmlwdGlvbiDln7rmnKzliIbpobXkv6Hmga/lnKjliIbpobXkv6Hmga/kuK3lrZjlgqjml7ZrZXnkuLpub2RlQ29kZVxuICAgKi9cbiAgLypwcml2YXRlIGdldFBhZ2luZ0luZm8obm9kZUNvZGU6IHN0cmluZykge1xuICAgIGNvbnN0IHJlc3VsdDogeyBwYWdlSW5kZXg/OiBudW1iZXIsIHBhZ2VTaXplPzogbnVtYmVyIH0gPSB7fTtcbiAgICBjb25zdCBub2RlQ29kZVBhdGggPSBgLyR7bm9kZUNvZGV9YDtcbiAgICBjb25zdCBkZWZhdWx0UGFnaW5nSW5mbyA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldFBhZ2luYXRpb25Db25maWdCeVBhdGgobm9kZUNvZGVQYXRoKTtcbiAgICBjb25zdCBwYWdlU2l6ZSA9IGRlZmF1bHRQYWdpbmdJbmZvICYmIGRlZmF1bHRQYWdpbmdJbmZvLnBhZ2VTaXplIHx8IDA7XG4gICAgY29uc3QgcGFnZUluZGV4ID0gZGVmYXVsdFBhZ2luZ0luZm8gJiYgZGVmYXVsdFBhZ2luZ0luZm8ucGFnZUluZGV4IHx8IDE7XG4gICAgcmVzdWx0LnBhZ2VJbmRleCA9IHBhZ2VJbmRleDtcbiAgICByZXN1bHQucGFnZVNpemUgPSBwYWdlU2l6ZTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9Ki9cbiAgLyoqXG4gICAqIOi/veWKoOS4gOadoeaWsOaVsOaNrlxuICAgKi9cbiAgcHVibGljIGFwcGVuZCgpOiBPYnNlcnZhYmxlPEVudGl0eT4ge1xuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSg1MDApO1xuICAgIGlmICh0aGlzLm1lc3NhZ2VQaXBlKSB7XG4gICAgICB0aGlzLm1lc3NhZ2VQaXBlLm5leHQoeyBtZXNzYWdlVHlwZTogJ2FwcGVuZCcgfSk7XG4gICAgfVxuICAgIGNvbnN0IGFwcGVuZCQgPSB0aGlzLnJlcG9zaXRvcnkuYXBwZW5kKCk7XG4gICAgcmV0dXJuIGFwcGVuZCQucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICB9LFxuICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmFwcGVuZEZhaWxlZCwgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog5b2T5YmN6KGM5YmN5oiW5ZCO5o+S5YWl5pWw5o2uXG4gICAqIEBwYXJhbSBwb3NpdGlvbiAxIHwgLTFcbiAgICovXG4gIHB1YmxpYyBpbnNlcnQocG9zaXRpb246IDEgfCAtMSA9IC0xKSB7XG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XG4gICAgaWYgKHRoaXMubWVzc2FnZVBpcGUpIHtcbiAgICAgIHRoaXMubWVzc2FnZVBpcGUubmV4dCh7IG1lc3NhZ2VUeXBlOiAnaW5zZXJ0JyB9KTtcbiAgICB9XG4gICAgY29uc3QgYXBwZW5kJCA9IHRoaXMucmVwb3NpdG9yeS5pbnNlcnQocG9zaXRpb24pO1xuICAgIHJldHVybiBhcHBlbmQkLnBpcGUoXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5hcHBlbmRGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICog5o+Q5Lqk5Y+Y5pu077yI5om56YeP57yW6L6R6aG16Z2i77yM6KGM5YiH5o2i5pe25o+Q5Lqk5aKe6YeP77yJXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlQ2hhbmdlcygpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBjb25zdCB1cGRhdGUkID0gdGhpcy5yZXBvc2l0b3J5LnVwZGF0ZUFsbENoYW5nZXMoKTtcbiAgICByZXR1cm4gdXBkYXRlJDtcbiAgfVxuXG4gIC8qKlxuICAgKiDmibnph4/kv53lrZhcbiAgICogQHBhcmFtIHN1Y2Nlc3NNc2cg6Ieq5a6a5LmJ5o+Q56S65L+h5oGvXG4gICAqL1xuICBwdWJsaWMgc2F2ZShzdWNjZXNzTXNnPzogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMubWVzc2FnZVBpcGUpIHtcbiAgICAgIHRoaXMubWVzc2FnZVBpcGUubmV4dCh7IG1lc3NhZ2VUeXBlOiAnc2F2ZScgfSk7XG4gICAgfVxuICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSg1MDApO1xuICAgIGNvbnN0IHNhdmUkID0gdGhpcy5yZXBvc2l0b3J5LmFwcGx5Q2hhbmdlcygpO1xuICAgIGNvbnN0IHJlc3VsdCQgPSBzYXZlJC5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICBpZiAoc3VjY2Vzc01zZyAmJiBzdWNjZXNzTXNnLnRyaW0oKSkge1xuICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHN1Y2Nlc3NNc2csIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2Uuc2F2ZVN1Y2Nlc3MsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgdGhpcy5mb3JtRXJyb3JTZXJ2aWNlLmV4Y2VwdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5tdWx0aVNhdmVGYWlsZWQsIGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG5cbiAgICByZXR1cm4gcmVzdWx0JDtcbiAgfVxuXG4gIC8qKlxuICAgKiDliKDpmaRcbiAgICogQHBhcmFtIGlkIOimgeWIoOmZpOeahOaVsOaNrueahGlkXG4gICAqIEBwYXJhbSBpZlNhdmUg5piv5ZCm5L+d5a2YXG4gICAqIEBwYXJhbSBzdWNjZXNzTXNnIOiHquWumuS5ieaPkOekuuS/oeaBr1xuICAgKiBAcGFyYW0gY29uZmlybSDmmK/lkKbpnIDopoHnoa7orqRcbiAgICogQHBhcmFtIGJyZWFrYWJsZSDmmK/lkKblj6/kuK3mlq3vvIxpZlNhdmXkuLpmYWxzZeaXtua1geS8muS4reaWrVxuICAgKi9cbiAgcHVibGljIHJlbW92ZShpZDogc3RyaW5nLCBpZlNhdmU/OiBib29sZWFuIHwgc3RyaW5nLCBzdWNjZXNzTXNnPzogc3RyaW5nLCBjb25maXJtOiBib29sZWFuIHwgc3RyaW5nID0gdHJ1ZSwgYnJlYWthYmxlOiBib29sZWFuIHwgc3RyaW5nID0gdHJ1ZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKHRoaXMubWVzc2FnZVBpcGUpIHtcbiAgICAgIHRoaXMubWVzc2FnZVBpcGUubmV4dCh7IG1lc3NhZ2VUeXBlOiAnZGVsZXRlJyB9KTtcbiAgICB9XG4gICAgaWYgKCFpZCkge1xuICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlWydwbHNTZWxlY3REZWxldGVEYXRhJ10sIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgfVxuICAgIGNvbmZpcm0gPSAoY29uZmlybSA9PT0gZmFsc2UgfHwgY29uZmlybSA9PT0gJ2ZhbHNlJykgPyBmYWxzZSA6IHRydWU7XG4gICAgYnJlYWthYmxlID0gKGJyZWFrYWJsZSA9PT0gZmFsc2UgfHwgYnJlYWthYmxlID09PSAnZmFsc2UnKSA/IGZhbHNlIDogdHJ1ZTtcbiAgICBjb25zdCBhY3Rpb24kID0gY29uZmlybSA/IHRoaXMubXNnU2VydmljZS5xdWVzdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZS5jb25maXJtRGVsZXRpb24pIDogb2YodHJ1ZSk7XG4gICAgcmV0dXJuIGFjdGlvbiQucGlwZShcbiAgICAgIGNvbmNhdE1hcChyZXN1bHQgPT4ge1xuICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmU2F2ZSA9IChpZlNhdmUgPT09IGZhbHNlIHx8IGlmU2F2ZSA9PT0gJ2ZhbHNlJykgPyBmYWxzZSA6IHRydWU7XG4gICAgICAgIGNvbnN0IGxvYWRpbmdUaW1lcklkID0gdGhpcy5sb2FkaW5nU2VydmljZS5zaG93TG9hZGluZ1dpdGhEZWxheSg1MDApO1xuICAgICAgICBjb25zdCByZW1vdmUkID0gdGhpcy5yZXBvc2l0b3J5LnJlbW92ZUJ5SWQoaWQsIGlmU2F2ZSk7XG4gICAgICAgIGlmICghcmVtb3ZlJCkge1xuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZW1vdmUkLnBpcGUoXG4gICAgICAgICAgdGFwKFxuICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgICAgICBpZiAoc3VjY2Vzc01zZyAmJiBzdWNjZXNzTXNnLnRyaW0oKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uuc3VjY2VzcyhzdWNjZXNzTXNnLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgICAgIHRoaXMuZm9ybUVycm9yU2VydmljZS5leGNlcHRpb24odGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlRmFpbGVkLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKSxcbiAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICAgICAgaWYgKGlmU2F2ZSA9PT0gdHJ1ZSB8fCAhYnJlYWthYmxlKSB7XG4gICAgICAgICAgICAgIC8vIHJldHVybiB0aGlzLmxvYWQoKTtcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOaJuemHj+WIoOmZpFxuICAgKiBAcGFyYW0gaWRzIGlkc1xuICAgKiBAcGFyYW0gaWZTYXZlIOaYr+WQpuS/neWtmFxuICAgKiBAcGFyYW0gc3VjY2Vzc01zZyDoh6rlrprkuYnmj5DnpLrkv6Hmga9cbiAgICogQHBhcmFtIGRlbGV0ZUN1cnJlbnRSb3dJZk5vQ2hlY2tzIOayoeacieWLvumAieaXtuWIoOmZpOW9k+WJjeihjFxuICAgKi9cbiAgcHVibGljIHJlbW92ZVJvd3MoaWRzOiBzdHJpbmdbXSwgaWZTYXZlPzogYm9vbGVhbiB8IHN0cmluZywgc3VjY2Vzc01zZz86IHN0cmluZywgZGVsZXRlQ3VycmVudFJvd0lmTm9DaGVja3M6IGJvb2xlYW4gfCBzdHJpbmcgPSBmYWxzZSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKHRoaXMubWVzc2FnZVBpcGUpIHtcbiAgICAgIHRoaXMubWVzc2FnZVBpcGUubmV4dCh7IG1lc3NhZ2VUeXBlOiAncmVtb3ZlUm93cycgfSk7XG4gICAgfVxuICAgIGRlbGV0ZUN1cnJlbnRSb3dJZk5vQ2hlY2tzID0gKGRlbGV0ZUN1cnJlbnRSb3dJZk5vQ2hlY2tzID09PSAndHJ1ZScgfHwgZGVsZXRlQ3VycmVudFJvd0lmTm9DaGVja3MgPT09IHRydWUpID8gdHJ1ZSA6IGZhbHNlO1xuICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnN0IGN1cnJlbnRJZCA9IHRoaXMuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XG4gICAgICBpZiAoZGVsZXRlQ3VycmVudFJvd0lmTm9DaGVja3MgPT09IHRydWUgJiYgY3VycmVudElkKSB7XG4gICAgICAgIGlkcyA9IFt0aGlzLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkXTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZVsncGxzU2VsZWN0RGVsZXRlRGF0YSddLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGFjdGlvbiQgPSB0aGlzLm1zZ1NlcnZpY2UuY29uZmlybSh0aGlzLmxhbmd1YWdlU2VydmljZS5jb25maXJtRGVsZXRpb24pO1xuICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXG4gICAgICBjb25jYXRNYXAocmVzdWx0ID0+IHtcbiAgICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgICByZXR1cm4gZW1wdHkoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIGlmU2F2ZSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBpZlNhdmUgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlb2YgaWZTYXZlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIGlmU2F2ZSA9IGlmU2F2ZS50b0xvd2VyQ2FzZSgpID09PSAnZmFsc2UnID8gZmFsc2UgOiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmU2F2ZSA9IChpZlNhdmUgPT09IGZhbHNlKSA/IGZhbHNlIDogdHJ1ZTtcbiAgICAgICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XG4gICAgICAgIGNvbnN0IHJlbW92ZSQgPSB0aGlzLnJlcG9zaXRvcnkucmVtb3ZlQnlJZHMoaWRzLCBpZlNhdmUpO1xuXG4gICAgICAgIGlmICghcmVtb3ZlJCkge1xuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlbW92ZSQucGlwZShcbiAgICAgICAgICB0YXAoXG4gICAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICAgICAgICAgIGlmIChzdWNjZXNzTXNnICYmIHN1Y2Nlc3NNc2cudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS5zdWNjZXNzKHN1Y2Nlc3NNc2csIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uuc3VjY2Vzcyh0aGlzLmxhbmd1YWdlU2VydmljZS5kZWxldGVTdWNjZXNzLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAvLyB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLnN1Y2Nlc3ModGhpcy5sYW5ndWFnZVNlcnZpY2UuZGVsZXRlU3VjY2VzcywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGVEZWxheUxvYWRpbmcobG9hZGluZ1RpbWVySWQpO1xuICAgICAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmRlbGV0ZUZhaWxlZCwgZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICksXG4gICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBvZihbXSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDliKDpmaTlkI7nmoTliLfmlrBcbiAgICovXG4gIHB1YmxpYyByZWZyZXNoQWZ0ZXJSZW1vdmluZyhsb2FkQ21kTmFtZTogc3RyaW5nLCBsb2FkQ21kRnJhbWVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgbG9hZENtZE5hbWUgJiYgbG9hZENtZEZyYW1lSWQpIHtcbiAgICAgIGNvbnN0IGNvbW1hbmRTZXJ2aWNlID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxDb21tYW5kU2VydmljZT4oQ29tbWFuZFNlcnZpY2UsIG51bGwpO1xuICAgICAgcmV0dXJuIGNvbW1hbmRTZXJ2aWNlLmV4ZWN1dGUobG9hZENtZE5hbWUsIGxvYWRDbWRGcmFtZUlkKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubG9hZCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIt+aWsFxuICAgKiBAcGFyYW0gbG9hZENtZE5hbWUg5Yi35paw5ZG95LukXG4gICAqIEBwYXJhbSBsb2FkQ21kRnJhbWVJZCDliLfmlrDlkb3ku6TmiYDlnKjnmoRmcmFtZUlkXG4gICAqL1xuICBwdWJsaWMgcmVmcmVzaChsb2FkQ21kTmFtZTogc3RyaW5nLCBsb2FkQ21kRnJhbWVJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy52aWV3TW9kZWwgJiYgbG9hZENtZE5hbWUgJiYgbG9hZENtZEZyYW1lSWQpIHtcbiAgICAgIGNvbnN0IGNvbW1hbmRTZXJ2aWNlID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxDb21tYW5kU2VydmljZT4oQ29tbWFuZFNlcnZpY2UsIG51bGwpO1xuICAgICAgcmV0dXJuIGNvbW1hbmRTZXJ2aWNlLmV4ZWN1dGUobG9hZENtZE5hbWUsIGxvYWRDbWRGcmFtZUlkKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMubG9hZCgpO1xuICB9XG4gIC8qKlxuICAgKiDlj5bmtojml7bmo4DmtYvmnKrkv53lrZjorrDlvZVcbiAgICovXG4gIHB1YmxpYyBjYW5jZWwoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBpZiAodGhpcy5tZXNzYWdlUGlwZSkge1xuICAgICAgdGhpcy5tZXNzYWdlUGlwZS5uZXh0KHsgbWVzc2FnZVR5cGU6ICdjYW5jZWwnIH0pO1xuICAgIH1cbiAgICAvLyDmsqHmnInlj5jmm7Tml7bnm7TmjqXlj5bmtohcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICBjb25zdCBoYXNVbnNhdmVkRGF0YSA9IEJlZlJlcG9zaXRvcnlVdGlsLmlzRXhpc3RVbnNhdmVEYXRhKGJlZlJlcG9zaXRvcnkpO1xuICAgIGlmIChoYXNVbnNhdmVkRGF0YSA9PT0gZmFsc2UpIHtcbiAgICAgIHJldHVybiB0aGlzLl9jYW5jZWwoKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb25maXJtUmVzdWx0JCA9IHRoaXMubXNnU2VydmljZS5xdWVzdGlvbih0aGlzLmxhbmd1YWdlU2VydmljZVsnY2FuY2VsV2l0aG91dFNhdmUnXSkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoaWZDYW5jZWw6IGJvb2xlYW4pID0+IHtcbiAgICAgICAgaWYgKGlmQ2FuY2VsID09PSBmYWxzZSkge1xuICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLl9jYW5jZWwoKTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJldHVybiBjb25maXJtUmVzdWx0JDtcbiAgfVxuICAvKipcbiAgICog6L+Y5Y6f5Y+Y5pu06ZuGXG4gICAqIEBkZXNjcmlwdGlvbiDkuI3luKblj5jmm7Tmo4DmtYvmj5DnpLpcbiAgICovXG4gIHB1YmxpYyByZXZlcnQoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5fY2FuY2VsKCk7XG4gIH1cbiAgLyoqXG4gICAqIOWPlua2iO+8iOWGhemDqOWPlua2iO+8iVxuICAgKi9cbiAgcHJpdmF0ZSBfY2FuY2VsKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgbG9hZGluZ1RpbWVySWQgPSB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3dMb2FkaW5nV2l0aERlbGF5KDUwMCk7XG4gICAgY29uc3QgY2FuY2VsJCA9IHRoaXMucmVwb3NpdG9yeS5jYW5jZWxDaGFuZ2VzKCk7XG4gICAgcmV0dXJuIGNhbmNlbCQucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZURlbGF5TG9hZGluZyhsb2FkaW5nVGltZXJJZCk7XG4gICAgICB9LFxuICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlRGVsYXlMb2FkaW5nKGxvYWRpbmdUaW1lcklkKTtcbiAgICAgICAgICB0aGlzLmZvcm1FcnJvclNlcnZpY2UuZXhjZXB0aW9uKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLmNhbmNlbEZhaWxlZCwgZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog6I635Y+W5qC557uE5Lu2YXBwQ29udGV4dFxuICAgKi9cbiAgcHJpdmF0ZSBnZXQgbWVzc2FnZVBpcGUoKSB7XG4gICAgaWYgKHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCkge1xuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpIHx8IG51bGw7XG4gICAgICBpZiAoYXBwQ29udGV4dCkge1xuICAgICAgICByZXR1cm4gYXBwQ29udGV4dC5tZXNzYWdlUGlwZSB8fCBudWxsO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICAvKipcbiAgICog6Kem5Y+R5p+l6K+i5LqL5Lu2XG4gICAqIEBwYXJhbSBmaWx0ZXJzIOi/h+a7pOadoeS7tlxuICAgKi9cbiAgcHJpdmF0ZSBmaXJlUXVlcnlFdmVudChmaWx0ZXJzOiBhbnkpIHtcbiAgICBjb25zdCBtZXNzYWdlUGlwZSA9IHRoaXMubWVzc2FnZVBpcGU7XG4gICAgLy8gY29uc3QgZnJhbWVJZCA9IHRoaXMudmlld01vZGVsICYmIHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dCAmJiB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQuZnJhbWVJZCB8fCBudWxsO1xuICAgIGlmIChtZXNzYWdlUGlwZSkge1xuICAgICAgbWVzc2FnZVBpcGUubmV4dCh7IHR5cGU6ICdxdWVyeScgfSk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDlkIjlubbov4fmu6TmnaHku7ZcbiAgICogQHBhcmFtIGZpbHRlciDooajljZXov4fmu6TmnaHku7ZcbiAgICovXG4gIHByaXZhdGUgbWVyZ2VGaWx0ZXJDb25kaXRpb25zKGZpbHRlcjogYW55KSB7XG4gICAgaWYgKHR5cGVvZiBmaWx0ZXIgPT09ICdzdHJpbmcnKSB7XG4gICAgICBmaWx0ZXIgPSBKU09OLnBhcnNlKGZpbHRlcikgfHwgW107XG4gICAgfVxuICAgIGNvbnN0IGZpbHRlcnM6IEFycmF5PGFueT4gPSBmaWx0ZXI7XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLnZpZXdNb2RlbCAmJiB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCBudWxsO1xuICAgIGlmIChiaW5kaW5nUGF0aCkge1xuICAgICAgY29uc3Qgb3JpZ2luYWxDb25kaXRpb25zID0gdGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZmlsdGVyQ29uZGl0aW9uTWFuYWdlci5nZXRGaWx0ZXJzKGJpbmRpbmdQYXRoKSB8fCBbXTtcbiAgICAgIC8vIHRoaXMuZmlsdGVyQ29uZGl0aW9uU2VydmljZS5nZXRGaWx0ZXJzKGJpbmRpbmdQYXRoKSB8fCBbXTtcbiAgICAgIGNvbnN0IGNvbmRpdGlvbnMgPSBBcnJheS5mcm9tKG9yaWdpbmFsQ29uZGl0aW9ucyk7XG4gICAgICBpZiAoY29uZGl0aW9ucyAmJiBjb25kaXRpb25zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgLypmaWx0ZXJzLmZvckVhY2goKGl0ZW06IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpZWxkID0gaXRlbS5GaWx0ZXJGaWVsZCB8fCBudWxsO1xuICAgICAgICAgIGlmIChmaWVsZCkge1xuICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlSW5kZXggPSBjb25kaXRpb25zLmZpbmRJbmRleChjb25kaXRpb24gPT4gY29uZGl0aW9uLkZpbHRlckZpZWxkID09PSBmaWVsZCk7XG4gICAgICAgICAgICBpZiAoZHVwbGljYXRlSW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICAgIGZpbHRlcnNbaW5kZXhdID0gY29uZGl0aW9uc1tkdXBsaWNhdGVJbmRleF07XG4gICAgICAgICAgICAgIGNvbmRpdGlvbnMuc3BsaWNlKGR1cGxpY2F0ZUluZGV4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pOyovXG4gICAgICAgIC8vIOS/ruaUueWRveS7pOS4iui/h+a7pOadoeS7tueahOacgOWQjuS4gOS4quafpeivouWFs+ezu+S4umFuZFxuICAgICAgICBpZiAoZmlsdGVycy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgLy8g5pyA5ZCO5LiA5Liq6L+H5ruk5p2h5Lu2XG4gICAgICAgICAgY29uc3QgbGFzdEZpbHRlciA9IGZpbHRlcnNbZmlsdGVycy5sZW5ndGggLSAxXTtcbiAgICAgICAgICBpZiAobGFzdEZpbHRlcikge1xuICAgICAgICAgICAgaWYgKGxhc3RGaWx0ZXIuaGFzT3duUHJvcGVydHkoJ1JlbGF0aW9uJykpIHtcbiAgICAgICAgICAgICAgZGVsZXRlIGxhc3RGaWx0ZXIuUmVsYXRpb247XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBsYXN0RmlsdGVyLnJlbGF0aW9uID0gMTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8g5ZCI5bm25paw55qE6L+H5ruk5p2h5Lu25ZKM5Y6f5p2l5ZG95Luk5LiK55qE6L+H5ruk5p2h5Lu2XG4gICAgICAgIGZpbHRlcnMucHVzaCguLi5jb25kaXRpb25zKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoZmlsdGVycyk7XG4gIH1cbiAgLyoqXG4gICAqIOWQiOW5tuaOkuW6j+adoeS7tlxuICAgKiBAcGFyYW0gc29ydCDmjpLluo/mnaHku7ZcbiAgICovXG4gIHByaXZhdGUgbWVyZ2VTb3J0Q29uZGl0aW9ucyhzb3J0OiBhbnkpIHtcbiAgICBpZiAodHlwZW9mIHNvcnQgPT09ICdzdHJpbmcnKSB7XG4gICAgICBzb3J0ID0gSlNPTi5wYXJzZShzb3J0KSB8fCBbXTtcbiAgICB9XG4gICAgY29uc3Qgc29ydHM6IEFycmF5PGFueT4gPSBzb3J0O1xuICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gdGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuYmluZGluZ1BhdGggfHwgbnVsbDtcbiAgICBpZiAoYmluZGluZ1BhdGgpIHtcbiAgICAgIC8vIOiOt+WPluW9k+WJjee7keWumui3r+W+hOeahOaJgOacieaOkuW6j+adoeS7tlxuICAgICAgY29uc3Qgb3JpZ2luYWxDb25kaXRpb25zID0gdGhpcy52aWV3TW9kZWwgJiYgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuc29ydENvbmRpdGlvbk1hbmFnZXIuZ2V0Q29uZGl0aW9uc0J5QmluZGluZ1BhdGgoYmluZGluZ1BhdGgsIChkaXJlY3Rpb24pID0+IHtcbiAgICAgICAgaWYgKGRpcmVjdGlvbiA9PT0gJ2FzYycpIHtcbiAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfSBlbHNlIHsgcmV0dXJuIDE7IH1cbiAgICAgIH0pIHx8IFtdO1xuICAgICAgY29uc3QgY29uZGl0aW9ucyA9IEFycmF5LmZyb20ob3JpZ2luYWxDb25kaXRpb25zKTtcbiAgICAgIC8vIOWmguaenOW9k+WJjee7keWumui3r+W+hOacieaOkuW6j+adoeS7tu+8jOWImeW/veeVpeWRveS7pOS4iumihOWItueahOaOkuW6j+adoeS7tlxuICAgICAgaWYgKGNvbmRpdGlvbnMgJiYgY29uZGl0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgIC8vIOmBjeWOhuW3suacieeahOi/h+a7pOadoeS7tu+8jOWmguaenOaciemHjeWkjeeahGZpZWxk77yM55So5ZCO6ICF55qE6KaG55uW5bey5pyJ55qEXG4gICAgICAgIC8qc29ydHMuZm9yRWFjaCgoaXRlbTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgICAgY29uc3QgZmllbGQgPSBpdGVtLlNvcnRGaWVsZCB8fCBudWxsO1xuICAgICAgICAgIGlmIChmaWVsZCkge1xuICAgICAgICAgICAgY29uc3QgZHVwbGljYXRlSW5kZXggPSBjb25kaXRpb25zLmZpbmRJbmRleChjb25kaXRpb24gPT4gY29uZGl0aW9uLlNvcnRGaWVsZCA9PT0gZmllbGQpO1xuICAgICAgICAgICAgaWYgKGR1cGxpY2F0ZUluZGV4ICE9PSAtMSkge1xuICAgICAgICAgICAgICBzb3J0c1tpbmRleF0gPSBjb25kaXRpb25zW2R1cGxpY2F0ZUluZGV4XTtcbiAgICAgICAgICAgICAgY29uZGl0aW9ucy5zcGxpY2UoZHVwbGljYXRlSW5kZXgsIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7Ki9cbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGNvbmRpdGlvbnMpO1xuICAgICAgICAvLyDlsIblhbbkvZnmjpLluo/mnaHku7bmt7vliqDliLDmjpLluo/mlbDnu4RcbiAgICAgICAgLy8gc29ydHMucHVzaCguLi5jb25kaXRpb25zKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHNvcnRzKTtcbiAgfVxufVxuZXhwb3J0IHsgTGlzdERhdGFTZXJ2aWNlIH07XG4iXX0=