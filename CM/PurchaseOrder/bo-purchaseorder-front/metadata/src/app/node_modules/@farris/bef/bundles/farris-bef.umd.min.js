!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@ecp-caf/caf-common"),require("date-fns"),require("rxjs"),require("rxjs/operators"),require("rxjs/operators/map"),require("@angular/core"),require("@angular/common/http"),require("@farris/devkit")):"function"==typeof define&&define.amd?define("@farris/bef",["exports","@ecp-caf/caf-common","date-fns","rxjs","rxjs/operators","rxjs/operators/map","@angular/core","@angular/common/http","@farris/devkit"],t):t((e.farris=e.farris||{},e.farris.bef={}),e.cafCommon,e.dateFns,e.rxjs,e.rxjs.operators,e.rxjs["operators/map"],e.ng.core,e.ng.common.http,e.devkit)}(this,function(e,t,r,C,g,s,o,h,I){"use strict";var b=(n.Added="Added",n.Modify="Modify",n.Deleted="Deleted",n);function n(){}var y=new o.InjectionToken("@farris/be BE_SERVER_URL"),a=new o.InjectionToken("@farris/be BE_SESSION_HANDLING_STRATEGY_TOKEN"),S=(i.getPropInfo=function(e,t){var n,r,i,o=I.FieldMetadataUtil.getNgFields(e);Object.keys(o).forEach(function(e){e===t&&(n="NgField",r=null,i=o[e])});var a=I.FieldMetadataUtil.getNgObjects(e);Object.keys(a).forEach(function(e){e===t&&(n="NgObject",r=a[e].type,i=a[e])});var s=I.FieldMetadataUtil.getNgList(e);Object.keys(s).forEach(function(e){e===t&&(n="NgList",r=s[e].type,i=s[e])});var p=I.FieldMetadataUtil.getNgDynamic(e);return Object.keys(p).forEach(function(e){e===t&&(n="NgDynamic",r=p[e].type,i=p[e])}),{propType:n,propEntityType:r,propMetadata:i}},i.getPrimaryKey=function(e){var t=I.FieldMetadataUtil.getPrimaryFieldMetadata(e);return t?t.dataField:""},i.isObjectProp=function(e,t){var n=!1,r=I.FieldMetadataUtil.getNgObjects(e);return Object.keys(r).forEach(function(e){e===t&&(n=!0)}),n},i.isDynamicProp=function(e,t){var n=!1,r=I.FieldMetadataUtil.getNgDynamic(e);return Object.keys(r).forEach(function(e){e===t&&(n=!0)}),n},i.appendInitialData=function(e,t){var n=Object.assign({},t);delete n.id,delete n.parentID,e.initialData=n},i);function i(){}var p=(u.prototype.build=function(e){var t=this;return this.changeDetail={ChangeType:b.Modify,ChangeInfo:{DataId:""}},e.forEach(function(e){t.buildChangeDetail(e)}),this.changeDetail},u.prototype.buildChangeDetail=function(l){var d=l.path.concat();this.changeDetail.ChangeInfo.DataId||(this.changeDetail.ChangeInfo.DataId=d[0].split(":")[1]);for(var f=this.changeDetail,g=this.entityType,e=function(e){var t=v.getChangeInfo(f),n=d[e],r=S.getPropInfo(g,n),i=r.propType,o=r.propEntityType,a=r.propMetadata.dataField||n;if("NgField"===i){if(n===S.getPrimaryKey(g))return"continue";if(l.type!==I.ModifyType.ValueChange)throw Error("简单类型的属性上不支持ValueChange类型之外的变更");t[a]=l.value,f=null}else if("NgObject"===i)if(d[e+1].split(":")[1],d[e+1].split(":")[0]){var s=t[a],p=d.slice(0,e+1);s=(y=v.entityCollection.getEntityByPath(p))?y.toJSON(!0):{},t[a]=s,g=f=null}else c=(c=t[a])||{ChangeType:b.Modify,ChangeInfo:{}},t[a]=c,f=c,g=o;else if("NgList"===i){f.ChangeInfo[a]||(f.ChangeInfo[a]=[]);var u=f.ChangeInfo[a];if(e!==d.length-1){var c,h=d[e+1].split(":")[1];return(c=u.find(function(e){return e.ChangeInfo.DataId===h}))||(c=v.createEmptyChangeDetail(b.Modify,h),u.push(c)),f=c,g=o,"continue"}l.type===I.ModifyType.Add||l.type===I.ModifyType.Insert||(l.type,I.ModifyType.Remove),g=f=null}else if("NgDynamic"===i){p=d.slice(0,e+1);var y=v.entityCollection.getEntityByPath(p);t[a]={ChangeType:b.Modify,ChangeInfo:y?y.toJSON(!0):{}},g=f=null}},v=this,t=1;t<d.length&&f;t+=2)e(t)},u.prototype.getChangeInfo=function(e){return e.hasOwnProperty("ChangeInfo")?e.ChangeInfo:e},u.prototype.createEmptyChangeDetail=function(e,t){return{ChangeType:e,ChangeInfo:{DataId:t}}},u);function u(e,t){this.entityType=e,this.entityCollection=t}var c=(l.prototype.handle=function(e,t,n){this.handleChangeDetails(e,t,n)},l.prototype.handleChangeDetails=function(r,i,e){var o=this;e&&e.forEach(function(e){var t=e.ChangeInfo.dataId||e.ChangeInfo.DataId,n=o.getEntityById(i,t);n&&o.handleChangeDetail(r,n,e)})},l.prototype.handleChangeDetail=function(u,c,e){var h=this;if(e&&c&&e.ChangeType===b.Modify){var y=e.ChangeInfo;Object.keys(y).forEach(function(e){var t=S.getPropInfo(u,e),n=t.propType,r=t.propEntityType;if("NgField"===n)c[e]=y[e];else if("NgObject"===n){var i=c[e];if(i.primaryKey){var o=y[e];i.load(o)}else{var a=y[e];h.handleChangeDetail(r,i,a)}}else if("NgList"===n){var s=c[e],p=y[e];h.handleChangeDetails(r,s,p)}})}},l.prototype.getEntityById=function(e,t){return(e instanceof I.EntityCollection?e.getEntityById(t):e.get(t))||null},l);function l(){}var d=(f.prototype.getUserSessionId=function(){return this.sessionService.getUserSessionId()},f.prototype.getCurrentSessionId=function(e){var t,n=this.getRuntimeSessionId();if(n)return n;if(this.sessionService)if(e&&e.hasOwnProperty("tabId")){var r=e.tabId;t=this.sessionService.getCurrentSeesionId(r)}else t=this.sessionService.getCurrentSeesionId();return t=t||this.getUserSessionId()},f.prototype.getRuntimeSessionId=function(){var e=window.location.hash,t=this.parse(e);return t&&t.rsi||null},f.prototype.parse=function(e){return e?e.slice(e.indexOf("?")+1).split("&").reduce(function(e,t){var n,r=t.indexOf("="),i=t.slice(0,r),o=t.slice(r+1);return Object.assign(e,((n={})[i]=decodeURIComponent(o),n))},{}):{}},f.decorators=[{type:o.Injectable}],f.ctorParameters=function(){return[{type:t.SessionService,decorators:[{type:o.Optional}]}]},f);function f(e){this.sessionService=e}var v=(m.prototype.getItem=function(e){return this.getAllBeSessions()[e]},m.prototype.setItem=function(e,t){var n=this.getAllBeSessions();n[e]=t,this.setAllBeSessions(n)},m.prototype.removeItem=function(e){var t=this.getAllBeSessions();t[e]&&delete t[e],this.setAllBeSessions(t)},m.prototype.clear=function(e,t){!0===this.isInFramework()?this.removeItemsByFrmSessionId(e):this.removeItem(t)},m.prototype.removeItemsByFrmSessionId=function(t){var n=this.getAllBeSessions();Object.keys(n).forEach(function(e){!0===e.startsWith(t)&&delete n[e]}),this.setAllBeSessions(n)},m.prototype.getAllBeSessions=function(){var e=window.sessionStorage.getItem(this.sessionStorageKey);return e?JSON.parse(e):{}},m.prototype.setAllBeSessions=function(e){var t=JSON.stringify(e);window.sessionStorage.setItem(this.sessionStorageKey,t)},m.prototype.isInFramework=function(){var e=window.location.hash;return!!e&&-1!==e.indexOf("tabId=")},m);function m(){this.sessionStorageKey="BE_SESSION_ID"}var E=function(e,t){return(E=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function x(e,t){function n(){this.constructor=e}E(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}function B(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function P(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o["return"])&&n.call(o)}finally{if(i)throw i.error}}return a}function R(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(P(arguments[t]));return e}var D=(q.convertToHeaders=function(t){if(1==(t=t||new h.HttpHeaders)instanceof h.HttpHeaders)return t;if(0<Object.keys(t).length){var n=new h.HttpHeaders;Object.keys(t).forEach(function(e){n=n.append(e,t[e])}),t=n}else t=new h.HttpHeaders;return t},q.appendSessionId=function(e,t){return e.append("SessionId",t)},q.appendCafRuntimeCommonVariable=function(e,t){return e.append("X-CAF-Runtime-CommonVariable",t)},q.appendCafRuntimeContext=function(e,t){return e.append("X-CAF-Runtime-Context",t)},q.appendContextType=function(e,t){return t=t||"application/json",e.append("Content-Type",t)},q.appendRequireMessage=function(e,t){return void 0===t&&(t=!0),e.append("Bff-Require-Message",t.toString())},q.appendFuncInstId=function(e,t){return e.append("Func-Inst-Id",t)},q.toJson=function(n){if(!(n instanceof h.HttpHeaders))return null;var r={};return n.keys().forEach(function(e){var t=n.getAll(e);1<t.length?r[e]=t:r[e]=t[0]||""}),r},q);function q(){}var w=(T.buildParams=function(e){var t=new h.HttpParams;for(var n in e)if(e.hasOwnProperty(n)){var r=e[n].toString();t=t.append(n,r)}return t},T);function T(){}var O=(M.hasRequestInfo=function(e){if(!e||!e.body)return!1;var t=e.body;return!(!t.requestInfo||!t.requestInfo.dataChange)||!!t.dataChange},M.hasRequestInfoWithR=function(e){if(!e||!e.body)return!1;var t=e.body;return!(!t.RequestInfo||!t.RequestInfo.dataChange)||!!t.dataChange},M.buildRequestInfo=function(e){return{dataChange:e.entityManager.buildAllEntityChangeDetails(),variableChange:e.variableManager.buildChangeDetail()}},M.buildBodyWithRequestInfo=function(e,t){if(e.RequestInfo||e.requestInfo)return e;var n=this.buildRequestInfo(t);return Object.assign({},e,{requestInfo:n})},M.getRequestInfo=function(e){if(!e||!e.body)return null;var t=e.body;return t.requestInfo?t.requestInfo:t.dataChange||t.variableChange?t:null},M);function M(){}var j=(U.unWrapResponseInfo=function(e){if(!e)return e;if(!1===e.hasOwnProperty("returnValue"))return e.hasOwnProperty("result")&&e.hasOwnProperty("pagination")?e.result:e;var t=e.returnValue;return t&&t.hasOwnProperty("result")&&t.hasOwnProperty("pagination")?t.result:e.returnValue},U.isReported401Error=function(e){return 401===e.status},U.parseBackEndMessage=function(e){return e&&e.message&&Array.isArray(e.message)&&0<e.message.length?e.message:null},U.parseBackEndError=function(e){var t=e&&e.error;return t&&t.hasOwnProperty("extensionMessage")&&t.extensionMessage&&t.extensionMessage.hasOwnProperty("UIMsg")&&t.extensionMessage.UIMsg&&0<t.extensionMessage.UIMsg.length?JSON.parse(t.extensionMessage.UIMsg):null},U);function U(){}var A=(V.prototype.getService=function(){for(var e=window;!e.gspframeworkService&&e!==window.top&&this.isSameOrigin(e);)e=window.parent;return e.gspframeworkService&&e.gspframeworkService.rtf||{}},V.prototype.isSameOrigin=function(e){var t=window.location.host;try{if(e&&e.location&&"undefined"!=typeof e.location.host)return e.location.host===t}catch(n){return!1}return!1},Object.defineProperty(V.prototype,"params",{get:function(){return this.rtf&&this.rtf.hasOwnProperty("session")&&"function"==typeof this.rtf.session.getCommonVariable?this.rtf.session.getCommonVariable():null},enumerable:!0,configurable:!0}),Object.defineProperty(V.prototype,"httpService",{get:function(){return this.rtf&&this.rtf.hasOwnProperty("http")&&"function"==typeof this.rtf.http.request?this.rtf.http:null},enumerable:!0,configurable:!0}),V.prototype.request=function(e,t,n){return void 0===n&&(n={}),this.defaultHttpClient.request(e,t,n)},V.decorators=[{type:o.Injectable}],V.ctorParameters=function(){return[{type:h.HttpClient}]},V);function V(e){this.defaultHttpClient=e,this.httpClient=e,this.rtf=this.getService()}var H=(k.prototype.getFrmSessionId=function(e){return this.frmSessionService.getCurrentSessionId(e)},Object.defineProperty(k.prototype,"frmSessionId",{get:function(){return this.frmSessionService.getCurrentSessionId()},enumerable:!0,configurable:!0}),k.prototype.getFrameworkSessionId=function(e){return this.getFrmSessionId(e)},k.prototype.getSessionIdFromStorage=function(e){var t=this.getSessionStorageKey(e);return this.storageStrategy.getItem(t)},k);function k(e,t){this.storageStrategy=e,this.frmSessionService=t}var F,N=(x(_,F=H),_.prototype.getSessionId=function(){var e=this.getSessionIdFromStorage();return e?C.of(e):this.createSession()},_.prototype.setSessionId=function(e){var t=this.getSessionStorageKey();this.storageStrategy.setItem(t,e)},_.prototype.clearSessionId=function(){var e=this.getSessionStorageKey();this.storageStrategy.clear(this.frmSessionId,e)},_.prototype.extendRequestHeaders=function(e,t){var n=this.getFrameworkSessionId(t),r=this.getSessionIdFromStorage(t);return e=D.appendCafRuntimeCommonVariable(e,n),r&&(e=D.appendCafRuntimeContext(e,r),e=D.appendSessionId(e,r)),e=D.appendFuncInstId(e,this.beSessionUri)},_.prototype.handleReponseHeaders=function(e){},_.prototype.createSession=function(){var t=this,e={responseType:"text"};return this.frmSessionId&&(this.injector.get(I.AppContext,null),e.headers=new h.HttpHeaders({SessionId:this.frmSessionId}),e.headers=e.headers.append("X-CAF-Runtime-CommonVariable",this.frmSessionId),e.headers=e.headers.append("Func-Inst-Id",this.beSessionUri),e.headers=D.toJson(e.headers)),this.httpService.request("POST",this.beSessionUri,e).pipe(g.tap(function(e){t.setSessionId(e)}))},_.prototype.extendHttpHeader=function(){},_.prototype.getSessionStorageKey=function(e){return(e?this.getFrameworkSessionId(e):this.frmSessionId)+"_"+this.beSessionUri},_);function _(e,t,n,r,i){var o=F.call(this,e,t)||this;return o.beSessionUri=r,o.httpClient=n,o.httpService=new A(o.httpClient),o.injector=i,o}var L,K=(x(G,L=H),G.prototype.getSessionId=function(){var e=this.getSessionStorageKey(),t=this.storageStrategy.getItem(e);return C.of(t)},G.prototype.setSessionId=function(e){var t=this.getSessionStorageKey();this.storageStrategy.setItem(t,e)},G.prototype.clearSessionId=function(){var e=this.getSessionStorageKey();this.storageStrategy.removeItem(e)},G.prototype.extendRequestHeaders=function(e,t){var n=this.getFrameworkSessionId(t),r=this.getSessionIdFromStorage(t),i=this.injector.get(I.AppContext,null);if(i){var o=i.Token;e=D.appendFuncInstId(e,o)}return e=D.appendCafRuntimeCommonVariable(e,n),r&&(e=D.appendCafRuntimeContext(e,r)),e},G.prototype.handleReponseHeaders=function(e){},G.prototype.getSessionStorageKey=function(e){return(e?this.getFrameworkSessionId(e):this.frmSessionId)+"_"+this.beSessionUri},G);function G(e,t,n,r){var i=L.call(this,e,t)||this;return i.beSessionUri=n,i.injector=r,i}var z=(J.prototype.create=function(e,t,n,r,i){var o=this.createStorageStrategy(),a=this.createBeSessionUri(n);return"UnifiedSession"===e?new K(o,t,a,i):new N(o,t,r,a,i)},J.prototype.createStorageStrategy=function(){return new v},J.prototype.createBeSessionUri=function(e){return e+"/service/createsession"},J.decorators=[{type:o.Injectable}],J);function J(){}var W=(Object.defineProperty(Y.prototype,"token",{get:function(){return this.handlingStrategy.getFrameworkSessionId()},enumerable:!0,configurable:!0}),Y.prototype.getBeSessionId=function(){return this.handlingStrategy.getSessionId()},Y.prototype.setBeSessionId=function(e){this.handlingStrategy.setSessionId(e),this.setSessionId(e)},Y.prototype.clearBeSessionId=function(){this.handlingStrategy.clearSessionId()},Y.prototype.extendRequestHeaders=function(e,t){return this.handlingStrategy.extendRequestHeaders(e,t)},Y.prototype.handleResponseHeaders=function(e){return this.handlingStrategy.handleReponseHeaders(e)},Y.prototype.createBeSession=function(){return this.handlingStrategy.createSession()},Y.prototype.setSessionId=function(e){var t=this.injector.get(I.AppContext,null,o.InjectFlags.Optional);t&&e&&t.params.set("sessionId",e)},Y.prototype.createHandlingStrategy=function(e,t,n,r){var i;return i=(i=e?e.get(a,null,o.InjectFlags.Optional):"SeparatedSession")||"SeparatedSession",(new z).create(i,n,r,t,e)},Y.decorators=[{type:o.Injectable}],Y.ctorParameters=function(){return[{type:h.HttpClient},{type:String},{type:d},{type:o.Injector}]},Y);function Y(e,t,n,r){this.beBaseUri=t,this.injector=r,this.handlingStrategy=this.createHandlingStrategy(r,e,n,t)}var Q,X="@farris/bef NG_VARIABLE",Z=I.makePropDecorator(X,function(e){return e}),$=(x(ee,Q=I.Repository),Object.defineProperty(ee.prototype,"restService",{get:function(){return this.dataService.restService},enumerable:!0,configurable:!0}),Object.defineProperty(ee.prototype,"changeBuilder",{get:function(){return this.entityManager.changeBuilder},enumerable:!0,configurable:!0}),Object.defineProperty(ee.prototype,"changeHandler",{get:function(){return this.entityManager.changeHandler},enumerable:!0,configurable:!0}),ee.prototype.getList=function(){return this.dataService.getList(null,null,null,null)},ee.prototype.getById=function(e){return this.dataService.getById(e)},ee.prototype.updateById=function(e){return this.dataService.updateById(e)},ee.prototype.create=function(e){return this.dataService.create(e)},ee.prototype.append=function(e){return this.dataService.append(e)},ee.prototype.appendByPath=function(e){return this.dataService.appendByPath(e)},ee.prototype.removeById=function(e,t){return this.dataService.removeById(e,t)},ee.prototype.removeByIds=function(e,t){return this.dataService.removeByIds(e,t)},ee.prototype.removeByPath=function(e,t){return this.dataService.removeByPath(e,t)},ee.prototype.updateChangesById=function(e){return this.dataService.updateChangesById(e)},ee.prototype.updateChangesByPath=function(e,t){throw new Error("Not Implement")},ee.prototype.updateAllChanges=function(){return this.dataService.updateAllChanges()},ee.prototype.applyChanges=function(){return this.dataService.applyChanges()},ee.prototype.updateDataAndVariableChanges=function(){var e={FilterConditions:[],SortConditions:[],IsUsePagination:!0,Pagination:{PageIndex:1,PageSize:1,PageCount:0,TotalCount:0}},t=JSON.stringify(e),n=this.restService.buildRequestInfo();if(this.isEmptyRequestInfo(n))return C.of(null);var r=this.restService.baseUri+"/extension/query?entityFilter="+t,i={body:n};return this.restService.invoke(r,"PUT",null,i,!1,!0,!0)},ee.prototype.applyChangesById=function(e){return this.dataService.applyChangesById(e)},ee.prototype.cancelChanges=function(e){return this.dataService.cancelChanges(e)},ee.prototype.clearAllEntityChanges=function(){return this.entityManager.clearAllEntityChanges()},ee.prototype.getDataChangeDetails=function(){return this.entityManager.buildAllEntityChangeDetails()},ee.prototype.handleDataChangeDetails=function(e){return this.entityManager.handleDataChangeDetails(e)},ee.prototype.getVariableChangeDetail=function(){return this.variableManager.buildChangeDetail()},ee.prototype.handleVariableChangeDetail=function(e){this.variableManager.handleChangeDetail(e)},ee.prototype.isEmptyRequestInfo=function(e){return!e||(!e.dataChange||e.dataChange.length<1)&&(!e.variableChange||Object.keys(e.variableChange).length<1)},ee.decorators=[{type:o.Injectable}],ee.ctorParameters=function(){return[]},ee);function ee(){return Q.call(this)||this}var te,ne=(x(re,te=I.EntityManager),re.prototype.buildAllEntityChangeDetails=function(){var n=this,r=[];return this.entityCollection.getAllEntities().forEach(function(e){if(0!==e.changes.length){var t=n.changeBuilder.build(e.changes);t&&t.ChangeInfo&&t.ChangeInfo.DataId&&r.push(t)}}),r},re.prototype.buildEntityChangeDetailById=function(e){var t=this.entityCollection.getEntityById(e);return 0===t.changes.length?null:this.changeBuilder.build(t.changes)},re.prototype.handleDataChangeDetails=function(e){this.changeHandler.handle(this.entityType,this.entityCollection,e)},re.prototype.reset=function(){this.entityCollection.clear()},re);function re(e){var t=te.call(this,e)||this;return t.changeBuilder=new p(t.entityCollection.entityType,t.entityCollection),t.changeHandler=new c,t}var ie=(oe.createEmpty=function(e,t){var n={ChangeType:e,ChangeInfo:{}};return t&&(n.ChangeInfo.DataId=t),n},oe.getChangeInfo=function(e){return!0===this.isChangeDetail(e)?e.ChangeInfo:e},oe.isChangeDetail=function(e){var t=Object.keys(e);return 2===t.length&&-1<t.indexOf("ChangeType")&&-1<t.indexOf("ChangeInfo")},oe);function oe(){}var ae=(se.prototype.handleChangeDetail=function(e){var i=this,o=e.ChangeInfo;Object.keys(o).forEach(function(e){var t=i.ngVariableMap.get(e);if(t){var n=t.mapping,r=o[e];i.getValueFromUIState(n)!==r&&(i.setValueToUIState(n,r),i.innerValueMap.set(e,r))}})},se.prototype.buildChangeDetail=function(){var o=this,a=ie.createEmpty(b.Modify);return this.ngVariableMap.forEach(function(e,t){var n=e.mapping,r=o.getValueFromUIState(n),i=o.innerValueMap.get(t);!1===o.isValueEqual(r,i)&&o.appendToChangeInfo(a,t,r)}),0===Object.keys(a.ChangeInfo).length?null:a},se.prototype.reset=function(){this.innerValueMap.clear()},se.prototype.clearChanges=function(){var o=this;this.ngVariableMap.forEach(function(e,t){var n=e.mapping,r=o.getValueFromUIState(n),i=o.innerValueMap.get(t);!1===o.isValueEqual(r,i)&&o.innerValueMap.set(t,r)})},se.prototype.clearChangeDetail=function(e){var i=this;e&&0!==Object.keys(e.ChangeInfo).length&&Object.keys(e.ChangeInfo).forEach(function(e){var t=i.ngVariableMap.get(e);if(t){var n=t.mapping,r=i.getValueFromUIState(n);i.innerValueMap.set(e,r)}})},se.prototype.appendToChangeInfo=function(e,t,n){if(!0===this.isUdtVariable(n)){var r=ie.createEmpty(b.Modify);r.ChangeInfo=n,e.ChangeInfo[t]=r}else e.ChangeInfo[t]=n},se.prototype.getValueFromUIState=function(e){var t=this.getRootUIState(),n=e.split(".").reduce(function(e,t){return e?e[t]:null},t);return n instanceof Date?r.format(n,"yyyy-MM-dd HH:mm:ss"):n},se.prototype.getRootUIState=function(){var e=this.appContext.frameContextManager.getRootFrameContext();if(this.injector){var t=this.injector.get(I.FrameContext,null);t&&(e=t.getVirtualRootFrameContext()||e)}if(e)return e.uiState},se.prototype.isValueEqual=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},se.prototype.isUdtVariable=function(e){return e&&e.constructor&&"[object Object]"===e.toString()&&e.constructor.prototype.hasOwnProperty("isPrototypeOf")},se.prototype.setValueToUIState=function(e,t){this.getRootUIState()[e]=t},se.ctorParameters=function(){return[{type:I.AppContext},{type:undefined},{type:o.Injector,decorators:[{type:o.Optional}]}]},se);function se(e,t,n){var r=this;this.appContext=e,this.ngVariables=t,this.injector=n,this.ngVariableMap=new Map,this.innerValueMap=new Map,Object.keys(t).forEach(function(e){r.ngVariableMap.set(e,t[e])})}var pe=(ue.buildRequestInfo=function(e){return{dataChange:e.entityManager.buildAllEntityChangeDetails(),variableChange:e.variableManager.buildChangeDetail()}},ue);function ue(){}var ce=(he.convertToPathArray=function(e,t){var r=this,n=I.BindingPathConverter.toBindingPathArray(e),i=[],o=t.list.currentItem;return i.push(o.primaryKeyValue),n.forEach(function(e){var t=I.PropertyUtil.getPropertyByName(o.properties,e);if(t.type!==I.BindingPropertyType.List)throw new Error(t.name+"不是子表对应的属性");var n=o[e];o=n.currentItem,i.push(r.trimTrailingS(e)),i.push(o.primaryKeyValue)}),i},he.convertToPathUrl=function(e,t){var n=this.convertToPathArray(e,t);return n.pop(),"/"+n.join("/")},he.convertToObjectCodes=function(e,t){for(var n=this.convertToPathArray(e,t),r=n.length,i=[],o=1;o<r;o+=2)i.push(n[o]);return i},he.convertToDataIdsForUpdate=function(e,t){for(var n=this.convertToPathArray(e,t),r=n.length,i=[],o=0;o<r;o+=2)i.push(n[o]);return i},he.convertToDataIdsForAdd=function(e,t){var n=this.convertToDataIdsForUpdate(e,t);return n.pop(),n},he.convertPathToUrl=function(e){for(var t=e.split("/"),n=t.length-1;0<n;n--)t[n]&&t[n].endsWith("s")&&(t[n]=t[n].substr(0,t[n].length-1).toLowerCase());return t.join("/")},he.trimTrailingS=function(e){return e.substr(0,e.length-1)},he.convertPathsToNodeCodes=function(e){var t=[];return!e||e.length<1||e.filter(function(e){return!!e&&-1===e.indexOf(":")}).forEach(function(e){t.push(e)}),t},he.convertPathsToIds=function(e){var t=[];return!e||e.length<1||e.filter(function(e){return!!e&&-1!==e.indexOf(":")}).forEach(function(e){t.push(e.split(":")[1])}),t},he);function he(){}var ye=(Object.defineProperty(le.prototype,"restProxy",{get:function(){return this.repository.restService.proxy},enumerable:!0,configurable:!0}),le.prototype.getList=function(e,t,n,r){var p=this;0!==n&&(n=n||this.repository.entityCollection.pageSize,r=r||this.repository.entityCollection.pageIndex);var i=this.buildEntityFilter(e,t,n,r),o=this.restService.buildRequestInfo();return this.restProxy.extendQuery(i,o).pipe(g.map(function(e){var t=e.returnValue,n=t.result,r=[];n.forEach(function(e){var t=p.repository.buildEntity(e);S.appendInitialData(t,e),r.push(t)});var i=t.pagination;if(i&&0<Object.keys(i).length){var o=i.pageSize,a=i.pageIndex,s=i.totalCount;p.repository.entityCollection.updatePaginationInfoByPath("/",{pageIndex:a,pageSize:o,totalCount:s})}else p.repository.entityCollection.updatePaginationInfoByPath("/",{pageIndex:1,pageSize:0,totalCount:r.length});return p.repository.entityCollection.loadEntities(r),r}))},le.prototype.filter=function(e,t,n,r){var p=this;0!==n&&(n=n||this.repository.entityCollection.pageSize,r=r||this.repository.entityCollection.pageIndex);var i=this.buildEntityFilter(e,t,n,r),o=this.restService.buildRequestInfo();return this.restProxy.filter(i,o).pipe(g.map(function(e){var t=e.returnValue,n=t.result,r=[];n.forEach(function(e){var t=p.repository.buildEntity(e);S.appendInitialData(t,e),r.push(t)});var i=t.pagination;if(i&&0<Object.keys(i).length){var o=i.pageSize,a=i.pageIndex,s=i.totalCount;p.repository.entityCollection.updatePaginationInfoByPath("/",{pageIndex:a,pageSize:o,totalCount:s})}else p.repository.entityCollection.updatePaginationInfoByPath("/",{pageIndex:1,pageSize:0,totalCount:r.length});return p.repository.entityCollection.loadEntities(r),r}))},le.prototype.buildEntityFilter=function(e,t,n,r){return e||t||n||r?(e&&0<e.length&&(e[e.length-1].Relation=0),{FilterConditions:e,SortConditions:t,IsUsePagination:0!==n,Pagination:{PageIndex:r,PageSize:n,PageCount:0,TotalCount:0}}):null},le.prototype.getById=function(e){var r=this,t=this.restService.buildRequestInfo(),n=this.buildRetrieveParam();return n?this.getEntityById(e):this.restService.extendRetrieve(e,t,n).pipe(g.map(function(e){var t=e.returnValue,n=r.repository.buildEntity(t);return r.repository.entityCollection.loadEntities([n]),n}))},le.prototype.getEntityById=function(e){var o=this,t=this.restService.buildRequestInfo(),n=this.buildRetrieveParam();return this.restService.serviceRetrieve(e,n,t).pipe(g.map(function(e){var t=e.returnValue||{},n=t.result,r=t.pagination;o.updatePagination(r);var i=o.repository.buildEntity(n);return o.repository.entityCollection.loadEntities([i]),i}))},le.prototype.queryChild=function(p,e,t,n,r){var u=this,i=this.restService.buildRequestInfo(),o=ce.convertPathsToNodeCodes(p).map(function(e){return e.substring(0,e.length-1)}),c=o[o.length-1],a=(this.repository.entityCollection.getPaginationConfigByPath("/"+c)||{}).pageSize,s=void 0===a?0:a,h=this.injector.get(I.ViewModel,null),y=!1;if(h&&(y=h.frameContext.appContext.params.get("forceQueryChild")||!1),0==s&&!y)return C.of(null);var l=ce.convertPathsToIds(p),d=l[l.length-1],f={nodeCodes:o,ids:l,pagination:{pageIndex:e,pageSize:t},requestInfo:i};return this.restService.queryChild(f).pipe(g.map(function(e){var t=e.returnValue;if(!t)return null;var n=t.result,r=void 0===n?[]:n,i=t.pagination,o=void 0===i?{}:i,a=p.map(function(e,t){return e.includes(":")&&t%2==0?e.split(":")[1]:e}),s=u.repository.entityManager.createEntitiesByPath("/"+a.join("/"),r);u.repository.entityCollection.resetEntities(p,s),u.repository.entityCollection.setPaginationConfigByPath("/"+c+"_"+d,o)}))},le.prototype.buildChildrenPagination=function(){var r=this.repository.entityCollection.getPaginationConfigByPath("/"),i={},o=[];return I.DataTypeInfoUtil.getChildrenNodeCodes(this.repository.entityTypeInfo,o),!o||o.length<1?null:(Object.keys(r).forEach(function(e){var t=r[e];if("object"==typeof t){var n=e&&e.includes("_")&&e.split("_")[0]||null;n&&o.includes(n+"s")||(i[e]=t)}}),i)},le.prototype.updatePagination=function(t){var n=this;if(t){var e=[];I.DataTypeInfoUtil.getChildrenNodeCodes(this.repository.entityTypeInfo,e),e=e.map(function(e){return e.substr(0,e.length-1)}),!t||Object.keys(t).length<1?e&&0<e.length&&e.forEach(function(e){var t=n.repository.entityCollection.getPaginationConfigByPath("/"+e);t&&(t.pageIndex=1,t.total=0,n.repository.entityCollection.setPaginationConfigByPath("/"+e,t))}):Object.keys(t).forEach(function(e){n.repository.entityCollection.setPaginationConfigByPath("/"+e,t[e])})}},le.prototype.buildRetrieveParam=function(){var r=this.buildChildrenPagination();if(!r||Object.keys(r).length<1)return null;var i={filters:{},parentIds:{}};return I.ExpressionUtil.getChildrenEntityPaths(this.repository.entityTypeInfo,[]),Object.keys(r).forEach(function(e){var t=r[e],n=t.pageIndex||1;i.filters[e]={pagination:{pageSize:t.pageSize||0,pageIndex:n}}}),i},le.prototype.editById=function(r){var i=this;if(!this.repository.entityCollection.getEntityById(r))return C.of(null);var e=pe.buildRequestInfo(this.repository);return this.restProxy.edit(r,e).pipe(g.map(function(e){var t=e.returnValue.data,n=i.repository.entityCollection.getEntityById(r);return n&&t&&i.reloadEntityData(n,t),n}))},le.prototype.updateById=function(r){var i=this;if(!this.repository.entityCollection.getEntityById(r))return C.of(null);var e=this.restService.buildRequestInfo(),t=this.buildRetrieveParam();return t?this.updateEntityById(r):this.restService.extendRetrieve(r,e,t).pipe(g.map(function(e){var t=e.returnValue,n=i.repository.entityCollection.getEntityById(r);return i.reloadEntityData(n,t),n}))},le.prototype.updateEntityById=function(o){var a=this,e=this.restService.buildRequestInfo(),t=this.buildRetrieveParam();return this.restService.serviceRetrieve(o,t,e).pipe(g.map(function(e){var t=e.returnValue||{},n=t.result,r=t.pagination;a.updatePagination(r);var i=a.repository.entityCollection.getEntityById(o);return a.reloadEntityData(i,n),i}))},le.prototype.reloadEntityData=function(e,t){e&&(this.appContext.changeDetectionController.detach(),this.repository.entityCollection.updateEntity(e,t),e.changes.splice(0,e.changes.length),this.appContext.changeDetectionController.reattach())},le.prototype.create=function(e){var r=this,t=this.restService.buildRequestInfo();return this.restService.create(e,t).pipe(g.map(function(e){var t=e.returnValue,n=r.repository.buildEntity(t);return S.appendInitialData(n,t),r.repository.entityCollection.loadEntities([n],!0),n}))},le.prototype.append=function(e){var r=this,t=this.restService.buildRequestInfo();return this.restService.create(e,t).pipe(g.map(function(e){var t=e.returnValue,n=r.repository.buildEntity(t);return r.repository.entityCollection.addEntity(n),n}))},le.prototype.insert=function(r,e){var i=this,t=this.buildRequestInfo();return this.restProxy.create(e,t).pipe(g.map(function(e){var t=e.returnValue,n=i.repository.buildEntity(t);return i.repository.entityCollection.insertEntity(n,r),n}))},le.prototype.appendByPath=function(n){var r=this,e=this.restService.buildRequestInfo();return this.restService.createByPath(n,e).pipe(g.map(function(e){var t=e.returnValue;return r.repository.entityManager.appendEntityByPath(n,t,t)}))},le.prototype.insertByPath=function(n,r){var i=this,e=this.buildRequestInfo();return this.restProxy.createByPath(n,e).pipe(g.map(function(e){var t=e.returnValue;return i.repository.entityManager.insertEntityByPath(n,t,t,r)}))},le.prototype.removeById=function(e,t){var n=this;t=t===undefined||t;var r=pe.buildRequestInfo(this.repository);return t?this.restProxy.deleteAndSave(e,r).pipe(g.switchMap(function(){return n.repository.entityCollection.removeEntityById(e),C.of(!0)})):this.restService.extendDelete(e,r).pipe(g.switchMap(function(){return n.repository.entityCollection.removeEntityById(e),n.repository.dataChangeHistory.addChange({dataId:e,changeType:I.DataChangeType.Delete}),C.of(!0)}))},le.prototype.removeAndSaveById=function(e){var t=this,n=pe.buildRequestInfo(this.repository);return this.restProxy.deleteAndSave(e,n).pipe(g.switchMap(function(){return t.repository.entityCollection.removeEntityById(e),C.of(!0)}))},le.prototype.removeByIds=function(n,e){var r=this;e=e===undefined||e;var t=this.restService.buildRequestInfo();return this.restService.extendBatchDelete(n,t).pipe(g.switchMap(function(){if(e)return r.applyChangesByIdArray(n).pipe(g.tap(function(e){e&&r.repository.entityCollection.removeEntities(function(e){return r.checkEntityValueExists(e,n)})}));if(r.repository.entityCollection.removeEntities(function(e){return r.checkEntityValueExists(e,n)}),n&&0<n.length){var t=[];n.forEach(function(e){t.push({dataId:e,changeType:I.DataChangeType.Delete})}),r.repository.dataChangeHistory.addChanges(t)}return C.of(!0)}))},le.prototype.batchRemove=function(t,e){var n=this,r=this.restService.buildRequestInfo();return this.restService.extendBatchDeletion(t,r).pipe(g.switchMap(function(){return e?n.applyChangesByIdArray(t).pipe(g.tap(function(e){e&&n.removeEntities(t)})):(n.removeEntities(t),n.addBatchRemoveHistory(t),C.of(!0))}))},le.prototype.addBatchRemoveHistory=function(e){if(e&&0<e.length){var t=[];e.forEach(function(e){t.push({dataId:e,changeType:I.DataChangeType.Delete})}),this.repository.dataChangeHistory.addChanges(t)}},le.prototype.removeEntities=function(t){var n=this;this.repository.entityCollection.removeEntities(function(e){return n.checkEntityValueExists(e,t)})},le.prototype.checkEntityValueExists=function(e,t){for(var n=!1,r=0;r<t.length;r++)if(e.primaryValue===t[r]){n=!0;break}return n},le.prototype.removeByPath=function(e,t){var n=this,r=this.restService.buildRequestInfo();return this.restService.extendDeletByPath(e,t,r).pipe(g.map(function(){return n.repository.entityManager.removeEntityByPath(e,t),n.repository.dataChangeHistory.addChange({fpath:e,dataId:t,changeType:I.DataChangeType.Delete}),!0}))},le.prototype.batchRemoveByPath=function(t,n){var r=this,e=this.restService.buildRequestInfo();return this.restService.batchDeleteByPath(t,n,e).pipe(g.map(function(){var e=n.split(",");return 0<e.length&&e.forEach(function(e){r.repository.entityManager.removeEntityByPath(t,e),r.repository.dataChangeHistory.addChange({fPath:t,dataId:e,changeType:I.DataChangeType.Delete})}),!0}))},le.prototype.updateChangesById=function(e){var t=this,n=this.repository.entityCollection.getEntityById(e);if(!n.changes)return C.of(!0);if(0===n.changes.length)return C.of(!0);var r=this.repository.entityManager.buildEntityChangeDetailById(e),i=this.restService.buildRequestInfo();return this.restService.update(r,i).pipe(g.tap(function(){t.repository.entityManager.clearEntityChangesById(e)}),g.map(function(){return!0}))},le.prototype.updateChangesByPath=function(e,t){throw new Error("Not Implement")},le.prototype.updateAllChanges=function(){var n=this,r=[],e=this.repository.entityCollection.toArray();return 0===e.length?C.of(!0):(e.forEach(function(e){var t=n.updateChangesById(e.primaryValue);r.push(t)}),C.zip.apply(void 0,R(r)).pipe(g.map(function(){return!0})))},le.prototype.applyChanges=function(){var e=this,t=this.restService.buildRequestInfo();return this.restService.save(t).pipe(g.tap(function(){e.repository.entityManager.clearAllEntityChanges(),e.repository.clearAllVariableChanges(t.variableChange),e.repository.dataChangeHistory.clear()}),g.map(function(){return!0}))},le.prototype.applyChangesByIdArray=function(e){var t=this,n=this.restService.buildRequestInfo();return this.restService.save(n).pipe(g.tap(function(){t.repository.entityManager.clearEntityChangesByArray(e),t.repository.dataChangeHistory.clearByIds(e)}),g.map(function(){return!0}))},le.prototype.applyChangesById=function(e){var t=this,n=this.restService.buildRequestInfo();return this.restService.save(n).pipe(g.tap(function(){t.repository.entityManager.clearEntityChangesById(e),t.repository.dataChangeHistory.clearByIds([e])}),g.map(function(){return!0}))},le.prototype.cancelChanges=function(e){var t=this;return this.restService.cancel(e).pipe(g.tap(function(){t.repository.entityManager.clearAllEntityChanges(),t.repository.dataChangeHistory.clear()}),g.map(function(){return!0}))},le.prototype.batchAppendByPath=function(i,e){var o=this,t=this.buildRequestInfo();return this.restProxy.batchAppendByPath(i,e,t).pipe(g.map(function(e){var t=e.returnValue,n=o.repository.entityManager.createEntitiesByPath(i,t),r=i.split("/").filter(function(e){return e});return o.repository.entityManager.appendEntitiesByPath(r,n),n}))},le.prototype.batchAppend=function(e){var r=this,t=this.buildRequestInfo();return this.restProxy.batchAppend(e,t).pipe(g.map(function(e){var t=e.returnValue,n=r.repository.buildEntities(t);return r.repository.entityCollection.addEntities(n),n}))},le.prototype.buildRequestInfo=function(){return{dataChange:this.repository.entityManager.buildAllEntityChangeDetails(),variableChange:this.repository.variableManager.buildChangeDetail()}},le);function le(e,t){this.injector=e,this.repository=t;var n=e.get(d),r=e.get(h.HttpClient),i=e.get(y)+"/"+this.repository.apiUri,o=e.get(I.EventBus);this.restService=new we(r,i,n,this.repository,o),this.appContext=e.get(I.AppContext)}var de=(fe.handleMessage=function(e,t,n){var r={ns:t.get(I.NAMESPACE,null),appContext:t.get(I.AppContext,null)},i=this.buildBackEndMessages(e),o=new I.BackEndMessage.Message(i,r),a=t.get(I.BACK_END_MESSAGE_HANDLER_TOKEN,null);a&&a.handle(o,n)},fe.isBackEndMessageHandlerExist=function(e){return!!e.get(I.BACK_END_MESSAGE_HANDLER_TOKEN,null)},fe.getFormlessMessages=function(e){return(this.buildBackEndMessages(e)||[]).filter(function(e){return!e.location||!e.location.columns||e.location.columns.length<1||!e.location.nodeCode})},fe.buildBackEndMessages=function(e){if(!e||e.length<1||!Array.isArray(e))return null;var n=[];return e.forEach(function(e){var t={level:e.level,message:e.message};e.hasOwnProperty("location")&&e.location&&(t.location={nodeCode:e.location.nodeCode,rows:e.location.dataIds,columns:e.location.columnNames}),n.push(t)}),n},fe);function fe(){}var ge=(ve.getSessionId=function(e,t){var n=e.ApplicationId+"_"+t.beBaseUri;return this.createSessionHistory.includes(n)?C.of(null):(this.createSessionHistory.push(n),t.getBeSessionId())},ve.createSessionHistory=[],ve.decorators=[{type:o.Injectable}],ve);function ve(){}var Ie=(be.prototype.onResponse=function(e,t,n){e&&e.innerDataChange&&!0!==t&&this.context.handleDataChangeDetails(e.innerDataChange),e&&e.innerVariableChange&&this.context.handleVariableChangeDetail(e.innerVariableChange);var r=j.parseBackEndMessage(e);de.handleMessage(r,this.context.getInjector()),this.context.clearAllEntityChanges();var i=O.getRequestInfo(n),o=i&&i.variableChange;return this.context.clearAllVariableChanges(o),e&&e.hasOwnProperty("returnValue")?e.returnValue:e},be.prototype.onError=function(e,t,n){var r,i,o=this.context.appContext.getFormAppContext(),a=o.ApplicationId,s=window.DEVKIT_LOADING_SERVICE,p=j.parseBackEndError(e);if(de.handleMessage(p,this.context.getInjector()),s&&s instanceof Array&&0<s.length)try{for(var u=B(s),c=u.next();!c.done;c=u.next()){var h=c.value;"function"==typeof h.destroy&&h.destroy()}}catch(b){r={error:b}}finally{try{c&&!c.done&&(i=u["return"])&&i.call(u)}finally{if(r)throw r.error}}if(t)return C.throwError(e);var y=this.context.restService.eventBus,l=!!(window[a]||{}).isExceptionHandlerExist,d=j.parseBackEndError(e),f=de.getFormlessMessages(d),g=f&&0<f.length||!1,v=!(e&&e.error&&e.error.extensionMessage&&de.isBackEndMessageHandlerExist(this.context.getInjector())&&!g),I=!!y&&l&&v;return de.handleMessage(d,this.context.getInjector(),{hasThrowError:I,isException:!0,eventBus:y,error:e,formAppContext:o}),y&&l&&!j.isReported401Error(e)?(v&&y.post("Exception","","onException",e,o),n?C.of(null):C.EMPTY):C.throwError(e)},be.prototype.extendHeaders=function(t,n){var r=this,e=this.context.appContext.getFormAppContext();return ge.getSessionId(e,this.context.restService.sessionService).pipe(g.switchMap(function(e){return t=r.context.restService.sessionService.extendRequestHeaders(t,n),C.of(t)}))},be.prototype.extendUrl=function(e,t){if(!t)return e;for(var n in t)if(t.hasOwnProperty(n)){var r=JSON.stringify(t[n]);e=-1===e.indexOf("?")?e+"?"+n+"="+r:e+"&"+n+"="+r}return e},be.prototype.extendBody=function(t){var n=this;return!t||"object"!=typeof t||Object.keys(t).length<1||(Object.keys(t).forEach(function(e){"requestInfo"===e&&(t.requestInfo=n.context.restService.buildRequestInfo())}),1===Object.keys(t).length&&(t=Object.values(t)[0])),t},be.prototype.parseHeaders=function(e){var t="BEFSessionID";e.headers&&e.headers.has(t)&&this.context.restService.sessionService.setBeSessionId(e.headers.get(t))},be);function be(e){this.context=e}var Ce,Se=(x(me,Ce=$),Object.defineProperty(me.prototype,"proxy",{get:function(){return this.befProxy},set:function(e){this.befProxy=e,this.befProxy.setProxyExtend(new Ie(this))},enumerable:!0,configurable:!0}),me.prototype.getEntities=function(e,t,n,r){return this.dataService.getList(e,t,n,r)},me.prototype.filter=function(e,t,n,r){return void 0===e&&(e=[]),void 0===t&&(t=[]),this.dataService.filter(e,t,n,r)},me.prototype.queryChild=function(e,t,n,r,i){return this.dataService.queryChild(e,t,n,r,i)},me.prototype.getEntityById=function(e){return this.dataService.getById(e)},me.prototype.updateEntityById=function(e){return this.dataService.updateById(e)},me.prototype.editEntityById=function(e){return this.dataService.editById(e)},me.prototype.createEntity=function(e){return this.dataService.create(e)},me.prototype.appendEntity=function(e){return this.dataService.append(e)},me.prototype.insert=function(e,t){return this.dataService.insert(e,t)},me.prototype.insertByPath=function(e,t){return this.dataService.insertByPath(e,t)},me.prototype.appendEntityByPath=function(e){return this.dataService.appendByPath(e)},me.prototype.removeEntityById=function(e,t){return this.dataService.removeById(e,t)},me.prototype.removeEntityAndSaveById=function(e){return this.dataService.removeAndSaveById(e)},me.prototype.removeEntityByPath=function(e,t){return this.dataService.removeByPath(e,t)},me.prototype.batchRemove=function(e,t){return void 0===t&&(t=!1),this.dataService.batchRemove(e,t)},me.prototype.batchRemoveByPath=function(e,t){return this.dataService.batchRemoveByPath(e,t)},me.prototype.saveEntityById=function(e){return this.dataService.applyChangesById(e)},me.prototype.saveEntities=function(){return this.dataService.applyChanges()},me.prototype.cancelEntityChanges=function(){return this.dataService.cancelChanges()},me.prototype.batchAppendByPath=function(e,t){return this.dataService.batchAppendByPath(e,t)},me.prototype.batchAppend=function(e){return this.dataService.batchAppend(e)},me.prototype.reset=function(){this.entityManager.reset(),this.variableManager.reset(),this.restService.sessionService.clearBeSessionId()},me.prototype.getInjector=function(){return this.injector},me.prototype.clearAllVariableChanges=function(e){this.variableManager.clearChangeDetail(e)},me.decorators=[{type:o.Injectable}],me.ctorParameters=function(){return[{type:o.Injector}]},me);function me(e){var t=Ce.call(this)||this;t.injector=e,t.entityCollection&&(t.entityManager=new ne(t.entityCollection)),t.appContext=t.injector.get(I.AppContext);var n=I.MetadataUtil.getPropsMetadatasByName(t.constructor,X);return t.variableManager=new ae(t.appContext,n,t.injector),t.dataService=new ye(t.injector,t),t.serverUri=e.get(y),t}var Ee=(xe.prototype.extendUri=function(e){return this.serverUri+"/"+e},xe.decorators=[{type:o.Injectable}],xe.ctorParameters=function(){return[{type:String,decorators:[{type:o.Inject,args:[y]}]}]},xe);function xe(e){this.serverUri=e}var Be="DELETE",Pe="PUT",Re="POST",De=(qe.prototype.setBaseUri=function(e){this.baseUri=e},qe.prototype.setProxyExtend=function(e){this.proxyExtend=e},qe.prototype.query=function(e){var t=this.baseUri;return e&&(t=t+"?entityFilter="+JSON.stringify(e)),this.request(t,"GET")},qe.prototype.extendQuery=function(e,t){var n=this.baseUri+"/extension/query";if(e){var r=JSON.stringify(e);n=n+"?entityFilter="+(r=I.encodeUrl(r))}var i=t,o=this.addBodyToOptions({},i);return this.request(n,Pe,null,o,!1)},qe.prototype.filter=function(e,t){var n=this.baseUri+"/extension/filter",r={requestInfo:t};e&&(r={entityFilter:e,requestInfo:t});var i=this.addBodyToOptions({},r);return this.request(n,Re,null,i,!1)},qe.prototype.retrieve=function(e){var t=this.baseUri+"/"+e;return this.request(t,"GET")},qe.prototype.serviceRetrieve=function(e,t,n){var r=this.baseUri+"/service/retrieve/"+e,i={body:{retrieveParam:t,requestInfo:n}};return this.request(r,Pe,null,i)},qe.prototype.queryChild=function(e){var t=this.baseUri+"/service/querychild",n={body:e};return this.request(t,Pe,null,n)},qe.prototype.extendRetrieve=function(e,t,n){var r=this.baseUri+"/extension/retrieve/"+e,i=t;n&&(i={retrieveParam:n,requestInfo:t});var o=this.addBodyToOptions({},i);return this.request(r,Pe,null,o)},qe.prototype.edit=function(e,t){var n=this.baseUri+"/service/edit/"+e,r=t,i=this.addBodyToOptions({},r);return this.request(n,Pe,null,i)},qe.prototype.create=function(e,t){var n={defaultValue:e,requestInfo:t},r=this.addBodyToOptions({},n);return this.request(this.baseUri,Re,null,r)},qe.prototype.createByPath=function(e,t){var n=ce.convertPathToUrl(e),r=""+this.baseUri+n,i=t,o=this.addBodyToOptions({},i);return this.request(r,Re,null,o)},qe.prototype.update=function(e,t){var n={changeDetail:e,requestInfo:t},r=this.addBodyToOptions({},n);return this.request(this.baseUri,"PATCH",null,r)},qe.prototype.save=function(e){var t=e,n=this.addBodyToOptions({},t);return this.request(this.baseUri,Pe,null,n)},qe.prototype["delete"]=function(e){var t=this.baseUri+"/"+e;return this.request(t,Be)},qe.prototype.deleteAndSave=function(e,t){var n=this.baseUri+"/service/delete/"+e,r=t,i=this.addBodyToOptions({},r);return this.request(n,Pe,null,i)},qe.prototype.extendDelete=function(e,t){var n=this.baseUri+"/extension/delete/"+e,r=t,i=this.addBodyToOptions({},r);return this.request(n,Pe,null,i)},qe.prototype.deletByPath=function(e,t){var n=ce.convertPathToUrl(e),r=""+this.baseUri+n+"/"+t;return this.request(r,Be)},qe.prototype.extendDeletByPath=function(e,t,n){var r=ce.convertPathToUrl(e),i=this.baseUri+"/extension"+r+"/"+t,o=n,a=this.addBodyToOptions({},o);return this.request(i,Pe,null,a)},qe.prototype.batchDeleteByPath=function(e,t,n){var r=ce.convertPathToUrl(e);if(r.split("/").length<3)throw Error("根据path删除实体数据出错了。传入的path["+e+"]格式不对");var i=this.baseUri+"/extension"+r+"/batch",o={ids:t.split(","),requestInfo:n},a=this.addBodyToOptions({},o);return this.request(i,Pe,null,a)},qe.prototype.batchDelete=function(e){var t={ids:e.join(",")};return this.request(this.baseUri,Be,t)},qe.prototype.extendBatchDeletion=function(e,t){var n=this.baseUri+"/extension/batchdeletion",r={ids:e,requestInfo:t},i=this.addBodyToOptions({},r);return this.request(n,Pe,null,i)},qe.prototype.extendBatchDelete=function(e,t){var n=this.baseUri+"/extension/batchdelete",r={ids:e.join(",")},i=t,o=this.addBodyToOptions({},i);return this.request(n,Pe,r,o)},qe.prototype.cancel=function(e){var t=this.baseUri+"/service/cancel";return this.request(t,Re,null,null,!1,!1,!1,e)},qe.prototype.batchAppendByPath=function(e,t,n){var r=ce.convertPathToUrl(e),i=""+this.baseUri+r+"/batch",o={requestInfo:n,retrieveDefaultParam:{defaultValues:t}},a=this.addBodyToOptions({},o);return this.request(i,Re,null,a)},qe.prototype.batchAppend=function(e,t){var n=this.baseUri+"/batch",r={requestInfo:t,retrieveDefaultParam:{defaultValues:e}},i=this.addBodyToOptions({},r);return this.request(n,Re,null,i)},qe.prototype.request=function(t,n,e,r,i,o,a,s){var p=this;r=r||{},void 0!==i&&"boolean"==typeof i||(i=!1),void 0!==o&&"boolean"==typeof o||(o=!1),e&&(r.params=e),r.headers=D.convertToHeaders(r.headers);var u=this.hasRequestInfo(r);return r&&r.body&&r.body.hasOwnProperty("RequestInfo")&&(r.body.requestInfo=r.body.RequestInfo,delete r.body.RequestInfo),this.proxyExtend.extendHeaders(r.headers,s).pipe(g.switchMap(function(e){return r.headers=D.toJson(e),r.observe="response",p.httpService.request(n,t,r)}),g.tap(function(e){return p.proxyExtend.parseHeaders(e)}),g.map(function(e){return e.body}),g.map(function(e){return u?(p.proxyExtend.onResponse(e,a,r),e):p.unWrapResponseInfo(e)}),g.catchError(function(e){return p.proxyExtend.onError(e,i,o)}))},qe.prototype.invoke=function(t,n,r){var i=this;return r.params&&(t=this.proxyExtend.extendUrl(t,r.params),r.params=null),r.body&&(r.body=this.proxyExtend.extendBody(r.body)),r.headers=D.convertToHeaders(r.headers),this.proxyExtend.extendHeaders(r.headers).pipe(g.switchMap(function(e){return r.headers=D.toJson(e),r.observe="response",i.httpService.request(n,t,r).pipe(g.tap(function(e){return i.proxyExtend.parseHeaders(e)}),g.map(function(e){return e.body}),g.map(function(e){return i.proxyExtend.onResponse(e,!1,r)}),g.catchError(function(e){return i.proxyExtend.onError(e,!1,!1)}))}))},qe.prototype.addBodyToOptions=function(e,t){return e=e||{},Object.assign(e,{body:t})},qe.prototype.buildParams=function(e){return w.buildParams(e)},qe.prototype.hasRequestInfo=function(e){return O.hasRequestInfo(e)||O.hasRequestInfoWithR(e)},qe.prototype.unWrapResponseInfo=function(e){return j.unWrapResponseInfo(e)},qe.decorators=[{type:o.Injectable}],qe.ctorParameters=function(){return[{type:h.HttpClient},{type:Ee}]},qe);function qe(e,t){this.httpClient=e,this.uriService=t,this.httpService=new A(this.httpClient)}var we=(Object.defineProperty(Te.prototype,"proxy",{get:function(){return this.repository.proxy?this.repository.proxy:this.createBefProxy()},enumerable:!0,configurable:!0}),Te.prototype.createBefProxy=function(){var e=this.repository.serverUri,t=new Ee(e),n=new De(this.httpClient,t);n.setBaseUri(this.baseUri);var r=new Ie(this.repository);return n.setProxyExtend(r),n},Te.prototype.query=function(e){return this.proxy.query(e)},Te.prototype.extendQuery=function(e,t){return this.proxy.extendQuery(e,t)},Te.prototype.serviceRetrieve=function(e,t,n){return this.proxy.serviceRetrieve(e,t,n)},Te.prototype.queryChild=function(e){return this.proxy.queryChild(e)},Te.prototype.retrieve=function(e){return this.proxy.retrieve(e)},Te.prototype.extendRetrieve=function(e,t,n){return this.proxy.extendRetrieve(e,t,n)},Te.prototype.create=function(e,t){return this.proxy.create(e,t)},Te.prototype.createByPath=function(e,t){return this.proxy.createByPath(e,t)},Te.prototype.update=function(e,t){return this.proxy.update(e,t)},Te.prototype.save=function(e){return this.proxy.save(e)},Te.prototype["delete"]=function(e){return this.proxy["delete"](e)},Te.prototype.extendDelete=function(e,t){return this.proxy.extendDelete(e,t)},Te.prototype.deletByPath=function(e,t){return this.proxy.deletByPath(e,t)},Te.prototype.extendDeletByPath=function(e,t,n){return this.proxy.extendDeletByPath(e,t,n)},Te.prototype.batchDeleteByPath=function(e,t,n){return this.proxy.batchDeleteByPath(e,t,n)},Te.prototype.batchDelete=function(e){return this.proxy.batchDelete(e)},Te.prototype.extendBatchDelete=function(e,t){return this.proxy.extendBatchDelete(e,t)},Te.prototype.extendBatchDeletion=function(e,t){return this.proxy.extendBatchDeletion(e,t)},Te.prototype.cancel=function(e){return this.proxy.cancel(e)},Te.prototype.request=function(e,t,n,r,i,o,a){return this.innerRequest(e,t,n,r,i,o,a,!1)},Te.prototype.invoke=function(e,t,n,r,i,o,a){if(r&&r.body&&r.body.RequestInfo)throw new Error("请使用requestInfo提交变更");return this.innerRequest(e,t,n,r,i,o,a,!0)},Te.prototype.innerRequest=function(t,n,e,r,i,o,a,s){var p=this;r=r||{};var u="BEFSessionID";void 0!==i&&"boolean"==typeof i||(i=!1),void 0!==o&&"boolean"==typeof o||(o=!1),void 0!==s&&"boolean"==typeof s||(s=!1);var c=s?this.existRequestInfo:this.hasRequestInfo;e&&(r.params=e);var h=c(r),y=D.convertToHeaders(r.headers),l=this.repository.appContext.getFormAppContext();return ge.getSessionId(l,this.sessionService).pipe(g.switchMap(function(e){return y=p.sessionService.extendRequestHeaders(y),r.headers=D.toJson(y),r.observe="response",p.httpService.request(n,t,r)}),g.tap(function(e){e.headers&&e.headers.has(u)&&p.sessionService.setBeSessionId(e.headers.get(u))}),g.map(function(e){return e.body}),g.map(function(e){var t=j.parseBackEndMessage(e);return de.handleMessage(t,p.repository.getInjector()),p.handleReponseInfo(e,h,a,r)}),g.catchError(function(e){return p.handleErrors(e,i,o)}))},Te.prototype.handleReponseInfo=function(e,t,n,r){if(t){e&&e.innerDataChange&&!0!==n&&this.repository.handleDataChangeDetails(e.innerDataChange),e&&e.innerVariableChange&&this.repository.handleVariableChangeDetail(e.innerVariableChange),this.repository.clearAllEntityChanges();var i=O.getRequestInfo(r),o=i&&i.variableChange;return this.repository.clearAllVariableChanges(o),e}return this.unWrapResponseInfo(e)},Te.prototype.handleErrors=function(e,t,n){if(this.clearLoading(),t)return C.throwError(e);var r=this.repository.appContext.getFormAppContext(),i=r.ApplicationId,o=window[i]||{},a=j.parseBackEndError(e),s=de.getFormlessMessages(a),p=!!o.isExceptionHandlerExist,u=s&&0<s.length||!1,c=!(e&&e.error&&e.error.extensionMessage&&de.isBackEndMessageHandlerExist(this.repository.getInjector())&&!u),h=!!this.eventBus&&p&&c;return de.handleMessage(a,this.repository.getInjector(),{hasThrowError:h,isException:!0,eventBus:this.eventBus,error:e,formAppContext:r}),this.eventBus&&p&&!j.isReported401Error(e)?(c&&this.eventBus.post("Exception","","onException",e,r),n?C.of(null):C.EMPTY):C.throwError(e)},Te.prototype.clearLoading=function(){var e,t;if(!1!==(window.DEVKIT_LOADING_SERVICE&&window.DEVKIT_LOADING_SERVICE instanceof Array&&0<window.DEVKIT_LOADING_SERVICE.length||!1)){var n=window.DEVKIT_LOADING_SERVICE;try{for(var r=B(n),i=r.next();!i.done;i=r.next()){var o=i.value;"function"==typeof o.destroy&&o.destroy()}}catch(a){e={error:a}}finally{try{i&&!i.done&&(t=r["return"])&&t.call(r)}finally{if(e)throw e.error}}}},Te.prototype.unWrapResponseInfo=function(e){return j.unWrapResponseInfo(e)},Te.prototype.hasRequestInfo=function(e){return O.hasRequestInfoWithR(e)},Te.prototype.existRequestInfo=function(e){return O.hasRequestInfo(e)},Te.prototype.buildParams=function(e){return w.buildParams(e)},Te.prototype.buildBodyWithRequestInfo=function(e){return O.buildBodyWithRequestInfo(e,this.repository)},Te.prototype.buildRequestInfo=function(){return O.buildRequestInfo(this.repository)},Te.decorators=[{type:o.Injectable}],Te.ctorParameters=function(){return[{type:h.HttpClient},{type:String},{type:d},{type:Se},{type:I.EventBus}]},Te);function Te(e,t,n,r,i){this.httpClient=e,this.httpService=new A(this.httpClient),this.baseUri=t;var o=r.getInjector();this.sessionService=new W(e,t,n,o),this.repository=r,this.eventBus=i}var Oe=(Me.prototype.registerDestroyEvent=function(){var e=this;this.frameContext&&this.frameContext.destorySignal&&this.frameContext.destorySignal.subscribe(function(){e.frameContext=null,e.befRepository=null})},Me.prototype.getData=function(e,t){var n=e.split(".")[0],r=e.split(".")[1];if(t=t||{},this.frameContext){var i=this.frameContext.bindingData.list.currentId;t.currentForm={id:i}}return!0===this.ifEnableExtendLoadMethod(e)?this.extendGetHelpData(r,n,t):this.getHelpData(r,n,t)},Me.prototype.saveUserSettings=function(e){var n=this;return this.befRepository.restService.invoke("/api/runtime/bcc/v1.0/datagrid/settings","POST",null,{body:e},!1).pipe(g.catchError(function(e){var t=n.befRepository.appContext.getFormAppContext();return n.befRepository.restService.eventBus.post("Exception","","onException",e,t),C.EMPTY}))},Me.prototype.getUserSettings=function(e){var n=this,t="/api/runtime/bcc/v1.0/datagrid/settings/"+e;return this.befRepository.restService.invoke(t,"GET",null,null,!1).pipe(g.catchError(function(e){var t=n.befRepository.appContext.getFormAppContext();return n.befRepository.restService.eventBus.post("Exception","","onException",e,t),C.EMPTY}))},Me.prototype.ifEnableExtendLoadMethod=function(e){if(this.context&&this.context.hasOwnProperty("enableExtendLoadMethod"))return this.context.enableExtendLoadMethod;var t=!1;if(this.frameContext){var n=e+"@"+this.frameContext.repository.apiUri;t=this.frameContext.getParam(n)}return t},Me.prototype.getHelpData=function(e,t,n){var r=this,i=this.befRepository.restService.baseUri+"/elementhelps/"+e;return this.befRepository.updateDataAndVariableChanges().pipe(g.switchMap(function(){return r.befRepository.restService.invoke(i,"GET",{nodeCode:t,queryParam:JSON.stringify(n)},null,!1).pipe(g.catchError(function(e){var t=r.befRepository.appContext.getFormAppContext();return r.befRepository.restService.eventBus.post("Exception","","onException",e,t),C.EMPTY}))}))},Me.prototype.extendGetHelpData=function(e,t,n){var r=this,i=this.befRepository.restService.baseUri+"/extension/elementhelps",o={body:{labelId:e,nodeCode:t,queryParam:n,requestInfo:this.befRepository.restService.buildRequestInfo()}};return this.befRepository.restService.invoke(i,"PUT",null,o,!1,!0,!0).pipe(g.map(function(e){return e&&e.returnValue||null}),g.catchError(function(e){var t=r.befRepository.appContext.getFormAppContext();return r.befRepository.restService.eventBus.post("Exception","","onException",e,t),C.EMPTY}))},Me.prototype.convert2TreeDataWithPathCode=function(r,t,n){var i=this;void 0===t&&(t=1),void 0===n&&(n="01");var e=r.filter(function(e){return e.layer===t&&e.pathcode===n});if(1<t&&(e=r.filter(function(e){return e.layer===t&&e.pathcode.substr(0,2*(t-1))===n})),e.length){var o=e.map(function(e){return{data:e,children:[]}});return o.forEach(function(e){var t,n=i.convert2TreeDataWithPathCode(r,e.data.layer+1,e.data.pathcode);(t=e.children).push.apply(t,R(n))}),o}},Me.decorators=[{type:o.Injectable}],Me.ctorParameters=function(){return[{type:I.Repository},{type:I.FrameContext,decorators:[{type:o.Optional}]}]},Me);function Me(e,t){this.frameContext=t,this.befRepository=e,this.registerDestroyEvent()}var je=(Ue.prototype.createSession=function(e){var t=this.sessionService.getUserSessionId();return t?this.befRepository.restService.invoke(e,"POST",null,{headers:new h.HttpHeaders({SessionId:t}),responseType:"text"},!1).pipe(g.switchMap(function(e){return C.of({status:!0,payload:e})})):C.of({status:!1,payload:"用户登录信息已过期，请重新登录"})},Ue.prototype.getData=function(e,t){var n=this,r={};t.condition&&(r=t.condition),"/"===e[e.length-1]&&(e=e.substr(0,e.length-1));var i=e+"/extension/query",o=e+"/service/createsession";if(r){var a=JSON.stringify(r);i=i+"?entityFilter="+a}return this.createSession(o).pipe(g.switchMap(function(e){if(e.status)return e.payload,n.befRepository.restService.invoke(i,"PUT",null,{},!1);throw new Error(e.payload)}),s.map(function(e){var t=e.returnValue,n={items:t.result};return t.pagination?Object.assign({},n,{total:t.pagination.totalCount,pageInfo:{pageSize:t.pagination.pageSize,pageIndex:t.pagination.pageIndex,enablePager:!0}}):n}))},Ue.decorators=[{type:o.Injectable}],Ue.ctorParameters=function(){return[{type:I.Repository},{type:d}]},Ue);function Ue(e,t){this.sessionService=t,this.befRepository=e}var Ae=(Ve.isExistUnsaveData=function(e){var t=!1;if(!e||!e.entityCollection)throw"Current Object is null or it's entityCollection is null.";var n=e.entityCollection.toArray();if(e.dataChangeHistory.isChanged())return!0;for(var r=0;r<n.length;r++)if(0<n[r].changes.length){t=!0;break}return t},Ve);function Ve(){}var He=(ke.prototype.toString=function(){return this.url},ke);function ke(e,t){void 0===t&&(t=null);var n=this;this.url=e,this.paths=t,this.paths&&Object.keys(t).forEach(function(e){-1!==n.url.indexOf("{"+e+"}")&&(n.url=n.url.replace("{"+e+"}",""+t[e]))})}var Fe=(Ne.prototype.getData=function(e,t,n){void 0===t&&(t={}),void 0===n&&(n="GET");var r=new h.HttpHeaders({"content-type":"application/json"});return"get"!==n.toLowerCase()?this.befRest.restService.invoke(e,n,null,{headers:r,body:t}):this.befRest.restService.invoke(e,n,t,{headers:r})},Ne.decorators=[{type:o.Injectable}],Ne.ctorParameters=function(){return[{type:I.Repository}]},Ne);function Ne(e){this.befRest=e}var _e=(Le.prototype.getData=function(e,t,n){void 0===t&&(t={}),void 0===n&&(n="GET");var r=new h.HttpHeaders({"content-type":"application/json"});return this.befRest.restService.invoke(e,n,t,{headers:r})},Le.decorators=[{type:o.Injectable}],Le.ctorParameters=function(){return[{type:I.Repository}]},Le);function Le(e){this.befRest=e}var Ke,Ge=(x(ze,Ke=Se),ze.prototype.batchAppend=function(e){throw new Error("Method not implemented.")},ze);function ze(e,t,n,r,i){var o=Ke.call(this,e)||this;o.name=t,o.entityType=n,o.serverUri=r,o.apiUri=i,o.apiUri=i;var a={};a[n.typeName]={pageSize:20},o.paginationInfo=a,o.entityTypeInfo=new I.DataTypeInfo(o.entityType),o.entityCollection=new I.EntityCollection(o.entityType),o.entityManager=new ne(o.entityCollection);var s=e.get(h.HttpClient),p=new Ee(r),u=new De(s,p),c=p.extendUri(i);return u.setBaseUri(c),o.dataService=new ye(e,o),o.serverUri=e.get(y),o}var Je,We=(x(Ye,Je=Se),Ye.prototype.batchAppend=function(e){throw new Error("Method not implemented.")},Ye);function Ye(e,t){var n=Je.call(this,e)||this;n.schema=t;var r=new I.EntityTypeFactory;return n.entityType=r.create(t),n.entityTypeInfo=new I.DataTypeInfo(n.entityType),n.entityCollection=new I.EntityCollection(n.entityType),n.entityManager=new ne(n.entityCollection),n}e.VERSION="ver.",e.ChangeDetailType=b,e.BE_SERVER_URI_TOKEN=y,e.BE_SESSION_HANDLING_STRATEGY_TOKEN=a,e.BefChangeBuilder=p,e.BefChangeHandler=c,e.BefSessionService=W,e.BefRestService=we,e.BefProxy=De,e.BefLookupRestService=Oe,e.BefLookupDefaultService=je,e.BefRepository=Se,e.FrameworkSessionService=d,e.NG_VARIABLE=X,e.NgVariable=Z,e.BefRepositoryUtil=Ae,e.BefDataPathUtil=ce,e.UriService=Ee,e.Uri=He,e.DefaultComboHttpService=Fe,e.DefaultDynamiControlGroupHttpService=_e,e.BefEntityManager=ne,e.DynamicBefRepository=Ge,e.PresetBefRepository=We,e.ɵa=$,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=farris-bef.umd.min.js.map