// tslint:disable: max-line-length
import { Injectable, Optional } from '@angular/core';
import { Repository, FrameContext, PARENT_CLASS, ChangeType, DataPropGroup } from '@farris/devkit';
import { tap, switchMap } from 'rxjs/operators';
import { EMPTY, Subject } from 'rxjs';
import { zip } from 'rxjs/observable/zip';
import { empty } from 'rxjs/observable/empty';
import { of } from 'rxjs/observable/of';
import { VerifyDetailService } from '@farris/ui-verify-detail';
import { FormNotifyService } from './form-notify.service';
import { LanguageService } from './languag.service';
/**
 * 表单验证服务
 * @scope FrameComponent
 */
class ValidationService {
    /**
     * 构造函数
     */
    constructor(repository, frameContext, notifyService, languageService) {
        this.repository = repository;
        this.frameContext = frameContext;
        this.notifyService = notifyService;
        this.languageService = languageService;
        this.validationResults = new Subject();
        this.validationAllResult = new Subject();
        if (!this.languageService) {
            this.languageService = new LanguageService();
        }
    }
    /**
     * 验证表单内的所有表单
     */
    validate() {
        this.repository.getList().subscribe((result) => {
            for (const entity of result) {
                entity.validate().subscribe((result) => {
                    if (!result.isValid) {
                        alert(result.message);
                        this.validationResults.next(result);
                    }
                });
            }
        });
        return this.validationResults;
    }
    /**
     * 校验当前行
     */
    validateCurrentRow() {
        const entityTypeInfo = this.repository.entityTypeInfo;
        // 组合表单只校验当前按钮所在的表单
        const primaryValue = this.frameContext.bindingData.list.currentId;
        if (!primaryValue) {
            return of(true);
        }
        // 首先校验实体不能为空规则
        const entity = this.repository.entityCollection.getEntityById(primaryValue);
        if (!entity) {
            return of(true);
        }
        const isEntityValid = this.validateEntityAllowEmptyRule(entity, entityTypeInfo);
        if (!isEntityValid) {
            return EMPTY;
        }
        const entities = [entity];
        const namespace = this.frameContext.namespace;
        let frameContexts = [];
        // 修复使用相同be创建的vo的组合表单校验时多个表单校验规则被合并的问题
        // TODO: 目前未考虑组合表单统一保存的场景，后续支持组合表单统一保存时再修改
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        const isModal = this.isInDialog();
        const hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        let rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        let toValidate = false;
        const formErrors = [];
        frameContexts.forEach((frameContext) => {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        rootViewModel.verifyInformations = [];
        let formValid = true;
        let entityValid = true;
        const formValidationRules = new Map();
        frameContexts.forEach((formContext) => {
            const bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                const currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach((rules, path) => {
                    if (formValidationRules.has(path)) {
                        rules.forEach(rule => formValidationRules.get(path).push(rule));
                    }
                    else {
                        formValidationRules.set(path, [...rules]);
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 验证所有实体
        const observableList = entities.map((entity) => {
            const index = this.frameContext.bindingData.list.getIndexById(entity.primaryValue);
            return entity.validate(undefined, undefined, formValidationRules, null, this.frameContext);
        });
        const result$ = zip(...observableList).pipe(tap((resultList) => {
            frameContexts.forEach((formContext) => {
                if (!formContext.form.enableValidate) {
                    return;
                }
                const handleErrors = (errors) => {
                    errors.forEach((validationError) => {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        const errMsgObj = {};
                        let id = '';
                        const findId = (target) => {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        let parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        const bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(key => {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        const paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                const isValidList = resultList.map((result) => result.isValid);
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(x => x).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        const bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        const form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach((result) => {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap((resultList) => {
            let isValidated = true;
            const errors = [];
            resultList.forEach((result) => {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push(...result.errors);
            });
            if (errors.length > 0) {
                this.collectValidationErrors(rootViewModel, errors, this.frameContext.namespace);
            }
            // rootViewModel.verifycationChanged.next(rootViewModel.verifyInformations);
            let verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace === namespace);
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && !formValid) {
                // 实体校验通过但表单校验不通过，此时实体和表单存在校验规则不一致的情况
                console.warn('实体和控件校验规则不一致，会导致命令执行中断！');
            }
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    }
    /**
     * 调用表单和实体上的验证规则, 通过后调用回调cb
     */
    validateAll() {
        // 组合表单只校验当前按钮所在的表单
        const entities = this.repository.entityCollection.getAllEntities();
        const namespace = this.frameContext.namespace;
        let frameContexts = [];
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        let toValidate = false;
        const formErrors = [];
        frameContexts.forEach((frameContext) => {
            if (frameContext.form && frameContext.form.enableValidate) {
                toValidate = true;
            }
        });
        if (!toValidate || entities.length < 1) {
            return of(true);
        }
        const isModal = this.isInDialog();
        const hasOwnVerifyDetailService = this.hasOwnVerifyDetailService();
        let rootViewModel = this.frameContext.root.viewModel;
        if (isModal && hasOwnVerifyDetailService) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        let formValid = true;
        let entityValid = true;
        const formValidationRules = new Map();
        frameContexts.forEach((formContext) => {
            const bindingObject = formContext.bindingData.getObject();
            // 通知所有bindingData,
            bindingObject && bindingObject.setShowValidationMsg(true);
            if (formContext.form && formContext.form.enableValidate) {
                // 获取当前表单上的所有验证规则
                const currentFormValidationRules = formContext.form.getValidationRules();
                currentFormValidationRules.forEach((rules, path) => {
                    if (formValidationRules.has(path)) {
                        rules.forEach(rule => formValidationRules.get(path).push(rule));
                    }
                    else {
                        formValidationRules.set(path, [...rules]);
                    }
                });
                formContext.form.setShowValidationMsg(true);
                // 逐个调用表单的验证，验证前端表单规则
                if (!formContext.form.isFormValid()) {
                    formErrors.push(formContext.form);
                    formValid = false;
                }
            }
        });
        // 触发所有实体的validate事件
        const isMultiEntityValiate = entities.length > 0;
        // 验证所有实体
        const observableList = entities.map((entity, index) => entity.validate(undefined, undefined, formValidationRules, isMultiEntityValiate ? index : null, this.frameContext));
        const result$ = zip(...observableList).pipe(tap((resultList) => {
            frameContexts.forEach((formContext) => {
                if (!formContext.form.enableValidate) {
                    return;
                }
                const handleErrors = (errors) => {
                    errors.forEach((validationError) => {
                        if (validationError.children && validationError.children.length) {
                            handleErrors(validationError.children);
                        }
                        const errMsgObj = {};
                        let id = '';
                        const findId = (target) => {
                            if (target && target.data && target.data.id) {
                                id = target.data.id;
                                return;
                            }
                            else if (target[PARENT_CLASS]) {
                                findId(target[PARENT_CLASS]);
                            }
                        };
                        findId(validationError.target);
                        // 实体验证出错，需要将错误展示到界面上
                        // 实体不一定是当前行
                        let parentPathData = {
                            path: [],
                            isUdt: false,
                            isGrid: false
                        };
                        if (validationError.target) {
                            parentPathData = validationError.target.getPaths();
                        }
                        const bindingPath = '/' + parentPathData.path.join('/');
                        if (validationError.constraints) {
                            Object.keys(validationError.constraints).forEach(key => {
                                errMsgObj[key] = {
                                    name: validationError.constraints[key]
                                };
                                // if (this.frameContext.viewModel.bindingPath === bindingPath) {
                                //   rootViewModel['verifyInformations'].push({
                                //     id: id,
                                //     title: key,
                                //     msg: validationError.constraints[key],
                                //     type: 'warn'
                                //   })
                                // }
                            });
                        }
                        const paths = parentPathData.path.concat(validationError.property);
                        //if (this.frameContext.viewModel.bindingPath === bindingPath) {
                        // 将错误信息更新到formControl上
                        formContext.bindingData.changes.next({
                            type: ChangeType.UpdateErrors,
                            id,
                            path: paths,
                            isUdt: parentPathData.isUdt,
                            isGrid: parentPathData.isGrid,
                            value: validationError.value,
                            errors: errMsgObj
                        });
                        //}
                    });
                };
                // 展开验证结果
                const isValidList = resultList.map((result) => result.isValid);
                // 保存前先调用实体上的验证规则，全部通过之后才保存
                // 实体验证通过
                if (isValidList.filter(x => x).length === observableList.length) {
                    // 将错误信息更新到formControl上
                    formContext.bindingData.changes.next({
                        type: ChangeType.UpdateErrors,
                        path: []
                    });
                    // 验证成功后隐藏输入时的验证
                    if (formValid) {
                        const bindingObject = formContext.bindingData.getObject();
                        bindingObject && bindingObject.setShowValidationMsg(false);
                        const form = formContext.form;
                        if (form) {
                            form.setShowValidationMsg(false);
                        }
                    }
                }
                else {
                    // 实体验证有错误
                    entityValid = false;
                    resultList.forEach((result) => {
                        if (result.isValid) {
                            // 清除验证通过的错误
                            formContext.bindingData.changes.next({
                                type: ChangeType.UpdateErrors,
                                path: []
                            });
                        }
                        else {
                            handleErrors(result.errors);
                        }
                    });
                }
            });
        }), switchMap((resultList) => {
            let isValidated = true;
            const errors = [];
            resultList.forEach((result) => {
                if (!result.isValid) {
                    isValidated = false;
                }
                errors.push(...result.errors);
            });
            if (errors.length > 0) {
                this.collectValidationErrors(rootViewModel, errors, this.frameContext.namespace);
            }
            let verifyInformations = rootViewModel.verifyInformations;
            if (isModal && hasOwnVerifyDetailService) {
                verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace === namespace);
            }
            // 因为校验累加的缘故，导致之前的校验信息一直存在，只能通过校验结果来确定是否还有错误信息
            if (isValidated && formValid) {
                verifyInformations = rootViewModel.verifyInformations = [];
            }
            rootViewModel.verifycationChanged.next(verifyInformations);
            if (isValidated && formValid) {
                return of(true);
            }
            else {
                return empty();
            }
        }));
        return result$;
    }
    /**
     * 校验实体是否满足不能为空的规则
     * @param entity 主实体
     */
    validateEntityAllowEmptyRule(entity, entityTypeInfo) {
        // 确认实体各个层级中是否存在不能为空的规则
        const paths = this.getNotAllowEmptyBindingPaths(entityTypeInfo);
        if (!paths || paths.length < 1) {
            return true;
        }
        // 找到所有不合法的bindingPaths
        const invalidPaths = paths.filter((path) => {
            const bindingPaths = path.split('/').filter(p => p);
            const bindingList = this.frameContext.bindingData.getValue(bindingPaths);
            if (!bindingList || bindingList.length < 1) {
                return true;
            }
            return false;
        });
        if (invalidPaths.length > 0) {
            const tableNames = [];
            invalidPaths.forEach((path) => {
                const viewModelName = this.getViewModelNameByBindingPaths(path.split('/'));
                tableNames.push(viewModelName);
            });
            if (this.notifyService) {
                this.notifyService.error(`${tableNames.join('，')} ${this.languageService.tableCanNotEmpty}`, { hideTitle: true });
            }
            return false;
        }
        return true;
    }
    /**
     *
     * @param bindingPaths path不能为空或/，不支持主表
     */
    getViewModelNameByBindingPaths(bindingPaths) {
        const namespace = this.frameContext.namespace;
        let frameContexts = null;
        if (namespace !== null) {
            // 存在命名空间，说明表单较新，可以依赖该特性
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContextsByNamespace(namespace);
        }
        else {
            // 表单较老，获取所有的上下文，在校验阶段过滤规则
            frameContexts = this.frameContext.appContext.frameContextManager.getFrameContexts();
        }
        const bindingPath = bindingPaths.filter(p => p).join('/');
        const frameContext = frameContexts.find((frameContext) => frameContext.viewModel && frameContext.viewModel.bindingPath.split('/').filter(p => p).join('/') === bindingPath);
        const viewModelName = frameContext && frameContext.form && frameContext.form.formGroupName || '';
        return viewModelName;
    }
    getNotAllowEmptyBindingPaths(entityTypeInfo) {
        if (!entityTypeInfo) {
            return undefined;
        }
        const paths = [];
        this.deepFirstTraversalEntityTypeInfo(entityTypeInfo, paths);
        return paths;
    }
    deepFirstTraversalEntityTypeInfo(entityTypeInfo, result = [], previousValue = []) {
        const list = entityTypeInfo.getPropInfosByGroup(DataPropGroup.List);
        if (list && list.length > 0) {
            list.forEach((propInfo) => {
                const typeInfo = propInfo.typeInfo;
                if (typeInfo && typeInfo.entityInfo && typeInfo.entityInfo.allowEmpty === false) {
                    previousValue.push(typeInfo.entityInfo.nodeCode);
                    this.deepFirstTraversalEntityTypeInfo(typeInfo, result, previousValue);
                }
            });
        }
        // 没有下级了，此时应该清空游标，将收集到的路径放到结果集中
        if (previousValue && previousValue.length > 0) {
            const paths = previousValue.join('/');
            result.push(paths);
        }
        previousValue.splice(0, previousValue.length);
    }
    collectValidationErrors(rootViewModel, errors, namespace, filter = true) {
        if (filter) {
            rootViewModel.verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace !== namespace);
        }
        errors.forEach((validationError) => {
            if (validationError.children && validationError.children.length) {
                this.collectValidationErrors(rootViewModel, validationError.children, namespace, false);
            }
            let id = '';
            const findId = (target) => {
                if (target && target.data && target.data.id) {
                    id = target.data.id;
                    return;
                }
                else if (target[PARENT_CLASS]) {
                    findId(target[PARENT_CLASS]);
                }
            };
            findId(validationError.target);
            if (validationError.constraints) {
                const validationResultTypes = Object.keys(validationError.constraints);
                if (validationResultTypes.length) {
                    const offset = rootViewModel.verifyInformations.filter(item => item.namespace === namespace).length;
                    let index = rootViewModel.verifyInformations.findIndex(item => item.namespace === namespace);
                    index = index === -1 ? 0 : index + offset;
                    rootViewModel.verifyInformations.splice(index, 0, {
                        id: id,
                        namespace,
                        targetField: validationError.field,
                        index: validationError.index,
                        title: validationError.propertyName,
                        msg: validationError.constraints[validationResultTypes[0]],
                        frameContext: validationError.frameContext,
                        fullPath: validationError.fullPath,
                        type: validationResultTypes[0] === 'required' ? 'empty' : 'error'
                    });
                }
            }
        });
    }
    /**
     * 重置校验信息（仅当前表单）
     */
    resetValidation() {
        const isDialog = this.isInDialog();
        let rootViewModel = this.frameContext.root.viewModel;
        if (isDialog) {
            rootViewModel = this.frameContext.getVirtualRootFrameContext().viewModel;
        }
        let verifyInformations = rootViewModel.verifyInformations;
        if (verifyInformations.length) {
            const namespace = this.frameContext.namespace;
            if (namespace !== null) {
                verifyInformations = rootViewModel.verifyInformations.filter(item => item.namespace !== namespace);
            }
            rootViewModel.verifyInformations = verifyInformations;
            //rootViewModel.verifyInformations.splice(0, rootViewModel.verifyInformations.length);
        }
        if (rootViewModel && rootViewModel.verifycationChanged) {
            rootViewModel.verifycationChanged.next(verifyInformations);
        }
        return of(null);
    }
    /**
     * 是否在弹窗内部
     */
    isInDialog() {
        return this.frameContext && this.frameContext.getVirtualRootFrameContext() && this.frameContext.getVirtualRootFrameContext().frameComponent && this.frameContext.getVirtualRootFrameContext().frameComponent['isDialogRootComponent'] || false;
    }
    /**
     * 拥有独自的校验提示服务
     */
    hasOwnVerifyDetailService() {
        return this.frameContext.injector.get(VerifyDetailService, null) !== this.frameContext.root.appContext.injector.get(VerifyDetailService, null);
        ;
    }
}
ValidationService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
ValidationService.ctorParameters = () => [
    { type: Repository },
    { type: FrameContext },
    { type: FormNotifyService, decorators: [{ type: Optional }] },
    { type: LanguageService, decorators: [{ type: Optional }] }
];
export { ValidationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3ZhbGlkYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxrQ0FBa0M7QUFDbEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckQsT0FBTyxFQUFFLFVBQVUsRUFBVSxZQUFZLEVBQUUsWUFBWSxFQUFFLFVBQVUsRUFBNEUsYUFBYSxFQUE2QixNQUFNLGdCQUFnQixDQUFDO0FBQ2hOLE9BQU8sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDaEQsT0FBTyxFQUFFLEtBQUssRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsRUFBRSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDeEMsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRXBEOzs7R0FHRztBQUVILE1BQ00saUJBQWlCO0lBSXJCOztPQUVHO0lBQ0gsWUFDVSxVQUEyQixFQUMzQixZQUEwQixFQUNkLGFBQWdDLEVBQ2hDLGVBQWdDO1FBSDVDLGVBQVUsR0FBVixVQUFVLENBQWlCO1FBQzNCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ2Qsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQ2hDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQVQ5QyxzQkFBaUIsR0FBRyxJQUFJLE9BQU8sRUFB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U0FBUyxDQUFDLENBQUM7YUFDcEc7WUFDRCxhQUFhLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7WUFDdEQsc0ZBQXNGO1NBQ3ZGO1FBQ0QsSUFBSSxhQUFhLElBQUksYUFBYSxDQUFDLG1CQUFtQixFQUFFO1lBQ3RELGFBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUM1RDtRQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFDRDs7T0FFRztJQUNLLFVBQVU7UUFDaEIsT0FBTyxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLDBCQUEwQixFQUFFLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsMEJBQTBCLEVBQUUsQ0FBQyxjQUFjLENBQUMsdUJBQXVCLENBQUMsSUFBSSxLQUFLLENBQUM7SUFDalAsQ0FBQztJQUNEOztPQUVHO0lBQ0sseUJBQXlCO1FBQy9CLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFzQixtQkFBbUIsRUFBRSxJQUFJLENBQUMsS0FBSyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBc0IsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFBQSxDQUFDO0lBQzVMLENBQUM7OztZQW5sQkYsVUFBVTs7OztZQWZGLFVBQVU7WUFBVSxZQUFZO1lBT2hDLGlCQUFpQix1QkFtQnJCLFFBQVE7WUFsQkosZUFBZSx1QkFtQm5CLFFBQVE7O0FBMGtCYixPQUFPLEVBQUUsaUJBQWlCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlOiBtYXgtbGluZS1sZW5ndGhcbmltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5LCBFbnRpdHksIEZyYW1lQ29udGV4dCwgUEFSRU5UX0NMQVNTLCBDaGFuZ2VUeXBlLCBWYWxpZGF0aW9uUmVzdWx0LCBWYWxpZGF0aW9uRXJyb3IsIFZhbGlkYXRlUnVsZSwgVmlld01vZGVsLCBEYXRhVHlwZUluZm8sIERhdGFQcm9wR3JvdXAsIERhdGFQcm9wSW5mbywgQmluZGluZ0xpc3QgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB6aXAgfSBmcm9tICdyeGpzL29ic2VydmFibGUvemlwJztcbmltcG9ydCB7IGVtcHR5IH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL2VtcHR5JztcbmltcG9ydCB7IG9mIH0gZnJvbSAncnhqcy9vYnNlcnZhYmxlL29mJztcbmltcG9ydCB7IFZlcmlmeURldGFpbFNlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLXZlcmlmeS1kZXRhaWwnO1xuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xuXG4vKipcbiAqIOihqOWNlemqjOivgeacjeWKoVxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XG4gKi9cblxuQEluamVjdGFibGUoKVxuY2xhc3MgVmFsaWRhdGlvblNlcnZpY2Uge1xuXG4gIHByaXZhdGUgdmFsaWRhdGlvblJlc3VsdHMgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG4gIHByaXZhdGUgdmFsaWRhdGlvbkFsbFJlc3VsdCA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgLyoqXG4gICAqIOaehOmAoOWHveaVsFxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PGFueT4sXG4gICAgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCxcbiAgICBAT3B0aW9uYWwoKSBwcml2YXRlIG5vdGlmeVNlcnZpY2U6IEZvcm1Ob3RpZnlTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2VcbiAgKSB7XG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBuZXcgTGFuZ3VhZ2VTZXJ2aWNlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIOmqjOivgeihqOWNleWGheeahOaJgOacieihqOWNlVxuICAgKi9cbiAgcHVibGljIHZhbGlkYXRlKCkge1xuICAgIHRoaXMucmVwb3NpdG9yeS5nZXRMaXN0KCkuc3Vic2NyaWJlKFxuICAgICAgKHJlc3VsdDogRW50aXR5W10pID0+IHtcbiAgICAgICAgZm9yIChjb25zdCBlbnRpdHkgb2YgcmVzdWx0KSB7XG4gICAgICAgICAgZW50aXR5LnZhbGlkYXRlKCkuc3Vic2NyaWJlKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcbiAgICAgICAgICAgIGlmICghcmVzdWx0LmlzVmFsaWQpIHtcbiAgICAgICAgICAgICAgYWxlcnQocmVzdWx0Lm1lc3NhZ2UpO1xuICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRpb25SZXN1bHRzLm5leHQocmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gICAgcmV0dXJuIHRoaXMudmFsaWRhdGlvblJlc3VsdHM7XG4gIH1cbiAgLyoqXG4gICAqIOagoemqjOW9k+WJjeihjFxuICAgKi9cbiAgcHVibGljIHZhbGlkYXRlQ3VycmVudFJvdygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGVudGl0eVR5cGVJbmZvID0gdGhpcy5yZXBvc2l0b3J5LmVudGl0eVR5cGVJbmZvO1xuICAgIC8vIOe7hOWQiOihqOWNleWPquagoemqjOW9k+WJjeaMiemSruaJgOWcqOeahOihqOWNlVxuICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICAgIGlmICghcHJpbWFyeVZhbHVlKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuICAgIC8vIOmmluWFiOagoemqjOWunuS9k+S4jeiDveS4uuepuuinhOWImVxuICAgIGNvbnN0IGVudGl0eSA9IHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmdldEVudGl0eUJ5SWQocHJpbWFyeVZhbHVlKTtcbiAgICBpZiAoIWVudGl0eSkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cbiAgICBjb25zdCBpc0VudGl0eVZhbGlkID0gdGhpcy52YWxpZGF0ZUVudGl0eUFsbG93RW1wdHlSdWxlKGVudGl0eSwgZW50aXR5VHlwZUluZm8pO1xuICAgIGlmICghaXNFbnRpdHlWYWxpZCkge1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBjb25zdCBlbnRpdGllczogRW50aXR5W10gPSBbZW50aXR5XTtcbiAgICBjb25zdCBuYW1lc3BhY2UgPSB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2U7XG4gICAgbGV0IGZyYW1lQ29udGV4dHMgPSBbXTtcbiAgICAvLyDkv67lpI3kvb/nlKjnm7jlkIxiZeWIm+W7uueahHZv55qE57uE5ZCI6KGo5Y2V5qCh6aqM5pe25aSa5Liq6KGo5Y2V5qCh6aqM6KeE5YiZ6KKr5ZCI5bm255qE6Zeu6aKYXG4gICAgLy8gVE9ETzog55uu5YmN5pyq6ICD6JmR57uE5ZCI6KGo5Y2V57uf5LiA5L+d5a2Y55qE5Zy65pmv77yM5ZCO57ut5pSv5oyB57uE5ZCI6KGo5Y2V57uf5LiA5L+d5a2Y5pe25YaN5L+u5pS5XG4gICAgaWYgKG5hbWVzcGFjZSAhPT0gbnVsbCkge1xuICAgICAgLy8g5a2Y5Zyo5ZG95ZCN56m66Ze077yM6K+05piO6KGo5Y2V6L6D5paw77yM5Y+v5Lul5L6d6LWW6K+l54m55oCnXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDooajljZXovoPogIHvvIzojrflj5bmiYDmnInnmoTkuIrkuIvmlofvvIzlnKjmoKHpqozpmLbmrrXov4fmu6Top4TliJlcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xuICAgIH1cblxuICAgIGNvbnN0IGlzTW9kYWwgPSB0aGlzLmlzSW5EaWFsb2coKTtcbiAgICBjb25zdCBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlID0gdGhpcy5oYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKCk7XG4gICAgbGV0IHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5yb290LnZpZXdNb2RlbDtcbiAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XG4gICAgICByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS52aWV3TW9kZWw7XG4gICAgfVxuXG4gICAgbGV0IHRvVmFsaWRhdGUgPSBmYWxzZTtcbiAgICBjb25zdCBmb3JtRXJyb3JzID0gW107XG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgaWYgKGZyYW1lQ29udGV4dC5mb3JtICYmIGZyYW1lQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XG4gICAgICAgIHRvVmFsaWRhdGUgPSB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmICghdG9WYWxpZGF0ZSB8fCBlbnRpdGllcy5sZW5ndGggPCAxKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zID0gW107XG4gICAgbGV0IGZvcm1WYWxpZCA9IHRydWU7XG4gICAgbGV0IGVudGl0eVZhbGlkID0gdHJ1ZTtcbiAgICBjb25zdCBmb3JtVmFsaWRhdGlvblJ1bGVzID0gbmV3IE1hcDxzdHJpbmcsIFZhbGlkYXRlUnVsZVtdPigpO1xuICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaCgoZm9ybUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgY29uc3QgYmluZGluZ09iamVjdCA9IGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmdldE9iamVjdCgpO1xuICAgICAgLy8g6YCa55+l5omA5pyJYmluZGluZ0RhdGEsXG4gICAgICBiaW5kaW5nT2JqZWN0ICYmIGJpbmRpbmdPYmplY3Quc2V0U2hvd1ZhbGlkYXRpb25Nc2codHJ1ZSk7XG4gICAgICBpZiAoZm9ybUNvbnRleHQuZm9ybSAmJiBmb3JtQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XG4gICAgICAgIC8vIOiOt+WPluW9k+WJjeihqOWNleS4iueahOaJgOaciemqjOivgeinhOWImVxuICAgICAgICBjb25zdCBjdXJyZW50Rm9ybVZhbGlkYXRpb25SdWxlcyA9IGZvcm1Db250ZXh0LmZvcm0uZ2V0VmFsaWRhdGlvblJ1bGVzKCk7XG4gICAgICAgIGN1cnJlbnRGb3JtVmFsaWRhdGlvblJ1bGVzLmZvckVhY2goKHJ1bGVzLCBwYXRoKSA9PiB7XG4gICAgICAgICAgaWYgKGZvcm1WYWxpZGF0aW9uUnVsZXMuaGFzKHBhdGgpKSB7XG4gICAgICAgICAgICBydWxlcy5mb3JFYWNoKHJ1bGUgPT4gZm9ybVZhbGlkYXRpb25SdWxlcy5nZXQocGF0aCkucHVzaChydWxlKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZvcm1WYWxpZGF0aW9uUnVsZXMuc2V0KHBhdGgsIFsuLi5ydWxlc10pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGZvcm1Db250ZXh0LmZvcm0uc2V0U2hvd1ZhbGlkYXRpb25Nc2codHJ1ZSk7XG4gICAgICAgIC8vIOmAkOS4quiwg+eUqOihqOWNleeahOmqjOivge+8jOmqjOivgeWJjeerr+ihqOWNleinhOWImVxuICAgICAgICBpZiAoIWZvcm1Db250ZXh0LmZvcm0uaXNGb3JtVmFsaWQoKSkge1xuICAgICAgICAgIGZvcm1FcnJvcnMucHVzaChmb3JtQ29udGV4dC5mb3JtKTtcbiAgICAgICAgICBmb3JtVmFsaWQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8g6aqM6K+B5omA5pyJ5a6e5L2TXG4gICAgY29uc3Qgb2JzZXJ2YWJsZUxpc3QgPSBlbnRpdGllcy5tYXAoKGVudGl0eTogRW50aXR5KSA9PiB7XG4gICAgICBjb25zdCBpbmRleCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuZ2V0SW5kZXhCeUlkKGVudGl0eS5wcmltYXJ5VmFsdWUpO1xuICAgICAgcmV0dXJuIGVudGl0eS52YWxpZGF0ZSh1bmRlZmluZWQsIHVuZGVmaW5lZCwgZm9ybVZhbGlkYXRpb25SdWxlcywgbnVsbCwgdGhpcy5mcmFtZUNvbnRleHQpO1xuICAgIH0pO1xuICAgIGNvbnN0IHJlc3VsdCQgPSB6aXAoLi4ub2JzZXJ2YWJsZUxpc3QpLnBpcGUoXG4gICAgICB0YXAoKHJlc3VsdExpc3QpID0+IHtcbiAgICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGhhbmRsZUVycm9ycyA9IChlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdKSA9PiB7XG4gICAgICAgICAgICBlcnJvcnMuZm9yRWFjaCgodmFsaWRhdGlvbkVycm9yOiBWYWxpZGF0aW9uRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiAmJiB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgaGFuZGxlRXJyb3JzKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY29uc3QgZXJyTXNnT2JqID0ge307XG4gICAgICAgICAgICAgIGxldCBpZCA9ICcnO1xuICAgICAgICAgICAgICBjb25zdCBmaW5kSWQgPSAodGFyZ2V0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5kYXRhICYmIHRhcmdldC5kYXRhLmlkKSB7XG4gICAgICAgICAgICAgICAgICBpZCA9IHRhcmdldC5kYXRhLmlkO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0W1BBUkVOVF9DTEFTU10pIHtcbiAgICAgICAgICAgICAgICAgIGZpbmRJZCh0YXJnZXRbUEFSRU5UX0NMQVNTXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBmaW5kSWQodmFsaWRhdGlvbkVycm9yLnRhcmdldCk7XG5cbiAgICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5Ye66ZSZ77yM6ZyA6KaB5bCG6ZSZ6K+v5bGV56S65Yiw55WM6Z2i5LiKXG4gICAgICAgICAgICAgIC8vIOWunuS9k+S4jeS4gOWumuaYr+W9k+WJjeihjFxuICAgICAgICAgICAgICBsZXQgcGFyZW50UGF0aERhdGEgPSB7XG4gICAgICAgICAgICAgICAgcGF0aDogW10sXG4gICAgICAgICAgICAgICAgaXNVZHQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGlzR3JpZDogZmFsc2VcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci50YXJnZXQpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnRQYXRoRGF0YSA9IHZhbGlkYXRpb25FcnJvci50YXJnZXQuZ2V0UGF0aHMoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aCA9ICcvJyArIHBhcmVudFBhdGhEYXRhLnBhdGguam9pbignLycpO1xuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICAgICAgICBlcnJNc2dPYmpba2V5XSA9IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW2tleV1cbiAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCkge1xuICAgICAgICAgICAgICAgICAgLy8gICByb290Vmlld01vZGVsWyd2ZXJpZnlJbmZvcm1hdGlvbnMnXS5wdXNoKHtcbiAgICAgICAgICAgICAgICAgIC8vICAgICBpZDogaWQsXG4gICAgICAgICAgICAgICAgICAvLyAgICAgdGl0bGU6IGtleSxcbiAgICAgICAgICAgICAgICAgIC8vICAgICBtc2c6IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50c1trZXldLFxuICAgICAgICAgICAgICAgICAgLy8gICAgIHR5cGU6ICd3YXJuJ1xuICAgICAgICAgICAgICAgICAgLy8gICB9KVxuICAgICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gcGFyZW50UGF0aERhdGEucGF0aC5jb25jYXQodmFsaWRhdGlvbkVycm9yLnByb3BlcnR5KTtcblxuICAgICAgICAgICAgICAvL2lmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XG4gICAgICAgICAgICAgIC8vIOWwhumUmeivr+S/oeaBr+abtOaWsOWIsGZvcm1Db250cm9s5LiKXG4gICAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XG4gICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXG4gICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgcGF0aDogcGF0aHMsXG4gICAgICAgICAgICAgICAgaXNVZHQ6IHBhcmVudFBhdGhEYXRhLmlzVWR0LFxuICAgICAgICAgICAgICAgIGlzR3JpZDogcGFyZW50UGF0aERhdGEuaXNHcmlkLFxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWxpZGF0aW9uRXJyb3IudmFsdWUsXG4gICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJNc2dPYmpcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIC8vfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICAvLyDlsZXlvIDpqozor4Hnu5PmnpxcbiAgICAgICAgICBjb25zdCBpc1ZhbGlkTGlzdCA9IHJlc3VsdExpc3QubWFwKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHJlc3VsdC5pc1ZhbGlkKTtcbiAgICAgICAgICAvLyDkv53lrZjliY3lhYjosIPnlKjlrp7kvZPkuIrnmoTpqozor4Hop4TliJnvvIzlhajpg6jpgJrov4fkuYvlkI7miY3kv53lrZhcbiAgICAgICAgICAvLyDlrp7kvZPpqozor4HpgJrov4dcbiAgICAgICAgICBpZiAoaXNWYWxpZExpc3QuZmlsdGVyKHggPT4geCkubGVuZ3RoID09PSBvYnNlcnZhYmxlTGlzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIC8vIOWwhumUmeivr+S/oeaBr+abtOaWsOWIsGZvcm1Db250cm9s5LiKXG4gICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xuICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcbiAgICAgICAgICAgICAgcGF0aDogW11cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8g6aqM6K+B5oiQ5Yqf5ZCO6ZqQ6JeP6L6T5YWl5pe255qE6aqM6K+BXG4gICAgICAgICAgICBpZiAoZm9ybVZhbGlkKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcbiAgICAgICAgICAgICAgYmluZGluZ09iamVjdCAmJiBiaW5kaW5nT2JqZWN0LnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcbiAgICAgICAgICAgICAgY29uc3QgZm9ybSA9IGZvcm1Db250ZXh0LmZvcm07XG4gICAgICAgICAgICAgIGlmIChmb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9ybS5zZXRTaG93VmFsaWRhdGlvbk1zZyhmYWxzZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5pyJ6ZSZ6K+vXG4gICAgICAgICAgICBlbnRpdHlWYWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC5pc1ZhbGlkKSB7XG4gICAgICAgICAgICAgICAgLy8g5riF6Zmk6aqM6K+B6YCa6L+H55qE6ZSZ6K+vXG4gICAgICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcbiAgICAgICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxuICAgICAgICAgICAgICAgICAgcGF0aDogW11cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnMocmVzdWx0LmVycm9ycyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIHN3aXRjaE1hcCgocmVzdWx0TGlzdCkgPT4ge1xuICAgICAgICBsZXQgaXNWYWxpZGF0ZWQgPSB0cnVlO1xuICAgICAgICBjb25zdCBlcnJvcnMgPSBbXTtcbiAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcbiAgICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XG4gICAgICAgICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlcnJvcnMucHVzaCguLi5yZXN1bHQuZXJyb3JzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRoaXMuY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbCwgZXJyb3JzLCB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2UpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHJvb3RWaWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zKTtcbiAgICAgICAgbGV0IHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zO1xuICAgICAgICBpZiAoaXNNb2RhbCAmJiBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKSB7XG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSk7XG4gICAgICAgIH1cbiAgICAgICAgcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkLm5leHQodmVyaWZ5SW5mb3JtYXRpb25zKTtcbiAgICAgICAgaWYgKGlzVmFsaWRhdGVkICYmICFmb3JtVmFsaWQpIHtcbiAgICAgICAgICAvLyDlrp7kvZPmoKHpqozpgJrov4fkvYbooajljZXmoKHpqozkuI3pgJrov4fvvIzmraTml7blrp7kvZPlkozooajljZXlrZjlnKjmoKHpqozop4TliJnkuI3kuIDoh7TnmoTmg4XlhrVcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ+WunuS9k+WSjOaOp+S7tuagoemqjOinhOWImeS4jeS4gOiHtO+8jOS8muWvvOiHtOWRveS7pOaJp+ihjOS4reaWre+8gScpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc1ZhbGlkYXRlZCAmJiBmb3JtVmFsaWQpIHtcbiAgICAgICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGVtcHR5KCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gcmVzdWx0JDtcbiAgfVxuICAvKipcbiAgICog6LCD55So6KGo5Y2V5ZKM5a6e5L2T5LiK55qE6aqM6K+B6KeE5YiZLCDpgJrov4flkI7osIPnlKjlm57osINjYlxuICAgKi9cbiAgdmFsaWRhdGVBbGwoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAvLyDnu4TlkIjooajljZXlj6rmoKHpqozlvZPliY3mjInpkq7miYDlnKjnmoTooajljZVcbiAgICBjb25zdCBlbnRpdGllczogRW50aXR5W10gPSB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRBbGxFbnRpdGllcygpO1xuICAgIGNvbnN0IG5hbWVzcGFjZSA9IHRoaXMuZnJhbWVDb250ZXh0Lm5hbWVzcGFjZTtcbiAgICBsZXQgZnJhbWVDb250ZXh0cyA9IFtdO1xuICAgIGlmIChuYW1lc3BhY2UgIT09IG51bGwpIHtcbiAgICAgIC8vIOWtmOWcqOWRveWQjeepuumXtO+8jOivtOaYjuihqOWNlei+g+aWsO+8jOWPr+S7peS+nei1luivpeeJueaAp1xuICAgICAgZnJhbWVDb250ZXh0cyA9IHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzQnlOYW1lc3BhY2UobmFtZXNwYWNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8g6KGo5Y2V6L6D6ICB77yM6I635Y+W5omA5pyJ55qE5LiK5LiL5paH77yM5Zyo5qCh6aqM6Zi25q616L+H5ruk6KeE5YiZXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKTtcbiAgICB9XG5cbiAgICBsZXQgdG9WYWxpZGF0ZSA9IGZhbHNlO1xuICAgIGNvbnN0IGZvcm1FcnJvcnMgPSBbXTtcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICBpZiAoZnJhbWVDb250ZXh0LmZvcm0gJiYgZnJhbWVDb250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcbiAgICAgICAgdG9WYWxpZGF0ZSA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaWYgKCF0b1ZhbGlkYXRlIHx8IGVudGl0aWVzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG4gICAgY29uc3QgaXNNb2RhbCA9IHRoaXMuaXNJbkRpYWxvZygpO1xuICAgIGNvbnN0IGhhc093blZlcmlmeURldGFpbFNlcnZpY2UgPSB0aGlzLmhhc093blZlcmlmeURldGFpbFNlcnZpY2UoKTtcbiAgICBsZXQgcm9vdFZpZXdNb2RlbCA9IHRoaXMuZnJhbWVDb250ZXh0LnJvb3Qudmlld01vZGVsO1xuICAgIGlmIChpc01vZGFsICYmIGhhc093blZlcmlmeURldGFpbFNlcnZpY2UpIHtcbiAgICAgIHJvb3RWaWV3TW9kZWwgPSB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLnZpZXdNb2RlbDtcbiAgICB9XG5cbiAgICBsZXQgZm9ybVZhbGlkID0gdHJ1ZTtcbiAgICBsZXQgZW50aXR5VmFsaWQgPSB0cnVlO1xuICAgIGNvbnN0IGZvcm1WYWxpZGF0aW9uUnVsZXMgPSBuZXcgTWFwPHN0cmluZywgVmFsaWRhdGVSdWxlW10+KCk7XG4gICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICBjb25zdCBiaW5kaW5nT2JqZWN0ID0gZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0T2JqZWN0KCk7XG4gICAgICAvLyDpgJrnn6XmiYDmnIliaW5kaW5nRGF0YSxcbiAgICAgIGJpbmRpbmdPYmplY3QgJiYgYmluZGluZ09iamVjdC5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcbiAgICAgIGlmIChmb3JtQ29udGV4dC5mb3JtICYmIGZvcm1Db250ZXh0LmZvcm0uZW5hYmxlVmFsaWRhdGUpIHtcbiAgICAgICAgLy8g6I635Y+W5b2T5YmN6KGo5Y2V5LiK55qE5omA5pyJ6aqM6K+B6KeE5YiZXG4gICAgICAgIGNvbnN0IGN1cnJlbnRGb3JtVmFsaWRhdGlvblJ1bGVzID0gZm9ybUNvbnRleHQuZm9ybS5nZXRWYWxpZGF0aW9uUnVsZXMoKTtcbiAgICAgICAgY3VycmVudEZvcm1WYWxpZGF0aW9uUnVsZXMuZm9yRWFjaCgocnVsZXMsIHBhdGgpID0+IHtcbiAgICAgICAgICBpZiAoZm9ybVZhbGlkYXRpb25SdWxlcy5oYXMocGF0aCkpIHtcbiAgICAgICAgICAgIHJ1bGVzLmZvckVhY2gocnVsZSA9PiBmb3JtVmFsaWRhdGlvblJ1bGVzLmdldChwYXRoKS5wdXNoKHJ1bGUpKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZm9ybVZhbGlkYXRpb25SdWxlcy5zZXQocGF0aCwgWy4uLnJ1bGVzXSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZm9ybUNvbnRleHQuZm9ybS5zZXRTaG93VmFsaWRhdGlvbk1zZyh0cnVlKTtcbiAgICAgICAgLy8g6YCQ5Liq6LCD55So6KGo5Y2V55qE6aqM6K+B77yM6aqM6K+B5YmN56uv6KGo5Y2V6KeE5YiZXG4gICAgICAgIGlmICghZm9ybUNvbnRleHQuZm9ybS5pc0Zvcm1WYWxpZCgpKSB7XG4gICAgICAgICAgZm9ybUVycm9ycy5wdXNoKGZvcm1Db250ZXh0LmZvcm0pO1xuICAgICAgICAgIGZvcm1WYWxpZCA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8g6Kem5Y+R5omA5pyJ5a6e5L2T55qEdmFsaWRhdGXkuovku7ZcbiAgICBjb25zdCBpc011bHRpRW50aXR5VmFsaWF0ZSA9IGVudGl0aWVzLmxlbmd0aCA+IDA7XG5cbiAgICAvLyDpqozor4HmiYDmnInlrp7kvZNcbiAgICBjb25zdCBvYnNlcnZhYmxlTGlzdCA9IGVudGl0aWVzLm1hcCgoZW50aXR5OiBFbnRpdHksIGluZGV4OiBudW1iZXIpID0+XG4gICAgICBlbnRpdHkudmFsaWRhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQsIGZvcm1WYWxpZGF0aW9uUnVsZXMsIGlzTXVsdGlFbnRpdHlWYWxpYXRlID8gaW5kZXggOiBudWxsLCB0aGlzLmZyYW1lQ29udGV4dCkpO1xuICAgIGNvbnN0IHJlc3VsdCQgPSB6aXAoLi4ub2JzZXJ2YWJsZUxpc3QpLnBpcGUoXG4gICAgICB0YXAoKHJlc3VsdExpc3QpID0+IHtcbiAgICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKChmb3JtQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICAgICAgaWYgKCFmb3JtQ29udGV4dC5mb3JtLmVuYWJsZVZhbGlkYXRlKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGhhbmRsZUVycm9ycyA9IChlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdKSA9PiB7XG4gICAgICAgICAgICBlcnJvcnMuZm9yRWFjaCgodmFsaWRhdGlvbkVycm9yOiBWYWxpZGF0aW9uRXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiAmJiB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgaGFuZGxlRXJyb3JzKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgY29uc3QgZXJyTXNnT2JqID0ge307XG4gICAgICAgICAgICAgIGxldCBpZCA9ICcnO1xuICAgICAgICAgICAgICBjb25zdCBmaW5kSWQgPSAodGFyZ2V0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5kYXRhICYmIHRhcmdldC5kYXRhLmlkKSB7XG4gICAgICAgICAgICAgICAgICBpZCA9IHRhcmdldC5kYXRhLmlkO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0W1BBUkVOVF9DTEFTU10pIHtcbiAgICAgICAgICAgICAgICAgIGZpbmRJZCh0YXJnZXRbUEFSRU5UX0NMQVNTXSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICBmaW5kSWQodmFsaWRhdGlvbkVycm9yLnRhcmdldCk7XG5cbiAgICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5Ye66ZSZ77yM6ZyA6KaB5bCG6ZSZ6K+v5bGV56S65Yiw55WM6Z2i5LiKXG4gICAgICAgICAgICAgIC8vIOWunuS9k+S4jeS4gOWumuaYr+W9k+WJjeihjFxuICAgICAgICAgICAgICBsZXQgcGFyZW50UGF0aERhdGEgPSB7XG4gICAgICAgICAgICAgICAgcGF0aDogW10sXG4gICAgICAgICAgICAgICAgaXNVZHQ6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGlzR3JpZDogZmFsc2VcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci50YXJnZXQpIHtcbiAgICAgICAgICAgICAgICBwYXJlbnRQYXRoRGF0YSA9IHZhbGlkYXRpb25FcnJvci50YXJnZXQuZ2V0UGF0aHMoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aCA9ICcvJyArIHBhcmVudFBhdGhEYXRhLnBhdGguam9pbignLycpO1xuICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXModmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICAgICAgICBlcnJNc2dPYmpba2V5XSA9IHtcbiAgICAgICAgICAgICAgICAgICAgbmFtZTogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW2tleV1cbiAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAvLyBpZiAodGhpcy5mcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCkge1xuICAgICAgICAgICAgICAgICAgLy8gICByb290Vmlld01vZGVsWyd2ZXJpZnlJbmZvcm1hdGlvbnMnXS5wdXNoKHtcbiAgICAgICAgICAgICAgICAgIC8vICAgICBpZDogaWQsXG4gICAgICAgICAgICAgICAgICAvLyAgICAgdGl0bGU6IGtleSxcbiAgICAgICAgICAgICAgICAgIC8vICAgICBtc2c6IHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50c1trZXldLFxuICAgICAgICAgICAgICAgICAgLy8gICAgIHR5cGU6ICd3YXJuJ1xuICAgICAgICAgICAgICAgICAgLy8gICB9KVxuICAgICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gcGFyZW50UGF0aERhdGEucGF0aC5jb25jYXQodmFsaWRhdGlvbkVycm9yLnByb3BlcnR5KTtcblxuICAgICAgICAgICAgICAvL2lmICh0aGlzLmZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggPT09IGJpbmRpbmdQYXRoKSB7XG4gICAgICAgICAgICAgIC8vIOWwhumUmeivr+S/oeaBr+abtOaWsOWIsGZvcm1Db250cm9s5LiKXG4gICAgICAgICAgICAgIGZvcm1Db250ZXh0LmJpbmRpbmdEYXRhLmNoYW5nZXMubmV4dCh7XG4gICAgICAgICAgICAgICAgdHlwZTogQ2hhbmdlVHlwZS5VcGRhdGVFcnJvcnMsXG4gICAgICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICAgICAgcGF0aDogcGF0aHMsXG4gICAgICAgICAgICAgICAgaXNVZHQ6IHBhcmVudFBhdGhEYXRhLmlzVWR0LFxuICAgICAgICAgICAgICAgIGlzR3JpZDogcGFyZW50UGF0aERhdGEuaXNHcmlkLFxuICAgICAgICAgICAgICAgIHZhbHVlOiB2YWxpZGF0aW9uRXJyb3IudmFsdWUsXG4gICAgICAgICAgICAgICAgZXJyb3JzOiBlcnJNc2dPYmpcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIC8vfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICAvLyDlsZXlvIDpqozor4Hnu5PmnpxcbiAgICAgICAgICBjb25zdCBpc1ZhbGlkTGlzdCA9IHJlc3VsdExpc3QubWFwKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHJlc3VsdC5pc1ZhbGlkKTtcbiAgICAgICAgICAvLyDkv53lrZjliY3lhYjosIPnlKjlrp7kvZPkuIrnmoTpqozor4Hop4TliJnvvIzlhajpg6jpgJrov4fkuYvlkI7miY3kv53lrZhcbiAgICAgICAgICAvLyDlrp7kvZPpqozor4HpgJrov4dcbiAgICAgICAgICBpZiAoaXNWYWxpZExpc3QuZmlsdGVyKHggPT4geCkubGVuZ3RoID09PSBvYnNlcnZhYmxlTGlzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIC8vIOWwhumUmeivr+S/oeaBr+abtOaWsOWIsGZvcm1Db250cm9s5LiKXG4gICAgICAgICAgICBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5jaGFuZ2VzLm5leHQoe1xuICAgICAgICAgICAgICB0eXBlOiBDaGFuZ2VUeXBlLlVwZGF0ZUVycm9ycyxcbiAgICAgICAgICAgICAgcGF0aDogW11cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8g6aqM6K+B5oiQ5Yqf5ZCO6ZqQ6JeP6L6T5YWl5pe255qE6aqM6K+BXG4gICAgICAgICAgICBpZiAoZm9ybVZhbGlkKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdPYmplY3QgPSBmb3JtQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRPYmplY3QoKTtcbiAgICAgICAgICAgICAgYmluZGluZ09iamVjdCAmJiBiaW5kaW5nT2JqZWN0LnNldFNob3dWYWxpZGF0aW9uTXNnKGZhbHNlKTtcbiAgICAgICAgICAgICAgY29uc3QgZm9ybSA9IGZvcm1Db250ZXh0LmZvcm07XG4gICAgICAgICAgICAgIGlmIChmb3JtKSB7XG4gICAgICAgICAgICAgICAgZm9ybS5zZXRTaG93VmFsaWRhdGlvbk1zZyhmYWxzZSk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8g5a6e5L2T6aqM6K+B5pyJ6ZSZ6K+vXG4gICAgICAgICAgICBlbnRpdHlWYWxpZCA9IGZhbHNlO1xuICAgICAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC5pc1ZhbGlkKSB7XG4gICAgICAgICAgICAgICAgLy8g5riF6Zmk6aqM6K+B6YCa6L+H55qE6ZSZ6K+vXG4gICAgICAgICAgICAgICAgZm9ybUNvbnRleHQuYmluZGluZ0RhdGEuY2hhbmdlcy5uZXh0KHtcbiAgICAgICAgICAgICAgICAgIHR5cGU6IENoYW5nZVR5cGUuVXBkYXRlRXJyb3JzLFxuICAgICAgICAgICAgICAgICAgcGF0aDogW11cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBoYW5kbGVFcnJvcnMocmVzdWx0LmVycm9ycyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KSxcbiAgICAgIHN3aXRjaE1hcCgocmVzdWx0TGlzdCkgPT4ge1xuICAgICAgICBsZXQgaXNWYWxpZGF0ZWQgPSB0cnVlO1xuICAgICAgICBjb25zdCBlcnJvcnMgPSBbXTtcbiAgICAgICAgcmVzdWx0TGlzdC5mb3JFYWNoKChyZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQpID0+IHtcbiAgICAgICAgICBpZiAoIXJlc3VsdC5pc1ZhbGlkKSB7XG4gICAgICAgICAgICBpc1ZhbGlkYXRlZCA9IGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgICBlcnJvcnMucHVzaCguLi5yZXN1bHQuZXJyb3JzKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRoaXMuY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbCwgZXJyb3JzLCB0aGlzLmZyYW1lQ29udGV4dC5uYW1lc3BhY2UpO1xuICAgICAgICB9XG4gICAgICAgIGxldCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucztcbiAgICAgICAgaWYgKGlzTW9kYWwgJiYgaGFzT3duVmVyaWZ5RGV0YWlsU2VydmljZSkge1xuICAgICAgICAgIHZlcmlmeUluZm9ybWF0aW9ucyA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbHRlcihpdGVtID0+IGl0ZW0ubmFtZXNwYWNlID09PSBuYW1lc3BhY2UpO1xuICAgICAgICB9XG4gICAgICAgIC8vIOWboOS4uuagoemqjOe0r+WKoOeahOe8mOaVhe+8jOWvvOiHtOS5i+WJjeeahOagoemqjOS/oeaBr+S4gOebtOWtmOWcqO+8jOWPquiDvemAmui/h+agoemqjOe7k+aenOadpeehruWumuaYr+WQpui/mOaciemUmeivr+S/oeaBr1xuICAgICAgICBpZiAoaXNWYWxpZGF0ZWQgJiYgZm9ybVZhbGlkKSB7XG4gICAgICAgICAgdmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xuICAgICAgICBpZiAoaXNWYWxpZGF0ZWQgJiYgZm9ybVZhbGlkKSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiBlbXB0eSgpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gICAgcmV0dXJuIHJlc3VsdCQ7XG4gIH1cbiAgLyoqXG4gICAqIOagoemqjOWunuS9k+aYr+WQpua7oei2s+S4jeiDveS4uuepuueahOinhOWImVxuICAgKiBAcGFyYW0gZW50aXR5IOS4u+WunuS9k1xuICAgKi9cbiAgcHJpdmF0ZSB2YWxpZGF0ZUVudGl0eUFsbG93RW1wdHlSdWxlKGVudGl0eTogRW50aXR5LCBlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKSB7XG4gICAgLy8g56Gu6K6k5a6e5L2T5ZCE5Liq5bGC57qn5Lit5piv5ZCm5a2Y5Zyo5LiN6IO95Li656m655qE6KeE5YiZXG4gICAgY29uc3QgcGF0aHMgPSB0aGlzLmdldE5vdEFsbG93RW1wdHlCaW5kaW5nUGF0aHMoZW50aXR5VHlwZUluZm8pO1xuICAgIGlmICghcGF0aHMgfHwgcGF0aHMubGVuZ3RoIDwgMSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIC8vIOaJvuWIsOaJgOacieS4jeWQiOazleeahGJpbmRpbmdQYXRoc1xuICAgIGNvbnN0IGludmFsaWRQYXRocyA9IHBhdGhzLmZpbHRlcigocGF0aDogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IHRoaXMuZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgICBpZiAoIWJpbmRpbmdMaXN0IHx8IGJpbmRpbmdMaXN0Lmxlbmd0aCA8IDEpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG4gICAgaWYgKGludmFsaWRQYXRocy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCB0YWJsZU5hbWVzID0gW107XG4gICAgICBpbnZhbGlkUGF0aHMuZm9yRWFjaCgocGF0aDogc3RyaW5nKSA9PiB7XG4gICAgICAgIGNvbnN0IHZpZXdNb2RlbE5hbWUgPSB0aGlzLmdldFZpZXdNb2RlbE5hbWVCeUJpbmRpbmdQYXRocyhwYXRoLnNwbGl0KCcvJykpO1xuICAgICAgICB0YWJsZU5hbWVzLnB1c2godmlld01vZGVsTmFtZSk7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLm5vdGlmeVNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy5ub3RpZnlTZXJ2aWNlLmVycm9yKGAke3RhYmxlTmFtZXMuam9pbign77yMJyl9ICR7dGhpcy5sYW5ndWFnZVNlcnZpY2UudGFibGVDYW5Ob3RFbXB0eX1gLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGhzIHBhdGjkuI3og73kuLrnqbrmiJYv77yM5LiN5pSv5oyB5Li76KGoXG4gICAqL1xuICBwcml2YXRlIGdldFZpZXdNb2RlbE5hbWVCeUJpbmRpbmdQYXRocyhiaW5kaW5nUGF0aHM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlO1xuICAgIGxldCBmcmFtZUNvbnRleHRzOiBGcmFtZUNvbnRleHRbXSA9IG51bGw7XG4gICAgaWYgKG5hbWVzcGFjZSAhPT0gbnVsbCkge1xuICAgICAgLy8g5a2Y5Zyo5ZG95ZCN56m66Ze077yM6K+05piO6KGo5Y2V6L6D5paw77yM5Y+v5Lul5L6d6LWW6K+l54m55oCnXG4gICAgICBmcmFtZUNvbnRleHRzID0gdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHNCeU5hbWVzcGFjZShuYW1lc3BhY2UpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyDooajljZXovoPogIHvvIzojrflj5bmiYDmnInnmoTkuIrkuIvmlofvvIzlnKjmoKHpqozpmLbmrrXov4fmu6Top4TliJlcbiAgICAgIGZyYW1lQ29udGV4dHMgPSB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xuICAgIH1cbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRocy5maWx0ZXIocCA9PiBwKS5qb2luKCcvJyk7XG4gICAgY29uc3QgZnJhbWVDb250ZXh0ID0gZnJhbWVDb250ZXh0cy5maW5kKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4gZnJhbWVDb250ZXh0LnZpZXdNb2RlbCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkuam9pbignLycpID09PSBiaW5kaW5nUGF0aCk7XG4gICAgY29uc3Qgdmlld01vZGVsTmFtZSA9IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQuZm9ybSAmJiBmcmFtZUNvbnRleHQuZm9ybS5mb3JtR3JvdXBOYW1lIHx8ICcnO1xuICAgIHJldHVybiB2aWV3TW9kZWxOYW1lO1xuICB9XG4gIHByaXZhdGUgZ2V0Tm90QWxsb3dFbXB0eUJpbmRpbmdQYXRocyhlbnRpdHlUeXBlSW5mbzogRGF0YVR5cGVJbmZvKTogc3RyaW5nW10gfCB1bmRlZmluZWQge1xuICAgIGlmICghZW50aXR5VHlwZUluZm8pIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGNvbnN0IHBhdGhzID0gW107XG4gICAgdGhpcy5kZWVwRmlyc3RUcmF2ZXJzYWxFbnRpdHlUeXBlSW5mbyhlbnRpdHlUeXBlSW5mbywgcGF0aHMpO1xuICAgIHJldHVybiBwYXRocztcbiAgfVxuICBwcml2YXRlIGRlZXBGaXJzdFRyYXZlcnNhbEVudGl0eVR5cGVJbmZvKGVudGl0eVR5cGVJbmZvOiBEYXRhVHlwZUluZm8sIHJlc3VsdDogc3RyaW5nW10gPSBbXSwgcHJldmlvdXNWYWx1ZTogc3RyaW5nW10gPSBbXSkge1xuICAgIGNvbnN0IGxpc3QgPSBlbnRpdHlUeXBlSW5mby5nZXRQcm9wSW5mb3NCeUdyb3VwKERhdGFQcm9wR3JvdXAuTGlzdCk7XG4gICAgaWYgKGxpc3QgJiYgbGlzdC5sZW5ndGggPiAwKSB7XG4gICAgICBsaXN0LmZvckVhY2goKHByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHtcbiAgICAgICAgY29uc3QgdHlwZUluZm8gPSBwcm9wSW5mby50eXBlSW5mbztcbiAgICAgICAgaWYgKHR5cGVJbmZvICYmIHR5cGVJbmZvLmVudGl0eUluZm8gJiYgdHlwZUluZm8uZW50aXR5SW5mby5hbGxvd0VtcHR5ID09PSBmYWxzZSkge1xuICAgICAgICAgIHByZXZpb3VzVmFsdWUucHVzaCh0eXBlSW5mby5lbnRpdHlJbmZvLm5vZGVDb2RlKTtcbiAgICAgICAgICB0aGlzLmRlZXBGaXJzdFRyYXZlcnNhbEVudGl0eVR5cGVJbmZvKHR5cGVJbmZvLCByZXN1bHQsIHByZXZpb3VzVmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgLy8g5rKh5pyJ5LiL57qn5LqG77yM5q2k5pe25bqU6K+l5riF56m65ri45qCH77yM5bCG5pS26ZuG5Yiw55qE6Lev5b6E5pS+5Yiw57uT5p6c6ZuG5LitXG4gICAgaWYgKHByZXZpb3VzVmFsdWUgJiYgcHJldmlvdXNWYWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBwYXRocyA9IHByZXZpb3VzVmFsdWUuam9pbignLycpO1xuICAgICAgcmVzdWx0LnB1c2gocGF0aHMpO1xuICAgIH1cbiAgICBwcmV2aW91c1ZhbHVlLnNwbGljZSgwLCBwcmV2aW91c1ZhbHVlLmxlbmd0aCk7XG4gIH1cbiAgY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbDogVmlld01vZGVsLCBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdLCBuYW1lc3BhY2U6IHN0cmluZywgZmlsdGVyOiBib29sZWFuID0gdHJ1ZSkge1xuICAgIGlmIChmaWx0ZXIpIHtcbiAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgIT09IG5hbWVzcGFjZSk7XG4gICAgfVxuICAgIGVycm9ycy5mb3JFYWNoKCh2YWxpZGF0aW9uRXJyb3I6IFZhbGlkYXRpb25FcnJvcikgPT4ge1xuICAgICAgaWYgKHZhbGlkYXRpb25FcnJvci5jaGlsZHJlbiAmJiB2YWxpZGF0aW9uRXJyb3IuY2hpbGRyZW4ubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMuY29sbGVjdFZhbGlkYXRpb25FcnJvcnMocm9vdFZpZXdNb2RlbCwgdmFsaWRhdGlvbkVycm9yLmNoaWxkcmVuLCBuYW1lc3BhY2UsIGZhbHNlKTtcbiAgICAgIH1cbiAgICAgIGxldCBpZCA9ICcnO1xuICAgICAgY29uc3QgZmluZElkID0gKHRhcmdldDogYW55KSA9PiB7XG4gICAgICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmRhdGEgJiYgdGFyZ2V0LmRhdGEuaWQpIHtcbiAgICAgICAgICBpZCA9IHRhcmdldC5kYXRhLmlkO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIGlmICh0YXJnZXRbUEFSRU5UX0NMQVNTXSkge1xuICAgICAgICAgIGZpbmRJZCh0YXJnZXRbUEFSRU5UX0NMQVNTXSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBmaW5kSWQodmFsaWRhdGlvbkVycm9yLnRhcmdldCk7XG4gICAgICBpZiAodmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzKSB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHRUeXBlcyA9IE9iamVjdC5rZXlzKHZhbGlkYXRpb25FcnJvci5jb25zdHJhaW50cyk7XG4gICAgICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0VHlwZXMubGVuZ3RoKSB7XG4gICAgICAgICAgY29uc3Qgb2Zmc2V0ID0gcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5uYW1lc3BhY2UgPT09IG5hbWVzcGFjZSkubGVuZ3RoO1xuICAgICAgICAgIGxldCBpbmRleCA9IHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLmZpbmRJbmRleChpdGVtID0+IGl0ZW0ubmFtZXNwYWNlID09PSBuYW1lc3BhY2UpO1xuICAgICAgICAgIGluZGV4ID0gaW5kZXggPT09IC0xID8gMCA6IGluZGV4ICsgb2Zmc2V0O1xuICAgICAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zLnNwbGljZShpbmRleCwgMCwge1xuICAgICAgICAgICAgaWQ6IGlkLFxuICAgICAgICAgICAgbmFtZXNwYWNlLFxuICAgICAgICAgICAgdGFyZ2V0RmllbGQ6IHZhbGlkYXRpb25FcnJvci5maWVsZCxcbiAgICAgICAgICAgIGluZGV4OiB2YWxpZGF0aW9uRXJyb3IuaW5kZXgsXG4gICAgICAgICAgICB0aXRsZTogdmFsaWRhdGlvbkVycm9yLnByb3BlcnR5TmFtZSxcbiAgICAgICAgICAgIG1zZzogdmFsaWRhdGlvbkVycm9yLmNvbnN0cmFpbnRzW3ZhbGlkYXRpb25SZXN1bHRUeXBlc1swXV0sXG4gICAgICAgICAgICBmcmFtZUNvbnRleHQ6IHZhbGlkYXRpb25FcnJvci5mcmFtZUNvbnRleHQsXG4gICAgICAgICAgICBmdWxsUGF0aDogdmFsaWRhdGlvbkVycm9yLmZ1bGxQYXRoLFxuICAgICAgICAgICAgdHlwZTogdmFsaWRhdGlvblJlc3VsdFR5cGVzWzBdID09PSAncmVxdWlyZWQnID8gJ2VtcHR5JyA6ICdlcnJvcidcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDph43nva7moKHpqozkv6Hmga/vvIjku4XlvZPliY3ooajljZXvvIlcbiAgICovXG4gIHB1YmxpYyByZXNldFZhbGlkYXRpb24oKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBpc0RpYWxvZyA9IHRoaXMuaXNJbkRpYWxvZygpO1xuICAgIGxldCByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQucm9vdC52aWV3TW9kZWw7XG4gICAgaWYgKGlzRGlhbG9nKSB7XG4gICAgICByb290Vmlld01vZGVsID0gdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS52aWV3TW9kZWw7XG4gICAgfVxuICAgIGxldCB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucztcbiAgICBpZiAodmVyaWZ5SW5mb3JtYXRpb25zLmxlbmd0aCkge1xuICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5mcmFtZUNvbnRleHQubmFtZXNwYWNlO1xuICAgICAgaWYgKG5hbWVzcGFjZSAhPT0gbnVsbCkge1xuICAgICAgICB2ZXJpZnlJbmZvcm1hdGlvbnMgPSByb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5maWx0ZXIoaXRlbSA9PiBpdGVtLm5hbWVzcGFjZSAhPT0gbmFtZXNwYWNlKTtcbiAgICAgIH1cbiAgICAgIHJvb3RWaWV3TW9kZWwudmVyaWZ5SW5mb3JtYXRpb25zID0gdmVyaWZ5SW5mb3JtYXRpb25zO1xuICAgICAgLy9yb290Vmlld01vZGVsLnZlcmlmeUluZm9ybWF0aW9ucy5zcGxpY2UoMCwgcm9vdFZpZXdNb2RlbC52ZXJpZnlJbmZvcm1hdGlvbnMubGVuZ3RoKTtcbiAgICB9XG4gICAgaWYgKHJvb3RWaWV3TW9kZWwgJiYgcm9vdFZpZXdNb2RlbC52ZXJpZnljYXRpb25DaGFuZ2VkKSB7XG4gICAgICByb290Vmlld01vZGVsLnZlcmlmeWNhdGlvbkNoYW5nZWQubmV4dCh2ZXJpZnlJbmZvcm1hdGlvbnMpO1xuICAgIH1cbiAgICByZXR1cm4gb2YobnVsbCk7XG4gIH1cbiAgLyoqXG4gICAqIOaYr+WQpuWcqOW8ueeql+WGhemDqFxuICAgKi9cbiAgcHJpdmF0ZSBpc0luRGlhbG9nKCkge1xuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpICYmIHRoaXMuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuZnJhbWVDb21wb25lbnQgJiYgdGhpcy5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5mcmFtZUNvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J10gfHwgZmFsc2U7XG4gIH1cbiAgLyoqXG4gICAqIOaLpeacieeLrOiHqueahOagoemqjOaPkOekuuacjeWKoVxuICAgKi9cbiAgcHJpdmF0ZSBoYXNPd25WZXJpZnlEZXRhaWxTZXJ2aWNlKCkge1xuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8VmVyaWZ5RGV0YWlsU2VydmljZT4oVmVyaWZ5RGV0YWlsU2VydmljZSwgbnVsbCkgIT09IHRoaXMuZnJhbWVDb250ZXh0LnJvb3QuYXBwQ29udGV4dC5pbmplY3Rvci5nZXQ8VmVyaWZ5RGV0YWlsU2VydmljZT4oVmVyaWZ5RGV0YWlsU2VydmljZSwgbnVsbCk7O1xuICB9XG59XG5cbmV4cG9ydCB7IFZhbGlkYXRpb25TZXJ2aWNlIH07XG4iXX0=