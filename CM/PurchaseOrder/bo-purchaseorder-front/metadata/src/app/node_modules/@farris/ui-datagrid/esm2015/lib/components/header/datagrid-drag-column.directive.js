/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Directive, NgZone, Injector, Renderer2, ElementRef, Input } from '@angular/core';
import { dropHandlers, smoothDnD as SmoothDnDForHeader, constants } from '@farris/smooth-dnd';
import { DatagridComponent } from '../../datagrid.component';
import { DatagridHeaderComponent } from './datagrid-header.component';
import { DragDropColumnService } from './drag-drop-column.service';
const { wrapperClass, animationClass } = constants;
SmoothDnDForHeader.dropHandler = dropHandlers.reactDropHandler().handler;
SmoothDnDForHeader.wrapChild = false;
/**
 * @record
 */
export function DragStartEndInfo() { }
if (false) {
    /** @type {?} */
    DragStartEndInfo.prototype.isSource;
    /** @type {?} */
    DragStartEndInfo.prototype.payload;
    /** @type {?} */
    DragStartEndInfo.prototype.willAcceptDrop;
}
export class DragColumnDirective {
    /**
     * @param {?} ngzone
     * @param {?} injector
     * @param {?} render
     * @param {?} el
     * @param {?} header
     * @param {?} dg
     * @param {?} dndSer
     */
    constructor(ngzone, injector, render, el, header, dg, dndSer) {
        this.ngzone = ngzone;
        this.injector = injector;
        this.render = render;
        this.el = el;
        this.header = header;
        this.dg = dg;
        this.dndSer = dndSer;
        this.enableDrag = true;
        this.groupName = '';
        this.options = {
            groupName: this.groupName,
            orientation: 'horizontal',
            behaviour: 'move',
            dragHandleSelector: '.drag-column-bar',
            dragClass: 'drag-column-moving',
            dropPlaceholder: {
                className: 'drop-group-field',
            },
            getGhostParent: (/**
             * @return {?}
             */
            () => {
                return document.body;
            }),
            getChildPayload: this.getChildPayload.bind(this),
            shouldAcceptDrop: (/**
             * @param {?} sourceContainerOptions
             * @param {?} payload
             * @return {?}
             */
            (sourceContainerOptions, payload) => {
                if (typeof payload === 'number') {
                    return false;
                }
                if (sourceContainerOptions.groupName !== this.groupName) {
                    return false;
                }
                return !this.dg.isMultiHeader();
            }),
            onDropReady: (/**
             * @param {?} dropResult
             * @return {?}
             */
            (dropResult) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDropReady(dropResult);
                }));
            }),
            onDrop: (/**
             * @param {?} dropResult
             * @return {?}
             */
            (dropResult) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDrop(dropResult);
                }));
            }),
            onDragEnter: (/**
             * @return {?}
             */
            () => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragEnter();
                }));
            }),
            onDragStart: (/**
             * @param {?} info
             * @return {?}
             */
            (info) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragStart(info);
                }));
            }),
            onDragEnd: (/**
             * @param {?} info
             * @return {?}
             */
            (info) => {
                this.ngzone.run((/**
                 * @return {?}
                 */
                () => {
                    this.onDragEnd(info);
                }));
            })
        };
    }
    /**
     * @param {?} changes
     * @return {?}
     */
    ngOnChanges(changes) {
        if (changes.enableDrag && !changes.enableDrag.isFirstChange()) {
            if (this.enableDrag) {
                this.initDnD();
            }
            else {
                this.disposeDnd();
            }
        }
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.initDnD();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.disposeDnd();
    }
    /**
     * @private
     * @return {?}
     */
    disposeDnd() {
        if (this.container) {
            this.container.dispose();
            this.container = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    initDnD() {
        if (this.dg.editable) {
            return;
        }
        if (this.groupName === 'left' || this.groupName === 'right') {
            const { left, right } = this.columnsGroup();
            if (!left.length || !right.length || (right.length === 1 && right[0].field === '_datagrid-setting-control_')) {
                return;
            }
        }
        this.options.groupName = this.groupName;
        this.disposeDnd();
        if (this.enableDrag) {
            this.container = SmoothDnDForHeader(this.el.nativeElement, this.options);
            this.dndSer.backupColumns(this.header.columns);
        }
    }
    /**
     * @private
     * @param {?} index
     * @return {?}
     */
    getChildPayload(index) {
        if (this.groupName === 'left') {
            if (this.dg.showCheckbox) {
                index--;
            }
            if (this.dg.showLineNumber) {
                index--;
            }
        }
        /** @type {?} */
        const groupColumns = this.columnsGroup();
        if (this.groupName === 'left') {
            return groupColumns.left.filter((/**
             * @param {?} n
             * @param {?} i
             * @return {?}
             */
            (n, i) => this.dg.columnIsVisible(n)))[index];
        }
        return groupColumns.middle.filter((/**
         * @param {?} n
         * @param {?} i
         * @return {?}
         */
        (n, i) => this.dg.columnIsVisible(n)))[index];
    }
    /**
     * @param {?} dropResult
     * @return {?}
     */
    onDropReady(dropResult) {
    }
    /**
     * @private
     * @param {?} dropResult
     * @return {?}
     */
    onDrop(dropResult) {
        const { addedIndex, payload, removedIndex } = dropResult;
        if (addedIndex === null) {
            return;
        }
        /** @type {?} */
        const groupColumns = this.columnsGroup();
        /** @type {?} */
        const cols = this.dg.columns[0];
        /** @type {?} */
        const currIndex = cols.findIndex((/**
         * @param {?} n
         * @return {?}
         */
        n => n.field === payload.field));
        /** @type {?} */
        let newIndex = addedIndex;
        /** @type {?} */
        const moveColumn = (/**
         * @param {?} columns
         * @return {?}
         */
        (columns) => {
            if (columns) {
                /** @type {?} */
                const targetColumn = columns.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => n.visible || n.visible === undefined))[newIndex];
                if (targetColumn) {
                    /** @type {?} */
                    const realTagetIndex = cols.findIndex((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n.field === targetColumn.field));
                    this.dg.columns[0] = this.dndSer.moveItem(this.dg.columns[0], realTagetIndex, currIndex);
                    return true;
                }
            }
            return false;
        });
        /** @type {?} */
        let columns = [];
        if (this.groupName === 'left') {
            if (this.dg.showCheckbox) {
                newIndex--;
            }
            if (this.dg.showLineNumber) {
                newIndex--;
            }
            columns = groupColumns.left;
        }
        else if (this.groupName === 'center') {
            columns = groupColumns.middle;
        }
        else if (this.groupName === 'right') {
            columns = groupColumns.right;
        }
        if (moveColumn(columns)) {
            this.dg.columnsChanged(false);
            if (this.dg.useControlPanel && this.dg.settingService) {
                this.dg.settingService.saveUserConfig(this.dg.id);
            }
            this.dg.columnMoved.emit({ newColumns: this.dg.columns, grid: this.dg });
        }
    }
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    onDragStart(info) {
    }
    /**
     * @private
     * @param {?} info
     * @return {?}
     */
    onDragEnd(info) {
    }
    /**
     * @private
     * @return {?}
     */
    onDragEnter() {
    }
    /**
     * @private
     * @return {?}
     */
    columnsGroup() {
        /** @type {?} */
        const leftColumns = this.dg.columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n.fixed === 'left'));
        /** @type {?} */
        const rightColumns = this.dg.columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n.fixed === 'right'));
        /** @type {?} */
        const middleColumns = this.dg.columns[0].filter((/**
         * @param {?} n
         * @return {?}
         */
        n => n.fixed !== 'right' && n.fixed !== 'left'));
        return {
            left: leftColumns,
            right: rightColumns,
            middle: middleColumns
        };
    }
}
DragColumnDirective.decorators = [
    { type: Directive, args: [{
                selector: '[drag-column]',
                providers: [
                    DragDropColumnService
                ]
            },] }
];
/** @nocollapse */
DragColumnDirective.ctorParameters = () => [
    { type: NgZone },
    { type: Injector },
    { type: Renderer2 },
    { type: ElementRef },
    { type: DatagridHeaderComponent },
    { type: DatagridComponent },
    { type: DragDropColumnService }
];
DragColumnDirective.propDecorators = {
    enableDrag: [{ type: Input, args: ['drag-column',] }],
    groupName: [{ type: Input }],
    options: [{ type: Input }]
};
if (false) {
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.container;
    /** @type {?} */
    DragColumnDirective.prototype.enableDrag;
    /** @type {?} */
    DragColumnDirective.prototype.groupName;
    /** @type {?} */
    DragColumnDirective.prototype.options;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.ngzone;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.render;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.el;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.header;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.dg;
    /**
     * @type {?}
     * @private
     */
    DragColumnDirective.prototype.dndSer;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtZHJhZy1jb2x1bW4uZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy91aS1kYXRhZ3JpZC8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL2hlYWRlci9kYXRhZ3JpZC1kcmFnLWNvbHVtbi5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFpQixLQUFLLEVBQXVDLE1BQU0sZUFBZSxDQUFDO0FBQzlJLE9BQU8sRUFBRSxZQUFZLEVBQUUsU0FBUyxJQUFJLGtCQUFrQixFQUFnQyxTQUFTLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM1SCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztNQUc3RCxFQUFFLFlBQVksRUFBRSxjQUFjLEVBQUUsR0FBRyxTQUFTO0FBQ2xELGtCQUFrQixDQUFDLFdBQVcsR0FBRyxZQUFZLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxPQUFPLENBQUM7QUFDekUsa0JBQWtCLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQzs7OztBQUVyQyxzQ0FJQzs7O0lBSEcsb0NBQWtCOztJQUNsQixtQ0FBYTs7SUFDYiwwQ0FBd0I7O0FBUzVCLE1BQU0sT0FBTyxtQkFBbUI7Ozs7Ozs7Ozs7SUF3RDVCLFlBQW9CLE1BQWMsRUFBVSxRQUFrQixFQUFVLE1BQWlCLEVBQ3JFLEVBQWMsRUFBVSxNQUErQixFQUFVLEVBQXFCLEVBQ3RGLE1BQTZCO1FBRjdCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNyRSxPQUFF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Q0FBQyxDQUFDLE1BQU07Ozs7UUFBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEtBQUssT0FBTyxJQUFJLENBQUMsQ0FBQyxLQUFLLEtBQUssTUFBTSxFQUFDO1FBRS9GLE9BQU87WUFDSCxJQUFJLEVBQUUsV0FBVztZQUNqQixLQUFLLEVBQUUsWUFBWTtZQUNuQixNQUFNLEVBQUUsYUFBYTtTQUN4QixDQUFDO0lBQ04sQ0FBQzs7O1lBdE5KLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsZUFBZTtnQkFDekIsU0FBUyxFQUFFO29CQUNQLHFCQUFxQjtpQkFDeEI7YUFDSjs7OztZQXRCbUIsTUFBTTtZQUFFLFFBQVE7WUFBRSxTQUFTO1lBQUUsVUFBVTtZQUdsRCx1QkFBdUI7WUFEdkIsaUJBQWlCO1lBRWpCLHFCQUFxQjs7O3lCQXFCekIsS0FBSyxTQUFDLGFBQWE7d0JBQ25CLEtBQUs7c0JBRUwsS0FBSzs7Ozs7OztJQUpOLHdDQUF1Qjs7SUFDdkIseUNBQXdDOztJQUN4Qyx3Q0FBd0I7O0lBRXhCLHNDQWlERTs7Ozs7SUFFVSxxQ0FBc0I7Ozs7O0lBQUUsdUNBQTBCOzs7OztJQUFFLHFDQUF5Qjs7Ozs7SUFDN0UsaUNBQXNCOzs7OztJQUFFLHFDQUF1Qzs7Ozs7SUFBRSxpQ0FBNkI7Ozs7O0lBQzlGLHFDQUFxQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBEaXJlY3RpdmUsIE5nWm9uZSwgSW5qZWN0b3IsIFJlbmRlcmVyMiwgRWxlbWVudFJlZiwgQWZ0ZXJWaWV3SW5pdCwgSW5wdXQsIE9uQ2hhbmdlcywgU2ltcGxlQ2hhbmdlcywgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGRyb3BIYW5kbGVycywgc21vb3RoRG5EIGFzIFNtb290aERuREZvckhlYWRlciwgRHJvcFJlc3VsdCwgQ29udGFpbmVyT3B0aW9ucywgY29uc3RhbnRzIH0gZnJvbSAnQGZhcnJpcy9zbW9vdGgtZG5kJztcclxuaW1wb3J0IHsgRGF0YWdyaWRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9kYXRhZ3JpZC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBEYXRhZ3JpZEhlYWRlckNvbXBvbmVudCB9IGZyb20gJy4vZGF0YWdyaWQtaGVhZGVyLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IERyYWdEcm9wQ29sdW1uU2VydmljZSB9IGZyb20gJy4vZHJhZy1kcm9wLWNvbHVtbi5zZXJ2aWNlJztcclxuXHJcblxyXG5jb25zdCB7IHdyYXBwZXJDbGFzcywgYW5pbWF0aW9uQ2xhc3MgfSA9IGNvbnN0YW50cztcclxuU21vb3RoRG5ERm9ySGVhZGVyLmRyb3BIYW5kbGVyID0gZHJvcEhhbmRsZXJzLnJlYWN0RHJvcEhhbmRsZXIoKS5oYW5kbGVyO1xyXG5TbW9vdGhEbkRGb3JIZWFkZXIud3JhcENoaWxkID0gZmFsc2U7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERyYWdTdGFydEVuZEluZm8ge1xyXG4gICAgaXNTb3VyY2U6IGJvb2xlYW47XHJcbiAgICBwYXlsb2FkOiBhbnk7XHJcbiAgICB3aWxsQWNjZXB0RHJvcDogYm9vbGVhbjtcclxufVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogJ1tkcmFnLWNvbHVtbl0nLFxyXG4gICAgcHJvdmlkZXJzOiBbXHJcbiAgICAgICAgRHJhZ0Ryb3BDb2x1bW5TZXJ2aWNlXHJcbiAgICBdXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEcmFnQ29sdW1uRGlyZWN0aXZlIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xyXG4gICAgcHJpdmF0ZSBjb250YWluZXI6IGFueTtcclxuICAgIEBJbnB1dCgnZHJhZy1jb2x1bW4nKSBlbmFibGVEcmFnID0gdHJ1ZTtcclxuICAgIEBJbnB1dCgpIGdyb3VwTmFtZSA9ICcnO1xyXG5cclxuICAgIEBJbnB1dCgpIG9wdGlvbnM6IENvbnRhaW5lck9wdGlvbnMgPSB7XHJcbiAgICAgICAgZ3JvdXBOYW1lOiB0aGlzLmdyb3VwTmFtZSxcclxuICAgICAgICBvcmllbnRhdGlvbjogJ2hvcml6b250YWwnLFxyXG4gICAgICAgIGJlaGF2aW91cjogJ21vdmUnLFxyXG4gICAgICAgIGRyYWdIYW5kbGVTZWxlY3RvcjogJy5kcmFnLWNvbHVtbi1iYXInLFxyXG4gICAgICAgIGRyYWdDbGFzczogJ2RyYWctY29sdW1uLW1vdmluZycsXHJcbiAgICAgICAgZHJvcFBsYWNlaG9sZGVyOiB7XHJcbiAgICAgICAgICAgIGNsYXNzTmFtZTogJ2Ryb3AtZ3JvdXAtZmllbGQnLFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZ2V0R2hvc3RQYXJlbnQ6ICgpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIGRvY3VtZW50LmJvZHk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBnZXRDaGlsZFBheWxvYWQ6IHRoaXMuZ2V0Q2hpbGRQYXlsb2FkLmJpbmQodGhpcyksXHJcbiAgICAgICAgc2hvdWxkQWNjZXB0RHJvcDogKHNvdXJjZUNvbnRhaW5lck9wdGlvbnMsIHBheWxvYWQpID0+IHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXlsb2FkID09PSAnbnVtYmVyJykge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZiAoc291cmNlQ29udGFpbmVyT3B0aW9ucy5ncm91cE5hbWUgIT09IHRoaXMuZ3JvdXBOYW1lKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiAhdGhpcy5kZy5pc011bHRpSGVhZGVyKCk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbkRyb3BSZWFkeTogKGRyb3BSZXN1bHQ6IERyb3BSZXN1bHQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25Ecm9wUmVhZHkoZHJvcFJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25Ecm9wOiAoZHJvcFJlc3VsdDogRHJvcFJlc3VsdCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm5nem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyb3AoZHJvcFJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25EcmFnRW50ZXI6ICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25EcmFnRW50ZXIoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvbkRyYWdTdGFydDogKGluZm86IERyYWdTdGFydEVuZEluZm8pID0+IHtcclxuICAgICAgICAgICAgdGhpcy5uZ3pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMub25EcmFnU3RhcnQoaW5mbyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgb25EcmFnRW5kOiAoaW5mbzogRHJhZ1N0YXJ0RW5kSW5mbykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLm5nem9uZS5ydW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vbkRyYWdFbmQoaW5mbyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBuZ3pvbmU6IE5nWm9uZSwgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgcmVuZGVyOiBSZW5kZXJlcjIsXHJcbiAgICAgICAgICAgICAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIGhlYWRlcjogRGF0YWdyaWRIZWFkZXJDb21wb25lbnQsIHByaXZhdGUgZGc6IERhdGFncmlkQ29tcG9uZW50LFxyXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBkbmRTZXI6IERyYWdEcm9wQ29sdW1uU2VydmljZSkgeyB9XHJcblxyXG5cclxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgICAgICBpZiAoY2hhbmdlcy5lbmFibGVEcmFnICYmICFjaGFuZ2VzLmVuYWJsZURyYWcuaXNGaXJzdENoYW5nZSgpKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmVuYWJsZURyYWcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5pdERuRCgpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kaXNwb3NlRG5kKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIHRoaXMuaW5pdERuRCgpO1xyXG4gICAgfVxyXG5cclxuICAgIG5nT25EZXN0cm95KCkge1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZURuZCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZGlzcG9zZURuZCgpIHtcclxuICAgICAgICBpZiAodGhpcy5jb250YWluZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5jb250YWluZXIuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaW5pdERuRCgpIHtcclxuICAgICAgICBpZiAodGhpcy5kZy5lZGl0YWJsZSkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmdyb3VwTmFtZSA9PT0gJ2xlZnQnIHx8IHRoaXMuZ3JvdXBOYW1lID09PSAncmlnaHQnKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgbGVmdCwgcmlnaHQgfSA9IHRoaXMuY29sdW1uc0dyb3VwKCk7XHJcbiAgICAgICAgICAgIGlmICghbGVmdC5sZW5ndGggfHwgIXJpZ2h0Lmxlbmd0aCB8fCAocmlnaHQubGVuZ3RoID09PSAxICYmIHJpZ2h0WzBdLmZpZWxkID09PSAnX2RhdGFncmlkLXNldHRpbmctY29udHJvbF8nKSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuXHJcbiAgICAgICAgdGhpcy5vcHRpb25zLmdyb3VwTmFtZSA9IHRoaXMuZ3JvdXBOYW1lO1xyXG4gICAgICAgIHRoaXMuZGlzcG9zZURuZCgpO1xyXG5cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuZW5hYmxlRHJhZykge1xyXG4gICAgICAgICAgICB0aGlzLmNvbnRhaW5lciA9IFNtb290aERuREZvckhlYWRlcihcclxuICAgICAgICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudCxcclxuICAgICAgICAgICAgICAgIHRoaXMub3B0aW9uc1xyXG4gICAgICAgICAgICApO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5kbmRTZXIuYmFja3VwQ29sdW1ucyh0aGlzLmhlYWRlci5jb2x1bW5zKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRDaGlsZFBheWxvYWQoaW5kZXgpIHtcclxuICAgICAgICBpZiAodGhpcy5ncm91cE5hbWUgPT09ICdsZWZ0Jykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZy5zaG93Q2hlY2tib3gpIHtcclxuICAgICAgICAgICAgICAgIGluZGV4LS07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGcuc2hvd0xpbmVOdW1iZXIpIHtcclxuICAgICAgICAgICAgICAgIGluZGV4LS07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGdyb3VwQ29sdW1ucyA9IHRoaXMuY29sdW1uc0dyb3VwKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmdyb3VwTmFtZSA9PT0gJ2xlZnQnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBncm91cENvbHVtbnMubGVmdC5maWx0ZXIoKG4sIGkpID0+IHRoaXMuZGcuY29sdW1uSXNWaXNpYmxlKG4pKVtpbmRleF07XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gZ3JvdXBDb2x1bW5zLm1pZGRsZS5maWx0ZXIoKG4sIGkpID0+IHRoaXMuZGcuY29sdW1uSXNWaXNpYmxlKG4pKVtpbmRleF07XHJcbiAgICB9XHJcblxyXG4gICAgb25Ecm9wUmVhZHkoZHJvcFJlc3VsdCkge1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25Ecm9wKGRyb3BSZXN1bHQ6IERyb3BSZXN1bHQpIHtcclxuICAgICAgICBjb25zdCB7IGFkZGVkSW5kZXgsIHBheWxvYWQsIHJlbW92ZWRJbmRleCB9ID0gZHJvcFJlc3VsdDtcclxuICAgICAgICBpZiAoYWRkZWRJbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBncm91cENvbHVtbnMgPSB0aGlzLmNvbHVtbnNHcm91cCgpO1xyXG5cclxuICAgICAgICBjb25zdCBjb2xzID0gdGhpcy5kZy5jb2x1bW5zWzBdO1xyXG4gICAgICAgIGNvbnN0IGN1cnJJbmRleCA9IGNvbHMuZmluZEluZGV4KG4gPT4gbi5maWVsZCA9PT0gcGF5bG9hZC5maWVsZCk7XHJcblxyXG4gICAgICAgIGxldCBuZXdJbmRleCA9IGFkZGVkSW5kZXg7XHJcblxyXG4gICAgICAgIGNvbnN0IG1vdmVDb2x1bW4gPSAoY29sdW1uczogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChjb2x1bW5zKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRDb2x1bW4gPSBjb2x1bW5zLmZpbHRlcihuID0+IG4udmlzaWJsZSB8fCBuLnZpc2libGUgPT09IHVuZGVmaW5lZClbbmV3SW5kZXhdO1xyXG4gICAgICAgICAgICAgICAgaWYgKHRhcmdldENvbHVtbikge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWxUYWdldEluZGV4ID0gY29scy5maW5kSW5kZXgobiA9PiBuLmZpZWxkID09PSB0YXJnZXRDb2x1bW4uZmllbGQpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGcuY29sdW1uc1swXSA9IHRoaXMuZG5kU2VyLm1vdmVJdGVtKHRoaXMuZGcuY29sdW1uc1swXSwgcmVhbFRhZ2V0SW5kZXgsIGN1cnJJbmRleCk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgbGV0IGNvbHVtbnMgPSBbXTtcclxuICAgICAgICBpZiAodGhpcy5ncm91cE5hbWUgPT09ICdsZWZ0Jykge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kZy5zaG93Q2hlY2tib3gpIHtcclxuICAgICAgICAgICAgICAgIG5ld0luZGV4LS07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGcuc2hvd0xpbmVOdW1iZXIpIHtcclxuICAgICAgICAgICAgICAgIG5ld0luZGV4LS07XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29sdW1ucyA9IGdyb3VwQ29sdW1ucy5sZWZ0O1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5ncm91cE5hbWUgPT09ICdjZW50ZXInKSB7XHJcbiAgICAgICAgICAgIGNvbHVtbnMgPSBncm91cENvbHVtbnMubWlkZGxlO1xyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5ncm91cE5hbWUgPT09ICdyaWdodCcpIHtcclxuICAgICAgICAgICAgY29sdW1ucyA9IGdyb3VwQ29sdW1ucy5yaWdodDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChtb3ZlQ29sdW1uKGNvbHVtbnMpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGcuY29sdW1uc0NoYW5nZWQoZmFsc2UpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGcudXNlQ29udHJvbFBhbmVsICYmIHRoaXMuZGcuc2V0dGluZ1NlcnZpY2UpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGcuc2V0dGluZ1NlcnZpY2Uuc2F2ZVVzZXJDb25maWcodGhpcy5kZy5pZCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGcuY29sdW1uTW92ZWQuZW1pdCh7IG5ld0NvbHVtbnM6IHRoaXMuZGcuY29sdW1ucywgZ3JpZDogdGhpcy5kZyB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbkRyYWdTdGFydChpbmZvKSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBvbkRyYWdFbmQoaW5mbykge1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIG9uRHJhZ0VudGVyKCkge1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcml2YXRlIGNvbHVtbnNHcm91cCgpIHtcclxuICAgICAgICBjb25zdCBsZWZ0Q29sdW1ucyA9IHRoaXMuZGcuY29sdW1uc1swXS5maWx0ZXIobiA9PiBuLmZpeGVkID09PSAnbGVmdCcpO1xyXG4gICAgICAgIGNvbnN0IHJpZ2h0Q29sdW1ucyA9IHRoaXMuZGcuY29sdW1uc1swXS5maWx0ZXIobiA9PiBuLmZpeGVkID09PSAncmlnaHQnKTtcclxuICAgICAgICBjb25zdCBtaWRkbGVDb2x1bW5zID0gdGhpcy5kZy5jb2x1bW5zWzBdLmZpbHRlcihuID0+IG4uZml4ZWQgIT09ICdyaWdodCcgJiYgbi5maXhlZCAhPT0gJ2xlZnQnKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgbGVmdDogbGVmdENvbHVtbnMsXHJcbiAgICAgICAgICAgIHJpZ2h0OiByaWdodENvbHVtbnMsXHJcbiAgICAgICAgICAgIG1pZGRsZTogbWlkZGxlQ29sdW1uc1xyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn1cclxuXHJcbiJdfQ==