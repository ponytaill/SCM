import { Injectable, ElementRef } from '@angular/core';
import { StateMachine } from '@farris/devkit';
// tslint:disable: max-line-length
/**
 * 状态机服务
 * @scope FrameComponent
 */
class StateMachineService {
    constructor(stateMachine) {
        this.stateMachine = stateMachine;
        this._clsDefaultName = 'f-form-state-default';
        this._initLoad = true;
        if (this.stateMachine.initialState.name === 'init') {
            window.setTimeout(() => {
                this.initFormState();
            }, 0);
        }
    }
    transit(action) {
        if (action && typeof this.stateMachine[action] === 'function') {
            this.stateMachine[action]();
            this._currentFrameContext = this['context'] && this['context']['frameContext'];
            if (this._initLoad) {
                this.initFormState();
                this._initLoad = false;
            }
            if (!this._currentFrameContext) {
                return;
            }
            const currentRootFrameContext = this.getCurrentRootFrameContext(this._currentFrameContext);
            if (!!currentRootFrameContext) {
                this.toggleFormState(action, currentRootFrameContext);
            }
        }
    }
    getCurrentRootFrameContext(currentFrameContext) {
        let currentRootFrameContext;
        this.getAllRootFrameContext().forEach((rootFc) => {
            if (currentFrameContext.namespace === rootFc.namespace) {
                currentRootFrameContext = rootFc;
            }
        });
        return currentRootFrameContext;
    }
    getFrameContextManagerMap() {
        if (this.stateMachine && this.stateMachine.frameContext) {
            const appContext = this.stateMachine.frameContext.appContext;
            if (appContext) {
                const frameContextManager = appContext.frameContextManager;
                return frameContextManager.getFrameContextMap();
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.appContext && this.stateMachine.frameContext.appContext.frameContextManager && this.stateMachine.frameContext.appContext.frameContextManager.getFrameContextMap();
    }
    getAllRootFrameContext() {
        const rootFrameContextArr = [];
        const frameContexts = this.getFrameContextManagerMap();
        if (frameContexts) {
            frameContexts.forEach(item => {
                if ((item['namespace'] === '' && item['parent'] === null) || (item['parent'] !== null && item['namespace'] !== item['parent']['namespace'])) {
                    rootFrameContextArr.push(item);
                }
            });
        }
        return rootFrameContextArr;
    }
    initFormState() {
        if (!this.getFrameContextManagerMap()) {
            return;
        }
        this.getAllRootFrameContext().forEach((rootFc) => {
            const rootComponent = rootFc.injector.get(ElementRef, null) || null;
            if (!rootComponent || !rootComponent.nativeElement) {
                return;
            }
            if (!rootComponent.nativeElement.className.includes(this._clsDefaultName) && !rootComponent.nativeElement.className.includes('f-form-state-create') && !rootComponent.nativeElement.className.includes('f-form-state-edit')) {
                this.addCssClass(rootComponent, this._clsDefaultName);
            }
        });
    }
    toggleFormState(action, frameContext) {
        const rootComponent = frameContext.injector.get(ElementRef, null) || null;
        if (!rootComponent || !rootComponent.nativeElement || !action) {
            return;
        }
        action = action.toLowerCase();
        if (action && ['create', 'edit'].includes(action)) {
            if (action === 'create') {
                this.addCssClass(rootComponent, 'f-form-state-create');
            }
            else if (action === 'edit') {
                this.addCssClass(rootComponent, 'f-form-state-edit');
            }
            this.removeCssClass(rootComponent, this._clsDefaultName);
        }
        else {
            ['f-form-state-create', 'f-form-state-edit'].forEach(item => this.removeCssClass(rootComponent, item));
            this.addCssClass(rootComponent, this._clsDefaultName);
        }
    }
    addCssClass(elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        const originalClassName = elementRef.nativeElement.className || '';
        if (!originalClassName.includes(className)) {
            elementRef.nativeElement.className = `${originalClassName} ${className}`;
        }
    }
    removeCssClass(elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        const originalClassName = elementRef.nativeElement.className || '';
        if (originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName.split(' ').filter(p => p && p !== className).join(' ');
        }
    }
    getFormRootComponent() {
        if (this.stateMachine && this.stateMachine.frameContext) {
            const viewContext = this.stateMachine.frameContext;
            if (viewContext) {
                const virtualRootContext = viewContext.getVirtualRootFrameContext();
                if (virtualRootContext) {
                    const injector = virtualRootContext.injector;
                    if (typeof injector.get === 'function') {
                        return injector.get(ElementRef, null);
                    }
                }
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.getVirtualRootFrameContext() && this.stateMachine.frameContext.getVirtualRootFrameContext().injector && typeof this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get === 'function' && this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get<ElementRef>(ElementRef, null) || null;
    }
}
StateMachineService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
StateMachineService.ctorParameters = () => [
    { type: StateMachine }
];
export { StateMachineService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtbWFjaGluZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsWUFBWSxFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSCxNQUNNLG1CQUFtQjtJQUV2QixZQUNVLFlBQTBCO1FBQTFCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBUzVCLG9CQUFlLEdBQUcsc0JBQXNCLENBQUM7UUFDekMsY0FBUyxHQUFHLElBQUksQ0FBQztRQVJ2QixJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLElBQUksS0FBSyxNQUFNLEVBQUU7WUFDbEQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN2QixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDUDtJQUNILENBQUM7SUFNRCxPQUFPLENBQUMsTUFBYztRQUNwQixJQUFJLE1BQU0sSUFBSSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssVUFBVSxFQUFFO1lBQzdELElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUM1QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUMvRSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7Z0JBQ2xCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztnQkFDckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7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LFFBQVEsQ0FBQyxHQUFHLEtBQUssVUFBVSxFQUFFO3dCQUN0QyxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO3FCQUNuRDtpQkFDRjthQUNGO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztRQUNaLHlaQUF5WjtJQUMzWixDQUFDOzs7WUF4SUYsVUFBVTs7OztZQU5GLFlBQVk7O0FBaUpyQixPQUFPLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN0YXRlTWFjaGluZSwgRnJhbWVDb250ZXh0LCBBcHBDb250ZXh0IH0gZnJvbSAnQGZhcnJpcy9kZXZraXQnO1xuLy8gdHNsaW50OmRpc2FibGU6IG1heC1saW5lLWxlbmd0aFxuLyoqXG4gKiDnirbmgIHmnLrmnI3liqFcbiAqIEBzY29wZSBGcmFtZUNvbXBvbmVudFxuICovXG5ASW5qZWN0YWJsZSgpXG5jbGFzcyBTdGF0ZU1hY2hpbmVTZXJ2aWNlIHtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHN0YXRlTWFjaGluZTogU3RhdGVNYWNoaW5lXG4gICkge1xuICAgIGlmICh0aGlzLnN0YXRlTWFjaGluZS5pbml0aWFsU3RhdGUubmFtZSA9PT0gJ2luaXQnKSB7XG4gICAgICB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuaW5pdEZvcm1TdGF0ZSgpO1xuICAgICAgfSwgMCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfY2xzRGVmYXVsdE5hbWUgPSAnZi1mb3JtLXN0YXRlLWRlZmF1bHQnO1xuICBwcml2YXRlIF9pbml0TG9hZCA9IHRydWU7XG4gIHByaXZhdGUgX2N1cnJlbnRGcmFtZUNvbnRleHQ6IGFueVxuXG4gIHRyYW5zaXQoYWN0aW9uOiBzdHJpbmcpIHtcbiAgICBpZiAoYWN0aW9uICYmIHR5cGVvZiB0aGlzLnN0YXRlTWFjaGluZVthY3Rpb25dID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLnN0YXRlTWFjaGluZVthY3Rpb25dKCk7XG4gICAgICB0aGlzLl9jdXJyZW50RnJhbWVDb250ZXh0ID0gdGhpc1snY29udGV4dCddICYmIHRoaXNbJ2NvbnRleHQnXVsnZnJhbWVDb250ZXh0J107XG4gICAgICBpZiAodGhpcy5faW5pdExvYWQpIHtcbiAgICAgICAgdGhpcy5pbml0Rm9ybVN0YXRlKCk7XG4gICAgICAgIHRoaXMuX2luaXRMb2FkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICBpZiAoIXRoaXMuX2N1cnJlbnRGcmFtZUNvbnRleHQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgY3VycmVudFJvb3RGcmFtZUNvbnRleHQgPSB0aGlzLmdldEN1cnJlbnRSb290RnJhbWVDb250ZXh0KHRoaXMuX2N1cnJlbnRGcmFtZUNvbnRleHQpO1xuICAgICAgaWYgKCEhY3VycmVudFJvb3RGcmFtZUNvbnRleHQpIHtcbiAgICAgICAgdGhpcy50b2dnbGVGb3JtU3RhdGUoYWN0aW9uLCBjdXJyZW50Um9vdEZyYW1lQ29udGV4dCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50Um9vdEZyYW1lQ29udGV4dChjdXJyZW50RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpOiBGcmFtZUNvbnRleHQge1xuICAgIGxldCBjdXJyZW50Um9vdEZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0O1xuICAgIHRoaXMuZ2V0QWxsUm9vdEZyYW1lQ29udGV4dCgpLmZvckVhY2goKHJvb3RGYzogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICBpZiAoY3VycmVudEZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IHJvb3RGYy5uYW1lc3BhY2UpIHtcbiAgICAgICAgY3VycmVudFJvb3RGcmFtZUNvbnRleHQgPSByb290RmM7XG4gICAgICB9XG4gICAgfSlcbiAgICByZXR1cm4gY3VycmVudFJvb3RGcmFtZUNvbnRleHQ7XG4gIH1cblxuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCkge1xuICAgICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0IGFzIEFwcENvbnRleHQ7XG4gICAgICBpZiAoYXBwQ29udGV4dCkge1xuICAgICAgICBjb25zdCBmcmFtZUNvbnRleHRNYW5hZ2VyID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyO1xuICAgICAgICByZXR1cm4gZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRNYXAoKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gICAgLy8gcmV0dXJuIHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dCAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0TWFwKCk7XG4gIH1cblxuICBwcml2YXRlIGdldEFsbFJvb3RGcmFtZUNvbnRleHQoKTogYW55W10ge1xuICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHRBcnIgPSBbXTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGcmFtZUNvbnRleHRNYW5hZ2VyTWFwKCk7XG4gICAgaWYgKGZyYW1lQ29udGV4dHMpIHtcbiAgICAgIGZyYW1lQ29udGV4dHMuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgICAgaWYgKChpdGVtWyduYW1lc3BhY2UnXSA9PT0gJycgJiYgaXRlbVsncGFyZW50J10gPT09IG51bGwpIHx8IChpdGVtWydwYXJlbnQnXSAhPT0gbnVsbCAmJiBpdGVtWyduYW1lc3BhY2UnXSAhPT0gaXRlbVsncGFyZW50J11bJ25hbWVzcGFjZSddKSkge1xuICAgICAgICAgIHJvb3RGcmFtZUNvbnRleHRBcnIucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gICAgcmV0dXJuIHJvb3RGcmFtZUNvbnRleHRBcnI7XG4gIH1cblxuICBwcml2YXRlIGluaXRGb3JtU3RhdGUoKSB7XG4gICAgaWYgKCF0aGlzLmdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmdldEFsbFJvb3RGcmFtZUNvbnRleHQoKS5mb3JFYWNoKChyb290RmM6IEZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgY29uc3Qgcm9vdENvbXBvbmVudCA9IHJvb3RGYy5pbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCkgfHwgbnVsbDtcbiAgICAgIGlmICghcm9vdENvbXBvbmVudCB8fCAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50KSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGlmICghcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmNsdWRlcyh0aGlzLl9jbHNEZWZhdWx0TmFtZSkgJiYgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudC5jbGFzc05hbWUuaW5jbHVkZXMoJ2YtZm9ybS1zdGF0ZS1jcmVhdGUnKSAmJiAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmNsdWRlcygnZi1mb3JtLXN0YXRlLWVkaXQnKSkge1xuICAgICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsIHRoaXMuX2Nsc0RlZmF1bHROYW1lKTtcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVGb3JtU3RhdGUoYWN0aW9uOiBzdHJpbmcsIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSB7XG4gICAgY29uc3Qgcm9vdENvbXBvbmVudCA9IGZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8RWxlbWVudFJlZj4oRWxlbWVudFJlZiwgbnVsbCkgfHwgbnVsbDtcbiAgICBpZiAoIXJvb3RDb21wb25lbnQgfHwgIXJvb3RDb21wb25lbnQubmF0aXZlRWxlbWVudCB8fCAhYWN0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGFjdGlvbiA9IGFjdGlvbi50b0xvd2VyQ2FzZSgpO1xuICAgIGlmIChhY3Rpb24gJiYgWydjcmVhdGUnLCAnZWRpdCddLmluY2x1ZGVzKGFjdGlvbikpIHtcbiAgICAgIGlmIChhY3Rpb24gPT09ICdjcmVhdGUnKSB7XG4gICAgICAgIHRoaXMuYWRkQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgJ2YtZm9ybS1zdGF0ZS1jcmVhdGUnKTtcbiAgICAgIH0gZWxzZSBpZiAoYWN0aW9uID09PSAnZWRpdCcpIHtcbiAgICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCAnZi1mb3JtLXN0YXRlLWVkaXQnKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucmVtb3ZlQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgdGhpcy5fY2xzRGVmYXVsdE5hbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBbJ2YtZm9ybS1zdGF0ZS1jcmVhdGUnLCAnZi1mb3JtLXN0YXRlLWVkaXQnXS5mb3JFYWNoKGl0ZW0gPT4gdGhpcy5yZW1vdmVDc3NDbGFzcyhyb290Q29tcG9uZW50LCBpdGVtKSk7XG4gICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsIHRoaXMuX2Nsc0RlZmF1bHROYW1lKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBhZGRDc3NDbGFzcyhlbGVtZW50UmVmOiBFbGVtZW50UmVmLCBjbGFzc05hbWU6IHN0cmluZykge1xuICAgIGlmICghZWxlbWVudFJlZiB8fCAhY2xhc3NOYW1lIHx8ICFlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3Qgb3JpZ2luYWxDbGFzc05hbWU6IHN0cmluZyA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgfHwgJyc7XG4gICAgaWYgKCFvcmlnaW5hbENsYXNzTmFtZS5pbmNsdWRlcyhjbGFzc05hbWUpKSB7XG4gICAgICBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lID0gYCR7b3JpZ2luYWxDbGFzc05hbWV9ICR7Y2xhc3NOYW1lfWA7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgcmVtb3ZlQ3NzQ2xhc3MoZWxlbWVudFJlZjogRWxlbWVudFJlZiwgY2xhc3NOYW1lOiBzdHJpbmcpIHtcbiAgICBpZiAoIWVsZW1lbnRSZWYgfHwgIWNsYXNzTmFtZSB8fCAhZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50KSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IG9yaWdpbmFsQ2xhc3NOYW1lOiBzdHJpbmcgPSBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lIHx8ICcnO1xuICAgIGlmIChvcmlnaW5hbENsYXNzTmFtZS5pbmNsdWRlcyhjbGFzc05hbWUpKSB7XG4gICAgICBlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lID0gb3JpZ2luYWxDbGFzc05hbWUuc3BsaXQoJyAnKS5maWx0ZXIocCA9PiBwICYmIHAgIT09IGNsYXNzTmFtZSkuam9pbignICcpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGdldEZvcm1Sb290Q29tcG9uZW50KCkge1xuICAgIGlmICh0aGlzLnN0YXRlTWFjaGluZSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQpIHtcbiAgICAgIGNvbnN0IHZpZXdDb250ZXh0ID0gdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0O1xuICAgICAgaWYgKHZpZXdDb250ZXh0KSB7XG4gICAgICAgIGNvbnN0IHZpcnR1YWxSb290Q29udGV4dCA9IHZpZXdDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCk7XG4gICAgICAgIGlmICh2aXJ0dWFsUm9vdENvbnRleHQpIHtcbiAgICAgICAgICBjb25zdCBpbmplY3RvciA9IHZpcnR1YWxSb290Q29udGV4dC5pbmplY3RvcjtcbiAgICAgICAgICBpZiAodHlwZW9mIGluamVjdG9yLmdldCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgICAgcmV0dXJuIGluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gICAgLy8gcmV0dXJuIHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKSAmJiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5pbmplY3RvciAmJiB0eXBlb2YgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuaW5qZWN0b3IuZ2V0ID09PSAnZnVuY3Rpb24nICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xuICB9XG59XG5cbmV4cG9ydCB7IFN0YXRlTWFjaGluZVNlcnZpY2UgfTtcbiJdfQ==