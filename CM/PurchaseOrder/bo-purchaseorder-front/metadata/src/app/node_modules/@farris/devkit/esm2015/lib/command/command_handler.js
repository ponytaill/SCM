import { InjectionToken } from '@angular/core';
import { Subject, BehaviorSubject, EMPTY } from 'rxjs';
import { concatMap, map, takeLast, take, takeUntil, throwIfEmpty } from 'rxjs/operators';
import { CommandContext } from './command_context';
import { TaskFlow } from './flow/index';
import { TranslateToken } from '../i18n/translate_token';
/**
 * 命令处理抽象类，所有具体的命令处理类必须继承它，并实现schedule方法。
 */
class CommandHandler {
    /**
     * 构造函数
     */
    constructor() {
        this.destroy$ = new Subject();
    }
    dispose(options) {
        if (this.destroy$) {
            this.destroy$.next();
            this.destroy$.complete();
        }
        this.frameContext = null;
    }
    ngOnDestroy() {
        this.dispose();
    }
    /**
     * 初始化
     */
    init(frameContext, variableParseService) {
        this.frameContext = frameContext;
        this.parseService = variableParseService;
        this.taskFlow = new TaskFlow();
        this.schedule();
    }
    /**
     * 执行任务
     * @param command 要执行的命令
     * @return 最后一个任务的执行结果
     * @todo：按功能拆分小函数
     */
    execute(command) {
        const lastTaskResult$ = new Subject();
        const taskFlow = this.taskFlow.clone();
        // setTimeout暂时不能去掉的原因：
        // 1、树表单加载数据，依赖TreeTableBinding里设置的全局变量，需要延后执行加载时机；
        // 2、关闭前命令需要延迟执行。
        setTimeout(() => {
            if (!this.frameContext || this.frameContext.isDisposed) {
                return EMPTY;
            }
            // 1、解析参数
            // 避免解析变量时修改了原始的command
            const { eventParam = null } = Object.assign({}, command);
            delete command.eventParam;
            const commandToExecute = JSON.parse(JSON.stringify(command));
            commandToExecute.params = this.paramsTransform(commandToExecute.params);
            commandToExecute.params = this.parseService.parse(commandToExecute.params, this.frameContext, eventParam);
            command.eventParam = eventParam;
            commandToExecute.eventParam = eventParam;
            this.transParamTypes(commandToExecute.params, commandToExecute.paramDescriptions);
            // 2、串联任务流
            const initContext = new CommandContext(commandToExecute, this.frameContext);
            initContext.eventParam = command.eventParam || null;
            const context$ = new BehaviorSubject(initContext);
            let currentTask = taskFlow.getNext('', initContext);
            const highOrder$ = context$.pipe(concatMap((context) => {
                const result$ = currentTask.execute(context);
                return result$.pipe(take(1), map((result) => {
                    // 写入执行结果
                    context.results[currentTask.name] = result;
                    context.latestResult = result;
                    currentTask = taskFlow.getNext(currentTask.name, context);
                    // 操作控制流
                    if (currentTask) {
                        context$.next(context);
                    }
                    else {
                        context$.complete();
                    }
                    // 将结果流转换为context流
                    return context;
                }), throwIfEmpty(() => {
                    context$.complete();
                }));
            }));
            // 3、执行合并后的任务流
            highOrder$.pipe(takeLast(1)).subscribe({
                next: (context) => {
                    this.waitForDestroy(context);
                    lastTaskResult$.next(context.latestResult);
                },
                error: (error) => {
                    this.waitForDestroy(initContext);
                    this.displayError(error);
                    lastTaskResult$.error(error || '');
                },
                complete: () => {
                    this.waitForDestroy(initContext);
                    lastTaskResult$.complete();
                },
            });
        }, 0);
        return lastTaskResult$;
    }
    /**
     * 等待销毁
     * @param commandContext
     */
    waitForDestroy(commandContext) {
        if (!commandContext) {
            return;
        }
        commandContext.clearResults();
        if (this.frameContext && this.frameContext.appContext && this.frameContext.appContext.destorySignal) {
            this.frameContext.appContext.destorySignal.pipe(takeUntil(this.destroy$)).subscribe(() => {
                if (commandContext) {
                    commandContext.dispose();
                    commandContext = null;
                }
            });
        }
    }
    /**
     * 显示错误信息
     */
    displayError(error) {
        if (!error) {
            return;
        }
        if (!console || !console.error) {
            return;
        }
        console.error(error);
    }
    /**
     * 参数国际化转换方法
     */
    paramsTransform(params) {
        const exp = /\{\{(\w+)\}\}/g;
        if (!params) {
            return null;
        }
        const translateService = this.frameContext && this.frameContext.injector && this.frameContext.injector.get(TranslateToken, null) || null;
        const pArray = Object.keys(params);
        const result = {};
        if (pArray.length === 0) {
            return params;
        }
        pArray.forEach((p) => {
            let ele = params[p];
            if (ele && exp.test(ele) && translateService) {
                ele = ele.replace(exp, ($1, $2) => {
                    return translateService.transform($2, null);
                });
            }
            result[p] = ele;
        });
        return result;
    }
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    addTask(name, func) {
        this.taskFlow.addNode(name, func);
    }
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    addLink(from, to, condition) {
        this.taskFlow.addLink(from, to, condition);
    }
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    insertTask(target, name, func) {
        throw new Error('Not Implemented');
    }
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    afterTask(target, name, func) {
        throw new Error('Not Implemented');
    }
    /**
     * 替换任务
     * @param  name 要替换的任务名称
     * @param  func 替换函数
     */
    replaceTask(name, func) {
        throw new Error('Not Implement');
    }
    /**
     * 调用方法
     */
    invoke(serviceInstance, method, args, context) {
        this.setContextToServiceInstance(serviceInstance, context);
        const parsedArgs = this.parseService.parse(args, context, context.eventParam);
        return serviceInstance[method](...parsedArgs);
    }
    /**
     * 为服务设置命令上下文
     * @todo
     * 通过这种方式存在很大问题：
     * 1、会覆盖掉已有的context，给开发人员造成困扰和调试成本；
     * 2、服务中依赖了一个没有声明的对象，不符合面向对象的原则。
     * 建议解决方案：
     * 1、将context修改为某个特殊属性名；
     * 2、先检测服务上有没有一个CommandContext类型的context属性，有的话再赋值，
     *    这就要求需要使用context的服务需要是实现一个IContext接口。
     */
    setContextToServiceInstance(serviceInstance, context) {
        // 如果服务上已经存在context属性，并且该属性不是CommandContext类型，则不能覆盖
        const serviceContext = serviceInstance.context;
        if (serviceContext && (serviceContext instanceof CommandContext === false)) {
            return;
        }
        serviceInstance.context = context;
    }
    /**
     * 根据参数描述信息转换参数类型
     */
    transParamTypes(params, paramDescriptions) {
        if (!paramDescriptions) {
            return;
        }
        const keys = Object.keys(params);
        keys.forEach(key => {
            if (!paramDescriptions[key] || !paramDescriptions[key].type) {
                return;
            }
            const parType = paramDescriptions[key].type;
            const value = params[key];
            if (value === undefined || value === null || typeof value === parType) {
                return; // 值不存在或类型匹配，无需处理
            }
            switch (parType) {
                case 'string':
                    // 其实转换前的参数都是string，这里不会走到
                    params[key] = value + '';
                    break;
                case 'int':
                case 'double':
                case 'number':
                    // 前端数值类型只有number，这里兼容命令构件上设置为int和double的情况
                    const numResult = Number(value);
                    if (isNaN(numResult)) {
                        throw Error(`类型转换失败，参数${key}值为${value}，无法转换为${parType}类型。`);
                    }
                    params[key] = numResult;
                    break;
                case 'boolean':
                    let boolResult;
                    const strValue = (value + '').toLowerCase();
                    if (strValue === 'true') {
                        boolResult = true;
                    }
                    else if (strValue === 'false') {
                        boolResult = false;
                    }
                    else {
                        throw Error(`类型转换失败，参数${key}值为${value}，无法转换为${parType}类型。`);
                    }
                    params[key] = boolResult;
                    break;
                case 'datetime':
                    // todo：日期时间暂不处理
                    break;
                case 'object':
                    // 表达式解析出来的参数，无需处理，按原类型返回
                    // todo: 输入参数是个json串，转成object
                    break;
                default:
                    break;
            }
        });
    }
}
/**
 * 命令处理器注入Token
 */
const COMMAND_HANDLERS_TOKEN = new InjectionToken('@Farris Command Handlers');
export { CommandHandler, COMMAND_HANDLERS_TOKEN };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvY29tbWFuZC9jb21tYW5kX2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGNBQWMsRUFBaUMsTUFBTSxlQUFlLENBQUM7QUFDOUUsT0FBTyxFQUFjLE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25FLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTXpGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNuRCxPQUFPLEVBQVksUUFBUSxFQUFFLE1BQU0sY0FBYyxDQUFDO0FBQ2xELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUl6RDs7R0FFRztBQUNILE1BQWUsY0FBYztJQW1CM0I7O09BRUc7SUFDSDtRQUpRLGFBQVEsR0FBaUIsSUFBSSxPQUFPLEVBQU8sQ0FBQztJQUtwRCxDQUFDO0lBQ0QsT0FBTyxDQUFDLE9BQWE7UUFDbkIsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2pCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUMxQjtRQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0lBQzNCLENBQUM7SUFDRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFPRDs7T0FFRztJQUNJLElBQUksQ0FBQyxZQUEwQixFQUFFLG9CQUEwQztRQUNoRixJQUFJLENBQUMsWUFBWSxHQUFHLFlBQVksQ0FBQztRQUNqQyxJQUFJLENBQUMsWUFBWSxHQUFH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QUFRO29CQUNYLHlCQUF5QjtvQkFDekIsNkJBQTZCO29CQUM3QixNQUFNO2dCQUNSO29CQUNFLE1BQU07YUFDVDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUVGO0FBRUQ7O0dBRUc7QUFDSCxNQUFNLHNCQUFzQixHQUFHLElBQUksY0FBYyxDQUFpQiwwQkFBMEIsQ0FBQyxDQUFDO0FBRTlGLE9BQU8sRUFBRSxjQUFjLEVBQUUsc0JBQXNCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGlvblRva2VuLCBPcHRpb25hbCwgSW5qZWN0b3IsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBCZWhhdmlvclN1YmplY3QsIEVNUFRZIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGNvbmNhdE1hcCwgbWFwLCB0YWtlTGFzdCwgdGFrZSwgdGFrZVVudGlsLCB0aHJvd0lmRW1wdHkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBGcmFtZUNvbnRleHQgfSBmcm9tICcuLi9mcmFtZS9pbmRleCc7XHJcbmltcG9ydCB7IFZhcmlhYmxlUGFyc2VTZXJ2aWNlIH0gZnJvbSAnLi4vdmFyaWFibGUvaW5kZXgnO1xyXG5cclxuaW1wb3J0IHsgQ29tbWFuZCwgQ29tbWFuZFBhcmFtcywgUGFyYW1EZXNjcmlwdGlvbnMgfSBmcm9tICcuL2NvbW1hbmQnO1xyXG5pbXBvcnQgeyBDb21tYW5kQ29udGV4dCB9IGZyb20gJy4vY29tbWFuZF9jb250ZXh0JztcclxuaW1wb3J0IHsgVGFza0Z1bmMsIFRhc2tGbG93IH0gZnJvbSAnLi9mbG93L2luZGV4JztcclxuaW1wb3J0IHsgVHJhbnNsYXRlVG9rZW4gfSBmcm9tICcuLi9pMThuL3RyYW5zbGF0ZV90b2tlbic7XHJcbmltcG9ydCB7IFRyYW5zbGF0ZSB9IGZyb20gJy4uL2kxOG4vdHJhbnNsYXRlJztcclxuaW1wb3J0IHsgSURpc3Bvc2FibGUgfSBmcm9tICcuLi9jb3JlJztcclxuXHJcbi8qKlxyXG4gKiDlkb3ku6TlpITnkIbmir3osaHnsbvvvIzmiYDmnInlhbfkvZPnmoTlkb3ku6TlpITnkIbnsbvlv4Xpobvnu6fmib/lroPvvIzlubblrp7njrBzY2hlZHVsZeaWueazleOAglxyXG4gKi9cclxuYWJzdHJhY3QgY2xhc3MgQ29tbWFuZEhhbmRsZXIgaW1wbGVtZW50cyBJRGlzcG9zYWJsZSwgT25EZXN0cm95IHtcclxuXHJcbiAgLyoqXHJcbiAgICog5Lu75Yqh5rWB56iL5Zu+XHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0YXNrRmxvdzogVGFza0Zsb3c7XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dDtcclxuXHJcbiAgLyoqXHJcbiAgICog5Y+Y6YeP6Kej5p6Q5pyN5YqhXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHBhcnNlU2VydmljZTogVmFyaWFibGVQYXJzZVNlcnZpY2U7XHJcblxyXG4gIHB1YmxpYyBjb21tYW5kTmFtZTogc3RyaW5nO1xyXG4gIHByaXZhdGUgZGVzdHJveSQ6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBjb25zdHJ1Y3RvcigpIHtcclxuICB9XHJcbiAgZGlzcG9zZShvcHRpb25zPzogYW55KSB7XHJcbiAgICBpZiAodGhpcy5kZXN0cm95JCkge1xyXG4gICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcclxuICAgICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSBudWxsO1xyXG4gIH1cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGlzcG9zZSgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5p6E6YCg5omn6KGM5rWB56iLXHJcbiAgICovXHJcbiAgYWJzdHJhY3Qgc2NoZWR1bGUoKTtcclxuXHJcbiAgLyoqXHJcbiAgICog5Yid5aeL5YyWXHJcbiAgICovXHJcbiAgcHVibGljIGluaXQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIHZhcmlhYmxlUGFyc2VTZXJ2aWNlOiBWYXJpYWJsZVBhcnNlU2VydmljZSkge1xyXG4gICAgdGhpcy5mcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQ7XHJcbiAgICB0aGlzLnBhcnNlU2VydmljZSA9IHZhcmlhYmxlUGFyc2VTZXJ2aWNlO1xyXG4gICAgdGhpcy50YXNrRmxvdyA9IG5ldyBUYXNrRmxvdygpO1xyXG4gICAgdGhpcy5zY2hlZHVsZSgpO1xyXG5cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaJp+ihjOS7u+WKoVxyXG4gICAqIEBwYXJhbSBjb21tYW5kIOimgeaJp+ihjOeahOWRveS7pFxyXG4gICAqIEByZXR1cm4g5pyA5ZCO5LiA5Liq5Lu75Yqh55qE5omn6KGM57uT5p6cXHJcbiAgICogQHRvZG/vvJrmjInlip/og73mi4bliIblsI/lh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgZXhlY3V0ZShjb21tYW5kOiBDb21tYW5kKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIGNvbnN0IGxhc3RUYXNrUmVzdWx0JCA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgICBjb25zdCB0YXNrRmxvdyA9IHRoaXMudGFza0Zsb3cuY2xvbmUoKTtcclxuXHJcbiAgICAvLyBzZXRUaW1lb3V05pqC5pe25LiN6IO95Y675o6J55qE5Y6f5Zug77yaXHJcbiAgICAvLyAx44CB5qCR6KGo5Y2V5Yqg6L295pWw5o2u77yM5L6d6LWWVHJlZVRhYmxlQmluZGluZ+mHjOiuvue9rueahOWFqOWxgOWPmOmHj++8jOmcgOimgeW7tuWQjuaJp+ihjOWKoOi9veaXtuacuu+8m1xyXG4gICAgLy8gMuOAgeWFs+mXreWJjeWRveS7pOmcgOimgeW7tui/n+aJp+ihjOOAglxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIGlmICghdGhpcy5mcmFtZUNvbnRleHQgfHwgdGhpcy5mcmFtZUNvbnRleHQuaXNEaXNwb3NlZCkge1xyXG4gICAgICAgIHJldHVybiBFTVBUWTtcclxuICAgICAgfVxyXG4gICAgICAvLyAx44CB6Kej5p6Q5Y+C5pWwXHJcbiAgICAgIC8vIOmBv+WFjeino+aekOWPmOmHj+aXtuS/ruaUueS6huWOn+Wni+eahGNvbW1hbmRcclxuICAgICAgY29uc3QgeyBldmVudFBhcmFtID0gbnVsbCB9ID0ge1xyXG4gICAgICAgIC4uLmNvbW1hbmRcclxuICAgICAgfTtcclxuICAgICAgZGVsZXRlIGNvbW1hbmQuZXZlbnRQYXJhbTtcclxuICAgICAgY29uc3QgY29tbWFuZFRvRXhlY3V0ZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoY29tbWFuZCkpO1xyXG4gICAgICBjb21tYW5kVG9FeGVjdXRlLnBhcmFtcyA9IHRoaXMucGFyYW1zVHJhbnNmb3JtKGNvbW1hbmRUb0V4ZWN1dGUucGFyYW1zKTtcclxuICAgICAgY29tbWFuZFRvRXhlY3V0ZS5wYXJhbXMgPSB0aGlzLnBhcnNlU2VydmljZS5wYXJzZShjb21tYW5kVG9FeGVjdXRlLnBhcmFtcywgdGhpcy5mcmFtZUNvbnRleHQsIGV2ZW50UGFyYW0pO1xyXG4gICAgICBjb21tYW5kLmV2ZW50UGFyYW0gPSBldmVudFBhcmFtO1xyXG4gICAgICBjb21tYW5kVG9FeGVjdXRlLmV2ZW50UGFyYW0gPSBldmVudFBhcmFtO1xyXG4gICAgICB0aGlzLnRyYW5zUGFyYW1UeXBlcyhjb21tYW5kVG9FeGVjdXRlLnBhcmFtcywgY29tbWFuZFRvRXhlY3V0ZS5wYXJhbURlc2NyaXB0aW9ucyk7XHJcblxyXG4gICAgICAvLyAy44CB5Liy6IGU5Lu75Yqh5rWBXHJcbiAgICAgIGNvbnN0IGluaXRDb250ZXh0ID0gbmV3IENvbW1hbmRDb250ZXh0KGNvbW1hbmRUb0V4ZWN1dGUsIHRoaXMuZnJhbWVDb250ZXh0KTtcclxuICAgICAgaW5pdENvbnRleHQuZXZlbnRQYXJhbSA9IGNvbW1hbmQuZXZlbnRQYXJhbSB8fCBudWxsO1xyXG4gICAgICBjb25zdCBjb250ZXh0JCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q29tbWFuZENvbnRleHQ+KGluaXRDb250ZXh0KTtcclxuICAgICAgbGV0IGN1cnJlbnRUYXNrID0gdGFza0Zsb3cuZ2V0TmV4dCgnJywgaW5pdENvbnRleHQpO1xyXG4gICAgICBjb25zdCBoaWdoT3JkZXIkID0gY29udGV4dCQucGlwZShcclxuICAgICAgICBjb25jYXRNYXAoKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICBjb25zdCByZXN1bHQkID0gY3VycmVudFRhc2suZXhlY3V0ZShjb250ZXh0KTtcclxuICAgICAgICAgIHJldHVybiByZXN1bHQkLnBpcGUoXHJcbiAgICAgICAgICAgIHRha2UoMSksXHJcbiAgICAgICAgICAgIG1hcCgocmVzdWx0OiBhbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgLy8g5YaZ5YWl5omn6KGM57uT5p6cXHJcbiAgICAgICAgICAgICAgY29udGV4dC5yZXN1bHRzW2N1cnJlbnRUYXNrLm5hbWVdID0gcmVzdWx0O1xyXG4gICAgICAgICAgICAgIGNvbnRleHQubGF0ZXN0UmVzdWx0ID0gcmVzdWx0O1xyXG4gICAgICAgICAgICAgIGN1cnJlbnRUYXNrID0gdGFza0Zsb3cuZ2V0TmV4dChjdXJyZW50VGFzay5uYW1lLCBjb250ZXh0KTtcclxuXHJcbiAgICAgICAgICAgICAgLy8g5pON5L2c5o6n5Yi25rWBXHJcbiAgICAgICAgICAgICAgaWYgKGN1cnJlbnRUYXNrKSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0JC5uZXh0KGNvbnRleHQpO1xyXG4gICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb250ZXh0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgLy8g5bCG57uT5p6c5rWB6L2s5o2i5Li6Y29udGV4dOa1gVxyXG4gICAgICAgICAgICAgIHJldHVybiBjb250ZXh0O1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgdGhyb3dJZkVtcHR5KCgpID0+IHtcclxuICAgICAgICAgICAgICBjb250ZXh0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgKTtcclxuICAgICAgICB9KVxyXG4gICAgICApO1xyXG5cclxuICAgICAgLy8gM+OAgeaJp+ihjOWQiOW5tuWQjueahOS7u+WKoea1gVxyXG4gICAgICBoaWdoT3JkZXIkLnBpcGUoXHJcbiAgICAgICAgdGFrZUxhc3QoMSlcclxuICAgICAgKS5zdWJzY3JpYmUoe1xyXG4gICAgICAgIG5leHQ6IChjb250ZXh0OiBDb21tYW5kQ29udGV4dCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy53YWl0Rm9yRGVzdHJveShjb250ZXh0KTtcclxuICAgICAgICAgIGxhc3RUYXNrUmVzdWx0JC5uZXh0KGNvbnRleHQubGF0ZXN0UmVzdWx0KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGVycm9yOiAoZXJyb3I6IGFueSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy53YWl0Rm9yRGVzdHJveShpbml0Q29udGV4dCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGlzcGxheUVycm9yKGVycm9yKTtcclxuICAgICAgICAgIGxhc3RUYXNrUmVzdWx0JC5lcnJvcihlcnJvciB8fCAnJyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjb21wbGV0ZTogKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy53YWl0Rm9yRGVzdHJveShpbml0Q29udGV4dCk7XHJcbiAgICAgICAgICBsYXN0VGFza1Jlc3VsdCQuY29tcGxldGUoKTtcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICB9LCAwKTtcclxuXHJcbiAgICByZXR1cm4gbGFzdFRhc2tSZXN1bHQkO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDnrYnlvoXplIDmr4FcclxuICAgKiBAcGFyYW0gY29tbWFuZENvbnRleHQgXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB3YWl0Rm9yRGVzdHJveShjb21tYW5kQ29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuICAgIGlmICghY29tbWFuZENvbnRleHQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29tbWFuZENvbnRleHQuY2xlYXJSZXN1bHRzKCk7XHJcbiAgICBpZiAodGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmRlc3RvcnlTaWduYWwpIHtcclxuICAgICAgdGhpcy5mcmFtZUNvbnRleHQuYXBwQ29udGV4dC5kZXN0b3J5U2lnbmFsLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgIGlmIChjb21tYW5kQ29udGV4dCkge1xyXG4gICAgICAgICAgY29tbWFuZENvbnRleHQuZGlzcG9zZSgpO1xyXG4gICAgICAgICAgY29tbWFuZENvbnRleHQgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOaYvuekuumUmeivr+S/oeaBr1xyXG4gICAqL1xyXG4gIHByaXZhdGUgZGlzcGxheUVycm9yKGVycm9yOiBhbnkpIHtcclxuICAgIGlmICghZXJyb3IpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgaWYgKCFjb25zb2xlIHx8ICFjb25zb2xlLmVycm9yKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiDlj4LmlbDlm73pmYXljJbovazmjaLmlrnms5VcclxuICAgKi9cclxuICBwcml2YXRlIHBhcmFtc1RyYW5zZm9ybShwYXJhbXM6IG9iamVjdCkge1xyXG4gICAgY29uc3QgZXhwID0gL1xce1xceyhcXHcrKVxcfVxcfS9nO1xyXG4gICAgaWYgKCFwYXJhbXMpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCB0cmFuc2xhdGVTZXJ2aWNlID0gdGhpcy5mcmFtZUNvbnRleHQgJiYgdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IgJiYgdGhpcy5mcmFtZUNvbnRleHQuaW5qZWN0b3IuZ2V0PFRyYW5zbGF0ZT4oVHJhbnNsYXRlVG9rZW4sIG51bGwpIHx8IG51bGw7XHJcbiAgICBjb25zdCBwQXJyYXkgPSBPYmplY3Qua2V5cyhwYXJhbXMpO1xyXG4gICAgY29uc3QgcmVzdWx0ID0ge307XHJcbiAgICBpZiAocEFycmF5Lmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICByZXR1cm4gcGFyYW1zO1xyXG4gICAgfVxyXG4gICAgcEFycmF5LmZvckVhY2goKHApID0+IHtcclxuICAgICAgbGV0IGVsZSA9IHBhcmFtc1twXTtcclxuICAgICAgaWYgKGVsZSAmJiBleHAudGVzdChlbGUpICYmIHRyYW5zbGF0ZVNlcnZpY2UpIHtcclxuICAgICAgICBlbGUgPSBlbGUucmVwbGFjZShleHAsICgkMSwgJDIpID0+IHtcclxuICAgICAgICAgIHJldHVybiB0cmFuc2xhdGVTZXJ2aWNlLnRyYW5zZm9ybSgkMiwgbnVsbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgICAgcmVzdWx0W3BdID0gZWxlO1xyXG5cclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDku7vliqHvvIzlj6rmnInlrZDnsbvlj6/ku6Xmt7vliqDku7vliqHvvIzlpJbpg6jkuI3og73orr/pl65cclxuICAgKiBAcGFyYW0gbmFtZSAg5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtIGZ1bmMg5Lu75Yqh5Ye95pWwXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGFkZFRhc2sobmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYykge1xyXG4gICAgdGhpcy50YXNrRmxvdy5hZGROb2RlKG5hbWUsIGZ1bmMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5re75Yqg5Lu75Yqh77yM5Y+q5pyJ5a2Q57G75Y+v5Lul5re75Yqg5Lu75Yqh77yM5aSW6YOo5LiN6IO96K6/6ZeuXHJcbiAgICogQHBhcmFtIG5hbWUgIOS7u+WKoeWQjeensFxyXG4gICAqIEBwYXJhbSBmdW5jIOS7u+WKoeWHveaVsFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBhZGRMaW5rKGZyb206IHN0cmluZywgdG86IHN0cmluZywgY29uZGl0aW9uOiBzdHJpbmcgfCBib29sZWFuKSB7XHJcbiAgICB0aGlzLnRhc2tGbG93LmFkZExpbmsoZnJvbSwgdG8sIGNvbmRpdGlvbik7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmj5LlhaXku7vliqFcclxuICAgKiBAcGFyYW0gIG5hbWUg6KaB5omp5bGV55qE5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtICBmdW5jIOaJqeWxleWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbnNlcnRUYXNrKHRhcmdldDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5o+S5YWl5Lu75YqhXHJcbiAgICogQHBhcmFtICBuYW1lIOimgeaJqeWxleeahOS7u+WKoeWQjeensFxyXG4gICAqIEBwYXJhbSAgZnVuYyDmianlsZXlh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgYWZ0ZXJUYXNrKHRhcmdldDogc3RyaW5nLCBuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnRlZCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5pu/5o2i5Lu75YqhXHJcbiAgICogQHBhcmFtICBuYW1lIOimgeabv+aNoueahOS7u+WKoeWQjeensFxyXG4gICAqIEBwYXJhbSAgZnVuYyDmm7/mjaLlh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgcmVwbGFjZVRhc2sobmFtZTogc3RyaW5nLCBmdW5jOiBUYXNrRnVuYykge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3QgSW1wbGVtZW50Jyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDosIPnlKjmlrnms5VcclxuICAgKi9cclxuICBwdWJsaWMgaW52b2tlKHNlcnZpY2VJbnN0YW5jZTogYW55LCBtZXRob2Q6IHN0cmluZywgYXJnczogYW55W10sIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSB7XHJcbiAgICB0aGlzLnNldENvbnRleHRUb1NlcnZpY2VJbnN0YW5jZShzZXJ2aWNlSW5zdGFuY2UsIGNvbnRleHQpO1xyXG4gICAgY29uc3QgcGFyc2VkQXJncyA9IHRoaXMucGFyc2VTZXJ2aWNlLnBhcnNlKGFyZ3MsIGNvbnRleHQsIGNvbnRleHQuZXZlbnRQYXJhbSk7XHJcbiAgICByZXR1cm4gc2VydmljZUluc3RhbmNlW21ldGhvZF0oLi4ucGFyc2VkQXJncyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDkuLrmnI3liqHorr7nva7lkb3ku6TkuIrkuIvmlodcclxuICAgKiBAdG9kb1xyXG4gICAqIOmAmui/h+i/meenjeaWueW8j+WtmOWcqOW+iOWkp+mXrumimO+8mlxyXG4gICAqIDHjgIHkvJropobnm5bmjonlt7LmnInnmoRjb250ZXh077yM57uZ5byA5Y+R5Lq65ZGY6YCg5oiQ5Zuw5omw5ZKM6LCD6K+V5oiQ5pys77ybXHJcbiAgICogMuOAgeacjeWKoeS4reS+nei1luS6huS4gOS4quayoeacieWjsOaYjueahOWvueixoe+8jOS4jeespuWQiOmdouWQkeWvueixoeeahOWOn+WImeOAglxyXG4gICAqIOW7uuiuruino+WGs+aWueahiO+8mlxyXG4gICAqIDHjgIHlsIZjb250ZXh05L+u5pS55Li65p+Q5Liq54m55q6K5bGe5oCn5ZCN77ybXHJcbiAgICogMuOAgeWFiOajgOa1i+acjeWKoeS4iuacieayoeacieS4gOS4qkNvbW1hbmRDb250ZXh057G75Z6L55qEY29udGV4dOWxnuaAp++8jOacieeahOivneWGjei1i+WAvO+8jFxyXG4gICAqICAgIOi/meWwseimgeaxgumcgOimgeS9v+eUqGNvbnRleHTnmoTmnI3liqHpnIDopoHmmK/lrp7njrDkuIDkuKpJQ29udGV4dOaOpeWPo+OAglxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzZXRDb250ZXh0VG9TZXJ2aWNlSW5zdGFuY2Uoc2VydmljZUluc3RhbmNlOiBhbnksIGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSB7XHJcblxyXG4gICAgLy8g5aaC5p6c5pyN5Yqh5LiK5bey57uP5a2Y5ZyoY29udGV4dOWxnuaAp++8jOW5tuS4lOivpeWxnuaAp+S4jeaYr0NvbW1hbmRDb250ZXh057G75Z6L77yM5YiZ5LiN6IO96KaG55uWXHJcbiAgICBjb25zdCBzZXJ2aWNlQ29udGV4dCA9IHNlcnZpY2VJbnN0YW5jZS5jb250ZXh0O1xyXG4gICAgaWYgKHNlcnZpY2VDb250ZXh0ICYmIChzZXJ2aWNlQ29udGV4dCBpbnN0YW5jZW9mIENvbW1hbmRDb250ZXh0ID09PSBmYWxzZSkpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHNlcnZpY2VJbnN0YW5jZS5jb250ZXh0ID0gY29udGV4dDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOagueaNruWPguaVsOaPj+i/sOS/oeaBr+i9rOaNouWPguaVsOexu+Wei1xyXG4gICAqL1xyXG4gIHByaXZhdGUgdHJhbnNQYXJhbVR5cGVzKHBhcmFtczogQ29tbWFuZFBhcmFtcywgcGFyYW1EZXNjcmlwdGlvbnM6IFBhcmFtRGVzY3JpcHRpb25zKSB7XHJcbiAgICBpZiAoIXBhcmFtRGVzY3JpcHRpb25zKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhwYXJhbXMpO1xyXG4gICAga2V5cy5mb3JFYWNoKGtleSA9PiB7XHJcbiAgICAgIGlmICghcGFyYW1EZXNjcmlwdGlvbnNba2V5XSB8fCAhcGFyYW1EZXNjcmlwdGlvbnNba2V5XS50eXBlKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBwYXJUeXBlID0gcGFyYW1EZXNjcmlwdGlvbnNba2V5XS50eXBlO1xyXG4gICAgICBjb25zdCB2YWx1ZSA9IHBhcmFtc1trZXldO1xyXG4gICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB0eXBlb2YgdmFsdWUgPT09IHBhclR5cGUpIHtcclxuICAgICAgICByZXR1cm47IC8vIOWAvOS4jeWtmOWcqOaIluexu+Wei+WMuemFje+8jOaXoOmcgOWkhOeQhlxyXG4gICAgICB9XHJcblxyXG4gICAgICBzd2l0Y2ggKHBhclR5cGUpIHtcclxuICAgICAgICBjYXNlICdzdHJpbmcnOlxyXG4gICAgICAgICAgLy8g5YW25a6e6L2s5o2i5YmN55qE5Y+C5pWw6YO95pivc3RyaW5n77yM6L+Z6YeM5LiN5Lya6LWw5YiwXHJcbiAgICAgICAgICBwYXJhbXNba2V5XSA9IHZhbHVlICsgJyc7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdpbnQnOlxyXG4gICAgICAgIGNhc2UgJ2RvdWJsZSc6XHJcbiAgICAgICAgY2FzZSAnbnVtYmVyJzpcclxuICAgICAgICAgIC8vIOWJjeerr+aVsOWAvOexu+Wei+WPquaciW51bWJlcu+8jOi/memHjOWFvOWuueWRveS7pOaehOS7tuS4iuiuvue9ruS4umludOWSjGRvdWJsZeeahOaDheWGtVxyXG4gICAgICAgICAgY29uc3QgbnVtUmVzdWx0ID0gTnVtYmVyKHZhbHVlKTtcclxuICAgICAgICAgIGlmIChpc05hTihudW1SZXN1bHQpKSB7XHJcbiAgICAgICAgICAgIHRocm93IEVycm9yKGDnsbvlnovovazmjaLlpLHotKXvvIzlj4LmlbAke2tleX3lgLzkuLoke3ZhbHVlfe+8jOaXoOazlei9rOaNouS4uiR7cGFyVHlwZX3nsbvlnovjgIJgKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHBhcmFtc1trZXldID0gbnVtUmVzdWx0O1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICBsZXQgYm9vbFJlc3VsdDogYm9vbGVhbjtcclxuICAgICAgICAgIGNvbnN0IHN0clZhbHVlID0gKHZhbHVlICsgJycpLnRvTG93ZXJDYXNlKCk7XHJcbiAgICAgICAgICBpZiAoc3RyVmFsdWUgPT09ICd0cnVlJykge1xyXG4gICAgICAgICAgICBib29sUmVzdWx0ID0gdHJ1ZTtcclxuICAgICAgICAgIH0gZWxzZSBpZiAoc3RyVmFsdWUgPT09ICdmYWxzZScpIHtcclxuICAgICAgICAgICAgYm9vbFJlc3VsdCA9IGZhbHNlO1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoYOexu+Wei+i9rOaNouWksei0pe+8jOWPguaVsCR7a2V5feWAvOS4uiR7dmFsdWV977yM5peg5rOV6L2s5o2i5Li6JHtwYXJUeXBlfeexu+Wei+OAgmApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGFyYW1zW2tleV0gPSBib29sUmVzdWx0O1xyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnZGF0ZXRpbWUnOlxyXG4gICAgICAgICAgLy8gdG9kb++8muaXpeacn+aXtumXtOaaguS4jeWkhOeQhlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAnb2JqZWN0JzpcclxuICAgICAgICAgIC8vIOihqOi+vuW8j+ino+aekOWHuuadpeeahOWPguaVsO+8jOaXoOmcgOWkhOeQhu+8jOaMieWOn+exu+Wei+i/lOWbnlxyXG4gICAgICAgICAgLy8gdG9kbzog6L6T5YWl5Y+C5pWw5piv5LiqanNvbuS4su+8jOi9rOaIkG9iamVjdFxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG59XHJcblxyXG4vKipcclxuICog5ZG95Luk5aSE55CG5Zmo5rOo5YWlVG9rZW5cclxuICovXHJcbmNvbnN0IENPTU1BTkRfSEFORExFUlNfVE9LRU4gPSBuZXcgSW5qZWN0aW9uVG9rZW48Q29tbWFuZEhhbmRsZXI+KCdARmFycmlzIENvbW1hbmQgSGFuZGxlcnMnKTtcclxuXHJcbmV4cG9ydCB7IENvbW1hbmRIYW5kbGVyLCBDT01NQU5EX0hBTkRMRVJTX1RPS0VOIH07XHJcbiJdfQ==