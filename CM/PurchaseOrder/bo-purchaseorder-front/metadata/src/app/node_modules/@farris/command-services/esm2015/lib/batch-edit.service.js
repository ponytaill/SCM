import { Injectable, Injector } from '@angular/core';
import { ViewModel, Repository, Entity, AppContext, EntityList } from '@farris/devkit';
import { from, EMPTY, concat, of, Subject } from 'rxjs';
import { concatMap, catchError, tap, switchMap, last, map, delay } from 'rxjs/operators';
import { BatchEditDialogService } from '@farris/ui-batch-edit-dialog';
import { DateTimeHelperService } from '@farris/ui-common/date';
import { ComponentManagerService } from './component-manager.service';
import { FormLoadingService } from './form-loading/form-loading.service';
import { LanguageService } from './languag.service';
import { FormNotifyService } from './form-notify.service';
// tslint:disable: max-line-length
/**
 * 批量编辑服务
 */
export class BatchEditService {
    constructor(injector, componentManagerService, viewModel, repository, batchEditDialogService, dateService, languageService, formNotifyService) {
        this.injector = injector;
        this.componentManagerService = componentManagerService;
        this.viewModel = viewModel;
        this.repository = repository;
        this.batchEditDialogService = batchEditDialogService;
        this.dateService = dateService;
        this.languageService = languageService;
        this.formNotifyService = formNotifyService;
        this.formLoadingService = this.injector.get(FormLoadingService, null);
        if (!this.languageService) {
            this.languageService = LanguageService.getInstance();
        }
        if (!this.formNotifyService) {
            this.formNotifyService = this.injector.get(FormNotifyService, null);
        }
        this.onHelpClose = new Subject();
        this.onHelpClose.subscribe(result => {
            const { frameId = '', mapFields = '', data = [] } = result || {};
            this.onHelpCloseHandler(frameId, mapFields, data);
        });
    }
    /**
     * 打开批量编辑对话框
     * @param frameId frameId
     */
    openBatchEditDialog(frameId) {
        if (!frameId) {
            throw new Error('frameId is required.');
        }
        if (this.batchEditDialogService) {
            let columns = [];
            if (this.viewModel) {
                const gridFrameContext = this.viewModel.frameContext.root.appContext.frameContextManager.getFrameContextById(frameId);
                const gridViewModel = gridFrameContext.viewModel;
                if (gridViewModel && gridViewModel.hasOwnProperty('dataGridColumnsName')) {
                    // tslint:disable-next-line: no-string-literal
                    const gridColumnsAttrName = gridViewModel['dataGridColumnsName'];
                    columns = gridViewModel[gridColumnsAttrName];
                }
                else if (gridViewModel && gridViewModel.hasOwnProperty('dataGridColumns')) {
                    columns = gridViewModel['dataGridColumns'];
                }
                const ids = gridViewModel.uiState['ids'] || [];
                if (!ids || ids.length < 1) {
                    this.formNotifyService.warning(this.languageService.plsCheckBatchEditRows, { hideTitle: true });
                    return EMPTY;
                }
                const dialogRef = this.batchEditDialogService.batchEdit(columns, {
                    rows: ids.length,
                    onConfirm: (inputs) => {
                        if (Array.isArray(ids) && ids.length > 0) {
                            // console.log('openBatchEditDialog', inputs);
                            const appContext = this.viewModel.frameContext.appContext;
                            appContext.changeDetectionController.detach();
                            inputs.forEach(input => {
                                this.updateBindingData(input, ids);
                            });
                            appContext.changeDetectionController.reattach();
                        }
                        dialogRef.close();
                    }
                });
            }
        }
    }
    /**
     * 打开隐藏帮助
     * @param helpId 帮助id
     */
    openHiddenHelp(helpId) {
        if (!helpId) {
            throw new Error('Argument error,helpId can`t be empty');
        }
        const componentManagerService = this.componentManagerService.getControl(helpId);
        if (componentManagerService) {
            componentManagerService.showDialog();
        }
        else {
            throw new Error(`the component which id is ${helpId} can't be found!`);
        }
    }
    /**
     * 清空帮助勾选（只能挂载到帮助前事件）
     */
    clearHelpSelections() {
        const self = this;
        const helpElement = self.context && self.context.eventParam && self.context.eventParam.instance || null;
        if (helpElement) {
            helpElement.displayValue = '';
        }
    }
    /**
     * 勾选当前行
     * @param frameId frameId
     * @param mapFields 字段映射
     * @param primaryKeyValue 帮助主键字段
     */
    checkCurrentRow(frameId, mapFields, primaryKeyValue) {
        const self = this;
        const helpElement = self.context && self.context.eventParam && self.context.eventParam.instance || null;
        if (!primaryKeyValue) {
            primaryKeyValue = 'id';
        }
        const mappings = JSON.parse(mapFields);
        if (helpElement) {
            frameId = frameId || this.viewModel.frameContext.frameId;
            if (frameId) {
                const frameContext = this.getFrameContextById(frameId);
                if (frameContext) {
                    const bindingPath = frameContext.viewModel.bindingPath;
                    if (bindingPath) {
                        const bindingPaths = bindingPath.split('/').filter(p => p);
                        const bindingList = frameContext.bindingData.getValue(bindingPaths);
                        const currentRow = bindingList.currentItem;
                        const path = mappings[primaryKeyValue];
                        if (path) {
                            const value = this.getValueByPath(currentRow, path);
                            helpElement.displayValue = value;
                        }
                    }
                }
            }
        }
    }
    /**
     * 以帮助勾选数据作为依据，批量新增主表数据
     * @param frameId 主表所在frame的id
     * @param mapFields 帮助字段与主表字段映射
     * @description 以帮助勾选数据作为依据，批量新增主表数据
     */
    batchAppend(frameId, mapFields) {
        const self = this;
        const result = self.context && self.context.eventParam || [];
        if (!mapFields) {
            throw new Error('mapFields can`t be empty.');
        }
        if (result && Array.isArray(result) && result.length > 0) {
            const mappings = JSON.parse(mapFields);
            // 不是bindingPath则按frameId处理
            let bindingPath = '/';
            const appContext = this.injector.get(AppContext, null);
            if (appContext) {
                const frameContext = appContext.frameContextManager.getFrameContextById(frameId);
                if (frameContext) {
                    bindingPath = frameContext.viewModel.bindingPath || '/';
                }
                else {
                    throw new Error('frameId is invalid!');
                }
            }
            const defaultValues = [];
            result.forEach((item) => {
                const defaultValue = {};
                Object.keys(mappings).forEach((prop) => {
                    const value = this.getValueByPath(item, prop);
                    const fields = mappings[prop];
                    const groups = fields.split(',').filter(p => p);
                    groups.forEach(group => {
                        const paths = group.split('.').filter(p => p);
                        this.setValueByPath(defaultValue, paths.join('.'), value);
                    });
                });
                defaultValues.push(defaultValue);
            });
            this.formLoadingService.show();
            return this.repository.batchAppend(defaultValues).pipe(tap(() => this.formLoadingService.hide()), map(() => true));
        }
        return of(true);
    }
    /**
     * 以帮助勾选数据作为依据，批量新增从表/从从表
     * @param frameId 从表/从从表所在frame的id
     * @param mapFields 帮助字段与从表/从从表字段映射
     * @description 以帮助勾选数据作为依据，批量新增从表/从从表
     */
    batchAppendByPathBasedOnHelpSelections(frameId, mapFields) {
        const self = this;
        const result = self.context && self.context.eventParam || [];
        if (!mapFields) {
            throw new Error('mapFields can`t be empty.');
        }
        if (result && Array.isArray(result) && result.length > 0) {
            const mappings = JSON.parse(mapFields);
            // 不是bindingPath则按frameId处理
            let bindingPath = '/';
            const appContext = this.injector.get(AppContext, null);
            if (appContext) {
                const frameContext = appContext.frameContextManager.getFrameContextById(frameId);
                if (frameContext) {
                    bindingPath = frameContext.viewModel.bindingPath || '/';
                }
                else {
                    throw new Error('frameId is invalid!');
                }
            }
            const defaultValues = [];
            result.forEach((item) => {
                const defaultValue = {};
                Object.keys(mappings).forEach((prop) => {
                    const value = this.getValueByPath(item, prop);
                    const fields = mappings[prop];
                    const groups = fields.split(',').filter(p => p);
                    groups.forEach(group => {
                        const paths = group.split('.').filter(p => p);
                        this.setValueByPath(defaultValue, paths.join('.'), value);
                    });
                });
                defaultValues.push(defaultValue);
            });
            this.formLoadingService.show();
            const path = this.buildPath(bindingPath, this.viewModel.bindingData.list.currentId);
            return this.repository.batchAppendByPath(path, defaultValues).pipe(tap(() => this.formLoadingService.hide()), map(() => true));
        }
        return of(true);
    }
    /**
     * 行内帮助多选批量新增或替换子表数据
     * @param frameId frameId, optional,为空时使用命令执行时所在的上下文
     * @param mapFields 字段映射
     * @returns
     */
    batchAppendBasedOnRowHelpSelections(frameId, mapFields) {
        const self = this;
        let result = self.context && self.context.eventParam || [];
        if (!mapFields) {
            return of(true);
        }
        const mappings = JSON.parse(mapFields);
        if (!mappings || !mappings.hasOwnProperty('id')) {
            return of(true);
        }
        frameId = frameId || this.viewModel.frameContext.frameId;
        if (!frameId) {
            return of(true);
        }
        const frameContext = this.getFrameContextById(frameId);
        if (!frameContext) {
            return of(true);
        }
        setTimeout(() => {
            this.endEdit(frameContext).subscribe(() => {
                if (result && Array.isArray(result) && result.length > 0) {
                    const bindingPath = frameContext.viewModel.bindingPath || '/';
                    const bindingPaths = bindingPath.split('/').filter(p => p);
                    const defaultValues = [];
                    // 获取当前行
                    const bindingList = frameContext.bindingData.getValue(bindingPaths);
                    const currentRow = bindingList.currentItem;
                    const currentRowId = bindingList.currentId;
                    const currentEntity = this.getEntityByPath(frameContext, bindingPaths, currentRowId);
                    const headItem = result[0];
                    // 如果仅勾选一条，则应替换当前行的映射
                    if (result.length === 1) {
                        this.mappingRow(headItem, mappings, currentEntity, bindingPath);
                        return of(true);
                    }
                    else {
                        const idMapField = mappings['id'];
                        const sourceItemId = this.getValueByPath(currentEntity, idMapField);
                        // 如果当前行没有映射或勾选结果中找不到当前行的映射
                        if (!sourceItemId || result.findIndex(item => item[bindingList.primaryKey] === sourceItemId) === -1) {
                            // 重新映射当前行
                            this.mappingRow(headItem, mappings, currentEntity, bindingPath);
                            result = result.slice(1);
                        }
                        else if (sourceItemId) {
                            const index = result.findIndex(item => item[bindingList.primaryKey] === sourceItemId);
                            // 重新映射当前行
                            this.mappingRow(result[index], mappings, currentEntity, bindingPath);
                            result.splice(index, 1);
                        }
                        // 当前行处理完成
                        // 处理未映射的行
                        const emptyRows = bindingList.toArray().filter(bindingObject => {
                            const id = this.getValueByPath(bindingObject, mappings[bindingList.primaryKey]);
                            return !id;
                        });
                        if (emptyRows && emptyRows.length > 0) {
                            let rows = result;
                            if (result.length > emptyRows.length) {
                                rows = result.slice(0, emptyRows.length);
                                result = result.slice(emptyRows.length);
                            }
                            else {
                                result = [];
                            }
                            rows.forEach((item, index) => {
                                const targetItem = emptyRows[index];
                                const entity = this.getEntityByPath(frameContext, bindingPaths, targetItem.primaryKeyValue);
                                this.mappingRow(item, mappings, entity, bindingPath);
                            });
                        }
                        // 处理剩余勾选
                        result.forEach((item) => {
                            const defaultValue = {};
                            Object.keys(mappings).forEach((prop) => {
                                const value = this.getValueByPath(item, prop);
                                const fields = mappings[prop];
                                const groups = fields.split(',').filter(p => p);
                                groups.forEach(group => {
                                    const paths = group.split('.').filter(p => p);
                                    this.setValueByPath(defaultValue, paths.join('.'), value);
                                });
                            });
                            defaultValues.push(defaultValue);
                        });
                        if (defaultValues.length > 0) {
                            this.formLoadingService.show();
                            const path = this.buildPath(bindingPath, this.viewModel.bindingData.list.currentId);
                            this.repository.batchAppendByPath(path, defaultValues).pipe(tap(() => this.formLoadingService.hide())).subscribe();
                        }
                    }
                }
            });
        }, 100);
        return of(true);
    }
    /**
     * 复制主表数据
     * @param id 要复制的数据id
     * @param fields 要复制的字段
     * @description 仅支持复制主表数据
     * @deprecated 该方法已被废弃，请使用clone方法替代。
     */
    copy(id) {
        if (!id) {
            this.formNotifyService.warning(this.languageService.plsSelectCopyData, { hideTitle: true });
            return EMPTY;
        }
        const befRepository = this.repository;
        const baseUri = befRepository.restService.baseUri;
        const url = `${baseUri}/service/copymainobjvoaction`;
        const requestInfo = befRepository.restService.buildRequestInfo();
        const body = {
            requestInfo,
            dataID: id
        };
        const options = {
            body
        };
        this.formLoadingService.show();
        return befRepository.proxy.request(url, 'PUT', null, options).pipe(tap(() => {
            this.formLoadingService.hide();
        }), map((responseInfo) => {
            const returnValue = responseInfo.returnValue;
            const entity = this.repository.buildEntity(returnValue);
            this.repository.entityCollection.addEntity(entity);
            return entity;
        }));
    }
    /**
     * 复制数据（支持主表、从表、从从表）
     * @param id 要复制的行
     * @param path 请求路径
     * @returns
     */
    clone(id, path) {
        if (!id) {
            this.formNotifyService.warning(this.languageService.plsSelectCopyData, { hideTitle: true });
            return EMPTY;
        }
        if (!path) {
            this.formNotifyService.warning(this.languageService.pathIsRequired, { hideTitle: true });
            return EMPTY;
        }
        if (!path.startsWith('/')) {
            path = '/' + path;
        }
        path = path.toLowerCase();
        const bindingPath = this.viewModel.bindingPath;
        const befRepository = this.repository;
        const baseUri = befRepository.restService.baseUri;
        const url = `${baseUri}${path}`;
        const requestInfo = befRepository.restService.buildRequestInfo();
        const ids = this.buildIds(bindingPath);
        ids.push(id);
        const body = {
            requestInfo,
            dataID: ids.join(',')
        };
        const options = {
            body
        };
        this.formLoadingService.show();
        return befRepository.proxy.request(url, 'PUT', null, options).pipe(tap(() => {
            this.formLoadingService.hide();
        }), map((responseInfo) => {
            const returnValue = responseInfo.returnValue;
            let entity = null;
            if (bindingPath.split('/').filter(p => p).length === 0) {
                entity = this.repository.buildEntity(returnValue);
                this.repository.entityCollection.addEntity(entity, true);
            }
            else {
                const fpath = this.buildPath(bindingPath, this.viewModel.bindingData.list.currentId);
                entity = befRepository.entityManager.appendEntityByPath(fpath, returnValue, returnValue, true);
            }
            return entity;
        }));
    }
    //#region 旧的实现
    /**
     * 复制行
     * @param frameId frameId
     * @param ignoreFields 复制时忽略字段
     * @param repeat 重复复制次数，默认为1
     */
    copyRow(frameId, ignoreFields, repeat = 1) {
        if (typeof repeat !== 'number') {
            repeat = parseInt(repeat, 10);
        }
        if (repeat < 1) {
            throw new Error('ArgumentError: repeat must >= 1');
        }
        // 获取当前行
        const frameContext = this.viewModel.frameContext.appContext.frameContextManager.getFrameContextById(frameId);
        const primaryValue = frameContext.bindingData.list.currentId;
        const bindingPath = frameContext.viewModel.bindingPath || '/';
        let bindingData = null;
        let currentItem = null;
        if (bindingPath === '/') {
            // 主表直接取当前行
            currentItem = frameContext.bindingData.list.currentItem;
        }
        else {
            // 取从表/从从表当前行
            const paths = bindingPath.split('/').filter(p => p);
            currentItem = frameContext.bindingData.getValue(paths).currentItem;
        }
        bindingData = currentItem.toJSON();
        if (!currentItem.primaryKeyValue) {
            if (this.formNotifyService) {
                this.formNotifyService.warning(this.languageService.plsSelectCopyData, { hideTitle: true });
            }
            return EMPTY;
        }
        const ignoreFieldsArray = ignoreFields.split(',').filter(item => item);
        const sources = new Array(repeat);
        return from(sources).pipe(concatMap(() => {
            let action$ = null;
            if (bindingPath !== '/') {
                const fullPath = this.buildPath(bindingPath, primaryValue);
                action$ = this.repository.appendByPath(fullPath);
            }
            else {
                action$ = this.repository.append();
            }
            return action$.pipe(tap((entity) => {
                // 修正实体主键
                bindingData[entity.primaryKey] = entity.primaryValue;
                // 忽略指定字段
                ignoreFieldsArray.forEach((field) => {
                    const extractedFields = field.split('.').filter(item => item);
                    if (extractedFields.length === 1) {
                        delete bindingData[field];
                    }
                    const parent = extractedFields.slice(0, -1).reduce((prev, current, index) => {
                        return prev[current];
                    }, bindingData);
                    delete parent[extractedFields[extractedFields.length - 1]];
                });
                bindingData = Object.assign({}, entity.toJSON(), bindingData);
                entity.load(bindingData, { loadChild: false });
            }), catchError(() => {
                return EMPTY;
            }));
        }));
    }
    /**
     * 增量多选帮助批量赋值帮助后事件
     * @param frameId frameId
     * @param mapFields 字段映射
     * @param associatedField 关联字段
     */
    afterIncrementalSelectHelpClose(frameId, mapFields, associatedField) {
        const self = this;
        const result = self.context && self.context.eventParam || [];
        // tslint:disable-next-line: max-line-length
        // const mapping = '{"id":"userRef.userRef", "name":"name", "sex":"sex","age":"userRef.userRef_Age","address":"userRef.userRef_Address","birthday":"userRef.userRef_Birthday","height":"userRef.userRef_Height","isMarried":"userRef.userRef_IsMarried"}';
        if (!associatedField) {
            throw new Error('associated field can`t be empty.');
        }
        if (!mapFields) {
            throw new Error('mapFields can`t be empty.');
        }
        const mappings = JSON.parse(mapFields);
        const foreignKey = associatedField;
        // 将选择人员保存到uistate中
        const rootFrameContext = this.viewModel.frameContext.root;
        // 不是bindingPath则按frameId处理
        let bindingPath = '/';
        const appContext = this.injector.get(AppContext, null);
        if (appContext) {
            const frameContext = appContext.frameContextManager.getFrameContextById(frameId);
            if (frameContext) {
                bindingPath = frameContext.viewModel.bindingPath || '/';
            }
            else {
                throw new Error('frameId is invalid!');
            }
        }
        // tslint:disable-next-line: no-string-literal
        rootFrameContext.uiState['selections'] = result;
        if (result && Array.isArray(result)) {
            // 根据bindingPath获取bindingdata中现有数据
            const bindingPaths = bindingPath.split('/').filter(item => item);
            const currentData = this.viewModel.bindingData.getValue(bindingPaths);
            const currentDataArray = currentData.toArray();
            // 找到result中有，但bindingData中没有的，为待新增项
            const appends = [];
            result.reduce((prev, item) => {
                const itemId = item && item[currentData.primaryKey] || null;
                const isExist = currentDataArray.find((bindingObject) => bindingObject[foreignKey][foreignKey] === itemId);
                if (!isExist) {
                    prev.push(item);
                }
                return prev;
            }, appends);
            // 找到bindingData中有，result中没有的，为待删除项
            const removes = [];
            currentDataArray.reduce((results, item) => {
                const index = result.findIndex(selectItem => selectItem[currentData.primaryKey] === item[foreignKey][foreignKey]);
                if (index === -1) {
                    results.push(item.primaryKeyValue);
                }
                return results;
            }, removes);
            // console.log('addItems', appends, 'removeItems', removes);
            // 调用后端接口新增数据
            const addAction$ = from(appends).pipe(concatMap(item => {
                const path = this.buildPath(bindingPath, this.viewModel.bindingData.list.currentId);
                return this.repository.appendByPath(path).pipe(tap((entity) => {
                    Object.keys(mappings).forEach(prop => {
                        const value = this.getValueByPath(item, prop);
                        const fields = mappings[prop];
                        const groups = fields.split(',').filter(p => p);
                        groups.forEach(group => {
                            const paths = group.split('.').filter(p => p);
                            this.setValueByPath(entity, paths.join('.'), value);
                        });
                    });
                }), catchError(() => {
                    return EMPTY;
                }));
            }));
            const removeAction$ = from(removes).pipe(concatMap(item => {
                const path = this.buildPath(bindingPath, this.viewModel.bindingData.list.currentId);
                return this.repository.removeByPath(path, item).pipe(tap(() => {
                    const befRepository = this.repository;
                    befRepository.entityManager.removeEntityByPath(path, item);
                }), catchError(() => {
                    return EMPTY;
                }));
            }));
            if (!appends && !removes || appends && appends.length < 1 && removes && removes.length < 1) {
                return of(true);
            }
            return concat(addAction$, removeAction$).pipe(catchError(() => EMPTY));
        }
        return of(true);
    }
    // todo:模拟用户操作，待后端接口支持主表批量新增后重写
    /**
     * 多选帮助批量赋值帮助前事件
     */
    beforeMultiSelectHelpOpen() {
        return this.clearHelpSelections();
    }
    /**
     * 多选帮助批量赋值帮助后事件
     * @param frameId 绑定路径
     * @param mapFields 字段映射
     * @param commandFrameId 回调命令所在frameId
     * @param commandName 回调命令
     * @deprecated 模拟用户操作，待批量赋值支持主表后废弃
     */
    afterMultiSelectHelpClose(frameId, mapFields, commandFrameId, commandName) {
        const self = this;
        const result = self.context && self.context.eventParam || [];
        if (result && Array.isArray(result)) {
            // 调用后端接口新增数据
            if (!result || result.length < 1) {
                return of(true);
            }
            this.onHelpClose.next({ frameId, mapFields, data: result, commandFrameId, commandName });
            return of(true);
        }
        return of(true);
    }
    /**
      * 帮助关闭后处理器
      * @param frameId frameid
      * @param mapFields mapFields
      * @param result 帮助数据结果
      */
    onHelpCloseHandler(frameId, mapFields, result) {
        if (!mapFields) {
            throw new Error('mapFields can`t be empty.');
        }
        const mappings = JSON.parse(mapFields);
        // 不是bindingPath则按frameId处理
        let bindingPath = '/';
        const appContext = this.injector.get(AppContext, null);
        if (appContext) {
            const frameContext = appContext.frameContextManager.getFrameContextById(frameId);
            if (frameContext) {
                bindingPath = frameContext.viewModel.bindingPath || '/';
            }
            else {
                throw new Error('frameId is invalid!');
            }
        }
        // 将选择人员保存到uistate中
        const rootFrameContext = this.viewModel.frameContext.root;
        const befRepository = this.repository;
        const bindingPaths = bindingPath.split('/').filter(p => p);
        // tslint:disable-next-line: no-string-literal
        rootFrameContext.uiState['selections'] = result;
        if (result && Array.isArray(result)) {
            const addAction$ = from(result).pipe(concatMap(item => {
                const requestInfo = befRepository.restService.buildRequestInfo();
                if (bindingPaths.length > 0) {
                    const path = this.buildPath(bindingPath, this.viewModel.bindingData.list.currentId);
                    return befRepository.restService.createByPath(path, requestInfo).pipe(tap((responseInfo) => {
                        const data = responseInfo.returnValue;
                        const newEntity = befRepository.entityManager.appendEntityByPath(path, data, data);
                        Object.keys(mappings).forEach(prop => {
                            const value = this.getValueByPath(item, prop);
                            const fields = mappings[prop];
                            const groups = fields.split(',').filter(p => p);
                            groups.forEach(group => {
                                const paths = group.split('.').filter(p => p);
                                this.setValueByPath(newEntity, paths.join('.'), value);
                            });
                        });
                        return newEntity;
                    }));
                }
                else {
                    return befRepository.restService.create(null, requestInfo).pipe(tap((responseInfo) => {
                        const data = responseInfo.returnValue;
                        const newEntity = this.repository.buildEntity(data);
                        Object.keys(mappings).forEach(prop => {
                            const value = this.getValueByPath(item, prop);
                            const fields = mappings[prop];
                            const groups = fields.split(',').filter(p => p);
                            groups.forEach(group => {
                                const paths = group.split('.').filter(p => p);
                                this.setValueByPath(newEntity, paths.join('.'), value);
                            });
                        });
                        this.repository.entityCollection.addEntity(newEntity);
                        return newEntity;
                    }));
                }
            }));
            // const formLoadingService = this.injector.get<FormLoadingService>(FormLoadingService, null);
            if (this.formLoadingService) {
                this.suspendFrameContextEvent(frameId);
                this.formLoadingService.show();
                this.formLoadingService.setSuspend(true);
            }
            return addAction$.pipe(last()).pipe(switchMap(() => {
                const primaryValue = this.viewModel.bindingData.list.currentId;
                if (primaryValue) {
                    return befRepository.updateChangesById(primaryValue);
                }
                else {
                    return of(null);
                }
            })).subscribe(() => {
                if (this.formLoadingService) {
                    this.resumeFrameContextEvent(frameId);
                    this.formLoadingService.setSuspend(false);
                    this.formLoadingService.hide();
                }
            }, () => {
                if (this.formLoadingService) {
                    this.resumeFrameContextEvent(frameId);
                    this.formLoadingService.setSuspend(false);
                    this.formLoadingService.hide();
                }
            });
        }
        return of(null);
    }
    suspendFrameContextEvent(frameId) {
        const appContext = this.injector.get(AppContext, null);
        if (appContext) {
            const frameContext = appContext.frameContextManager.getFrameContextById(frameId);
            frameContext.suspend = true;
        }
    }
    resumeFrameContextEvent(frameId) {
        const appContext = this.injector.get(AppContext, null);
        if (appContext) {
            const frameContext = appContext.frameContextManager.getFrameContextById(frameId);
            frameContext.suspend = false;
            frameContext.appContext.messagePipe.next('bindData');
        }
    }
    //#endregion
    setValueByPath(target, path, value) {
        if (target) {
            const paths = path.split('.');
            if (paths.length <= 1) {
                target[path] = value;
            }
            else {
                paths.slice(0, -1).reduce((prev, path) => {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    }
    getValueByPath(target, path) {
        const paths = path.split('.');
        if (paths.length < 1) {
            return;
        }
        if (paths.length === 1) {
            return target[path];
        }
        let result = null;
        paths.forEach((prop, index) => {
            if (index === 0) {
                result = target && target[prop] || null;
            }
            else {
                result = result && result[prop] || null;
            }
        });
        return result;
    }
    /**
     * 构造子表路径
     * @param bindingPath 绑定路径
     * @param id id
     */
    buildPath(bindingPath, id) {
        let path = '/' + id;
        const subPaths = bindingPath.split('/');
        if (subPaths.length > 0) {
            // eg:bindingPath形如/edus/grades,split后是['', 'edus', 'grades']
            // 因此index从1开始
            for (let index = 1; index < subPaths.length - 1; index++) {
                const subPath = subPaths[index];
                const subData = this.viewModel.bindingData[subPath];
                if (!subData || !subData.currentId) {
                    throw Error(`获取子表完整路径出错，找不到${subData}对应的子表，或对应子表没有当前行。`);
                }
                path += `/${subPath}/${subData.currentId}`;
            }
        }
        path += '/' + subPaths[subPaths.length - 1];
        return path;
    }
    /**
     * 获取绑定路径的当前行数组
     * @param bindingPath bindingPath
     * @returns
     */
    buildIds(bindingPath) {
        const bindingPaths = bindingPath.split('/').filter(p => p);
        const primaryValue = this.viewModel.bindingData.list.currentId;
        const result = [];
        const paths = [];
        if (bindingPaths.length > 0) {
            result.push(primaryValue);
            // 从表或从从表要复制的行不一定是当前行，用户可以指定
            bindingPaths.pop();
            bindingPaths.forEach((path) => {
                paths.push(path);
                const bindingList = this.viewModel.bindingData.getValue(paths);
                if (bindingList) {
                    result.push(bindingList.currentId);
                }
            });
        }
        return result;
    }
    updateBindingData(input, ids) {
        const { controlType = null, value = null, options = {}, dataType = null } = input || {};
        if (controlType) {
            // 对帮助做特殊处理
            if (controlType === 'lookup' || controlType === 'combo-lookup') {
                const mapFields = options.mapFields;
                this.updateLookupField(ids, value, mapFields);
            }
            else {
                this.updateSimpleField(ids, value, input);
            }
        }
    }
    updateSimpleField(ids, value, column) {
        if (!column) {
            return;
        }
        const currentColumnType = column.dataType;
        // 存在行编辑器
        let result = value;
        if (currentColumnType === 'date') {
            let dateStr = this.dateService.formatTo(value, 'yyyy-MM-dd');
            if (!dateStr) {
                dateStr = '0001-01-01T00:00:00';
            }
            result = dateStr;
        }
        else if (currentColumnType === 'number') {
            result = Number(value) || 0;
        }
        const field = column.field;
        ids.forEach(id => {
            this.updateBindingList(id, field, result);
        });
    }
    updateLookupField(ids, helpData, mapFields) {
        if (!mapFields) {
            return;
        }
        let helpFields = Object.keys(mapFields);
        const idIndex = helpFields.findIndex(item => item === 'id');
        if (helpFields.includes('id') && idIndex !== 0) {
            helpFields.splice(idIndex, 1);
            helpFields = ['id', ...helpFields];
        }
        helpFields.forEach((helpField) => {
            let helpValue = '';
            if (helpData) {
                if (helpData instanceof Array) {
                    helpValue = helpData.map((item) => {
                        return this.getValue(helpField, item);
                    }).join(',');
                }
                else {
                    helpValue = this.getValue(helpField, helpData);
                }
            }
            ids.forEach(id => {
                this.updateBindingList(id, mapFields[helpField], helpValue);
            });
        });
    }
    updateBindingList(primaryValue, propertyName, value) {
        const viewModel = this.viewModel || null;
        if (!viewModel || !propertyName) {
            return;
        }
        // 更新主表部分行的字段
        const propertyNames = propertyName.split('.').filter(item => item);
        const bindingObject = this.bindingList.findById(primaryValue);
        if (propertyNames.length < 2) {
            bindingObject.setValue(propertyName, value, true, true);
        }
        else {
            let targetBindingObject = null;
            const fpaths = propertyNames.slice(0, propertyNames.length - 1);
            const targetPropertyName = propertyNames[propertyNames.length - 1];
            fpaths.forEach(prop => {
                targetBindingObject = targetBindingObject && targetBindingObject[prop] || bindingObject[prop];
            });
            // todo:需要添加值变化事件
            targetBindingObject.setValue(targetPropertyName, value, true, true);
        }
    }
    getBindingPathArray() {
        const path = this.viewModel.bindingPath;
        if (path) {
            return path.split('/').filter(n => n !== '');
        }
        return [];
    }
    getValue(f, data) {
        let val = '';
        if (f.indexOf('.') === -1) {
            val = data[f];
        }
        else {
            val = f.split('.').reduce((a, b) => {
                return a[b];
            }, data);
        }
        return val;
    }
    get bindingList() {
        // 根实体
        if (this.viewModel.bindingPath === '/' || !this.viewModel.bindingPath) {
            return this.viewModel.bindingData.list;
        }
        // 子实体
        let bindingPath = this.viewModel.bindingPath.substr(1);
        bindingPath = bindingPath[0].toLowerCase() + bindingPath.substring(1, bindingPath.length);
        const paths = bindingPath.split('/');
        const filteredPaths = paths.filter((part) => {
            return part !== '';
        });
        return this.viewModel.bindingData.getValue(filteredPaths);
    }
    /**
     * 根据映射将数据赋值给bindingData
     * @param data
     * @param mapFields
     * @param bindingData
     */
    mappingRow(data, mapFields, entity, bindingPath) {
        Object.keys(mapFields).forEach((prop) => {
            const value = this.getValueByPath(data, prop);
            const fields = mapFields[prop];
            const groups = fields.split(',').filter(p => p);
            groups.forEach(group => {
                const paths = group.split('.').filter(p => p);
                this.setValueByPath(entity, paths.join('.'), value);
            });
        });
    }
    /**
     * 通过frameId获取对应的组件上下文
     * @param frameId frameId
     * @returns
     */
    getFrameContextById(frameId) {
        if (!frameId) {
            return null;
        }
        const appContext = this.injector.get(AppContext, null);
        let frameContext = null;
        if (appContext) {
            frameContext = appContext.frameContextManager.getFrameContextById(frameId);
        }
        return frameContext;
    }
    getEntityByPath(frameContext, bindingPaths, currentId) {
        bindingPaths = [...bindingPaths];
        const id = frameContext.bindingData.list.currentId;
        const entity = frameContext.repository.entityCollection.getEntityById(id);
        let item = entity;
        const paths = [];
        const tailPath = bindingPaths.pop();
        const parent = bindingPaths.reduce((object, path) => {
            paths.push(path);
            if (object && (object.hasOwnProperty(path) || object['__proto__'].hasOwnProperty(path))) {
                const value = object[path];
                if (value && value instanceof EntityList) {
                    const bindingList = frameContext.bindingData.getValue(paths);
                    const currentItemId = bindingList.currentId;
                    return value.get(currentItemId);
                }
                else {
                    return value;
                }
            }
            else {
                return null;
            }
        }, item);
        if (parent instanceof Entity) {
            const list = parent[tailPath];
            if (list) {
                return list.get(currentId);
            }
            else {
                throw new Error(`无效的bindingPath.`);
            }
        }
        else {
            throw new Error(`无效的bindingPath.`);
        }
    }
    endEdit(frameContext) {
        const appContext = frameContext && frameContext.getFormAppContext();
        return of(null).pipe(tap(() => {
            if (appContext) {
                appContext.messagePipe.next({ type: 'endEdit' });
            }
        }), 
        // todo: 不应该使用delay，应该串流
        delay(5));
    }
}
BatchEditService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
BatchEditService.ctorParameters = () => [
    { type: Injector },
    { type: ComponentManagerService },
    { type: ViewModel },
    { type: Repository },
    { type: BatchEditDialogService },
    { type: DateTimeHelperService },
    { type: LanguageService },
    { type: FormNotifyService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmF0Y2gtZWRpdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2JhdGNoLWVkaXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUMvRCxPQUFPLEVBQWUsU0FBUyxFQUFpQixVQUFVLEVBQUUsTUFBTSxFQUE2QixVQUFVLEVBQWlELFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzdMLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsT0FBTyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxTQUFTLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV6RixPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUN0RSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDcEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFMUQsa0NBQWtDO0FBQ2xDOztHQUVHO0FBRUgsTUFBTSxPQUFPLGdCQUFnQjtJQUczQixZQUNVLFFBQWtCLEVBQ2xCLHVCQUFnRCxFQUNoRCxTQUFvQixFQUNwQixVQUEyQixFQUMzQixzQkFBOEMsRUFDOUMsV0FBa0MsRUFDbEMsZUFBZ0MsRUFDaEMsaUJBQW9DO1FBUHBDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxjQUFTLEdBQVQsU0FBUyxDQUFXO1FBQ3BCLGVBQVUsR0FBVixVQUFVLENBQWlCO1FBQzNCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFDOUMsZ0JBQVcsR0FBWCxXQUFXLENBQXVCO1FBQ2xDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBRTVDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBcUIsa0JBQWtCLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDMUYsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDdEQ7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFO1lBQzNCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBb0IsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDeEY7UUFDRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksT0FBTyxFQUFPLENBQUM7UUFDdEMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDbEMsTUFBTSxFQUFFLE9BQU8sR0FBRyxFQUFFLEVBQUUsU0FBUyxHQUFHLEVBQUUsRUFBRSxJQUFJLEdBQUcsRUFBRSxFQUFFLEdBQUcsTUFBTSxJQUFJLEVBQUUsQ0FBQztZQUNqRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNwRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7O09BR0c7SUFDSSxtQkFBbUIsQ0FBQyxPQUFlO1FBQ3hDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUM7U0FDekM7UUFDRCxJQUFJLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtZQUMvQixJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDakIsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixNQUFNLGdCQUFnQixHQUFpQixJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNwSSxNQUFNLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUM7Z0JBQ2pELElBQUksYUFBYSxJQUFJLGFBQWEsQ0FBQyxjQUFjLENBQUMscUJBQXFCLENBQUMsRUFBRTtvQkFDeEUsOENBQThDO29CQUM5QyxNQUFNLG1CQUFtQixHQUFHLGFBQWEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO29CQUNqRSxPQUFPLEdBQUcsYUFBYSxDQUFDLG1CQUFtQixDQUFDLENBQUM7aUJBQzlDO3FCQUFNLElBQUksYUFBYSxJQUFJLGFBQWEsQ0FBQyxjQUFjLENBQUMsaUJBQWlCLENBQUMsRUFBRTtvQkFDM0UsT0FBTyxHQUFHLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO2lCQUM1QztnQkFDRCxNQUFNLEdBQUcsR0FBYSxhQUFhLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDekQsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDMUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLHFCQUFxQixFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7b0JBQ2hHLE9BQU8sS0FBSyxDQUFDO2lCQUNkO2dCQUNELE1BQU0sU0FBUyxHQUFRLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFO29CQUNwRSxJQUFJLEVBQUUsR0FBRyxDQUFDLE1BQU07b0JBQ2hCLFNBQVMsRUFBRSxDQUFDLE1BQWtCLEVBQUUsRUFBRTt3QkFDaEMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFOzRCQUN4Qyw4Q0FBOEM7NEJBQzlDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQzs0QkFDMUQsVUFBVSxDQUFDLHlCQUF5QixDQUFDLE1BQU0sRUFBRSxDQUFDOzRCQUM5QyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dDQUNyQixJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDOzRCQUNyQyxDQUFDLENBQUMsQ0FBQzs0QkFDSCxVQUFVLENBQUMseUJBQXlCLENBQUMsUUFBUSxFQUFFLENBQUM7eUJBQ2pEO3dCQUNELFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDcEIsQ0FBQztpQkFDRixDQUFDLENBQUM7YUFDSjtTQUNGO0lBQ0gsQ0FBQztJQUNEOzs7T0FHRztJQUNJLGNBQWMsQ0FBQyxNQUFjO1FBQ2xDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7U0FDekQ7UUFDRCxNQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDaEYsSUFBSSx1QkFBdUIsRUFBRTtZQUMzQix1QkFBdUIsQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUN0QzthQUFNO1lBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsTUFBTSxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3hFO0lBQ0gsQ0FBQztJQUNEOztPQUVHO0lBQ0ksbUJBQW1CO1FBQ3hCLE1BQU0sSUFBSSxHQUFRLElBQUksQ0FBQztRQUN2QixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUM7UUFDeEcsSUFBSSxXQUFXLEVBQUU7WUFDZixXQUFXLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztTQUMvQjtJQUNILENBQUM7SUFDRDs7Ozs7T0FLRztJQUNJLGVBQWUsQ0FBQyxPQUFlLEVBQUUsU0FBaUIsRUFBRSxlQUF1QjtRQUNoRixNQUFNLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdkIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDO1FBQ3hHLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDcEIsZUFBZSxHQUFHLElBQUksQ0FBQztTQUN4QjtRQUNELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdkMsSUFBSSxXQUFXLEVBQUU7WUFDZixPQUFPLEdBQUcsT0FBTyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQztZQUN6RCxJQUFJLE9BQU8sRUFBRTtnQkFDWCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3ZELElBQUksWUFBWSxFQUFFO29CQUNoQixNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztvQkFDdkQsSUFBSSxXQUFXLEVBQUU7d0JBQ2YsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDM0QsTUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFnQixDQUFDO3dCQUNuRixNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDO3dCQUMzQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsZUFBZSxDQUFDLENBQUM7d0JBQ3ZDLElBQUksSUFBSSxFQUFFOzRCQUNSLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDOzRCQUNwRCxXQUFXLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQzt5QkFDbEM7cUJBQ0Y7aUJBQ0Y7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ksV0FBVyxDQUFDLE9BQWUsRUFBRSxTQUFpQjtRQUNuRCxNQUFNLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDN0QsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUM5QztRQUNELElBQUksTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDeEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUN2QywyQkFBMkI7WUFDM0IsSUFBSSxXQUFXLEdBQUcsR0FBRyxDQUFDO1lBQ3RCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFhLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUNuRSxJQUFJLFVBQVUsRUFBRTtnQkFDZCxNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ2pGLElBQUksWUFBWSxFQUFFO29CQUNoQixXQUFXLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLElBQUksR0FBRyxDQUFDO2lCQUN6RDtxQkFBTTtvQkFDTCxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7aUJBQ3hDO2FBQ0Y7WUFDRCxNQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7WUFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO2dCQUN0QixNQUFNLFlBQVksR0FBRyxFQUFFLENBQUM7Z0JBQ3hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBWSxFQUFFLEVBQUU7b0JBQzdDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUM5QyxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7b0JBQzlCLE1BQU0sTUFBTSxHQUFVLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZELE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7d0JBQ3JCLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQzlDLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQzVELENBQUMsQ0FBQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUNILGFBQWEsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDbkMsQ0FBQyxDQUFDLENBQUM7WUFDSCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDL0IsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQ3BELEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUMsRUFDekMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUNoQixDQUFDO1NBQ0g7UUFDRCxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsQixDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSxzQ0FBc0MsQ0FBQyxPQUFlLEVBQUUsU0FBaUI7UUFDOUUsTUFBTSxJQUFJLEdBQVEsSUFBSSxDQUFDO1FBQ3ZCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO1FBQzdELElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7U0FDOUM7UUFDRCxJQUFJLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3hELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDdkMsMkJBQTJCO1lBQzNCLElBQUksV0FBVyxHQUFHLEdBQUcsQ0FBQztZQUN0QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBYSxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDbkUsSUFBSSxVQUFVLEVBQUU7Z0JBQ2QsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNqRixJQUFJLFlBQVksRUFBRTtvQkFDaEIsV0FBVyxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxJQUFJLEdBQUcsQ0FBQztpQkFDekQ7cUJBQU07b0JBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2lCQUN4QzthQUNGO1lBQ0QsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDdEIsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDO2dCQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVksRUFBRSxFQUFFO29CQUM3QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFDOUMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUM5QixNQUFNLE1BQU0sR0FBVSxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN2RCxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO3dCQUNyQixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUM5QyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUM1RCxDQUFDLENBQUMsQ0FBQztnQkFDTCxDQUFDLENBQUMsQ0FBQztnQkFDSCxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1lBQ25DLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDO1lBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNwRixPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDLElBQUksQ0FDaEUsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUN6QyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQ2hCLENBQUM7U0FDSDtRQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFDRDs7Ozs7T0FLRztJQUNJLG1DQUFtQyxDQUFDLE9BQWUsRUFBRSxTQUFpQjtRQUMzRSxNQUFNLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdkIsSUFBSSxNQUFNLEdBQVUsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDbEUsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO1FBQ0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN2QyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMvQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUNELE9BQU8sR0FBRyxPQUFPLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDO1FBQ3pELElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUNELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsWUFBWSxFQUFFO1lBQ2pCLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO1FBQ0QsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtnQkFDeEMsSUFBSSxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtvQkFDeEQsTUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLElBQUksR0FBRyxDQUFDO29CQUM5RCxNQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUMzRCxNQUFNLGFBQWEsR0FBRyxFQUFFLENBQUM7b0JBQ3pCLFFBQVE7b0JBQ1IsTUFBTSxXQUFXLEdBQWdCLFlBQVksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBZ0IsQ0FBQztvQkFDaEcsTUFBTSxVQUFVLEdBQUcsV0FBVyxDQUFDLFdBQVcsQ0FBQztvQkFDM0MsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQztvQkFDM0MsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsWUFBWSxFQUFFLFlBQVksQ0FBQyxDQUFDO29CQUNyRixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzNCLHFCQUFxQjtvQkFDckIsSUFBSSxNQUFNLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTt3QkFDdkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQzt3QkFDaEUsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7cUJBQ2pCO3lCQUFNO3dCQUNMLE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDbEMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsVUFBVSxDQUFDLENBQUM7d0JBQ3BFLDJCQUEyQjt3QkFDM0IsSUFBSSxDQUFDLFlBQVksSUFBSSxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsS0FBSyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTs0QkFDbkcsVUFBVTs0QkFDVixJQUFJLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDOzRCQUNoRSxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQzt5QkFDMUI7NkJBQU0sSUFBSSxZQUFZLEVBQUU7NEJBQ3ZCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLFlBQVksQ0FBQyxDQUFDOzRCQUN0RixVQUFVOzRCQUNWLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7NEJBQ3JFLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO3lCQUN6Qjt3QkFDRCxVQUFVO3dCQUNWLFVBQVU7d0JBQ1YsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsRUFBRTs0QkFDN0QsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDOzRCQUNoRixPQUFPLENBQUMsRUFBRSxDQUFDO3dCQUNiLENBQUMsQ0FBQyxDQUFDO3dCQUNILElBQUksU0FBUyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFOzRCQUNyQyxJQUFJLElBQUksR0FBRyxNQUFNLENBQUM7NEJBQ2xCLElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxFQUFFO2dDQUNwQyxJQUFJLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dDQUN6QyxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7NkJBQ3pDO2lDQUFNO2dDQUNMLE1BQU0sR0FBRyxFQUFFLENBQUM7NkJBQ2I7NEJBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtnQ0FDM0IsTUFBTSxVQUFVLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dDQUNwQyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksRUFBRSxZQUFZLEVBQUUsVUFBVSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dDQUM1RixJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFdBQVcsQ0FBQyxDQUFDOzRCQUN2RCxDQUFDLENBQUMsQ0FBQzt5QkFDSjt3QkFDRCxTQUFTO3dCQUNULE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTs0QkFDdEIsTUFBTSxZQUFZLEdBQUcsRUFBRSxDQUFDOzRCQUN4QixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQVksRUFBRSxFQUFFO2dDQUM3QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztnQ0FDOUMsTUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2dDQUM5QixNQUFNLE1BQU0sR0FBVSxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dDQUN2RCxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO29DQUNyQixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO29DQUM5QyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dDQUM1RCxDQUFDLENBQUMsQ0FBQzs0QkFDTCxDQUFDLENBQUMsQ0FBQzs0QkFDSCxhQUFhLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO3dCQUNuQyxDQUFDLENBQUMsQ0FBQzt3QkFDSCxJQUFJLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFOzRCQUM1QixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7NEJBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzs0QkFDcEYsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUN6RCxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDLENBQzFDLENBQUMsU0FBUyxFQUFFLENBQUM7eUJBQ2Y7cUJBQ0Y7aUJBQ0Y7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNSLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFDRDs7Ozs7O09BTUc7SUFDSSxJQUFJLENBQUMsRUFBVTtRQUNwQixJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ1AsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDNUYsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUVELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxVQUFnQyxDQUFDO1FBQzVELE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ2xELE1BQU0sR0FBRyxHQUFHLEdBQUcsT0FBTyw4QkFBOEIsQ0FBQztRQUNyRCxNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDakUsTUFBTSxJQUFJLEdBQUc7WUFDWCxXQUFXO1lBQ1gsTUFBTSxFQUFFLEVBQUU7U0FDWCxDQUFDO1FBQ0YsTUFBTSxPQUFPLEdBQUc7WUFDZCxJQUFJO1NBQ0wsQ0FBQztRQUNGLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMvQixPQUFPLGFBQWEsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDaEUsR0FBRyxDQUFDLEdBQUcsRUFBRTtZQUNQLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqQyxDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsQ0FBQyxZQUEwQixFQUFFLEVBQUU7WUFDakMsTUFBTSxXQUFXLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQztZQUM3QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNuRCxPQUFPLE1BQU0sQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUNEOzs7OztPQUtHO0lBQ0ksS0FBSyxDQUFDLEVBQVUsRUFBRSxJQUFZO1FBQ25DLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDUCxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUM1RixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUN6RixPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDekIsSUFBSSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7U0FDbkI7UUFDRCxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzFCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDO1FBQy9DLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxVQUFnQyxDQUFDO1FBQzVELE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ2xELE1BQU0sR0FBRyxHQUFHLEdBQUcsT0FBTyxHQUFHLElBQUksRUFBRSxDQUFDO1FBQ2hDLE1BQU0sV0FBVyxHQUFHLGFBQWEsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNqRSxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3ZDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDYixNQUFNLElBQUksR0FBRztZQUNYLFdBQVc7WUFDWCxNQUFNLEVBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7U0FDdEIsQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHO1lBQ2QsSUFBSTtTQUNMLENBQUM7UUFDRixJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDL0IsT0FBTyxhQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ2hFLEdBQUcsQ0FBQyxHQUFHLEVBQUU7WUFDUCxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDakMsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFO1lBQ2pDLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7WUFDN0MsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUN0RCxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBQ2xELElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQzthQUMxRDtpQkFBTTtnQkFDTCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3JGLE1BQU0sR0FBRyxhQUFhLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxXQUFXLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ2hHO1lBQ0QsT0FBTyxNQUFNLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRCxjQUFjO0lBRWQ7Ozs7O09BS0c7SUFDSSxPQUFPLENBQUMsT0FBZSxFQUFFLFlBQW9CLEVBQUUsU0FBaUIsQ0FBQztRQUN0RSxJQUFJLE9BQU8sTUFBTSxLQUFLLFFBQVEsRUFBRTtZQUM5QixNQUFNLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztTQUMvQjtRQUNELElBQUksTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQztTQUNwRDtRQUNELFFBQVE7UUFDUixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDN0csTUFBTSxZQUFZLEdBQUcsWUFBWSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQzdELE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsV0FBVyxJQUFJLEdBQUcsQ0FBQztRQUM5RCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7UUFDdkIsSUFBSSxXQUFXLEdBQWtCLElBQUksQ0FBQztRQUN0QyxJQUFJLFdBQVcsS0FBSyxHQUFHLEVBQUU7WUFDdkIsV0FBVztZQUNYLFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7U0FDekQ7YUFBTTtZQUNMLGFBQWE7WUFDYixNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BELFdBQVcsR0FBSSxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQWlCLENBQUMsV0FBVyxDQUFDO1NBQ3JGO1FBQ0QsV0FBVyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsRUFBRTtZQUNoQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtnQkFDMUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixFQUFFLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7YUFDN0Y7WUFDRCxPQUFPLEtBQUssQ0FBQztTQUNkO1FBQ0QsTUFBTSxpQkFBaUIsR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXZFLE1BQU0sT0FBTyxHQUFHLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDdkIsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNiLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztZQUNuQixJQUFJLFdBQVcsS0FBSyxHQUFHLEVBQUU7Z0JBQ3ZCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO2dCQUMzRCxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDbEQ7aUJBQU07Z0JBQ0wsT0FBTyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUM7YUFDcEM7WUFDRCxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQ2pCLEdBQUcsQ0FBQyxDQUFDLE1BQWMsRUFBRSxFQUFFO2dCQUNyQixTQUFTO2dCQUNULFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQztnQkFDckQsU0FBUztnQkFDVCxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFhLEVBQUUsRUFBRTtvQkFDMUMsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDOUQsSUFBSSxlQUFlLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTt3QkFDaEMsT0FBTyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7cUJBQzNCO29CQUNELE1BQU0sTUFBTSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRTt3QkFDMUUsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ3ZCLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQztvQkFDaEIsT0FBTyxNQUFNLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDN0QsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxXQUFXLENBQUMsQ0FBQztnQkFDOUQsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUNqRCxDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNkLE9BQU8sS0FBSyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSSwrQkFBK0IsQ0FBQyxPQUFlLEVBQUUsU0FBaUIsRUFBRSxlQUF1QjtRQUNoRyxNQUFNLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDN0QsNENBQTRDO1FBQzVDLDBQQUEwUDtRQUMxUCxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztTQUNyRDtRQUNELElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDZCxNQUFNLElBQUksS0FBSyxDQUFDLDJCQUEyQixDQUFDLENBQUM7U0FDOUM7UUFDRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZDLE1BQU0sVUFBVSxHQUFHLGVBQWUsQ0FBQztRQUNuQyxtQkFBbUI7UUFDbkIsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDMUQsMkJBQTJCO1FBQzNCLElBQUksV0FBVyxHQUFHLEdBQUcsQ0FBQztRQUN0QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBYSxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbkUsSUFBSSxVQUFVLEVBQUU7WUFDZCxNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakYsSUFBSSxZQUFZLEVBQUU7Z0JBQ2hCLFdBQVcsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsSUFBSSxHQUFHLENBQUM7YUFDekQ7aUJBQU07Z0JBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2FBQ3hDO1NBQ0Y7UUFDRCw4Q0FBOEM7UUFDOUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNoRCxJQUFJLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ25DLGtDQUFrQztZQUNsQyxNQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sV0FBVyxHQUFnQixJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDbkYsTUFBTSxnQkFBZ0IsR0FBRyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDL0Msb0NBQW9DO1lBQ3BDLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNuQixNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBZ0IsRUFBRSxJQUFJLEVBQUUsRUFBRTtnQkFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxDQUFDO2dCQUM1RCxNQUFNLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxhQUE0QixFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsVUFBVSxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUM7Z0JBQzFILElBQUksQ0FBQyxPQUFPLEVBQUU7b0JBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDakI7Z0JBQ0QsT0FBTyxJQUFJLENBQUM7WUFDZCxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFFWixtQ0FBbUM7WUFDbkMsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ25CLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQVksRUFBRSxJQUFtQixFQUFFLEVBQUU7Z0JBQzVELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO2dCQUNsSCxJQUFJLEtBQUssS0FBSyxDQUFDLENBQUMsRUFBRTtvQkFDaEIsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7aUJBQ3BDO2dCQUNELE9BQU8sT0FBTyxDQUFDO1lBQ2pCLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztZQUVaLDREQUE0RDtZQUM1RCxhQUFhO1lBQ2IsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDbkMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUNmLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDcEYsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQzVDLEdBQUcsQ0FBQyxDQUFDLE1BQWMsRUFBRSxFQUFFO29CQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTt3QkFDbkMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7d0JBQzlDLE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDOUIsTUFBTSxNQUFNLEdBQVUsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDdkQsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTs0QkFDckIsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDOUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQzt3QkFDdEQsQ0FBQyxDQUFDLENBQUM7b0JBQ0wsQ0FBQyxDQUFDLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLEdBQUcsRUFBRTtvQkFDZCxPQUFPLEtBQUssQ0FBQztnQkFDZixDQUFDLENBQUMsQ0FDSCxDQUFDO1lBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztZQUVGLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQ3RDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDZixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3BGLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDLElBQUksQ0FDbEQsR0FBRyxDQUFDLEdBQUcsRUFBRTtvQkFDUCxNQUFNLGFBQWEsR0FBdUIsSUFBSSxDQUFDLFVBQWdDLENBQUM7b0JBQ2hGLGFBQWEsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUM3RCxDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsR0FBRyxFQUFFO29CQUNkLE9BQU8sS0FBSyxDQUFDO2dCQUNmLENBQUMsQ0FBQyxDQUNILENBQUM7WUFDSixDQUFDLENBQUMsQ0FDSCxDQUFDO1lBQ0YsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sSUFBSSxPQUFPLElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUMxRixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUNqQjtZQUNELE9BQU8sTUFBTSxDQUFDLFVBQVUsRUFBRSxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQzNDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FDeEIsQ0FBQztTQUNIO1FBQ0QsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUNELCtCQUErQjtJQUMvQjs7T0FFRztJQUNJLHlCQUF5QjtRQUM5QixPQUFPLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFDRDs7Ozs7OztPQU9HO0lBQ0kseUJBQXlCLENBQUMsT0FBZSxFQUFFLFNBQWlCLEVBQUUsY0FBdUIsRUFBRSxXQUFvQjtRQUNoSCxNQUFNLElBQUksR0FBUSxJQUFJLENBQUM7UUFDdkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFLENBQUM7UUFDN0QsSUFBSSxNQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNuQyxhQUFhO1lBQ2IsSUFBSSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDaEMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakI7WUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztZQUN6RixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNqQjtRQUNELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xCLENBQUM7SUFDRDs7Ozs7UUFLSTtJQUNJLGtCQUFrQixDQUFDLE9BQWUsRUFBRSxTQUFpQixFQUFFLE1BQWE7UUFDMUUsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE1BQU0sSUFBSSxLQUFLLENBQUMsMkJBQTJCLENBQUMsQ0FBQztTQUM5QztRQUNELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdkMsMkJBQTJCO1FBQzNCLElBQUksV0FBVyxHQUFHLEdBQUcsQ0FBQztRQUN0QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBYSxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbkUsSUFBSSxVQUFVLEVBQUU7WUFDZCxNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakYsSUFBSSxZQUFZLEVBQUU7Z0JBQ2hCLFdBQVcsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsSUFBSSxHQUFHLENBQUM7YUFDekQ7aUJBQU07Z0JBQ0wsTUFBTSxJQUFJLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO2FBQ3hDO1NBQ0Y7UUFDRCxtQkFBbUI7UUFDbkIsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDMUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFVBQWdDLENBQUM7UUFDNUQsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzRCw4Q0FBOEM7UUFDOUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxHQUFHLE1BQU0sQ0FBQztRQUNoRCxJQUFJLE1BQU0sSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ25DLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQ2xDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDZixNQUFNLFdBQVcsR0FBRyxhQUFhLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLENBQUM7Z0JBQ2pFLElBQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7b0JBQzNCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDcEYsT0FBTyxhQUFhLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUNuRSxHQUFHLENBQUMsQ0FBQyxZQUEwQixFQUFFLEVBQUU7d0JBQ2pDLE1BQU0sSUFBSSxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUM7d0JBQ3RDLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQzt3QkFDbkYsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7NEJBQ25DLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDOzRCQUM5QyxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQzlCLE1BQU0sTUFBTSxHQUFVLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ3ZELE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0NBQ3JCLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0NBQzlDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7NEJBQ3pELENBQUMsQ0FBQyxDQUFDO3dCQUNMLENBQUMsQ0FBQyxDQUFDO3dCQUNILE9BQU8sU0FBUyxDQUFDO29CQUNuQixDQUFDLENBQUMsQ0FDSCxDQUFDO2lCQUNIO3FCQUFNO29CQUNMLE9BQU8sYUFBYSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FDN0QsR0FBRyxDQUFDLENBQUMsWUFBMEIsRUFBRSxFQUFFO3dCQUNqQyxNQUFNLElBQUksR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDO3dCQUN0QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQzt3QkFDcEQsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7NEJBQ25DLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDOzRCQUM5QyxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7NEJBQzlCLE1BQU0sTUFBTSxHQUFVLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7NEJBQ3ZELE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0NBQ3JCLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0NBQzlDLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7NEJBQ3pELENBQUMsQ0FBQyxDQUFDO3dCQUNMLENBQUMsQ0FBQyxDQUFDO3dCQUNILElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO3dCQUN0RCxPQUFPLFNBQVMsQ0FBQztvQkFDbkIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztpQkFDSDtZQUNILENBQUMsQ0FBQyxDQUNILENBQUM7WUFDRiw4RkFBOEY7WUFDOUYsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7Z0JBQzNCLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDdkMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksRUFBRSxDQUFDO2dCQUMvQixJQUFJLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQzFDO1lBQ0QsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUNwQixJQUFJLEVBQUUsQ0FDUCxDQUFDLElBQUksQ0FDSixTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUNiLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQy9ELElBQUksWUFBWSxFQUFFO29CQUNoQixPQUFPLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztpQkFDdEQ7cUJBQU07b0JBQ0wsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ2pCO1lBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFO2dCQUNmLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFFO29CQUMzQixJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ3RDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQzFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDaEM7WUFDSCxDQUFDLEVBQUUsR0FBRyxFQUFFO2dCQUNOLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFFO29CQUMzQixJQUFJLENBQUMsdUJBQXVCLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ3RDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQzFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsQ0FBQztpQkFDaEM7WUFDSCxDQUFDLENBQUMsQ0FBQztTQUNKO1FBQ0QsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEIsQ0FBQztJQUNPLHdCQUF3QixDQUFDLE9BQWU7UUFDOUMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksVUFBVSxFQUFFO1lBQ2QsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2pGLFlBQVksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1NBQzdCO0lBQ0gsQ0FBQztJQUNPLHVCQUF1QixDQUFDLE9BQWU7UUFDN0MsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25FLElBQUksVUFBVSxFQUFFO1lBQ2QsTUFBTSxZQUFZLEdBQUcsVUFBVSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2pGLFlBQVksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1lBQzdCLFlBQVksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztTQUN0RDtJQUNILENBQUM7SUFFRCxZQUFZO0lBQ0osY0FBYyxDQUFDLE1BQWMsRUFBRSxJQUFZLEVBQUUsS0FBVTtRQUM3RCxJQUFJLE1BQU0sRUFBRTtZQUNWLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUIsSUFBSSxLQUFLLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtnQkFDckIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQzthQUN0QjtpQkFBTTtnQkFDTCxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRTtvQkFDdkMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUU7d0JBQzFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7cUJBQ2pCO29CQUNELE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNwQixDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7YUFDN0M7U0FDRjtJQUNILENBQUM7SUFDTyxjQUFjLENBQUMsTUFBYyxFQUFFLElBQVk7UUFDakQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM5QixJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3BCLE9BQU87U0FDUjtRQUNELElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDdEIsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDckI7UUFDRCxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDbEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUM1QixJQUFJLEtBQUssS0FBSyxDQUFDLEVBQUU7Z0JBQ2YsTUFBTSxHQUFHLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO2FBQ3pDO2lCQUFNO2dCQUNMLE1BQU0sR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQzthQUN6QztRQUNILENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNEOzs7O09BSUc7SUFDSyxTQUFTLENBQUMsV0FBbUIsRUFBRSxFQUFPO1FBQzVDLElBQUksSUFBSSxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDcEIsTUFBTSxRQUFRLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN4QyxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQ3ZCLDZEQUE2RDtZQUM3RCxjQUFjO1lBQ2QsS0FBSyxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsS0FBSyxHQUFHLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFO2dCQUN4RCxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2hDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNwRCxJQUFJLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRTtvQkFDbEMsTUFBTSxLQUFLLENBQUMsaUJBQWlCLE9BQU8sbUJBQW1CLENBQUMsQ0FBQztpQkFDMUQ7Z0JBQ0QsSUFBSSxJQUFJLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQzthQUM1QztTQUNGO1FBQ0QsSUFBSSxJQUFJLEdBQUcsR0FBRyxRQUFRLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUU1QyxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFDRDs7OztPQUlHO0lBQ0ssUUFBUSxDQUFDLFdBQW1CO1FBQ2xDLE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0QsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUMvRCxNQUFNLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDbEIsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLElBQUksWUFBWSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMxQiw0QkFBNEI7WUFDNUIsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ25CLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtnQkFDcEMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDakIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBZ0IsQ0FBQztnQkFDOUUsSUFBSSxXQUFXLEVBQUU7b0JBQ2YsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7aUJBQ3BDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7U0FDSjtRQUNELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFDTyxpQkFBaUIsQ0FBQyxLQUFVLEVBQUUsR0FBZTtRQUNuRCxNQUFNLEVBQUUsV0FBVyxHQUFHLElBQUksRUFBRSxLQUFLLEdBQUcsSUFBSSxFQUFFLE9BQU8sR0FBRyxFQUFFLEVBQUUsUUFBUSxHQUFHLElBQUksRUFBRSxHQUFHLEtBQUssSUFBSSxFQUFFLENBQUM7UUFDeEYsSUFBSSxXQUFXLEVBQUU7WUFDZixXQUFXO1lBQ1gsSUFBSSxXQUFXLEtBQUssUUFBUSxJQUFJLFdBQVcsS0FBSyxjQUFjLEVBQUU7Z0JBQzlELE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUM7Z0JBQ3BDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2FBQy9DO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQzNDO1NBQ0Y7SUFDSCxDQUFDO0lBQ08saUJBQWlCLENBQUMsR0FBZSxFQUFFLEtBQVUsRUFBRSxNQUFXO1FBQ2hFLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPO1NBQ1I7UUFDRCxNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQUM7UUFDMUMsU0FBUztRQUNULElBQUksTUFBTSxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLGlCQUFpQixLQUFLLE1BQU0sRUFBRTtZQUNoQyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDN0QsSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDWixPQUFPLEdBQUcscUJBQXFCLENBQUM7YUFDakM7WUFDRCxNQUFNLEdBQUcsT0FBTyxDQUFDO1NBQ2xCO2FBQU0sSUFBSSxpQkFBaUIsS0FBSyxRQUFRLEVBQUU7WUFDekMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDN0I7UUFDRCxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQzNCLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDZixJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDTyxpQkFBaUIsQ0FBQyxHQUFlLEVBQUUsUUFBYSxFQUFFLFNBQWM7UUFDdEUsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE9BQU87U0FDUjtRQUNELElBQUksVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDeEMsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsQ0FBQztRQUM1RCxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksT0FBTyxLQUFLLENBQUMsRUFBRTtZQUM5QyxVQUFVLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztZQUM5QixVQUFVLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxVQUFVLENBQUMsQ0FBQztTQUNwQztRQUNELFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFjLEVBQUUsRUFBRTtZQUNwQyxJQUFJLFNBQVMsR0FBUSxFQUFFLENBQUM7WUFDeEIsSUFBSSxRQUFRLEVBQUU7Z0JBQ1osSUFBSSxRQUFRLFlBQVksS0FBSyxFQUFFO29CQUM3QixTQUFTLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQVMsRUFBRSxFQUFFO3dCQUNyQyxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN4QyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2Q7cUJBQU07b0JBQ0wsU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2lCQUNoRDthQUNGO1lBQ0QsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDZixJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQztZQUM5RCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNPLGlCQUFpQixDQUFDLFlBQWlCLEVBQUUsWUFBb0IsRUFBRSxLQUFVO1FBQzNFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDO1FBQ3pDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDL0IsT0FBTztTQUNSO1FBQ0QsYUFBYTtRQUNiLE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbkUsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7UUFFOUQsSUFBSSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUM1QixhQUFhLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3pEO2FBQU07WUFDTCxJQUFJLG1CQUFtQixHQUFHLElBQUksQ0FBQztZQUMvQixNQUFNLE1BQU0sR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2hFLE1BQU0sa0JBQWtCLEdBQUcsYUFBYSxDQUFDLGFBQWEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDbkUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDcEIsbUJBQW1CLEdBQUcsbUJBQW1CLElBQUksbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2hHLENBQUMsQ0FBQyxDQUFDO1lBQ0gsaUJBQWlCO1lBQ2pCLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1NBQ3JFO0lBQ0gsQ0FBQztJQUNPLG1CQUFtQjtRQUN6QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztRQUN4QyxJQUFJLElBQUksRUFBRTtZQUNSLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDOUM7UUFDRCxPQUFPLEVBQUUsQ0FBQztJQUNaLENBQUM7SUFDTyxRQUFRLENBQUMsQ0FBUyxFQUFFLElBQVM7UUFDbkMsSUFBSSxHQUFHLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ3pCLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDZjthQUFNO1lBQ0wsR0FBRyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNqQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNkLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUNWO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBQ0QsSUFBYyxXQUFXO1FBQ3ZCLE1BQU07UUFDTixJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFO1lBQ3JFLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO1NBQ3hDO1FBQ0QsTUFBTTtRQUNOLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RCxXQUFXLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxRixNQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXJDLE1BQU0sYUFBYSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUNsRCxPQUFPLElBQUksS0FBSyxFQUFFLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBQ0Q7Ozs7O09BS0c7SUFDSyxVQUFVLENBQUMsSUFBUyxFQUFFLFNBQWMsRUFBRSxNQUFjLEVBQUUsV0FBbUI7UUFDL0UsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFZLEVBQUUsRUFBRTtZQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM5QyxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDL0IsTUFBTSxNQUFNLEdBQVUsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNyQixNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM5QyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3RELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0Q7Ozs7T0FJRztJQUNLLG1CQUFtQixDQUFDLE9BQWU7UUFDekMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBYSxVQUFVLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbkUsSUFBSSxZQUFZLEdBQWlCLElBQUksQ0FBQztRQUN0QyxJQUFJLFVBQVUsRUFBRTtZQUNkLFlBQVksR0FBRyxVQUFVLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDNUU7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBQ08sZUFBZSxDQUFDLFlBQTBCLEVBQUUsWUFBbUIsRUFBRSxTQUFpQjtRQUN4RixZQUFZLEdBQUcsQ0FBQyxHQUFHLFlBQVksQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sRUFBRSxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNuRCxNQUFNLE1BQU0sR0FBVyxZQUFZLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQVcsQ0FBQztRQUM1RixJQUFJLElBQUksR0FBVyxNQUFNLENBQUM7UUFDMUIsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDO1FBQ2pCLE1BQU0sUUFBUSxHQUFHLFlBQVksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNwQyxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBYyxFQUFFLElBQVksRUFBRSxFQUFFO1lBQ2xFLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakIsSUFBSSxNQUFNLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRTtnQkFDdkYsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUMzQixJQUFJLEtBQUssSUFBSSxLQUFLLFlBQVksVUFBVSxFQUFFO29CQUN4QyxNQUFNLFdBQVcsR0FBRyxZQUFZLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQWdCLENBQUM7b0JBQzVFLE1BQU0sYUFBYSxHQUFHLFdBQVcsQ0FBQyxTQUFTLENBQUM7b0JBQzVDLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztpQkFDakM7cUJBQU07b0JBQ0wsT0FBTyxLQUFLLENBQUM7aUJBQ2Q7YUFDRjtpQkFBTTtnQkFDTCxPQUFPLElBQUksQ0FBQzthQUNiO1FBQ0gsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ1QsSUFBSSxNQUFNLFlBQVksTUFBTSxFQUFFO1lBQzVCLE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQW9CLENBQUM7WUFDakQsSUFBSSxJQUFJLEVBQUU7Z0JBQ1IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzVCO2lCQUFNO2dCQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQzthQUNwQztTQUNGO2FBQU07WUFDTCxNQUFNLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUM7U0FDcEM7SUFDSCxDQUFDO0lBQ08sT0FBTyxDQUFDLFlBQTBCO1FBQ3hDLE1BQU0sVUFBVSxHQUFlLFlBQVksSUFBSSxZQUFZLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUNoRixPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQ2xCLEdBQUcsQ0FBQyxHQUFHLEVBQUU7WUFDUCxJQUFJLFVBQVUsRUFBRTtnQkFDZCxVQUFVLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO2FBQ2xEO1FBQ0gsQ0FBQyxDQUFDO1FBQ0Ysd0JBQXdCO1FBQ3hCLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FDVCxDQUFDO0lBQ0osQ0FBQzs7O1lBei9CRixVQUFVOzs7O1lBaEJVLFFBQVE7WUFPcEIsdUJBQXVCO1lBTlYsU0FBUztZQUFpQixVQUFVO1lBSWpELHNCQUFzQjtZQUN0QixxQkFBcUI7WUFHckIsZUFBZTtZQUNmLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmluZGluZ0xpc3QsIFZpZXdNb2RlbCwgQmluZGluZ09iamVjdCwgUmVwb3NpdG9yeSwgRW50aXR5LCBGcmFtZUNvbnRleHQsIEJpbmRpbmdEYXRhLCBBcHBDb250ZXh0LCBCaW5kaW5nUHJvcGVydHksIERhdGFUeXBlSW5mbywgY3JlYXRlRW50aXRpZXMsIEVudGl0eUxpc3QgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG5pbXBvcnQgeyBmcm9tLCBFTVBUWSwgY29uY2F0LCBvZiwgU3ViamVjdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY29uY2F0TWFwLCBjYXRjaEVycm9yLCB0YXAsIHN3aXRjaE1hcCwgbGFzdCwgbWFwLCBkZWxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIFJlc3BvbnNlSW5mbyB9IGZyb20gJ0BmYXJyaXMvYmVmJztcbmltcG9ydCB7IEJhdGNoRWRpdERpYWxvZ1NlcnZpY2UgfSBmcm9tICdAZmFycmlzL3VpLWJhdGNoLWVkaXQtZGlhbG9nJztcbmltcG9ydCB7IERhdGVUaW1lSGVscGVyU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uL2RhdGUnO1xuaW1wb3J0IHsgQ29tcG9uZW50TWFuYWdlclNlcnZpY2UgfSBmcm9tICcuL2NvbXBvbmVudC1tYW5hZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi9mb3JtLWxvYWRpbmcvZm9ybS1sb2FkaW5nLnNlcnZpY2UnO1xuaW1wb3J0IHsgTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi9sYW5ndWFnLnNlcnZpY2UnO1xuaW1wb3J0IHsgRm9ybU5vdGlmeVNlcnZpY2UgfSBmcm9tICcuL2Zvcm0tbm90aWZ5LnNlcnZpY2UnO1xuXG4vLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXG4vKipcbiAqIOaJuemHj+e8lui+keacjeWKoVxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQmF0Y2hFZGl0U2VydmljZSB7XG4gIHByaXZhdGUgZm9ybUxvYWRpbmdTZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2U7XG4gIHByaXZhdGUgb25IZWxwQ2xvc2U6IFN1YmplY3Q8YW55PjtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBjb21wb25lbnRNYW5hZ2VyU2VydmljZTogQ29tcG9uZW50TWFuYWdlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSB2aWV3TW9kZWw6IFZpZXdNb2RlbCxcbiAgICBwcml2YXRlIHJlcG9zaXRvcnk6IFJlcG9zaXRvcnk8YW55PixcbiAgICBwcml2YXRlIGJhdGNoRWRpdERpYWxvZ1NlcnZpY2U6IEJhdGNoRWRpdERpYWxvZ1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBkYXRlU2VydmljZTogRGF0ZVRpbWVIZWxwZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBMYW5ndWFnZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBmb3JtTm90aWZ5U2VydmljZTogRm9ybU5vdGlmeVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UgPSB0aGlzLmluamVjdG9yLmdldDxGb3JtTG9hZGluZ1NlcnZpY2U+KEZvcm1Mb2FkaW5nU2VydmljZSwgbnVsbCk7XG4gICAgaWYgKCF0aGlzLmxhbmd1YWdlU2VydmljZSkge1xuICAgICAgdGhpcy5sYW5ndWFnZVNlcnZpY2UgPSBMYW5ndWFnZVNlcnZpY2UuZ2V0SW5zdGFuY2UoKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlKSB7XG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlID0gdGhpcy5pbmplY3Rvci5nZXQ8Rm9ybU5vdGlmeVNlcnZpY2U+KEZvcm1Ob3RpZnlTZXJ2aWNlLCBudWxsKTtcbiAgICB9XG4gICAgdGhpcy5vbkhlbHBDbG9zZSA9IG5ldyBTdWJqZWN0PGFueT4oKTtcbiAgICB0aGlzLm9uSGVscENsb3NlLnN1YnNjcmliZShyZXN1bHQgPT4ge1xuICAgICAgY29uc3QgeyBmcmFtZUlkID0gJycsIG1hcEZpZWxkcyA9ICcnLCBkYXRhID0gW10gfSA9IHJlc3VsdCB8fCB7fTtcbiAgICAgIHRoaXMub25IZWxwQ2xvc2VIYW5kbGVyKGZyYW1lSWQsIG1hcEZpZWxkcywgZGF0YSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICog5omT5byA5om56YeP57yW6L6R5a+56K+d5qGGXG4gICAqIEBwYXJhbSBmcmFtZUlkIGZyYW1lSWRcbiAgICovXG4gIHB1YmxpYyBvcGVuQmF0Y2hFZGl0RGlhbG9nKGZyYW1lSWQ6IHN0cmluZykge1xuICAgIGlmICghZnJhbWVJZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdmcmFtZUlkIGlzIHJlcXVpcmVkLicpO1xuICAgIH1cbiAgICBpZiAodGhpcy5iYXRjaEVkaXREaWFsb2dTZXJ2aWNlKSB7XG4gICAgICBsZXQgY29sdW1ucyA9IFtdO1xuICAgICAgaWYgKHRoaXMudmlld01vZGVsKSB7XG4gICAgICAgIGNvbnN0IGdyaWRGcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yb290LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKGZyYW1lSWQpO1xuICAgICAgICBjb25zdCBncmlkVmlld01vZGVsID0gZ3JpZEZyYW1lQ29udGV4dC52aWV3TW9kZWw7XG4gICAgICAgIGlmIChncmlkVmlld01vZGVsICYmIGdyaWRWaWV3TW9kZWwuaGFzT3duUHJvcGVydHkoJ2RhdGFHcmlkQ29sdW1uc05hbWUnKSkge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc3RyaW5nLWxpdGVyYWxcbiAgICAgICAgICBjb25zdCBncmlkQ29sdW1uc0F0dHJOYW1lID0gZ3JpZFZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zTmFtZSddO1xuICAgICAgICAgIGNvbHVtbnMgPSBncmlkVmlld01vZGVsW2dyaWRDb2x1bW5zQXR0ck5hbWVdO1xuICAgICAgICB9IGVsc2UgaWYgKGdyaWRWaWV3TW9kZWwgJiYgZ3JpZFZpZXdNb2RlbC5oYXNPd25Qcm9wZXJ0eSgnZGF0YUdyaWRDb2x1bW5zJykpIHtcbiAgICAgICAgICBjb2x1bW5zID0gZ3JpZFZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zJ107XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgaWRzOiBzdHJpbmdbXSA9IGdyaWRWaWV3TW9kZWwudWlTdGF0ZVsnaWRzJ10gfHwgW107XG4gICAgICAgIGlmICghaWRzIHx8IGlkcy5sZW5ndGggPCAxKSB7XG4gICAgICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc0NoZWNrQmF0Y2hFZGl0Um93cywgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICAgICAgcmV0dXJuIEVNUFRZO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRpYWxvZ1JlZjogYW55ID0gdGhpcy5iYXRjaEVkaXREaWFsb2dTZXJ2aWNlLmJhdGNoRWRpdChjb2x1bW5zLCB7XG4gICAgICAgICAgcm93czogaWRzLmxlbmd0aCxcbiAgICAgICAgICBvbkNvbmZpcm06IChpbnB1dHM6IEFycmF5PGFueT4pID0+IHtcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGlkcykgJiYgaWRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ29wZW5CYXRjaEVkaXREaWFsb2cnLCBpbnB1dHMpO1xuICAgICAgICAgICAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmFwcENvbnRleHQ7XG4gICAgICAgICAgICAgIGFwcENvbnRleHQuY2hhbmdlRGV0ZWN0aW9uQ29udHJvbGxlci5kZXRhY2goKTtcbiAgICAgICAgICAgICAgaW5wdXRzLmZvckVhY2goaW5wdXQgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlQmluZGluZ0RhdGEoaW5wdXQsIGlkcyk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBhcHBDb250ZXh0LmNoYW5nZURldGVjdGlvbkNvbnRyb2xsZXIucmVhdHRhY2goKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDmiZPlvIDpmpDol4/luK7liqlcbiAgICogQHBhcmFtIGhlbHBJZCDluK7liqlpZFxuICAgKi9cbiAgcHVibGljIG9wZW5IaWRkZW5IZWxwKGhlbHBJZDogc3RyaW5nKSB7XG4gICAgaWYgKCFoZWxwSWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQXJndW1lbnQgZXJyb3IsaGVscElkIGNhbmB0IGJlIGVtcHR5Jyk7XG4gICAgfVxuICAgIGNvbnN0IGNvbXBvbmVudE1hbmFnZXJTZXJ2aWNlID0gdGhpcy5jb21wb25lbnRNYW5hZ2VyU2VydmljZS5nZXRDb250cm9sKGhlbHBJZCk7XG4gICAgaWYgKGNvbXBvbmVudE1hbmFnZXJTZXJ2aWNlKSB7XG4gICAgICBjb21wb25lbnRNYW5hZ2VyU2VydmljZS5zaG93RGlhbG9nKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgdGhlIGNvbXBvbmVudCB3aGljaCBpZCBpcyAke2hlbHBJZH0gY2FuJ3QgYmUgZm91bmQhYCk7XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiDmuIXnqbrluK7liqnli77pgInvvIjlj6rog73mjILovb3liLDluK7liqnliY3kuovku7bvvIlcbiAgICovXG4gIHB1YmxpYyBjbGVhckhlbHBTZWxlY3Rpb25zKCkge1xuICAgIGNvbnN0IHNlbGY6IGFueSA9IHRoaXM7XG4gICAgY29uc3QgaGVscEVsZW1lbnQgPSBzZWxmLmNvbnRleHQgJiYgc2VsZi5jb250ZXh0LmV2ZW50UGFyYW0gJiYgc2VsZi5jb250ZXh0LmV2ZW50UGFyYW0uaW5zdGFuY2UgfHwgbnVsbDtcbiAgICBpZiAoaGVscEVsZW1lbnQpIHtcbiAgICAgIGhlbHBFbGVtZW50LmRpc3BsYXlWYWx1ZSA9ICcnO1xuICAgIH1cbiAgfVxuICAvKipcbiAgICog5Yu+6YCJ5b2T5YmN6KGMXG4gICAqIEBwYXJhbSBmcmFtZUlkIGZyYW1lSWRcbiAgICogQHBhcmFtIG1hcEZpZWxkcyDlrZfmrrXmmKDlsIRcbiAgICogQHBhcmFtIHByaW1hcnlLZXlWYWx1ZSDluK7liqnkuLvplK7lrZfmrrVcbiAgICovXG4gIHB1YmxpYyBjaGVja0N1cnJlbnRSb3coZnJhbWVJZDogc3RyaW5nLCBtYXBGaWVsZHM6IHN0cmluZywgcHJpbWFyeUtleVZhbHVlOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzZWxmOiBhbnkgPSB0aGlzO1xuICAgIGNvbnN0IGhlbHBFbGVtZW50ID0gc2VsZi5jb250ZXh0ICYmIHNlbGYuY29udGV4dC5ldmVudFBhcmFtICYmIHNlbGYuY29udGV4dC5ldmVudFBhcmFtLmluc3RhbmNlIHx8IG51bGw7XG4gICAgaWYgKCFwcmltYXJ5S2V5VmFsdWUpIHtcbiAgICAgIHByaW1hcnlLZXlWYWx1ZSA9ICdpZCc7XG4gICAgfVxuICAgIGNvbnN0IG1hcHBpbmdzID0gSlNPTi5wYXJzZShtYXBGaWVsZHMpO1xuICAgIGlmIChoZWxwRWxlbWVudCkge1xuICAgICAgZnJhbWVJZCA9IGZyYW1lSWQgfHwgdGhpcy52aWV3TW9kZWwuZnJhbWVDb250ZXh0LmZyYW1lSWQ7XG4gICAgICBpZiAoZnJhbWVJZCkge1xuICAgICAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCk7XG4gICAgICAgIGlmIChmcmFtZUNvbnRleHQpIHtcbiAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGg7XG4gICAgICAgICAgaWYgKGJpbmRpbmdQYXRoKSB7XG4gICAgICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3cgPSBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbTtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSBtYXBwaW5nc1twcmltYXJ5S2V5VmFsdWVdO1xuICAgICAgICAgICAgaWYgKHBhdGgpIHtcbiAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGN1cnJlbnRSb3csIHBhdGgpO1xuICAgICAgICAgICAgICBoZWxwRWxlbWVudC5kaXNwbGF5VmFsdWUgPSB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOS7peW4ruWKqeWLvumAieaVsOaNruS9nOS4uuS+neaNru+8jOaJuemHj+aWsOWinuS4u+ihqOaVsOaNrlxuICAgKiBAcGFyYW0gZnJhbWVJZCDkuLvooajmiYDlnKhmcmFtZeeahGlkXG4gICAqIEBwYXJhbSBtYXBGaWVsZHMg5biu5Yqp5a2X5q615LiO5Li76KGo5a2X5q615pig5bCEXG4gICAqIEBkZXNjcmlwdGlvbiDku6XluK7liqnli77pgInmlbDmja7kvZzkuLrkvp3mja7vvIzmibnph4/mlrDlop7kuLvooajmlbDmja5cbiAgICovXG4gIHB1YmxpYyBiYXRjaEFwcGVuZChmcmFtZUlkOiBzdHJpbmcsIG1hcEZpZWxkczogc3RyaW5nKSB7XG4gICAgY29uc3Qgc2VsZjogYW55ID0gdGhpcztcbiAgICBjb25zdCByZXN1bHQgPSBzZWxmLmNvbnRleHQgJiYgc2VsZi5jb250ZXh0LmV2ZW50UGFyYW0gfHwgW107XG4gICAgaWYgKCFtYXBGaWVsZHMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbWFwRmllbGRzIGNhbmB0IGJlIGVtcHR5LicpO1xuICAgIH1cbiAgICBpZiAocmVzdWx0ICYmIEFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgbWFwcGluZ3MgPSBKU09OLnBhcnNlKG1hcEZpZWxkcyk7XG4gICAgICAvLyDkuI3mmK9iaW5kaW5nUGF0aOWImeaMiWZyYW1lSWTlpITnkIZcbiAgICAgIGxldCBiaW5kaW5nUGF0aCA9ICcvJztcbiAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcbiAgICAgIGlmIChhcHBDb250ZXh0KSB7XG4gICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKGZyYW1lSWQpO1xuICAgICAgICBpZiAoZnJhbWVDb250ZXh0KSB7XG4gICAgICAgICAgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoIHx8ICcvJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ZyYW1lSWQgaXMgaW52YWxpZCEnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgZGVmYXVsdFZhbHVlcyA9IFtdO1xuICAgICAgcmVzdWx0LmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0ge307XG4gICAgICAgIE9iamVjdC5rZXlzKG1hcHBpbmdzKS5mb3JFYWNoKChwcm9wOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbSwgcHJvcCk7XG4gICAgICAgICAgY29uc3QgZmllbGRzID0gbWFwcGluZ3NbcHJvcF07XG4gICAgICAgICAgY29uc3QgZ3JvdXBzOiBhbnlbXSA9IGZpZWxkcy5zcGxpdCgnLCcpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgIGdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gZ3JvdXAuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWVCeVBhdGgoZGVmYXVsdFZhbHVlLCBwYXRocy5qb2luKCcuJyksIHZhbHVlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRlZmF1bHRWYWx1ZXMucHVzaChkZWZhdWx0VmFsdWUpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LmJhdGNoQXBwZW5kKGRlZmF1bHRWYWx1ZXMpLnBpcGUoXG4gICAgICAgIHRhcCgoKSA9PiB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5oaWRlKCkpLFxuICAgICAgICBtYXAoKCkgPT4gdHJ1ZSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBvZih0cnVlKTtcbiAgfVxuICAvKipcbiAgICog5Lul5biu5Yqp5Yu+6YCJ5pWw5o2u5L2c5Li65L6d5o2u77yM5om56YeP5paw5aKe5LuO6KGoL+S7juS7juihqFxuICAgKiBAcGFyYW0gZnJhbWVJZCDku47ooagv5LuO5LuO6KGo5omA5ZyoZnJhbWXnmoRpZFxuICAgKiBAcGFyYW0gbWFwRmllbGRzIOW4ruWKqeWtl+auteS4juS7juihqC/ku47ku47ooajlrZfmrrXmmKDlsIRcbiAgICogQGRlc2NyaXB0aW9uIOS7peW4ruWKqeWLvumAieaVsOaNruS9nOS4uuS+neaNru+8jOaJuemHj+aWsOWinuS7juihqC/ku47ku47ooahcbiAgICovXG4gIHB1YmxpYyBiYXRjaEFwcGVuZEJ5UGF0aEJhc2VkT25IZWxwU2VsZWN0aW9ucyhmcmFtZUlkOiBzdHJpbmcsIG1hcEZpZWxkczogc3RyaW5nKSB7XG4gICAgY29uc3Qgc2VsZjogYW55ID0gdGhpcztcbiAgICBjb25zdCByZXN1bHQgPSBzZWxmLmNvbnRleHQgJiYgc2VsZi5jb250ZXh0LmV2ZW50UGFyYW0gfHwgW107XG4gICAgaWYgKCFtYXBGaWVsZHMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbWFwRmllbGRzIGNhbmB0IGJlIGVtcHR5LicpO1xuICAgIH1cbiAgICBpZiAocmVzdWx0ICYmIEFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgbWFwcGluZ3MgPSBKU09OLnBhcnNlKG1hcEZpZWxkcyk7XG4gICAgICAvLyDkuI3mmK9iaW5kaW5nUGF0aOWImeaMiWZyYW1lSWTlpITnkIZcbiAgICAgIGxldCBiaW5kaW5nUGF0aCA9ICcvJztcbiAgICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcbiAgICAgIGlmIChhcHBDb250ZXh0KSB7XG4gICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKGZyYW1lSWQpO1xuICAgICAgICBpZiAoZnJhbWVDb250ZXh0KSB7XG4gICAgICAgICAgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoIHx8ICcvJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ZyYW1lSWQgaXMgaW52YWxpZCEnKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgZGVmYXVsdFZhbHVlcyA9IFtdO1xuICAgICAgcmVzdWx0LmZvckVhY2goKGl0ZW0pID0+IHtcbiAgICAgICAgY29uc3QgZGVmYXVsdFZhbHVlID0ge307XG4gICAgICAgIE9iamVjdC5rZXlzKG1hcHBpbmdzKS5mb3JFYWNoKChwcm9wOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbSwgcHJvcCk7XG4gICAgICAgICAgY29uc3QgZmllbGRzID0gbWFwcGluZ3NbcHJvcF07XG4gICAgICAgICAgY29uc3QgZ3JvdXBzOiBhbnlbXSA9IGZpZWxkcy5zcGxpdCgnLCcpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgIGdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gZ3JvdXAuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICAgIHRoaXMuc2V0VmFsdWVCeVBhdGgoZGVmYXVsdFZhbHVlLCBwYXRocy5qb2luKCcuJyksIHZhbHVlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGRlZmF1bHRWYWx1ZXMucHVzaChkZWZhdWx0VmFsdWUpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgICBjb25zdCBwYXRoID0gdGhpcy5idWlsZFBhdGgoYmluZGluZ1BhdGgsIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkKTtcbiAgICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnkuYmF0Y2hBcHBlbmRCeVBhdGgocGF0aCwgZGVmYXVsdFZhbHVlcykucGlwZShcbiAgICAgICAgdGFwKCgpID0+IHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKSksXG4gICAgICAgIG1hcCgoKSA9PiB0cnVlKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG9mKHRydWUpO1xuICB9XG4gIC8qKlxuICAgKiDooYzlhoXluK7liqnlpJrpgInmibnph4/mlrDlop7miJbmm7/mjaLlrZDooajmlbDmja5cbiAgICogQHBhcmFtIGZyYW1lSWQgZnJhbWVJZCwgb3B0aW9uYWws5Li656m65pe25L2/55So5ZG95Luk5omn6KGM5pe25omA5Zyo55qE5LiK5LiL5paHXG4gICAqIEBwYXJhbSBtYXBGaWVsZHMg5a2X5q615pig5bCEXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHVibGljIGJhdGNoQXBwZW5kQmFzZWRPblJvd0hlbHBTZWxlY3Rpb25zKGZyYW1lSWQ6IHN0cmluZywgbWFwRmllbGRzOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzZWxmOiBhbnkgPSB0aGlzO1xuICAgIGxldCByZXN1bHQ6IGFueVtdID0gc2VsZi5jb250ZXh0ICYmIHNlbGYuY29udGV4dC5ldmVudFBhcmFtIHx8IFtdO1xuICAgIGlmICghbWFwRmllbGRzKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuICAgIGNvbnN0IG1hcHBpbmdzID0gSlNPTi5wYXJzZShtYXBGaWVsZHMpO1xuICAgIGlmICghbWFwcGluZ3MgfHwgIW1hcHBpbmdzLmhhc093blByb3BlcnR5KCdpZCcpKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuICAgIGZyYW1lSWQgPSBmcmFtZUlkIHx8IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5mcmFtZUlkO1xuICAgIGlmICghZnJhbWVJZCkge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCk7XG4gICAgaWYgKCFmcmFtZUNvbnRleHQpIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmVuZEVkaXQoZnJhbWVDb250ZXh0KS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICBpZiAocmVzdWx0ICYmIEFycmF5LmlzQXJyYXkocmVzdWx0KSAmJiByZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCAnLyc7XG4gICAgICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWVzID0gW107XG4gICAgICAgICAgLy8g6I635Y+W5b2T5YmN6KGMXG4gICAgICAgICAgY29uc3QgYmluZGluZ0xpc3Q6IEJpbmRpbmdMaXN0ID0gZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgICAgICAgY29uc3QgY3VycmVudFJvdyA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJdGVtO1xuICAgICAgICAgIGNvbnN0IGN1cnJlbnRSb3dJZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcbiAgICAgICAgICBjb25zdCBjdXJyZW50RW50aXR5ID0gdGhpcy5nZXRFbnRpdHlCeVBhdGgoZnJhbWVDb250ZXh0LCBiaW5kaW5nUGF0aHMsIGN1cnJlbnRSb3dJZCk7XG4gICAgICAgICAgY29uc3QgaGVhZEl0ZW0gPSByZXN1bHRbMF07XG4gICAgICAgICAgLy8g5aaC5p6c5LuF5Yu+6YCJ5LiA5p2h77yM5YiZ5bqU5pu/5o2i5b2T5YmN6KGM55qE5pig5bCEXG4gICAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgICAgICAgIHRoaXMubWFwcGluZ1JvdyhoZWFkSXRlbSwgbWFwcGluZ3MsIGN1cnJlbnRFbnRpdHksIGJpbmRpbmdQYXRoKTtcbiAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgaWRNYXBGaWVsZCA9IG1hcHBpbmdzWydpZCddO1xuICAgICAgICAgICAgY29uc3Qgc291cmNlSXRlbUlkID0gdGhpcy5nZXRWYWx1ZUJ5UGF0aChjdXJyZW50RW50aXR5LCBpZE1hcEZpZWxkKTtcbiAgICAgICAgICAgIC8vIOWmguaenOW9k+WJjeihjOayoeacieaYoOWwhOaIluWLvumAiee7k+aenOS4reaJvuS4jeWIsOW9k+WJjeihjOeahOaYoOWwhFxuICAgICAgICAgICAgaWYgKCFzb3VyY2VJdGVtSWQgfHwgcmVzdWx0LmZpbmRJbmRleChpdGVtID0+IGl0ZW1bYmluZGluZ0xpc3QucHJpbWFyeUtleV0gPT09IHNvdXJjZUl0ZW1JZCkgPT09IC0xKSB7XG4gICAgICAgICAgICAgIC8vIOmHjeaWsOaYoOWwhOW9k+WJjeihjFxuICAgICAgICAgICAgICB0aGlzLm1hcHBpbmdSb3coaGVhZEl0ZW0sIG1hcHBpbmdzLCBjdXJyZW50RW50aXR5LCBiaW5kaW5nUGF0aCk7XG4gICAgICAgICAgICAgIHJlc3VsdCA9IHJlc3VsdC5zbGljZSgxKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc291cmNlSXRlbUlkKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gcmVzdWx0LmZpbmRJbmRleChpdGVtID0+IGl0ZW1bYmluZGluZ0xpc3QucHJpbWFyeUtleV0gPT09IHNvdXJjZUl0ZW1JZCk7XG4gICAgICAgICAgICAgIC8vIOmHjeaWsOaYoOWwhOW9k+WJjeihjFxuICAgICAgICAgICAgICB0aGlzLm1hcHBpbmdSb3cocmVzdWx0W2luZGV4XSwgbWFwcGluZ3MsIGN1cnJlbnRFbnRpdHksIGJpbmRpbmdQYXRoKTtcbiAgICAgICAgICAgICAgcmVzdWx0LnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyDlvZPliY3ooYzlpITnkIblrozmiJBcbiAgICAgICAgICAgIC8vIOWkhOeQhuacquaYoOWwhOeahOihjFxuICAgICAgICAgICAgY29uc3QgZW1wdHlSb3dzID0gYmluZGluZ0xpc3QudG9BcnJheSgpLmZpbHRlcihiaW5kaW5nT2JqZWN0ID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgaWQgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGJpbmRpbmdPYmplY3QsIG1hcHBpbmdzW2JpbmRpbmdMaXN0LnByaW1hcnlLZXldKTtcbiAgICAgICAgICAgICAgcmV0dXJuICFpZDtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKGVtcHR5Um93cyAmJiBlbXB0eVJvd3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBsZXQgcm93cyA9IHJlc3VsdDtcbiAgICAgICAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPiBlbXB0eVJvd3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgcm93cyA9IHJlc3VsdC5zbGljZSgwLCBlbXB0eVJvd3MubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHQuc2xpY2UoZW1wdHlSb3dzLmxlbmd0aCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gW107XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcm93cy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBlbXB0eVJvd3NbaW5kZXhdO1xuICAgICAgICAgICAgICAgIGNvbnN0IGVudGl0eSA9IHRoaXMuZ2V0RW50aXR5QnlQYXRoKGZyYW1lQ29udGV4dCwgYmluZGluZ1BhdGhzLCB0YXJnZXRJdGVtLnByaW1hcnlLZXlWYWx1ZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5tYXBwaW5nUm93KGl0ZW0sIG1hcHBpbmdzLCBlbnRpdHksIGJpbmRpbmdQYXRoKTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyDlpITnkIbliankvZnli77pgIlcbiAgICAgICAgICAgIHJlc3VsdC5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGRlZmF1bHRWYWx1ZSA9IHt9O1xuICAgICAgICAgICAgICBPYmplY3Qua2V5cyhtYXBwaW5ncykuZm9yRWFjaCgocHJvcDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW0sIHByb3ApO1xuICAgICAgICAgICAgICAgIGNvbnN0IGZpZWxkcyA9IG1hcHBpbmdzW3Byb3BdO1xuICAgICAgICAgICAgICAgIGNvbnN0IGdyb3VwczogYW55W10gPSBmaWVsZHMuc3BsaXQoJywnKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICAgICAgICBncm91cHMuZm9yRWFjaChncm91cCA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBwYXRocyA9IGdyb3VwLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgICAgICAgICAgICAgICB0aGlzLnNldFZhbHVlQnlQYXRoKGRlZmF1bHRWYWx1ZSwgcGF0aHMuam9pbignLicpLCB2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBkZWZhdWx0VmFsdWVzLnB1c2goZGVmYXVsdFZhbHVlKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgaWYgKGRlZmF1bHRWYWx1ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmJ1aWxkUGF0aChiaW5kaW5nUGF0aCwgdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQpO1xuICAgICAgICAgICAgICB0aGlzLnJlcG9zaXRvcnkuYmF0Y2hBcHBlbmRCeVBhdGgocGF0aCwgZGVmYXVsdFZhbHVlcykucGlwZShcbiAgICAgICAgICAgICAgICB0YXAoKCkgPT4gdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpKVxuICAgICAgICAgICAgICApLnN1YnNjcmliZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSwgMTAwKTtcbiAgICByZXR1cm4gb2YodHJ1ZSk7XG4gIH1cbiAgLyoqXG4gICAqIOWkjeWItuS4u+ihqOaVsOaNrlxuICAgKiBAcGFyYW0gaWQg6KaB5aSN5Yi255qE5pWw5o2uaWRcbiAgICogQHBhcmFtIGZpZWxkcyDopoHlpI3liLbnmoTlrZfmrrVcbiAgICogQGRlc2NyaXB0aW9uIOS7heaUr+aMgeWkjeWItuS4u+ihqOaVsOaNrlxuICAgKiBAZGVwcmVjYXRlZCDor6Xmlrnms5Xlt7Looqvlup/lvIPvvIzor7fkvb/nlKhjbG9uZeaWueazleabv+S7o+OAglxuICAgKi9cbiAgcHVibGljIGNvcHkoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgaWYgKCFpZCkge1xuICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdENvcHlEYXRhLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG5cbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICBjb25zdCBiYXNlVXJpID0gYmVmUmVwb3NpdG9yeS5yZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IHVybCA9IGAke2Jhc2VVcml9L3NlcnZpY2UvY29weW1haW5vYmp2b2FjdGlvbmA7XG4gICAgY29uc3QgcmVxdWVzdEluZm8gPSBiZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKTtcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgcmVxdWVzdEluZm8sXG4gICAgICBkYXRhSUQ6IGlkXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgYm9keVxuICAgIH07XG4gICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgIHJldHVybiBiZWZSZXBvc2l0b3J5LnByb3h5LnJlcXVlc3QodXJsLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMuZm9ybUxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pLFxuICAgICAgbWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICBjb25zdCByZXR1cm5WYWx1ZSA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZTtcbiAgICAgICAgY29uc3QgZW50aXR5ID0gdGhpcy5yZXBvc2l0b3J5LmJ1aWxkRW50aXR5KHJldHVyblZhbHVlKTtcbiAgICAgICAgdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXR5KGVudGl0eSk7XG4gICAgICAgIHJldHVybiBlbnRpdHk7XG4gICAgICB9KSxcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDlpI3liLbmlbDmja7vvIjmlK/mjIHkuLvooajjgIHku47ooajjgIHku47ku47ooajvvIlcbiAgICogQHBhcmFtIGlkIOimgeWkjeWItueahOihjFxuICAgKiBAcGFyYW0gcGF0aCDor7fmsYLot6/lvoRcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwdWJsaWMgY2xvbmUoaWQ6IHN0cmluZywgcGF0aDogc3RyaW5nKSB7XG4gICAgaWYgKCFpZCkge1xuICAgICAgdGhpcy5mb3JtTm90aWZ5U2VydmljZS53YXJuaW5nKHRoaXMubGFuZ3VhZ2VTZXJ2aWNlLnBsc1NlbGVjdENvcHlEYXRhLCB7IGhpZGVUaXRsZTogdHJ1ZSB9KTtcbiAgICAgIHJldHVybiBFTVBUWTtcbiAgICB9XG4gICAgaWYgKCFwYXRoKSB7XG4gICAgICB0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlLndhcm5pbmcodGhpcy5sYW5ndWFnZVNlcnZpY2UucGF0aElzUmVxdWlyZWQsIHsgaGlkZVRpdGxlOiB0cnVlIH0pO1xuICAgICAgcmV0dXJuIEVNUFRZO1xuICAgIH1cbiAgICBpZiAoIXBhdGguc3RhcnRzV2l0aCgnLycpKSB7XG4gICAgICBwYXRoID0gJy8nICsgcGF0aDtcbiAgICB9XG4gICAgcGF0aCA9IHBhdGgudG9Mb3dlckNhc2UoKTtcbiAgICBjb25zdCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoO1xuICAgIGNvbnN0IGJlZlJlcG9zaXRvcnkgPSB0aGlzLnJlcG9zaXRvcnkgYXMgQmVmUmVwb3NpdG9yeTxhbnk+O1xuICAgIGNvbnN0IGJhc2VVcmkgPSBiZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgdXJsID0gYCR7YmFzZVVyaX0ke3BhdGh9YDtcbiAgICBjb25zdCByZXF1ZXN0SW5mbyA9IGJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpO1xuICAgIGNvbnN0IGlkcyA9IHRoaXMuYnVpbGRJZHMoYmluZGluZ1BhdGgpO1xuICAgIGlkcy5wdXNoKGlkKTtcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgcmVxdWVzdEluZm8sXG4gICAgICBkYXRhSUQ6IGlkcy5qb2luKCcsJylcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBib2R5XG4gICAgfTtcbiAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgcmV0dXJuIGJlZlJlcG9zaXRvcnkucHJveHkucmVxdWVzdCh1cmwsICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSksXG4gICAgICBtYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgIGNvbnN0IHJldHVyblZhbHVlID0gcmVzcG9uc2VJbmZvLnJldHVyblZhbHVlO1xuICAgICAgICBsZXQgZW50aXR5ID0gbnVsbDtcbiAgICAgICAgaWYgKGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgZW50aXR5ID0gdGhpcy5yZXBvc2l0b3J5LmJ1aWxkRW50aXR5KHJldHVyblZhbHVlKTtcbiAgICAgICAgICB0aGlzLnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5hZGRFbnRpdHkoZW50aXR5LCB0cnVlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBmcGF0aCA9IHRoaXMuYnVpbGRQYXRoKGJpbmRpbmdQYXRoLCB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCk7XG4gICAgICAgICAgZW50aXR5ID0gYmVmUmVwb3NpdG9yeS5lbnRpdHlNYW5hZ2VyLmFwcGVuZEVudGl0eUJ5UGF0aChmcGF0aCwgcmV0dXJuVmFsdWUsIHJldHVyblZhbHVlLCB0cnVlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZW50aXR5O1xuICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIC8vI3JlZ2lvbiDml6fnmoTlrp7njrBcblxuICAvKipcbiAgICog5aSN5Yi26KGMXG4gICAqIEBwYXJhbSBmcmFtZUlkIGZyYW1lSWRcbiAgICogQHBhcmFtIGlnbm9yZUZpZWxkcyDlpI3liLbml7blv73nlaXlrZfmrrVcbiAgICogQHBhcmFtIHJlcGVhdCDph43lpI3lpI3liLbmrKHmlbDvvIzpu5jorqTkuLoxXG4gICAqL1xuICBwdWJsaWMgY29weVJvdyhmcmFtZUlkOiBzdHJpbmcsIGlnbm9yZUZpZWxkczogc3RyaW5nLCByZXBlYXQ6IG51bWJlciA9IDEpIHtcbiAgICBpZiAodHlwZW9mIHJlcGVhdCAhPT0gJ251bWJlcicpIHtcbiAgICAgIHJlcGVhdCA9IHBhcnNlSW50KHJlcGVhdCwgMTApO1xuICAgIH1cbiAgICBpZiAocmVwZWF0IDwgMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcmd1bWVudEVycm9yOiByZXBlYXQgbXVzdCA+PSAxJyk7XG4gICAgfVxuICAgIC8vIOiOt+WPluW9k+WJjeihjFxuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKTtcbiAgICBjb25zdCBwcmltYXJ5VmFsdWUgPSBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XG4gICAgY29uc3QgYmluZGluZ1BhdGggPSBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoIHx8ICcvJztcbiAgICBsZXQgYmluZGluZ0RhdGEgPSBudWxsO1xuICAgIGxldCBjdXJyZW50SXRlbTogQmluZGluZ09iamVjdCA9IG51bGw7XG4gICAgaWYgKGJpbmRpbmdQYXRoID09PSAnLycpIHtcbiAgICAgIC8vIOS4u+ihqOebtOaOpeWPluW9k+WJjeihjFxuICAgICAgY3VycmVudEl0ZW0gPSBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SXRlbTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8g5Y+W5LuO6KGoL+S7juS7juihqOW9k+WJjeihjFxuICAgICAgY29uc3QgcGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgICAgY3VycmVudEl0ZW0gPSAoZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmdldFZhbHVlKHBhdGhzKSBhcyBCaW5kaW5nTGlzdCkuY3VycmVudEl0ZW07XG4gICAgfVxuICAgIGJpbmRpbmdEYXRhID0gY3VycmVudEl0ZW0udG9KU09OKCk7XG4gICAgaWYgKCFjdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUpIHtcbiAgICAgIGlmICh0aGlzLmZvcm1Ob3RpZnlTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMuZm9ybU5vdGlmeVNlcnZpY2Uud2FybmluZyh0aGlzLmxhbmd1YWdlU2VydmljZS5wbHNTZWxlY3RDb3B5RGF0YSwgeyBoaWRlVGl0bGU6IHRydWUgfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfVxuICAgIGNvbnN0IGlnbm9yZUZpZWxkc0FycmF5ID0gaWdub3JlRmllbGRzLnNwbGl0KCcsJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XG5cbiAgICBjb25zdCBzb3VyY2VzID0gbmV3IEFycmF5KHJlcGVhdCk7XG4gICAgcmV0dXJuIGZyb20oc291cmNlcykucGlwZShcbiAgICAgIGNvbmNhdE1hcCgoKSA9PiB7XG4gICAgICAgIGxldCBhY3Rpb24kID0gbnVsbDtcbiAgICAgICAgaWYgKGJpbmRpbmdQYXRoICE9PSAnLycpIHtcbiAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IHRoaXMuYnVpbGRQYXRoKGJpbmRpbmdQYXRoLCBwcmltYXJ5VmFsdWUpO1xuICAgICAgICAgIGFjdGlvbiQgPSB0aGlzLnJlcG9zaXRvcnkuYXBwZW5kQnlQYXRoKGZ1bGxQYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBhY3Rpb24kID0gdGhpcy5yZXBvc2l0b3J5LmFwcGVuZCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY3Rpb24kLnBpcGUoXG4gICAgICAgICAgdGFwKChlbnRpdHk6IEVudGl0eSkgPT4ge1xuICAgICAgICAgICAgLy8g5L+u5q2j5a6e5L2T5Li76ZSuXG4gICAgICAgICAgICBiaW5kaW5nRGF0YVtlbnRpdHkucHJpbWFyeUtleV0gPSBlbnRpdHkucHJpbWFyeVZhbHVlO1xuICAgICAgICAgICAgLy8g5b+955Wl5oyH5a6a5a2X5q61XG4gICAgICAgICAgICBpZ25vcmVGaWVsZHNBcnJheS5mb3JFYWNoKChmaWVsZDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGV4dHJhY3RlZEZpZWxkcyA9IGZpZWxkLnNwbGl0KCcuJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XG4gICAgICAgICAgICAgIGlmIChleHRyYWN0ZWRGaWVsZHMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgZGVsZXRlIGJpbmRpbmdEYXRhW2ZpZWxkXTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBleHRyYWN0ZWRGaWVsZHMuc2xpY2UoMCwgLTEpLnJlZHVjZSgocHJldiwgY3VycmVudCwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldltjdXJyZW50XTtcbiAgICAgICAgICAgICAgfSwgYmluZGluZ0RhdGEpO1xuICAgICAgICAgICAgICBkZWxldGUgcGFyZW50W2V4dHJhY3RlZEZpZWxkc1tleHRyYWN0ZWRGaWVsZHMubGVuZ3RoIC0gMV1dO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBiaW5kaW5nRGF0YSA9IE9iamVjdC5hc3NpZ24oe30sIGVudGl0eS50b0pTT04oKSwgYmluZGluZ0RhdGEpO1xuICAgICAgICAgICAgZW50aXR5LmxvYWQoYmluZGluZ0RhdGEsIHsgbG9hZENoaWxkOiBmYWxzZSB9KTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBFTVBUWTtcbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDlop7ph4/lpJrpgInluK7liqnmibnph4/otYvlgLzluK7liqnlkI7kuovku7ZcbiAgICogQHBhcmFtIGZyYW1lSWQgZnJhbWVJZFxuICAgKiBAcGFyYW0gbWFwRmllbGRzIOWtl+auteaYoOWwhFxuICAgKiBAcGFyYW0gYXNzb2NpYXRlZEZpZWxkIOWFs+iBlOWtl+autVxuICAgKi9cbiAgcHVibGljIGFmdGVySW5jcmVtZW50YWxTZWxlY3RIZWxwQ2xvc2UoZnJhbWVJZDogc3RyaW5nLCBtYXBGaWVsZHM6IHN0cmluZywgYXNzb2NpYXRlZEZpZWxkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBzZWxmOiBhbnkgPSB0aGlzO1xuICAgIGNvbnN0IHJlc3VsdCA9IHNlbGYuY29udGV4dCAmJiBzZWxmLmNvbnRleHQuZXZlbnRQYXJhbSB8fCBbXTtcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1heC1saW5lLWxlbmd0aFxuICAgIC8vIGNvbnN0IG1hcHBpbmcgPSAne1wiaWRcIjpcInVzZXJSZWYudXNlclJlZlwiLCBcIm5hbWVcIjpcIm5hbWVcIiwgXCJzZXhcIjpcInNleFwiLFwiYWdlXCI6XCJ1c2VyUmVmLnVzZXJSZWZfQWdlXCIsXCJhZGRyZXNzXCI6XCJ1c2VyUmVmLnVzZXJSZWZfQWRkcmVzc1wiLFwiYmlydGhkYXlcIjpcInVzZXJSZWYudXNlclJlZl9CaXJ0aGRheVwiLFwiaGVpZ2h0XCI6XCJ1c2VyUmVmLnVzZXJSZWZfSGVpZ2h0XCIsXCJpc01hcnJpZWRcIjpcInVzZXJSZWYudXNlclJlZl9Jc01hcnJpZWRcIn0nO1xuICAgIGlmICghYXNzb2NpYXRlZEZpZWxkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2Fzc29jaWF0ZWQgZmllbGQgY2FuYHQgYmUgZW1wdHkuJyk7XG4gICAgfVxuICAgIGlmICghbWFwRmllbGRzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ21hcEZpZWxkcyBjYW5gdCBiZSBlbXB0eS4nKTtcbiAgICB9XG4gICAgY29uc3QgbWFwcGluZ3MgPSBKU09OLnBhcnNlKG1hcEZpZWxkcyk7XG4gICAgY29uc3QgZm9yZWlnbktleSA9IGFzc29jaWF0ZWRGaWVsZDtcbiAgICAvLyDlsIbpgInmi6nkurrlkZjkv53lrZjliLB1aXN0YXRl5LitXG4gICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dCA9IHRoaXMudmlld01vZGVsLmZyYW1lQ29udGV4dC5yb290O1xuICAgIC8vIOS4jeaYr2JpbmRpbmdQYXRo5YiZ5oyJZnJhbWVJZOWkhOeQhlxuICAgIGxldCBiaW5kaW5nUGF0aCA9ICcvJztcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy5pbmplY3Rvci5nZXQ8QXBwQ29udGV4dD4oQXBwQ29udGV4dCwgbnVsbCk7XG4gICAgaWYgKGFwcENvbnRleHQpIHtcbiAgICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKGZyYW1lSWQpO1xuICAgICAgaWYgKGZyYW1lQ29udGV4dCkge1xuICAgICAgICBiaW5kaW5nUGF0aCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ1BhdGggfHwgJy8nO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdmcmFtZUlkIGlzIGludmFsaWQhJyk7XG4gICAgICB9XG4gICAgfVxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc3RyaW5nLWxpdGVyYWxcbiAgICByb290RnJhbWVDb250ZXh0LnVpU3RhdGVbJ3NlbGVjdGlvbnMnXSA9IHJlc3VsdDtcbiAgICBpZiAocmVzdWx0ICYmIEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgLy8g5qC55o2uYmluZGluZ1BhdGjojrflj5ZiaW5kaW5nZGF0YeS4reeOsOacieaVsOaNrlxuICAgICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIoaXRlbSA9PiBpdGVtKTtcbiAgICAgIGNvbnN0IGN1cnJlbnREYXRhOiBCaW5kaW5nTGlzdCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmdldFZhbHVlKGJpbmRpbmdQYXRocyk7XG4gICAgICBjb25zdCBjdXJyZW50RGF0YUFycmF5ID0gY3VycmVudERhdGEudG9BcnJheSgpO1xuICAgICAgLy8g5om+5YiwcmVzdWx05Lit5pyJ77yM5L2GYmluZGluZ0RhdGHkuK3msqHmnInnmoTvvIzkuLrlvoXmlrDlop7poblcbiAgICAgIGNvbnN0IGFwcGVuZHMgPSBbXTtcbiAgICAgIHJlc3VsdC5yZWR1Y2UoKHByZXY6IEFycmF5PGFueT4sIGl0ZW0pID0+IHtcbiAgICAgICAgY29uc3QgaXRlbUlkID0gaXRlbSAmJiBpdGVtW2N1cnJlbnREYXRhLnByaW1hcnlLZXldIHx8IG51bGw7XG4gICAgICAgIGNvbnN0IGlzRXhpc3QgPSBjdXJyZW50RGF0YUFycmF5LmZpbmQoKGJpbmRpbmdPYmplY3Q6IEJpbmRpbmdPYmplY3QpID0+IGJpbmRpbmdPYmplY3RbZm9yZWlnbktleV1bZm9yZWlnbktleV0gPT09IGl0ZW1JZCk7XG4gICAgICAgIGlmICghaXNFeGlzdCkge1xuICAgICAgICAgIHByZXYucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcHJldjtcbiAgICAgIH0sIGFwcGVuZHMpO1xuXG4gICAgICAvLyDmib7liLBiaW5kaW5nRGF0YeS4reacie+8jHJlc3VsdOS4reayoeacieeahO+8jOS4uuW+heWIoOmZpOmhuVxuICAgICAgY29uc3QgcmVtb3ZlcyA9IFtdO1xuICAgICAgY3VycmVudERhdGFBcnJheS5yZWR1Y2UoKHJlc3VsdHM6IGFueSwgaXRlbTogQmluZGluZ09iamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBpbmRleCA9IHJlc3VsdC5maW5kSW5kZXgoc2VsZWN0SXRlbSA9PiBzZWxlY3RJdGVtW2N1cnJlbnREYXRhLnByaW1hcnlLZXldID09PSBpdGVtW2ZvcmVpZ25LZXldW2ZvcmVpZ25LZXldKTtcbiAgICAgICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVtLnByaW1hcnlLZXlWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdHM7XG4gICAgICB9LCByZW1vdmVzKTtcblxuICAgICAgLy8gY29uc29sZS5sb2coJ2FkZEl0ZW1zJywgYXBwZW5kcywgJ3JlbW92ZUl0ZW1zJywgcmVtb3Zlcyk7XG4gICAgICAvLyDosIPnlKjlkI7nq6/mjqXlj6PmlrDlop7mlbDmja5cbiAgICAgIGNvbnN0IGFkZEFjdGlvbiQgPSBmcm9tKGFwcGVuZHMpLnBpcGUoXG4gICAgICAgIGNvbmNhdE1hcChpdGVtID0+IHtcbiAgICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5idWlsZFBhdGgoYmluZGluZ1BhdGgsIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkKTtcbiAgICAgICAgICByZXR1cm4gdGhpcy5yZXBvc2l0b3J5LmFwcGVuZEJ5UGF0aChwYXRoKS5waXBlKFxuICAgICAgICAgICAgdGFwKChlbnRpdHk6IEVudGl0eSkgPT4ge1xuICAgICAgICAgICAgICBPYmplY3Qua2V5cyhtYXBwaW5ncykuZm9yRWFjaChwcm9wID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0VmFsdWVCeVBhdGgoaXRlbSwgcHJvcCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZmllbGRzID0gbWFwcGluZ3NbcHJvcF07XG4gICAgICAgICAgICAgICAgY29uc3QgZ3JvdXBzOiBhbnlbXSA9IGZpZWxkcy5zcGxpdCgnLCcpLmZpbHRlcihwID0+IHApO1xuICAgICAgICAgICAgICAgIGdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gZ3JvdXAuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICAgICAgICAgIHRoaXMuc2V0VmFsdWVCeVBhdGgoZW50aXR5LCBwYXRocy5qb2luKCcuJyksIHZhbHVlKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICBjb25zdCByZW1vdmVBY3Rpb24kID0gZnJvbShyZW1vdmVzKS5waXBlKFxuICAgICAgICBjb25jYXRNYXAoaXRlbSA9PiB7XG4gICAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuYnVpbGRQYXRoKGJpbmRpbmdQYXRoLCB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5saXN0LmN1cnJlbnRJZCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeS5yZW1vdmVCeVBhdGgocGF0aCwgaXRlbSkucGlwZShcbiAgICAgICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGJlZlJlcG9zaXRvcnk6IEJlZlJlcG9zaXRvcnk8YW55PiA9IHRoaXMucmVwb3NpdG9yeSBhcyBCZWZSZXBvc2l0b3J5PGFueT47XG4gICAgICAgICAgICAgIGJlZlJlcG9zaXRvcnkuZW50aXR5TWFuYWdlci5yZW1vdmVFbnRpdHlCeVBhdGgocGF0aCwgaXRlbSk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgICAgaWYgKCFhcHBlbmRzICYmICFyZW1vdmVzIHx8IGFwcGVuZHMgJiYgYXBwZW5kcy5sZW5ndGggPCAxICYmIHJlbW92ZXMgJiYgcmVtb3Zlcy5sZW5ndGggPCAxKSB7XG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBjb25jYXQoYWRkQWN0aW9uJCwgcmVtb3ZlQWN0aW9uJCkucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBFTVBUWSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBvZih0cnVlKTtcbiAgfVxuICAvLyB0b2RvOuaooeaLn+eUqOaIt+aTjeS9nO+8jOW+heWQjuerr+aOpeWPo+aUr+aMgeS4u+ihqOaJuemHj+aWsOWinuWQjumHjeWGmVxuICAvKipcbiAgICog5aSa6YCJ5biu5Yqp5om56YeP6LWL5YC85biu5Yqp5YmN5LqL5Lu2XG4gICAqL1xuICBwdWJsaWMgYmVmb3JlTXVsdGlTZWxlY3RIZWxwT3BlbigpIHtcbiAgICByZXR1cm4gdGhpcy5jbGVhckhlbHBTZWxlY3Rpb25zKCk7XG4gIH1cbiAgLyoqXG4gICAqIOWkmumAieW4ruWKqeaJuemHj+i1i+WAvOW4ruWKqeWQjuS6i+S7tlxuICAgKiBAcGFyYW0gZnJhbWVJZCDnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIG1hcEZpZWxkcyDlrZfmrrXmmKDlsIRcbiAgICogQHBhcmFtIGNvbW1hbmRGcmFtZUlkIOWbnuiwg+WRveS7pOaJgOWcqGZyYW1lSWRcbiAgICogQHBhcmFtIGNvbW1hbmROYW1lIOWbnuiwg+WRveS7pFxuICAgKiBAZGVwcmVjYXRlZCDmqKHmi5/nlKjmiLfmk43kvZzvvIzlvoXmibnph4/otYvlgLzmlK/mjIHkuLvooajlkI7lup/lvINcbiAgICovXG4gIHB1YmxpYyBhZnRlck11bHRpU2VsZWN0SGVscENsb3NlKGZyYW1lSWQ6IHN0cmluZywgbWFwRmllbGRzOiBzdHJpbmcsIGNvbW1hbmRGcmFtZUlkPzogc3RyaW5nLCBjb21tYW5kTmFtZT86IHN0cmluZykge1xuICAgIGNvbnN0IHNlbGY6IGFueSA9IHRoaXM7XG4gICAgY29uc3QgcmVzdWx0ID0gc2VsZi5jb250ZXh0ICYmIHNlbGYuY29udGV4dC5ldmVudFBhcmFtIHx8IFtdO1xuICAgIGlmIChyZXN1bHQgJiYgQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICAvLyDosIPnlKjlkI7nq6/mjqXlj6PmlrDlop7mlbDmja5cbiAgICAgIGlmICghcmVzdWx0IHx8IHJlc3VsdC5sZW5ndGggPCAxKSB7XG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgIH1cbiAgICAgIHRoaXMub25IZWxwQ2xvc2UubmV4dCh7IGZyYW1lSWQsIG1hcEZpZWxkcywgZGF0YTogcmVzdWx0LCBjb21tYW5kRnJhbWVJZCwgY29tbWFuZE5hbWUgfSk7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuICAgIHJldHVybiBvZih0cnVlKTtcbiAgfVxuICAvKipcbiAgICAqIOW4ruWKqeWFs+mXreWQjuWkhOeQhuWZqFxuICAgICogQHBhcmFtIGZyYW1lSWQgZnJhbWVpZFxuICAgICogQHBhcmFtIG1hcEZpZWxkcyBtYXBGaWVsZHNcbiAgICAqIEBwYXJhbSByZXN1bHQg5biu5Yqp5pWw5o2u57uT5p6cXG4gICAgKi9cbiAgcHJpdmF0ZSBvbkhlbHBDbG9zZUhhbmRsZXIoZnJhbWVJZDogc3RyaW5nLCBtYXBGaWVsZHM6IHN0cmluZywgcmVzdWx0OiBhbnlbXSkge1xuICAgIGlmICghbWFwRmllbGRzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ21hcEZpZWxkcyBjYW5gdCBiZSBlbXB0eS4nKTtcbiAgICB9XG4gICAgY29uc3QgbWFwcGluZ3MgPSBKU09OLnBhcnNlKG1hcEZpZWxkcyk7XG4gICAgLy8g5LiN5pivYmluZGluZ1BhdGjliJnmjIlmcmFtZUlk5aSE55CGXG4gICAgbGV0IGJpbmRpbmdQYXRoID0gJy8nO1xuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcbiAgICBpZiAoYXBwQ29udGV4dCkge1xuICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCk7XG4gICAgICBpZiAoZnJhbWVDb250ZXh0KSB7XG4gICAgICAgIGJpbmRpbmdQYXRoID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aCB8fCAnLyc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ZyYW1lSWQgaXMgaW52YWxpZCEnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8g5bCG6YCJ5oup5Lq65ZGY5L+d5a2Y5YiwdWlzdGF0ZeS4rVxuICAgIGNvbnN0IHJvb3RGcmFtZUNvbnRleHQgPSB0aGlzLnZpZXdNb2RlbC5mcmFtZUNvbnRleHQucm9vdDtcbiAgICBjb25zdCBiZWZSZXBvc2l0b3J5ID0gdGhpcy5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8YW55PjtcbiAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tc3RyaW5nLWxpdGVyYWxcbiAgICByb290RnJhbWVDb250ZXh0LnVpU3RhdGVbJ3NlbGVjdGlvbnMnXSA9IHJlc3VsdDtcbiAgICBpZiAocmVzdWx0ICYmIEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgICAgY29uc3QgYWRkQWN0aW9uJCA9IGZyb20ocmVzdWx0KS5waXBlKFxuICAgICAgICBjb25jYXRNYXAoaXRlbSA9PiB7XG4gICAgICAgICAgY29uc3QgcmVxdWVzdEluZm8gPSBiZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKTtcbiAgICAgICAgICBpZiAoYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSB0aGlzLmJ1aWxkUGF0aChiaW5kaW5nUGF0aCwgdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQpO1xuICAgICAgICAgICAgcmV0dXJuIGJlZlJlcG9zaXRvcnkucmVzdFNlcnZpY2UuY3JlYXRlQnlQYXRoKHBhdGgsIHJlcXVlc3RJbmZvKS5waXBlKFxuICAgICAgICAgICAgICB0YXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZTtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdFbnRpdHkgPSBiZWZSZXBvc2l0b3J5LmVudGl0eU1hbmFnZXIuYXBwZW5kRW50aXR5QnlQYXRoKHBhdGgsIGRhdGEsIGRhdGEpO1xuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKG1hcHBpbmdzKS5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW0sIHByb3ApO1xuICAgICAgICAgICAgICAgICAgY29uc3QgZmllbGRzID0gbWFwcGluZ3NbcHJvcF07XG4gICAgICAgICAgICAgICAgICBjb25zdCBncm91cHM6IGFueVtdID0gZmllbGRzLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgICAgICAgICAgICAgICBncm91cHMuZm9yRWFjaChncm91cCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gZ3JvdXAuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZUJ5UGF0aChuZXdFbnRpdHksIHBhdGhzLmpvaW4oJy4nKSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ld0VudGl0eTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBiZWZSZXBvc2l0b3J5LnJlc3RTZXJ2aWNlLmNyZWF0ZShudWxsLCByZXF1ZXN0SW5mbykucGlwZShcbiAgICAgICAgICAgICAgdGFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGEgPSByZXNwb25zZUluZm8ucmV0dXJuVmFsdWU7XG4gICAgICAgICAgICAgICAgY29uc3QgbmV3RW50aXR5ID0gdGhpcy5yZXBvc2l0b3J5LmJ1aWxkRW50aXR5KGRhdGEpO1xuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKG1hcHBpbmdzKS5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGl0ZW0sIHByb3ApO1xuICAgICAgICAgICAgICAgICAgY29uc3QgZmllbGRzID0gbWFwcGluZ3NbcHJvcF07XG4gICAgICAgICAgICAgICAgICBjb25zdCBncm91cHM6IGFueVtdID0gZmllbGRzLnNwbGl0KCcsJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgICAgICAgICAgICAgICBncm91cHMuZm9yRWFjaChncm91cCA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhdGhzID0gZ3JvdXAuc3BsaXQoJy4nKS5maWx0ZXIocCA9PiBwKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRWYWx1ZUJ5UGF0aChuZXdFbnRpdHksIHBhdGhzLmpvaW4oJy4nKSwgdmFsdWUpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXBvc2l0b3J5LmVudGl0eUNvbGxlY3Rpb24uYWRkRW50aXR5KG5ld0VudGl0eSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ld0VudGl0eTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICAgIC8vIGNvbnN0IGZvcm1Mb2FkaW5nU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0PEZvcm1Mb2FkaW5nU2VydmljZT4oRm9ybUxvYWRpbmdTZXJ2aWNlLCBudWxsKTtcbiAgICAgIGlmICh0aGlzLmZvcm1Mb2FkaW5nU2VydmljZSkge1xuICAgICAgICB0aGlzLnN1c3BlbmRGcmFtZUNvbnRleHRFdmVudChmcmFtZUlkKTtcbiAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2Uuc2hvdygpO1xuICAgICAgICB0aGlzLmZvcm1Mb2FkaW5nU2VydmljZS5zZXRTdXNwZW5kKHRydWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFkZEFjdGlvbiQucGlwZShcbiAgICAgICAgbGFzdCgpLFxuICAgICAgKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHByaW1hcnlWYWx1ZSA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICAgICAgICAgIGlmIChwcmltYXJ5VmFsdWUpIHtcbiAgICAgICAgICAgIHJldHVybiBiZWZSZXBvc2l0b3J5LnVwZGF0ZUNoYW5nZXNCeUlkKHByaW1hcnlWYWx1ZSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBvZihudWxsKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmZvcm1Mb2FkaW5nU2VydmljZSkge1xuICAgICAgICAgIHRoaXMucmVzdW1lRnJhbWVDb250ZXh0RXZlbnQoZnJhbWVJZCk7XG4gICAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2Uuc2V0U3VzcGVuZChmYWxzZSk7XG4gICAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgICB9XG4gICAgICB9LCAoKSA9PiB7XG4gICAgICAgIGlmICh0aGlzLmZvcm1Mb2FkaW5nU2VydmljZSkge1xuICAgICAgICAgIHRoaXMucmVzdW1lRnJhbWVDb250ZXh0RXZlbnQoZnJhbWVJZCk7XG4gICAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2Uuc2V0U3VzcGVuZChmYWxzZSk7XG4gICAgICAgICAgdGhpcy5mb3JtTG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG9mKG51bGwpO1xuICB9XG4gIHByaXZhdGUgc3VzcGVuZEZyYW1lQ29udGV4dEV2ZW50KGZyYW1lSWQ6IHN0cmluZykge1xuICAgIGNvbnN0IGFwcENvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxBcHBDb250ZXh0PihBcHBDb250ZXh0LCBudWxsKTtcbiAgICBpZiAoYXBwQ29udGV4dCkge1xuICAgICAgY29uc3QgZnJhbWVDb250ZXh0ID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZCk7XG4gICAgICBmcmFtZUNvbnRleHQuc3VzcGVuZCA9IHRydWU7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgcmVzdW1lRnJhbWVDb250ZXh0RXZlbnQoZnJhbWVJZDogc3RyaW5nKSB7XG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHQ+KEFwcENvbnRleHQsIG51bGwpO1xuICAgIGlmIChhcHBDb250ZXh0KSB7XG4gICAgICBjb25zdCBmcmFtZUNvbnRleHQgPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0QnlJZChmcmFtZUlkKTtcbiAgICAgIGZyYW1lQ29udGV4dC5zdXNwZW5kID0gZmFsc2U7XG4gICAgICBmcmFtZUNvbnRleHQuYXBwQ29udGV4dC5tZXNzYWdlUGlwZS5uZXh0KCdiaW5kRGF0YScpO1xuICAgIH1cbiAgfVxuXG4gIC8vI2VuZHJlZ2lvblxuICBwcml2YXRlIHNldFZhbHVlQnlQYXRoKHRhcmdldDogb2JqZWN0LCBwYXRoOiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICBpZiAodGFyZ2V0KSB7XG4gICAgICBjb25zdCBwYXRocyA9IHBhdGguc3BsaXQoJy4nKTtcbiAgICAgIGlmIChwYXRocy5sZW5ndGggPD0gMSkge1xuICAgICAgICB0YXJnZXRbcGF0aF0gPSB2YWx1ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhdGhzLnNsaWNlKDAsIC0xKS5yZWR1Y2UoKHByZXYsIHBhdGgpID0+IHtcbiAgICAgICAgICBpZiAoIShwcmV2Lmhhc093blByb3BlcnR5KHBhdGgpIHx8IHByZXZbJ19fcHJvdG9fXyddLmhhc093blByb3BlcnR5KHBhdGgpKSkge1xuICAgICAgICAgICAgcHJldltwYXRoXSA9IHt9O1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcHJldltwYXRoXTtcbiAgICAgICAgfSwgdGFyZ2V0KVtwYXRoc1twYXRocy5sZW5ndGggLSAxXV0gPSB2YWx1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSBnZXRWYWx1ZUJ5UGF0aCh0YXJnZXQ6IG9iamVjdCwgcGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgcGF0aHMgPSBwYXRoLnNwbGl0KCcuJyk7XG4gICAgaWYgKHBhdGhzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHBhdGhzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuIHRhcmdldFtwYXRoXTtcbiAgICB9XG4gICAgbGV0IHJlc3VsdCA9IG51bGw7XG4gICAgcGF0aHMuZm9yRWFjaCgocHJvcCwgaW5kZXgpID0+IHtcbiAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICByZXN1bHQgPSB0YXJnZXQgJiYgdGFyZ2V0W3Byb3BdIHx8IG51bGw7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXN1bHQgPSByZXN1bHQgJiYgcmVzdWx0W3Byb3BdIHx8IG51bGw7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuICAvKipcbiAgICog5p6E6YCg5a2Q6KGo6Lev5b6EXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCDnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIGlkIGlkXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkUGF0aChiaW5kaW5nUGF0aDogc3RyaW5nLCBpZDogYW55KSB7XG4gICAgbGV0IHBhdGggPSAnLycgKyBpZDtcbiAgICBjb25zdCBzdWJQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XG4gICAgaWYgKHN1YlBhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIGVnOmJpbmRpbmdQYXRo5b2i5aaCL2VkdXMvZ3JhZGVzLHNwbGl05ZCO5pivWycnLCAnZWR1cycsICdncmFkZXMnXVxuICAgICAgLy8g5Zug5q2kaW5kZXjku44x5byA5aeLXG4gICAgICBmb3IgKGxldCBpbmRleCA9IDE7IGluZGV4IDwgc3ViUGF0aHMubGVuZ3RoIC0gMTsgaW5kZXgrKykge1xuICAgICAgICBjb25zdCBzdWJQYXRoID0gc3ViUGF0aHNbaW5kZXhdO1xuICAgICAgICBjb25zdCBzdWJEYXRhID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGFbc3ViUGF0aF07XG4gICAgICAgIGlmICghc3ViRGF0YSB8fCAhc3ViRGF0YS5jdXJyZW50SWQpIHtcbiAgICAgICAgICB0aHJvdyBFcnJvcihg6I635Y+W5a2Q6KGo5a6M5pW06Lev5b6E5Ye66ZSZ77yM5om+5LiN5YiwJHtzdWJEYXRhfeWvueW6lOeahOWtkOihqO+8jOaIluWvueW6lOWtkOihqOayoeacieW9k+WJjeihjOOAgmApO1xuICAgICAgICB9XG4gICAgICAgIHBhdGggKz0gYC8ke3N1YlBhdGh9LyR7c3ViRGF0YS5jdXJyZW50SWR9YDtcbiAgICAgIH1cbiAgICB9XG4gICAgcGF0aCArPSAnLycgKyBzdWJQYXRoc1tzdWJQYXRocy5sZW5ndGggLSAxXTtcblxuICAgIHJldHVybiBwYXRoO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5bnu5Hlrprot6/lvoTnmoTlvZPliY3ooYzmlbDnu4RcbiAgICogQHBhcmFtIGJpbmRpbmdQYXRoIGJpbmRpbmdQYXRoXG4gICAqIEByZXR1cm5zIFxuICAgKi9cbiAgcHJpdmF0ZSBidWlsZElkcyhiaW5kaW5nUGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGJpbmRpbmdQYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgY29uc3QgcHJpbWFyeVZhbHVlID0gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEubGlzdC5jdXJyZW50SWQ7XG4gICAgY29uc3QgcmVzdWx0ID0gW107XG4gICAgY29uc3QgcGF0aHMgPSBbXTtcbiAgICBpZiAoYmluZGluZ1BhdGhzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJlc3VsdC5wdXNoKHByaW1hcnlWYWx1ZSk7XG4gICAgICAvLyDku47ooajmiJbku47ku47ooajopoHlpI3liLbnmoTooYzkuI3kuIDlrprmmK/lvZPliY3ooYzvvIznlKjmiLflj6/ku6XmjIflrppcbiAgICAgIGJpbmRpbmdQYXRocy5wb3AoKTtcbiAgICAgIGJpbmRpbmdQYXRocy5mb3JFYWNoKChwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgcGF0aHMucHVzaChwYXRoKTtcbiAgICAgICAgY29uc3QgYmluZGluZ0xpc3QgPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgICAgIGlmIChiaW5kaW5nTGlzdCkge1xuICAgICAgICAgIHJlc3VsdC5wdXNoKGJpbmRpbmdMaXN0LmN1cnJlbnRJZCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHByaXZhdGUgdXBkYXRlQmluZGluZ0RhdGEoaW5wdXQ6IGFueSwgaWRzOiBBcnJheTxhbnk+KSB7XG4gICAgY29uc3QgeyBjb250cm9sVHlwZSA9IG51bGwsIHZhbHVlID0gbnVsbCwgb3B0aW9ucyA9IHt9LCBkYXRhVHlwZSA9IG51bGwgfSA9IGlucHV0IHx8IHt9O1xuICAgIGlmIChjb250cm9sVHlwZSkge1xuICAgICAgLy8g5a+55biu5Yqp5YGa54m55q6K5aSE55CGXG4gICAgICBpZiAoY29udHJvbFR5cGUgPT09ICdsb29rdXAnIHx8IGNvbnRyb2xUeXBlID09PSAnY29tYm8tbG9va3VwJykge1xuICAgICAgICBjb25zdCBtYXBGaWVsZHMgPSBvcHRpb25zLm1hcEZpZWxkcztcbiAgICAgICAgdGhpcy51cGRhdGVMb29rdXBGaWVsZChpZHMsIHZhbHVlLCBtYXBGaWVsZHMpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy51cGRhdGVTaW1wbGVGaWVsZChpZHMsIHZhbHVlLCBpbnB1dCk7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIHByaXZhdGUgdXBkYXRlU2ltcGxlRmllbGQoaWRzOiBBcnJheTxhbnk+LCB2YWx1ZTogYW55LCBjb2x1bW46IGFueSkge1xuICAgIGlmICghY29sdW1uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGN1cnJlbnRDb2x1bW5UeXBlID0gY29sdW1uLmRhdGFUeXBlO1xuICAgIC8vIOWtmOWcqOihjOe8lui+keWZqFxuICAgIGxldCByZXN1bHQgPSB2YWx1ZTtcbiAgICBpZiAoY3VycmVudENvbHVtblR5cGUgPT09ICdkYXRlJykge1xuICAgICAgbGV0IGRhdGVTdHIgPSB0aGlzLmRhdGVTZXJ2aWNlLmZvcm1hdFRvKHZhbHVlLCAneXl5eS1NTS1kZCcpO1xuICAgICAgaWYgKCFkYXRlU3RyKSB7XG4gICAgICAgIGRhdGVTdHIgPSAnMDAwMS0wMS0wMVQwMDowMDowMCc7XG4gICAgICB9XG4gICAgICByZXN1bHQgPSBkYXRlU3RyO1xuICAgIH0gZWxzZSBpZiAoY3VycmVudENvbHVtblR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICByZXN1bHQgPSBOdW1iZXIodmFsdWUpIHx8IDA7XG4gICAgfVxuICAgIGNvbnN0IGZpZWxkID0gY29sdW1uLmZpZWxkO1xuICAgIGlkcy5mb3JFYWNoKGlkID0+IHtcbiAgICAgIHRoaXMudXBkYXRlQmluZGluZ0xpc3QoaWQsIGZpZWxkLCByZXN1bHQpO1xuICAgIH0pO1xuICB9XG4gIHByaXZhdGUgdXBkYXRlTG9va3VwRmllbGQoaWRzOiBBcnJheTxhbnk+LCBoZWxwRGF0YTogYW55LCBtYXBGaWVsZHM6IGFueSkge1xuICAgIGlmICghbWFwRmllbGRzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBoZWxwRmllbGRzID0gT2JqZWN0LmtleXMobWFwRmllbGRzKTtcbiAgICBjb25zdCBpZEluZGV4ID0gaGVscEZpZWxkcy5maW5kSW5kZXgoaXRlbSA9PiBpdGVtID09PSAnaWQnKTtcbiAgICBpZiAoaGVscEZpZWxkcy5pbmNsdWRlcygnaWQnKSAmJiBpZEluZGV4ICE9PSAwKSB7XG4gICAgICBoZWxwRmllbGRzLnNwbGljZShpZEluZGV4LCAxKTtcbiAgICAgIGhlbHBGaWVsZHMgPSBbJ2lkJywgLi4uaGVscEZpZWxkc107XG4gICAgfVxuICAgIGhlbHBGaWVsZHMuZm9yRWFjaCgoaGVscEZpZWxkOiBhbnkpID0+IHtcbiAgICAgIGxldCBoZWxwVmFsdWU6IGFueSA9ICcnO1xuICAgICAgaWYgKGhlbHBEYXRhKSB7XG4gICAgICAgIGlmIChoZWxwRGF0YSBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgICAgaGVscFZhbHVlID0gaGVscERhdGEubWFwKChpdGVtOiBhbnkpID0+IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFZhbHVlKGhlbHBGaWVsZCwgaXRlbSk7XG4gICAgICAgICAgfSkuam9pbignLCcpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGhlbHBWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoaGVscEZpZWxkLCBoZWxwRGF0YSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGlkcy5mb3JFYWNoKGlkID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVCaW5kaW5nTGlzdChpZCwgbWFwRmllbGRzW2hlbHBGaWVsZF0sIGhlbHBWYWx1ZSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuICBwcml2YXRlIHVwZGF0ZUJpbmRpbmdMaXN0KHByaW1hcnlWYWx1ZTogYW55LCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgIGNvbnN0IHZpZXdNb2RlbCA9IHRoaXMudmlld01vZGVsIHx8IG51bGw7XG4gICAgaWYgKCF2aWV3TW9kZWwgfHwgIXByb3BlcnR5TmFtZSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyDmm7TmlrDkuLvooajpg6jliIbooYznmoTlrZfmrrVcbiAgICBjb25zdCBwcm9wZXJ0eU5hbWVzID0gcHJvcGVydHlOYW1lLnNwbGl0KCcuJykuZmlsdGVyKGl0ZW0gPT4gaXRlbSk7XG4gICAgY29uc3QgYmluZGluZ09iamVjdCA9IHRoaXMuYmluZGluZ0xpc3QuZmluZEJ5SWQocHJpbWFyeVZhbHVlKTtcblxuICAgIGlmIChwcm9wZXJ0eU5hbWVzLmxlbmd0aCA8IDIpIHtcbiAgICAgIGJpbmRpbmdPYmplY3Quc2V0VmFsdWUocHJvcGVydHlOYW1lLCB2YWx1ZSwgdHJ1ZSwgdHJ1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCB0YXJnZXRCaW5kaW5nT2JqZWN0ID0gbnVsbDtcbiAgICAgIGNvbnN0IGZwYXRocyA9IHByb3BlcnR5TmFtZXMuc2xpY2UoMCwgcHJvcGVydHlOYW1lcy5sZW5ndGggLSAxKTtcbiAgICAgIGNvbnN0IHRhcmdldFByb3BlcnR5TmFtZSA9IHByb3BlcnR5TmFtZXNbcHJvcGVydHlOYW1lcy5sZW5ndGggLSAxXTtcbiAgICAgIGZwYXRocy5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICB0YXJnZXRCaW5kaW5nT2JqZWN0ID0gdGFyZ2V0QmluZGluZ09iamVjdCAmJiB0YXJnZXRCaW5kaW5nT2JqZWN0W3Byb3BdIHx8IGJpbmRpbmdPYmplY3RbcHJvcF07XG4gICAgICB9KTtcbiAgICAgIC8vIHRvZG866ZyA6KaB5re75Yqg5YC85Y+Y5YyW5LqL5Lu2XG4gICAgICB0YXJnZXRCaW5kaW5nT2JqZWN0LnNldFZhbHVlKHRhcmdldFByb3BlcnR5TmFtZSwgdmFsdWUsIHRydWUsIHRydWUpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGdldEJpbmRpbmdQYXRoQXJyYXkoKTogYW55W10ge1xuICAgIGNvbnN0IHBhdGggPSB0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aDtcbiAgICBpZiAocGF0aCkge1xuICAgICAgcmV0dXJuIHBhdGguc3BsaXQoJy8nKS5maWx0ZXIobiA9PiBuICE9PSAnJyk7XG4gICAgfVxuICAgIHJldHVybiBbXTtcbiAgfVxuICBwcml2YXRlIGdldFZhbHVlKGY6IHN0cmluZywgZGF0YTogYW55KSB7XG4gICAgbGV0IHZhbCA9ICcnO1xuICAgIGlmIChmLmluZGV4T2YoJy4nKSA9PT0gLTEpIHtcbiAgICAgIHZhbCA9IGRhdGFbZl07XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhbCA9IGYuc3BsaXQoJy4nKS5yZWR1Y2UoKGEsIGIpID0+IHtcbiAgICAgICAgcmV0dXJuIGFbYl07XG4gICAgICB9LCBkYXRhKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsO1xuICB9XG4gIHByb3RlY3RlZCBnZXQgYmluZGluZ0xpc3QoKTogQmluZGluZ0xpc3Qge1xuICAgIC8vIOagueWunuS9k1xuICAgIGlmICh0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCA9PT0gJy8nIHx8ICF0aGlzLnZpZXdNb2RlbC5iaW5kaW5nUGF0aCkge1xuICAgICAgcmV0dXJuIHRoaXMudmlld01vZGVsLmJpbmRpbmdEYXRhLmxpc3Q7XG4gICAgfVxuICAgIC8vIOWtkOWunuS9k1xuICAgIGxldCBiaW5kaW5nUGF0aCA9IHRoaXMudmlld01vZGVsLmJpbmRpbmdQYXRoLnN1YnN0cigxKTtcbiAgICBiaW5kaW5nUGF0aCA9IGJpbmRpbmdQYXRoWzBdLnRvTG93ZXJDYXNlKCkgKyBiaW5kaW5nUGF0aC5zdWJzdHJpbmcoMSwgYmluZGluZ1BhdGgubGVuZ3RoKTtcbiAgICBjb25zdCBwYXRocyA9IGJpbmRpbmdQYXRoLnNwbGl0KCcvJyk7XG5cbiAgICBjb25zdCBmaWx0ZXJlZFBhdGhzID0gcGF0aHMuZmlsdGVyKChwYXJ0OiBzdHJpbmcpID0+IHtcbiAgICAgIHJldHVybiBwYXJ0ICE9PSAnJztcbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy52aWV3TW9kZWwuYmluZGluZ0RhdGEuZ2V0VmFsdWUoZmlsdGVyZWRQYXRocyk7XG4gIH1cbiAgLyoqXG4gICAqIOagueaNruaYoOWwhOWwhuaVsOaNrui1i+WAvOe7mWJpbmRpbmdEYXRhXG4gICAqIEBwYXJhbSBkYXRhIFxuICAgKiBAcGFyYW0gbWFwRmllbGRzIFxuICAgKiBAcGFyYW0gYmluZGluZ0RhdGEgXG4gICAqL1xuICBwcml2YXRlIG1hcHBpbmdSb3coZGF0YTogYW55LCBtYXBGaWVsZHM6IGFueSwgZW50aXR5OiBFbnRpdHksIGJpbmRpbmdQYXRoOiBzdHJpbmcpIHtcbiAgICBPYmplY3Qua2V5cyhtYXBGaWVsZHMpLmZvckVhY2goKHByb3A6IHN0cmluZykgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmdldFZhbHVlQnlQYXRoKGRhdGEsIHByb3ApO1xuICAgICAgY29uc3QgZmllbGRzID0gbWFwRmllbGRzW3Byb3BdO1xuICAgICAgY29uc3QgZ3JvdXBzOiBhbnlbXSA9IGZpZWxkcy5zcGxpdCgnLCcpLmZpbHRlcihwID0+IHApO1xuICAgICAgZ3JvdXBzLmZvckVhY2goZ3JvdXAgPT4ge1xuICAgICAgICBjb25zdCBwYXRocyA9IGdyb3VwLnNwbGl0KCcuJykuZmlsdGVyKHAgPT4gcCk7XG4gICAgICAgIHRoaXMuc2V0VmFsdWVCeVBhdGgoZW50aXR5LCBwYXRocy5qb2luKCcuJyksIHZhbHVlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG4gIC8qKlxuICAgKiDpgJrov4dmcmFtZUlk6I635Y+W5a+55bqU55qE57uE5Lu25LiK5LiL5paHXG4gICAqIEBwYXJhbSBmcmFtZUlkIGZyYW1lSWRcbiAgICogQHJldHVybnMgXG4gICAqL1xuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dEJ5SWQoZnJhbWVJZDogc3RyaW5nKTogRnJhbWVDb250ZXh0IHwgbnVsbCB7XG4gICAgaWYgKCFmcmFtZUlkKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgY29uc3QgYXBwQ29udGV4dCA9IHRoaXMuaW5qZWN0b3IuZ2V0PEFwcENvbnRleHQ+KEFwcENvbnRleHQsIG51bGwpO1xuICAgIGxldCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCA9IG51bGw7XG4gICAgaWYgKGFwcENvbnRleHQpIHtcbiAgICAgIGZyYW1lQ29udGV4dCA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRCeUlkKGZyYW1lSWQpO1xuICAgIH1cbiAgICByZXR1cm4gZnJhbWVDb250ZXh0O1xuICB9XG4gIHByaXZhdGUgZ2V0RW50aXR5QnlQYXRoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBiaW5kaW5nUGF0aHM6IGFueVtdLCBjdXJyZW50SWQ6IHN0cmluZykge1xuICAgIGJpbmRpbmdQYXRocyA9IFsuLi5iaW5kaW5nUGF0aHNdO1xuICAgIGNvbnN0IGlkID0gZnJhbWVDb250ZXh0LmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICAgIGNvbnN0IGVudGl0eTogRW50aXR5ID0gZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5Q29sbGVjdGlvbi5nZXRFbnRpdHlCeUlkKGlkKSBhcyBFbnRpdHk7XG4gICAgbGV0IGl0ZW06IEVudGl0eSA9IGVudGl0eTtcbiAgICBjb25zdCBwYXRocyA9IFtdO1xuICAgIGNvbnN0IHRhaWxQYXRoID0gYmluZGluZ1BhdGhzLnBvcCgpO1xuICAgIGNvbnN0IHBhcmVudCA9IGJpbmRpbmdQYXRocy5yZWR1Y2UoKG9iamVjdDogRW50aXR5LCBwYXRoOiBzdHJpbmcpID0+IHtcbiAgICAgIHBhdGhzLnB1c2gocGF0aCk7XG4gICAgICBpZiAob2JqZWN0ICYmIChvYmplY3QuaGFzT3duUHJvcGVydHkocGF0aCkgfHwgb2JqZWN0WydfX3Byb3RvX18nXS5oYXNPd25Qcm9wZXJ0eShwYXRoKSkpIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBvYmplY3RbcGF0aF07XG4gICAgICAgIGlmICh2YWx1ZSAmJiB2YWx1ZSBpbnN0YW5jZW9mIEVudGl0eUxpc3QpIHtcbiAgICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IGZyYW1lQ29udGV4dC5iaW5kaW5nRGF0YS5nZXRWYWx1ZShwYXRocykgYXMgQmluZGluZ0xpc3Q7XG4gICAgICAgICAgY29uc3QgY3VycmVudEl0ZW1JZCA9IGJpbmRpbmdMaXN0LmN1cnJlbnRJZDtcbiAgICAgICAgICByZXR1cm4gdmFsdWUuZ2V0KGN1cnJlbnRJdGVtSWQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICB9XG4gICAgfSwgaXRlbSk7XG4gICAgaWYgKHBhcmVudCBpbnN0YW5jZW9mIEVudGl0eSkge1xuICAgICAgY29uc3QgbGlzdCA9IHBhcmVudFt0YWlsUGF0aF0gYXMgRW50aXR5TGlzdDxhbnk+O1xuICAgICAgaWYgKGxpc3QpIHtcbiAgICAgICAgcmV0dXJuIGxpc3QuZ2V0KGN1cnJlbnRJZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOaViOeahGJpbmRpbmdQYXRoLmApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYOaXoOaViOeahGJpbmRpbmdQYXRoLmApO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGVuZEVkaXQoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcbiAgICBjb25zdCBhcHBDb250ZXh0OiBBcHBDb250ZXh0ID0gZnJhbWVDb250ZXh0ICYmIGZyYW1lQ29udGV4dC5nZXRGb3JtQXBwQ29udGV4dCgpO1xuICAgIHJldHVybiBvZihudWxsKS5waXBlKFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgaWYgKGFwcENvbnRleHQpIHtcbiAgICAgICAgICBhcHBDb250ZXh0Lm1lc3NhZ2VQaXBlLm5leHQoeyB0eXBlOiAnZW5kRWRpdCcgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgLy8gdG9kbzog5LiN5bqU6K+l5L2/55SoZGVsYXnvvIzlupTor6XkuLLmtYFcbiAgICAgIGRlbGF5KDUpXG4gICAgKTtcbiAgfVxufVxuIl19