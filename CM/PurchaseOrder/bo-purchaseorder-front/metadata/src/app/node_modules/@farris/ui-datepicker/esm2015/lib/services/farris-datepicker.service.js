/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { PX, EMPTY_STR } from '../constants/constants';
import { Year } from '../enums/year.enum';
import { UtilService } from './farris-datepicker.util.service';
export class DatePickerService {
    /**
     * @param {?} opts
     */
    constructor(opts) {
        this._mouseWheelHandle = null;
        this._mouseScrollHandle = null;
        this.opts = opts;
        this.utilService = new UtilService();
    }
    /**
     * @param {?} opts
     * @param {?} defaultOpts
     * @return {?}
     */
    static parseOptions(opts, defaultOpts) {
        if (defaultOpts !== undefined) {
            Object.keys(defaultOpts).forEach((/**
             * @param {?} k
             * @return {?}
             */
            k => {
                if (defaultOpts[k] !== undefined && defaultOpts[k] !== '') {
                    ((/** @type {?} */ (opts)))[k] = defaultOpts[k];
                }
            }));
        }
        if (opts.minYear < Year.min) {
            opts.minYear = Year.min;
        }
        if (opts.maxYear > Year.max) {
            opts.maxYear = Year.max;
        }
        return opts;
    }
    /**
     * @param {?} value
     * @return {?}
     */
    validate(value) {
        const { dateRange } = this.opts;
        /** @type {?} */
        let valid = false;
        if (!dateRange) {
            /** @type {?} */
            const date = this.utilService.isDateValid(value, this.opts);
            valid = this.utilService.isInitializedDate(date);
        }
        else {
            /** @type {?} */
            const _dateRange = this.utilService.isDateValidDateRange(value, this.opts);
            const { begin, end } = _dateRange;
            valid = this.utilService.isInitializedDate(begin) && this.utilService.isInitializedDate(end);
        }
        return valid;
    }
    /**
     * @param {?} fn
     * @return {?}
     */
    registerScrollEvent(fn) {
        this._mouseScrollHandle = fn;
        document.addEventListener('scroll', this._mouseScrollHandle);
    }
    /**
     * @return {?}
     */
    removeMouseEvent() {
        /** @type {?} */
        const container = document.querySelector('.date-overlay-container');
        if (container) {
            container.removeEventListener('mousewheel', this._mouseWheelHandle);
        }
        document.removeEventListener('scroll', this._mouseScrollHandle);
    }
    /**
     * @param {?} elem
     * @return {?}
     */
    appendSelector(elem) {
        /** @type {?} */
        let container = document.querySelector('.date-overlay-container');
        if (container) {
            if (container.hasChildNodes()) {
                container.childNodes.forEach((/**
                 * @param {?} el
                 * @return {?}
                 */
                el => {
                    if (el !== elem) {
                        container.removeChild(el);
                    }
                }));
            }
        }
        else {
            container = document.createElement('div');
            container.classList.add('date-overlay-container');
            container.classList.add('overlay-container');
            document.body.appendChild(container);
        }
        container.addEventListener('mousewheel', this._mouseWheelHandle = (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            /** @type {?} */
            const target = (/** @type {?} */ (e.target));
            if (!target.closest('.calendar-time-picker-select')) {
                e.preventDefault();
            }
            return;
        }));
        container.appendChild(elem);
    }
    /**
     * @param {?} elem
     * @param {?=} calendarRef
     * @return {?}
     */
    getSelectorPosition(elem, calendarRef = null) {
        /** @type {?} */
        let top = 0;
        /** @type {?} */
        let left = 0;
        /** @type {?} */
        let _selectorHeight = 0;
        /** @type {?} */
        let _selectorWidth = 0;
        const { selectorHeight, selectorWidth, showTime, dateRange, showType } = this.opts;
        /** @type {?} */
        const b = document.body.getBoundingClientRect();
        /** @type {?} */
        const e = elem.getBoundingClientRect();
        top = e.top - b.top;
        left = e.left - b.left;
        /** @type {?} */
        let position = 'bottom';
        if (dateRange && showType !== 4) {
            _selectorWidth = this.getSelectorDimension(selectorWidth) * 2;
        }
        else {
            _selectorWidth = this.getSelectorDimension(selectorWidth);
        }
        if (showTime) {
            _selectorHeight = this.getSelectorDimension(selectorHeight) + 36;
        }
        else {
            _selectorHeight = this.getSelectorDimension(selectorHeight);
        }
        if (top + elem.offsetHeight + _selectorHeight > window.innerHeight && top - _selectorHeight - 2 > 0) {
            top = top - _selectorHeight - 2 - (showTime ? 6 : 0);
            position = 'top';
        }
        else {
            top = top + elem.offsetHeight + 2;
        }
        if (window.innerHeight - top < _selectorHeight) {
            top = top - (_selectorHeight - (window.innerHeight - e.top - e.height - 15));
            if (calendarRef) {
                /** @type {?} */
                const calendarElem = calendarRef.location.nativeElement;
                /** @type {?} */
                const arrow = calendarElem.querySelector('.arrow');
                if (arrow) {
                    arrow.style.display = 'none';
                }
            }
        }
        if (left + _selectorWidth > b.width) {
            left = b.width - _selectorWidth - 15;
        }
        left = left > 0 ? left : 0;
        /** @type {?} */
        const scrollTop = document.body.scrollTop || document.documentElement.scrollTop;
        top -= scrollTop;
        return { top, left, position };
    }
    /**
     * @private
     * @param {?} value
     * @return {?}
     */
    getSelectorDimension(value) {
        return Number(value.replace(PX, EMPTY_STR));
    }
}
if (false) {
    /** @type {?} */
    DatePickerService.prototype.opts;
    /** @type {?} */
    DatePickerService.prototype.utilService;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseWheelHandle;
    /**
     * @type {?}
     * @private
     */
    DatePickerService.prototype._mouseScrollHandle;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFycmlzLWRhdGVwaWNrZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0ZXBpY2tlci8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9mYXJyaXMtZGF0ZXBpY2tlci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFDQSxPQUFPLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMxQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHL0QsTUFBTSxPQUFPLGlCQUFpQjs7OztJQU8xQixZQUFZLElBQUk7UUFIUixzQkFBaUIsR0FBRyxJQUFJLENBQUM7UUFDekIsdUJBQWtCLEdBQUcsSUFBSSxDQUFDO1FBRzlCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUN6QyxDQUFDOzs7Ozs7SUFFRCxNQUFNLENBQUMsWUFBWSxDQUFDLElBQWdCLEVBQUUsV0FBVztRQUM3QyxJQUFJLFdBQVcsS0FBSyxTQUFTLEVBQUU7WUFDM0IsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxPQUFPOzs7O1lBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2pDLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLFNBQVMsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUN2RCxDQUFDLG1CQUFBLElBQUksRUFBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUM1QztZQUNMLENBQUMsRUFBQyxDQUFDO1NBQ047UUFDRCxJQUFJLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUN6QixJ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RSxHQUFHLElBQUksU0FBUyxDQUFDO1FBRWpCLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDO0lBQ25DLENBQUM7Ozs7OztJQUNPLG9CQUFvQixDQUFDLEtBQWE7UUFDdEMsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUNoRCxDQUFDO0NBRUo7OztJQXRKRyxpQ0FBSzs7SUFDTCx3Q0FBWTs7Ozs7SUFFWiw4Q0FBaUM7Ozs7O0lBQ2pDLCtDQUFrQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElNeURhdGUsIElNeURhdGVSYW5nZSwgSU15U2VsZWN0b3JQb3NpdGlvbiwgSU15T3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvcHVibGljLWFwaSc7XHJcbmltcG9ydCB7IFBYLCBFTVBUWV9TVFIgfSBmcm9tICcuLi9jb25zdGFudHMvY29uc3RhbnRzJztcclxuaW1wb3J0IHsgWWVhciB9IGZyb20gJy4uL2VudW1zL3llYXIuZW51bSc7XHJcbmltcG9ydCB7IFV0aWxTZXJ2aWNlIH0gZnJvbSAnLi9mYXJyaXMtZGF0ZXBpY2tlci51dGlsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmV4cG9ydCBjbGFzcyBEYXRlUGlja2VyU2VydmljZSB7XHJcbiAgICBvcHRzO1xyXG4gICAgdXRpbFNlcnZpY2U7XHJcblxyXG4gICAgcHJpdmF0ZSBfbW91c2VXaGVlbEhhbmRsZSA9IG51bGw7XHJcbiAgICBwcml2YXRlIF9tb3VzZVNjcm9sbEhhbmRsZSA9IG51bGw7XHJcblxyXG4gICAgY29uc3RydWN0b3Iob3B0cykge1xyXG4gICAgICAgIHRoaXMub3B0cyA9IG9wdHM7XHJcbiAgICAgICAgdGhpcy51dGlsU2VydmljZSA9IG5ldyBVdGlsU2VydmljZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBwYXJzZU9wdGlvbnMob3B0czogSU15T3B0aW9ucywgZGVmYXVsdE9wdHMpOiBJTXlPcHRpb25zIHtcclxuICAgICAgICBpZiAoZGVmYXVsdE9wdHMgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhkZWZhdWx0T3B0cykuZm9yRWFjaChrID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0T3B0c1trXSAhPT0gdW5kZWZpbmVkICYmIGRlZmF1bHRPcHRzW2tdICE9PSAnJykge1xyXG4gICAgICAgICAgICAgICAgICAgIChvcHRzIGFzIElNeU9wdGlvbnMpW2tdID0gZGVmYXVsdE9wdHNba107XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAob3B0cy5taW5ZZWFyIDwgWWVhci5taW4pIHtcclxuICAgICAgICAgICAgb3B0cy5taW5ZZWFyID0gWWVhci5taW47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChvcHRzLm1heFllYXIgPiBZZWFyLm1heCkge1xyXG4gICAgICAgICAgICBvcHRzLm1heFllYXIgPSBZZWFyLm1heDtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG9wdHM7XHJcbiAgICB9XHJcblxyXG4gICAgdmFsaWRhdGUodmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IHsgZGF0ZVJhbmdlIH0gPSB0aGlzLm9wdHM7XHJcblxyXG4gICAgICAgIGxldCB2YWxpZCA9IGZhbHNlO1xyXG4gICAgICAgIGlmICghZGF0ZVJhbmdlKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGU6IElNeURhdGUgPSB0aGlzLnV0aWxTZXJ2aWNlLmlzRGF0ZVZhbGlkKHZhbHVlLCB0aGlzLm9wdHMpO1xyXG5cclxuICAgICAgICAgICAgdmFsaWQgPSB0aGlzLnV0aWxTZXJ2aWNlLmlzSW5pdGlhbGl6ZWREYXRlKGRhdGUpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbnN0IF9kYXRlUmFuZ2U6IElNeURhdGVSYW5nZSA9IHRoaXMudXRpbFNlcnZpY2UuaXNEYXRlVmFsaWREYXRlUmFuZ2UodmFsdWUsIHRoaXMub3B0cyk7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgYmVnaW4sIGVuZCB9ID0gX2RhdGVSYW5nZTtcclxuICAgICAgICAgICAgdmFsaWQgPSB0aGlzLnV0aWxTZXJ2aWNlLmlzSW5pdGlhbGl6ZWREYXRlKGJlZ2luKSAmJiB0aGlzLnV0aWxTZXJ2aWNlLmlzSW5pdGlhbGl6ZWREYXRlKGVuZCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsaWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmVnaXN0ZXJTY3JvbGxFdmVudChmbikge1xyXG4gICAgICAgIHRoaXMuX21vdXNlU2Nyb2xsSGFuZGxlID0gZm47XHJcbiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5fbW91c2VTY3JvbGxIYW5kbGUpO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICByZW1vdmVNb3VzZUV2ZW50KCkge1xyXG4gICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5kYXRlLW92ZXJsYXktY29udGFpbmVyJyk7XHJcbiAgICAgICAgaWYgKGNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBjb250YWluZXIucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHRoaXMuX21vdXNlV2hlZWxIYW5kbGUpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5fbW91c2VTY3JvbGxIYW5kbGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGFwcGVuZFNlbGVjdG9yKGVsZW06IGFueSk6IHZvaWQge1xyXG4gICAgICAgIGxldCBjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuZGF0ZS1vdmVybGF5LWNvbnRhaW5lcicpO1xyXG4gICAgICAgIGlmIChjb250YWluZXIpIHtcclxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lci5oYXNDaGlsZE5vZGVzKCkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnRhaW5lci5jaGlsZE5vZGVzLmZvckVhY2goZWwgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChlbCAhPT0gZWxlbSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoZWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdkYXRlLW92ZXJsYXktY29udGFpbmVyJyk7XHJcbiAgICAgICAgICAgIGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdvdmVybGF5LWNvbnRhaW5lcicpO1xyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGNvbnRhaW5lcik7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V3aGVlbCcsIHRoaXMuX21vdXNlV2hlZWxIYW5kbGUgPSAoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldCBhcyBhbnk7XHJcbiAgICAgICAgICAgIGlmICghdGFyZ2V0LmNsb3Nlc3QoJy5jYWxlbmRhci10aW1lLXBpY2tlci1zZWxlY3QnKSkge1xyXG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKGVsZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFNlbGVjdG9yUG9zaXRpb24oZWxlbTogYW55LCBjYWxlbmRhclJlZjogQ29tcG9uZW50UmVmPGFueT4gID0gbnVsbCk6IElNeVNlbGVjdG9yUG9zaXRpb24ge1xyXG4gICAgICAgIGxldCB0b3AgPSAwO1xyXG4gICAgICAgIGxldCBsZWZ0ID0gMDtcclxuICAgICAgICBsZXQgX3NlbGVjdG9ySGVpZ2h0ID0gMDtcclxuICAgICAgICBsZXQgX3NlbGVjdG9yV2lkdGggPSAwO1xyXG4gICAgICAgIGNvbnN0IHtcclxuICAgICAgICAgICAgc2VsZWN0b3JIZWlnaHQsXHJcbiAgICAgICAgICAgIHNlbGVjdG9yV2lkdGgsXHJcbiAgICAgICAgICAgIHNob3dUaW1lLFxyXG4gICAgICAgICAgICBkYXRlUmFuZ2UsXHJcbiAgICAgICAgICAgIHNob3dUeXBlXHJcbiAgICAgICAgfSA9IHRoaXMub3B0cztcclxuXHJcbiAgICAgICAgY29uc3QgYjogYW55ID0gZG9jdW1lbnQuYm9keS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICBjb25zdCBlOiBhbnkgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gICAgICAgIHRvcCA9IGUudG9wIC0gYi50b3A7XHJcbiAgICAgICAgbGVmdCA9IGUubGVmdCAtIGIubGVmdDtcclxuICAgICAgICBsZXQgcG9zaXRpb24gPSAnYm90dG9tJztcclxuICAgICAgICBpZiAoZGF0ZVJhbmdlICYmIHNob3dUeXBlICE9PSA0KSB7XHJcbiAgICAgICAgICAgIF9zZWxlY3RvcldpZHRoID0gdGhpcy5nZXRTZWxlY3RvckRpbWVuc2lvbihzZWxlY3RvcldpZHRoKSAqIDI7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgX3NlbGVjdG9yV2lkdGggPSB0aGlzLmdldFNlbGVjdG9yRGltZW5zaW9uKHNlbGVjdG9yV2lkdGgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHNob3dUaW1lKSB7XHJcbiAgICAgICAgICAgIF9zZWxlY3RvckhlaWdodCA9IHRoaXMuZ2V0U2VsZWN0b3JEaW1lbnNpb24oc2VsZWN0b3JIZWlnaHQpICsgMzY7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgX3NlbGVjdG9ySGVpZ2h0ID0gdGhpcy5nZXRTZWxlY3RvckRpbWVuc2lvbihzZWxlY3RvckhlaWdodCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0b3AgKyBlbGVtLm9mZnNldEhlaWdodCArIF9zZWxlY3RvckhlaWdodCA+IHdpbmRvdy5pbm5lckhlaWdodCAmJiB0b3AgLSBfc2VsZWN0b3JIZWlnaHQgLSAyID4gMCkge1xyXG4gICAgICAgICAgICB0b3AgPSB0b3AgLSBfc2VsZWN0b3JIZWlnaHQgLSAyIC0gKHNob3dUaW1lID8gNiA6IDApO1xyXG4gICAgICAgICAgICBwb3NpdGlvbiA9ICd0b3AnO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRvcCA9IHRvcCArIGVsZW0ub2Zmc2V0SGVpZ2h0ICsgMjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh3aW5kb3cuaW5uZXJIZWlnaHQgLSB0b3AgPCBfc2VsZWN0b3JIZWlnaHQpIHtcclxuICAgICAgICAgICAgdG9wID0gdG9wIC0gKF9zZWxlY3RvckhlaWdodCAtICh3aW5kb3cuaW5uZXJIZWlnaHQgLSBlLnRvcCAtIGUuaGVpZ2h0IC0gMTUpKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChjYWxlbmRhclJlZikge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgY2FsZW5kYXJFbGVtID0gY2FsZW5kYXJSZWYubG9jYXRpb24ubmF0aXZlRWxlbWVudDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFycm93ID0gY2FsZW5kYXJFbGVtLnF1ZXJ5U2VsZWN0b3IoJy5hcnJvdycpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGFycm93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgYXJyb3cuc3R5bGUuZGlzcGxheSA9ICdub25lJztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKGxlZnQgKyBfc2VsZWN0b3JXaWR0aCA+IGIud2lkdGgpIHtcclxuICAgICAgICAgICAgbGVmdCA9IGIud2lkdGggLSBfc2VsZWN0b3JXaWR0aCAtIDE1O1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZWZ0ID0gbGVmdCA+IDAgPyBsZWZ0IDogMDtcclxuXHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gZG9jdW1lbnQuYm9keS5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcDtcclxuICAgICAgICB0b3AgLT0gc2Nyb2xsVG9wO1xyXG5cclxuICAgICAgICByZXR1cm4geyB0b3AsIGxlZnQsIHBvc2l0aW9uIH07XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldFNlbGVjdG9yRGltZW5zaW9uKHZhbHVlOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiBOdW1iZXIodmFsdWUucmVwbGFjZShQWCwgRU1QVFlfU1RSKSk7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==