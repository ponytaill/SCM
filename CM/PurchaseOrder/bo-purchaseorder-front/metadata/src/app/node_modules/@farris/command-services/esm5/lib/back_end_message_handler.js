import * as tslib_1 from "tslib";
import { Inject, Injectable, Injector } from '@angular/core';
import { FrameContext, TranslateToken } from '@farris/devkit';
/**
 * 后端消息处理服务
 * @description
 * ### 服务注入位置
 *  1、整个表单的root-component
 *  2、弹出窗口的root-component
 */
var BackEndMessageHandler = /** @class */ (function () {
    function BackEndMessageHandler(injector, frameContext, translate) {
        this.injector = injector;
        this.frameContext = frameContext;
        this.translate = translate;
    }
    /**
     * 处理后端返回的消息或错误
     * @param message 消息或错误
     */
    BackEndMessageHandler.prototype.handle = function (message, context) {
        var isException = context && context.isException || false;
        var hasThrowError = context && context.hasThrowError || false;
        var eventBus = context && context.eventBus || null;
        var error = context && context.error || null;
        var formAppContext = context && context.formAppContext || null;
        var result = this.collect(message, isException, hasThrowError, eventBus, error, formAppContext);
        if (result && result.form && result.form.length > 0) {
            result.form.forEach(function (item) {
                item.frameContext.viewModel.form.updateFormErrors(item.message, true, 'backend');
            });
        }
        else {
            this.resetFormMessage(message.context.appContext, message.context.ns);
        }
        var targetFrameContext = this.findTargetFrameContext(this.frameContext);
        if (result && result.all && result.all.length > 0) {
            targetFrameContext.viewModel.verifycationChanged.next(result.all);
        }
        else {
            if (result !== null) {
                targetFrameContext.viewModel.verifycationChanged.next([]);
            }
        }
    };
    /**
     * 收集汇总信息和form信息
     * @param backEndMessage
     */
    BackEndMessageHandler.prototype.collect = function (backEndMessage, isException, hasThrowError, eventBus, error, formAppContext) {
        var _this = this;
        if (isException === void 0) { isException = false; }
        if (hasThrowError === void 0) { hasThrowError = false; }
        if (eventBus === void 0) { eventBus = null; }
        if (error === void 0) { error = null; }
        if (formAppContext === void 0) { formAppContext = null; }
        var e_1, _a;
        var bizMessages = backEndMessage && backEndMessage.bizMessages || null;
        var appContext = backEndMessage && backEndMessage.context.appContext;
        var ns = backEndMessage.context.ns;
        if (!bizMessages || bizMessages.length < 1) {
            return null;
        }
        var result = {
            form: [],
            all: []
        };
        var hasFormlessError = false;
        var _loop_1 = function (bizMessage) {
            var e_2, _a;
            var message = bizMessage.message;
            var location_1 = bizMessage.location || null;
            var columns = location_1 && location_1.columns || null;
            var nodeCode = location_1 && location_1.nodeCode || null;
            var rows = location_1 && location_1.rows;
            var bindingPath = this_1.getBindingPath(appContext, ns, nodeCode);
            var bindingPaths = bindingPath && bindingPath.split('/').filter(function (p) { return p; });
            // 目前仅处理有location，且有id、列名、表名的。
            if (!location_1 || !columns || columns.length < 1 || !nodeCode || !rows || rows.length < 1) {
                return "continue";
            }
            var _loop_2 = function (row) {
                var e_3, _a;
                var _loop_3 = function (column) {
                    // 获取到所有绑定该列数据的frameContext
                    var frameContexts = this_1.getFrameContextsByBindingPathAndColumnName(appContext, ns, bindingPath, column);
                    if (!frameContexts || frameContexts.length < 1) {
                        // 没有任何一个组件绑定该列的数据
                        hasFormlessError = true;
                        return "continue";
                    }
                    // 排除掉只读datagrid
                    frameContexts = frameContexts.filter(function (frameContext) {
                        var isDataGridComponent = _this.isDataGridComponent(frameContext.frameComponent);
                        if (isDataGridComponent) {
                            var isReadonlyDataGrid = _this.isReadonlyDataGrid(frameContext.frameComponent);
                            if (isReadonlyDataGrid) {
                                return false;
                            }
                            else {
                                return true;
                            }
                        }
                        return true;
                    });
                    // 遍历的行是否为当前行
                    var isCurrentRow = this_1.isCurrentRow(appContext, ns, bindingPath, row);
                    // 如果是当前行的话需要将错误信息放到form中
                    if (isCurrentRow) {
                        // 忽略grid
                        // const formFrameContexts = frameContexts.filter(frameContext => !this.isGridComponent(frameContext.frameComponent));
                        if (frameContexts && frameContexts.length > 0) {
                            frameContexts.forEach(function (frameContext) {
                                // 只处理了一个组件中列只绑定到一个前端控件的场景
                                var formControls = _this.getFormControlByColumnName(frameContext, column);
                                if (formControls && formControls.length > 0) {
                                    formControls.forEach(function (_a) {
                                        var _b = tslib_1.__read(_a, 2), domPropertyName = _b[0], formControl = _b[1];
                                        //const domPropertyName = formControl && formControl. || null;
                                        _this.mergeMessage(result.form, frameContext, domPropertyName, message);
                                    });
                                }
                                //if (formControl && domPropertyName) {
                                //}
                            });
                        }
                        else {
                        }
                    }
                    // 将错误信息放到汇总中
                    frameContexts.forEach(function (frameContext) {
                        var viewModelName = frameContext.viewModel.form.formGroupName;
                        var formControls = _this.getFormControlByColumnName(frameContext, column);
                        if (formControls && formControls.length > 0) {
                            var _a = tslib_1.__read(formControls.find(function (_a) {
                                var _b = tslib_1.__read(_a, 2), propertyName = _b[0], formControl = _b[1];
                                return propertyName && propertyName.length > 0;
                            }), 2), domPropertyName = _a[0], formControl = _a[1];
                            // const domPropertyName = domProperty && domProperty.propertyName;
                            var bindingList = frameContext.viewModel.bindingData.getValue(bindingPaths);
                            var index = bindingList.getIndexById(row);
                            var primary_1 = row + "_" + column + "_" + message;
                            // TODO:虽然能纠正汇总消息显示重复的问题，但可能导致点击错误无法定位到对应控件的问题，待后续优化
                            if (index >= 0 && result.all.findIndex(function (p) { return p.id === primary_1; }) === -1) {
                                // 数据源中有多于1行时显示索引
                                var position = (bindingList && bindingList.length > 1) ? (index + 1) : -1;
                                var title = _this.buildItemTitle(viewModelName, formControl.name || formControl.defaultI18nValue || domPropertyName, position);
                                var item = {
                                    id: primary_1,
                                    index: index,
                                    targetField: formControl.id,
                                    title: title,
                                    msg: message,
                                    namespace: ns,
                                    bindingPath: bindingPath,
                                    type: 'error'
                                };
                                result.all.push(item);
                            }
                        }
                    });
                };
                try {
                    for (var columns_1 = tslib_1.__values(columns), columns_1_1 = columns_1.next(); !columns_1_1.done; columns_1_1 = columns_1.next()) {
                        var column = columns_1_1.value;
                        _loop_3(column);
                    }
                }
                catch (e_3_1) { e_3 = { error: e_3_1 }; }
                finally {
                    try {
                        if (columns_1_1 && !columns_1_1.done && (_a = columns_1.return)) _a.call(columns_1);
                    }
                    finally { if (e_3) throw e_3.error; }
                }
            };
            try {
                // 遍历数据行
                for (var rows_1 = tslib_1.__values(rows), rows_1_1 = rows_1.next(); !rows_1_1.done; rows_1_1 = rows_1.next()) {
                    var row = rows_1_1.value;
                    _loop_2(row);
                }
            }
            catch (e_2_1) { e_2 = { error: e_2_1 }; }
            finally {
                try {
                    if (rows_1_1 && !rows_1_1.done && (_a = rows_1.return)) _a.call(rows_1);
                }
                finally { if (e_2) throw e_2.error; }
            }
        };
        var this_1 = this;
        try {
            for (var bizMessages_1 = tslib_1.__values(bizMessages), bizMessages_1_1 = bizMessages_1.next(); !bizMessages_1_1.done; bizMessages_1_1 = bizMessages_1.next()) {
                var bizMessage = bizMessages_1_1.value;
                _loop_1(bizMessage);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (bizMessages_1_1 && !bizMessages_1_1.done && (_a = bizMessages_1.return)) _a.call(bizMessages_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        if (hasFormlessError && isException && !hasThrowError && eventBus) {
            eventBus.post('Exception', '', 'onException', error, formAppContext);
        }
        return result;
    };
    BackEndMessageHandler.prototype.mergeMessage = function (formItems, frameContext, domPropertyName, message) {
        var _a, _b;
        var targetItem = formItems.find(function (item) { return item.frameContext.frameId === frameContext.frameId; });
        if (targetItem) {
            var isPropertyExist = targetItem.message && Object.keys(targetItem.message).includes(domPropertyName);
            var messageType = "backend-message-" + (Object.keys(targetItem.message).length + 1);
            if (isPropertyExist) {
                targetItem.message[domPropertyName]['errors'][messageType] = { name: message };
            }
            else {
                targetItem.message[domPropertyName] = { errors: (_a = {}, _a[messageType] = { name: message }, _a) };
            }
        }
        else {
            formItems.push({
                frameContext: frameContext,
                message: (_b = {},
                    _b[domPropertyName] = {
                        errors: {
                            'backend-message-1': { name: message }
                        }
                    },
                    _b)
            });
        }
    };
    BackEndMessageHandler.prototype.buildItemTitle = function (viewModelName, propertyName, index) {
        var template = {
            'zh-CHS': {
                viewModelName: "$viewModel",
                index: "\u7B2C $index \u884C",
                propertyName: "- $propertyName"
            },
            'en': {
                viewModelName: "$viewModel",
                index: "row $index",
                propertyName: "- $propertyName"
            },
            'zh-CHT': {
                viewModelName: "$viewModel",
                index: "\u7B2C $index \u884C",
                propertyName: "- $propertyName"
            }
        };
        var currentLanguage = this.translate.getCurrentLanguage() || 'zh-CHS';
        var message = [];
        if (viewModelName) {
            message.push(template[currentLanguage]['viewModelName'].replace('$viewModel', viewModelName));
        }
        if (index > 0) {
            message.push(template[currentLanguage]['index'].replace('$index', index));
        }
        if (propertyName) {
            message.push(template[currentLanguage]['propertyName'].replace('$propertyName', propertyName));
        }
        return message.join(' ');
    };
    /**
     * 根据表名或nodeCode获取绑定路径
     * @param appContext appContext
     * @param ns ns
     * @param nodeCode 表名
     */
    BackEndMessageHandler.prototype.getBindingPath = function (appContext, ns, nodeCode) {
        var frameContext = this.getFrameContext(appContext, ns);
        return frameContext.repository.entityTypeInfo.getBindingPathByTableName(nodeCode);
    };
    /**
     * 通过绑定路径和列名找到所有符合条件的视图模型(包括grid和form)
     * @param appContext appContext
     * @param ns namespace
     * @param bindingPath 绑定路径
     * @param columnName 列名
     */
    BackEndMessageHandler.prototype.getFrameContextsByBindingPathAndColumnName = function (appContext, ns, bindingPath, columnName) {
        var frameContexts = appContext.frameContextManager.getFrameContexts();
        if (frameContexts && frameContexts.length > 0) {
            // 找到form中有控件的frameContext
            frameContexts = frameContexts.filter(function (frameContext) {
                // 基本条件是否满足
                var isValidFrameContext = frameContext.namespace === ns && frameContext.viewModel.bindingPath === bindingPath && frameContext.viewModel.form && frameContext.viewModel.form.controls && Object.keys(frameContext.viewModel.form.controls).length > 0;
                if (!isValidFrameContext) {
                    return false;
                }
                // 再通过列名过滤
                var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
                var dataTypeInfo = frameContext.repository.entityTypeInfo.getTypeInfoByPath(bindingPaths);
                if (dataTypeInfo) {
                    var dataPropInfos = Array.from(dataTypeInfo.propInfoMap.values());
                    // 从当前实体属性中找到数据字段为列名的属性
                    var entityPropertyInfo = dataPropInfos.find(function (propInfo) { return propInfo.metadataInfo && (propInfo.metadataInfo.originalDataField === columnName || propInfo.metadataInfo.dataField === columnName); });
                    if (entityPropertyInfo) {
                        var entityPropertyName_1 = entityPropertyInfo.name;
                        var ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(function (item) { return item.binding === entityPropertyName_1; });
                        if (ngFormControl) {
                            return true;
                        }
                        else {
                            var item = Object.keys(frameContext.viewModel.form.ngFormControls).find(function (key) { return key === entityPropertyName_1; });
                            return item ? true : false;
                        }
                    }
                    else {
                        return false;
                    }
                }
                else {
                    return false;
                }
            });
            return frameContexts;
        }
        return null;
    };
    /**
     * 是否为datagrid组件
     * @param frameComponent component
     */
    BackEndMessageHandler.prototype.isDataGridComponent = function (frameComponent) {
        var columnNames = frameComponent.context.viewModel['dataGridColumnsName'] || null;
        return columnNames ? true : false;
    };
    /**
     * grid组件是否是只读的
     * @param frameComponent frameComponent
     * @returns
     */
    BackEndMessageHandler.prototype.isReadonlyDataGrid = function (frameComponent) {
        var frameContext = frameComponent.context;
        var dataGridColumnsName = frameContext.viewModel['dataGridColumnsName'] || null;
        if (dataGridColumnsName) {
            var datagridColumns = frameContext.viewModel[dataGridColumnsName];
            return datagridColumns.every(function (group) {
                return group.every(function (item) { return !item.editor; });
            });
        }
        else {
            throw new Error("\u4F20\u5165\u7684\u7EC4\u4EF6\u4E0D\u662F\u4E00\u4E2A\u8868\u683C\uFF01");
        }
    };
    /**
     * id是否为当前行
     * @param appContext appContext
     * @param ns namespace
     * @param bindingPath bindingPath
     * @param id id
     */
    BackEndMessageHandler.prototype.isCurrentRow = function (appContext, ns, bindingPath, id) {
        var bindingPaths = bindingPath.split('/').filter(function (p) { return p; });
        var frameContext = this.getFrameContext(appContext, ns);
        var bindingData = frameContext.bindingData;
        var bindingList = bindingData.getValue(bindingPaths);
        return bindingList.currentItem.primaryKeyValue === id;
    };
    /**
     * 获取当前ns下的rootFrameContext
     * @param appContext appcontext
     * @param ns namespace
     */
    BackEndMessageHandler.prototype.getFrameContext = function (appContext, ns) {
        var frameContexts = appContext.frameContextManager.getFrameContexts();
        if (frameContexts && frameContexts.length > 0) {
            var randomFrameContext = frameContexts.find(function (frameContext) { return frameContext.namespace === ns; });
            if (randomFrameContext) {
                var virtualRootFrameContext = randomFrameContext.getVirtualRootFrameContext();
                return virtualRootFrameContext;
            }
        }
        return null;
    };
    /**
     * 通过绑定路径和列名获取绑定到该列的formControl
     */
    BackEndMessageHandler.prototype.getFormControlByColumnName = function (frameContext, columnName) {
        var bindingPaths = frameContext.viewModel.bindingPath.split('/').filter(function (p) { return p; });
        // 通过bindingPath找到对应的实体信息
        var typeInfo = frameContext.repository.entityTypeInfo.getTypeInfoByPath(bindingPaths);
        var propsInfo = Array.from(typeInfo.propInfoMap.values());
        var propInfo = propsInfo.find(function (propInfo) { return propInfo.metadataInfo && (propInfo.metadataInfo.originalDataField === columnName || propInfo.metadataInfo.dataField === columnName); });
        if (propInfo) {
            var mappingName_1 = propInfo.name;
            var formControls = Object.entries(frameContext.viewModel.form.ngFormControls).filter(function (item) { return item[1].binding === mappingName_1 || item[0] === mappingName_1; });
            // const ngFormControl = Object.values(frameContext.viewModel.form.ngFormControls).find(item => item.binding === mappingName);
            if (formControls) {
                return formControls;
            }
        }
        return null;
    };
    BackEndMessageHandler.prototype.resetFormMessage = function (appContext, ns) {
        var frameContexts = appContext.frameContextManager.getFrameContexts().filter(function (frameContext) { return frameContext.namespace === ns; });
        frameContexts.forEach(function (frameContext) { return frameContext && frameContext.viewModel && frameContext.viewModel.form && frameContext.viewModel.form.clearBackendError(); });
    };
    /**
     * 递归找到展示消息的组件上下文
     * @param frameContext frameContext
     */
    BackEndMessageHandler.prototype.findTargetFrameContext = function (frameContext) {
        var virtualRootFrameContext = frameContext.getVirtualRootFrameContext();
        var virtualRootComponent = virtualRootFrameContext.frameComponent;
        var isDialogComponent = virtualRootComponent && virtualRootComponent['isDialogRootComponent'] || false;
        if (isDialogComponent) {
            // 如果消息处理服务是弹窗内的，则消息提示展示在弹窗内
            return virtualRootFrameContext;
        }
        else {
            // 当前消息服务不在弹窗内，递归向上查找，找到第一个弹窗，如果找不到则找到最上的root-component
            var parentFrameContext = virtualRootFrameContext.parent;
            if (parentFrameContext) {
                return this.findTargetFrameContext(parentFrameContext);
            }
            else {
                return virtualRootFrameContext;
            }
        }
    };
    BackEndMessageHandler.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    BackEndMessageHandler.ctorParameters = function () { return [
        { type: Injector },
        { type: FrameContext },
        { type: undefined, decorators: [{ type: Inject, args: [TranslateToken,] }] }
    ]; };
    return BackEndMessageHandler;
}());
export { BackEndMessageHandler };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja19lbmRfbWVzc2FnZV9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL2JhY2tfZW5kX21lc3NhZ2VfaGFuZGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBbUYsWUFBWSxFQUE0QixjQUFjLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6Szs7Ozs7O0dBTUc7QUFDSDtJQUVFLCtCQUFvQixRQUFrQixFQUFVLFlBQTBCLEVBQWtDLFNBQW9CO1FBQTVHLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUFrQyxjQUFTLEdBQVQsU0FBUyxDQUFXO0lBQUksQ0FBQztJQUNySTs7O09BR0c7SUFDSSxzQ0FBTSxHQUFiLFVBQWMsT0FBZ0MsRUFBRSxPQUFZO1FBQzFELElBQU0sV0FBVyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsV0FBVyxJQUFJLEtBQUssQ0FBQztRQUM1RCxJQUFNLGFBQWEsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLGFBQWEsSUFBSSxLQUFLLENBQUM7UUFDaEUsSUFBTSxRQUFRLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDO1FBQ3JELElBQU0sS0FBSyxHQUFHLE9BQU8sSUFBSSxPQUFPLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQztRQUMvQyxJQUFNLGNBQWMsR0FBRyxPQUFPLElBQUksT0FBTyxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUM7UUFDakUsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ2xHLElB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LENBQUM7YUFDeEQ7aUJBQU07Z0JBQ0wsT0FBTyx1QkFBdUIsQ0FBQzthQUNoQztTQUNGO0lBQ0gsQ0FBQzs7Z0JBL1ZGLFVBQVU7Ozs7Z0JBVGtCLFFBQVE7Z0JBQ3FELFlBQVk7Z0RBVXZCLE1BQU0sU0FBQyxjQUFjOztJQThWcEcsNEJBQUM7Q0FBQSxBQWhXRCxJQWdXQztTQS9WWSxxQkFBcUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBcHBDb250ZXh0LCBCYWNrRW5kTWVzc2FnZSwgQmluZGluZ0xpc3QsIERhdGFQcm9wSW5mbywgRXZlbnRCdXMsIEZyYW1lQ29tcG9uZW50LCBGcmFtZUNvbnRleHQsIE5nRm9ybUNvbnRyb2wsIFRyYW5zbGF0ZSwgVHJhbnNsYXRlVG9rZW4gfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG4vKipcbiAqIOWQjuerr+a2iOaBr+WkhOeQhuacjeWKoVxuICogQGRlc2NyaXB0aW9uXG4gKiAjIyMg5pyN5Yqh5rOo5YWl5L2N572uXG4gKiAgMeOAgeaVtOS4quihqOWNleeahHJvb3QtY29tcG9uZW50IFxuICogIDLjgIHlvLnlh7rnqpflj6PnmoRyb290LWNvbXBvbmVudCBcbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJhY2tFbmRNZXNzYWdlSGFuZGxlciBpbXBsZW1lbnRzIEJhY2tFbmRNZXNzYWdlLklCYWNrRW5kTWVzc2FnZUhhbmRsZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgQEluamVjdChUcmFuc2xhdGVUb2tlbikgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZSkgeyB9XG4gIC8qKlxuICAgKiDlpITnkIblkI7nq6/ov5Tlm57nmoTmtojmga/miJbplJnor69cbiAgICogQHBhcmFtIG1lc3NhZ2Ug5raI5oGv5oiW6ZSZ6K+vXG4gICAqL1xuICBwdWJsaWMgaGFuZGxlKG1lc3NhZ2U6IEJhY2tFbmRNZXNzYWdlLklNZXNzYWdlLCBjb250ZXh0OiBhbnkpIHtcbiAgICBjb25zdCBpc0V4Y2VwdGlvbiA9IGNvbnRleHQgJiYgY29udGV4dC5pc0V4Y2VwdGlvbiB8fCBmYWxzZTtcbiAgICBjb25zdCBoYXNUaHJvd0Vycm9yID0gY29udGV4dCAmJiBjb250ZXh0Lmhhc1Rocm93RXJyb3IgfHwgZmFsc2U7XG4gICAgY29uc3QgZXZlbnRCdXMgPSBjb250ZXh0ICYmIGNvbnRleHQuZXZlbnRCdXMgfHwgbnVsbDtcbiAgICBjb25zdCBlcnJvciA9IGNvbnRleHQgJiYgY29udGV4dC5lcnJvciB8fCBudWxsO1xuICAgIGNvbnN0IGZvcm1BcHBDb250ZXh0ID0gY29udGV4dCAmJiBjb250ZXh0LmZvcm1BcHBDb250ZXh0IHx8IG51bGw7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5jb2xsZWN0KG1lc3NhZ2UsIGlzRXhjZXB0aW9uLCBoYXNUaHJvd0Vycm9yLCBldmVudEJ1cywgZXJyb3IsIGZvcm1BcHBDb250ZXh0KTtcbiAgICBpZiAocmVzdWx0ICYmIHJlc3VsdC5mb3JtICYmIHJlc3VsdC5mb3JtLmxlbmd0aCA+IDApIHtcbiAgICAgIHJlc3VsdC5mb3JtLmZvckVhY2goKGl0ZW06IHsgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIG1lc3NhZ2U6IGFueSB9KSA9PiB7XG4gICAgICAgIGl0ZW0uZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLnVwZGF0ZUZvcm1FcnJvcnMoaXRlbS5tZXNzYWdlLCB0cnVlLCAnYmFja2VuZCcpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVzZXRGb3JtTWVzc2FnZShtZXNzYWdlLmNvbnRleHQuYXBwQ29udGV4dCwgbWVzc2FnZS5jb250ZXh0Lm5zKTtcbiAgICB9XG4gICAgY29uc3QgdGFyZ2V0RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQgPSB0aGlzLmZpbmRUYXJnZXRGcmFtZUNvbnRleHQodGhpcy5mcmFtZUNvbnRleHQpO1xuICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LmFsbCAmJiByZXN1bHQuYWxsLmxlbmd0aCA+IDApIHtcbiAgICAgIHRhcmdldEZyYW1lQ29udGV4dC52aWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KHJlc3VsdC5hbGwpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAocmVzdWx0ICE9PSBudWxsKSB7XG4gICAgICAgIHRhcmdldEZyYW1lQ29udGV4dC52aWV3TW9kZWwudmVyaWZ5Y2F0aW9uQ2hhbmdlZC5uZXh0KFtdKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIOaUtumbhuaxh+aAu+S/oeaBr+WSjGZvcm3kv6Hmga9cbiAgICogQHBhcmFtIGJhY2tFbmRNZXNzYWdlIFxuICAgKi9cbiAgcHJpdmF0ZSBjb2xsZWN0KGJhY2tFbmRNZXNzYWdlOiBCYWNrRW5kTWVzc2FnZS5JTWVzc2FnZSwgaXNFeGNlcHRpb246IGJvb2xlYW4gPSBmYWxzZSwgaGFzVGhyb3dFcnJvcjogYm9vbGVhbiA9IGZhbHNlLCBldmVudEJ1czogRXZlbnRCdXMgPSBudWxsLCBlcnJvcjogYW55ID0gbnVsbCwgZm9ybUFwcENvbnRleHQ6IEFwcENvbnRleHQgPSBudWxsKTogeyBmb3JtOiB7IGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBtZXNzYWdlOiBhbnkgfVtdLCBhbGw6IGFueVtdIH0ge1xuICAgIGNvbnN0IGJpek1lc3NhZ2VzID0gYmFja0VuZE1lc3NhZ2UgJiYgYmFja0VuZE1lc3NhZ2UuYml6TWVzc2FnZXMgfHwgbnVsbDtcbiAgICBjb25zdCBhcHBDb250ZXh0ID0gYmFja0VuZE1lc3NhZ2UgJiYgYmFja0VuZE1lc3NhZ2UuY29udGV4dC5hcHBDb250ZXh0O1xuICAgIGNvbnN0IG5zID0gYmFja0VuZE1lc3NhZ2UuY29udGV4dC5ucztcbiAgICBpZiAoIWJpek1lc3NhZ2VzIHx8IGJpek1lc3NhZ2VzLmxlbmd0aCA8IDEpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQgPSB7XG4gICAgICBmb3JtOiBbXSxcbiAgICAgIGFsbDogW11cbiAgICB9O1xuICAgIGxldCBoYXNGb3JtbGVzc0Vycm9yID0gZmFsc2U7XG4gICAgZm9yIChsZXQgYml6TWVzc2FnZSBvZiBiaXpNZXNzYWdlcykge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGJpek1lc3NhZ2UubWVzc2FnZTtcbiAgICAgIGNvbnN0IGxvY2F0aW9uID0gYml6TWVzc2FnZS5sb2NhdGlvbiB8fCBudWxsO1xuICAgICAgY29uc3QgY29sdW1ucyA9IGxvY2F0aW9uICYmIGxvY2F0aW9uLmNvbHVtbnMgfHwgbnVsbDtcbiAgICAgIGNvbnN0IG5vZGVDb2RlID0gbG9jYXRpb24gJiYgbG9jYXRpb24ubm9kZUNvZGUgfHwgbnVsbDtcbiAgICAgIGNvbnN0IHJvd3MgPSBsb2NhdGlvbiAmJiBsb2NhdGlvbi5yb3dzO1xuICAgICAgY29uc3QgYmluZGluZ1BhdGggPSB0aGlzLmdldEJpbmRpbmdQYXRoKGFwcENvbnRleHQsIG5zLCBub2RlQ29kZSk7XG4gICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aCAmJiBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuXG4gICAgICAvLyDnm67liY3ku4XlpITnkIbmnIlsb2NhdGlvbu+8jOS4lOaciWlk44CB5YiX5ZCN44CB6KGo5ZCN55qE44CCXG4gICAgICBpZiAoIWxvY2F0aW9uIHx8ICFjb2x1bW5zIHx8IGNvbHVtbnMubGVuZ3RoIDwgMSB8fCAhbm9kZUNvZGUgfHwgIXJvd3MgfHwgcm93cy5sZW5ndGggPCAxKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgLy8g6YGN5Y6G5pWw5o2u6KGMXG4gICAgICBmb3IgKGxldCByb3cgb2Ygcm93cykge1xuICAgICAgICBmb3IgKGxldCBjb2x1bW4gb2YgY29sdW1ucykge1xuICAgICAgICAgIC8vIOiOt+WPluWIsOaJgOaciee7keWumuivpeWIl+aVsOaNrueahGZyYW1lQ29udGV4dFxuICAgICAgICAgIGxldCBmcmFtZUNvbnRleHRzID0gdGhpcy5nZXRGcmFtZUNvbnRleHRzQnlCaW5kaW5nUGF0aEFuZENvbHVtbk5hbWUoYXBwQ29udGV4dCwgbnMsIGJpbmRpbmdQYXRoLCBjb2x1bW4pO1xuICAgICAgICAgIGlmICghZnJhbWVDb250ZXh0cyB8fCBmcmFtZUNvbnRleHRzLmxlbmd0aCA8IDEpIHtcbiAgICAgICAgICAgIC8vIOayoeacieS7u+S9leS4gOS4que7hOS7tue7keWumuivpeWIl+eahOaVsOaNrlxuICAgICAgICAgICAgaGFzRm9ybWxlc3NFcnJvciA9IHRydWU7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8g5o6S6Zmk5o6J5Y+q6K+7ZGF0YWdyaWRcbiAgICAgICAgICBmcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpc0RhdGFHcmlkQ29tcG9uZW50ID0gdGhpcy5pc0RhdGFHcmlkQ29tcG9uZW50KGZyYW1lQ29udGV4dC5mcmFtZUNvbXBvbmVudCk7XG4gICAgICAgICAgICBpZiAoaXNEYXRhR3JpZENvbXBvbmVudCkge1xuICAgICAgICAgICAgICBjb25zdCBpc1JlYWRvbmx5RGF0YUdyaWQgPSB0aGlzLmlzUmVhZG9ubHlEYXRhR3JpZChmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQpO1xuICAgICAgICAgICAgICBpZiAoaXNSZWFkb25seURhdGFHcmlkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICAvLyDpgY3ljobnmoTooYzmmK/lkKbkuLrlvZPliY3ooYxcbiAgICAgICAgICBjb25zdCBpc0N1cnJlbnRSb3cgPSB0aGlzLmlzQ3VycmVudFJvdyhhcHBDb250ZXh0LCBucywgYmluZGluZ1BhdGgsIHJvdyk7XG4gICAgICAgICAgLy8g5aaC5p6c5piv5b2T5YmN6KGM55qE6K+d6ZyA6KaB5bCG6ZSZ6K+v5L+h5oGv5pS+5YiwZm9ybeS4rVxuICAgICAgICAgIGlmIChpc0N1cnJlbnRSb3cpIHtcbiAgICAgICAgICAgIC8vIOW/veeVpWdyaWRcbiAgICAgICAgICAgIC8vIGNvbnN0IGZvcm1GcmFtZUNvbnRleHRzID0gZnJhbWVDb250ZXh0cy5maWx0ZXIoZnJhbWVDb250ZXh0ID0+ICF0aGlzLmlzR3JpZENvbXBvbmVudChmcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQpKTtcbiAgICAgICAgICAgIGlmIChmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICAgICAgICAgICAgLy8g5Y+q5aSE55CG5LqG5LiA5Liq57uE5Lu25Lit5YiX5Y+q57uR5a6a5Yiw5LiA5Liq5YmN56uv5o6n5Lu255qE5Zy65pmvXG4gICAgICAgICAgICAgICAgY29uc3QgZm9ybUNvbnRyb2xzID0gdGhpcy5nZXRGb3JtQ29udHJvbEJ5Q29sdW1uTmFtZShmcmFtZUNvbnRleHQsIGNvbHVtbik7XG4gICAgICAgICAgICAgICAgaWYgKGZvcm1Db250cm9scyAmJiBmb3JtQ29udHJvbHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgZm9ybUNvbnRyb2xzLmZvckVhY2goKFtkb21Qcm9wZXJ0eU5hbWUsIGZvcm1Db250cm9sXSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvL2NvbnN0IGRvbVByb3BlcnR5TmFtZSA9IGZvcm1Db250cm9sICYmIGZvcm1Db250cm9sLiB8fCBudWxsO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm1lcmdlTWVzc2FnZShyZXN1bHQuZm9ybSwgZnJhbWVDb250ZXh0LCBkb21Qcm9wZXJ0eU5hbWUsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy9pZiAoZm9ybUNvbnRyb2wgJiYgZG9tUHJvcGVydHlOYW1lKSB7XG5cbiAgICAgICAgICAgICAgICAvL31cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICAvLyDlsIbplJnor6/kv6Hmga/mlL7liLDmsYfmgLvkuK1cbiAgICAgICAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goKGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCB2aWV3TW9kZWxOYW1lID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLmZvcm1Hcm91cE5hbWU7XG4gICAgICAgICAgICBjb25zdCBmb3JtQ29udHJvbHMgPSB0aGlzLmdldEZvcm1Db250cm9sQnlDb2x1bW5OYW1lKGZyYW1lQ29udGV4dCwgY29sdW1uKTtcbiAgICAgICAgICAgIGlmIChmb3JtQ29udHJvbHMgJiYgZm9ybUNvbnRyb2xzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgY29uc3QgW2RvbVByb3BlcnR5TmFtZSwgZm9ybUNvbnRyb2xdID0gZm9ybUNvbnRyb2xzLmZpbmQoKFtwcm9wZXJ0eU5hbWUsIGZvcm1Db250cm9sXSkgPT4gcHJvcGVydHlOYW1lICYmIHByb3BlcnR5TmFtZS5sZW5ndGggPiAwKTtcbiAgICAgICAgICAgICAgLy8gY29uc3QgZG9tUHJvcGVydHlOYW1lID0gZG9tUHJvcGVydHkgJiYgZG9tUHJvcGVydHkucHJvcGVydHlOYW1lO1xuICAgICAgICAgICAgICBjb25zdCBiaW5kaW5nTGlzdCA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWwuYmluZGluZ0RhdGEuZ2V0VmFsdWUoYmluZGluZ1BhdGhzKSBhcyBCaW5kaW5nTGlzdDtcbiAgICAgICAgICAgICAgbGV0IGluZGV4ID0gYmluZGluZ0xpc3QuZ2V0SW5kZXhCeUlkKHJvdyk7XG4gICAgICAgICAgICAgIGNvbnN0IHByaW1hcnkgPSBgJHtyb3d9XyR7Y29sdW1ufV8ke21lc3NhZ2V9YDtcbiAgICAgICAgICAgICAgLy8gVE9ETzromb3nhLbog73nuqDmraPmsYfmgLvmtojmga/mmL7npLrph43lpI3nmoTpl67popjvvIzkvYblj6/og73lr7zoh7Tngrnlh7vplJnor6/ml6Dms5XlrprkvY3liLDlr7nlupTmjqfku7bnmoTpl67popjvvIzlvoXlkI7nu63kvJjljJZcbiAgICAgICAgICAgICAgaWYgKGluZGV4ID49IDAgJiYgcmVzdWx0LmFsbC5maW5kSW5kZXgocCA9PiBwLmlkID09PSBwcmltYXJ5KSA9PT0gLTEpIHtcbiAgICAgICAgICAgICAgICAvLyDmlbDmja7mupDkuK3mnInlpJrkuo4x6KGM5pe25pi+56S657Si5byVXG4gICAgICAgICAgICAgICAgY29uc3QgcG9zaXRpb24gPSAoYmluZGluZ0xpc3QgJiYgYmluZGluZ0xpc3QubGVuZ3RoID4gMSkgPyAoaW5kZXggKyAxKSA6IC0xO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRpdGxlID0gdGhpcy5idWlsZEl0ZW1UaXRsZSh2aWV3TW9kZWxOYW1lLCBmb3JtQ29udHJvbC5uYW1lIHx8IGZvcm1Db250cm9sLmRlZmF1bHRJMThuVmFsdWUgfHwgZG9tUHJvcGVydHlOYW1lLCBwb3NpdGlvbik7XG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IHtcbiAgICAgICAgICAgICAgICAgIGlkOiBwcmltYXJ5LFxuICAgICAgICAgICAgICAgICAgaW5kZXgsXG4gICAgICAgICAgICAgICAgICB0YXJnZXRGaWVsZDogZm9ybUNvbnRyb2wuaWQsXG4gICAgICAgICAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICAgICAgICAgIG1zZzogbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZTogbnMsXG4gICAgICAgICAgICAgICAgICBiaW5kaW5nUGF0aCxcbiAgICAgICAgICAgICAgICAgIHR5cGU6ICdlcnJvcidcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJlc3VsdC5hbGwucHVzaChpdGVtKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKGhhc0Zvcm1sZXNzRXJyb3IgJiYgaXNFeGNlcHRpb24gJiYgIWhhc1Rocm93RXJyb3IgJiYgZXZlbnRCdXMpIHtcbiAgICAgIGV2ZW50QnVzLnBvc3QoJ0V4Y2VwdGlvbicsICcnLCAnb25FeGNlcHRpb24nLCBlcnJvciwgZm9ybUFwcENvbnRleHQpO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIHByaXZhdGUgbWVyZ2VNZXNzYWdlKGZvcm1JdGVtczogeyBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgbWVzc2FnZTogeyBbZG9tUHJvcGVydHlOYW1lOiBzdHJpbmddOiB7IGVycm9yczogeyBbbWVzc2FnZVR5cGU6IHN0cmluZ106IHsgbmFtZTogc3RyaW5nIH0gfSB9IH0gfVtdLCBmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgZG9tUHJvcGVydHlOYW1lOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZykge1xuICAgIGNvbnN0IHRhcmdldEl0ZW0gPSBmb3JtSXRlbXMuZmluZChpdGVtID0+IGl0ZW0uZnJhbWVDb250ZXh0LmZyYW1lSWQgPT09IGZyYW1lQ29udGV4dC5mcmFtZUlkKTtcbiAgICBpZiAodGFyZ2V0SXRlbSkge1xuICAgICAgY29uc3QgaXNQcm9wZXJ0eUV4aXN0ID0gdGFyZ2V0SXRlbS5tZXNzYWdlICYmIE9iamVjdC5rZXlzKHRhcmdldEl0ZW0ubWVzc2FnZSkuaW5jbHVkZXMoZG9tUHJvcGVydHlOYW1lKTtcbiAgICAgIGNvbnN0IG1lc3NhZ2VUeXBlID0gYGJhY2tlbmQtbWVzc2FnZS0ke09iamVjdC5rZXlzKHRhcmdldEl0ZW0ubWVzc2FnZSkubGVuZ3RoICsgMX1gO1xuICAgICAgaWYgKGlzUHJvcGVydHlFeGlzdCkge1xuICAgICAgICB0YXJnZXRJdGVtLm1lc3NhZ2VbZG9tUHJvcGVydHlOYW1lXVsnZXJyb3JzJ11bbWVzc2FnZVR5cGVdID0geyBuYW1lOiBtZXNzYWdlIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0YXJnZXRJdGVtLm1lc3NhZ2VbZG9tUHJvcGVydHlOYW1lXSA9IHsgZXJyb3JzOiB7IFttZXNzYWdlVHlwZV06IHsgbmFtZTogbWVzc2FnZSB9IH0gfTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZm9ybUl0ZW1zLnB1c2goe1xuICAgICAgICBmcmFtZUNvbnRleHQ6IGZyYW1lQ29udGV4dCxcbiAgICAgICAgbWVzc2FnZToge1xuICAgICAgICAgIFtkb21Qcm9wZXJ0eU5hbWVdOiB7XG4gICAgICAgICAgICBlcnJvcnM6IHtcbiAgICAgICAgICAgICAgJ2JhY2tlbmQtbWVzc2FnZS0xJzogeyBuYW1lOiBtZXNzYWdlIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGJ1aWxkSXRlbVRpdGxlKHZpZXdNb2RlbE5hbWU6IHN0cmluZywgcHJvcGVydHlOYW1lOiBzdHJpbmcsIGluZGV4OiBhbnkpIHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IHtcbiAgICAgICd6aC1DSFMnOiB7XG4gICAgICAgIHZpZXdNb2RlbE5hbWU6IGAkdmlld01vZGVsYCxcbiAgICAgICAgaW5kZXg6IGDnrKwgJGluZGV4IOihjGAsXG4gICAgICAgIHByb3BlcnR5TmFtZTogYC0gJHByb3BlcnR5TmFtZWBcbiAgICAgIH0sXG4gICAgICAnZW4nOiB7XG4gICAgICAgIHZpZXdNb2RlbE5hbWU6IGAkdmlld01vZGVsYCxcbiAgICAgICAgaW5kZXg6IGByb3cgJGluZGV4YCxcbiAgICAgICAgcHJvcGVydHlOYW1lOiBgLSAkcHJvcGVydHlOYW1lYFxuICAgICAgfSxcbiAgICAgICd6aC1DSFQnOiB7XG4gICAgICAgIHZpZXdNb2RlbE5hbWU6IGAkdmlld01vZGVsYCxcbiAgICAgICAgaW5kZXg6IGDnrKwgJGluZGV4IOihjGAsXG4gICAgICAgIHByb3BlcnR5TmFtZTogYC0gJHByb3BlcnR5TmFtZWBcbiAgICAgIH1cbiAgICB9O1xuICAgIGNvbnN0IGN1cnJlbnRMYW5ndWFnZSA9IHRoaXMudHJhbnNsYXRlLmdldEN1cnJlbnRMYW5ndWFnZSgpIHx8ICd6aC1DSFMnO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBbXTtcbiAgICBpZiAodmlld01vZGVsTmFtZSkge1xuICAgICAgbWVzc2FnZS5wdXNoKHRlbXBsYXRlW2N1cnJlbnRMYW5ndWFnZV1bJ3ZpZXdNb2RlbE5hbWUnXS5yZXBsYWNlKCckdmlld01vZGVsJywgdmlld01vZGVsTmFtZSkpO1xuICAgIH1cbiAgICBpZiAoaW5kZXggPiAwKSB7XG4gICAgICBtZXNzYWdlLnB1c2godGVtcGxhdGVbY3VycmVudExhbmd1YWdlXVsnaW5kZXgnXS5yZXBsYWNlKCckaW5kZXgnLCBpbmRleCkpO1xuICAgIH1cbiAgICBpZiAocHJvcGVydHlOYW1lKSB7XG4gICAgICBtZXNzYWdlLnB1c2godGVtcGxhdGVbY3VycmVudExhbmd1YWdlXVsncHJvcGVydHlOYW1lJ10ucmVwbGFjZSgnJHByb3BlcnR5TmFtZScsIHByb3BlcnR5TmFtZSkpO1xuICAgIH1cbiAgICByZXR1cm4gbWVzc2FnZS5qb2luKCcgJyk7XG4gIH1cbiAgLyoqXG4gICAqIOagueaNruihqOWQjeaIlm5vZGVDb2Rl6I635Y+W57uR5a6a6Lev5b6EXG4gICAqIEBwYXJhbSBhcHBDb250ZXh0IGFwcENvbnRleHRcbiAgICogQHBhcmFtIG5zIG5zXG4gICAqIEBwYXJhbSBub2RlQ29kZSDooajlkI1cbiAgICovXG4gIHByaXZhdGUgZ2V0QmluZGluZ1BhdGgoYXBwQ29udGV4dDogQXBwQ29udGV4dCwgbnM6IHN0cmluZywgbm9kZUNvZGU6IHN0cmluZykge1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0RnJhbWVDb250ZXh0KGFwcENvbnRleHQsIG5zKTtcbiAgICByZXR1cm4gZnJhbWVDb250ZXh0LnJlcG9zaXRvcnkuZW50aXR5VHlwZUluZm8uZ2V0QmluZGluZ1BhdGhCeVRhYmxlTmFtZShub2RlQ29kZSk7XG4gIH1cbiAgLyoqXG4gICAqIOmAmui/h+e7keWumui3r+W+hOWSjOWIl+WQjeaJvuWIsOaJgOacieespuWQiOadoeS7tueahOinhuWbvuaooeWeiyjljIXmi6xncmlk5ZKMZm9ybSlcbiAgICogQHBhcmFtIGFwcENvbnRleHQgYXBwQ29udGV4dFxuICAgKiBAcGFyYW0gbnMgbmFtZXNwYWNlXG4gICAqIEBwYXJhbSBiaW5kaW5nUGF0aCDnu5Hlrprot6/lvoRcbiAgICogQHBhcmFtIGNvbHVtbk5hbWUg5YiX5ZCNXG4gICAqL1xuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dHNCeUJpbmRpbmdQYXRoQW5kQ29sdW1uTmFtZShhcHBDb250ZXh0OiBBcHBDb250ZXh0LCBuczogc3RyaW5nLCBiaW5kaW5nUGF0aDogc3RyaW5nLCBjb2x1bW5OYW1lOiBzdHJpbmcpOiBGcmFtZUNvbnRleHRbXSB7XG4gICAgbGV0IGZyYW1lQ29udGV4dHMgPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIuZ2V0RnJhbWVDb250ZXh0cygpO1xuICAgIGlmIChmcmFtZUNvbnRleHRzICYmIGZyYW1lQ29udGV4dHMubGVuZ3RoID4gMCkge1xuICAgICAgLy8g5om+5YiwZm9ybeS4reacieaOp+S7tueahGZyYW1lQ29udGV4dFxuICAgICAgZnJhbWVDb250ZXh0cyA9IGZyYW1lQ29udGV4dHMuZmlsdGVyKChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCkgPT4ge1xuICAgICAgICAvLyDln7rmnKzmnaHku7bmmK/lkKbmu6HotrNcbiAgICAgICAgbGV0IGlzVmFsaWRGcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHQubmFtZXNwYWNlID09PSBucyAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmJpbmRpbmdQYXRoID09PSBiaW5kaW5nUGF0aCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0gJiYgZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5mb3JtLmNvbnRyb2xzICYmIE9iamVjdC5rZXlzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5jb250cm9scykubGVuZ3RoID4gMDtcbiAgICAgICAgaWYgKCFpc1ZhbGlkRnJhbWVDb250ZXh0KSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIC8vIOWGjemAmui/h+WIl+WQjei/h+a7pFxuICAgICAgICBjb25zdCBiaW5kaW5nUGF0aHMgPSBiaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgICAgICBjb25zdCBkYXRhVHlwZUluZm8gPSBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRUeXBlSW5mb0J5UGF0aChiaW5kaW5nUGF0aHMpO1xuICAgICAgICBpZiAoZGF0YVR5cGVJbmZvKSB7XG4gICAgICAgICAgY29uc3QgZGF0YVByb3BJbmZvcyA9IEFycmF5LmZyb20oZGF0YVR5cGVJbmZvLnByb3BJbmZvTWFwLnZhbHVlcygpKTtcbiAgICAgICAgICAvLyDku47lvZPliY3lrp7kvZPlsZ7mgKfkuK3mib7liLDmlbDmja7lrZfmrrXkuLrliJflkI3nmoTlsZ7mgKdcbiAgICAgICAgICBjb25zdCBlbnRpdHlQcm9wZXJ0eUluZm8gPSBkYXRhUHJvcEluZm9zLmZpbmQoKHByb3BJbmZvOiBEYXRhUHJvcEluZm8pID0+IHByb3BJbmZvLm1ldGFkYXRhSW5mbyAmJiAocHJvcEluZm8ubWV0YWRhdGFJbmZvLm9yaWdpbmFsRGF0YUZpZWxkID09PSBjb2x1bW5OYW1lIHx8IHByb3BJbmZvLm1ldGFkYXRhSW5mby5kYXRhRmllbGQgPT09IGNvbHVtbk5hbWUpKTtcbiAgICAgICAgICBpZiAoZW50aXR5UHJvcGVydHlJbmZvKSB7XG4gICAgICAgICAgICBjb25zdCBlbnRpdHlQcm9wZXJ0eU5hbWUgPSBlbnRpdHlQcm9wZXJ0eUluZm8ubmFtZTtcbiAgICAgICAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2wgPSBPYmplY3QudmFsdWVzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5uZ0Zvcm1Db250cm9scykuZmluZChpdGVtID0+IGl0ZW0uYmluZGluZyA9PT0gZW50aXR5UHJvcGVydHlOYW1lKTtcbiAgICAgICAgICAgIGlmIChuZ0Zvcm1Db250cm9sKSB7XG4gICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IE9iamVjdC5rZXlzKGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybS5uZ0Zvcm1Db250cm9scykuZmluZChrZXkgPT4ga2V5ID09PSBlbnRpdHlQcm9wZXJ0eU5hbWUpO1xuICAgICAgICAgICAgICByZXR1cm4gaXRlbSA/IHRydWUgOiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIGZyYW1lQ29udGV4dHM7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG4gIC8qKlxuICAgKiDmmK/lkKbkuLpkYXRhZ3JpZOe7hOS7tlxuICAgKiBAcGFyYW0gZnJhbWVDb21wb25lbnQgY29tcG9uZW50XG4gICAqL1xuICBwcml2YXRlIGlzRGF0YUdyaWRDb21wb25lbnQoZnJhbWVDb21wb25lbnQ6IEZyYW1lQ29tcG9uZW50KSB7XG4gICAgY29uc3QgY29sdW1uTmFtZXMgPSBmcmFtZUNvbXBvbmVudC5jb250ZXh0LnZpZXdNb2RlbFsnZGF0YUdyaWRDb2x1bW5zTmFtZSddIHx8IG51bGw7XG4gICAgcmV0dXJuIGNvbHVtbk5hbWVzID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG4gIC8qKlxuICAgKiBncmlk57uE5Lu25piv5ZCm5piv5Y+q6K+755qEXG4gICAqIEBwYXJhbSBmcmFtZUNvbXBvbmVudCBmcmFtZUNvbXBvbmVudFxuICAgKiBAcmV0dXJucyBcbiAgICovXG4gIHByaXZhdGUgaXNSZWFkb25seURhdGFHcmlkKGZyYW1lQ29tcG9uZW50OiBGcmFtZUNvbXBvbmVudCkge1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dCA9IGZyYW1lQ29tcG9uZW50LmNvbnRleHQ7XG4gICAgY29uc3QgZGF0YUdyaWRDb2x1bW5zTmFtZSA9IGZyYW1lQ29udGV4dC52aWV3TW9kZWxbJ2RhdGFHcmlkQ29sdW1uc05hbWUnXSB8fCBudWxsO1xuICAgIGlmIChkYXRhR3JpZENvbHVtbnNOYW1lKSB7XG4gICAgICBjb25zdCBkYXRhZ3JpZENvbHVtbnM6IGFueVtdID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbFtkYXRhR3JpZENvbHVtbnNOYW1lXTtcbiAgICAgIHJldHVybiBkYXRhZ3JpZENvbHVtbnMuZXZlcnkoKGdyb3VwOiBBcnJheTxhbnk+KSA9PiB7XG4gICAgICAgIHJldHVybiBncm91cC5ldmVyeShpdGVtID0+ICFpdGVtLmVkaXRvcik7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGDkvKDlhaXnmoTnu4Tku7bkuI3mmK/kuIDkuKrooajmoLzvvIFgKTtcbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIGlk5piv5ZCm5Li65b2T5YmN6KGMXG4gICAqIEBwYXJhbSBhcHBDb250ZXh0IGFwcENvbnRleHRcbiAgICogQHBhcmFtIG5zIG5hbWVzcGFjZVxuICAgKiBAcGFyYW0gYmluZGluZ1BhdGggYmluZGluZ1BhdGhcbiAgICogQHBhcmFtIGlkIGlkXG4gICAqL1xuICBwcml2YXRlIGlzQ3VycmVudFJvdyhhcHBDb250ZXh0OiBBcHBDb250ZXh0LCBuczogc3RyaW5nLCBiaW5kaW5nUGF0aDogc3RyaW5nLCBpZDogc3RyaW5nKSB7XG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gYmluZGluZ1BhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKTtcbiAgICBjb25zdCBmcmFtZUNvbnRleHQgPSB0aGlzLmdldEZyYW1lQ29udGV4dChhcHBDb250ZXh0LCBucyk7XG4gICAgY29uc3QgYmluZGluZ0RhdGEgPSBmcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XG4gICAgY29uc3QgYmluZGluZ0xpc3QgPSBiaW5kaW5nRGF0YS5nZXRWYWx1ZShiaW5kaW5nUGF0aHMpIGFzIEJpbmRpbmdMaXN0O1xuICAgIHJldHVybiBiaW5kaW5nTGlzdC5jdXJyZW50SXRlbS5wcmltYXJ5S2V5VmFsdWUgPT09IGlkO1xuICB9XG4gIC8qKlxuICAgKiDojrflj5blvZPliY1uc+S4i+eahHJvb3RGcmFtZUNvbnRleHRcbiAgICogQHBhcmFtIGFwcENvbnRleHQgYXBwY29udGV4dFxuICAgKiBAcGFyYW0gbnMgbmFtZXNwYWNlXG4gICAqL1xuICBwcml2YXRlIGdldEZyYW1lQ29udGV4dChhcHBDb250ZXh0OiBBcHBDb250ZXh0LCBuczogc3RyaW5nKSB7XG4gICAgY29uc3QgZnJhbWVDb250ZXh0cyA9IGFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRzKCk7XG4gICAgaWYgKGZyYW1lQ29udGV4dHMgJiYgZnJhbWVDb250ZXh0cy5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCByYW5kb21GcmFtZUNvbnRleHQgPSBmcmFtZUNvbnRleHRzLmZpbmQoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IG5zKTtcbiAgICAgIGlmIChyYW5kb21GcmFtZUNvbnRleHQpIHtcbiAgICAgICAgY29uc3QgdmlydHVhbFJvb3RGcmFtZUNvbnRleHQgPSByYW5kb21GcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcbiAgICAgICAgcmV0dXJuIHZpcnR1YWxSb290RnJhbWVDb250ZXh0O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICAvKipcbiAgICog6YCa6L+H57uR5a6a6Lev5b6E5ZKM5YiX5ZCN6I635Y+W57uR5a6a5Yiw6K+l5YiX55qEZm9ybUNvbnRyb2xcbiAgICovXG4gIHByaXZhdGUgZ2V0Rm9ybUNvbnRyb2xCeUNvbHVtbk5hbWUoZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQsIGNvbHVtbk5hbWU6IHN0cmluZyk6IEFycmF5PFtzdHJpbmcsIE5nRm9ybUNvbnRyb2xdPiB7XG4gICAgY29uc3QgYmluZGluZ1BhdGhzID0gZnJhbWVDb250ZXh0LnZpZXdNb2RlbC5iaW5kaW5nUGF0aC5zcGxpdCgnLycpLmZpbHRlcihwID0+IHApO1xuICAgIC8vIOmAmui/h2JpbmRpbmdQYXRo5om+5Yiw5a+55bqU55qE5a6e5L2T5L+h5oGvXG4gICAgY29uc3QgdHlwZUluZm8gPSBmcmFtZUNvbnRleHQucmVwb3NpdG9yeS5lbnRpdHlUeXBlSW5mby5nZXRUeXBlSW5mb0J5UGF0aChiaW5kaW5nUGF0aHMpO1xuXG4gICAgY29uc3QgcHJvcHNJbmZvID0gQXJyYXkuZnJvbSh0eXBlSW5mby5wcm9wSW5mb01hcC52YWx1ZXMoKSk7XG4gICAgY29uc3QgcHJvcEluZm8gPSBwcm9wc0luZm8uZmluZCgocHJvcEluZm86IERhdGFQcm9wSW5mbykgPT4gcHJvcEluZm8ubWV0YWRhdGFJbmZvICYmIChwcm9wSW5mby5tZXRhZGF0YUluZm8ub3JpZ2luYWxEYXRhRmllbGQgPT09IGNvbHVtbk5hbWUgfHwgcHJvcEluZm8ubWV0YWRhdGFJbmZvLmRhdGFGaWVsZCA9PT0gY29sdW1uTmFtZSkpO1xuICAgIGlmIChwcm9wSW5mbykge1xuICAgICAgY29uc3QgbWFwcGluZ05hbWUgPSBwcm9wSW5mby5uYW1lO1xuICAgICAgY29uc3QgZm9ybUNvbnRyb2xzOiBBcnJheTxbc3RyaW5nLCBOZ0Zvcm1Db250cm9sXT4gPSBPYmplY3QuZW50cmllcyhmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0ubmdGb3JtQ29udHJvbHMpLmZpbHRlcigoaXRlbSkgPT4gaXRlbVsxXS5iaW5kaW5nID09PSBtYXBwaW5nTmFtZSB8fCBpdGVtWzBdID09PSBtYXBwaW5nTmFtZSk7XG4gICAgICAvLyBjb25zdCBuZ0Zvcm1Db250cm9sID0gT2JqZWN0LnZhbHVlcyhmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0ubmdGb3JtQ29udHJvbHMpLmZpbmQoaXRlbSA9PiBpdGVtLmJpbmRpbmcgPT09IG1hcHBpbmdOYW1lKTtcbiAgICAgIGlmIChmb3JtQ29udHJvbHMpIHtcbiAgICAgICAgcmV0dXJuIGZvcm1Db250cm9scztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcHJpdmF0ZSByZXNldEZvcm1NZXNzYWdlKGFwcENvbnRleHQ6IEFwcENvbnRleHQsIG5zOiBzdHJpbmcpIHtcbiAgICBjb25zdCBmcmFtZUNvbnRleHRzID0gYXBwQ29udGV4dC5mcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dHMoKS5maWx0ZXIoZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dC5uYW1lc3BhY2UgPT09IG5zKTtcbiAgICBmcmFtZUNvbnRleHRzLmZvckVhY2goZnJhbWVDb250ZXh0ID0+IGZyYW1lQ29udGV4dCAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsICYmIGZyYW1lQ29udGV4dC52aWV3TW9kZWwuZm9ybSAmJiBmcmFtZUNvbnRleHQudmlld01vZGVsLmZvcm0uY2xlYXJCYWNrZW5kRXJyb3IoKSk7XG4gIH1cbiAgLyoqXG4gICAqIOmAkuW9kuaJvuWIsOWxleekuua2iOaBr+eahOe7hOS7tuS4iuS4i+aWh1xuICAgKiBAcGFyYW0gZnJhbWVDb250ZXh0IGZyYW1lQ29udGV4dFxuICAgKi9cbiAgcHJpdmF0ZSBmaW5kVGFyZ2V0RnJhbWVDb250ZXh0KGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0KTogRnJhbWVDb250ZXh0IHtcbiAgICBjb25zdCB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpO1xuICAgIGNvbnN0IHZpcnR1YWxSb290Q29tcG9uZW50ID0gdmlydHVhbFJvb3RGcmFtZUNvbnRleHQuZnJhbWVDb21wb25lbnQ7XG4gICAgY29uc3QgaXNEaWFsb2dDb21wb25lbnQgPSB2aXJ0dWFsUm9vdENvbXBvbmVudCAmJiB2aXJ0dWFsUm9vdENvbXBvbmVudFsnaXNEaWFsb2dSb290Q29tcG9uZW50J10gfHwgZmFsc2U7XG4gICAgaWYgKGlzRGlhbG9nQ29tcG9uZW50KSB7XG4gICAgICAvLyDlpoLmnpzmtojmga/lpITnkIbmnI3liqHmmK/lvLnnqpflhoXnmoTvvIzliJnmtojmga/mj5DnpLrlsZXnpLrlnKjlvLnnqpflhoVcbiAgICAgIHJldHVybiB2aXJ0dWFsUm9vdEZyYW1lQ29udGV4dDtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8g5b2T5YmN5raI5oGv5pyN5Yqh5LiN5Zyo5by556qX5YaF77yM6YCS5b2S5ZCR5LiK5p+l5om+77yM5om+5Yiw56ys5LiA5Liq5by556qX77yM5aaC5p6c5om+5LiN5Yiw5YiZ5om+5Yiw5pyA5LiK55qEcm9vdC1jb21wb25lbnRcbiAgICAgIGNvbnN0IHBhcmVudEZyYW1lQ29udGV4dCA9IHZpcnR1YWxSb290RnJhbWVDb250ZXh0LnBhcmVudDtcbiAgICAgIGlmIChwYXJlbnRGcmFtZUNvbnRleHQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmluZFRhcmdldEZyYW1lQ29udGV4dChwYXJlbnRGcmFtZUNvbnRleHQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHZpcnR1YWxSb290RnJhbWVDb250ZXh0O1xuICAgICAgfVxuICAgIH1cbiAgfVxufSJdfQ==