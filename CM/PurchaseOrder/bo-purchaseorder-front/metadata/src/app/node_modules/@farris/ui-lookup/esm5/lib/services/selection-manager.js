/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
var SelectionManager = /** @class */ (function () {
    function SelectionManager(ins) {
        this.ins = ins;
    }
    /**
     * @return {?}
     */
    SelectionManager.prototype.destroy = /**
     * @return {?}
     */
    function () {
    };
    /**
     * @return {?}
     */
    SelectionManager.prototype.getBindingData = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var jsonData = this.ins.bindingData;
        if (this.ins.ngControl &&
            this.ins.ngControl.formDirective &&
            this.ins.ngControl.formDirective.form &&
            this.ins.ngControl.formDirective.form.bindingData) {
            /** @type {?} */
            var bindingData = this.ins.ngControl.formDirective.form.bindingData;
            jsonData = bindingData;
            if (bindingData.getObject) {
                jsonData = bindingData.getObject().toJSON();
            }
        }
        return jsonData;
    };
    /**
     * @return {?}
     */
    SelectionManager.prototype.initDisplayValue = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var jsonData = this.getBindingData();
        if (jsonData && this.ins.mapFields) {
            /** @type {?} */
            var idField = this.ins.idField;
            /** @type {?} */
            var targetField = this.ins.mapFields[idField];
            if (targetField) {
                if (targetField.indexOf(',') > -1) {
                    targetField = targetField.split(',')[0];
                }
                /** @type {?} */
                var val = this.ins.utils.getValue(targetField, jsonData);
                if (val) {
                    this.ins.displayValue = val;
                }
            }
        }
    };
    /**
     * @private
     * @return {?}
     */
    SelectionManager.prototype._clearSelections = /**
     * @private
     * @return {?}
     */
    function () {
        var t = this.getDataCmpInstance().cmpRefInstance;
        if (t) {
            if (this.ins.isTree()) {
                // 树表
                t.clearAll(false);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                t.dtBody.selectedRowIndex = -1;
                t.dtBody.selections = undefined;
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    };
    /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     */
    /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     * @param {?=} selectedIds
     * @return {?}
     */
    SelectionManager.prototype.selectCurrentValue = /**
     * 帮助窗口打开后，根据 displayValue 选中数据
     * @param {?=} selectedIds
     * @return {?}
     */
    function (selectedIds) {
        var _this = this;
        if (selectedIds === void 0) { selectedIds = []; }
        if (!this.ins.enableToSelect) {
            return;
        }
        var _a = this.getDataCmpInstance(), t = _a.cmpRefInstance, items = _a.items;
        if (!t || !items || !items.length) {
            return;
        }
        this._clearSelections();
        if (!selectedIds || !selectedIds.length) {
            /** @type {?} */
            var selectedRows = this.ins.lookupSelectionSer.getSelections();
            if (selectedRows.length) {
                selectedIds = selectedRows.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n[_this.ins.idField]; }));
            }
        }
        // const _ids = this.getSelectedIds();
        // selectedIds = selectedIds.concat(_ids);
        // selectedIds = Array.from(new Set(selectedIds));
        if (selectedIds && selectedIds.length) {
            if (this.ins.isTree()) {
                // 树表
                this.selected4Treetable(t, selectedIds);
                if (!t.cdRef.destroyed) {
                    t.cdRef.detectChanges();
                }
            }
            else {
                // 列表
                this.selected4Datatable(t, items, selectedIds);
                if (!t.cd.destroyed) {
                    t.cd.detectChanges();
                }
            }
        }
    };
    /**
     * @private
     * @return {?}
     */
    SelectionManager.prototype.getDataCmpInstance = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var ref = null;
        /** @type {?} */
        var items = null;
        if (this.ins.activeTab === 'datalist') {
            if (this.ins.isTree()) {
                ref = this.ins.lookupCmpMgr.getComponentInstance('treetable');
                items = ((/** @type {?} */ (ref))).serializedValue;
            }
            else {
                items = this.ins.items;
                ref = this.ins.lookupCmpMgr.getComponentInstance();
            }
        }
        else if (this.ins.activeTab === 'favorite') {
            ref = this.ins.lookupCmpMgr.getComponentInstance('fav');
            items = this.ins.favoriteItems;
        }
        return { cmpRefInstance: ref, items: items };
    };
    /**
     * @private
     * @param {?} t
     * @param {?} items
     * @param {?} values
     * @return {?}
     */
    SelectionManager.prototype.selected4Datatable = /**
     * @private
     * @param {?} t
     * @param {?} items
     * @param {?} values
     * @return {?}
     */
    function (t, items, values) {
        var _this = this;
        if (this.ins.singleSelect) {
            items.forEach((/**
             * @param {?} item
             * @param {?} index
             * @return {?}
             */
            function (item, index) {
                if (item[_this.ins.idField] === values[0]) {
                    if (!t.dtBody.isSelected(item)) {
                        t.dtBody.selectedRowIndex = -1;
                        t.dtBody.selectedRow('', index, item);
                    }
                }
            }));
        }
        else {
            // const values = this.getSelectedIds();
            values.forEach((/**
             * @param {?} id
             * @return {?}
             */
            function (id) {
                /** @type {?} */
                var r = items.find((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n[_this.ins.idField] == id; }));
                if (r) {
                    t.checkRow(id);
                }
            }));
        }
    };
    /**
     * @private
     * @param {?} t
     * @param {?} valueArr
     * @return {?}
     */
    SelectionManager.prototype.selected4Treetable = /**
     * @private
     * @param {?} t
     * @param {?} valueArr
     * @return {?}
     */
    function (t, valueArr) {
        if (this.ins.singleSelect) {
            t.selectNode(valueArr[0], false, false);
        }
        else {
            // const valueArr = this.getSelectedIds();
            t.checkedNodes(valueArr, false, false, true);
            t.selectNodes(valueArr);
        }
    };
    /**
     * @return {?}
     */
    SelectionManager.prototype.getSelectedIds = /**
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var values = [];
        /** @type {?} */
        var s = this.ins.multipleChoiceSeparator;
        if (!this.ins.singleSelect && this.ins.displayValue && ('' + this.ins.displayValue).indexOf(s) > -1) {
            values = this.ins.displayValue.split(s);
        }
        else {
            if (this.ins.displayValue !== null && this.ins.displayValue !== '' && this.ins.displayValue !== undefined) {
                values = [this.ins.displayValue];
            }
        }
        // 启用显示多选列表
        if (this.ins.showSelected) {
            /** @type {?} */
            var rows = this.ins.lookupSelectionSer.getSelections();
            if (rows && rows.length) {
                values = rows.map((/**
                 * @param {?} n
                 * @return {?}
                 */
                function (n) { return n[_this.ins.idField]; }));
            }
            else {
                values = [];
            }
        }
        return values;
    };
    return SelectionManager;
}());
export { SelectionManager };
if (false) {
    /**
     * @type {?}
     * @private
     */
    SelectionManager.prototype.ins;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1hbmFnZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9zZWxlY3Rpb24tbWFuYWdlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBSUE7SUFDSSwwQkFBb0IsR0FBd0I7UUFBeEIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7SUFFNUMsQ0FBQzs7OztJQUVELGtDQUFPOzs7SUFBUDtJQUNBLENBQUM7Ozs7SUFFRCx5Q0FBYzs7O0lBQWQ7O1lBQ1EsUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVztRQUNuQyxJQUNJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUztZQUNsQixJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxhQUFhO1lBQ2hDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJO1lBQ3JDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUNuRDs7Z0JBQ1EsV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVztZQUNyRSxRQUFRLEdBQUcsV0FBVyxDQUFDO1lBRXZCLElBQUksV0FBVyxDQUFDLFNBQVMsRUFBRTtnQkFDdkIsUUFBUSxHQUFHLFdBQVcsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQzthQUMvQztTQUNKO1FBQ0QsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQzs7OztJQUVELDJDQUFnQjs7O0lBQWhCOztZQUNVLFFBQVEsR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFO1FBQ3RDLElBQUksUUFBUSxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFOztnQkFDMUIsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTzs7Z0JBQzVCLFdBQVcs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QyxDQUFDO2FBQy9DO2lCQUFNO2dCQUNILE1BQU0sR0FBRyxFQUFFLENBQUM7YUFDZjtTQUNKO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUNMLHVCQUFDO0FBQUQsQ0FBQyxBQXRMRCxJQXNMQzs7Ozs7OztJQXJMZSwrQkFBZ0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUcmVlVGFibGVDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLXRyZWV0YWJsZSc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICcuLi9sb29rdXAtZ3JpZC5jb21wb25lbnQnO1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25NYW5hZ2VyIHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaW5zOiBMb29rdXBHcmlkQ29tcG9uZW50KSB7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGRlc3Ryb3koKSB7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0QmluZGluZ0RhdGEoKSB7XHJcbiAgICAgICAgbGV0IGpzb25EYXRhID0gdGhpcy5pbnMuYmluZGluZ0RhdGE7XHJcbiAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICB0aGlzLmlucy5uZ0NvbnRyb2wgJiZcclxuICAgICAgICAgICAgdGhpcy5pbnMubmdDb250cm9sLmZvcm1EaXJlY3RpdmUgJiZcclxuICAgICAgICAgICAgdGhpcy5pbnMubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybSAmJlxyXG4gICAgICAgICAgICB0aGlzLmlucy5uZ0NvbnRyb2wuZm9ybURpcmVjdGl2ZS5mb3JtLmJpbmRpbmdEYXRhXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGJpbmRpbmdEYXRhID0gdGhpcy5pbnMubmdDb250cm9sLmZvcm1EaXJlY3RpdmUuZm9ybS5iaW5kaW5nRGF0YTtcclxuICAgICAgICAgICAganNvbkRhdGEgPSBiaW5kaW5nRGF0YTtcclxuXHJcbiAgICAgICAgICAgIGlmIChiaW5kaW5nRGF0YS5nZXRPYmplY3QpIHtcclxuICAgICAgICAgICAgICAgIGpzb25EYXRhID0gYmluZGluZ0RhdGEuZ2V0T2JqZWN0KCkudG9KU09OKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGpzb25EYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIGluaXREaXNwbGF5VmFsdWUoKSB7XHJcbiAgICAgICAgY29uc3QganNvbkRhdGEgPSB0aGlzLmdldEJpbmRpbmdEYXRhKCk7XHJcbiAgICAgICAgaWYgKGpzb25EYXRhICYmIHRoaXMuaW5zLm1hcEZpZWxkcykge1xyXG4gICAgICAgICAgICBjb25zdCBpZEZpZWxkID0gdGhpcy5pbnMuaWRGaWVsZDtcclxuICAgICAgICAgICAgbGV0IHRhcmdldEZpZWxkID0gdGhpcy5pbnMubWFwRmllbGRzW2lkRmllbGRdO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRhcmdldEZpZWxkKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0RmllbGQuaW5kZXhPZignLCcpID4gLTEgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0RmllbGQgPSB0YXJnZXRGaWVsZC5zcGxpdCgnLCcpWzBdO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuaW5zLnV0aWxzLmdldFZhbHVlKHRhcmdldEZpZWxkLCBqc29uRGF0YSk7XHJcbiAgICAgICAgICAgICAgICBpZiAodmFsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnMuZGlzcGxheVZhbHVlID0gdmFsO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2NsZWFyU2VsZWN0aW9ucygpIHtcclxuICAgICAgICBjb25zdCB7IGNtcFJlZkluc3RhbmNlOiB0IH0gPSB0aGlzLmdldERhdGFDbXBJbnN0YW5jZSgpO1xyXG4gICAgICAgIGlmICh0KSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICAgICAgLy8g5qCR6KGoXHJcbiAgICAgICAgICAgICAgICB0LmNsZWFyQWxsKGZhbHNlKTtcclxuICAgICAgICAgICAgICAgIGlmICghdC5jZFJlZi5kZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmNkUmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vIOWIl+ihqFxyXG4gICAgICAgICAgICAgICAgdC5kdEJvZHkuc2VsZWN0ZWRSb3dJbmRleCA9IC0xO1xyXG4gICAgICAgICAgICAgICAgdC5kdEJvZHkuc2VsZWN0aW9ucyA9IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIGlmICghdC5jZC5kZXN0cm95ZWQpIHtcclxuICAgICAgICAgICAgICAgICAgICB0LmNkLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIOW4ruWKqeeql+WPo+aJk+W8gOWQju+8jOagueaNriBkaXNwbGF5VmFsdWUg6YCJ5Lit5pWw5o2uXHJcbiAgICAgKi9cclxuICAgIHNlbGVjdEN1cnJlbnRWYWx1ZShzZWxlY3RlZElkcyA9IFtdKSB7XHJcblxyXG4gICAgICAgIGlmICghdGhpcy5pbnMuZW5hYmxlVG9TZWxlY3QpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIGNvbnN0IHsgY21wUmVmSW5zdGFuY2U6IHQsIGl0ZW1zIH0gPSB0aGlzLmdldERhdGFDbXBJbnN0YW5jZSgpO1xyXG4gICAgICAgIGlmICghdCB8fCAhaXRlbXMgfHwgIWl0ZW1zLmxlbmd0aCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLl9jbGVhclNlbGVjdGlvbnMoKTtcclxuXHJcbiAgICAgICAgaWYgKCFzZWxlY3RlZElkcyB8fCAhc2VsZWN0ZWRJZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkUm93cyA9IHRoaXMuaW5zLmxvb2t1cFNlbGVjdGlvblNlci5nZXRTZWxlY3Rpb25zKCk7XHJcbiAgICAgICAgICAgIGlmIChzZWxlY3RlZFJvd3MubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZElkcyA9IHNlbGVjdGVkUm93cy5tYXAobiA9PiBuW3RoaXMuaW5zLmlkRmllbGRdKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gY29uc3QgX2lkcyA9IHRoaXMuZ2V0U2VsZWN0ZWRJZHMoKTtcclxuICAgICAgICAvLyBzZWxlY3RlZElkcyA9IHNlbGVjdGVkSWRzLmNvbmNhdChfaWRzKTtcclxuICAgICAgICAvLyBzZWxlY3RlZElkcyA9IEFycmF5LmZyb20obmV3IFNldChzZWxlY3RlZElkcykpO1xyXG5cclxuICAgICAgICBpZiAoc2VsZWN0ZWRJZHMgJiYgc2VsZWN0ZWRJZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICAgICAgLy8g5qCR6KGoXHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkNFRyZWV0YWJsZSh0LCBzZWxlY3RlZElkcyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXQuY2RSZWYuZGVzdHJveWVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5jZFJlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyDliJfooahcclxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWQ0RGF0YXRhYmxlKHQsIGl0ZW1zLCBzZWxlY3RlZElkcyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXQuY2QuZGVzdHJveWVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdC5jZC5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXREYXRhQ21wSW5zdGFuY2UoKSB7XHJcbiAgICAgICAgbGV0IHJlZiA9IG51bGw7XHJcbiAgICAgICAgbGV0IGl0ZW1zID0gbnVsbDtcclxuICAgICAgICBpZiAodGhpcy5pbnMuYWN0aXZlVGFiID09PSAnZGF0YWxpc3QnKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlucy5pc1RyZWUoKSkge1xyXG4gICAgICAgICAgICAgICAgcmVmID0gdGhpcy5pbnMubG9va3VwQ21wTWdyLmdldENvbXBvbmVudEluc3RhbmNlKCd0cmVldGFibGUnKTtcclxuICAgICAgICAgICAgICAgIGl0ZW1zID0gKHJlZiBhcyBUcmVlVGFibGVDb21wb25lbnQpLnNlcmlhbGl6ZWRWYWx1ZTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGl0ZW1zID0gdGhpcy5pbnMuaXRlbXM7XHJcbiAgICAgICAgICAgICAgICByZWYgPSB0aGlzLmlucy5sb29rdXBDbXBNZ3IuZ2V0Q29tcG9uZW50SW5zdGFuY2UoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy5pbnMuYWN0aXZlVGFiID09PSAnZmF2b3JpdGUnKSB7XHJcbiAgICAgICAgICAgIHJlZiA9IHRoaXMuaW5zLmxvb2t1cENtcE1nci5nZXRDb21wb25lbnRJbnN0YW5jZSgnZmF2Jyk7XHJcbiAgICAgICAgICAgIGl0ZW1zID0gdGhpcy5pbnMuZmF2b3JpdGVJdGVtcztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHsgY21wUmVmSW5zdGFuY2U6IHJlZiwgaXRlbXMgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNlbGVjdGVkNERhdGF0YWJsZSh0OiBhbnksIGl0ZW1zOiBhbnksIHZhbHVlczogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICBpdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW1bdGhpcy5pbnMuaWRGaWVsZF0gPT09IHZhbHVlc1swXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghdC5kdEJvZHkuaXNTZWxlY3RlZChpdGVtKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0LmR0Qm9keS5zZWxlY3RlZFJvd0luZGV4ID0gLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHQuZHRCb2R5LnNlbGVjdGVkUm93KCcnLCBpbmRleCwgaXRlbSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAvLyBjb25zdCB2YWx1ZXMgPSB0aGlzLmdldFNlbGVjdGVkSWRzKCk7XHJcbiAgICAgICAgICAgIHZhbHVlcy5mb3JFYWNoKGlkID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBpdGVtcy5maW5kKG4gPT4gblt0aGlzLmlucy5pZEZpZWxkXSA9PSBpZCk7XHJcbiAgICAgICAgICAgICAgICBpZiAocikge1xyXG4gICAgICAgICAgICAgICAgICAgIHQuY2hlY2tSb3coaWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBzZWxlY3RlZDRUcmVldGFibGUodDogYW55LCB2YWx1ZUFycjogYW55KSB7XHJcbiAgICAgICAgaWYgKHRoaXMuaW5zLnNpbmdsZVNlbGVjdCkge1xyXG4gICAgICAgICAgICB0LnNlbGVjdE5vZGUodmFsdWVBcnJbMF0sIGZhbHNlLCBmYWxzZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gY29uc3QgdmFsdWVBcnIgPSB0aGlzLmdldFNlbGVjdGVkSWRzKCk7XHJcbiAgICAgICAgICAgIHQuY2hlY2tlZE5vZGVzKHZhbHVlQXJyLCBmYWxzZSwgZmFsc2UsIHRydWUpO1xyXG4gICAgICAgICAgICB0LnNlbGVjdE5vZGVzKHZhbHVlQXJyKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2VsZWN0ZWRJZHMoKSB7XHJcbiAgICAgICAgbGV0IHZhbHVlcyA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHMgPSB0aGlzLmlucy5tdWx0aXBsZUNob2ljZVNlcGFyYXRvcjsgLy8g5aSa6YCJ5YiG6ZqU56ymXHJcbiAgICAgICAgaWYgKCF0aGlzLmlucy5zaW5nbGVTZWxlY3QgJiYgdGhpcy5pbnMuZGlzcGxheVZhbHVlICYmICgnJyArIHRoaXMuaW5zLmRpc3BsYXlWYWx1ZSkuaW5kZXhPZihzKSA+IC0xKSB7XHJcbiAgICAgICAgICAgIHZhbHVlcyA9IHRoaXMuaW5zLmRpc3BsYXlWYWx1ZS5zcGxpdChzKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5pbnMuZGlzcGxheVZhbHVlICE9PSBudWxsICYmIHRoaXMuaW5zLmRpc3BsYXlWYWx1ZSAhPT0gJycgJiYgdGhpcy5pbnMuZGlzcGxheVZhbHVlICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlcyA9IFt0aGlzLmlucy5kaXNwbGF5VmFsdWVdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyDlkK/nlKjmmL7npLrlpJrpgInliJfooahcclxuICAgICAgICBpZiAodGhpcy5pbnMuc2hvd1NlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJvd3MgPSB0aGlzLmlucy5sb29rdXBTZWxlY3Rpb25TZXIuZ2V0U2VsZWN0aW9ucygpO1xyXG4gICAgICAgICAgICBpZiAocm93cyAmJiByb3dzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgdmFsdWVzID0gcm93cy5tYXAobiA9PiBuW3RoaXMuaW5zLmlkRmllbGRdKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlcyA9IFtdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdmFsdWVzO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuXHJcbiJdfQ==