import { Injectable } from '@angular/core';
import { of } from 'rxjs';
import { tap, switchMap, map } from 'rxjs/operators';
import { FrameContext, BindingPathConverter } from '@farris/devkit';
import { BefDataPathUtil } from '@farris/bef';
import { FormLoadingService } from '../form-loading/form-loading.service';
import { AttachmentUtil } from './attachment.util';
/**
 * 附件调用
 */
var AttachmentDataService = /** @class */ (function () {
    function AttachmentDataService(frameContext, loadingService) {
        this.frameContext = frameContext;
        this.loadingService = loadingService;
    }
    Object.defineProperty(AttachmentDataService.prototype, "repository", {
        /**
         * 实体仓库
         */
        get: function () {
            return this.frameContext.repository;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(AttachmentDataService.prototype, "bindingData", {
        /**
         * 绑定数据
         */
        get: function () {
            return this.frameContext.bindingData;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * 更新附件信息
     */
    AttachmentDataService.prototype.updateRow = function (attachmentInfoFieldPath, attachmentInfo) {
        var _this = this;
        var restService = this.repository.restService;
        var baseUri = restService.baseUri;
        var updateUri = baseUri + "/service/updateattachment";
        var serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        var body = {
            updateAttachInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        this.loadingService.show();
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap(function (responseInfo) {
            return _this.syncAttachmentInfosToClient();
        }), tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 通过属性名更新附件信息
     * @param attachmentInfoFieldPath 附件字段
     * @param attachmentInfo 附件信息
     */
    AttachmentDataService.prototype.updateRowWithPropertyName = function (attachmentInfoFieldPath, attachmentInfo) {
        var _this = this;
        var restService = this.repository.restService;
        var baseUri = restService.baseUri;
        var updateUri = baseUri + "/service/updateattachmentwithproptyname";
        var serverAttachInfo = this.createUpdateAttachInfo(attachmentInfoFieldPath, attachmentInfo);
        var propertyName = attachmentInfoFieldPath.split('/').filter(function (p) { return p; }).pop();
        var body = {
            updateAttachInfo: serverAttachInfo,
            propertyName: propertyName,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        this.loadingService.show();
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap(function (responseInfo) {
            return _this.syncAttachmentInfosToClient();
        }), tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 批量创建附件行数据
     */
    AttachmentDataService.prototype.updateRows = function (attachmentInfoFieldPath, attachmentInfos) {
        var _this = this;
        var restService = this.repository.restService;
        var baseUri = restService.baseUri;
        var updateUri = baseUri + "/service/batchuploadattachment";
        var serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        var isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        var body = {
            batchUploadInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap(function (responseInfo) {
            return _this.appendAttachmentInfosToClient(responseInfo.returnValue, isRootEntity);
        }), tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 批量创建附件行数据
     */
    AttachmentDataService.prototype.updateRowsWithConfigs = function (attachmentInfoFieldPath, attachmentInfos, configs) {
        var _this = this;
        var restService = this.repository.restService;
        var baseUri = restService.baseUri;
        var updateUri = baseUri + "/service/batchuploadattachment";
        var serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        // const isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        var body = {
            batchUploadInfo: serverAttachInfo,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap(function (responseInfo) {
            return _this.appendAttachmentInfos(responseInfo.returnValue, configs);
        }), tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 根据属性名批量创建附件行数据
     */
    AttachmentDataService.prototype.updateRowsWithPropertyName = function (attachmentInfoFieldPath, attachmentInfos) {
        var _this = this;
        var restService = this.repository.restService;
        var baseUri = restService.baseUri;
        var updateUri = baseUri + "/service/batchuploadattachmentwithproptyname";
        var serverAttachInfo = this.createBatchCreateAttachInfo(attachmentInfoFieldPath, attachmentInfos);
        var isRootEntity = serverAttachInfo.NodeCodes.length === 0;
        var propertyName = attachmentInfoFieldPath.split('/').filter(function (p) { return p; }).pop();
        var body = {
            batchUploadInfo: serverAttachInfo,
            propertyName: propertyName,
            requestInfo: restService.buildRequestInfo()
        };
        var options = {
            body: body
        };
        return restService.invoke(updateUri, 'PUT', null, options).pipe(switchMap(function (responseInfo) {
            return _this.appendAttachmentInfosToClient(responseInfo.returnValue, isRootEntity);
        }), tap(function () {
            _this.loadingService.hide();
        }));
    };
    /**
     * 创建服务器端需要的更新信息
     */
    AttachmentDataService.prototype.createUpdateAttachInfo = function (attachmentInfoFieldPath, attachmentInfo) {
        var attachmentId = attachmentInfo.attachmentId;
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        var nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        var hiretryIds = BefDataPathUtil.convertToDataIdsForUpdate(parentBindingPathArray, this.bindingData);
        var serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: [attachmentId],
            AttachmentId: attachmentId
        };
        return serverAttachInfo;
    };
    /**
     * 创建服务器端需要的批量新增附件信息
     */
    AttachmentDataService.prototype.createBatchCreateAttachInfo = function (attachmentInfoFieldPath, attachmentInfo) {
        var attachmentIds = AttachmentUtil.peekAttachmentIds(attachmentInfo);
        var parentBindingPathArray = BindingPathConverter.toBindingPathArray(attachmentInfoFieldPath);
        parentBindingPathArray.pop();
        var nodeCodes = BefDataPathUtil.convertToObjectCodes(parentBindingPathArray, this.bindingData);
        var hiretryIds = BefDataPathUtil.convertToDataIdsForAdd(parentBindingPathArray, this.bindingData);
        var serverAttachInfo = {
            NodeCodes: nodeCodes,
            HiretryIds: hiretryIds,
            AttachmentIds: attachmentIds,
            AttachmentId: null
        };
        return serverAttachInfo;
    };
    /**
     * 同步服务器端最新信息到客户端
     * @todo:
     * 1、主对象批量新增时不支持
     */
    AttachmentDataService.prototype.syncAttachmentInfosToClient = function () {
        var rootDataId = this.bindingData.list.currentId;
        return this.repository.updateEntityById(rootDataId);
    };
    /**
     * 追加主表数据到客户端
     */
    AttachmentDataService.prototype.appendAttachmentInfosToClient = function (listData, isRootEntity) {
        if (isRootEntity === true) {
            var entities = this.repository.buildEntities(listData);
            this.repository.entityCollection.addEntities(entities);
            return of(listData);
        }
        else {
            var rootDataId = this.bindingData.list.currentId;
            return this.repository.updateEntityById(rootDataId).pipe(map(function () { return listData; }));
        }
    };
    AttachmentDataService.prototype.appendAttachmentInfos = function (listData, keyValues) {
        var entities = this.repository.buildEntities(listData);
        this.repository.entityCollection.addEntities(entities);
        // 更新实体使之产生变更集
        this.updateEntities(entities, keyValues);
        return of(listData);
    };
    AttachmentDataService.prototype.updateEntities = function (entities, keyValues) {
        var _this = this;
        entities.forEach(function (entity) {
            _this.updateEntity(entity, keyValues);
        });
    };
    AttachmentDataService.prototype.updateEntity = function (target, keyValues) {
        var _this = this;
        Object.keys(keyValues).forEach(function (key) {
            _this.setValueByPath(target, key, keyValues[key]);
        });
    };
    AttachmentDataService.prototype.setValueByPath = function (target, path, value) {
        if (target) {
            var paths = path.split('.');
            if (paths.length <= 1) {
                target[path] = value;
            }
            else {
                paths.slice(0, -1).reduce(function (prev, path) {
                    if (!(prev.hasOwnProperty(path) || prev['__proto__'].hasOwnProperty(path))) {
                        prev[path] = {};
                    }
                    return prev[path];
                }, target)[paths[paths.length - 1]] = value;
            }
        }
    };
    AttachmentDataService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    AttachmentDataService.ctorParameters = function () { return [
        { type: FrameContext },
        { type: FormLoadingService }
    ]; };
    return AttachmentDataService;
}());
export { AttachmentDataService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXR0YWNobWVudC1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2NvbW1hbmQtc2VydmljZXMvIiwic291cmNlcyI6WyJsaWIvYXR0YWNobWVudC9hdHRhY2htZW50LWRhdGEuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckQsT0FBTyxFQUFFLFlBQVksRUFBdUIsb0JBQW9CLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RixPQUFPLEVBQWlCLGVBQWUsRUFBZ0IsTUFBTSxhQUFhLENBQUM7QUFDM0UsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFMUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRW5EOztHQUVHO0FBQ0g7SUFpQkUsK0JBQW9CLFlBQTBCLEVBQVUsY0FBa0M7UUFBdEUsaUJBQVksR0FBWixZQUFZLENBQWM7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBb0I7SUFDMUYsQ0FBQztJQVpELHNCQUFZLDZDQUFVO1FBSHRCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBbUMsQ0FBQztRQUMvRCxDQUFDOzs7T0FBQTtJQUtELHNCQUFZLDhDQUFXO1FBSHZCOztXQUVHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDO1FBQ3ZDLENBQUM7OztPQUFBO0lBS0Q7O09BRUc7SUFDSSx5Q0FBUyxHQUFoQixVQUFpQix1QkFBK0IsRUFBRSxjQUE4QjtRQUFoRixpQkFxQkM7UUFwQkMsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDaEQsSUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFNLFNBQVMsR0FBTSxPQUFPLDhCQUEyQixDQUFDO1FBQ3hELElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDLHVCQUF1QixFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQzlGLElBQU0sSUFBSSxHQUFHO1lBQ1gsZ0JBQWdCLEVBQUUsZ0JBQWdCO1lBQ2xDLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLElBQU0sT0FBTyxHQUFHO1lBQ2QsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMzQixPQUFPLFdBQVcsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUM3RCxTQUFTLENBQUMsVUFBQyxZQUEwQjtZQUNuQyxPQUFPLEtBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDO1FBQzVDLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQztZQUNGLEtBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFDRDs7OztPQUlHO0lBQ0kseURBQXlCLEdBQWhDLFVBQWlDLHVCQUErQixFQUFFLGNBQThCO1FBQWhHLGlCQXVCQztRQXRCQyxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUNoRCxJQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFDO1FBQ3BDLElBQU0sU0FBUyxHQUFNLE9BQU8sNENBQXlDLENBQUM7UUFDdEUsSUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUMsdUJBQXVCLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFDOUYsSUFBTSxZQUFZLEdBQUcsdUJBQXVCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsRUFBRCxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUM3RSxJQUFNLElBQUksR0FBRztZQUNYLGdCQUFnQixFQUFFLGdCQUFnQjtZQUNsQyxZQUFZLGNBQUE7WUFDWixXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1NBQzVDLENBQUM7UUFDRixJQUFNLE9BQU8sR0FBRztZQUNkLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQztRQUNGLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDM0IsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDN0QsU0FBUyxDQUFDLFVBQUMsWUFBMEI7WUFDbkMsT0FBTyxLQUFJLENBQUMsMkJBQTJCLEVBQUUsQ0FBQztRQUM1QyxDQUFDLENBQUMsRUFDRixHQUFHLENBQUM7WUFDRixLQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBQ0Q7O09BRUc7SUFDSSwwQ0FBVSxHQUFqQixVQUFrQix1QkFBK0IsRUFBRSxlQUFpQztRQUFwRixpQkFzQkM7UUFyQkMsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUM7UUFDaEQsSUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUNwQyxJQUFNLFNBQVMsR0FBTSxPQUFPLG1DQUFnQyxDQUFDO1FBQzdELElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLDJCQUEyQixDQUFDLHVCQUF1QixFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ3BHLElBQU0sWUFBWSxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDO1FBRTdELElBQU0sSUFBSSxHQUFHO1lBQ1gsZUFBZSxFQUFFLGdCQUFnQjtZQUNqQyxXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1NBQzVDLENBQUM7UUFDRixJQUFNLE9BQU8sR0FBRztZQUNkLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQztRQUNGLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQzdELFNBQVMsQ0FBQyxVQUFDLFlBQTBCO1lBQ25DLE9BQU8sS0FBSSxDQUFDLDZCQUE2QixDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDcEYsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDO1lBQ0YsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUNEOztPQUVHO0lBQ0kscURBQXFCLEdBQTVCLFVBQTZCLHVCQUErQixFQUFFLGVBQWlDLEVBQUUsT0FBZ0M7UUFBakksaUJBc0JDO1FBckJDLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDO1FBQ2hELElBQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsSUFBTSxTQUFTLEdBQU0sT0FBTyxtQ0FBZ0MsQ0FBQztRQUM3RCxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQywyQkFBMkIsQ0FBQyx1QkFBdUIsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNwRyxnRUFBZ0U7UUFFaEUsSUFBTSxJQUFJLEdBQUc7WUFDWCxlQUFlLEVBQUUsZ0JBQWdCO1lBQ2pDLFdBQVcsRUFBRSxXQUFXLENBQUMsZ0JBQWdCLEVBQUU7U0FDNUMsQ0FBQztRQUNGLElBQU0sT0FBTyxHQUFHO1lBQ2QsSUFBSSxFQUFFLElBQUk7U0FDWCxDQUFDO1FBQ0YsT0FBTyxXQUFXLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDN0QsU0FBUyxDQUFDLFVBQUMsWUFBMEI7WUFDbkMsT0FBTyxLQUFJLENBQUMscUJBQXFCLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN2RSxDQUFDLENBQUMsRUFDRixHQUFHLENBQUM7WUFDRixLQUFJLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBQ0Q7O09BRUc7SUFDSSwwREFBMEIsR0FBakMsVUFBa0MsdUJBQStCLEVBQUUsZUFBaUM7UUFBcEcsaUJBd0JDO1FBdkJDLElBQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDO1FBQ2hELElBQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7UUFDcEMsSUFBTSxTQUFTLEdBQU0sT0FBTyxpREFBOEMsQ0FBQztRQUMzRSxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQywyQkFBMkIsQ0FBQyx1QkFBdUIsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUNwRyxJQUFNLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQztRQUM3RCxJQUFNLFlBQVksR0FBRyx1QkFBdUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxFQUFELENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRTdFLElBQU0sSUFBSSxHQUFHO1lBQ1gsZUFBZSxFQUFFLGdCQUFnQjtZQUNqQyxZQUFZLGNBQUE7WUFDWixXQUFXLEVBQUUsV0FBVyxDQUFDLGdCQUFnQixFQUFFO1NBQzVDLENBQUM7UUFDRixJQUFNLE9BQU8sR0FBRztZQUNkLElBQUksRUFBRSxJQUFJO1NBQ1gsQ0FBQztRQUNGLE9BQU8sV0FBVyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQzdELFNBQVMsQ0FBQyxVQUFDLFlBQTBCO1lBQ25DLE9BQU8sS0FBSSxDQUFDLDZCQUE2QixDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDcEYsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDO1lBQ0YsS0FBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVEOztPQUVHO0lBQ0ssc0RBQXNCLEdBQTlCLFVBQStCLHVCQUErQixFQUFFLGNBQThCO1FBRTVGLElBQU0sWUFBWSxHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQUM7UUFDakQsSUFBTSxzQkFBc0IsR0FBRyxvQkFBb0IsQ0FBQyxrQkFBa0IsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQ2hHLHNCQUFzQixDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQzdCLElBQU0sU0FBUyxHQUFHLGVBQWUsQ0FBQyxvQkFBb0IsQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDakcsSUFBTSxVQUFVLEdBQUcsZUFBZSxDQUFDLHlCQUF5QixDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUV2RyxJQUFNLGdCQUFnQixHQUF5QjtZQUM3QyxTQUFTLEVBQUUsU0FBUztZQUNwQixVQUFVLEVBQUUsVUFBVTtZQUN0QixhQUFhLEVBQUUsQ0FBQyxZQUFZLENBQUM7WUFDN0IsWUFBWSxFQUFFLFlBQVk7U0FDM0IsQ0FBQztRQUVGLE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssMkRBQTJCLEdBQW5DLFVBQW9DLHVCQUErQixFQUFFLGNBQWdDO1FBQ25HLElBQU0sYUFBYSxHQUFHLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUV2RSxJQUFNLHNCQUFzQixHQUFHLG9CQUFvQixDQUFDLGtCQUFrQixDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFDaEcsc0JBQXNCLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDN0IsSUFBTSxTQUFTLEdBQUcsZUFBZSxDQUFDLG9CQUFvQixDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqRyxJQUFNLFVBQVUsR0FBRyxlQUFlLENBQUMsc0JBQXNCLENBQUMsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRXBHLElBQU0sZ0JBQWdCLEdBQUc7WUFDdkIsU0FBUyxFQUFFLFNBQVM7WUFDcEIsVUFBVSxFQUFFLFVBQVU7WUFDdEIsYUFBYSxFQUFFLGFBQWE7WUFDNUIsWUFBWSxFQUFFLElBQUk7U0FDbkIsQ0FBQztRQUVGLE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSwyREFBMkIsR0FBbEM7UUFDRSxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7UUFDbkQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRDs7T0FFRztJQUNJLDZEQUE2QixHQUFwQyxVQUFxQyxRQUFlLEVBQUUsWUFBcUI7UUFDekUsSUFBSSxZQUFZLEtBQUssSUFBSSxFQUFFO1lBQ3pCLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3pELElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3ZELE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3JCO2FBQU07WUFDTCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDbkQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FDdEQsR0FBRyxDQUFDLGNBQU0sT0FBQSxRQUFRLEVBQVIsQ0FBUSxDQUFDLENBQ3BCLENBQUM7U0FDSDtJQUNILENBQUM7SUFDTSxxREFBcUIsR0FBNUIsVUFBNkIsUUFBZSxFQUFFLFNBQWtDO1FBQzlFLElBQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZELGNBQWM7UUFDZCxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUN6QyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN0QixDQUFDO0lBQ08sOENBQWMsR0FBdEIsVUFBdUIsUUFBa0IsRUFBRSxTQUFrQztRQUE3RSxpQkFJQztRQUhDLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUFjO1lBQzlCLEtBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUNPLDRDQUFZLEdBQXBCLFVBQXFCLE1BQWMsRUFBRSxTQUFrQztRQUF2RSxpQkFJQztRQUhDLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBVztZQUN6QyxLQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDbkQsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBQ08sOENBQWMsR0FBdEIsVUFBdUIsTUFBYyxFQUFFLElBQVksRUFBRSxLQUFVO1FBQzdELElBQUksTUFBTSxFQUFFO1lBQ1YsSUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUM5QixJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO2dCQUNyQixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQ3RCO2lCQUFNO2dCQUNMLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUMsSUFBSSxFQUFFLElBQUk7b0JBQ25DLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFO3dCQUMxRSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO3FCQUNqQjtvQkFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDcEIsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO2FBQzdDO1NBQ0Y7SUFDSCxDQUFDOztnQkE3UEYsVUFBVTs7OztnQkFURixZQUFZO2dCQUVaLGtCQUFrQjs7SUFxUTNCLDRCQUFDO0NBQUEsQUE5UEQsSUE4UEM7QUFHRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAsIHN3aXRjaE1hcCwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRnJhbWVDb250ZXh0LCBFbnRpdHksIEJpbmRpbmdEYXRhLCBCaW5kaW5nUGF0aENvbnZlcnRlciB9IGZyb20gJ0BmYXJyaXMvZGV2a2l0JztcbmltcG9ydCB7IEJlZlJlcG9zaXRvcnksIEJlZkRhdGFQYXRoVXRpbCwgUmVzcG9uc2VJbmZvIH0gZnJvbSAnQGZhcnJpcy9iZWYnO1xuaW1wb3J0IHsgRm9ybUxvYWRpbmdTZXJ2aWNlIH0gZnJvbSAnLi4vZm9ybS1sb2FkaW5nL2Zvcm0tbG9hZGluZy5zZXJ2aWNlJztcbmltcG9ydCB7IEF0dGFjaG1lbnRJbmZvLCBTZXJ2ZXJBdHRhY2htZW50SW5mbyB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgQXR0YWNobWVudFV0aWwgfSBmcm9tICcuL2F0dGFjaG1lbnQudXRpbCc7XG5cbi8qKlxuICog6ZmE5Lu26LCD55SoXG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIEF0dGFjaG1lbnREYXRhU2VydmljZSB7XG5cbiAgLyoqXG4gICAqIOWunuS9k+S7k+W6k1xuICAgKi9cbiAgcHJpdmF0ZSBnZXQgcmVwb3NpdG9yeSgpOiBCZWZSZXBvc2l0b3J5PEVudGl0eT4ge1xuICAgIHJldHVybiB0aGlzLmZyYW1lQ29udGV4dC5yZXBvc2l0b3J5IGFzIEJlZlJlcG9zaXRvcnk8RW50aXR5PjtcbiAgfVxuXG4gIC8qKlxuICAgKiDnu5HlrprmlbDmja5cbiAgICovXG4gIHByaXZhdGUgZ2V0IGJpbmRpbmdEYXRhKCk6IEJpbmRpbmdEYXRhIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZUNvbnRleHQuYmluZGluZ0RhdGE7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0LCBwcml2YXRlIGxvYWRpbmdTZXJ2aWNlOiBGb3JtTG9hZGluZ1NlcnZpY2UpIHtcbiAgfVxuXG4gIC8qKlxuICAgKiDmm7TmlrDpmYTku7bkv6Hmga9cbiAgICovXG4gIHB1YmxpYyB1cGRhdGVSb3coYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3VwZGF0ZWF0dGFjaG1lbnRgO1xuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZVVwZGF0ZUF0dGFjaEluZm8oYXR0YWNobWVudEluZm9GaWVsZFBhdGgsIGF0dGFjaG1lbnRJbmZvKTtcbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgdXBkYXRlQXR0YWNoSW5mbzogc2VydmVyQXR0YWNoSW5mbyxcbiAgICAgIHJlcXVlc3RJbmZvOiByZXN0U2VydmljZS5idWlsZFJlcXVlc3RJbmZvKClcbiAgICB9O1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgICBib2R5OiBib2R5XG4gICAgfTtcbiAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLnNob3coKTtcbiAgICByZXR1cm4gcmVzdFNlcnZpY2UuaW52b2tlKHVwZGF0ZVVyaSwgJ1BVVCcsIG51bGwsIG9wdGlvbnMpLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoKHJlc3BvbnNlSW5mbzogUmVzcG9uc2VJbmZvKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnN5bmNBdHRhY2htZW50SW5mb3NUb0NsaWVudCgpO1xuICAgICAgfSksXG4gICAgICB0YXAoKCkgPT4ge1xuICAgICAgICB0aGlzLmxvYWRpbmdTZXJ2aWNlLmhpZGUoKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuICAvKipcbiAgICog6YCa6L+H5bGe5oCn5ZCN5pu05paw6ZmE5Lu25L+h5oGvXG4gICAqIEBwYXJhbSBhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCDpmYTku7blrZfmrrVcbiAgICogQHBhcmFtIGF0dGFjaG1lbnRJbmZvIOmZhOS7tuS/oeaBr1xuICAgKi9cbiAgcHVibGljIHVwZGF0ZVJvd1dpdGhQcm9wZXJ0eU5hbWUoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm86IEF0dGFjaG1lbnRJbmZvKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL3VwZGF0ZWF0dGFjaG1lbnR3aXRocHJvcHR5bmFtZWA7XG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHRoaXMuY3JlYXRlVXBkYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm8pO1xuICAgIGNvbnN0IHByb3BlcnR5TmFtZSA9IGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLnNwbGl0KCcvJykuZmlsdGVyKHAgPT4gcCkucG9wKCk7XG4gICAgY29uc3QgYm9keSA9IHtcbiAgICAgIHVwZGF0ZUF0dGFjaEluZm86IHNlcnZlckF0dGFjaEluZm8sXG4gICAgICBwcm9wZXJ0eU5hbWUsXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgdGhpcy5sb2FkaW5nU2VydmljZS5zaG93KCk7XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cGRhdGVVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zeW5jQXR0YWNobWVudEluZm9zVG9DbGllbnQoKTtcbiAgICAgIH0pLFxuICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgdGhpcy5sb2FkaW5nU2VydmljZS5oaWRlKCk7XG4gICAgICB9KVxuICAgICk7XG4gIH1cbiAgLyoqXG4gICAqIOaJuemHj+WIm+W7uumZhOS7tuihjOaVsOaNrlxuICAgKi9cbiAgcHVibGljIHVwZGF0ZVJvd3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCByZXN0U2VydmljZSA9IHRoaXMucmVwb3NpdG9yeS5yZXN0U2VydmljZTtcbiAgICBjb25zdCBiYXNlVXJpID0gcmVzdFNlcnZpY2UuYmFzZVVyaTtcbiAgICBjb25zdCB1cGRhdGVVcmkgPSBgJHtiYXNlVXJpfS9zZXJ2aWNlL2JhdGNodXBsb2FkYXR0YWNobWVudGA7XG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHRoaXMuY3JlYXRlQmF0Y2hDcmVhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoLCBhdHRhY2htZW50SW5mb3MpO1xuICAgIGNvbnN0IGlzUm9vdEVudGl0eSA9IHNlcnZlckF0dGFjaEluZm8uTm9kZUNvZGVzLmxlbmd0aCA9PT0gMDtcblxuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBiYXRjaFVwbG9hZEluZm86IHNlcnZlckF0dGFjaEluZm8sXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cGRhdGVVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcHBlbmRBdHRhY2htZW50SW5mb3NUb0NsaWVudChyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUsIGlzUm9vdEVudGl0eSk7XG4gICAgICB9KSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmibnph4/liJvlu7rpmYTku7booYzmlbDmja5cbiAgICovXG4gIHB1YmxpYyB1cGRhdGVSb3dzV2l0aENvbmZpZ3MoYXR0YWNobWVudEluZm9GaWVsZFBhdGg6IHN0cmluZywgYXR0YWNobWVudEluZm9zOiBBdHRhY2htZW50SW5mb1tdLCBjb25maWdzOiB7IFtwcm9wOiBzdHJpbmddOiBhbnkgfSk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgY29uc3QgcmVzdFNlcnZpY2UgPSB0aGlzLnJlcG9zaXRvcnkucmVzdFNlcnZpY2U7XG4gICAgY29uc3QgYmFzZVVyaSA9IHJlc3RTZXJ2aWNlLmJhc2VVcmk7XG4gICAgY29uc3QgdXBkYXRlVXJpID0gYCR7YmFzZVVyaX0vc2VydmljZS9iYXRjaHVwbG9hZGF0dGFjaG1lbnRgO1xuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZUJhdGNoQ3JlYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcbiAgICAvLyBjb25zdCBpc1Jvb3RFbnRpdHkgPSBzZXJ2ZXJBdHRhY2hJbmZvLk5vZGVDb2Rlcy5sZW5ndGggPT09IDA7XG5cbiAgICBjb25zdCBib2R5ID0ge1xuICAgICAgYmF0Y2hVcGxvYWRJbmZvOiBzZXJ2ZXJBdHRhY2hJbmZvLFxuICAgICAgcmVxdWVzdEluZm86IHJlc3RTZXJ2aWNlLmJ1aWxkUmVxdWVzdEluZm8oKVxuICAgIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGJvZHk6IGJvZHlcbiAgICB9O1xuICAgIHJldHVybiByZXN0U2VydmljZS5pbnZva2UodXBkYXRlVXJpLCAnUFVUJywgbnVsbCwgb3B0aW9ucykucGlwZShcbiAgICAgIHN3aXRjaE1hcCgocmVzcG9uc2VJbmZvOiBSZXNwb25zZUluZm8pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBwZW5kQXR0YWNobWVudEluZm9zKHJlc3BvbnNlSW5mby5yZXR1cm5WYWx1ZSwgY29uZmlncyk7XG4gICAgICB9KSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG4gIC8qKlxuICAgKiDmoLnmja7lsZ7mgKflkI3mibnph4/liJvlu7rpmYTku7booYzmlbDmja5cbiAgICovXG4gIHB1YmxpYyB1cGRhdGVSb3dzV2l0aFByb3BlcnR5TmFtZShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mb3M6IEF0dGFjaG1lbnRJbmZvW10pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHJlc3RTZXJ2aWNlID0gdGhpcy5yZXBvc2l0b3J5LnJlc3RTZXJ2aWNlO1xuICAgIGNvbnN0IGJhc2VVcmkgPSByZXN0U2VydmljZS5iYXNlVXJpO1xuICAgIGNvbnN0IHVwZGF0ZVVyaSA9IGAke2Jhc2VVcml9L3NlcnZpY2UvYmF0Y2h1cGxvYWRhdHRhY2htZW50d2l0aHByb3B0eW5hbWVgO1xuICAgIGNvbnN0IHNlcnZlckF0dGFjaEluZm8gPSB0aGlzLmNyZWF0ZUJhdGNoQ3JlYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCwgYXR0YWNobWVudEluZm9zKTtcbiAgICBjb25zdCBpc1Jvb3RFbnRpdHkgPSBzZXJ2ZXJBdHRhY2hJbmZvLk5vZGVDb2Rlcy5sZW5ndGggPT09IDA7XG4gICAgY29uc3QgcHJvcGVydHlOYW1lID0gYXR0YWNobWVudEluZm9GaWVsZFBhdGguc3BsaXQoJy8nKS5maWx0ZXIocCA9PiBwKS5wb3AoKTtcblxuICAgIGNvbnN0IGJvZHkgPSB7XG4gICAgICBiYXRjaFVwbG9hZEluZm86IHNlcnZlckF0dGFjaEluZm8sXG4gICAgICBwcm9wZXJ0eU5hbWUsXG4gICAgICByZXF1ZXN0SW5mbzogcmVzdFNlcnZpY2UuYnVpbGRSZXF1ZXN0SW5mbygpXG4gICAgfTtcbiAgICBjb25zdCBvcHRpb25zID0ge1xuICAgICAgYm9keTogYm9keVxuICAgIH07XG4gICAgcmV0dXJuIHJlc3RTZXJ2aWNlLmludm9rZSh1cGRhdGVVcmksICdQVVQnLCBudWxsLCBvcHRpb25zKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChyZXNwb25zZUluZm86IFJlc3BvbnNlSW5mbykgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5hcHBlbmRBdHRhY2htZW50SW5mb3NUb0NsaWVudChyZXNwb25zZUluZm8ucmV0dXJuVmFsdWUsIGlzUm9vdEVudGl0eSk7XG4gICAgICB9KSxcbiAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgIHRoaXMubG9hZGluZ1NlcnZpY2UuaGlkZSgpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIOWIm+W7uuacjeWKoeWZqOerr+mcgOimgeeahOabtOaWsOS/oeaBr1xuICAgKi9cbiAgcHJpdmF0ZSBjcmVhdGVVcGRhdGVBdHRhY2hJbmZvKGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoOiBzdHJpbmcsIGF0dGFjaG1lbnRJbmZvOiBBdHRhY2htZW50SW5mbyk6IFNlcnZlckF0dGFjaG1lbnRJbmZvIHtcblxuICAgIGNvbnN0IGF0dGFjaG1lbnRJZCA9IGF0dGFjaG1lbnRJbmZvLmF0dGFjaG1lbnRJZDtcbiAgICBjb25zdCBwYXJlbnRCaW5kaW5nUGF0aEFycmF5ID0gQmluZGluZ1BhdGhDb252ZXJ0ZXIudG9CaW5kaW5nUGF0aEFycmF5KGF0dGFjaG1lbnRJbmZvRmllbGRQYXRoKTtcbiAgICBwYXJlbnRCaW5kaW5nUGF0aEFycmF5LnBvcCgpO1xuICAgIGNvbnN0IG5vZGVDb2RlcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9PYmplY3RDb2RlcyhwYXJlbnRCaW5kaW5nUGF0aEFycmF5LCB0aGlzLmJpbmRpbmdEYXRhKTtcbiAgICBjb25zdCBoaXJldHJ5SWRzID0gQmVmRGF0YVBhdGhVdGlsLmNvbnZlcnRUb0RhdGFJZHNGb3JVcGRhdGUocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XG5cbiAgICBjb25zdCBzZXJ2ZXJBdHRhY2hJbmZvOiBTZXJ2ZXJBdHRhY2htZW50SW5mbyA9IHtcbiAgICAgIE5vZGVDb2Rlczogbm9kZUNvZGVzLFxuICAgICAgSGlyZXRyeUlkczogaGlyZXRyeUlkcyxcbiAgICAgIEF0dGFjaG1lbnRJZHM6IFthdHRhY2htZW50SWRdLFxuICAgICAgQXR0YWNobWVudElkOiBhdHRhY2htZW50SWRcbiAgICB9O1xuXG4gICAgcmV0dXJuIHNlcnZlckF0dGFjaEluZm87XG4gIH1cblxuICAvKipcbiAgICog5Yib5bu65pyN5Yqh5Zmo56uv6ZyA6KaB55qE5om56YeP5paw5aKe6ZmE5Lu25L+h5oGvXG4gICAqL1xuICBwcml2YXRlIGNyZWF0ZUJhdGNoQ3JlYXRlQXR0YWNoSW5mbyhhdHRhY2htZW50SW5mb0ZpZWxkUGF0aDogc3RyaW5nLCBhdHRhY2htZW50SW5mbzogQXR0YWNobWVudEluZm9bXSk6IFNlcnZlckF0dGFjaG1lbnRJbmZvIHtcbiAgICBjb25zdCBhdHRhY2htZW50SWRzID0gQXR0YWNobWVudFV0aWwucGVla0F0dGFjaG1lbnRJZHMoYXR0YWNobWVudEluZm8pO1xuXG4gICAgY29uc3QgcGFyZW50QmluZGluZ1BhdGhBcnJheSA9IEJpbmRpbmdQYXRoQ29udmVydGVyLnRvQmluZGluZ1BhdGhBcnJheShhdHRhY2htZW50SW5mb0ZpZWxkUGF0aCk7XG4gICAgcGFyZW50QmluZGluZ1BhdGhBcnJheS5wb3AoKTtcbiAgICBjb25zdCBub2RlQ29kZXMgPSBCZWZEYXRhUGF0aFV0aWwuY29udmVydFRvT2JqZWN0Q29kZXMocGFyZW50QmluZGluZ1BhdGhBcnJheSwgdGhpcy5iaW5kaW5nRGF0YSk7XG4gICAgY29uc3QgaGlyZXRyeUlkcyA9IEJlZkRhdGFQYXRoVXRpbC5jb252ZXJ0VG9EYXRhSWRzRm9yQWRkKHBhcmVudEJpbmRpbmdQYXRoQXJyYXksIHRoaXMuYmluZGluZ0RhdGEpO1xuXG4gICAgY29uc3Qgc2VydmVyQXR0YWNoSW5mbyA9IHtcbiAgICAgIE5vZGVDb2Rlczogbm9kZUNvZGVzLFxuICAgICAgSGlyZXRyeUlkczogaGlyZXRyeUlkcyxcbiAgICAgIEF0dGFjaG1lbnRJZHM6IGF0dGFjaG1lbnRJZHMsXG4gICAgICBBdHRhY2htZW50SWQ6IG51bGxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHNlcnZlckF0dGFjaEluZm87XG4gIH1cblxuICAvKipcbiAgICog5ZCM5q2l5pyN5Yqh5Zmo56uv5pyA5paw5L+h5oGv5Yiw5a6i5oi356uvXG4gICAqIEB0b2RvOlxuICAgKiAx44CB5Li75a+56LGh5om56YeP5paw5aKe5pe25LiN5pSv5oyBXG4gICAqL1xuICBwdWJsaWMgc3luY0F0dGFjaG1lbnRJbmZvc1RvQ2xpZW50KCkge1xuICAgIGNvbnN0IHJvb3REYXRhSWQgPSB0aGlzLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnkudXBkYXRlRW50aXR5QnlJZChyb290RGF0YUlkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiDov73liqDkuLvooajmlbDmja7liLDlrqLmiLfnq69cbiAgICovXG4gIHB1YmxpYyBhcHBlbmRBdHRhY2htZW50SW5mb3NUb0NsaWVudChsaXN0RGF0YTogYW55W10sIGlzUm9vdEVudGl0eTogYm9vbGVhbik6IE9ic2VydmFibGU8YW55W10+IHtcbiAgICBpZiAoaXNSb290RW50aXR5ID09PSB0cnVlKSB7XG4gICAgICBjb25zdCBlbnRpdGllcyA9IHRoaXMucmVwb3NpdG9yeS5idWlsZEVudGl0aWVzKGxpc3REYXRhKTtcbiAgICAgIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzKTtcbiAgICAgIHJldHVybiBvZihsaXN0RGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHJvb3REYXRhSWQgPSB0aGlzLmJpbmRpbmdEYXRhLmxpc3QuY3VycmVudElkO1xuICAgICAgcmV0dXJuIHRoaXMucmVwb3NpdG9yeS51cGRhdGVFbnRpdHlCeUlkKHJvb3REYXRhSWQpLnBpcGUoXG4gICAgICAgIG1hcCgoKSA9PiBsaXN0RGF0YSlcbiAgICAgICk7XG4gICAgfVxuICB9XG4gIHB1YmxpYyBhcHBlbmRBdHRhY2htZW50SW5mb3MobGlzdERhdGE6IGFueVtdLCBrZXlWYWx1ZXM6IHsgW3Byb3A6IHN0cmluZ106IGFueSB9KTogT2JzZXJ2YWJsZTxhbnlbXT4ge1xuICAgIGNvbnN0IGVudGl0aWVzID0gdGhpcy5yZXBvc2l0b3J5LmJ1aWxkRW50aXRpZXMobGlzdERhdGEpO1xuICAgIHRoaXMucmVwb3NpdG9yeS5lbnRpdHlDb2xsZWN0aW9uLmFkZEVudGl0aWVzKGVudGl0aWVzKTtcbiAgICAvLyDmm7TmlrDlrp7kvZPkvb/kuYvkuqfnlJ/lj5jmm7Tpm4ZcbiAgICB0aGlzLnVwZGF0ZUVudGl0aWVzKGVudGl0aWVzLCBrZXlWYWx1ZXMpO1xuICAgIHJldHVybiBvZihsaXN0RGF0YSk7XG4gIH1cbiAgcHJpdmF0ZSB1cGRhdGVFbnRpdGllcyhlbnRpdGllczogRW50aXR5W10sIGtleVZhbHVlczogeyBbcHJvcDogc3RyaW5nXTogYW55IH0pIHtcbiAgICBlbnRpdGllcy5mb3JFYWNoKChlbnRpdHk6IEVudGl0eSkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVFbnRpdHkoZW50aXR5LCBrZXlWYWx1ZXMpO1xuICAgIH0pO1xuICB9XG4gIHByaXZhdGUgdXBkYXRlRW50aXR5KHRhcmdldDogRW50aXR5LCBrZXlWYWx1ZXM6IHsgW3Byb3A6IHN0cmluZ106IGFueSB9KSB7XG4gICAgT2JqZWN0LmtleXMoa2V5VmFsdWVzKS5mb3JFYWNoKChrZXk6IHN0cmluZykgPT4ge1xuICAgICAgdGhpcy5zZXRWYWx1ZUJ5UGF0aCh0YXJnZXQsIGtleSwga2V5VmFsdWVzW2tleV0pO1xuICAgIH0pO1xuICB9XG4gIHByaXZhdGUgc2V0VmFsdWVCeVBhdGgodGFyZ2V0OiBvYmplY3QsIHBhdGg6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgIGlmICh0YXJnZXQpIHtcbiAgICAgIGNvbnN0IHBhdGhzID0gcGF0aC5zcGxpdCgnLicpO1xuICAgICAgaWYgKHBhdGhzLmxlbmd0aCA8PSAxKSB7XG4gICAgICAgIHRhcmdldFtwYXRoXSA9IHZhbHVlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcGF0aHMuc2xpY2UoMCwgLTEpLnJlZHVjZSgocHJldiwgcGF0aCkgPT4ge1xuICAgICAgICAgIGlmICghKHByZXYuaGFzT3duUHJvcGVydHkocGF0aCkgfHwgcHJldlsnX19wcm90b19fJ10uaGFzT3duUHJvcGVydHkocGF0aCkpKSB7XG4gICAgICAgICAgICBwcmV2W3BhdGhdID0ge307XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBwcmV2W3BhdGhdO1xuICAgICAgICB9LCB0YXJnZXQpW3BhdGhzW3BhdGhzLmxlbmd0aCAtIDFdXSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5cbmV4cG9ydCB7IEF0dGFjaG1lbnREYXRhU2VydmljZSB9O1xuIl19