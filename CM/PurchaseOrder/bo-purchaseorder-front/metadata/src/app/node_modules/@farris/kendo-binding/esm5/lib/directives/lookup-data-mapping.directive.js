/*
 * @Author: 疯狂秀才(lucas huang)
 * @Date: 2018-11-07 16:31:57
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-09-27 14:57:22
 * @Company: Inspur
 * @Version: v0.0.1
 */
import * as tslib_1 from "tslib";
/**
 * 使用方法：
 * [data-mapping]="{ id: 'user.userId', name: 'user.userName' }"
 * key 为帮助上的字段， value 为 表单中的字段名
 * 帮助上的同一个字段可以映射到表单中的多个字段中，{ ... id: 'user.userid, user.addusid'}
 * 多字段以逗号隔开
 *
 */
import { Directive, Optional, Self, Input } from '@angular/core';
import { BindingObject, ViewModel } from '@farris/devkit';
import { LookupGridComponent } from '@farris/ui-lookup';
import { DataMapping } from './data-mapping';
var LookupDataMappingDirective = /** @class */ (function (_super) {
    tslib_1.__extends(LookupDataMappingDirective, _super);
    function LookupDataMappingDirective(vm, lookup) {
        var _this = _super.call(this) || this;
        _this.vm = vm;
        _this.lookup = lookup;
        _this.target = null;
        return _this;
    }
    LookupDataMappingDirective.prototype.ngOnInit = function () {
        var _this = this;
        this.lookup.selectedData.subscribe(function (data) {
            var _mapfields = _this.mapfields || _this.lookup.mapFields;
            _this.mappingData(data, _mapfields);
        });
        this.lookup.clearMappings.subscribe(function (result) {
            // const value = result && result.value || null;
            var mapfields = Object.assign({}, (_this.mapfields || _this.lookup.mapFields || {}));
            var lookupTextField = _this.lookup.textField;
            var data = {};
            var controlName = _this.lookup.ngControl && _this.lookup.ngControl.name;
            if (controlName && _this.vm) {
                var textFieldMapping = mapfields[lookupTextField];
                var ngFormControl = _this.vm && _this.vm.form && _this.vm.form.ngFormControls && _this.vm.form.ngFormControls[controlName];
                var binding_1 = ngFormControl && ngFormControl.binding;
                if (textFieldMapping && binding_1) {
                    mapfields[lookupTextField] = textFieldMapping.split(',').filter(function (item) { return item !== binding_1; }).join(',');
                }
            }
            // this.setValue(data, lookupTextField.split('.'), value);
            Object.keys(mapfields).forEach(function (field) {
                _this.setValue(data, field.split('.'), '');
            });
            _this.mappingData(data, mapfields, true);
        });
        this.lookup.clear.subscribe(function () {
            var _mapfields = _this.mapfields || _this.lookup.mapFields;
            _this.mappingData(null, _mapfields);
        });
    };
    LookupDataMappingDirective.decorators = [
        { type: Directive, args: [{ selector: '[data-mapping]' },] }
    ];
    /** @nocollapse */
    LookupDataMappingDirective.ctorParameters = function () { return [
        { type: ViewModel, decorators: [{ type: Optional }] },
        { type: LookupGridComponent, decorators: [{ type: Optional }, { type: Self }] }
    ]; };
    LookupDataMappingDirective.propDecorators = {
        mapfields: [{ type: Input, args: ['data-mapping',] }],
        target: [{ type: Input, args: ['target',] }]
    };
    return LookupDataMappingDirective;
}(DataMapping));
export { LookupDataMappingDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9va3VwLWRhdGEtbWFwcGluZy5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL2tlbmRvLWJpbmRpbmcvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy9sb29rdXAtZGF0YS1tYXBwaW5nLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HOztBQUVIOzs7Ozs7O0dBT0c7QUFFSCxPQUFPLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxhQUFhLEVBQTZDLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JHLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUc3QztJQUNnRCxzREFBVztJQUt6RCxvQ0FBK0IsRUFBYSxFQUE4QixNQUEyQjtRQUFyRyxZQUNFLGlCQUFPLFNBQ1I7UUFGOEIsUUFBRSxHQUFGLEVBQUUsQ0FBVztRQUE4QixZQUFNLEdBQU4sTUFBTSxDQUFxQjtRQUZwRixZQUFNLEdBQWtCLElBQUksQ0FBQzs7SUFJOUMsQ0FBQztJQUVELDZDQUFRLEdBQVI7UUFBQSxpQkE2QkM7UUE1QkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLFVBQUMsSUFBUztZQUMzQyxJQUFNLFVBQVUsR0FBRyxLQUFJLENBQUMsU0FBUyxJQUFJLEtBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO1lBQzNELEtBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ3JDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLFVBQUMsTUFBVztZQUM5QyxnREFBZ0Q7WUFDaEQsSUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxLQUFJLENBQUMsU0FBUyxJQUFJLEtBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDckYsSUFBTSxlQUFlLEdBQUcsS0FBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7WUFDOUMsSUFBTSxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQ2hCLElBQU0sV0FBVyxHQUFHLEtBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxJQUFJLEtBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztZQUN4RSxJQUFJLFdBQVcsSUFBSSxLQUFJLENBQUMsRUFBRSxFQUFFO2dCQUMxQixJQUFNLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDcEQsSUFBTSxhQUFhLEdBQUcsS0FBSSxDQUFDLEVBQUUsSUFBSSxLQUFJLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxLQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLElBQUksS0FBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBa0IsQ0FBQztnQkFDMUksSUFBTSxTQUFPLEdBQUcsYUFBYSxJQUFJLGFBQWEsQ0FBQyxPQUFPLENBQUM7Z0JBQ3ZELElBQUksZ0JBQWdCLElBQUksU0FBTyxFQUFFO29CQUMvQixTQUFTLENBQUMsZUFBZSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksS0FBSyxTQUFPLEVBQWhCLENBQWdCLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3JHO2FBQ0Y7WUFDRCwwREFBMEQ7WUFDMUQsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQSxLQUFLO2dCQUNsQyxLQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQzVDLENBQUMsQ0FBQyxDQUFDO1lBQ0gsS0FBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzFDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1lBQzFCLElBQU0sVUFBVSxHQUFHLEtBQUksQ0FBQyxTQUFTLElBQUksS0FBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUM7WUFDM0QsS0FBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDckMsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOztnQkF2Q0YsU0FBUyxTQUFDLEVBQUUsUUFBUSxFQUFFLGdCQUFnQixFQUFFOzs7O2dCQUwwQixTQUFTLHVCQVc3RCxRQUFRO2dCQVZkLG1CQUFtQix1QkFVcUIsUUFBUSxZQUFJLElBQUk7Ozs0QkFIOUQsS0FBSyxTQUFDLGNBQWM7eUJBQ3BCLEtBQUssU0FBQyxRQUFROztJQW9DakIsaUNBQUM7Q0FBQSxBQXhDRCxDQUNnRCxXQUFXLEdBdUMxRDtTQXZDWSwwQkFBMEIiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0obHVjYXMgaHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE4LTExLTA3IDE2OjMxOjU3XHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTA5LTI3IDE0OjU3OjIyXHJcbiAqIEBDb21wYW55OiBJbnNwdXJcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiDkvb/nlKjmlrnms5XvvJpcclxuICogW2RhdGEtbWFwcGluZ109XCJ7IGlkOiAndXNlci51c2VySWQnLCBuYW1lOiAndXNlci51c2VyTmFtZScgfVwiXHJcbiAqIGtleSDkuLrluK7liqnkuIrnmoTlrZfmrrXvvIwgdmFsdWUg5Li6IOihqOWNleS4reeahOWtl+auteWQjVxyXG4gKiDluK7liqnkuIrnmoTlkIzkuIDkuKrlrZfmrrXlj6/ku6XmmKDlsITliLDooajljZXkuK3nmoTlpJrkuKrlrZfmrrXkuK3vvIx7IC4uLiBpZDogJ3VzZXIudXNlcmlkLCB1c2VyLmFkZHVzaWQnfVxyXG4gKiDlpJrlrZfmrrXku6XpgJflj7fpmpTlvIBcclxuICpcclxuICovXHJcblxyXG5pbXBvcnQgeyBEaXJlY3RpdmUsIE9uSW5pdCwgT3B0aW9uYWwsIFNlbGYsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJpbmRpbmdPYmplY3QsIERhdGFQcm9wSW5mbywgRGF0YVR5cGVJbmZvLCBOZ0Zvcm1Db250cm9sLCBWaWV3TW9kZWwgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XHJcbmltcG9ydCB7IExvb2t1cEdyaWRDb21wb25lbnQgfSBmcm9tICdAZmFycmlzL3VpLWxvb2t1cCc7XHJcbmltcG9ydCB7IERhdGFNYXBwaW5nIH0gZnJvbSAnLi9kYXRhLW1hcHBpbmcnO1xyXG5cclxuXHJcbkBEaXJlY3RpdmUoeyBzZWxlY3RvcjogJ1tkYXRhLW1hcHBpbmddJyB9KVxyXG5leHBvcnQgY2xhc3MgTG9va3VwRGF0YU1hcHBpbmdEaXJlY3RpdmUgZXh0ZW5kcyBEYXRhTWFwcGluZyBpbXBsZW1lbnRzIE9uSW5pdCB7XHJcblxyXG4gIEBJbnB1dCgnZGF0YS1tYXBwaW5nJykgbWFwZmllbGRzOiBhbnk7XHJcbiAgQElucHV0KCd0YXJnZXQnKSB0YXJnZXQ6IEJpbmRpbmdPYmplY3QgPSBudWxsO1xyXG5cclxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBwdWJsaWMgdm06IFZpZXdNb2RlbCwgQE9wdGlvbmFsKCkgQFNlbGYoKSBwcml2YXRlIGxvb2t1cDogTG9va3VwR3JpZENvbXBvbmVudCkge1xyXG4gICAgc3VwZXIoKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy5sb29rdXAuc2VsZWN0ZWREYXRhLnN1YnNjcmliZSgoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgIGNvbnN0IF9tYXBmaWVsZHMgPSB0aGlzLm1hcGZpZWxkcyB8fCB0aGlzLmxvb2t1cC5tYXBGaWVsZHM7XHJcbiAgICAgIHRoaXMubWFwcGluZ0RhdGEoZGF0YSwgX21hcGZpZWxkcyk7XHJcbiAgICB9KTtcclxuICAgIHRoaXMubG9va3VwLmNsZWFyTWFwcGluZ3Muc3Vic2NyaWJlKChyZXN1bHQ6IGFueSkgPT4ge1xyXG4gICAgICAvLyBjb25zdCB2YWx1ZSA9IHJlc3VsdCAmJiByZXN1bHQudmFsdWUgfHwgbnVsbDtcclxuICAgICAgY29uc3QgbWFwZmllbGRzID0gT2JqZWN0LmFzc2lnbih7fSwgKHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcyB8fCB7fSkpO1xyXG4gICAgICBjb25zdCBsb29rdXBUZXh0RmllbGQgPSB0aGlzLmxvb2t1cC50ZXh0RmllbGQ7XHJcbiAgICAgIGNvbnN0IGRhdGEgPSB7fTtcclxuICAgICAgY29uc3QgY29udHJvbE5hbWUgPSB0aGlzLmxvb2t1cC5uZ0NvbnRyb2wgJiYgdGhpcy5sb29rdXAubmdDb250cm9sLm5hbWU7XHJcbiAgICAgIGlmIChjb250cm9sTmFtZSAmJiB0aGlzLnZtKSB7XHJcbiAgICAgICAgY29uc3QgdGV4dEZpZWxkTWFwcGluZyA9IG1hcGZpZWxkc1tsb29rdXBUZXh0RmllbGRdO1xyXG4gICAgICAgIGNvbnN0IG5nRm9ybUNvbnRyb2wgPSB0aGlzLnZtICYmIHRoaXMudm0uZm9ybSAmJiB0aGlzLnZtLmZvcm0ubmdGb3JtQ29udHJvbHMgJiYgdGhpcy52bS5mb3JtLm5nRm9ybUNvbnRyb2xzW2NvbnRyb2xOYW1lXSBhcyBOZ0Zvcm1Db250cm9sO1xyXG4gICAgICAgIGNvbnN0IGJpbmRpbmcgPSBuZ0Zvcm1Db250cm9sICYmIG5nRm9ybUNvbnRyb2wuYmluZGluZztcclxuICAgICAgICBpZiAodGV4dEZpZWxkTWFwcGluZyAmJiBiaW5kaW5nKSB7XHJcbiAgICAgICAgICBtYXBmaWVsZHNbbG9va3VwVGV4dEZpZWxkXSA9IHRleHRGaWVsZE1hcHBpbmcuc3BsaXQoJywnKS5maWx0ZXIoaXRlbSA9PiBpdGVtICE9PSBiaW5kaW5nKS5qb2luKCcsJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIC8vIHRoaXMuc2V0VmFsdWUoZGF0YSwgbG9va3VwVGV4dEZpZWxkLnNwbGl0KCcuJyksIHZhbHVlKTtcclxuICAgICAgT2JqZWN0LmtleXMobWFwZmllbGRzKS5mb3JFYWNoKGZpZWxkID0+IHtcclxuICAgICAgICB0aGlzLnNldFZhbHVlKGRhdGEsIGZpZWxkLnNwbGl0KCcuJyksICcnKTtcclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMubWFwcGluZ0RhdGEoZGF0YSwgbWFwZmllbGRzLCB0cnVlKTtcclxuICAgIH0pO1xyXG4gICAgdGhpcy5sb29rdXAuY2xlYXIuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgY29uc3QgX21hcGZpZWxkcyA9IHRoaXMubWFwZmllbGRzIHx8IHRoaXMubG9va3VwLm1hcEZpZWxkcztcclxuICAgICAgdGhpcy5tYXBwaW5nRGF0YShudWxsLCBfbWFwZmllbGRzKTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=