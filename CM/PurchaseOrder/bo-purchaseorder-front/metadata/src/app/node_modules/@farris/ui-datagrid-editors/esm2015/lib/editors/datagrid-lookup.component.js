/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { debounceTime } from 'rxjs/operators';
import { Injector } from '@angular/core';
/*
 * @Author: 疯狂秀才(Lucas Huang)
 * @Date: 2019-08-14 11:41:00
 * @LastEditors: 疯狂秀才(Lucas Huang)
 * @LastEditTime: 2019-10-14 13:00:48
 * @QQ: 1055818239
 * @Version: v0.0.1
 */
import { Component, Renderer2, ElementRef, ViewChild } from '@angular/core';
import { DatagridBaseEditorDirective } from '../datagrid-base-editor.directive';
import { LookupDefaultOptions } from '../editor-default-options';
import { LookupGridComponent } from '@farris/ui-lookup';
import { RuntimeStateService } from '@farris/ui-common';
// [quickSelect]="options?.quickSelect"
export class DatagridLookupComponent extends DatagridBaseEditorDirective {
    /**
     * @param {?} render
     * @param {?} el
     * @param {?} rts
     * @param {?} injector
     */
    constructor(render, el, rts, injector) {
        super(render, el, injector);
        this.rts = rts;
        this.stopPropagation = false;
        this.extInfoFormatter = (/**
         * @param {?} e
         * @return {?}
         */
        (e) => {
            if (this.options.extInfoFormatter) {
                return this.options.extInfoFormatter({ bindingData: this.dr.rowData, instance: e.instance });
            }
            return '';
        });
    }
    /**
     * @param {?} id
     * @return {?}
     */
    set controlId(id) {
        this.instance.controlId = id;
        if (this.instance.uri) {
            this.instance.controlId += '_' + this.instance.uri;
        }
    }
    /**
     * @return {?}
     */
    ngOnInit() {
        super.ngOnInit();
        this.options = Object.assign({}, LookupDefaultOptions, this.options);
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.instance.changeDetector.detectChanges();
        if (this.options.viewType === 'tag') {
            this.inputElement = this.instance.tagbox.nativeElement;
        }
        else {
            this.inputElement = this.instance.inputGroup.textbox.nativeElement;
        }
        super.ngAfterViewInit();
        if (this.options.loader) {
            if (this.instance['http']) {
                /** @type {?} */
                const getDataFn = this.instance['http'];
                this.instance['http'] = Object.assign({}, getDataFn, { getData: this.options.loader });
            }
            else {
                this.instance['http'] = { getData: this.options.loader };
            }
        }
        this.instance['host'] = this.dg;
        this.rts.state$.pipe(debounceTime(10)).subscribe((/**
         * @param {?} state
         * @return {?}
         */
        state => {
            if (state && state.form && state.form.lookup && this.dg) {
                this.pending = state.form.lookup.pending;
                this.dg.pending = this.pending;
            }
        }));
    }
    /**
     * @return {?}
     */
    onDialogClosed() {
        // this.lookup.changeDetector.detectChanges();
    }
    /**
     * @return {?}
     */
    onDialogOpen() {
        this.instance.changeDetector.detectChanges();
    }
    /**
     * @return {?}
     */
    onLoadSuccess() {
        this.instance.changeDetector.detectChanges();
    }
    /**
     * @param {?} event
     * @return {?}
     */
    onClear(event) {
        // const rowData = this.instance.selectionMgr.getBindingData();
        // this.instance['defaultMapping'].lookupFieldMap(null, this.instance.mapFields, rowData);
        this.instance.changeDetector.detectChanges();
        if (this.options.clear) {
            this.options.clear();
        }
    }
    /**
     * @param {?} $evnet
     * @return {?}
     */
    onTagRemoved($evnet) {
        if (this.options.tagRemoved) {
            this.options.tagRemoved($evnet);
        }
    }
}
DatagridLookupComponent.decorators = [
    { type: Component, args: [{
                selector: 'grid-editor-lookup',
                template: `
    <div [formGroup]="group" class="f-datagrid-cell-formgroup farris-group-auto">
        <datagrid-tooltip [control]="formControl" [tooltipPosition]="'top-left'" [message]="errorMessage">
            <farris-lookup-grid #lookup style="width: 100%"
                id="{{ controlId }}"
                [formControlName]="column.field"
                [uri]="options.uri"
                [helpId]="options.helpId"
                [displayType]="options.displayType"
                [singleSelect]="options.singleSelect"
                [idField]="options.idField"
                [pageSize]="options.pageSize || 20"
                [pageIndex]="options.pageSize || 1"
                [pagination]="options.pageination"
                [textField]="options.textField"
                [valueField]="options.valueField"
                [title]="options.title"
                [useFavorite]="options.useFavorite"
                [isRecordSize]="options.isRecordSize"
                [useTip]="options.useTip"
                [editable]="options.editable"
                [readonly]="options.readonly"
                [dialogWidth]="options.dialogWidth"
                [dialogHeight]="options.dialogHeight"
                [showMaxButton]="options.showMaxButton"
                [showCloseButton]="options.showCloseButton"
                [resizable]="options.resizable"
                [buttonAlign]="options.buttonAlign"
                [enableClear]="options.enableClear"
                [searchOnServer]="options.searchOnServer"
                [nosearch]="options.nosearch"
                [maxLength]="options.maxLength"
                [mappingFn]="options.mappingFn"
                [mapFields]="options.mapFields"
                [context]="options.context"
                [expandLevel]="options.expandLevel"
                [dictPicking]="options.dictPicking"
                [dictPicked]="options.dictPicked"
                [enableFullTree]="options.enableFullTree"
                [loadTreeDataType]="options.loadTreeDataType"
                [enableCascade]="options.enableCascade"
                [cascadeStatus]="options.cascadeStatus"
                [useExtendInfo]="options.useExtendInfo"
                [extInfoFields]="options.extInfoFields"
                [extInfoFormatter]="options.extInfoFormatter"
                [textAlign]="options.textAlign"
                [loadDataWhenOpen]="options.loadDataWhenOpen"
                [selectFirstInNav]="options.selectFirstInNav"
                [customNavFormatter]="options.customNavFormatter"
                [customFormatter]="options.customFormatter"
                [treeInfo]="options?.treeInfo"
                (dialogClosed)="onDialogClosed()"
                (dialogOpened)="onDialogOpen()"
                (clear)="onClear($event)"
                (loadSuccess)="onLoadSuccess()"
                [treeTableOptions]="options?.treeTableOptions"
                [showCheckAll]="options?.showCheckAll"
                [viewType]="options?.viewType"
                (tagRemoved)="onTagRemoved($event)"
            ></farris-lookup-grid>
        </datagrid-tooltip>
    </div>
    `
            }] }
];
/** @nocollapse */
DatagridLookupComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef },
    { type: RuntimeStateService },
    { type: Injector }
];
DatagridLookupComponent.propDecorators = {
    instance: [{ type: ViewChild, args: ['lookup',] }]
};
if (false) {
    /** @type {?} */
    DatagridLookupComponent.prototype.instance;
    /** @type {?} */
    DatagridLookupComponent.prototype.stopPropagation;
    /** @type {?} */
    DatagridLookupComponent.prototype.extInfoFormatter;
    /**
     * @type {?}
     * @private
     */
    DatagridLookupComponent.prototype.rts;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWdyaWQtbG9va3VwLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktZGF0YWdyaWQtZWRpdG9ycy8iLCJzb3VyY2VzIjpbImxpYi9lZGl0b3JzL2RhdGFncmlkLWxvb2t1cC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQXFELFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7Ozs7Ozs7O0FBUzVGLE9BQU8sRUFBRSxTQUFTLEVBQVUsU0FBUyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDcEYsT0FBTyxFQUFFLDJCQUEyQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFDaEYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDeEQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7O0FBc0V4RCxNQUFNLE9BQU8sdUJBQXdCLFNBQVEsMkJBQTJCOzs7Ozs7O0lBWXBFLFlBQVksTUFBaUIsRUFBRSxFQUFjLEVBQVUsR0FBd0IsRUFDbkUsUUFBa0I7UUFDMUIsS0FBSyxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFGdUIsUUFBRyxHQUFILEdBQUcsQ0FBcUI7UUFEL0Usb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFvRXhCLHFCQUFnQjs7OztRQUFHLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDckIsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFO2dCQUMvQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsUUFB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LElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUU7WUFDcEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUN4QjtJQUNMLENBQUM7Ozs7O0lBRUQsWUFBWSxDQUFDLE1BQU07UUFDZixJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ25DO0lBQ0wsQ0FBQzs7O1lBL0lKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsb0JBQW9CO2dCQUM5QixRQUFRLEVBQUU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0tBOERUO2FBQ0o7Ozs7WUF6RTJCLFNBQVM7WUFBRSxVQUFVO1lBSXhDLG1CQUFtQjtZQWJnQyxRQUFROzs7dUJBb0YvRCxTQUFTLFNBQUMsUUFBUTs7OztJQUFuQiwyQ0FBbUQ7O0lBVW5ELGtEQUF3Qjs7SUFvRXhCLG1EQU1DOzs7OztJQXpFOEMsc0NBQWdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVib3VuY2VUaW1lIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5pbXBvcnQgeyBBZnRlclZpZXdJbml0LCBBcHBsaWNhdGlvblJlZiwgSW5qZWN0LCBmb3J3YXJkUmVmLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG4vKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0oTHVjYXMgSHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE5LTA4LTE0IDExOjQxOjAwXHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTEwLTE0IDEzOjAwOjQ4XHJcbiAqIEBRUTogMTA1NTgxODIzOVxyXG4gKiBAVmVyc2lvbjogdjAuMC4xXHJcbiAqL1xyXG5pbXBvcnQgeyBDb21wb25lbnQsIE9uSW5pdCwgUmVuZGVyZXIyLCBFbGVtZW50UmVmLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIH0gZnJvbSAnLi4vZGF0YWdyaWQtYmFzZS1lZGl0b3IuZGlyZWN0aXZlJztcclxuaW1wb3J0IHsgTG9va3VwRGVmYXVsdE9wdGlvbnMgfSBmcm9tICcuLi9lZGl0b3ItZGVmYXVsdC1vcHRpb25zJztcclxuaW1wb3J0IHsgTG9va3VwR3JpZENvbXBvbmVudCB9IGZyb20gJ0BmYXJyaXMvdWktbG9va3VwJztcclxuaW1wb3J0IHsgUnVudGltZVN0YXRlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuXHJcblxyXG4vLyBbcXVpY2tTZWxlY3RdPVwib3B0aW9ucz8ucXVpY2tTZWxlY3RcIlxyXG5AQ29tcG9uZW50KHtcclxuICAgIHNlbGVjdG9yOiAnZ3JpZC1lZGl0b3ItbG9va3VwJyxcclxuICAgIHRlbXBsYXRlOiBgXHJcbiAgICA8ZGl2IFtmb3JtR3JvdXBdPVwiZ3JvdXBcIiBjbGFzcz1cImYtZGF0YWdyaWQtY2VsbC1mb3JtZ3JvdXAgZmFycmlzLWdyb3VwLWF1dG9cIj5cclxuICAgICAgICA8ZGF0YWdyaWQtdG9vbHRpcCBbY29udHJvbF09XCJmb3JtQ29udHJvbFwiIFt0b29sdGlwUG9zaXRpb25dPVwiJ3RvcC1sZWZ0J1wiIFttZXNzYWdlXT1cImVycm9yTWVzc2FnZVwiPlxyXG4gICAgICAgICAgICA8ZmFycmlzLWxvb2t1cC1ncmlkICNsb29rdXAgc3R5bGU9XCJ3aWR0aDogMTAwJVwiXHJcbiAgICAgICAgICAgICAgICBpZD1cInt7IGNvbnRyb2xJZCB9fVwiXHJcbiAgICAgICAgICAgICAgICBbZm9ybUNvbnRyb2xOYW1lXT1cImNvbHVtbi5maWVsZFwiXHJcbiAgICAgICAgICAgICAgICBbdXJpXT1cIm9wdGlvbnMudXJpXCJcclxuICAgICAgICAgICAgICAgIFtoZWxwSWRdPVwib3B0aW9ucy5oZWxwSWRcIlxyXG4gICAgICAgICAgICAgICAgW2Rpc3BsYXlUeXBlXT1cIm9wdGlvbnMuZGlzcGxheVR5cGVcIlxyXG4gICAgICAgICAgICAgICAgW3NpbmdsZVNlbGVjdF09XCJvcHRpb25zLnNpbmdsZVNlbGVjdFwiXHJcbiAgICAgICAgICAgICAgICBbaWRGaWVsZF09XCJvcHRpb25zLmlkRmllbGRcIlxyXG4gICAgICAgICAgICAgICAgW3BhZ2VTaXplXT1cIm9wdGlvbnMucGFnZVNpemUgfHwgMjBcIlxyXG4gICAgICAgICAgICAgICAgW3BhZ2VJbmRleF09XCJvcHRpb25zLnBhZ2VTaXplIHx8IDFcIlxyXG4gICAgICAgICAgICAgICAgW3BhZ2luYXRpb25dPVwib3B0aW9ucy5wYWdlaW5hdGlvblwiXHJcbiAgICAgICAgICAgICAgICBbdGV4dEZpZWxkXT1cIm9wdGlvbnMudGV4dEZpZWxkXCJcclxuICAgICAgICAgICAgICAgIFt2YWx1ZUZpZWxkXT1cIm9wdGlvbnMudmFsdWVGaWVsZFwiXHJcbiAgICAgICAgICAgICAgICBbdGl0bGVdPVwib3B0aW9ucy50aXRsZVwiXHJcbiAgICAgICAgICAgICAgICBbdXNlRmF2b3JpdGVdPVwib3B0aW9ucy51c2VGYXZvcml0ZVwiXHJcbiAgICAgICAgICAgICAgICBbaXNSZWNvcmRTaXplXT1cIm9wdGlvbnMuaXNSZWNvcmRTaXplXCJcclxuICAgICAgICAgICAgICAgIFt1c2VUaXBdPVwib3B0aW9ucy51c2VUaXBcIlxyXG4gICAgICAgICAgICAgICAgW2VkaXRhYmxlXT1cIm9wdGlvbnMuZWRpdGFibGVcIlxyXG4gICAgICAgICAgICAgICAgW3JlYWRvbmx5XT1cIm9wdGlvbnMucmVhZG9ubHlcIlxyXG4gICAgICAgICAgICAgICAgW2RpYWxvZ1dpZHRoXT1cIm9wdGlvbnMuZGlhbG9nV2lkdGhcIlxyXG4gICAgICAgICAgICAgICAgW2RpYWxvZ0hlaWdodF09XCJvcHRpb25zLmRpYWxvZ0hlaWdodFwiXHJcbiAgICAgICAgICAgICAgICBbc2hvd01heEJ1dHRvbl09XCJvcHRpb25zLnNob3dNYXhCdXR0b25cIlxyXG4gICAgICAgICAgICAgICAgW3Nob3dDbG9zZUJ1dHRvbl09XCJvcHRpb25zLnNob3dDbG9zZUJ1dHRvblwiXHJcbiAgICAgICAgICAgICAgICBbcmVzaXphYmxlXT1cIm9wdGlvbnMucmVzaXphYmxlXCJcclxuICAgICAgICAgICAgICAgIFtidXR0b25BbGlnbl09XCJvcHRpb25zLmJ1dHRvbkFsaWduXCJcclxuICAgICAgICAgICAgICAgIFtlbmFibGVDbGVhcl09XCJvcHRpb25zLmVuYWJsZUNsZWFyXCJcclxuICAgICAgICAgICAgICAgIFtzZWFyY2hPblNlcnZlcl09XCJvcHRpb25zLnNlYXJjaE9uU2VydmVyXCJcclxuICAgICAgICAgICAgICAgIFtub3NlYXJjaF09XCJvcHRpb25zLm5vc2VhcmNoXCJcclxuICAgICAgICAgICAgICAgIFttYXhMZW5ndGhdPVwib3B0aW9ucy5tYXhMZW5ndGhcIlxyXG4gICAgICAgICAgICAgICAgW21hcHBpbmdGbl09XCJvcHRpb25zLm1hcHBpbmdGblwiXHJcbiAgICAgICAgICAgICAgICBbbWFwRmllbGRzXT1cIm9wdGlvbnMubWFwRmllbGRzXCJcclxuICAgICAgICAgICAgICAgIFtjb250ZXh0XT1cIm9wdGlvbnMuY29udGV4dFwiXHJcbiAgICAgICAgICAgICAgICBbZXhwYW5kTGV2ZWxdPVwib3B0aW9ucy5leHBhbmRMZXZlbFwiXHJcbiAgICAgICAgICAgICAgICBbZGljdFBpY2tpbmddPVwib3B0aW9ucy5kaWN0UGlja2luZ1wiXHJcbiAgICAgICAgICAgICAgICBbZGljdFBpY2tlZF09XCJvcHRpb25zLmRpY3RQaWNrZWRcIlxyXG4gICAgICAgICAgICAgICAgW2VuYWJsZUZ1bGxUcmVlXT1cIm9wdGlvbnMuZW5hYmxlRnVsbFRyZWVcIlxyXG4gICAgICAgICAgICAgICAgW2xvYWRUcmVlRGF0YVR5cGVdPVwib3B0aW9ucy5sb2FkVHJlZURhdGFUeXBlXCJcclxuICAgICAgICAgICAgICAgIFtlbmFibGVDYXNjYWRlXT1cIm9wdGlvbnMuZW5hYmxlQ2FzY2FkZVwiXHJcbiAgICAgICAgICAgICAgICBbY2FzY2FkZVN0YXR1c109XCJvcHRpb25zLmNhc2NhZGVTdGF0dXNcIlxyXG4gICAgICAgICAgICAgICAgW3VzZUV4dGVuZEluZm9dPVwib3B0aW9ucy51c2VFeHRlbmRJbmZvXCJcclxuICAgICAgICAgICAgICAgIFtleHRJbmZvRmllbGRzXT1cIm9wdGlvbnMuZXh0SW5mb0ZpZWxkc1wiXHJcbiAgICAgICAgICAgICAgICBbZXh0SW5mb0Zvcm1hdHRlcl09XCJvcHRpb25zLmV4dEluZm9Gb3JtYXR0ZXJcIlxyXG4gICAgICAgICAgICAgICAgW3RleHRBbGlnbl09XCJvcHRpb25zLnRleHRBbGlnblwiXHJcbiAgICAgICAgICAgICAgICBbbG9hZERhdGFXaGVuT3Blbl09XCJvcHRpb25zLmxvYWREYXRhV2hlbk9wZW5cIlxyXG4gICAgICAgICAgICAgICAgW3NlbGVjdEZpcnN0SW5OYXZdPVwib3B0aW9ucy5zZWxlY3RGaXJzdEluTmF2XCJcclxuICAgICAgICAgICAgICAgIFtjdXN0b21OYXZGb3JtYXR0ZXJdPVwib3B0aW9ucy5jdXN0b21OYXZGb3JtYXR0ZXJcIlxyXG4gICAgICAgICAgICAgICAgW2N1c3RvbUZvcm1hdHRlcl09XCJvcHRpb25zLmN1c3RvbUZvcm1hdHRlclwiXHJcbiAgICAgICAgICAgICAgICBbdHJlZUluZm9dPVwib3B0aW9ucz8udHJlZUluZm9cIlxyXG4gICAgICAgICAgICAgICAgKGRpYWxvZ0Nsb3NlZCk9XCJvbkRpYWxvZ0Nsb3NlZCgpXCJcclxuICAgICAgICAgICAgICAgIChkaWFsb2dPcGVuZWQpPVwib25EaWFsb2dPcGVuKClcIlxyXG4gICAgICAgICAgICAgICAgKGNsZWFyKT1cIm9uQ2xlYXIoJGV2ZW50KVwiXHJcbiAgICAgICAgICAgICAgICAobG9hZFN1Y2Nlc3MpPVwib25Mb2FkU3VjY2VzcygpXCJcclxuICAgICAgICAgICAgICAgIFt0cmVlVGFibGVPcHRpb25zXT1cIm9wdGlvbnM/LnRyZWVUYWJsZU9wdGlvbnNcIlxyXG4gICAgICAgICAgICAgICAgW3Nob3dDaGVja0FsbF09XCJvcHRpb25zPy5zaG93Q2hlY2tBbGxcIlxyXG4gICAgICAgICAgICAgICAgW3ZpZXdUeXBlXT1cIm9wdGlvbnM/LnZpZXdUeXBlXCJcclxuICAgICAgICAgICAgICAgICh0YWdSZW1vdmVkKT1cIm9uVGFnUmVtb3ZlZCgkZXZlbnQpXCJcclxuICAgICAgICAgICAgPjwvZmFycmlzLWxvb2t1cC1ncmlkPlxyXG4gICAgICAgIDwvZGF0YWdyaWQtdG9vbHRpcD5cclxuICAgIDwvZGl2PlxyXG4gICAgYCxcclxufSlcclxuZXhwb3J0IGNsYXNzIERhdGFncmlkTG9va3VwQ29tcG9uZW50IGV4dGVuZHMgRGF0YWdyaWRCYXNlRWRpdG9yRGlyZWN0aXZlIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuICAgIEBWaWV3Q2hpbGQoJ2xvb2t1cCcpIGluc3RhbmNlOiBMb29rdXBHcmlkQ29tcG9uZW50O1xyXG5cclxuXHJcbiAgICBzZXQgY29udHJvbElkKGlkKSB7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5jb250cm9sSWQgPSBpZDtcclxuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZS51cmkpIHtcclxuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5jb250cm9sSWQgKz0gJ18nICsgdGhpcy5pbnN0YW5jZS51cmk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHN0b3BQcm9wYWdhdGlvbiA9IGZhbHNlO1xyXG4gICAgY29uc3RydWN0b3IocmVuZGVyOiBSZW5kZXJlcjIsIGVsOiBFbGVtZW50UmVmLCBwcml2YXRlIHJ0czogUnVudGltZVN0YXRlU2VydmljZSxcclxuICAgICAgICAgICAgICAgIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgICAgIHN1cGVyKHJlbmRlciwgZWwsIGluamVjdG9yKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oIHt9ICwgTG9va3VwRGVmYXVsdE9wdGlvbnMsIHRoaXMub3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudmlld1R5cGUgPT09ICd0YWcnKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXRFbGVtZW50ID0gdGhpcy5pbnN0YW5jZS50YWdib3gubmF0aXZlRWxlbWVudDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmlucHV0RWxlbWVudCA9IHRoaXMuaW5zdGFuY2UuaW5wdXRHcm91cC50ZXh0Ym94Lm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHN1cGVyLm5nQWZ0ZXJWaWV3SW5pdCgpO1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9hZGVyKSB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmluc3RhbmNlWydodHRwJ10pIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGdldERhdGFGbiA9IHRoaXMuaW5zdGFuY2VbJ2h0dHAnXTtcclxuICAgICAgICAgICAgICAgIHRoaXMuaW5zdGFuY2VbJ2h0dHAnXSA9IHsuLi5nZXREYXRhRm4sIGdldERhdGE6IHRoaXMub3B0aW9ucy5sb2FkZXJ9O1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5pbnN0YW5jZVsnaHR0cCddID0ge2dldERhdGE6IHRoaXMub3B0aW9ucy5sb2FkZXJ9O1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLmluc3RhbmNlWydob3N0J10gPSB0aGlzLmRnO1xyXG5cclxuICAgICAgICB0aGlzLnJ0cy5zdGF0ZSQucGlwZShcclxuICAgICAgICAgICAgZGVib3VuY2VUaW1lKDEwKVxyXG4gICAgICAgICkuc3Vic2NyaWJlKHN0YXRlID0+IHtcclxuICAgICAgICAgICAgaWYgKHN0YXRlICYmIHN0YXRlLmZvcm0gJiYgc3RhdGUuZm9ybS5sb29rdXAgJiYgdGhpcy5kZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nID0gc3RhdGUuZm9ybS5sb29rdXAucGVuZGluZztcclxuICAgICAgICAgICAgICAgIHRoaXMuZGcucGVuZGluZyA9IHRoaXMucGVuZGluZztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9uRGlhbG9nQ2xvc2VkKCkge1xyXG4gICAgICAgIC8vIHRoaXMubG9va3VwLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkRpYWxvZ09wZW4oKSB7XHJcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9XHJcblxyXG4gICAgb25Mb2FkU3VjY2VzcygpIHtcclxuICAgICAgICB0aGlzLmluc3RhbmNlLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsZWFyKGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcbiAgICAgICAgLy8gY29uc3Qgcm93RGF0YSA9IHRoaXMuaW5zdGFuY2Uuc2VsZWN0aW9uTWdyLmdldEJpbmRpbmdEYXRhKCk7XHJcbiAgICAgICAgLy8gdGhpcy5pbnN0YW5jZVsnZGVmYXVsdE1hcHBpbmcnXS5sb29rdXBGaWVsZE1hcChudWxsLCB0aGlzLmluc3RhbmNlLm1hcEZpZWxkcywgcm93RGF0YSk7XHJcblxyXG4gICAgICAgIHRoaXMuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuY2xlYXIpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLmNsZWFyKCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIG9uVGFnUmVtb3ZlZCgkZXZuZXQpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLnRhZ1JlbW92ZWQoJGV2bmV0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZXh0SW5mb0Zvcm1hdHRlciA9IChlKSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5leHRJbmZvRm9ybWF0dGVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZXh0SW5mb0Zvcm1hdHRlcih7IGJpbmRpbmdEYXRhOiB0aGlzLmRyLnJvd0RhdGEsIGluc3RhbmNlOiBlLmluc3RhbmNlIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==