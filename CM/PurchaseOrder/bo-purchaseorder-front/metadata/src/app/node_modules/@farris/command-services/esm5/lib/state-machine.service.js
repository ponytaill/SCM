import { Injectable, ElementRef } from '@angular/core';
import { StateMachine } from '@farris/devkit';
// tslint:disable: max-line-length
/**
 * 状态机服务
 * @scope FrameComponent
 */
var StateMachineService = /** @class */ (function () {
    function StateMachineService(stateMachine) {
        var _this = this;
        this.stateMachine = stateMachine;
        this._clsDefaultName = 'f-form-state-default';
        this._initLoad = true;
        if (this.stateMachine.initialState.name === 'init') {
            window.setTimeout(function () {
                _this.initFormState();
            }, 0);
        }
    }
    StateMachineService.prototype.transit = function (action) {
        if (action && typeof this.stateMachine[action] === 'function') {
            this.stateMachine[action]();
            this._currentFrameContext = this['context'] && this['context']['frameContext'];
            if (this._initLoad) {
                this.initFormState();
                this._initLoad = false;
            }
            if (!this._currentFrameContext) {
                return;
            }
            var currentRootFrameContext = this.getCurrentRootFrameContext(this._currentFrameContext);
            if (!!currentRootFrameContext) {
                this.toggleFormState(action, currentRootFrameContext);
            }
        }
    };
    StateMachineService.prototype.getCurrentRootFrameContext = function (currentFrameContext) {
        var currentRootFrameContext;
        this.getAllRootFrameContext().forEach(function (rootFc) {
            if (currentFrameContext.namespace === rootFc.namespace) {
                currentRootFrameContext = rootFc;
            }
        });
        return currentRootFrameContext;
    };
    StateMachineService.prototype.getFrameContextManagerMap = function () {
        if (this.stateMachine && this.stateMachine.frameContext) {
            var appContext = this.stateMachine.frameContext.appContext;
            if (appContext) {
                var frameContextManager = appContext.frameContextManager;
                return frameContextManager.getFrameContextMap();
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.appContext && this.stateMachine.frameContext.appContext.frameContextManager && this.stateMachine.frameContext.appContext.frameContextManager.getFrameContextMap();
    };
    StateMachineService.prototype.getAllRootFrameContext = function () {
        var rootFrameContextArr = [];
        var frameContexts = this.getFrameContextManagerMap();
        if (frameContexts) {
            frameContexts.forEach(function (item) {
                if ((item['namespace'] === '' && item['parent'] === null) || (item['parent'] !== null && item['namespace'] !== item['parent']['namespace'])) {
                    rootFrameContextArr.push(item);
                }
            });
        }
        return rootFrameContextArr;
    };
    StateMachineService.prototype.initFormState = function () {
        var _this = this;
        if (!this.getFrameContextManagerMap()) {
            return;
        }
        this.getAllRootFrameContext().forEach(function (rootFc) {
            var rootComponent = rootFc.injector.get(ElementRef, null) || null;
            if (!rootComponent || !rootComponent.nativeElement) {
                return;
            }
            if (!rootComponent.nativeElement.className.includes(_this._clsDefaultName) && !rootComponent.nativeElement.className.includes('f-form-state-create') && !rootComponent.nativeElement.className.includes('f-form-state-edit')) {
                _this.addCssClass(rootComponent, _this._clsDefaultName);
            }
        });
    };
    StateMachineService.prototype.toggleFormState = function (action, frameContext) {
        var _this = this;
        var rootComponent = frameContext.injector.get(ElementRef, null) || null;
        if (!rootComponent || !rootComponent.nativeElement || !action) {
            return;
        }
        action = action.toLowerCase();
        if (action && ['create', 'edit'].includes(action)) {
            if (action === 'create') {
                this.addCssClass(rootComponent, 'f-form-state-create');
            }
            else if (action === 'edit') {
                this.addCssClass(rootComponent, 'f-form-state-edit');
            }
            this.removeCssClass(rootComponent, this._clsDefaultName);
        }
        else {
            ['f-form-state-create', 'f-form-state-edit'].forEach(function (item) { return _this.removeCssClass(rootComponent, item); });
            this.addCssClass(rootComponent, this._clsDefaultName);
        }
    };
    StateMachineService.prototype.addCssClass = function (elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        var originalClassName = elementRef.nativeElement.className || '';
        if (!originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName + " " + className;
        }
    };
    StateMachineService.prototype.removeCssClass = function (elementRef, className) {
        if (!elementRef || !className || !elementRef.nativeElement) {
            return;
        }
        var originalClassName = elementRef.nativeElement.className || '';
        if (originalClassName.includes(className)) {
            elementRef.nativeElement.className = originalClassName.split(' ').filter(function (p) { return p && p !== className; }).join(' ');
        }
    };
    StateMachineService.prototype.getFormRootComponent = function () {
        if (this.stateMachine && this.stateMachine.frameContext) {
            var viewContext = this.stateMachine.frameContext;
            if (viewContext) {
                var virtualRootContext = viewContext.getVirtualRootFrameContext();
                if (virtualRootContext) {
                    var injector = virtualRootContext.injector;
                    if (typeof injector.get === 'function') {
                        return injector.get(ElementRef, null);
                    }
                }
            }
        }
        return null;
        // return this.stateMachine && this.stateMachine.frameContext && this.stateMachine.frameContext.getVirtualRootFrameContext() && this.stateMachine.frameContext.getVirtualRootFrameContext().injector && typeof this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get === 'function' && this.stateMachine.frameContext.getVirtualRootFrameContext().injector.get<ElementRef>(ElementRef, null) || null;
    };
    StateMachineService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    StateMachineService.ctorParameters = function () { return [
        { type: StateMachine }
    ]; };
    return StateMachineService;
}());
export { StateMachineService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUtbWFjaGluZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9jb21tYW5kLXNlcnZpY2VzLyIsInNvdXJjZXMiOlsibGliL3N0YXRlLW1hY2hpbmUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RCxPQUFPLEVBQUUsWUFBWSxFQUE0QixNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLGtDQUFrQztBQUNsQzs7O0dBR0c7QUFDSDtJQUdFLDZCQUNVLFlBQTBCO1FBRHBDLGlCQVFDO1FBUFMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFTNUIsb0JBQWUsR0FBRyxzQkFBc0IsQ0FBQztRQUN6QyxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBUnZCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtZQUNsRCxNQUFNLENBQUMsVUFBVSxDQUFDO2dCQUNoQixLQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDdkIsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQ1A7SUFDSCxDQUFDO0lBTUQscUNBQU8sR0FBUCxVQUFRLE1BQWM7UUFDcEIsSUFBSSxNQUFNLElBQUksT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxLQUFLLFVBQVUsRUFBRTtZQUM3RCxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDNUIsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDL0UsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7Z0JBQ3JCLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO2FBQ3hC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b0JBQ3RCLElBQU0sUUFBUSxHQUFHLGtCQUFrQixDQUFDLFFBQVEsQ0FBQztvQkFDN0MsSUFBSSxPQUFPLFFBQVEsQ0FBQyxHQUFHLEtBQUssVUFBVSxFQUFFO3dCQUN0QyxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQWEsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO3FCQUNuRDtpQkFDRjthQUNGO1NBQ0Y7UUFDRCxPQUFPLElBQUksQ0FBQztRQUNaLHlaQUF5WjtJQUMzWixDQUFDOztnQkF4SUYsVUFBVTs7OztnQkFORixZQUFZOztJQStJckIsMEJBQUM7Q0FBQSxBQXpJRCxJQXlJQztBQUVELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RhdGVNYWNoaW5lLCBGcmFtZUNvbnRleHQsIEFwcENvbnRleHQgfSBmcm9tICdAZmFycmlzL2RldmtpdCc7XG4vLyB0c2xpbnQ6ZGlzYWJsZTogbWF4LWxpbmUtbGVuZ3RoXG4vKipcbiAqIOeKtuaAgeacuuacjeWKoVxuICogQHNjb3BlIEZyYW1lQ29tcG9uZW50XG4gKi9cbkBJbmplY3RhYmxlKClcbmNsYXNzIFN0YXRlTWFjaGluZVNlcnZpY2Uge1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgc3RhdGVNYWNoaW5lOiBTdGF0ZU1hY2hpbmVcbiAgKSB7XG4gICAgaWYgKHRoaXMuc3RhdGVNYWNoaW5lLmluaXRpYWxTdGF0ZS5uYW1lID09PSAnaW5pdCcpIHtcbiAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5pbml0Rm9ybVN0YXRlKCk7XG4gICAgICB9LCAwKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9jbHNEZWZhdWx0TmFtZSA9ICdmLWZvcm0tc3RhdGUtZGVmYXVsdCc7XG4gIHByaXZhdGUgX2luaXRMb2FkID0gdHJ1ZTtcbiAgcHJpdmF0ZSBfY3VycmVudEZyYW1lQ29udGV4dDogYW55XG5cbiAgdHJhbnNpdChhY3Rpb246IHN0cmluZykge1xuICAgIGlmIChhY3Rpb24gJiYgdHlwZW9mIHRoaXMuc3RhdGVNYWNoaW5lW2FjdGlvbl0gPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHRoaXMuc3RhdGVNYWNoaW5lW2FjdGlvbl0oKTtcbiAgICAgIHRoaXMuX2N1cnJlbnRGcmFtZUNvbnRleHQgPSB0aGlzWydjb250ZXh0J10gJiYgdGhpc1snY29udGV4dCddWydmcmFtZUNvbnRleHQnXTtcbiAgICAgIGlmICh0aGlzLl9pbml0TG9hZCkge1xuICAgICAgICB0aGlzLmluaXRGb3JtU3RhdGUoKTtcbiAgICAgICAgdGhpcy5faW5pdExvYWQgPSBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmICghdGhpcy5fY3VycmVudEZyYW1lQ29udGV4dCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCBjdXJyZW50Um9vdEZyYW1lQ29udGV4dCA9IHRoaXMuZ2V0Q3VycmVudFJvb3RGcmFtZUNvbnRleHQodGhpcy5fY3VycmVudEZyYW1lQ29udGV4dCk7XG4gICAgICBpZiAoISFjdXJyZW50Um9vdEZyYW1lQ29udGV4dCkge1xuICAgICAgICB0aGlzLnRvZ2dsZUZvcm1TdGF0ZShhY3Rpb24sIGN1cnJlbnRSb290RnJhbWVDb250ZXh0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEN1cnJlbnRSb290RnJhbWVDb250ZXh0KGN1cnJlbnRGcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCk6IEZyYW1lQ29udGV4dCB7XG4gICAgbGV0IGN1cnJlbnRSb290RnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQ7XG4gICAgdGhpcy5nZXRBbGxSb290RnJhbWVDb250ZXh0KCkuZm9yRWFjaCgocm9vdEZjOiBGcmFtZUNvbnRleHQpID0+IHtcbiAgICAgIGlmIChjdXJyZW50RnJhbWVDb250ZXh0Lm5hbWVzcGFjZSA9PT0gcm9vdEZjLm5hbWVzcGFjZSkge1xuICAgICAgICBjdXJyZW50Um9vdEZyYW1lQ29udGV4dCA9IHJvb3RGYztcbiAgICAgIH1cbiAgICB9KVxuICAgIHJldHVybiBjdXJyZW50Um9vdEZyYW1lQ29udGV4dDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RnJhbWVDb250ZXh0TWFuYWdlck1hcCgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0KSB7XG4gICAgICBjb25zdCBhcHBDb250ZXh0ID0gdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmFwcENvbnRleHQgYXMgQXBwQ29udGV4dDtcbiAgICAgIGlmIChhcHBDb250ZXh0KSB7XG4gICAgICAgIGNvbnN0IGZyYW1lQ29udGV4dE1hbmFnZXIgPSBhcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXI7XG4gICAgICAgIHJldHVybiBmcmFtZUNvbnRleHRNYW5hZ2VyLmdldEZyYW1lQ29udGV4dE1hcCgpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgICAvLyByZXR1cm4gdGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmZyYW1lQ29udGV4dE1hbmFnZXIgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZnJhbWVDb250ZXh0TWFuYWdlci5nZXRGcmFtZUNvbnRleHRNYXAoKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QWxsUm9vdEZyYW1lQ29udGV4dCgpOiBhbnlbXSB7XG4gICAgY29uc3Qgcm9vdEZyYW1lQ29udGV4dEFyciA9IFtdO1xuICAgIGNvbnN0IGZyYW1lQ29udGV4dHMgPSB0aGlzLmdldEZyYW1lQ29udGV4dE1hbmFnZXJNYXAoKTtcbiAgICBpZiAoZnJhbWVDb250ZXh0cykge1xuICAgICAgZnJhbWVDb250ZXh0cy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBpZiAoKGl0ZW1bJ25hbWVzcGFjZSddID09PSAnJyAmJiBpdGVtWydwYXJlbnQnXSA9PT0gbnVsbCkgfHwgKGl0ZW1bJ3BhcmVudCddICE9PSBudWxsICYmIGl0ZW1bJ25hbWVzcGFjZSddICE9PSBpdGVtWydwYXJlbnQnXVsnbmFtZXNwYWNlJ10pKSB7XG4gICAgICAgICAgcm9vdEZyYW1lQ29udGV4dEFyci5wdXNoKGl0ZW0pO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgICByZXR1cm4gcm9vdEZyYW1lQ29udGV4dEFycjtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdEZvcm1TdGF0ZSgpIHtcbiAgICBpZiAoIXRoaXMuZ2V0RnJhbWVDb250ZXh0TWFuYWdlck1hcCgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuZ2V0QWxsUm9vdEZyYW1lQ29udGV4dCgpLmZvckVhY2goKHJvb3RGYzogRnJhbWVDb250ZXh0KSA9PiB7XG4gICAgICBjb25zdCByb290Q29tcG9uZW50ID0gcm9vdEZjLmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xuICAgICAgaWYgKCFyb290Q29tcG9uZW50IHx8ICFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgaWYgKCFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluY2x1ZGVzKHRoaXMuX2Nsc0RlZmF1bHROYW1lKSAmJiAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZS5pbmNsdWRlcygnZi1mb3JtLXN0YXRlLWNyZWF0ZScpICYmICFyb290Q29tcG9uZW50Lm5hdGl2ZUVsZW1lbnQuY2xhc3NOYW1lLmluY2x1ZGVzKCdmLWZvcm0tc3RhdGUtZWRpdCcpKSB7XG4gICAgICAgIHRoaXMuYWRkQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgdGhpcy5fY2xzRGVmYXVsdE5hbWUpO1xuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHRvZ2dsZUZvcm1TdGF0ZShhY3Rpb246IHN0cmluZywgZnJhbWVDb250ZXh0OiBGcmFtZUNvbnRleHQpIHtcbiAgICBjb25zdCByb290Q29tcG9uZW50ID0gZnJhbWVDb250ZXh0LmluamVjdG9yLmdldDxFbGVtZW50UmVmPihFbGVtZW50UmVmLCBudWxsKSB8fCBudWxsO1xuICAgIGlmICghcm9vdENvbXBvbmVudCB8fCAhcm9vdENvbXBvbmVudC5uYXRpdmVFbGVtZW50IHx8ICFhY3Rpb24pIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYWN0aW9uID0gYWN0aW9uLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKGFjdGlvbiAmJiBbJ2NyZWF0ZScsICdlZGl0J10uaW5jbHVkZXMoYWN0aW9uKSkge1xuICAgICAgaWYgKGFjdGlvbiA9PT0gJ2NyZWF0ZScpIHtcbiAgICAgICAgdGhpcy5hZGRDc3NDbGFzcyhyb290Q29tcG9uZW50LCAnZi1mb3JtLXN0YXRlLWNyZWF0ZScpO1xuICAgICAgfSBlbHNlIGlmIChhY3Rpb24gPT09ICdlZGl0Jykge1xuICAgICAgICB0aGlzLmFkZENzc0NsYXNzKHJvb3RDb21wb25lbnQsICdmLWZvcm0tc3RhdGUtZWRpdCcpO1xuICAgICAgfVxuICAgICAgdGhpcy5yZW1vdmVDc3NDbGFzcyhyb290Q29tcG9uZW50LCB0aGlzLl9jbHNEZWZhdWx0TmFtZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIFsnZi1mb3JtLXN0YXRlLWNyZWF0ZScsICdmLWZvcm0tc3RhdGUtZWRpdCddLmZvckVhY2goaXRlbSA9PiB0aGlzLnJlbW92ZUNzc0NsYXNzKHJvb3RDb21wb25lbnQsIGl0ZW0pKTtcbiAgICAgIHRoaXMuYWRkQ3NzQ2xhc3Mocm9vdENvbXBvbmVudCwgdGhpcy5fY2xzRGVmYXVsdE5hbWUpO1xuICAgIH1cbiAgfVxuICBwcml2YXRlIGFkZENzc0NsYXNzKGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsIGNsYXNzTmFtZTogc3RyaW5nKSB7XG4gICAgaWYgKCFlbGVtZW50UmVmIHx8ICFjbGFzc05hbWUgfHwgIWVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBvcmlnaW5hbENsYXNzTmFtZTogc3RyaW5nID0gZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsYXNzTmFtZSB8fCAnJztcbiAgICBpZiAoIW9yaWdpbmFsQ2xhc3NOYW1lLmluY2x1ZGVzKGNsYXNzTmFtZSkpIHtcbiAgICAgIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgPSBgJHtvcmlnaW5hbENsYXNzTmFtZX0gJHtjbGFzc05hbWV9YDtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSByZW1vdmVDc3NDbGFzcyhlbGVtZW50UmVmOiBFbGVtZW50UmVmLCBjbGFzc05hbWU6IHN0cmluZykge1xuICAgIGlmICghZWxlbWVudFJlZiB8fCAhY2xhc3NOYW1lIHx8ICFlbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3Qgb3JpZ2luYWxDbGFzc05hbWU6IHN0cmluZyA9IGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgfHwgJyc7XG4gICAgaWYgKG9yaWdpbmFsQ2xhc3NOYW1lLmluY2x1ZGVzKGNsYXNzTmFtZSkpIHtcbiAgICAgIGVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jbGFzc05hbWUgPSBvcmlnaW5hbENsYXNzTmFtZS5zcGxpdCgnICcpLmZpbHRlcihwID0+IHAgJiYgcCAhPT0gY2xhc3NOYW1lKS5qb2luKCcgJyk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgZ2V0Rm9ybVJvb3RDb21wb25lbnQoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGVNYWNoaW5lICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dCkge1xuICAgICAgY29uc3Qgdmlld0NvbnRleHQgPSB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQ7XG4gICAgICBpZiAodmlld0NvbnRleHQpIHtcbiAgICAgICAgY29uc3QgdmlydHVhbFJvb3RDb250ZXh0ID0gdmlld0NvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKTtcbiAgICAgICAgaWYgKHZpcnR1YWxSb290Q29udGV4dCkge1xuICAgICAgICAgIGNvbnN0IGluamVjdG9yID0gdmlydHVhbFJvb3RDb250ZXh0LmluamVjdG9yO1xuICAgICAgICAgIGlmICh0eXBlb2YgaW5qZWN0b3IuZ2V0ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICByZXR1cm4gaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgICAvLyByZXR1cm4gdGhpcy5zdGF0ZU1hY2hpbmUgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0ICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpICYmIHRoaXMuc3RhdGVNYWNoaW5lLmZyYW1lQ29udGV4dC5nZXRWaXJ0dWFsUm9vdEZyYW1lQ29udGV4dCgpLmluamVjdG9yICYmIHR5cGVvZiB0aGlzLnN0YXRlTWFjaGluZS5mcmFtZUNvbnRleHQuZ2V0VmlydHVhbFJvb3RGcmFtZUNvbnRleHQoKS5pbmplY3Rvci5nZXQgPT09ICdmdW5jdGlvbicgJiYgdGhpcy5zdGF0ZU1hY2hpbmUuZnJhbWVDb250ZXh0LmdldFZpcnR1YWxSb290RnJhbWVDb250ZXh0KCkuaW5qZWN0b3IuZ2V0PEVsZW1lbnRSZWY+KEVsZW1lbnRSZWYsIG51bGwpIHx8IG51bGw7XG4gIH1cbn1cblxuZXhwb3J0IHsgU3RhdGVNYWNoaW5lU2VydmljZSB9O1xuIl19