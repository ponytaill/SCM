import * as tslib_1 from "tslib";
import { InjectionToken } from '@angular/core';
import { Subject, BehaviorSubject, EMPTY } from 'rxjs';
import { concatMap, map, takeLast, take, takeUntil, throwIfEmpty } from 'rxjs/operators';
import { CommandContext } from './command_context';
import { TaskFlow } from './flow/index';
import { TranslateToken } from '../i18n/translate_token';
/**
 * 命令处理抽象类，所有具体的命令处理类必须继承它，并实现schedule方法。
 */
var CommandHandler = /** @class */ (function () {
    /**
     * 构造函数
     */
    function CommandHandler() {
        this.destroy$ = new Subject();
    }
    CommandHandler.prototype.dispose = function (options) {
        if (this.destroy$) {
            this.destroy$.next();
            this.destroy$.complete();
        }
        this.frameContext = null;
    };
    CommandHandler.prototype.ngOnDestroy = function () {
        this.dispose();
    };
    /**
     * 初始化
     */
    CommandHandler.prototype.init = function (frameContext, variableParseService) {
        this.frameContext = frameContext;
        this.parseService = variableParseService;
        this.taskFlow = new TaskFlow();
        this.schedule();
    };
    /**
     * 执行任务
     * @param command 要执行的命令
     * @return 最后一个任务的执行结果
     * @todo：按功能拆分小函数
     */
    CommandHandler.prototype.execute = function (command) {
        var _this = this;
        var lastTaskResult$ = new Subject();
        var taskFlow = this.taskFlow.clone();
        // setTimeout暂时不能去掉的原因：
        // 1、树表单加载数据，依赖TreeTableBinding里设置的全局变量，需要延后执行加载时机；
        // 2、关闭前命令需要延迟执行。
        setTimeout(function () {
            if (!_this.frameContext || _this.frameContext.isDisposed) {
                return EMPTY;
            }
            // 1、解析参数
            // 避免解析变量时修改了原始的command
            var _a = tslib_1.__assign({}, command).eventParam, eventParam = _a === void 0 ? null : _a;
            delete command.eventParam;
            var commandToExecute = JSON.parse(JSON.stringify(command));
            commandToExecute.params = _this.paramsTransform(commandToExecute.params);
            commandToExecute.params = _this.parseService.parse(commandToExecute.params, _this.frameContext, eventParam);
            command.eventParam = eventParam;
            commandToExecute.eventParam = eventParam;
            _this.transParamTypes(commandToExecute.params, commandToExecute.paramDescriptions);
            // 2、串联任务流
            var initContext = new CommandContext(commandToExecute, _this.frameContext);
            initContext.eventParam = command.eventParam || null;
            var context$ = new BehaviorSubject(initContext);
            var currentTask = taskFlow.getNext('', initContext);
            var highOrder$ = context$.pipe(concatMap(function (context) {
                var result$ = currentTask.execute(context);
                return result$.pipe(take(1), map(function (result) {
                    // 写入执行结果
                    context.results[currentTask.name] = result;
                    context.latestResult = result;
                    currentTask = taskFlow.getNext(currentTask.name, context);
                    // 操作控制流
                    if (currentTask) {
                        context$.next(context);
                    }
                    else {
                        context$.complete();
                    }
                    // 将结果流转换为context流
                    return context;
                }), throwIfEmpty(function () {
                    context$.complete();
                }));
            }));
            // 3、执行合并后的任务流
            highOrder$.pipe(takeLast(1)).subscribe({
                next: function (context) {
                    _this.waitForDestroy(context);
                    lastTaskResult$.next(context.latestResult);
                },
                error: function (error) {
                    _this.waitForDestroy(initContext);
                    _this.displayError(error);
                    lastTaskResult$.error(error || '');
                },
                complete: function () {
                    _this.waitForDestroy(initContext);
                    lastTaskResult$.complete();
                },
            });
        }, 0);
        return lastTaskResult$;
    };
    /**
     * 等待销毁
     * @param commandContext
     */
    CommandHandler.prototype.waitForDestroy = function (commandContext) {
        if (!commandContext) {
            return;
        }
        commandContext.clearResults();
        if (this.frameContext && this.frameContext.appContext && this.frameContext.appContext.destorySignal) {
            this.frameContext.appContext.destorySignal.pipe(takeUntil(this.destroy$)).subscribe(function () {
                if (commandContext) {
                    commandContext.dispose();
                    commandContext = null;
                }
            });
        }
    };
    /**
     * 显示错误信息
     */
    CommandHandler.prototype.displayError = function (error) {
        if (!error) {
            return;
        }
        if (!console || !console.error) {
            return;
        }
        console.error(error);
    };
    /**
     * 参数国际化转换方法
     */
    CommandHandler.prototype.paramsTransform = function (params) {
        var exp = /\{\{(\w+)\}\}/g;
        if (!params) {
            return null;
        }
        var translateService = this.frameContext && this.frameContext.injector && this.frameContext.injector.get(TranslateToken, null) || null;
        var pArray = Object.keys(params);
        var result = {};
        if (pArray.length === 0) {
            return params;
        }
        pArray.forEach(function (p) {
            var ele = params[p];
            if (ele && exp.test(ele) && translateService) {
                ele = ele.replace(exp, function ($1, $2) {
                    return translateService.transform($2, null);
                });
            }
            result[p] = ele;
        });
        return result;
    };
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    CommandHandler.prototype.addTask = function (name, func) {
        this.taskFlow.addNode(name, func);
    };
    /**
     * 添加任务，只有子类可以添加任务，外部不能访问
     * @param name  任务名称
     * @param func 任务函数
     */
    CommandHandler.prototype.addLink = function (from, to, condition) {
        this.taskFlow.addLink(from, to, condition);
    };
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    CommandHandler.prototype.insertTask = function (target, name, func) {
        throw new Error('Not Implemented');
    };
    /**
     * 插入任务
     * @param  name 要扩展的任务名称
     * @param  func 扩展函数
     */
    CommandHandler.prototype.afterTask = function (target, name, func) {
        throw new Error('Not Implemented');
    };
    /**
     * 替换任务
     * @param  name 要替换的任务名称
     * @param  func 替换函数
     */
    CommandHandler.prototype.replaceTask = function (name, func) {
        throw new Error('Not Implement');
    };
    /**
     * 调用方法
     */
    CommandHandler.prototype.invoke = function (serviceInstance, method, args, context) {
        this.setContextToServiceInstance(serviceInstance, context);
        var parsedArgs = this.parseService.parse(args, context, context.eventParam);
        return serviceInstance[method].apply(serviceInstance, tslib_1.__spread(parsedArgs));
    };
    /**
     * 为服务设置命令上下文
     * @todo
     * 通过这种方式存在很大问题：
     * 1、会覆盖掉已有的context，给开发人员造成困扰和调试成本；
     * 2、服务中依赖了一个没有声明的对象，不符合面向对象的原则。
     * 建议解决方案：
     * 1、将context修改为某个特殊属性名；
     * 2、先检测服务上有没有一个CommandContext类型的context属性，有的话再赋值，
     *    这就要求需要使用context的服务需要是实现一个IContext接口。
     */
    CommandHandler.prototype.setContextToServiceInstance = function (serviceInstance, context) {
        // 如果服务上已经存在context属性，并且该属性不是CommandContext类型，则不能覆盖
        var serviceContext = serviceInstance.context;
        if (serviceContext && (serviceContext instanceof CommandContext === false)) {
            return;
        }
        serviceInstance.context = context;
    };
    /**
     * 根据参数描述信息转换参数类型
     */
    CommandHandler.prototype.transParamTypes = function (params, paramDescriptions) {
        if (!paramDescriptions) {
            return;
        }
        var keys = Object.keys(params);
        keys.forEach(function (key) {
            if (!paramDescriptions[key] || !paramDescriptions[key].type) {
                return;
            }
            var parType = paramDescriptions[key].type;
            var value = params[key];
            if (value === undefined || value === null || typeof value === parType) {
                return; // 值不存在或类型匹配，无需处理
            }
            switch (parType) {
                case 'string':
                    // 其实转换前的参数都是string，这里不会走到
                    params[key] = value + '';
                    break;
                case 'int':
                case 'double':
                case 'number':
                    // 前端数值类型只有number，这里兼容命令构件上设置为int和double的情况
                    var numResult = Number(value);
                    if (isNaN(numResult)) {
                        throw Error("\u7C7B\u578B\u8F6C\u6362\u5931\u8D25\uFF0C\u53C2\u6570" + key + "\u503C\u4E3A" + value + "\uFF0C\u65E0\u6CD5\u8F6C\u6362\u4E3A" + parType + "\u7C7B\u578B\u3002");
                    }
                    params[key] = numResult;
                    break;
                case 'boolean':
                    var boolResult = void 0;
                    var strValue = (value + '').toLowerCase();
                    if (strValue === 'true') {
                        boolResult = true;
                    }
                    else if (strValue === 'false') {
                        boolResult = false;
                    }
                    else {
                        throw Error("\u7C7B\u578B\u8F6C\u6362\u5931\u8D25\uFF0C\u53C2\u6570" + key + "\u503C\u4E3A" + value + "\uFF0C\u65E0\u6CD5\u8F6C\u6362\u4E3A" + parType + "\u7C7B\u578B\u3002");
                    }
                    params[key] = boolResult;
                    break;
                case 'datetime':
                    // todo：日期时间暂不处理
                    break;
                case 'object':
                    // 表达式解析出来的参数，无需处理，按原类型返回
                    // todo: 输入参数是个json串，转成object
                    break;
                default:
                    break;
            }
        });
    };
    return CommandHandler;
}());
/**
 * 命令处理器注入Token
 */
var COMMAND_HANDLERS_TOKEN = new InjectionToken('@Farris Command Handlers');
export { CommandHandler, COMMAND_HANDLERS_TOKEN };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZF9oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGZhcnJpcy9kZXZraXQvIiwic291cmNlcyI6WyJsaWIvY29tbWFuZC9jb21tYW5kX2hhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQWlDLE1BQU0sZUFBZSxDQUFDO0FBQzlFLE9BQU8sRUFBYyxPQUFPLEVBQUUsZUFBZSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRSxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQU16RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFZLFFBQVEsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJekQ7O0dBRUc7QUFDSDtJQW1CRTs7T0FFRztJQUNIO1FBSlEsYUFBUSxHQUFpQixJQUFJLE9BQU8sRUFBTyxDQUFDO0lBS3BELENBQUM7SUFDRCxnQ0FBTyxHQUFQLFVBQVEsT0FBYTtRQUNuQixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQzFCO1FBQ0QsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7SUFDM0IsQ0FBQztJQUNELG9DQUFXLEdBQVg7UUFDRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDakIsQ0FBQztJQU9EOztPQUVHO0lBQ0ksNkJBQUksR0FBWCxVQUFZLFlBQTBCLEVBQUUsb0JBQTBDO1FBQ2hGLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLElBQUksQ0FBQyxZ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QkFDWCx5QkFBeUI7b0JBQ3pCLDZCQUE2QjtvQkFDN0IsTUFBTTtnQkFDUjtvQkFDRSxNQUFNO2FBQ1Q7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFSCxxQkFBQztBQUFELENBQUMsQUEzVUQsSUEyVUM7QUFFRDs7R0FFRztBQUNILElBQU0sc0JBQXNCLEdBQUcsSUFBSSxjQUFjLENBQWlCLDBCQUEwQixDQUFDLENBQUM7QUFFOUYsT0FBTyxFQUFFLGNBQWMsRUFBRSxzQkFBc0IsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0aW9uVG9rZW4sIE9wdGlvbmFsLCBJbmplY3RvciwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgRU1QVFkgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgY29uY2F0TWFwLCBtYXAsIHRha2VMYXN0LCB0YWtlLCB0YWtlVW50aWwsIHRocm93SWZFbXB0eSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IEZyYW1lQ29udGV4dCB9IGZyb20gJy4uL2ZyYW1lL2luZGV4JztcclxuaW1wb3J0IHsgVmFyaWFibGVQYXJzZVNlcnZpY2UgfSBmcm9tICcuLi92YXJpYWJsZS9pbmRleCc7XHJcblxyXG5pbXBvcnQgeyBDb21tYW5kLCBDb21tYW5kUGFyYW1zLCBQYXJhbURlc2NyaXB0aW9ucyB9IGZyb20gJy4vY29tbWFuZCc7XHJcbmltcG9ydCB7IENvbW1hbmRDb250ZXh0IH0gZnJvbSAnLi9jb21tYW5kX2NvbnRleHQnO1xyXG5pbXBvcnQgeyBUYXNrRnVuYywgVGFza0Zsb3cgfSBmcm9tICcuL2Zsb3cvaW5kZXgnO1xyXG5pbXBvcnQgeyBUcmFuc2xhdGVUb2tlbiB9IGZyb20gJy4uL2kxOG4vdHJhbnNsYXRlX3Rva2VuJztcclxuaW1wb3J0IHsgVHJhbnNsYXRlIH0gZnJvbSAnLi4vaTE4bi90cmFuc2xhdGUnO1xyXG5pbXBvcnQgeyBJRGlzcG9zYWJsZSB9IGZyb20gJy4uL2NvcmUnO1xyXG5cclxuLyoqXHJcbiAqIOWRveS7pOWkhOeQhuaKveixoeexu++8jOaJgOacieWFt+S9k+eahOWRveS7pOWkhOeQhuexu+W/hemhu+e7p+aJv+Wug++8jOW5tuWunueOsHNjaGVkdWxl5pa55rOV44CCXHJcbiAqL1xyXG5hYnN0cmFjdCBjbGFzcyBDb21tYW5kSGFuZGxlciBpbXBsZW1lbnRzIElEaXNwb3NhYmxlLCBPbkRlc3Ryb3kge1xyXG5cclxuICAvKipcclxuICAgKiDku7vliqHmtYHnqIvlm75cclxuICAgKi9cclxuICBwcml2YXRlIHRhc2tGbG93OiBUYXNrRmxvdztcclxuXHJcbiAgLyoqXHJcbiAgICog5LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGZyYW1lQ29udGV4dDogRnJhbWVDb250ZXh0O1xyXG5cclxuICAvKipcclxuICAgKiDlj5jph4/op6PmnpDmnI3liqFcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcGFyc2VTZXJ2aWNlOiBWYXJpYWJsZVBhcnNlU2VydmljZTtcclxuXHJcbiAgcHVibGljIGNvbW1hbmROYW1lOiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBkZXN0cm95JDogU3ViamVjdDxhbnk+ID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gIH1cclxuICBkaXNwb3NlKG9wdGlvbnM/OiBhbnkpIHtcclxuICAgIGlmICh0aGlzLmRlc3Ryb3kkKSB7XHJcbiAgICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xyXG4gICAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dCA9IG51bGw7XHJcbiAgfVxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdGhpcy5kaXNwb3NlKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDmiafooYzmtYHnqItcclxuICAgKi9cclxuICBhYnN0cmFjdCBzY2hlZHVsZSgpO1xyXG5cclxuICAvKipcclxuICAgKiDliJ3lp4vljJZcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdChmcmFtZUNvbnRleHQ6IEZyYW1lQ29udGV4dCwgdmFyaWFibGVQYXJzZVNlcnZpY2U6IFZhcmlhYmxlUGFyc2VTZXJ2aWNlKSB7XHJcbiAgICB0aGlzLmZyYW1lQ29udGV4dCA9IGZyYW1lQ29udGV4dDtcclxuICAgIHRoaXMucGFyc2VTZXJ2aWNlID0gdmFyaWFibGVQYXJzZVNlcnZpY2U7XHJcbiAgICB0aGlzLnRhc2tGbG93ID0gbmV3IFRhc2tGbG93KCk7XHJcbiAgICB0aGlzLnNjaGVkdWxlKCk7XHJcblxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5omn6KGM5Lu75YqhXHJcbiAgICogQHBhcmFtIGNvbW1hbmQg6KaB5omn6KGM55qE5ZG95LukXHJcbiAgICogQHJldHVybiDmnIDlkI7kuIDkuKrku7vliqHnmoTmiafooYznu5PmnpxcclxuICAgKiBAdG9kb++8muaMieWKn+iDveaLhuWIhuWwj+WHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBleGVjdXRlKGNvbW1hbmQ6IENvbW1hbmQpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgbGFzdFRhc2tSZXN1bHQkID0gbmV3IFN1YmplY3QoKTtcclxuICAgIGNvbnN0IHRhc2tGbG93ID0gdGhpcy50YXNrRmxvdy5jbG9uZSgpO1xyXG5cclxuICAgIC8vIHNldFRpbWVvdXTmmoLml7bkuI3og73ljrvmjonnmoTljp/lm6DvvJpcclxuICAgIC8vIDHjgIHmoJHooajljZXliqDovb3mlbDmja7vvIzkvp3otZZUcmVlVGFibGVCaW5kaW5n6YeM6K6+572u55qE5YWo5bGA5Y+Y6YeP77yM6ZyA6KaB5bu25ZCO5omn6KGM5Yqg6L295pe25py677ybXHJcbiAgICAvLyAy44CB5YWz6Zet5YmN5ZG95Luk6ZyA6KaB5bu26L+f5omn6KGM44CCXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgaWYgKCF0aGlzLmZyYW1lQ29udGV4dCB8fCB0aGlzLmZyYW1lQ29udGV4dC5pc0Rpc3Bvc2VkKSB7XHJcbiAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICB9XHJcbiAgICAgIC8vIDHjgIHop6PmnpDlj4LmlbBcclxuICAgICAgLy8g6YG/5YWN6Kej5p6Q5Y+Y6YeP5pe25L+u5pS55LqG5Y6f5aeL55qEY29tbWFuZFxyXG4gICAgICBjb25zdCB7IGV2ZW50UGFyYW0gPSBudWxsIH0gPSB7XHJcbiAgICAgICAgLi4uY29tbWFuZFxyXG4gICAgICB9O1xyXG4gICAgICBkZWxldGUgY29tbWFuZC5ldmVudFBhcmFtO1xyXG4gICAgICBjb25zdCBjb21tYW5kVG9FeGVjdXRlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShjb21tYW5kKSk7XHJcbiAgICAgIGNvbW1hbmRUb0V4ZWN1dGUucGFyYW1zID0gdGhpcy5wYXJhbXNUcmFuc2Zvcm0oY29tbWFuZFRvRXhlY3V0ZS5wYXJhbXMpO1xyXG4gICAgICBjb21tYW5kVG9FeGVjdXRlLnBhcmFtcyA9IHRoaXMucGFyc2VTZXJ2aWNlLnBhcnNlKGNvbW1hbmRUb0V4ZWN1dGUucGFyYW1zLCB0aGlzLmZyYW1lQ29udGV4dCwgZXZlbnRQYXJhbSk7XHJcbiAgICAgIGNvbW1hbmQuZXZlbnRQYXJhbSA9IGV2ZW50UGFyYW07XHJcbiAgICAgIGNvbW1hbmRUb0V4ZWN1dGUuZXZlbnRQYXJhbSA9IGV2ZW50UGFyYW07XHJcbiAgICAgIHRoaXMudHJhbnNQYXJhbVR5cGVzKGNvbW1hbmRUb0V4ZWN1dGUucGFyYW1zLCBjb21tYW5kVG9FeGVjdXRlLnBhcmFtRGVzY3JpcHRpb25zKTtcclxuXHJcbiAgICAgIC8vIDLjgIHkuLLogZTku7vliqHmtYFcclxuICAgICAgY29uc3QgaW5pdENvbnRleHQgPSBuZXcgQ29tbWFuZENvbnRleHQoY29tbWFuZFRvRXhlY3V0ZSwgdGhpcy5mcmFtZUNvbnRleHQpO1xyXG4gICAgICBpbml0Q29udGV4dC5ldmVudFBhcmFtID0gY29tbWFuZC5ldmVudFBhcmFtIHx8IG51bGw7XHJcbiAgICAgIGNvbnN0IGNvbnRleHQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDb21tYW5kQ29udGV4dD4oaW5pdENvbnRleHQpO1xyXG4gICAgICBsZXQgY3VycmVudFRhc2sgPSB0YXNrRmxvdy5nZXROZXh0KCcnLCBpbml0Q29udGV4dCk7XHJcbiAgICAgIGNvbnN0IGhpZ2hPcmRlciQgPSBjb250ZXh0JC5waXBlKFxyXG4gICAgICAgIGNvbmNhdE1hcCgoY29udGV4dDogQ29tbWFuZENvbnRleHQpID0+IHtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCQgPSBjdXJyZW50VGFzay5leGVjdXRlKGNvbnRleHQpO1xyXG4gICAgICAgICAgcmV0dXJuIHJlc3VsdCQucGlwZShcclxuICAgICAgICAgICAgdGFrZSgxKSxcclxuICAgICAgICAgICAgbWFwKChyZXN1bHQ6IGFueSkgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAvLyDlhpnlhaXmiafooYznu5PmnpxcclxuICAgICAgICAgICAgICBjb250ZXh0LnJlc3VsdHNbY3VycmVudFRhc2submFtZV0gPSByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgY29udGV4dC5sYXRlc3RSZXN1bHQgPSByZXN1bHQ7XHJcbiAgICAgICAgICAgICAgY3VycmVudFRhc2sgPSB0YXNrRmxvdy5nZXROZXh0KGN1cnJlbnRUYXNrLm5hbWUsIGNvbnRleHQpO1xyXG5cclxuICAgICAgICAgICAgICAvLyDmk43kvZzmjqfliLbmtYFcclxuICAgICAgICAgICAgICBpZiAoY3VycmVudFRhc2spIHtcclxuICAgICAgICAgICAgICAgIGNvbnRleHQkLm5leHQoY29udGV4dCk7XHJcbiAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnRleHQkLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAvLyDlsIbnu5PmnpzmtYHovazmjaLkuLpjb250ZXh05rWBXHJcbiAgICAgICAgICAgICAgcmV0dXJuIGNvbnRleHQ7XHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICB0aHJvd0lmRW1wdHkoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIGNvbnRleHQkLmNvbXBsZXRlKCk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICApO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICk7XHJcblxyXG4gICAgICAvLyAz44CB5omn6KGM5ZCI5bm25ZCO55qE5Lu75Yqh5rWBXHJcbiAgICAgIGhpZ2hPcmRlciQucGlwZShcclxuICAgICAgICB0YWtlTGFzdCgxKVxyXG4gICAgICApLnN1YnNjcmliZSh7XHJcbiAgICAgICAgbmV4dDogKGNvbnRleHQ6IENvbW1hbmRDb250ZXh0KSA9PiB7XHJcbiAgICAgICAgICB0aGlzLndhaXRGb3JEZXN0cm95KGNvbnRleHQpO1xyXG4gICAgICAgICAgbGFzdFRhc2tSZXN1bHQkLm5leHQoY29udGV4dC5sYXRlc3RSZXN1bHQpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZXJyb3I6IChlcnJvcjogYW55KSA9PiB7XHJcbiAgICAgICAgICB0aGlzLndhaXRGb3JEZXN0cm95KGluaXRDb250ZXh0KTtcclxuICAgICAgICAgICAgdGhpcy5kaXNwbGF5RXJyb3IoZXJyb3IpO1xyXG4gICAgICAgICAgbGFzdFRhc2tSZXN1bHQkLmVycm9yKGVycm9yIHx8ICcnKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGNvbXBsZXRlOiAoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLndhaXRGb3JEZXN0cm95KGluaXRDb250ZXh0KTtcclxuICAgICAgICAgIGxhc3RUYXNrUmVzdWx0JC5jb21wbGV0ZSgpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG5cclxuICAgIH0sIDApO1xyXG5cclxuICAgIHJldHVybiBsYXN0VGFza1Jlc3VsdCQ7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOetieW+hemUgOavgVxyXG4gICAqIEBwYXJhbSBjb21tYW5kQ29udGV4dCBcclxuICAgKi9cclxuICBwcml2YXRlIHdhaXRGb3JEZXN0cm95KGNvbW1hbmRDb250ZXh0OiBDb21tYW5kQ29udGV4dCkge1xyXG4gICAgaWYgKCFjb21tYW5kQ29udGV4dCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBjb21tYW5kQ29udGV4dC5jbGVhclJlc3VsdHMoKTtcclxuICAgIGlmICh0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0ICYmIHRoaXMuZnJhbWVDb250ZXh0LmFwcENvbnRleHQuZGVzdG9yeVNpZ25hbCkge1xyXG4gICAgICB0aGlzLmZyYW1lQ29udGV4dC5hcHBDb250ZXh0LmRlc3RvcnlTaWduYWwucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgaWYgKGNvbW1hbmRDb250ZXh0KSB7XHJcbiAgICAgICAgICBjb21tYW5kQ29udGV4dC5kaXNwb3NlKCk7XHJcbiAgICAgICAgICBjb21tYW5kQ29udGV4dCA9IG51bGw7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcbiAgLyoqXHJcbiAgICog5pi+56S66ZSZ6K+v5L+h5oGvXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBkaXNwbGF5RXJyb3IoZXJyb3I6IGFueSkge1xyXG4gICAgaWYgKCFlcnJvcikge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBpZiAoIWNvbnNvbGUgfHwgIWNvbnNvbGUuZXJyb3IpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc29sZS5lcnJvcihlcnJvcik7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIOWPguaVsOWbvemZheWMlui9rOaNouaWueazlVxyXG4gICAqL1xyXG4gIHByaXZhdGUgcGFyYW1zVHJhbnNmb3JtKHBhcmFtczogb2JqZWN0KSB7XHJcbiAgICBjb25zdCBleHAgPSAvXFx7XFx7KFxcdyspXFx9XFx9L2c7XHJcbiAgICBpZiAoIXBhcmFtcykge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHRyYW5zbGF0ZVNlcnZpY2UgPSB0aGlzLmZyYW1lQ29udGV4dCAmJiB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3RvciAmJiB0aGlzLmZyYW1lQ29udGV4dC5pbmplY3Rvci5nZXQ8VHJhbnNsYXRlPihUcmFuc2xhdGVUb2tlbiwgbnVsbCkgfHwgbnVsbDtcclxuICAgIGNvbnN0IHBBcnJheSA9IE9iamVjdC5rZXlzKHBhcmFtcyk7XHJcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcclxuICAgIGlmIChwQXJyYXkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHJldHVybiBwYXJhbXM7XHJcbiAgICB9XHJcbiAgICBwQXJyYXkuZm9yRWFjaCgocCkgPT4ge1xyXG4gICAgICBsZXQgZWxlID0gcGFyYW1zW3BdO1xyXG4gICAgICBpZiAoZWxlICYmIGV4cC50ZXN0KGVsZSkgJiYgdHJhbnNsYXRlU2VydmljZSkge1xyXG4gICAgICAgIGVsZSA9IGVsZS5yZXBsYWNlKGV4cCwgKCQxLCAkMikgPT4ge1xyXG4gICAgICAgICAgcmV0dXJuIHRyYW5zbGF0ZVNlcnZpY2UudHJhbnNmb3JtKCQyLCBudWxsKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgICByZXN1bHRbcF0gPSBlbGU7XHJcblxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOa3u+WKoOS7u+WKoe+8jOWPquacieWtkOexu+WPr+S7pea3u+WKoOS7u+WKoe+8jOWklumDqOS4jeiDveiuv+mXrlxyXG4gICAqIEBwYXJhbSBuYW1lICDku7vliqHlkI3np7BcclxuICAgKiBAcGFyYW0gZnVuYyDku7vliqHlh73mlbBcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgYWRkVGFzayhuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XHJcbiAgICB0aGlzLnRhc2tGbG93LmFkZE5vZGUobmFtZSwgZnVuYyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmt7vliqDku7vliqHvvIzlj6rmnInlrZDnsbvlj6/ku6Xmt7vliqDku7vliqHvvIzlpJbpg6jkuI3og73orr/pl65cclxuICAgKiBAcGFyYW0gbmFtZSAg5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtIGZ1bmMg5Lu75Yqh5Ye95pWwXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIGFkZExpbmsoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nLCBjb25kaXRpb246IHN0cmluZyB8IGJvb2xlYW4pIHtcclxuICAgIHRoaXMudGFza0Zsb3cuYWRkTGluayhmcm9tLCB0bywgY29uZGl0aW9uKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOaPkuWFpeS7u+WKoVxyXG4gICAqIEBwYXJhbSAgbmFtZSDopoHmianlsZXnmoTku7vliqHlkI3np7BcclxuICAgKiBAcGFyYW0gIGZ1bmMg5omp5bGV5Ye95pWwXHJcbiAgICovXHJcbiAgcHVibGljIGluc2VydFRhc2sodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmj5LlhaXku7vliqFcclxuICAgKiBAcGFyYW0gIG5hbWUg6KaB5omp5bGV55qE5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtICBmdW5jIOaJqeWxleWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZnRlclRhc2sodGFyZ2V0OiBzdHJpbmcsIG5hbWU6IHN0cmluZywgZnVuYzogVGFza0Z1bmMpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignTm90IEltcGxlbWVudGVkJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmm7/mjaLku7vliqFcclxuICAgKiBAcGFyYW0gIG5hbWUg6KaB5pu/5o2i55qE5Lu75Yqh5ZCN56ewXHJcbiAgICogQHBhcmFtICBmdW5jIOabv+aNouWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyByZXBsYWNlVGFzayhuYW1lOiBzdHJpbmcsIGZ1bmM6IFRhc2tGdW5jKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdCBJbXBsZW1lbnQnKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOiwg+eUqOaWueazlVxyXG4gICAqL1xyXG4gIHB1YmxpYyBpbnZva2Uoc2VydmljZUluc3RhbmNlOiBhbnksIG1ldGhvZDogc3RyaW5nLCBhcmdzOiBhbnlbXSwgY29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuICAgIHRoaXMuc2V0Q29udGV4dFRvU2VydmljZUluc3RhbmNlKHNlcnZpY2VJbnN0YW5jZSwgY29udGV4dCk7XHJcbiAgICBjb25zdCBwYXJzZWRBcmdzID0gdGhpcy5wYXJzZVNlcnZpY2UucGFyc2UoYXJncywgY29udGV4dCwgY29udGV4dC5ldmVudFBhcmFtKTtcclxuICAgIHJldHVybiBzZXJ2aWNlSW5zdGFuY2VbbWV0aG9kXSguLi5wYXJzZWRBcmdzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOS4uuacjeWKoeiuvue9ruWRveS7pOS4iuS4i+aWh1xyXG4gICAqIEB0b2RvXHJcbiAgICog6YCa6L+H6L+Z56eN5pa55byP5a2Y5Zyo5b6I5aSn6Zeu6aKY77yaXHJcbiAgICogMeOAgeS8muimhuebluaOieW3suacieeahGNvbnRleHTvvIznu5nlvIDlj5HkurrlkZjpgKDmiJDlm7DmibDlkozosIPor5XmiJDmnKzvvJtcclxuICAgKiAy44CB5pyN5Yqh5Lit5L6d6LWW5LqG5LiA5Liq5rKh5pyJ5aOw5piO55qE5a+56LGh77yM5LiN56ym5ZCI6Z2i5ZCR5a+56LGh55qE5Y6f5YiZ44CCXHJcbiAgICog5bu66K6u6Kej5Yaz5pa55qGI77yaXHJcbiAgICogMeOAgeWwhmNvbnRleHTkv67mlLnkuLrmn5DkuKrnibnmrorlsZ7mgKflkI3vvJtcclxuICAgKiAy44CB5YWI5qOA5rWL5pyN5Yqh5LiK5pyJ5rKh5pyJ5LiA5LiqQ29tbWFuZENvbnRleHTnsbvlnovnmoRjb250ZXh05bGe5oCn77yM5pyJ55qE6K+d5YaN6LWL5YC877yMXHJcbiAgICogICAg6L+Z5bCx6KaB5rGC6ZyA6KaB5L2/55SoY29udGV4dOeahOacjeWKoemcgOimgeaYr+WunueOsOS4gOS4qklDb250ZXh05o6l5Y+j44CCXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHNldENvbnRleHRUb1NlcnZpY2VJbnN0YW5jZShzZXJ2aWNlSW5zdGFuY2U6IGFueSwgY29udGV4dDogQ29tbWFuZENvbnRleHQpIHtcclxuXHJcbiAgICAvLyDlpoLmnpzmnI3liqHkuIrlt7Lnu4/lrZjlnKhjb250ZXh05bGe5oCn77yM5bm25LiU6K+l5bGe5oCn5LiN5pivQ29tbWFuZENvbnRleHTnsbvlnovvvIzliJnkuI3og73opobnm5ZcclxuICAgIGNvbnN0IHNlcnZpY2VDb250ZXh0ID0gc2VydmljZUluc3RhbmNlLmNvbnRleHQ7XHJcbiAgICBpZiAoc2VydmljZUNvbnRleHQgJiYgKHNlcnZpY2VDb250ZXh0IGluc3RhbmNlb2YgQ29tbWFuZENvbnRleHQgPT09IGZhbHNlKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgc2VydmljZUluc3RhbmNlLmNvbnRleHQgPSBjb250ZXh0O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5qC55o2u5Y+C5pWw5o+P6L+w5L+h5oGv6L2s5o2i5Y+C5pWw57G75Z6LXHJcbiAgICovXHJcbiAgcHJpdmF0ZSB0cmFuc1BhcmFtVHlwZXMocGFyYW1zOiBDb21tYW5kUGFyYW1zLCBwYXJhbURlc2NyaXB0aW9uczogUGFyYW1EZXNjcmlwdGlvbnMpIHtcclxuICAgIGlmICghcGFyYW1EZXNjcmlwdGlvbnMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG4gICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHBhcmFtcyk7XHJcbiAgICBrZXlzLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgaWYgKCFwYXJhbURlc2NyaXB0aW9uc1trZXldIHx8ICFwYXJhbURlc2NyaXB0aW9uc1trZXldLnR5cGUpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHBhclR5cGUgPSBwYXJhbURlc2NyaXB0aW9uc1trZXldLnR5cGU7XHJcbiAgICAgIGNvbnN0IHZhbHVlID0gcGFyYW1zW2tleV07XHJcbiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gcGFyVHlwZSkge1xyXG4gICAgICAgIHJldHVybjsgLy8g5YC85LiN5a2Y5Zyo5oiW57G75Z6L5Yy56YWN77yM5peg6ZyA5aSE55CGXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHN3aXRjaCAocGFyVHlwZSkge1xyXG4gICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAvLyDlhbblrp7ovazmjaLliY3nmoTlj4LmlbDpg73mmK9zdHJpbmfvvIzov5nph4zkuI3kvJrotbDliLBcclxuICAgICAgICAgIHBhcmFtc1trZXldID0gdmFsdWUgKyAnJztcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2ludCc6XHJcbiAgICAgICAgY2FzZSAnZG91YmxlJzpcclxuICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgLy8g5YmN56uv5pWw5YC857G75Z6L5Y+q5pyJbnVtYmVy77yM6L+Z6YeM5YW85a655ZG95Luk5p6E5Lu25LiK6K6+572u5Li6aW505ZKMZG91Ymxl55qE5oOF5Ya1XHJcbiAgICAgICAgICBjb25zdCBudW1SZXN1bHQgPSBOdW1iZXIodmFsdWUpO1xyXG4gICAgICAgICAgaWYgKGlzTmFOKG51bVJlc3VsdCkpIHtcclxuICAgICAgICAgICAgdGhyb3cgRXJyb3IoYOexu+Wei+i9rOaNouWksei0pe+8jOWPguaVsCR7a2V5feWAvOS4uiR7dmFsdWV977yM5peg5rOV6L2s5o2i5Li6JHtwYXJUeXBlfeexu+Wei+OAgmApO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcGFyYW1zW2tleV0gPSBudW1SZXN1bHQ7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdib29sZWFuJzpcclxuICAgICAgICAgIGxldCBib29sUmVzdWx0OiBib29sZWFuO1xyXG4gICAgICAgICAgY29uc3Qgc3RyVmFsdWUgPSAodmFsdWUgKyAnJykudG9Mb3dlckNhc2UoKTtcclxuICAgICAgICAgIGlmIChzdHJWYWx1ZSA9PT0gJ3RydWUnKSB7XHJcbiAgICAgICAgICAgIGJvb2xSZXN1bHQgPSB0cnVlO1xyXG4gICAgICAgICAgfSBlbHNlIGlmIChzdHJWYWx1ZSA9PT0gJ2ZhbHNlJykge1xyXG4gICAgICAgICAgICBib29sUmVzdWx0ID0gZmFsc2U7XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aHJvdyBFcnJvcihg57G75Z6L6L2s5o2i5aSx6LSl77yM5Y+C5pWwJHtrZXl95YC85Li6JHt2YWx1ZX3vvIzml6Dms5XovazmjaLkuLoke3BhclR5cGV957G75Z6L44CCYCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBwYXJhbXNba2V5XSA9IGJvb2xSZXN1bHQ7XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdkYXRldGltZSc6XHJcbiAgICAgICAgICAvLyB0b2Rv77ya5pel5pyf5pe26Ze05pqC5LiN5aSE55CGXHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlICdvYmplY3QnOlxyXG4gICAgICAgICAgLy8g6KGo6L6+5byP6Kej5p6Q5Ye65p2l55qE5Y+C5pWw77yM5peg6ZyA5aSE55CG77yM5oyJ5Y6f57G75Z6L6L+U5ZueXHJcbiAgICAgICAgICAvLyB0b2RvOiDovpPlhaXlj4LmlbDmmK/kuKpqc29u5Liy77yM6L2s5oiQb2JqZWN0XHJcbiAgICAgICAgICBicmVhaztcclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbn1cclxuXHJcbi8qKlxyXG4gKiDlkb3ku6TlpITnkIblmajms6jlhaVUb2tlblxyXG4gKi9cclxuY29uc3QgQ09NTUFORF9IQU5ETEVSU19UT0tFTiA9IG5ldyBJbmplY3Rpb25Ub2tlbjxDb21tYW5kSGFuZGxlcj4oJ0BGYXJyaXMgQ29tbWFuZCBIYW5kbGVycycpO1xyXG5cclxuZXhwb3J0IHsgQ29tbWFuZEhhbmRsZXIsIENPTU1BTkRfSEFORExFUlNfVE9LRU4gfTtcclxuIl19