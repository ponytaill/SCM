/**
 * session变量解析
 * @author Witt <jiwt@inspur.com>
 */
import * as tslib_1 from "tslib";
import { CommandContext } from '../command/index';
/**
 * 命令变量解析
 * {COMMAND~/params/key}
 * {COMMAND~/results/taskName}
 */
var CommandVariableParser = /** @class */ (function () {
    /**
     * 构造函数
     */
    function CommandVariableParser() {
    }
    /**
     * 解析变量
     * @param expression 变量：格式形如：/frameId/componentId/stateName
     * @param context 上下文
     */
    CommandVariableParser.prototype.parse = function (expression, context) {
        var _this = this;
        var paths = this.extractPaths(expression);
        // 1、单个的表达式：直接求值
        if (paths.length === 1 && expression === "{COMMAND~" + paths[0] + "}") {
            return this.getValue(paths[0], context);
        }
        // 2、其他情况：字符串替换
        paths.forEach(function (path) {
            var searchValue = "{COMMAND~" + path + "}";
            var replaceValue = _this.getValue(path, context);
            expression = expression.replace(searchValue, replaceValue);
        });
        return expression;
    };
    /**
     * 提取Session变量名
     * 变量格式：{}
     */
    CommandVariableParser.prototype.extractPaths = function (expression) {
        var paths = [];
        // 查找所有的uiState变量字符串
        var UI_STATE_PATTERN_G = /\{COMMAND~(\S+?)\}/g;
        var uiStateVariables = expression.match(UI_STATE_PATTERN_G);
        if (uiStateVariables === null) {
            return [];
        }
        // 提取后边的路径
        var UI_STATE_PATTERN = /\{COMMAND~(\S+?)\}/;
        uiStateVariables.forEach(function (sessionVariable) {
            var pathMatches = sessionVariable.match(UI_STATE_PATTERN);
            if (pathMatches != null && pathMatches.length === 2) {
                paths.push(pathMatches[1]);
            }
        });
        return paths;
    };
    /**
     * 获取UIState
     */
    CommandVariableParser.prototype.getValue = function (path, context) {
        if (context instanceof CommandContext === false) {
            throw new Error('当前上下文不支持COMMAND变量，请检查！');
        }
        var parts = path.split('/').filter(function (part) {
            return part !== '';
        });
        var _a = tslib_1.__read(parts, 2), type = _a[0], name = _a[1];
        if (type === 'params') {
            return context.command.params[name];
        }
        else if (type === 'results') {
            return context.results[name];
        }
    };
    return CommandVariableParser;
}());
export { CommandVariableParser };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZF92YXJpYWJsZV9wYXJzZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL21vYmlsZS1kZXZraXQvIiwic291cmNlcyI6WyJsaWIvdmFyaWFibGUvY29tbWFuZF92YXJpYWJsZV9wYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7OztHQUdHOztBQUVILE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUdsRDs7OztHQUlHO0FBQ0g7SUFFRTs7T0FFRztJQUNIO0lBQ0EsQ0FBQztJQUVEOzs7O09BSUc7SUFDSSxxQ0FBSyxHQUFaLFVBQWEsVUFBa0IsRUFBRSxPQUFZO1FBQTdDLGlCQWdCQztRQWZDLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFNUMsZ0JBQWdCO1FBQ2hCLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksVUFBVSxLQUFLLGNBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFHLEVBQUU7WUFDaEUsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN6QztRQUVELGVBQWU7UUFDZixLQUFLLENBQUMsT0FBTyxDQUFFLFVBQUEsSUFBSTtZQUNqQixJQUFNLFdBQVcsR0FBRyxjQUFZLElBQUksTUFBRyxDQUFDO1lBQ3hDLElBQU0sWUFBWSxHQUFHLEtBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2xELFVBQVUsR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUM3RCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQVEsVUFBVSxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7O09BR0c7SUFDSyw0Q0FBWSxHQUFwQixVQUFxQixVQUFrQjtRQUNyQyxJQUFNLEtBQUssR0FBYyxFQUFFLENBQUM7UUFFNUIsb0JBQW9CO1FBQ3BCLElBQU0sa0JBQWtCLEdBQUcscUJBQXFCLENBQUM7UUFDakQsSUFBTSxnQkFBZ0IsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDOUQsSUFBSSxnQkFBZ0IsS0FBSyxJQUFJLEVBQUU7WUFDN0IsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUVELFVBQVU7UUFDVixJQUFNLGdCQUFnQixHQUFHLG9CQUFvQixDQUFDO1FBQzlDLGdCQUFnQixDQUFDLE9BQU8sQ0FBRSxVQUFBLGVBQWU7WUFDdkMsSUFBTSxXQUFXLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQzVELElBQUksV0FBVyxJQUFJLElBQUksSUFBSSxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDbkQsS0FBSyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUM1QjtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDSyx3Q0FBUSxHQUFoQixVQUFpQixJQUFZLEVBQUUsT0FBWTtRQUN6QyxJQUFJLE9BQU8sWUFBWSxjQUFjLEtBQUssS0FBSyxFQUFFO1lBQy9DLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztTQUMzQztRQUNELElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQUMsSUFBWTtZQUNoRCxPQUFPLElBQUksS0FBSyxFQUFFLENBQUM7UUFDckIsQ0FBQyxDQUFDLENBQUM7UUFFRyxJQUFBLDZCQUFvQixFQUFuQixZQUFJLEVBQUUsWUFBYSxDQUFDO1FBQzNCLElBQUksSUFBSSxLQUFLLFFBQVEsRUFBRTtZQUNyQixPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3JDO2FBQU0sSUFBSSxJQUFJLEtBQUssU0FBUyxFQUFFO1lBQzdCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM5QjtJQUNILENBQUM7SUFDSCw0QkFBQztBQUFELENBQUMsQUEzRUQsSUEyRUM7QUFFRCxPQUFPLEVBQUUscUJBQXFCLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBzZXNzaW9u5Y+Y6YeP6Kej5p6QXHJcbiAqIEBhdXRob3IgV2l0dCA8aml3dEBpbnNwdXIuY29tPlxyXG4gKi9cclxuXHJcbmltcG9ydCB7IENvbW1hbmRDb250ZXh0IH0gZnJvbSAnLi4vY29tbWFuZC9pbmRleCc7XHJcbmltcG9ydCB7IFZhcmlhYmxlUGFyc2VyIH0gZnJvbSAnLi92YXJpYWJsZV9wYXJzZXInO1xyXG5cclxuLyoqXHJcbiAqIOWRveS7pOWPmOmHj+ino+aekFxyXG4gKiB7Q09NTUFORH4vcGFyYW1zL2tleX1cclxuICoge0NPTU1BTkR+L3Jlc3VsdHMvdGFza05hbWV9XHJcbiAqL1xyXG5jbGFzcyBDb21tYW5kVmFyaWFibGVQYXJzZXIgaW1wbGVtZW50cyBWYXJpYWJsZVBhcnNlciB7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaehOmAoOWHveaVsFxyXG4gICAqL1xyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcigpIHtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIOino+aekOWPmOmHj1xyXG4gICAqIEBwYXJhbSBleHByZXNzaW9uIOWPmOmHj++8muagvOW8j+W9ouWmgu+8mi9mcmFtZUlkL2NvbXBvbmVudElkL3N0YXRlTmFtZVxyXG4gICAqIEBwYXJhbSBjb250ZXh0IOS4iuS4i+aWh1xyXG4gICAqL1xyXG4gIHB1YmxpYyBwYXJzZShleHByZXNzaW9uOiBzdHJpbmcsIGNvbnRleHQ6IGFueSk6IGFueSB7XHJcbiAgICBjb25zdCBwYXRocyA9IHRoaXMuZXh0cmFjdFBhdGhzKGV4cHJlc3Npb24pO1xyXG5cclxuICAgIC8vIDHjgIHljZXkuKrnmoTooajovr7lvI/vvJrnm7TmjqXmsYLlgLxcclxuICAgIGlmIChwYXRocy5sZW5ndGggPT09IDEgJiYgZXhwcmVzc2lvbiA9PT0gYHtDT01NQU5EfiR7cGF0aHNbMF19fWApIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZ2V0VmFsdWUocGF0aHNbMF0sIGNvbnRleHQpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIDLjgIHlhbbku5bmg4XlhrXvvJrlrZfnrKbkuLLmm7/mjaJcclxuICAgIHBhdGhzLmZvckVhY2goIHBhdGggPT4ge1xyXG4gICAgICBjb25zdCBzZWFyY2hWYWx1ZSA9IGB7Q09NTUFORH4ke3BhdGh9fWA7XHJcbiAgICAgIGNvbnN0IHJlcGxhY2VWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUocGF0aCwgY29udGV4dCk7XHJcbiAgICAgIGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2Uoc2VhcmNoVmFsdWUsIHJlcGxhY2VWYWx1ZSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gIGV4cHJlc3Npb247XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDmj5Dlj5ZTZXNzaW9u5Y+Y6YeP5ZCNXHJcbiAgICog5Y+Y6YeP5qC85byP77yae31cclxuICAgKi9cclxuICBwcml2YXRlIGV4dHJhY3RQYXRocyhleHByZXNzaW9uOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICBjb25zdCBwYXRoczogc3RyaW5nW10gID0gW107XHJcblxyXG4gICAgLy8g5p+l5om+5omA5pyJ55qEdWlTdGF0ZeWPmOmHj+Wtl+espuS4slxyXG4gICAgY29uc3QgVUlfU1RBVEVfUEFUVEVSTl9HID0gL1xce0NPTU1BTkR+KFxcUys/KVxcfS9nO1xyXG4gICAgY29uc3QgdWlTdGF0ZVZhcmlhYmxlcyA9IGV4cHJlc3Npb24ubWF0Y2goVUlfU1RBVEVfUEFUVEVSTl9HKTtcclxuICAgIGlmICh1aVN0YXRlVmFyaWFibGVzID09PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBbXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyDmj5Dlj5blkI7ovrnnmoTot6/lvoRcclxuICAgIGNvbnN0IFVJX1NUQVRFX1BBVFRFUk4gPSAvXFx7Q09NTUFORH4oXFxTKz8pXFx9LztcclxuICAgIHVpU3RhdGVWYXJpYWJsZXMuZm9yRWFjaCggc2Vzc2lvblZhcmlhYmxlID0+ICB7XHJcbiAgICAgIGNvbnN0IHBhdGhNYXRjaGVzID0gc2Vzc2lvblZhcmlhYmxlLm1hdGNoKFVJX1NUQVRFX1BBVFRFUk4pO1xyXG4gICAgICBpZiAocGF0aE1hdGNoZXMgIT0gbnVsbCAmJiBwYXRoTWF0Y2hlcy5sZW5ndGggPT09IDIpIHtcclxuICAgICAgICBwYXRocy5wdXNoKHBhdGhNYXRjaGVzWzFdKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHBhdGhzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog6I635Y+WVUlTdGF0ZVxyXG4gICAqL1xyXG4gIHByaXZhdGUgZ2V0VmFsdWUocGF0aDogc3RyaW5nLCBjb250ZXh0OiBhbnkpIHtcclxuICAgIGlmIChjb250ZXh0IGluc3RhbmNlb2YgQ29tbWFuZENvbnRleHQgPT09IGZhbHNlKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcign5b2T5YmN5LiK5LiL5paH5LiN5pSv5oyBQ09NTUFOROWPmOmHj++8jOivt+ajgOafpe+8gScpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgcGFydHMgPSBwYXRoLnNwbGl0KCcvJykuZmlsdGVyKChwYXJ0OiBzdHJpbmcpID0+IHtcclxuICAgICAgcmV0dXJuIHBhcnQgIT09ICcnO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgW3R5cGUsIG5hbWVdID0gcGFydHM7XHJcbiAgICBpZiAodHlwZSA9PT0gJ3BhcmFtcycpIHtcclxuICAgICAgcmV0dXJuIGNvbnRleHQuY29tbWFuZC5wYXJhbXNbbmFtZV07XHJcbiAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdyZXN1bHRzJykge1xyXG4gICAgICByZXR1cm4gY29udGV4dC5yZXN1bHRzW25hbWVdO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IHsgQ29tbWFuZFZhcmlhYmxlUGFyc2VyIH07XHJcbiJdfQ==