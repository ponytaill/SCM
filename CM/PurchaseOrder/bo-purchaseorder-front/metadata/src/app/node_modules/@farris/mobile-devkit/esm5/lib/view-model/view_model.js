import { MetadataUtil } from '../core/index';
import { Repository } from '../repository/index';
import { CommandBus } from '../command/index';
import { BindingData } from '../binding-data/index';
import { UIState } from '../ui-state/index';
import { StateMachine } from '../state-machine/index';
import { Form } from '../form/index';
import { ViewModelContext } from './view_model_context';
import { COMMAND_METHOD_META } from './decorators';
import { EMPTY, from, of } from 'rxjs';
import { concatMap, every, tap } from 'rxjs/operators';
var ViewModel = /** @class */ (function () {
    /**
     * 构造函数
     */
    function ViewModel(injector, id) {
        this.injector = injector;
        this.id = id;
    }
    /**
     * 初始化
     */
    ViewModel.prototype.init = function () {
        this.initRepository();
        this.initContext();
        this.initBindingData();
        this.initUIState();
        this.intiStateMachine();
        this.initForm();
        this.initCommandBus();
        this.registerWithParent();
        this.initListeners();
        this.closeOldBeSession();
    };
    ViewModel.prototype.initRepository = function () {
        this.repository = this.injector.get(Repository);
    };
    ViewModel.prototype.initContext = function () {
        this.context = this.injector.get(ViewModelContext);
        this.context.init(this);
    };
    ViewModel.prototype.initBindingData = function () {
        var _this = this;
        this.bindingData = this.context.injector.get(BindingData);
        this.entityValueChangingListeners = new Map();
        this.entityValueChangedListeners = new Map();
        if (this.bindingData) {
            this.bindingData.setValueChangeInvokerFactory(function (paths) {
                return function (preValue, value, entityChanged, primaryValue) {
                    var plainPath = '/' + paths.join('/');
                    var command;
                    if (entityChanged === false) {
                        command = _this.entityValueChangingListeners[plainPath];
                    }
                    else {
                        command = _this.entityValueChangedListeners[plainPath];
                    }
                    if (!!command) {
                        var change_1 = {
                            paths: paths,
                            preValue: preValue,
                            value: value,
                            changed: entityChanged
                        };
                        var commands = command.split(';').filter(function (p) { return p; });
                        var valueChangeSuccess_1 = true;
                        return from(commands).pipe(concatMap(function (item) {
                            if (!valueChangeSuccess_1) {
                                return EMPTY;
                            }
                            return _this[item](change_1).pipe(tap(function (result) {
                                valueChangeSuccess_1 = result;
                            }));
                        }), every(function (result) { return result; }));
                    }
                    else {
                        return of(true);
                    }
                };
            });
        }
        var repositoryName = this.repository.name;
        var bindingDataManager = this.context.appContext.bindingDataManager;
        var repositoryBindingData = bindingDataManager.getBindingDataByName(repositoryName);
        this.bindingData.initByBindingList(repositoryBindingData.list, this.context);
    };
    ViewModel.prototype.initUIState = function () {
        this.uiState = this.injector.get(UIState);
    };
    ViewModel.prototype.intiStateMachine = function () {
        this.stateMachine = this.injector.get(StateMachine, null);
        if (!this.stateMachine) {
            return;
        }
        this.stateMachine.init(this.context);
    };
    ViewModel.prototype.initForm = function () {
        this.form = this.injector.get(Form, null);
        this.form.init();
    };
    ViewModel.prototype.initCommandBus = function () {
        this.commandBus = this.injector.get(CommandBus);
        this.extendCommandMethods();
    };
    ViewModel.prototype.extendCommandMethods = function () {
        var _this = this;
        this.ngCommands = MetadataUtil.getPropsMetadatasByName(this.constructor, COMMAND_METHOD_META);
        this.keybindingMap = new Map();
        Object.keys(this.ngCommands).forEach(function (propName) {
            var ngCommand = _this.ngCommands[propName];
            Object.defineProperty(_this, propName, {
                value: function (eventParams) {
                    var command = {
                        name: ngCommand.name,
                        params: ngCommand.params,
                        paramDescriptions: ngCommand.paramDescriptions,
                        eventParam: eventParams || null
                    };
                    return _this.commandBus.dispatch(command);
                }
            });
            if (ngCommand.keyBinding) {
                _this.keybindingMap.set(propName, ngCommand.keyBinding);
            }
        });
    };
    ViewModel.prototype.registerWithParent = function () {
        var parentContext = this.context.parent;
        if (!parentContext || !parentContext.viewModel || !parentContext.viewModel['childViewModels']) {
            return;
        }
        var parentViewModel = parentContext.viewModel;
        var className = this.constructor.name;
        var propName = parentViewModel['childViewModels'][className];
        parentViewModel[propName] = this;
    };
    /**
     * 关闭老的BeSession
     */
    ViewModel.prototype.closeOldBeSession = function () {
        var allViewModelContexts = this.context.appContext.viewModelContextManager.getContexts();
        if (allViewModelContexts.length === 1 && allViewModelContexts[0] === this.context) {
            this.context.repository.reset();
        }
    };
    /**
   * 从Form获取监听器
   */
    ViewModel.prototype.initListeners = function () {
        var _this = this;
        var extractPath = function (bindingBasePath, bindingPath) {
            return '/' + bindingBasePath.split('/').concat(bindingPath.split('.')).filter(function (item) { return item.length > 0; }).join('/');
        };
        if (this.form) {
            var valueChangingListeners_1 = this.form.getEntityValueChangingListeners();
            Object.keys(valueChangingListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangingListeners[plainPath] = valueChangingListeners_1[bindingPath];
            });
            var valueChangedListeners_1 = this.form.getEntityValueChangedListeners();
            Object.keys(valueChangedListeners_1).forEach(function (bindingPath) {
                var plainPath = extractPath(_this.bindingPath, bindingPath);
                _this.entityValueChangedListeners[plainPath] = valueChangedListeners_1[bindingPath];
            });
        }
    };
    return ViewModel;
}());
export { ViewModel };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld19tb2RlbC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvbW9iaWxlLWRldmtpdC8iLCJzb3VyY2VzIjpbImxpYi92aWV3LW1vZGVsL3ZpZXdfbW9kZWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUc3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFXLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxXQUFXLEVBQTBDLE1BQU0sdUJBQXVCLENBQUM7QUFDNUYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRXhELE9BQU8sRUFBRSxtQkFBbUIsRUFBcUMsTUFBTSxjQUFjLENBQUM7QUFDdEYsT0FBTyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZEO0lBd0VFOztPQUVHO0lBQ0gsbUJBQW1CLFFBQWtCLEVBQUUsRUFBVTtRQUMvQyxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztRQUN6QixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFRDs7T0FFRztJQUNJLHdCQUFJLEdBQVg7UUFDRSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdEIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FB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Qyx3QkFBc0IsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLFdBQVc7Z0JBQ3RELElBQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxLQUFJLENBQUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2dCQUM3RCxLQUFJLENBQUMsNEJBQTRCLENBQUMsU0FBUyxDQUFDLEdBQUcsd0JBQXNCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDckYsQ0FBQyxDQUFDLENBQUM7WUFFSCxJQUFNLHVCQUFxQixHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsOEJBQThCLEVBQUUsQ0FBQztZQUN6RSxNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUFxQixDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsV0FBVztnQkFDckQsSUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLEtBQUksQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDLENBQUM7Z0JBQzdELEtBQUksQ0FBQywyQkFBMkIsQ0FBQyxTQUFTLENBQUMsR0FBRyx1QkFBcUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNuRixDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVILGdCQUFDO0FBQUQsQ0FBQyxBQXhQRCxJQXdQQztBQUVELE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1ldGFkYXRhVXRpbCB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBJbmplY3RvciB9IGZyb20gJy4uL2NvcmUvaW5kZXgnO1xyXG5pbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuLi9lbnRpdHkvaW5kZXgnO1xyXG5pbXBvcnQgeyBSZXBvc2l0b3J5IH0gZnJvbSAnLi4vcmVwb3NpdG9yeS9pbmRleCc7XHJcbmltcG9ydCB7IENvbW1hbmQsIENvbW1hbmRCdXMgfSBmcm9tICcuLi9jb21tYW5kL2luZGV4JztcclxuaW1wb3J0IHsgQmluZGluZ0RhdGEsIEVudGl0eVZhbHVlQ2hhbmdlLCBJbnZva2VPblZhbHVlQ2hhbmdlIH0gZnJvbSAnLi4vYmluZGluZy1kYXRhL2luZGV4JztcclxuaW1wb3J0IHsgVUlTdGF0ZSB9IGZyb20gJy4uL3VpLXN0YXRlL2luZGV4JztcclxuaW1wb3J0IHsgU3RhdGVNYWNoaW5lIH0gZnJvbSAnLi4vc3RhdGUtbWFjaGluZS9pbmRleCc7XHJcbmltcG9ydCB7IEZvcm0gfSBmcm9tICcuLi9mb3JtL2luZGV4JztcclxuaW1wb3J0IHsgVmlld01vZGVsQ29udGV4dCB9IGZyb20gJy4vdmlld19tb2RlbF9jb250ZXh0JztcclxuXHJcbmltcG9ydCB7IENPTU1BTkRfTUVUSE9EX01FVEEsIENvbW1hbmRNZXRob2RNZXRhZGF0YSwgS2V5YmluZGluZyB9IGZyb20gJy4vZGVjb3JhdG9ycyc7XHJcbmltcG9ydCB7IEVNUFRZLCBmcm9tLCBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBjb25jYXRNYXAsIGV2ZXJ5LCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5hYnN0cmFjdCBjbGFzcyBWaWV3TW9kZWwge1xyXG5cclxuICAvKipcclxuICAgKiDlkb3ku6TlhYPmlbDmja7pm4blkIhcclxuICAgKi9cclxuICBwdWJsaWMgbmdDb21tYW5kczogeyBbcHJvcE5hbWU6IHN0cmluZ106IENvbW1hbmRNZXRob2RNZXRhZGF0YSB9O1xyXG5cclxuICAvKipcclxuICAgKiDlkI3np7BcclxuICAgKi9cclxuICBwdWJsaWMgaWQ6IHN0cmluZztcclxuXHJcbiAgLyoqXHJcbiAgICog5rOo5YWl5ZmoXHJcbiAgICovXHJcbiAgcHVibGljIGluamVjdG9yOiBJbmplY3RvcjtcclxuXHJcbiAgLyoqXHJcbiAgICog6KeG5Zu+5qih5Z6L5LiK5LiL5paHXHJcbiAgICovXHJcbiAgcHVibGljIGNvbnRleHQ6IFZpZXdNb2RlbENvbnRleHQ7XHJcblxyXG4gIC8qKlxyXG4gICAqIOaVsOaNruS7k+W6k1xyXG4gICAqL1xyXG4gIHB1YmxpYyByZXBvc2l0b3J5OiBSZXBvc2l0b3J5PEVudGl0eT47XHJcblxyXG4gIC8qKlxyXG4gICAqIOe7keWumui3r+W+hFxyXG4gICAqL1xyXG4gIHB1YmxpYyBiaW5kaW5nUGF0aDogc3RyaW5nO1xyXG5cclxuICAvKipcclxuICAgKiDmlbDmja7nirbmgIFcclxuICAgKi9cclxuICBwdWJsaWMgYmluZGluZ0RhdGE6IEJpbmRpbmdEYXRhO1xyXG5cclxuICAvKipcclxuICAgKiBVSeeKtuaAgVxyXG4gICAqL1xyXG4gIHB1YmxpYyB1aVN0YXRlOiBVSVN0YXRlO1xyXG5cclxuICAvKipcclxuICAgKiDnirbmgIHmnLpcclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGVNYWNoaW5lOiBTdGF0ZU1hY2hpbmU7XHJcblxyXG4gIC8qKlxyXG4gICAqIOihqOWNlVxyXG4gICAqL1xyXG4gIHB1YmxpYyBmb3JtOiBGb3JtO1xyXG5cclxuICAvKipcclxuICAgKiDlkb3ku6TmgLvnur9cclxuICAgKi9cclxuICBwdWJsaWMgY29tbWFuZEJ1czogQ29tbWFuZEJ1cztcclxuXHJcbiAgLyoqXHJcbiAgICog5b+r5o236ZSu5pig5bCEXHJcbiAgICovXHJcbiAgcHVibGljIGtleWJpbmRpbmdNYXA6IE1hcDxzdHJpbmcsIEtleWJpbmRpbmc+O1xyXG5cclxuICAvKipcclxuICAgKiDlgLzlj5jljJbliY3nm5HlkKzlmahcclxuICAgKi9cclxuICBwcml2YXRlIGVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnM6IE1hcDxzdHJpbmcsIHN0cmluZz47XHJcblxyXG4gIC8qKlxyXG4gICAqIOWAvOWPmOWMluWQjuebkeWQrOWZqFxyXG4gICAqL1xyXG4gIHByaXZhdGUgZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzOiBNYXA8c3RyaW5nLCBzdHJpbmc+O1xyXG5cclxuICAvKipcclxuICAgKiDmnoTpgKDlh73mlbBcclxuICAgKi9cclxuICBwdWJsaWMgY29uc3RydWN0b3IoaW5qZWN0b3I6IEluamVjdG9yLCBpZDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLmluamVjdG9yID0gaW5qZWN0b3I7XHJcbiAgICB0aGlzLmlkID0gaWQ7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiDliJ3lp4vljJZcclxuICAgKi9cclxuICBwdWJsaWMgaW5pdCgpIHtcclxuICAgIHRoaXMuaW5pdFJlcG9zaXRvcnkoKTtcclxuICAgIHRoaXMuaW5pdENvbnRleHQoKTtcclxuICAgIHRoaXMuaW5pdEJpbmRpbmdEYXRhKCk7XHJcbiAgICB0aGlzLmluaXRVSVN0YXRlKCk7XHJcbiAgICB0aGlzLmludGlTdGF0ZU1hY2hpbmUoKTtcclxuICAgIHRoaXMuaW5pdEZvcm0oKTtcclxuICAgIHRoaXMuaW5pdENvbW1hbmRCdXMoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJXaXRoUGFyZW50KCk7XHJcbiAgICB0aGlzLmluaXRMaXN0ZW5lcnMoKTtcclxuICAgIHRoaXMuY2xvc2VPbGRCZVNlc3Npb24oKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdFJlcG9zaXRvcnkoKSB7XHJcbiAgICB0aGlzLnJlcG9zaXRvcnkgPSB0aGlzLmluamVjdG9yLmdldChSZXBvc2l0b3J5KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdENvbnRleHQoKSB7XHJcbiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmluamVjdG9yLmdldDxWaWV3TW9kZWxDb250ZXh0PihWaWV3TW9kZWxDb250ZXh0KTtcclxuICAgIHRoaXMuY29udGV4dC5pbml0KHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0QmluZGluZ0RhdGEoKSB7XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhID0gdGhpcy5jb250ZXh0LmluamVjdG9yLmdldChCaW5kaW5nRGF0YSk7XHJcbiAgICB0aGlzLmVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xyXG4gICAgdGhpcy5lbnRpdHlWYWx1ZUNoYW5nZWRMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xyXG4gICAgaWYgKHRoaXMuYmluZGluZ0RhdGEpIHtcclxuICAgICAgdGhpcy5iaW5kaW5nRGF0YS5zZXRWYWx1ZUNoYW5nZUludm9rZXJGYWN0b3J5KChwYXRoczogc3RyaW5nW10pOiBJbnZva2VPblZhbHVlQ2hhbmdlID0+IHtcclxuICAgICAgICByZXR1cm4gKHByZVZhbHVlLCB2YWx1ZSwgZW50aXR5Q2hhbmdlZDogYm9vbGVhbiwgcHJpbWFyeVZhbHVlPzogYW55KTogT2JzZXJ2YWJsZTxib29sZWFuPiA9PiB7XHJcbiAgICAgICAgICBjb25zdCBwbGFpblBhdGggPSAnLycgKyBwYXRocy5qb2luKCcvJyk7XHJcbiAgICAgICAgICBsZXQgY29tbWFuZDogc3RyaW5nO1xyXG4gICAgICAgICAgaWYgKGVudGl0eUNoYW5nZWQgPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgIGNvbW1hbmQgPSB0aGlzLmVudGl0eVZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnNbcGxhaW5QYXRoXTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbW1hbmQgPSB0aGlzLmVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVyc1twbGFpblBhdGhdO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGlmICghIWNvbW1hbmQpIHtcclxuICAgICAgICAgICAgY29uc3QgY2hhbmdlOiBFbnRpdHlWYWx1ZUNoYW5nZSA9IHtcclxuICAgICAgICAgICAgICBwYXRoczogcGF0aHMsXHJcbiAgICAgICAgICAgICAgcHJlVmFsdWU6IHByZVZhbHVlLFxyXG4gICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSxcclxuICAgICAgICAgICAgICBjaGFuZ2VkOiBlbnRpdHlDaGFuZ2VkXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbW1hbmRzID0gY29tbWFuZC5zcGxpdCgnOycpLmZpbHRlcihwID0+IHApO1xyXG4gICAgICAgICAgICBsZXQgdmFsdWVDaGFuZ2VTdWNjZXNzID0gdHJ1ZTtcclxuICAgICAgICAgICAgcmV0dXJuIGZyb20oY29tbWFuZHMpLnBpcGUoXHJcbiAgICAgICAgICAgICAgY29uY2F0TWFwKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKCF2YWx1ZUNoYW5nZVN1Y2Nlc3MpIHtcclxuICAgICAgICAgICAgICAgICAgcmV0dXJuIEVNUFRZO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbaXRlbV0oY2hhbmdlKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICB0YXAoKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVDaGFuZ2VTdWNjZXNzID0gcmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICBldmVyeSgocmVzdWx0OiBhbnkpID0+IHJlc3VsdClcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcmVwb3NpdG9yeU5hbWUgPSB0aGlzLnJlcG9zaXRvcnkubmFtZTtcclxuICAgIGNvbnN0IGJpbmRpbmdEYXRhTWFuYWdlciA9IHRoaXMuY29udGV4dC5hcHBDb250ZXh0LmJpbmRpbmdEYXRhTWFuYWdlcjtcclxuICAgIGNvbnN0IHJlcG9zaXRvcnlCaW5kaW5nRGF0YSA9IGJpbmRpbmdEYXRhTWFuYWdlci5nZXRCaW5kaW5nRGF0YUJ5TmFtZShyZXBvc2l0b3J5TmFtZSk7XHJcbiAgICB0aGlzLmJpbmRpbmdEYXRhLmluaXRCeUJpbmRpbmdMaXN0KHJlcG9zaXRvcnlCaW5kaW5nRGF0YS5saXN0LCB0aGlzLmNvbnRleHQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0VUlTdGF0ZSgpIHtcclxuICAgIHRoaXMudWlTdGF0ZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KFVJU3RhdGUpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbnRpU3RhdGVNYWNoaW5lKCkge1xyXG4gICAgdGhpcy5zdGF0ZU1hY2hpbmUgPSB0aGlzLmluamVjdG9yLmdldChTdGF0ZU1hY2hpbmUsIG51bGwpO1xyXG4gICAgaWYgKCF0aGlzLnN0YXRlTWFjaGluZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICB0aGlzLnN0YXRlTWFjaGluZS5pbml0KHRoaXMuY29udGV4dCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRGb3JtKCkge1xyXG4gICAgdGhpcy5mb3JtID0gdGhpcy5pbmplY3Rvci5nZXQoRm9ybSwgbnVsbCk7XHJcbiAgICB0aGlzLmZvcm0uaW5pdCgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0Q29tbWFuZEJ1cygpIHtcclxuICAgIHRoaXMuY29tbWFuZEJ1cyA9IHRoaXMuaW5qZWN0b3IuZ2V0KENvbW1hbmRCdXMpO1xyXG4gICAgdGhpcy5leHRlbmRDb21tYW5kTWV0aG9kcygpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBleHRlbmRDb21tYW5kTWV0aG9kcygpIHtcclxuICAgIHRoaXMubmdDb21tYW5kcyA9IE1ldGFkYXRhVXRpbC5nZXRQcm9wc01ldGFkYXRhc0J5TmFtZSh0aGlzLmNvbnN0cnVjdG9yLCBDT01NQU5EX01FVEhPRF9NRVRBKTtcclxuICAgIHRoaXMua2V5YmluZGluZ01hcCA9IG5ldyBNYXA8c3RyaW5nLCBLZXliaW5kaW5nPigpO1xyXG5cclxuICAgIE9iamVjdC5rZXlzKHRoaXMubmdDb21tYW5kcykuZm9yRWFjaCgocHJvcE5hbWU6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBuZ0NvbW1hbmQ6IENvbW1hbmRNZXRob2RNZXRhZGF0YSA9IHRoaXMubmdDb21tYW5kc1twcm9wTmFtZV07XHJcblxyXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcywgcHJvcE5hbWUsIHtcclxuICAgICAgICB2YWx1ZTogKGV2ZW50UGFyYW1zOiBhbnkpID0+IHtcclxuICAgICAgICAgIGNvbnN0IGNvbW1hbmQ6IENvbW1hbmQgPSB7XHJcbiAgICAgICAgICAgIG5hbWU6IG5nQ29tbWFuZC5uYW1lLFxyXG4gICAgICAgICAgICBwYXJhbXM6IG5nQ29tbWFuZC5wYXJhbXMsXHJcbiAgICAgICAgICAgIHBhcmFtRGVzY3JpcHRpb25zOiBuZ0NvbW1hbmQucGFyYW1EZXNjcmlwdGlvbnMsXHJcbiAgICAgICAgICAgIGV2ZW50UGFyYW06IGV2ZW50UGFyYW1zIHx8IG51bGxcclxuICAgICAgICAgIH07XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5jb21tYW5kQnVzLmRpc3BhdGNoKGNvbW1hbmQpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcblxyXG4gICAgICBpZiAobmdDb21tYW5kLmtleUJpbmRpbmcpIHtcclxuICAgICAgICB0aGlzLmtleWJpbmRpbmdNYXAuc2V0KHByb3BOYW1lLCBuZ0NvbW1hbmQua2V5QmluZGluZyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3RlcldpdGhQYXJlbnQoKSB7XHJcbiAgICBjb25zdCBwYXJlbnRDb250ZXh0ID0gdGhpcy5jb250ZXh0LnBhcmVudDtcclxuICAgIGlmICghcGFyZW50Q29udGV4dCB8fCAhcGFyZW50Q29udGV4dC52aWV3TW9kZWwgfHwgIXBhcmVudENvbnRleHQudmlld01vZGVsWydjaGlsZFZpZXdNb2RlbHMnXSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgcGFyZW50Vmlld01vZGVsID0gcGFyZW50Q29udGV4dC52aWV3TW9kZWw7XHJcbiAgICBjb25zdCBjbGFzc05hbWUgPSB0aGlzLmNvbnN0cnVjdG9yLm5hbWU7XHJcbiAgICBjb25zdCBwcm9wTmFtZSA9IHBhcmVudFZpZXdNb2RlbFsnY2hpbGRWaWV3TW9kZWxzJ11bY2xhc3NOYW1lXTtcclxuICAgIHBhcmVudFZpZXdNb2RlbFtwcm9wTmFtZV0gPSB0aGlzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICog5YWz6Zet6ICB55qEQmVTZXNzaW9uXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjbG9zZU9sZEJlU2Vzc2lvbigpIHtcclxuICAgIGNvbnN0IGFsbFZpZXdNb2RlbENvbnRleHRzID0gdGhpcy5jb250ZXh0LmFwcENvbnRleHQudmlld01vZGVsQ29udGV4dE1hbmFnZXIuZ2V0Q29udGV4dHMoKTtcclxuICAgIGlmIChhbGxWaWV3TW9kZWxDb250ZXh0cy5sZW5ndGggPT09IDEgJiYgYWxsVmlld01vZGVsQ29udGV4dHNbMF0gPT09IHRoaXMuY29udGV4dCkge1xyXG4gICAgICB0aGlzLmNvbnRleHQucmVwb3NpdG9yeS5yZXNldCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAqIOS7jkZvcm3ojrflj5bnm5HlkKzlmahcclxuICovXHJcbiAgcHJpdmF0ZSBpbml0TGlzdGVuZXJzKCkge1xyXG4gICAgY29uc3QgZXh0cmFjdFBhdGggPSAoYmluZGluZ0Jhc2VQYXRoOiBzdHJpbmcsIGJpbmRpbmdQYXRoOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xyXG4gICAgICByZXR1cm4gJy8nICsgYmluZGluZ0Jhc2VQYXRoLnNwbGl0KCcvJykuY29uY2F0KGJpbmRpbmdQYXRoLnNwbGl0KCcuJykpLmZpbHRlcigoaXRlbSkgPT4gaXRlbS5sZW5ndGggPiAwKS5qb2luKCcvJyk7XHJcbiAgICB9O1xyXG5cclxuICAgIGlmICh0aGlzLmZvcm0pIHtcclxuICAgICAgY29uc3QgdmFsdWVDaGFuZ2luZ0xpc3RlbmVycyA9IHRoaXMuZm9ybS5nZXRFbnRpdHlWYWx1ZUNoYW5naW5nTGlzdGVuZXJzKCk7XHJcbiAgICAgIE9iamVjdC5rZXlzKHZhbHVlQ2hhbmdpbmdMaXN0ZW5lcnMpLmZvckVhY2goKGJpbmRpbmdQYXRoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGxhaW5QYXRoID0gZXh0cmFjdFBhdGgodGhpcy5iaW5kaW5nUGF0aCwgYmluZGluZ1BhdGgpO1xyXG4gICAgICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1twbGFpblBhdGhdID0gdmFsdWVDaGFuZ2luZ0xpc3RlbmVyc1tiaW5kaW5nUGF0aF07XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY29uc3QgdmFsdWVDaGFuZ2VkTGlzdGVuZXJzID0gdGhpcy5mb3JtLmdldEVudGl0eVZhbHVlQ2hhbmdlZExpc3RlbmVycygpO1xyXG4gICAgICBPYmplY3Qua2V5cyh2YWx1ZUNoYW5nZWRMaXN0ZW5lcnMpLmZvckVhY2goKGJpbmRpbmdQYXRoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgcGxhaW5QYXRoID0gZXh0cmFjdFBhdGgodGhpcy5iaW5kaW5nUGF0aCwgYmluZGluZ1BhdGgpO1xyXG4gICAgICAgIHRoaXMuZW50aXR5VmFsdWVDaGFuZ2VkTGlzdGVuZXJzW3BsYWluUGF0aF0gPSB2YWx1ZUNoYW5nZWRMaXN0ZW5lcnNbYmluZGluZ1BhdGhdO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgeyBWaWV3TW9kZWwgfTtcclxuIl19