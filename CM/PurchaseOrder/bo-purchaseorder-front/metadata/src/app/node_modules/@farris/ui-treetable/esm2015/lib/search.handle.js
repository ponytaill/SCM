/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { cloneDeep } from 'lodash-es';
export class SearchHandle {
    /**
     * @param {?} ttInstance
     */
    constructor(ttInstance) {
        this.ttInstance = ttInstance;
        this.allNodes = [];
    }
    // 刷新查询结果
    /**
     * @param {?=} from
     * @return {?}
     */
    research(from = 'client') {
        const { field, value } = this.ttInstance.searchData;
        this.allNodes = [];
        this.search(field, value, from);
    }
    /**
     * @param {?} field
     * @param {?} value
     * @param {?=} from
     * @return {?}
     */
    search(field, value, from = 'client') {
        if (!this.allNodes.length) {
            this.allNodes = cloneDeep(this.ttInstance.state.rowNodes);
        }
        switch (from) {
            case 'server':
                this.searchOnServer(field, value);
                break;
            default:
                if (value !== '' && value !== undefined) {
                    /** @type {?} */
                    const values = this.searchOnClient(field, value, this.allNodes);
                    this.ttInstance.state.searchRowNodes = null;
                    this._updateSerializedValues(values);
                }
                else {
                    this.ttInstance.updateSerializedValue();
                }
                if (this.ttInstance.checkeds && this.ttInstance.checkeds.length) {
                    this.ttInstance.checkedNodes(this.ttInstance.checkeds.map((/**
                     * @param {?} n
                     * @return {?}
                     */
                    n => n.data[this.ttInstance.idField])));
                }
                else {
                    this.ttInstance.resize();
                    this.ttInstance.detectChanges();
                    if (this.ttInstance.psRef) {
                        this.ttInstance.psRef.directiveRef.update();
                    }
                }
                break;
        }
    }
    /**
     * @private
     * @param {?} visibleItems
     * @return {?}
     */
    _updateSerializedValues(visibleItems) {
        /** @type {?} */
        const pids = ((/** @type {?} */ (visibleItems.map((/**
         * @param {?} n
         * @return {?}
         */
        n => [...n.parents, n.id]))))).flat();
        /** @type {?} */
        const pidArr = Array.from(new Set(pids));
        /** @type {?} */
        const rowNodes = this.allNodes.filter((/**
         * @param {?} n
         * @return {?}
         */
        n => pidArr.some((/**
         * @param {?} item
         * @return {?}
         */
        item => item == n.id)))).map((/**
         * @param {?} r
         * @return {?}
         */
        r => {
            r.expanded = true;
            this.ttInstance.updateNodeProperty(r.id, { expanded: true });
            return r;
        }));
        this.ttInstance.serializedValue = this.resetTreeData(null, rowNodes);
        this.ttInstance.state.searchRowNodes = this.ttInstance.serializedValue;
    }
    /**
     * @param {?} item
     * @param {?} allNodes
     * @return {?}
     */
    findParent(item, allNodes) {
        /** @type {?} */
        let res = [];
        if (item && allNodes && allNodes.length) {
            /** @type {?} */
            const p = allNodes.find((/**
             * @param {?} t1
             * @return {?}
             */
            t1 => t1.id === item.data[this.ttInstance.idField]));
            res.push(p);
            if (p.parent) {
                res = res.concat(this.findParent(p.parent, allNodes));
            }
        }
        return res;
    }
    /**
     * @private
     * @param {?} item
     * @param {?} value
     * @param {?=} fields
     * @return {?}
     */
    searchExpression(item, value, fields = []) {
        /** @type {?} */
        const _fields = fields.length ? fields : this.ttInstance.columns.map((/**
         * @param {?} c
         * @return {?}
         */
        c => c.field));
        /** @type {?} */
        const results = _fields.map((/**
         * @param {?} f
         * @return {?}
         */
        f => {
            /** @type {?} */
            const targetValue = '' + this.getValue(f, item.node.data);
            if (targetValue !== undefined) {
                if (typeof targetValue === 'number') {
                    return targetValue === parseFloat(value);
                }
                else {
                    return targetValue.indexOf(value) > -1;
                }
            }
            else {
                this.ttInstance.writeConsole(`不存在列 ${f}`);
            }
        }));
        return results.reduce((/**
         * @param {?} flag
         * @param {?} curr
         * @return {?}
         */
        (flag, curr) => {
            return flag || curr;
        }), false);
    }
    /**
     * @private
     * @param {?} field
     * @param {?} data
     * @return {?}
     */
    getValue(field, data) {
        if (field) {
            if (field.indexOf('.') > -1) {
                try {
                    return field.split('.').reduce((/**
                     * @param {?} r
                     * @param {?} f
                     * @return {?}
                     */
                    (r, f) => {
                        if (r) {
                            return r[f];
                        }
                        else {
                            return null;
                        }
                    }), data);
                }
                catch (_a) {
                    this.ttInstance.writeConsole(`字段 ${field} 不存在。`);
                }
            }
            else {
                return data[field];
            }
        }
    }
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    getFindTextTotal(field, value, nodes) {
        /** @type {?} */
        let t = 0;
        /** @type {?} */
        const getCount = (/**
         * @param {?} fields
         * @return {?}
         */
        (fields) => {
            /** @type {?} */
            let c = 0;
            nodes.forEach((/**
             * @param {?} n
             * @return {?}
             */
            n => {
                fields.forEach((/**
                 * @param {?} f
                 * @return {?}
                 */
                f => {
                    /** @type {?} */
                    const targetValue = '' + this.getValue(f, n.node.data);
                    if (targetValue !== undefined) {
                        if (targetValue.indexOf(value) > -1) {
                            c++;
                        }
                    }
                }));
            }));
            return c;
        });
        /** @type {?} */
        let _fields = [field];
        if (field === '*') {
            _fields = this.ttInstance.columns.map((/**
             * @param {?} c
             * @return {?}
             */
            c => c.field));
        }
        else if (field.indexOf(',') > -1) {
            _fields = field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            f => f.trim()));
        }
        t = getCount(_fields);
        return t;
    }
    /**
     * @param {?} field
     * @param {?} value
     * @param {?} nodes
     * @return {?}
     */
    searchOnClient(field, value, nodes) {
        /** @type {?} */
        let resultNodes = [];
        if (!value) {
            return [];
        }
        if (field === '*') {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => this.searchExpression(n, value)));
        }
        else if (field.indexOf(',') > -1) {
            resultNodes = nodes.filter((/**
             * @param {?} n
             * @return {?}
             */
            n => this.searchExpression(n, value, field.split(',').map((/**
             * @param {?} f
             * @return {?}
             */
            f => f.trim())))));
        }
        else {
            value = value.toLowerCase();
            if (field.indexOf('.') === -1) {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => ('' + n.node.data[field]).toLowerCase().indexOf(value) > -1));
            }
            else {
                resultNodes = nodes.filter((/**
                 * @param {?} n
                 * @return {?}
                 */
                n => ('' + this.getValue(field, n.node.data)).toLowerCase().indexOf(value) > -1));
            }
        }
        return resultNodes;
    }
    /**
     * @param {?} rowNodes
     * @param {?} allNodes
     * @return {?}
     */
    findParents(rowNodes, allNodes) {
        /** @type {?} */
        let res = [];
        rowNodes.forEach((/**
         * @param {?} item
         * @return {?}
         */
        item => {
            res = res.concat(this.findParent(item.node, allNodes));
        }));
        return Array.from(new Set(res));
    }
    /**
     * @private
     * @param {?} parentNode
     * @param {?} visibleItems
     * @return {?}
     */
    resetTreeData(parentNode, visibleItems) {
        /** @type {?} */
        let res = [];
        /** @type {?} */
        let arr = [];
        if (parentNode === null) {
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            t2 => t2.parent === parentNode));
        }
        else {
            parentNode.node.expanded = true;
            arr = visibleItems.filter((/**
             * @param {?} t2
             * @return {?}
             */
            t2 => t2.parent && t2.parent.data[this.ttInstance.idField] === parentNode.id));
            if (!arr.length) {
                parentNode.node.children = [];
            }
            else {
                parentNode.node.children = arr.map((/**
                 * @param {?} tn
                 * @return {?}
                 */
                tn => tn.node));
            }
        }
        arr.forEach((/**
         * @param {?} a
         * @return {?}
         */
        a => {
            a.visible = true;
            res.push(a);
            res = res.concat(this.resetTreeData(a, visibleItems));
        }));
        return res;
    }
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    searchOnServer(field, value) {
    }
}
if (false) {
    /** @type {?} */
    SearchHandle.prototype.allNodes;
    /**
     * @type {?}
     * @private
     */
    SearchHandle.prototype.ttInstance;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLmhhbmRsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BmYXJyaXMvdWktdHJlZXRhYmxlLyIsInNvdXJjZXMiOlsibGliL3NlYXJjaC5oYW5kbGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQVdBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEMsTUFBTSxPQUFPLFlBQVk7Ozs7SUFFckIsWUFBb0IsVUFBOEI7UUFBOUIsZUFBVSxHQUFWLFVBQVUsQ0FBb0I7UUFEbEQsYUFBUSxHQUFHLEVBQUUsQ0FBQztJQUVkLENBQUM7Ozs7OztJQUdELFFBQVEsQ0FBQyxPQUEwQixRQUFRO2NBQ2pDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVTtRQUNuRCxJQUFJLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQzs7Ozs7OztJQUVELE1BQU0sQ0FBQyxLQUFhLEVBQUUsS0FBYSxFQUFFLE9BQTBCLFFBQVE7UUFDbkUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxRQUFRLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQzdEO1FBQ0QsUUFBUSxJQUFJLEVBQUU7WUFDVixLQUFLLFFBQVE7Z0JBQ1QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUM7Z0JBQ2xDLE1BQU07WUFDVjtnQkFDSSxJQUFJLEtBQUssS0FBSyxFQUFFLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTs7MEJBQy9CLE1BQU0sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLFFBQVEs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QztRQUMxRCxDQUFDLEVBQUMsQ0FBQztRQUNILE9BQU8sR0FBRyxDQUFDO0lBQ2YsQ0FBQzs7Ozs7OztJQUVPLGNBQWMsQ0FBQyxLQUFhLEVBQUUsS0FBYTtJQUVuRCxDQUFDO0NBRUo7OztJQS9MRyxnQ0FBYzs7Ozs7SUFDRixrQ0FBc0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleHRlbmQgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG4vKlxyXG4gKiBAQXV0aG9yOiDnlq/ni4Lnp4DmiY0obHVjYXMgaHVhbmcpXHJcbiAqIEBEYXRlOiAyMDE4LTEyLTE4IDEzOjM4OjUxXHJcbiAqIEBMYXN0RWRpdG9yczog55av54uC56eA5omNKEx1Y2FzIEh1YW5nKVxyXG4gKiBATGFzdEVkaXRUaW1lOiAyMDE5LTExLTE1IDE1OjEzOjU2XHJcbiAqIEBDb21wYW55OiBJbnNwdXJcclxuICogQFZlcnNpb246IHYwLjAuMVxyXG4gKi9cclxuaW1wb3J0IHsgVHJlZVRhYmxlQ29tcG9uZW50IH0gZnJvbSAnLi90cmVldGFibGUuY29tcG9uZW50JztcclxuaW1wb3J0IHsgUm93Tm9kZSwgVHJlZU5vZGUgfSBmcm9tICcuL3R5cGVzL3RyZWVub2RlJztcclxuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoLWVzJztcclxuZXhwb3J0IGNsYXNzIFNlYXJjaEhhbmRsZSB7XHJcbiAgICBhbGxOb2RlcyA9IFtdO1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB0dEluc3RhbmNlOiBUcmVlVGFibGVDb21wb25lbnQpIHtcclxuICAgIH1cclxuXHJcbiAgICAvLyDliLfmlrDmn6Xor6Lnu5PmnpxcclxuICAgIHJlc2VhcmNoKGZyb206ICdjbGllbnQnfCdzZXJ2ZXInID0gJ2NsaWVudCcgKSB7XHJcbiAgICAgICAgY29uc3QgeyBmaWVsZCwgdmFsdWUgfSA9IHRoaXMudHRJbnN0YW5jZS5zZWFyY2hEYXRhO1xyXG4gICAgICAgIHRoaXMuYWxsTm9kZXMgPSBbXTtcclxuICAgICAgICB0aGlzLnNlYXJjaChmaWVsZCwgdmFsdWUsIGZyb20pO1xyXG4gICAgfVxyXG5cclxuICAgIHNlYXJjaChmaWVsZDogc3RyaW5nLCB2YWx1ZTogc3RyaW5nLCBmcm9tOiAnY2xpZW50J3wnc2VydmVyJyA9ICdjbGllbnQnKTogYW55IHtcclxuICAgICAgICBpZiAoIXRoaXMuYWxsTm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWxsTm9kZXMgPSBjbG9uZURlZXAodGhpcy50dEluc3RhbmNlLnN0YXRlLnJvd05vZGVzKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgc3dpdGNoIChmcm9tKSB7XHJcbiAgICAgICAgICAgIGNhc2UgJ3NlcnZlcic6XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNlYXJjaE9uU2VydmVyKGZpZWxkLCB2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gJycgJiYgdmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlcyA9IHRoaXMuc2VhcmNoT25DbGllbnQoZmllbGQsIHZhbHVlLCB0aGlzLmFsbE5vZGVzKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2Uuc3RhdGUuc2VhcmNoUm93Tm9kZXMgPSBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVNlcmlhbGl6ZWRWYWx1ZXModmFsdWVzKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLnVwZGF0ZVNlcmlhbGl6ZWRWYWx1ZSgpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnR0SW5zdGFuY2UuY2hlY2tlZHMgJiYgdGhpcy50dEluc3RhbmNlLmNoZWNrZWRzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS5jaGVja2VkTm9kZXModGhpcy50dEluc3RhbmNlLmNoZWNrZWRzLm1hcChuID0+IG4uZGF0YVt0aGlzLnR0SW5zdGFuY2UuaWRGaWVsZF0pKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50dEluc3RhbmNlLnJlc2l6ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudHRJbnN0YW5jZS5wc1JlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2UucHNSZWYuZGlyZWN0aXZlUmVmLnVwZGF0ZSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF91cGRhdGVTZXJpYWxpemVkVmFsdWVzKHZpc2libGVJdGVtczogUm93Tm9kZVtdKSB7XHJcbiAgICAgICAgY29uc3QgcGlkcyA9ICh2aXNpYmxlSXRlbXMubWFwKG4gPT4gWy4uLm4ucGFyZW50cywgbi5pZF0pIGFzIGFueSkuZmxhdCgpO1xyXG4gICAgICAgIGNvbnN0IHBpZEFyciA9IEFycmF5LmZyb20obmV3IFNldChwaWRzKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHJvd05vZGVzID0gIHRoaXMuYWxsTm9kZXMuZmlsdGVyKG4gPT4gcGlkQXJyLnNvbWUoaXRlbT0+aXRlbT09bi5pZCkpLm1hcChyID0+IHtcclxuICAgICAgICAgICAgci5leHBhbmRlZCA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS51cGRhdGVOb2RlUHJvcGVydHkoci5pZCwge2V4cGFuZGVkOiB0cnVlIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gcjtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy50dEluc3RhbmNlLnNlcmlhbGl6ZWRWYWx1ZSA9IHRoaXMucmVzZXRUcmVlRGF0YShudWxsLCByb3dOb2Rlcyk7XHJcbiAgICAgICAgdGhpcy50dEluc3RhbmNlLnN0YXRlLnNlYXJjaFJvd05vZGVzID0gdGhpcy50dEluc3RhbmNlLnNlcmlhbGl6ZWRWYWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICBmaW5kUGFyZW50KGl0ZW06IFRyZWVOb2RlLCBhbGxOb2RlczogYW55W10pIHtcclxuICAgICAgICBsZXQgcmVzID0gW107XHJcbiAgICAgICAgaWYgKGl0ZW0gJiYgYWxsTm9kZXMgJiYgYWxsTm9kZXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHAgPSBhbGxOb2Rlcy5maW5kKHQxID0+IHQxLmlkID09PSBpdGVtLmRhdGFbdGhpcy50dEluc3RhbmNlLmlkRmllbGRdKTtcclxuICAgICAgICAgICAgcmVzLnB1c2gocCk7XHJcbiAgICAgICAgICAgIGlmIChwLnBhcmVudCkge1xyXG4gICAgICAgICAgICAgICAgcmVzID0gcmVzLmNvbmNhdCh0aGlzLmZpbmRQYXJlbnQocC5wYXJlbnQsIGFsbE5vZGVzKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlcztcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNlYXJjaEV4cHJlc3Npb24oaXRlbTogUm93Tm9kZSwgdmFsdWU6IHN0cmluZywgZmllbGRzOiBzdHJpbmdbXSA9IFtdKSB7XHJcbiAgICAgICAgY29uc3QgX2ZpZWxkcyA9IGZpZWxkcy5sZW5ndGggPyBmaWVsZHMgOiB0aGlzLnR0SW5zdGFuY2UuY29sdW1ucy5tYXAoYyA9PiBjLmZpZWxkKTtcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gX2ZpZWxkcy5tYXAoZiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlID0gJycgKyAgIHRoaXMuZ2V0VmFsdWUoZiwgaXRlbS5ub2RlLmRhdGEpO1xyXG4gICAgICAgICAgICBpZiAodGFyZ2V0VmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXRWYWx1ZSA9PT0gJ251bWJlcicpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0VmFsdWUgPT09IHBhcnNlRmxvYXQodmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0VmFsdWUuaW5kZXhPZih2YWx1ZSkgPiAtMTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudHRJbnN0YW5jZS53cml0ZUNvbnNvbGUoYOS4jeWtmOWcqOWIlyAke2Z9YCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdHMucmVkdWNlKChmbGFnLCBjdXJyKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiBmbGFnIHx8IGN1cnI7XHJcbiAgICAgICAgfSwgZmFsc2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZ2V0VmFsdWUoZmllbGQsIGRhdGEpIHtcclxuICAgICAgICBpZiAoZmllbGQpIHtcclxuICAgICAgICAgICAgaWYgKGZpZWxkLmluZGV4T2YoJy4nKSA+IC0xKSB7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZpZWxkLnNwbGl0KCcuJykucmVkdWNlKCAociwgZikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByW2ZdO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0sIGRhdGEgKTtcclxuICAgICAgICAgICAgfSBjYXRjaCB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnR0SW5zdGFuY2Uud3JpdGVDb25zb2xlKGDlrZfmrrUgJHtmaWVsZH0g5LiN5a2Y5Zyo44CCYClcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFbZmllbGRdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGdldEZpbmRUZXh0VG90YWwoZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZywgbm9kZXM6IFJvd05vZGVbXSkge1xyXG4gICAgICAgIGxldCB0ID0gMDtcclxuICAgICAgICBjb25zdCBnZXRDb3VudCA9IChmaWVsZHMpOiBhbnkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgYyA9IDA7XHJcbiAgICAgICAgICAgIG5vZGVzLmZvckVhY2gobiA9PiB7XHJcbiAgICAgICAgICAgICAgICBmaWVsZHMuZm9yRWFjaChmID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWYWx1ZSA9ICcnICsgICB0aGlzLmdldFZhbHVlKGYsIG4ubm9kZS5kYXRhKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0VmFsdWUgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0VmFsdWUuaW5kZXhPZih2YWx1ZSkgPiAtMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYysrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gYztcclxuICAgICAgICB9O1xyXG4gICAgICAgIGxldCBfZmllbGRzID0gW2ZpZWxkXTtcclxuICAgICAgICBpZiAoZmllbGQgPT09ICcqJykge1xyXG4gICAgICAgICAgICBfZmllbGRzID0gdGhpcy50dEluc3RhbmNlLmNvbHVtbnMubWFwKGMgPT4gYy5maWVsZCk7XHJcblxyXG4gICAgICAgIH0gZWxzZSBpZiAoZmllbGQuaW5kZXhPZignLCcpID4gLTEpIHtcclxuICAgICAgICAgICAgX2ZpZWxkcyA9IGZpZWxkLnNwbGl0KCcsJykubWFwKGYgPT4gZi50cmltKCkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdCA9IGdldENvdW50KF9maWVsZHMpO1xyXG4gICAgICAgIHJldHVybiB0O1xyXG4gICAgfVxyXG5cclxuICAgIHNlYXJjaE9uQ2xpZW50KGZpZWxkOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIG5vZGVzOiBSb3dOb2RlW10pIHtcclxuICAgICAgICBsZXQgcmVzdWx0Tm9kZXM6IFJvd05vZGVbXSA9IFtdO1xyXG4gICAgICAgIGlmICghdmFsdWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZmllbGQgPT09ICcqJykge1xyXG4gICAgICAgICAgICByZXN1bHROb2RlcyA9IG5vZGVzLmZpbHRlcihuID0+IHRoaXMuc2VhcmNoRXhwcmVzc2lvbihuLCB2YWx1ZSkpO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZmllbGQuaW5kZXhPZignLCcpID4gLTEpIHtcclxuICAgICAgICAgICAgcmVzdWx0Tm9kZXMgPSBub2Rlcy5maWx0ZXIobiA9PiB0aGlzLnNlYXJjaEV4cHJlc3Npb24obiwgdmFsdWUsIGZpZWxkLnNwbGl0KCcsJykubWFwKGYgPT4gZi50cmltKCkpKSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICBpZiAoZmllbGQuaW5kZXhPZignLicpID09PSAtMSkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0Tm9kZXMgPSBub2Rlcy5maWx0ZXIobiA9PiAoJycgKyBuLm5vZGUuZGF0YVtmaWVsZF0pLnRvTG93ZXJDYXNlKCkuaW5kZXhPZih2YWx1ZSkgPiAtMSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHROb2RlcyA9IG5vZGVzLmZpbHRlcihuID0+ICgnJyArIHRoaXMuZ2V0VmFsdWUoZmllbGQsIG4ubm9kZS5kYXRhKSkudG9Mb3dlckNhc2UoKS5pbmRleE9mKHZhbHVlKSA+IC0xKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdE5vZGVzO1xyXG4gICAgfVxyXG5cclxuICAgIGZpbmRQYXJlbnRzKHJvd05vZGVzLCBhbGxOb2Rlcykge1xyXG4gICAgICAgIGxldCByZXMgPSBbXTtcclxuICAgICAgICByb3dOb2Rlcy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICByZXMgPSByZXMuY29uY2F0KHRoaXMuZmluZFBhcmVudChpdGVtLm5vZGUsIGFsbE5vZGVzKSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBBcnJheS5mcm9tKG5ldyBTZXQocmVzKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSByZXNldFRyZWVEYXRhKHBhcmVudE5vZGU6IFJvd05vZGUsIHZpc2libGVJdGVtczogUm93Tm9kZVtdKSB7XHJcbiAgICAgICAgbGV0IHJlcyA9IFtdO1xyXG4gICAgICAgIGxldCBhcnIgPSBbXTtcclxuICAgICAgICBpZiAocGFyZW50Tm9kZSA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICBhcnIgPSB2aXNpYmxlSXRlbXMuZmlsdGVyKHQyID0+IHQyLnBhcmVudCA9PT0gcGFyZW50Tm9kZSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcGFyZW50Tm9kZS5ub2RlLmV4cGFuZGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgYXJyID0gdmlzaWJsZUl0ZW1zLmZpbHRlcih0MiA9PiB0Mi5wYXJlbnQgJiYgdDIucGFyZW50LmRhdGFbdGhpcy50dEluc3RhbmNlLmlkRmllbGRdID09PSBwYXJlbnROb2RlLmlkKTtcclxuICAgICAgICAgICAgaWYgKCFhcnIubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnROb2RlLm5vZGUuY2hpbGRyZW4gPSBbXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHBhcmVudE5vZGUubm9kZS5jaGlsZHJlbiA9IGFyci5tYXAoIHRuID0+IHRuLm5vZGUgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBhcnIuZm9yRWFjaCggYSA9PiB7XHJcbiAgICAgICAgICAgIGEudmlzaWJsZSA9IHRydWU7XHJcbiAgICAgICAgICAgIHJlcy5wdXNoKGEpO1xyXG4gICAgICAgICAgICByZXMgPSByZXMuY29uY2F0KHRoaXMucmVzZXRUcmVlRGF0YShhLCB2aXNpYmxlSXRlbXMpKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gcmVzO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc2VhcmNoT25TZXJ2ZXIoZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xyXG5cclxuICAgIH1cclxuXHJcbn1cclxuIl19