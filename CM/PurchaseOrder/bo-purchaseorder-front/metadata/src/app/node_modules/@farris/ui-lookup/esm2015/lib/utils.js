/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable, NgZone } from '@angular/core';
import { CommonUtils, RuntimeStateService } from '@farris/ui-common';
import { FilterRelation, Compare } from '@farris/ui-common/types';
import { cloneDeep } from 'lodash-es';
export class LookupUtils {
    /**
     * @param {?} utils
     * @param {?} rts
     * @param {?} ngZone
     */
    constructor(utils, rts, ngZone) {
        this.utils = utils;
        this.rts = rts;
        this.ngZone = ngZone;
    }
    /**
     * @param {?} lookupIns
     * @return {?}
     */
    setActiveLookupInstance(lookupIns) {
        if (this.rts) {
            this.rts.setLookupInstance(lookupIns);
        }
    }
    /**
     * @return {?}
     */
    destroy() {
        this.rts.destroy();
    }
    /**
     * @return {?}
     */
    pendingStart() {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: true
                }
            });
            // 禁用页面的所有鼠标事件
            document.body.style['pointer-events'] = 'none';
        }
    }
    /**
     * @return {?}
     */
    pendingEnd() {
        if (this.rts) {
            this.rts.updateFormState({
                lookup: {
                    pending: false
                }
            });
            // 激活鼠标事件
            document.body.style['pointer-events'] = '';
        }
    }
    /**
     * @private
     * @param {?} field
     * @param {?} value
     * @return {?}
     */
    createFilterCondition(field, value) {
        return {
            filterField: field,
            value,
            lbracket: '',
            rbracket: '',
            relation: FilterRelation.Or,
            compare: Compare.Like
        };
    }
    /**
     * @param {?} condition
     * @param {?} fields
     * @param {?} searchData
     * @return {?}
     */
    mergeCondition(condition, fields, searchData) {
        if (!condition) {
            condition = {
                pagination: {
                    pageIndex: 1,
                    pageSize: 20
                },
                filterConditions: [],
                sortConditions: []
            };
        }
        else {
            condition = cloneDeep(condition);
        }
        const { field = '*', value = '' } = Object.assign({}, searchData);
        if (value) {
            if (field === '*') {
                if (fields && fields.length) {
                    /** @type {?} */
                    const searchConditions = fields.map((/**
                     * @param {?} f
                     * @return {?}
                     */
                    (f) => {
                        return this.createFilterCondition(f, value);
                    }));
                    if (searchConditions.length) {
                        searchConditions[0].lbracket = '(';
                        /** @type {?} */
                        const lastSearchConditions = searchConditions[searchConditions.length - 1];
                        lastSearchConditions.rbracket = ')';
                        lastSearchConditions.relation = FilterRelation.Empty;
                    }
                    if (condition.filterConditions && condition.filterConditions.length) {
                        condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                        condition.filterConditions = condition.filterConditions.concat(searchConditions);
                    }
                    else {
                        condition.filterConditions = searchConditions;
                    }
                }
            }
            else {
                /** @type {?} */
                const searchCondition = this.createFilterCondition(field, value);
                searchCondition.relation = FilterRelation.Empty;
                if (condition.filterConditions && condition.filterConditions.length) {
                    condition.filterConditions[condition.filterConditions.length - 1].relation = FilterRelation.And;
                    condition.filterConditions.push(searchCondition);
                }
                else {
                    condition.filterConditions = [searchCondition];
                }
            }
        }
        return condition;
    }
    /**
     * @private
     * @param {?} n
     * @return {?}
     */
    canSelectable(n) {
        if (n.hasOwnProperty('farris_selectable')) {
            return !!n['farris_selectable'];
        }
        return true;
    }
    /**
     * 将数据转树形结构
     * @param {?} data
     * @param {?} parentId
     * @param {?=} parentIdField
     * @param {?=} idField
     * @return {?}
     */
    makeTreeWithParentID(data, parentId, parentIdField = 'parentId', idField = 'id') {
        /** @type {?} */
        const nodes = new Map();
        /** @type {?} */
        const result = [];
        /** @type {?} */
        const unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        t => {
            /** @type {?} */
            const node = {
                data: t,
                children: [],
                selectable: this.canSelectable(t),
                parent: null,
                parents: []
            };
            /** @type {?} */
            const id = t[idField];
            nodes.set(id, node);
            /** @type {?} */
            const PID = this.utils.getValue(parentIdField, t);
            if (PID === parentId) {
                result.push(node);
            }
            else {
                /** @type {?} */
                const parent = nodes.get(PID);
                if (parent) {
                    node.parent = PID;
                    node.parents = [...parent.parents, PID];
                    parent.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            /** @type {?} */
            const pid = this.utils.getValue(parentIdField, n.data);
            /** @type {?} */
            const parent = nodes.get(pid);
            if (parent) {
                n.parent = pid;
                n.parents = [...parent.parents, pid];
                parent.children.push(n);
            }
        }));
        return result;
    }
    /**
     * @param {?} data
     * @param {?} treeInfo
     * @return {?}
     */
    makeTree(data, treeInfo) {
        /** @type {?} */
        const treeInfoField = treeInfo.dataField;
        /** @type {?} */
        const layerField = treeInfo.layerField;
        /** @type {?} */
        const pathField = treeInfo.pathField;
        /** @type {?} */
        const nodes = new Map();
        /** @type {?} */
        const result = [];
        /** @type {?} */
        const unattached = [];
        data.forEach((/**
         * @param {?} t
         * @return {?}
         */
        t => {
            /** @type {?} */
            const node = {
                data: t,
                children: [],
                selectable: this.canSelectable(t)
            };
            /** @type {?} */
            const pathCode = t[treeInfoField][pathField];
            nodes.set(pathCode, node);
            if (t[treeInfoField][layerField] === 1) {
                result.push(node);
            }
            else {
                /** @type {?} */
                const parentPathCode = pathCode.substr(0, pathCode.length - 4);
                /** @type {?} */
                const parent = nodes.get(parentPathCode);
                if (parent) {
                    parent.children.push(node);
                }
                else {
                    unattached.push(node);
                }
            }
        }));
        unattached.forEach((/**
         * @param {?} n
         * @return {?}
         */
        n => {
            /** @type {?} */
            const pathCode = n.data[treeInfoField][pathField];
            /** @type {?} */
            const parent = nodes.get(pathCode.substr(0, pathCode.length - 4));
            if (parent) {
                parent.children.push(n);
            }
        }));
        return result;
    }
}
LookupUtils.decorators = [
    { type: Injectable }
];
/** @nocollapse */
LookupUtils.ctorParameters = () => [
    { type: CommonUtils },
    { type: RuntimeStateService },
    { type: NgZone }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.utils;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.rts;
    /**
     * @type {?}
     * @private
     */
    LookupUtils.prototype.ngZone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZmFycmlzL3VpLWxvb2t1cC8iLCJzb3VyY2VzIjpbImxpYi91dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxjQUFjLEVBQW1CLE9BQU8sRUFBZ0IsTUFBTSx5QkFBeUIsQ0FBQztBQUNqRyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBSXRDLE1BQU0sT0FBTyxXQUFXOzs7Ozs7SUFFcEIsWUFBb0IsS0FBa0IsRUFBVSxHQUF3QixFQUFVLE1BQWM7UUFBNUUsVUFBSyxHQUFMLEtBQUssQ0FBYTtRQUFVLFFBQUcsR0FBSCxHQUFHLENBQXFCO1FBQVUsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUFJLENBQUM7Ozs7O0lBRXJHLHVCQUF1QixDQUFDLFNBQWM7UUFDbEMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6QztJQUNMLENBQUM7Ozs7SUFHRCxPQUFPO1FBQ0gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN2QixDQUFDOzs7O0lBRUQsWUFBWTtRQUNSLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRTtZQUNWLElBQUksQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDO2dCQUNyQixNQUFNLEVBQUU7b0JBQ0osT0FBTyxFQUFFLElBQUk7aUJBQ2hCO2FBQ0osQ0FBQyxDQUFDO1lBRUgsY0FBYztZQUNkLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQUcsTUFBTSxDQUFDO1NBQ2xEO0lBQ0wsQ0FBQzs7OztJQUVE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LEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNqRSxJQUFJLE1BQU0sRUFBRTtnQkFDUixNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUMzQjtRQUNMLENBQUMsRUFBQyxDQUFDO1FBRUgsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQzs7O1lBcE1KLFVBQVU7Ozs7WUFMRixXQUFXO1lBQUUsbUJBQW1CO1lBRHBCLE1BQU07Ozs7Ozs7SUFTWCw0QkFBMEI7Ozs7O0lBQUUsMEJBQWdDOzs7OztJQUFFLDZCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb21tb25VdGlscywgUnVudGltZVN0YXRlU2VydmljZSB9IGZyb20gJ0BmYXJyaXMvdWktY29tbW9uJztcclxuaW1wb3J0IHsgRmlsdGVyUmVsYXRpb24sIEZpbHRlckNvbmRpdGlvbiwgQ29tcGFyZSwgRW50aXR5RmlsdGVyIH0gZnJvbSAnQGZhcnJpcy91aS1jb21tb24vdHlwZXMnO1xyXG5pbXBvcnQgeyBjbG9uZURlZXAgfSBmcm9tICdsb2Rhc2gtZXMnO1xyXG5pbXBvcnQgeyBUcmVlSW5mbyB9IGZyb20gJy4vbG9va3VwLWdyaWQtb3B0aW9ucyc7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBMb29rdXBVdGlscyB7XHJcblxyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSB1dGlsczogQ29tbW9uVXRpbHMsIHByaXZhdGUgcnRzOiBSdW50aW1lU3RhdGVTZXJ2aWNlLCBwcml2YXRlIG5nWm9uZTogTmdab25lKSB7IH1cclxuXHJcbiAgICBzZXRBY3RpdmVMb29rdXBJbnN0YW5jZShsb29rdXBJbnM6IGFueSkge1xyXG4gICAgICAgIGlmICh0aGlzLnJ0cykge1xyXG4gICAgICAgICAgICB0aGlzLnJ0cy5zZXRMb29rdXBJbnN0YW5jZShsb29rdXBJbnMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLnJ0cy5kZXN0cm95KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcGVuZGluZ1N0YXJ0KCkge1xyXG4gICAgICAgIGlmICh0aGlzLnJ0cykge1xyXG4gICAgICAgICAgICB0aGlzLnJ0cy51cGRhdGVGb3JtU3RhdGUoe1xyXG4gICAgICAgICAgICAgICAgbG9va3VwOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGVuZGluZzogdHJ1ZVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIC8vIOemgeeUqOmhtemdoueahOaJgOaciem8oOagh+S6i+S7tlxyXG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlWydwb2ludGVyLWV2ZW50cyddID0gJ25vbmUnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwZW5kaW5nRW5kKCkge1xyXG4gICAgICAgIGlmICh0aGlzLnJ0cykge1xyXG4gICAgICAgICAgICB0aGlzLnJ0cy51cGRhdGVGb3JtU3RhdGUoe1xyXG4gICAgICAgICAgICAgICAgbG9va3VwOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcGVuZGluZzogZmFsc2VcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICAvLyDmv4DmtLvpvKDmoIfkuovku7ZcclxuICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZVsncG9pbnRlci1ldmVudHMnXSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcblxyXG4gICAgcHJpdmF0ZSBjcmVhdGVGaWx0ZXJDb25kaXRpb24oZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZykge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIGZpbHRlckZpZWxkOiBmaWVsZCxcclxuICAgICAgICAgICAgdmFsdWUsXHJcbiAgICAgICAgICAgIGxicmFja2V0OiAnJyxcclxuICAgICAgICAgICAgcmJyYWNrZXQ6ICcnLFxyXG4gICAgICAgICAgICByZWxhdGlvbjogRmlsdGVyUmVsYXRpb24uT3IsXHJcbiAgICAgICAgICAgIGNvbXBhcmU6IENvbXBhcmUuTGlrZVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgbWVyZ2VDb25kaXRpb24oY29uZGl0aW9uOiBFbnRpdHlGaWx0ZXIsIGZpZWxkczogc3RyaW5nW10sIHNlYXJjaERhdGE6IHsgZmllbGQ6IHN0cmluZywgdmFsdWU6IHN0cmluZyB9KSB7XHJcbiAgICAgICAgaWYgKCFjb25kaXRpb24pIHtcclxuICAgICAgICAgICAgY29uZGl0aW9uID0ge1xyXG4gICAgICAgICAgICAgICAgcGFnaW5hdGlvbjoge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhZ2VJbmRleDogMSxcclxuICAgICAgICAgICAgICAgICAgICBwYWdlU2l6ZTogMjBcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBmaWx0ZXJDb25kaXRpb25zOiBbXSxcclxuICAgICAgICAgICAgICAgIHNvcnRDb25kaXRpb25zOiBbXVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNvbmRpdGlvbiA9IGNsb25lRGVlcChjb25kaXRpb24pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgeyBmaWVsZCA9ICcqJywgdmFsdWUgPSAnJyB9ID0geyAuLi5zZWFyY2hEYXRhIH07XHJcblxyXG4gICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICBpZiAoZmllbGQgPT09ICcqJykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGZpZWxkcyAmJiBmaWVsZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoQ29uZGl0aW9uczogRmlsdGVyQ29uZGl0aW9uW10gPSBmaWVsZHMubWFwKChmOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRmlsdGVyQ29uZGl0aW9uKGYsIHZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHNlYXJjaENvbmRpdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlYXJjaENvbmRpdGlvbnNbMF0ubGJyYWNrZXQgPSAnKCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGxhc3RTZWFyY2hDb25kaXRpb25zID0gc2VhcmNoQ29uZGl0aW9uc1tzZWFyY2hDb25kaXRpb25zLmxlbmd0aCAtIDFdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsYXN0U2VhcmNoQ29uZGl0aW9ucy5yYnJhY2tldCA9ICcpJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGFzdFNlYXJjaENvbmRpdGlvbnMucmVsYXRpb24gPSBGaWx0ZXJSZWxhdGlvbi5FbXB0eTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucyAmJiBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucy5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnNbY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMubGVuZ3RoIC0gMV0ucmVsYXRpb24gPSBGaWx0ZXJSZWxhdGlvbi5BbmQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zID0gY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMuY29uY2F0KHNlYXJjaENvbmRpdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbi5maWx0ZXJDb25kaXRpb25zID0gc2VhcmNoQ29uZGl0aW9ucztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBzZWFyY2hDb25kaXRpb24gPSB0aGlzLmNyZWF0ZUZpbHRlckNvbmRpdGlvbihmaWVsZCwgdmFsdWUpO1xyXG4gICAgICAgICAgICAgICAgc2VhcmNoQ29uZGl0aW9uLnJlbGF0aW9uID0gRmlsdGVyUmVsYXRpb24uRW1wdHk7XHJcbiAgICAgICAgICAgICAgICBpZiAoY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMgJiYgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnNbY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMubGVuZ3RoIC0gMV0ucmVsYXRpb24gPSBGaWx0ZXJSZWxhdGlvbi5BbmQ7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uLmZpbHRlckNvbmRpdGlvbnMucHVzaChzZWFyY2hDb25kaXRpb24pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25kaXRpb24uZmlsdGVyQ29uZGl0aW9ucyA9IFtzZWFyY2hDb25kaXRpb25dO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY29uZGl0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgY2FuU2VsZWN0YWJsZShuOiBhbnkpIHtcclxuICAgICAgICBpZiAobi5oYXNPd25Qcm9wZXJ0eSgnZmFycmlzX3NlbGVjdGFibGUnKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gISFuWydmYXJyaXNfc2VsZWN0YWJsZSddO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvKiog5bCG5pWw5o2u6L2s5qCR5b2i57uT5p6EICovXHJcbiAgICBtYWtlVHJlZVdpdGhQYXJlbnRJRChkYXRhOiBhbnlbXSwgcGFyZW50SWQsIHBhcmVudElkRmllbGQgPSAncGFyZW50SWQnLCBpZEZpZWxkID0gJ2lkJykge1xyXG4gICAgICAgIGNvbnN0IG5vZGVzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgICAgICBjb25zdCB1bmF0dGFjaGVkID0gW107XHJcbiAgICAgICAgZGF0YS5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBub2RlID0ge1xyXG4gICAgICAgICAgICAgICAgZGF0YTogdCxcclxuICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbXSxcclxuICAgICAgICAgICAgICAgIHNlbGVjdGFibGU6IHRoaXMuY2FuU2VsZWN0YWJsZSh0KSxcclxuICAgICAgICAgICAgICAgIHBhcmVudDogbnVsbCxcclxuICAgICAgICAgICAgICAgIHBhcmVudHM6IFtdXHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIGNvbnN0IGlkID0gdFtpZEZpZWxkXTtcclxuICAgICAgICAgICAgbm9kZXMuc2V0KGlkLCBub2RlKTtcclxuICAgICAgICAgICAgY29uc3QgUElEID0gdGhpcy51dGlscy5nZXRWYWx1ZShwYXJlbnRJZEZpZWxkLCB0KTtcclxuICAgICAgICAgICAgaWYgKFBJRCA9PT0gcGFyZW50SWQpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZXMuZ2V0KFBJRCk7XHJcbiAgICAgICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnQgPSBQSUQ7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnRzID0gWy4uLnBhcmVudC5wYXJlbnRzLCBQSURdO1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICB1bmF0dGFjaGVkLnB1c2gobm9kZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdW5hdHRhY2hlZC5mb3JFYWNoKG4gPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBwaWQgPSB0aGlzLnV0aWxzLmdldFZhbHVlKHBhcmVudElkRmllbGQsIG4uZGF0YSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGVzLmdldChwaWQpO1xyXG4gICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICBuLnBhcmVudCA9IHBpZDtcclxuICAgICAgICAgICAgICAgIG4ucGFyZW50cyA9IFsuLi5wYXJlbnQucGFyZW50cywgcGlkXTtcclxuICAgICAgICAgICAgICAgIHBhcmVudC5jaGlsZHJlbi5wdXNoKG4pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICB9XHJcblxyXG4gICAgbWFrZVRyZWUoZGF0YSwgdHJlZUluZm86IFRyZWVJbmZvKSB7XHJcbiAgICAgICAgY29uc3QgdHJlZUluZm9GaWVsZCA9IHRyZWVJbmZvLmRhdGFGaWVsZDtcclxuICAgICAgICBjb25zdCBsYXllckZpZWxkID0gdHJlZUluZm8ubGF5ZXJGaWVsZDtcclxuICAgICAgICBjb25zdCBwYXRoRmllbGQgPSB0cmVlSW5mby5wYXRoRmllbGQ7XHJcblxyXG4gICAgICAgIGNvbnN0IG5vZGVzID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oKTtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgICAgICBjb25zdCB1bmF0dGFjaGVkID0gW107XHJcbiAgICAgICAgZGF0YS5mb3JFYWNoKHQgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBub2RlID0ge1xyXG4gICAgICAgICAgICAgICAgZGF0YTogdCxcclxuICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBbXSxcclxuICAgICAgICAgICAgICAgIHNlbGVjdGFibGU6IHRoaXMuY2FuU2VsZWN0YWJsZSh0KVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjb25zdCBwYXRoQ29kZSA9IHRbdHJlZUluZm9GaWVsZF1bcGF0aEZpZWxkXTtcclxuICAgICAgICAgICAgbm9kZXMuc2V0KHBhdGhDb2RlLCBub2RlKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0W3RyZWVJbmZvRmllbGRdW2xheWVyRmllbGRdID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQucHVzaChub2RlKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudFBhdGhDb2RlID0gcGF0aENvZGUuc3Vic3RyKDAsIHBhdGhDb2RlLmxlbmd0aCAtIDQpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZXMuZ2V0KHBhcmVudFBhdGhDb2RlKTtcclxuICAgICAgICAgICAgICAgIGlmIChwYXJlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdW5hdHRhY2hlZC5wdXNoKG5vZGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICB1bmF0dGFjaGVkLmZvckVhY2gobiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGhDb2RlID0gbi5kYXRhW3RyZWVJbmZvRmllbGRdW3BhdGhGaWVsZF07XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGVzLmdldChwYXRoQ29kZS5zdWJzdHIoMCwgcGF0aENvZGUubGVuZ3RoIC0gNCkpO1xyXG4gICAgICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChuKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG59XHJcbiJdfQ==